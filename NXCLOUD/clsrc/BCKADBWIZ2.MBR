             PGM
/*                                                                         */
/*    Programmet lister alle jobber med lock til current bibliotek         */
/*    Dersom noen jobber sperrer biblioteket gis melding og jobb avbrytes  */
/*    Savfiler bygges i asp.savf og får tekst med dagens dato              */
/*    ADBxxx og xxx lagres til respektive savfiler                         */
/*                                                                         */
             dcl        var(&m1)   type(*char)   len(50) +
                        value('Denne jobben setter ADB til current og tar +
                               Backup')
             dcl        var(&m2)   type(*char)   len(50) +
                        value('av ADBxxx.  Svar J dersom ok')
             dcl        var(&av)   type(*dec)    len(1 0)
             dcl        var(&sv)   type(*char)   len(1)
             dcl        var(&lib)  type(*char)   len(10)
             dcl        var(&txt)  type(*char)   len(50)
             dcl        var(&dat)  type(*char)   len(6)

             dclf       file(*curlib/endjobwiz) alwnull(*yes)

             rtvjoba    curlib(&lib)
             chgvar     var(%sst(&m2 7 3))   value(%sst(&lib 4 3))
             call       pgm(aa007r) +
                        parm(&m1 &m2 +
                              &sv &av)
             if       cond(&sv *ne 'J') then(do)
               goto    endpgm
             enddo
             if       cond(&av *eq 1) then(do)
               goto    endpgm
             enddo

             rtvjoba    curlib(&lib)
start:
     clrpfm      file(*libl/endjobwiz)
     wrkobjlck   obj(&lib) objtype(*lib) output(*print)
     cpysplf     file(qpdspolk) tofile(*libl/endjobwiz) +
                 splnbr(*last)
      dltsplf    file(qpdspolk) splnbr(*last)
/*   Les fil med jobber som sperrer ADBxxx                         */
rcv:  rcvf
      monmsg     msgid(cpf0864) exec(goto backup)
      if         cond(%sst(&endjobwiz 47 4) *eq 'HELD') then(do)
/* ---------------- */
        chgvar   var(&M1)  value('En eller flere jobber sperrer ' +
                          *cat &lib *tcat '. ' +
                          *cat  %sst(&endjobwiz 16 10))
        chgvar   var(&M2)  value('Sjekk dette og start jobben +
                                  på nytt')
        call     aa007r    parm(&m1 &m2 &sv &av)
        goto    cmdlbl(endpgm)
      enddo
      goto      cmdlbl(rcv)

/* ---------------- */
Backup:
/*  Bygge savfiler og endre tekst på disse til dagens dato    */
        crtsavf    file(asp.savf/&lib)
        monmsg     msgid(cpf5813)
        crtsavf    file(asp.savf/%sst(&lib 4 3))
        monmsg     msgid(cpf5813)
        chgvar     var(&txt)   value('Backup før +
                          oppgradering til NXCloud')
        rtvjoba    date(&dat)
        chgvar     var(%sst(&txt 39 6)) value('.  .20')
        chgvar     var(%sst(&txt 37 2)) value(%sst(&dat 1 2))
        chgvar     var(%sst(&txt 40 2)) value(%sst(&dat 3 2))
        chgvar     var(%sst(&txt 45 2)) value(%sst(&dat 5 2))
        chgsavf    file(asp.savf/&lib)  text(&txt)
        chgsavf    file(asp.savf/%sst(&lib 4 3))  text(&txt)

/*   Backupå av bilbiotekene                         */
        savlib     lib(&lib) dev(*savf) savf(asp.savf/&lib)
        savlib     lib(%sst(&lib 4 3)) dev(*savf) savf(asp.savf/%sst(&lib 4 3))

 ENDPGM:     ENDPGM
