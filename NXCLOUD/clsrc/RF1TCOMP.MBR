/*-------------------------------------------------------------------*/
             PGM        PARM(&SYST &jkey &stat)
/* 06.02.2012:   Ny omskriving av integrasjonen.                     */
/*    Tatt bort igjen Trigger-løsningen da Didrik nå ville legge ut  */
/*    transene direkte i filgruppene.  Endret xc100r slik at denne   */
/*    nå leser fra RCOMPF og overører til RCMPPF.                    */
/*    XC100R kjøres nå i denne jobben før overføring til RBUN/RTRA   */
/*    Dersom det oppstår feiltranser avbrytes overføringen til RB/RT */
/* 13.07.2011:   Ny endring                                          */
/*    Didrik har laget ny integrasjon som automatisk tar tak i bilag */
/*    med en gang de er regnskapsført og legger dem over til ny fil  */
/*    RCMPPF.  Dvs at overføring tas bort igjen herfra.              */
/*-------------------------------------------------------------------*/
/* Initiering av parametre.                                          */

             DCL        VAR(&FGRP)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&LIB)   TYPE(*CHAR) LEN(10) value('ADB ')
             DCL        VAR(&SYST)  TYPE(*CHAR) LEN(4)
             DCL        VAR(&FFIR)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&WALI)  TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&WAPO)  TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&MLD1)  TYPE(*CHAR) LEN(40)
             DCL        VAR(&MLD2)  TYPE(*CHAR) LEN(40)
             DCL        VAR(&M50)   TYPE(*CHAR) LEN(50)
             DCL        VAR(&MEMB)  TYPE(*CHAR) LEN(10)
             dcl        var(&cmprf) type(*char) len(10)
             dcl        var(&cmpr)  type(*char) len(200)
             dcl        var(&fper)  type(*char) len(1)
             dcl        var(&jkey)  type(*char) len(41)
             dcl        var(&stan)  type(*dec)  len(1 0)
             dcl        var(&stat)  type(*char) len(1)
             dcl        var(&jsta)  type(*dec)  len(2 0) value(0)
             dcl        var(&jmld)  type(*char) len(200)
             dcl        var(&sts)   type(*char) len(1)   value(' ')

/* Henter verdier i fra LDA.                                         */

             RTVDTAARA  DTAARA(*LDA (944 03)) RTNVAR(&FFIR)
             RTVDTAARA  DTAARA(*LDA (931 03)) RTNVAR(&FGRP)
             chgvar     var(%sst(&lib 4 3)) value(&fgrp)

             CHGVAR     VAR(%SST(&MEMB 1 4))  VALUE(&SYST)
             CHGVAR     VAR(%SST(&MEMB 5 3))  VALUE(&FFIR)

/* Varselbilde dersom poster ikke finnes i scannefil fra Compello    */

             IF         COND(&SYST *EQ 'COMP') THEN(DO)
              CHKOBJ    OBJ(&lib/RCMPPF) OBJTYPE(*FILE)
              MONMSG    MSGID(CPF9801) EXEC(DO)
               call      pgm(rgcmpc) parm(&fgrp ' ')

              ENDDO
              GOTO      CMDLBL(OVERFOR)
             ENDDO
Overfor:
/* Overføring av poster fra RCOMPF(Didrik-format) til RCMPPF         */

/*   Først kjøres XC100r bare for å teste at alt er ok               */
             chgdtaara  dtaara(*lda (1 1)) value('J')
             ovrdbf     file(rcoml2)  tofile(&lib/rcoml2)
             ovrdbf     file(rcmplu)  tofile(&lib/rcmplu)
             call       pgm(xc100r) parm(&sts)
             if         cond(&sts *ne ' ') then(do)
              if         cond(&sts *eq 'F') then(do)
               chgvar   var(&mld1) value('Noen poster inneholder feil,')
               chgvar   var(&mld2) value('Sjekk feiltranser.')
               chgvar   var(&stat) value('F')
              enddo
              if         cond(&sts *eq 'B') then(do)
               chgvar   var(&mld1) value('Diff. i overføringen.')
               chgvar   var(&mld2) value('Sjekk bilag i feiltranser.')
               chgvar   var(&stat) value('B')
              enddo
              if         cond(&sts *eq '0') then(do)
               chgvar   var(&mld1) value('Ingen poster ble funnet for')
               chgvar   var(&mld2) value('overføring til Nexstep')
               chgvar   var(&stat) value('T')
              enddo
/*    Ev. feilmelding 400-miljø                                     */
              if       cond(&jkey *eq ' ') then(do)
                chgvar    var(&wali) value(7)
                chgvar    var(&wapo) value(21)
/*              call      pgm(aa006C)  parm(&wali &wapo &mld1 &mld2) */
/*              dlyjob    dly(5) */
                chgvar    var(&m50) value(&mld1 *tcat ' ' *cat &mld2)
                call      pgm(aa005r)  parm(&m50)
               enddo
/*    Ev. feilmelding klient                                        */
               if         cond(&jkey *ne ' ') then(do)
                chgvar     var(&jsta) value(15)
                chgvar     var(&jmld) value(&mld1 *cat &mld2)
                call       pgm(ab705r)  parm(&jkey &jsta &jmld)
               enddo
/*    Hopp ut og forvent at feiltranser rettes opp først            */
               goto        cmdlbl(endpgm)
             enddo
/*   Så    kjøres XC100r for å overføre transer til RCMPPF      */
             chgdtaara  dtaara(*lda (1 1)) value(' ')
             ovrdbf     file(rcoml2)  tofile(&lib/rcoml2)
             ovrdbf     file(rcmplu)  tofile(&lib/rcmplu)
             call       pgm(xc100r) parm(&sts)
/*   Ny test om feiltranser i tilfelle noen har kommet under veis  */
             if         cond(&sts *ne ' ') then(do)
              if         cond(&sts *eq 'F') then(do)
               chgvar   var(&mld1) value('Noen poster inneholder feil')
               chgvar   var(&mld2) value('Sjekk feiltranser før ny overføring')
               chgvar   var(&stat) value('F')
              enddo
              if         cond(&sts *eq '0') then(do)
               chgvar   var(&mld1) value('Ingen poster ble funnet for')
               chgvar   var(&mld2) value('overføring til Nexstep     ')
               chgvar   var(&stat) value('T')
              enddo
              if         cond(&sts *eq 'B') then(do)
               chgvar   var(&mld1) value('Diff. i overføringen.')
               chgvar   var(&mld2) value('Sjekk bilag i feiltranser.')
               chgvar   var(&stat) value('B')
              enddo
/*    Ev. feilmelding 400-miljø                                     */
              if       cond(&jkey *eq ' ') then(do)
                chgvar    var(&wali) value(7)
                chgvar    var(&wapo) value(21)
                call      pgm(AA006C)  parm(&wali &wapo &mld1 &mld2)
                dlyjob    dly(5)
               enddo
/*    Ev. feilmelding klient                                        */
               if         cond(&jkey *ne ' ') then(do)
                chgvar     var(&jsta) value(15)
                chgvar     var(&jmld) value(&mld1 *cat &mld2)
                call       pgm(ab705r)  parm(&jkey &jsta &jmld)
               enddo
/*    Hopp ut og forvent at feiltranser rettes opp først            */
               goto        cmdlbl(endpgm)
             enddo
/* Overføring av poster fra Compello                                 */

             IF         COND(&SYST *EQ 'COMP') THEN(DO)
     /*  Sjekk om regler er satt vedr periode i CMPRfff hvor fff = fir manr.  */
               chgdtaara  dtaara(*lda (100 200)) value('          ')
               chgvar     var(&cmprf) value('COMPR' *cat &ffir)
               rtvdtaara  dtaara(&cmprf) rtnvar(&cmpr)
               monmsg     msgid(cpf1015) exec(do)
                 goto     cmdlbl(nocmpreg)
               enddo
               chgdtaara  dtaara(*lda (100 10)) +
                          value(%substring(&cmpr 1 10))
               chgdtaara  dtaara(*lda (111 16)) +
                          value(%substring(&cmpr 28 16))

             CHGVAR     VAR(&WALI) VALUE(10)
             CHGVAR     VAR(&WAPO) VALUE(26)
             CHGVAR     VAR(&MLD1) VALUE('Poster fra Compello hentes ')
             CHGVAR     VAR(&MLD2) VALUE('Vennligst vent           ')

/*           CHGDTAARA  DTAARA(ADB610/TSTCOMP (1 41))  VALUE(&JKEY) */
/*           CHGDTAARA  DTAARA(ADB610/TSTCOMP (49 2))  VALUE('3>')  */
/*           CHGDTAARA  DTAARA(ADB610/TSTCOMP (51 10)) VALUE(&syst) */
             if         cond(&jkey *eq ' ') then(do)
             CALL       PGM(AA006C)  PARM(&WALI &WAPO &MLD1 &MLD2)
             DLYJOB     DLY(2)
             enddo
nocmpreg:
/*    All historikk ligger igjen i ADBxxx/rcompf                    */
/*    Dette for at Didrik skal kunne sjekke om tidligere ovf transer*/
/*    har kommet inn riktig.  Jeg merker i steden records jeg henter*/
/*    med 'J' i RTHENT                                              */

/*   Tildele periode i recordene dersom dette ikke er gjort fra Comp */
             ovrdbf     file(rcmpl1) tofile(&lib/rcmpl1)
               CALL       PGM(RFP14R) PARM(&MEMB &jkey &stan)
               if         cond(&stan *eq 1) then(do)
                 if         cond(&jkey *eq ' ') then(do)
                  chgvar     var(&jsta) value(15)
                  chgvar     var(&jmld) value('Ingen poster hentet +
                               fra Skanning')
                  call       pgm(ab705r)  parm(&jkey &jsta &jmld)
                 enddo
               goto       cmdlbl(endpgm)
               enddo
/*   Bygger transer for dette firma og filgruppe                     */
             ovrdbf     file(rcmpl1) tofile(&lib/rcmpl1)
               CALL       PGM(RFP16R) PARM(&memb &jkey &stan)
               chgvar     var(&stat) value('O')

/*   Dersom det posteres på avsluttet periode gis melding om dette  */

               rtvdtaara  dtaara(*lda (110 1)) rtnvar(&fper)
               if         cond(&fper *eq 'J') then(do)
                 chgvar     var(&wali) value(12)
                 chgvar     VAR(&wapo) value(35)
                 chgvar     VAR(&mld1) value('Det ligger posteringer her ')
                 chgvar     VAR(&mld2) value('på avsluttet periode...... ')
                 chgvar     var(&stat) value('P')
                 if         cond(&jkey *eq ' ') then(do)
                  call       pgm(aa006c)  parm(&wali &wapo &mld1 &mld2)
                  dlyjob     dly(5)
                 enddo
                 if         cond(&jkey *ne ' ') then(do)
                  chgvar     var(&jsta) value(15)
                  chgvar     var(&jmld) value(&mld1 *cat &mld2)
                  call       pgm(ab705r)  parm(&jkey &jsta &jmld)
                 enddo
               enddo
             enddo

ENDPGM:      ENDPGM
