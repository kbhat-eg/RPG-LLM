             PGM

/* Prosjekt  Innlesning av excel ark   NX_PROSJ.csv                  */
/*                                                                   */
/*   Filene legges i:  asp\G0x\Prosjekt\Pr_*.csv                     */
/*   Backup legges i:  asp\G0x\Prosjekt\Backup\PR_ååmmddnn           */

             DCL        VAR(&IN03)  TYPE(*CHAR) LEN(1)
             DCL        VAR(&IN12)  TYPE(*CHAR) LEN(1)
             DCL        VAR(&BTCH)  TYPE(*CHAR) LEN(1)
             DCL        VAR(&MLD1)  TYPE(*CHAR) LEN(40)
             DCL        VAR(&MLD2)  TYPE(*CHAR) LEN(40)
             DCL        VAR(&MLD3)  TYPE(*CHAR) LEN(50)
             DCL        VAR(&MLD4)  TYPE(*CHAR) LEN(50)
             DCL        VAR(&SVAR)  TYPE(*CHAR) LEN(1)
             DCL        VAR(&WALI)  TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&WAPO)  TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&FIRM)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&MBER)  TYPE(*CHAR) LEN(10)
             DCL        VAR(&filg)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&fra)   TYPE(*CHAR) LEN(80) +
                                    value('/asp/xxx/Prosjekt/')
             DCL        VAR(&til)   TYPE(*CHAR) LEN(80) +
                      value('/asp/xxx/Prosjekt/backup/Pr_ååmmddnn.csv')
             DCL        VAR(&tilf)  TYPE(*CHAR) LEN(60)
             DCL        VAR(&tlib)  TYPE(*CHAR) LEN(10)
             DCL        VAR(&posx)  TYPE(*dec)  LEN(2 0) value(5)
             DCL        VAR(&posy)  TYPE(*dec)  LEN(2 0) value(7)
             DCL        VAR(&i)     TYPE(*dec)  LEN(3 0)
             DCL        VAR(&j)     TYPE(*dec)  LEN(3 0)
             DCL        VAR(&mbrsz) TYPE(*dec)  LEN(10 0)
             dcl        var(&dato)  TYPE(*char) LEN(6)
             dcl        var(&nn)    TYPE(*dec)  LEN(2 0)
             dcl        var(&xx)    TYPE(*char) LEN(2)

             dclf       file(*libl/HentProsj)

             rtvjoba    date(&dato)
             rtvdtaara  dtaara(*lda (931 03))  rtnvar(&filg)
             rtvdtaara  dtaara(*lda (934 10))  rtnvar(&tlib)
             chgvar     var(%sst(&fra  6 03))  value(&filg)
             chgvar     var(%sst(&til  6 03))  value(&filg)

             chgvar     var(%sst(&fra 19 04)) value('Pr_*')
             dsplnk     obj(&fra)  output(*print)
             monmsg     msgid(CPFA0A9) exec(do)
               chgvar   var(&mld1) value('Mappe eksisterer ikke å må bygges.')
               chgvar   var(&mld2) value(&fra)
               call     pgm(aa006c) parm(&posx &posy &mld1 &mld2)
               dlyjob   dly(5)
               goto     cmdlbl(endpgm)
             enddo

logok:
      cpysplf    file(qsysprt) tofile(*curlib/HentProsj) +
                   splnbr(*last) jobsysname(*only)
      monmsg     msgid(cpf9812) exec(do)
        crtpf    file(*curlib/HentProsj) rcdlen(512)
        goto     cmdlbl(logok)
      enddo

      dltsplf    file(qsysprt) splnbr(*last)

             clrpfm     file(*libl/xl_prosj)
             monmsg     msgid(cpf3142) exec(do)
               crtpf    file(xl_prosj) rcdlen(512) size(*nomax)
             enddo

             clrpfm     file(*libl/henttmp)
             monmsg     msgid(cpf3142) exec(do)
               crtpf    file(henttmp) rcdlen(512) size(*nomax)
             enddo

rcv:         rcvf
             monmsg     msgid(cpf0864) exec(goto lesok)
             chgvar     var(&i)  value(0)
nexti:       chgvar     var(&i)  value(&i + 1)
             if         cond(&i < 45) then(do)
               if       cond(%sst(&hentProsj &i 4) = '.csv') then(do)
                 goto   cmdlbl(kopier)
               enddo
               else
                 do
                   goto cmdlbl(nexti)
                 enddo
             enddo
             else
               do
                 goto   cmdlbl(rcv)
             enddo
             goto       cmdlbl(nexti)

kopier:      chgvar     var(&j)    value(&i + 2)
             chgvar     var(%sst(&fra 19 &j)) +
                        value(%sst(&hentProsj 2 &j))

             chgvar     var(&tilf) value('/qsys.lib/' *tcat &tlib +
                          *tcat '.lib/henttmp.file/' +
                          *tcat 'henttmp.mbr')
             cpyfrmstmf fromstmf(&fra) tombr(&tilf) mbropt(*replace)
             /*           STMFCCSID(1252)                */
         /*  monmsg     msgid(cpfA0A9 cpfa095) exec(do)   */
         /*    goto     cmdlbl(error)                     */
         /*  enddo                                        */
/*  backup av innlest fil                                          */
             chgvar     var(%sst(&til 29 2)) value(%sst(&dato 5 2))
             chgvar     var(%sst(&til 31 2)) value(%sst(&dato 3 2))
             chgvar     var(%sst(&til 33 2)) value(%sst(&dato 1 2))
             chgvar     var(&nn)  value(00)
bloop:       chgvar     var(&nn)  value(&nn + 1)
             chgvar     var(&xx)  value(&nn)
             chgvar     var(%sst(&til 35 2)) value(&xx)
/*           mov        obj(&fra) todir(&til)     */
             cpy        obj(&fra) toobj(&til)
             monmsg     msgid(cpfA0A0) exec(do)
               goto     cmdlbl(bloop)
             enddo
             rmvlnk     objlnk(&fra)

             cpyf       fromfile(*libl/henttmp) +
                        tofile(&tlib/xl_Prosj) +
                        tombr(*first) +
                        mbropt(*add) +
                        fmtopt(*nochk)
             goto       rcv

lesok:
/* Ble det lest inn noen transer?                                   */
             rtvmbrd    file(xl_Prosj) mbr(*first) nbrcurrcd(&mbrsz)
             if         cond(&mbrsz *eq 0) then(do)
              CHGVAR     VAR(&WALI) VALUE(4)
              CHGVAR     VAR(&WAPO) VALUE(2)
              CHGVAR     VAR(&MLD1) VALUE('Innlesning av Prosjekt fra XL')
              CHGVAR     VAR(&MLD2) VALUE('Det var ikke noe å lese inn')
              CALL       PGM(AA006C)  PARM(&WALI &WAPO &MLD1 &MLD2)
              dlyjob     dly(000005)
              CHGVAR     VAR(&WALI) VALUE(7)
              CHGVAR     VAR(&WAPO) VALUE(8)
              CHGVAR     VAR(&MLD1) VALUE('Prosjektene må legges i:     ')
              CHGVAR     VAR(&MLD2) VALUE(' \asp\xxx\Prosjekt\Pr_*.csv')
              chgvar     var(%sst(&mld2 7 3)) value(&filg)
              CALL       PGM(AA006C)  PARM(&WALI &WAPO &MLD1 &MLD2)
              dlyjob     dly(000007)
              goto       endpgm
             enddo

/* Varselbilde 1                                                     */

             IF         COND(&BTCH *NE '1') THEN(DO)
             CHGVAR     VAR(&WALI) VALUE(4)
             CHGVAR     VAR(&WAPO) VALUE(2)
             CHGVAR     VAR(&MLD1) VALUE('Prosjekt fra Excel-fil   ')
             CHGVAR     VAR(&MLD2) VALUE('**** Innlesning  ******* ')
             CALL       PGM(AA006C)  PARM(&WALI &WAPO &MLD1 &MLD2)
             ENDDO


/* Innlesning av prosjekt                                            */

             CALL       PGM(Rp700r)


             GOTO       CMDLBL(ENDPGM)

 ERROR:

/* Varselbilde FEIL                                                  */

             CHGVAR     VAR(&MLD3) VALUE('Overføring fra Svea feilet')
             CHGVAR     VAR(&MLD4) VALUE('   Vennligst bekreft.     ')
             CALL       PGM(AA007R)  PARM(&MLD3 &MLD4 &SVAR &IN12)

 ENDPGM:     ENDPGM
