/*--------------------------------------------------------------------------------*/
/*8.01  300823 bsa Feil utregning av dekningsgrad                                 */
/*8.02  011123 sst Feil utregning av dekningsgrad                                 */
/*                                                                                */
/*                                                                                */
/*--------------------------------------------------------------------------------*/
             PGM        PARM(&FIRMA &NUMM &SUFF &POST_LINK)

             DCL        VAR(&FIRMA) TYPE(*DEC) LEN(3 0)
             DCL        VAR(&NUMM) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&SUFF) TYPE(*DEC) LEN(2 0)
             DCL        VAR(&POST_LINK) TYPE(*CHAR) LEN(100)

             DCL        VAR(&WHERE) TYPE(*CHAR) LEN(100)
             DCL        VAR(&NUMMS) TYPE(*CHAR) LEN(8)  VALUE('00000000')
             DCL        VAR(&SUFFS) TYPE(*CHAR) LEN(2)  VALUE('00')


             DCL        VAR(&SQLSTMT)  TYPE(*CHAR) LEN(10000)
             DCL        VAR(&PREFIX_FIL)    TYPE(*CHAR) LEN(20) +
                          VALUE('ORDRE_')

             CHGVAR     VAR(&NUMMS) VALUE(%CHAR(&NUMM))
             CHGVAR     VAR(&SUFFS) VALUE(%CHAR(&SUFF))

/*   Filnavn                                                                  */
             CHGVAR     VAR(&PREFIX_FIL) VALUE(&PREFIX_FIL *TCAT &NUMMS)
             CHGVAR     VAR(&PREFIX_FIL) VALUE(&PREFIX_FIL *TCAT  '_' +
                          *Tcat &SUFFS *TCAT  '_')

/*   Bygg SQL                                                                 */
             CHGVAR     VAR(&WHERE) VALUE(' AND FDNUMM = ' *CAT &NUMMS +
                          *CAT ' AND FDSUFF = ' *CAT &SUFFS)

             CHGVAR     VAR(&SQLSTMT) VALUE('SELECT fdvare AS +
                          "Varenummer",fdnobb AS "NOBB-nummer",fdtek1 AS +
                          "Varektest 1",fdtek2 AS "Varektest 2",fdanta AS +
                          "Antall",fdenh1 AS "Enhet",fdsapr AS "Enhetspris +
                          brutto",case when fdanta = 0 then 0 else +
                          ((fdsums - fdsumr)/fdanta) end AS "Enhetspris +
                          netto",fdsums AS "Sum brutto",fdrab1 AS "Rabatt +
                          1 %",fdrab2 AS "Rabatt 2 %",fdsums - fdsumr AS +
                          "Sum netto",fdkopr AS "Kostpris enhet",fdsumk AS +
/*8.01*/                  "Kostpris",(fdsums - fdsumr - fdsumk) AS +
                          "Dekningsbidrag",case when fdsums = 0 then 0 +
/*8.01*/ /* 8.02 */       else (((FDSUMS - FDSUMR - FDSUMK) / (fdsums-fdsumr)) * 100) end AS +
                          "DG" FROM fodtpf ')

             chgvar     var(&sqlstmt) value(&sqlstmt *Bcat 'WHERE FDFIRM=' +
                          *CAT %CHAR(&FIRMA))
             chgvar     var(&sqlstmt) value(&sqlstmt *Bcat &WHERE)
             chgvar     var(&sqlstmt) value(&sqlstmt *Bcat 'ORDER BY +
                          fdline ')

             CALL       PGM(XLSXCLODXP) PARM( &SQLSTMT &POST_LINK +
                          &PREFIX_FIL)

 ENDPGM:     ENDPGM
