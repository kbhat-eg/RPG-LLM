/* Oppretting/oppdatering av tabeller og indekser på bakgrunn av DDF */
/* Programmet takler maksimalt 25 indekser pr. tabell                */

/* Tabeller opprettes med:                                           */
/*   SIZE(*NOMAX) REUSEDLT(*YES) SRTSEQ(*LANGIDUNQ) LANGID(NOR)      */
/*                                                                   */
/* 2022_10_04:  Tildele også tilgang på asp_xxx's gruppeprofil       */
/*                                                                   */

             PGM        PARM(&FILE &FGRP &GRP &NULL)

             dcl        var(&ver)  type(*char) len(3) value(' ')
             dcl        var(&sys)  type(*char) len(12)

             DCL        VAR(&FILE) TYPE(*CHAR) LEN(6)
             DCL        VAR(&FGRP) TYPE(*CHAR) LEN(3)
             DCL        VAR(&GRP)  TYPE(*CHAR) LEN(10)
             DCL        VAR(&NULL) TYPE(*CHAR) LEN(1)

             DCL        VAR(&DLIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&cLIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&sfil) TYPE(*CHAR) LEN(10)

             DCL        VAR(&BACK) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INDX) TYPE(*CHAR) LEN(6)

             DCL        VAR(&INLA) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLB) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLC) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLD) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLE) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLF) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLG) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLH) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLI) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLJ) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLK) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLL) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLM) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLN) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLO) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLP) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLQ) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLR) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLS) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLT) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLU) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLV) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLW) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLX) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLY) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INLZ) TYPE(*CHAR) LEN(6)

             DCL        VAR(&INL1) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL2) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL3) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL4) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL5) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL6) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL7) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL8) TYPE(*CHAR) LEN(6)
             DCL        VAR(&INL9) TYPE(*CHAR) LEN(6)

             DCL        VAR(&FLST) TYPE(*CHAR) LEN(5)
             DCL        VAR(&TBLE) TYPE(*CHAR) LEN(10)

             DCL        VAR(&txt)  type(*CHAR) LEN(100)
             dcl        var(&asp)  type(*char) len(10)

/* Finner ut hvilke bibliotek filen skal ligge                       */

             call       pgm(getdlib)  parm(&file &dlib &sfil &fgrp)
             rtvjoba    curlib(&clib)
             if         cond(&clib *ne ' ' *and +
                             &clib *ne '*NONE') then(do)
               addlible   lib(&clib)  position(*last)
               monmsg     msgid(cpf2103)
             enddo

/*     Hvis LVR, Sjekk om filen kan bygges i dette LVR'et for denne filgruppa  */
             if         cond(%scan('LVR' &dlib) *gt 0) then(do)
               chkobj     obj(&dlib) objtype(*lib)
               monmsg     msgid(cpf9801) exec(do)
                 chgvar     var(&txt)  value('AG916C   ' +
                            *cat  ' File: ' *cat &file *cat ' Kan ikke +
                            bygges i biblioteket: ' *cat  &dlib)
                 call     pgm(egd97c) parm+
                          ('NXC_DISTR' +
                           'AG916C    ' +
                           '001' +
                           &txt)
                 goto     cmdlbl(end)
               enddo
             enddo
             if         cond(%sst(&file 1 4) *ne 'NXLO'  *and +
                             %sst(&file 1 4) *ne 'NXLA') then(do)
               chgvar     var(&txt)  value('NXC_Distr' +
                          *cat  ' File: ' *cat &file *cat ' Bibl: ' +
                               *cat  &dlib)
/* 08.05.2023  call     pgm(egd97c) parm+            */
/*                      ('NXC_DISTR' +               */
/*                       'AG916C    ' +              */
/*                       '001' +                     */
/*                       &txt)                       */
             enddo


/* Setter databibliotek til current library                          */

             CHGCURLIB  CURLIB(&DLIB)
     /*      DSPNETA    OUTPUT(*PRINT)     */
     /*      DSPLIBL    OUTPUT(*PRINT)     */

             CHGVAR     VAR(%SST(&TBLE 1 6)) VALUE(&FILE)

/* Finner hvilken versjon vi kjører                                  */

             rtvneta    sysname(&sys)
             call       pgm(ar701r) parm(&sys &fgrp &ver)

/* Slett triggere på tabell                                          */
             CALL       PGM(nxTRGDLT) PARM(&dlib &TBLE &ver)
/* Slett indexer  på tabell                                          */
             CALL       PGM(nxIDXDLT) PARM(&dlib ' ' ' ' &TBLE &ver)
/* Slett views    på tabell                                          */
             CALL       PGM(nxVIEWDLT) PARM(&dlib &TBLE &ver)

    /*       DSPLIBL    OUTPUT(*PRINT)        */
    /*       DSPNETA    OUTPUT(*PRINT)         */

/* Utleder navn på backup-tabell og indeks-prefix                    */

             CHGVAR     VAR(&FLST) VALUE(%SUBSTRING(&FILE 1 4) *CAT '*')

             CHGVAR     VAR(&BACK) VALUE(%SUBSTRING(&FILE 1 4) *CAT +
                          'BF')
             CHGVAR     VAR(&INDX) VALUE(%SUBSTRING(&FILE 1 4) *CAT +
                          'L*')

/* Utleder navn indekser                                             */

             CHGVAR     VAR(&INLA) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'A')
             CHGVAR     VAR(&INLB) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'B')
             CHGVAR     VAR(&INLC) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'C')
             CHGVAR     VAR(&INLD) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'D')
             CHGVAR     VAR(&INLE) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'E')
             CHGVAR     VAR(&INLF) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'F')
             CHGVAR     VAR(&INLG) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'G')
             CHGVAR     VAR(&INLH) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'H')
             CHGVAR     VAR(&INLI) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'I')
             CHGVAR     VAR(&INLJ) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'J')
             CHGVAR     VAR(&INLK) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'K')
             CHGVAR     VAR(&INLL) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'L')
             CHGVAR     VAR(&INLM) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'M')
             CHGVAR     VAR(&INLN) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'N')
             CHGVAR     VAR(&INLO) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'O')
             CHGVAR     VAR(&INLP) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          'P')
             CHGVAR     VAR(&INLQ) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'Q')
             CHGVAR     VAR(&INLR) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'R')
             CHGVAR     VAR(&INLS) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'S')
             CHGVAR     VAR(&INLT) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'T')
             CHGVAR     VAR(&INLU) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'U')
             CHGVAR     VAR(&INLV) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'V')
             CHGVAR     VAR(&INLW) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'W')
             CHGVAR     VAR(&INLX) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'X')
             CHGVAR     VAR(&INLY) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'Y')
             CHGVAR     VAR(&INLZ) VALUE(%SUBSTRING(&INDX 1 5) *CAT 'Z')


             CHGVAR     VAR(&INL1) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '1')
             CHGVAR     VAR(&INL2) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '2')
             CHGVAR     VAR(&INL3) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '3')
             CHGVAR     VAR(&INL4) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '4')
             CHGVAR     VAR(&INL5) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '5')
             CHGVAR     VAR(&INL6) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '6')
             CHGVAR     VAR(&INL7) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '7')
             CHGVAR     VAR(&INL8) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '8')
             CHGVAR     VAR(&INL9) VALUE(%SUBSTRING(&INDX 1 5) *CAT +
                          '9')

/* Tar vare på tabellinnholdet i temporær backup-tabell og sletter   */
/* eksisterende tabell og tilhørende indekser                        */

             CHKOBJ     OBJ(&DLIB/&FILE) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(DDF))

             CHKOBJ     OBJ(&DLIB/&BACK) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(BACKUP))

             DLTF       FILE(&DLIB/&BACK)

 BACKUP:

             DLTF       FILE(&DLIB/&INDX)
             MONMSG     MSGID(CPF2125)
/*  Sletter ev overlevde indexer     */
             call       pgm(ag906dc)  parm(&file)
/*  Sletter ev overlevde indexer     NB!!!  Må kjøres 2 ganger  */
             call       pgm(ag906dc)  parm(&file)

             rnmobj     obj(&dlib/&file) objtype(*file) newobj(&back)
             monmsg     msgid(cpf3220)

/* Opretter tabell med tilhørende indekser                           */

 DDF:        CRTPF      FILE(&DLIB/&FILE) SRCFILE(&sfil) +
                          MAXMBRS(*NOMAX) SIZE(*NOMAX) +
                          REUSEDLT(*YES) SRTSEQ(*LANGIDUNQ) LANGID(NOR)
             monmsg     msgid(cpf9801 cpf9815 cpf7302) exec(do)
               chgvar   var(&null)   value(X)
               goto     end
             enddo

             CRTLF      FILE(&DLIB/&INLA) SRCFILE(&sfil) +
                          MAXMBRS(*NOMAX) SRTSEQ(*LANGIDUNQ) +
                          LANGID(NOR)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLB) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLC) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLD) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLE) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLF) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLG) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLH) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLI) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLJ) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLK) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLL) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLM) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLN) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLO) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLP) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLQ) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLR) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLS) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLT) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLU) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLV) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLW) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLX) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLY) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INLZ) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)

             CRTLF      FILE(&DLIB/&INL1) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL2) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL3) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL4) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL5) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL6) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL7) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL8) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)
             CRTLF      FILE(&DLIB/&INL9) SRCFILE(&sfil) +
                          SRTSEQ(*LANGIDUNQ) LANGID(NOR) +
                          maxmbrs(*nomax)
             MONMSG     MSGID(CPF7302)

/* Kopierer tilbake tabellinnhold fra temporær backup-tabell         */

             CHKOBJ     OBJ(&DLIB/&BACK) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO STRSQL)

             IF         COND(&NULL *NE '1') THEN( +
             CPYF       FROMFILE(&DLIB/&BACK) +
                          TOFILE(&DLIB/&FILE) MBROPT(*ADD) +
                          FMTOPT(*MAP *DROP))

             DLTF       FILE(&DLIB/&BACK)

 STRSQL:

/* Legg på gruppe rettigheter                                        */

           chgvar     var(&asp)     value('asp_' *cat &fgrp)
           rvkobjaut obj(&dlib/&flst) objtype(*file) user(qdftown) aut(*all)
           rvkobjaut obj(&dlib/&flst) objtype(*file) user(&asp) aut(*all)
           rvkobjaut obj(&dlib/&flst) objtype(*file) user(*all) aut(*all)
           grtobjaut obj(&dlib/&flst) objtype(*file) user(&grp) aut(*all)
           if        cond(&dlib *NE 'ADB') THEN( +
             grtobjaut obj(&dlib/&flst) objtype(*file) user(*public) aut(*exclude))
           if        cond(&dlib *EQ 'ADB') THEN( +
             grtobjaut obj(&dlib/&flst) objtype(*file) user(*public) aut(*change))
           rtvusrprf usrprf(&asp) grpprf(&grp)
           grtobjaut obj(&dlib/&flst) objtype(*file) user(&grp) aut(*all)

             chgobjown  obj(&dlib/&file) objtype(*file) newown(&grp)

/* Journalfør tabellen                                               */
             STRJRNPF   FILE(&DLIB/&Flst) JRN(&DLIB/BUTIJRN) +
                          OMTJRNE(*OPNCLO)
             MONMSG     MSGID(CPF9801) EXEC(GOTO END) /* BUTIJRN finnes +
                          ikke */
             MONMSG     MSGID(CPF7030 CPF700A CPA0702 CPD7002)
                                            /*  already being journaled  */
/* Legg inn triggere på tabell                                       */
             CALL    PGM(nxTRGCRT) PARM(&dlib &TBLE &ver)
/* Legg inn indexer  på tabell                                       */
             CALL    PGM(nxIDXCRT) PARM(&dlib &fgrp ' ' ' ' &TBLE &ver)

 end:        chgcurlib  curlib(&clib)
             rmvlible   lib(&clib)
             ENDPGM
