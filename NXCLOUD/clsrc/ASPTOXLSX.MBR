             PGM        parm(&sqlstm &tilmap &tildok &typ)
/*  Eier av ev nye cataloger legges i &DUS                          */
/*  150320 BKV sqlstm økt fra 1000 til 10000                        */
/*  250320 BKV tildok økt fra 25   til 50                           */

/* Initiering av parametre.                                          */

             DCL        VAR(&sqlstm) TYPE(*char) LEN(10000)
             DCL        VAR(&tilmap) TYPE(*char) LEN(20) /* OKONOMI */
             DCL        VAR(&tildok) TYPE(*CHAR) LEN(50) /* Kunder */
             DCL        VAR(&typ)    TYPE(*CHAR) LEN(4) /* xls */
             DCL        VAR(&map)    TYPE(*char) LEN(40)
             DCL        VAR(&x)      TYPE(*char) LEN(40)
             DCL        VAR(&FGRP)     TYPE(*CHAR) LEN(3)
             DCL        VAR(&CLIB)     TYPE(*CHAR) LEN(10)
             DCL        VAR(&MAPX)     TYPE(*CHAR) LEN(30)
             DCL        VAR(&tfil)     TYPE(*CHAR) LEN(70)
             DCL        VAR(&i)        TYPE(*dec)  LEN(3 0)
             DCL        VAR(&j)        TYPE(*dec)  LEN(3 0)
             DCL        VAR(&dus)      TYPE(*char) LEN(10) value('ASP')

             DCL        VAR(&GRPPRF)   TYPE(*CHAR) LEN(10)

/* Kopierer til IFS                                               */

             RTVDTAARA  DTAARA(*LDA (931 03)) RTNVAR(&FGRP)
             RTVJOBA    CURLIB(&CLIB)

             RTVUSRPRF  GRPPRF(&GRPPRF)
             if         cond(&GRPPRF *ne ' ' *and &GRPPRF *ne '*NONE') +
                          then(do)
                chgvar     var(&dus)      value(&GRPPRF)
             enddo

             CHGVAR     VAR(&MAPX)  VALUE('/asp/' *TCAT &FGRP)

 /* Danner mappen på IFS */
nymapp:      if         cond(&tilmap *ne '   ') then(do)
               chgvar     var(&map)    value(' ')
               chgvar     var(&x)      value(&tilmap)
               if         cond(%sst(&x 1 8) *eq &mapx) then(do)
                 chgvar   var(&map) value(&tilmap)
               enddo
               if         cond(%sst(&x 1 8) *ne &mapx) then(do)
                 chgvar   var(&map) value(&mapx *tcat '/' +
                                          *tcat &x)
               enddo

               chgvar     var(&i)  value(%scan('/' &map 10))
               if         cond(&i *ne 0) then(do)
                 chgvar   var(&j)     value(&i - 1)
                 chgvar   var(&x)     value(%sst(&map 1 &j))
                 crtdir     dir(&x)      dtaaut(*INDIR) objaut(*INDIR)
                 monmsg   msgid(cpfa0a0)
                 monmsg     msgid(cpf0000)
                 CHGPGP     obj(&x) NEWPGP(*none)
                 MONMSG     MSGID(CPFA0B1)
                 chgown     obj(&x)   newown(&dus) RVKOLDAUT(*NO)
                 MONMSG     MSGID(CPFA0B1)
                 monmsg     msgid(cpf0000)
               enddo

               if         cond(&i *ne 0) then(do)
                 chgvar   var(&j)     value(&i + 1)
                 chgvar   var(&i)  value(%scan('/' &map &j))
                 if       cond(&i *ne 0) then(do)
                   chgvar var(&j)     value(&i - 1)
                   chgvar var(&x)     value(%sst(&map 1 &j))
                   crtdir     dir(&x)      dtaaut(*INDIR) objaut(*INDIR)
                   monmsg msgid(cpfa0a0)
                   monmsg     msgid(cpf0000)
                   CHGPGP     obj(&x) NEWPGP(*none)
                   MONMSG     MSGID(CPFA0B1)
                   chgown     obj(&x)   newown(&dus) RVKOLDAUT(*NO)
                   MONMSG     MSGID(CPFA0B1)
                   monmsg     msgid(cpf0000)
                 enddo
               enddo

               if         cond(&i *ne 0) then(do)
                 chgvar   var(&j)     value(&i + 1)
                 chgvar   var(&i)  value(%scan('/' &map &j))
                 if       cond(&i *ne 0) then(do)
                   chgvar var(&j)     value(&i - 1)
                   chgvar var(&x)     value(%sst(&map 1 &j))
                   crtdir     dir(&x)      dtaaut(*INDIR) objaut(*INDIR)
                   monmsg msgid(cpfa0a0)
                   monmsg     msgid(cpf0000)
                   CHGPGP     obj(&x) NEWPGP(*none)
                   MONMSG     MSGID(CPFA0B1)
                   chgown     obj(&x)   newown(&dus) RVKOLDAUT(*NO)
                   MONMSG     MSGID(CPFA0B1)
                   monmsg     msgid(cpf0000)
                 enddo
               enddo

               if         cond(&i *ne 0) then(do)
                 chgvar   var(&j)     value(&i + 1)
                 chgvar   var(&i)  value(%scan('/' &map &j))
                 if       cond(&i *ne 0) then(do)
                   chgvar var(&j)     value(&i - 1)
                   chgvar var(&x)     value(%sst(&map 1 &j))
                   crtdir     dir(&x)      dtaaut(*INDIR) objaut(*INDIR)
                   monmsg msgid(cpfa0a0)
                   monmsg     msgid(cpf0000)
                   CHGPGP     obj(&x) NEWPGP(*none)
                   MONMSG     MSGID(CPFA0B1)
                   chgown     obj(&x)   newown(&dus) RVKOLDAUT(*NO)
                   MONMSG     MSGID(CPFA0B1)
                   monmsg     msgid(cpf0000)
                 enddo
               enddo

               crtdir     dir(&map)    dtaaut(*INDIR) objaut(*INDIR)
               monmsg   msgid(cpfa0a0)
               CHGPGP     obj(&map) NEWPGP(*none)
               MONMSG     MSGID(CPFA0B1)
               chgown     obj(&map)   newown(&dus) RVKOLDAUT(*NO)
               MONMSG     MSGID(CPFA0B1)
               monmsg     msgid(cpf0000)

             enddo

             if         cond(&typ *ne ' ') then(do)
                chgvar     var(&tildok) value(&tildok *tcat '.' *cat &typ)
             enddo
             chgvar     var(&tfil) value(&map *tcat +
                                       '/' *tcat &tildok)

             COOLSPV7R1/CVTDBFXLSX FROMFILE(*SQL) SQL(&sqlstm) +
                          TOSTMF(&tfil) STMFOPT(*REPLACE)

             CHGPGP     obj(&tfil) NEWPGP(*none)
             MONMSG     MSGID(CPFA0A9) /* Objektet finnes ikke */
             MONMSG     MSGID(CPFA0B1) /* hvis filen finnes fra før, og +
                          bruker ikke er eier, feiler chgaut */
             chgown     obj(&tfil)   newown(&dus) RVKOLDAUT(*NO)
             MONMSG     MSGID(CPFA0A9) /* Objektet finnes ikke */
             MONMSG     MSGID(CPFA0B1) /* hvis filen finnes fra før, og +
                          bruker ikke er eier, feiler chgaut */
             chgaut     obj(&tfil) user(*public) dtaaut(*rwx) objaut(*all)
             MONMSG     MSGID(CPFA0A9) /* Objektet finnes ikke */
             monmsg     msgid(cpfA0B1)

 END:        ENDPGM
