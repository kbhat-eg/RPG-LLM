             PGM

/* Initiering av parametre.                                          */

             DCL        VAR(&PROG) TYPE(*CHAR) LEN(10) +
                          VALUE('GL109R')

             DCL        VAR(&RAPP) TYPE(*CHAR) LEN(10) +
                          VALUE('GL109P')

             DCL        VAR(&VALG) TYPE(*CHAR) LEN(1) VALUE(' ')
             DCL        VAR(&LIST)   TYPE(*CHAR) LEN(6)
             DCL        VAR(&IN12)   TYPE(*DEC) LEN(1 0)
             DCL        VAR(&PROG)   TYPE(*CHAR) LEN(10)
             DCL        VAR(&RAPP)   TYPE(*CHAR) LEN(10)
             DCL        VAR(&OVRS)   TYPE(*CHAR) LEN(1)
             DCL        VAR(&FORM)   TYPE(*CHAR) LEN(10)
             DCL        VAR(&OUTQ)   TYPE(*CHAR) LEN(10)
             DCL        VAR(&ACPIX)  TYPE(*CHAR) LEN(4)
             DCL        VAR(&ACPI)   TYPE(*DEC)  LEN(4 0)
             DCL        VAR(&AKOPX)  TYPE(*CHAR) LEN(6)
             DCL        VAR(&AKOP)   TYPE(*DEC)  LEN(6 0)
             DCL        VAR(&HLDQ)   TYPE(*CHAR) LEN(4)
             DCL        VAR(&ALINX)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&ALIN)   TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&PRTY)   TYPE(*CHAR) LEN(1)
             DCL        VAR(&OFLWX)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&OFLW)   TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&BTCH)   TYPE(*CHAR) LEN(1)

             DCL        VAR(&FILG)   TYPE(*CHAR) LEN(3)
             DCL        VAR(&FIRM)   TYPE(*CHAR) LEN(3)
             DCL        VAR(&WWFIRM) TYPE(*DEC) LEN(3 0)

             DCL        VAR(&FREM) TYPE(*CHAR) LEN(8)
             DCL        VAR(&FMOT) TYPE(*CHAR) LEN(8)
             DCL        VAR(&FAVR) TYPE(*CHAR) LEN(8)
             DCL        VAR(&FOCR) TYPE(*CHAR) LEN(8)
             DCL        VAR(&FKTO) TYPE(*CHAR) LEN(8)
             DCL        VAR(&FINK) TYPE(*CHAR) LEN(8)
             DCL        VAR(&FTFF) TYPE(*CHAR) LEN(8)

/* Initiering av parametre.                                          */

             DCL        &MSGDTA *CHAR LEN(120)
             DCL        VAR(&KOMM) TYPE(*CHAR) LEN(4) VALUE('PC  ')
             DCL        VAR(&IN03) TYPE(*DEC) LEN(1 0)
             DCL        VAR(&IN3) TYPE(*CHAR) LEN(1)
             DCL        VAR(&LINJ) TYPE(*DEC) LEN(2 0) VALUE(2)
             DCL        VAR(&POSI) TYPE(*DEC) LEN(3 0) VALUE(43)
             DCL        VAR(&KODE) TYPE(*DEC) LEN(1 0) VALUE(0)
             DCL        VAR(&VALG) TYPE(*CHAR) LEN(1)

/* Parametre som brukes for å kontrollere om program er aktivt:      */

             DCL        VAR(&PRGM) TYPE(*CHAR) LEN(10)
             DCL        VAR(&TYPE) TYPE(*DEC) LEN(1 0)
             DCL        VAR(&AKTI) TYPE(*DEC) LEN(1 0)

/* Parametre som brukes for å hente data fra IFS området             */

             dcl        var(&fradoc) type(*char) len(30)
             dcl        var(&framap) type(*char) len(30)
             dcl        var(&tillib) type(*char) len(10)
             dcl        var(&tilfil) type(*char) len(10)
             dcl        var(&tilmbr) type(*char) len(10)
             dcl        var(&fgr)    type(*char) len(3)
             dcl        var(&sts)    type(*char) len(8)

/* Tester på om DETTE program er aktivt:                             */

             CHGVAR     VAR(&PRGM) VALUE('GL109C    ')
             CHGVAR     VAR(&TYPE) VALUE('0')
             CHGVAR     VAR(&AKTI) VALUE('0')

          CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)

          IF   COND(&AKTI *EQ 1) THEN(DO)

/* Sender opp informasjonsbilde om at program allerede er aktivt:    */

             CHGVAR     VAR(&VALG) VALUE('4')
             CALL       PGM(GL124R) PARM(&IN03 &VALG &LINJ +
                          &POSI &KODE)
             GOTO       CMDLBL(END)
          ENDDO

/* Tester på om program er aktivt:                                   */

      IF         COND(&KOMM *NE 'PC  ') THEN(DO)

             CHGVAR     VAR(&PRGM) VALUE('BANK      ')
             CHGVAR     VAR(&TYPE) VALUE('1')
             CHGVAR     VAR(&AKTI) VALUE('0')

          CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)

/* Program er aktivt!:                                               */

          IF   COND(&AKTI *EQ 1) THEN(DO)
               CHGVAR     VAR(&VALG) VALUE('4')
               CALL       PGM(GL124R) PARM(&IN03 &VALG +
                                           &LINJ &POSI &KODE)
               GOTO       CMDLBL(END)

          ENDDO

/* Program er ikke aktivt.  Det settes nå AKTIVT!                    */

          IF   COND(&AKTI *EQ 0) THEN(DO)
               CHGVAR     VAR(&TYPE) VALUE('0')
               CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)
          ENDDO

      ENDDO

             CLRPFM     FILE(DIRUIE)
             CLRPFM     FILE(DIRRIE)
/*                                                                   */
/* Starter ICF-kommunikasjonsprogram for å HENTE data, dersom        */
/* dette er valgt som kommunikasjonstype på firma.                   */

/* Programmet legger data ut på samlefile GRETPF:                    */

             IF         COND(&KOMM *EQ 'ICF ') THEN(DO)
             CALL       PGM(GL702R) PARM(&IN03)

/* Tester på om program skal avsluttes.                              */

                   IF         COND(&IN03 *EQ 1) THEN(DO)
                   GOTO       CMDLBL(EOJ)
                   ENDDO

             ENDDO

/* Ved PC-kommunikasjon må de forskjellige returfiler slås sammen:   */

/* ( Henter først informasjon om filnavn som brukes ):               */

/* Henter filgruppe og firmanummer:                                  */

             RTVDTAARA  DTAARA(*LDA (931 3)) RTNVAR(&FILG)
             RTVDTAARA  DTAARA(*LDA (944 3)) RTNVAR(&FIRM)
             CHGVAR     VAR(&WWFIRM) VALUE(&FIRM)

             CALL       PGM(GL320C) PARM(&FILG &WWFIRM &FREM &FMOT +
                          &FAVR &FOCR &FKTO &FINK &FTFF)

/* Hopper ut dersom mottaksretur IKKE er utfylt.  Dette indikerer at */
/* sammenslåing av returfiler skjer i egen bat-fil på PC'n, og at    */
/* sammenslåing her IKKE skal gjøres.                                */

/* NB! I faste data, så må det under bankfiler ligge noe i feltet    */
/*     for MOTTAKSRETUR, for at det i hele tatt skal tas hensyn til  */
/*     returene som ligger i mappe PCFILER.                          */

/*     Denne testen kommer her:                                      */
/*     ************************                                      */

             IF         COND(&FMOT *EQ '        ') THEN(DO)
             GOTO       CMDLBL(IKKEBRUK)
             ENDDO

/*           CPYFRMPCD  FROMFLR(PCFILER) TOFILE(GRETPF) +          */
/*                        FROMDOC(&FMOT) MBROPT(*ADD)              */
/*                        Mottaksretur                             */
/*             MONMSG     MSGID(CPF0000)                           */
             rtvdtaara  dtaara(*lda (931 03)) rtnvar(&fgr)
             chgvar     var(&framap)  value('/ASP/' *cat +
                                             &fgr   *cat +
                                             '/' *cat 'PCFILER')
             chgvar     var(&fradoc)  value(&FMOT)
             rtvjoba    curlib(&tillib)
             chgvar     var(&tilfil)  value('GRETPF')
             chgvar     var(&tilmbr)  value('GRETPF')
             chgvar     var(&sts)     value('A')
             call       pgm(aspfrstmf) parm(+
                            &fradoc +
                            &framap +
                            &tillib +
                            &tilfil +
                            &tilmbr +
                            &sts)
 /*          if         cond(&sts *ne ' ') then(goto cmdlbl(feil)) */
               DLTDLO     DLO(&FMOT) FLR(&framap)
               MONMSG     MSGID(CPF0000)

/*           CPYFRMPCD  FROMFLR(PCFILER) TOFILE(GRETPF) +      */
/*                        FROMDOC(&FAVR) MBROPT(*ADD)          */
/*                        Avregningsretur                      */
             chgvar     var(&fradoc)  value(&FAVR)
             chgvar     var(&tillib)  value('*LIBL')
             chgvar     var(&tilfil)  value('GRETPF')
             chgvar     var(&tilmbr)  value('GRETPF')
             chgvar     var(&sts)     value('A')
             call       pgm(aspfrstmf) parm(+
                            &fradoc +
                            &framap +
                            &tillib +
                            &tilfil +
                            &tilmbr +
                            &sts)
/*             MONMSG     MSGID(CPF0000)                        */
               DLTDLO     DLO(&FAVR) FLR(&framap)
               MONMSG     MSGID(CPF0000)

/*           CPYFRMPCD  FROMFLR(PCFILER) TOFILE(GRETPF) +       */
/*                        FROMDOC(&FOCR) MBROPT(*ADD)    OCR-retur */
             chgvar     var(&fradoc)  value(&FOCR)
             chgvar     var(&tillib)  value('*LIBL')
             chgvar     var(&tilfil)  value('GRETPF')
             chgvar     var(&tilmbr)  value('GRETPF')
             chgvar     var(&sts)     value('A')
             call       pgm(aspfrstmf) parm(+
                            &fradoc +
                            &framap +
                            &tillib +
                            &tilfil +
                            &tilmbr +
                            &sts)
/*             MONMSG     MSGID(CPF0000)                        */
               DLTDLO     DLO(&FOCR) FLR(&framap)
               MONMSG     MSGID(CPF0000)

             CPYFRMPCD  FROMFLR(PCFILER) TOFILE(GKTOPF) +
                          FROMDOC(&FKTO) MBROPT(*ADD) /* +
                          Kontoinformasjon */
             chgvar     var(&fradoc)  value(&FKTO)
             chgvar     var(&tillib)  value('*LIBL')
             chgvar     var(&tilfil)  value('GKTOPF')
             chgvar     var(&tilmbr)  value('GKTOPF')
             chgvar     var(&sts)     value('A')
             call       pgm(aspfrstmf) parm(+
                            &fradoc +
                            &framap +
                            &tillib +
                            &tilfil +
                            &tilmbr +
                            &sts)
/*             MONMSG     MSGID(CPF0000)                        */
               DLTDLO     DLO(&FKTO) FLR(&framap)
               MONMSG     MSGID(CPF0000)

/*           CPYFRMPCD  FROMFLR(PCFILER) TOFILE(GRETPF) +      */
/*                        FROMDOC(&FINK) MBROPT(*ADD)          */
/*                        Inkassoretur                         */
             chgvar     var(&fradoc)  value(&FINK)
             chgvar     var(&tillib)  value('*LIBL')
             chgvar     var(&tilfil)  value('GRETPF')
             chgvar     var(&tilmbr)  value('GRETPF')
             chgvar     var(&sts)     value('A')
             call       pgm(aspfrstmf) parm(+
                            &fradoc +
                            &framap +
                            &tillib +
                            &tilfil +
                            &tilmbr +
                            &sts)
/*             MONMSG     MSGID(CPF0000)                        */
               DLTDLO     DLO(&FINK) FLR(&framap)
               MONMSG     MSGID(CPF0000)

/*           CPYFRMPCD  FROMFLR(PCFILER) TOFILE(GRETPF) +       */
/*                        FROMDOC(&FTFF) MBROPT(*ADD)           */
/*                        Feilretur                             */
             chgvar     var(&fradoc)  value(&FTFF)
             chgvar     var(&tillib)  value('*LIBL')
             chgvar     var(&tilfil)  value('GRETPF')
             chgvar     var(&tilmbr)  value('GRETPF')
             chgvar     var(&sts)     value('A')
             call       pgm(aspfrstmf) parm(+
                            &fradoc +
                            &framap +
                            &tillib +
                            &tilfil +
                            &tilmbr +
                            &sts)
/*             MONMSG     MSGID(CPF0000)                        */
               DLTDLO     DLO(&FTFF) FLR(&framap)
               MONMSG     MSGID(CPF0000)

 IKKEBRUK:

/* Skriver ut kvittering på mottatt retur:                           */

             CALL       PGM(GL151C)

/* Tar kopi av GRETPF:                                               */

             GOTO       CMDLBL(OVERA)

/* Bygger hjelpefile dersom den ikke finnes:                         */

             CHKOBJ     OBJ(ADB/GRETPFASP) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(DO)
             CPYF       FROMFILE(ADB/GRETPF) TOFILE(ADB/GRETPFASP) +
                          CRTFILE(*YES)
             MONMSG     MSGID(CPF0000)
             CLRPFM     FILE(ADB/GRETPFASP)
             MONMSG     MSGID(CPF0000)
             ENDDO

/* Kopierer over til hjelpefile:                                     */

             CPYF       FROMFILE(ADB/GRETPF) TOFILE(ADB/GRETPFASP) +
                          MBROPT(*ADD)
             MONMSG     MSGID(CPF0000)

 OVERA:

/* Splitter GRETPF ut på GTGIPF, GOCRPF og GKTOPF:                   */

             CALL       PGM(BF204R)
             CHKOBJ     OBJ(QS36F/MSRJE01) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(CRTPF +
                          FILE(QS36F/MSRJE01) RCDLEN(80) +
                          TEXT('Returdata fra bank'))
             RCLRSC

/* Henter formularparametre:                                         */

/* LDA skal ved oppkall av denne rutinen inneholde en verdi i        */
/* posisjon 844-844 for å fortelle om formularparametre skal         */
/* vises på skjermen (verdi="1") før de legges ut i LDA, eller       */
/* legges direkte ut i LDA fra formularregister (verdi= " ").        */

/* Oppdaterer LDA med navn på prinfile og kode for om formular-      */
/* parametre skal endres.                                            */
/*                                                                   */
             CHGDTAARA  DTAARA(*LDA (800 10)) VALUE(&PROG)
             CHGDTAARA  DTAARA(*LDA (844 1)) VALUE(&VALG)
             CHGDTAARA  DTAARA(*LDA (846 10)) VALUE(&RAPP)

/* Oppkall av utskriftsparametre.                                    */

/*           CALL       PGM(AP100R) PARM(&IN03 &IN12) */

             CALL       PGM(AP600R) PARM('GL109' '1' '0' &IN3 &BTCH)

/* Tester om F3 eller F12 er tastet.  Da skal rapport ikke skrives.  */

             IF         COND(&IN3 *EQ '1') THEN(GOTO CMDLBL(EOJ))
             IF         COND(&IN12 *EQ 1) THEN(GOTO CMDLBL(EOJ))

/* Henter verdier i fra LDA.                                         */

             RTVDTAARA  DTAARA(*LDA (800 10)) RTNVAR(&PROG)
             RTVDTAARA  DTAARA(*LDA (810 10)) RTNVAR(&OUTQ)
             RTVDTAARA  DTAARA(*LDA (820 10)) RTNVAR(&FORM)
             RTVDTAARA  DTAARA(*LDA (830 4)) RTNVAR(&ACPIX)
             RTVDTAARA  DTAARA(*LDA (834 4)) RTNVAR(&HLDQ)
             RTVDTAARA  DTAARA(*LDA (838 6)) RTNVAR(&AKOPX)
             RTVDTAARA  DTAARA(*LDA (845 1)) RTNVAR(&OVRS)
             RTVDTAARA  DTAARA(*LDA (846 10)) RTNVAR(&RAPP)
             RTVDTAARA  DTAARA(*LDA (856 3)) RTNVAR(&ALINX)
             RTVDTAARA  DTAARA(*LDA (859 1)) RTNVAR(&PRTY)
             RTVDTAARA  DTAARA(*LDA (860 3)) RTNVAR(&OFLWX)
             RTVDTAARA  DTAARA(*LDA (863 1)) RTNVAR(&BTCH)

/* ANTALL KOPIER og CPI må konverteres til numerisk felt.            */

             CHGVAR     VAR(&AKOP) VALUE(&AKOPX)
             CHGVAR     VAR(&ACPI) VALUE(&ACPIX)
             CHGVAR     VAR(&ALIN) VALUE(&ALINX)
             CHGVAR     VAR(&OFLW) VALUE(&OFLWX)

             IF         COND(&OVRS *EQ ' ') THEN(GOTO +
                          CMDLBL(NOTOVRPRTF))

/* Endrer printfile ut i fra nye verdier.                            */

             OVRPRTF    FILE(&RAPP) TOFILE(*FILE) DEV(&OUTQ) +
                          PAGESIZE(&ALIN) CPI(&ACPI) +
                          OVRFLW(&OFLW) OUTQ(&OUTQ) +
                          FORMTYPE(&FORM) COPIES(&AKOP) +
                          HOLD(&HLDQ) OUTPTY(&PRTY)

NOTOVRPRTF:

/* Kaller opp program for å splitte kontoinformasjon:                */

             CALL       PGM(DB800C)

/* Bygger GINKPF og GISOPF dersom de IKKE finnes:                    */

             CHKOBJ     OBJ(GINKPF) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(DO)
             CRTPF      FILE(ADB/GINKPF) SRCFILE(*LIBL/QDDFSRC)
             ENDDO

             CHKOBJ     OBJ(GISOPF) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(DO)
             CRTPF      FILE(ADB/GISOPF) SRCFILE(*LIBL/QDDFSRC)
             ENDDO

/* Kaller opp program for å lese filer m/returdata:                  */

             CALL       PGM(GL109R) PARM(&LINJ &POSI)

/* Sletter Kontrollmember:                                           */

 EOJ:
             CHGVAR     VAR(&TYPE) VALUE('2')
             CHGVAR     VAR(&PRGM) VALUE('GL109C    ')
             CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)

             CHGVAR     VAR(&TYPE) VALUE('2')
             CHGVAR     VAR(&PRGM) VALUE('BANK      ')
             CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)
 END:

             ENDPGM
