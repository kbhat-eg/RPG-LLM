             PGM        PARM(&FIRM &KUND &KPRO &VSOR &OGRP &HGRP +
                          &UGRP &LDOR &RFMT &ENDR &DAT2 &SVAL &TVAL +
                          &XVAL &BVAL &LETY &DATO &LAGE &FTIS &FLDR &MEMB)

/*                                                              */
/* 010712 bof : Nytt format IBX, kopieres til IFS               */
/* 040614 bkv : kopiering av regneark: lagt på replace yes      */
/* 150819 hko : Nytt format LOGIQ                               */
/* 040220 bkv : Bugfix i sql: VVENHE var char(2)                */
/* 040220 bkv : Støtte for regnearks                            */
/* 150320 bkv : økt &SQLSTMT2 pga endring i ASPTOXLSX           */
/*                                                              */
             DCL        VAR(&FIRM)     TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&KUND)     TYPE(*DEC)  LEN(6 0)
             DCL        VAR(&KPRO)     TYPE(*DEC)  LEN(6 0)
             DCL        VAR(&VSOR)     TYPE(*CHAR) LEN(10)
             DCL        VAR(&OGRP)     TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&HGRP)     TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&UGRP)     TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&LDOR)     TYPE(*DEC)  LEN(6 0)
             DCL        VAR(&RFMT)     TYPE(*CHAR) LEN(10)
             DCL        VAR(&ENDR)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&DAT2)     TYPE(*CHAR) LEN(10)
             DCL        VAR(&SVAL)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&TVAL)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&XVAL)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&BVAL)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&LETY)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&LAGE)     TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&DATO)     TYPE(*CHAR) LEN(10)
             DCL        VAR(&FTIS)     TYPE(*CHAR) LEN(26)
             DCL        VAR(&FLDR)     TYPE(*CHAR) LEN(12)
             DCL        VAR(&MEMB)     TYPE(*CHAR) LEN(10)

             DCL        VAR(&FILE1)    TYPE(*CHAR) LEN(10)
             DCL        VAR(&FILE2)    TYPE(*CHAR) LEN(25)
             DCL        VAR(&FILE3)    TYPE(*CHAR) LEN(10)
             DCL        VAR(&FILE4)    TYPE(*CHAR) LEN(25)
             DCL        VAR(&KUND_ALF) TYPE(*CHAR) LEN(6)
             DCL        VAR(&KPRO_ALF) TYPE(*CHAR) LEN(6)
             DCL        VAR(&MAPPE)    TYPE(*CHAR) LEN(30)
             DCL        VAR(&FLDX)     TYPE(*CHAR) LEN(16)
             DCL        VAR(&FGRP)     TYPE(*CHAR) LEN(3)

             DCL        VAR(&BIBL)     TYPE(*CHAR) LEN(6)
             DCL        VAR(&FILN)     TYPE(*CHAR) LEN(12)

             DCL        VAR(&CLIB)     TYPE(*CHAR) LEN(10)
             DCL        VAR(&MAPX)     TYPE(*CHAR) LEN(30)
             DCL        VAR(&FFIL)     TYPE(*CHAR) LEN(70)
             DCL        VAR(&TFIL)     TYPE(*CHAR) LEN(70)
             DCL        VAR(&FILNF)    TYPE(*CHAR) LEN(25) -
                        value('IBXfil.txt')
             dcl        var(&type)     type(*char) Len(3)
             dcl        var(&i)        type(*dec)  Len(3 0)
             dcl        var(&j)        type(*dec)  Len(3 0)
             DCL        VAR(&FILEX)    TYPE(*CHAR) LEN(50)
             DCL        &SQLSTMT       TYPE(*CHAR) LEN(1000)
             DCL        &SQLSTMT2      TYPE(*CHAR) LEN(10000)
             CHGVAR     VAR(&SQLSTMT) VALUE('CREATE TABLE QTEMP.VP682PF (  +
                          VVVARE  CHAR  (15), VVNOBB  NUMERIC(8), VVTEK1  +
                          CHAR  (35), VVTEK2  CHAR  (35), VAPTXT  CHAR  +
                          (5), FDRAB1  NUMERIC(5, 2), VVENHE1 CHAR  (3), +
                          VPSAPR1 NUMERIC(12, 6), VPNOPR1 NUMERIC(12, 6), +
                          VVENHE2 CHAR  (3), VEOMRE2 NUMERIC(12, 6), +
                          VPNOPR2 NUMERIC(12, 6), VVENHE3 CHAR  (3), +
                          VEOMRE3 NUMERIC(12, 6), VPNOPR3 NUMERIC(12, 6), +
                          VVOGRP  NUMERIC(2), VVHGRP  NUMERIC(2), VVUGRP  +
                          NUMERIC(3), VGRPT   CHAR  (35), VEPGTI  CHAR  +
                          (14), RLNAVN  CHAR  (30))')

             CHGVAR     VAR(&SQLSTMT2) VALUE('SELECT VVVARE  as "Varenr", +
                          VVNOBB as "Nobbnr" , VVTEK1 as "Varetekst 1", +
                          VVTEK2 as "Varetekst 2" , VAPTXT as "Kode", +
                          FDRAB1 as "Rabatt" , VVENHE1 as "Enh1", VPSAPR1 +
                          as "Bruttopris enh1", VPNOPR1 as "Nettopris +
                          enh1", VVENHE2 as "Enh2", VPNOPR2 as "Nettopris +
                          enh2", VEOMRE2 as "Omr. volum enh2", VVENHE3 as +
                          "Enh3", VPNOPR3 as "Nettopris enh3", VEOMRE3 as +
                          "Omr. volum enh3", VVOGRP as "Overvgr", VVHGRP +
                          as "Hovedvgr", VVUGRP  as "Undervgr", VGRPT as +
                          "Varegruppe-tekst" , VEPGTI as "EAN-nr", RLNAVN  +
                          as "Leverandør" FROM VP682PF')

/* Finner navn på prisfil i.h.t. recordformat                        */

             IF         COND(&RFMT = 'BA-KALK') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBSPF')
             CHGVAR     VAR(&FILE2) VALUE('BA-KALK.TXT')
             ENDDO
/*7.05*/
             IF         COND(&RFMT = 'BA-KALK2') THEN(DO)
                CHGVAR     VAR(&FILE1) VALUE('FIBSPF')
                CHGVAR     VAR(&FILE2) VALUE('BA-KALK.TXT')
             ENDDO
/*7.05*/

             IF         COND(&RFMT = 'BYGGDATA') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBDPF')
             CHGVAR     VAR(&FILE2) VALUE('5001.TXT')
             ENDDO

             IF         COND(&RFMT = 'BYGGDATAWI') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBDPF')
             CHGVAR     VAR(&FILE2) VALUE('5001.TXT')
             ENDDO

             IF         COND(&RFMT = 'CORRADO') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FINNPF')
             CHGVAR     VAR(&FILE2) VALUE('CORRADO.TXT')
             ENDDO

             IF         COND(&RFMT = 'FRIKALK') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIRCPF')
             CHGVAR     VAR(&FILE2) VALUE('PRIS.TXT')
             ENDDO

             IF         COND(&RFMT = 'HOLTE') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIHPPF')
             CHGVAR     VAR(&FILE2) VALUE('HOLTE.TXT')
             ENDDO

             IF         COND(&RFMT = 'NOBB') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FINOPF')
             CHGVAR     VAR(&FILE2) VALUE('BB_PRIS.DAT')
             ENDDO

             IF         COND(&RFMT = 'NOBB_INT') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FINIPF')
             CHGVAR     VAR(&FILE2) VALUE('INTEG.DAT')
             ENDDO

             IF         COND(&RFMT = 'REGNEARK') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIRAPF')
             CHGVAR     VAR(&FILE2) VALUE('REGNEARK.XLS')
             ENDDO

             IF         COND(&RFMT = 'REGNEARKX' *OR &RFMT = 'REGNEARKS') +
                          THEN(DO)
                RUNSQL     SQL(&SQLSTMT) COMMIT(*NONE) NAMING(*SQL)
                CHGVAR     VAR(&FILE1) VALUE('VP682PF')
                CHGVAR     VAR(&FILE2) VALUE('REGNEARK.XLSX')
             ENDDO

             IF         COND(&RFMT = 'REGNEARKPO') THEN(DO)
                CHGVAR     VAR(&FILE1) VALUE('FIRAPF')
                CHGVAR     VAR(&FILE2) VALUE('REGNEARK.XLS')
             ENDDO

 /*spes Gipling start */
             IF         COND(&RFMT = 'REGNEARKM2') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIRAPF')
             CHGVAR     VAR(&FILE2) VALUE('REGNEARK.XLS')
             ENDDO
 /*spes Gipling slutt*/

             IF         COND(&RFMT = 'SALGSSUPP') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FISKPF')
             CHGVAR     VAR(&FILE2) VALUE('SALGSUPP.TXT')
             ENDDO

             IF         COND(&RFMT = 'HS-FAKTURA') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIH1PF')
             CHGVAR     VAR(&FILE2) VALUE('HSVARE.TXT')
             CHGVAR     VAR(&FILE3) VALUE('FIH2PF')
             CHGVAR     VAR(&FILE4) VALUE('RABATT.FIL')
             ENDDO

             IF         COND(&RFMT = 'ENTREKA') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIETPF')
             CHGVAR     VAR(&FILE2) VALUE('ENTREKA.TXT')
             ENDDO

             IF         COND(&RFMT = 'BYGGMANN') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIETPF')
             CHGVAR     VAR(&FILE2) VALUE('BYGGMAN.TXT')
             ENDDO

             IF         COND(&RFMT = 'PRICAT93A') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIPRPF')
             CHGVAR     VAR(&FILE2) VALUE('PRICAT.TXT')
             CHGVAR     VAR(&FILN)  VALUE(' ')
             ENDDO

             IF         COND(&RFMT = 'PRICAT2002') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIPRPF')
             CHGVAR     VAR(&FILE2) VALUE('PRICAT.TXT')
             CHGVAR     VAR(&FILN)  VALUE(' ')
             ENDDO

             IF         COND(&RFMT = 'INTFILE') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIPXPF')
             CHGVAR     VAR(&FILE2) VALUE('FIPXPF.TXT')
             ENDDO

             IF         COND(&RFMT = 'BYGGOFFICE') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBOPF')
             CHGVAR     VAR(&FILE2) VALUE('BYGGOFF.TXT')
             ENDDO

             IF         COND(&RFMT = 'IBX') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBXPF')
             CHGVAR     VAR(&FILE2) VALUE('IBXCAT.TXT')
             ENDDO

             IF         COND(&RFMT = 'LOGIQ') THEN(DO)
                CHGVAR     VAR(&FILE1) VALUE('FILQPF')
                CHGVAR     VAR(&FILE2) VALUE('LOGIQKAT.TXT')
             ENDDO
/* spes Gipling */
             IF         COND(&RFMT = 'BYGGDATA_U') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBYPF')
             CHGVAR     VAR(&FILE2) VALUE('5001.TXT')
             ENDDO

             IF         COND(&RFMT = 'BYGGDATA_2') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBZPF')
             CHGVAR     VAR(&FILE2) VALUE('5001.TXT')
             ENDDO

             IF         COND(&RFMT = 'BYGGDATAM2') THEN(DO)
             CHGVAR     VAR(&FILE1) VALUE('FIBZPF')
             CHGVAR     VAR(&FILE2) VALUE('5001.TXT')
             ENDDO
/* spes Gipling */

/* Tømmer prisfil                                                    */

             CLRPFM     FILE(&FILE1)

             IF         COND(&FILE3 *NE '          ') THEN(DO)
             CLRPFM     FILE(&FILE3)
             ENDDO

/* Oppretter og overrider member i arbeidsfil                        */

             ADDPFM     FILE(VVAWPF) MBR(&MEMB)
             OVRDBF     FILE(VVAWPF) MBR(&MEMB) OVRSCOPE(*CALLLVL)

/* Kaller program for oppdatering av prisfil til kunde/kundeprosj.   */

             IF         COND(&RFMT *NE 'PRICAT93A') THEN(DO)
             IF         COND(&RFMT *NE 'PRICAT2002') THEN(DO)
             CALL       PGM(VP682R) PARM(&FIRM &KUND &KPRO &VSOR +
                          &OGRP &HGRP &UGRP &LDOR &RFMT &ENDR &DAT2 +
                          &SVAL &TVAL &XVAL &BVAL &LETY &DATO &LAGE &FTIS)
             ENDDO
             ENDDO

             IF         COND(&RFMT = 'PRICAT93A') THEN(DO)
             CALL       PGM(VP685R) PARM(&FIRM &KUND &KPRO &VSOR +
                          &OGRP &HGRP &UGRP &LDOR &RFMT &ENDR &DAT2 +
                          &SVAL &TVAL &XVAL &BVAL &LETY &DATO &LAGE &FTIS +
                          &FILN)

             RTVDTAARA  DTAARA(*LDA (931 03)) RTNVAR(&FGRP)
             CHGVAR     VAR(&BIBL) VALUE('EDI' *TCAT &FGRP)
             CPYF       FROMFILE(FIPRPF) TOFILE(&BIBL/&FILN) +
                          FROMMBR(FIPRPF) TOMBR(&FILN) +
                          MBROPT(*REPLACE) CRTFILE(*YES)
             ENDDO

             ELSE IF    COND(&RFMT = 'PRICAT2002') THEN(DO)
             CALL       PGM(VP686R) PARM(&FIRM &KUND &KPRO &VSOR +
                          &OGRP &HGRP &UGRP &LDOR &RFMT &ENDR &DAT2 +
                          &SVAL &TVAL &XVAL &BVAL &LETY &DATO &LAGE &FTIS +
                          &FILN)

             RTVDTAARA  DTAARA(*LDA (931 03)) RTNVAR(&FGRP)
             CHGVAR     VAR(&BIBL) VALUE('EDI' *TCAT &FGRP)
             CPYF       FROMFILE(FIPRPF) TOFILE(&BIBL/&FILN) +
                          FROMMBR(FIPRPF) TOMBR(&FILN) +
                          MBROPT(*REPLACE) CRTFILE(*YES)
             ENDDO

             SNDMSG     MSG(&FILN) TOUSR(*REQUESTER)

/* Fjerner member i arbeidsfil                                       */

             RMVM       FILE(VVAWPF) MBR(&MEMB)

/* Oppretter mappe for kunde og kundeprosjekt                        */

             IF         COND(&RFMT = 'INTFILE') THEN(GOTO CMDLBL(END))

             CHGVAR     VAR(&KUND_ALF) VALUE(&KUND)
             CHGVAR     VAR(&KPRO_ALF) VALUE(&KPRO)

/* Henter filgruppe fra LDA (spes. flersystemmaskin) LDA            */

             RTVDTAARA  DTAARA(*LDA (931 3)) RTNVAR(&FGRP)

             CHGVAR     VAR(&FLDX) VALUE(&FGRP *CAT '/' *TCAT +
                          &FLDR)

/*              CHKDLO     DLO(&FGRP) OBJTYPE(*FLR)                           */
/*              MONMSG     MSGID(CPF8A77) EXEC(DO)                            */
/*              CHGVAR     VAR(&FLDX) VALUE(' ')                              */
/*              CHGVAR     VAR(&FLDX) VALUE(&FLDR)                            */
/*              ENDDO                                                         */

/*              CRTFLR     FLR(&KUND_ALF) INFLR(&FLDX) AUT(*ALL)              */
/*              MONMSG     MSGID(CPF8A85)                                     */
/*              MONMSG     MSGID(CPF8A18)                                     */

             IF         COND(&KPRO *NE 0) THEN(DO)
             CHGVAR     VAR(&MAPPE) VALUE(&FLDX *TCAT '/' *CAT +
                          &KUND_ALF)
/*              CRTFLR     FLR(&KPRO_ALF) INFLR(&MAPPE) AUT(*ALL)             */
             ENDDO

/* Kopierer prisfil til mappe                                        */

             IF         COND(&KPRO *EQ 0) THEN(CHGVAR VAR(&MAPPE) +
                          VALUE(&FLDX *TCAT '/' *CAT &KUND_ALF))
             ELSE       CMD(CHGVAR VAR(&MAPPE) VALUE(&FLDX *TCAT '/' +
                          *CAT &KUND_ALF *TCAT '/' *CAT &KPRO_ALF))

/*           IF         COND(&RFMT = 'IBX') THEN(GOTO CMDLBL(IFS))  */

/*   Ny logikk 11.09.2017 Bare bruke IFS-området                    */

             if         cond(%sst(&mappe 1 3) *eq 'ASP') then(do)
               chgvar   var(&mappe) value(%sst(&mappe 5 15))
             enddo
             if         cond(%sst(&mappe 1 3) *eq &fgrp) then(do)
               chgvar   var(&mappe) value(%sst(&mappe 5 15))
             enddo
             chgvar     var(&i)  value(%scan('.' &file2))
             chgvar     var(&type)  value('txt')
             if         cond(&i *ne 0) then(do)
               chgvar   var(&j)     value(&i + 1)
               chgvar   var(&type)  value(%sst(&file2 &j 3))
               chgvar   var(&j)     value(&i - 1)
               chgvar   var(&file2) value(%sst(&file2 1 &j))
             enddo
             IF         COND(&RFMT = 'REGNEARKX' *OR &RFMT = 'REGNEARKS') +
                          THEN(DO)
                chgvar     var(&filex) value(&file2)
                call       pgm(asptoxlsx) parm(&SQLSTMT2 &mappe &filex +
                             'XLSX')
             ENDDO
             ELSE       DO
                call       pgm(asptostmf) parm(&file1 &file1 &mappe &file2 +
                             &type)
             ENDDO
/*           CPYTOPCD  FROMFILE(&FILE1) TOFLR(&MAPPE) TODOC(&FILE2) +*/
/*                        REPLACE(*YES)                              */

             IF         COND(&FILE3 *NE '          ') THEN(DO)
             chgvar     var(&i)  value(%scan('.' &file4))
             chgvar     var(&type)  value('txt')
             if         cond(&i *ne 0) then(do)
               chgvar   var(&j)     value(&i + 1)
               chgvar   var(&type)  value(%sst(&file4 &j 3))
               chgvar   var(&j)     value(&i - 1)
               chgvar   var(&file4) value(%sst(&file4 1 &j))
             enddo
             call       pgm(asptostmf) parm(&file3 &file3 +
                                       &mappe &file4 &type)
/*           CPYTOPCD  FROMFILE(&FILE3) TOFLR(&MAPPE) TODOC(&FILE4) */
             ENDDO

             GOTO       CMDLBL(END)
 IFS:       /*  Herfra og ut kan tas ut                          */

             RTVJOBA    CURLIB(&CLIB)

 /* Danner mappen på IFS */
             CHGVAR     VAR(&MAPX)  VALUE('/asp/' *TCAT &FGRP +
                                       *TCAT '/' *TCAT 'PRISFIL' +
                                       *TCAT '/' *TCAT &KUND_ALF)
             CRTDIR     DIR(&MAPX)     DTAAUT(*RWX) OBJAUT(*ALL)
             MONMSG     MSGID(CPF0000)
 /* danner og overfører til temp fil */
             CRTSRCPF   FILE(FIBTMP) RCDLEN(1024) MBR(FIBTMP) +
                          TEXT('Temp.fil IBX-format') SIZE(*NOMAX)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(*LIBL/FIBXPF) TOFILE(*LIBL/FIBTMP) +
                          FROMMBR(FIBXPF) TOMBR(FIBTMP) +
                          MBROPT(*REPLACE) FMTOPT(*CVTSRC)

             CHGVAR     VAR(&TFIL) VALUE(&MAPX *TCAT '/' *TCAT &FILNF)

             CHGVAR     VAR(&FFIL) VALUE('/qsys.lib/' *TCAT &CLIB +
                                   *TCAT '.lib/FIBTMP.file/FIBTMP.mbr')

  /*                                                                  */

             CPYTOSTMF  FROMMBR(&FFIL) TOSTMF(&TFIL) +
                           STMFOPT(*REPLACE) STMFCODPAG(*PCASCII)
             CHGAUT     OBJ(&TFIL) USER(*PUBLIC) DTAAUT(*RWX) +
                          OBJAUT(*ALL)

 END:        ENDPGM
