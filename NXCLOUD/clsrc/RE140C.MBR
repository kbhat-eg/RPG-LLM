/* OBS I stmt. 10 angis mappe/delmappe i PCFILER hvor PC-filen hentes*/
/* Nytt program 28.12.09 Visma Integrasjon                           */
             PGM

             DCLF       FILE(RE130D) ALWVARLEN(*YES) ALWNULL(*YES)

             DCL        VAR(&O1FGR) TYPE(*CHAR) LEN(3)
             DCL        VAR(&FLGR) TYPE(*CHAR) LEN(3)
             DCL        VAR(&FRM)   TYPE(*CHAR) LEN(3)
             DCL        VAR(&MELD)  TYPE(*CHAR) LEN(45)
             DCL        VAR(&MAPPE) TYPE(*CHAR) LEN(15) -
                                                VALUE('M03/PCFILER')
/*                                              VALUE('AAA/PCFILER') */
             DCL        VAR(&WPFFIR)   TYPE(*CHAR) LEN(3)
             DCL        VAR(&WMM1) TYPE(*CHAR) LEN(10) +
                          VALUE('LONN      ')
             DCL        VAR(&FIL)    TYPE(*CHAR) LEN(12)
             DCL        VAR(&WFEIL) TYPE(*CHAR) LEN(1) VALUE(' ')
             DCL        VAR(&WALI)   TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&WAPO)   TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&MLD1)   TYPE(*CHAR) LEN(40)
             DCL        VAR(&MLD2)   TYPE(*CHAR) LEN(40)
             DCL        VAR(&MLD3) TYPE(*CHAR) LEN(6) VALUE('Filen')
             DCL        VAR(&MLD4)  TYPE(*CHAR) LEN(19)
             CHGVAR     VAR(&FLGR) VALUE('   ')
             CHGVAR     VAR(&FRM) VALUE(000)
             CHGVAR     VAR(&O1FRM) VALUE('000')
             CHGVAR     VAR(&FIL) VALUE('            ')
             CHGDTAARA  DTAARA(*LDA (211 90)) +
VALUE('                                                              +
                                         ')

             SNDRCVF    RCDFMT(O1WIN)

             RTVDTAARA  DTAARA(*LDA (944 03)) RTNVAR(&WPFFIR)

             CHGVAR     VAR(&FLGR) VALUE(&O1FGR)
             CHGVAR     VAR(&FRM) VALUE(&O1FRM)
             CHGVAR     VAR(&FIL) VALUE(&O1FIL)
             CHGVAR     VAR(%SST(&WMM1 5 3)) VALUE(&WPFFIR)

             IF         COND(&IN03 *EQ '1') THEN(DO)
             GOTO       CMDLBL(ENDPGM)
             ENDDO

/* Test om arbeidsfiler finnes                                     */

             CHKOBJ     OBJ(*LIBL/REINPF) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(DO)
/*           CRTPF      FILE(REINPF) RCDLEN(130) TEXT('Integrasjon + */
/*                        Visma lønn inn') MAXMBRS(*NOMAX)         */
             CHGVAR     VAR(&WALI) VALUE(4)
             CHGVAR     VAR(&WAPO) VALUE(2)
             CHGVAR     VAR(&MLD1) VALUE('Visma lønn poster => ASOKON')
             CHGVAR     VAR(&MLD2) VALUE('Fil REINPF finnes ikke!')
             CALL       PGM(AA006C)  PARM(&WALI &WAPO &MLD1 &MLD2)
             DLYJOB     DLY(10)
             GOTO       CMDLBL(SLUTT)
             ENDDO

             CHKOBJ     OBJ(*LIBL/REUTPF) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(DO)
             CHGVAR     VAR(&WALI) VALUE(4)
             CHGVAR     VAR(&WAPO) VALUE(2)
             CHGVAR     VAR(&MLD1) VALUE('Visma Lønn poster => ASOKON')
             CHGVAR     VAR(&MLD2) VALUE('Fil REUTPF finnes ikke!')
             CALL       PGM(AA006C)  PARM(&WALI &WAPO &MLD1 &MLD2)
             DLYJOB     DLY(10)
             GOTO       CMDLBL(SLUTT)
             ENDDO


/* Bygger membere dersom de ikke finnes                              */
             CHKOBJ     OBJ(*LIBL/REINPF) OBJTYPE(*FILE) MBR(&WMM1)
             MONMSG     MSGID(CPF9815) EXEC(DO)
             ADDPFM     FILE(*LIBL/REINPF) MBR(&WMM1) TEXT('Poster +
                          fra Visma lønn')
                        ENDDO

             CHKOBJ     OBJ(*LIBL/REUTPF) OBJTYPE(*FILE) MBR(&WMM1)
             MONMSG     MSGID(CPF9815) EXEC(DO)
             ADDPFM     FILE(*LIBL/REUTPF) MBR(&WMM1) TEXT('Poster +
                          fra Visma lønn')
                        ENDDO

/* Sletter innholdet fra innlesingsfila                              */

             CLRPFM     FILE(REINPF) MBR(&WMM1)
             CLRPFM     FILE(REUTPF) MBR(&WMM1)

/*  Lager feilmelding                                                */

             CHGVAR     VAR(&MELD) VALUE(&MLD3 *CAT &FIL *CAT &MLD4-
                        *CAT &MAPPE)
             MONMSG     MSGID(IWS1603 CPA0701)

             CPYFRMPCD  FROMFLR(&MAPPE) TOFILE(*LIBL/REINPF) +
                          FROMDOC(&FIL) TOMBR(&WMM1)
             MONMSG     MSGID(IWS1611) EXEC(DO)
             SNDUSRMSG  MSG(&MELD)
             GOTO       CMDLBL(ENDPGM)
             ENDDO
             DLTDLO     DLO(&FIL) FLR(&MAPPE)
             MONMSG     MSGID(IWS1603 CPA0701)

/* Bygger membere dersom de ikke finnes                              */

/* Danner postering                                                  */

             OVRDBF     FILE(REINPF) TOFILE(*LIBL/REINPF) MBR(&WMM1)
             OVRDBF     FILE(REUTPF) TOFILE(*LIBL/REUTPF) MBR(&WMM1)

             CALL       PGM(RE140R) PARM(&FLGR &FRM)
/*           MONMSG     MSGID(CPF0000)            */

/*           OVRDBF     FILE(RTRALU) TOFILE(*LIBL/RTRALU) MBR(&WMM1) */
/*           OVRDBF     FILE(RBUNLU) TOFILE(*LIBL/RBUNLU) MBR(&WMM1) */
/*           OVRDBF     FILE(RBUNL1) TOFILE(*LIBL/RBUNL1) MBR(&WMM1) */

/* Danner postering                                                  */

             CALL       PGM(RE131R) PARM(&WMM1)
/*           MONMSG     MSGID(CPF0000)            */
             CHGVAR     VAR(&WFEIL) VALUE(%SST(*LDA 211 1))
             IF         COND(&WFEIL *EQ '1') THEN(DO)
             CHGVAR     VAR(&WALI) VALUE(4)
             CHGVAR     VAR(&WAPO) VALUE(2)
             CHGVAR     VAR(&MLD1) VALUE('Visma Lønn poster => ASOKON')
             CHGVAR     VAR(&MLD2) VALUE('Feil firmagruppe/firma!')
             CALL       PGM(AA006C)  PARM(&WALI &WAPO &MLD1 &MLD2)
             DLYJOB     DLY(05)
             ENDDO

 SLUTT:
             DLTOVR     FILE(*ALL)

 ENDPGM:     ENDPGM
