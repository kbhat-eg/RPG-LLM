             PGM

/* -----------------------------------------------------------------*/
/* 7.01 140220 bsa Endret logikk for avslutning                     */
/* 7.02 050620 bsa Sender med overføringsanmodning som parameter    */
/*                                                                  */
/*------------------------------------------------------------------*/

             dcl        var(&fsta) type(*char) len(1)
             dcl        var(&stat) type(*char) len(1)
             dcl        var(&bsta) type(*char) len(1) value('0')
             dcl        var(&numb) type(*dec) len(2)
             dcl        var(&t)    type(*char) len(20)
/*7.02*/     dcl        var(&ovrf) type(*char) len(10)

             chgvar     var(&numb) value(0)
/*7.02*/     chgvar     var(&ovrf)   value('NBSEDIHNTB')

/* Sjekk om innhenting allerede pågår                                */

 ny_sjekk:   chgvar     var(&bsta) value('0')

/*7.02*/     call       pgm(li719r) parm(&ovrf &bsta)
             if         cond(&bsta *eq '1') then(do)
             chgvar     var(&numb) value(&numb + 1)
/*7.01*/     if         cond(&numb *gt 10) then(goto cmdlbl(vent))
             dlyjob     dly(5)
             goto       cmdlbl(ny_sjekk)
             enddo

/* Klargjør filer før mottak                                         */

             clrpfm     file(lwerpf)
             clrpfm     file(lwefpf)
             clrpfm     file(lweopf)
             clrpfm     file(lweppf)
             clrpfm     file(lwebpf)

/* Call til program for kommunikasjon  IBM + NBS                     */
             call       pgm(li703c_sbe) parm(&fsta)
             if         cond(&fsta *eq 'E') then(do)
             goto       cmdlbl(slutt)
             enddo

/* Call til program for oppdatering                                  */
             call       pgm(li700r)  parm(&stat)
/*           if         cond(&stat *eq 'E') then(do)                 */
/*           goto       cmdlbl(slutt)                                */
/*           enddo                                                   */

/* Call til program for oppdatering statusregister                   */
             call       pgm(li726r)  parm(&stat)

/* Avslutter ikke før kl 2100 - kjøres på nytt etter 10 minutter     */

vent:        chgvar     var(&numb) value(0)
             rtvsysval  sysval(qtime) rtnvar(&t)
             if         cond(%substring(&T 1 4) *lt '2100') then(do)
                        dlyjob     dly(600)
                        goto  cmdlbl(ny_sjekk)
             enddo

/* Tømmer filer som er brukt under innlesing                         */

             CLRPFM     FILE(LWERPF)
             CLRPFM     FILE(LWEFPF)
             CLRPFM     FILE(LWEOPF)
             CLRPFM     FILE(LWEPPF)
             CLRPFM     FILE(LWEBPF)

/* Call til program for oppdatering statusregister                   */
slutt:       call       pgm(li726r)  parm(&stat)

end:         ENDPGM
