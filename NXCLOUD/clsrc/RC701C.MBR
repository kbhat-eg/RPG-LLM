             PGM
/*   Innbetalinger til Svea                                          */
/*   Tar med innbet. som ikke er overført før                        */
/*   Forrige overføring må være fullført.                            */

/* Definerer variable                                                */

             DCL        VAR(&MLD1)  TYPE(*CHAR) LEN(50)
             DCL        VAR(&MLD2)  TYPE(*CHAR) LEN(50)
             DCL        VAR(&svar)  TYPE(*char) LEN(1)
             DCL        VAR(&in12)  TYPE(*DEC)  LEN(1 0)

/*FTP*/
             DCL        VAR(&fgr)   TYPE(*CHAR) LEN(3)
             DCL        VAR(&mbrsz) TYPE(*dec)  LEN(10 0)

/*IFS*/
             DCL        VAR(&WPFILE) TYPE(*CHAR) LEN(20)
             DCL        VAR(&dat)    TYPE(*CHAR) LEN(6)
             DCL        VAR(&svea)   TYPE(*CHAR) LEN(50)
             DCL        VAR(&w_t)    TYPE(*dec)  LEN(2 0)
             DCL        VAR(&w_tx)   TYPE(*char) LEN(2)

/*  NB!!! */ addlible   asokon630
             addlible   askorr630
             addlible   asutvk_g01
             addlible   askund_g01
             addlible   aspgpl630
             addlible   aspgplu630
             addlible   aspgplk
             addlible   G01gpl
             addlible   adb
             addlible   g01

 /*  NB */   chgcurlib  curlib(adbg01)
             chgdtaara  dtaara(*lda (911 30)) +
                          value('G01EGSVSTR          G01ADBG01 ')
             chgdtaara  dtaara(*lda (944 3)) +
                          value('000')

             rtvjoba    date(&dat)
             crtdtaara  dtaara(SVEASTATUS) type(*char) len(50) +
                          value('   ') text('Status på overføring +
                          Innbet til Svea')
             monmsg     msgid(cpf0000)

             RTVdtaara  dtaara(*lda (931 3)) rtnvar(&fgr)
/* Dette gjeld bare test for å kunne kjøre om ubegrenset innt. videre*/
             if         cond(&fgr *eq 'G0S') then(do)
               clrpfm   file(adbg0x/rktspf)
               clrpfm   file(adbg0x/rcsvpf)
             enddo
/* Dette gjeld b....    Hit                                          */
/*   Sjekk om siste overføring gikk ok                             */
             rtvmbrd    file(RCSVPF) mbr(*first) nbrcurrcd(&mbrsz)
             if         cond(&mbrsz *ne 0) then(do)
               CHGVAR   VAR(&MLD1) VALUE('Overføring til Svea Ekonomi')
               CHGVAR   VAR(&MLD2) VALUE('Siste overføring er ikke +
                                     fullført, jobben avbrytes')
               chgdtaara dtaara(Sveastatus) value('Siste ovf ikke +
                                 overført ' *tcat &dat)
    /*         CALL     PGM(AA007r)  PARM(&mld1 &mld2 &svar &in12) */
               goto     cmdlbl(end)
             enddo

/* Kjør ut fil over innbetalinger til SVEA                          */

             clrpfm      file(*libl/RCSVPF)
             monmsg      msgid(cpf3333) exec(do)
               call      pgm(rgcsvc) parm(&fgr ' ')
             enddo

             call        pgm(RC701R)
/*   Sjekk om det ble lagt ut noen linjer til overføring           */
             rtvmbrd    file(RCSVPF) mbr(*first) nbrcurrcd(&mbrsz)
             if         cond(&mbrsz *eq 0) then(do)
               CHGVAR   VAR(&MLD1) VALUE('Overføring til Svea Ekonomi')
               CHGVAR   VAR(&MLD2) VALUE('Det var ingen innbet. +
                                     til overføring, Job avbrytes')
               chgdtaara dtaara(Sveastatus) value('Ingen transer' +
                                 *tcat &dat)
   /*          CALL     PGM(AA007r)  PARM(&mld1 &mld2 &svar &in12) */
               goto     cmdlbl(end)
             enddo

/* Bygger filnavn og kataloger                                       */
             rtvdtaara  dtaara(SVEA_PAR (1 50)) rtnvar(&svea)
             monmsg     msgid(CPF1015) exec(do)
               chgvar     var(&svea)   value(&dat *tcat '00')
               crtdtaara  dtaara(SVEA_PAR) type(*char) len(50) +
                          value(&svea)
             enddo
             chgvar     var(&w_t)   value(%sst(&svea 7 2))
             if         cond(%sst(&svea 1 6) *ne &dat) then(do)
               chgvar   var(&w_t)  value(00)
             enddo
             chgvar     var(&w_t)   value(&w_t + 1)
             chgvar     var(&w_tx)  value(&w_t)
             CHGVAR     VAR(&WPFILE) VALUE('b' *tcat %sst(&dat 3 2) +
                                               *tcat %sst(&dat 1 2) +
                                               *tcat (&w_tx) +
                                               *tcat '.MG')
             chgvar      var(&svea)  value(&dat *tcat &w_tx)
             chgdtaara   dtaara(SVEA_PAR *ALL) value(&svea)

/* Overfører via ftp (Foreløpig,  nå bare som en backup)            */

             cpyf       fromfile(rcsvpf) tofile(*curlib/&wpfile) +
                          mbropt(*replace) crtfile(*yes) fmtopt(*nochk)

/* Overfører innbetalinger m/SFTP                                    */


/*           CALL       PGM(AF700C) PARM(&OVRF &STAT &wpfile &SMSG)  */
             Call       pgm(rc701FC)
             chgdtaara  dtaara(Sveastatus) value('Transer er +
                                 overført ' *tcat &dat)
/* Hvordan gikk overføringen?                                        */

/*           if         cond(&stat *ne ' ') then(do)      */
/*             goto     cmdlbl(error)                     */
/*           enddo                                        */

/* Varselbilde OK                                                    */

/*           CHGVAR  VAR(&MLD1) VALUE('Overføring til Svea Ekonomi') */
/*           CHGVAR  VAR(&MLD2) VALUE('**** OVERFØRING OK! **** ')   */
/*           CALL    PGM(AA007r)  PARM(&mld1 &mld2 &svar &in12)      */


/* Tømmer overføringsfile for poster etter å ha tatt backup          */

             DLTF       FILE(RcsvPF_BAC)
             MONMSG     MSGID(CPF2105)

             CPYF       FROMFILE(*LIBL/RCSVPF) +
                          TOFILE(*CURLIB/RCSVPF_BAC) +
                          MBROPT(*REPLACE) CRTFILE(*YES) FMTOPT(*NOCHK)

             CLRPFM     FILE(*LIBL/RCsvPF) MBR(RCsvPF)
             GOTO       CMDLBL(END)

 ERROR:

/* Varselbilde FEIL                                                  */

             CHGVAR     VAR(&MLD1) VALUE('Overføring til Svea Ekonomi')
             CHGVAR     VAR(&MLD2) VALUE('**** OVERFØRING FEILET ****')
             CALL       PGM(AA007r)  PARM(&mld1 &mld2 &svar &in12)

 END:        ENDPGM
