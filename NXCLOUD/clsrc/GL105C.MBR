             PGM        PARM(&BFNR)

/* Har lagt inn at også XML fil dannes                               */
/* Initiering av parametre.                                          */

             DCL        VAR(&BFNR) TYPE(*CHAR) LEN(3)
             DCL        VAR(&IN03) TYPE(*DEC) LEN(1 0)
             DCL        VAR(&IN3) TYPE(*CHAR) LEN(1)
             DCL        VAR(&IN12) TYPE(*DEC) LEN(1 0)

             DCL        VAR(&PROG) TYPE(*CHAR) LEN(10) +
                          VALUE('GL105R')

             DCL        VAR(&RAPP1) TYPE(*CHAR) LEN(10) +
                          VALUE('GL105PJ')

             DCL        VAR(&RAPP2) TYPE(*CHAR) LEN(10) +
                          VALUE('GL105PN')

             DCL        VAR(&VALG) TYPE(*CHAR) LEN(1) VALUE('0')

             DCL        VAR(&OVRS)   TYPE(*CHAR) LEN(1)
             DCL        VAR(&FORM)   TYPE(*CHAR) LEN(10)
             DCL        VAR(&OUTQ)   TYPE(*CHAR) LEN(10)
             DCL        VAR(&ACPIX)  TYPE(*CHAR) LEN(4)
             DCL        VAR(&ACPI)   TYPE(*DEC)  LEN(4 0)
             DCL        VAR(&AKOPX)  TYPE(*CHAR) LEN(6)
             DCL        VAR(&AKOP)   TYPE(*DEC)  LEN(6 0)
             DCL        VAR(&HLDQ)   TYPE(*CHAR) LEN(4)
             DCL        VAR(&ALINX)  TYPE(*CHAR)  LEN(3)
             DCL        VAR(&ALIN)   TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&PRTY)   TYPE(*CHAR) LEN(1)
             DCL        VAR(&OFLWX)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&OFLW)   TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&BTCH)   TYPE(*CHAR) LEN(1)

             DCL        VAR(&KODE) TYPE(*DEC) LEN(1 0) VALUE(0)
             DCL        VAR(&VALG) TYPE(*CHAR) LEN(1)
             DCL        VAR(&LINJ) TYPE(*DEC) LEN(2 0) VALUE(2)
             DCL        VAR(&POSI) TYPE(*DEC) LEN(3 0) VALUE(43)

/* Parametre som brukes for å kontrollere om program er aktivt:      */

             DCL        VAR(&PRGM) TYPE(*CHAR) LEN(10)
             DCL        VAR(&TYPE) TYPE(*DEC) LEN(1 0)
             DCL        VAR(&AKTI) TYPE(*DEC) LEN(1 0)

/* Dersom firma som kaller opp rutinen IKKE har utplukk til          */
/* samlefile, så medfører dette at GL106C blir kalt opp i            */
/* GL105R, d.v.s. utplukket legges ut på DIRREM direkte.  Det        */
/* må i denne forbindelsen testes på at overføringsprogram           */
/* til DIRREM ikke allerede er aktivt, d.v.s. GL106C kan ikke        */
/* allerede være i bruk:                                             */

/* Tester på om data IKKE overføres via samlefile.  KODE er        */
/* "1" dersom dette er tilfelle:                                     */

               GOTO       CMDLBL(OVER)

             CHGVAR     VAR(&VALG) VALUE('5')
             CALL       PGM(GL124R) PARM(&IN03 &VALG &LINJ +
                          &POSI &KODE)

/* Dersom KODE er "1" må det kontrolleres at GL106 ikke er aktivt. */
/* Dersom det allerede er låst, så vil program bli avsluttet.        */

       IF         COND(&KODE *EQ 1) THEN(DO)

             CHGVAR     VAR(&PRGM) VALUE('GL106C    ')
             CHGVAR     VAR(&TYPE) VALUE('1')
             CHGVAR     VAR(&AKTI) VALUE('0')

          CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)

          IF   COND(&AKTI *EQ 1) THEN(DO)
/* Program er aktivt!:                                               */
               CHGVAR     VAR(&VALG) VALUE('6')

               CALL       PGM(GL124R) PARM(&IN03 &VALG +
                                           &LINJ &POSI &KODE)

               GOTO       CMDLBL(END)

          ENDDO

/* Kontrollerer om DENNE rutinen (GL105C) er aktiv.                  */

             CHGVAR     VAR(&PRGM) VALUE('GL105C    ')
             CHGVAR     VAR(&TYPE) VALUE('0')
             CHGVAR     VAR(&AKTI) VALUE('0')

          CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)

          IF   COND(&AKTI *EQ 1) THEN(DO)
/* Program er aktivt!:                                               */
               CHGVAR     VAR(&VALG) VALUE('6')
               CALL       PGM(GL124R) PARM(&IN03 &VALG +
                                           &LINJ &POSI &KODE)
               GOTO       CMDLBL(END)

          ENDDO

       ENDDO

 OVER:

/* LDA skal ved oppkall av denne rutinen inneholde en verdi i        */
/* posisjon 844-844 for å fortelle om formularparametre skal         */
/* vises på skjermen (verdi="1") før de legges ut i LDA, eller       */
/* legges direkte ut i LDA fra formularregister (verdi= " ").        */

/* Oppdaterer LDA med navn på printfile og kode for om formular-     */
/* parametre skal endres.                                            */

             CHGDTAARA  DTAARA(*LDA (800 10)) VALUE(&PROG)
             CHGDTAARA  DTAARA(*LDA (844 1)) VALUE(&VALG)

/* Oppkall av utskriftsparametre.                                    */

/*           CALL       PGM(AP100R) PARM(&IN03 &IN12) */

             CALL       PGM(AP600R) PARM('GL105' '1' '0' &IN3 &BTCH)

/* Dersom F3  skal ikke rapporten skrives                   */

             IF         COND(&IN3 *EQ '1') THEN(GOTO CMDLBL(END))

/* Henter verdier i fra LDA.                                         */

             RTVDTAARA  DTAARA(*LDA (800 10)) RTNVAR(&PROG)
             RTVDTAARA  DTAARA(*LDA (810 10)) RTNVAR(&OUTQ)
             RTVDTAARA  DTAARA(*LDA (820 10)) RTNVAR(&FORM)
             RTVDTAARA  DTAARA(*LDA (830 4)) RTNVAR(&ACPIX)
             RTVDTAARA  DTAARA(*LDA (834 4)) RTNVAR(&HLDQ)
             RTVDTAARA  DTAARA(*LDA (838 6)) RTNVAR(&AKOPX)
             RTVDTAARA  DTAARA(*LDA (845 1)) RTNVAR(&OVRS)
             RTVDTAARA  DTAARA(*LDA (856 3)) RTNVAR(&ALINX)
             RTVDTAARA  DTAARA(*LDA (859 1)) RTNVAR(&PRTY)
             RTVDTAARA  DTAARA(*LDA (860 3)) RTNVAR(&OFLWX)
             RTVDTAARA  DTAARA(*LDA (863 1)) RTNVAR(&BTCH)

/* ANTALL KOPIER, LINJER og CPI må konverteres til numerisk felt.    */

             CHGVAR     VAR(&AKOP) VALUE(&AKOPX)
             CHGVAR     VAR(&ACPI) VALUE(&ACPIX)
             CHGVAR     VAR(&ALIN) VALUE(&ALINX)
             CHGVAR     VAR(&OFLW) VALUE(&OFLWX)

/* Tester om printfile skal overrides.                               */

             IF         COND(&OVRS *EQ ' ') THEN(GOTO +
                          CMDLBL(NOTOVRPRTF))

/* Endrer printfiler ut i fra nye verdier.                           */

             OVRPRTF    FILE(&RAPP1) TOFILE(*FILE) DEV(&OUTQ) +
                          PAGESIZE(&ALIN) CPI(&ACPI) +
                          OVRFLW(&OFLW) OUTQ(&OUTQ) +
                          FORMTYPE(&FORM) COPIES(&AKOP) +
                          HOLD(&HLDQ) OUTPTY(&PRTY)
/*                                                                   */
             OVRPRTF    FILE(&RAPP2) TOFILE(*FILE) DEV(&OUTQ) +
                          PAGESIZE(&ALIN) CPI(&ACPI) +
                          OVRFLW(&OFLW) OUTQ(&OUTQ) +
                          FORMTYPE(&FORM) COPIES(&AKOP) +
                          HOLD(&HLDQ) OUTPTY(&PRTY)
NOTOVRPRTF:

/* Kaller opp program for overføring til samlefile.                  */

             CALL       PGM(GL105R) PARM(&BFNR)

/* Sletter Kontrollmember for overføring uten samlefile:             */

             CHGVAR     VAR(&TYPE) VALUE('2')
             CHGVAR     VAR(&PRGM) VALUE('GL106C    ')
             CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)

/* Sletter Kontrollmember for overføring via samlefile:              */

             CHGVAR     VAR(&TYPE) VALUE('2')
             CHGVAR     VAR(&PRGM) VALUE('GL105C    ')
             CALL       PGM(GLCHKPGM) PARM(&PRGM &TYPE &AKTI)
/* Så danner vi XML fil                                              */
             CALL       PGM(GL300R)

 END:
             ENDPGM
