# Program RH662R – Main Ledger VAT Assignment (Parameter Input)

## Overview

**Program Name:** RH662R  
**System:** ASOKON  
**Purpose:**  
This program serves as a parameter entry and validation routine for generating a VAT (MVA) report from the main ledger. It is typically called as a preliminary step before the actual report execution, allowing the user to specify or confirm key parameters such as accounting year, period, and VAT period. The parameters are then written to the LDA (Local Data Area), making them available for subsequent processes.

## Business Context

- **Domain:** Norwegian accounting, specifically handling VAT reporting periods.
- **User Interaction:** The user is prompted via a workstation display (A2BLD) to enter or confirm reporting parameters. The program provides validation and warning mechanisms, especially regarding the accounting year.
- **Integration:** The program reads user information from the `AUSRL1` file and writes parameters to the LDA for use by downstream processes.

## Structure and Flow

### File Declarations

- **AUSRL1**: User master file (keyed, input, disk). Used to fetch user and company info.
- **RH662D**: Workstation file (display) for user interaction.

### Key Data Structures and Fields

- **Parameter Fields** (prefix `rh`):  
  Used for storing selected parameters in the LDA.
- **Screen Fields** (prefix `a2`):  
  Used for screen interaction.
- **Local Variables**:  
  For temporary storage, user info, and warning messages.

### Indicator Usage

- **KA (F1)**: Select company
- **KC (F3)**: Exit
- **LR**: End program
- **Indicators 30–99**:  
  Used for field protection, warnings, file operations, and subroutine logic as per project conventions.

### Main Logic

#### 1. Initialization (`*INZSR`)

- Sets default values for the parameter screen based on the current system date.
- Determines default accounting year, period, and VAT period according to the current month.
- Copies user and company info from the LDA (populated by the calling program/environment) to local variables.
- Fetches the user record from `AUSRL1` for additional information if needed.

#### 2. Parameter Entry Screen (`A2BLD`)

- Displays the parameter entry screen (`A2BLD`) and waits for user input.
- If F3 (exit) is pressed, sets a return code and exits.
- If no date is entered, defaults to the current system date.
- Validates the entered date (using `TEST(D)`).
- If the date is invalid, redisplays the screen for correction.

#### 3. Business Validation

- Checks if the entered accounting year is greater than the current year.
- If so, displays a warning message (`M1WIN`) and requires user confirmation to proceed.
- If not confirmed, redisplays the parameter entry screen.

#### 4. Parameter Output

- Upon successful validation, moves the selected parameters from the screen fields to the LDA fields for use by subsequent programs.
- Sets the test indicator to 'O' (purpose not fully detailed, possibly for operational or test mode).
- Returns to the caller, signaling end of parameter entry.

#### 5. Warning Display Subroutine (`XM1WIN`)

- Handles modal warning messages requiring user confirmation.
- If F3 is pressed during warning, assumes 'No' as the answer.

## Notable Design Decisions and Patterns

- **LDA Usage:**  
  Parameters are passed via the LDA, a common pattern in legacy IBM i systems for inter-program communication.
- **Indicator Conventions:**  
  The program uses a strict indicator range convention for different types of logic (field protection, warnings, file operations, etc.), which is standard in this codebase.
- **Screen Handling:**  
  Uses a dedicated screen (`A2BLD`) for parameter entry and a separate window (`M1WIN`) for warnings and confirmations.
- **Year/Period Logic:**  
  The program automatically determines the default reporting period based on the current month, with special handling for January/February (defaults to previous year, period 12).

## Interactions with Other Modules/Data

- **User File (`AUSRL1`):**  
  Used to fetch additional user information, possibly for display or access control.
- **Display Files (`RH662D`):**  
  All user interaction is via workstation screens defined in this display file.
- **LDA:**  
  Central mechanism for passing parameters to downstream processes (e.g., the actual VAT report generator).

## Business Rules Encapsulated

- **VAT Period Selection:**  
  The mapping of months to accounting periods and VAT periods is hardcoded, reflecting standard Norwegian VAT reporting cycles.
- **Year Validation:**  
  Entering a year greater than the current system year triggers a confirmation prompt, preventing accidental future-dated reports.
- **Exit Handling:**  
  F3 (KC) is universally used to exit the screen/program.

## Extensibility and Maintenance Notes

- **Parameter Extensions:**  
  Additional parameters can be added by extending both the display and LDA field mappings.
- **Validation Logic:**  
  All validation is performed before writing to the LDA, ensuring downstream processes receive only vetted parameters.
- **Localization:**  
  Some comments and messages are in Norwegian; maintain consistency for future updates.

## Summary Table: Key Fields

| Field      | Purpose                                | Source      | Destination   |
|------------|----------------------------------------|-------------|---------------|
| a2pkda     | Run date (kjøredato)                   | Screen      | rhpkda (LDA)  |
| a2prår     | Accounting year (regnskapsår)          | Screen      | rhprår (LDA)  |
| a2pper     | Accounting period                      | Screen      | rhpper (LDA)  |
| a2pmva     | VAT period                             | Screen      | rhpmva (LDA)  |
| a2pmv0     | VAT zero indicator                     | Screen      | rhpmv0 (LDA)  |
| a2ptst     | Test indicator                         | Screen      | rhptst (LDA)  |
| a2psps     | Special processing indicator           | Screen      | rhpsps (LDA)  |
| l_user     | User ID                                | LDA         | w_user        |
| l_firm     | Company number                         | LDA         | w_firm        |
| l_fnav     | Company name                           | LDA         | w_navn        |

## Error and Warning Handling

- **Invalid Date:**  
  Detected via `TEST(D)`; user must correct before proceeding.
- **Future Year:**  
  User must confirm before proceeding; otherwise, the screen is redisplayed.
- **Exit:**  
  Immediate return with status if F3 is pressed.

## Conclusion

This program is a robust, user-driven parameter entry and validation front-end for VAT reporting in the main ledger. It enforces business rules, ensures data integrity, and prepares parameters for downstream processing via the LDA, all while adhering to established indicator and field conventions in the codebase.