# RC110R – Saksregister Maintenance Program Documentation

## Overview

**Program:** RC110R  
**System:** ASOKON  
**Description:** This program manages the "saksregister" (case register) for the ASOKON system. It provides maintenance (create, update, view) functionality for cases via a subfile-driven green-screen interface. The program is tailored for Norwegian business processes, particularly within debt collection (inkasso) operations, and includes integration points toward external systems (notably Lindorf).

---

## Business and Domain Context

- **Saksregister**: Central registry of cases ("saker"), each identified by keys such as customer number (`rcnask`), case number (`rcnsak`), and sub-case number (`rcnasb`).
- **Inkassobyrå**: Debt collection agency. The program restricts visibility and actions to cases associated with the currently active agency.
- **Lindorf Integration**: Supports lookup and linking to external case information via dynamically constructed URLs.

---

## File and Data Relationships

### Physical Files

- **RCNFL1, RCNFL2, RCNFLR**: Main case files, variants for different access patterns.
- **RKUNL1**: Customer master.
- **RCA0L1**: Agency master (used to restrict visibility to the active agency).

### Display Files

- **RC110D**: Workstation file with subfile (`b1sfl`) and various control records.

---

## Key Program Structure

### Indicators

- **LR**: End program.
- **10, 12, 13, 14, 15, 16**: Subfile and display management.
- **21, 22**: Cursor positioning.
- **30**: Field protection.
- **31-79**: Error and warning indicators.
- **80-89**: Work indicators.
- **90-99**: File operation results.

### Data Areas

- **LDA**: Used to retrieve firm number and other session context.

### Arrays

- **a_meld**: Holds messages for display (e.g., "Ny post", "Endring", "Vise").

---

## Main Program Logic

### Initialization (`*inzsr`)

1. Defines key lists for all file access patterns.
2. Retrieves firm number from LDA.
3. Loads agency master data to restrict subsequent queries.
4. Positions main case file and populates the subfile with initial data.

### Main Loop (B2CTL/B2CMD)

1. **Display Main Menu**: Presents subfile and control options.
2. **Function Key Handling**:
   - F3/F12: Exit.
   - F5: Refresh subfile.
   - F7: Toggle between showing all/open cases.
   - Roll (F10): Page subfile.
   - Home (F21): Cursor positioning.

3. **Subfile Control**:
   - Handles positioning (by customer or case number).
   - Validates keys and invokes change/view routines as needed.

4. **Subfile Processing**:
   - Reads user actions from the subfile.
   - Handles change, view, and Lindorf lookup actions per record.

---

## Subroutines

### `forny` (Refresh Subfile)

- Repositions the file pointer based on the current search mode (customer/case).
- Clears and repopulates the subfile.

### `posisjoner` (Positioning)

- Allows positioning by customer number or case number.
- Clears and repopulates the subfile to reflect the new position.

### `control` (Subfile Control Handler)

- Validates keys.
- Invokes change or view routines (`xc2bld`) as appropriate.
- Handles error signaling and subfile refresh.

### `subfile` (Subfile Record Processing)

- Iterates through visible subfile records.
- Handles per-record actions:
  - **Change**: Opens the change dialog, updates subfile.
  - **View**: Opens the view dialog, updates subfile.
  - **Lindorf lookup**: Constructs the URL, calls external program (`AP628C`), updates subfile.

### `xc2bld` (Change/View Dialog)

- Reads the selected case.
- Fills the dialog fields with case and customer data.
- Handles field protection and message display depending on mode (change/view).
- On change, updates the case file and refreshes the subfile row.

### `clr_subfile` (Clear Subfile)

- Clears the subfile and resets all subfile-related counters.

### `crt_subfile` (Create/Populate Subfile)

- Reads records from the main case file into the subfile, applying:
  - File group filtering.
  - Agency filtering (only cases for the active agency).
  - Status filtering (open/all cases toggle).
- For each record, retrieves customer name from the customer master.
- Maintains paging logic for the subfile.

### `dsp_subfile` (Display Subfile)

- Displays the subfile control screen, setting indicators as needed depending on whether there are records.

---

## Notable Design Decisions & Patterns

- **Subfile Paging**: Paging is handled via `w_srrn`, `w_spge`, `w_sfrn`, and `w_ssrn`. The subfile is loaded in chunks to support efficient navigation.
- **Dynamic Key Lists**: Key lists are defined for each file access pattern, supporting both positioning and updates.
- **Indicator-Driven UI**: The program relies heavily on indicators for UI state, error signaling, and field protection.
- **Business Rule Enforcement**: The agency filter (`rcncnk <> rc0cnk`) ensures users only see cases for their agency. This is a critical business constraint.
- **External System Integration**: The program supports integration with Lindorf by dynamically constructing URLs and invoking an external program (`AP628C`). The URL templates are defined as constants, and the actual search value is inserted using `%scan` and `%subst`.
- **Localized Messages**: The use of the `a_meld` array for dialog messages, with content in Norwegian, supports localized UI feedback.

---

## Integration Points

- **Lindorf**: External debt collection system. The program can construct various search URLs (by customer number, SSN, organization number, or creditor reference) and pass them to an external handler.
- **AP628C**: External program invoked for Lindorf lookups.

---

## Special Considerations

- **Cloud Adaptations**: The code contains comments referencing cloud adaptations (see `7.xx`), indicating modifications for running in cloud environments.
- **Subfile Size Adjustments**: The subfile size and display logic have been tuned for usability and performance (see `7.02`).
- **Check Box Values**: There are explicit adjustments for handling check box values in the graphical interface (`7.01`).
- **Agency Visibility**: As of `7.03`, the subfile only shows cases for the active inkassobyrå.

---

## User Actions Supported

- **Create New Case**: Not explicitly shown in the provided code but implied by message array and UI design.
- **Change Case**: Select a row, choose 'change', edit fields, save.
- **View Case**: Select a row, choose 'view', fields protected, no changes allowed.
- **Lindorf Lookup**: Select a row, choose 'lookup', triggers external search.
- **Subfile Navigation**: Page, roll, and position within the subfile.
- **Exit**: F3 or F12.

---

## Summary

This program exemplifies a typical AS/400 RPG subfile maintenance pattern, adapted for the debt collection business domain. It enforces strict business rules around agency data visibility, integrates with external systems, and provides robust subfile navigation and record maintenance capabilities. The codebase follows established conventions for indicator usage, key list management, and display file interaction, while also incorporating domain-specific logic and external integration points.