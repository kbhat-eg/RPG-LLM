# Explanation of RPG Program JS700R

This RPG (ILE RPG/400) program processes and updates "search text" records for items, based on various properties such as item description, manufacturer, owner, price-giving suppliers, and keywords. It maintains a table of search texts that are used in some form of item search/navigation feature.

## High-Level Flow

1. **Initialization**: Receives parameters for item number, keyword module, item text, producer, owner, and a flag for "last record" handling.
2. **Deletes existing search texts** (except for manually entered ones) for the item.
3. **Adds a new set of search texts** based on:
   - Manufacturer name
   - Owner/supplier name (if different from manufacturer)
   - All price-giving suppliers' names
   - Keywords from the keyword register, if not already present
   - Full item description
   - Significant words (substrings) from the item description, avoiding duplicates and short words.

---

## File Declarations

```rpg
fjsoklu    uf a e           k disk    rename(jsokpfr:jsoklur)
fjsokl1    if   e           k disk    rename(jsokpfr:jsokl1r)
fjprol1    if   e           k disk    rename(jpropfr:jprol1r)
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
fjvprl1    if   e           k disk    rename(jvprpfr:jvprl1r)
fjmstl1    if   e           k disk    rename(jmstpfr:jmstl1r)
```
- These files are logical files over various physical files, renamed for local usage.
- They represent:
  - `jsoklu/jsokl1`: Search text tables (update/lookup)
  - `jprol1`: Producer lookup
  - `jlevl1`: Supplier/owner lookup
  - `jvprl1`: Item price supplier lookup
  - `jmstl1`: Keyword lookup

---

## Parameter Definitions

```rpg
d p_vare          s                   like(jsvare)
d p_modn          s                   like(jusmod)
d p_tek1          s             35
d p_prod          s                   like(jqprod)
d p_ldor          s                   like(jlldor)
d p_inlr          s              1
```
- **p_vare**: Item ID
- **p_modn**: Keyword module
- **p_tek1**: Main item description text
- **p_prod**: Producer number/ID
- **p_ldor**: Owner/supplier number/ID
- **p_inlr**: LR flag (to control last record setting)

---

## Key Variables

Used for chaining/reading logical files with keys.

---

## Local Working Variables

Strings and counters for substring management, lengths, etc.

---

## Constants

```rpg
d Lo              c                   'abcdefghijklmnopqrstuvwxyz�����'
d Up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZ�����'
```
- For converting text between upper/lower case, including Norwegian letters ('æøå').

---

## Main Program Flow

### 1. Delete Existing Search Texts (Except Manual)

```rpg
eval jsoklu_vare = p_vare
setll jsoklu_key jsoklu
reade jsoklur
dow not %eof
   if jsokod <> 'L'
      delete jsoklur
   else
      unlock jsoklu
   endif
   reade jsoklur
enddo
```
- Loops through all search text records for the item
- Deletes all except those marked as "L" (manual entries)

---

### 2. Initialize Variables

Zeroes and blanks out working variables.

---

### 3. Add Producer Name as Search Text

```rpg
if p_prod <> 0
   eval jprol1_prod = p_prod
   chain jprol1
   if %found
      eval jsokod = 'P'
      xlate jqnavn to jqnavn (normalize case)
      eval jsstek = jqnavn
      write jsoklur
      eval w_pnav_4 = jqnavn
   endif
endif
```
- If a producer number is given, fetch the name, normalize case, add as a search text.

---

### 4. Add Owner/Supplier Name (if Different Than Producer)

```rpg
if p_ldor <> 0
   eval jlevl1_ldor = p_ldor
   chain jlevl1
   if %found
      xlate jlnavn to jlnavn
      eval w_lnav_4 = jlnavn
      if w_pnav_4 <> w_lnav_4
         eval jsokod = 'P'
         eval jsstek = jlnavn
         write jsoklur
      endif
   endif
endif
```
- Owner/supplier name only gets added if it differs (by first 4 letters) from producer.

---

### 5. Add Names of Price-Giving Suppliers

Loops through all price records for the item. For each record:
- Checks active price (not expired)
- Looks up supplier name
- Adds as search text, unless it matches producer or owner

---

### 6. Add Keyword Register Entries (if Not Already Present)

If a keyword module is set, loops through all registered keywords for the module. For each, checks if already present; if not, adds as search text of type 'M'.

---

### 7. Add Item Description as Search Text

```rpg
if p_tek1 = *blank
   goto avslutt
endif
eval jsokod = 'V'
eval jsstek = p_tek1
write jsoklur
```
- If item text is not empty, adds that as a search text of type 'V'.

---

### 8. Add Substrings from Item Description as Search Texts

- Splits the description into words (based on spaces)
- For each word except the first, if it has more than 2 characters and is not already a search text, adds it.

---

### 9. End-of-Program Logic

```rpg
avslutt tag
if p_inlr <> *on
   eval *inlr = *on
endif
return
```
- Sets RPG's "last record" indicator if not instructed otherwise, then returns.

---

## *INZSR (Initialization Subroutine)

- Receives entry parameters
- Prepares all required key lists
- Sets variable w_dato to current date/time (for filtering valid price records)

---

## Summary Table

| Section      | Purpose                                                  |
|--------------|---------------------------------------------------------|
| Delete       | Remove old search texts except manual                   |
| Producer     | Add producer name as search text                        |
| Owner        | Add supplier/owner name if not redundant                |
| Suppliers    | Add all price supplier names (filter by date)           |
| Keywords     | Add keywords from module, avoid duplicates              |
| Desc         | Add full item description as search text                |
| Word Split   | Add significant words from the item description         |
| End Logic    | Set LR indicator and exit                               |

---

## Special Notes

- Uses classic fixed-format RPG IV (`C` spec lines).
- Norwegian letters are handled in upper/lower case logic.
- Duplicates are avoided wherever possible.
- All new search texts are written to `jsoklur`.

---

## Use Case

Business process: Whenever an item is created or updated, this program is called to refresh the search index for that item, using not only the main description but also related keywords, supplier/producer names, ensuring robust and up-to-date search/navigation functionality in the application.