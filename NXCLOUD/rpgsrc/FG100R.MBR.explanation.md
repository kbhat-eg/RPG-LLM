## RPG Program FG100R Overview and Explanation

This RPG program (FG100R) is designed to manage **fees and their maintenance** ("gebyr, vedlikehold") in an IBM i environment, utilizing subfiles for interactive data entry and management. The source contains extensive comments (in Norwegian) and clearly follows best-practice conventions of classic ILE RPG/400 programming (fixed-format C-spec, D-spec, F-spec, etc.).

### 1. High-Level Description

- **Purpose:**  
  Handles a database of fees, with features to display, maintain, create, copy, or delete fee records via subfile-based screens.
- **User Interactions:**  
  - View lists of fee records (in a subfile)
  - Add new records
  - Edit, view, copy, or delete existing records
- **Files involved:**  
  - Physical file(s) for fee data: `fgebl1`, `fgeblr`, `fgeblu` (possibly logicals)
  - Display file(s): `fg100d` (workstn, subfile structure)
- **Control Logic:**  
  Driven by function keys and indicator bits; subroutines handle each screen/panel and function.

---

### 2. File Declarations (F-specs)

```rpg
ffgebl1    if   e           k disk    rename(fgebpfr:fgebl1r)
ffgeblr    if   e           k disk    rename(fgebpfr:fgeblrr)
ffgeblu    uf a e           k disk    rename(fgebpfr:fgeblur)
fg100d     cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **fgebl1, fgeblr, fgeblu**: Database files for fees, referenced with different record formats for reading/writing/updating.
- **fg100d**: Display file used to interact with the user, supports a subfile named `b1sfl`.
- **`infds(dspfbk)`**: Associates display feedback data structure.

---

### 3. Data Declarations (D-specs)

- **LDA Interface**:  
  Fields like `l_user`, `l_firm`, `l_fnav` pick out specific bytes in the Local Data Area. Used for user/firma/other info context.

- **Indicator Usage**:  
  Comments describe the meaning of each indicator:  
  - `*IN10` Rollup, `*IN11` Rolldown, etc.
  - `*IN30` protect fields when displaying
  - Error/warning indicators, etc.

- **Work Variables**:  
  - `w_fcrn`: First record number on current page
  - `w_stel`: Subfile line counter
  - `w_spge`: Page size (number of records in subfile page)
  - `w_srrn`: Relative record number in subfile
  - etc.
- **Key Variables for File Access**:  
  - Used for positioning and updates in files, matching key fields in physical/logical files

---

### 4. Main Processing Logic (C-specs/Control)

#### **Initialization (`*inzsr`)**
- Sets up keys for file access.
- Reads firm number from LDA.
- Initializes the display and loads the subfile (calls `crt_subfile`).

#### **Main Loop Tags (`b2taga`, `b2tagb`)**
- `b2taga`: Screen for command keys (`b2cmd`)
- `b2tagb`: Main subfile display and processing
- Depending on function keys pressed, directs flow to subroutines:
  - Rollup (`*IN10`): creates next subfile page (`crt_subfile`)
  - Rolldown (`*IN11`): displays previous subfile page (`bck_subfile`)
  - New (`*INKF`): add new fee (`xc1bld`)
  - Renew/refresh (`*INKE`): reloads subfile (`forny`)
  - Home/positioning
  - Exit keys (`*INKC`/`*INKL`): ends program

#### **Subfile Handling**
- **Displaying the subfile:**  
  - `dsp_subfile` – displays or redisplays the subfile page with options.
- **Subroutines to manipulate subfile:**
  - `clr_subfile` – clears/empties the subfile
  - `crt_subfile` – fills subfile with records
  - `bck_subfile` – moves backward a page
  - `forny` – refresh (re-read) the current subfile page
  - `subfile` – reads input from the subfile lines, processes edit/copy/delete/view requests

#### **Fee Maintenance Actions**

- **Add new fee (`xc1bld`):**
  - Prompts for new fee record
  - Validates input
  - Checks for duplicates, notifies if already exists
  - Calls edit panel for entry (`xc2bld`)

- **Edit/Copy/Delete/View (`subfile` options):**
  - According to the option selected in the subfile (`b1valg` field), performs:
    - Edit: calls maintenance (`xc2bld`)
    - Copy: fetches source and calls copy dialog (`xk1win`)
    - Delete: calls delete dialog (`xd1win`)
    - View: shows details in protected mode

- **Update and File I/O**  
  - Uses RPG file operations: CHAIN (fetch by key), UPDATE, WRITE, DELETE, SETLL/SETGT for positioning.

#### **Special Panels/Dialogs**
- **xc1msg**: Message panel if attempting to create a record that already exists.
- **xd1win**: Delete confirmation dialog and deletion logic.
- **xk1win**: Copy dialog for copying existing records.

---

### 5. Screen and Field Management

- **Subfiles:**  
  Used to display multiple records; users can select records for edit/copy/delete/etc.
- **Panels/Screens:**  
  - Each screen has a subroutine to control its flow (`C1BLD`, `C2BLD`, etc.)
  - Indicators manage field protection, error highlighting, displaying the right options.
  - Uses RPG `EXFMT`, `WRITE`, and `READC`/`READP` for UI handling.

---

### 6. Inquiry (Search/Lookup) Subroutine (`spørring`)

- **Field-level lookup:**  
  Based on which field is active, calls out to inquiry programs (RA511R, VA550R, FM510R) to find the correct value or description.
- **Examples:**  
  - 'C1KKAT': Lookup for fee category
  - 'C1OTYP': Lookup for order type
  - 'C1FTYP': Lookup for invoice type

---

### 7. Keys and Key Lists

- **KLISTs (`klist`)**:  
  Used to define composite keys for database file access.  
  - For positioning and searching for existing records.

---

## Summary Table

| Main Functionality   | How It's Done                                                                     |
|----------------------|-----------------------------------------------------------------------------------|
| List fees            | Subfile display (`crt_subfile`, `dsp_subfile`)                                    |
| Add new fee          | `xc1bld` (new entry panel) → `xc2bld` (edit entry panel)                         |
| Edit/view/copy/delete| Subfile option in `b1valg`: handled in `subfile` loop, calls appropriate subrtn.  |
| Copy                 | `xk1win` subroutine                                                              |
| Delete               | `xd1win` subroutine                                                              |
| Inquiry/lookup       | `spørring` subroutine, calls external inquiry pgms                               |
| Error/validation     | Indicators, message panels, duplicate check, field resets                        |
| Refresh/position     | `forny`, `posisjoner`, etc.                                                      |

---

## Typical Program Flow

1. **Initialization (`*inzsr`):**
   - Load company id, initialize subfile.

2. **Main Program Loop:**
   - Display subfile, wait for user input.
   - On function key, branch to correct handler.
   - User selects: add, edit, copy, delete, browse, or move pages.
   - All maintenance is handled within subroutines, most with tag/loop constructs for multiple attempts.

3. **Exit**:
   - If exit keys pressed, set LR and return.

---

## Coding Style Notes

- **Classic fixed-format:**  
  This is not RPG IV/free-form, but fixed-format RPG/400.
- **Indicators and GOTO:**  
  Indicator-based UI logic, use of tags and GOTO is normal in these applications.
- **External dependencies:**  
  Inquiry subroutines rely on other RPG or CL programs.

---

## Takeaway

This program is a classic example of **IBM i subfile-based maintenance** for a master file (fees). The main constructs to understand are:
- Subfile loading and processing cycles.
- Display file and indicator interaction.
- Maintenance through CHAIN/WRITE/UPDATE/DELETE.
- Use of inquiry programs for field lookups.
- Classic RPG flow with tags, indicators, and subroutines.

Onboarding to this code would benefit from exploring the display file (`fg100d`), understanding the key fields and file layouts, and being familiar with the IBM i interactive programming paradigm, particularly subfiles and indicator-driven logic.