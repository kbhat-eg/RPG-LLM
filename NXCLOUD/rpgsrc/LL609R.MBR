      /TITLE  Utskrift av lagerverdiliste
pdf  h decedit('0.') datedit(*ymd-) option(*nodebugio)
pdf  h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
      *
pdf   /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Program . . . . : LL609R
      * Beskrivelse . . : Utskrift av lagerverdiliste
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Referanse  Dato   Endringsbeskrivelse                      Sign.
      * --------- ------  --------------------------------------------------
      *           150900  Nytt program                             KOB
      *           040102  Lagt inn dummy-parameter bakerst i       ASK
      *                   parameterliste pga. OS/400 feil.
5.20  * R5.20 171003 AMD  Utvidet med mulighet for å kunne kontere på
      *                   leveringstype
5.20  * R5.50 040307 KOB  Lagt inn test for å unngå å skrive beholdning hvis = 0
5.50  * R5.50 030108 bof  Lagt inn overflow test
      * R5.60 110608 ASK  Lagt inn korreksjon mot negative lagererdier
5.61  * R5.60 110310 bof  Endret hardkodet 2005 til inneværende år - 1
pdf   * R6.10 170811 bsa  Lagt inn funksjonalitet for arkivering og eksport
pdf   *                   til excel. Layout lages i iReport og lages std i
pdf   *                   PDF.
6.20  *  6.20 130212 amd  For Mestersalg ble det sprekk på kostpris -
      *                   variabel, jeg utvider den. . .
6.30  *  6.30 130814 bsa  Maler skal ikke lenger hardkodes
6.31  * R6.30 120914 bsa  Utvidet parameterliste til FO798R.
6.32  * 6.30  280115 bsa  Skriver til datakø for å trigge java sniffer
6.33  * 6.30  220514 BKV  Utvidet parameterliste til FÅ707R
6.34  * 6.30  050615 bsa  Nullstill minne
6.35  * 6.30  051015 bsa  Utvidet antallsfelt da det kan være for lite.
6.36  * 6.30  090117 bsa  Hvis ikke excel er valgt, men PROA aktivert,
6.36  *                   må vi hente spoolmal.
6.37  * 6.30  081018 bof  Utvidet med trelast sortiment
7.01  * 6.30  130117 bsa  Henter varetekst fra ny sidetabell pga overstyring
7.01  *                   på diversevarer.
7.02  * 7.02 191021  ask  Henter gj.sn. glidende kostpris om valgt
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flwa1l1    if   e           k disk    rename(lwa1pfr:lwa1l1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
     fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
     fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
     fvkhvl1    if   e           k disk    rename(vkhvpfr:vkhvl1r)
     fsistlb    if   e           k disk    rename(sistpfr:sistlbr)
     flbchl1    if   e           k disk    rename(lbchpfr:lbchl1r)
pdf  fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
pdf  faforl1    if   e           k disk    rename(aforpfr:aforl1r)
7.01 flwa4l1    if   e           k disk    rename(lwa4pfr:lwa4l1r)
      *
     fll609p    o    e             printer
6.36 f                                     usropn
      *
      *  Parameter-rec
      *
     d                 ds
     d p_prec                       128
     d  p_fvar                        8  0 overlay(p_prec)
     d  p_tvar                        8  0 overlay(p_prec:9)
     d  p_flag                        2  0 overlay(p_prec:17)
     d  p_tlag                        2  0 overlay(p_prec:19)
     d  p_fogr                        2  0 overlay(p_prec:21)
     d  p_togr                        2  0 overlay(p_prec:23)
     d  p_fhgr                        2  0 overlay(p_prec:25)
     d  p_thgr                        2  0 overlay(p_prec:27)
     d  p_fugr                        3  0 overlay(p_prec:29)
     d  p_tugr                        3  0 overlay(p_prec:32)
     d  p_levn                        6  0 overlay(p_prec:35)
     d  p_sakb                        6  0 overlay(p_prec:41)
     d  p_sort                        1  0 overlay(p_prec:45)
     d  p_brud                        1  0 overlay(p_prec:46)
     d  p_vlin                        1  0 overlay(p_prec:47)
     d  p_batc                       10    overlay(p_prec:48)
     d  p_dath                        6  0 overlay(p_prec:58)
7.02 d  p_gjko                        1  0 overlay(p_prec:64)
7.02 d  p_dumm                       10    overlay(p_prec:65)
      *
      * Local Data Area
      *
     d                uds
pdf  d l_poff                584    584
pdf  d l_utqm                585    594
pdf  d l_bach                595    635
pdf  d l_arch                636    636  0
pdf  d l_skje                637    637  0
pdf  d l_land                638    638  0
pdf  d l_exlp                639    639  0
pdf  d l_mail                640    640  0
pdf  d l_prfi                750    750  0
pdf  d l_ruti                800    809
pdf  d l_outq                810    819
pdf  d l_copy                838    843  0
     d l_wsid                901    910
     d l_user                        10
pdf  d l_filg                931    933
     d l_firm                944    946  0
pdf  d l_avde                947    950  0
     d l_fnav                951    980
pdf   *
pdf   * Definering av parametre
pdf   *
pdf  d p_mail          s              1
pdf  d p_kund          s              6  0
pdf  d p_kpro          s              6  0
6.nu d p_numm          s              8  0
6.31 d p_suff          s              2  0
pdf  d p_selg          s              4  0
      *
pdf  d p_serv          s             35
pdf  d p_stat          s              1
pdf  d p_kule          s              1
pdf  d p_navn          s             30
pdf  d p_emal          s             50
pdf  d p_ema2          s             50
6.31 d p_ema3          s             50
6.31 d p_kopi          s             50
pdf  d p_emne          s             50
pdf  d p_txt1          s             50
pdf  d p_txt2          s             50
pdf  d p_txt3          s             50
pdf  d p_txt4          s             50
pdf  d p_pers          s             50
pdf  d p_inif          s             40
pdf  d p_in03          s              1
pdf  d p_ok            s              1
pdf  d p_lr            s              1
pdf  d p_str_in        s            512
pdf  d p_str_out       s            512
6.32 d p_filg          s             10
6.32 d p_xmlf          s            256
      *
      * Definering av variable i nøkler
      *
     d vvarl1_vare     s                   like(vvvare)
     d vogrl1_oogr     s                   like(vgoogr)
     d vhgrl1_hogr     s                   like(vghogr)
     d vhgrl1_hhgr     s                   like(vghhgr)
     d vugrl1_uogr     s                   like(vguogr)
     d vugrl1_uhgr     s                   like(vguhgr)
     d vugrl1_uugr     s                   like(vguugr)
     d vkhvl1_khev     s                   like(vvkhev)
5.20 d vkhvl1_klty     s                   like(vaklty)
     d vkhvl1_koty     s                   like(vakoty)
     d sistlb_paar     s                   like(sipaar)
     d sistlb_vare     s                   like(sivare)
     d lbchl1_batc     s                   like(lcbatc)
7.01 d lwa4l1_akey     s                   like(l4akey)
      *
      * Definering av variable
      *
     d w_parm          s            128
     d w_firm          s                   like(vvfirm)
     d w_dato          s               d   datfmt(*iso)
     d w_time          s               t   timfmt(*iso)
pdf  d w_ddmy          s              6  0
pdf  d w_prfi          s              1  0
pdf  d w_ffir          s              3  0
pdf  d w_fnav          s             30
pdf  d w_fad1          s             30
pdf  d w_fad2          s             30
pdf  d w_fste          s             30
pdf  d w_fftx          s             30
pdf  d w_tfax          s              8
pdf  d w_ftlf          s             11
pdf  d w_ffax          s             11
6.33 d w_mail          s             50
6.33 d w_weba          s             50
pdf  d w_head          s             75
     d w_vare          s              8  0
     d w_adrs          s             30
     d w_ponr          s              4  0
     d w_pste          s             30
     d w_avde          s              4  0
     d w_tell          s              5  0
     d w_forste        s              1  0
     d w_snkp          s             10  2
     d w_snkt          s             13  2
6.20 d w_kost          s             13  2
6.35 d w_anta          s             15  3
pdf  d t_behl          s             11  2
pdf  d t_kost          s             11  2
pdf  d t_omst          s             11  2
pdf  d t_snko          s             11  2
pdf  d t_text          s             75
     d w_aarr          s              6  0
6.37 d w_nobb          s                   like(vvnobb)
6.37 d w_lv_nobb       s                   like(vvnobb)
6.37 d w_lv_modn       s                   like(vvnmod)
6.37 d w_lv_lldo       s                   like(vvldor)
6.37 d w_lv_llva       s                   like(vvlvar)
5.37 d w_vtyp          s                   like(vvvtyp)
6.37 d w_udat          s                   like(vvudat)
6.37 d w_ldor          s                   like(vvldor)
7.02 d w_gjko          s              9  2
7.02 d w_datg          s              8  0
7.02 d w_dath          s               d   datfmt(*iso)
7.02 d w_varh          s                   like(vvvare)
      *
     d g_vare          s                   like(mlvare)
     d g_ogrp          s                   like(vgoogr)
     d g_hgrp          s                   like(vghhgr)
     d g_ugrp          s                   like(vguugr)
     d g_khev          s                   like(vakkod)
     d g_lage          s                   like(mllage)
      *
     d b_feil          s              1    inz(*off)
     d b_init          s              1    inz(*on)
6.37 d b_inlr          s              1    inz(*off)
      *
pdf  d b_pdfp          s              1    inz(*off)
pdf  d b_sort          s              1    inz(*off)
pdf  d b_tota          s              1    inz(*off)
pdf  d b_deta          s              1    inz(*off)
pdf  d b_grop          s              1    inz(*off)
6.36 d b_exlp          s              1    inz(*off)
pdf  d x_numm          s             15
pdf  d x_vref          s             25
pdf  d x_betb          s             42
pdf  d w_bdat          s               d   datfmt(*iso)
pdf  d w_date          s               d   datfmt(*iso)
pdf  d w_dato2         s             12  0
pdf  d w_kode          s              1
pdf  d w_fell          s              6
pdf  d w_type          s              2
pdf  d w_fast          s             10
pdf  d w_ruti          s             10
pdf  d w_numm          s              6  0
pdf  d w_pdf           s              1  0
pdf  d w_jnav          s             15
pdf  d w_jkey          s             41
pdf  d w_jtxt          s             35
pdf  d w_pdf_ds        s            512
pdf  d w_mtxt          s            300
pdf  d w_jstat         s              2  0
pdf  d w_jtext         s            200
pdf  d w_text          s            200
pdf  d w_ogtx          s             50
pdf  d w_hgtx          s             50
pdf  d w_ugtx          s             50
pdf  d w_khtx          s             50
pdf  d w_ltek          s             50
pdf  d w_land          s              9
pdf  d w_mark          s              5
pdf  d w_spol          s              5
pdf  d w_x             s              3  0
pdf  d w_path          s            256
pdf  d w_ema2          s             50
pdf  d w_ttype         s              1
pdf  d w_draw1         s             10
pdf  d w_draw2         s             10
pdf  d w_dspl          s            100
pdf  d w_tek1          s            512
pdf  d w_tek2          s            512
pdf  d w_copy          s              3  0
pdf  d w_faks          s             30
pdf  d w_pemne         s             75
pdf  d w_ptxt1         s             75
pdf  d w_ptxt2         s             75
pdf  d w_ptxt3         s             75
pdf  d w_ptxt4         s             75
pdf  d w_ppers         s             75
pdf  d w_rekv          s             50
pdf  d w_1fnav         s             50
pdf  d w_1fad1         s             50
pdf  d w_1fad2         s             50
pdf  d w_1navn         s             50
pdf  d w_1gate         s             50
pdf  d w_1adr2         s             50
pdf  d w_txt1          s             75
pdf  d w_rtyp          s             50
pdf  d w_txt2          s             50
pdf   *
pdf  d XML_Output      s            256a   Varying
pdf  d XML_path        s            256a   Varying
pdf  d                                     Inz('/home/asp/print/adb')
pdf  d jasper_mal      s            256a
pdf  d jasper_logo     s            256a   varying
pdf  d tmpdate         s               D
pdf  d tmptime         s               T
pdf  d crlf            c                   const(X'0d25')
pdf   *
pdf  d d_pdf_ds        ds
pdf  d  d_xmlm                       75
pdf  d  d_jasm                       75
pdf  d  d_logo                       75
pdf  d  d_path                      100
pdf  d  d_emal                       50
6.32 d  d_fifo                       75
6.32 d  d_fkop                        1
6.32 d  d_dtaq                        1
6.32 d  d_sign                        1
pdf   /copy prototypeb
pdf   /copy usec
      *
6.36 d p_btyp          s            100
6.36 d splfname2       s             10a
6.36 d jobname2        s             10a
6.36 d username2       s             10a
6.36 d jobnbr2         s              6a
6.36 d splfnbr2        s             10i 0
6.36 d splfname3       s             10a
6.36 d jobname3        s             10a
6.36 d username3       s             10a
6.36 d jobnbr3         s              6a
6.36 d splfnbr3        s             10i 0
6.36 d p_tagg0         s             20
6.36 d p_tagg0val      s             50
6.36 d p_tagg1         s             20
6.36 d p_tagg1val      s             50
6.36 d p_tagg2         s             20
6.36 d p_tagg2val      s             50
6.36 d p_tagg3         s             20
6.36 d p_tagg3val      s             50
6.36 d p_tagg4         s             20
6.36 d p_tagg4val      s             50
6.36 d p_tagg5         s             20
6.36 d p_tagg5val      s             50
6.36 d p_tagg6         s             20
6.36 d p_tagg6val      s             50
6.36 d p_tagg7         s             20
6.36 d p_tagg7val      s             50
6.36 d p_tagg8         s             20
6.36 d p_tagg8val      s             50
6.36 d p_tagg9         s             20
6.36 d p_tagg9val      s             50
6.36 d p_refn          s             50
6.36 d p_dspl          s            100
6.36  *
6.36 d qsprilsp        pr                  extpgm('QSPRILSP')
6.36 d rcvvar                     32767a   options(*varsize)
6.36 d rcvvarlen                     10i 0 const
6.36 d format                         8a   const
6.36 d errorcode                  32767a   options(*varsize)
6.36  *
6.36 d sprl0100        ds
6.36 d  bytesrtn                     10i 0
6.36 d  bytesavl                     10i 0
6.36 d  splfname                     10a
6.36 d  jobname                      10a
6.36 d  username                     10a
6.36 d  jobnbr                        6a
6.36 d  splfnbr                      10i 0
6.36 d  systemname                    8a
6.36 d  createdate                    7a
6.36 d                                1a
6.36 d  createtime                    6a
6.36  *
6.36 d errorcode       ds
6.36 d  bytesprov                    10i 0 inz(0)
6.36 d  byteavail                    10i 0 inz(0)
      *
      * - - - - - - - - - -
      * Benyttede formater
      * - - - - - - - - - -
      *
      * A1HDR  - Heading A1 på rapport
      * A2HDR  - Overgruppe heading
      * A3HDR  - Hovedgruppe heading
      * A4HDR  - Undergruppe heading
      * A5HDR  - Kontohenvisningsheading
      * A6HDR  - Lager heading
      * D1DET  - Detail pr vare/lager
      * T1SUM  - Sum pr vare
      * T2SUM  - Sum pr overgruppe
      * T3SUM  - Sum pr hovedgruppe
      * T4SUM  - Sum pr undergruppe
      * T5SUM  - Sum pr kontohenvisning
      * T6SUM  - Sum pr lager
      * T7SUM  - Sum pr firma
      *
6.37 C/Exec SQL
6.37 C+  Set Option DatFmt=*ISO
6.37 C/End-Exec
      * Skriv første heading
      *
     c                   if        p_sort <> 2 and
     c                             p_sort <> 3
pdf  c                   if        b_pdfp = *off
     c                   write     a1hdr                                30
pdf  c                   endif
     c                   endif
pdf   * Vi skriver til XML taggene for heading hvis PROA er aktivert
pdf  c                   if        b_pdfp = *on
pdf  c                   exsr      xml_head
pdf  c                   endif
      *
      * Lese file
      *
     c                   eval      g_khev = *hival
     c                   eval      g_lage = *hival
     c                   eval      g_ogrp = *hival
     c                   eval      g_hgrp = *hival
     c                   eval      g_ugrp = *hival
      *
     c                   read      lwa1l1                                 90
      *
     c                   dow       *in90 = *off
      *
      * Ikke skriv summer på første
      *
     c                   if        w_forste = 1
      *
      * Sjekk om sortert på vare/lager
      *
     c                   if        p_sort = 1 or
     c                             p_sort = 2 or
     c                             p_sort = 3
     c                   if        mlvare <> w_vare
     c                   exsr      sum_t1
     c                   endif
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på varegruppe/Varenummer/Lager
      *
     c                   if        p_sort = 2
      *
      * Brudd på undergruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp or
     c                             mlugrp <> g_ugrp
     c                   exsr      sum_t2
     c                   endif
      *
      * Brudd på hovedgruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp
     c                   exsr      sum_t3
     c                   endif
      *
      * Brudd på overgruppe ?
      *
     c                   if        mlogrp <> g_ogrp
     c                   exsr      sum_t4
     c                   endif
      *
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på kontohenvisning/varenummer/lager
      *
     c                   if        p_sort = 3
     c                   if        mlkhev <> g_khev
     c                   exsr      sum_t5
     c                   endif
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på lager
      *
     c                   if        p_sort  = 4
     c                   if        mllage <> g_lage
     c                   exsr      sum_t6
     c                   endif
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på lager/varegruppe/varenummer
      *
     c                   if        p_sort = 5
      *
      * Brudd på lager ?
      *
     c                   if        mllage <> g_lage
      *
     c                   exsr      sum_t2
     c                   exsr      sum_t3
     c                   exsr      sum_t4
     c                   exsr      sum_t6
      *
     c                   else
      *
      * Brudd på undergruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp or
     c                             mlugrp <> g_ugrp
     c                   exsr      sum_t2
     c                   endif
      *
      * Brudd på hovedgruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp
     c                   exsr      sum_t3
     c                   endif
      *
      * Brudd på overgruppe ?
      *
     c                   if        mlogrp <> g_ogrp
     c                   exsr      sum_t4
     c                   endif
      *
     c                   endif
      *
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på lager/kontohenvisning/varenummer
      *
     c                   if        p_sort = 6
      *
     c                   if        mllage <> g_lage
     c                   exsr      sum_t5
     c                   exsr      sum_t6
     c                   else
     c                   if        mlkhev <> g_khev
     c                   exsr      sum_t5
     c                   endif
     c                   endif
      *
     c                   endif
      *
     c                   endif
      *
     c                   eval      w_forste = 1
     c/eject
      *
      * Brudd på lager ?
      *
     c                   if        p_sort  = 4 or
     c                             p_sort  = 5 or
     c                             p_sort  = 6
     c                   if        mllage <> g_lage
     c                   exsr      hed_a6
     c                   endif
     c                   endif
      *
      * Sjekk om sortert på varegruppe
      *
     c                   if        p_sort = 2 or
     c                             p_sort = 5
      *
      * Brudd på overgruppe ?
      *
     c                   if        mlogrp <> g_ogrp
     c                   if        p_sort = 2
pdf  c                   if        b_pdfp = *off
     c                   exsr      overflow
pdf  c                   endif
     c                   endif
     c                   exsr      hed_a2
     c                   endif
      *
      * Brudd på hovedgruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp
     c                   exsr      hed_a3
     c                   endif
      *
      * Brudd på undergruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp or
     c                             mlugrp <> g_ugrp
     c                   exsr      hed_a4
     c                   endif
      *
     c                   endif
      *
      * Sjekk om sortert på kontohenvisning
      *
     c                   if        p_sort = 3 or
     c                             p_sort = 6
     c                   if        mlkhev <> g_khev
     c                   if        p_sort = 3
pdf  c                   if        b_pdfp = *off
     c                   exsr      overflow
pdf  c                   endif
     c                   endif
     c                   exsr      hed_a5
     c                   endif
     c                   endif
      *
      * Utskrift av detaljer
      *
     c                   movel     mlvare        d1vare
     c                   movel     mlvare        vvarl1_vare
     c     vvarl1_key    chain     vvarl1                             91
7.01 c**                 if        *in91 = *off
7.01 c**                 eval      d1tek1 = vvtek1
7.01 c**                 else
7.01 c**                 eval      d1tek1 = 'Ukjent vare'
7.01 c**                 endif
7.01  *
7.01  * Henter varetekst fra sidetabell
7.01  *
7.01 c                   eval      lwa4l1_akey = mlakey
7.01 c     lwa4l1_key    chain     lwa4l1
7.01 c                   if        %found
7.01 c                   eval      d1tek1 = l4tek1
7.01 c                   else
7.01 c                   eval      d1tek1 = 'Ukjent vare'
7.01 c                   endif
6.37  * sjekker om logistikk-vare
6.37 c                   call      'VL710R'
6.37 c                   parm                    w_firm
6.37 c                   parm                    mlvare
6.37 c                   parm                    mllage
6.37 c                   parm                    w_vtyp
6.37 c                   parm                    w_udat
6.37 c                   parm                    w_ldor
6.37 c                   parm                    b_inlr
6.37 c                   parm                    w_lv_nobb
6.37 c                   parm                    w_lv_modn
6.37 c                   parm                    w_lv_lldo
6.37 c                   parm                    w_lv_llva
      *
     c                   eval      d1lage = mllage
     c                   eval      d1enhl = vvenhl
     c                   eval      d1spri = mlspri
     c                   eval      d1kpri = mlkpri
     c                   eval      d1behl = mlbehl
      *
5.50  * Ikke skriv beholdning hvis = 0
5.50  *
5.50 c                   if        d1behl = 0
5.50 c                   eval      *in61 = *on
5.50 c                   else
5.50 c                   eval      *in61 = *off
5.50 c                   endif
      *
     c                   if        mltrda <> *loval
     c     *dmy          move      mltrda        d1dato
     c                   else
     c                   move      *zeros        d1dato
     c                   endif
      *
      * Henter gjennomsnitts kostpris
      *
7.02 c                   if        p_gjko = 1
7.02 c                   exsr      snit_kost
7.02 c                   else
     c                   exsr      stat_kost
7.02 c                   endif
     c                   eval      d1snkp = w_snkp
     c                   eval      d1snkt = w_snkp * mlbehl
      *
      * Negative beholdninger tas ut av beregning av verdier
      *
     c                   if        mlbehl < 0
     c                   eval      mlomst = 0
     c                   eval      mlkost = 0
     c                   eval      d1snkt = 0
     c                   endif
      *
     c                   eval      d1omst = mlomst
     c                   eval      d1kost = mlkost
      *
     c                   if        p_vlin = 0
pdf  c                   if        b_pdfp = *off
     c                   write     d1det                                30
pdf   * Skriver XML tagger for detaljer
pdf  c                   else
pdf  c                   exsr      xml_deta
pdf  c                   endif
      *
pdf  c                   if        b_pdfp = *off
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   endif
     c                   endif
      *
     c                   eval      g_vare = mlvare
     c                   eval      g_lage = mllage
     c                   eval      g_khev = mlkhev
     c                   eval      g_ogrp = mlogrp
     c                   eval      g_hgrp = mlhgrp
     c                   eval      g_ugrp = mlugrp
      *
      * Summer innen varenummer
      *
     c                   if        p_sort = 1 or
     c                             p_sort = 2 or
     c                             p_sort = 3
     c                   eval      w_tell = w_tell + 1
     c                   eval      w_vare = mlvare
     c                   eval      t1behl = t1behl + mlbehl
     c                   eval      t1omst = t1omst + mlomst
     c                   eval      t1kost = t1kost + mlkost
     c                   eval      t1snko = t1snko + d1snkt
     c                   endif
      *
      * Summer innen varegruppe
      *
     c                   if        p_sort = 2 or
     c                             p_sort = 5
      *
     c                   eval      t2omst = t2omst + mlomst
     c                   eval      t2kost = t2kost + mlkost
     c                   eval      t2snko = t2snko + d1snkt
      *
     c                   eval      t3omst = t3omst + mlomst
     c                   eval      t3kost = t3kost + mlkost
     c                   eval      t3snko = t3snko + d1snkt
      *
     c                   eval      t4omst = t4omst + mlomst
     c                   eval      t4kost = t4kost + mlkost
     c                   eval      t4snko = t4snko + d1snkt
     c                   endif
      *
      * Summer innen kontohenvisning
      *
     c                   if        p_sort = 3 or
     c                             p_sort = 6
      *
     c                   eval      t5omst = t5omst + mlomst
     c                   eval      t5kost = t5kost + mlkost
     c                   eval      t5snko = t5snko + d1snkt
     c                   endif
      *
      * Summer innen lager
      *
     c                   if        p_sort = 4 or
     c                             p_sort = 5 or
     c                             p_sort = 6
     c                   eval      t6omst = t6omst + mlomst
     c                   eval      t6kost = t6kost + mlkost
     c                   eval      t6snko = t6snko + d1snkt
     c                   endif
      *
      * Summer innen firma
      *
     c                   eval      t7omst = t7omst + mlomst
     c                   eval      t7kost = t7kost + mlkost
     c                   eval      t7snko = t7snko + d1snkt
      *
     c                   read      lwa1l1                                 90
      *
     c                   enddo
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     end_pgm       tag
      *
      * Sjekk om sortert på varegruppe
      *
     c                   if        p_sort = 2 or
     c                             p_sort = 5
      *
     c                   exsr      sum_t2
      *
     c                   exsr      sum_t3
      *
     c                   exsr      sum_t4
      *
     c                   endif
      *
      * Sjekk om sortert på kontohenvisning
      *
     c                   if        p_sort = 3 or
     c                             p_sort = 6
     c                   exsr      sum_t5
      *
     c                   endif
      *
      * Sjekk om sortert på lager
      *
     c                   if        p_sort = 4 or
     c                             p_sort = 5 or
     c                             p_sort = 6
     c                   exsr      sum_t6
      *
     c                   endif
      *
      * Firmatotal
      *
     c                   exsr      sum_t7
pdf   * Hvis xml gen, må vi kvittere med siste vanlige linjetag
pdf  c                   if        b_pdfp = *on
pdf   * Skriv xml fila på disk
pdf  c                   exsr      xml_end
pdf   * Hvis forhåndvisning/eller excel må vi kjøre linken i browser
pdf  c                   if        l_skje = 1 and
pdf  c                             l_bach = w_jkey or
pdf  c                             l_exlp = 1 and
pdf  c                             l_bach = w_jkey
pdf  c                   exsr      pdf_preview
pdf  c                   endif
pdf   * Avslutt jobbiden
pdf  c                   call      'AB710R'
pdf  c                   parm                    l_bach
pdf  c                   goto      avslutt
pdf  c                   endif
6.36  *
6.36 c                   if        l_poff = '1'
6.36 c                   exsr      spoolnbr
6.36 c                   endif
6.36  *
6.36 c                   close     ll609p
6.36  *
6.36  * Hvis ikke excel, og proa er aktivert, lag standard spoolfile
6.36  *
6.36 c                   if        l_poff = '1'
6.36 c                   exsr      xml_create
6.36 c                   exsr      pdf_preview2
6.36  * Avslutt jobbid
6.36 c                   call      'AB710R'
6.36 c                   parm                    l_bach
6.36 c                   endif
      *
6.36 c     avslutt       tag
     c                   eval      *inlr = *on
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum varenummer (Flere lager)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t1        begsr
      *
     c                   if        w_tell > 1
     c                             and p_sort < 3
     c                   eval      t1vare = g_vare
     c                   if        p_vlin = 0
pdf  c                   if        b_pdfp = *off
     c                   write     t1sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      t_text = 'Sum: ' + %trim(%char(t1vare))
pdf  c                   eval      t_behl = t1behl
pdf  c                   eval      t_omst = t1omst
pdf  c                   eval      t_kost = t1kost
pdf  c                   eval      t_snko = t1snko
pdf  c**                 exsr      xml_total
pdf  c                   endif
     c                   endif
     c                   endif
      *
     c                   eval      t1behl = 0
     c                   eval      t1omst = 0
     c                   eval      t1kost = 0
     c                   eval      t1snko = 0
     c                   eval      w_tell = 0
      *
     c     end_t1        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum undergruppe
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t2        begsr
      *
     c                   eval      t4ogrp = g_ogrp
     c                   eval      t4hgrp = g_hgrp
     c                   eval      t4ugrp = g_ugrp
     c                   eval      t4ugtx = a4ugtx
pdf  c                   if        b_pdfp = *off
     c                   write     t4sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      t_text = 'Sum: '+%trim(%char(t4ogrp))+' '+
pdf  c                             %trim(%char(t4hgrp)) + ' ' +
pdf  c                             %trim(%char(t4ugrp)) + ' ' +
pdf  c                             %trim(t4ugtx)
pdf  c                   eval      t_behl = 0
pdf  c                   eval      t_omst = t4omst
pdf  c                   eval      t_kost = t4kost
pdf  c                   eval      t_snko = t4snko
pdf  c                   exsr      xml_total
pdf  c                   endif
      *
     c                   eval      t4omst = 0
     c                   eval      t4kost = 0
     c                   eval      t4snko = 0
      *
     c     end_t2        endsr
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum hovedgruppe
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t3        begsr
      *
     c                   eval      t3ogrp = g_ogrp
     c                   eval      t3hgrp = g_hgrp
     c                   eval      t3hgtx = a3hgtx
pdf  c                   if        b_pdfp = *off
     c                   write     t3sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      t_text = 'Sum: '+%trim(%char(t3ogrp))+' '+
pdf  c                             %trim(%char(t3hgrp)) + ' ' +
pdf  c                             %trim(t3hgtx)
pdf  c                   eval      t_behl = 0
pdf  c                   eval      t_omst = t3omst
pdf  c                   eval      t_kost = t3kost
pdf  c                   eval      t_snko = t3snko
pdf  c                   exsr      xml_total
pdf  c                   endif
      *
     c                   eval      t3omst = 0
     c                   eval      t3kost = 0
     c                   eval      t3snko = 0
      *
     c     end_t3        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum overgruppe
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t4        begsr
      *
     c                   eval      t2ogrp = g_ogrp
     c                   eval      t2ogtx = a2ogtx
pdf  c                   if        b_pdfp = *off
     c                   write     t2sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      t_text = 'Sum: '+%trim(%char(t2ogrp))+' '+
pdf  c                             %trim(t2ogtx)
pdf  c                   eval      t_behl = 0
pdf  c                   eval      t_omst = t2omst
pdf  c                   eval      t_kost = t2kost
pdf  c                   eval      t_snko = t2snko
pdf  c                   exsr      xml_total
pdf  c                   endif
      *
     c                   eval      t2omst = 0
     c                   eval      t2kost = 0
     c                   eval      t2snko = 0
      *
     c     end_t4        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum kontohenvisning
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t5        begsr
      *
     c                   eval      t5khev = g_khev
     c                   eval      t5khtx = a5khtx
pdf  c                   if        b_pdfp = *off
     c                   write     t5sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      t_text = 'Sum: ' + %trim(t5khev) + ' ' +
pdf  c                             %trim(t5khtx)
pdf  c                   eval      t_behl = 0
pdf  c                   eval      t_omst = t5omst
pdf  c                   eval      t_kost = t5kost
pdf  c                   eval      t_snko = t5snko
pdf  c                   exsr      xml_total
pdf  c                   endif
      *
     c                   eval      t5omst = 0
     c                   eval      t5kost = 0
     c                   eval      t5snko = 0
      *
     c     end_t5        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum lager
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t6        begsr
      *
     c                   eval      t6lage = g_lage
     c                   eval      t6ltek = a6ltek
pdf  c                   if        b_pdfp = *off
     c                   write     t6sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      t_text = 'Sum: '+%trim(%char(t6lage))+' '+
pdf  c                             %trim(t6ltek)
pdf  c                   eval      t_behl = 0
pdf  c                   eval      t_omst = t6omst
pdf  c                   eval      t_kost = t6kost
pdf  c                   eval      t_snko = t6snko
pdf  c                   exsr      xml_total
pdf  c                   endif
      *
     c                   eval      t6omst = 0
     c                   eval      t6kost = 0
     c                   eval      t6snko = 0
      *
     c     end_t6        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum firma
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t7        begsr
      *
     c                   eval      t7firm = l_firm
pdf  c                   if        b_pdfp = *off
     c                   write     t7sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      t_text = 'Sum firma: '+%char(t7firm)
pdf  c                   eval      t_behl = 0
pdf  c                   eval      t_omst = t7omst
pdf  c                   eval      t_kost = t7kost
pdf  c                   eval      t_snko = t7snko
pdf  c                   exsr      xml_total
pdf  c                   exsr      xml_tot_end
pdf  c                   exsr      xml_grp_end
pdf  c                   endif
      *
     c     end_t7        endsr
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på overgruppe ?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a2        begsr
      *
     c                   eval      vogrl1_oogr = mlogrp
     c     vogrl1_key    chain     vogrl1                             92
     c                   eval      a2ogrp = mlogrp
     c                   if        *in92 = *off
     c                   eval      a2ogtx = vgotxt
     c                   else
     c                   eval      a2ogtx = 'Ukjent overgruppe'
     c                   endif
      *
     c                   if        p_vlin = 0
pdf  c                   if        b_pdfp = *off
     c                   write     a2hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      w_text = *blanks
pdf  c                   eval      w_ogtx = *blanks
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     a2ogtx        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ogtx
pdf   *
pdf  c                   eval      w_text = 'Ogr: '+ %char(a2ogrp)+' ' +
pdf  c                                      %trim(w_ogtx)
pdf  c                   exsr      xml_sort
pdf  c                   endif
     c                   endif
      *
     c     end_a2        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på hovedgruppe ?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a3        begsr
      *
     c                   eval      vhgrl1_hogr = mlogrp
     c                   eval      vhgrl1_hhgr = mlhgrp
     c     vhgrl1_key    chain     vhgrl1                             93
     c                   eval      a3ogrp = mlogrp
     c                   eval      a3hgrp = mlhgrp
     c                   if        *in93 = *off
     c                   eval      a3hgtx = vghtxt
     c                   else
     c                   eval      a3hgtx = 'Ukjent hovedgruppe'
     c                   endif
      *
     c                   if        p_vlin = 0
pdf  c                   if        b_pdfp = *off
     c                   write     a3hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      w_text = *blanks
pdf  c                   eval      w_hgtx = *blanks
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     a3hgtx        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_hgtx
pdf   *
pdf  c                   eval      w_text = 'Hgr: '+%char(a3ogrp)+%char(a3hgrp)+
pdf  c                                      ' ' + %trim(w_hgtx)
pdf  c                   exsr      xml_sort
pdf  c                   endif
     c                   endif
      *
     c     end_a3        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på undergruppe ?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a4        begsr
      *
     c                   eval      vugrl1_uogr = mlogrp
     c                   eval      vugrl1_uhgr = mlhgrp
     c                   eval      vugrl1_uugr = mlugrp
     c     vugrl1_key    chain     vugrl1                             94
     c                   eval      a4ogrp = mlogrp
     c                   eval      a4hgrp = mlhgrp
     c                   eval      a4ugrp = mlugrp
     c                   if        *in94 = *off
     c                   eval      a4ugtx = vgutxt
     c                   else
     c                   eval      a4ugtx = 'Ukjent undergruppe'
     c                   endif
      *
     c                   if        p_vlin = 0
pdf  c                   if        b_pdfp = *off
     c                   write     a4hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      w_text = *blanks
pdf  c                   eval      w_ugtx = *blanks
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     a4ugtx        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ugtx
pdf   *
pdf  c                   eval      w_text = 'Ugr: '+%char(a4ogrp)+%char(a4hgrp)+
pdf  c                                      %char(a4ugrp)+' '+%trim(w_ugtx)
pdf  c                   exsr      xml_sort
pdf  c                   endif
     c                   endif
      *
     c     end_a4        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på kontohenvisning
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a5        begsr
      *
     c                   eval      vkhvl1_khev = mlkhev
5.20 c                   eval      vkhvl1_klty = *zero
     c                   eval      vkhvl1_koty = *blank
     c     vkhvl1_key    chain     vkhvl1                             94
     c                   eval      a5khev = mlkhev
     c                   if        *in94 = *off
     c                   eval      a5khtx = vaktxt
     c                   else
     c                   eval      a5khtx = 'Ukjent kontohenvisning'
     c                   endif
      *
     c                   if        p_vlin = 0
pdf  c                   if        b_pdfp = *off
     c                   write     a5hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      w_text = *blanks
pdf  c                   eval      w_khtx = *blanks
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     a5khtx        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_khtx
pdf   *
pdf  c                   eval      w_text = 'Khv: '+%trim(a5khev)+' '+
pdf  c                             %trim(w_khtx)
pdf  c                   exsr      xml_sort
pdf  c                   endif
     c                   endif
      *
     c     end_a5        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på lager?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a6        begsr
      *
     c                   eval      a6lage = mllage
      *
     c                   call      'FÅ720R'
     c                   parm                    w_firm
     c                   parm                    mllage
     c                   parm                    a6ltek
     c                   parm                    w_adrs
     c                   parm                    w_ponr
     c                   parm                    w_pste
     c                   parm                    w_avde
     c                   parm                    b_feil
      *
     c                   if        b_feil = *on
     c                   eval      a6ltek = 'Ukjent lager'
     c                   endif
      *
     c                   if        b_init = *off
     c                   exsr      overflow
     c                   else
     c                   eval      b_init = '0'
     c                   endif
      *
pdf  c                   if        b_pdfp = *off
     c                   write     a6hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
pdf  c                   else
pdf  c                   eval      w_text = *blanks
pdf  c                   eval      w_ltek = *blanks
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     a6ltek        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ltek
pdf   *
pdf  c                   eval      w_text = 'Lager: '+%char(a6lage)+' '+
pdf  c                             %trim(w_ltek)
pdf  c                   exsr      xml_sort
pdf  c                   endif
      *
     c     end_a6        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  OVFLOW    Behandling av overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     overflow      begsr
      *
      *  Skriver heading
      *
     c                   write     a1hdr                                30
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  STAT_KOST Finner gjennomsnitskostpris fra statistikk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     stat_kost     begsr
      *
     c                   eval      w_anta = 0
     c                   eval      w_kost = 0
     c                   eval      w_snkp = 0
     c                   eval      sistlb_vare = vvarl1_vare
5.61 c                   eval      sistlb_paar = *year
5.61 c                   eval      sistlb_paar = sistlb_paar - 1
      *
     c     sistlb_key    setll     sistlb
     c     sistlb_key    reade     sistlb
      *
     c                   dow       not %eof
      *
     c                   eval      w_anta = w_anta + sianta
     c                   eval      w_kost = w_kost + sisumk
      *
     c     sistlb_key    reade     sistlb
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   eval      w_snkp = w_kost / w_anta
     c                   else
     c                   eval      w_snkp = mlkpri
     c                   endif
      *
     c                   endsr
7.02  *
7.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.02  *  SNIT_KOST Finner gjennomsnitskostpris fra glidende kostpris
7.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.02  *
7.02 c     snit_kost     begsr
7.02  *
7.02 c     *dmy          move      p_dath        w_dath
7.02 c                   movel     mlvare        w_varh
7.02 c                   eval      w_datg = %dec(w_dath:*iso)
7.02 c                   call      'VG701R'
7.02 c                   parm                    w_varh
7.02 c                   parm                    mllage
7.02 c                   parm                    w_datg
7.02 c                   parm                    w_gjko
7.02  *
7.02 c                   if        w_gjko > 0
7.02 c                   eval      w_snkp = w_gjko
7.02 c                   else
7.02 c                   eval      w_snkp = mlkpri
7.02 c                   endif
7.02  *
7.02 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  LES_BATCH Leser tellebatch for å finne telledato
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     les_batch     begsr
      *
     c                   eval      lbchl1_batc = p_batc
     c     lbchl1_key    chain     lbchl1
      *
     c                   endsr
      *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_envm      begsr
pdf   * Hvis skjermvisning/excel skal vi ikke lagre i spoolfile
pdf  c                   if        l_skje = 1 or
pdf  c                             l_exlp = 1
pdf  c                   eval      w_spol = 'true'
pdf  c                   else
pdf  c                   eval      w_spol = 'false'
pdf  c                   endif
pdf   * Sjekk om det er PDF eller excel som skal vises
pdf  c                   if        l_exlp > 0
pdf  c                   eval      w_rtyp = 'XmlExcelDocumentReportCommand'
pdf  c                   eval      d_jasm = *blanks
6.30 c**                 eval      d_jasm = 'FILE:/HOME/ADBBER/PRINT/MALER/+
6.30 c**                           LAGERVERDILISTE/LAGERVERDILISTE_XL.JASPER'
pdf  c                   else
pdf  c                   eval      w_rtyp = 'XmlDocumentReportCommand'
pdf  c                   endif
pdf   *
pdf   /Free
pdf        // Finne nytt batch nummer
pdf            UpdHTMLVar('BatchNo':               w_jkey);
pdf            UpdHTMLVar('Batchtype':  'LAGERVERDILISTE');
pdf            UpdHTMLVar('Username':              l_user);
pdf            WrtSection('Topp');
pdf        // Finn report command variabler
pdf            UpdHTMLVar('User':                l_user);
pdf            UpdHTMLVar('PW':                     ' ');
pdf            UpdHTMLVar('IPAdr':                  ' ');
pdf            UpdHTMLVar('Schema':        'ADB'+l_filg);
pdf            UpdHTMLVar('Companyno':    %char(l_firm));
pdf            WrtSection('Credential');
pdf        // Finn report command variabler
pdf            UpdHTMLVar('Reportcommandtype':   w_rtyp);
pdf            UpdHTMLVar('Jaspertemplate':      d_jasm);
pdf            UpdHTMLVar('Logo':           jasper_logo);
pdf            UpdHTMLVar('Keepspool':           w_spol);
pdf            WrtSection('ReportCommand');
pdf   /End-free
pdf   *
pdf   * Hvis skjermvisning skal ikke PDF skrives
pdf   *
pdf  c                   if        l_skje = 0 and
pdf  c                             l_mail = 0 and
pdf  c                             l_exlp = 0
pdf   * Hvis *ARKIV er valgt som skriver, skal det ikke skrives ut
pdf  c                   if        l_utqm <> '*ARKIV'
pdf   *
pdf  c                   if        l_land = 1
pdf  c                   eval      w_land = 'LANDSCAPE'
pdf  c                   else
pdf  c                   eval      w_land = 'PORTRAIT'
pdf  c                   endif
pdf   * Sjekk at valgt outq støttes av skriveren. Kan skli gjennom hvis
pdf   * jobben legges på jobbkø.
pdf  c                   eval      p_ok = '0'
pdf  c                   call      'AP612R'
pdf  c                   parm                    l_filg
pdf  c                   parm                    l_outq
pdf  c                   parm                    p_ok
pdf   * Hvis feil utkø, logges dette i transaksjonsloggen
pdf  c                   if        p_ok = '0'
pdf  c                   eval      w_jstat = 20
pdf  c                   eval      w_jtext = 'Ugyldig utkø '+ l_outq + ' er val+
pdf  c                             gt. Ingen utskrift er generert. Utskrift kan+
pdf  c                              arkiveres.'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf  c                   else
pdf   *
pdf  c                   if        l_copy > 0
pdf  c                   eval      w_copy = l_copy
pdf  c                   else
pdf  c                   eval      w_copy = 1
pdf  c                   endif
pdf   *
pdf   *
pdf   /Free
pdf        // Finn print informasjon
pdf            UpdHTMLVar('Printername':         l_outq);
pdf            UpdHTMLVar('Copies':        %char(w_copy));
pdf            UpdHTMLVar('Papersource':            ' ');
pdf            UpdHTMLVar('Lastpagedrawer':         ' ');
pdf            UpdHTMLVar('Duplex':              'true');
pdf            UpdHTMLVar('Quality':                ' ');
pdf            UpdHTMLVar('Sorting':                ' ');
pdf            UpdHTMLVar('Staple':              'true');
pdf            UPDHTMLVar('Alignment':           w_land);
pdf            WrtSection('PrintCommand');
pdf   /End-free
pdf  c                   endif
pdf  c                   endif
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading                 *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_head      begsr
pdf   *
pdf  c                   eval      w_head = 'Utskrift av lagerverdiliste'
pdf   *
pdf   * Hvis mail skal skrives, må vi hente mail informasjon
pdf   *
pdf  c                   if        l_mail = 1
pdf  c                   eval      p_kule = 'L'
pdf  c                   eval      p_kund = vvldor
pdf  c                   eval      p_kpro = *zeros
pdf  c                   eval      p_numm = *zeros
6.31 c                   eval      p_suff = *zeros
pdf  c                   eval      p_selg = *zeros
pdf  c                   eval      p_in03 = *off
pdf   * Henter ut mailserver
pdf  c                   eval      p_serv = *blank
pdf  c                   eval      p_stat = *blank
pdf  c                   call      'AM705C'
pdf  c                   parm                    p_serv
pdf  c                   parm                    p_stat
pdf   *
pdf  c                   call      'FO798R'
pdf  c                   parm                    p_kule
pdf  c                   parm                    p_kund
pdf  c                   parm                    p_kpro
pdf  c                   parm                    p_numm
6.31 c                   parm                    p_suff
pdf  c                   parm                    p_selg
pdf  c                   parm                    p_navn
pdf  c                   parm                    p_emal
6.31 c                   parm                    p_ema2
6.31 c                   parm                    p_ema3
pdf  c                   parm                    p_emne
pdf  c                   parm                    p_txt1
pdf  c                   parm                    p_txt2
pdf  c                   parm                    p_txt3
pdf  c                   parm                    p_txt4
pdf  c                   parm                    p_pers
6.31 c                   parm                    p_kopi
pdf  c                   parm                    p_inif
pdf  c                   parm                    p_in03
pdf   * Scann av strenger
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_emne        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_pemne
pdf   * Scann av strenger
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt1        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt1
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt2        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt2
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt3        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt3
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt4        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt4
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_pers        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ppers
pdf   *
pdf  c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
pdf  c                                      %trim(w_ptxt2) + crlf +
pdf  c                                      %trim(w_ptxt3) + crlf +
pdf  c                                      %trim(w_ptxt4) + crlf +
pdf  c                                      %trim(w_ppers)
pdf   *
6.31 c                   if        p_kopi = *blanks
6.31 c                   eval      p_kopi = d_emal
pdf  c                   endif
pdf   *
pdf  c                   if        p_in03 = *off
pdf   *
pdf   /Free
pdf        // Skriv mailinformasjon
6.31           WrtSection('MailCommandStart');
6.31       //  UpdHTMLVar('Receivers':           p_emal);
6.31           if %Trim(p_emal)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_emal);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema2)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema2);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema3)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema3);
6.31           WrtSection('MailReceiver');
6.31           endif;
pdf            UpdHTMLVar('CC':                     ' ');
6.31           UpdHTMLVar('BCC':                 p_kopi);
6.31           UpdHTMLVar('Sender':              p_kopi);
pdf            UpdHTMLVar('Subject':             w_pemne);
pdf            UpdHTMLVar('Message':             w_mtxt);
pdf            UpdHTMLVar('SMTPServer':          p_serv);
pdf            UPDHTMLVar('SMTPUser':               ' ');
pdf            UPDHTMLVar('SMTPPw':                 ' ');
6.31      //   WrtSection('MailCommand');
6.31           WrtSection('MailCommandEnd');
pdf   /End-free
pdf  c                   endif
pdf  c                   endif
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Firma
pdf  c                   eval      w_1fnav = *blank
pdf  c                   eval      w_1fad1 = *blank
pdf  c                   eval      w_1fad2 = *blank
pdf  c                   eval      w_1navn = *blank
pdf  c                   eval      w_1gate = *blank
pdf  c                   eval      w_1adr2 = *blank
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     a1fnav        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     a1fnav
pdf  c                   movel     p_str_out     w_1fnav
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     w_fad1        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_fad1
pdf  c                   movel     p_str_out     w_1fad1
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     w_fad2        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_fad2
pdf  c                   movel     p_str_out     w_1fad2
pdf   /Free
pdf
pdf        // Skriv firmavariabler
pdf            UpdHTMLVar('Reporttext':            w_txt1);
pdf            UpdHTMLVar('CompanyName':          w_1fnav);
pdf            UpdHTMLVar('Companyadress1':       w_1fad1);
pdf            UpdHTMLVar('Companyadress2':       w_1fad2);
pdf            UpdHTMLVar('Companypostalcode':        ' ');
pdf            UpdHTMLVar('Companypostoffice':     w_fste);
pdf            UpdHTMLVar('Companyphone':          w_ftlf);
pdf            UpdHTMLVar('Companyfax':            w_ffax);
pdf            UpdHTMLVar('Companyorgno':   %char(aafftn));
pdf            UpdHTMLVar('Companygiro':    %char(aafbgi));
pdf            WrtSection('Company');
pdf
pdf            test(de) *dmy w_ddmy;
pdf            if %error;
pdf            tmpdate = *loval;
pdf            else;
pdf            tmpdate = %date(w_ddmy : *dmy);
pdf            endif;
pdf            UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
pdf
pdf            test(te) *hms w_tids;
pdf            if %error;
pdf            tmptime = *loval;
pdf            else;
pdf            tmptime = %time(w_tids : *hms);
pdf            endif;
pdf            UpdHTMLVar('Creationtime': %char(tmptime : *hms));
pdf            WrtSection('DocumentInformation');
pdf
pdf   /End-free
pdf   * Hvis kun bruddnivåer, skriv grupperingsnivå
pdf  c                   if        p_vlin = 1
pdf   *
pdf   /Free
pdf        // Første grupperingsnivå
pdf            WrtSection('StartGroup');
pdf        // Start/stopp tag for linjer
pdf            WrtSection('StockValueLines');
pdf   /End-free
pdf  c                   eval      b_grop = *on
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading                 *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_sort      begsr
pdf   * Hvis ikke forrige sluttag for sortering av totaler er skrevet gjøres det nå
pdf  c                   if        b_tota = *on
pdf  c                   exsr      xml_tot_end
pdf  c                   exsr      xml_grp_end
pdf  c                   endif
pdf   * Hvis group allerede er skrevet, skriv endtagg
pdf  c                   if        b_grop = *on and
pdf  c                             b_tota = *on
pdf  c                   exsr      xml_grp_end
pdf  c                   endif
pdf   * Hvis group heading ikke er skrevet tidligere, gjøres det nå
pdf  c                   if        b_grop = *off
pdf  c                   exsr      xml_grp_start
pdf  c                   endif
pdf   * Hvis heading på sort sekvens ikke er skrevet tidligere, gjøres det nå
pdf  c                   if        b_sort = *off
pdf   /Free
pdf        //  Legg ut 'heading' på sorteringslinjer
pdf            WrtSection('DocumentSortStart');
pdf   /End-free
pdf  c                   eval      b_sort = *on
pdf  c                   endif
pdf   *
pdf   * Legger ut sorteringsbegrep
pdf   *
pdf   /Free
pdf            UpdHTMLVar('Text':                 w_text);
pdf            WrtSection('DocumentSortText');
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading                 *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_sort_end  begsr
pdf   * Skriv avsluttende sort sekvens
pdf  c                   if        b_sort = *on
pdf   /Free
pdf        //  Legg ut 'heading' på sorteringslinjer
pdf            WrtSection('DocumentSortEnd');
pdf   /End-free
pdf  c                   endif
pdf   *
pdf  c                   eval      b_sort = *off
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Detaljer                *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_deta      begsr
pdf   * Skriv avsluttende sorttag
pdf  c                   exsr      xml_sort_end
pdf   * Hvis ikke forrige sluttag for sortering av totaler er skrevet gjøres det nå
pdf  c                   if        b_tota = *on
pdf  c                   exsr      xml_tot_end
pdf  c                   exsr      xml_grp_end
pdf  c                   endif
pdf   * Hvis ikke grupperingsnivå er skrevet, legges ut nå.
pdf  c                   if        b_grop = *off
pdf  c                   exsr      xml_grp_start
pdf  c                   endif
pdf   *
6.37 c                   if        w_lv_nobb <> 0
6.37 c                   eval      w_nobb = w_lv_nobb
6.37 c                   else
6.37 c                   eval      w_nobb = vvnobb
6.37 c                   endif
      *
pdf   * Klargjør detaljer og legge ut.
pdf   *
pdf  c                   if        b_deta = *off
pdf  c                   eval      b_deta = *on
pdf   /Free
pdf            WrtSection('StockValueLines');
pdf   /End-free
pdf  c                   endif
pdf   * Scann varetekst
pdf  c                   eval      w_tek1 = *blank
pdf  c                   eval      w_tek2 = *blank
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     d1tek1        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_tek1
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     vvtek2        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_tek2
pdf   *
pdf   /Free
pdf        // Skriv mailinformasjon
pdf            UpdHTMLVar('Overgruppe':      %char(vvogrp));
pdf            UpdHTMLVar('Hovedgruppe':     %char(vvhgrp));
pdf            UpdHTMLVar('Undergruppe':     %char(vvugrp));
pdf            UpdHTMLVar('Storage':         %char(d1lage));
6.37           UpdHTMLVar('Nobbno':          %char(w_nobb));
pdf            UpdHTMLVar('Itemno':                 d1vare);
pdf            UpdHTMLVar('Text1':                  w_tek1);
pdf            UPDHTMLVar('Text2':                  w_tek2);
pdf            UPDHTMLVar('Unit':                   d1enhl);
pdf            UPDHTMLVar('Salesprice':      %char(d1spri));
pdf            UPDHTMLVar('Costpricecurrent':%char(d1kpri));
pdf            UPDHTMLVar('Costpriceaverage':%char(d1snkp));
pdf            UPDHTMLVar('Quantity':        %char(d1behl));
pdf            UPDHTMLVar('Salesvalue':      %char(d1omst));
pdf            UPDHTMLVar('Costvalue':       %char(d1kost));
pdf            UPDHTMLVar('Costvalueaverage':%char(d1snkt));
pdf
pdf            test(de) *dmy d1dato;
pdf            if %error;
pdf            tmpdate = *loval;
pdf            else;
pdf            tmpdate = %date(d1dato : *dmy);
pdf            endif;
pdf            UpdHTMLVar('Transdate':   %char(tmpdate : *iso));
pdf
pdf            WrtSection('Line');
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Linje                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_line_end  begsr
pdf   * Skriv avsluttende line sekvens
pdf   /Free
pdf        //  Legg ut 'sluttag' på detaljlinjer
pdf            WrtSection('EndStockValueLines');
pdf   /End-free
pdf   *
pdf  c                   eval      b_deta = *off
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Sorteringstotal         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_tot_start begsr
pdf   * Skriv avsluttende line sekvens
pdf  c                   exsr      xml_line_end
pdf   //Free
pdf        //  Legg ut 'starttagg' på sorteringsnivå
pdf        //  WrtSection('SortingTotalStart');
pdf   //End-free
pdf   *
pdf  c                   eval      b_tota = *on
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - total                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_total     begsr
pdf   * Hvis heading på total sekvens ikke er skrevet tidligere, gjøres det nå
pdf  c                   if        b_tota = *off
pdf  c                   exsr      xml_tot_start
pdf  c                   endif
pdf   *
pdf   * Legger ut sorteringsbegrep
pdf   *
pdf   /Free
pdf            UpdHTMLVar('Totaltext':               t_text);
pdf            UpdHTMLVar('Totalquantity':    %char(t_behl));
pdf            UpdHTMLVar('Totalsalesvalue':  %char(t_omst));
pdf            UpdHTMLVar('Totalcostvalue':   %char(t_kost));
pdf            UpdHTMLVar('Totalavgcostvalue':%char(t_snko));
pdf            WrtSection('SortingTotalvalue');
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - totallinjer             *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_tot_end   begsr
pdf   * Skriv avsluttende total
pdf   //Free
pdf        //  Legg ut 'sluttag' på totallinjer
pdf        //  WrtSection('EndSortingTotal');
pdf   //End-free
pdf   *
pdf  c                   eval      b_tota = *off
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Grouping                *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_grp_start begsr
pdf   * Skriv start group
pdf   /Free
pdf        //  Legg ut 'starttag' på group
pdf            WrtSection('StartGroup');
pdf   /End-free
pdf  c                   eval      b_grop = *on
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Grouping                *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_grp_end   begsr
pdf   * Hvis startgroup er skrevet, må vi legge ut ny endtagg, før
pdf   /Free
pdf        //  Legg ut 'sluttag' på group
pdf            WrtSection('EndGroup');
pdf   /End-free
pdf  c                   eval      b_grop = *off
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Slutt                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_end       begsr
pdf   *
pdf   /Free
pdf            WrtSection('EndStockValueDocument');
pdf   /End-free
pdf   *
pdf   * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
pdf   *
pdf  c                   if        l_arch = 1
pdf   * Lag tag for vising i arkivklienten
pdf  c                   eval      w_dspl = *blank
pdf  c                   eval      w_dspl = 'Lagerverdiliste '
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     w_dspl        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_dspl
pdf   /Free
pdf        // Skriv metattags
pdf
pdf            UpdHTMLVar('Displaytag':     %trim(w_dspl));
pdf            WrtSection('ArchiveCommandStart');
pdf
pdf            UpdHTMLVar('Metavalue':                ' ');
pdf            UpdHTMLVar('Metakey':    'LAGERVERIDLISTE');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue':             l_user);
pdf            UpdHTMLVar('Metakey':             'BRUKER');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue': %char(w_date:*iso));
pdf            UpdHTMLVar('Metakey':               'DATO');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue':             w_txt1);
pdf            UpdHTMLVar('Metakey':         'RUTINETEKST');
pdf            WrtSection('MetaTag');
pdf
pdf            WrtSection('ArchiveCommandEnd');
pdf   /End-free
pdf   *
pdf  c                   endif
pdf   *
pdf   /Free
pdf            WrtSection('Footer');
pdf   /End-free
pdf   *
pdf  c                   eval      XML_Output = XML_path + l_filg +'/'+
pdf  c                             'Lagv_'+ %trim(w_jkey) + '.xml'
pdf   *
pdf  c                   callp     WrtHtmlToStmf(XML_Output: 819)
6.32  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
6.32 c                   if        d_dtaq = '1'
6.32 c                   eval      p_xmlf = xml_output
6.32 c                   eval      p_filg = 'ADB'+l_filg
6.32 c                   call      'AP629C'
6.32 c                   parm                    p_filg
6.32 c                   parm                    p_xmlf
6.32 c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     pdf_preview   begsr
pdf   *
pdf   * Vi kaller program for launch av PDF i browser
pdf  c                   call      'AP621R'
pdf  c                   parm                    w_jkey
pdf   *
pdf  c                   endsr
pdf   *
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.36  * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.36 c     pdf_preview2  begsr
6.36 c                   if        l_skje = 1
6.36  * Vi kaller program for launch av PDF i browser
6.36 c                   call      'AP621R'
6.36 c                   parm                    l_bach
6.36  *
6.36 c                   endif
6.36  *
6.36 c                   endsr
6.36  *
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.36  * Finner spool som er generert av jobben
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.36 c     spoolnbr      begsr
6.36  /Free
6.36
6.36           QSPRILSP( SPRL0100
6.36                   : %size(SPRL0100)
6.36                   : 'SPRL0100'
6.36                   : errorcode );
6.36  /End-free
6.36 c*
6.36 c                   endsr
6.36  *
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.36  * Kaller eget program for generering av xml fil. Eget pgm         *
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.36 c     xml_create    begsr
6.36  *
6.36 c                   eval      splfname2 = *blanks
6.36 c                   eval      splfname3 = *blanks
6.36 c                   eval      jobname2 = *blanks
6.36 c                   eval      jobname3 = *blanks
6.36 c                   eval      username2 = *blanks
6.36 c                   eval      username3 = *blanks
6.36 c                   eval      jobnbr2 = *blanks
6.36 c                   eval      jobnbr3 = *blanks
6.36 c                   eval      splfnbr2 = *zeros
6.36 c                   eval      splfnbr3 = *zeros
6.36 c                   eval      p_btyp = 'LAGERVERDILISTE'
6.36 c                   eval      p_dspl = *blanks
6.36 c                   eval      p_refn = 'LAGERVERDILISTE ' + %char(a1date)
6.36 c                   eval      p_tagg0 = *blanks
6.36 c                   eval      p_tagg0val = *blanks
6.36 c                   eval      p_tagg1 = *blanks
6.36 c                   eval      p_tagg1val = *blanks
6.36 c                   eval      p_tagg2 = *blanks
6.36 c                   eval      p_tagg2val = *blanks
6.36 c                   eval      p_tagg3 = *blanks
6.36 c                   eval      p_tagg3val = *blanks
6.36 c                   eval      p_tagg4 = *blanks
6.36 c                   eval      p_tagg4val = *blanks
6.36 c                   eval      p_tagg5 = *blanks
6.36 c                   eval      p_tagg5val = *blanks
6.36 c                   eval      p_tagg6 = *blanks
6.36 c                   eval      p_tagg6val = *blanks
6.36 c                   eval      p_tagg7 = *blanks
6.36 c                   eval      p_tagg7val = *blanks
6.36 c                   eval      p_tagg8 = *blanks
6.36 c                   eval      p_tagg8val = *blanks
6.36 c                   eval      p_tagg9 = *blanks
6.36 c                   eval      p_tagg9val = *blanks
6.36  *
6.36 c                   call      'AP627R'
6.36 c                   parm                    splfname
6.36 c                   parm                    jobname
6.36 c                   parm                    username
6.36 c                   parm                    jobnbr
6.36 c                   parm                    splfnbr
6.36 c                   parm                    splfname2
6.36 c                   parm                    jobname2
6.36 c                   parm                    username2
6.36 c                   parm                    jobnbr2
6.36 c                   parm                    splfnbr2
6.36 c                   parm                    splfname3
6.36 c                   parm                    jobname3
6.36 c                   parm                    username3
6.36 c                   parm                    jobnbr3
6.36 c                   parm                    splfnbr3
6.36 c                   parm                    p_tagg0
6.36 c                   parm                    p_tagg0val
6.36 c                   parm                    p_tagg1
6.36 c                   parm                    p_tagg1val
6.36 c                   parm                    p_tagg2
6.36 c                   parm                    p_tagg2val
6.36 c                   parm                    p_tagg3
6.36 c                   parm                    p_tagg3val
6.36 c                   parm                    p_tagg4
6.36 c                   parm                    p_tagg4val
6.36 c                   parm                    p_tagg5
6.36 c                   parm                    p_tagg5val
6.36 c                   parm                    p_tagg6
6.36 c                   parm                    p_tagg6val
6.36 c                   parm                    p_tagg7
6.36 c                   parm                    p_tagg7val
6.36 c                   parm                    p_tagg8
6.36 c                   parm                    p_tagg8val
6.36 c                   parm                    p_tagg9
6.36 c                   parm                    p_tagg9val
6.36 c                   parm                    l_bach
6.36 c                   parm                    p_btyp
6.36 c                   parm                    p_refn
6.36 c                   parm                    p_dspl
6.36  *
6.36 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Key for les av vare
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for av overgruppe
      *
     c     vogrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vogrl1_oogr
      *
      * Key for hovedgruppe
      *
     c     vhgrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vhgrl1_hogr
     c                   kfld                    vhgrl1_hhgr
      *
      * Key for undergruppe
      *
     c     vugrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vugrl1_uogr
     c                   kfld                    vugrl1_uhgr
     c                   kfld                    vugrl1_uugr
      *
      *  Key for kontohenvisning
      *
     c     vkhvl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vkhvl1_khev
5.20 c                   kfld                    vkhvl1_klty
     c                   kfld                    vkhvl1_koty
      *
      * Key for les av innkjøpsstatistikk
      *
     c     sistlb_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sistlb_paar
     c                   kfld                    sistlb_vare
      *
      * Key for les av BATCH
      *
     c     lbchl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lbchl1_batc
7.01  *
7.01  * Key for les av sidetabell med varetekst
7.01  *
7.01 c     lwa4l1_key    klist
7.01 c                   kfld                    w_firm
7.01 c                   kfld                    lwa4l1_akey
pdf   *
pdf   * Key for firmaregister
pdf   *
pdf  c     afirl1_key    klist
pdf  c                   kfld                    w_firm
pdf   *
pdf   * Key for formular-register
pdf   *
pdf  C     aforl1_key    klist
pdf  C                   kfld                    w_ruti
pdf   *
pdf   * Hente inn rutinenavn
pdf   * og meldingstekst
pdf   *
pdf  c                   eval      w_ruti = l_ruti
pdf  c                   eval      w_txt1 = *blank
pdf   *
pdf  C     aforl1_key    chain     aforl1r                            69
pdf  C* n69              move      aftxt1        w_txt1
      *
      * Parameterliste
      *
     c     *entry        plist
     c                   parm                    w_parm
     c                   eval      p_prec = w_parm
      *
     c                   time                    w_dato
     c                   time                    w_time
     c                   eval      w_firm = l_firm
      *
      * Redigere heading
      *
     c     *dmy          move      w_dato        a1date
     c     *hms          move      w_time        a1time
     c                   eval      a1user = l_user
     c                   eval      a1wsid = l_wsid
     c                   eval      a1firm = l_firm
     c                   eval      a1fnav = l_fnav
      *
      * Lagerverdi pr. dato - finn riktig dato i hht. metode
      *
     c                   select
     c                   when      p_brud = 0
     c                   eval      a1datp = p_dath
     c                   when      p_brud = 1
     c                   eval      w_aarr = uyear
     c                   eval      w_aarr = w_aarr + 10100
     c                   eval      a1datp = w_aarr
     c                   when      p_brud = 2
     c                   exsr      les_batch
     c     *dmy          move      lcedat        a1datp
     c                   endsl
      *
     c                   eval      *in71  = p_sort = 1
     c                   eval      *in72  = p_sort = 2
     c                   eval      *in73  = p_sort = 3
     c                   eval      *in74  = p_sort = 4
     c                   eval      *in75  = p_sort = 5
     c                   eval      *in76  = p_sort = 6
pdf   *
pdf   * Sjekk om vi skal bruke JASPER og XML generering av dokumenter
pdf  c                   if        l_poff = '1'
pdf  c                   eval      b_pdfp = *off
pdf  c                   eval      w_pdf = 0
pdf  c                   eval      w_pdf_ds = *blanks
pdf  c                   eval      w_ruti = l_ruti
pdf   *
pdf  c                   call      'AP609R'
pdf  c                   parm                    w_ruti
pdf  c                   parm                    w_pdf
pdf  c                   parm                    w_pdf_ds
pdf  c                   eval      d_pdf_ds = w_pdf_ds
pdf   * Vi skal kjøre med jasper
pdf  c                   if        w_pdf = 1 and
pdf  c                             %trim(d_xmlm) <> *blanks
pdf  c                   eval      p_mail = '0'
pdf  c                   eval      w_jkey = l_bach
pdf   *
pdf   * Hent inn xml templaten - NB Kun hvis excel er valgt
pdf   *
6.36 c                   if        l_exlp = 1 and
6.36 c                             p_vlin = 0
pdf  c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
6.34 c                   callp     ClrHtmlBuffer
pdf   *
pdf   * Finn hvor xml'en skal legges
pdf   *
pdf  c                   eval      XML_path = *blanks
pdf  c                   eval      XML_path = %trim(d_path)
pdf   *
pdf   * Finn path til logo
pdf   *
pdf  c                   eval      jasper_logo = *blanks
pdf  c                   eval      jasper_logo = %trim(d_logo)
pdf   *
pdf   * Jobbnummer er allerede generert i AP600R. Overføres i *lda
pdf   *
pdf  c                   time                    w_date
pdf   * Vi logger ar utskriftprogrammet har startet
pdf  c                   eval      w_jstat = 10
pdf  c                   eval      w_jtext = 'Utskrift av lagerverdiliste ha+
pdf  c                                       r startet'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf   * Vi skriver xml for miljø formater
pdf  c                   exsr      xml_envm
pdf  c                   eval      b_pdfp = *on
6.36 c                   endif
pdf   *
pdf  c                   endif
pdf   * Hvis et eller annet er galt med parametrene, logges og kjør uten PROA
pdf  c                   if        %trim(d_xmlm) = *blanks
pdf  c                   eval      b_pdfp = *off
pdf   * Vi logger at noe er galt med parametrene
pdf  c                   eval      w_jstat = 20
pdf  c                   eval      w_jtext = 'Finner ikke path til xml !!! +
pdf  c                             Sjekk rutineregister !'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf  c                   endif
pdf   *
pdf   *  Hent inn firma/avd. opplysninger dersom
pdf   *  kode for det er satt i rutineregister
pdf   *
pdf  c                   if        l_prfi = 1 or
pdf  c                             l_prfi = 2
pdf  c                   eval      w_prfi = l_prfi
pdf  c                   eval      w_ffir = w_firm
pdf  c                   eval      w_avde = l_avde
pdf   *
pdf  c                   call      'FÅ707R'
pdf  c                   parm                    w_prfi
pdf  c                   parm                    w_ffir
pdf  c                   parm                    w_avde
pdf  c                   parm                    w_fnav
pdf  c                   parm                    w_fad1
pdf  c                   parm                    w_fad2
pdf  c                   parm                    w_fste
pdf  c                   parm                    w_fftx
pdf  c                   parm                    w_tfax
pdf  c                   parm                    w_ftlf
pdf  c                   parm                    w_ffax
6.33 c                   parm                    w_mail
6.33 c                   parm                    w_weba
pdf  c                   endif
pdf   *
pdf  c                   time                    w_dato2
pdf  c                   movel     w_dato2       w_tids            6 0
pdf  c                   move      w_dato2       w_ddmy
pdf  c                   eval      b_sort = *off
pdf  c                   eval      b_tota = *off
pdf  c                   eval      b_deta = *off
pdf   * Hardkoder inn tekst basert på sorteringsbegref
pdf  c                   eval      w_txt1 = 'Sortert pr: '
pdf  c                   if        *in71 = *on
pdf  c                   eval      w_txt2 = 'Varenummer/lager'
pdf  c                   elseif    *in72 = *on
pdf  c                   eval      w_txt2 = 'Varegruppe/Varenummer/+
pdf  c                             lager'
pdf  c                   elseif    *in73 = *on
pdf  c                   eval      w_txt2 = 'Kontohenv./Varenummer/+
pdf  c                             lager'
pdf  c                   elseif    *in74 = *on
pdf  c                   eval      w_txt2 = 'Lager/Varenummer'
pdf  c                   elseif    *in75 = *on
pdf  c                   eval      w_txt2 = 'Lager/Varegruppe/+
pdf  c                             varenummer'
pdf  c                   elseif    *in76 = *on
pdf  c                   eval      w_txt2 = 'Lager/Kontohenv./+
pdf  c                             varenummer'
pdf  c                   else
pdf  c                   move      aftxt1        w_txt2
pdf  c                   endif
pdf  c                   eval      w_txt1 = 'Sortert pr: ' + %trim(w_txt2)
pdf   *
pdf  c                   else
pdf  c                   eval      b_pdfp = *off
pdf  c                   endif
pdf   *
pdf   * Slår opp etter firmainformasjon
pdf   *
pdf  c     afirl1_key    chain     afirl1r
      *
6.36 c                   if        b_pdfp = *off
6.36 c                   open      ll609p
6.36 c                   endif
      *
     c                   endsr
