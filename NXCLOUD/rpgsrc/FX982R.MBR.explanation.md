# RPG Source Code Explanation

## Purpose and Function

This program, intended for the IBM i (AS/400) platform and written in ILE RPG (fixed-form), reads through every record in a physical file `vvarPF` (accessed through logical files `vvarl1` and `vvarlu`). Its goal is to search for specific special character representations (such as HTML entities like `&hy;`, `&quot;`, `&apos;`, etc.) in two text fields (`vvtek1` and `vvtek2`) and replace them with double quotes (`"`). The program updates the records in place, one entity at a time per record, so repeated updates may occur for the same record if there are multiple substitutions necessary.

Comments and variable names are in Norwegian, but the logic can be understood generally.

---

## File Declarations

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvarlu    uf   e           k disk    rename(vvarpfr:vvarlur)
```
- **vvarl1**: Input logical file (keyed) for reading all records.
- **vvarlu**: Update logical file (keyed) for updating records.
- Both are based on the physical file `vvarPF`, but with different record formats.

---

## Data Definitions

```rpg
d w_firm          s                   like(vvfirm)
d vvarlu_vare     s                   like(vvvare)
d w_tek1          s                   like(vvtek1)
d w_tek2          s                   like(vvtek2)
d pos1            s              4  0
d pos2            s              4  0
d b_sokfl         s              1    inz(*off)
```
- **w_firm**: Work variable for company number/identifier.
- **vvarlu_vare**: Key variable for record identification.
- **w_tek1, w_tek2**: Work variables for text processing on two fields.
- **pos1, pos2**: Used to hold the position of the found entity in text.
- **b_sokfl**: Search flag, initialized to false (unused in logic).

### Local Data Area (LDA) Reference

```rpg
d                uds
d l_firm                944    946  0
```
- UDS block references fields in LDA, the **l_firm** being a field at positions 944–946.

---

## Processing Loop

### Read and Loop through All Records

```rpg
c                   read      vvarl1                                 90
c                   dow       *in90 = *off
    ...
c                   read      vvarl1                                 90
c                   enddo
```
- Reads the next record from `vvarl1` and processes until EOF.

---

## Replacement Routine

For each record, the program searches for the following HTML-like entity strings **in both text fields**:

- `&hy;`  (possibly means hyphen, but replaced with `"`)
- `&quot;` (double quote)
- `&apos;` (single quote)
- `&lt;`   (less than)
- `&gt;`   (greater than)
- `&amp;`  (ampersand)

### Search and Replace Steps

#### For Each Entity:
1. **Find the position** of the entity in `vvtek1` and `vvtek2` using `%scan`.
2. If found in either field:
    - Set up the key and chain to the record in the update-capable file (`vvarlu`).
    - For `vvtek1` and/or `vvtek2`:
        - Build a new string (`w_tek1`/`w_tek2`) by concatenating:
            - The part before the found entity,
            - A double quote (`"`),
            - The part after the entity (skipping the entity's length).
          - The number of characters skipped depends on the entity length:
              - `&hy;`/`&quot;`/`&apos;`: 6 chars
              - `&lt;`/`&gt;`: 4 chars
              - `&amp;`: 5 chars
        - If the entity is near the end of the string, just append `"` after the previous part.
    - Store back to the original field.
    - **Update** the record in the file.
    - **Goto Tag:** Repeat for the same entity type in the same record, in case there are multiple occurrences.
3. Repeat the search-and-replace for the next entity.

#### Example for `&hy;`:

```rpg
c                   eval      pos1 = %scan('&hy':vvtek1)
c                   eval      pos2 = %scan('&hy':vvtek2)
...
c                   if        pos1 > 0 or pos2 > 0
    - Chain to update file by key.
    - If found, for each field that has the entity:
        - Compose the new string with a quote in place of the entity.
    - Update the record.
    - `goto sok_fler1` to repeat until all `&hy;` are replaced in this record.
```

This pattern repeats for all entities.

### Why do we keep reprocessing a record after update?

- If a record has multiple instances of the entity (e.g., more than one `&amp;`), the loop repeats (`goto sok_fler*`), rescanning and replacing until all are replaced.

---

## Key List and Initialization

```rpg
c     vvarlu_key    klist
c                   kfld                    w_firm
c                   kfld                    vvarlu_vare
...
c                   eval      w_firm = l_firm
```
- The key to update records is made up of the company identifier and item code.
- `w_firm` is loaded from the Local Data Area field `l_firm` on program initialization.

---

## Program End

```rpg
c                   eval      *inlr = *on
```
- Sets last record indicator for program exit and cleanup.

---

# Summary

- This program systematically updates special HTML-like entities in two text fields, replacing them with double quotes (`"`).
- It reads every record in the file, processes multiple entities per record, and updates records as needed.
- It uses logical files for read and update, and tags with `goto` for in-record entity loop.
- All changes are done in place, one entity-at-a-time per update to ensure all instances are replaced.

---

## Diagram: Main Loop

```text
For each record in vvarl1:
    For each entity (&hy;, &quot;, &apos;, &lt;, &gt;, &amp;):
        While entity found in either vvtek1 or vvtek2:
            Chain update file by key
            Replace entity with "
            Update record
            Repeat for this entity
End
```

---

## What to Know for Onboarding

- **Record Structure**: Know the structure of `vvarPF` and its logicals.
- **Fields**: Focus on `vvtek1`, `vvtek2` (text fields), their max lengths, and how entities may appear.
- **Special Entities**: Know which entities are replaced and why (to sanitize or normalize malformed text).
- **Logic**: Note repeated processing within a single record for multiple occurrences.
- **Testing**: If modifying, test with data including multiple and overlapping entities.

Let me know if you need a flowchart or further breakdown of a specific entity’s processing!