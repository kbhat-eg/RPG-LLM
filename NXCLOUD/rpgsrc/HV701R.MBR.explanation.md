# RPG Program Explanation: HV701R

## Overview

This RPG program (`HV701R`) is targeted at generating item (product) data for hand terminals, by producing a file (METO) for external scanning of the product register.  
It processes assortments of items, retrieves their relevant data, calculates prices (including tax), and writes output records with EAN codes or supplier numbers for use by handheld devices.

The program is highly parameterized, supports various file versions, and is maintained through incremental updates as seen in the history comments with new features, extensions for EAN numbers, logistics, etc.

---

## Header Information

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: Disables debug for IO operations.
- `datedit(*dmy)`: Sets the default date editing format to day-month-year.

---

## File Declarations

The program uses several database files, each with a specific role:

- `veanl2`, `vvepl1`, `vvepl2`, `vvawpf`, `vvlel1`: Various item, EAN, and item unit files, many renamed for internal use.
- `hbvapf`: Output file for scanned product information (`hbvapfr`).

---

## Data Structures

### Main Output Record

```rpg
d                 ds
d d_vrec                       114
d  d_eann                       14    overlay(d_vrec)
d  d_lvnr                       15    overlay(d_vrec:15)
d  d_vare                        8    overlay(d_vrec:30)
d  d_tek1                       35    overlay(d_vrec:38)
d  d_enh1                        3    overlay(d_vrec:73)
d  d_pri1                       11    overlay(d_vrec:76)
d  d_enh2                        3    overlay(d_vrec:87)
d  d_pri2                       11    overlay(d_vrec:90)
d  d_enh3                        3    overlay(d_vrec:101)
d  d_pri3                       11    overlay(d_vrec:104)
```
- A packed record representing output for each product, with overlays enabling access to fields like EAN, supplier item number, product, description, units, and prices.

### Price Formatting

```rpg
d                 ds
d d_spim                        11
d  d_spim_kr                     7    overlay(d_spim:2)
d  d_spim_komma                  1    overlay(d_spim:9) inz(',')
d  d_spim_øre                    2    overlay(d_spim:10)
```
- Used to split and format price into kroner and øre (cents).

---

## Parameter Declarations

Variables used for input parameters, such as company, assortment, warehouse, and date.

---

## Key Variables and Work Fields

Work fields for:
- Storing key fields for database lookups.
- Price, tax, item types, timestamps.
- Output formatting and business logic control (e.g., which items to include/exclude).

---

## Main Logic Flow

### 1. Initialization (`*inzsr`)
- Receives parameters: company, assortment, date, warehouse.
- Prepares key lists for file lookups.
- Reads company info and current time.
- Retrieves VAT factors by calling `FÅ705R`.
- Retrieves price group with `VL711R`.

### 2. Main Routine

#### a. Call Extraction Program

```rpg
c     call      'VD700R'
```
- Calls extraction program to generate a picklist file for the assortment.

#### b. Loop Through Items

```rpg
c     read      vvawpf
c     dow       *in90 = *off
    if    vvvare <> w_vare_gml
        exsr behandling
    endif
    w_vare_gml = vvvare
    read      vvawpf
enddo
```
- Reads the assortment file (`vvawpf`), processes each unique item by invoking the `behandling` subroutine.

#### c. Program End

- Sets last record indicator `*inlr = *on` and returns.

---

### 3. Item Processing Subroutine (`behandling`)

#### a. Exclude Non-Processed Types

- Calls `VL710R` to get item type and info.
- Skips items of type 'S' (special order), 'D' (misc), or 'T' (service).

#### b. Build Output Record

- Clears output buffer.
- Fills out item fields from assorted files.
- Fetches prices for up to 3 sales units by calling `VP716R`.
- Handles offer prices: if offer not valid for current date, zeroes out special prices.
- Chooses applicable price per unit via a priority (offer > base > standard).

#### c. Price Calculation

- Multiplies price by VAT factor.
- Optionally calls `FA909R` for further price calculation/validation.
- Formats price into kroner and øre for output fields.

#### d. EAN Handling

- Looks up EAN codes from unit and EAN files (`vvepl1`, `veanl2`).
- If found, writes a record for each EAN.
- If no EAN, writes a record with the supplier item number.

---

### 4. Key Lists

- Key lists (`klist`) are set up for efficient indexed file access using the appropriate combination of company and item/EAN number.

---

## Other Key Points

- Version control and history are meticulously kept in comments.
- The code supports extensibility for new fields and external modules via *CALL/PARM* interface.
- Norwegian code comments and variable names: "vare" (item), "lev" (supplier), "pris" (price), etc.

---

## Summary Table

| Function              | Description                                                      |
|-----------------------|------------------------------------------------------------------|
| `*inzsr`              | Init; reads params, sets up keys, gets company/time/VAT/prices   |
| Main loop             | Calls picklist generator, loops through picked items             |
| `behandling` subr     | For each unique item: filters, fetches info/prices, writes output|
| EAN handling          | Records written per EAN/unit; fallback to supplier number        |
| Extensible design     | Easily supports new fields, calls to external programs           |

---

## Key Takeaways for Developers

- **Modular Approach:** Business logic is subdivided through subroutines and external program calls.
- **File-based Batch Processing:** The RPG code interacts extensively with DB2/400 physical files.
- **Parameter Driven:** Behavior, output, and file access are controlled by parameters provided at runtime.
- **Localization:** Business terms, comments, and some formatting adhere to Norwegian conventions.

This code is essentially a batch process exporting up-to-date, detailed item/master data (with multi-unit pricing and barcode/EAN support) for use with hand terminal systems in a retail/logistics environment.