# Overview

This RPG program (`FW626R`) is designed to update product and price information, including managing supplier/product journals, and producing control or journal lists. The main function is to transfer changed/updated product data from a supplier to the master product register and print relevant lists for control or logging.

The program is structured in traditional ILE RPG (mostly fixed-form, with *C* specs for logic, *F* specs for files, and *D* specs for data definitions). It interacts with multiple database files representing products, prices, suppliers, and other related entities.

The comments (some in Norwegian) and version history indicate it has evolved over years, gaining features like cross-docking, expanded price group fields, traceability, and more.

---

## File Definitions (`F` specs)

The program defines several input (I), update (U), and output (O) files, often using logical views (with `rename`) over base physical files.

- **Primary Input Files:**  
  - `flval3`: Supplier product records.
  - `vvarl5`, `vvarlu`: Product master data.
  - `vvprl1`, `vvprlu`: Product price data.
  - `vvenlu`, `veanlu`, `vveplu`, `vvepl2`: Additional product/unit/EAN data.
  - Others: `afir1`, `rlevl1`, `vogrl1`, `vhgrl1`, `vugrl1`.

- **Output File:**  
  - `fw626p`: Printer file for report output.

Each file has an associated record format (e.g., `flvapfr:flval3r`) that is renamed for clarity within this program.

---

## Data Structures

- **Local Data Area (`UDS`):**  
  Holds workstation ID and user, mapped to fixed positions.

- **Input Parameter Structure (`d_list`):**  
  Contains fields like company, type, supplier, product group, date, price modifications, update/control flags, etc. These are mapped via overlays to the input parameter.

- **Working Variables:**  
  Many stand-alone variables (e.g., status, date, various codes, monetary values, etc.) are declared for intermediate calculations.

---

## Main Logic Flow (Control Section)

1. **Initialize Program (`*inzsr`):**  
   - Load input parameters.
   - Set up file keys for various database lookups/updates.
   - Fetch today’s date and VAT rates.
   
2. **Print Report Header (`exsr hode`):**  
   - Populate header variables (company, user, workstation, date/time).
   - Fetch company info, parameter descriptions, and names.
   - Print report header lines.

3. **Process and Print Details (`exsr behandling`):**  
   - Loop through supplier product records.
   - Check if product matches selection criteria (range, group, etc.).
   - Call validation subprogram.
   - Print detail line.
   - If journal list (not just control list), update master data (`exsr oppdater`).

4. **End Program:**  
   - Set on LR flag (end-of-program indicator).
   - Return.

---

## Subroutines (Important ones)

### 1. Header Output (`hode`)
- Sets up report headers using system/user info and parameter values from the input structure.
- Looks up and displays descriptive names for supplier, product groups, etc.
- Writes multiple header lines to the printer file.

### 2. Main Processing Loop (`behandling`)
- Reads the supplier’s product records, starting from the appropriate key.
- Applies selection logic: product number range, exclusion codes, etc.
- Validates each record by calling an external program (`FW113R`).
- Prints a detail line (`exsr detalj`).
- If journal updating is requested, updates master data (`exsr oppdater`).
- Loops for next supplier product record.

### 3. Detail Line Output (`detalj`)
- Maps/assigns variables for report columns.
- Looks up existing prices for the product/unit/type combo.
- Calculates new prices, including VAT and price changes.
- Calculates price change percentage and margin (dekningsgrad, DG).
- Outputs a detail line to the report/printer.
- Handles page overflow (prints headers again if needed).

### 4. Update Master Data (`oppdater`)
- Updates price records and product master data if the product passes checks.
- Applies price change factors to all relevant product/unit/price type records.
- If “new price only” is specified, deletes future-dated prices.
- Updates product (e.g., text, NOBB code, variant/cross-dock, weights/dims, etc.).
- Updates product/unit info (weight, volume, EAN, etc.).
- Updates EAN cross-references, ensuring uniqueness.
- Calls external program for updating search texts.
- Puts product on hold if needed.

### 5. Update Price Record (`oppdat_pris`)
- Used by `oppdater` to update individual price records for product/unit/type/date.
- Either updates an existing price or writes a new one.
- If “delete newer prices” is set, deletes any prices after the new price date.

### 6. EAN Uniqueness Check (`sjekk_ean`)
- Checks if an EAN number is already registered on a product-unit.
- Sets a flag to prevent duplicate EAN registration.

---

## Key Program Features

- **Selection Logic:**  
  The program allows detailed selection of which products to process, based on range and group fields in the input structure.

- **Price Calculation:**  
  Allows for complex rules to update sales, cost, and purchase prices, including applying percentage changes, and recalculating margin and price change percentage.

- **Data Integrity:**  
  Updates are only performed if validation passes (`w_stat = 0`), and checks for duplicates (e.g., EANs).

- **Extensive Logging/Tracing:**  
  Maintains timestamps, users, etc., for all changes.

- **Scalability:**  
  Handles updating all price records for a product, not just the incoming one, according to factors and control parameters.

- **External Program Calls:**  
  Uses “call” to external programs (e.g., for validation, for VAT rate fetch, search text update). Thus, program is modular and relies on other business logic.

---

## Key Data Flows

1. **Input Parameter Structure:**  
   Used to define which products are processed and how.

2. **Supplier Product File (`flval3`):**  
   Main input; each record is a candidate for update.

3. **Product/Price/Register Tables:**  
   Various chains, reads, and updates to product and price files (master and supplier versions) for updating, reading, and deleting relevant records as needed.

4. **Output:**  
   Printer file for reports/lists.

---

## Notable RPG Idioms

- `setll`/`reade`/`chain`/`update`/`write`/`delete`: Common file I/O operations.
- `eval(h)`: High-precision arithmetic calculations.
- `dow`/`endif`/`endsr`/`return`: Control flow.
- Use of `*entry` and parameter parsers in `*inzsr`.
- Overlay fields for efficient memory/data structure usage.
- Heavy reliance on working variables and manual mapping between fields.

---

## Summary Table

| Function                   | Action                                                                                   |
|----------------------------|-----------------------------------------------------------------------------------------|
| Initial parameter processing| Set up environment, file keys, parse input.                                             |
| Header printing            | Print company/user/report-type info as report heading.                                  |
| Detail processing          | Loop over supplier products, validating, selecting, and handling update/report output.  |
| Detail line output         | Calculate and print price, margin, changes, and other info for each product.             |
| Update processing          | For journal update requests, update master and price records, handle EANs, log changes. |
| EAN check                  | Ensure EAN numbers are unique across product/units.                                     |
| Overflow handling          | Re-print headers as needed during page breaks.                                          |

---

## Onboarding Notes

- **Understand the File Structures:**  
  Familiarity with the physical/logical files and their relationships is vital.

- **Know the Business Context:**  
  The program is specific to Norwegian retail/wholesale business, using industry terms (NOBB, etc.). Domain knowledge helps, especially with groups, types, EANs, etc.

- **Be Careful with Updates:**  
  The program can perform mass updates to products and prices. Use test data and ensure full backups before running on production data.

- **Debugging and Logging:**  
  The `option(*nodebugio)` disables some debugging info. Use additional logging if troubleshooting.

- **Version Control:**  
  Multiple sections are marked for version changes (e.g., 6.30, 6.11) with comments reflecting why/when fields were added or changed.

- **Layered Design:**  
  The main program coordinates, but some logic is in external callable programs. Review those for full understanding.

---

## Conclusion

This program is a critical part of the product/pricing data flow, keeping master data synchronized with supplier input and maintaining audit trails via reporting. It uses classic RPG constructs and techniques, is modular, and has been maintained/improved over years for new business needs and file structure changes.

**New developers should focus on:**

- Understanding the main files/tables and their keys.
- The meaning and use of each field in the input parameter structure.
- The rules around when and how prices and product fields are updated.
- The significance of each subroutine for report formatting, data selection, and data integrity.
- The sequence of steps in validation, calculation, updating, and reporting.

---

Feel free to ask for deeper explanations of any part or for a diagram of the data flows!