# RPG Program VP510R Documentation

## Overview

**Program:** VP510R  
**System:** ASOFAK  
**Description:**  
Displays item prices for a given item (Vare-pris, vise for vare). This program is a display-based (workstation) application using subfiles to present and allow navigation of item price data. It is designed for inquiry and drill-down on item prices, with support for multiple price groups, units, delivery types, and suppliers.

**Main Purpose:**  
- Display all prices for a selected item, with supporting details such as unit, delivery type, price group, and supplier.
- Allow navigation and selection within the list (subfile), with drilldown to detailed views.

---

## File Structure and Relationships

The program interacts with multiple physical files (tables) and display files:

### Physical Files

| File    | Rename   | Purpose / Content                                          |
|---------|----------|-----------------------------------------------------------|
| vvprlr  | vvprlrr  | Item price header records                                 |
| vvprl1  | vvprl1r  | Item price detail records (main price list)               |
| vvarl1  | vvarl1r  | Item master                                               |
| vvenl1  | vvenl1r  | Supplier master                                           |
| vltpl1  | vltpl1r  | Delivery type master                                      |
| venhl1  | venhl1r  | Unit master                                               |
| vugrl1  | vugrl1r  | Item group hierarchy                                      |
| ra30l1  | ra30l1r  | Price group master (from version 5.70)                    |
| rlevl1  | rlevl1r  | Supplier detail (from version 6.20)                       |

### Display File

- **vp510d**: Contains subfile (`b1sfl`), control (`b2ctl`), command (`b2cmd`), and detail (`c2bld`) records.

---

## Key Business Concepts

- **Item (Vare):** The product whose prices are being displayed.
- **Price Group (Prisgruppe):** Allows grouping of prices for different contexts (e.g., customer segments).
- **Unit (Enhet):** The sales or inventory unit for pricing.
- **Delivery Type (Leveringstype):** The type of delivery associated with the price.
- **Supplier (Leverand√∏r):** Optionally, prices can be supplier-specific.
- **Subfile:** Used for paginated display and navigation of price records.

---

## Program Flow

### Initialization (`*inzsr`)

- Receives parameters: company (firm), item (vare), and optionally supplier (ldor).
- Initializes all key lists for file access.
- Loads item and supplier descriptions for display.
- Loads item group hierarchy for later use in calculations.
- Positions the price detail file and fills the subfile with the first page of data.

### Main Loop

- Presents the main subfile screen (`b2ctl`/`b1sfl`).
- Handles function keys for:
    - Exit (F3/F12)
    - Refresh (F5)
    - Page forward (F10)
    - Page backward (F11)
    - Cursor reposition (Home)
- Allows drilldown to detail view for a selected price record.

### Subfile Handling

- **Create (`crt_subfile`):** Reads price records and fills the subfile, calculating coverage (dekningsgrad) for each.
- **Refresh (`forny`):** Repositions and reloads the subfile.
- **Clear (`clr_subfile`):** Clears subfile records and resets state.
- **Page Backward (`bck_subfile`):** (Stub, not implemented in this version.)
- **Display (`dsp_subfile`):** Handles display logic, including indicator management and cursor positioning.

### Detail View (`xc2bld`)

- Loads the selected price record and related descriptions.
- Presents a detail screen with all relevant fields for the price entry.
- Allows exit back to the subfile view.

---

## Key Data and Control Structures

### Indicators

- **LR:** End of program.
- **10:** Page forward (Roll).
- **12:** Display subfile.
- **13:** Display subfile control.
- **14:** Clear subfile.
- **15:** End of subfile (no more records).
- **21:** Home key.
- **22:** Cursor positioning.
- **30:** Field protection during display.
- **31-79:** Error and screen indicators.
- **80-99:** Work indicators.

### Subfile Variables

- `w_fcrn`: First record number on the current page.
- `w_stel`: Subfile counter.
- `w_spge`: Subfile page size.
- `w_srrn`: Relative record number in subfile.
- `w_sfrn`: First record number on last page.
- `w_ssrn`: Last record number on last page.

---

## Notable Business Logic and Calculations

### Coverage Calculation (`kalk_dekn`)

- If cost price (`b1kopr`) is set, calculates coverage as `100 - (cost price * 100 / sales price)`.
    - Caps result between -999.99 and 999.99.
- If cost price is zero, falls back to coverage from item or group master (`vvdekn`, `vgudek`).

### Description Fetching (`hent_info`)

- Fetches and displays:
    - Item description.
    - Delivery type description, if set.
    - Unit description, if set.
    - Price group description, if set.

---

## Version History / Enhancements

- **5.70:** Added support for price group (`prisgruppe`).
- **6.20:** Added support for supplier-specific pricing (`prisgiver`).
- **8.01:** Extended price group field from 1 to 2 characters.

---

## Design Conventions and Patterns

- **KLIST/KFLD:** All file accesses use keyed lists for clarity and maintainability.
- **Subfiles:** All navigation, paging, and selection are managed via subfile structures, following standard IBM i patterns.
- **Indicator-driven UI:** Function key and display logic is managed via *INxx indicators, with clear separation of concerns.
- **Field Naming:** All fields are prefixed by their context (e.g., `b1`, `b2`, `c2`) to denote which screen or structure they belong to.
- **Modular Subroutines:** Business logic is encapsulated in named subroutines for clarity (e.g., `kalk_dekn`, `hent_info`, `clr_subfile`).

---

## Integration Points

- **Item Master (`vvarl1`)**: For item descriptions and group hierarchy.
- **Supplier Master (`vvenl1`, `rlevl1`)**: For supplier-related price filtering and display.
- **Delivery Type (`vltpl1`)**: For display of delivery type descriptions.
- **Unit Master (`venhl1`)**: For unit descriptions.
- **Price Group (`ra30l1`)**: For price group descriptions.
- **Group Hierarchy (`vugrl1`)**: For fallback coverage calculations.

---

## Special Notes

- The subfile paging logic is sized by the constant `c_sfil` (14 records per page).
- The program is display-only; there is no support for add/change/delete of price records.
- Several enhancements over time have expanded the domain model (e.g., multi-character price groups, supplier-specific prices).
- There is a stub for page-backward logic (`bck_subfile`), but it is not implemented in the provided version.
- All file access is controlled by key lists, and all critical data fetches are protected by indicator checks (e.g., *IN90, *IN91).

---

## Summary

This program provides a robust, paginated, and drillable view of item price data, supporting multiple business dimensions (price group, unit, delivery type, supplier). It is a central inquiry tool for price management, leveraging standard IBM i subfile and indicator patterns, and is tightly integrated with the master data tables of the business. All enhancements and changes are documented in the header for traceability.