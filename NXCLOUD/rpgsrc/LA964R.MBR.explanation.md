# RPG Program LA964R â€“ Overview and Explanation

## Header & Comments

The program begins with an RPG IV (ILE RPG) header:

```rpg
h datedit(*dmy) option(*nodebugio)
```
- `datedit(*dmy)`: Dates are edited as Day/Month/Year.
- `option(*nodebugio)`: Disables debug I/O for improved performance.

The comments indicate:
- Program name: `LA964R`
- Description: Inventory Register Update from Inventory Book (`Oppdatering av lager-register utfra lagerbok`)
- System: `ASLAGR`
- Changelog, versioning, references, and special instructions.

---

## File Specifications

```rpg
6.30 fvhisl1    if   e           k disk    rename(vhispfr:vhisl1r)
6.30 f                                     prefix(xx:2)
fvhisl2    if   e           k disk    rename(vhispfr:vhisl2r)
fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
```
- **vhisl1**: Historical Inventory Book, input file, with key (`k`), renamed record format, prefix local fields with `xx`.
- **vhisl2**: Input file for current inventory book, similar structure.
- **vlaglu**: Update file, for inventory register, renamed record format.

---

## Data Structures & Variables

### Parameter Data Structure

```rpg
d                 ds
d d_prec                        64
d  d_val1                        1  0 overlay(d_prec)
d  d_val2                        1  0 overlay(d_prec:2)
d  d_val3                        1  0 overlay(d_prec:3)
d  d_val4                        1  0 overlay(d_prec:4)
d  d_dato                       10d   datfmt(*iso)
d                                     overlay(d_prec:5)
```
- Receives a 64-byte parameter block, subdivided into 4 numeric fields and 1 date field using RPG `overlay`.

### Data Area Variables (User Data Area)

```rpg
d                uds
6.10 d l_user                911    920
d l_firm                944    946  0
```
- `uds`: RPG User Data Structure, for system-related fields.
- `l_user`: User code.
- `l_firm`: Firm/company code.

### Key Variables

- Variables like `vhisl2_dato`, `vhisl2_lage`, etc., are used for file keys, mirroring the structure of file fields.
- Used for reading records and record lookups.

### Working Variables

- Numeric and character fields for temporary storage (`w_firm`, `w_parm`, `w_anta`, `w_dato`, `w_time`, etc.).
- `resdto/resdt1/resdt2`: For date manipulation/comparison.

---

## Main Program Logic

### Initial Setup

- The program reads input parameters and sets up local working variables in the initialization subroutine (`*inzsr`).

### Process Loop

#### 1. Set Inventory Book Position

```rpg
c     vhisl2_key    setll     vhisl2r
```
- Sets the file pointer to the appropriate place in `vhisl2r` using a key list.

#### 2. Main Reading Loop

- Labeled as `les_lagbok`, then goes to `nyles` tag.
- Reads the next record in the inventory book (`vhisl2r`).
- Checks for end-of-file or firm mismatch; if so, ends the program (`goto pgm_end`).

#### 3. Prepare to Update Inventory Register

- Resets totals.
- Prepares key for inventory register file (`vlaglur`).
- Reads the current register using `chain`. Indicator 66 is set if not found.

#### 4. Exclude Certain Transactions

```rpg
if vhsyst = 'L' and vhkode = 'T '
    goto les_lagbok
endif
```
- If the transaction is a stocktake (`telletransaksjon`), skip processing.

#### 5. Update Movement Counter

- Increments movement field (`vlbeve`).

#### 6. Transaction-type Based Processing

Depending on transaction system (`vhsyst`), type (`vhtype`), and code (`vhkode`), the program updates the register fields for:

- **Sales ("SALG")**
    - If the system is "F" and type is "U", increase sales field by quantity; else decrease.
- **Withdrawals ("UTTAK")**
    - System "L" and code "U ".
- **Adjustments ("JUSTERING")**
    - System "L" and code "J ".
- **Receipts/Ingress ("INNGANG")**
    - System "L" (for other receipts).

For each, totals are updated (+ or -), and a working total (`w_anta`) is kept.

#### 7. Special Balance Correction (Yearly Routine)

- If parameter 3 (`d_val3`) is 1, special logic runs for year-beginning saldo correction.
- Includes logic to skip the last record of the previous year if balances are to be updated as per January 1st.

#### 8. Update Inventory Register

- If the record exists (`*in66 = *off`), date, time, and user fields are updated, and the record is written.
- Loop continues reading the next inventory record.

---

## End of Program

- `pgm_end`: Sets last record indicator (`*inlr`) to release resources and returns from the program.

---

## Subroutine: Initialization (`*inzsr`)

- Defines key lists for all used files: `vhisl1_key`, `vhisl2_key`, `vlaglu_key`.
- Retrieves the parameter block from the previous program via `*entry` and assigns it to the working area.
- Sets up working variables for the subsequent processing loop.

---

## Key Takeaways

- **Purpose:** Updates the inventory register (`vlaglur`) based on records from the inventory book (`vhisl2r`), handling various types of transactions (sales, withdrawals, adjustments, receipts) and correcting the starting balance at the year boundary when required.
- **Modular Design:** Uses tags as logical blocks (common in older RPG).
- **Parameterized:** Can be driven with a parameter block allowing flexible invocation.
- **Revision History:** Contains extensive versioning and inline documentation, indicating careful maintenance.
- **Special Handling for Year-End:** Includes logic to correctly manage year transitions and avoid double-counting.

---

## For New Developers

- **Files:** Understand the structure of inventory book (`vhisl1`, `vhisl2`) and register files (`vlaglur`).
- **Transaction Codes:** Familiarize yourself with the meaning of `vhsyst`, `vhtype`, and `vhkode`.
- **Parameters:** The program expects a 64-byte block with control information at entry.
- **Testing:** Special attention should be given to year-end processing and how balances are updated.
- **Debugging:** As `*nodebugio` is active, add temporary logging or debug output for troubleshooting.

---

This explanation should provide clarity on the overall function and important details of the program for onboarding and maintenance.