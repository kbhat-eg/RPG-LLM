# RPG Program JV842R â€“ Documentation

## Overview

**Program:** JV842R  
**System:** ASVADM  
**Description:**  
This program processes updates for product group hierarchies (Overgruppe, Hovedgruppe, Undergruppe) based on XML data from Norgros/NIB. It parses an XML-formatted file, extracts group information, and updates corresponding database files with new or changed descriptions and PSE codes.

**Business Domain:**  
The program is used in the Norwegian building materials sector, updating product group hierarchies (used for categorizing products) based on incoming data from NIB (Norsk Byggevarebase).

---

## Main Purpose

- **Read**: Sequentially reads an XML-formatted file containing product group hierarchy information.
- **Parse**: Extracts relevant data for overgroup (overgruppe), main group (hovedgruppe), and subgroup (undergruppe) elements.
- **Update**: Updates corresponding records in the database if changes are detected, specifically updating description fields and PSE codes.

---

## File Definitions and Data Relationships

- **nxvgpf**: Input XML file (sequential, single record format).
- **vogrlu**: Overgroup master file (keyed access).
- **vhgrlu**: Main group master file (keyed access).
- **vugrlu**: Subgroup master file (keyed access).
- **jstsl1**: Status code lookup file (keyed access).

Each group level (overgruppe, hovedgruppe, undergruppe) has a corresponding data structure for parsing and processing.

---

## Program Structure

### Initialization (`*inzsr`)

- Receives a firm/company code as a parameter (`p_firm`).
- Sets up key lists for database access.
- Retrieves additional status information for the company, if needed.

---

### Main Loop

1. **Read XML file** (`nxvgpfr`).
2. **While not EOF**:
   - If processing a valid sender/kilde, and the start of an `<Overgruppe>` is found, triggers the `beh_ogrp` subroutine.
   - Extracts elements by scanning for XML tags and processes them via subroutines.
   - Deletes records from the work file after processing.

---

### XML Parsing Approach

- The program does not use an XML parser, but instead processes the XML as flat text lines.
- It uses `%scan` and `%subst` to locate and extract values between XML tags.
- Tag constants (e.g., `<Overgruppe>`, `<Hovedgruppe>`, `<Undergruppe>`, etc.) are defined for matching.

---

### Subroutine Hierarchy

#### 1. **Sender/Kilde Handling**

- `uttr_kild`: Checks if the `<Kilde>` element matches the expected value (`c_NIBk`), enabling processing for this batch.

#### 2. **Group Processing**

Each group level has:
- An initialization subroutine (e.g., `ogrp_init`, `hgrp_init`, `ugrp_init`).
- A main handler (e.g., `beh_ogrp`, `beh_hgrp`, `beh_ugrp`) which loops through XML elements, triggering field-specific subroutines.
- Field-specific subroutines for each XML element (e.g., `uttr_ogrp`, `uttr_osta`, etc.).
- An update subroutine (e.g., `skr_ogrp`, `skr_hgrp`, `skr_ugrp`).

#### 3. **Text Field Decoding**

- `konv_XML_esc`: Decodes XML escape sequences (e.g., `&amp;`, `&lt;`, `&gt;`, `&apos;`, `&quot;`) in text fields before writing to the database.

---

## Business/Domain-Specific Logic

- **Group Hierarchy**: The product grouping is three-level: Overgruppe (top), Hovedgruppe (middle), Undergruppe (bottom).
- **Description Update**: Only updates descriptions or PSE codes if they have changed.
- **Status Handling**: Status fields are parsed, but logic for status code '4' (deletion) is commented out.
- **User/Date/Time Stamping**: On update, sets user (from LDA), and stamps current date/time.

---

## Design Decisions and Conventions

- **Flat File XML Parsing**: The program assumes each XML element is on a separate line and parses via string operations. This is a legacy approach, but works for the controlled input format.
- **Defensive Programming**: Checks for valid numeric fields before assigning, sets error flags (`b_gfel`) to skip invalid records.
- **Overlay Data Structures**: Uses overlays to map fields within 100-byte record blocks for each group level.
- **Keyed File Updates**: Uses keyed access to update only matching records for the current firm and group codes.
- **Blank/Zero Initialization**: Each group structure is reinitialized before processing a new group.

---

## Interactions with Other Modules

- **Database Files**: Updates master files for product groupings.
- **LDA (Local Data Area)**: Reads user ID for audit stamping.
- **Status Lookup**: Uses `jstsl1` to potentially retrieve status codes for the firm.

---

## Error Handling

- **Invalid Data**: If a group number or status is not numeric, sets `b_gfel` to skip processing for that group.
- **Commented Deletion Logic**: There is placeholder logic (commented out) for deleting records with status '4', which may be activated in the future.

---

## Key Patterns and Notable Points

- **Subroutine-Driven**: Each XML element has a dedicated subroutine for parsing and assignment.
- **Update Only on Change**: Database is updated only if relevant fields have changed, minimizing unnecessary writes.
- **Text Field Escaping**: Explicit handling of XML escape sequences ensures clean text storage.
- **Firm-Specific Processing**: All updates are scoped to the current firm, as passed in the program parameter.

---

## Summary Table: Group Levels and Main Fields

| Level        | Key Fields               | Description Field | PSE Fields      | Status Field |
|--------------|-------------------------|------------------|-----------------|--------------|
| Overgruppe   | Ogrp                    | Beskrivelse      |                 | Status       |
| Hovedgruppe  | Hgrp, Hogr              | Beskrivelse      |                 | Status       |
| Undergruppe  | Ugrp, Uogr, Uhgr        | Beskrivelse      | PSE_prim, PSE_sek | Status    |

---

## Maintenance Notes

- **Adding New Fields**: To support new XML elements, define constants, extend the data structure, add a parsing subroutine, and update the main handler.
- **Activating Deletion**: To enable deletion on status '4', uncomment the relevant code blocks in the `skr_ogrp`, `skr_hgrp`, and `skr_ugrp` subroutines.

---

## Conclusion

This program is a robust, subroutine-driven batch processor for updating product group hierarchies from NIB XML feeds. Its design is tailored to the specific, predictable XML format and the requirements of the Norwegian building materials sector. All changes are auditable and scoped per firm. The code is modular and can be extended for new fields or business rules as needed.