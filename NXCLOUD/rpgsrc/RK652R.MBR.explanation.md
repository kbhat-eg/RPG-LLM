# Documentation: Program RK652R – Print Payment Reminder Control List

## Overview

**Program:** RK652R  
**System:** ASOKON  
**Purpose:**  
Generates a control list for payment reminders, printing customer-level and item-level details for overdue balances. The report includes checks for the presence of notes attached to each transaction and marks them accordingly.

## Business Context

- **Payment Reminders:** The program is part of the payment collection process, helping staff to monitor which customers and invoices require follow-up.
- **Note Detection:** Special logic is included to detect and flag transactions with attached notes (notatblokk), which may indicate disputes, special handling, or other business exceptions.
- **Customer Grouping:** Output is grouped by customer, with subtotals per customer and overall totals.

## File Relationships

- **RKWBL2 (renamed rkwbl2r):** The main file containing payment reminder transactions.
- **RKUNL1 (renamed rkunl1r):** Customer master file, used to retrieve customer details.
- **RKLAL3 (renamed rklal3r):** Note block file, checked to determine if a transaction has an associated note.
- **RK652P:** Printer file for report output.

## Key Data Structures

- **Work Fields:**  
  - `w_bdat`, `w_fdat`: Working date fields (document and due dates).
  - `w_forp`, `w_fort`: Accumulators for per-customer and overall totals.
  - `w_kund_gml`: Tracks the previous customer number for group break logic.
- **Parameter Buffer:**  
  - A large parameter buffer (positions 300–490) is mapped for potential future enhancements or external control.
- **Key Lists:**  
  - Key lists are defined for efficient indexed access to files.

## Main Processing Flow

1. **Initialization (`*inzsr`):**
   - Sets up key lists for all files.
   - Initializes working variables and writes the report header.

2. **Main Loop:**
   - Reads through all records in `rkwbl2r` (payment reminders), ordered by the defined key.
   - On customer number change:
     - Writes a subtotal for the previous customer.
     - Retrieves and prints customer details from `rkunl1r`.
   - Skips records with zero or negative balances, or flagged as not to be reminded.
   - Skips records that are complaints (reklamasjon), have special codes, or have zero outstanding amount.
   - Processes document and due dates, setting a flag if the due date is missing or default.
   - Calls subroutine `notat` to check for attached notes (see below).
   - Accumulates per-customer and overall totals.
   - Writes detail lines for each valid transaction.

3. **Finalization:**
   - Writes any remaining customer subtotal and the grand total at the end of processing.

## Subroutines

### 1. `notat`
- **Purpose:** Checks if the current transaction has an associated note in the `rklal3r` file.
- **Logic:**
  - Builds a key from the current transaction’s attributes.
  - Sets indicator `*in73` if a note is found.
  - Used to flag transactions in the report for special attention.

### 2. `*inzsr`
- **Purpose:** Initializes key lists and working variables at program start.
- **Logic:**
  - Maps key fields for indexed file access.
  - Initializes counters and accumulators.
  - Writes the initial report header.

## Special Features and Conventions

- **Indicators:**  
  - `*in30`, `*in35`, `*in61`, `*in73`, etc. are used for flow control, page break handling, and marking special conditions (e.g., notes present).
- **Page Handling:**  
  - When the output file signals overflow (`*in30`), a new header is written.
- **Field Mapping:**  
  - The program uses explicit buffer mapping for parameter and output fields, supporting legacy integration and possible future expansion.
- **Extensibility:**  
  - The key setup and buffer mapping allow for relatively easy adaptation to new requirements or file layouts.

## Design Decisions and Patterns

- **Group Break Logic:**  
  - The customer number is tracked (`w_kund_gml`) to detect group breaks for subtotaling and header printing.
- **Note Block Integration:**  
  - The `notat` subroutine encapsulates the logic for note detection, isolating this business rule for clarity and maintainability.
- **Legacy Compatibility:**  
  - The program follows traditional RPG patterns (cycle control, indicators, explicit buffer mapping), ensuring compatibility with existing systems and processes.

## Interactions and Dependencies

- **Data Source Dependencies:**  
  - Relies on up-to-date and properly indexed customer, transaction, and note files.
- **Output:**  
  - Generates a printed control list, typically used by finance or collections staff.

## Change History & Domain Notes

- **T5.40 (160806):** Added logic to flag when a note is present on a transaction.
- **6.20 (190215):** Project attribute is now alpha (character) in the note block check.

## Summary Table

| Section         | Purpose                                                                 |
|-----------------|-------------------------------------------------------------------------|
| Initialization  | Setup keys, accumulators, and print header.                             |
| Main Loop       | Process each payment reminder, group by customer, check for notes, etc. |
| Subroutines     | `notat` (note check), `*inzsr` (initialization).                       |
| Files Accessed  | Payment reminders, customer master, note blocks.                        |
| Output          | Printed control list (RK652P).                                          |
| Special Logic   | Note detection, group breaks, subtotaling.                              |

---

**For onboarding developers:**  
This program is a classic report generator for payment reminders, with business-specific logic for note detection and customer grouping. The codebase relies on explicit buffer and indicator management, typical of older RPG systems. The modular approach to note checking and key management makes it straightforward to maintain or extend for additional business rules or file layouts.