# RR105R – Resultatrapport, Vedlikehold Rapportlinje

## Overview

**RR105R** is a maintenance program for managing report lines within the ASOKON system. Its primary function is to display, add, update, copy, and delete lines (records) in a report, using subfiles for interactive user navigation and manipulation. The program is designed for use with a green-screen (workstn) interface, with multiple display formats and subfiles for user interaction.

This program is heavily tied to the business domain of financial or result reporting, where users maintain the structure and content of report lines, including descriptions, codes, and associated metadata.

---

## File and Data Relationships

### Physical Files

- **rrf5l1, rrf5l2, rrf5lu, rrf5lr**: Variants of the main report line file (`rrf5pfr`), each with a different record format, supporting various access paths and operations (listing, lookup, update, read).
- **rrf8l1, rrf8lu**: Used for "fra-til begrep" (from-to concepts/terms), likely supporting relationships or mappings between report lines.

All files are accessed by keys, with explicit key lists defined for various operations.

### Display Files

- **rr105d**: The display file, using multiple record formats and subfiles (notably `b1sfl` for the main subfile).
- **Subfile and Control Records**:
  - **B1SFL**: Main subfile for listing/editing lines.
  - **B2CTL, B2CMD**: Subfile control and command screens.
  - **C1BLD, C1MSG, C2BLD**: Screens for creating, messaging, and editing/viewing a line.
  - **D1WIN, K1WIN**: Windows for delete and copy operations.

---

## Indicator and Variable Conventions

- **Indicators**:
  - *LR*: End program
  - *10–15, 21–22, 30, 31–79*: Used for function keys, field protection, error/warning flags, and work indicators
- **Subfile Navigation Variables**:
  - `w_stel`: Subfile record count
  - `w_spge`: Subfile page size
  - `w_srrn`, `w_sfrn`, `w_ssrn`: Record numbers for subfile navigation
  - `w_curn`, `w_virn`: Current/virtual record numbers for cursor positioning

---

## Main Program Flow

### Entry and Initialization

- Parameters (`p_0rap`, `p_0txt`) are received at program start, representing the report and its description.
- LDA (Local Data Area) is read for user and firm information.
- Key lists are initialized for all file operations.
- The subfile is positioned and filled based on the initial report (`p_0rap`).

---

### Main Loop

The program enters a main loop that alternates between:
- **Command Screen (`b2cmd`)**
- **Subfile Display/Processing (`b1sfl` via `dsp_subfile` and `subfile` subroutines)**

#### Function Key Handling

- **Exit**: *F3/F12* (`*inkc`/`*inkl`) – Ends the program
- **Refresh**: *F5* (`*inke`) – Calls `forny` to re-read and refresh the subfile
- **Create New**: *F6* (`*inkf`) – Calls `xc1bld` to add a new line
- **Roll Up/Down**: *F10/F11* (`*in10`/`*in11`) – Page up/down in the subfile
- **Home/Positioning**: *F21* (`*in21`) – Sets up for cursor positioning
- **Position by Line/Description**: If line or description fields are entered, calls `posisjoner` for targeted navigation

---

### Subfile Processing

Within the subfile (`subfile` subroutine), for each visible row, user actions are interpreted via the `b1valg` field:

- **2: Edit** – Calls `xc2bld` for editing, updates the subfile
- **3: Copy** – Calls `xk1win` for copy, updates the subfile
- **4: Delete** – Calls `xd1win` for delete, updates the subfile
- **5: View** – Calls `xc2bld` for view-only, updates the subfile
- **7: Maintain Account/Line** – Calls external program `RR108R` with context, updates the subfile

After each operation, the subfile row is reset and updated.

---

### Subroutines

#### Subfile Management

- **clr_subfile**: Clears the subfile and resets navigation variables.
- **crt_subfile**: Fills the subfile with the next page of data, based on current position and sequence mode.
- **bck_subfile**: Reads the previous page in the subfile, for backward navigation.
- **dsp_subfile**: Handles display logic, setting necessary indicators for the subfile control record.

#### Positioning and Refresh

- **forny**: Refreshes the subfile based on the current position and sequence (by line or description).
- **posisjoner**: Positions the subfile to a specific line or description.

#### Record Maintenance

- **xc1bld**: Handles creation of a new line, with validation and duplicate checking (calls `xc1msg` for duplicate warning).
- **xc1msg**: Displays a message if attempting to create a line that already exists.
- **xc2bld**: Handles editing/viewing of a line, including input validation and file updates/inserts.
- **xd1win**: Handles deletion, including cascading deletes of related "fra-til begrep" records.
- **xk1win**: Handles copy operation, including copying related "fra-til begrep" records and invoking edit logic on the new line.

---

## Business Logic and Domain-Specific Notes

- **Report Line Uniqueness**: The program enforces unique line numbers within a report, and provides user feedback if a duplicate is attempted.
- **From-To Concepts (`fra-til begrep`)**: When deleting or copying a line, associated from-to mappings are also deleted/copied, ensuring referential integrity.
- **User/Time Stamping**: Updates to lines include user and timestamp fields, supporting auditability.
- **Subfile Paging**: Subfile navigation is custom-implemented, with explicit page size and record number tracking.
- **External Program Call**: For "maintain account/line" (`b1valg = 7`), the program delegates to `RR108R`, passing all relevant context.

---

## Patterns, Design Decisions, and Conventions

- **Explicit Key Lists**: All file accesses use named key lists, aiding readability and maintainability.
- **Indicator Usage**: Follows a strict convention for field protection, error signaling, and subfile control, making UI logic consistent.
- **Subfile as Central UI Element**: All user interaction revolves around the subfile, with the program acting as a controller for CRUD operations on report lines.
- **Separation of Concerns**: Subroutines encapsulate discrete operations (CRUD, navigation, validation), minimizing code duplication.
- **Error and Message Handling**: Uses dedicated screens for user messaging, such as duplicate warnings.

---

## Interactions with Other Modules

- **RR108R**: Invoked for advanced maintenance of account/line combinations, indicating modular design for complex operations.
- **Physical Files (`rrf5pfr`, `rrf8pfr`)**: The program is tightly coupled to these files, which must follow expected key and record format conventions.

---

## Summary

**RR105R** is a robust, interactive maintenance program for managing report lines in a financial reporting system. It provides rich subfile-based navigation, supports all expected CRUD operations with business rule enforcement, and ensures data integrity through careful handling of related records. The codebase follows established IBM i (AS/400) RPG conventions, with clear separation of UI, file, and business logic, and leverages modular subroutines for maintainability.

Any developer maintaining or extending this program should be aware of the critical role of indicators, key lists, and subfile navigation variables, as well as the business requirement for referential integrity between report lines and their associated "from-to" concepts.