     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : VP755R
      * Beskrivelse . . : Vare-pris, henter priser på tre innkjøpsenheter
      *
      *                   Input:  Firma, vare, lev.type og dato
      *                   Output: Enhet, kostpris og innkjøpspris på tre
      *                           innkjøpsenheter
      *                           Omregningsfaktor volum for enhet-2 og
      *                           enhet-3 i forhold til enhet-1
      *
      *                           Dersom innkjøpspris ikke ble funnet,
      *                           settes denne lik kostpris
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       190699 HKO  Nytt program
      *       020805 HKO  Endret les mot vare-enhet for å finne innkjøps-
      *                   enheter og salgsenheter
5.70  * PRGR  241008 BOF  Utvidet med prisgruppe
6.20  *       220311 BOF  Utvidet med prisgiver på vare-pris
6.21  *       110112 Bsa  Må ta hensyn til kampane ved innhenting av
6.21  *                   innkjøp/kost priser.
6.22  *       210212 Bsa  Må avslutte når han ar funnet priser og omrfaktor
6.23  *       060312 Bsa  Hvis tilslag på kampanje, skal vi se bort fra dato
6.23  *                   for gyldighet, da innkjøp skjer utenfor perioden.
6.23  *                   Ref. Skattumtest
6.30  *       110615 bkv  Sjekk om det finnes gyldig tilbudspris innenfor dato
6.31  *       110316 bof  Bruke vare-enh-prisg. i valg av enhet.
6.32  *       100516 bof  Utvidet med parameter for l.dor og lager
6.33  *       110516 bof  Må sette tag at pris er funnet
6.34  *       061118 bof  Feilretting i sql vedr. firma
      *
8.01  *K000   240323 bsa  Endret logikk for å finne innkjøpsenheter.
8.02  *PRG2   150622 bsa  Utvidet prisgruppe fra 1 til 2 posisjoner
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
     fvvenl4    if   e           k disk    rename(vvenpfr:vvenl4r)
     fvvenl2    if   e           k disk    rename(vvenpfr:vvenl2r)
6.20 fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
6.21 fvtill9    if   e           k disk    rename(vtilpfr:vtill9r)
6.31 fvveppf    if   e           k disk    rename(vveppfr:vveppfr)
      *
      * Definering av pamametre
      *
     d p_firm          s                   like(vpfirm)
     d p_vare          s                   like(vpvare)
5.70 d p_prgr          s                   like(vpprgr)
     d p_lety          s                   like(vplety)
     d p_dato          s                   like(vppdat)
     d p_enh1          s                   like(vpenhe)
     d p_kop1          s                   like(vpkopr)
     d p_inp1          s                   like(vpinpr)
     d p_enh2          s                   like(vpenhe)
     d p_kop2          s                   like(vpkopr)
     d p_inp2          s                   like(vpinpr)
     d p_omr2          s                   like(veomre)
     d p_enh3          s                   like(vpenhe)
     d p_kop3          s                   like(vpkopr)
     d p_inp3          s                   like(vpinpr)
     d p_omr3          s                   like(veomre)
6.32 d p_ldor          s                   like(vvldor)
6.32 d p_lage          s              2  0
      *
      * Definering av variable i nøkler
      *
6.20 d vvarl1_vare     s                   like(vvvare)
     d vvprl1_vare     s                   like(vpvare)
6.20 d vvprl1_ldor     s                   like(vpldor)
5.70 d vvprl1_prgr     s                   like(vpprgr)
     d vvprl1_enhe     s                   like(vpenhe)
     d vvprl1_lety     s                   like(vplety)
     d vvenl4_vare     s                   like(vevare)
     d vvenl4_inen     s                   like(veinen)
     d vvenl2_vare     s                   like(vevare)
     d vvenl2_saen     s                   like(vesaen)
6.21 d vtill9_vare     s                   like(vvvare)
6.21 d vtill9_prgr     s                   like(vpprgr)
6.21 d vtill9_lety     s                   like(vplety)
      *
      * Definering av variable
      *
     d x               s              1  0
     d b_pris          s              1    inz(*off)
6.20 d b_inlr          s              1    inz(*off)
8.01 d b_dist          s              1    inz(*off)
      *
     d w_firm          s                   like(vpfirm)
     d w_dato          s                   like(vppdat)
     d w_omr1          s                   like(veomre)
     d w_omr2          s                   like(veomre)
     d w_omr3          s                   like(veomre)
6.20 d w_ldor          s                   like(vvldor)
6.20 d w_lage          s              2  0
8.01 d w_ekst          s             20
8.01 d w_levr          s              6  0
8.01 d w_ldis          s              6  0
      *
6.21 d p_kamp          s              5
      *
6.20 d                uds
8.01 d l_filg                937    939
6.20 d l_lage               1001   1002  0
8.01  *
8.01  * Definering av eksterne prg
8.01  *
8.01   dcl-s co402_verdi1  char(1);
8.01   dcl-s co402_verdi2  char(2048);
8.01   DCL-PR CO402R EXTPGM('CO402R');
8.01     p_filgrp            char(3)     const;
8.01     p_firm              packed(3:0) const;
8.01     p_lager             packed(2:0) const;
8.01     p_nokkel            char(50)    const;
8.01     p_verdi1            char(1);
8.01     p_verdi2            char(2048);
8.01   END-PR;
      *
8.01 d u_pakl          s              1    inz(*on)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31 C/Exec SQL
6.31 C+  Set Option DatFmt=*ISO
6.31 C/End-Exec
8.01  *
8.01  * Sjekk om vedlagt leverandør er intern/RDS
8.01  *
8.01 c                   if        p_ldor <> 0
8.01
8.01     exec SQL
8.01       select rkrela into :w_ekst
8.01         from ra36st
8.01         where rkrfir = :p_firm
8.01          and rkrsla = :p_lage;
8.01
8.01       if sqlcod < 0 or
8.01       sqlcod = 100;
8.01          w_ekst = ' ';
8.01        endif;
8.01
8.01     if w_ekst <> ' ';
8.01      exec SQL
8.01        select rkelev
8.01          into :w_ldis
8.01         from ra37st
8.01          where rkefir = :p_firm
8.01            and rkeela = :w_ekst;
8.01
8.01         if sqlcod < 0 or
8.01        sqlcod = 100;
8.01          w_ldis = 0;
8.01        endif;
8.01     endif;
8.01
8.01  *
8.01 c                   if        w_ldis <> 0 and
8.01 c                             w_ldis = p_ldor
8.01 c                   eval      b_dist = *on
8.01 c                   endif
8.01  *
8.01 c                   endif
8.01  *
6.32 c                   if        p_lage <> 0
6.32 c                   eval      w_lage = p_lage
6.32 c                   else
6.20 c                   eval      w_lage = l_lage
6.32 c                   endif
6.20  *
6.20  * Henter leverandør for vare og lager
6.20  *
6.20 c                   call      'VL721R  '
6.20 c                   parm                    w_firm
6.20 c                   parm                    p_vare
6.20 c                   parm                    w_lage
8.01 c                   parm                    w_levr
6.20 c                   parm                    b_inlr
      *
6.32  * Hent også info fra vareregister
      *
6.20 c                   eval      vvarl1_vare = p_vare
6.20 c     vvarl1_key    chain     vvarl1                             90
      *
6.32 c                   eval      w_ldor = p_ldor
      *
6.31 c                   exsr      sjekk_vvep
8.01  *
8.01  * Hvis det ikke er funnet noe på vvep, så sjekk med prioritert leverandør
8.01  *
8.01 c                   if        x = 0
8.01 c                   eval      w_ldor = w_levr
8.01 c                   exsr      sjekk_vvep
8.01 c                   endif
8.01  *
8.01  * Hvis det ikke er funnet noe på vvep, så sjekk med hovedleverandør
8.01  * hvis det er forksjell mellom det og prioritert leverandør.
8.01  *
8.01 c                   if        x = 0 and
8.01 c                             w_levr <> vvldor
8.01 c                   eval      w_ldor = vvldor
8.01 c                   exsr      sjekk_vvep
8.01 c                   endif
8.01  *
6.31  * hvis det ikke er funnet noe på vvep, så gjør som før
6.31  *
6.31 c                   if        x = 0
      *
      * Leser innkjøpsenheter på vare, og henter prisinformasjon
      *
     c                   eval      x = 0
      *
     c                   eval      vvenl4_vare = p_vare
     c                   eval      vvenl4_inen = 1
     c     vvenl4_key    setll     vvenl4
     c     vvenl4_key2   reade     vvenl4                                 90
     c                   dow       *in90 = *off and
     c                             x < 3
      *
6.20  * 1. leverandør for lageret
6.20 c                   eval      vvprl1_ldor = w_ldor
     c                   exsr      hent_pris
6.20 c                   if        b_pris = *off  and
6.20 c                             w_ldor <> vvldor
6.20  * 2. hovedleverandør
6.20 c                   eval      vvprl1_ldor = vvldor
6.20 c                   exsr      hent_pris
6.20 c                   if        b_pris = *off
6.20  * siste mulighet...
6.20 c                   eval      vvprl1_ldor = 0
6.20 c                   exsr      hent_pris
6.20 c                   endif
6.20 c                   endif
      *
     c     vvenl4_key2   reade     vvenl4                                 90
     c                   enddo
      *
      * Dersom innkjøpsenhet ikke ble funnet, hentes prisinformasjon fra
      * salgsenheter
      *
     c                   if        x = 0
      *
     c                   eval      vvenl2_vare = p_vare
     c                   eval      vvenl2_saen = 1
     c     vvenl2_key    setll     vvenl2
     c     vvenl2_key2   reade     vvenl2                                 90
     c                   dow       *in90 = *off and
     c                             x < 3
      *
     c                   exsr      hent_pris
      *
     c     vvenl2_key2   reade     vvenl2                                 90
     c                   enddo
      *
     c                   endif
6.31 c                   endif
      *
      * Dersom innkjøpspris ikke ble funnet, settes denne lik kostpris
      *
     c                   if        p_inp1 = 0
     c                   eval      p_inp1 = p_kop1
     c                   endif
      *
     c                   if        p_inp2 = 0
     c                   eval      p_inp2 = p_kop2
     c                   endif
      *
     c                   if        p_inp3 = 0
     c                   eval      p_inp3 = p_kop3
     c                   endif
      *
      * Finner omregningsfaktor volum for enhet 2 og 3
      *
     c                   if        w_omr1 = 0
     c                   eval      w_omr1 = 1
     c                   endif
      *
     c                   eval(h)   p_omr2 = w_omr2 / w_omr1
     c                   eval(h)   p_omr3 = w_omr3 / w_omr1
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for henting av prisinformasjon for salgsenhet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_pris     begsr
      *
     c                   eval      b_pris = *off
6.21  * Hvis kampanje sjekker vi om det finnes tilslag på denne
6.21 c                   if        p_kamp <> *blanks
6.21 c                   eval      vtill9_vare = p_vare
6.21 c                   eval      vtill9_prgr = p_prgr
6.21 c                   eval      vtill9_lety = p_lety
6.21 c     vtill9_key    setll     vtill9
6.21 c     vtill9_key    reade     vtill9                                 91
6.21 c                   dow       *in91 = *off
6.21  *
6.21 c                   if        p_kamp = vtkamp
6.21  * Enhet 1
6.21 c                   if        vtenh1 = veenhe and
6.21 c                             vtinp1 <> 0
6.21  * Gyldige dato
6.21 c**6.23             if        w_dato >= vtfdat and
6.21 c**6.23                       w_dato <= vttdat
6.21 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.21 c                   if        x = 1
6.21 c                   eval      p_enh1 = veenhe
6.21 c                   eval      p_kop1 = vtkop1
6.21 c                   eval      p_inp1 = vtinp1
6.22 c                   eval      w_omr1 = veomre
6.21 c                   elseif    x = 2
6.21 c                   eval      p_enh2 = veenhe
6.21 c                   eval      p_kop2 = vtkop1
6.21 c                   eval      p_inp2 = vtinp1
6.22 c                   eval      w_omr2 = veomre
6.21 c                   elseif    x = 3
6.21 c                   eval      p_enh3 = veenhe
6.21 c                   eval      p_kop3 = vtkop1
6.21 c                   eval      p_inp3 = vtinp1
6.22 c                   eval      w_omr3 = veomre
6.21 c                   endif
6.22 c                   leavesr
6.21 c**6.23             endif
6.21 c                   endif
6.21  * Enhet 2
6.21 c                   if        vtenh2 = veenhe and
6.21 c                             vtinp2 <> 0
6.21  * Gyldige dato
6.21 c**6.23             if        w_dato >= vtfdat and
6.21 c**6.23                       w_dato <= vttdat
6.21 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.21 c                   if        x = 1
6.21 c                   eval      p_enh1 = veenhe
6.21 c                   eval      p_kop1 = vtkop2
6.21 c                   eval      p_inp1 = vtinp2
6.22 c                   eval      w_omr1 = veomre
6.21 c                   elseif    x = 2
6.21 c                   eval      p_enh2 = veenhe
6.21 c                   eval      p_kop2 = vtkop2
6.21 c                   eval      p_inp2 = vtinp2
6.22 c                   eval      w_omr2 = veomre
6.21 c                   elseif    x = 3
6.21 c                   eval      p_enh3 = veenhe
6.21 c                   eval      p_kop3 = vtkop2
6.21 c                   eval      p_inp3 = vtinp2
6.22 c                   eval      w_omr3 = veomre
6.21 c                   endif
6.22 c                   leavesr
6.21 c**6.23             endif
6.21 c                   endif
6.21  * Enhet 3
6.21 c                   if        vtenh3 = veenhe and
6.21 c                             vtinp3 <> 0
6.21  * Gyldige dato
6.21 c**6.23             if        w_dato >= vtfdat and
6.21 c**6.23                       w_dato <= vttdat
6.21 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.21 c                   if        x = 1
6.21 c                   eval      p_enh1 = veenhe
6.21 c                   eval      p_kop1 = vtkop3
6.21 c                   eval      p_inp1 = vtinp3
6.22 c                   eval      w_omr1 = veomre
6.21 c                   elseif    x = 2
6.21 c                   eval      p_enh2 = veenhe
6.21 c                   eval      p_kop2 = vtkop3
6.21 c                   eval      p_inp2 = vtinp3
6.22 c                   eval      w_omr2 = veomre
6.21 c                   elseif    x = 3
6.21 c                   eval      p_enh3 = veenhe
6.21 c                   eval      p_kop3 = vtkop3
6.21 c                   eval      p_inp3 = vtinp3
6.22 c                   eval      w_omr3 = veomre
6.21 c                   endif
6.22 c                   leavesr
6.21 c**6.23             endif
6.21 c                   endif
6.21  *
6.21 c                   endif
6.21  *
6.21 c     vtill9_key    reade     vtill9                                 91
6.21 c                   enddo
6.21  *
6.21  * Vi prøver med prisgruppe blank, hvis det ikke ble treff
6.21  *
6.21 c                   eval      vtill9_vare = p_vare
6.21 c                   eval      vtill9_prgr = *blank
6.21 c                   eval      vtill9_lety = p_lety
6.21 c     vtill9_key    setll     vtill9
6.21 c     vtill9_key    reade     vtill9                                 91
6.21 c                   dow       *in91 = *off
6.21  *
6.21 c                   if        p_kamp = vtkamp
6.21  * Enhet 1
6.21 c                   if        vtenh1 = veenhe and
6.21 c                             vtinp1 <> 0
6.21  * Gyldige dato
6.21 c**6.23             if        w_dato >= vtfdat and
6.21 c**6.23                       w_dato <= vttdat
6.21 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.21 c                   if        x = 1
6.21 c                   eval      p_enh1 = veenhe
6.21 c                   eval      p_kop1 = vtkop1
6.21 c                   eval      p_inp1 = vtinp1
6.22 c                   eval      w_omr1 = veomre
6.21 c                   elseif    x = 2
6.21 c                   eval      p_enh2 = veenhe
6.21 c                   eval      p_kop2 = vtkop1
6.21 c                   eval      p_inp2 = vtinp1
6.22 c                   eval      w_omr2 = veomre
6.21 c                   elseif    x = 3
6.21 c                   eval      p_enh3 = veenhe
6.21 c                   eval      p_kop3 = vtkop1
6.21 c                   eval      p_inp3 = vtinp1
6.22 c                   eval      w_omr3 = veomre
6.21 c                   endif
6.22 c                   leavesr
6.21 c**6.23             endif
6.21 c                   endif
6.21  * Enhet 2
6.21 c                   if        vtenh2 = veenhe and
6.21 c                             vtinp2 <> 0
6.21  * Gyldige dato
6.21 c**6.23             if        w_dato >= vtfdat and
6.21 c**6.23                       w_dato <= vttdat
6.21 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.21 c                   if        x = 1
6.21 c                   eval      p_enh1 = veenhe
6.21 c                   eval      p_kop1 = vtkop2
6.21 c                   eval      p_inp1 = vtinp2
6.22 c                   eval      w_omr1 = veomre
6.21 c                   elseif    x = 2
6.21 c                   eval      p_enh2 = veenhe
6.21 c                   eval      p_kop2 = vtkop2
6.21 c                   eval      p_inp2 = vtinp2
6.22 c                   eval      w_omr2 = veomre
6.21 c                   elseif    x = 3
6.21 c                   eval      p_enh3 = veenhe
6.21 c                   eval      p_kop3 = vtkop2
6.21 c                   eval      p_inp3 = vtinp2
6.22 c                   eval      w_omr3 = veomre
6.21 c                   endif
6.22 c                   leavesr
6.21 c**6.23             endif
6.21 c                   endif
6.21  * Enhet 3
6.21 c                   if        vtenh3 = veenhe and
6.21 c                             vtinp3 <> 0
6.21  * Gyldige dato
6.21 c**6.23             if        w_dato >= vtfdat and
6.21 c**6.23                       w_dato <= vttdat
6.21 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.21 c                   if        x = 1
6.21 c                   eval      p_enh1 = veenhe
6.21 c                   eval      p_kop1 = vtkop3
6.21 c                   eval      p_inp1 = vtinp3
6.22 c                   eval      w_omr1 = veomre
6.21 c                   elseif    x = 2
6.21 c                   eval      p_enh2 = veenhe
6.21 c                   eval      p_kop2 = vtkop3
6.21 c                   eval      p_inp2 = vtinp3
6.22 c                   eval      w_omr2 = veomre
6.21 c                   elseif    x = 3
6.21 c                   eval      p_enh3 = veenhe
6.21 c                   eval      p_kop3 = vtkop3
6.21 c                   eval      p_inp3 = vtinp3
6.22 c                   eval      w_omr3 = veomre
6.21 c                   endif
6.22 c                   leavesr
6.21 c**6.23             endif
6.21 c                   endif
6.21  *
6.21 c                   endif
6.21  *
6.21 c     vtill9_key    reade     vtill9                                 91
6.21 c                   enddo
6.21  * p_kamp<>*blank
6.30  * hvis ikke kampanje angitt, sjekk etter gyldig kampanje ut fra dato
6.30 c                   else
6.30 c                   eval      vtill9_vare = p_vare
6.30 c                   eval      vtill9_prgr = p_prgr
6.30 c                   eval      vtill9_lety = p_lety
6.30 c     vtill9_key    setll     vtill9
6.30 c     vtill9_key    reade     vtill9                                 91
6.30 c                   dow       *in91 = *off
6.30  *
6.30  * Enhet 1
6.30 c                   if        vtenh1 = veenhe and
6.30 c                             vtinp1 <> 0
6.30  * Gyldige dato
6.30 c                   if        w_dato >= vtfdat and
6.30 c                             w_dato <= vttdat
6.30 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.30 c                   if        x = 1
6.30 c                   eval      p_enh1 = veenhe
6.30 c                   eval      p_kop1 = vtkop1
6.30 c                   eval      p_inp1 = vtinp1
6.30 c                   eval      w_omr1 = veomre
6.30 c                   elseif    x = 2
6.30 c                   eval      p_enh2 = veenhe
6.30 c                   eval      p_kop2 = vtkop1
6.30 c                   eval      p_inp2 = vtinp1
6.30 c                   eval      w_omr2 = veomre
6.30 c                   elseif    x = 3
6.30 c                   eval      p_enh3 = veenhe
6.30 c                   eval      p_kop3 = vtkop1
6.30 c                   eval      p_inp3 = vtinp1
6.30 c                   eval      w_omr3 = veomre
6.30 c                   endif
6.30 c                   leavesr
6.30 c                   endif
6.30 c                   endif
6.30  * Enhet 2
6.30 c                   if        vtenh2 = veenhe and
6.30 c                             vtinp2 <> 0
6.30  * Gyldige dato
6.30 c                   if        w_dato >= vtfdat and
6.30 c                             w_dato <= vttdat
6.30 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.30 c                   if        x = 1
6.30 c                   eval      p_enh1 = veenhe
6.30 c                   eval      p_kop1 = vtkop2
6.30 c                   eval      p_inp1 = vtinp2
6.30 c                   eval      w_omr1 = veomre
6.30 c                   elseif    x = 2
6.30 c                   eval      p_enh2 = veenhe
6.30 c                   eval      p_kop2 = vtkop2
6.30 c                   eval      p_inp2 = vtinp2
6.30 c                   eval      w_omr2 = veomre
6.30 c                   elseif    x = 3
6.30 c                   eval      p_enh3 = veenhe
6.30 c                   eval      p_kop3 = vtkop2
6.30 c                   eval      p_inp3 = vtinp2
6.30 c                   eval      w_omr3 = veomre
6.30 c                   endif
6.30 c                   leavesr
6.30 c                   endif
6.30 c                   endif
6.30  * Enhet 3
6.30 c                   if        vtenh3 = veenhe and
6.30 c                             vtinp3 <> 0
6.30  * Gyldige dato
6.30 c                   if        w_dato >= vtfdat and
6.30 c                             w_dato <= vttdat
6.30 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.30 c                   if        x = 1
6.30 c                   eval      p_enh1 = veenhe
6.30 c                   eval      p_kop1 = vtkop3
6.30 c                   eval      p_inp1 = vtinp3
6.30 c                   eval      w_omr1 = veomre
6.30 c                   elseif    x = 2
6.30 c                   eval      p_enh2 = veenhe
6.30 c                   eval      p_kop2 = vtkop3
6.30 c                   eval      p_inp2 = vtinp3
6.30 c                   eval      w_omr2 = veomre
6.30 c                   elseif    x = 3
6.30 c                   eval      p_enh3 = veenhe
6.30 c                   eval      p_kop3 = vtkop3
6.30 c                   eval      p_inp3 = vtinp3
6.30 c                   eval      w_omr3 = veomre
6.30 c                   endif
6.30 c                   leavesr
6.30 c                   endif
6.30 c                   endif
6.30  *
6.30  *
6.30 c     vtill9_key    reade     vtill9                                 91
6.30 c                   enddo
6.30  *
6.30  * Vi prøver med prisgruppe blank, hvis det ikke ble treff
6.30  *
6.30 c                   eval      vtill9_vare = p_vare
6.30 c                   eval      vtill9_prgr = *blank
6.30 c                   eval      vtill9_lety = p_lety
6.30 c     vtill9_key    setll     vtill9
6.30 c     vtill9_key    reade     vtill9                                 91
6.30 c                   dow       *in91 = *off
6.30  *
6.30  * Enhet 1
6.30 c                   if        vtenh1 = veenhe and
6.30 c                             vtinp1 <> 0
6.30  * Gyldige dato
6.30 c                   if        w_dato >= vtfdat and
6.30 c                             w_dato <= vttdat
6.30 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.30 c                   if        x = 1
6.30 c                   eval      p_enh1 = veenhe
6.30 c                   eval      p_kop1 = vtkop1
6.30 c                   eval      p_inp1 = vtinp1
6.30 c                   eval      w_omr1 = veomre
6.30 c                   elseif    x = 2
6.30 c                   eval      p_enh2 = veenhe
6.30 c                   eval      p_kop2 = vtkop1
6.30 c                   eval      p_inp2 = vtinp1
6.30 c                   eval      w_omr2 = veomre
6.30 c                   elseif    x = 3
6.30 c                   eval      p_enh3 = veenhe
6.30 c                   eval      p_kop3 = vtkop1
6.30 c                   eval      p_inp3 = vtinp1
6.30 c                   eval      w_omr3 = veomre
6.30 c                   endif
6.30 c                   leavesr
6.30 c                   endif
6.30 c                   endif
6.30  * Enhet 2
6.30 c                   if        vtenh2 = veenhe and
6.30 c                             vtinp2 <> 0
6.30  * Gyldige dato
6.30 c                   if        w_dato >= vtfdat and
6.30 c                             w_dato <= vttdat
6.30 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.30 c                   if        x = 1
6.30 c                   eval      p_enh1 = veenhe
6.30 c                   eval      p_kop1 = vtkop2
6.30 c                   eval      p_inp1 = vtinp2
6.30 c                   eval      w_omr1 = veomre
6.30 c                   elseif    x = 2
6.30 c                   eval      p_enh2 = veenhe
6.30 c                   eval      p_kop2 = vtkop2
6.30 c                   eval      p_inp2 = vtinp2
6.30 c                   eval      w_omr2 = veomre
6.30 c                   elseif    x = 3
6.30 c                   eval      p_enh3 = veenhe
6.30 c                   eval      p_kop3 = vtkop2
6.30 c                   eval      p_inp3 = vtinp2
6.30 c                   eval      w_omr3 = veomre
6.30 c                   endif
6.30 c                   leavesr
6.30 c                   endif
6.30 c                   endif
6.30  * Enhet 3
6.30 c                   if        vtenh3 = veenhe and
6.30 c                             vtinp3 <> 0
6.30  * Gyldige dato
6.30 c                   if        w_dato >= vtfdat and
6.30 c                             w_dato <= vttdat
6.30 c                   eval      x = x + 1
6.33 c                   eval      b_pris = *on
6.30 c                   if        x = 1
6.30 c                   eval      p_enh1 = veenhe
6.30 c                   eval      p_kop1 = vtkop3
6.30 c                   eval      p_inp1 = vtinp3
6.30 c                   eval      w_omr1 = veomre
6.30 c                   elseif    x = 2
6.30 c                   eval      p_enh2 = veenhe
6.30 c                   eval      p_kop2 = vtkop3
6.30 c                   eval      p_inp2 = vtinp3
6.30 c                   eval      w_omr2 = veomre
6.30 c                   elseif    x = 3
6.30 c                   eval      p_enh3 = veenhe
6.30 c                   eval      p_kop3 = vtkop3
6.30 c                   eval      p_inp3 = vtinp3
6.30 c                   eval      w_omr3 = veomre
6.30 c                   endif
6.30 c                   leavesr
6.30 c                   endif
6.30 c                   endif
6.30  *
6.30 c     vtill9_key    reade     vtill9                                 91
6.30 c                   enddo
6.30  * elseif p_kamp<>*blank
6.30 c                   endif
6.21  *
     c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = p_prgr
     c                   eval      vvprl1_enhe = veenhe
     c                   eval      vvprl1_lety = p_lety
     c     vvprl1_key    setll     vvprl1
     c     vvprl1_key    reade     vvprl1                                 91
      *
     c                   if        *in91 = *off
     c                   eval      x = x + 1
     c                   eval      b_pris = *on
     c                   endif
      *
     c                   dow       *in91 = *off
      *
     c                   select
     c                   when      x = 1
     c                   eval      p_enh1 = vpenhe
     c                   eval      p_kop1 = vpkopr
     c                   eval      p_inp1 = vpinpr
     c                   eval      w_omr1 = veomre
     c                   when      x = 2
     c                   eval      p_enh2 = vpenhe
     c                   eval      p_kop2 = vpkopr
     c                   eval      p_inp2 = vpinpr
     c                   eval      w_omr2 = veomre
     c                   when      x = 3
     c                   eval      p_enh3 = vpenhe
     c                   eval      p_kop3 = vpkopr
     c                   eval      p_inp3 = vpinpr
     c                   eval      w_omr3 = veomre
     c                   endsl
      *
     c                   if        w_dato >= vppdat
     c                   leave
     c                   endif
      *
     c     vvprl1_key    reade     vvprl1                                 91
     c                   enddo
      *
      * Dersom priser ikke finnes for oppgitt leveringstype, hentes priser
      * fra leveringstype 0
      *
     c                   if        b_pris = *off and
     c                             p_lety <> 0
      *
     c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = p_prgr
     c                   eval      vvprl1_enhe = veenhe
     c                   eval      vvprl1_lety = 0
     c     vvprl1_key    setll     vvprl1
     c     vvprl1_key    reade     vvprl1                                 91
      *
     c                   if        *in91 = *off
     c                   eval      x = x + 1
     c                   eval      b_pris = *on
     c                   endif
      *
     c                   dow       *in91 = *off
      *
     c                   select
     c                   when      x = 1
     c                   eval      p_enh1 = vpenhe
     c                   eval      p_kop1 = vpkopr
     c                   eval      p_inp1 = vpinpr
     c                   eval      w_omr1 = veomre
     c                   when      x = 2
     c                   eval      p_enh2 = vpenhe
     c                   eval      p_kop2 = vpkopr
     c                   eval      p_inp2 = vpinpr
     c                   eval      w_omr2 = veomre
     c                   when      x = 3
     c                   eval      p_enh3 = vpenhe
     c                   eval      p_kop3 = vpkopr
     c                   eval      p_inp3 = vpinpr
     c                   eval      w_omr3 = veomre
     c                   endsl
      *
     c                   if        w_dato >= vppdat
     c                   leave
     c                   endif
      *
     c     vvprl1_key    reade     vvprl1                                 91
     c                   enddo
      *
     c                   endif
5.70  *
5.70  * Dersom priser ikke finnes for oppgitt prisgruppe, hentes priser
5.70  * fra prisgruppe = blank
5.70  *
5.70 c                   if        b_pris = *off and
5.70 c                             p_prgr <> *blank
5.70  *
5.70 c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = *blank
5.70 c                   eval      vvprl1_enhe = veenhe
5.70 c                   eval      vvprl1_lety = p_lety
5.70 c     vvprl1_key    setll     vvprl1
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70  *
5.70 c                   if        *in91 = *off
5.70 c                   eval      x = x + 1
5.70 c                   eval      b_pris = *on
5.70 c                   endif
5.70  *
5.70 c                   dow       *in91 = *off
5.70  *
5.70 c                   select
5.70 c                   when      x = 1
5.70 c                   eval      p_enh1 = vpenhe
5.70 c                   eval      p_kop1 = vpkopr
5.70 c                   eval      p_inp1 = vpinpr
5.70 c                   eval      w_omr1 = veomre
5.70 c                   when      x = 2
5.70 c                   eval      p_enh2 = vpenhe
5.70 c                   eval      p_kop2 = vpkopr
5.70 c                   eval      p_inp2 = vpinpr
5.70 c                   eval      w_omr2 = veomre
5.70 c                   when      x = 3
5.70 c                   eval      p_enh3 = vpenhe
5.70 c                   eval      p_kop3 = vpkopr
5.70 c                   eval      p_inp3 = vpinpr
5.70 c                   eval      w_omr3 = veomre
5.70 c                   endsl
5.70  *
5.70 c                   if        w_dato >= vppdat
5.70 c                   leave
5.70 c                   endif
5.70  *
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70 c                   enddo
5.70  *
5.70  * Dersom priser ikke finnes for oppgitt leveringstype, hentes priser
5.70  * fra leveringstype 0
5.70  *
5.70 c                   if        b_pris = *off and
5.70 c                             p_lety <> 0
5.70  *
5.70 c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = *blank
5.70 c                   eval      vvprl1_enhe = veenhe
5.70 c                   eval      vvprl1_lety = 0
5.70 c     vvprl1_key    setll     vvprl1
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70  *
5.70 c                   if        *in91 = *off
5.70 c                   eval      x = x + 1
5.70 c                   eval      b_pris = *on
5.70 c                   endif
5.70  *
5.70 c                   dow       *in91 = *off
5.70  *
5.70 c                   select
5.70 c                   when      x = 1
5.70 c                   eval      p_enh1 = vpenhe
5.70 c                   eval      p_kop1 = vpkopr
5.70 c                   eval      p_inp1 = vpinpr
5.70 c                   eval      w_omr1 = veomre
5.70 c                   when      x = 2
5.70 c                   eval      p_enh2 = vpenhe
5.70 c                   eval      p_kop2 = vpkopr
5.70 c                   eval      p_inp2 = vpinpr
5.70 c                   eval      w_omr2 = veomre
5.70 c                   when      x = 3
5.70 c                   eval      p_enh3 = vpenhe
5.70 c                   eval      p_kop3 = vpkopr
5.70 c                   eval      p_inp3 = vpinpr
5.70 c                   eval      w_omr3 = veomre
5.70 c                   endsl
5.70  *
5.70 c                   if        w_dato >= vppdat
5.70 c                   leave
5.70 c                   endif
5.70  *
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70 c                   enddo
5.70  *
5.70 c                   endif
5.70  *
5.70 c                   endif
      *
     c                   endsr
6.31  *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Subrutine for å først å bruke
6.31  * 1. hvis flere enn en bestilbar enhet, bruk rekkefølge i vare-enh.
6.31  * 2. hvis kun en bestillbare enhet i vare-enhet-prisg. bruk denne
6.31  * 3. ellers som før
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     sjekk_vvep    begsr
6.31  *
6.31 c/exec sql
6.31 c+                  declare sok_o cursor for
6.31 c+                  select vepvar,
6.31 c+                         vepenh,
6.31 c+                         vepbes,
8.01 c+                         vepkla,
6.31 c+                         vevare,
6.31 c+                         veomre,
6.31 c+                         veenhe,
6.31 c+                         veinen
6.31 c+                  from   vveppf
6.31 c+                  inner  join vvenpf
6.34 c+                  on     vepfir = vefirm and
6.31 c+                         vepvar = vevare and
6.31 c+                         vepenh = veenhe
6.31 c+                  where  vepfir = :w_firm and
6.31 c+                         vepldo = :w_ldor and
6.31 c+                         vepvar = :p_vare and
6.31 c+                         vepbes = 1       and
6.31 c+                         vepgti <> 0
6.31 c+                  order by vepvar, veinen
6.31 c+                  for read only
6.31 c/end-exec
6.31 c/exec sql
6.31 c+                  close sok_o
6.31 c/end-exec
6.31 c/exec sql
6.31 c+                  open sok_o
6.31 c/end-exec
6.31  *
6.31 c                   dow       x <  3
6.31  *
6.31 c     fetch_vare    tag
6.31  *
6.31 c/exec sql
6.31 c+                  fetch next
6.31 c+                  from  sok_o
6.31 c+                  into  :vepvar,
6.31 c+                        :vepenh,
6.31 c+                        :vepbes,
8.01 c+                        :vepkla,
6.31 c+                        :vevare,
6.31 c+                        :veomre,
6.31 c+                        :veenhe,
6.31 c+                        :veinen
6.31 c/end-exec
6.31  *
6.31 c                   if        sqlcod = 100 or sqlstt = '02000'
6.31 c                   leavesr
6.31 c                   endif
6.31  *
8.01  * Hvis krav til pakninsgklasse, sjekk at den finnes
6.31  *
8.01 c                   if        u_pakl = *on and
8.01 c                             %trim(vepkla) = *blanks
8.01 c                   goto      neste_vare
8.01 c                   endif
6.31  * 1. leverandør for lageret
6.31 c                   eval      vvprl1_ldor = w_ldor
6.31 c                   exsr      hent_pris
6.31 c                   if        b_pris = *off  and
6.31 c                             w_ldor <> vvldor
6.31  * 2. hovedleverandør
6.31 c                   eval      vvprl1_ldor = vvldor
6.31 c                   exsr      hent_pris
6.31 c                   if        b_pris = *off
6.31  * siste mulighet...
6.31 c                   eval      vvprl1_ldor = 0
6.31 c                   exsr      hent_pris
6.31 c                   endif
6.31 c                   endif
6.31  *
6.31  *  Velg neste Vare-register post
6.31  *
6.31 c     neste_vare    tag
6.31 c                   goto      fetch_vare
6.31  *
6.31 c                   enddo
6.31 c                   endsr
6.31  *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_firm
     c                   parm                    p_vare
5.70 c                   parm                    p_prgr
     c                   parm                    p_lety
     c                   parm                    p_dato
     c                   parm                    p_enh1
     c                   parm                    p_kop1
     c                   parm                    p_inp1
     c                   parm                    p_enh2
     c                   parm                    p_kop2
     c                   parm                    p_inp2
     c                   parm                    p_omr2
     c                   parm                    p_enh3
     c                   parm                    p_kop3
     c                   parm                    p_inp3
     c                   parm                    p_omr3
6.21 c                   parm                    p_kamp
6.32 c                   parm                    p_ldor
6.32 c                   parm                    p_lage
      *
      * Key for les på vare-pris-register
      *
     c     vvprl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvprl1_vare
6.20 c                   kfld                    vvprl1_ldor
5.70 c                   kfld                    vvprl1_prgr
     c                   kfld                    vvprl1_enhe
     c                   kfld                    vvprl1_lety
6.21  *
6.21  * Key for les på vare-pris-register
6.21  *
6.21 c     vtill9_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    vtill9_vare
6.21 c                   kfld                    vtill9_prgr
6.21 c                   kfld                    vtill9_lety
      *
      * Key for les på vare-enhet-register m/innkjøpsenhet
      *
     c     vvenl4_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl4_vare
     c                   kfld                    vvenl4_inen
      *
     c     vvenl4_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl4_vare
      *
      * Key for les på vare-enhet-register m/salgsenhet
      *
     c     vvenl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl2_vare
     c                   kfld                    vvenl2_saen
      *
     c     vvenl2_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl2_vare
6.20  *
6.20  * Key for oppslag på vare
6.20  *
6.20 c     vvarl1_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    vvarl1_vare
      *
      *
      * Henter firma fra parameter
      *
     c                   eval      w_firm = p_firm
      *
      * Initierer dato
      *
     c                   eval      w_dato = p_dato
      *
     c                   if        w_dato = *loval
     c                   time                    w_dato
     c                   endif
      *
      * Initierer output-parametre
      *
     c                   eval      p_enh1 = *blank
     c                   eval      p_kop1 = 0
     c                   eval      p_inp1 = 0
     c                   eval      p_enh2 = *blank
     c                   eval      p_kop2 = 0
     c                   eval      p_inp2 = 0
     c                   eval      p_omr2 = 0
     c                   eval      p_enh3 = *blank
     c                   eval      p_kop3 = 0
     c                   eval      p_inp3 = 0
     c                   eval      p_omr3 = 0
8.01  *
8.01  * Test om internordre skal overføres.
8.01  *
8.01   u_pakl = *off;
8.01  *
8.01   CallP CO402R(l_filg:p_firm:0:'ENHET_MED_PAKNINGSKLASSE':
8.01                    co402_verdi1:co402_verdi2);
8.01   if co402_verdi1 = '1';
8.01     u_pakl = *on;
8.01   endif;
8.01  *
      *
     c                   endsr
