# RPG Program Explanation: ASOFAK - FW705R

## Overview

This ILE RPG program, named **FW705R**, is designed for use in the **ASOFAK** system. Its primary function is to generate and maintain a supplier product register (vareregister) for the supplier "Luna." The program processes an input file that can contain both article records and price update records, writing the appropriate data to the supplier product register.

Key features include:
- Article records are written with the current date as the price date.
- Unit information is pulled from Luna for article records.
- For price updates, unit and product text are fetched from the product register. The unit is set to the base unit, and product text to the primary product text.

The program handles both article and price records in a single input file, with articles processed first, followed by prices.

---

## File Declarations

```rpg
fflvwpf    if   e           k disk
ffenkl1    if   e           k disk    rename(fenkpfr:fenkl1r)
fvvarl5    if   e           k disk    rename(vvarpfr:vvarl5r)
fflval2    if   e           k disk    rename(flvapfr:flval2r)
fflvalu    uf a e           k disk    rename(flvapfr:flvalur)
```

- **flvwpf**: Input file containing article and price data.
- **fenkl1**: File for unit conversion/look-up (possibly units of measurement).
- **vvarl5**: Product register (for look-up).
- **flval2**: Register containing supplier product numbers (for look-up).
- **flvalu**: The supplier product register file to write/update.

---

## Data Structures

### Local User Data

```rpg
d                uds
d l_user                911    920
```
- Extracts user information from the Local Data Area (positions 911–920).

### Input Record Structures (overlayed on input strings)

**Header Record (3 chars, post type)**
```rpg
d                 ds
d d_inpu                         3
d  d_type                        3    overlay(d_inpu:1)
```

**Article Record (200 chars)**
```rpg
d                 ds
d d_ainp                       200
d  d_avar                       24    overlay(d_ainp:4)
d  d_aean                       13    overlay(d_ainp:28)
d  d_atek                       30    overlay(d_ainp:41)
d  d_aenh                        3    overlay(d_ainp:75)
d  d_aspr                        9  2 overlay(d_ainp:89)
d  d_aipr                        9  2 overlay(d_ainp:98)
d  d_aeva                       10    overlay(d_ainp:127)
d  d_aeko                        1    overlay(d_ainp:137)
```
- Fields for article number, EAN number, description, unit, prices, replacement article, etc.

**Price Update Record (80 chars)**
```rpg
d                 ds
d d_pinp                        80
d  d_pvar                       11    overlay(d_pinp:4)
d  d_pean                       13    overlay(d_pinp:15)
d  d_pspr                        9  2 overlay(d_pinp:49)
d  d_prab                        3  1 overlay(d_pinp:58)
```
- Fields for article number, EAN, sales price, discount etc.

---

## Parameters

```rpg
d p_firm          s                   like(vvfirm)
d p_ldor          s                   like(vvldor)
```
- Company and supplier identifiers passed into the program as parameters.

---

## Key Variables and Work Variables

- Used for forming key lists to read/update the various database files.
- Work variables for processing EAN numbers, handling leading zeroes, etc.

---

## Main Program Logic (Hovedprogram)

1. **Reads the input file (`flvwpf`) one record at a time.**
2. **Determines record type** by checking the post type (`d_type`):
    - `'100'`: Article record → Populates data structure and calls `artikkel` subroutine.
    - `'001'`: Price update → Populates data structure and calls `prisoppdat` subroutine.
3. **Loops** until end of file.

---

## Subroutines

### 1. **artikkel** (Handles Article Records)

- Populates the output fields from the input.
- Parses/normalizes the EAN number, ensuring it is 13 digits, zero-padded if necessary.
- Sets product register fields (text, unit, prices, etc.).
- Attempts to enhance the unit from the unit conversion table if a match is found.
- Stamps the record with current date/time and user info.
- Adds a new record to the supplier product register (`flvalur`).

**Special handling:**
- If EAN number is less than 13 chars, it is zero-padded on the left.
- Writes all relevant audit information (date, time, user).

### 2. **prisoppdat** (Handles Price Update Records)

- Looks up the product in the `flval2` file using the supplier's article number.
- If found, chains the corresponding record in the main supplier register (`flvalur`) and updates prices (calculates purchase price as price minus discount).
- If not found, creates a new record similar to the `artikkel` routine.
    - Pulls product text and unit information from the product register if available.
    - EAN number is normalized as above.
    - Audit fields are set.
- Writes the (updated or new) record to the supplier product register.

**Special handling:**
- Uses the product register to supplement missing product description/unit if present during price update.

### 3. **\*inzsr** (Initialization Subroutine)

- Defines `plist` (parameter list) to receive company and supplier IDs.
- Sets up key lists for use in `chain`, `setll`, and `reade` operations throughout the program.
- Initializes work fields.

---

## Key Handling Details

- Multiple `klist` (key lists) defined for searching different files:
    - For unit look-up: firm + unit code.
    - For supplier product number: firm + supplier + article number.
    - For updating product register: firm + supplier + line number.

---

## Comments / Audit Trail

- Program is well-documented with a detailed comment header, including history of changes, bug fixes, and feature additions.
- Audit trail fields are updated whenever a record is written/updated.

---

## Notable RPG Techniques

- Heavy use of data structure overlays to extract fields from input records.
- `chain`, `setll`, and `reade` used for keyed access to database files.
- Inline date/time/user stamping for auditing.
- Calculations use both simple arithmetic and formatting for data migration/normalization (notably for EAN numbers).
- Use of subroutines (`begsr`/`endsr`) for structuring the processing logic.

---

## Summary

This program serves as a batch loader and updater of a supplier product register from a Luna-provided file containing both articles and price updates. It is robust in handling different input scenarios, ensures data integrity (e.g., normalized EAN numbers), and writes every change with full traceability (user/date/time). The modular structure and clear documentation make it maintainable and extensible for future changes.