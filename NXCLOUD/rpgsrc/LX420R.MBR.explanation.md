# FX820R Program Documentation

## Overview

**Program Name:** FX820R  
**System:** ASOFAK  
**Purpose:**  
This program updates product group (varegruppe) information in the statistics table for products (varer) in the statistics file (SISTLA) where group information is missing. It pulls group data from either the active product master (JVARL1) or from the deleted product archive (VVASL1).  
**Business Context:**  
- The program is used to ensure that all product statistics lines have valid group assignments, which are necessary for accurate reporting and analysis.
- It is typically run as a corrective or maintenance task.

---

## File Definitions

- **SISTLA (Statistics Line Table)**
  - File name: `SISTLA`
  - Record format: `SISTPFR` renamed as `SISTLAR`
  - Usage: Update mode (UF), keyed access (K), external (E)

- **JVARL1 (Active Product Master)**
  - File name: `JVARL1`
  - Record format: `JVARPFR` renamed as `JVARL1R`
  - Usage: Input mode (IF), keyed access (K), external (E)

- **VVASL1 (Deleted Product Archive)**
  - File name: `VVASL1`
  - Record format: `VVASPFR` renamed as `VVASL1R`
  - Usage: Input mode (IF), keyed access (K), external (E)

---

## Key Variables and Structures

- **LDA (Local Data Area)**
  - `l_firm`: Extracts the company number from LDA positions 944-946.

- **Key Variables**
  - `sistla_paar`: Statistics year (initialized to 2004).
  - `jvarl1_vare`: Product number for lookups in JVARL1.
  - `vvasl1_vare`: Product number for lookups in VVASL1.
  - `w_firm`: Company number, fetched from LDA.

- **Key Lists**
  - `sistla_key`: (w_firm, sistla_paar) — used for reading/updating statistics lines.
  - `jvarl1_key`: (jvarl1_vare) — used for chaining into JVARL1.
  - `vvasl1_key`: (w_firm, vvasl1_vare) — used for chaining into VVASL1.

---

## Main Logic Flow

### 1. Initialization (`*INZSR`)

- Builds key lists for all relevant files.
- Sets `w_firm` from LDA (`l_firm`).

### 2. Main Processing Loop

- Sets `sistla_paar` to 2004 (hardcoded; adjust if running for other years).
- Positions to the first record in SISTLA for the current company/year.
- Iterates over all statistics lines for the year.

#### For each statistics line:
- **Skip if group data is complete:**  
  If all three group fields (`siogrp`, `sihgrp`, `siugrp`) are non-zero, go to the next record.

- **Try to supplement from JVARL1 (Active Product Master):**
  - Chain on product number (`sivare`).
  - If found, copy group fields (`jvogrp`, `jvhgrp`, `jvugrp`) into the statistics line.

- **If not found, try to supplement from VVASL1 (Deleted Product Archive):**
  - Chain on company and product number.
  - If found, copy group fields (`vvogrp`, `vvhgrp`, `vvugrp`) into the statistics line.

- **If group data was updated (from either source):**
  - Update the statistics line in SISTLA.

- **Continue to next record.**

### 3. Program Termination

- Set LR indicator to on (`*INLR = *ON`) to end the program.

---

## Design Notes and Conventions

- **Year Hardcoding:**  
  The statistics year is hardcoded to 2004 (`sistla_paar = 2004`). If you need to run this for other years, parameterize this value.

- **Company Context:**  
  The company number is read from the LDA, ensuring that updates are always company-specific.

- **Two-Stage Lookup:**  
  The program first attempts to supplement missing group data from the active product master (JVARL1). Only if the product is not found there does it look in the deleted product archive (VVASL1). This ensures the most current group data is used when available.

- **Key List Usage:**  
  Key lists are used for all file operations. This is a common pattern in this codebase for clarity and maintainability.

- **Goto/Tag Structure:**  
  The program uses `GOTO` and `TAG` for flow control, a legacy pattern in this codebase. This avoids deeply nested `IF`/`ENDIF` blocks and keeps the main loop flat.

- **Update Only When Needed:**  
  The program only updates records in SISTLA if missing group data is successfully supplemented from one of the source files.

---

## Interactions with Other Modules

- **JVARL1:**  
  The active product master. If group data is missing in statistics, this is the primary source for supplementation.

- **VVASL1:**  
  The deleted product archive. Used as a fallback for products that have been deleted but still have statistics lines.

- **LDA:**  
  Used to determine the current company context.

---

## Business Domain Considerations

- **Product Groups:**  
  Product group data is critical for statistical reporting. Missing group assignments can cause misclassification in reports and analytics.

- **Deleted Products:**  
  Statistics may exist for products that have since been deleted. This program ensures that even these records have valid group data, leveraging the archive.

---

## Error Handling

- The program does not log or report errors if a product is not found in either JVARL1 or VVASL1. Such records will remain with missing group data.

---

## Maintenance Notes

- **Extending to Other Years:**  
  Consider parameterizing `sistla_paar` if this program is to be reused for other periods.

- **Performance:**  
  The program processes all statistics lines for the year sequentially. For large datasets, consider optimizing file access or adding progress reporting.

- **Modernization:**  
  The use of `GOTO` and tags is a legacy style. Consider refactoring to structured control flow if making significant changes.

---

## Summary

FX820R is a maintenance utility that ensures all statistics lines for products in a given year and company have valid group assignments. It supplements missing group data from both the active and deleted product masters, updating the statistics table as needed. The program is designed for batch/maintenance use and relies on legacy RPG patterns and conventions.