## Program Documentation: RL601R – Duplicate Supplier Register Report

### Overview

**Program Name:** RL601R  
**System:** ASOKON  
**Purpose:**  
This program generates a report of duplicate entries in the supplier register. It processes supplier master files, identifies duplicates based on configurable criteria, and outputs a formatted list to a printer file.

**Business Domain Context:**  
The application is part of the supplier management subsystem. It is used to maintain data quality in the supplier master by detecting and reporting potential duplicate supplier records. The duplicate check can be fine-tuned by specifying which fields must match (name, address, postal code, phone, mobile).

---

### File Definitions and Relationships

- **RLEVL2** (`rlevpfr` record format, renamed `rlevl2r`):  
  Main supplier file, processed sequentially to identify duplicates.

- **RLEVL1** (`rlevpfr` record format, renamed `rlevl1r`):  
  Used to retrieve full supplier details for reporting, accessed by key.

- **RL601P**:  
  Printer file for report output, with overflow indicator `*IN30`.

#### File Relationships

- `RLEVL2` is the primary file scanned for possible duplicates.
- For reporting, details are chained from `RLEVL1` using keys derived from `RLEVL2`.
- The report is written to `RL601P`.

---

### Key Variables and Data

- **Local Data Area Usage:**  
  The program utilizes the user data space (UDS) for configuration and runtime parameters (e.g., which fields to check for duplicates, user and firm info).

    - `l_navn`, `l_gate`, `l_ponr`, `l_tlfn`, `l_mobn`: Flags ('J' = Yes) to enable duplicate checking on name, address, postal code, phone, mobile.
    - `l_firm`: Current firm/company number.
    - `l_user`, `l_wsid`, `l_fnav`: User/session info.

- **Working Storage:**  
  - `ant`: Counter for the number of consecutive records considered duplicates.
  - `w_ikke`: Flag to indicate a non-duplicate in the current comparison.
  - `w_firm`, `w_levr`, `w_alfa`, `w_navn`, etc.: Working copies of fields from the current or previous supplier record for comparison.

---

### Program Logic and Flow

#### 1. Initialization (`*INZSR`)

- Sets up key lists for file access.
- Initializes working variables and duplicate counters.
- Writes the report heading to the printer file.

#### 2. Main Processing Loop

- Sequentially reads `RLEVL2` by key.
- For each record:
    - Compares the current record's key field (`rlalfa`) to the previous (`w_alfa`).
    - If the key matches, invokes the duplicate check subroutine (`xsrkont`) to further compare configured fields.
    - Maintains a count (`ant`) of how many consecutive records are considered duplicates.
    - Based on the value of `ant`:
        - **1:** Stores the first record as the potential start of a duplicate set.
        - **2:** Outputs both the first and current record as duplicates.
        - **>2:** Outputs only the current record as an additional duplicate.
    - Updates the working key (`w_alfa`) for the next iteration.

#### 3. Duplicate Check Subroutine (`xsrkont`)

- For each field flagged in the local data area (e.g., name, address), compares the current record with the previous.
- If any flagged field does not match, sets `w_ikke = 'J'` to indicate the records are not duplicates by the configured criteria.

#### 4. Report Output Subroutine (`utskrift`)

- Handles report overflow (page breaks).
- Chains into `RLEVL1` to retrieve full supplier details for the current record.
- Writes a detail line to the printer file.

#### 5. Program End

- Sets LR indicator to end the program.

---

### Indicators and Conventions

- **Indicator Usage:**
    - `*IN30`: Printer file overflow, triggers heading write.
    - `*IN90`: End-of-file indicator for input files.
    - Other indicator ranges are reserved for standard purposes (see header comments).

- **Field Naming and Prefixing:**
    - `x:` prefix used for fields from the `rlevl1` file to avoid naming collisions.

- **Subroutine Naming:**
    - `xsrkont`: "kontroll" (check/control) – duplicate check logic.
    - `utskrift`: printing/output logic.

---

### Notable Design Decisions

- **Configurable Duplicate Criteria:**  
  The program allows runtime configuration of which fields are considered in duplicate detection, controlled via the local data area. This offers flexibility to adjust the strictness of duplicate identification without modifying the code.

- **Separation of Scanning and Reporting:**  
  The program decouples the scanning of potential duplicates (`RLEVL2`) from the retrieval of full details (`RLEVL1`), optimizing performance and report clarity.

- **Batch Processing with Sequential Logic:**  
  The loop assumes that `RLEVL2` is sorted by the key field (`rlalfa`). This enables efficient grouping and detection of consecutive duplicates.

---

### Integration Points

- **Data Sources:**  
  - Reads supplier master data from `RLEVL2` and `RLEVL1`.
  - Uses the local data area for runtime configuration.

- **Output:**  
  - Writes a formatted report to the `RL601P` printer file.

---

### Summary Table

| Section        | Functionality                                      |
|----------------|---------------------------------------------------|
| Initialization | Set up keys, working storage, write heading        |
| Main Loop      | Scan `RLEVL2`, detect/group duplicates             |
| xsrkont        | Field-by-field duplicate check per configuration   |
| utskrift       | Retrieve details, write report line, handle OFL    |
| End            | Set LR, terminate program                          |

---

### Business Rules

- Only suppliers within the current firm (`l_firm`) are processed.
- Duplicates are defined based on configurable fields; all flagged fields must match for records to be considered duplicates.
- All detected duplicates are listed in the output, grouped together.

---

### Maintenance Notes

- To adjust which fields are used for duplicate detection, update the corresponding flags in the local data area.
- Ensure `RLEVL2` is sorted by the key field (`rlalfa`) before running the report.
- The program is designed for batch operation; no interactive components are present.

---

### Potential Enhancements

- Consider parameterizing the local data area settings for easier control by end-users.
- Add logging or summary statistics to the report for better auditability.
- Migrate to free-format RPG for maintainability if modernizing the codebase.

---

### Contact

For questions regarding business rules or integration, contact the supplier master data team.  
For technical maintenance, contact the RPG development lead.