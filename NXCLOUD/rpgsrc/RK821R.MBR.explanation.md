# RPG Program Explanation: Autogiro Printing - Receipt (RK821R)

## Program Purpose

This RPG program is for **printing autogiro (direct debit) receipt controls**. The process involves reading financial and customer master files, accumulating amounts owed, managing batch records for bank transmission (autogiro), and creating print records as well as output records for transmission.

It's tailored to Norwegian banking/AR routines (hence, a lot of field names and comments are in Norwegian).

---

## 1. **Program and File Declarations**

- **Header lines** set up program options (`*NODEBUGIO` disables debug for file I/O), decimal and date edit codes.
- **Files** are declared as input (`I`), update (`U`), output (`O`), etc. Each file (`rkw4pf`, `rkwapf`, etc.) corresponds to different business data tables:
    - `rkw4pf`, `rkwapf`, `frkunpf`, etc.: Various master and transactional files.
    - Some are renamed (for logical views).
    - Output files include a printer file (`rk821p`) and output files for result records.

---

## 2. **Data Structures**

- **Working Fields**: Standard working variables for looping, flags, accumulators, and parameter storage.
- **Parameter Data Structure**: `d_parm` contains fields passed into the program at runtime: company code, user, date, etc.
- **Overlay Data Structures**: Many DS definitions use `overlay` to provide both field-level and record-level access.
- **Kid-field DS**: Special structure for KID (customer identification numbers in payment systems).

---

## 3. **Specialized DS for Bank File Layouts**

The program defines several 80-byte DS, overlaid with fields for:
- **Start, transaction, specification, and end records** for both **transmission ("forsendelse")** and **assignment ("oppdrag")**, as required by the Norwegian BBS (Bank Payment System).

Each record type (10, 20, 30, 31, 40, 41, 49, 70, 71, 72, 88, 89) is supported with a matching DS, allowing data to be mapped directly for transmission files.

---

## 4. **One-Time Initialization (`*INZSR`)**

- Loads the entry parameter (`w_parm`) and spreads its contents into the overlayed fields.
- Initializes various numeric and work fields to zero.
- Builds key lists for various files, matching the data structures.

---

## 5. **Main Processing Loop**

### a. **Initial Read and Setup**

- The program seeks the starting place in the master file (e.g., `rkw4pf`).
- Reads the first record.

### b. **Per-Firm Processing**

- Checks whether the company (`rnfirm`) matches the expected one (`s_firm`). If not, loads company info from another file (`afirl1`).
- Updates or creates a BBS exchange sequence record (`raa7lu`).

### c. **Company Filter**

- Only processes records for the desired company (`pfirm`): sets a boolean (`b_firm`). If not the right company, the program skips.

### d. **Header Output and Transmission Start**

- Writes a header.
- Calls subroutine `skriv_r10` to write the "start of transmission" record (record type 10).
- Accumulators for totals are zeroed.

### e. **Start Assignment (Oppdrag) Output**

- Calls subroutine `skriv_r20` to write the "start of assignment" record (record type 20).

### f. **Customer/Invoice Loop (`dow not %eof`)**

- **Zero-amount skip**: If the invoice (`rnbel�`) is zero, marks a flag.
- **Customer break check**: If the customer (`rnkund`) changes:
    - Finalizes totals for the prior customer.
    - Writes summary and possibly an "end of assignment" record (type 88).
    - Resets per-customer accumulators.
- **Negative/zero amounts**: Flags if negative, skips autogiro if so.
- **Date Splitting**: Handles conversion between RPG date fields and BBS layouts.
- **Customer master lookup**: Pulls data from customer (`frkunpf`) and post register (`apospf`).
- **Balance check**: Skips further processing if the customer's balance is non-positive.
- **Reklamasjon (Complaint) check**: Skips further processing if the invoice is a complaint (type 89).
- **Valid invoice**:
    - Accumulates assignment and transmission totals.
    - Updates earliest and latest due dates.
    - Writes the invoice detail record to both print and output files.
    - Calls subroutines to write transaction records (types 30 & 31).
    - Updates master record (`rnauto` status flag).

Reads next record and continues.

---

## 6. **Termination and Finalization**

- Writes any remaining totals by customer.
- Calls subroutines to write "end of assignment" (type 88) and "end of transmission" (type 89).
- Updates sequence numbers in the BBS sequence file (`raa7lu`).
- Turns on `*INLR` to close files and return.

---

## 7. **Subroutines**

### `skriv_r10` (Write Start Transmission)
- Fills in the appropriately mapped DS for the start of transmission (type 10).
- Writes the record to the output file.
- Stores transmission sequence numbers, resets earliest due date, etc.

### `skriv_r20` (Write Start Assignment)
- Prepares and writes start of assignment (type 20).

### `skriv_r30` (Write Transaction Record 1)
- Prepares transaction record (type 30) with invoice specifics, including due date and KID.
- Calls external program `ASMD10` to generate the KID field.

### `skriv_r31` (Write Transaction Record 2)
- Prepares a secondary transaction record (type 31), usually for name/reference info.
- Performs character translation to handle Norwegian/special characters.

### `skriv_r88` (Write End of Assignment)
- Writes the summary "end of assignment" record (type 88).

### `skriv_r89` (Write End of Transmission)
- Writes the summary "end of transmission" record (type 89).

---

## 8. **Flags and Control Variables**

- The program uses both *INxx hardware indicators and custom boolean fields (`b_firm`, `b_kund`, etc.) to manage logic, improve code readability, and avoid classic RPG's limitations.

---

## 9. **Error Handling and Data Integrity**

- Handles all edge cases: zero/negative balances, customer/assignment boundaries, missing data, and records flagged as complaints.
- Ensures all summary and batch totals are accurate for both reporting and output files.

---

## **Summary for Developers**

- **This program is a main driver for generating both printed and BBS file outputs for autogiro payment runs.**
- **It integrates with several master and transaction files, adheres to strict record layouts for BBS, and has detailed control logic for totals and boundaries (per customer, company, and run).**
- **The program's subroutines isolate record layout-specific output logic, making it easier to update if BBS requirements change.**
- **It uses overlays heavily – understanding the data structures is key.**
- **Thorough state/flag management ensures reliability and auditability.**

---

## **Key Points for Onboarding**

- Familiarize yourself with the BBS file formats and Norwegian AR/Autogiro concepts.
- Carefully review the data structures and overlays to understand how fields map for both business logic and output.
- The main loop and subroutine calls are the heart of the program; they're well-structured around the business process.
- For changes, focus on the subroutines, especially if updating BBS layouts or print output.
- Be aware of the customer/language context: field names and comments are largely in Norwegian. Use the Norwegian banking domain as a reference.

---

**End of explanation.**