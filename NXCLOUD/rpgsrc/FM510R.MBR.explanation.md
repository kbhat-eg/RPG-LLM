# RPG Program FM510R - Facturatype Inquiry

This program is an ILE RPG (RPG IV) application used on IBM i systems for handling invoice type inquiries (Fakturatype, spørring). It features subfile display, navigation, and selection logic on a display file. Below, you'll find a detailed breakdown of its structure and behavior.

---

## **1. Header and Documentation**

- `h option(*nodebugio) datedit(*dmy)`: Sets program options. No debug for I/O, date edit in day/month/year format.
- The comments specify the system, program name, and a short description (Facturatype inquiry).
- Change history is provided, indicating developments and enhancements over time.
- Indicator usage is explained—vital for understanding screen and program flow.

---

## **2. File Definitions**

- `fmftl1`: Input file (likely a database physical file with key). Renamed record format.
- `fm510d`: Display file (`workstn`), with a subfile (SFILE) named `b1sfl` using variable `w_srrn` as the relative record number. Uses an information data structure called `dspfbk` for display feedback.

---

## **3. Data Definitions**

### **Parameters**

- `p_firm`, `p_faty`, `p_tbes`: Incoming parameters, likely for company, invoice type, and description.

### **DS for Display Feedback**

- `dspfbk` data structure: Used to get cursor position on the display screen (via `d_fcrn`).

### **Key and Work Variables**

- `fmftl1_faty`, `w_firm`: Work variables for database keys.
- `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Work fields for tracking subfile (paging, record selection, etc.).
- `w_seqe`, `b_valg_ok`: State/flag variables.
- `c_sfil`: Constant (subfile page size).

#### **Special Field Explanation**

There's an extensive block explaining the purpose of all paging/subfile variables, which is vital for any developer enhancing subfile logic.

---

## **4. Main Control Flow**

### **Startup**

- Program entry initializes parameters and subfile. Populates key fields and positions the database using `setll` before filling the subfile via the `crt_subfile` subroutine.

### **Screen and Subfile Loop**

- There is a main loop, labeled `b2taga` and `b2tagb`, that alternates between sending the screen, filling the subfile, and processing user input (function keys).

#### **Function Keys / Indicator Handling**

- Select/`select` block determines what to do for each function key:
    - *inkc, *inkl: Exit
    - *inke: Refresh (calls `forny`)
    - *in10: Roll forward (calls `crt_subfile`)
    - *in11: Roll backward (calls `bck_subfile`)
    - *in21: Sets cursor to home
    - All other cases loop back to the tags.

#### **Subfile Processing**

- The `subfile` subroutine reads user entries from the subfile lines. If the 'select' field (`b1valg`) is set to 1 by the user, the selected record information is captured and the flag `b_valg_ok` is set, indicating to exit the loop.

---

## **5. Subroutines**

### **forny** - "Refresh Subfile"
- If a current record exists, chains to the corresponding subfile position.
- Resets filter field, positions the database, clears and refills the subfile.

### **subfile** - "Handle Subfile Input"
- Toggles a cursor placement indicator.
- Loops over subfile records (`readc`), looking for a selected entry; if found, captures and flags for exit.

### **clr_subfile** - "Clear Subfile"
- Sets indicator 14 to clear the subfile, writes the control record, then resets paging and subfile counters.

### **crt_subfile** - "Fill Subfile (Page Forward)"
- Advances the page counter, then loops to read from the database (`read`) and populates subfile entries until the page is full or EOF.
- Handles end-of-file by setting the appropriate indicator.

### **bck_subfile** - "Page Backward"
- If at the end, steps the file pointer backward, then reads records backward (`readp`) just enough to revert one page, then repopulates the subfile display.

### **dsp_subfile** - "Display Subfile"
- If subfile contains entries, sets indicators for screen state and displays control record (`exfmt b2ctl`).

### **INZSR** - "Program Initialization"
- Parameter loading and initial setup.
- Positions the file to the correct company and starting invoice type, then initializes the subfile.

---

## **6. Indicators**

- Standard RPG indicators are heavily used for screen flow, error handling, and toggling subfile/page states. Their mapping was clearly described in the comments, e.g.:
    - 10: Roll
    - 11: Roll back
    - 12, 13: Subfile display and control
    - 14: Clear subfile
    - 15: End of subfile

---

## **7. Display File (DSPF) Usage & Subfiles**

- The program uses a subfile (`b1sfl`) to list invoice types.
- Control records (`b2ctl`, `b2cmd`) are written to display additional screens/messages.
- Paging (next/previous) is handled via function key processing, and the subfile is repopulated as needed.

---

## **8. Key Lists**

- Database file access uses `klist` and `kfld` for key field positioning, e.g., company and invoice type.

---

## **Summary Table**

| Section             | Purpose                                               |
|---------------------|------------------------------------------------------|
| Header & Docs       | Meta-info, change history, indicator mapping         |
| F specs             | File and display file setup                          |
| D specs             | Parameter, key, and work variable definitions        |
| Mainline            | Main loop: display, process, and navigate subfile    |
| Subroutines         | Refresh, clear, fill, and navigate the subfile       |
| Display Logic       | Show subfiles, handle selections, process function keys |
| Indicators          | Control screen, paging, and flow throughout the code |

---

## **Key Takeaways for Onboarding Developers**

- The code is a standard subfile-driven inquiry program, with comprehensive handling of paging and user input.
- All core subfile mechanics are encapsulated in distinct subroutines.
- Indicator usage is systematic—refer to the indicator explanation and comments.
- Screen handling is tightly controlled using write/exfmt with indicators for visual state.
- Variable names and comments are in Norwegian; use the provided explanations for translation/context.
- The code uses fixed-format RPG IV (which may be less familiar to developers only versed in free format RPG).

---

### **Practical Hints**

- To change subfile page size, adjust the constant `c_sfil`.
- To add new fields to the display, update the display file and ensure subfile write logic is adjusted.
- To add validation or more complex selection, extend the `subfile` subroutine where the selection is handled.
- Debugging typically leverages indicators; understand which indicator means what before making changes.

---

**In essence:**  
This program implements a robust, standard IBM i subfile inquiry interface for invoice types, with full keyboard/navigation support and clear logic separation in subroutines for maintainability.