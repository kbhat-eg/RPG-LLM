# Overview

This program (RK651R) selects and processes customer ledger records in preparation for sending out payment reminders or inkasso (debt collection) notices. It reads a set of customer master records and then iterates over open transactions that meet specific criteria (e.g., overdue balances). The program also supports a two-pass selection logic if the parameter requests all open items, thereby including both overdue and non-overdue items. Finally, it cleans up any interim records that do not conform to the required conditions (e.g., negative amounts).

# Purpose and Domain Logic

1. **Payment Reminder / Inkasso Warning**  
   - The primary goal is to identify which customers and ledger items (transactions) should receive a payment reminder.  
   - It also handles certain business constraints such as excluding items already sent to collection or those marked as “reklamasjon” (complaints).

2. **Overdue Calculation**  
   - The code uses a “løpedager” (days to run past the due date) parameter to determine if a transaction is overdue relative to the current run date (w_kdat).  
   - Only overdue items are selected in the first pass, unless special parameters tell the system to include non-overdue items in a second pass.

3. **Multiple Passes for “All Items”**  
   - If the parameter “ppfor” equals “A,” the program performs two passes when it finds at least one overdue item for a customer. The second pass includes open items that are not yet overdue but should still be included in the final output based on the business rules.

4. **Restrictions and Filters**  
   - Customers with certain rentekoder (interest code, e.g., code 3) are excluded from the reminder routine, reflecting a business decision that these should not be purred (reminded).  
   - Balances that are zero or negative, or postings already flagged for inkasso, are excluded from selection.

# Main Files and Their Roles

1. **RKUNLU / RKUNL1**  
   - These files (with slightly different record formats) hold the primary customer master data. The program uses them to locate valid customers and apply filtering rules (e.g., categories, sales groups, and status flags).

2. **RKTRL1 / RKTRL9**  
   - These contain the customer ledger entries (open items). They are read to determine which transactions should be included in the reminder run.  
   - RKTRL9 is specifically used for the second pass in the case of parameter “A=all items.”

3. **RKWBPF**  
   - A work file (or “arbeidsfil”) that the program writes selected transaction records to. This file captures all the eligible overdue (or open) items that will eventually be processed or printed for the reminder or collection notice.

# Important Parameters and Fields

- **pknrf, pknrt**: Range of customer numbers to include.  
- **pkatf, pkatt**: Range of category codes.  
- **pself, pselt**: Range of sales group codes.  
- **ppfor**: Indicates which records to fetch:
  - “A” triggers an additional pass to fetch all open items (the second pass in subroutine beh_trans2).  
  - Otherwise, only first-pass overdue items are processed.  
- **ppbeh, ppunr**: Used to filter transactions based on the number of previous reminders (“antall purringer”). For instance, “<,” “>,” or “=” compare the actual number of reminders (rnantp) to the threshold (ppunr).  
- **w_fdat, w_kdat**: Dates used to compare against the transaction’s forfallsdato (due date) plus any grace days.  
- **rninko**: Flag that denotes if a transaction has already been sent to inkasso.  
- **rnrekl**: Flag for “reklamasjon” (complaint), which also excludes a transaction from reminders.

# Program Flow

1. **Initialize / Read Customer Records (RKUNLU)**  
   - Set a key list (rkunlu_key) and start reading the customer master.  
   - For each customer (loop controlled by indicator 61), the code checks:  
     - Whether the customer is valid for reminders (e.g., rentekode != 3).  
     - Whether the customer falls within the allowed number ranges (pknrf, pknrt), categories (pkatf, pkatt), and sales groups (pself, pselt).  
     - If these checks pass, the subroutine `BEH_TRANS` is called to gather overdue transactions.

2. **Subroutine BEH_TRANS (beh_trans)**  
   - Reads open items (RKTRL1). For each item:  
     - Ensures it is not sent to inkasso or marked with reklamasjon.  
     - Verifies that the item has a non-zero restbeløp (rnrest).  
     - Checks if the number of previous reminders (rnantp) is within the allowed range.  
     - Calculates the overdue date by adding plope days to rnfdat. If the due date is strictly after the current date (w_kdat), the item is skipped.  
     - Once an item is confirmed to be overdue, it is written to RKWBPF.  

3. **Second Pass (beh_trans2)**  
   - If ppfor = 'A' and the first pass found at least one overdue item for this customer, the program re-reads the ledger data (RKTRL9).  
   - This time it picks up any open items that are not yet overdue but are still valid for selection (same business filters, but ignoring the typical overdue check).  
   - Those items also get written to RKWBPF.

4. **Finalizing Customer**  
   - The net restbeløp (w_rest) for the customer is tallied. If w_rest is negative, the code sets a flag (rkpneg), which eventually leads to removing that record from RKWBPF in a later step.

5. **Cleanup (slett_trans)**  
   - After processing all customers, the program deletes any interim records from RKWBPF that have a negative balance flag (rkpneg = 'N').

6. **End of Program**  
   - Ends by setting *INLR = *ON, returning control back to the calling environment.

# Notable Design Choices

1. **Two-Pass Approach**  
   - The program's structure explicitly supports a two-pass selection process when “all” items must be included. This is triggered only if the first pass found overdue posts for that customer.  
   - This design ensures minimal overhead: it doesn’t automatically do the second pass unless there is a reason to.

2. **Timestamp and Counter**  
   - For each written record in the work file, the code updates a numeric counter (w_tell) and appends that counter into a timestamp field (rwtist). This is used for traceability, ensuring that each record written can be uniquely identified.

3. **Rentekode 3 Exclusion**  
   - The code has historically toggled how rentekode 3 is handled. In the latest logic (labeled as “6.12”), it explicitly excludes rentekode 3 from reminders. This ties to specific agreements (e.g., Mestergruppen) that do not allow certain interest codes to be purred.

4. **Deletion of Negative Balances**  
   - Any resulting record that calculates to a negative restbeløp is removed. This prevents incorrectly sending a reminder to a customer who should have a credit balance.

5. **Version Tagging**  
   - Comments marked with T5.40, R5.60, 6.10, 6.11, 6.12 reflect the ongoing versioning and changes in the business rules.

# Summary

RK651R focuses on extracting overdue (and optionally non-overdue) open items for customers who meet specific criteria, preparing them for payment reminders or inkasso warnings. The core logic lies in filtering out unwanted records (inkasso-flagged, zero or negative rest, certain rentekodes, and so on), then writing valid ledger items to a work file (RKWBPF). The second pass approach, triggered by parameter settings, demonstrates how the system handles mixed scenarios of overdue and non-overdue records under a single process. Finally, any contradictory records (negative amounts, etc.) are purged before the program ends.