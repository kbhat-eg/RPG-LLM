# RPG Program: FO674R – Printing of Invoice Journal

## High-Level Purpose

This RPG/400 program (FO674R) prints an invoice journal for a specified company, year, and invoice number interval. It does the following:
- Reads invoice headers and customer master files.
- Writes a report (journal) to an output printer file.
- Optionally, supports generating PDF output and archiving via spool management and XML/Jasper integration.
- Maintains and updates historical journal records.

---

## Source Organization

### Header Section

- **H/TITLE** and **H Specs**: Describes the program and sets decimal/date edit codes.
- **Change History**: Documents changes, versions, enhancements, and PDF/archiving support.

### File Definitions (F Specs)

- **SOHEL1/SOHELUR**: Invoice header files (current and historical).
- **RKUNL1**: Customer master file.
- **AFORL1**: Form register file.
- **FO674P**: Printer output file (with USROPN option for PDFs).

### Data Structures (D Specs)

- **DSPARM**: 32-byte inbound parameter block, parsed into subfields (company, year, invoice numbers, etc.).
- **LDA Fields**: Variables mapped to specific LDA positions for spool, archiving, user, etc.
- **PDF/Spool Variables**: For integration with IBM i spooling and Jasper/PDF routines.
- **Error Code/Data for APIs**: To interface with system APIs (e.g., `QSPRILSP`).
- **Other Work Fields**: For batch type, etc.

### Subroutine and Format Markers

- Listing and comments define "formats" for reporting (A1HDR, A1DET, T1TOT).

---

## Main Logic Flow (C Specs)

### Program Initialization

- **XSTRSR Subroutine**
  - Sets up working company/year/invoice keys from the parameter or LDA.
  - Gets next available journal number from the number register (`HNTNUM` subroutine).
  - Positions to the starting invoice header using a keyed SETLL/READ.
  - Writes the initial report heading.

- **Entry Parameters**
  - Reads 32 bytes for parameters (company, year, etc.), sets up working fields.

### Invoice Processing Loop

- Starts a `DOWEQ *OFF` loop, reading entries from `SOHEL1`.
- **Filters**: Selects only those for the given company/year and within the invoice number range.
- **Processing**:
  - **XAJOUR Subroutine**: Prepares data for printing—formats invoice and due dates, fetches customer name, sets up print fields, accumulates invoice totals. Updates the historical header if the entry is newly journaled.
  - **XPRINT Subroutine**: Writes invoice detail lines to the report. Handles page overflow via `XOVRFL` subroutine (writes new page heading).
- **EOF/Exit**: Writes final totals with the `T1TOT` format.

### PDF/Jasper Integration (if requested)

- If `l_poff = '1'` (PDF output is desired):
    - Finds the spool file generated (`spoolnbr` subroutine calls system API `QSPRILSP`).
    - Calls external program `AP620R` to generate XML for archiving/reporting.
    - Closes the print file.
    - Optionally launches browser preview (calls `AP621R`) if screen preview requested (`l_skje = '1'`).
    - Calls `AB710R` for batch/job maintenance.

---

## Key Subroutines

### HNTNUM: Retrieve Next Number from Number Register

- Calls external program `AS100R` to fetch next available journal number.
- Sets up code, type, and other fields before call.

### XAJOUR: Prepare Data For Print & Update Historical Header

- Formats dates, retrieves customer data, calculates totals.
- If the entry isn't already journaled (SOJOUR=0), marks it as journaled and updates its historical record.

### XPRINT: Output Invoice Line to Report

- Writes the invoice detail format (`A1DET`) to the printer.
- On page overflow, calls XOVRFL to write the page heading.

### XOVRFL: Page Overflow Handler

- Writes report heading (`A1HDR`) when the page overflows.

### spoolnbr: Acquire Spool File Information

- Calls IBM i API `QSPRILSP` to get information about the generated spool file.

### xml_create: Generate Report XML

- Sets up and calls program `AP620R` to convert spool data into XML for downstream PDF/Jasper processing.

### pdf_preview: Show PDF in Browser

- Optionally calls `AP621R` to launch a browser window for PDF preview if screen output is requested.

---

## Initialization Subroutine (*INZSR)

- Initializes variables, sets up KLISTs for keying related files (headers, customers, forms), and loads related form definitions.
- Maps entry parameters and LDA variables to work and report variables.
- Opens the optional PDF printer file if PDF output is requested.

---

## Comments and Naming Conventions

- **Norwegian/Scandinavian comments and variable names**:
    - "Faktura" = Invoice
    - "Journal" = Journal/Report
    - "Utskrift" = Print/Output
    - "Kunde" = Customer

- Extensive use of comments and version tracking for maintenance.

---

## External Programs/Files Used

- **AS100R**: Number register handler.
- **AP620R**: Generate XML for reports.
- **AP621R**: Launch PDF preview in browser.
- **AB710R**: End batch/job logic.

---

## Modernization Flags

- **6.10, 6.11, 6.20, 6.30**: Marked changes for each version/release, enabling maintenance tracking.
- **pdf**: Indicates code introduced for PDF and Jasper integration.

---

## Summary Table

| Section      | Purpose                                         |
|--------------|-------------------------------------------------|
| F Specs      | File definitions and output report              |
| D Specs      | Fields, data structures, parameter blocks       |
| Main Loop    | Runs through invoices, prints journal           |
| XAJOUR       | Prepares print data, updates history            |
| HNTNUM       | Gets next journal number                        |
| XPRINT/XOVRFL| Report output and page overflow                 |
| PDF Support  | Spool, XML, browser preview routines            |
| *INZSR       | Init variables, keys—entry and LDA mapping      |

---

## Onboarding Hints

- **To understand processing flow**: Start with the initialization (`*INZSR`), then see XSTRSR, and follow the main loop to the subroutines.
- **To add report fields**: Update subroutine XAJOUR and the related output formats.
- **PDF/Jasper-related changes** are behind the `pdf` flag; non-PDF workflows can ignore these sections.
- **Number register and archiving logic** is modularized in subroutines/calls to keep main logic clean.

---

For further onboarding, focus on the subroutines and the field mapping from parameters/LDA to the report output. This program is a classic batch RPG/400 report with extended support for electronic archiving and PDF output.