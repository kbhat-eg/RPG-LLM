# FO104R – Order Merge and Suffix Management

## Overview

This program, `FO104R`, is part of the ASOFAK system and is responsible for merging ("samkjøring") order suffix lines back into their base order. It also manages status indicators for orders being processed and updates related inventory and order tracking information. The program interacts with several files (order headers, order lines, inventory, status, and purchase order lines) and calls other programs for inventory and memo balance updates.

---

## Business Purpose

- **Merges order suffixes into their base order**: Used when orders have been split (suffixes) and need to be consolidated back to the original order.
- **Updates inventory and memo balances**: Ensures that stock and financial records are in sync with order changes.
- **Tracks order processing status**: Marks orders as in-process to prevent concurrent modifications.
- **Maintains referential integrity**: Updates purchase order lines to reflect new relationships after merging.

---

## Key Files and Relationships

- **Order Header (fohel1r/fohelur)**: Main and update access to order header records.
- **Order Lines (fodtl1r/fodtlur)**: Main and update access to order line records.
- **Purchase Order Lines (lodtlur)**: For updating linked purchase order lines when suffixes are merged.
- **Status Table (fstsl1r)**: Holds status information, e.g., for firm and system-wide flags.
- **Display File (fo104d)**: Workstation file for user interaction.

---

## Main Program Flow

1. **Initialization**
   - Receives base order number (`p_numm`) and suffix (`p_suff`) as parameters.
   - Loads firm number from the Local Data Area (LDA).
   - Reads status information for the firm.

2. **Mark Base Order as In Use**
   - Calls subroutine `xmerk_ord` to flag the base order as being processed (prevents concurrent changes).

3. **User Interaction**
   - Displays the merge screen and waits for user input.
   - If the user cancels, unflags the base order and exits.

4. **Validate Suffix Order**
   - Checks if the provided suffix order exists and is not already in use.
   - If not valid, sets error indicators and redisplays the screen.

5. **Mark Suffix Order as In Use**
   - Flags the suffix order as being processed.

6. **Merge Process (`xoppd_ord`)**
   - **Reverse Base Order Lines:** Negates quantities on the base order to "undo" them in preparation for the merge.
   - **Reverse Suffix Order Lines:** Same as above for the suffix order.
   - **Move Suffix Lines to Base Order:**
     - Finds the next available line number on the base order.
     - Moves each suffix line, updating line and suffix numbers.
     - If the line was linked to a purchase order, updates the reference in the purchase order line.
   - **Delete Suffix Order Header:** Removes the now-merged suffix order.
   - **Reapply Base Order Lines:** Re-adds all active lines to the base order.
   - **Update Memo Balance:** Calls external program `FO730R` for memo balance recalculation.

7. **Unmark Base Order as In Use**
   - Calls subroutine `xopph_ord` to clear the in-use flag.

8. **Exit**

---

## Subroutines

### `xmerk_ord` – Mark Order as In Use

- Calls external program `FO709R` to set the in-use flag.
- Updates the order header with the current user and timestamp.

### `xopph_ord` – Unmark Order as In Use

- Calls `FO709R` to clear the in-use flag.
- Updates the order header with the current user and timestamp.

### `xoppd_ord` – Merge Orders

- **Reverse (negate) all lines** in both base and suffix orders (calls `xtilbake` for each line).
- **Move suffix lines** to the base order, updating line numbers and references.
- **Update purchase order lines** if the merged line had a purchase order reference.
- **Delete the suffix order header**.
- **Reapply all lines** to the base order.
- **Call `FO730R`** to update memo balance.

### `xtilbake` – Inventory Update for Line

- Prepares a data structure with line and order info.
- Calls external program `VL001R` to update inventory based on the reversed line.

---

## Notable Design and Domain-Specific Details

- **Order Suffix Handling:** Suffixes represent split or partial orders. This program consolidates them, ensuring all links and references are updated.
- **Concurrency Control:** Orders are marked as "in use" during processing to prevent data corruption from parallel edits.
- **Inventory Synchronization:** Every change to order lines triggers an inventory update via a dedicated external program.
- **Purchase Order Line Integrity:** If an order line being merged was linked to a purchase order, the purchase order line is updated to reflect its new order and line number.
- **Memo Balance:** Memo (possibly credit or reservation) balances are recalculated after merging, ensuring financial data integrity.
- **Error Handling:** Uses indicator fields for error and warning signaling, following codebase conventions.

---

## Indicators Usage

- **LR:** End of program.
- **30:** Field protection on display.
- **31-79:** Error/warning indicators for screen and logic.
- **80-89:** Work indicators.
- **90-99:** File operation indicators (e.g., chain, read errors).

---

## External Program Calls

- **FO709R:** Sets or clears the "in use" flag on an order.
- **VL001R:** Processes inventory updates for order lines.
- **FO730R:** Updates memo balance for an order after merging.

---

## Data Structure Highlights

- **d_lrec:** A 128-byte structure for passing inventory update information to `VL001R`.
- **Local Data Area (LDA):** Used for retrieving firm, user, and workstation information.
- **Key Lists:** Defined for each physical file access pattern to ensure consistent and maintainable file operations.

---

## File and Record Locking

- Uses `chain`, `setll`, `reade`, and `readp` for precise record access and locking, ensuring transactional consistency during the merge.

---

## Version and Change Management

- Extensive version and change history in comments, reflecting continuous adaptation for business needs (e.g., new fields, expanded references, logic corrections).

---

## Summary

`FO104R` is a critical utility for managing the integrity of orders and their suffixes in the ASOFAK system. It ensures that merging operations are atomic, consistent, and reflected across all related data (inventory, purchase orders, and memo balances). The program follows established conventions for indicator usage, file access, and external integration, providing a robust foundation for order management in this domain.