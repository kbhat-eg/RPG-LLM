# FA931R – Bisnode Private Webservice Lookup Program

## Purpose and Overview

This program is part of the ASOFAK system and performs a private individual lookup against Bisnode’s web services. Its main responsibilities are:

- Lookup a person using their national identification number (personnummer)
- Receive and parse personal and scoring data via XML-based web service responses
- Populate output parameters with the person’s data and a calculated credit limit, based on business rules and values retrieved from a code register

This program is invoked with input/output parameters (primarily personnummer) and interacts with several external resources: IFS files, web services, a code register table, and other RPG programs.

## Main Flow

### 1. Initialization (`*inzsr`)

- **Parameter Handling**: Receives all necessary parameters via the *ENTRY PLIST.
- **Firm Information**: Reads company number and other context from the local data area.
- **Bisnode Counter**: Calls program `AS100R` to get a unique counter (likely for request correlation).
- **Bisnode Credentials**: Calls external program `CO402R` to fetch Bisnode login credentials for the current company. Credentials are parsed from a string returned in `co402_verdi2`.

### 2. Person Lookup – First Web Service Call (`PersonSok`)

**Preparation:**
- Builds three files for the web service request (params, headers, body) using HTML templates and the CGIDEV2 utility routines (`GetHTMLIFS`, `UpdHTMLVar`, `WrtSection`, `WrtHtmlToStmf`).
- Files are created in `/home/<company>/Bisnode/Bisnode_ws/PersonSok<numm>.*`

**Execution:**
- Calls web service via program `AW703C` with the constructed request files.
- Cleans up temporary files after the call.

**Response Handling:**
- Reads the response XML file and parses it into the `Personalia` data structure using `xml-into`.
- Extracts personal data fields (name, address, birthdate, etc.) for output parameters.

### 3. Person Info & Scoring – Second Web Service Call (`Personinfo`)

**Preparation:**
- Similar to the first call, builds request files for the second web service using templates.
- Inserts data from the first response (e.g., `Internref`, scoring model, etc.) into the request.

**Execution:**
- Calls web service via `AW703C`.
- Cleans up temporary files post-call.

**Response Handling:**
- Parses the response into the `Score` data structure.
- Extracts scoring and financial assessment data.

### 4. Credit Limit Calculation

- Converts the score to numeric (`w_scorn`).
- Fetches credit limit thresholds from table `ra33st` for type `PRIVAT` using embedded SQL.
- Applies business rules: for each threshold, if the score exceeds the threshold, assigns the corresponding credit limit to the output parameter `p_kgre`.
- If no thresholds are found, sets credit limit to zero.

### 5. Error Handling (`*pssr`)

- If any error occurs (e.g., person not found), sets all output parameters to blank/zero or a suitable error message and returns.

## Key Data Structures

- **Personalia (qualified DS):** Holds personal data parsed from the first web service response.
- **Score (qualified DS):** Holds scoring/credit assessment data from the second response.
- **Ligning (qualified DS):** Placeholder for future or alternate use (not used in current code).

## External Interactions

- **CGIDEV2 Utilities:** Used for HTML/XML template handling and IFS file operations.
- **AW703C:** Wrapper program for making HTTP web service requests.
- **CO402R:** Retrieves Bisnode login credentials for the current company.
- **AS100R:** Retrieves a unique sequence/counter for the request.
- **ra33st Table:** Holds credit scoring thresholds and limits, queried via embedded SQL.

## Business/Domain-Specific Logic

- **Credit Limit Assignment:** Business rules for credit limit assignment are driven by the `ra33st` code register. The credit limit is determined by the highest threshold exceeded by the person's score.
- **Template-Based Request Building:** All web service requests are constructed using HTML/XML templates, allowing for flexible updates to request formats without code changes.
- **Per-Company Context:** All file paths and credentials are dynamically determined based on the company context (from LDA).

## Notable Conventions and Design Decisions

- **IFS File Usage:** All web service interactions are mediated via IFS files. This is both for request construction and response parsing, reflecting a decoupled, file-based integration approach.
- **Template-Driven Requests:** Use of CGIDEV2 to manage template files for request/response handling, which allows business users or support staff to adjust request formats without code changes.
- **Separation of Web Service Calls:** The process is split into two distinct calls: first to identify the person and retrieve a reference, then to fetch scoring data using that reference.
- **Error Handling:** Centralized error routine (`*pssr`) ensures consistent output in case of failures.
- **SQL Integration:** Embedded SQL is used to fetch business rules (credit thresholds) rather than hardcoding them, allowing dynamic adjustment.

## Relationships with Other Modules

- **CGIDEV2/CGIDEV2 Binding Directory:** Provides access to utility routines for HTML/IFS handling.
- **CO402R and AS100R:** External RPG programs for credential and sequence management.
- **AW703C:** HTTP/web service client wrapper.
- **ra33st Table:** Central repository for credit scoring thresholds.

## Version History and Comments

- **8.01:** Removed splitting of first and last names.
- **8.02:** Introduced dynamic credit limit assignment based on codes in the `ra33st` code register.

## Summary Table of Key Variables

| Variable      | Purpose                                             |
|---------------|-----------------------------------------------------|
| `p_pnum`      | Input: Personnummer (national ID)                   |
| `p_navn`      | Output: Name                                        |
| `p_adr1`      | Output: Address line 1                              |
| `p_kgre`      | Output: Calculated credit limit                     |
| `w_usrk`/`w_pask` | Bisnode username/password (from CO402R)         |
| `w_numm`      | Unique request number (from AS100R)                 |
| `Personalia`  | DS: Person data from first WS response              |
| `Score`       | DS: Scoring/credit data from second WS response     |
| `w_ksc1..5` / `w_kgr1..5` | Thresholds and credit limits from ra33st|
| `XML_Output*` / `XML_Input` | IFS paths for WS request/response     |

---

## For New Developers

- **Do not modify the template files directly in code.** If changes to request/response formats are needed, update the templates in the IFS.
- **Credit thresholds and limits** are maintained in the `ra33st` table. Coordinate with business analysts before changing these.
- **When troubleshooting,** check the IFS request/response files and the logs from `AW703C` for web service call issues.
- **All external calls (CO402R, AS100R, AW703C)** are critical integration points; ensure these programs are available and up-to-date.

---

This program is a central part of our private customer credit assessment workflow and should be maintained with care to ensure compliance with both technical and business requirements.