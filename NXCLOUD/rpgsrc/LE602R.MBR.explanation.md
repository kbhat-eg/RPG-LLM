# RPG Program LE602R: "ASLAGR: Lagertelling" - Explanation

This RPG (Report Program Generator) program is designed to generate a stock count list (“telle-liste”) for a warehouse management system. It processes and filters inventory data according to provided parameters, and updates or creates records in a helper file for stock count printouts.

The program consists of several main blocks:

- **File Declarations**
- **Data Structure and Variable Definitions**
- **Main Logic (Processing Parameters, Filtering, and Output)**
- **Subroutines (key logic broken out for reusability and clarity)**
- **Initialization and Parameter Handling**

Below is a structured walkthrough and explanation.

---

## 1. File Declarations

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
fra10l1    if   e           k disk    rename(ra10pfr:ra10l1r)
flpstlu    uf a e           k disk    rename(lpstpfr:lpstlur)
...
```
- Data files are declared for items, warehouses, groups, helper registers, etc., with aliases for record formats.
- This program reads and writes to various logical and physical files.

---

## 2. Data Structures and Variable Definitions

### Parameter Data Structure

```rpg
d                 ds
d d_prec                       128
d  d_batc                       10    overlay(d_prec)
d  d_fvar                       15    overlay(d_prec:11)
...
```
- `d_prec` is a parameter buffer (128 bytes) split into individual fields via `overlay`. These correspond to selection criteria passed to the program (e.g., item number ranges, warehouse range, group codes, list options, etc.)

### Local Data Area

```rpg
d                uds
d l_wsid                901    910
d l_user                        10
d l_firm                944    946  0
```
- These refer to fields within the RPG User Data Area (UDA) for tracking user, firm, etc.

### Work and Helper Variables

Variables such as `w_opda`, `w_firm`, `w_vare`, `w_lage`, `w_anta`, etc., are used as working fields throughout the code.

---

## 3. Main Program Logic

### a. Processing Parameters

```rpg
c                   eval      d_prec = w_parm
...
c                   if        d_opda <> 0
c     *dmy          move      d_opda        w_opda
c                   endif
```
- The received parameter area is mapped into the structured fields, setting up the filter and selection criteria.
- If a date (`d_opda`) is provided, it is translated to an RPG date variable.

### b. Filtering and Navigating Master Data

```rpg
c                   eval      vvarl1_vare = d_fvar
c                   eval      w_vare = d_tvar
c     vvarl1_key    setll     vvarl1r
c                   read      vvarl1r                                90
c                   dow       *in90 = *off
```
- Starts reading the item register, beginning at the 'from' item number (`d_fvar`) up to the 'to' item number (`d_tvar`).

#### Per-item Filters

Each item read is subjected to several filters:
- Must match the firm number.
- Must fall within over group, main group, and subgroup bounds.
- Optional: Must match product manager/pans (if set).
- Optional: Must match supplier/leverandør (if set).

```rpg
c     pans_ok       tag
...
```
- "Pans" (product manager) selection checks involve chaining into various group master files to check for matching responsible personnel.

#### Per-item Actions

Depending on the `d_list` flag:
- `d_list=0`: All applicable warehouses are processed (`exsr lag_alle`).
- `d_list≠0`: Only existing warehouse records are processed (`exsr lag_finnes`).

After processing logic for the current item, the loop advances to the next item.

---

## 4. Subroutines

### a. `lag_tab` — Build Warehouse Table

```rpg
c     lag_tab       begsr
...
c                   eval      a_lage(*) = *blank
...
c                   dow       *in91 = *off and
c                             rajfir = w_firm and
c                             rajkod <= d_tlag
c                   move      rajkod        a_lage(w_ltel)
...
```
- Fills the `a_lage` array with warehouse codes to be included, based on the firm and selection bounds.

### b. `lag_alle` — Output Rows for All Warehouses

```rpg
c     lag_alle      begsr
...
c                   dow       a_lage(w_ltel) <> *blank
...
c     vlagl1_key    chain     vlagl1                             93
...
c                   call      'VL710R'
c                   parm                    w_firm
c                   parm                    vvvare
c                   parm                    vllage
c                   parm                    w_vtyp
...
c                   if        w_vtyp = 'T'
c                   goto      end_alle
c                   endif
...
c                   exsr      sorsub
c                   exsr      skriv_rad
...
```
- For each warehouse in `a_lage`, prepares/retrieves stock record, calls out to an external program to fetch item type, applies further filters, then writes (or updates) the helper file accordingly.
- Special logic skips certain item types ('T') or mismatched types.

### c. `lag_finnes` — Output Rows for Existing Warehouse Records

```rpg
c     lag_finnes    begsr
...
c                   read      vlagl1                                 94
c                   dow       *in94 = *off and
c                             vlfirm = w_firm and
c                             vlvare = vvvare and
c                             vllage <= d_tlag
...
```
- Only processes warehouses/items that exist in the warehouse file, otherwise similar to `lag_alle`.

### d. `skriv_rad` — Write/Update Helper File

```rpg
c     skriv_rad     begsr
...
c     lpstlu_key    chain     lpstlur                            92
...
c                   if        *in92 = *off
c                   update    lpstlur
c                   else
c                   eval      lzfirm = w_firm
c                   ...
c                   write     lpstlur
c                   endif
...
```
- Updates or inserts a record in the helper register based on whether a record already exists for the item/warehouse key.

### e. `sorsub` — Build Sort Key

```rpg
c     sorsub        begsr
...
c                   if        d_val3 = 1
c                   eval      w_sort = w_lag_alf + w_ogr_alf + ...
...
c                   if        d_val3 = 2
c                   eval      w_sort = w_lag_alf + w_ogr_alf + ... + vvtek1
...
```
- Constructs a 'sort key' (`w_sort`) based on selection — allowing the resulting report to be sorted in various ways (e.g., by warehouse, group, item, text, etc.).

---

## 5. Initialization and Parameter Entry

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    w_parm
...
c                   eval      w_firm = l_firm
c                   endsr
```
- The initialization routine sets up key lists (for keyed database access), receives the parameter structure from the caller, and sets the working firm number from the user data area.

---

## 6. Special Notes

- **Versioning Comments:** The top of the source lists version numbers and change descriptions related to program enhancements and bugfixes.
- **External Program Call:** The call to `'VL710R'` fetches detailed information (such as item type) for each item/warehouse.
- **Sorting Logic:** Multiple sort orders can be selected (by parameter), affecting how the resulting list is structured.

---

## 7. Program Flow Summary

1. **Start/Initialize:** The program receives parameters and initializes key lists.
2. **Filter Items:** For each item fitting the parameters, it checks group/supplier filters.
3. **Iterate Warehouses:** For each item, either:
    - Loop through all configured warehouses, or
    - Process only warehouses where item exists.
4. **Type & Place Filters:** Additional selection on item type and warehouse position.
5. **Sort & Output:** Compute sort key and write/update stock count helper file.
6. **Loop:** Continue until all items in the range have been processed.
7. **Exit:** Program ends, setting the LR (last record) indicator.

---

## 8. Key Concepts
- **Parameter-driven Filtering:** Report output is highly parameterized for flexible ad-hoc lists.
- **Multi-level Group Filtering:** Supports over group, main group, subgroup selection.
- **Flexible Output:** Can list all possible combinations or just existing stock, per flag.
- **External Data Retrieval:** Uses external program for up-to-date item/warehouse information.
- **Sort Key Construction:** Dynamic sort keys allow diverse output sort orders.

---

## 9. Intended Use and Customization

This program is designed for warehouse personnel or support programs to generate picking/counting lists according to many possible business rules, and can be adapted further as business needs change. Versioning comments and modular subroutine design enable easier maintenance and targeted enhancements.