# JW507R - Select Item Supplier (Velg vare leverandør)

## Overview

This program (`JW507R`) is an interactive RPG application designed to allow a user to select a supplier for an item (vare leverandør) via a subfile-based interface. The program is part of the ASOFAK system and manages the display, navigation, and selection of supplier records, using subfiles for paging and selection, and integrates with two physical files: `JLEV` (supplier master) and `JVLE` (supplier/item cross-reference).

The code is heavily commented in Norwegian, and follows established conventions for subfile handling, function key management, and indicator usage within this codebase.

---

## Main Files and Relationships

- **JLEV**: Supplier master file, renamed as `JLEVL1` in this program.
- **JVLE**: Supplier/item cross-reference file, renamed as `JVLEL1` in this program.
- **JW507D**: Display file, includes subfile (`B1SFL`), control record (`B2CTL`), and a command screen (`B2CMD`).

The program reads from `JVLE` to list suppliers for a given item and uses `JLEV` to fetch supplier names for display.

---

## Key Data Structures and Variables

- **Parameters**: 
  - `p_firm`, `p_lvnr`, `p_ldor` – passed in at program start. Represent company, supplier number, and supplier/order number.
- **Display File Feedback (INFDS)**: 
  - `dspfbk` is used to retrieve cursor position and other display feedback.
- **Subfile Variables**: 
  - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` – manage subfile paging, current/first/last record numbers.
- **Subfile Constants**: 
  - `c_sfil` (8) – subfile page size (number of records per page).
- **Selection and State**: 
  - `b_valg_ok` – flag set when a selection is made.
  - `w_lvnr`, `w_ldor`, `s_ldor` – working variables for current supplier/item.

---

## Indicators Usage

- **LR**: End of program.
- **Function keys**: 
  - 10 (Roll), 11 (Rolldown), 12/13/14/15 (Subfile display/clear/end), 21 (Home).
- **22**: Cursor positioning.
- **31-79**: Warnings, messages.
- **80-99**: Work indicators.

These are used per the standard for subfile navigation and screen control in this application suite.

---

## Program Flow

### 1. Program Initialization (`*INZSR`)

- Receives parameters for company, supplier number, and supplier/order number.
- Initializes key-lists for file positioning.
- Sets up the subfile for the initial supplier/item.
- Loads the first page of the subfile.

### 2. Main Processing Loop

- The program alternates between displaying the command screen (`B2CMD`) and the subfile list (`B1SFL/B2CTL`).
- User actions (function keys) are handled via a `SELECT` block:
  - **Exit (Cancel/Home)**: Ends program.
  - **Refresh (F5)**: Calls `forny` to refresh subfile.
  - **Page Down (F10)**: Calls `crt_subfile` to load next page.
  - **Page Up (F11)**: Calls `bck_subfile` to load previous page.
  - **Home (F21)**: Sets indicator 22 for cursor positioning.

- If a supplier/order number is entered, the program positions (`posisjoner`) to that record.

### 3. Subfile Handling

- **Display (`dsp_subfile`)**: Manages the display of the subfile and control record, handles cursor position feedback.
- **Clear (`clr_subfile`)**: Clears the subfile and resets counters.
- **Create (`crt_subfile`)**: Reads the next set of records from `JVLE` (cross-reference), fetches supplier names from `JLEV`, and writes them to the subfile. Handles end-of-file and page limits.
- **Back (`bck_subfile`)**: Reads the prior page of records, repositions the file, and reloads the subfile.
- **Process (`subfile`)**: Reads changed subfile records, checks for selection, and sets return values.

---

## Subroutine Details

### `forny`
Refreshes the subfile based on current position, repositions the file, clears and reloads the subfile.

### `posisjoner`
Positions the subfile to a specific supplier/order number, clears and reloads the subfile, and resets the position field.

### `subfile`
Handles user interaction with the subfile. Reads changed records, checks for selection (`b1valg = 1`), and if selected, sets the return value and exit flag.

### `clr_subfile`
Clears the subfile and resets all paging counters and indicators.

### `crt_subfile`
Fills the subfile with the next page of supplier records:
- Reads from `JVLE` (cross-reference) for the current supplier.
- For each record, fetches the supplier name from `JLEV`.
- Handles end-of-file and page size limits.

### `bck_subfile`
Loads the previous page of the subfile:
- Reads backwards in `JVLE`.
- Handles repositioning and subfile clearing/filling.

### `dsp_subfile`
Displays the subfile or command screen as appropriate, manages display indicators, and updates the current record number from the display feedback area.

---

## Design Patterns & Conventions

- **Subfile Paging**: Uses standard IBM i subfile paging logic (clear, fill, display, next/previous page).
- **Indicator Management**: Follows codebase conventions for indicator assignment (see comments).
- **Key Lists**: Uses named key lists for file access and positioning, improving maintainability.
- **Display Feedback**: Utilizes the INFDS structure for cursor management and feedback from the display file.
- **Modularity**: Major operations are encapsulated in subroutines, facilitating reuse and clarity.

---

## Integration Points

- **Files**: Reads from `JVLE` (item/supplier cross-ref) and `JLEV` (supplier master).
- **Display File**: `JW507D` with subfile and control records.
- **Parameters**: Receives values from calling program or process, enabling integration into broader workflows.

---

## Business Logic

- **Purpose**: To allow users to select a supplier for an item, supporting paging, direct positioning, and selection via a subfile interface.
- **Selection**: When a user selects a record, the program returns the selected supplier/order number.
- **Paging**: Supports both forward and backward paging through subfile records.
- **Positioning**: Allows direct positioning to a specific supplier/order number.

---

## Key Takeaways for New Developers

- The program is a standard subfile selection interface, tailored for supplier selection.
- All subfile and function-key logic follows established conventions in this codebase.
- Be aware of the Norwegian field and comment names; business logic is closely tied to supplier and item management.
- The program expects to be called with parameters and returns a selected value via the parameter list.
- Extensions or maintenance should preserve the integrity of subfile paging, indicator usage, and file positioning logic.

---

## References

- **ASOFAK System Documentation**: For business context and data model.
- **Display File (JW507D)**: For screen layout and subfile definitions.
- **Physical Files (JLEV, JVLE)**: For field definitions and relationships.