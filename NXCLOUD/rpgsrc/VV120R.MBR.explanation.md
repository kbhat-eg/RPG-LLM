# Explanation of RPG Source Code for Program VV120R

## Overview

The given code is an IBM ILE RPG (RPG IV - fixed-format) program for alternative item maintenance (*Alternativ vare, vedlikehold*). It manages a subfile-based interactive display for handling alternative items (likely in an inventory or product context). The code is structured using subroutines, file I/O for physical files, and screens (workstn, subfile handling).

The code is commented in Norwegian; this explanation will clarify structure, logic, and intent for onboarding developers.

---

## 1. **Header & Documentation**

- **`h option(*nodebugio) datedit(*dmy)`**  
  - Compile options: No debug for I/O, and date editing is *day/month/year*.
- Program documentation includes system, program ID (`VV120R`), description, and change log.

---

## 2. **Indicator Usage**

- RPG indicators (`*INxx`) are mapped to screen and logic functions:
  - e.g. LR: end of program, 10: Roll, 13: Subfile control, 14: Clear subfile, etc.

---

## 3. **File Declarations**

```rpg
fvvaal1    if e k disk    rename(vvaapfr:vvaal1r)
fvvaalr    if e k disk    rename(vvaapfr:vvaalrr)
fvvaalu    uf e k disk    rename(vvaapfr:vvaalur)
fvvarl1    if e k disk    rename(vvarpfr:vvarl1r)
fvv120d    cf e workstn sfile(b1sfl:w_srrn) infds(dspfbk)
```
- `vvaal1`, `vvaalr`, `vvaalu`, `vvarl1`: Physical files for item data, alternative items, etc.
- `vv120d`: Display file with SFL (subfile) `b1sfl` controlled by record number `w_srrn`.  
- `infds(dspfbk)`: Info data structure for display feedback.

---

## 4. **Data Structures & Variables**

- **LDA (Local Data Area) mapping:**  
  - `l_user`, `l_firm`, `l_fnav` (user, firm, navigation info).

- **Display Feedback Structure:**  
  - `dspfbk` holds cursor location, etc.

- **Key Variables:**  
  - For handling composite keys in file access.

- **Working Variables:**  
  - Record counters, flags, buffers for subfile processing.

- **Constants:**  
  - E.g., `c_sfil = 13` for subfile page size.

---

## 5. **Subfile Concepts and Screen Layouts**

- Comments explain subfile variables:
  - `w_fcrn` (First rec. on page), `w_stel` (Subfile counter), `w_spge` (Page size), etc.
- Screen layouts describe what `B1SFL`, `B2CTL`, `C1BLD`, etc. are used for.

---

## 6. **Main Control Flow**

### a. Opening Screen / Main Loop

- **Initial Write:**  
  - `write b2cmd`
- **Display the Subfile:**  
  - `exsr dsp_subfile`
- **Key Handling (Function Keys):**  
  - *Select* statement dispatches logic based on function keys (e.g., F3 to exit, F5 for refresh, page up/down, insert).

### b. Subfile Positioning

- If `b2anob` (Nobbnr field) is entered, position database and display accordingly.

### c. Subfile Handling

- `exsr subfile` processes the subfile for possible row-level actions (edit, delete, view).

---

## 7. **Subroutines**

### a. `forny` (Refresh Subfile)
- If positioned, re-chain to the correct record, reset keys, clear, and refill the subfile.

### b. `posisjoner` (Positioning by Key)
- Position to a specific "Nobbnr" (`b2anob`), clear subfile, refill.

### c. `subfile` (Subfile Row Handling)
- Loop through displayed subfile rows (`readc b1sfl`):
  - `b1valg = 2`: Edit row (`endre`)
  - `b1valg = 4`: Delete row (`xd1win`)
  - `b1valg = 5`: View row (call `VV521R`)
- Refreshes subfile if needed.

### d. `xc1bld` (Add New Row)
- Handles dialog for adding new rows (screen `C1BLD`).
- Checks for key uniqueness before creating.
- Calls maintenance program `VV121R` for insert.

### e. `xc1msg` (Show Row Exists Message)
- Shows an override/information message if trying to add a duplicate key.

### f. `xd1win` (Delete Row)
- Confirms deletion via dialog (`D1WIN`).
- Deletes all instances of a row from the corresponding file.

### g. `clr_subfile` (Clear Subfile)
- Turns on clear indicator, writes control record, resets counters, and state variables.

### h. `crt_subfile` (Create/Populate Subfile)
- Reads through the item file (`vvaal1`), adds rows to subfile until page is full.
- For each item, loads up to 7 alternative items into the subfile's columns from `vvaalr`.

### i. `bck_subfile` (Page Back Subfile)
- Backs up one page in the file using the `readp` operation (read previous).
- Recreates the subfile to show the previous page.

### j. `dsp_subfile` (Display Subfile)
- Determines whether to show subfile or just the function key screen if subfile is empty.

### k. `spørring` (Inquiry)
- Handles pop-up search using another program (`VV500R`) for field values (`B2ANOB` or `C1ANOB`), positions accordingly.

### l. `endre` (Edit/Update Row)
- Calls maintenance program `VV121R`.
- Reloads the subfile row with up-to-date data from file.

### m. `*inzsr` (Initialization Subroutine)
- Builds key lists for file access.
- Loads default "firm" from LDA.
- Initializes subfile to beginning.

---

## 8. **Key Lists (`klist`)**

- Used for composite key access (e.g., `w_firm` and an item number).
- Key lists are defined for each file access pattern.

---

## 9. **Program End**

- Branches to `avslutt`: sets LR indicator to *on (program end), returns.

---

## 10. **Notable Patterns & Best Practices**

- **Subfile handling** is robust and classic for RPG:
  - Uses readc for changed records, paging logic, clear/fill subfile routines.
- **Screen modularity:**  
  - Distinct records used for subfile, pop-ups, command screens.
- **Dialog/Confirmation:**  
  - Insert and delete are both confirmed via dedicated subroutines/dialog screens.
- **Key validation:**  
  - Prevents duplicate keys and confirms with user if row exists.
- **Separation of concerns:**  
  - Maintenance programs (`VV121R`, `VV521R`) are called for actual edits/displays, keeping this program's focus on navigation/display.

---

## 11. **Summary Table of Main Elements**

| Section        | Purpose                                                                                      |
|----------------|---------------------------------------------------------------------------------------------|
| File/F Spec    | Declares files, display, and subfile functionality                                          |
| Data defs (D)  | Variables for key, display, subfile control, and info structures                            |
| Main loop      | Repeatedly shows subfile, processes key presses, dispatches to subroutines                  |
| Subroutines    | Modularize subfile operations: clear, fill, refresh, page, edit, delete, insert             |
| Key lists      | Define composite keys for file lookups                                                      |

---

## 12. **Onboarding Tips**

- **Subfile operations** are central. Familiarize yourself with how indicators (like *IN14, *IN15, *IN12, etc.) control the display and page logic.
- **File structure** (what each file and its fields mean) will be crucial; ask for the file and display file descriptions (DDS).
- **Programs called** (`VV121R`, `VV521R`, `VV500R`) handle core create/read/update/delete logic for items—these are important for understanding data flow.
- **Error handling/user messages** are filtered via indicators and controlled pop-up/message screens.

---

## 13. **Glossary**

- **Nobbnr:** Likely a unique item number (Norwegian: Norsk Byggevarebase, but generalized as item number here).
- **Subfile:** A way to display a scrollable list/table on IBM i screens.
- **DDS:** Display File Description, RPG's way to describe UI.
- **LDA:** Local Data Area—a special memory area in IBM i jobs often used for user/session context.

---

**In summary:**  
This is a classic subfile maintenance program in RPG IV with modular subroutine structure, robust key/navigation handling, and clear separation between display logic and backend maintenance routines. Reading and updating the alternative items is done via the subfile and confirmed by specific dialogs, in keeping with IBM i UI traditions.