# Overview

This ILE RPG III program (SR151R) is part of the "ASSTAT" system and deals with the maintenance ("Utvalg Ordretype" = "Selection Order Type") of order types via a subfile-based display. The code manages adding, changing, displaying, and deleting records representing order types, using multiple physical and logical files, and provides a standard 5250 green screen interface for operators.

Below is a breakdown of the main structural elements, the key routines, and how data is managed:

---

## 1. **File Declarations**

```rpg
fSR151d    cf   e             workstn sfile(b1sfl:w_srrn)
fslpml1    if   e           k disk    rename(slpmpfr:slpml1r)
fslpmlr    if   e           k disk    rename(slpmpfr:slpmlrr)
fslpmlu    uf a e           k disk    rename(slpmpfr:slpmlur)
fvotyl1    if   e           k disk    rename(votypfr:votyp1r)
```

- **SR151d**: Display device with subfile `b1sfl`, record number in `w_srrn`.
- **slpml1, slpmlr, slpmlu**: Logical/physical files for main, read, and update access to order type records, renamed for clarity.
- **votyl1**: File to validate or fetch order type names.

---

## 2. **Key Variable Declarations**

Variables are declared for use as file keys, mimicking record format fields, and program work variables, e.g.:

```rpg
d slpml1_type     s                   like(srtype)
...
d w_spge          s              4  0
...
d b_forn          s              1    inz(*off)
...
d w_firm          s                   like(srfirm)
```

- `w_firm`, `wptype`, `wpkode`, etc., are used to hold the "firm", "order type", and "code" values.
- `b_forn`: Flag indicating whether data should be refreshed/rebuilt.
- `w_spge`, `w_srrn`, etc.: Subfile management counters (page, relative record, etc.).

---

## 3. **Local Data Area**

```rpg
d                uds
d dsuser                911    920
d dsfirm                944    946  0
d l_fnav                951    980
```

- The program uses the LDA (Local Data Area) for session-specific data (e.g., firm number).

---

## 4. **Main Control Flow**

The main transaction loop alternates between:
- writing screens (`write b2cmd`)
- populating the subfile (`exsr dsp_subfile`)
- handling function keys and actions (add, delete, position, refresh).

**Function Key Handling Example:**
```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inke
c                   exsr      forny
c                   goto      b2tagb
...
c                   endsl
```
- *inkc/inkl*: Exit
- *inke*: Refresh subfile
- *inkf*: Add new row
- *in10*: Refresh (??)
- *in21*: Toggle function

---

## 5. **Subroutines**

### a. **forny (Renew/Refresh subfile)**

- Sets file position with `setll`, clears and recreates the subfile.

### b. **posisjoner (Position in subfile)**

- Positions records in the subfile by key, then clears and rebuilds it for user-defined starting point.

### c. **control**

- Central logic for handling function key actions, including:
    - Adding (`b2valg='1'`)
    - Deleting (`b2valg='4'`)
    - Key validation

### d. **subfile**

- Loops through visible subfile records, handling deletes and updating relevant flags.

### e. **xc1bld / xc2bld**

- Manages the display and input of new/change screens:
  - `xc1bld`: Handles add operation, checks if already exists.
  - `xc2bld`: Handles the change/display/update of a record.

### f. **xd1win**

- Handles "delete" confirmation and process.

### g. **clr_subfile / crt_subfile**

- **clr_subfile**: Flags subfile for "clear", resets counters.
- **crt_subfile**: Reads database, adds records to the subfile up to a pageful.

### h. **dsp_subfile**

- Displays the subfile if not empty; otherwise shows a command screen.

### i. **\*inzsr (Initialization)**

- Sets up key lists for file access.
- Receives parameters.
- Sets initial state and primes the subfile.

---

## 6. **Data Flow and Logic**

- Data is loaded into the subfile from the database for display.
- User actions (add/change/delete) are handled with subroutines, updating the main file as appropriate.
- Flag variables are heavily used to control program flow.
- Validation and display logic ensures that user actions are confirmed or result in error messages (e.g. duplicate add).

---

## 7. **General Comments / Best Practices**

- **KLIST/KFLD**: For key lists to simplify access to files.
- **Parameter Passing**: *ENTRY PLIST for program call params.
- **Display File**: Standard subfile pattern, including subfile control record.
- **Flag Variables**: Used for enabling/disabling options, controlling actions.
- **Record Level Access**: Uses `chain`, `setll`, `read`, etc. for ISAM access.

---

## 8. **Typical Use Case (Operatorâ€™s Perspective)**

- Operator selects/manages order types from a list: add, change, or delete.
- Subfile lists existing keys; navigation and positioning is supported.
- Actions are confirmed and validated with feedback screens as needed.
- The UI is green-screen, menu-driven (using programmed function keys).

---

## 9. **File Relationships**

- **slpml1**: Main logical for displaying/reading order types.
- **slpmlr**: For checking existence/validation.
- **slpmlu**: For updating/deleting.
- **votyl1**: Auxiliary file for order type labels.

---

## 10. **Initialization**

On program start, the *inzsr subroutine:
- Receives parameters (type, descriptive text).
- Sets up key values.
- Reads the firm number from LDA.
- Prepares the subfile for the operator.

---

# Summary Table

| Routine        | Purpose                                       |
|----------------|-----------------------------------------------|
| *inzsr         | Initialization, parameter input, subfile fill |
| forny          | Refresh/renew subfile contents                |
| posisjoner     | Position the subfile to a specific entry      |
| control        | Central action handler (add/delete)           |
| subfile        | Loop through subfile records, handle updates  |
| xc1bld         | Handle add new entry (with exist check)       |
| xc2bld         | Update/change entry                           |
| xd1win         | Confirmation and execution of delete          |
| clr_subfile    | Clear subfile (remove all records)            |
| crt_subfile    | Populate subfile from database                |
| dsp_subfile    | Display subfile or command screen             |

---

# Summary

This program is a classic ILE RPG green screen application for administering order types via a subfile interface. It incorporates logic for paging, adding, deleting, validation, and subfile management, with clean separation of business logic into subroutines. Mastery of such programs is essential for maintaining and extending IBM i (AS/400) legacy applications.