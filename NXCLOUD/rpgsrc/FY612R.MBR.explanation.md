# Explanation of RPG Source Code: "Utskrift av Ordre-slettet-liste" (Print Deleted Orders List)

This RPG program (FY612R) is designed to produce a report listing deleted sales orders for a company. The code is written in fixed-format RPG (RPG III/400-style) and processes physical files for customers, status, and deleted orders, then prints out relevant details.

---

## High-level Overview

- **Purpose:** List deleted orders (Ordre-slettet-liste) for a given company (firma), with filtering by order types, and print totals.
- **Input:** Disk files containing customers, status, deleted orders, parameters from another program (via *ENTRY PLIST).
- **Output:** Printed report (via printer file FFY612P).
- **Features:** 
  - Reads parameters (e.g., order types, firm) from previous program
  - Gets new list number from a numbering register if required
  - Filters by order type if specified
  - Retrieves customer names for orders
  - Updates order status to indicate they've been printed
  - Sums totals for report footer

---

## Source Code Walkthrough

### 1. **File Declarations**

```rpg
Frkunl1    IF   E           K DISK
F                                     RENAME(RKUNPFR:rkunl1r)
FFSTSL1    IF   E           K DISK
F                                     RENAME(FSTSPFR:FSTSL1R)
FFDELL1    IF   E           K DISK
F                                     RENAME(FDELPFR:FDELL1R)
FFDELLU    UF   E           K DISK
F                                     RENAME(FDELPFR:FDELLUR)
FFY612P    O    E             PRINTER
```

- **Files**:
  - `rkunl1r`: Customer file (RKUNPFR)
  - `FSTSL1R`: Status code file (FSTSPFR)
  - `FDELL1R`: Deleted orders file (FDELPFR) — main file being read
  - `FDELLUR`: Deleted orders update file (same as above, updated)
  - `FFY612P`: Printer file for report output

---

### 2. **Data Structures and Parameters**

```rpg
D                 DS
D  LDPREC                 1     64
D  LDVAL1                 1      1  0
D  LDOTY1                 2      3
D  LDOTY2                 4      5
D  LDOTY3                 6      7
D  LDOTY4                 8      9
D  LDOTY5                10     11
D  LDOTY6                12     13
```
- **LDPREC:** Holds input parameters (probably passed from a previous program).
- **LDVAL1:** Process control flag (e.g., if 1, get new list number).
- **LDOTY1-6:** Order types to include (blank = include all).

```rpg
D                UDS
d l_user                911    920
D  DSFIRM               944    946  0
D  l_fnav               951    980
```
- **User Data Structure (UDS):** Holds user code (`l_user`), firm (`DSFIRM`), and possibly the user's name (`l_fnav`).

---

### 3. **Initialization & Parameter Handling (`*INZSR`)**

- **Clears parameter fields and sets up key variables (e.g., firm code for keys).**
- **Populates parameters from *ENTRY PLIST, moving values into program structures.**
- **Reads status codes for the relevant firm.**

---

### 4. **Retrieving List Number**

```rpg
C     LDVAL1        IFEQ      1
C                   MOVE      *ZERO         WSNUMM
C                   MOVE      '0'           WSKODE
C                   EXSR      HNTNUM
C                   MOVE      WSNUMM        D1LIST
C                   ENDIF
```

- **If `LDVAL1 = 1`, the program needs a new "SLETTE-LISTE" (deleted-list) number:**
  - Calls subroutine `HNTNUM` to retrieve a unique list number from the numbering register (`AS100R`).
  - Stores the number in `D1LIST` for use in the report.

---

### 5. **Main Processing Loop**

1. **Writes Page Heading**
    ```rpg
    C                   WRITE     A1HDR
    ```
2. **Reads Deleted Order File**
    ```rpg
    C     DELKEY        SETLL     FDELL1
    C                   READ      FDELL1                                 15
    C     *IN15         DOWEQ     '0'
    ```
    - Sets a starting position using a key list (`DELKEY`), then reads records in a loop until end-of-file.

3. **For Each Deleted Order:**
   - **Skips if already printed (`FYPRTK IFNE 1`)**
   - **Checks Order Type Filter:**
     - If all order type selection parameters are blank, include all (`GOTO XTAG01`).
     - Else only proceed if `FYOTYP` matches any `LDOTY1-6`; otherwise, skip record (`GOTO XTAG02`).

   - **Fetches Customer Name:**
     - Moves customer number from order to customer key, `CHAIN` fetches from customer master.
     - `D1NAVN` is filled with the customer name for the report.

   - **Marks Record as Printed:**
     - If initial run (`LDVAL1=1`), updates order record with firm, year, number, suffix, and sets as printed.
     - Writes audit information (`fyeusr`, `fyedat`, `fyetim`).

   - **Date and Time Formatting:**
     - Converts internal (packed?) date/time to report format if not low-value.

   - **Totals Calculation:**
     - Subtracts and sums up order values for total fields.

   - **Prints Detail Line**
     - Writes the detail format (`WRITE D1DET`).
     - If page overflow (`*IN30`), prints new report header.

   - **Reads Next Record**

4. **Completes List**
    - After the loop, writes total line (`WRITE T1TOT`).
    - Branches to program end.

---

### 6. **Number Register Subroutine (`HNTNUM`)**

- Initializes local work variables.
- Calls program `'AS100R'` (external) to retrieve the next available list number.
- The result is stored in `WSNUMM` (moved earlier to `D1LIST`).

---

### 7. **Report Layouts / Formats**

The code refers to three output formats (not shown in the code):
- **A1HDR:** Report headings (top of each page)
- **D1DET:** Detail line with order info
- **T1TOT:** Totals footer

---

### 8. **Key Lists**

The program uses multiple key lists for efficient indexed reads:
- **KUNKEY:** For customer file
- **STSKEY:** For status file
- **DELKEY:** For deleted order file (based on firm/year/number/suffix)

---

### 9. **Program Entry & End**

- **Program starts via *ENTRY PLIST** (parameters from prior program).
- **Ends via SETON LR** — marks last record, prepares for program termination/cleanup.

---

## **Summary for New Developers**

- **Main goal:** Print a list of deleted orders, with details and totals, filtered by parameters, and mark orders as reported.
- **Files:** Reads customers, statuses, and deleted orders; updates deleted orders to flag as reported/printed.
- **Parameters:** Get selection criteria (order types, firm, etc.) from a prior invoked program.
- **Key logic:**
    - Fetches and prints only relevant orders (by type/firm)
    - Marks processed orders to avoid re-reporting
    - Totals order values and prints a summary at the end
- **Standard RPG fixed-format design:** Extensive use of C-specs, key lists, data structures, and externally described files.
- **Important to understand:** 
    - How parameters are passed and used
    - The structure and purpose of each file
    - The report printing logic (header, details, totals, page overflow)
    - The update mechanism for marking orders as printed

---

## **Typical Onboarding Tasks**

- **Understand the record layouts** for files referenced (customer, status, deleted order, etc.)
- **Review the printer file layout** (formats A1HDR, D1DET, T1TOT) to see what information appears in the report.
- **Check the numbering service** (`AS100R`), as it’s essential for unique list sequencing.
- **Trace the program flow** to see how parameters propagate from the *ENTRY PLIST to data selection logic.

If you have a specific area or statement you want more information on, ask and I can elaborate!