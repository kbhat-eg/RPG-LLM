# Code Explanation: FX785R – Routine Register Conversion

## Overview

This RPG III program (FX785R) is part of the ASOFAK system. Its purpose is to **process and update a "routine register" file** as part of a data conversion. It reads through the file, applies specific conversion or update rules to certain records, and writes the changes back to the file.

---

## File Declarations

```rpg
faforlu    uf   e           k disk    rename(aforpfr:aforlur)
```
- **faforlu**: File name used in the program.
- **uf e k disk**: Update-capable, externally described, keyed file, disk-resident.
- **rename(aforpfr:aforlur)**: The external format `aforpfr` is renamed to `aforlur` inside the program for easier reference.

---

## Main Program Logic

### File Processing Loop

```rpg
c                   read      aforlur                                90
c                   dow       *in90 = *off
   ...
c                   read      aforlur                                90
c                   enddo
```
- **read aforlur 90**: Reads the next record from the file `aforlur`. If EOF, indicator 90 is set on.
- **dow *in90 = *off**: Loop continues until EOF (i.e., while not at the end of the file).

---

### Select and Update Logic

Within the loop over records:

```rpg
c                   select
c                   when      afruti = 'FTILB'
c                   eval      afacpi = 15
...
c                   endsl
```
- **select/when/endsl**: RPG III branching, similar to a switch/case.
- **afruti**: A field in the record (likely indicating a routine type or code).
- **afacpi**: A field in the record (likely a processing code, status, or category).

#### Two Main Kinds of Logic:

1. **Set `afacpi = 15` for Certain Routine Codes**  
   If `afruti` equals any of:
   - 'FTILB', 'FOBEK', 'FPLUKK', 'FPAKK', 'FPAKKNEG', 'FBEST', 'BPLUKK', 'BPAKK', 'BPAKKNEG'
   then set `afacpi` field to 15.

2. **Convert Routine Code (`afruti`) to a New Value**
   For specific values of `afruti`, set it to a new value. Sometimes, also set `afacpi = 15`.
   - 'FP651'  → 'FH601'
   - 'FO202'  → 'FR612'
   - 'FO204'  → 'FR602'
   - 'FO206'  → 'FR604'
   - 'FO221'  → 'VG601' and set `afacpi = 15`
   - 'FP601'  → 'VP601'
   - 'FP612'  → 'VP612'
   - 'FV603'  → 'VV603'
   - 'FV605'  → 'VV605'
   - 'FV611'  → 'VV611'
   - 'FV621'  → 'VV621'
   - 'FV651'  → 'VT601'

---

### Write Updates

```rpg
c                   update    aforlur
```
After applying the changes (if any), the updated record is written back to the file.

---

## Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- ***inlr = *on**: Turns on the "last record" indicator, which triggers program termination and closes files.
- **return**: Exits the program.

---

## Special Section: Initialization Subroutine

```rpg
c     *inzsr        begsr
c                   endsr
```
- **INZSR**: This is a special subroutine that runs automatically when the program starts. In this code, it is empty.

---

## Summary Table of Routine Code Conversion

| Original `afruti` | New `afruti` | Set `afacpi` = 15 |
|-------------------|--------------|-------------------|
| FTILB             | -            | Yes               |
| FOBEK             | -            | Yes               |
| FPLUKK            | -            | Yes               |
| FPAKK             | -            | Yes               |
| FPAKKNEG          | -            | Yes               |
| FBEST             | -            | Yes               |
| BPLUKK            | -            | Yes               |
| BPAKK             | -            | Yes               |
| BPAKKNEG          | -            | Yes               |
| FP651             | FH601        | No                |
| FO202             | FR612        | No                |
| FO204             | FR602        | No                |
| FO206             | FR604        | No                |
| FO221             | VG601        | Yes               |
| FP601             | VP601        | No                |
| FP612             | VP612        | No                |
| FV603             | VV603        | No                |
| FV605             | VV605        | No                |
| FV611             | VV611        | No                |
| FV621             | VV621        | No                |
| FV651             | VT601        | No                |

---

## Onboarding Notes

- This program is a **one-off or batch conversion utility**: You run it once over a file to update certain fields/codes in-place.
- The code is **simple and linear**: Reads one record at a time, applies business rules, writes it back.
- All business logic is concentrated in the `select` block; adding more conversions is straightforward.
- There is **no error handling** or logging; any record that does not match a `when` clause is not changed.
- **Field Names:** You might want to check the external file definition for what `afruti`, `afacpi` actually mean in the context of your system.
- **Testing:** Always back up your file before running this kind of conversion, as it updates records in place.

---