# IBM ILE RPG: RP605R Program Explanation

This program is written in ILE RPG and is designed as an interactive inquiry (spørring) for "Aktivitet" – probably project activities. It uses subfiles to display records, offers several positioning and paging options, and tracks user selection. The comments and field names are in Norwegian.

Below, we break down the code structure, major logic sections, key variables, and subroutines used in the program.

---

## 1. File Definitions

```rpg
frp3al1    if   e           k disk    rename(rp3apfr:rp3al1r)
frp3al2    if   e           k disk    rename(rp3apfr:rp3al2r)
frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
frp2ul1    if   e           k disk    rename(rp2upfr:rp2ul1r)
frp605d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- Four physical files (*rp3al1*, *rp3al2*, *rp1pl1*, *rp2ul1*) are defined and renamed for use in the program. These are likely master and detail files for projects, subprojects, and activities.
- One display file (*rp605d*) is defined for the workstation, with a subfile (*b1sfl*) controlled by *w_srrn* (relative record number).

---

## 2. Indicator Usage

The header comments explain the meaning of program and display indicators (e.g., *LR*, *10*, *11*, *14*, etc.), which are used for subfile control and UI management.

---

## 3. Key Variables and Parameters

### Input/Output Parameters

```rpg
d p_firm          s                   like(rp3frm)
d p_pros          s                   like(rp3pro)
d p_upro          s                   like(rp3upr)
d p_akti          s                   like(rp3akt)
d p_txt1          s                   like(rp3txt)
d p_txt2          s                   like(rp3tx2)
d p_prt1          s                   like(rp3txt)
d p_kund          s                   like(rp3knr)
```
- These are program parameters, passed in and out by reference, for firm, project, subproject, activity, texts, and customer numbers.
- Set as *like* the relevant database fields for type compatibility.

### Local Data Area

```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Used to get user, firm, and firm name info from the LDA.

### Subfile and Paging Variables

```rpg
d w_stel          s              4  0
d w_spge          s              4  0
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
```
- These track subfile record counts, page size, current/first/last record numbers.

### Miscellaneous

```rpg
d w_seqe          s              1
d b_eof           s              1    inz(*off)
d b_valg_ok       s              1    inz(*off)
d uh              c                   'abcdefghijklmnopqrstuvwxyz������'
d lo              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZ��ֲ��'
```
- *w_seqe* controls sorting or display sequence.
- *b_eof*, *b_valg_ok* are boolean flags for end-of-file and selection confirmation.
- *uh*, *lo* are uppercase/lowercase constants, possibly for data cleansing or conversion.

---

## 4. Main Logic and Program Flow

### Entry and Initialization

- Uses `*inzsr` subroutine (runs at program start) to set up parameter variables, establish initial keys, and populate the subfile.
- Key lists are defined for chaining and setting LL (positioning) in files.

### Main Event Loop

- The main control loop starts at tag `b2taga` and cycles through:
    - Displaying the subfile and control record.
    - Handling function keys (F3, F12 to exit; F5 to refresh; F10/F11 to scroll pages; F21 for Home).
    - Checking and handling positioning requests (by project, underproject, activity, or description).
    - Invoking subroutines to clear, create, and display subfiles as needed.
    - Tests selection result; if a record is selected, program ends.

### Key Subroutines

#### `forny` (Refresh Subfile)
- Repositions the file pointer and repopulates the subfile.

#### `posisjoner` (Position in Subfile)
- Handles cursor positioning/search by field value (project, description, underproject, activity).
- Clears and refills the subfile accordingly.
- Resets position fields after use.

#### `subfile` (Process Subfile)
- Reads and processes every displayed subfile record.
- Handles user selection (e.g., if "select" is pressed) and gathers further data.

#### `clr_subfile` (Clear Subfile)
- Empties subfile and resets relevant variables and indicators.

#### `crt_subfile` (Create/Fill Subfile)
- Fills the subfile with the next page-worth of data from either main or alternate sequence, stops at EOF or firm change.
- Sets status indicators for lines, populates detail fields, and writes them to the screen's subfile.

#### `bck_subfile` (Back/Page Up in Subfile)
- Reads page backwards to facilitate page up in the subfile.
- Afterward, clears and refills the subfile for the previous page.

#### `dsp_subfile` (Display Subfile)
- Sets indicators and formats the display for the subfile control record.

---

## 5. User Interface & Subfile Handling

- Subfiles (*b1sfl*) enable paged display, selection, and searching.
- Supports navigating forward/backward, direct positioning by key fields, and dynamic filtering.
- Records can be selected, causing the corresponding output parameters to be set and the program to return.

---

## 6. General Structure

- The program follows standard "display file data selection" RPG structure:
    1. Setup (parameter and LDA fetch, key initialization)
    2. Populate and display subfile (w/ paging)
    3. Allow search, navigation, and record selection.
    4. Return selection, or exit on command.

---

## 7. Notable Norwegian to English translations

- Aktivitet = Activity
- Beskrivelse = Description
- Prosjekt = Project
- Underprosjekt = Subproject
- Kunde = Customer
- Varsle m/feilmeldinger/skjermindikatorer = Warn with error messages/screen indicators

---

## 8. Useful Variable/Indicator References

| Variable | Purpose |  
|----------|---------|
| w_stel   | Subfile record counter |
| w_srrn   | Current subfile record number |
| w_spge   | Subfile page size |
| b_valg_ok| Selection made/OK flag |

| Indicator | Use |
|-----------|-----|
| LR        | End program |
| 10,11     | Roll up/down (page navigation) |
| 12,13     | Subfile display/format control |
| 14        | Clear subfile |
| 15        | End-of-subfile indicator |

---

## 9. Summary

This RPG program is a robust, interactive screen for selecting "Aktivitet" (activities) within a project management context. It is well-structured for paging, searching, filtering, and selecting using subfiles and typical IBM midrange techniques. The heavy use of subroutines, indicators, and key lists is classic RPG, and the code is well-commented for maintainability and onboarding.

For onboarding:
- Focus on the subfile logic and indicator controls, as that's where user interface behavior is managed.
- Understand how parameters flow in and out for integration.
- Most business logic centers around how projects/activities are filtered, presented, and selected in the subfile.

If you have further questions or wish to drill into specific sections or user scenarios, feel free to ask!