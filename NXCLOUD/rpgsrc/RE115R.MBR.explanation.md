# Documentation for Program RE115R

## Overview

**Program:** RE115R  
**System:** ASOKON  
**Description:**  
This program prepares (tilrettelegger) transaction postings from external systems. It ensures that transactions are posted to the correct period, handling cases where the period is missing by consulting a code register for exception periods ("Avvikende periode i følge koderegister dersom null"). It also manages the allocation of batch numbers (buntnr.) and posting years (år) for these transactions.

## Business Context

- **External Integration:** The program processes postings originating from external systems, ensuring their compatibility and consistency with internal accounting periods and batch structures.
- **Exception Periods:** If a transaction does not specify a period, the program uses a code register to determine the correct (possibly non-standard) posting period.
- **Batch Management:** It finds and assigns the next available batch number for new postings, ensuring no collisions and correct sequencing.

## File Usage and Relationships

| File      | Type | Usage | Notes |
|-----------|------|-------|-------|
| RE0TPF    | Input/Primary | Transaction records from external systems | Key fields: `rtfirm`, `rtrper` |
| AFIRL1    | Input | Company/account info | Renamed to `afirl1r` |
| RAA3L1    | Input | Status info for exception periods | Renamed to `raa3l1r` |
| RAA4L1    | Input | Last used note number per company/year | Renamed to `raa4l1r` |
| RBUNLU    | Update | Batch header (bunt) info | Renamed to `rbunlur` |
| RTRAPF    | Output | Transaction posting records | |

**Note:** The program reads and updates several files, often using keys constructed from company, year, and batch number.

## Key Data Structures

- **per(13):** Array holding period values from RAA3L1, used to map exception periods.
- **w_memb:** Member/user identifier passed as a parameter.
- **wraar, wkraar, raa4l1_4aar:** Year values, manipulated to handle 2-digit years and century logic.
- **wnxbun:** Next available batch number.

## Main Processing Logic

### 1. Initialization (`*INZSR` Subroutine)

- Initializes key variables.
- Sets up key lists for file access.
- Loads company/account, exception period, and last note number records.
- If no note number exists, initializes it to zero.

### 2. Main Loop (Processing Each Transaction)

#### a. Load Reference Data

- If `*INL6` is on, chain to `afirl1` (company/account info) and `raa3l1` (exception period info).
- Loads period array from `raa3l1` for use in exception mapping.

#### b. Determine Year and Note Number

- Converts 2-digit year (`rtrper`) to 4-digit year using a cutoff at 80 (i.e., 1980/2000 split).
- Chains to `raa4l1` to get the last used note number for the company/year.
- If found, uses the last note number; otherwise, initializes to zero.

#### c. Batch Number Allocation

- On period/year break (`*INL3`), prepares to find the next available batch number.
- Clears relevant fields, sets up keys, and reads the previous batch record.
- If none found, starts with 1; otherwise, increments the last found batch number.

#### d. Posting Preparation

- Increments transaction amount, line number, and assigns the batch number.
- Sets various posting fields (e.g., flags, status, references).
- Writes the transaction posting to `rtrapf`.

#### e. Batch Header Update

- Updates or creates the batch header record in `rbunlu` with the new posting summary.
- Handles period/year mapping, including exception logic if the period is not standard.
- Updates financial totals and audit fields.

### 3. Exception Period Handling

- Uses the period array (`per`) from `raa3l1` to map transactions to the correct period if the standard mapping does not apply.
- Handles special cases for prior year postings.

### 4. Audit and Metadata

- Sets user, date, and time fields on all created/updated records for traceability.

## Design and Domain-Specific Conventions

- **Century Determination:** 2-digit years are mapped to centuries using a cutoff value (80), a common local convention.
- **Batch Numbering:** Batch numbers are managed per company and user/member, ensuring uniqueness and sequencing.
- **Exception Periods:** The use of a 13-element period array allows for flexible handling of fiscal periods that may differ from the standard 12-month calendar.
- **Audit Trail:** All records written include user, date, and time fields for compliance and traceability.
- **File Renaming:** Files are renamed in the F-specs to avoid naming conflicts and clarify their role within the program.

## Integration Points

- **External Systems:** The input file (`re0tpf`) is populated by upstream (external) systems.
- **Code Register:** Exception period logic depends on `raa3l1`, which acts as a code register for fiscal periods.
- **Batch Management:** Batch headers (`rbunlu`) are updated to reflect new postings, ensuring downstream processes (e.g., posting, reporting) have accurate batch summaries.

## Notable Implementation Details

- **Conditional Logic via Indicators:** The program uses RPG indicators (`*INL3`, `*INL6`, etc.) to control branching, typical in legacy RPG but important to note for maintainers.
- **Use of Key Lists:** Keys for file access are constructed using KLIST/KFLD conventions for clarity and maintainability.
- **Handling of Null/Zero Values:** When expected data is missing (e.g., note number), the program initializes fields to zero to avoid processing errors.

## Summary

This program is a critical integration point for external financial postings, ensuring that all transactions are assigned to the correct periods, batches, and audit trails according to internal business rules and exception logic. It is tightly coupled with the company’s period and batch management files and expects upstream and downstream systems to adhere to these conventions. 

**For new developers:**  
Familiarity with the business rules around fiscal periods, batch numbering, and the role of exception periods is essential for effective maintenance and enhancement of this program. Pay special attention to the period mapping logic and batch number sequencing, as these are frequent sources of integration issues.