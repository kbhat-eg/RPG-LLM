# Program Overview

This RPG III / ILE RPG program (`MR100R`) manages records via a subfile interface on IBM i (AS/400). The code manages company (firma)-related records, allowing users to view, add, change, copy, and delete entries using subfiles on a display file. It leverages standard RPG C-spec logic, subroutine structures, and indicator-based flow control.

**Key features:**
- Subfile display and manipulation.
- Function key handling.
- Record maintenance: create, update, delete, copy.
- Initialization and position handling.
- Modular subroutines for various UI states (add, display messages, copy, delete).

---

## Section Breakdown

### 1. **Header & Metadata**
- The `H` spec sets program options (e.g., disables debug IO, sets date edit to DD/MM/YY).
- Comments document the system, program, references, and indicator usage standards.

### 2. **File Declarations**
```rpg
famsrl1    if   e           k disk    rename(amsrpfr:amsrl1r)
famsrlr    if   e           k disk    rename(amsrpfr:amsrlrr)
famsrlu    uf a e           k disk    rename(amsrpfr:amsrlur)
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
fam100d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- Files represent physical or logical data files, some renamed for use in this program.
- `fam100d` is a display file with a subfile (`b1sfl`) referenced using `w_srrn` for record number tracking.

### 3. **Data/Variable Definitions**
- **Parameters:** e.g., `p_clib` for input library name.
- **Local Data Area:** Used for passing session/user info.
- **Key Variables:** For file access (by "firma").
- **Working Variables:** For subfile management (counters, flags).
- **Flags (1-char):** Indicate program state (e.g., EOF, ongoing operation, errors).
- **Constants:** e.g., `c_sfil` defines subfile page size (14 records per page).

**Special subfile variables:**  
`w_stel` (subfile counter), `w_spge` (page size), `w_srrn` (relative record in subfile), etc., are all used for paginated subfile operations.

### 4. **Main Program Logic**
The main program is event-driven around a loop that displays the subfile and reacts to function keys:

#### **Key Tags/Control Structures**
- `b2taga`, `b2tagb`: Main loop points for screen display.
- `avslutt`: Program end/exit.
- Function key handling via `select/when` blocks, indicators such as `*inkc` (F3/Exit), `*inkd` (F5/Refresh), etc.

#### **Display Subfile & Command Screen**
- Write command screen (`b2cmd`).
- ExSR (execute subroutine) `dsp_subfile` to manage subfile display/edit.

#### **Function Key Handling**
- Uses RPG indicators for keys/actions.
- Each key triggers a subroutine or program flow (e.g., create, update, scroll up/down, exit).

### 5. **Subroutines**

#### **forny**
- Refresh subfile starting from a specific record.

#### **posisjoner**
- Re-positions the subfile using entered positioning values (e.g., company number).

#### **subfile**
- Core handler for subfile row processing (reads with `readc` — reads changed records).
- Checks action requested for each row (edit, copy, delete, display), performs, and updates subfile accordingly.

#### **xc1bld**
- Handles add-new-row UI and validation.
- Checks for existing record before allowing new entry.
- Calls message window (`xc1msg`) if the row exists.

#### **xc1msg**
- Displays message screen if trying to add a duplicate row.

#### **xc2bld**
- Handles the main maintenance screen for add/edit/view.
- Fills in fields if editing/viewing existing; clears for new.
- Save/update logic for existing or new records.
- Updates subfile row after change.

#### **xd1win**
- Manage delete window and actual deletion of the record.

#### **xk1win**
- Manage copy window/logic, checks for valid input and duplicate, then calls maintenance screen for the new copy.

#### **clr_subfile**
- Clears subfile, resets subfile paging variables.

#### **crt_subfile**
- Fills subfile from database, one page at a time.
- Handles "paging" by reading and displaying up to `c_sfil` records per page.

#### **bck_subfile**
- Handles scrolling back a page in the subfile.

#### **dsp_subfile**
- Handles conditional display of subfile or command screen, manages UI state.

#### **\*inzsr (Initialization)**
- Handles program start, parameter reception, file keylist setup.
- Initially fills subfile with data.

---

## 6. **Indicator Usage**

- **LR**: Last Record, program end.
- **10, 11**: Scroll (Roll up/down).
- **12**: Display subfile.
- **14, 15**: Subfile clear/end.
- **21, 22**: Cursor management.
- **30**: Field protection (e.g., display-only).
- **31-99**: Error and work indicators (for messaging, error states, internal logic).

---

## 7. **Screen/Record Layouts**

- **B1SFL**: Subfile record format.
- **B2CTL**: Subfile control record.
- **B2CMD**: Commands window.
- **C1BLD/C1MSG**: Add-new-row, and message windows.
- **C2BLD**: Change/View record screen.
- **D1WIN**: Delete confirmation window.
- **K1WIN**: Copy window.

Each is used as appropriate in the maintenance or display subroutines.

---

# **Summary of How the Code Works**

1. **Initialization:** Sets up files, keylists, and loads the subfile with the first page of records.
2. **Main Loop:** Waits for user interaction via function keys and subfile edits.
3. **Subfile Display/Interaction:** Handles scrolling, edit, add, copy, delete, and view actions on records.
4. **Updates Database:** Updates underlying files as records are changed, added, deleted.
5. **Paging:** Supports paging through data with roll up/down keys.
6. **Termination:** Ends gracefully on exit.

---

# **Key Takeaways for Onboarding**

- Subfile logic is central: most operations focus on viewing and changing portions of a larger list.
- Program state is largely controlled by single-character indicators and flags.
- Modular subroutines handle specific UI/DB operations, simplifying maintenance.
- Visualize the UI as a list-detail (subfile/detail), with modal windows for add/copy/delete.
- Familiarity with OS/400 display file programming (subfiles, indicator usage) is important.
- **Function keys:** Most user navigation/manipulation is done through F-keys, mapped to RPG indicators.

---

**If you are onboarding to this project:**
- Understand subfile programming and indicator usage.
- Identify the display file layouts (`B1SFL`, etc.) referenced in the RPG code.
- Recognize the flow: load subfile → interact/modify → persist changes.
- Use the subroutine structure to trace/add new maintenance functions as needed.
- Pay attention to the variable and indicator naming conventions (most are business-driven).

---

**Tip: "firma" means "company" in Norwegian; adjust variable and field usage accordingly in your mental model.**