# RPG Program Explanation â€“ "Skriver hylle etiketter" (Shelf Label Printing)

This is an RPG III/400 ILE program designed to print shelf labels of size 48x38 mm for various types of label printers in a warehouse or shop environment. It's an established, production-oriented program with a long maintenance history (see the change log in comments).

Below is an organized, sectioned explanation of its operation, control flow, data usage, and output logic.

---

## 1. **Program Intent**

- **Goal:** Read product/item records and generate formatted shelf labels, adapting the output for different label printer models (Meto 8100, Bandit, Meto mi-4, Datamax EX-2).
- **Customization:** Handles various item and label types, with variable support for alternative item numbers, text fields, and barcodes.
- **I/O:** 
  - Input: Product/item file (vaw1pf)
  - Output: Printer file (Etikett)

---

## 2. **File Specifications (F-Specs)**

```rpg
fvaw1pf    if   f  512    64aidisk
fEtikett   o    f  132        Printer oflind(*inof)
```
- **vaw1pf**: Input file; likely an indexed DB table of product/item records.
- **Etikett**: Output; the generated label output stream for the configured printer.

---

## 3. **Field / Variable Definitions (D-Specs, I-Specs)**

- **Work variables** (e.g., `w_skty`, `w_hyle`, `w_tek1`, `w_tek2`, `w_altv`, `w_best`, etc.) are used for temporary storage of item, label, and formatting info.
- **Overlaying fields** using positions from the input record (I-Specs), to map record segments to variables like `vaanta` (quantity), `vatek1/2` (description), `valvar` (vendor item no.), `vaplas` (location), etc.

---

## 4. **Main Control Flow**

### a. **Initialization**

- Reads the first record from the input file.

### b. **Main Loop (read & process each input record)**

- **Loop:** Continues until the end of file.
- **Label Type Check:** Only process records with `vaetyp = 6` (label type 6).
- **Printer Type Selection:** Reads printer type from `lctype`, determines special handling for several printers:
  - **0** = Meto 8100 Twinax
  - **1** = Meto 8100 Standard
  - **2** = Meto Bandit
  - **4** = Meto mi-4
  - **6** = Datamax EX-2 (same as Meto mi-4 at output)

### c. **Preparation of Fields for Output**

- Assigns relevant input fields to working variables.
- Handles trimming and formatting of vendor item numbers, checking if they're numeric, and prepares variants of different lengths (5,6,7,8 chars).
- Selects alternative item number source based on `valvko`.

### d. **Label Format Switching**

- Detects when the label type changes (`vahyle` vs. `w_hyle`), and resets barcode field indicators accordingly to match the new type.

### e. **Data Formatting and Output**

- Based on printer type, writes data using the correct output specification (`EXCEPT` statements), printing the data in the format and protocol required by that printer.

---

## 5. **Printer Output Handling (O-Specs)**

Based on the label type and printer, different output sections are used:

- **Meto 8100 Twinax/Standard (Clr0/Clr1, Pgm0/Pgm1, Data0/Data1):**
  - Output commands with special control characters (e.g., "&02", '{', '\') to position, format, and feed data to the printer.
  - Various sections for item text, alternative numbers, barcodes, dates, location, price code, and dummy/filler data.

- **Meto Bandit (Pgm2, Data2):**
  - Output using a different set of commands and formatting, suitable for Bandit printer logic.

- **Meto mi-4 / Datamax EX-2 (Data4):**
  - Yet another protocol, with fields output in printer-specific command sequences.
  - Handles extra cases (e.g., special handling of bestillingmengde/order quantity and price info).

**Barcodes:**
- The program can print the barcode for multiple ID types, e.g.:
    - Internal item number
    - Vendor item number
    - EAN number
    - NOBB number

---

## 6. **Additional Features**

- **Robustness:** Checks for data type mismatches, e.g., ensuring vendor item numbers are numeric before using them for barcode output.
- **Special Cases:** Handles label/field length differences, and leaves fields *zeroed* or *trimmed* based on data content.
- **Multi-printer Support:** The control flow is heavily parameterized to allow transparent support for several printer technologies and label layouts.

---

## 7. **Error Handling, End-of-Job Logic, and Initialization**

- Uses indicators (`*inLR`, return statements, tag/label flow) for program end and clean exit.
- Subroutine skeleton for initialization (`*inzsr`), though presently empty.

---

## 8. **Maintenance and Comments**

- The program is well-commented (in Norwegian), with a detailed change log.
- There are comments indicating versions, responsible developers, changes to field lengths, and enhancements (e.g., added new printer support).

---

## 9. **Summary**

- The application is a classic RPG program for generating shelf (hylle) labels.
- It is adaptable to several printer types and label formats, with logic to handle data validation, field formatting, and dynamic output construction.
- Output generation is driven by both input data content and printer configuration.
- The code is modularized primarily around printer types, with output logic segmented into printer-specific EXCEPT blocks.

---

### **Onboarding Notes**

- **To add new printers or label formats**, you would model new output `EXCEPT` routines and corresponding output spec logic.
- **To add/change fields on the label**, ensure you update:
    - Input I-specs,
    - Work variables,
    - Relevant output sections (in O-specs) for all printer types.
- **For business logic changes** (e.g., barcodes, alternative numbers), review the field-handling logic in the main loop.

If you are onboarding to maintain or extend this program, focus first on the printer output logic for your label printer model and understand the mapping of input fields to label sections.

---

### **Diagram: Simplified Control Flow**

```
Start
  |
  v
Read Item Record
  |
  v
If label type OK (vaetyp=6)?
  |          \
  v           \
Format data    ----> Next record
  | 
Determine printer type
  |         |        |        |      |
Meto8100  Bandit   mi-4    EX-2   [others]
  |         |        |        |
Write Output via printer-specific logic
  |
  v
Read next record
  |
Repeat until EOF
  |
  v
Cleanup and End program
```
---

If you need more detailed field-by-field or printer-specific output format explanations, please ask!