# Program Documentation: JX431R (ASVADM)

## Overview

**Program Name:** JX431R  
**System:** ASVADM  
**Purpose:**  
This program is responsible for deleting item prices (`pris`) from the price file(s) under certain conditions. The main use cases are:

- Deleting prices where the "to date" (`til dato`) is less than a user-supplied date.
- Optionally, deleting prices where the "from date" (`fra dato`) is less than the user-supplied date.
- If a supplier number (`lev.nr`) is specified, prices are only deleted for that supplier, with an additional check preventing deletion if the supplier is the one assigned to the item.

The program is designed to be called with a parameter list containing the controlling values.

---

## File Usage and Relationships

- **jvprpfr (jvprlrr, jvprl2r, jvprlur):** Main price files, renamed for different access paths.
- **jlevpfr (jlevlrr):** Supplier file.
- **vvarpfr (vvarl1r):** Item master file.
- Each file is accessed using keys established in the initialization subroutine.

---

## Parameter Structure

The program expects a 20-character parameter list (`p_list`), parsed as follows:

| Field      | Position | Length | Description                                  |
|------------|----------|--------|----------------------------------------------|
| d_firm     | 1-3      | 3      | Company code                                 |
| d_ldor     | 4-9      | 6      | Supplier number (0 if not specified)         |
| d_dato     | 10-15    | 6      | Reference date (DDMMYY format, converted)    |
| d_valg     | 16       | 1      | Deletion option: 1 = prevent deletion if supplier matches item |
| d_vfra     | 17       | 1      | 1 = delete based on "from date"              |
| d_vtil     | 18       | 1      | 1 = delete based on "to date"                |
| (unused)   | 19-20    | 2      | Not used                                     |

---

## Main Logic Flow

### Entry Point

- The program begins by parsing the parameter list and initializing key lists for file access.
- It then checks if a supplier number (`d_ldor`) was specified:
  - If yes: Calls `slett_ldor` (delete for supplier).
  - If no:  Calls `slett_alle` (delete for all items).

### Subroutines

#### 1. `slett_ldor` (Delete for Supplier)

- Iterates through all prices for the specified supplier.
- For each record:
  - If `d_vtil` is set, and the record's "to date" (`jxtdat`) is less than the reference date, calls `slett_pris`.
  - If `d_vfra` is set, and the record's "from date" (`jxgdat`) is less than the reference date, calls `slett_pris`.
  - Skips to the next record after processing.

#### 2. `slett_alle` (Delete for All Items with Status Code 4)

- Iterates through all price records.
- For each record:
  - If `d_vtil` is set, and "to date" is less than the reference date, calls `slett_pris`.
  - If `d_vfra` is set, and "from date" is less than the reference date, calls `slett_pris`.

#### 3. `slett_pris` (Delete Price Record)

- If `d_valg` is set (1):
  - Looks up the supplier in the supplier file (`jlevlrr`).
  - Looks up the item in the item master file (`vvarl1r`).
  - If the supplier number on the item matches the supplier number from the supplier file, the price is **not** deleted (exits subroutine).
- If not prevented by the above check:
  - Builds the key for the price record.
  - If found, deletes the price record from the file.

#### 4. `*inzsr` (Initialization)

- Receives and parses the parameter list.
- Sets up all key lists for file access.
- Converts the date from the parameter to ISO format for comparison.

---

## Business Logic and Domain-Specific Notes

- **Supplier Protection:** When deleting by supplier, if the deletion option (`d_valg`) is set, the program will not delete a price if the supplier number matches the supplier assigned to the item. This prevents accidental deletion of the primary supplier's price.
- **Flexible Date Deletion:** The program can be instructed to delete based on either the "from date" or "to date" fields, or both, depending on the flags passed in.
- **Status Code:** In `slett_alle`, only items with a specific status code (likely 4, though not explicitly checked in the code) are considered for deletion.
- **File Renaming:** Files are renamed in the F-specs for clarity and to allow multiple access paths to the same physical file.
- **Parameter Overlay:** The parameter list is overlaid with fields for easy extraction, a common pattern in legacy RPG.

---

## Design Considerations and Conventions

- **No Debug I/O:** The program is compiled with `*NODEBUGIO` to prevent debug I/O overhead.
- **Date Handling:** Dates are passed as numeric and converted to ISO format for reliable comparison.
- **Goto Usage:** The code uses labeled GOTO statements (`neste`, `neste2`) to skip further checks within the loop after a delete operation, which is a legacy RPG idiom.
- **Key Lists:** Key lists are defined once in the initialization routine and reused for all file operations, improving maintainability.
- **File Handling:** All file operations use keyed access, and deletion is always performed after a successful chain operation to ensure data integrity.

---

## External Dependencies

- **jvprpfr:** Price file, accessed via multiple logicals for different views.
- **jlevpfr:** Supplier master file.
- **vvarpfr:** Item master file.

These files are assumed to be maintained and consistent with the business rules for pricing and supplier management.

---

## Maintenance and Extension Notes

- **Adding New Delete Criteria:** To extend deletion logic (e.g., additional date fields or status codes), adjust the relevant IF conditions in `slett_ldor` and `slett_alle`.
- **Parameter List Expansion:** If more criteria are needed, increase the parameter list size and overlay structure accordingly.
- **File Structure Changes:** If key structures change, update key lists and overlays in the initialization subroutine.

---

## Summary

This program is a batch utility to clean up item prices based on flexible date and supplier criteria, with safeguards to prevent deletion of crucial supplier pricing. It is highly parameter-driven and designed for integration into larger batch or administrative processes. All file and domain logic follows established conventions in this codebase.