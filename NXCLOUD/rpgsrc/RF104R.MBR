      /TITLE    Kontroll av posteringer
     h datedit(*dmy.) option(*nodebugio)
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RF104R                                              *
      * Beskrivelse . . : Kontroll av posteringer                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                                     *
      * Tilpasset for . :                                                     *
      *                                                                       *
      * Referanse  Dato   Endringsbeskrivelse                            Sign *
      * --------- ------  ---------------------------------------------- ---- *
      * R3.30     200100  Nytt program                                   KOB  *
5.00  * R5.00     150102  Kontroll mot kostnadsbærer dersom                   *
5.00  *                   kostnadsbærer brukes.                               *
T5.00 * R5.00     061102  Endret sjekk av prosjekt og aktivitet.         HFL  *
T5.00 *           210803  Flyttet test på bilagskode 85/98 til beh_konto KOB  *
T5.00 *           021003  Test på regnskapsår mot inneværende år + 1     KOB  *
T5.00 *           021003  Test på bilagsdato  mot inneværende år + 1     KOB  *
T5.20 * R5.20     040604  Endret kontroll mot koderegistre fra CALL til       *
T5.20 *                   CHAIN. CALL-program sjekker firma i LDA. Det        *
T5.20 *                   ble feil hvis posteringer for flere firmaer i       *
T5.20 *                   samme kjøring.                                 HFL  *
T5.00 * R5.31     300105  Lagt inn kontroll mva-kode - mva-grunnlag      KOB  *
T5.00 * R5.31     200205  Henter firmanavn fra firmaregisteret           KOB  *
T5.00 * R5.31     220205  Fjernet kontroll om konto ikke skal ha prosjekt     *
      *                   Lagt inn 0-stilling i RF105R i stedet          KOB  *
T5.00 * R5.31     220205  Fjernet kontroll om konto ikke skal ha avdeling     *
      *                   Lagt inn 0-stilling i RF105R i stedet          KOB  *
T5.40 * R5.40     120101  Fjernet kontroll av investeringsavgift-konto.  HFL  *
T5.40 * R5.40     100506  Test på at bilagskode 98 ikke skal ha mva, er  HFL  *
      *                   tatt bort. Mva fjernes i RF105R.               HFL  *
T5.00 * R5.41     111006  Lagt inn kontroll postert < mva-grunnlag       KOB  *
T5.60 * R5.60     130308  Legger ut skjermbilde når differanse           HFL  *
T5.60 *                   debet/kredit.                                  HFL  *
      * R5.60     151008  Lagt inn test på max bilagsdato 31.12.2039     KOB  *
5.61  * R5.60     271208  Slipper igjennom poster for bruker = ASP_..    KOB  *
6.20  * R6.20     241110  Pros er nå alfa                                NHO  *
6.21  *  6.21     081210  Kontroll av prosjekt mot nye register               *
6.21  *  6.20     091210  Kjøring fra klienten
6.22  *  6.20     290512  Kontroll ikke prosjekt hvis konto sier 'N'
6.23  *  6.20 sst 150812  Kontroll om refnr mot riktig post D/C
6.24  *  6.20 sst 170812  Div kontroller overført fra rf010r
6.25  *  6.20 sst 200812  Sjekk om flere avkryssninger mot samme ref
6.26  *  6.20 sst 030912  Kontroll mot samlereferanse
6.27  *  6.20 sst 181012  Kontroll mot kid mot åpen post på kunde
6.28  *  6.20 sst 241012  Justering klient kontroller  Valvatne
6.29  *  6.20 sst 251012  Justering klient/ikke klient Skattum
6.30  *  6.20 sst 280113  Tillegsskontroll av forfallsdato (TME)
6.31  *  6.20 sst 020413  Justert kontroll av forfallsdato (TME)
6.32  *  6.20 sst 080513  Ikke feil bel=valb=0 if SHOP,FAKT,LAGR,LONN
6.33  *  6.30 bsa 150814  Innført mulighet for arkivering og PDF        *
6.34  *  6.33 nho 220115  Tatt bort feilmeld.Bil.dto for langt tilake
6.35  * R6.30 180816 bsa  Rokkert på rekkefølge av close printerfile
6.36  * R6.31 221217 sst  Hopper over kontroll av sjekksiffer i Kid
6.37  * R6.30 161219 sst  Ikke tillate diff på journal etter 01.01.2020
6.38  * R6.30 090120 sst  Ikke tillate diff på bilagsnummer  01.01.2020
6.39  * R6.30 140120 sst  Ikke tillate diff på bilnr/periode 01.01.2020
6.40  * R6.30 140120 sst  Lese gjennom rtra og hente periode fra rbun
6.40X * R6.30 200220 sst  Justert test om diff i bilag
6.41  * R6.30 100320 sst  Åpnet for postering m/diff i inntil 2 dager.
6.41  *                   Styres av parameter: OPPD_ØK_M_DIFF
8.00  * R8.00 260623 sst  Ikke legge ut bilder dersom det kjøres i batch
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *
     frtripf    if   e           k disk    rename(rtripfr:rtripfr)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     frhovlr    if   e           k disk    rename(rhovpfr:rhovlrr)
     frkunlr    if   e           k disk    rename(rkunpfr:rkunlrr)
6.23 frktrl8    if   e           k disk    rename(rktrpfr:rktrl8r)
6.24 frktrlb    if   e           k disk    rename(rktrpfr:rktrlbr)
6.24 frhtrl4    if   e           k disk    rename(rhtrpfr:rhtrl4r)
6.24 frhtrlb    if   e           k disk    rename(rhtrpfr:rhtrlbr)
     frlevlr    if   e           k disk    rename(rlevpfr:rlevlrr)
6.26 frltrl5    if   e           k disk    rename(rltrpfr:rltrl5r)
6.24 frltrl7    if   e           k disk    rename(rltrpfr:rltrl7r)
6.24 frltrl8    if   e           k disk    rename(rltrpfr:rltrl8r)
6.24 frltrlc    if   e           k disk    rename(rltrpfr:rltrlcr)
6.21 f*rprolr    if   e           k disk    rename(rpropfr:rprolrr)
6.21 frp1plr    if   e           k disk    rename(rp1ppfr:rp1plrr)
6.21 frp2ulr    if   e           k disk    rename(rp2upfr:rp2ulrr)
6.21 frp3alr    if   e           k disk    rename(rp3apfr:rp3alrr)
6.21 frp4olr    if   e           k disk    rename(rp4opfr:rp4olrr)
6.25 frtrzl2    if   e           k disk    rename(rtrzpfr:rtrzl2r)
     f                                     prefix(r3:2)
6.25 frtrzl3    if   e           k disk    rename(rtrzpfr:rtrzl3r)
6.25 frtx2lu    uf a e           k disk    rename(rtx2pfr:rtx2lur)
T5.20fra01l1    if   e           k disk    rename(ra01pfr:ra01l1r)
T5.20fra05l1    if   e           k disk    rename(ra05pfr:ra05l1r)
T5.20fra07l1    if   e           k disk    rename(ra07pfr:ra07l1r)
T5.20fra16l1    if   e           k disk    rename(ra16pfr:ra16l1r)
T5.00fra21l1    if   e           k disk    rename(ra21pfr:ra21l1r)
T5.20fra23l1    if   e           k disk    rename(ra23pfr:ra23l1r)
T5.20fra28l1    if   e           k disk    rename(ra28pfr:ra28l1r)
     fraa1l1    if   e           k disk    rename(raa1pfr:raa1l1r)
T5.00fraa3l1    if   e           k disk    rename(raa3pfr:raa3l1r)
     fraa4l1    if   e           k disk    rename(raa4pfr:raa4l1r)
     fra04l1    if   e           k disk    rename(ra04pfr:ra04l1r)
6.27 fakidl1    if   e           k disk    rename(akidpfr:akidl1r)
6.23 frtrxlu    uf a e           k disk    rename(rtrxpfr:rtrxlur)
6.40 frtral4    if   e           k disk    rename(rtrapfr:rtral4r)
6.40 f                                     prefix(xx:2)
7.39 frbunl1    if   e           k disk    rename(rbunpfr:rbunl1r)
     frf104d    cf   e             workstn usropn
     frf104p    o    e             printer oflind(*in30)
6.33 f                                     usropn
     f**sfdebug   o    f  128        disk
      *
      * Definering av Local data area
      *
     d                uds
6.30 d l_memb                  1     10
6.30 d l_poff                584    584
6.30 d l_utqm                585    594
6.33 d l_bach                595    635
6.33 d l_arch                636    636  0
6.33 d l_skje                637    637  0
6.33 d l_land                638    638  0
6.33 d l_exlp                639    639  0
6.33 d l_mail                640    640  0
6.33 d l_ruti                800    809
6.33 d l_outq                810    819
     d l_wsid                901    910
     d l_user                911    920
6.41 d l_filg                931    933
6.33 d l_firm                944    946  0
6.33 d l_fnav                951    980
      *
      * Definering av variable i nøkler
      *
     d rkunlr_kund     s                   like(rkkund)
6.23 d rktrl8_firm     s                   like(rnfirm)
6.23 d rktrl8_kund     s                   like(rnkund)
6.23 d rktrl8_biln     s                   like(rnbiln)
6.24 d rktrlb_firm     s                   like(rnfirm)
6.24 d rktrlb_raar     s                   like(rnraar)
6.24 d rktrlb_biln     s                   like(rnbiln)
     d rlevlr_levr     s                   like(rllevr)
6.26 d rltrl5_firm     s                   like(rofirm)
6.26 d rltrl5_samb     s                   like(rosamb)
6.24 d rltrl7_firm     s                   like(rnfirm)
6.24 d rltrl7_levr     s                   like(rolevr)
6.24 d rltrl7_raar     s                   like(roraar)
6.24 d rltrl7_lfak     s                   like(rolfak)
6.24 d rltrl8_firm     s                   like(rnfirm)
6.24 d rltrl8_levr     s                   like(rolevr)
6.24 d rltrl8_biln     s                   like(robiln)
6.24 d rltrlc_firm     s                   like(rofirm)
6.24 d rltrlc_raar     s                   like(roraar)
6.24 d rltrlc_biln     s                   like(robiln)
     d rhtrl4_raar     s                   like(rbraar)
     d rhtrl4_biln     s                   like(rbbiln)
     d rhovlr_kont     s                   like(rhkont)
     d rhovlr_spes     s                   like(rhspes)
     d rhovlr_avde     s                   like(rhavde)
6.21 d*rprolr_pros     s                   like(rppros)
6.21 d*rprolr_akti     s                   like(rpakti)
6.21 d*rprolr_kont     s                   like(rpkont)
6.21 d*rprolr_spes     s                   like(rpspes)
6.21 d rp1plr_frm      s                   like(rp1frm)
6.21 d rp1plr_pro      s                   like(rp1pro)
6.21 d rp2ulr_frm      s                   like(rp2frm)
6.21 d rp2ulr_pro      s                   like(rp2pro)
6.21 d rp2ulr_upr      s                   like(rp2upr)
6.21 d rp3alr_frm      s                   like(rp3frm)
6.21 d rp3alr_pro      s                   like(rp3pro)
6.21 d rp3alr_upr      s                   like(rp3upr)
6.21 d rp3alr_akt      s                   like(rp3akt)
6.21 d rp4olr_frm      s                   like(rp4frm)
6.21 d rp4olr_ord      s                   like(rp4ord)
6.25 d rtx2lu_ist      s                   like(rx2ist)
6.25 d rtx2lu_emb      s                   like(rx2emb)
6.25 d rtx2lu_grp      s                   like(rx2grp)
6.25 d rtx2lu_fir      s                   like(rx2fir)
6.25 d rtx2lu_unt      s                   like(rx2unt)
6.25 d rtx2lu_ref      s                   like(rx2ref)
6.25 d rtrzl2_emb      s                   like(rz1emb)
6.25 d rtrzl2_fir      s                   like(rz1fir)
6.25 d rtrzl2_unt      s                   like(rz1unt)
6.25 d rtrzl2_inj      s                   like(rz1inj)
6.25 d rtrzl2_vlg      s                   like(rzwvlg)
6.25 d rtrzl3_emb      s                   like(rz1emb)
6.25 d rtrzl3_fir      s                   like(rz1fir)
6.25 d rtrzl3_unt      s                   like(rz1unt)
6.25 d rtrzl3_ref      s                   like(rzrefn)
6.25 d rtrzl3_vlg      s                   like(rzwvlg)
     d raa4l1_4aar     s                   like(ra4aar)
T5.20d ra01l1_kod      s                   like(raakod)
T5.20d ra05l1_kod      s                   like(raekod)
T5.20d ra07l1_kod      s                   like(ragkod)
T5.20d ra16l1_kod      s                   like(rapkod)
T5.00d ra21l1_kod      s                   like(raukod)
T5.20d ra23l1_kod      s                   like(rawkod)
T5.20d ra28l1_kod      s                   like(rebkod)
6.23 d rtrxlu_ist      s                   like(rtnivo)
6.23 d rtrxlu_emb      s                   like(rtmemb)
6.23 d rtrxlu_fir      s                   like(rtfirm)
6.23 d rtrxlu_unt      s                   like(rtbunt)
6.23 d rtrxlu_inj      s                   like(rtlinj)
6.23 d rtrxlu_tel      s                   like(rtlinj)
6.27 d akidl1_firm     s                   like(akfirm)
6.27 d akidl1_kidr     s                   like(akkidr)
6.40 d rtral4_nivo     s                   like(rtnivo)
6.40 d rtral4_memb     s                   like(rtmemb)
6.40 d rtral4_firm     s                   like(rtfirm)
6.40 d rtral4_biln     s                   like(rtbiln)
7.39 d rtral4_raar     s                   like(rtraar)
7.39 d rtral4_rper     s                   like(rtrper)
6.40 d rtral4_linj     s                   like(rtlinj)
7.39 d rbunl1_nivo     s                   like(rsnivo)
7.39 d rbunl1_memb     s                   like(rsmemb)
7.39 d rbunl1_firm     s                   like(rsfirm)
7.39 d rbunl1_bunt     s                   like(rsbunt)
      *
     d gm_firm         s                   like(rtfirm)
     d gm_bunt         s                   like(rtbunt)
     d gm_raar         s                   like(rtraar)
     d gm_rper         s                   like(rtrper)
      *
     d p_akod          s                   like(rtbilk)
     d p_pkod          s                   like(rtvalk)
     d p_ukod          s                   like(rtakti)
     d p_wkod          s                   like(rtvirk)
     d p_ekod          s                   like(rhmvak)
     d p_gkod          s                   like(rhavde)
T5.00d p_Økod          s                   like(rhspes)
     d p_stat          s              1
     d p_tx20          s             20
     d p_feil          s              1
     d p_tell          s              7  0
      *
610  d w_memb          s                   like(rtmemb)
610  d w_jkey          s             41
610  d w_jsta          s              2  0
610  d w_jmld          s            200
610  d w_stat          s              1  0
6.23 d w_klient        s              1
     d w_firm          s                   like(rtfirm)
     d w_kont          s                   like(rtdkto)
     d w_spes          s                   like(rtdsps)
     d w_avde          s                   like(rtdavd)
     d w_mvak          s                   like(rtdmva)
     d w_dato          s                   like(rtbdat)
     d w_raar          s              2  0
     d w_raa4          s              4  0
6.39 d w_rper          s              2  0
T5.60d w_sumd          s             13  2
T5.60d w_sumk          s             13  2
T5.60d w_diff          s             13  2
6.37 d var             s             55    dim(3) ctdata perrcd(1)
T5.60d wsavli          s              2  0
T5.60d wsavpo          s              3  0
     d w_maxdat        s               d   datfmt(*iso)
5.61 d w_aspuser       s              4
5.61 d w_rutine        s             11
5.61 d w_rest          s             11  2
5.61 d w_tot_vlg       s              1
5.61 d w_sav_lin       s                   like(rtlinj)
5.61 d w_deb           s              3  0
5.61 d w_kre           s              3  0
5.61 d w_belop         s                   like(rtbelØ)
6.26 d w_samb_bel      s                   like(rtbelØ)
6.27 d w_ptyp          s              1
6.27 d w_kidkto        s              6
6.27 d w_kidktn        s              6  0
6.27 d w_kidbnr        s              6
6.27 d w_kidbnn        s              6  0
6.30 d w_fartst        s             10
6.30 d w_bartst        s             10
6.33 d p_btyp          s            100
6.33 d w_year          s              4  0
6.33 d w_date          s               d   datfmt(*iso)
6.40 d w_totxx         s                   like(rtbelØ)
6.40 d w_biln          s                   like(rtbiln)
6.41 d Til_M_Diff      s              1
6.41 d w_dd            s              2  0
6.41 d w_mm            s              2  0
6.41 d w_aa            s              4  0
6.41 d w_idag          s               d   datfmt(*iso)
6.41 d w_pdat          s               d   datfmt(*iso)
6.41 d w_ndag          s              6  0
8.00 d w_batch         s              1
      *
     d fei             s             30    dim(20)
     d x               s              2  0
     d m               s              2  0
     d forste          s              1  0
6.24  *
6.24  * Felt for kontroll av kid
6.24 d kid             s              1    dim(25)
6.24 d nyki            s              1    dim(25)
6.24 d tall            s              1    dim(24)
6.24 d ktr             s              1
6.24 d p_rkod          s              1
6.24 d p_tall          s             25
6.24 d w_kidi          s             25
6.24 d w_ki24          s             24
6.24 d w_sist          s              1
6.27 d w_kidr          s              6
6.24 d v               s              2  0
6.24 d w               s              2  0
6.24 d n               s              2  0
6.24 d tell            s              1  0
6.24 d psum            s              3  0
6.24 d vekt            s              1  0
6.24 d faktor          s              1  0
6.24 d prod            s              2  0
6.24 d difktr          s              2  0
6.24 d divtal          s              2  0
6.24 d rest            s              2  0
6.24  *
6.24 d tegn            s              1     dim(25)
      *
6.33 d splfname2       s             10a
6.33 d jobname2        s             10a
6.33 d username2       s             10a
6.33 d jobnbr2         s              6a
6.33 d splfnbr2        s             10i 0
6.33 d splfname3       s             10a
6.33 d jobname3        s             10a
6.33 d username3       s             10a
6.33 d jobnbr3         s              6a
6.33 d splfnbr3        s             10i 0
6.33 d p_tagg0         s             20
6.33 d p_tagg0val      s             50
6.33 d p_tagg1         s             20
6.33 d p_tagg1val      s             50
6.33 d p_tagg2         s             20
6.33 d p_tagg2val      s             50
6.33 d p_tagg3         s             20
6.33 d p_tagg3val      s             50
6.33 d p_tagg4         s             20
6.33 d p_tagg4val      s             50
6.33 d p_tagg5         s             20
6.33 d p_tagg5val      s             50
6.33 d p_tagg6         s             20
6.33 d p_tagg6val      s             50
6.33 d p_tagg7         s             20
6.33 d p_tagg7val      s             50
6.33 d p_tagg8         s             20
6.33 d p_tagg8val      s             50
6.33 d p_tagg9         s             20
6.33 d p_tagg9val      s             50
6.33 d p_refn          s             50
6.33 d p_dspl          s            100
      *
6.33 d qsprilsp        pr                  extpgm('QSPRILSP')
6.33 d rcvvar                     32767a   options(*varsize)
6.33 d rcvvarlen                     10i 0 const
6.33 d format                         8a   const
6.33 d errorcode                  32767a   options(*varsize)
      *
6.33 d sprl0100        ds
6.33 d  bytesrtn                     10i 0
6.33 d  bytesavl                     10i 0
6.33 d  splfname                     10a
6.33 d  jobname                      10a
6.33 d  username                     10a
6.33 d  jobnbr                        6a
6.33 d  splfnbr                      10i 0
6.33 d  systemname                    8a
6.33 d  createdate                    7a
6.33 d                                1a
6.33 d  createtime                    6a
      *
6.33 d errorcode       ds
6.33 d  bytesprov                    10i 0 inz(0)
6.33 d  byteavail                    10i 0 inz(0)
7.08  *
7.08  * Definering av eksterne prg
7.08  * BKV
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
      *
610  c**** dummy         tag
      *
     c                   read      rtripf                                 90
      *
     c                   eval      x = 0
     c                   eval      gm_firm = *loval
     c                   eval      gm_bunt = *loval
     c                   eval      gm_raar = *loval
     c                   eval      gm_rper = *loval
      *
     c                   dow       *in90 = *off
610   *
610  c                   if        rtmemb <> w_memb
610  c                   goto      dummy
610  c                   endif
610   *
     c                   if        rtbiln = 13625
     c                   eval      rtbiln = rtbiln
     c                   endif
      *
      * Tell antall poster som behandles
      *
     c                   eval      p_tell = p_tell + 1
      *
      * Brudd på firma
      *
     c                   if        rtfirm <> gm_firm
     c                   exsr      brd_firm
      *
      * Skriv feilmelding
      *
     c                   if        x > 0
     c                   eval      p_feil = 'J'
      *
     c                   if        forste = 0
     c                   write     a1hdr
     c                   eval      forste = 1
     c                   endif
      *
     c                   eval      m = 1
     c                   dou       m > x
     c                   eval      d2feil = *blanks
     c                   eval      d2feil = fei(m)
      *
     c                   write     d2fei
      *
     c                   if        *in30 = *on
     c                   write     a1hdr
     c                   eval      *in30 = *off
     c                   endif
      *
     c                   eval      m = m + 1
     c                   enddo
     c                   endif
      *
     c                   eval      gm_firm = rtfirm
      *
     c                   endif
      *
      * Brudd på bunt
      *
     c                   if        rtbunt <> gm_bunt
     c                   exsr      brd_bunt
     c                   eval      gm_bunt = rtbunt
     c                   endif
      *
      * Brudd på regnskapsår/periode
      *
     c                   if        rtraar <> gm_raar or
     c                             rtrper <> gm_rper
     c                   exsr      brd_rper
     c                   eval      gm_raar = rtraar
     c                   eval      gm_rper = rtrper
     c                   endif
      *
      * Kontroller transaksjonen
      *
     c                   eval      x = 0
     c                   eval      fei = *blank
      *
     c                   exsr      kontroll
      *
      * Skriv feilmelding
      *
     c                   if        x > 0
     c                   eval      p_feil = 'J'
      *
     c                   if        forste = 0
     c                   write     a1hdr
     c                   eval      forste = 1
     c                   endif
      *
     c                   if        *in30 = *on
     c                   write     a1hdr
     c                   eval      *in30 = *off
     c                   endif
      *
T5.00c                   if        rtbdat = *loval
T5.00c                   move      *zeros        w_bdat
T5.00c                   else
T5.00c     *dmy          move      rtbdat        w_bdat
T5.00c                   endif
      *
T5.00c                   if        rtfdat = *loval
T5.00c                   move      *zeros        w_fdat
T5.00c                   else
T5.00c     *dmy          move      rtfdat        w_fdat
T5.00c                   endif
      *
T5.00c                   move      rtraar        w_raar
      *
     c                   write     d1det
      *
     c                   if        *in30 = *on
     c                   write     a1hdr
     c                   eval      *in30 = *off
     c                   endif
      *
     c                   eval      m = 1
     c                   dou       m > x
     c                   eval      d2feil = *blanks
     c                   eval      d2feil = fei(m)
      *
     c                   write     d2fei
      *
     c                   if        *in30 = *on
     c                   write     a1hdr
     c                   eval      *in30 = *off
     c                   endif
      *
     c                   eval      m = m + 1
     c                   enddo
      *
     c                   endif
610  c     dummy         tag
     c                   read      rtripf                                 90
610   *
610  c     dumm1         tag
     c                   enddo
     c/space 3
      *
     c     Slutt         tag
      *                                         Debug
6.23 c                   if        p_feil <> *blank and
6.23 c                             w_klient <> 'J'
8.00 c                             and w_batch <> '0'
6.23 c                   open      rf104d
     c                   exfmt     a2bld
6.23 c                   close     rf104d
     c                   endif
      *
T5.60 * Sjekk debet/kredit, legg ut bilde hvis differanse
      *
T5.60c                   eval      w_diff = w_sumd - w_sumk
T5.60c                   if        p_feil = *blank
T5.60c                   if        w_diff <> *zero
     c                   if        w_klient <> 'J'
T5.60c                   movel     var(1)        m1mld1
6.37 c                   if        rtraar > 2019
6.41 c                             and Til_M_Diff <> 'J'
6.37 c                   movel     var(3)        m1mld2
6.37 c                   else
6.37 c                   movel     var(2)        m1mld2
6.37 c                   endif
T5.60c                   move      'N'           m1svar
8.00 c                   if        w_batch <> '0'
T5.60c                   exsr      xm1win
8.00 c                   endif
6.37 c                   if        rtraar > 2019
6.41 c                             and m1svar = 'J'
6.41 c                             and Til_M_Diff <> 'J'
T5.60c                   eval      p_feil = 'J'
6.37 c                   else
T.560c                   if        m1svar = 'N'
T5.60c                   eval      p_feil = 'J'
T.560c                   endif
6.37 c                   endif
6.23 c                   else
6.23 c                   eval      p_feil = 'J'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Diff Debet-Kredit i bunt'
6.23 c                   exsr      msg_rtrx
6.23 c                   endif
T5.60c                   endif
T5.60c                   endif
6.40  * ______________________________________________________________
6.40  *  Sjekk om bilag ikke går i null    Debug
6.41 c                   if        Til_M_Diff <> 'J'
6.40 c                   eval      rtral4_nivo = *blank
6.40 c                   eval      rtral4_memb = l_memb
6.40 c                   eval      rtral4_firm = w_firm
6.40 c                   eval      rtral4_biln = *zero
7.39 c                   eval      rtral4_raar = *zero
7.39 c                   eval      rtral4_rper = *zero
6.40 c                   eval      rtral4_linj = *zero
6.40 c     rtral4_key    setll     rtral4
6.40 c                   read      rtral4
6.40 c                   dow       not %eof(rtral4) and
6.40 c                             xxmemb = l_memb
6.40 c                   eval      w_biln = xxbiln
7.39 c                   move      xxraar        w_raar
7.39 c                   eval      w_raa4 = xxraar
7.39 c                   eval      w_rper = xxrper
6.40 c                   eval      w_totxx = *zero
7.39sc*                  if        w_raa4 = *zero or
7.39sc*                            w_rper = *zero
7.39 c                   eval      rbunl1_nivo = *blank
7.39 c                   eval      rbunl1_memb = l_memb
7.39 c                   eval      rbunl1_firm = w_firm
7.39 c                   eval      rbunl1_bunt = xxbunt
7.39 c     rbunl1_key    chain     rbunl1
7.39 c                   if        %found(rbunl1)
7.39 c                   eval      w_raa4 = rsraar
7.39 c                   move      rsraar        w_raar
7.39 c                   eval      w_rper = rsrper
7.39 c                   eval      xxraar = rsraar
7.39 c                   eval      xxrper = rsrper
7.39 c                   endif
7.39 c*                  endif
6.40 c                   dow       not %eof(rtral4) and
6.40 c                             xxmemb = l_memb  and
7.39 c                             xxbiln = w_biln  and
7.39 c                             xxraar = w_raa4  and
7.39 c                             xxrper = w_rper
6.40 c                   eval      w_raa4 = xxraar
6.40 c                   clear                   d1det
6.40 c                   eval      rtbunt = xxbunt
6.40 c                   eval      rtbiln = xxbiln
6.40 c                   eval      rtrper = xxrper
7.39 c                   eval      rtraar = xxraar
6.40 c                   if        xxdkto <> 0
6.40 c                   eval      w_totxx = w_totxx + xxbelØ
6.40 c                   endif
6.40 c                   if        xxckto <> 0
6.40 c                   eval      w_totxx = w_totxx - xxbelØ
6.40 c                   endif
6.40 c                   read      rtral4
7.39 c                   if        xxraar = *zero or
7.39 c                             xxrper = *zero
7.39 c                   eval      rbunl1_nivo = *blank
7.39 c                   eval      rbunl1_memb = l_memb
7.39 c                   eval      rbunl1_firm = w_firm
7.39 c                   eval      rbunl1_bunt = xxbunt
7.39 c     rbunl1_key    chain     rbunl1
7.39 c                   if        %found(rbunl1)
7.39 c                   eval      xxraar = rsraar
7.39 c                   eval      xxrper = rsrper
7.39 c                   endif
7.39 c                   endif
6.40 c                   enddo
6.40  *  Rapporter ev diff
6.40 c                   if        w_totxx <> 0
6.40 c                             and rsstat <> 'U'
6.40xc                             and rsraar  > 2019
6.40 c                   eval      p_feil = 'J'
6.40  *
6.40 c                   if        forste = 0
6.40 c                   write     a1hdr
6.40 c                   eval      forste = 1
6.40 c                   endif
6.40  *
6.40 c                   if        *in30 = *on
6.40 c                   write     a1hdr
6.40 c                   eval      *in30 = *off
6.40 c                   endif
6.40  *
     c                   move      w_raa4        w_raar
6.40 c                   eval      rtbelØ = w_totxx
6.40 c                   eval      rttext = 'Diff i bilag'
6.40  *
6.40 c                   write     d1det
6.40  *
6.40 c                   if        *in30 = *on
6.40 c                   write     a1hdr
6.40 c                   eval      *in30 = *off
6.40 c                   endif
6.40  *
6.40 c                   endif
6.40 c                   enddo
6.41  *                  End_Til_M_Diff
6.41 c                   endif
6.41  *
6.40 c                   if        p_feil = 'J'
6.40 c                             and rsstat <> 'U'
8.00 c                             and w_batch <> '0'
6.40 c                   open      rf104d
6.40 c                   exfmt     a2bld
6.40 c                   close     rf104d
6.40 c                   endif
6.41  *
      * Generer xml for videre utskrift
6.33 c                   if        l_poff = '1'
6.33 c                   exsr      spoolnbr
6.35 c                   close     rf104p
6.35 c                   exsr      xml_create
6.33 c                   exsr      pdf_preview
6.33  * Avslutt jobbiden
6.33 c                   call      'AB710R'
6.33 c                   parm                    l_bach
6.33 c                   endif
      *
     c                   eval      *inlr = *on
      *
     c/eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for brudd på firma                                    *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     brd_firm      begsr
      *
     c                   eval      w_firm = rtfirm
      *
     c     afirl1_key    chain     afirl1                             61
     c                   eval      a1firm = aaffir
     c                   eval      a1fnav = aafnav
      *
      *
      * Sjekk statuskode 1
      *
     c     raa1l1_key    chain     raa1l1                             91
      *
     c                   if        *in91 = *on
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Statuskode 1 må opprettes'
      *
     c                   else
      *
     c                   if        ra1hkt = *zeros or
     c                             ra1hrs = *zeros
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Grense hovedbok/resk. feil'
     c                   endif
      *
     c                   if        ra1ape < 1 or
     c                             ra1ape > 13
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Antall regnskapsperioder feil'
     c                   endif
      *
     c                   endif
      *
N5.00 * Sjekk statuskode 3
NT.00 * Hvis RA3BÆR = J, kostnadsbærer brukes
      *
T5.00c     raa3l1_key    chain     raa3l1                             91
      *
T5.00c                   if        *in91 = *on
T5.00c                   eval      x = x + 1
T5.00c                   eval      fei(x) = 'Statuskode 3 må opprettes'
T5.00c                   endif
      *
      * Sjekk statuskode 4
      *
     c                   eval      raa4l1_4aar = *zeros
     c     raa4l1_key    chain     raa4l1                             91
      *
     c                   if        *in91 = *on
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Statuskode 4 må opprettes'
     c                   endif
      *
      * Sjekk faste konti
      *
     c     ra04l1_key    chain     ra04l1                             91
      *
     c                   if        *in91 = *on
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Faste konti må opprettes'
     c                   endif
      *
      * Sjekk konti for automatiske posteringer
      *
     c                   if        *in91 = *off
      *
     c                   if        radk01 = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto for utg. mva mangler '
     c                   endif
      *
     c                   if        radk02 = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto for inng. mva mangler '
     c                   endif
      *
S5.40c*                  if        radk03 = 0
     c*                  eval      x = x + 1
     c*                  eval      fei(x) = 'Konto for inv.avg. mangler '
     c*                  endif
      *
     c                   if        radk04 = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto for fylkesskt. mangler '
     c                   endif
      *
      *
     c                   if        radk05 = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto for debitorer mangler '
     c                   endif
      *
     c                   if        radk06 = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto for kreditorer mangler '
     c                   endif
      *
     c                   endif
      *   --------------------------------------------------------
      *   Bygge opp RTX2Pf med alle avkryssede linjer fra klienten
      *
     c                   if        w_klient = 'J'
     c                   eval      rtrzl3_emb = %subst(w_memb:4:7)
     c                   eval      rtrzl3_fir = w_firm
     c                   eval      rtrzl3_unt = rtbunt
     c     rtrzl3_key    setll     rtrzl3
     c     rtrzl3_key    reade     rtrzl3
     c                   dow       not %eof(rtrzl3)
     c                   if        rzrefn = 0 or
     c                             rz1ist = 'M'
     c                   goto      NextRef
     c                   endif
     c                   eval      rtx2lu_ist = *blank
     c                   eval      rtx2lu_emb = w_memb
     c                   eval      rtx2lu_grp = *blank
     c                   eval      rtx2lu_fir = rz1fir
     c                   eval      rtx2lu_unt = rz1unt
     c                   eval      rtx2lu_ref = rzrefn
     c     rtx2lu_key    chain     rtx2lu
     c                   if        not %found(rtx2lu)
     c                   eval      rx2ist = rtx2lu_ist
     c                   eval      rx2emb = rtx2lu_emb
     c                   eval      rx2grp = rtx2lu_grp
     c                   eval      rx2fir = rtx2lu_fir
     c                   eval      rx2unt = rtx2lu_unt
     c                   eval      rx2ref = rtx2lu_ref
     c                   eval      rx2bel = rzbelØ
     c                   endif
      *   Finner alle kryssede linjer på en postering
     c                   eval      rtrzl2_emb = rtrzl3_emb
     c                   eval      rtrzl2_fir = w_firm
     c                   eval      rtrzl2_unt = rtbunt
     c                   eval      rtrzl2_inj = rz1inj
     c                   eval      rtrzl2_vlg = *blank
     c                   eval      w_rest = *zero
     c                   eval      w_tot_vlg = *blank
     c                   eval      w_deb = *zero
     c                   eval      w_kre = *zero
     c     rtrzl2_key    setll     rtrzl2
     c     rtrzl2_key    reade     rtrzl2
     c                   dow       not %eof(rtrzl2)
     c                   if        r3wvlg <> 'A'
     c                   if        r31ist = 'M'
      *                                            M-record (Registrert)
     c                   if        r31kto <= ra1hrs
      *                                            Kunde
     c                   eval      w_rest = w_rest - r3BelØ
     c                   if        r3BelØ > 0
     c                   eval      w_kre = w_kre + 1
     c                   else
     c                   eval      w_deb = w_deb + 1
     c                   endif
     c                   else
      *                                            Leverandør
     c                   eval      w_rest = w_rest + r3BelØ
     c                   if        r3BelØ > 0
     c                   eval      w_deb = w_deb + 1
     c                   else
     c                   eval      w_kre = w_kre + 1
     c                   endif
     c                   endif
     c                   else
      *                                            X-record (fra reskontro)
     c                   eval      w_rest = w_rest + r3BelØ
     c                   if        r3BelØ < 0
     c                   eval      w_kre = w_kre + 1
     c                   else
     c                   eval      w_deb = w_deb + 1
     c                   endif
      *   Sjekk om det er lagt debet-diff på kredit rest eller motsatt
     c                   if        (r3belØ < 0  and
     c                              r3dbel > 0)      or
     c                             (r3belØ > 0  and
     c                              r3dbel < 0)
     c                   eval      w_sav_lin = rtlinj
     c                   eval      rtlinj = rz1inj
     c                   if        r3belØ < 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Ikke debet diff på kredit post'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   if        r3belØ > 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Ikke kreidt diff på debet post'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   eval      rtlinj = w_sav_lin
     c                   endif
      *
     c***                else
     c                   endif
     c                   if        r3wvlg <> *blank
     c                   eval      w_tot_vlg = r3wvlg
     c                   endif
     c                   endif
     c     rtrzl2_key    reade     rtrzl2
     c                   enddo
      *
     c                   if        (w_Deb =  0    or
     c                              w_Kre =  0)      and
     c                             (w_Deb >  0 or
     c                              w_Kre >  0)
     c                   eval      w_sav_lin = rtlinj
     c                   eval      rtlinj = rz1inj
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Krysset bare Debet eller Kredit'
6.23 c                   exsr      msg_rtrx
     c                   eval      rtlinj = w_sav_lin
     c                   endif
      *
     c                   if        w_Deb >  1    and
     c                             w_Kre >  1
     c                   eval      w_sav_lin = rtlinj
     c                   eval      rtlinj = rz1inj
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Du kan ikke krysse flere debet'
6.23 c                   exsr      msg_rtrx
     c                   eval      x = x + 1
     c                   eval      fei(x) = ' mot flere kredit poster'
6.23 c                   exsr      msg_rtrx
     c                   eval      rtlinj = w_sav_lin
     c                   endif
      *
     c                   if        w_tot_vlg = *blank and
     c                             w_rest <> 0
     c                   eval      w_sav_lin = rtlinj
     c                   eval      rtlinj = rz1inj
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Avkrysset linje har diff'
6.23 c                   exsr      msg_rtrx
     c                   eval      rtlinj = w_sav_lin
     c                   endif
      *
     c                   if        rzwvlg <> 'L'
     c                   eval      rx2rst = 0
     c                   else
     c                   eval      rx2rst = w_rest
     c                   endif
     c                   if        %found(rtx2lu)
     c                   update    rtx2lur
     c                   else
     c                   write     rtx2lur
     c                   endif
      *
     c     NextRef       tag
     c     rtrzl3_key    reade     rtrzl3
     c                   enddo
      *      end-klient = 'J'
     c                   endif
      *
     c                   endsr
      *
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for brudd på bunt                                     *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     brd_bunt      begsr
      *
     c                   endsr
      *
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for brudd på periode                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     brd_rper      begsr
      *
     c                   endsr
      *
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for kontroll                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     kontroll      begsr
      *
      * Kontroll av periode
      *
     c                   if        rtraar = 0 or
     c                             rtrper = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Regnskapsperiode ikke utfylt'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   if        rtrper > ra1ape
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Regnskapsmnd. > ant. perioder'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   if        rtraar > *year + 1
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Regnskapsår > inneværende år+1'
6.23 c                   exsr      msg_rtrx
     c                   endif
6.24  *
6.24  * Sjekke om bilagskode er gyldig
6.24  *
     c                   if        rtbilk = *zero
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Bilagskode ikke registrert'
6.24 c                   exsr      msg_rtrx
     c                   else
6.24 c                   move      rtbilk        p_akod
6.24 c                   call      'RS701R'
6.24 c                   parm                    p_stat
6.24 c                   parm                    p_akod
6.24 c                   parm                    p_tx20
6.24 c                   if        p_stat = 'N'
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Ugyldig bilagskode'
6.24 c                   exsr      msg_rtrx
6.24 c                   endif
6.24 c                   endif
      *----------------------------------------------------------------
      * Kontroll av bilagsnummer
      *
     c                   if        rtbiln = 0
     c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Bilagsnummer mangler'
6.24 c                   exsr      msg_rtrx
     c                   endif
6.24  *
6.24  * Varsle dersom bilagsnummer brukt før dette år
6.24  *
6.24 c                   if        ra1bnr = 'J' and
6.24 c                             rtbiln <> *zero
6.24  *
6.24  * Sjekk hovedboksposter
6.24  *
6.24 c                   eval      rhtrl4_biln = rtbiln
6.24 c                   eval      rhtrl4_raar = rtraar
6.24 c     rhtrl4_key    chain     rhtrl4
6.24 c                   if        %found(rhtrl4)
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Bilagsnr brukt før dette år'
6.24 c                   exsr      msg_rtrx
6.24 c                   endif
6.24  *
6.24  * Sjekk kundeposter
6.24  *
6.24 c                   if        not%found(rhtrlb)
6.24 c                   eval      rktrlb_raar = rtraar
6.24 c                   eval      rktrlb_biln = rtbiln
6.24 c     rktrlb_key    chain     rktrlb
6.24 c                   if        %found(rktrlb)
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Bilagsnr brukt før dette år'
6.24 c                   exsr      msg_rtrx
6.24 c                   endif
6.24 c                   endif
6.24  *
6.24  * Sjekk leverandørposter
6.24  *
6.24 c                   if        not%found(rhtrl4) and
6.24 c                             not%found(rktrlb)
6.24 c                   eval      rltrlc_raar = rtraar
6.24 c                   eval      rltrlc_biln = rtbiln
6.24 c     rltrlc_key    chain     rltrlc
6.24 c                   if        %found(rltrlc)
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Bilagsnr brukt før dette år'
6.24 c                   exsr      msg_rtrx
6.24 c                   endif
6.24 c                   endif
6.24  *
6.24 c                   endif
      *----------------------------------------------------------------
      * Sjekk bilagsdato utfylt
      *
     c*                  eval      w_rutine = 'Debug sst'
     c*                  except    debug
6.24 c                   if        rtbdat = *loval
6.24 c     *dmy          move      udate         rtbdat
6.24 c                   endif
     c                   if        rtbdat = *loval
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Bilagsdato er ikke utfylt'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Sjekk at bilagsdato er maks 1 år fram i tid
      *
     c                   time                    w_dato
     c     w_dato        adddur    1 : *y        w_dato
      *
     c                   if        rtbdat > w_dato
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Bilagsdato er for langt fram'
6.23 c                   exsr      msg_rtrx
     c     *dmy          move      311239        w_maxdat
     c                   if        rtbdat > w_maxdat
     c                   eval      rtbdat = w_maxdat
     c                   endif
     c                   endif
      *
      * Sjekk at bilagsdato er maks 1 år tilbake i tid
      *
     c                   time                    w_dato
     c     w_dato        subdur    1 : *y        w_dato
      *
6.34 c*                  if        rtbdat < w_dato
6.34 c*                  eval      x = x + 1
6.34 c*                  eval      fei(x) = 'Bilagsdato for langt tilbake'
6.34 c*                  exsr      msg_rtrx
6.34 c*                  endif
      *----------------------------------------------------------------
6.27  * Indikasjon på om det er kunde eller leverandør postering
6.27 c                   eval      w_ptyp = *blank
      * Kontroll av at konto er utfylt
      *
     c                   if        rtdkto = 0 and
     c                             rtckto = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Ingen kontonummer utfylt'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Behandle debetkonto
      *
     c                   if        rtdkto <> 0
      *
T5.60c                   eval      w_sumd = w_sumd + rtbelØ
     c                   eval      w_kont = rtdkto
     c                   eval      w_avde = rtdavd
     c                   eval      w_spes = rtdsps
     c                   eval      w_mvak = rtdmva
      *
     c                   select
     c                   when      rtdkto <= ra1hkt
     c                   exsr      beh_konto
     c                   when      rtdkto <= ra1hrs
6.27 c                   eval      w_ptyp = 'K'
     c                   exsr      beh_kunde
     c                   when      rtdkto > ra1hrs
6.27 c                   eval      w_ptyp = 'L'
     c                   exsr      beh_lever
     c                   endsl
      *
     c                   endif
      *
      * Behandle kreditkonto
      *
sven c                   if        rtckto <> 0
      *
T5.60c                   eval      w_sumk = w_sumk + rtbelØ
     c                   eval      w_kont = rtckto
     c                   eval      w_avde = rtcavd
     c                   eval      w_spes = rtcsps
     c                   eval      w_mvak = rtcmva
      *
     c                   select
     c                   when      rtckto <= ra1hkt
     c                   exsr      beh_konto
     c                   when      rtckto <= ra1hrs
6.27 c                   eval      w_ptyp = 'K'
     c                   exsr      beh_kunde
     c                   when      rtckto > ra1hrs
6.27 c                   eval      w_ptyp = 'L'
     c                   exsr      beh_lever
     c                   endsl
      *
     c                   endif
      *----------------------------------------------------------------
      * Kontroll av beløp
      *
     c                   if        rtbelØ < 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Beløp er negativt'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Det kan ikke være null i både beløp og valutabeløp
      *
     c**                 eval      w_rutine = 'Beløp=Val=0'
     c**                 except    debug
6.29 c                   if        w_klient = 'J' and
6.29 c                             rtbelØ = 0 and
6.32 c                             rtvalb = 0 and
6.32 c                             %subst(rtmemb:4:4) <> 'SHOP' and
6.32 c                             %subst(rtmemb:4:4) <> 'FAKT' and
6.32 c                             %subst(rtmemb:4:4) <> 'LAGR' and
6.32 c                             %subst(rtmemb:4:4) <> 'LONN'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Beløp og Valuta = 0'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Det kan ikke være både beløp og valutabeløp på samme postering
      * 2013.03.25:  Tyder på at det alltid er både norske og valuta så
      *              dette blir foreløpig fjernet.  Registrering gir vel
      *              alltid begge da det der omberegnes fra Valuta til nok.
      *
     c*                  if        rtbelØ <> 0 and
     c*                            rtvalb <> 0
     c*                  eval      x = x + 1
     c*                  eval      fei(x) = 'Enten beløp eller Valutabeløp'
6.23 c*                  exsr      msg_rtrx
     c*                  endif
      *----------------------------------------------------------------
6.24  * Varsle dersom leverandørens fakturanr. brukt før dette år
6.24  *
6.24 c                   if        rtckto > ra1hrs
6.24 c                   eval      rltrl7_levr = rtckto
6.24 c                   endif
6.24  *
6.24 c                   if        rtdkto > ra1hrs
6.24 c                   eval      rltrl7_levr = rtdkto
6.24 c                   endif
6.24  *
6.24 c                   if        rtlfak <> *blank
6.24  *
6.24 c                   eval      rltrl7_raar = rtraar
6.24 c                   eval      rltrl7_lfak = rtlfak
6.24 c     rltrl7_key    chain     rltrl7
6.24  *
6.24 c                   if        %found
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Lev.faktnr. brukt før dette år'
6.24 c                   exsr      msg_rtrx
6.24 c                   endif
6.24 c                   endif
      *----------------------------------------------------------------
6.23  * Behandle referansenr
6.23  *
      *  Hvis ikke kunde eller leverandør hoppes test av referanse over
     c                   if        (rtdkto < ra1hkt and
     c                              rtckto < ra1hkt)  or
6.23 c                             rtrefn  = 0
     c                   goto      ref_utgang
     c                   endif
6.29  *   Bare dersom det kjøres fra klienten.
6.29 c                   if        w_klient <> 'J'
6.29 c                   goto      ref_utgang
6.29 c                   endif
6.23  *
      *  Hvis leverandørpostering, hopp til x_lever
     c                   if        rtdkto >= ra1hrs or
     c                             rtckto >= ra1hrs
     c                   goto      x_lever
     c                   endif
6.23  *   Kunde
     c     x_kunde       tag
      *  Sjekk om både referanse og avkrysset
      *
     c                   eval      rtx2lu_ist = *blank
     c                   eval      rtx2lu_emb = w_memb
     c                   eval      rtx2lu_grp = *blank
     c                   eval      rtx2lu_fir = rtfirm
     c                   eval      rtx2lu_unt = rtbunt
     c                   eval      rtx2lu_ref = rtrefn
     c     rtx2lu_key    chain     rtx2lu
     c                   if        %found(rtx2lu)
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Ikke Refnr og avkryssing samtidig'
6.23 c                   exsr      msg_rtrx
6.23 c                   endif
      *  Finn referanse på kunden
      *
6.23 c                   eval      rktrl8_kund = *zero
6.23 c                   if        rtdkto > ra1hkt and
6.23 c                             rtdkto < ra1hrs
6.23 c                   eval      rktrl8_kund = rtdkto
6.23 c                   endif
6.23 c                   if        rtckto >  ra1hkt and
6.23 c                             rtckto <= ra1hrs
6.23 c                   eval      rktrl8_kund = rtckto
6.23 c                   endif
6.23 c                   if        rktrl8_kund > 0
6.23 c                   eval      rktrl8_biln = rtrefn
6.23 c     rktrl8_key    chain     rktrl8
6.23 c                   if        not %found(rktrl8)
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Ref.nr ukjent på kunde'
6.23 c                   exsr      msg_rtrx
     c                   goto      ref_utgang
     c                   else
6.23 c                   if        (rtdkto = rktrl8_kund and
6.23 c                              rnrest > 0)             or
6.23 c                             (rtckto = rktrl8_kund and
6.23 c                              rnrest < 0)
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Ref.nr mot feil post'
6.23 c                   exsr      msg_rtrx
6.23 c                   endif
6.23 c                   endif
6.23 c                   endif
     c                   goto      x_ok
      *
6.23  *   Leverandør     sven
     c     x_Lever       tag
6.23 c                   eval      rltrl8_levr = *zero
6.23 c                   if        rtdkto >= ra1hrs
6.23 c                   eval      rltrl8_levr = rtdkto
6.23 c                   endif
6.23 c                   if        rtckto >= ra1hrs
6.23 c                   eval      rltrl8_levr = rtckto
6.23 c                   endif
6.26  *    Krysset mot Ref.nr
6.26 c                   if        rtkrys <> 'S'
6.23 c                   if        rltrl8_levr > 0
6.23 c                   eval      rltrl8_biln = rtrefn
6.23 c     rltrl8_key    chain     rltrl8
6.23 c                   if        not %found(rltrl8)
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Ref.nr ukjent på lever'
6.23 c                   exsr      msg_rtrx
     c                   goto      ref_utgang
     c                   endif
6.23 c                   if        rorest = 0
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Ref.nr avkrysset før  '
6.23 c                   exsr      msg_rtrx
     c                   goto      ref_utgang
     c                   endif
6.23 c                   if        (rtdkto = rltrl8_levr and
6.23 c                              rorest > 0)             or
6.23 c                             (rtckto = rltrl8_levr and
6.23 c                              rorest < 0)
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Ref.nr mot feil post'
6.23 c                   exsr      msg_rtrx
     c                   goto      ref_utgang
6.23 c                   endif
6.23 c                   if        (rtdkto = rltrl8_levr and
6.23 c                              rorest <> rtbelØ)        or
6.23 c                             (rtckto = rltrl8_levr and
6.23 c                              rorest <> rtbelØ * -1)
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Krysset mot feil beløp'
6.23 c                   exsr      msg_rtrx
     c                   goto      ref_utgang
6.23 c                   endif
6.23 c                   endif
6.26  *    Krysset mot Samleref.nr
6.26 c                   else
6.26 c                   eval      rltrl5_samb = rtrefn
6.26 c     rltrl5_key    setll     rltrl5
6.26 c     rltrl5_key    reade     rltrl5
6.26 c                   eval      w_samb_bel = 0
6.26 c                   dow       rosamb = rtrefn and
6.26 c                             not %eof(rltrl5)
6.26 c                   if        rolevr = rltrl8_levr
6.26 c                   eval      w_samb_bel = w_samb_bel + rorest
6.26 c                   endif
6.26 c     rltrl5_key    reade     rltrl5
6.26 c                   enddo
6.26  *    Ingen poster funnet å krysse mot
6.26 c                   if        w_samb_bel = 0
6.26 c                   eval      x = x + 1
6.26 c                   eval      fei(x) = 'Krysset mot feil referanse'
6.26 c                   exsr      msg_rtrx
6.26 c                   goto      ref_utgang
6.26 c                   endif
6.26  *    Krysset mot beløp stemmer ikke
6.26 c                   if        w_samb_bel * -1 <> rtbelØ
6.26 c                   eval      x = x + 1
6.26 c                   eval      fei(x) = 'Krysset mot feil beløp'
6.26 c                   exsr      msg_rtrx
6.26 c                   goto      ref_utgang
6.26 c                   endif
6.26  *
6.26 c                   endif
      *
     c     x_Ok          tag
      *    Hopp ut dersom ikke kunde eller leverandørpostering
     c                   if        rktrl8_kund = *zero and
     c                             rltrl8_levr = *zero
     c                   goto      ref_utgang
     c                   endif
      *
      *    Sjekk om flere betalinger mot samme referanse
      *
     c                   eval      rtx2lu_ist = *blank
     c                   eval      rtx2lu_emb = rtmemb
     c                   eval      rtx2lu_grp = *blank
     c                   eval      rtx2lu_fir = rtfirm
     c                   eval      rtx2lu_unt = rtbunt
     c                   eval      rtx2lu_ref = rtrefn
     c     rtx2lu_key    chain     rtx2lu
     c                   if        not %found(rtx2lu)
     c                   eval      rx2ist = rtx2lu_ist
     c                   eval      rx2emb = rtx2lu_emb
     c                   eval      rx2grp = rtx2lu_grp
     c                   eval      rx2fir = rtx2lu_fir
     c                   eval      rx2unt = rtx2lu_unt
     c                   eval      rx2ref = rtx2lu_ref
     c                   eval      rx2bel = rnbelØ
     c                   eval      rx2rst = rnrest
     c                   endif
     c                   if        rtdkto > ra1hrs or
     c                             rtckto > ra1hrs
     c                   eval      w_belop = rtbelØ * -1
     c                   else
     c                   eval      w_belop = rtbelØ
     c                   endif
     c                   if        w_belop > rx2rst
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Restbeløp på Ref.nr for lite'
6.23 c                   exsr      msg_rtrx
6.23 c                   eval      x = x + 1
6.23 c                   eval      fei(x) = 'Har du krysset faktura før? '
6.23 c                   exsr      msg_rtrx
     c                   else
     c                   eval      rx2rst = rx2rst - rtbelØ
     c                   endif
     c                   if        %found(rtx2lu)
     c                   update    rtx2lur
     c                   else
     c                   write     rtx2lur
     c                   endif
      *
6.23 c*                  endif
      *
     c     ref_utgang    tag
      *
      *----------------------------------------------------------------
6.36 c                   goto      kid_slutt
      *
6.24  * Kontroll av KID-felt
6.24  *
6.24 c                   if        rtkidi = *blank
6.28 c                   goto      kid_slutt
6.28 c                   endif
6.24  *
6.24 c                   movea     rtkidi        tegn
6.24 c     1             do        25            n
6.24 c                   if        tegn(n) <> ' '
6.24 c                   if        (tegn(n) < '0' or
6.24 c                              tegn(n) > '9') and
6.24 c                              tegn(n) <> '-'
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Feil tegn i kid'
6.24 c                   exsr      msg_rtrx
6.24 c                   goto      kid_slutt
6.24 c                   endif
6.24 c                   endif
6.24 c                   enddo
6.24  *
6.24  * Dersom KID-feltet er utfylt med KID, så blir det først
6.24  * høyrejustert, og deretter modulustestet.
6.24  *
6.24 c                   movea     rtkidi        kid
6.24 c                   eval      v = 25
6.24 c                   eval      w = 25
6.24 c                   eval      nyki = *blanks
6.24  *
6.24 c                   dow       v >= 1
6.24  *
6.24 c                   if        kid(v) >= '0' and
6.24 c                             kid(v) <= '9' or
6.24 c                             kid(v) = '-'
6.24 c                   move      kid(v)        nyki(w)
6.24 c                   eval      w = w - 1
6.24 c                   endif
6.24  *
6.24 c                   eval      v = v - 1
6.24 c                   enddo
6.24 c                   movea     nyki          w_kidi
6.24 c                   move      w_kidi        w_sist
6.24 c                   movel     w_kidi        w_ki24
6.24 c                   movea     w_ki24        tall
6.24 c                   eval      p_tall = w_kidi
6.24 c                   eval      p_rkod = *off
6.24  *
6.24 c                   exsr      xmod10
6.24 c     xno1          tag
6.24  *
6.24 c                   if        p_rkod = *on and
6.24 c                             ktr <> w_sist
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Feil sjekksiffer i KID'
6.23 c                   exsr      msg_rtrx
6.24 c                   endif
6.27  *    -----------------------------------------------------------
6.27  *    Sjekk om kort kidd og denne finnes og trans finnes på kunde
      * >> Kunde
6.27 c                   if        w_ptyp = 'K'
      *  >> Kort Kid
6.27 c                   if        %subst(rtkidi:10:5) = *blank
6.27  *    Sjekk om kort kidd og max 7 posisjoner
6.27 c                   if        %subst(rtkidi:10:5) = *blank and
6.27 c                             %subst(rtkidi:14:5) <> *blank
6.27 c                   eval      x = x + 1
6.27 c                   eval      fei(x) = 'Kort KID er for lang'
6.27 c                   exsr      msg_rtrx
6.27 c                   goto      kid_slutt
6.27 c                   endif
6.27 c                   eval      akidl1_firm = rtfirm
6.27 c                   eval      w_kidr = %subst(rtkidi:1:6)
6.27 c                   move      w_kidr        akidl1_kidr
6.27 c     akidl1_key    chain     akidl1
6.27 c                   if        not %found(akidl1)
6.27 c                   eval      x = x + 1
6.27 c                   eval      fei(x) = 'Ukjent kort KID'
6.27 c                   exsr      msg_rtrx
6.27 c                   goto      kid_slutt
6.27 c                   endif
6.28  * Lang kid fra akidpf må høyrejusteres
6.28  *
6.28 c                   movea     akkidd        kid
6.28 c                   eval      v = 25
6.28 c                   eval      w = 25
6.28 c                   eval      nyki = *blanks
6.28  *
6.28 c                   dow       v >= 1
6.28  *
6.28 c                   if        kid(v) >= '0' and
6.28 c                             kid(v) <= '9' or
6.28 c                             kid(v) = '-'
6.28 c                   move      kid(v)        nyki(w)
6.28 c                   eval      w = w - 1
6.28 c                   endif
6.28  *
6.28 c                   eval      v = v - 1
6.28 c                   enddo
6.28 c                   movea     nyki          akkidd
6.28  *    <=   Ikke Kort Kid
6.28 c                   else
6.28 c                   move      w_kidi        akkidd
      *    << End Kort/lang kid   Lang kid ligger nå i akkidd
6.28 c                   endif
      *   Ikke kontroll av KID i følge Terje S. 25.10.2012
     c                   goto      kid_slutt
6.27  *   Stemmer kundenr med konto på postering
6.27 c                   eval      w_kidkto = %subst(akkidd:13:6)
6.27 c                   move      w_kidkto      w_kidktn
6.27 c                   if        w_kidktn <> rtckto and
6.27 c                             w_kidktn <> rtdkto
6.27 c                   eval      x = x + 1
6.27 c                   eval      fei(x) = 'Kunde,KID <> kunde,Post'
6.a7 c                   exsr      msg_rtrx
6.27 c                   goto      kid_slutt
6.27 c                   endif
6.27 c*  kort, ikke      else
6.27 c                   eval      w_kidbnr = %subst(akkidd:19:6)
6.27 c                   move      w_kidbnr      w_kidbnn
6.27 c                   eval      rktrl8_firm = rtfirm
6.27 c                   eval      rktrl8_kund = w_kidktn
6.27 c                   eval      rktrl8_biln = w_kidbnn
6.27 c     rktrl8_key    chain     rktrl8
6.27 c                   if        not %found(rktrl8)
6.27 c                   eval      x = x + 1
6.27 c                   eval      fei(x) = 'Ukjent KID,bilag på kunde'
6.27 c                   exsr      msg_rtrx
6.27 c                   endif
6.27 c                   endif
6.24 c     kid_slutt     tag
      *----------------------------------------------------------------
      * Behandle prosjekt
      *
6.20 c                   if        rtpros <> *blank or
     c                             rtupro <> *blank or
     c                             rtakti <> *blank or
     c                             rtarbo <> *blank
     c                   exsr      beh_prosj
     c                   endif
      *----------------------------------------------------------------
6.30  * Sjekk at forfalldato-år ikke er før forfallsdato-år
6.31  *   Hvis før 2040 går datotester i ball ?????
6.31 c                   if        rtbilk < 5
6.30 c                   move      rtbdat        w_bartst
6.30 c                   move      rtfdat        w_fartst
6.31 c*                  eval      w_rutine = 'Forfall-å'
6.31 c*                  except    debug
6.30 c                   if        %subst(w_fartst:1:4) <> *blank and
6.31 c                             %subst(w_fartst:1:4) <> '0001' and
6.30 c                             %subst(w_fartst:1:4) <
6.30 c                             %subst(w_bartst:1:4)
6.30 c                   eval      x = x + 1
6.30 c                   eval      fei(x) = 'Forfalls-år før bilags-år'
6.30 c                   exsr      msg_rtrx
6.31 c*                  if        %subst(w_fartst:1:4) < '2040'
6.31 c*                  eval      rtfdat = *loval
6.31 c*                  endif
     c                   goto      forf_ok
6.30 c                   endif
6.31 c                   endif
      *
      * Sjekk at forfallsdato er maks 1 år fram i tid
      *
     c                   time                    w_dato
     c     w_dato        adddur    1 : *y        w_dato
     c                   if        rtfdat > w_dato
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Forfallsdato for langt fram'
6.23 c                   exsr      msg_rtrx
     c                   if        rtfdat > w_maxdat
     c                   eval      rtfdat = w_maxdat
     c                   endif
     c                   endif
      *
      * Sjekk bilagsdato > forfallsdato
      *
     c                   if        rtfdat <> *loval and
     c                             rtbdat > rtfdat
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Bilagsdato > forfallsdato'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c     forf_ok       tag
      *----------------------------------------------------------------
      *
      * Behandle valuta
      *
     c                   if        rtvalk <> *blank
E5.20c                   eval      ra16l1_kod = rtvalk
E5.20c     ra16l1_key    chain     ra16l1
      *
E5.20c                   if        not %found
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Valuta mangler i koderegister'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
      *
      * Valutabeløp uten valutakode
      *
     c                   if        rtvalb <> *zero  and
     c                             rtvalk = *blank
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Valutabeløp uten valutakode  '
6.23 c                   exsr      msg_rtrx
     c                   endif
      *----------------------------------------------------------------
      *
      * Behandle virksomhet
      *
     c                   if        rtvirk <> *blank
E5.20c                   eval      ra23l1_kod = rtvirk
E5.20c     ra23l1_key    chain     ra23l1
      *
E5.20c                   if        not %found
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Virksomhet mangler i kodereg.'
6.23 c                   exsr      msg_rtrx
     c                   endif
6.24 c                   endif
      *----------------------------------------------------------------
      * Behandle avkryssing
      *
     c                   if        rtkrys <> ' ' and
     c                             rtkrys <> 'S' and
     c                             rtkrys <> 'X'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Avkryssingskode feil'
6.23 c                   exsr      msg_rtrx
     c                   endif
6.24  *
6.24  * Avkryssing = X og referansenummer finnes
6.24  *
6.24 c                   if        rtkrys = 'X' and
6.24 c                             rtrefn <> *zero
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'Ikke "X" og ref.nr samtidig.'
6.24 c                   exsr      msg_rtrx
6.24 c                   endif
6.24  *
6.24  * Avkryssing = S og referansenummer finnes ikke
6.24  *
6.24 c                   if        (rtkrys = 'S'    and
6.24 c                              rtrefn = *zero)    and
     c                             (rtckto > ra1hkt or
     c                             rtdkto > ra1hkt)
6.24 c                   eval      x = x + 1
6.24 c                   eval      fei(x) = 'X-kode "S" og ref.nr mangler'
6.24 c                   exsr      msg_rtrx
6.24 c                   endif
      *----------------------------------------------------------------
6.24  *
6.24  * Attestasjonskode forskjellig fra 1 eller 0,  gir 1
6.24  *
6.24 c                   if        rtatte <> '1' and
6.24 c                             rtatte <> ' '
6.24 c                   move      1             rtatte
6.24 c                   endif
      *
     c                   endsr
      *
     c/eject
      *
     c     beh_konto     begsr
      *
     c                   eval      rhovlr_kont = w_kont
     c                   eval      rhovlr_spes = w_spes
     c                   eval      rhovlr_avde = w_avde
     c     rhovlr_key    chain     rhovlr                             63
      *
     c                   if        *in63 = *on
     c                   eval      rhovlr_avde = *zeros
     c     rhovlr_key    chain     rhovlr                             63
      *
     c                   if        *in63 = *on
     c                   eval      rhovlr_spes = *zeros
     c     rhovlr_key    chain     rhovlr                             63
      *
     c                   if        *in63 = *on
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto mangler i kontoplan'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   endif
      *
     c                   endif
      *
      * Konto sperret
      *
     c                   if        rhsprk = 'J'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto er sperret'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Konto skal ha prosjekt, men mangler i postering
      *
E5.00c                   if        rhproj = 'J' and
6.20 c**                           rtpros = 0
6.20 c                             rtpros = *blank
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto skal ha prosjekt'
6.23 c                   exsr      msg_rtrx
     c                   endif
6.22  *
6.22  * Konto skal IKKE ha prosjekt, men posteringen har prosjekt
6.22  *
6.22 c                   if        rhproj = 'N' and
6.22 c                             rtpros <> *blank
6.22 c                   eval      x = x + 1
6.22 c                   eval      fei(x) = 'Konto skal IKKE ha prosjekt'
6.23 c                   exsr      msg_rtrx
6.22 c                   endif
      *
      * Konto skal ha avdeling, men mangler i postering
      *
     c                   if        rhavdk = 'J' and
     c                             w_avde = 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto skal ha avdeling'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Konto skal IKKE ha avdeling, men postering har det
      *
     c                   if        rhavdk = 'N' and
     c                             w_avde <> 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Konto skal IKKE ha avdeling'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Sjekk avdeling
      *
     c                   if        w_avde <> 0
E5.20c                   eval      ra07l1_kod = w_avde
R5.20c     ra07l1_key    chain     ra07l1r
      *
E5.20c                   if        not %found
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Avdeling mangler i kodereg.'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
      *
T5.00c                   if        ra3bÆr = 'J'
T5.00 * Dersom kostnadsbærer brukes, skal den kontrolleres
      *
T5.00 * Konto skal ha kostnadsted, men mangler i postering
      *
T5.00c                   if        rhbÆrk = 'J' and
T5.00c                             w_spes = 0
T5.00c                   eval      x = x + 1
T5.00c                   eval      fei(x) = 'Konto skal ha k.bærer '
6.23 c                   exsr      msg_rtrx
T5.00c                   endif
      *
T5.00 * Konto skal ikke ha kostnadsted, men utfylt i postering
      *
T5.00c                   if        rhbÆrk = 'N' and
T5.00c                             w_spes <> 0
T5.00c                   eval      x = x + 1
T5.00c                   eval      fei(x) = 'Konto skal ikke ha k.bærer '
6.23 c                   exsr      msg_rtrx
T5.00c                   endif
      *
T5.00 * Sjekk kostnadsbærer
      *
T5.00c                   if        w_spes <> 0
T5.20c                   eval      ra28l1_kod = w_spes
T5.20c     ra28l1_key    chain     ra28l1r
      *
E5.20c                   if        not %found
T5.00c                   eval      x = x + 1
T5.00c                   eval      fei(x) = 'K.bærer mangler i kodereg.'
6.23 c                   exsr      msg_rtrx
T5.00c                   endif
T5.00c                   endif
      *
T5.00c                   endif
      *
      * Sjekk mva-kode
      *
     c                   if        w_mvak <> *blank and
     c                             w_mvak <> '0'
      *
E5.20c                   eval      ra05l1_kod = w_mvak
E5.20c     ra05l1_key    chain     ra05l1r
      *
E5.20c                   if        not %found
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'MVA-kode mangler i kodereg.'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Ugyldig mva-overstyring
      *
     c                   if        rhmvao = 'N' and
     c                             rhmvak <> '0'and
     c                             rhmvak <> w_mvak
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'MVA-kode er overstyrt '
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   endif
      *

      *
     c                   if        w_mvak = *blank or
     c                             w_mvak = '0' or
     c                             w_mvak = '4'
      *
      * Ugyldig mva-overstyring
      *
     c                   if        rtgmva <> 0
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'MVA-kode - MVA-gr.lag '
6.23 c                   exsr      msg_rtrx
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Kontakt ASP kundesenter'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   endif
      *
      * Sjekk mva-grunnlag - postert beløp for avg.pliktig
      *
     c                   if        w_mvak = '1' or
     c                             w_mvak = '3'
      *
      * Mvagrunnlag <> postert beløp
      *
     c                   if        rtgmva <> 0 and
5.61 c                             rtgmva  > rtbelØ and
5.61 c                             w_aspuser <> 'ASP_'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Postert < MVA-gr.lag '
6.23 c                   exsr      msg_rtrx
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Kontakt ASP kundesenter'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   endif
      *
      * Årsoppgjør eller saldo
      *
T5.40c                   if        rtbilk = 85
     c                   if        w_mvak  <> *blank and
     c                             w_mvak  <> *zeros
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Bilagskode kan ikke ha mvakode'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
      *
      * Sjekk valuta mot konto
      *
     c                   if        rhvalk <> *blank and
     c                             rtvalk <> rhvalk
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Valutakode ugyldig for konto'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   endsr
      *
     c/eject
      *
      * Behandle kundeposteringer
      *
     c     beh_kunde     begsr
      *
     c                   move      w_kont        rkunlr_kund
     c     rkunlr_key    chain     rkunlr                             62
      *
      * Ugyldig kundenummer
      *
     c                   if        *in62 = *on
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Kundenummer er ugyldig'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Kunde sperret
      *
     c                   if        rksprk = 'J'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Kundenummer er sperret'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Kunden har ikke valuta
      *
     c                   if        rtvalk <> 'NOK'
     c                   if        rtvalk <> *blank and
     c                             rkvalk = *blanks
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Kunde har ikke valuta '
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Valuta postering <> valuta kunde
      *
     c                   if        rtvalk <> *blank and
     c                             rtvalk <> rkvalk
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Valutakode feil for kunde  '
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
      *
     c                   endsr
     c/eject
      *
      * Behandle leverandørposter
      *
     c     beh_lever     begsr
      *
     c                   move      w_kont        rlevlr_levr
     c     rlevlr_key    chain     rlevlr                             63
      *
      * Leverandørnumme ugyldig
      *
     c                   if        *in63 = *on
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Leverandør mangler    '
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Leverandør sperret
      *
     c                   if        rlsprk = 'J'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Leverandør sperret    '
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Leverandør uten valuta, nullstill
      *
     c                   if        rtvalk <> *blank and
     c                             rlvalk = *blanks
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Leverandør har ikke valuta'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
      * Valuta postering <> valuta leverandør
      *
     c                   if        rtvalk <> *blank and
     c                             rtvalk <> rlvalk
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Valutakode feil for leverandør'
6.23 c                   exsr      msg_rtrx
     c                   endif
      *
     c                   endsr
     c/eject
      *
      * Behandle prosjekt
      *
     c     beh_prosj     begsr
      *
     c                   select
      *  Prosjekt, Underprosjekt og aktivitet
     c                   when      rtakti <> *blank
     c                   eval      rp3alr_frm = rtfirm
     c                   eval      rp3alr_pro = rtpros
     c                   eval      rp3alr_upr = rtupro
     c                   eval      rp3alr_akt = rtakti
     c     rp3alr_key    chain     rp3alr
     c                   if        not %found(rp3alr)
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Aktivitet ugyldig'
6.23 c                   exsr      msg_rtrx
     c                   else
     c                   if        rp3sts = 'A'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Aktivitet avsluttet'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
      *  Prosjekt og Underprosjekt
     c                   when      rtupro <> *blank
     c                   eval      rp2ulr_frm = rtfirm
     c                   eval      rp2ulr_pro = rtpros
     c                   eval      rp2ulr_upr = rtupro
     c     rp2ulr_key    chain     rp2ulr
     c                   if        not %found(rp2ulr)
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'UnderProsj.ugyldig'
6.23 c                   exsr      msg_rtrx
     c                   else
     c                   if        rp2sts = 'A'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'UnderProsj.avsluttet'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
      *  Prosjekt
     c                   when      rtpros <> *blank
     c                   eval      rp1plr_frm = rtfirm
     c                   eval      rp1plr_pro = rtpros
     c     rp1plr_key    chain     rp1plr
     c                   if        not %found(rp1plr)
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Prosjekt ugyldig'
6.23 c                   exsr      msg_rtrx
     c                   else
     c                   if        rp1sts = 'A'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Prosjekt avsluttet'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
      *
     c                   endsl
      *  Arb.ordre
     c                   if        rtarbo <> *blank
     c                   eval      rp4olr_frm = rtfirm
     c                   eval      rp4olr_ord = rtarbo
     c     rp4olr_key    chain     rp4olr
     c                   if        not %found(rp4olr)
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Arb.Ordre ugyldig'
6.23 c                   exsr      msg_rtrx
     c                   else
     c                   if        rp4sts = 'A'
     c                   eval      x = x + 1
     c                   eval      fei(x) = 'Arb.Ordre avsluttet'
6.23 c                   exsr      msg_rtrx
     c                   endif
     c                   endif
     c                   endif
      *
     c                   endsr
6.24  *
6.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.24  * Subrutine for modulus 10 kontrol
6.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.24  *
6.24 c     xmod10        begsr
6.24  *
6.24 c                   call      'RÅ910R'
6.24 c                   parm                    p_tall
6.24 c                   parm                    p_rkod
6.24  *
6.24  * Mod 11 kalles opp dersom feil ved mod 10.
6.24  *
6.24 c                   if        p_rkod = *on
6.24 c                   exsr      xmod11
6.24 c                   endif
6.24  *
6.24 c                   endsr
6.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.24  * Subrutine for modulus 11 kontrol
6.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.24  *
6.24 c     xmod11        begsr
6.24  *
6.24  * Legger KID-felt over i hjelpefelt.
6.24  *
6.24 c                   eval      tell = 0
6.24 c                   eval      psum = 0
6.24 c                   eval      vekt = 1
6.24 c                   eval      v = 25
6.24  *
6.24 c                   dow       v > 1
6.24 c                   eval      v = v - 1
6.24 c                   if        tell = 6
6.24 c                   eval      tell = 0
6.24 c                   eval      vekt = 1
6.24 c                   endif
6.24 c                   eval      vekt = vekt + 1
6.24 c                   move      tall(v)       faktor
6.24 c                   eval      prod = faktor * vekt
6.24 c                   eval      psum = psum + prod
6.24 c                   eval      tell = tell + 1
6.24 c                   enddo
6.24  *
6.24 c     psum          div       11            divtal
6.24 c                   mvr                     rest
6.24  *
6.24 c                   if        rest = 1
6.24 c                   move      '-'           ktr
6.24 c                   else
6.24 c                   eval      difktr = 11 - rest
6.24 c                   move      difktr        ktr
6.24 c                   if        rest = 0
6.24 c                   move      0             ktr
6.24 c                   endif
6.24 c                   endif
6.24  *
6.24 c                   endsr
6.23  *
6.23  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.23  * msg_rtrx  Legge ut feilmelding i rtrxpf                         *
6.23  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.23  *
6.23 c     msg_rtrx      begsr
6.23  *
6.23 c                   eval      rtrxlu_ist = *blank
6.23 c                   eval      rtrxlu_emb = rtmemb
6.23 c                   eval      rtrxlu_fir = rtfirm
6.23 c                   eval      rtrxlu_unt = rtbunt
6.23 c                   eval      rtrxlu_inj = rtlinj
6.23 c                   eval      rtrxlu_tel = 1
6.23 c     rtrxlu_key    chain     rtrxlu
6.23 c                   dow       %found(rtrxlu)
6.23 c                   if        rx1msg = fei(x)
6.23 c                   goto      msg_ok
6.23 c                   endif
6.23 c                   eval      rtrxlu_tel = rtrxlu_tel + 1
6.23 c     rtrxlu_key    chain     rtrxlu
6.23 c                   enddo
6.23 c                   eval      rx1msg = fei(x)
6.23 c                   eval      rx1emb = rtmemb
6.23 c                   eval      rx1fir = rtfirm
6.23 c                   eval      rx1unt = rtbunt
6.23 c                   eval      rx1inj = rtlinj
6.23 c                   eval      rx1tel = rtrxlu_tel
6.23 c                   write     rtrxlur
6.23 c     msg_ok        tag
6.23  *
6.23 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
T5.60 * M1WIN Behandle bilde for melding med svar                       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
T5.60c     xm1win        begsr
      *
6.23 c                   open      rf104d
T5.60c                   eval      wsavli = 6
T5.60c                   eval      wsavpo = 9
T5.60c                   eval      w_arow = wsavli
T5.60c                   eval      w_acol = wsavpo
      *
T5.60c                   exfmt     m1win
      *
T5.60c                   if        *inkc = *on
T5.60c                   move      'N'           m1svar
T5.60c                   endif
6.23 c                   close     rf104d
      *
T5.60c                   endsr
      *
     c/eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * ERROR-rutine
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c**s  *pssr         begsr
      *
6.23 c**s                if        w_klient = 'J'
6.10 c**s                eval      w_stat = 1
6.10 c**s                eval      w_jsta = 40
6.10 c**s                eval      w_jmld = 'Fatal feil i RF104R'
6.10 c**s                call      'AB705R'
6.10 c**s                parm                    w_jkey
6.10 c**s                parm                    w_jsta
6.10 c**s                parm                    w_jmld
610  c**s                move      *on           *inlr
610  c**s                goto      slutt
6.23 c**s                endif
      *
     c**s                endsr
      *
      *
6.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.33  * Finner spool som er generert av jobben
6.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.33 c     spoolnbr      begsr
6.33  /Free
6.33
6.33           QSPRILSP( SPRL0100
6.33                   : %size(SPRL0100)
6.33                   : 'SPRL0100'
6.33                   : errorcode );
6.33  /End-free
6.33  *
6.33 c                   endsr
6.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.33  * Kaller eget program for generering av xml fil. Eget pgm         *
6.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.33 c     xml_create    begsr
6.33  *
6.33 c                   eval      splfname2 = *blanks
6.33 c                   eval      splfname3 = *blanks
6.33 c                   eval      jobname2 = *blanks
6.33 c                   eval      jobname3 = *blanks
6.33 c                   eval      username2 = *blanks
6.33 c                   eval      username3 = *blanks
6.33 c                   eval      jobnbr2 = *blanks
6.33 c                   eval      jobnbr3 = *blanks
6.33 c                   eval      splfnbr2 = *zeros
6.33 c                   eval      splfnbr3 = *zeros
6.33 c                   eval      p_btyp = 'FEILLISTE'
6.33 c                   eval      p_dspl = 'Feilliste - journal '+
6.33 c                                      %char(w_date)
6.33 c                   eval      p_refn = %char(w_year)+%char(w_date)
6.33 c                   eval      p_tagg0 = 'KJOREDATO'
6.33 c                   eval      p_tagg0val = %char(w_date)
6.33 c                   eval      p_tagg1 = *blanks
6.33 c                   eval      p_tagg1val = *blanks
6.33 c                   eval      p_tagg2 = *blanks
6.33 c                   eval      p_tagg2val = *blanks
6.33 c                   eval      p_tagg3 = *blanks
6.33 c                   eval      p_tagg3val = *blanks
6.33 c                   eval      p_tagg4 = *blanks
6.33 c                   eval      p_tagg4val = *blanks
6.33 c                   eval      p_tagg5 = *blanks
6.33 c                   eval      p_tagg5val = *blanks
6.33 c                   eval      p_tagg6 = *blanks
6.33 c                   eval      p_tagg6val = *blanks
6.33 c                   eval      p_tagg7 = *blanks
6.33 c                   eval      p_tagg7val = *blanks
6.33 c                   eval      p_tagg8 = *blanks
6.33 c                   eval      p_tagg8val = *blanks
6.33 c                   eval      p_tagg9 = *blanks
6.33 c                   eval      p_tagg9val = *blanks
      *
6.33 c                   call      'AP627R'
6.33 c                   PARM                    splfname
6.33 c                   PARM                    jobname
6.33 c                   PARM                    username
6.33 c                   PARM                    jobnbr
6.33 c                   PARM                    splfnbr
6.33 c                   PARM                    splfname2
6.33 c                   PARM                    jobname2
6.33 c                   PARM                    username2
6.33 c                   PARM                    jobnbr2
6.33 c                   PARM                    splfnbr2
6.33 c                   PARM                    splfname3
6.33 c                   PARM                    jobname3
6.33 c                   PARM                    username3
6.33 c                   PARM                    jobnbr3
6.33 c                   PARM                    splfnbr3
6.33 c                   parm                    p_tagg0
6.33 c                   parm                    p_tagg0val
6.33 c                   parm                    p_tagg1
6.33 c                   parm                    p_tagg1val
6.33 c                   parm                    p_tagg2
6.33 c                   parm                    p_tagg2val
6.33 c                   parm                    p_tagg3
6.33 c                   parm                    p_tagg3val
6.33 c                   parm                    p_tagg4
6.33 c                   parm                    p_tagg4val
6.33 c                   parm                    p_tagg5
6.33 c                   parm                    p_tagg5val
6.33 c                   parm                    p_tagg6
6.33 c                   parm                    p_tagg6val
6.33 c                   parm                    p_tagg7
6.33 c                   parm                    p_tagg7val
6.33 c                   parm                    p_tagg8
6.33 c                   parm                    p_tagg8val
6.33 c                   parm                    p_tagg9
6.33 c                   parm                    p_tagg9val
6.33 c                   parm                    l_bach
6.33 c                   parm                    p_btyp
6.33 c                   parm                    p_refn
6.33 c                   parm                    p_dspl
6.33  *
6.33 c                   endsr
6.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.33  * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
6.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.33 c     pdf_preview   begsr
6.33 c                   if        l_skje = 1
6.33  * Vi kaller program for launch av PDF i browser
6.33 c                   call      'AP621R'
6.33 c                   parm                    l_bach
6.33  *
6.33 c                   endif
6.33  *
6.33 c                   endsr
6.33  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
     c                   eval      p_tell = 0
      *
      * Key for firma-opplysninger - firmaregister
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for kontoplan
      *
     c     rhovlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhovlr_kont
     c                   kfld                    rhovlr_spes
     c                   kfld                    rhovlr_avde
      *
      * Key for kunder
      *
     c     rkunlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunlr_kund
6.23  *
6.23  * Key for kunde-transer
6.23  *
6.23 c     rktrl8_key    klist
6.23 c                   kfld                    w_firm
6.23 c                   kfld                    rktrl8_kund
6.23 c                   kfld                    rktrl8_biln
6.24  *
6.24  * Key for kunde-transer
6.24  *
6.24 c     rktrlb_key    klist
6.24 c                   kfld                    w_firm
6.24 c                   kfld                    rktrlb_raar
6.24 c                   kfld                    rktrlb_biln
6.23  *
6.23  * Key for feiltranser til klient
6.23  *
6.23 c     rtrxlu_key    klist
6.23 c                   kfld                    rtrxlu_ist
6.23 c                   kfld                    rtrxlu_emb
6.23 c                   kfld                    rtrxlu_fir
6.23 c                   kfld                    rtrxlu_unt
6.23 c                   kfld                    rtrxlu_inj
6.23 c                   kfld                    rtrxlu_tel
      *
      * Key for leverandører
      *
     c     rlevlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rlevlr_levr
6.24  *
6.24  * Key for leverandørposteringer
6.24  *
6.24 c     rltrlc_key    klist
6.24 c                   kfld                    w_firm
6.24 c                   kfld                    rltrlc_raar
6.24 c                   kfld                    rltrlc_biln
6.26  *
6.26  * Key for leverandørposteringer
6.26  *
6.26 c     rltrl5_key    klist
6.26 c                   kfld                    w_firm
6.26 c                   kfld                    rltrl5_samb
6.24  *
6.24  * Key for leverandørposteringer
6.24  *
6.24 c     rltrl7_key    klist
6.24 c                   kfld                    w_firm
6.24 c                   kfld                    rltrl7_levr
6.24 c                   kfld                    rltrl7_raar
6.24 c                   kfld                    rltrl7_lfak
6.24  *
6.24  * Key for leverandørposteringer
6.24  *
6.24 c     rltrl8_key    klist
6.24 c                   kfld                    w_firm
6.24 c                   kfld                    rltrl8_levr
6.24 c                   kfld                    rltrl8_biln
6.24  *
6.24  * Key for hovedbokstransposteringer
6.24  *
6.24 c     rhtrl4_key    klist
6.24 c                   kfld                    w_firm
6.24 c                   kfld                    rhtrl4_raar
6.24 c                   kfld                    rhtrl4_biln
6.21  *
6.21  * Key for prosjekt
6.21  *
6.21 c*    rprolr_key    klist
6.21 c*                  kfld                    w_firm
6.21 c*                  kfld                    rprolr_pros
6.21 c*                  kfld                    rprolr_akti
6.21 c*                  kfld                    rprolr_kont
6.21 c*                  kfld                    rprolr_spes
6.21  *
6.21  * Key for Aktivitet
6.21  *
6.21 c     rp3alr_key    klist
6.21 c                   kfld                    rp3alr_frm
6.21 c                   kfld                    rp3alr_pro
6.21 c                   kfld                    rp3alr_upr
6.21 c                   kfld                    rp3alr_akt
6.21  *
6.21  * Key for Underprosjekt
6.21  *
6.21 c     rp2ulr_key    klist
6.21 c                   kfld                    rp2ulr_frm
6.21 c                   kfld                    rp2ulr_pro
6.21 c                   kfld                    rp2ulr_upr
6.21  *
6.21  * Key for Prosjekt
6.21  *
6.21 c     rp1plr_key    klist
6.21 c                   kfld                    rp1plr_frm
6.21 c                   kfld                    rp1plr_pro
6.21  *
6.21  * Key for Arbeidsordre
6.21  *
6.21 c     rp4olr_key    klist
6.21 c                   kfld                    rp4olr_frm
6.21 c                   kfld                    rp4olr_ord
      *
T5.00 * Key for aktivitet
      *
T5.00c     ra21l1_key    klist
T5.00c                   kfld                    w_firm
T5.00c                   kfld                    ra21l1_kod
      *
      * Key for faste konti
      *
     c     ra04l1_key    klist
     c                   kfld                    w_firm
      *
      * Key for statusopplysninger - koderegister
      *
     c     raa1l1_key    klist
     c                   kfld                    w_firm
      *
T5.00 * Key for statusrecord 3
      *
T5.00c     raa3l1_key    klist
T5.00c                   kfld                    w_firm
      *
      * Key for sist brukte nr. - koderegister
      *
     c     raa4l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    raa4l1_4aar
      *
T5.20 * Key for bilagskode
      *
T5.20c     ra01l1_key    klist
T5.20c                   kfld                    w_firm
T5.20c                   kfld                    ra01l1_kod
      *
T5.20 * Key for momskode
      *
T5.20c     ra05l1_key    klist
T5.20c                   kfld                    w_firm
T5.20c                   kfld                    ra05l1_kod
      *
T5.20 * Key for avdeling
      *
T5.20c     ra07l1_key    klist
T5.20c                   kfld                    w_firm
T5.20c                   kfld                    ra07l1_kod
      *
T5.20 * Key for valutakode
      *
T5.20c     ra16l1_key    klist
T5.20c                   kfld                    w_firm
T5.20c                   kfld                    ra16l1_kod
      *
T5.20 * Key for virksomhet
      *
T5.20c     ra23l1_key    klist
T5.20c                   kfld                    w_firm
T5.20c                   kfld                    ra23l1_kod
      *
T5.20 * Key for kostnadsbærer
      *
T5.20c     ra28l1_key    klist
T5.20c                   kfld                    w_firm
     c                   kfld                    ra28l1_kod
6.23  *
6.23  * Key for test av avkryssingstrans
6.23  *
6.23 c     rtx2lu_key    klist
6.23 c                   kfld                    rtx2lu_ist
6.23 c                   kfld                    rtx2lu_emb
6.23 c                   kfld                    rtx2lu_grp
6.23 c                   kfld                    rtx2lu_fir
6.23 c                   kfld                    rtx2lu_unt
6.23 c                   kfld                    rtx2lu_ref
6.23  *
6.23  * Key for lese rtrzl2   finne alle som er krysset i denne linja
6.23  *                       for å finne ev. diff som skal være igjen
6.23 c     rtrzl2_key    klist
6.23 c                   kfld                    rtrzl2_emb
6.23 c                   kfld                    rtrzl2_fir
6.23 c                   kfld                    rtrzl2_unt
6.23 c                   kfld                    rtrzl2_inj
6.23  *
6.23  * Key for lese rtrzl3   finne alle refnr i denne bunt
6.23  *
6.23 c     rtrzl3_key    klist
6.23 c                   kfld                    rtrzl3_emb
6.23 c                   kfld                    rtrzl3_fir
6.23 c                   kfld                    rtrzl3_unt
6.27  *
6.27  * Key for kontoll av kort kidd
6.27  *
6.27 c     akidl1_key    klist
6.27 c                   kfld                    akidl1_firm
6.27 c                   kfld                    akidl1_kidr
6.40  *
6.40  * Key for lese rtral4
6.40  *
6.40 c     rtral4_key    klist
6.40 c                   kfld                    rtral4_nivo
6.40 c                   kfld                    rtral4_memb
6.40 c                   kfld                    rtral4_firm
6.40 c                   kfld                    rtral4_biln
7.39 c                   kfld                    rtral4_raar
7.39 c                   kfld                    rtral4_rper
6.40 c                   kfld                    rtral4_linj
7.39  *
7.39  * Key for lese rtral4
7.39  *
7.39 c     rbunl1_key    klist
7.39 c                   kfld                    rbunl1_nivo
7.39 c                   kfld                    rbunl1_memb
7.39 c                   kfld                    rbunl1_firm
7.39 c                   kfld                    rbunl1_bunt
      *
     c     *entry        plist
610  c                   parm                    w_memb
     c                   parm                    p_feil
     c                   parm                    p_tell
6.23 c                   parm                    w_jkey
6.23 c                   parm                    w_stat
8.00  *  Kjøres det i batch?  Da er w_batch = 0
8.00 c                   call      'AP700C'
8.00 c                   parm                    w_batch
      *
6.23 c                   if        w_stat = 7
6.23 c                   eval      w_klient = 'J'
6.23 c                   else
6.23 c                   eval      w_klient = 'N'
6.23 c                   endif
6.23 c                   eval      w_stat = *zero
5.61 c                   movel     l_user        w_aspuser
      *
6.33 c                   open      rf104p
6.33 c                   eval      w_year = *year
6.33 c                   time                    w_date
6.41  *
6.41  *   Sjekk om tilatt med diff i bilag
6.41  *   Dato i prameter OPPD_ØK_M_DIFF gjelder kun for max to dager
6.41  *   Det gjelder for gitt dato + dagen før.  Dvs max en dag fram.
6.41  *
6.41   Til_M_Diff = *blank;
6.41   w_idag = %date();
6.41   CallP CO402R(l_filg:w_firm:0:'OPPD_ØK_M_DIFF':
6.41                    co402_verdi1:co402_verdi2);
6.41   if co402_verdi1 = '1';
6.41    w_dd = %dec(%subst(co402_verdi2:1:2):2:0);
6.41    w_mm = %dec(%subst(co402_verdi2:4:2):2:0);
6.41    w_aa = %dec(%subst(co402_verdi2:7:4):4:0);
6.41    w_ndag = w_dd * 10000 + w_mm * 100 + w_aa -2000;
6.41    w_pdat = %date(w_ndag:*dmy);
6.41    if w_idag = w_pdat
6.41       or w_idag = w_pdat - %days(1);
6.41         Til_M_Diff = 'J';
6.41    endif;
6.41   endif;
      *
     c                   endsr
      *
     o**sfdebug   e            debug
     o**                       w_rutine            12
     o**                                              '<'
     o**                       rtbelØ              25
     o**                                              '<'
     o**                       rtvalb              40
     o**                                              '<'
     o**                       w_klient            55
     o**                                              '<'
     o**                       rtmemb              70
     o**                                              '<'
     o*                       rtbdat              25
     o*                       rtfdat              38
     o*                       w_bartst            52
     o*                       w_fartst            66
     o*                       l_usrid            128
**
Det er differanse debet/kredit i kontroll/journal.
Bekreft dersom dette er riktig.
Dette er ikke lov etter 01.01.2020, Jobb avbrytes.
