# RPG Program Explanation: HO703R — Terminal Order Header Upload

## Overview

This RPG program, part of the ASLAGR system, is named `HO703R` and designed to process order header data uploaded from handheld terminals ("håndterminal") into the system. It reads a source file (presumably with order transactions), and for each entry, creates records in two files: an order header file and an order line file.

---

## File Declarations

```rpg
fhbtrpf    if   e           k disk
fhohelu    uf a e           k disk    rename(hohepfr:hohelur)
fhodtlu    uf a e           k disk    rename(hodtpfr:hodtlur)
```

- **hbtrpf**: Input file, likely the source of terminal uploads.
- **hohelu**: Output file, order headers, renamed for internal use.
- **hodtlu**: Output file, order lines, renamed for internal use.

---

## Data Definitions

### Local Data Area & Variables

```rpg
d                uds
d l_firm                944    946  0
```
- Accesses the User Data Space (LDA) to retrieve the current company/firm identifier (`l_firm`, 3 bytes at position 944).

### Hand Terminal Record Layout

```rpg
d                 ds
d d_ht                          34
d  d_ht_kund                     6  0 overlay(d_ht)
d  d_ht_refn                     6  0 overlay(d_ht:7)
d  d_ht_vare                     8    overlay(d_ht:13)
d  d_ht_enhe                     3    overlay(d_ht:21)
d  d_ht_anta                    11    overlay(d_ht:24)
```
- Defines a 34-byte data structure `d_ht`, with overlays for its fields:
  - `d_ht_kund`: Customer number
  - `d_ht_refn`: Reference number
  - `d_ht_vare`: Item number
  - `d_ht_enhe`: Unit
  - `d_ht_anta`: Quantity (as alphanumeric)

### Working Variables

```rpg
d b_hode          s              1    inz(*off)
d w_firm          s                   like(hofirm)
d w_anta_alf      s             11
```
- `b_hode`: Controls if header has been written (*off = not yet).
- `w_firm`: Company/firm code, for output.
- `w_anta_alf`: Work variable for manipulating alphanumeric quantity.

---

## Mainline Logic

```rpg
c                   goto      avslutt
```
- **NOTE:** This line immediately jumps to the program end (`avslutt`). This is a placeholder (see comment "Hopper ut uten behandling"), likely for testing or staged development.

### If the placeholder is removed:

- The code reads each record from `hbtrpf`, processes with the subroutine `behandling`, and continues until the end of file:
  ```rpg
  c                   read      hbtrpf                                 90
  c                   dow       *in90 = *off
  c                   exsr      behandling
  c                   read      hbtrpf                                 90
  c                   enddo
  ```

---

## Subroutines

### behandling: Handle Each Input Row

```rpg
c     behandling    begsr
c                   eval      d_ht = hoinfo
c                   if        d_ht_vare = *blank
c                   goto      end_behandl
c                   endif
```
- Loads the current record into `d_ht`.
- If item number (`d_ht_vare`) is blank, skips further processing for this row.

#### Write Order Header (If Not Already Written)

```rpg
c                   if        b_hode = *off
c                   eval      hofirm = w_firm
c                   eval      horefn = d_ht_refn
c                   eval      hokund = d_ht_kund
c                   eval      hoselg = 0
c                   eval      hostat = 0
c                   time                    hodato
c                   time                    hotime
c                   write     hohelur
c                   eval      b_hode = *on
c                   endif
```
- If header hasn't been written for this order, populates order header fields (firm, reference, customer, etc.), sets status and seller to 0, writes date/time, writes the record, and sets the flag to prevent duplicate headers.

#### Write Order Line

```rpg
c                   eval      hdfirm = w_firm
c                   eval      hdrefn = d_ht_refn
c                   movel     d_ht_vare     hdvare
c                   eval      hdenhe = d_ht_enhe
c                   eval      w_anta_alf = %subst(d_ht_anta:1:8) +
c                                          %subst(d_ht_anta:10:2) + '0'
c                   move      w_anta_alf    hdanta
c                   time                    hddato
c                   time                    hdtime
c                   write     hodtlur
```
- Sets up order line fields, transforms the quantity string (`d_ht_anta`) with some extraction and concatenation logic, and writes the order line record.

#### End of Subroutine

```rpg
c     end_behandl   endsr
```

---

### *inzsr: Initialization Subroutine

```rpg
c     *inzsr        begsr
c                   eval      w_firm = l_firm
c                   endsr
```
- At program start, retrieves the firm code from the LDA and stores in a work variable.

---

## Program Ending

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Standard end-of-program code: set last record indicator and return.

---

## Summary

**What this program does:**
- Reads each uploaded order record from a terminal file.
- For each order, creates an order header (once) and one or more order lines.
- Fields are mapped from the handheld terminal file to the order files.
- Special extraction is done for the quantity field (possibly to correct formatting).
- Initialization and program termination are handled explicitly.

**Note:** Currently, main logic is bypassed by the initial `goto avslutt`, meaning processing is disabled until this line is removed.

---

## Onboarding Hints

- To enable full processing, remove or comment out the `goto avslutt`.
- Understand the source file content and structure; field overlays must match.
- Order headers are written once per batch, lines for each item.
- Pay attention to the manipulation of quantity (`d_ht_anta`), as it is formatted in a non-standard way.
- Adapt file names/field names as needed if underlying files change.