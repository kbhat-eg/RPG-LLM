# JW100R – Product Packaging Maintenance  
## Business Purpose

This program is the main maintenance module for "Vare-pakning" (product packaging) in the ASVADM system. It is used to maintain packaging information for products, including adding, editing, copying, viewing, and deleting packaging records. The program supports multiple units (sales, purchase, price book), packaging classes, and GTIN (Global Trade Item Number) handling, and is adapted for a variety of business requirements and evolving data models.

## High-Level Structure

- **Screen-based interactive program** using subfiles (workstn file `jvw100d`).
- **Subfile-driven navigation** for listing and selecting packaging records.
- **Modular, subroutine-based logic** for each major operation (add, edit, delete, copy, validate).
- **Heavy use of indicators** for field protection, error signaling, and UI state.
- **Integration with several master files**: product, supplier, unit, and packaging files.

## Key Data Relationships

- **Packaging records** are keyed by product and packaging code, with optional supplier/module keys.
- **Units** (sales, purchase, price book) are maintained and validated against master tables.
- **Supplier information** is fetched and displayed as part of packaging context.
- **Firm-specific field protection** is supported via the AVALPF file.

## Files and Data Sources

- `jvpklr`, `jvpklu`, `jvpkl1`, `jvpkl3`: Packaging master files (read, update, and list access).
- `jforl5`, `jforl1`, `jforlu`: Packaging unit mapping files (for units at various levels).
- `jvarl1`: Product master file.
- `jlevl1`: Supplier master file.
- `venhl1`: Unit master file (for unit descriptions).
- `avall1`: Field protection/validation control file.
- `jvw100d`: Workstation file with subfiles and screens for user interaction.

## Key Business Logic and Conventions

### Indicators

- **UI/Navigation**: 10 (rollup), 11 (rolldown), 12/13/14/15 (subfile control), 21/22 (cursor/home), 30 (field protection).
- **Error/Feedback**: 31–79 (error signals/messages).
- **Working**: 80–99 (internal state).

### Subfile Handling

- **Subfile B1SFL** is used to display and edit packaging records for a product.
- Supports paging, selection, and direct record manipulation (edit, copy, delete, view).

### Packaging Record Maintenance

- **Add/Edit/View/Delete/Copy** logic is routed through dedicated subroutines (`xc1bld`, `xc2bld`, `xd1win`, `xk1win`).
- **Validation** includes:
    - Existence of units in the master table.
    - Mandatory fields and value checks (e.g., conversion factors, GTIN/EAN checks).
    - Uniqueness of GTIN within the product.
    - Special handling for supplier numbers in the 9XXXXX range (bypassing some EAN checks).
- **Field protection** is dynamically determined based on company policy via the `avall1` file.

### Unit Handling

- **Three unit types** are tracked for each packaging:
    - Sales unit (`saen`)
    - Purchase unit (`inen`)
    - Price book unit (`pben`)
- **Business rules** enforce that price book units must also be selected as sales units.

### GTIN/EAN Handling

- **GTIN** field is validated for correctness via external program (`FØ900R`).
- **Uniqueness**: No two packagings for the same product may share the same GTIN, unless for the same record.
- **Bypass**: Suppliers in the 9XXXXX range are exempt from EAN validation.

### Copy and Delete Functions

- **Copy**: Prompts for new packaging code and supplier, validates, then invokes the edit/create logic.
- **Delete**: Prompts for confirmation, then deletes the selected packaging record.

### Field Protection

- **Dynamic field protection** is implemented by reading the `avall1` file for the program and company, setting indicators for fields to be protected on the screen.

### Initialization

- **On program entry**, parameters for company, product, and optionally supplier are loaded.
- **Product and supplier info** are fetched and displayed.
- **Unit selections** are loaded from packaging unit files, with fallback logic if not found at the most granular level.

### Error Handling

- **Screen indicators** are set for specific errors (e.g., missing units, duplicate GTIN, invalid EAN).
- **Error messages** are shown via dedicated screens (e.g., `c1msg`).

## Notable Design Patterns & Conventions

- **Subroutine-centric design**: All major operations are encapsulated in named subroutines for maintainability and clarity.
- **Indicator-driven UI state**: RPG indicators are systematically used for field protection, error signaling, and navigation.
- **Separation of concerns**: File IO, business rules, and UI logic are cleanly separated.
- **Extensive use of file-level keys**: Multiple key lists are defined for different access patterns (e.g., lookup, update, list, validation).
- **Versioning and change log**: Program includes a detailed header with version and change tracking, reflecting continuous adaptation to business needs.

## Integration Points

- **External validation programs**: EAN/GTIN validation (`FØ900R`).
- **Search text update**: Calls to `JV790R` to update search texts after changes.
- **Unit selection dialog**: Calls to `VA510R` for unit selection.

## Special Notes / Domain-Specific Considerations

- **"Forpakning"** refers to packaging at the product level, with possible variations by supplier/module.
- **Unit selection logic** is critical for downstream processes like sales, purchasing, and pricing.
- **Field protection** is company- and program-specific, allowing for flexible business rule enforcement.
- **GTIN/EAN handling** is business-critical for logistics and compliance.
- **Legacy and recent enhancements**: The codebase shows a long history of incremental improvements, especially in unit handling, GTIN/EAN, and UI field protection.

## Summary of Main Subroutines

| Subroutine     | Purpose                                                                                 |
|----------------|----------------------------------------------------------------------------------------|
| `forny`        | Refreshes the subfile, repositions and reloads records.                                |
| `subfile`      | Handles user actions on the subfile (edit, copy, delete, view, etc.).                  |
| `xc1bld`       | Handles creation of new packaging records.                                              |
| `xc1msg`       | Displays message if attempting to create a record that already exists.                  |
| `xc2bld`       | Handles edit/view of a packaging record, including validation and update logic.         |
| `xd1win`       | Handles the delete confirmation and deletion of a packaging record.                     |
| `xk1win`       | Handles the copy operation for packaging records.                                       |
| `clr_subfile`  | Clears the subfile for a new page or refresh.                                           |
| `crt_subfile`  | Loads the subfile with packaging records for the current product/supplier.              |
| `bck_subfile`  | Handles paging backwards in the subfile.                                                |
| `dsp_subfile`  | Displays the subfile control screen.                                                    |
| `sjekk_forpakn`| Validates the subfile input for required fields and business rules.                     |
| `oppd_forpakn` | Updates the packaging unit mapping after changes in the subfile.                        |
| `skrb_c2`      | Determines which fields should be protected on the C2BLD screen, based on company rules.|
| `sjekk_ean`    | Calls external program to validate GTIN/EAN numbers.                                    |
| `sjekk_input`  | Validates input values and fetches descriptions during create/copy.                     |

---

## Typical Workflow

1. **Entry:** Program is called with company, product, and optionally supplier.
2. **Initialization:** Product and supplier info, unit selections are loaded.
3. **Subfile Display:** User sees a list of packaging records for the product.
4. **Actions:** User can add, edit, copy, view, or delete packaging records.
5. **Validation:** All actions are validated for business rules (units, GTIN/EAN, field requirements).
6. **Update:** Changes are written to master files, and search texts are updated.
7. **Exit:** Program ends, releasing resources.

---

## Points for New Developers

- **Understand the domain**: Packaging in this context is not just a container, but a business object with complex rules and relationships.
- **Be mindful of indicators**: They are central to UI and business logic flow.
- **Follow subroutine boundaries**: Extending or modifying logic should respect the modular structure.
- **When in doubt, check AVALPF**: Field protection is dynamic—test changes with varying company settings.
- **GTIN/EAN logic is critical**: Always validate changes for compliance.
- **Refer to the change log**: Many business rules are the result of historical requirements—consult the header for context.

---

For further details on data models (file layouts, field meanings), refer to the data dictionary and system documentation, as this program assumes deep integration with the ASVADM domain model.