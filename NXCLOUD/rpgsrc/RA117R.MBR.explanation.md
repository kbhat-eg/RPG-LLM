# RA117R - Documentation

## Overview

**System:** ASOKON  
**Program:** RA117R  
**Description:** Maintenance of Shipping Methods (“Forsendelsesmåter, vedlikehold”)

This program provides a maintenance interface for shipping methods, allowing users to view, add, update, copy, and delete shipping method records. The program is designed to work with subfiles for efficient record browsing and editing. It contains several business-specific enhancements, such as integration with the Regional Distribution Center (RDS), SMS notifications, and a "side register" (sideregister).

## Key Business Concepts

- **Shipping Methods:** Each record represents a method of shipping, with associated codes, descriptions, and additional business attributes (e.g., notification settings, office handling).
- **Subfile Browsing:** The main UI is a subfile, allowing users to page through, select, and edit records efficiently.
- **Side Register (Sideregister):** An additional register related to shipping methods, added for extended business requirements.
- **RDS Integration:** Special maintenance for records tied to the Regional Distribution Center.
- **SMS Notification:** Some shipping methods can trigger SMS notifications to customers/sellers.

## Main Components and Structure

### Files

- **fra17l1, fra17l2, fra17lr, fra17lu:** Main shipping method master files, each with a specific role (list, description, read, update).
- **fraf2lu, fraf2l1:** Side register files, introduced in version 8.02.
- **fra117d:** Display file with subfile (B1SFL) and various screens for maintenance tasks.

### Local Data Area (LDA)

- Used to retrieve session/user context, e.g., current user (`l_user`), company/firm (`l_firm`), and user name (`l_fnav`).

### Key Variables

- **w_firm:** Current company/firm code, used throughout as a key field.
- **w_srrn, w_sfrn, w_ssrn, w_spge:** Subfile navigation and paging variables.
- **b_oppr, b_forn, b_anul, b_feil:** Boolean flags controlling operational state (e.g., in create mode, needs refresh, cancel, error).
- **w_seqe:** Determines current search or display mode (by code or by description).

### Indicators

- **LR:** End program.
- **10/11:** Rollup/Rolldown (paging).
- **12/13/14/15:** Subfile display and control.
- **21/22:** Home key and cursor positioning.
- **30:** Field protection.
- **31-79:** Error and screen indicators.
- **80-99:** Work indicators.

## Main Program Flow

1. **Initialization (`*inzsr`):**
    - Sets up key lists for all file access.
    - Loads company/firm from LDA.
    - Positions the database to the start and builds the initial subfile page.

2. **Main Loop:**
    - Displays the main subfile screen (`b2ctl`).
    - Handles function keys for navigation, create, update, copy, delete, and special actions.
    - Supports positioning by code or description.
    - Calls subroutines for subfile handling, record maintenance, and screen refreshes.

3. **Subfile Handling:**
    - **Display (`dsp_subfile`):** Shows the subfile, enables relevant indicators.
    - **Create (`crt_subfile`):** Fills the subfile with records from the database.
    - **Clear (`clr_subfile`):** Clears the subfile and resets navigation variables.
    - **Back (`bck_subfile`):** Pages backward in the list.
    - **Subfile Actions (`subfile`):** Handles edit, copy, delete, view, and RDS actions based on user selection.

4. **Maintenance Screens:**
    - **Create New (`xc1bld`):** Handles new record creation, with validation and duplicate checking.
    - **Edit/View (`xc2bld`):** Handles editing or viewing of an existing record, including updates to the side register.
    - **Delete (`xd1win`):** Handles record deletion, with confirmation.
    - **Copy (`xk1win`):** Handles copying of an existing record to a new key.

5. **Special Features:**
    - **RDS Maintenance:** If selected, calls an external program (`RA136R`) for RDS-related records.
    - **Side Register Maintenance:** When editing, also updates the side register file (`fraf2lu`).
    - **SMS Notification, Office Handling:** Fields and logic present for these business requirements.

## Notable Design Decisions & Conventions

- **Subfile Paging:** The program uses a fixed page size (`c_sfil`) and carefully tracks the current, first, and last record numbers for efficient navigation.
- **Key Lists:** All database access uses explicit key lists, making it easy to maintain and extend key structures.
- **Indicator Usage:** The program uses a consistent indicator scheme for UI and logic control, as documented in the header comments.
- **Modular Subroutines:** All major actions (create, edit, delete, copy, refresh, subfile operations) are encapsulated in subroutines for clarity and maintainability.
- **Versioning and Business Adaptations:** The code is heavily commented with version numbers and business-specific adaptations (e.g., Skattum, Byggmakker, RDS).
- **Display File Structure:** Multiple screens are defined for different actions (subfile, control, command keys, create/edit forms, message windows), supporting a rich user interface.

## Relationships to Other Modules

- **RA136R:** Called for RDS maintenance when action code 8 is selected in the subfile.
- **Other Files:** The program expects the main shipping method files and side register files to be present and keyed by firm and code.

## Business/Domain-Specific Logic

- **Direct Selection:** The system supports direct selection of records by code or description for efficient user navigation.
- **Copy Protection:** When copying, the system checks for duplicate keys and prevents overwriting existing records.
- **Error Handling:** Uses indicators and message screens to guide the user through errors or invalid input.
- **Field Protection:** When viewing (not editing), fields are protected to prevent accidental changes.
- **SMS and Office Handling:** Extended fields for advanced notification and office-specific processing, reflecting evolving business needs.
- **Regional Distribution Center (RDS):** Special handling and maintenance logic for records associated with RDS.

## Summary Table: Key User Actions and Program Responses

| Action              | Key/Indicator | Subroutine(s)      | Description                                                   |
|---------------------|---------------|--------------------|---------------------------------------------------------------|
| Rollup/Rolldown     | F10/F11       | crt_subfile/bck_subfile | Page forward/back in subfile                                  |
| Create              | F6            | xc1bld, xc2bld     | Bring up create screen, validate, and add new record          |
| Edit/View           | Select (2/5)  | xc2bld             | Edit or view selected record                                  |
| Copy                | Select (3)    | xk1win, xc2bld     | Copy selected record to new key                               |
| Delete              | Select (4)    | xd1win             | Confirm and delete selected record                            |
| RDS Maintenance     | Select (8)    | Call RA136R        | External maintenance for RDS-related records                  |
| Refresh             | F5            | forny              | Refresh subfile display                                       |
| Position by Key/Desc| Input fields  | posisjoner         | Position subfile to specific code or description              |

## Typical Program Flow Example

1. **Startup:** Loads and displays the first subfile page.
2. **User pages forward:** F10 pressed, `crt_subfile` called, next page displayed.
3. **User selects record to edit:** Enters '2' on a line, `xc2bld` called, edit screen shown.
4. **User saves changes:** Record updated in both main file and side register.
5. **User creates new record:** F6 pressed, `xc1bld` called, create screen shown.
6. **User enters duplicate key:** Error message displayed, user must correct.
7. **User copies a record:** Enters '3', `xk1win` called, copy screen shown, then `xc2bld` for editing new record.
8. **User deletes a record:** Enters '4', `xd1win` called, confirmation and deletion handled.

## Extensibility

- **Adding New Fields:** Extend the database files and update the relevant subfile and maintenance screens.
- **Adding New Actions:** Add new selection codes and corresponding subroutines.
- **Integrating with Other Systems:** Add new function key handlers and calls to external programs as with RDS.

## Summary

RA117R is a robust, business-centric maintenance program for shipping methods, supporting advanced navigation, editing, and integration requirements. The code is modular, well-commented, and designed for extensibility, with clear separation of UI, business logic, and file access. The program is tailored for environments with complex shipping and distribution needs, supporting both standard and business-specific workflows.