# Program LP102R – Vendor Packing Slip Information Maintenance

## Overview

**Purpose:**  
This program (`LP102R`) is a maintenance utility for vendor packing slip information. It provides CRUD (Create, Read, Update, Delete) operations on packing slip records per vendor and warehouse, using a subfile-driven interface. The program is part of the ASLAGR system and is primarily used by users to maintain packing slip levels and sampling frequencies for vendors and warehouses.

**Business Domain:**  
- **Vendor (Leverandør):** Identified by vendor number.
- **Warehouse (Lager):** Identified by warehouse code.
- **Packing slip information:** Includes packing slip level, sampling frequency, and user/audit fields.

## File Definitions and Data Relationships

- **LLPAI1** (Read-only): Main file containing vendor packing slip records.
- **LLPAIU** (Update): Used for updating/inserting/deleting packing slip records.
- **RLEVL1** (Read-only): Vendor master file, used for looking up vendor names/descriptions.

All files are keyed by company (firm), vendor number, and warehouse code. The company code is retrieved from the Local Data Area.

## Display Files

- **LP102D**: Workstation display file containing:
  - Subfile for listing packing slip records (`B1SFL`).
  - Multiple screens for add/change/view (`C1BLD`, `C2BLD`), delete (`D1WIN`), copy (`K1WIN`), and message display (`C1MSG`).

## Indicators

The program uses a well-documented indicator convention:

- **LR:** End of program.
- **10, 12, 13, 14, 15, 16, 21, 22, 30:** Subfile and display control.
- **31-79:** Error/warning indicators.
- **80-89:** Work indicators.
- **90-99:** File operation indicators.

## Core Logic and Flow

### Initialization

- On program start (`*INZSR`), the company code is loaded from the LDA.
- Keys for all file accesses are set up.
- The subfile is initially loaded with all relevant records.

### Main Loop

The program operates in a loop, displaying the subfile and responding to function keys:

- **F3/F12:** Exit.
- **F4:** Inquiry (calls sub-procedures for field lookups).
- **F5:** Refresh subfile.
- **F6:** Add new record.
- **Roll/Scroll:** Page subfile.

### Subfile Handling

- **Subfile (`B1SFL`):** Lists all packing slip records for the vendor/warehouse. Each line allows selection for:
  - Change (2)
  - Copy (3)
  - Delete (4)
  - View (5)

- **Paging:** Handles subfile paging, positioning, and refresh.

- **Positioning:** Allows positioning to a specific vendor.

### Record Operations

#### Add New (`xc1bld`)

- Displays add screen.
- Validates vendor and warehouse.
- Checks for duplicates; if found, displays a warning.
- Calls the maintenance routine (`xc2bld`) to perform the add.

#### Change/View (`xc2bld`)

- Handles both update and view, depending on context.
- Loads current values for the selected record.
- Validates input (packing slip level, sampling frequency).
- Updates or adds the record as needed.
- Updates audit fields (user, date, time).

#### Delete (`xd1win`)

- Confirms deletion.
- Deletes the record from the update file.

#### Copy (`xk1win`)

- Prompts for new vendor/warehouse.
- Validates input and checks for duplicates.
- Calls the maintenance routine to create the new record by copying data from the original.

### Field Lookups (`spørring`)

- Supports field lookups (F4) for vendor and warehouse fields.
- Calls external programs (`RL500R`, `RA510R`) to perform lookups and return values.

### Warehouse Description (`hent_lag`)

- Calls program `FØ720R` to retrieve and validate the warehouse description and related fields.
- Sets error indicator if warehouse is invalid.

### Subfile Maintenance

- **Clear Subfile (`clr_subfile`):** Clears all subfile records and resets counters.
- **Create Subfile (`crt_subfile`):** Reads records from the main file and populates the subfile, handling paging.

## Special/Non-obvious Design Decisions

- **Separation of Read and Update Files:** The use of both `LLPAI1` (read) and `LLPAIU` (update) files allows for separation of read and write logic, which can help with record locking and concurrency.
- **Subfile Paging Logic:** The subfile is paged in blocks (`c_sfil` = 14 records per page). The program maintains variables for first/last record on page, visible record, etc., to handle navigation efficiently.
- **External Program Calls:** Field lookups and warehouse validation are delegated to external programs, promoting code reuse and centralizing business logic for these operations.
- **Indicator-based Field Protection:** When viewing records, input fields are protected via indicator 30.
- **Error Handling:** Error indicators (31-33) are set for specific validation errors (e.g., missing vendor, invalid warehouse, duplicate records).

## User Interface Patterns

- **Subfile-driven interaction:** Users work from a list, select records for actions, and use function keys for navigation and operations.
- **Dedicated screens for each operation:** Add, change, view, delete, and copy each have their own display formats.
- **Message windows:** When attempting to add a duplicate record, a message window is shown and the user can cancel or retry.

## External Interfaces

- **Vendor Lookup (`RL500R`):** Used for vendor number/name lookups.
- **Warehouse Lookup (`RA510R`):** Used for warehouse code/description lookups.
- **Warehouse Info (`FØ720R`):** Retrieves warehouse details and validates warehouse codes.

## Key Variables and Data Structures

- **a_meld:** Array of informational messages for add/change/view.
- **b_forn, b_anul, b_feil:** Boolean flags for various control flows.
- **w_srrn, w_spge, w_sfrn, w_ssrn:** Subfile paging variables.
- **b1valg:** Action selected on a subfile row (2=change, 3=copy, 4=delete, 5=view).

## Error and Message Handling

- Error indicators are set for specific validation failures (e.g., missing or invalid vendor/warehouse).
- Message windows are used to inform users of duplicate records or invalid input.
- The program ensures that all error indicators and control indicators are reset after each operation.

## Maintenance/Extensibility Notes

- **Adding new fields:** Extend both the database files and the display file; update all corresponding logic in subfile and maintenance routines.
- **Changing lookup logic:** Modify the external programs (`RL500R`, `RA510R`, `FØ720R`) as needed.
- **Adding more subfile actions:** Extend the `subfile` routine and the subfile display format.

## Summary Table: Main Screens and Their Purpose

| Screen   | Purpose                                   |
|----------|-------------------------------------------|
| B1SFL    | Subfile list of packing slip records      |
| B2CTL    | Subfile control (paging, function keys)   |
| B2CMD    | Command screen for function keys          |
| C1BLD    | Add new record                            |
| C1MSG    | Message window (e.g., duplicate warning)  |
| C2BLD    | Change/View record                        |
| D1WIN    | Delete confirmation                       |
| F1WIN    | Inquiry window (hardcoded options)        |
| K1WIN    | Copy record                               |

---

**In summary:**  
This program is the primary maintenance interface for vendor packing slip information, supporting all standard maintenance operations through a subfile-driven UI, with robust validation, paging, and integration with vendor/warehouse master data. The codebase follows established RPG subfile patterns, uses indicator-based UI and error control, and delegates field lookups and validation to shared external programs for consistency across the application.