# RPG Program Explanation: "Tildeler riktig periode i.h.t. bankreferanse" (`RF121R`)

This ILE RPG program assigns the correct accounting period based on reference data, typically used for allocating transactions from a bank file to the correct fiscal period for a company. The source is an older style RPG (likely RPG III or early RPG IV / RPGLE with fixed-format C-specs) and contains both Norwegian comments and program logic.

Below is an explanation annotated with references to the relevant code sections.

---

## 1. **Program Heading and Documentation**

```rpg
/TITLE  Tildeler riktig periode i.h.t. bankreferanse
h dftname(rf121r) datedit(*dmy) option(*nodebugio)
```
- The program title states its purpose: "Assigns correct period according to bank reference."
- The `h-spec` sets the default program name, date edit format, and disables debug IO.

```rpg
* System. . . . . : ASOKON
* Program . . . . : RF121R
* Description. .. : Tildeler samme periode med lik referanse
*                   (Assign the same period for identical references)
* History:
* T5.00 * R5.00 140103 Rettet feil i WSRAAR. HFL
* T5.30 * R5.30 020605 Splitting på periode er endret HFL
```
- Provides the program description and a change log.

---

## 2. **File Declarations**

```rpg
frjoupf    up   e           k disk
fraa3l1    if   e           k disk    rename(raa3pfr:raa3l1r)
```
- File `rjoupf`: Update-capable (UP) disk file, keyed, most likely holds transaction/post records (“poster ut”).
- File `raa3l1`: Input file (IF), keyed, with renamed record format; likely contains per-firm period tables.

---

## 3. **Data Structures and Variables**

### User Data and Period Table

```rpg
d l_user                911    920
d per             s              2  0 dim(13) ctdata perrcd(13)            PERIODER
```
- `l_user`: 10-character user field.
- `per`: Array of 13 elements, each 2-digit integer, loaded from compile-time data (normally mapping months to period numbers). Used for storing period mapping for each month.

### Key Structure – for Sorting/Matching

```rpg
d                 ds
d wssort                  2     37
d  wsfirm                        3  0 overlay(wssort)
d  wsbref                       12    overlay(wssort:4)
d  waar                          2  0 overlay(wssort:18)
d  wmnd                          2  0 overlay(wssort:20)
d  wdag                          2  0 overlay(wssort:22)
```
- Defines mapping of a 36-byte (positions 2–37) record into multiple overlay fields such as company, bank reference, year, month, day, for sorting/grouping purposes.

### Working Variables (for Current Record)

```rpg
d wsraar          s                   like(rjraar)
d wsrper          s                   like(rjrper)
d w_firm          s                   like(rjfirm)
d w_memb          s                   like(rjmemb)
```
- `wsraar`, `wsrper`: Work fields for year and period, built from transaction and period tables.
- `w_firm`, `w_memb`: Work fields for current company/member.

---

## 4. **Input Specification (I-Spec)**

```rpg
irjoupfr
i                                          rjfirm        l3
i                                          rjbref        l2
i                                          rjbdat        l1
```
- Defines input key fields for `rjoupf`, for breaking/rolling at company, reference, and date.

---

## 5. **Main Logic Flow**

### a. **Selection by Member (`rjmemb`)**

```rpg
610  c                   if        rjmemb > w_memb
610  c                   move      *on           *inlr
610  c                   goto      end
610  c                   endif
610  c                   if        rjmemb <> w_memb
610  c                   move      *off          *inl1
610  c                   move      *off          *inl2
610  c                   move      *off          *inl3
610  c                   goto      end
610  c                   endif
```
- If the member in the record is greater than the working member, end program (`*inlr`), else if not equal, reset break indicators and end. Effectively processes records only for one member at a time.

---

### b. **Break on Company (`l3`)**

```rpg
     c   l3              do
*    Fetch period mapping table for the firm
     c                   move      rjfirm        w_firm
     c     raa3l1_key    chain     raa3l1                             61
     c                   if        *in61 = *off
     c                   move      ra3p01        per(01)
     c                   move      ra3p02        per(02) /* etc, for all 13 months */
     c                   endif
     c                   if        *in61 = *on
     c                   move      01            ra3stp
     c                   endif
     c                   enddo
```
- On company break (new company), fetch the period table from `raa3l1` file using company as key.
- If found (`*in61 = *off`), load periods for each month into `per` array.
- If not found, set start period to 1.

---

### c. **Break on Reference/Date**

```rpg
T5.30c   l1              do
...
     c                   move      rjsort        wssort
     c                   move      per(wmnd)     wsrper
     c                   move      2000          wsraar
     c                   move      waar          wsraar
     c                   if        wmnd < ra3stp
     c                   eval      wsraar = wsraar - 1
     c                   if        waar = *zeros
E5.00c                   eval      wsraar = 2099
     c                   endif
     c                   endif
     c                   enddo
```
- On reference break, set up sorting fields.
- Set period (`wsrper`) from period table for the month (`wmnd`).
- Calculate year (`wsraar`). If month is before the start period (`ra3stp`), decrement year.
- If year is zero, set to 2099 as a fallback/error mark.

---

### d. **Write Back Update**

```rpg
     c                   move      wsrper        rjrper
     c                   move      wsraar        rjraar
610  c                   time                    rjedat
610  c                   time                    rjetim
610  c                   eval      rjeusr = l_user
     c                   update    rjoupfr
```
- Store the calculated period and year in the output file, along with timestamp and user ID.

---

## 6. **Initialization Subroutine**

```rpg
     c     *inzsr        begsr
     ...
610  c     *entry        plist
610  c                   parm                    w_memb                         user
     ...
     c     raa3l1_key    klist
     c                   kfld                    w_firm
     c                   endsr
```
- When program starts (`*inzsr`), parses member parameter, sets up key list structure for period file chain operations.

---

## 7. **Compile-Time Array Initialization (PERIODER)**

```rpg
** TAB - NORMALT REGNSKAPSÅR
01020304050607080910111213
```
- Defines standard period values for a regular accounting year, loaded into array `per`.

---

## Summary

**Overall Flow:**
- For each record in `rjoupf` for a given member:
    - When the company changes, fetch the period/month mapping from `raa3l1`.
    - For each new bank reference (or date), compute the target year and period using the period table.
    - Update the record’s period and year, along with audit fields (user, date, time).

**Key Points:**
- Supports custom period mappings per company and fallback defaults.
- Handles "fiscal year offset" (i.e., if the month is before the start period, consider as part of prior year).
- Robust to missing period mappings, uses 2099 as a marker for missing/erroneous year situations.
- Updates are audit-stamped.

---

**Typical Usage:**  
Run this program periodically to ensure all outgoing payment records or similar bank-related transactions are assigned correct fiscal period and year, respecting each company’s fiscal calendar. The program is designed for flexibility and error handling, robustly supporting multiple clients (companies/members) within the same system.