# Comprehensive Documentation: Program RH120R (Budsjett, Vedlikehold)

## Overview

**Program:** RH120R  
**System:** ASOKON  
**Description:** Budget maintenance (Budsjett, vedlikehold)

This program is the central maintenance tool for budgeting in the ASOKON system. It allows users to view, create, update, copy, and delete budget records at various levels (account, cost carrier, department) for a given fiscal year and period. The interface is subfile-based and supports flexible navigation, data validation, and integration with several related modules (e.g., account plan, cost carrier registry, notepad, etc.).

---

## Business Domain Context

- **Budgeting in ASOKON:** Budgets are maintained per account (konto), cost carrier (kostnadsbærer/spesifikasjon), and department (avdeling), for each fiscal year (år) and period (periode). Each budget record can be further detailed by distribution keys and methods.
- **Records and Subfiles:** The program presents budget lines in a subfile (B1SFL), with navigation and operations (add, edit, copy, delete, view, etc.) managed through standard function keys and a control record (B2CTL).

---

## File and Data Structure Relationships

### Physical and Logical Files

- **rhsal1, rhsal2, rhsal3, rhsalr, rhsalu:** Budget master and detail files, keyed by combinations of firm, account, specification, department, year, and type.
- **rhovlr:** Account plan file (kontoplan).
- **ra13l1:** Budget key file (budsjettnøkkel).
- **rklal2:** Notepad (notatark) file.
- **Subfile B1SFL:** Used for displaying and editing budget lines.
- **Workstation File RH120D:** Handles display file operations (workstn, sfile).

### Data Structures

- **LDA (Local Data Area):** Used for passing user, firm, and navigation context.
- **Display Feedback (dspfbk):** Used for subfile navigation and cursor placement.

---

## Main Program Flow

1. **Initialization (`*INZSR`):**
   - Sets up keys, initializes working variables, loads default values (year, period, column headings, etc.), and positions the database for the initial subfile load.

2. **Main Loop (Tag `b2taga`):**
   - Displays the control screen (`b2cmd`), then enters the subfile display and command processing loop.
   - Handles function keys for navigation, record operations, and calls to related modules.

3. **Function Key Handling:**
   - **F3/F12:** Exit/Cancel.
   - **F4:** Field-level lookups (account, specification, department) via calls to RH500R, RA528R, RA507R.
   - **F5:** Refresh subfile.
   - **F6:** Add new budget line (calls subroutine `xc1bld`).
   - **F7/F8:** Transfers or recalculates balances via external programs.
   - **F9:** Switch between budget/alt. budget views.
   - **Roll Up/Down:** Page navigation in the subfile.
   - **Other keys:** Positioning, column editing, notepad access, etc.

4. **Subfile Operations:**
   - **Display (`dsp_subfile`):** Shows subfile or command screen.
   - **Refresh (`forny`):** Repositions and reloads subfile based on current sequence (account, department, specification).
   - **Positioning (`posisjoner`):** Positions the subfile to a specific account, specification, or department.
   - **Subfile Processing (`subfile`):** Handles row-level operations: edit, copy, delete, view, and integration with ledger transaction inquiry.

5. **CRUD Operations:**
   - **Add (`xc1bld`):** Interactive process for adding a new budget line, including duplicate checks and validation.
   - **Edit/View (`xc2bld`):** Handles both editing and viewing of budget lines, including complex validation and calculation logic.
   - **Delete (`xd1win`):** Confirms and deletes a budget line.
   - **Copy (`xk1win`):** Copies an existing budget line to a new key, with checks for duplicates.

6. **Validation and Calculation:**
   - **Account Validation (`xkonto`):** Calls RS740R to validate account, specification, and department, setting error indicators as needed.
   - **Budget Calculation (`beregn`):** Computes new budget distributions based on selected key/method/percentages, supporting several allocation methods and keys.

7. **Auxiliary Subroutines:**
   - **Clear Subfile (`clr_subfile`):** Clears subfile for reloading.
   - **Create Subfile (`crt_subfile`):** Loads subfile with records matching current filters.
   - **Back Page (`bck_subfile`):** Handles backward paging in the subfile.
   - **Column Editing (`xv1win`):** Allows editing of column definitions.
   - **Field Loading (`xc2les`):** Loads data into C2BLD screen, sets up column headers, and retrieves budget values for up to four years.

---

## Domain and Design Notes

### Indicators

- **Indicator Usage:** The program uses RPG indicators (LR, 10-99) for flow control, screen field protection, error signaling, and work flags. See in-code documentation for indicator purposes.

### Subfile Paging

- **Subfile Navigation:** Implements custom logic for paging, positioning, and refreshing the subfile, including handling of page boundaries and record number tracking.

### Multi-Year and Multi-Type Support

- **Column Headings and Data:** The system supports up to four columns, each potentially representing a different year and budget type (e.g., actual, budget, alt. budget). The user can dynamically change which years/types are displayed.

### Budget Distribution Logic

- **Distribution Keys and Methods:** Supports allocation of budget amounts using either keys (from `ra13l1`) or methods (fixed period, quarterly, etc.), and can also calculate budgets as a percentage of another account line.
- **Calculation Subroutine (`beregn`):** Handles both key-based and method-based allocation, with logic for special cases (e.g., key 99 = equal distribution).

### Integration with Other Modules

- **Account Plan (RH500R):** Used for account lookup and validation.
- **Cost Carrier Registry (RA528R) and Department Registry (RA507R):** Used for specification and department lookups.
- **Notepad (RF020R):** Allows attaching/viewing notes for a budget line.
- **Ledger Transaction Inquiry (RH512R, RH510R):** Allows inquiry into ledger transactions for the selected account/specification/department.

### Error Handling

- **User Feedback:** Error indicators (31-36, 81-85) are set based on validation results and displayed on the UI.
- **Duplicate Checking:** Prevents duplicate budget lines for the same key/year/type.

### Data Model Conventions

- **Year/Period Handling:** Period 13 is not used due to screen constraints.
- **Budget Types:** Types (3 = budget, 4 = alt. budget, etc.) are hardcoded and switchable via F9.
- **Firm Context:** All queries are filtered by the current firm (`w_firm`), which is initialized from LDA.

### Historical Comments

- **Change Log:** The code contains a detailed change log with version tags (e.g., T5.30, T5.40, 6.10), indicating ongoing maintenance and feature additions, such as GUI enhancements, field expansions, and bug fixes.

---

## Key Data Structures and Arrays

- **ISA:** Array for holding budget amounts per period (1-13, 14 = sum).
- **MFO/WFO:** Arrays for budget key/method distributions.
- **WRK:** Working array for calculated budget values.
- **TXT:** Array for column headings (actual, budget, alt. budget).

---

## Screen Layouts

- **B1SFL:** Main budget line subfile.
- **B2CTL/B2CMD:** Subfile control and command screens.
- **C1BLD/C2BLD:** Add/Edit/View screens for budget lines.
- **D1WIN/K1WIN/V1WIN:** Windows for delete, copy, and column maintenance.

---

## Notable Patterns and Conventions

- **Modularization:** All complex or repeated logic is encapsulated in subroutines, facilitating reuse and clarity.
- **Dynamic UI:** The display adapts to user selections (years, types, columns), making the interface highly flexible.
- **External Program Calls:** Integration with other modules is abstracted via parameterized program calls, following ASOKON system conventions.

---

## Summary Table: Key Functionality

| Functionality            | Subroutine/Tag | External Program | Screen/Record      |
|------------------------- |--------------- |------------------|--------------------|
| Add Budget Line          | `xc1bld`       | RH500R, RA528R, RA507R | C1BLD, C1MSG |
| Edit/View Budget Line    | `xc2bld`       | RA513R, RF020R, RH500R, RH510R | C2BLD      |
| Delete Budget Line       | `xd1win`       | -                | D1WIN              |
| Copy Budget Line         | `xk1win`       | -                | K1WIN              |
| Subfile Paging           | `crt_subfile`, `bck_subfile` | - | B1SFL, B2CTL      |
| Budget Calculation       | `beregn`       | -                | -                  |
| Account Validation       | `xkonto`       | RS740R           | -                  |
| Notepad Integration      | -              | RF020R           | -                  |
| Ledger Inquiry           | -              | RH512R, RH510R   | -                  |

---

## Recommendations for New Developers

- **Understand the Budget Data Model:** Familiarize yourself with the relationships between accounts, specifications, departments, years, periods, and budget types.
- **Review External Program Interfaces:** Many operations depend on data and validation from external modules. Study the parameter lists and expected behaviors.
- **Pay Attention to Indicators:** The use of RPG indicators is pervasive and critical for both UI and logic control.
- **Test Navigation and Paging Thoroughly:** The subfile navigation logic is complex and sensitive to changes; always test paging/positioning scenarios.
- **Maintain Consistency with Existing Patterns:** When extending or modifying functionality, follow the established modular and indicator-based patterns.

---

## Additional Notes

- **Language:** Some comments and variable names are in Norwegian—refer to the in-code comments for translations where needed.
- **Extensibility:** The program is designed for extensibility, with clear separation of UI, business logic, and data access.
- **Performance:** Paging and filtering are handled at the database level via keyed access, ensuring scalability for large datasets.

---

**End of Documentation**