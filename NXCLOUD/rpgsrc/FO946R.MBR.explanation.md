# RPG ILE Program FO946R – Invoice Printing and Export

This RPG source file is for the program **FO946R**, which is the invoice print program (Fakturautskrift) for "Byggmester-faktura" and other invoice types. The code is comprehensive, with features for printing, exporting as XML (Jasper/CGIDEV2), handling different versions, and support for special business logic such as deposits, factoring, and copy printing.

Below is a structured, component-wise explanation suitable for developer onboarding:

---

## 1. **Program Header and Metadata**

- `h decedit('0.') datedit(*dmy.) option(*nodebugio)`: Set default decimal and date edit words, and disables debug I/O.
- `h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')`: No default activation group, binds to the CGIDEV2 binding directory for web/XML integration.
- `/copy hspecsbnd`: Includes a copybook for binding specifications.

### **Revision History**
There is a large block comment at the top detailing the change history. Each change is marked by version number and date with a description, useful for understanding business-driven code changes.

---

## 2. **File Definitions**

- Input files (`if e k disk ... rename(...)`): Many files are declared for reading (orders, customers, items, projects, etc.), each with their RPG-format record names.
- Output file: `fo946p o e printer infds(d_infds)`: The printer output file for invoices, with an *INFDS data structure for print control.

---

## 3. **Key Data Structures and Variables**

- **Arrays for Tax/VAT (MVA) Handling**: Arrays (e.g., `mko, msa, mgr, mbe, ...`) track up to 9 different VAT codes/rates and their calculated bases/totals.
- **Modulus 10 Calculation Arrays**: Arrays for calculating KID numbers (OCR reference numbers in Norway).
- **Input Parameter Data Structures**: `d_parm` overlays the input parameter, breaking it into year, order type, numbers, etc.
- **Printer INFDS Structure**: For monitoring print output (lines per page, current page number).
- **Local Data Area**: Several variables are defined via UDS (User Data Space) overlays, for batch, archive, mail, and other environmental flags.

---

## 4. **Key Variables for Business Logic**

- **Customer and Order Info**: Variables to hold customer, order, invoice, and project information, with various overlays and helper variables.
- **Flags for PDF/XML Export**: Boolean flags to control traditional print vs. Jasper/XML output (`b_pdfp`, `b_pdfp_first`, etc.).
- **Factoring/FTP/Deposit**: Variables track whether to process factoring, FTP export, or deposits.
- **Working variables**: For calculation, formatting, and string/number manipulation across invoice processing.

---

## 5. **Main Control Routine**

### **Order Cycle**

1. **Initialization**:
    - Call to `xstrsr` subroutine (initialize environment, read first order header).
  
2. **Order Header Processing (htag01)**:
    - Skips orders based on company, year, order type, etc.
    - Checks if invoice should be printed (facturalog, has order lines).
    - Calls `sjk_uf_log` (skip if invoice type not for print), `sjk_varlin` (skip if header has no lines).

3. **Factoring Logic**:
    - If factoring is enabled, runs factoring check and prepares factoring data.

4. **Print/Export Decision**:
    - Calls different subroutines for handling main/secondary order headers (`xhode1`, `xhode2`).

5. **Order Lines Loop**:
    - Iterates through each order line, matching order header, and calls `xvare1` to process each line (item, text, info).

6. **Order/Invoice End**:
    - At the end of an order header or invoice, totals are processed and output (`xorrab`, `xtotal`).

---

## 6. **Key Subroutines**

### **xhode1 / xhode2 – Header Handling**
- Prepares data for print/export, formats dates, sets up customer and project info, retrieves VAT rates, payment terms, and seller contact.
- Handles company/department info and possibly overrides with department data.
- Prepares variables for Jasper/XML output if in PDF export mode.
- Writes page headers and/or calls `xml_head_inv` for Jasper/XML.

### **xvare1 – Line Processing**
- Resets work fields for the line.
- Determines if line is text, F11-type (special text), or item.
- Looks up item info, line type, sets quantity/decimal logic.
- Calculates gross/net/discounted amounts.
- Handles VAT for the line.
- Accumulates to totals for invoice.
- Writes detail lines (or XML) for each product or text.

### **xarray – Array Handling for VAT**
- Updates VAT/discount summary arrays for each line.
- Used to provide VAT breaks for different codes/rates.

### **xorrab – Order Discount**
- Processes and writes (or exports as XML) the order discount lines.
- Adjusts totals accordingly.

### **xtotal – Final Totals**
- Uses the last order header for exact total.
- Handles output of “user discounts” (bruksrettsrabatt), deposit handling, and writes totals.
- Processes VAT summaries, KID/OCR number calculation, and writes invoice total line.

### **xovrfl – Overflow Handling**
- Manages page overflow, writes page headers as needed.

### **mod10 – Modulus 10 Check Calculation**
- Implements Modulus 10 checksum for KID/OCR.

### **sjk_uf_log – Check Invoice Log**
- Determines if the invoice should be printed depending on log settings, test flags, etc.

### **sjk_varlin – Check Order Lines**
- Checks if order header has corresponding order detail lines; skips if none.

### **xstrsr – Initialization**
- Sets up environment, reads first order, processes company/routine registers, Jasper/CGIDEV2/FTP/XML environment setup.
- Reads parameter block and determines print/export mode.

---

## 7. **Jasper/XML Export Subroutines**

- **xml_envm, xml_head_inv, xml_head_ord, xml_deta, xml_rabatt, xml_totaler, xml_netto, xml_vat, xml_end, etc.**
    - Each subroutine writes specific invoice sections and data as XML tags using CGIDEV2 procedures (`UpdHTMLVar`, `WrtSection`), supporting PDF/Jasper export.
    - Handles mail, FTP, and other outputs.

- **xml_topt_str, xml_topptxt, xml_bott_str, xml_bunntxt**: For handling top/bottom (header/footer) text lines as XML.

- **Hint: These routines use CGIDEV2 methods to assemble structured XML for dynamic invoice generation and export, typically for PDF conversion by external processes (JasperReports, etc.).**

---

## 8. **Supporting Features**

- **Factoring**: Special logic for handling invoices sent to factoring companies, including checks on customer and order type (see `sjk_fact`, `bygg_fact`).
- **Deposit Handling**: Support for managing and displaying deposit (advance payment) info per invoice.
- **FTP Export**: Uploads XML to FTP server or sends via mail if configured (FTP settings fetched from central register).

---

## 9. **Key Lists (KLISTs) and RPG Formatting**

- The RPG source relies heavily on KLISTs for chaining and lookups in logical files.
- Data is moved and formatted for print, export, and for further processing (e.g., different date formats, number formats, trimmed fields for XML).

---

## 10. **Special Settings & Compatibility**

- **CGIDEV2/ILE RPG Integration**: The program is designed to operate both in classic spoolfile print mode *and* in web/XML/PDF export mode, as configured by the environment and parameters.
- **Multilingual, Multi-version**: Support for different routines, formats, and configuration via various register and parameter files.
- **Error Handling & Logging**: Writes status updates to log routines (`AB705R`).

---

## 11. **Entry and Initialization**

- The program expects a packed parameter block, breaking it up for year, order type, numbers, etc.
- After environment setup, it launches the main processing loop.

---

## 12. **Typical Processing Flow**

1. **Initialization (`xstrsr`)**
2. **Read First Order Header**
3. **Loop: For Each Invoice / Order**
    - Skip/print logic (log, lines, etc.)
    - Retrieve customer/project/routine data
    - Write headers (print/XML)
    - For each order line:
        - Write product or text lines (print/XML)
        - Update totals and VAT
    - Accumulate and write discounts, totals, deposits as needed
    - Write closing sections (print/XML)
    - Move to next order
4. **Finish / Exit**

---

## 13. **Integration Points**

- Many calls to external programs (`RS205R`, `FØ703R`, etc.) for business logic calculations (VAT, payment terms, etc.).
- Uses CGIDEV2 for all HTML/XML writing when in PDF export mode.
- Logging and status updates use call-outs to central routines.

---

## 14. **Version Control and History**

- The program is extensively commented for each version/release.
- Many changes relate to Norwegian business law (factoring, KID handling, xml standards) and company-specific requirements.

---

# **Conclusion**

**FO946R** is a central program in the invoice printing/export process, handling complex business logic and output requirements. It is highly configurable, integrates with many external systems, and supports both legacy IBM i (AS/400) print flows and modern XML/PDF export scenarios. Its rich historical commentary and numerous business-specific subroutines make it critical to approach maintenance with careful attention to context, configuration, and external dependencies.

---

### **Where to Start When Onboarding**

- **Understand major data files and structures**: Know the main files for orders, customers, VAT, etc.
- **Know the print vs. export flow**: Identify which flags/fields kick in Jasper/XML mode.
- **Identify key subroutines**: `xhode1`, `xvare1`, `xtotal`, and corresponding `xml_*` routines.
- **Follow processing sequence in the main loop**.
- **Use the history section to understand why particular business rules appear as they do**.

---

**Note:** For in-depth onboarding, study the data files’ DDS layouts, external subroutine documentation, and organizational business rules driving the configuration registers.