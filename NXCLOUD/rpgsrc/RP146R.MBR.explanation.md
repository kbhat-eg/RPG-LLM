# ILE RPG Program Explanation: RP145R

## Overview

This RPG program (`RP145R`) is written for the IBM i platform (previously AS/400, iSeries).  
It is designed to **maintain project budgeted items** ("Prosjekt, vedlikehold Budjsetterte varer").  
The program updates the file `RPVAPF` (budget/project value file) by reading and consolidating data from multiple source files related to purchases, sales, and internal orders.

---

## Key Sections

### 1. Header & Maintenance Log

- **Source & Program Name:** System `ASOKON`, Program `RP145R`.
- **Date/Change Log:** Documents enhancements and bug fixes with dates and initials, e.g.:
  - `7.00` - Always fetch delivery date from specific files.
  - `8.01` - Expanded price group to 2 positions, etc.

### 2. File Definitions

- `frpvalu`: Output/update file (main budget file, `RPVAPF`), for writing/reading.
- `ffodtlp`/`ffohel1`: Purchase detail and header files.
- `fsodtlp`/`fsohel1`: Sales order detail and header files.
- `fsidtlp`/`fsihel1`: Internal order detail and header files.
- `fvotyl1`: Weather/type code file (used for filtering).

**Note:** Some files are renamed during input for clarity and to avoid naming conflicts.

### 3. Data Area & Variable Definitions

- **Local Data Area Fields:**  
  Used for user/session-level data (e.g., user ID, firm/company code).
- **Key Fields:**  
  Variables mirroring key fields in files to assist indexed access (`setll`, `chain`).
- **Work Fields:**  
  Temporary variables used during processing.

### 4. Main Logic

#### Initialization (`*inzsr` subroutine)

- **Entry Parameters:**  
  The project number (`p_pros`) is accepted as an input parameter.
- **Key Lists:**  
  RPG key lists for efficient indexed file operations are defined for each file, using relevant fields (e.g., firm, project, item, etc.).
- **Firm Initialization:**  
  Sets up the working firm variable (`w_firm`) from the data area.

#### Main Processing Steps

##### Step 1: Update from Purchase Details (`FODTPF`)

- **Purpose:**  
  For each purchase detail (`fodtlp`) matching the project, synchronize/create a record in the main budget table (`rpvalu`).
- **Process:**
  1. Set file pointer to first purchase detail for the project.
  2. Loop over all relevant records:
      - Fetch matching header data (`fohel1`), and when type-related, fetch further info (`votyl1`).
      - Only include records where the item is non-blank and additional criteria are met.
      - If a corresponding `rpvalu` record is found, update it; otherwise, write a new record.
      - Logic contains several corrections/enhancements (e.g., how delivery date is selected if missing, new fields with version numbers).
  3. Update tracking variables for item and batch.

##### Step 2: Update from Sales Order Details (`SODTPF`)

- **Same structure as purchase processing:**
  - Iterate over sales details for the project.
  - Fetch header data for additional fields.
  - Write or update a matching record in the main file.

##### Step 3: Update from Internal Order Details (`SIDTPF`)

- **Same structure as above:**
  - Process internal order details for the project.
  - Fetch associated header record.
  - Create/update the project value record (`rpvalu`).

##### Exit and Clean-up

- **Set LR Indicator:**  
  Marks the program for last record, signaling OS to close files and reclaim resources.
- **Return:**  
  Graceful program exit.

---

## Detailed Functional Flow

1. **Program starts** (receives a project number as input).
2. **Initializes** necessary variables (especially firm code).
3. **Read and process**:
    - All purchase details (`FODTPF`) for the project.
    - All sales order details (`SODTPF`) for the project.
    - All internal order details (`SIDTPF`) for the project.
4. For each relevant detail:
    - **Read matching header** for extra fields.
    - **Build key** for the master file (`RPVAPF`).
    - **Chain (search) master file** for existing entry.
    - **If exists**, update record (with business logic to handle specific fields/values).
    - **If not**, create a new record with relevant data.
5. **Repeat** until all records for the project in each file are processed.

---

## Notable Implementation Points

- **Conditional Logic–Version Control:**  
  Version numbers in comments (e.g., `7.00`, `8.01`) signal enhancements.  
  You’ll see checks like `if fdldat = *loval` (if load date is lowest/blank) to pull from a header file.
- **Use of Key Lists:**  
  Efficient navigation and searching of indexed files using RPG’s `KLIST/KFLD` constructs.
- **Locale Awareness:**  
  The code uses `datedit(*dmy)` for date formatting (day/month/year), influencing how dates are read/written.
- **Variable Naming:**  
  Prefixes indicate source (`fd` = Purchase, `sd` = Sales, `sl` = Internal, etc.).
- **Data Area as Context Container:**  
  Draws session context variables (firm, user) directly from the system data area.

---

## Summary Table

| File     | Purpose                        | When Used          |
|----------|--------------------------------|---------------------|
| RPVAPF   | Main budget/project value file  | Always (update)     |
| FODTPF   | Purchase details               | Step 1              |
| FOHEPF   | Purchase header                | Step 1              |
| SODTPF   | Sales details                  | Step 2              |
| SOHEPF   | Sales header                   | Step 2              |
| SIDTPF   | Internal order details         | Step 3              |
| SIHEPF   | Internal order header          | Step 3              |
| VOTYPF   | Weather/type - for filtering   | Only in Step 1      |

---

## Useful Tips for Onboarding

- **Business Logic:**  
  Understand how your company organizes projects and budgeted items.  
  This program expects project-consolidated information in `RPVAPF`—generated by merging purchase, sales, and internal order detail files.
- **Troubleshooting & Extending:**  
  Pay attention to the *Key Lists* and how records are chained/setll'd—file structure and indexes must match expectations.
- **Testing:**  
  To test, run with a project number and check updates in `RPVAPF` for accuracy.  
  Review update/write conditions especially for date fields and type code filtering.
- **Maintenance:**  
  When updating structure (e.g., new fields), update key lists and logic for all related files and processing steps.

---

## Conclusion

In summary, this RPG program is a batch updater that merges item-level data from purchases, sales, and internal orders into a central, per-project budget file, using a blend of careful file indexing, conditional updates, and header-detail lookups. It's modular, well-commented (with a strong change log), and designed to run efficiently for a single project at a time.