# Program VV605R – Printing Account Details for Items

This RPG program (VV605R) is part of the ASOFAK system and prints account information linked to items, grouped by various classification levels (over group, main group, under group, and status). It also supports referencing supplier (leverandør) and sorting by different criteria.

## Purpose and Flow

1. **Initialization**  
   - The program begins by reading an 80-character parameter list (`p_list`), which is copied into the local data structure (`d_list`). This data structure extracts filtering and sorting criteria such as firm number, group boundaries, item numbers, and sort orders.  
   - Key lists for different database lookups are built here, mapping the firm number (`w_firm`) and group codes to their respective files.

2. **Header Printing (Subroutine HODE)**  
   - Updates specific variables (like `a1firm`, `a1user`, `a1wsid`) with company/user/workstation information.  
   - Retrieves date/time (`w_timestamp`) and populates corresponding fields for the report header.  
   - Reads company information from file `afirl1` using the firm number as the key (to populate `a1fnav`).  
   - Sets up the parameter-based filters (from/to groups, levels, items) into the header fields (`a2fogr`, `a2fhgr`, etc.).  
   - Builds a textual representation of the chosen sort order in `a2sort`, combining sorting criteria if multiple levels of sorting are requested.  
   - Finally, writes the header records (`a1hdr`, `a2hdr`, `a3hdr`) to the printer file `vv605p`.

3. **Main Processing (Subroutine BEHANDLING)**  
   - Iterates through records in `vvawpf` (likely a work file of item records awaiting printing).  
   - For each retrieved record, the program calls subroutine `detalj` to determine the correct account references and print the detail line.

4. **Detail Printing (Subroutine DETALJ)**  
   - Uses item-related fields from `vvawpf` (e.g., `vvogrp`, `vvhgrp`, `vvugrp`, `vvldor`, etc.) to populate local fields (`d1ogrp`, `d1hgrp`, `d1ugrp`, etc.).  
   - Initializes account fields (`d1kko1`…`d1kav7`) to zero or blank.  
   - Attempts to locate a “kontohenvisning” (`khev`) from multiple sources:
     1. The current item record (`vvkhev`).
     2. Under group file (`vugrl1`).
     3. Main group file (`vhgrl1`).
     4. Over group file (`vogrl1`).
     5. Status file (`fstsl1`).  
   - If a reference is found, the program chains into `vkhvl1` to fetch the associated accounts (fields `vakko*`, `vaksp*`, `vakav*`).  
   - Writes the detail line (`d1dtl`) to the printer.  
   - Calls `overflow` to handle page overflow logic.

5. **Overflow Handling (Subroutine OVERFLOW)**  
   - If pagination requires it (`*in30` = *ON), the program reprints the header lines (`a1hdr` and `a3hdr`) before continuing.

## Notable Design Points

- **Multi-Level Group Logic**  
  The application checks multiple classification layers (item, under group, main group, over group, and status) to find the correct account reference. This tiered chaining approach is central to how the program resolves which account codes to print.

- **Sort Order Construction**  
  The parameter list includes up to four “sort flags” (`d_srt1`…`d_srt4`). The program uses a multi-step `SELECT` to build a descriptive string (`a2sort`), allowing for combined sorting criteria in the final report header.

- **File Renaming with RENAME()**  
  Each physical file (e.g., `afirpfr`, `vugrpfr`) is renamed to a local record format (e.g., `afirl1r`, `vugrl1r`) to align with site conventions. This is done to unify naming across the system and keep consistent record format references.

- **Reference to Delivery Type (Release Note R5.20)**  
  The declaration of `vkhvl1_klty` and related logic indicates an enhancement to support referencing a “leveringstype” (delivery type). The comment “Utvidet med mulighet for å kunne kontere på leveringstype” shows new functionality for processing accounts by delivery type.

- **Key Lists**  
  The definition of key lists (`afirl1_key`, `vugrl1_key`, etc.) is done using `klist` and `kfld`. This is a standard approach in this codebase for single and multiple-level lookups. Each key list references fields like `w_firm` plus the group codes, ensuring the correct record is retrieved from each file.

## Interaction with Other Modules

- **AFIRL1 (Company Info)**: Stores name and other overarching data for the firm.  
- **VUGRL1, VHGRL1, VOGRL1**: Files for under group, main group, and over group classification, respectively.  
- **FSTSL1 (Status File)**: Contains status keys that may be used when an item’s account reference is not found in the group files.  
- **VKHVL1 (Account Reference Mapping)**: The central file for retrieving the actual accounts (`vakko*`, `vakav*`) once the program resolves the “kontohenvisning” key.  
- **VVAWPF**: Input work file read in the main loop, likely holding items that need an account listing.

## Summary

VV605R is a reporting program that outputs item-driven account references based on layered group lookups. It reads a flexible parameter list guiding which firm, item ranges, and group ranges are included, along with how the output is sorted. Data is gathered from multiple files (company, group, status, account mappings), then printed in a structured layout. The program’s handling of multi-tier references and dynamic sorting is key to its design.