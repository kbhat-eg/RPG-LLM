# RPG Program: VS500R – Display and Navigation of Search Texts

## Overview

This RPG (ILE RPG/400) program handles the display and navigation of "search text" (Søketekst) information from a physical file, using a subfile-based user interface. It features paging, rolling, and some field control for maintaining state between the display and the database backend.

The code is well-commented in Norwegian, and follows classic RPG conventions (fixed-format with C-spec statements).

---

## 1. File Declarations

```rpg
fjsokl1    if   e           k disk    rename(jsokpfr:jsokl1r)
fjs500d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **jsokl1**: Input file, keyed access, renamed record format.
- **js500d**: Workstation file for the display, with a subfile (`b1sfl`) that uses the `w_srrn` variable for relative record numbers. The display file feedback data structure is linked for retrieving cursor and display state.

---

## 2. Data Structure and Variable Definitions

### Parameters & Data Structure

```rpg
d p_vare          s                   like(jsvare)
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- `p_vare`: Program parameter, same type as the field `jsvare`—likely a product/item ID.
- `dspfbk`: Information Data Structure for display file, extracts the cursor row (`d_fcrn`).

### Working Variables

- Subfile and paging control variables (`w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`).
- Status flags: `b_dupl` (duplicate), `b_oppd` (update)
- Constant: `c_sfil` (subfile page size, set to 9).

#### Comments explain the purpose of each work variable, for example:
- `w_fcrn`: First record number on page
- `w_spge`: Page size in subfile
- `w_srrn`: Relative record number in subfile

---

## 3. Display File Screens/Records

Refer to the display (`js500d`) for these screen formats:
- `B1SFL`: Subfile record
- `B2CTL`: Subfile control record (header/page control)
- `B2CMD`: Dedicated screen for command keys

---

## 4. Main Logic (Control Flow)

### Startup/Initialization

**Subroutine `*inzsr`** initializes the program:
- Loads the input parameter (`p_vare`) into `w_vare`
- Builds the key list (`jsokl1_key`) for database positioning
- Calls `crt_subfile` to fill the subfile for display

### Main Processing Loop

**Tags and Main Workflow:**
- Two main tags: `b2taga` (show command screen), `b2tagb` (display data with subfile).
- Writes `b2cmd` (command keys) screen
- Executes `dsp_subfile` to display current subfile page, then waits for user input.

**Function Key Handling**
- **Exit (F3/F12):** Set LR and leave program.
- **Refresh (F5):** Call `forny` subroutine (reload from database and refill subfile).
- **Roll Up (F10):** Call `crt_subfile` - fill additional page.
- **Roll Down (F11):** Call `bck_subfile` - go back a page (empty subroutine stub in this code).
- **Home (F21):** Set cursor position indicator.

All other keys return to the main tag loop.

---

## 5. Subroutines

### `forny` – Refresh Subfile

- Positions to the first record (`setll`).
- Calls `clr_subfile` (clear subfile).
- Calls `crt_subfile` (refill subfile from DB).

### `clr_subfile` – Clear Subfile

- Sets indicator 14 (clear subfile) and writes the control record.
- Resets all paging and record tracking variables.

### `crt_subfile` – Create/Fill Subfile

- Adjusts page and subfile record counters.
- Loops through records from `jsokl1`, reading up to a full page (using page size `c_sfil`).
- For each record found, moves data to subfile fields (`b1stek`, `b1okod`), else blank lines.
- Writes each subfile record for display.
- Updates page tracking variables (`w_sfrn`, `w_ssrn`, etc.).

### `bck_subfile` – Roll Back Subfile

- **Currently empty (stub)**. Intended to handle rolling back to previous page.

### `dsp_subfile` – Display Subfile

- If there are subfile records (`w_srrn <> 0`), turns on indicator 12 to show subfile, else writes the command screen.
- Turns on indicator 13 and does EXFMT (read/display) of `b2ctl` (subfile control).
- Turns off indicators after display.
- Captures the cursor position from the feedback data structure.

---

## 6. Entry Parameters

```rpg
c     *entry        plist
c                   parm                    p_vare
```
- The program receives an item/product number as parameter to drive the search text display.

---

## 7. Indicators

Comment header gives standard meanings to indicators (*INxx), e.g.
- `LR`: Last record (exit)
- `10`: Roll up
- `12`: Subfile display
- `13`: Subfile display control
- `14`: Subfile clear
- `15`: Subfile end
- `16`: Readc ("no more records")
- `21`, `22`: Cursor positioning
- `30`, `31-99`: Error and work indicators

---

## Summary

- This program presents a paged list of "search texts" for a given product/item, using a subfile UI.
- It supports paging, refresh, and some cursor positioning.
- The data is read from a keyed physical file and written into a subfile, which the user can browse page by page.
- The code is modular, with standard RPG C-spec processing and subroutines for all major actions.
- Roll-back (previous page) logic is stubbed and could be implemented as needed.

**This program is a good example of subfile programming in classic RPG for green-screen applications.**