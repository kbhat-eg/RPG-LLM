# RPG Program RF225R: Code Walkthrough and Explanation

This RPG (Report Program Generator) program is an interactive maintenance application for a "kortregister" (card register) system running on IBM i (formerly AS/400, iSeries). It uses subfiles for display and update and supports different card types, validation logic, and maintenance operations.

Below is a structured explanation, focusing on the key aspects of the code.

---

## 1. **Header and High-Level Structure**

- `h option(*nodebugio) datedit(*dmy)`
  - Compilation options: disables debugging for I/O operations, and specifies DD/MM/YY date format for input/output.

- **Program information/banner block**  
  Includes historical modification tracking, which is useful for understanding changes over time.

- **Indicator Usage**
  - Indicators (LR, 10-99) control various aspects like program exit, subfile control, field protection, and error/work flags.
  - Example: LR = Last Record (program end), 10 = Roll, 30 = protect fields, etc.

---

## 2. **File Declarations**

- `frukslr, fruksl1, frukslu, fra01l1, frhovl1, fvinfl1`:  
  - Physical files for main card registers, account codes, and related information.
  - Rename clause maps DDS record formats for easier local reference.

- `frf225d` (WORKSTN):  
  - Display file controlling the interactive screen, with subfile B1SFL.

---

## 3. **Data Structures and Variables**

### Parameters and Local Data

- **Parameters**: `p_firm`, `p_ofir`, ...  
  - Working storage for screen input, values passed to/from called programs (e.g., account selection).

- **Local Data Area (LDA)**:  
  - Used for session user info and company (firm) code.

- **Display Feedback DS**:  
  - `dspfbk` structure for keyboard cursor position tracking.

- **Subfile management variables**:  
  - `w_fcrn`, `w_srrn`, `w_ssrn`, etc.—manage subfile record and page positions.

- **Constants**:  
  - `c_modu` for module code, `c_sfil` for subfile page size, etc.

---

## 4. **Main Program Logic**

### Start/Initialization (`*inzsr` subroutine)
- Reads user and company info from LDA.
- Checks for additional module installation (via call to AX700R); disables main logic if missing.
- Sets file positioning for first display of subfile.

### Main Loop

- Uses a "goto-driven" interaction loop using tags, typical for classic RPG, not structured.
- Presents a subfile display to the user, handles commands (function keys), and processes requested operations (Edit, Add, Delete, Next/Prev page, etc).

#### Screen Operations

- **Subfile (B1SFL/B2CTL)**  
  - Fills, clears, navigates, and displays the card register entries in a classic green screen subfile.

- **Function Key Handling**  
  - F3/F12: Exit  
  - F5 (Refresh): Calls `forny` subroutine to refill the subfile.
  - F6 (Add): Calls `bc2bld` (initialize entry), then `xc2bld` (display input screen).
  - F10: Next page, calls `crt_subfile`.
  - F11: Previous page, calls `bck_subfile`.

- **Selection and Subfile Actions** (`subfile` subroutine):
  - Handles entry changes:  
    - 2 or 5: Edit/View
    - 4: Delete
    - 7: Transfer info (calls `RF810R` with card type parameters)

---

## 5. **Subroutines**

### Subfile Management

- **clr_subfile**:  
  Clears subfile screen/page variables and sets indicator for clearing subfile on screen.

- **crt_subfile**:  
  Fills subfile with next page of data, up to maximum per page (`c_sfil`), reads from main file.
  Writes lines to subfile to be displayed.

- **bck_subfile**:  
  Navigates back to previous page, resets subfile to show previous entries.

- **dsp_subfile**:  
  Shows the subfile and handles the control record display.

### Entry Maintenance Screens

- **xc2bld**:  
  - Shows the detailed entry (Add/Edit/View) screen.
  - Populates fields from database (if found), otherwise blanks.
  - Handles field lookup for code selections via calls to other programs (lookup account, ledger code, order info, etc.).
  - Contains extensive validation logic for all major fields (type, warehouse, valid from date, active/passive, account, etc.).
  - On validation ok: Writes the update or new record to database.
  - If display only, sets input-protection indicators.

- **bc2bld**:  
  - Initializes (blanks out) all fields for a new entry.

### Lookup and Validation

- **xf1win1/xf1nul**:  
  - Handles display and initialization of the ‘hardcoded’ value lookup window (for card types).

- **avt_tp_sh/avt_tp_fu**:  
  - Sets card type name in plain text, used for screen display.

- **xd1win**:  
  - Handles the delete operation, asking for confirmation and then deleting from file if confirmed.

---

## 6. **Supporting Logic**

### Key Lists

- Key lists (`klist`) define composite keys for file access (CHAIN, SETLL, etc.), all placed in `*inzsr`.

---

## 7. **Special Features and Enhancements**

- **Multi-version enhancements** are noted with version annotations (`6.10`, `6.30`, `6.31`, `8.00`)— new fields, new logic for card/vendor types, order info, etc.
- **Norwegian Field Names and Comments**:  
  Field and comment text is largely Norwegian; these describe business terms and logic.

---

## 8. **Error, Field, and State Handling**

- RPG indicators and screen indicators (e.g., `*in31`, `*in36`, etc.) are used to provide user messages or protect fields based on validation errors or mode (view/edit).

---

## 9. **External Program Calls**

- Calls to other programs (e.g., `RH500R`, `RA501R`, `RA510R`, `VA540R`) are used for validation and selection popups, typical of modular RPG applications.

---

## 10. **Subfile Field Mapping**

  - Subfile fields (b1skty, b1slag, etc.) are mapped to/from physical file data and screen variables using `eval` before/after subfile writes/reads.  
  - "Selection" field (`b1valg`) is used for user selection (Edit/Del/Transfer).

---

## **Summary Table**

| Section           | Purpose                                                        |
|-------------------|----------------------------------------------------------------|
| File Declarations | Define main database and display files, with record mapping    |
| Data Structures   | Working storage, parameters, display feedback, constants       |
| Main Loop         | Screen handling, command processing, goto-based navigation     |
| Subroutines       | Subfile handling, entry maintenance, validation, popups        |
| Error Handling    | Indicators, lookup, and validation routines                    |
| External Calls    | Field/code lookups via RPG program calls                      |
| Versioning        | Update history, fields and logic per requirements              |

---

## **New Developer Onboarding Notes**

- **Understand RPG indicators and their role in UI, flow, error handling.**
- **Familiarize yourself with subfile processing (RPG green screen list display).**
- **Pay attention to field names—most are Norwegian business terms related to cards.**
- **Validation logic is crucial: check all field requirements in `xc2bld`.**
- **Key lists and file I/O (CHAIN, SETLL, etc.) are at the heart of record logic.**
- **Screen input fields (subfile, detail, selection popups) are managed by display file FRF225D.**
- **Enhancements are marked by version in comments—track logic by change history.**
- **External programs (e.g., for account or order info validation) are called routinely.**
- **Program control flow is based on RPG tags and ‘goto’ statements; subroutines maintain modularity.**
- **Refer to Data Structure names and variable naming for mapping between screen, file, and working storage.**

---

## **References for Deeper Learning**

- IBM ILE RPG Reference and Subfile Processing documentation
- Internal business documentation for field definitions (especially if you need to understand business rules in Norwegian context)
- Display file DDS for FRF225D to understand field layouts and indicators

---

This walkthrough should give you a strong starting point for navigating and maintaining the RF225R card maintenance program. For any deep changes, first review the validation and subfile handling logic.