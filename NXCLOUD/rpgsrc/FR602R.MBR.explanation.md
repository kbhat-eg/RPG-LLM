# RPG Program FR602R – Explanation and Onboarding Guide

## Overview

This RPG/400 (ILE RPG with fixed-format specification) program, named **FR602R**, is designed to **print a discount matrix** (rabattmatrise) in batch mode. The program reads discount definitions, enriches them with descriptive data from related master files (e.g., customers, items, groups), stores a working copy with extra info, and generates a detailed report with calculated values, including various types of discounts and coverage rates (“dekningsgrad”, DG). It is meant to be run in batch.

### Key Functions

- **Reads main discount matrix file**
- **Completes lines with customer/project/item data**
- **Stores working copy (arbeidsfil) for processing**
- **Prints report with grouping, filtering, and calculations**
- **Calls external program (FR700R) to calculate “DG”**
- **Handles complex selection and filtering logic via parameters**

---

## Program Structure

### A. Definition Section

#### 1. Header (`H`) and Comments

- Specifies date format as *DMY*.
- Indicates the program is for batch only.
- Documents revisions and changes, using Norwegian (beskrivelse = description).

#### 2. File Declarations (`F`)

- **Input/Output Files:** Multiple files, most are keyed physical files (`IF/E`), some are output (`O`) printers.
- Files are renamed on input to distinct record formats, e.g. `frabl1` renames format `frabpfr` to `frabl1r`.

| File     | Purpose / Origin (likely)         | Notes                             |
|----------|----------------------------------|-----------------------------------|
| frabl1   | Discount matrix (main file)      |                                  |
| frkunl1  | Customer master                  |                                  |
| fkprl1   | Customer project                 |                                  |
| vvarl1   | Item master                      |                                  |
| frawlu   | Work file (arbeidsfil, update)   | Used to build working set        |
| ffrawl1  | Work file (arbeidsfil, input)    | Used to read working set         |
| afirl1   | Company master                   |                                  |
| vogrl1   | Item group - upper group         |                                  |
| vhgrl1   | Item group - main group          |                                  |
| vugrl1   | Item group - sub group           |                                  |
| frlevl1  | Supplier master                  |                                  |
| fr602p   | Printer output                   | Final output to report            |

#### 3. Data Definitions (`D`)

- **Parameters:** `p_list` (120 char param list), used as a packed parameter block.
- **Local Data Area (LDA):** Structures to access workstation/user ID.
- **Data Structure for Parameter List:** Overlays are used for extracting each parameter from `d_list` (type, start position).

- **Various Key Variables:** Fields used in keyed access for each master file.
- **Working Variables:** For control, flags, date/time, temporary group numbers, etc.

---

### B. Mainline Logic (`C`)

#### Initialization (`*inzsr`)

- Receives parameter block (`p_list`), stores in data structure (`d_list`), extracts params.
- Sets `w_firm` (company id) for key use.
- Initializes various key-lists for indexed access on all files.
- Gets system date/time (`w_udat`, `w_utim`).

#### 1. Build Working File: `exsr utplukk`

- Reads **discount matrix (frabl1)**, for each record:
  - **Finds extra info:** Customer project/category, customer, item group/hierarchy, supplier, module.
  - **Enriches record:** Adds fetched info to buffer.
  - **Stores record** in work file (`frawlur`).
- Handles various cross-references by chaining to customer/item/project/group master files.

#### 2. Print Header: `exsr hode`

- Populates printer header fields with system/user info, company info, and all used parameters.
- Fetches company name and prints report headers.

#### 3. Process and Print Detail Lines

- **Position to correct records in work file:** Uses parameter/filter values (`setll` and `read` loop).
- For each record, calls `exsr detalj` subroutine:
  - **Applies all selection criteria:** Skips/ends if current record is outside parameter ranges.
  - **Loads detail line fields:** Populates print buffer with relevant data.
  - **Looks up descriptions** for customer, project, groups, item, supplier.
  - **Calls external program FR700R** to compute “DG” (margin or coverage).
  - **Prints**: Writes main detail, then writes discount lines for each discount type (if present).
  - **Handles page overflow:** Prints page headers when needed.

- **End of Program:** Sets *INLR on, returns.

---

## C. Subroutines

### 1. `utplukk`: Populate Work File

- Reads all rows from discount matrix (`frabl1`), for each:
  - Gets customer project/category, customer data.
  - Gets item group and supplier info.
  - Fills in timestamps, user id.
  - Writes to work file (`frawlur`).

### 2. `hode`: Print Header

- Assembles fixed and parameter fields for the header.
- Fetches company name.
- Prints three lines of report header.

### 3. `detalj`: Process and Print a Detail Line

- Applies all filter/selection criteria (if record is out of bounds, skips).
- Loads all print fields for the detail line.
- Looks up all related descriptions (customer, project, group, supplier, item).
- Calls `FR700R` with all key fields to calculate “DG” (writes into `d1dggj`).
- Writes main detail line.
- Writes discount lines for each present discount (linjerabatt-1, -2, nettopris, bunnpris, tilbudspris), with appropriate text.
- If all discount fields are empty, writes a blank line.
- Handles page overflow (calls `overflow` subroutine if needed).

### 4. `overflow`: Print Header on New Page

- If overflow detected, writes top header lines again.

---

## D. Parameter Handling

- Program gets a 120-position character parameter block.
- Each parameter (customer, group, item, etc.) is found via overlay at a fixed position/length.
- Used for flexible filtering of the data set.

---

## E. External Call

- Calls program `FR700R` for calculation of DG (Coverage Degree).
- Passes all key and discount fields, receives calculated value in `d1dggj`.

---

## F. Key Lists

- **Key-lists** (`klist`/`kfld`) are used for all indexed file accesses (lookups by composite keys).
- Each related file (customer, item, group, project, supplier) has its associated keyed access.

---

## G. Filtering Logic

- For each field that has a start/stop filter, record is tested:
    - If any field is outside the given range, record is skipped (`leavesr`).
    - Main key fields: price group, category, customer, project, group, supplier, module, item.

---

## H. Data Augmentation

- For every record, the program **pulls in:**
    - Customer/project names
    - Group (and subgroup) names
    - Supplier names
    - Item descriptions
    - And calculates “DG” via external call

---

## I. Printing

- Printer lines are written using output specs (not shown here – defined in printer file).
- Each detail line may be followed by several discount lines, depending on which fields are present.
- Handles overflow (new page) logic.

---

## J. Best Practices

- This program applies classic RPG patterns, including:
    - Extensive use of lookups/chains for data enrichment
    - Parameter “block” for flexible batch selection/filtering
    - Use of subroutines for logical grouping
    - Clear separation of data enrichment (utplukk) and reporting (detalj)
    - Consistent page overflow handling

---

## K. Onboarding Notes

- **Language:** Variable/comments are mostly Norwegian; consider a glossary for common terms.
- **Parameter Structure:** Key to understanding program run; review how caller populates `p_list`.
- **File Layouts:** You’ll need DDS/SQL layouts for all referenced files to fully understand field content.
- **External Programs:** Know the interface to program `FR700R` for calculation logic.
- **Testing:** Program is designed for batch. Requires proper input data and parameter setup.

---

## L. Summary of Flow

1. **Initialize** – Loads parameters and company info.
2. **Build Working File** – Reads the discount matrix, enriches with auxiliary data, and writes work records.
3. **Print Report** – For each qualified detail record, prints header(s) and detail lines, with discount breakdowns and “DG”.
4. **Handles Overflow/New Pages** – Ensures clean report structure.
5. **End** – Clean completion, with *INLR=*ON.

---

## M. Key Concepts

- **Rabattmatrise:** Discount matrix, defines how discounts apply in various hierarchies (per customer, group, item, etc.)
- **DG (Dekningsgrad):** Margin/coverage ratio, calculated per line via external logic.
- **Parameter Block:** Allows flexible report setup without recompilation.

---

This summary should help new developers understand the purpose, logic, and structure of **FR602R** so they can maintain, modify, or extend its functionality. For further development, ensure you have documentation for all data files and the external `FR700R` calculation logic.