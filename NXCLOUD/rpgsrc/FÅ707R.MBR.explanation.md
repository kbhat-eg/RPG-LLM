# RPG Program Explanation

This RPG source code is for a common program (fellesprogram) used to retrieve company and department information. Below is a detailed walkthrough of the code, organized by logical sections, to help new developers understand its structure and functionality.

---

## 1. **Title and Documentation**

At the top, the code contains comments (marked with `*`) describing its purpose and change history:

- **System:** ASOFAK
- **Program:** F₣707R
- **Description:** Common program to fetch company/department information.
- **Change log:** Each line (e.g., `5.20`, `6.30`) documents version, date, author initials, and description of the change. For example:
  - `6.30 R6.30 051214 bsa  Utvider parameterliste til å ta med web og mail`  
    (Expands parameter list to include web and mail)

---

## 2. **File Declarations**

```rpgle
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
fra07pf    if   e           k disk
```
- **fafirl1**: File used for company information, renamed record format to `afirl1r`.
- **fra07pf**: File used for department (avdeling) information.

---

## 3. **Data Definitions**

### **Parameters (to/from caller)**
```rpgle
d p_prfi          s              1  0   // Type of fetch: company/department
d p_avde          s              4  0   // Department code
d p_fftx          s             30      // Output: company text
d p_tfax          s              8      // Output: phone/fax text prefix
d p_ffir          s                   like(aaffir) // Company number
...
6.30 d p_mail      s                   like(aamail) // E-mail
6.30 d p_weba      s                   like(aaweba) // Web address
```

### **Key Variables**
```rpgle
d ra07pf_avde     s                   like(ragkod) // Department code for department file
d afirl1_ffir     s                   like(aaffir) // Company number for company file
```

### **Work Variables**
```rpgle
d w_firm          s                   like(aaffir) // Current company number
d w_pnra          s              4                // Postal code
d w_ffta          s              9                // Company VAT/registration number
```

### **Indicators and UDS**
```rpgle
6.20 d                uds
6.20 d l_poff         584    584 // Used as a logical indicator (single position)
```

---

## 4. **Main Logic**

### **Initialization**

```rpgle
c                   eval      p_fnav = *blank
c                   eval      p_fad1 = *blank
...
6.30 c                   eval      p_mail = *blank
6.30 c                   eval      p_weba = *blank
```
All output fields are initialized to blanks.

---

### **Fetch Company Information**

```rpgle
c                   eval      afirl1_ffir = w_firm
c     afirl1_key    chain     afirl1r                            90
c                   if        *in90  = *off
    // Only if found (if *in90 is off)
    // Set output fields from company file record
    ...
c                   endif
```
- Builds a key (`afirl1_key`) with the current company number.
- Uses `CHAIN` to read the company record.
- If found, populates output parameters (company name, address lines, postal code, phone, fax, mail, web).
- Handles formatted creation of the `p_fftx` field (company VAT/text), with branches for specific business rules.

---

### **Fetch Department Information (if requested)**

```rpgle
c                   if        p_prfi = 2
    // Only fetch dept info if requested
    c                   eval      ra07pf_avde = p_avde
    c     ra07pf_key    chain     ra07pfr                            90
    c                   if        *in90  = *off
        // Only if found
        // Overwrites some of the company output fields with department info
        ...
    c                   endif
c                   endif
```
- If parameter `p_prfi` is 2, program will attempt to fetch department info.
- Uses both company number and department code as key to read from department file (`RA07PF`).
- If found, fills/overwrites address info and possibly phone, fax, mail, and web fields.
- Conditional logic ensures if a department field is not blank, it replaces the corresponding company field.

---

### **Program End and Cleanup**

```rpgle
c     avslutt       tag
c                   eval      *inlr = *on  // End program and close files
c                   return
```
Program ends with setting *INLR (last record indicator) to *ON and returning to the caller.

---

## 5. **Subroutines**

### **Initialization Subroutine (\*INZSR)**

- **Keylists for CHAIN:**
  - `afirl1_key`: Contains just the company number (`w_firm`).
  - `ra07pf_key`: Contains company number and department code.
- **Parameter List (\*ENTRY PLIST):** Parameters from the calling program are mapped to local variables.
- **Sets work variable `w_firm` from the company parameter.**

---

## 6. **Parameter Handling**

The program is designed to be called from another program, passing all necessary input/output parameters. The parameters include:

- Type of lookup (company or department)
- Company and/or department code
- Output fields for name, address, post code, phone, fax, mail, web

---

## 7. **Key RPG Concepts Used**

- **CHAIN:** Random access read using a key (for both company and department).
- **Keylists/KLIST/KFLD:** Used to define keys for file lookup.
- **PLIST/PARM:** Parameter passing to and from the program.
- **INDICATORS (\*IN90):** Used to check if a record was found.
- **\*INLR:** Program termination and file closure.
- **\*INZSR:** Special subroutine for initialization.
- **MOVE:** Data movement between fields, sometimes for character/numeric conversion.

---

## 8. **Business Rules**

- If department info is found and active, it will overwrite certain company fields.
- Special formatting for VAT/organization number output depends on business logic and flags.
- If department phone/fax is not blank, it overrides company values.

---

## 9. **Field Name Conventions**

- Most field names (`aaf`, `rag`) are likely abbreviations tied to actual physical file layouts (company and department master files).
- Short variable names are typical in legacy RPG.

---

## 10. **Summary**

This program is a typical RPG "subroutine" program, responsible for fetching either company or department contact/master data based on the incoming parameters. It supports extension (as seen with mail/web address), uses defensive logic (initializing outputs, overriding only if data is present), and abides by RPG conventions for file access, parameter passing, and program control.

---

**Key Takeaway:**  
If you are onboarding to this code, focus on understanding:
- How parameter passing works in RPG (`PLIST`, `PARM`)
- How keyed file access (`CHAIN`, `KLIST`, `KFLD`) is handled
- The conditional logic for which fields are populated from company vs. department tables
- The initialization pattern and indicators (`*INLR`, `*IN90`)

For further development, consider refactoring for free-format RPG, increasing field name descriptiveness, and document parameter contracts more explicitly.