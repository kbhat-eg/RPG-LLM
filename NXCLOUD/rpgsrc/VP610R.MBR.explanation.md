# RPG Program VP610R – Detailed Explanation

This program (VP610R) is an ILE RPG application meant for IBM i (AS/400) systems. It is used for printing customer price lists ("prisbok kunder") based on a variety of parameters. The program interacts with display files for screen input and output, and several database files for validations and lookups.

---

## 1. Program Declaration and File Definitions

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debug input/output and sets date editing to day/month/year.
- The heading introduces version history, authors, and rationales for changes.

### File Specifications (`F-Specs`)
```rpg
fra06pf    if   e           k disk    rename(ra06pfr:ra06pfr)
...
fvp610d    cf   e             workstn
```
- Many physical files are defined with external key (K) and renamed records for clarity.
- `vp610d` is a display file for interacting with the user (screen).

---

## 2. Data Definitions

### Local Data Area
```rpg
d                uds
d l_firm                944    946  0
d l_fnav                951    980
```
- `l_firm` and `l_fnav` map to specific offsets in the User Data Area, usually set at program call.

### Parameter List Data Structure
```rpg
d                 ds
d d_list                        64
d  d_firm                        3  0 overlay(d_list)
...
d  d_dato                         d   overlay(d_list:48) datfmt(*iso)
```
- A datastructure overlays 64 bytes, breaking out each parameter required for the report program and overlays for convenient access and passing as a parameter list.

### Key Variables and Reference Fields
```rpg
d ra06pf_fkod     s                   like(rafkod)
...
d rlevl1_levr     s                   like(rllevr)
```
- These variables store key fields for database lookups, using the same data type as in the corresponding file.

### Working Variables
```rpg
d b_feil          s              1    inz(*off)
d w_udat          s               d   datfmt(*iso)
d w_firm          s                   like(flfirm)
...
d w_stat          s              1
```
- Various working variables, e.g., for error handling (`b_feil`), current date, company code, etc.

---

## 3. Main Program Flow

### Opening Screen Handling (Section B1)
The program flow starts at label `b1tag` and processes the main input screen (`b1bld`):
- Displays the screen and waits for user action.
- Handles function keys:
  - *INKC*/*INKL*: Exit program.
  - *INKD*: Call inquiry/subfile logic (`spørring`) and redisplay screen.
- Validates input via `sjekk_input` subroutine. If errors, returns to the screen.

#### Preparing for Report Generation
- Input fields entered by the user are mapped into the parameter list (`d_list`).
- Calls the report generation program `VP610C` with this parameter list.

### Subroutines

#### `spørring`: Inquiry/Help Subroutine
- Based on which field the cursor is in (`w_afld`), calls various inquiry programs (e.g., lookup discount category, customer, project, assortment).
- Updates screen fields with the selected/validated values.

#### `sjekk_input`: Input Validation Subroutine
- Checks each input field for validity:
  - Discount category: Must exist, cannot be combined with customer.
  - Customer: Must exist; project must reference valid customer.
  - Customer project: Must exist if specified.
  - Delivery type, assortment, groups, and supplier: Validates existence in respective files.
  - Date: Must be valid if specified, otherwise set to current date.
  - Logic for assortment and group selection—mutually exclusive combinations enforced.
  - For each error, sets special indicator, marks `b_feil` as on, and returns.

#### `*inzsr`: Initialization Subroutine
- Defines KLISTs (key lists) for database file access.
- Sets working fields (`w_firm`) from User Data Area, initializes the screen date from the system clock.

---

## 4. File Key Lists

KLISTs are defined for all database file lookups, grouping primary fields (company + key field(s)) needed for CHAIN operations.

---

## 5. Report Program Call

Once validation passes:
- Parameters are transferred from screen fields to the parameter list structure (`d_list`).
- The report program `VP610C` is called with this structure, and control cycles back to the input screen for further processing.

---

## 6. Program Termination

When the user indicates exit (by function key):
- Sets last record indicator (`*INLR = *ON`) and returns.

---

## 7. General Purpose and Usage

- **Purpose**: To collect, validate, and pass user input to a report generation program for printing customer price books, with lookups and validation against a sophisticated sales database.
- **User Flow**:
  1. User enters criteria on the display file.
  2. User can press help/inquiry on any field for lookup programs.
  3. Input is validated—if errors, highlighted.
  4. When valid, generates a report via `VP610C`.
- **Special Notes**:
  - Fields and subfile logic are tailored to specific Norwegian business needs (terms like "Rabattkategori", "Varesortiment").
  - All database access is by CHAIN with composite keys.
  - Strong input validation prevents inconsistent or incomplete reporting.

---

## 8. Versioning and Customization

- The header documents version changes, enhancements (e.g., additional fields like warehouse selection), and specific custom features by version.
- Lines beginning with numbers (e.g., `5.70`) indicate lines or blocks tagged for specific versions/enhancements.

---

## 9. How to Extend or Maintain

- To add a new input field:
  - Update the display file.
  - Add to parameter DS and transfer logic.
  - Add validation and inquiry logic as needed in `sjekk_input` and `spørring`.
- To change file lookup logic, update the corresponding KLIST and validation CHAIN operation.

---

## 10. Summary Table of Main Subroutines

| Subroutine      | Purpose                              |
|-----------------|--------------------------------------|
| `spørring`      | Inquiry/Help lookups for input fields|
| `sjekk_input`   | Validate all input fields            |
| `*inzsr`        | Initialization, set up KLISTs, data  |

---

## 11. Key Abbreviations

- **b_feil**: Boolean flag for screen input error
- **w_firm**: Current company/firm code
- **CHAIN**: Keyed file lookup (returns *INxx indicator if not found)
- **KLIST/KFLD**: Composite key list for file access
- **EXFMT**: Display a record format and wait for user input

---

## 12. System Integration

- Calls several external RPG inquiry programs for lookup.
- Centralizes database validation logic for report parameters.
- Modular structure makes it reasonably straightforward to maintain or extend.

---

## Conclusion

This program is a classic IBM i RPG application that acts as a controlled, menu-driven preface to a sales price book report, enforcing consistent and valid input before generating the report via a parameter interface. The code is well-commented (in Norwegian), uses standard RPG idioms, and is ready for further customization based on evolving business requirements.