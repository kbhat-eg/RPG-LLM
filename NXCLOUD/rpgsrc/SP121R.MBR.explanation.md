# RPG Program Overview: SP121R - "Utvalg Kundekategori" (Customer Category Selection)

This ILE RPG program is part of a system (ASSTAT) designed to manage customer categories. The code is written in fixed-format RPG IV, using subfiles for interactive display and management.

Below is a pedagogical explanation of the program structure and logic.

---

## 1. **File Declarations**

```rpg
fsp121d    cf   e             workstn sfile(b1sfl:w_srrn)
fskpml1    if   e           k disk    rename(skpmpfr:skpml1r)
fskpmlr    if   e           k disk    rename(skpmpfr:skpmlrr)
fskpmlu    uf a e           k disk    rename(skpmpfr:skpmlur)
fra11pf    if   e           k disk
```

- **sp121d**: Workstation file using subfile `b1sfl` with relative record number `w_srrn`.
- **skpml1, skpmlr, skpmlu**: Disk files, with record formats renamed. These are used for accessing and updating customer category data.
- **ra11pf**: Reference file for additional validations or lookups.

---

## 2. **Data Definitions (D-Specs)**

The D-spec section defines variables used for keys, flags, text values, counters, and constants.

- **Key Variables**: For accessing records in various files (e.g., `skpml1_type`, `skpml1_kode`, ...).
- **Work Variables**:
    - `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Subfile counters for page management.
    - `b_forn`, `b_anul`, `b_feil`: Flag variables, typically for control flow.
    - `w_firm`, `wptype`, `wpkode`, `wptext`, `wpkkod`: Firm and customer category descriptors.
- **Constants**: 
    - `c_sfil`: Subfile page size (12).
- **LDA (Local Data Area)**: Used to extract user and firm information at program initialization.

---

## 3. **Program Flow and Main Routine**

The mainline program logic begins after data and file definitions.

### **Tags and Main Flow:**

- **b2taga**: Display command line.
- **b2tagb**: Display and handle subfile.

### **Function Key Handling:**

- **F3, F12** (`*inkc`, `*inkl`): Exit the program.
- **F5** (`*inke`): Refresh subfile.
- **F6** (`*inkf`): Add new entry (show new entry screen).
- **F10** (`*in10`): Build (reconstruct) subfile.
- **F21** (`*in21`): Set flag to redisplay command area.

The `select` statement routes processing to the correct subroutine depending on the function key pressed.

---

## 4. **Subfile and Data Management Subroutines**

### **forny**: Refresh Subfile
- Resets subfile to the current position and rebuilds it from file.

### **posisjoner**: Position in Subfile
- Positions the subfile view based on entered selection or code.

### **control**: Handle Subfile Control Area
- Executes create or delete actions depending on what the user requests.
- Validates input and sets error flags/messages if needed.

### **subfile**: Handle Rows in Subfile
- Iterates over the subfile, lets users select or delete rows.

### **xc1bld**: Handle New Entry Screen (C1BLD)
- Displays the screen to add a new entry, handles validation, and calls registration logic.

### **xc1msg**: New Entry Info Message
- Notifies the user if the entry already exists.

### **xc2bld**: Handle Entry Edit/View Screen (C2BLD)
- Displays and updates an existing entry (or creates a new one), saves to file.

### **xd1win**: Delete Confirmation / Delete Entry
- Requests confirmation and deletes the selected entry from the file.

### **clr_subfile**: Clear Subfile
- Clears the subfile screen and resets counters.

### **crt_subfile**: Create/Fill Subfile
- Reads records from the file and fills the subfile for display.

### **dsp_subfile**: Display Subfile
- Handles subfile display logic (including when there is no data).

---

## 5. **Initialization (*INZSR)**

- Sets up keys for file access.
- Loads parameters (category type and text) from the calling program.
- Gets the firm number and name from the LDA.
- Positions and fills the subfile with initial data.

---

## 6. **Function Key Indicators**

- **Indicators** (e.g., `*in12`, `*in13`, ...) are used for subfile and screen control, including locking, clearing, confirming, and error display.

---

## 7. **Program Termination (avslutt)**

- Standard RPG pattern: Set `*inlr = *on` and `return` to end program.

---

## **Summary of User Actions:**

- **View** customer categories via subfile.
- **Add** a new category (F6), with error checking for duplicates and reference validation.
- **Edit**/register an entry.
- **Delete** a category with confirmation.
- **Page** through subfiles, re-position, and refresh as needed.

---

## **Notable RPG Techniques Used**

- **Subfile handling**: For list display and interactive processing.
- **File key lists** (`klist`/`kfld`): For indexed file access.
- **Indicators**: Finely control the program state and screen behavior.
- **Use of Local Data Area**: For passing user/session data.
- **Structured use of subroutines (`begsr` / `endsr`)**: Modularity and clarity.

---

## **Glossary**

- **Subfile**: A temporary list shown on-screen, allowing display and entry of multiple records.
- **DDS**: Data Description Specifications, used for screen and database definitions in IBM i systems.
- **LDA**: Local Data Area, a special IBM i data structure available to all programs in a job.

---

## **Onboarding Tips:**

- Start by understanding how subfile handling works in RPG.
- Focus on subroutine structure for clarity on user actions.
- Read associated DDS (display file) definitions for screen layouts.
- Understand how indicators link to function keys and screen state.

---

Please feel free to ask for explanations of specific subroutines, how the subfile works, or for walkthroughs of user scenarios!