```markdown
# RPG Program SF500R Explanation

This RPG source code is for the `SF500R` program, part of the ASSTAT (Sales Statistics) system. Its main function is to serve as a parameter-driven inquiry screen for sales statistics, allowing users to query sales data based on various parameters such as customer, product, and date. The code is in traditional ILE RPG/400 (RPG IV in fixed-format), heavily utilizing display files and physical files.

---

## Overview of the Program

- **Program Name:** SF500R
- **Purpose:** Provide an interactive inquiry screen for sales statistics based on input parameters (customer, project, item, year, date, etc.)
- **Main Files Used:**
  - **sstapf:** Unknown (possibly parameters or configuration)
  - **rkunl1:** Customer master
  - **fkprl1:** Customer project master
  - **vvarl1:** Item master
  - **vvasl1:** Deleted items register
  - **sf500d:** Display file for user interface

---

## Structure and Flow

### 1. File and Variable Declarations

- **Files (`F-specs`):**
  - All files are keyed, externally described disk files (`k disk`).
  - Some files are renamed for local record format naming.

- **Display File:**
  - `sf500d` (WORKSTN, i.e., workstation file)—used for the interactive display.

- **Local Data Area:**
  - Used to retrieve the firm/company code.

- **Working Variables (`D-specs`):**
  - Various fields for date handling, customer/project/item keys, flags, and temporary storage.

---

### 2. Initialization (`*inzsr` Subroutine)

- **Keylists:** 
  - Keylists (`klist`) for later chains (lookups) into the master files.
- **Firm Code:**
  - Reads the firm code from local data area and stores in `w_firm`.

---

### 3. Main Processing Loop

#### Display Initialization

- Sets the current date and copies it into a field (`b1paar`) to display on the screen.

#### Main Screen Handling Loop (`b1taga` tag)

- **`exfmt b1bld`**: Presents the main input/output screen and waits for user input.

##### Function Key Handling (`SELECT`):

- If **F3 (INKC) or F12 (INKL)** pressed: goto `avslutt` (exit program).
- If **F4 (INKD)** pressed: Execute the `spørring` (inquiry) subroutine, then redisplay.
- Otherwise, continue to input checking.

##### Input Validation

- Calls `sjekk_input` subroutine.
- If `b_feil = *on` (an error/invalid input was detected), resets flag and redisplays the screen.

##### Call Inquiry Programs

- If both item number (`b1vare`) and date (`b1bida`) are not entered, calls either:
    - `'SF501R'` if no item number is specified, or
    - `'SF502R'` if item number is specified.
- Passes appropriate parameters (firm, year, customer, project, date, etc.) to the called program.

- Then redisplays main screen for further input.

#### Program Exit (`avslutt` tag)

- Ends the program (sets *INLR on and returns).

---

### 4. Inquiry Handling (`spørring` Subroutine)

- Responds to user selections for *searching*:
    - **Customer** (`wactfe = 'B1VKUN'`): Calls `'RK500R'`.
    - **Customer Project** (`wactfe = 'B1KPRO'`): Calls `'FL500R'`.
    - **Item** (`wactfe = 'B1VARE'`): Calls `'VV500R'`.
- Each call passes necessary parameters and updates screen fields with the result (e.g., names).
- Each block ends with `leavesr` (leave subroutine after handling).

---

### 5. Input Validation (`sjekk_input` Subroutine)

Checks the integrity and completeness of user input before proceeding:

- **Year Validation:** If year is not entered, sets error indicator and returns.
- **Date Validation:** If date is entered, checks it is a valid date (using `test(d)`).
- **At Least One Key Field:** Either Customer or Item number must be entered.
- **Customer Validation:** Looks up customer in the customer master; if not found, sets error.
- **Customer Project Validation:** If entered, checks it exists for the customer.
- **Item Validation:** If entered, looks up in item master or deleted item register; if not found, sets error message "Item not found in register".

All errors are signaled by setting `b_feil` and display field indicators.

---

### 6. Special RPG Features and Conventions

- **Keylists (`klist/kfld`)**: Used to define composite keys for chained accesses.
- **Flags (`b_feil`)**: Used for input error signaling.
- **Parameter Passing (`call/parm`)**: Calls to other RPG programs for sub-inquiries.
- **Field Protection/Indicators**: Standard for display file driven programs.

---

## Summary Table of Key Data Flows

| Input Field      | Checked/Validated? | Used For                                  |
|------------------|-------------------|-------------------------------------------|
| b1paar (Year)    | Yes               | Date range/year for inquiry               |
| b1bida (Date)    | Yes               | Specific date filtering                   |
| b1vkun (Customer)| Yes               | Customer selection/look-up                |
| b1kpro (Project) | Yes               | Customer-project selection/look-up        |
| b1vare (Item)    | Yes               | Item look-up (incl. deleted items)        |

---

## Conclusion

This is a fairly typical interactive inquiry RPG program, handling a parameter-driven selection screen, validating user input, and branching to appropriate inquiry logic or subsidiary programs depending on what the user enters. It demonstrates modular (subroutine) structure, robust validation, and separation of inquiry logic via separate programs.
```