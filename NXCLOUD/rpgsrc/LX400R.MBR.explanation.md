# Program Documentation: LX400R – Transfer of Inventory Unit to Historical Inventory Book

## Overview

**System:** ASLAGR  
**Program:** LX400R  
**Description:**  
This program transfers inventory units from the current inventory to the historical inventory book. It reads records from the historical inventory file, finds corresponding inventory units in the item master file, updates the historical record with tracking and user information, and writes the changes back.

**Special Versions:** None  
**Customization:** None

**Change History:**

| Version | Date    | Author | Description                                 |
|---------|---------|--------|---------------------------------------------|
|         | 210999  | ASK    | New program                                 |
| 6.10    | 260609  | BSA    | Updated with tracking information           |

---

## File Definitions

- **vhislu** (historical inventory units)
  - Usage: Update (uf), keyed access (k), external file (disk)
  - Renamed to `vhislur` in the program

- **vvarl1** (item master file)
  - Usage: Input (if), keyed access (k), external file (disk)
  - Renamed to `vvarl1r` in the program

---

## Data Area and Variables

### Local Data Area (LDA)
- **l_user**: User ID from LDA (positions 911–920)
- **l_firm**: Firm code from LDA (positions 944–946, packed decimal)

### Key Variables
- **vvarl1_vare**: Item number for key lookup in item master (`like(vvvare)`)

### Working Variables
- **w_firm**: Firm code for key lookup (`like(vvfirm)`)

---

## Program Flow

### Main Logic

1. **Initialization:**
   - The *INZSR subroutine* sets up the key list for item master lookup and initializes `w_firm` with the firm code from LDA.

2. **Processing Loop:**
   - Reads the first record from `vhislu` (historical inventory).
   - For each record:
     - Sets up the item number for lookup (`vvarl1_vare = vhvare`).
     - Performs a keyed lookup (`chain`) in the item master file using the key list (`vvarl1_key`).
     - If found, updates the historical record fields:
         - `vhenhl` (historical inventory lot) is set from `vvenhl` (current inventory lot).
         - **Version 6.10+**: Updates tracking fields:
             - `vhedat`: Current date (system time)
             - `vhetim`: Current time (system time)
             - `vheusr`: Current user (`l_user`)
         - Writes the updated record back to `vhislur`.
   - Continues until all records are processed.

3. **Program End:**
   - The program sets the LR indicator and returns.

---

## Key Business Logic

- **Purpose:**  
  The program synchronizes historical inventory records with the latest information from the item master, specifically updating lot and tracking information for traceability.

- **Tracking Enhancements (v6.10):**  
  As of version 6.10, the program also records the date, time, and user for each historical record update. This supports audit and traceability requirements.

- **Key Construction:**  
  The key for item master lookup (`vvarl1_key`) consists of the firm code (`w_firm`) and the item number (`vvarl1_vare`). This ensures that lookups are firm- and item-specific.

---

## Design Notes & Conventions

- **File Renaming:**  
  External files are renamed in the `F` specs to avoid name clashes and clarify their usage within this program.

- **Use of LDA:**  
  User and firm information is obtained from the Local Data Area, a common practice in this system for passing environment-specific context.

- **Field Naming:**  
  Field names follow a convention where `vh*` refers to historical inventory, and `vv*` refers to current inventory or item master.

- **Update Pattern:**  
  The program uses a simple read-process-update loop, typical for batch data migration or synchronization programs in this system.

- **Error Handling:**  
  The program does not include explicit error handling for missing records in the item master (`chain` operation), which implies that either all historical records are expected to have corresponding item master entries, or missing entries are not critical for this process.

---

## External Relationships

- **vhislu/vhislur:**  
  The historical inventory book file. This file is both read from and updated by the program.

- **vvarl1/vvarl1r:**  
  The item master file. Used for lookups to obtain the latest lot information.

- **Local Data Area (LDA):**  
  Provides environmental data such as user and firm, which is used for both key construction and tracking updates.

---

## Summary

This program is a batch utility for updating historical inventory records with current lot and tracking information from the item master. It is designed for traceability and audit support, with enhancements in version 6.10 to record the user, date, and time of each update. The program is tightly coupled to the structure and conventions of the ASLAGR inventory system, particularly in its use of LDA and file naming conventions.