# RPG Program Explanation: RP147R
#### (Prosjekt, Hente budsjett til Ordre — Project, Retrieve Budget to Order)

This is an ILE RPG III/IV program designed for IBM i (AS/400) systems to allow users to retrieve project budget items and transfer them as order lines, supporting subfile processing for user interaction. The source is well-documented and implements several business rules within a project/order management environment. Below is a thorough walkthrough.

---

## High-Level Overview

- **Purpose:**  
  The program allows users to search, display, and select project budget entries (likely material lines or similar), which can then be transferred (in whole or part) to an order (purchase or production order).
- **Interface:**  
  Utilizes subfiles for interactive display and selection.
- **Files (Tables) Used:**  
  Several files (rpvalX, rpvalu, rpkol1, etc.) which seem to relate to project budgets, orders, articles, storage, and account info.
- **Techniques Used:**  
  - Subfile processing
  - Data structure feedback (INFDS)
  - Call to external programs for price-finding and confirmation dialogs
  - Strong use of indicators for screen and process control

---

## Detailed Explanation

### 1. **Header and Documentation**
- System, program, and description.
- Change log: tracks changes, bugfixes, and enhancements (e.g., handling of order type, price group, etc.).
- Indicators usage map (LR, 10-99, etc.), important for RPG classic programmers.

### 2. **File Declarations**
- Files `rpval1` to `rpvalu`: Project budget/allocations by various keys (item, load, etc.), opened for I/O, with record format rename for clarity.
- Files for orders (`fohel1`, `fodtlu`), articles (`vvarl1`), stock (`vlagl1`), price info, and more.
- Workstation file (`rp147d`) for the interactive display, using a subfile (B1SFL) with screen feedback data structure `dspfbk`.

### 3. **Constants and Data Structures**
- `lo`, `up`: Lowercase and uppercase alphabetic constants, possibly for manual upper/lower case operations.
- **Local Data Area (LDA):**  
  Used for session/user data (`l_user`, `l_fgr`, etc.).
- **INFDS (dspfbk):**  
  Used to capture screen feedback like the first cursor row, etc.

### 4. **Key Variable Definitions**
- Variables for all keys used in data access and updates, such as for reading/updating project lines, articles, order headers/lines, etc.

### 5. **Main Working Variables**
- Subfile-related: `w_fcrn` (first record num), `w_srrn` (subfile record num), `w_spge` (page size), etc.
- UI and logic flags: `b_forn` (refresh subfile), `b_oppr` (create), `b_anul` (cancel), etc.
- Search and filtering: `w_firm`, `s_vare` (item), `w_dato` (date), etc.
- Price, text, and other operational variables.

### 6. **Subfile and Screen Section Comments**
- Explains the meaning of various working variables, subfile/control record names (B1SFL, B2CTL, etc.), and how the program uses them.

---

## Mainline Processing Flow

### A. **Program Start**

1. **Entry Parameters**
   - Receives: Project, subproject, activity, order number, order suffix.

2. **Keylists**
   - Keylists (`klist`) are defined for all indexed access patterns for the physical/logical files (e.g., by project, by item, for updating, etc.).

3. **Initialization**
   - Sets firm from LDA.
   - Prepares next available load number.
   - Reads in project and subproject descriptions for the display.
   - Prepares the subfile for display.

---

### B. **Main Screen/Loop Control**

- The primary display loop (`b2taga` and `b2tagb` tags):
  - Shows the subfile or CMD screen, processes user function keys:
    - `*INKC` / `*INKL`: End or cancel → exit.
    - `*INKE`: Refresh subfile.
    - `*INKJ`: Transfer all lines of a load to the order.
    - `*IN10`: Build (create) subfile from the start.
    - `*IN21`: Position cursor at "home".
  - Handles positioning based on user search input/criteria.

---

### C. **Subfile Processing**

- **Filling the Subfile:**  
  Loops through project/budget lines (reading from `rpval4` or `rpval5` depending on search mode), filtering and filling subfile records with relevant data (item, text, load, balance, prices, etc.).

- **Clearing the Subfile:**  
  Writes control record with indicator 14 to clear, resets all counters.

- **Displaying the Subfile:**  
  If records exist, enables the subfile display indicator; otherwise, shows the command screen (`b2cmd`).

---

### D. **Selection/Transfer Logic**

- When an item (or all lines in a load) is selected for transfer:
  - **Order Line Number Assignment:** Finds the next available order line number by looping until an unused key is found.
  - **Budget Line Fetch:** Fetches the selected project/budget line.
  - **Order Line Assembly:** Constructs the order line data by copying relevant fields from the project/budget line, adding any user-selected quantities, and ensuring all required keys and fields are filled.

- **Price Fetching:**  
  Calls an external program (`VP700R`) to fetch current price info for the item.

- **Inventory and Supplier Info:**  
  Via `GetVarLagVep`, fetches supplementary info (from VVAR, VLAG, VVEPL1 files) about the item (e.g., supplier, group, last received date).

- **Budget Line Update:**  
  Marks budget/project line as picked/processed, decreases the available quantity, and if partially picked, creates a new budget line with remaining qty.

- **Order Header Update:**  
  Always sets order type to "HP" (Hardcoded by business rule).

---

### E. **Transfer of All Lines in a Load**

- Similar logic as "transfer item," but loops through all lines with the given load number, transferring each and marking each as picked.

---

### F. **Utility Subroutines**

- `forny`: Refreshes (clear/fill) subfile after an update.
- `posisjoner`: Positions/start at a specific item or load, based on user input.
- `hentpris`: Calls external program to set price on the order line.
- `GetVarLagVep`: Fetches additional item/inventory info into order line.

---

## Special Features and Business Logic

- **Order Type Enforcement:**  
  From version 7.04, all created/updated orders are set to type "HP."
- **Price Group Update:**  
  Price group expanded (from 1 to 2 chars) in version 8.01.
- **Adaptive Filtering:**  
  The subfile fill logic includes multiple filters (by project, subproject, activity, account, etc.) — only lines matching all criteria are listed.

---

## Indicator Usage

- **LR**: End of program.
- **10-15, 21, 22, 30-99**: Control subfile/page navigation, protect fields, work indicators.

---

## Notable Calls to External Programs

- **AA007R:**  
  Message box/confirmation for load transfer ("Bekreft ... overføring av hele lass ...").
- **VP700R:**  
  Fetch item price (called for each transferred line).

---

## Error Handling & Edge Cases

- **Locking and Record Existence:**  
  Uses `chain` and `read/readc/reade` for record-level processing, iterates to find next available keys to prevent duplicates.
- **Quantity Handling:**  
  When a partial transfer occurs, the remaining quantity is put into a new project line.
- **EOF and Not Found Conditions:**  
  Various `%found()` and `%eof()` checks ensure no improper updates.

---

## Conclusion

This program is a robust, multi-step interactive RPG application for handling project budgets and their transfer into order lines. It features:

- Advanced subfile usage for user display and selection.
- Integrated price fetching.
- Intelligent handling of item, load, and order relationships.
- Strict business rules regarding order types and status tracking.
- Modular subroutines for clarity and maintainability.

Understanding this program requires familiarity with RPG III/IV constructs, subfile operations, IBM i file access, and the domain logic (project → budget line → order line flow). The header comments, variable names, and change logs provide critical orientation for onboarding developers.

---

### **Suggested Starting Points for New Developers:**

- Review the subfile-related logic (`crt_subfile`, `dsp_subfile`, `clr_subfile`).
- Study the transfer logic in `Ovf_Ordre` and `Ovf_Lass`.
- Confirm the key fields and relationships among the main files used (RPVALx, FODTLU, FOHELU, VVARL1, etc).
- Note the external program calls for price fetching and user confirmation.
- Pay attention to business rules (e.g., only order type 'HP' is now used for these transfers).

---

*If you need deeper insight into any particular subroutine, or the structure of the files involved, let me know!*