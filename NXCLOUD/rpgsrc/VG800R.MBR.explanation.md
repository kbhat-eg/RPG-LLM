# RPG Program VG800R – Explanation

This program is written in RPG IV (RPGLE, ILE RPG) and is meant for IBM i (AS/400) systems. Its purpose is to control the update of cost prices and the creation of postings (posteringer) when goods are received (varemottak). The source is well-commented (in Norwegian), and includes a changelog.

## Sections Overview

### 1. Header & Comments

- `h option(*nodebugio) datedit(*dmy)`: Program options set to disable certain debug IO features and use DMY date format.
- The comments describe the program's purpose, history, and recent changes.  
- System: ASLAGR  
- Program: VG800R  
- Description: Controls cost price updating and journal entries for goods receipts.

### 2. File Declarations

Several database files are defined, each with their respective record formats and renamings. For example:
```rpg
flohelr    if   e           k disk    rename(lohepfr:lohelrr)
flodtl1    if   e           k disk    rename(lodtpfr:lodtl1r)
...
```
**Key points:**
- Each file is declared for input (`i`) and full procedural access (`e`), as keyed files (`k`).
- Files are renamed for easier reference.

### 3. Variable Declarations

- **Parameter Variables**: Used for passing values to and from called programs.
    ```rpg
    d p_numm          s                   like(lonumm)
    d p_suff          s                   like(losuff)
    ...
    ```
- **Local Data Area Variables**: `l_firm`, `l_user` mapped to specific positions in the user data space (UDS).
- **Key Variables**: Used to form file access keys.
- **Other Working Variables**: E.g. `w_firm`, `w_fast`, etc.

### 4. SQL Options Setup

```rpg
c/Exec SQL
c+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR,
c+             commit=*none
c/End-Exec
```
Sets SQL options for this program, including date format, proper delayed preparation, unique language sorting for Norwegian, and no commitment control.

### 5. Main Program Logic

#### - **Initialization & Header Read**

1. Reads the header record (`lohelr`) for the given order number and suffix.
2. If not found, program exits (`goto avslutt`).
3. Looks up the order type record (`votylr`).
4. If order type not found, exit.

#### - **Update Cost Price Decision**

- Checks control fields (`vgoppd`, `vaoakk`) to determine if cost price should be updated:
    - Only proceed if `vgoppd` = 'M' or 'F' and `vaoakk` = 2 or 3, respectively.

#### - **Cost Price Update Call (VG702R)**

- Calls an external program `VG702R` to perform the cost price calculation.

#### - **Journal Entry Decision**

- If `vgkrgn` (indicator for posting journal entries) is not 'J', skip.
- If 'J', calls subroutine `hntnum` to fetch a number (likely invoice or posting number).

#### - **Detail Line Processing**

- Loops through detail lines in the order (`lodtl1`):
    - Skips lines with direct delivery (`ldlety = 1`).
    - Skips lines with zero or negative quantity (`ldanta < 0.001`).
    - Looks up line type record (`vltyl1`); skips if not found or not valid for processing (`vallag <> 1`).
    - Calls the `VG804R` program for postings, passing relevant parameters.

### 6. Subroutine: hntnum

Handles fetching/updating a register number by calling the subprogram `AS100R`, likely to get the next posting number.

### 7. Subroutine: *PSSR (Error Handling)

On error, inserts a record into `vgkest` to log the error with details about the run, then sets the LR indicator and returns.

### 8. Subroutine: *INZSR (Initialization)

- Handles program initialization and parameter mapping.
- Sets up key lists for database accesses.
- Gets code information from `vgkkir`.

---

## Key Processes

### Initialization

- Loads common variables and key fields from parameters/local data area.
- Chains to master files to retrieve control and configuration data.

### Main Processing

- Validates if updates should happen based on control fields.
- Delegates cost price calculation to another program.
- If postings are needed, loops all order lines:
    - Only processes lines with positive quantities and proper types.
    - Calls another program for each valid detail line for posting.

### Error Handling

- Catches errors in a special subroutine, logging them with context to `vgkest` for troubleshooting.

---

## Summary

**VG800R** is a control program for cost price and journal updating during item receipts. It reads order headers, checks if processing is needed, delegates calculations to other programs, and handles postings line-by-line. It is modular, with clear separation between main logic, initialization, error handling, and dependent program calls.

**Key focus for new developers:**
- Understand the data model: order headers (`lohelr`), detail lines (`lodtl1`), order and line types, config files.
- The business rules for when to update cost prices and/or make postings are central (these are in the control fields).
- Error handling is robust: failures are logged to a dedicated error table with plenty of context.
- Program is modular—actual cost price and posting logic is delegated to other RPG programs.

The comments and changelog at the top are crucial for understanding the evolution and rationale for structural changes.