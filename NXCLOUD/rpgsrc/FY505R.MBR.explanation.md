# Documentation for FY505R – Display Deleted Order Lines

## Overview

**Program:** FY505R  
**System:** ASOFAK  
**Purpose:**  
FY505R is responsible for displaying deleted order lines within the application. It provides an interactive subfile interface, allowing users to review deleted lines and, if required, restore them to a new or existing offer (tilbud). The program also supports special business logic for handling order number expansions and restoring deleted lines under certain conditions.

## Key Business Concepts

- **Deleted Order Lines:** The program operates on order lines that have been deleted from the main order but are retained in a separate file for possible restoration or review.
- **Restoration to Offer:** Users can select deleted lines and restore them to a new or existing offer, supporting a workflow for recovering mistakenly deleted items.
- **Order Number Expansion:** The program is aware of changes in order number formats, ensuring correct handling of orders with expanded numbering schemes.
- **Subfile Interface:** The display and selection of lines utilize IBM i subfile patterns for paging and interaction.

## File Relationships

- **fdell1 / fdelpfr:** Deleted order headers.
- **fdesl1 / fdespfr:** Deleted order lines.
- **fdeslr / fdespfr:** For updating the suffix when a line is restored.
- **fodtlu / fodtpfr:** Target for restored lines (offer lines).
- **rkunl1 / rkunpfr:** Customer master.
- **vpkol1 / vpkopfr:** Price code master.
- **vltyl1 / vltypfr:** Line type master.
- **votyl1 / votypfr:** Order type master (for offer validation).
- **fstsl1 / fstspfr:** Status master (for controlling available functions).

## Main Data Flow

1. **Initialization:**
   - Parameters for firm, year, order number, suffix, and optionally new suffix and target number (for offer) are received.
   - Keys for file access are set up.
   - Business logic flags are initialized (e.g., whether offer restoration is enabled).

2. **Control Record Preparation:**
   - The header for the deleted order is loaded and displayed, including customer and order info.
   - Customer details are pulled from the customer master.
   - Order total is calculated and displayed.

3. **Subfile Population:**
   - Deleted order lines matching the given order are read and displayed in a subfile.
   - Each line is formatted for display, including calculation of discounts and display of line types.
   - Only lines for the correct year are included (handles order number expansion).

4. **User Interaction:**
   - The user can:
     - Page through the subfile.
     - Select a line to restore to an offer.
     - Use function keys for bulk actions, cursor placement, or program exit.

5. **Restoration Logic:**
   - If enabled, the user can restore one or more lines to an offer.
   - New offer numbers can be generated via external programs if required.
   - Restored lines are written to the offer file, and the deleted line is updated to reflect restoration.

## Special Features and Conventions

### Indicator Usage

- Standard IBM i indicators are used for subfile control (roll, rolldown, subfile display/protect/clear/end, etc.).
- Custom indicators (31–79) are reserved for warnings and screen flags; 80–99 for work indicators.

### Error and Message Handling

- Business rule violations (e.g., restoring to a non-offer order type) result in messages displayed through a central message program (`AA005R`).

### External Program Calls

- **CO402R:** Checks if the functionality to restore deleted lines to offers is enabled (via configuration).
- **VA752R:** Retrieves override order type for number series.
- **AS100R:** Allocates a new offer number from the number register.
- **AA005R:** Displays error messages to the user.

### Data Structure Overlay

- The program uses overlayed data structures to efficiently format and display line information (e.g., `d_text` overlays for line details).

### Handling of Order Number Expansion

- Logic ensures that only lines from the correct year (not just order number) are included, addressing issues where the same order number exists in multiple years.

### Subfile Paging

- Subfile records are paged in blocks (size defined by `c_sfil`), with tracking of first/last record numbers for paging and cursor placement.

## Subroutines and Their Roles

### control_init

- Loads and displays order header info, including customer details and order totals.
- Handles formatting and data movement for the control record.

### forny

- Refreshes the subfile, clearing and repopulating it from the current position.

### subfile

- Handles user selection and processing of subfile records, including restoration logic and line viewing.

### clr_subfile

- Clears the subfile and resets paging variables.

### crt_subfile

- Populates the subfile with deleted order lines, formatting each line for display.
- Applies business rules for discounts, line types, and only includes lines from the correct year.

### dsp_subfile

- Displays the subfile to the user, handling cases where the subfile is empty.

### bygg_tilbud

- Handles the restoration of deleted lines to an offer.
- Supports both single-line and bulk restoration.
- Interacts with the user to confirm bulk actions and handles number generation for new offers.

### hent_linje

- Copies a deleted line to the offer file and updates the deleted line to reflect the restoration.
- Handles field mapping between deleted line and offer line, including audit fields.

### hente_numm

- Calls external programs to determine the correct order type and to allocate a new offer number.

### *inzsr

- Program initialization subroutine.
- Sets up parameters, keys, and business flags.

## Key Business Rules

- Only lines not already restored (not individually deleted or copied) are eligible for restoration.
- Restoration to offers is only allowed if the order type is valid (checked via master file and configuration).
- When restoring all lines, user confirmation is required.
- When restoring, the system supports both restoring to an existing offer or generating a new offer number.

## Integration Points

- **Order Management:** Interacts with deleted order headers/lines and offer lines.
- **Customer Master:** Pulls customer details for display.
- **Price/Line/Order Type Masters:** Used for display and validation.
- **Number Register:** Allocates new offer numbers as needed.
- **Configuration (CO402R):** Determines if offer restoration is enabled.

## Versioning and Change History

- The code contains detailed inline comments tracking enhancements, especially regarding:
  - Order number expansion (R6.30)
  - Offer restoration logic (7.01, 7.02)
  - Price group expansion (8.01)
  - New offer number selection (8.02)

## Summary Table of Main Files

| File      | Purpose                                | Notes                                               |
|-----------|----------------------------------------|-----------------------------------------------------|
| fdell1    | Deleted order header                   | Renamed from fdelpfr                                |
| fdesl1    | Deleted order lines                    | Renamed from fdespfr                                |
| fdeslr    | Deleted order lines (update)           | Used for updating suffix after restoration          |
| fodtlu    | Offer lines (target for restoration)   | Renamed from fodtpfr                                |
| rkunl1    | Customer master                        | Used for customer info display                      |
| vpkol1    | Price code master                      | Used for discount/price code lookup                 |
| vltyl1    | Line type master                       | Used to format/interpret line types                 |
| votyl1    | Order type master                      | Used for offer validation                           |
| fstsl1    | Status master                          | Used for controlling function availability          |

## Notable Design Patterns

- **Subfile Paging:** Standard IBM i subfile with paging and cursor management.
- **Configuration-Driven Logic:** Restoration to offer is enabled/disabled via a configuration call (`CO402R`).
- **Overlayed Data Structures:** Used for efficient data formatting for display.
- **Externalized Number Allocation:** New offer numbers are assigned via external number register programs.

## Conclusion

FY505R is a specialized program for managing deleted order lines, providing interactive review and restoration functionality. It is tightly integrated with several master files and external programs, and implements business rules that are driven by both configuration and data in master files. The code is well-structured for maintainability, with clear separation of concerns across subroutines and detailed inline documentation for business logic changes.

**For onboarding developers:**  
Familiarize yourself with the subfile handling conventions, the structure of the deleted order and offer files, and the external program interfaces for configuration and number allocation. Pay special attention to the business rules around restoration eligibility and the handling of order number expansions.