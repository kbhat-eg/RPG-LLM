# Explanation of RPG Program FH600R

This RPG program (FH600R) is designed as part of the "ASOFAK" system, intended for customer distribution lists and printing name labels. The code is written using the traditional fixed-format RPG IV (ILE RPG) style.

---

## File and Title Declarations

```rpg
/TITLE  ASOFAK: Kunde distr.liste, utskrift av navneetiketter, par
ffh600d    cf   e             workstn
```
- **`fh600d`** is a display file (`workstn`) used for interacting with the user interface (screen/form).

---

## Data Definitions

### Local Data Area (LDA) Fields

```rpg
d                uds
d l_firm                944    946  0
```
- Declares use of the LDA.
- **`l_firm`**: A 3-digit numeric field from positions 944–946 in the LDA.
  - Used to fetch the company number.

### Parameter List Data Structure

```rpg
d                 ds
d d_list                        16
d  d_firm                        3  0 overlay(d_list)
d  d_valg                        1    overlay(d_list:4)
d  d_ante                        1  0 overlay(d_list:5)
d  d_bred                        2  0 overlay(d_list:6)
d  d_hoyd                        2  0 overlay(d_list:8)
```
- **`d_list`**: A 16-byte structure used to pass parameters to another program.
- **Subfields (with overlays):**
  - `d_firm` (company, 3 digits)
  - `d_valg` (selection, 1 char)
  - `d_ante` (number in width, 1 digit)
  - `d_bred` (width in chars, 2 digits)
  - `d_hoyd` (height in lines, 2 digits)

### Program Variables

```rpg
d b_feil          s              1    inz(*off)
d w_firm          s              3  0
```
- **`b_feil`**: 1-char flag (error indicator), initialized to *off.
- **`w_firm`**: 3-digit numeric, holds company's number.

---

## Main Program Logic

### Initialization of Screen Fields

```rpg
c                   eval      b1valg = 'F'
c                   eval      b1ante = 3
c                   eval      b1bred = 36
c                   eval      b1hoyd = 6
```
- **Default values** for the screen fields before presenting the screen to the user.
  - Label type (`b1valg`) set to 'F'
  - Number (`b1ante`) set to 3
  - Width (`b1bred`) set to 36
  - Height (`b1hoyd`) set to 6

### Main Input/Output Loop

```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- **Displays the main screen** and waits for user input (`exfmt` for screen format `b1bld`).

#### Handling Function Keys

```rpg
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
```
- If the user presses F3 (*inkc) or F12 (*inkl), the program jumps to the `avslutt` (exit) routine.

#### Field Validation

```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   goto      b1taga
c                   endif
```
- Calls the subroutine `sjekk_input` to validate user input.
    - If there's an error (`b_feil` = *on), redisplay the screen for correction.

#### Calling the Print Program

```rpg
c                   eval      d_firm = w_firm
c                   eval      d_valg = b1valg
c                   eval      d_ante = b1ante
c                   eval      d_bred = b1bred
c                   eval      d_hoyd = b1hoyd

c                   call      'FH600C'
c                   parm                    d_list

c                   goto      b1taga
```
- **Copies screen fields to the parameter data structure**.
- **Calls external program** `'FH600C'`, passing the parameter structure for printing.
- Returns to the input loop for further interaction.

---

## Program Termination

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets LR indicator to *on (cleanup), then exits.

---

## Subroutines

### `sjekk_input` — Input Validation

```rpg
c     sjekk_input   begsr
c                   eval      b_feil = *off
```
Resets the error flag.

#### Checks

- **Antall etiketter i bredden (Number of labels in width):**
  ```rpg
  c                   if        b1ante = 0
  c                   eval      *in31  = *on
  c                   eval      b_feil = *on
  c                   goto      end_sjekk
  c                   endif
  ```
  - If `b1ante` (number of labels in width) is 0, sets indicator 31 and marks an error.

- **Etikettbredde (Label width):**
  ```rpg
  c                   if        b1bred < 32
  c                   eval      *in32  = *on
  c                   eval      b_feil = *on
  c                   goto      end_sjekk
  c                   endif
  ```
  - If the label width (`b1bred`) is less than 32, sets indicator 32 and marks an error.

- **Etikett høyde (Label height):**
  ```rpg
  c                   if        b1hoyd < 5
  c                   eval      *in33  = *on
  c                   eval      b_feil = *on
  c                   goto      end_sjekk
  c                   endif
  ```
  - If the label height (`b1hoyd`) is less than 5, sets indicator 33 and marks an error.

All errors stop further validation and return to the screen.

### `*inzsr` — Program Initialization

```rpg
c     *inzsr        begsr
c                   eval      w_firm = l_firm
c                   endsr
```
- **When the program starts**, it initializes the `w_firm` variable with the company number from the LDA.

---

## Summary of Program Flow

1. **Initialization**: Retrieves company number, sets up default screen values.
2. **User Interaction**: Displays a screen for user input.
3. **Validation**: Checks the screen inputs for validity.
4. **Print Call**: On valid input, calls an external print program with parameters.
5. **Repeat or Exit**: Allows the user to process multiple batches or exit via F3/F12.

---

## Key Takeaways

- This program provides a **parameterized interface for printing name labels** for customers.
- Uses traditional RPG constructs: display file I/O, data structure overlays, subroutines.
- Focused on **robust input validation** and parameter passing to an external print routine.
- Is designed to be cyclic, allowing multiple print runs in one session.

---

> **For onboarding:**  
Focus on understanding the display file interaction (`fh600d`), how the parameter data structure overlays are organized for inter-program communication, and the validation logic for user input. The core business logic is actually delegated to the `'FH600C'` program.  
