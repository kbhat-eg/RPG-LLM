# Explanation of RPG Program: CK002R

---

## **Program Overview**

This RPG (ILE RPG/400) program, `CK002R`, is part of the "EHANDEL" system and is used to manage the relationship between chain categories (`kjedkategori`) and customers (`kunde`). In particular, it's adapted for "Byggeriet Norge". The program is primarily a green-screen interactive application utilizing subfiles to display, create, update, and delete the connections between chain categories and customer categories.

---

## **File Section**

```rpg
fckgrl1    if   e           k disk    rename(ckgrpfr:ckgrl1r)
fckgrlr    if   e           k disk    rename(ckgrpfr:ckgrlrr)
fckgrlu    uf a e           k disk    rename(ckgrpfr:ckgrlur)
fckkllr    if   e           k disk    rename(ckklpfr:ckkllrr)
fra11lr    if   e           k disk    rename(ra11pfr:ra11lrr)
fck002d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **Physical/Logical Files:** The program uses several files, mostly renamed from base files for clarity or specific record formats. These files contain data about chains, categories, and connections.
- **Display File:** `ck002d` is the display file, using subfile `b1sfl` for interactive display. It also includes a feedback data structure for advanced screen feedback.


---

## **Data Structures and Variables**

### **Local Data Area (LDA)**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Holds user, firm, and navigation info loaded at program start.

### **Display Feedback DS**
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Captures screen feedback, such as the current record number.

### **Other Variables**
- Variables are defined for keys, screen work fields (like `w_srrn` for subfile record number, `w_fcrn` for first record number on the page, etc), flags (like `b_oppr` for "create mode"), and text fields.

---

## **Constants**
```rpg
d c_sfil          s              2  0 inz(14)
d c_modu          c                   'BM_MODUL  '
```
- `c_sfil` is the subfile page size (14 records per page).

---

## **Indicator Usage**

- Indicators (`*INxx`) are heavily used for screen and logic flow control (e.g. rollup, rolldown, subfile display, error messages).

---

## **Program Structure and Flow**

The main program logic is a tag/goto loop driving the display of the subfile and handling function (PF) keys. Much of the logic is in subroutines (`begsr`/`endsr`).

---

## **High-Level Workflow**

1. **Startup / Initialize**
   - The *INZSR subroutine reads LDA, fills initial variable values, and loads the first page of the subfile.

2. **Main Display Loop**
   - The program enters a loop (tagged by `b2taga`) where the screen is written (command display, subfile, etc.).
   - User input is handled by checking indicator variables for function keys.
   - Based on the input, the program branches to various operations: create, update, delete, view, position, and function-key-specific processing.

3. **Subfile Handling**
   - Data is loaded into the subfile (`crt_subfile`), displayed (`dsp_subfile`), and can be scrolled forward and backward (pagination).
   - Each subfile line can be selected for update, delete, or view.
   - Operations update both the subfile on the display and the corresponding database tables.

4. **Create/Update/View/Delete**
   - These are handled in their own subroutines and usually involve:
     - Displaying an edit/create screen.
     - Performing validation (ensuring referenced keys exist in their master tables).
     - Updating or writing records to the database.
     - Showing errors or confirmation messages as needed.

---

## **Detailed Subroutine Overview**

### **A. Subfile Management**

- **clr_subfile**: Clears the subfile and resets page/record counters.
- **crt_subfile**: Loads the next page of data by reading from the main data file and filling the subfile until the page is full.
- **bck_subfile**: Scrolls the subfile one page back by reading previous records.

### **B. Record Operations**

- **subfile**: Reads each subfile entry, checks if an operation (update, delete, view) was selected, and branches accordingly.
- **xc1bld / xc2bld / xd1win**: Handle creation, updating, and deletion (including validation and error messaging).
  - **xc1bld**: "Create new" - enter new link, with validation (does the referenced chain and customer category exist?).
  - **xc2bld**: Edit existing link. Updates the record and subfile.
  - **xd1win**: Delete a link, with confirmation.

### **C. Validation/Error Messaging**

- **xc1msg / xc2msg / xc3msg**: Display error/information messages (e.g., missing chain/customer category, or record already exists).
- **sok_kat**: Calls another program to lookup the customer category.

### **D. Positioning**

- **posisjoner**: Positions the file pointer to a selected point in the data, e.g., when the user wants to jump to a particular key in the subfile.

---

## **Screen/Key Processing**

- Each "bilde" (screen) has special processing for function keys (PF keys such as F3=End, F4=Create, F5=Categories, F10/Page Down, F11/Page Up, F21=Home, etc.).
- Indicators associated with these keys control screen flow and which operations are invoked after user actions.

---

## **Subfile-related Fields Explanation**

- `w_fcrn`: First record number on the current screen page.
- `w_spge`: Subfile page size.
- `w_srrn`, `w_sfrn`, `w_ssrn`: Subfile record counters (current, first on last page, last on last page).
- The subfile screen itself displays records and allows operations based on what the user selects per row.

---

## **File Key Lists (KLIST/KFLD)**

- Key lists are defined for all major files to allow composite key access (most keys are firm + chain-category/customer-category).

---

## **Calls to Other Programs**

- `call 'CK001R'`: Opens maintenance for chain categories.
- `call 'RA511R'`: Searches for a customer category.

---

## **Termination**

- When the user chooses to exit (PF3 or PF12), indicator LR is set (program end), and the program returns.

---

## **Key Takeaways for Maintenance/Onboarding**

- **Subfiles** are central: Most of the user interface is driven by subfiles for list display and entry selection.
- **Validation**: New connections are checked against master files; errors are clearly handled through message subroutines.
- **Function/Flow Control**: Largely indicator-based, with heavy use of tags and `goto` for main program control.
- **Manual Positioning**: The code enables scrolling and positioning of the subfile for usability.
- **Batch/Interactive Mix**: All database operations are interactive, and all updates are immediate.
- **Screen Management**: Each operation (add, change, delete, view) brings up a dedicated screen ("bilde").

---

## **Summary**

This program is a typical interactive RPG subfile maintenance application. It provides users with the ability to:
- List, scroll, and page through chain-customer category connections.
- Create new links, update existing ones, view, or delete them with appropriate validation and messaging.
- Navigate easily with PF keys and positioning fields.

Anyone maintaining or extending this code should be comfortable with:
- Classic RPG syntax and screen programming.
- Subfile mechanics and indicator-driven programming.
- Modularizing additional business rules into the existing subroutine structure.