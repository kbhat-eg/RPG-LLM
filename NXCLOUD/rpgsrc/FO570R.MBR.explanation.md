# Explanation of RPG Source Code (FO570R)

This RPG (Report Program Generator) program, `FO570R`, is a classic IBM i (AS/400) interactive application used for inquiry on orders/rest orders ready for delivery. The code is written in ILE RPG IV (also known as RPGLE) and uses a combination of fixed and free-format syntax, including handling of subfiles (paged lists on the display), working with database files, and calling other programs.

Below, the main components and control flow of the program are explained for onboarding and maintenance purposes.

---

## 1. **Program Overview**

- **Purpose:** Order/Rest Order Inquiry and Management for Deliveries.
- **Main Features:**
  - Viewing order lists ("subfile" presentation).
  - Navigating, filtering, and taking actions on orders.
  - Integration with transport/flow management.
  - Logging and updating order statuses.
- **User Interface:** 5250 screen with subfiles (scrollable lists), function keys, and input fields.

---

## 2. **Key Program Structures and Files**

### **2.1 File Declarations (`F-Specs`)**

- The program works with multiple database files representing orders, customers, inventory, users etc.
- Each file is renamed for local usage (e.g., `fohel1` as `fohel1r`).
- Display file `fo570d` is defined as a workstation file using a subfile (`sfile(b1sfl:w_srrn)`), which is the main list shown to users.

### **2.2 Data Structures (`D-Specs`)**

- **Local Data Area**: Used for user/session context (workstation id, user id, company number, etc).
- **Display Feedback Data Structure (`dspfbk`)**: Used for cursor positioning and feedback from the display file.
- **Work Variables**: Used for subfile control, record numbers, page sizing, flags, and various field values.
- **Composite Data Structure for Logging (`d_urec`)**: Used to create log records before calling a logging program.

### **2.3 Subfile-Related Variables**

Variables like `w_fcrn`, `w_stel`, `w_srrn`, `w_sfrn`, etc., control navigation and population of the subfile (scrolled list).

---

## 3. **Indicator Usage**

Indicators (`*INxx`) are used extensively to control screen behavior, program logic, and subfile options. The header comment explains their usage (e.g., *IN12 for subfile display, *IN14 to clear subfile, *IN15 for subfile end, etc.).

---

## 4. **Key Processing Flow**

### **4.1 Main Processing Loop**

- **Entry (Tag `b2taga`/`b2tagb`):**
  - Handles user input, executes subroutines, processes function keys, and reacts to user actions.
  - Main options are: renew list, position list, back/forward page, process entries, exit program, etc.

- **Subfile Handling (`subfile` subroutine):**
  - Loops through the subfile records, processes user selections (change, view, handle orders, etc.), calls external programs, and updates records accordingly.

### **4.2 Core Subroutines**

- **forny:** Refreshes the subfile based on current position/state.
- **posisjoner:** Positions to user-specified order number or date.
- **clr_subfile / crt_subfile:** Clears and creates/refills the subfile for display.
- **bck_subfile:** Handles paging backwards through the subfile.
- **dsp_subfile:** Displays the subfile or command screen.
- **sjk_lager:** Checks if there is enough inventory for an order.
- **klar_plukking:** Prepares an order for picking (removes rest status, updates log, may integrate with transport API).
- **chk_subfile:** Determines if a record should be shown in the subfile (based on status codes/filters).
- **xsjekk_lag:** Checks whether a user-selected warehouse exists on the order lines.
- **newlo_vask:** Cleans up data values for NewLook (removes problematic trailing characters).
- **xsjekk_inp:** Input field validation (mainly date checks).

---

## 5. **Highlights of Specific Features**

### **5.1 Subfile Paging and Cursor Handling**

- The RPG program manages subfile display and navigation "by hand," controlling which records are shown and how the user can scroll (forward, backward, jump to position/order).
- Uses variables like `w_srrn` (current relative record number), `w_ssrn` (last record), etc.

### **5.2 Order and Customer Lookup/Display**

- Chains to relevant files to display additional information (order details, customer names, address, types, etc.).
- Handles special customer/project logic (differentiates between invoice customer and product customer).

### **5.3 Logging and Status Management**

- On various order state changes (sending to picking, un-resting, etc.), builds a log record (`d_urec` structure) and calls another program (`FU900R`) to store the event.
- Also calls related programs for further processing (`AP058R` for transport/flows, `FO150R`, `FO710R`, etc.).

### **5.4 Integration with Flow Management**

- The program can be extended with external flow/transport management (flagged with `u_803`).
- If flow management is active, additional requests/program calls are made to synchronize orders with the transport system.

### **5.5 Filtering and Business Logic**

- Records can be filtered on warehouse, order status, type, and delivery capability.
- Subroutine `chk_subfile` applies business logic to include/exclude rows in the subfile, e.g., only showing orders with enough stock, of a certain type, or with the correct status.

### **5.6 Data Cleansing for NewLook**

- Ensures that certain characters (like periods or colons at the end of values) are cleansed from displayed fields to prevent screen-scraping or UI errors in external software called NewLook.

---

## 6. **Initialization (`*INZSR`)**

- Prepares key lists for database accesses.
- Loads user/company context from the LDA.
- Positions and prepares the initial subfile.
- Integrates with flow management if enabled.

---

## 7. **External Program Calls**

Throughout, other programs are called to handle certain operations and maintain modularity (such as customer detail, order update, logging, or external integrations).

---

## 8. **Comments, Versioning, and Change History**

- Extensive comments throughout the source explain modifications, business logic, and indicator usage.
- A version-log is kept at the beginning with changes, dates, and programmer initials.

---

## 9. **Subfile Interaction Summary**

- The main interactive loop handles keyboard events, field changes, and actions (change, display, process, etc.).
- Most user-driven activities are routed to subroutines that perform file operations, call other programs, and update the display.
- Navigation and display are tightly interwoven with subfile pointer logic.

---

## 10. **Key Coding Techniques**

- **Use of `CHAIN`, `SETLL`, `READE`, `READC`, `WRITE`**: For direct file access and subfile manipulation.
- **Indicators (`*INxx`)**: For field protection, highlighting, and UI control.
- **Data Structures**: For passing and organizing complex data between routines.
- **Free-format `DCL-S`, `DCL-PR`, `CallP`**: For newer-style RPG, especially for handling new external program calls and string management.

---

## 11. **Getting Started for Maintenance/Development**

- **Understand the subfile logic:** Most enhancements/additional actions will interact with this.
- **Review field and indicator usage:** Many business logic decisions are controlled via these.
- **Check external program interfaces:** If logic is extended (especially with flow/transport), make sure the parameter interfaces are aligned.
- **Test thoroughly:** Much of the workflow is dependent on interactive data entry with conditional logic for status, warehouse, customer, and so on.

---

**In summary**:  
This is a comprehensive, interactive, order management program on IBM i. It uses classic RPG subfile and interactive techniques, is heavily commented, modular (with subroutines and external program calls), and highly customized for the organizationâ€™s needs. New developers or maintainers should familiarize themselves with the subfile flow, the data structures/indicators, and the business rules controlling what is shown and what actions are available.