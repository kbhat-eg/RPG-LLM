## Program Overview

**System:** ASOFAK  
**Program:** EK723R  
**Description:** Customer bonus letter generation—prints a bonus letter for each customer.  
**Special Version:** Used only for Degernes (tailored for this customer).  
**History:**  
- Initial release: 2001-02-09 (ASK)
- v9.01 (2004-03-10, bof): Support for multiple bonus groups (up to 99)
- v6.10 (2011-08-11, bsa): Considers selected bonus type
- v6.11 (2011-09-02, bsa): Checks if type is "byggende" (building/accumulating)

---

## Purpose and Business Context

This program generates and prints bonus letters for customers who have associated bonus agreements. It aggregates bonus data per customer and per product group, retrieves the applicable bonus rates, and formats the output for printing. The logic is tailored for a specific customer (Degernes), reflecting both technical and business-specific requirements.

---

## File/Table Usage

- **rkunl1**: Customer master (renamed from `rkunpfr`)
- **ekboi1**: Customer bonus agreements (renamed from `ekbost`)
- **eppsl1**: Bonus rates/procent register (renamed from `eppspfr`)
- **ek723p**: Printer file (output)

**Note:** All files are externally described and accessed via keys. Naming conventions use the `rename` keyword for clarity and to avoid conflicts.

---

## Data Structures and Key Variables

### Arrays for Bonus Groups (v9.01)

- `a_merk(99)`: Bonus group codes/identifiers
- `a_besk(99)`: Bonus group descriptions
- `a_pros(99)`: Percentage rates for each group
- `a_bgru(99)`: Accumulated bonus basis per group (11,2)
- `a_sbon(99)`: Accumulated bonus amount per group (9,0)

### Parameters

- `p_firm`: Company code (3 chars)
- `p_paar`: Bonus year/period (4 chars)
- `p_tbot`: Bonus type (2 chars, v6.10+)

### Local Data Area (LDA)

- Used to pass date and three lines of text (for letter headers/footers).

### Key Variables

- `eppsl1_aarr`: Bonus year for rates lookup
- `ekboi1_bkun`: Customer number for bonus agreements

---

## Program Structure and Flow

### Initialization (`*inzsr`)

- Parameters are received: company, period/year, and (if v6.10+) bonus type.
- Key lists are constructed for file access (customer, bonus agreements, bonus rates).
- Parameters are moved to working variables.

### Main Logic

1. **Load Bonus Rates and Descriptions**
   - `prosent` subroutine populates `a_merk`, `a_besk`, and `a_pros` arrays from the bonus rates file for the current period.

2. **Load Letter Texts and Date**
   - `tekst` subroutine loads textual content and date from the LDA into variables for output.

3. **Iterate Over Customers with Bonus Agreements**
   - Loop over all customers in `rkunl1`.
   - For each customer:
     - Chain into `ekboi1` to check for bonus agreements.
     - If a specific bonus type is required (`w_tbot`), skip customers whose agreement type does not match.
     - If the agreement is "byggende" (accumulating, `ekebyg = 1`), skip as required by business rules.
     - Call `beregn` to process and print the bonus letter.

4. **Exit and Cleanup**
   - Set LR indicator and return.

---

## Subroutines

### `beregn` — Calculate and Print Bonus Letter

- **Reset Accumulators:**
  - Zero out `a_bgru` and `a_sbon` arrays.
- **Aggregate Bonus Data:**
  - Loop through all bonus agreements for the customer.
  - For each agreement, find the matching bonus group via `%lookup` (using the first 4 chars of `ekmerk`).
  - Accumulate bonus basis and bonus amount per group.
- **Prepare Customer Information:**
  - Copy customer details into output fields.
- **Print Header:**
  - Write `a1hdr` record (customer header).
- **Summarize and Print Bonus Groups:**
  - Loop through all bonus groups (up to 99).
  - Accumulate subtotals (`t1subg`, `t1subn`).
  - For each group with a non-blank code, print group details (`d1det`).
  - If page overflow indicator (`*in40`) is set, print the header again and reset the indicator.
- **Print Totals:**
  - Write `t1tot` record.
- **Reset Subtotals:**
  - Zero out subtotal accumulators.

### `prosent` — Load Bonus Group Rates/Descriptions

- **Initialize Arrays:**
  - Set all `a_merk` and `a_besk` elements to blank, and `a_pros` to zero.
- **Load From Rates File:**
  - For the current period, read all bonus groups and fill arrays with codes, descriptions, and percentages.

### `tekst` — Load Letter Texts

- **Copy From LDA:**
  - Assigns period, date, and up to three text lines from the LDA to output variables.

---

## Design Decisions and Patterns

- **Multi-Bonus Group Support (v9.01):**
  - Arrays with dimension 99 for group-specific data, enabling scalable support for multiple bonus groups per customer.
- **Business Rule Filters:**
  - Bonus type filter (`w_tbot`) and "byggende" (accumulating) type exclusion are handled inline, reflecting evolving business requirements.
- **Data-Driven Output:**
  - Bonus rates, descriptions, and groupings are loaded at runtime from the bonus rates table, making the program adaptable to changes in group structure or rates without code changes.
- **LDA Usage:**
  - The program leverages the Local Data Area for dynamic, session-specific data (date and letter text), simplifying integration with batch or interactive job control.

---

## Integration and Dependencies

- **Master Data:**
  - Customer and bonus agreement data are sourced from central files, likely shared with other modules.
- **Bonus Rates Table:**
  - The bonus rates/procent register is a key reference for group rates and descriptions.
- **Printer Output:**
  - Output is sent to a printer file (`ek723p`), with formatting controlled by the program and potentially by DDS in the printer file definition.
- **LDA:**
  - Used for run-time parameterization, possibly set by a job control program or operator.

---

## Conventions and Notes

- **Norwegian Naming:**
  - Variable and field names, as well as comments, are in Norwegian, reflecting the business context.
- **Version Comments:**
  - Inline comments track changes by version, making maintenance and auditing easier.
- **Tag/Goto Usage:**
  - Some legacy control flow remains (e.g., `goto`, `tag`), typical of older RPG codebases.
- **Error/Overflow Handling:**
  - Page overflow is managed via indicator `*in40`, with logic to repeat headers as needed.

---

## Summary

This program is a batch/reporting utility for generating customer bonus letters, tailored for a specific client and supporting up to 99 bonus groups per customer. It is data-driven, modular, and incorporates business rules that reflect both general and customer-specific requirements. Understanding the relationships between customers, bonus agreements, and bonus group definitions is key to maintaining or extending this program. Integration with other modules is primarily through shared files and the LDA, with output managed via a dedicated printer file.