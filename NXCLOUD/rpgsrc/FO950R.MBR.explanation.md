# Explanation of RPG Source Code: FO950R

This RPG (Report Program Generator) code is for an IBM i (AS/400, iSeries) system. The program's name is **FO950R**, and it is designed for printing "frittstående bankgiro" — standalone bank giro payment forms, a common payment method in Scandinavia.

Below is a pedagogical breakdown of the source code, focusing on its structure, major sections, and key logic.

---

## 1. **Header Section**

The header specifies program metadata and configuration:

- `h`: Header specification, sets edit codes for numbers and dates.
    - `dedit('0,')`: Decimal edit for using comma as decimal separator.
    - `datedit(*dmy.)`: Date edit for day-month-year formatting.
- Comments outline program purpose, history, and modifications.  
    - The program has undergone several revisions, mostly to adapt to new versions, handle special cases, or add fields.

---

## 2. **File Specifications (`F-Specs`)**

Declare the files used by the program:

- Input files (all disk files, `I`, externally described, keyed, end-of-file indicator, and with renamed record formats):
    - `votyl1`, `sohel1`, `rkunl1`, `afirl1`, `aforl1`
- Output file:
    - `fo950p` (printer file for physical printout)

---

## 3. **Data Definitions**

### a. **Alphanumeric Arrays and Variables**

- `akr`: Array used to process the amount in kroner (Norwegian currency)
- `a10`, `m10`, `u10`: Arrays and variables supporting "modulus 10" checksum calculations

### b. **Data Structures (DS)**

- **Parameter DS**: Stores incoming parameter block and overlays individual fields (year, order type, etc.).
- **BankGiro From/To DS**: Used for manipulating and formatting account numbers
- **Fields from LDA (Local Data Area)**: Pulls configuration and print control info (e.g., OCR flag, company code) in legacy ways.

### c. **Other Variables**

- Key variables for reading files
- Working fields for amounts, customer, check digits, etc.

---

## 4. **Main Control Section (Calculation Specs)**

### a. **Initialization**

- If this is the first pass (`fcycle = *zero`), call the initialization subroutine (`xstrsr`).

### b. **Main Processing Loop**

- Processes order headers by reading through `sohel1` file until EOF.
- Checks for:
    - New company
    - Year changes
    - Order number passing the target
    - Inactive order types
- For unique customer/order-number pairs, it calls:
    - `xajour`: Prepare data for print
    - `xprint`: Print bankgiro if eligible

- Updates local variables for subsequent iterations.

### c. **Handling Special Fields**

- If `l_kidk` (KID type selector from LDA) is 1 or 2, moves the appropriate customer identification number (`KID`) field for check digit calculation.

---

## 5. **Subroutines**

### a. **xajour: Prepare Data for Printing**

- Reads customer data from the customer file
- Transfers relevant address and name information
- Moves invoice total (`sofsum`) into a local field
- Calculates check digits (modulus 10) for the amount, storing the result
- Removes leading zeroes from alphanumeric representations

### b. **xprint: Print Bankgiro**

- Only prints if:
    - The invoice total is positive
    - The payment method (from customer) is "1" (bank giro)
- Writes the bankgiro form and H-line (special line depending on printer/OCR type):
    - Various record formats are written (`p3gir`, `p4gir`, etc.), depending on the print technology (plain, OCR, special printers).
    - Handles specific flags (`l_ocrk`) for output variants.

### c. **mod10: Calculate Modulus 10 Check Digit**

- Standard modulo-10 algorithm for Swedish/Norwegian OCR payment reference fields.
- Transforms the input field into an array, applies position weighting, adds up values, and calculates the check digit to be printed/stored.

### d. **xstrsr: Initialization Routine**

- Sets up the company and year in the key fields
- Reads the first matching order header record to prime the loop
- If printing company info is enabled, reads company file and copies the required fields for printout
- Formats bankgiro numbers for OCR if required
- Looks up the order type and sets a flag if it's negative

### e. **Standard Initialization (`*inzsr`)**

- Resets certain fields
- Defines record keys for file access
- Loads the control file (`aforl1`) for print configuration (using `l_ruti`)

### f. **Parameter Reception (`*entry`)**

- Receives incoming parameters into the local parameter data structure and initializes `d_parm` overlayed fields.

---

## 6. **Key RPG Concepts Used**

- **Data Structures with Overlay**: For mapping parameters and account numbers.
- **File Key-lists (`klist`)**: For keyed access to DB files.
- **Subroutines (`begsr`/`endsr`)**: For modular and reusable code sections.
- **LDA Access**: For local job-specific configuration.
- **Conditional Output**: Printout logic depends on customer/payment/printer flags.
- **Modulus 10 Check Digits**: Ensures data integrity on payment forms.

---

## 7. **Typical Program Flow**

1. **Initialization**:
    - Set up fields and configuration from parameters and the current job context.
2. **Order Loop**:
    - Read orders, comparing each to the target company/year/type.
    - For unique customer-order combos, prepare data and print if eligible.
    - For each relevant line, produce the bankgiro printout using the correct template/format.
3. **Check Digit Calculation**:
    - Before printing critical fields (like amount, KID), calculate modulus 10 check digits as required for scannable payment forms.
4. **End of Program**:
    - Close files and end the program with `*inlr = *on` (last record indicator).

---

## 8. **Special Notes**

- **Legacy Features**: LDA usage, overlayed data structures, and direct file access patterns are typical of older RPG/400 programs but remain relevant on modern IBM i systems.
- **Edit Codes**: The header edit codes ensure that printed amounts/dates use Norwegian/Scandinavian formatting.
- **Customization**: Comments note areas where the program was customized for new printer types, OCR handling, and payment reference handling over time.

---

## 9. **Summary Table of Main Files Used**

| File    | Purpose                                  |
|---------|------------------------------------------|
| votyl1  | Order types/config                       |
| sohel1  | Order header/main data                   |
| rkunl1  | Customer master file                     |
| afirl1  | Company master file                      |
| aforl1  | Print template/control register          |
| fo950p  | Printer output (bankgiro forms)          |

---

This program is a classic RPG batch utility for mass-printing payment forms for customers, with integrity checks (modulus 10), conditional output per printer type, and flexible forms configuration via control files, all common in Scandinavian banking/payment processing.