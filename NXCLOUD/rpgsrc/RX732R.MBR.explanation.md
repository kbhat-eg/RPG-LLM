# RX732R – Update VAT Basis

## Overview

This program, RX732R, is part of the ASOKON system and is responsible for updating the VAT (MVA) basis in the general ledger records. The code processes records in the `rhtrpf` file and adjusts the VAT basis field (`rbmvag`) according to specific business rules. Additionally, it updates tracing fields for audit purposes.

## File and Data Area Usage

- **rhtrpf**: Primary input/output file, processed with a record-level lock (`uf e k disk`). The record format is renamed from `rhtrpfr` to `rhtrpfr` (likely for consistency).
- **Local Data Area (LDA)**: Used to retrieve user and company information:
    - `l_user`: User ID (positions 911–920)
    - `l_firm`: Firm number (positions 944–946)
    - `l_navn`: Name (positions 951–980)

## Variable Definitions

- `w_firm`: Work variable, same type as `rbfirm` (company/firm code).
- `w_pmva`: Work variable, 2-digit packed decimal, likely for VAT code or similar.
- `w_mdat`: Work variable, date in ISO format.

## Main Processing Logic

### Record Selection

- The program reads records from `rhtrpf`.
- Only records where the accounting year (`rbraar`) is 2004 or later are processed.

### VAT Basis Adjustment Logic

For each qualifying record, two mutually exclusive conditions are checked:

#### 1. Negative Case

- `rbneto` < 0
- `rbmvab` < 0
- `rbmvag` > 0

**Action:**  
`rbmvag` is negated (`0 - rbmvag`), making it negative.  
Audit/tracing fields are updated:
- `rbedat`: Set to current date (using `time`)
- `rbetim`: Set to current time
- `rbeusr`: Set to current user (`l_user`)

The record is then updated.

#### 2. Positive Case

- `rbneto` > 0
- `rbmvab` > 0
- `rbmvag` < 0

**Action:**  
`rbmvag` is negated (`0 - rbmvag`), making it positive.  
Audit/tracing fields are updated as above, and the record is updated.

### Loop Control

- The program continues reading and processing records until end-of-file (`*in90` = *on).

## Program Termination

- After processing, the program sets the LR indicator (`*inlr = *on`) and returns.
- There is a placeholder for an initialization subroutine (`*inzsr`), but it is currently empty.

## Tracing/Audit Fields

- As of version 6.10 (210909), tracing fields (`rbedat`, `rbetim`, `rbeusr`) are updated whenever a record is changed. This supports auditability and tracking of changes.

## Business/Domain-Specific Notes

- The program enforces consistency in VAT basis sign according to the sign of net amount and VAT amount, which is a common requirement in Scandinavian accounting.
- Only records from 2004 onwards are affected, likely due to a regulatory or system change.
- The VAT basis field (`rbmvag`) is corrected if its sign does not match the expected sign given the net and VAT amounts.

## Design Considerations and Conventions

- The program uses direct record-level processing (native I/O) for performance and control.
- Audit fields are always updated when a record is changed.
- The use of the LDA for user and company information is a system-wide convention.
- Error handling is minimal; the program assumes the file is available and records are accessible.
- All business logic is contained within the main loop; there are no external calls or modularization.

## Interactions

- **File `rhtrpf`**: Main data source and target for updates.
- **Local Data Area**: Used to retrieve session/user information.
- No calls to external programs, APIs, or modules.

## Version History

- **100204 (KOB)**: Initial version.
- **6.10 / 210909 (BSA)**: Added tracing/audit fields.

---

If you are onboarding to this codebase:
- Familiarize yourself with the structure and fields of `rhtrpf`.
- Understand the company’s VAT handling and why sign consistency is enforced.
- Be aware of the audit field conventions and the use of LDA for session information.
- Note that this program is batch-oriented and not intended for interactive use.