```markdown
# Overview

This RPG IV program (`FO672R`) is part of the ASOFAK system. It displays a data entry screen for invoice/journal printing parameters, validates the input, and then returns control (and parameters) to the caller (`FO674`).

---

## 1. File and Data Structure Declarations

```rpg
FFO672D    CF   E             WORKSTN
```

- **CF E**: Defines a workstation file for display I/O.

```rpg
D                 DS
D  DSPARM                 1     32
D  DSAARR                 1      4  0
D  DSOTYP                 5      6
D  DSFBIN                 7     14  0
D  DSTBIN                15     22  0
D  DSPROG                23     32
```

- **DS** (`DSPARM`): A 32-byte data structure used for passing parameters to/from the caller.
- Subfields:
  - `DSAARR`: Year
  - `DSOTYP`: (unused here)
  - `DSFBIN`: “From” invoice number
  - `DSTBIN`: “To” invoice number
  - `DSPROG`: Calling program identifier

```rpg
D                UDS
D  DSRUTI               800    809
D  DSSFIR               944    946  0
```

- **UDS**: User-defined storage (LDA) to pick up variables from the program global area.

---

## 2. Main Processing Logic

```rpg
A1TAG         TAG
   // 1. Initialize screen-field variables
   MOVE UYEAR      A1AARR
   MOVE *ZERO      A1FBIN
   MOVE *ZERO      A1TBIN

   // 2. Convert two-digit year to four-digit
   IF A1AARR > 80
     ADD 1900      A1AARR
   ELSE
     ADD 2000      A1AARR
   ENDIF

A1TAGA        TAG
   EXFMT A1BLD    // Display the data-entry screen named A1BLD
```

### 2.1 Handle “Exit” (F3)

```rpg
*INKC IFEQ *ON
   Z-ADD 1     WPPF03      // Signal exit to caller
   GOTO XSLUTT
ENDIF
```

- If the **F3** key is pressed, set the exit indicator (`WPPF03`) and jump to the exit routine.

### 2.2 Validate “From” ≤ “To”

```rpg
A1TBIN IFNE *ZERO
   IF A1FBIN > A1TBIN
     MOVE *ON   *IN33      // Turn on error indicator at field 33
     GOTO A1TAGA          // Redisplay screen
   ENDIF
ENDIF
```

- If “To” is entered, ensure the “From” number is not greater.
- Otherwise, redisplay the screen with an error.

### 2.3 Default “To” if Blank

```rpg
A1TBIN IFEQ *ZERO
   Z-ADD A1FBIN    A1TBIN
ENDIF
```

- If the “To” field is blank, copy the “From” value into it.

### 2.4 Prepare Return Parameters

```rpg
MOVE A1AARR    DSAARR
MOVE A1FBIN    DSFBIN
MOVE A1TBIN    DSTBIN
MOVE DSPARM    WPPARM    // Copy the raw parameter block back
MOVE 'FO674'   DSRUTI    // Next program to call
```

- Moves screen values into the LDA (data area) for the caller.
- Sets up `DSRUTI` to the next routine name.

---

## 3. Exit Routine

```rpg
XSLUTT        TAG
   SETON       LR       // Set Last Record indicator: end program
   RETURN
```

- Cleans up and returns to the caller.

---

## 4. Initialization Subroutine (`*INZSR`)

```rpg
*INZSR        BEGSR
   MOVE *BLANK    WRETUR(1)   // Clear return buffer
   // Parameter list to accept incoming parameters
*ENTRY        PLIST
   PARM     WPPARM         32   // 32-byte parm block
   PARM     WPPF03          1 0 // 1-byte flag for exit
   ENDSR
```

- **`*INZSR`** is automatically called on the first cycle.
- Clears any non-redefinable fields.
- Defines the **parameter list** to accept:
  - `WPPARM`: a 32-byte parameter block from the caller.
  - `WPPF03`: a one-byte status flag (to detect F3).

---

# Summary of Flow

1. **Initialize** screen fields and accept incoming parameters.
2. **Display** the screen (`EXFMT A1BLD`).
3. **Handle F3** exit if requested.
4. **Validate** the “from-to” invoice range.
5. **Default** the upper bound if blank.
6. **Move** entered values into the LDA and set up the next routine.
7. **Exit**, returning control to the calling program (`FO674R`).

This pattern—display, validate, and return—is common in AS/400 ILE programs using traditional **WORKSTN** display files.