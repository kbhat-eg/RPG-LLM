# RPG Program Explanation: ASOFAK (FA909R)

This RPG (Report Program Generator) source code defines a subprogram ("ASOFAK") for rounding monetary amounts in the format 9:2 (7 digits before and 2 after the decimal point). The program is written in traditional /FREE RPG IV (ILE RPG), and is intended for use on IBM i (AS/400) systems.

## High-Level Purpose

- **Function:** Receives a monetary amount, passes it to another program for rounding ("FA910R"), and safely returns the result, making sure it does not exceed the maximum representable value for 9:2 numeric type (9,999,999.99).
- **Use Case:** Ensuring that amounts manipulated in the system fit within formats and rounding rules used for database storage or display.

---

## Program Structure Overview

### 1. Variable Definitions

```rpg
d p_firm          s              3  0   // Company identifier (3 digits, no decimals)
d p_vare          s             15      // Item identifier (15 alphanumeric)
d p_kode          s              1  0   // Code (1 digit, no decimals)
d p_bel1          s              9  2   // Amount (up to 9,999,999.99)

d w_bel1          s             11  2   // Working amount (larger range, up to 999,999,999.99)
```
- **`p_...` fields** are program parameters.
- **`w_bel1`** is a temporary/working field to allow for overflow during processing.

---

### 2. Main Program Logic

#### a. Preparation
```rpg
c                   eval      w_bel1 = 0
c                   eval      w_bel1 = p_bel1
```
- Initialize `w_bel1` to zero, then copy the input amount (`p_bel1`) to `w_bel1`.

#### b. Call to Rounding Subprogram
```rpg
c                   call      'FA910R'
c                   parm                    p_firm
c                   parm                    p_vare
c                   parm                    p_kode
c                   parm                    w_bel1
```
- Calls another program (`FA910R`) to perform the actual rounding. Parameters are passed by reference, so `w_bel1` is updated in-place.

#### c. Post-processing: Overflow Protection
```rpg
6.31 c               if        w_bel1 < 10000000
c                   eval      p_bel1 = w_bel1
6.31 c               endif
```
- After rounding, if the result fits within 9,999,999.99 (`w_bel1` < 10,000,000), then it is moved back to `p_bel1` (the parameter the caller provided).
- If it doesn't fit, the output is not changed—protecting against database or calculation overflow.

#### d. Program End
```rpg
c     avslutt       tag
c                   return
```
- `avslutt` tag marks the logical end point. Program returns to the caller.

---

### 3. Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_vare
c                   parm                    p_kode
c                   parm                    p_bel1
c                   endsr
```
- The `*inzsr` subroutine is called once when the program starts, to set up the parameters.
- The `*entry plist` defines the order and variables that will receive the parameters passed into the program.

---

## Notable Features & Comments

- **Overflow Handling:** The business rule (line marked `6.31`) ensures amounts exceeding 9,999,999.99 are not erroneously returned to the caller, avoiding errors in subsequent processing.
- **Modular Design:** Delegates rounding logic to another program (`FA910R`), allowing for reuse and separation of concerns.
- **Legacy Style:** Written in fixed-format RPG IV, which is common in older IBM i shops.

---

## Summary Table

| **Variable** | **Purpose**              | **Type/Length**    |
|--------------|--------------------------|--------------------|
| p_firm       | Company number           | Packed(3,0)        |
| p_vare       | Item number/code         | Char(15)           |
| p_kode       | Rounding/control code    | Packed(1,0)        |
| p_bel1       | Amount, parameter        | Packed(9,2)        |
| w_bel1       | Amount, working          | Packed(11,2)       |

---

## Typical Flow

1. The program is called with four parameters: firm, item, code, and amount.
2. Copies the amount to a working variable.
3. Calls the FA910R subprogram to round the amount.
4. If the processed amount is less than 10,000,000, copies it back to the caller’s variable.
5. Returns control to the caller.

---

## Comments

- This kind of subprogram is often used for enforcing data integrity and business rules, especially in financial/accounting applications.
- "Beløp på formen 9:2" means "amount in the format 9:2", i.e., 9 digits, 2 decimals.

---

## Example Usage Scenario

If you had an amount of 5,000,123.457, the program would:
- Pass the amount to FA910R for rounding (e.g., to 5,000,123.46).
- If the rounded amount is less than 10,000,000, it returns the result.
- Larger values are not returned to avoid storage errors.

---

This program is an interface layer ensuring safe, rounded monetary values within defined storage limits.