# RPG Program Explanation: EK110R

This program, written in classic (fixed-format) IBM ILE RPG, is designed to **display and process customer bonus elements in a subfile**. The code features file definitions, parameter handling, subfile loading/handling, function key management, and various lookups related to customers, products, groups, vendors, and more. Below is a detailed walkthrough for onboarding new developers.

---

## **1. High-Level Purpose**

- **System**: ASPNIB
- **Program**: EK110R
- **Description**: Displays and processes customer bonus elements (`Kunde bonuselement, vise`).
- **Input**: Various parameters for filtering bonus elements (e.g., company, customer, product group, dates).
- **User Interface**: Uses subfiles for display and selection, with support for standard function keys (e.g., page up/down, inquiry, refresh).

---

## **2. Key Architectural Elements**

### **a. File Definitions**

Several logical files are defined and renamed for record formats, supporting lookups for:

- **Bonus Elements**: `ekbei1`, `ekbeir`
- **Discounts & Products**: `ra06l1`, `fkprl1`, `jvarl1`, etc.
- **Groups and Vendors**: `vogrl1`, `vhgrl1`, `vugrl1`, `rlevl1`
- **Other Info**: `vvarl1`, `venhl1`, `vltpl1`, `vbotl1`

The main display file is:
- `ek510d` (with subfile `b1sfl`, controlled by `w_srrn`), defined as a workstation file.

### **b. Indicator Usage**

The first comments block describes how numbered indicators (`*INxx`) are used. For instance:
- `*IN10`, `*IN11` → Roll up/down
- `*IN12`, `*IN13`, `*IN14`, `*IN15` → Subfile display/control
- `*IN21`, `*IN22` → Cursor and home key
- `*INLR` (last record) → Program exit

### **c. Parameter Handling**

- Parameters (such as `p_firm`, `p_kund`, etc.) are defined as standalone variables, and then mapped into "working" variables (like `w_firm`) at program start.
- These are received via the *ENTRY PLIST*, making this RPG program callable from other programs.

### **d. Data Structures and Variables**

- Flat Data Structure for Local Data Area (User, Name).
- Information Data Structure (`dspfbk`) for handling feedback from display file (e.g. cursor position).
- Various variables for subfile handling (first/last record, page size, etc.), and working copies of parameters.

---

## **3. Main Program Flow**

The program structure is a classic "main loop" with subroutines:

### **a. *INZSR (Initialization Subroutine)**

- **Receives parameters** via PLIST and assigns them to working variables.
- **Populates display fields** for the header (names, descriptions, etc.) by calling or chaining to various files.
- **Positions the bonus element file** and calls subroutine to load the subfile (`crt_subfile`).

### **b. Main Loop**

- **b2taga / b2tagb**: Entry points via tags (labels), handling display logic and user input.
    - Writes CMD screen.
    - Displays/refreshes the subfile (`exsr dsp_subfile`).
- **Function Key Handling**: Uses a `SELECT` group to branch on function key indicators:
    - `*INKC`, `*INKL` (F3/Exit): Exit program.
    - `*INKD` (F5/Inquire): Call inquiry subroutine.
    - `*INKE` (F6/Refresh): Call refresh subroutine.
    - `*IN10` (Page up): Load more records into subfile.
    - `*IN21` (Home): Set cursor to start.

- **Subfile Handling**:
    - Reads changed subfile records.
    - Takes action based on user selection (e.g., show details).
    - Bails out if the user exits.

- **Program Exit**: Sets `*INLR` to `*ON` and returns.

---

## **4. Key Subroutines**

### **a. forny (Refresh Subfile)**
- Clears and repopulates subfile after repositioning file pointer to appropriate key.

### **b. subfile**
- Reads changes from subfile (using `readc`), processes each change.
- Handles "show" selection (usually coded as value = 5), and displays details using `xc2bld` subroutine.

### **c. xc2bld**
- Loads details for a specific bonus element and displays the detail screen.

### **d. clr_subfile**
- Empties (clears) the subfile, resets record counters.

### **e. crt_subfile**
- Loads up to a page of records into the subfile based on current keys and parameters.
- Handles end condition if the bonus element file does not match user-specified criteria.

### **f. dsp_subfile**
- Controls the actual display of the subfile (with/without content), sets indicators for display file.

### **g. spørring (Inquiry)**
- Placeholder for inquiry logic (currently empty).

---

## **5. File Key Lists**

The program makes heavy use of key-lists (`KLIST`) for defining complex key fields needed for SQL-like random access (`CHAIN`, `SETLL`, etc.) to the various logical files.

---

## **6. Special Notes**

- **Subfile Mechanism**: Subfiles are a classic IBM i screen pattern for displaying lists. This code handles page handling, cursor positioning, reading changed records, and updating the subfile.
- **Scandinavian Code**: Field names and comments are in Norwegian, common in many IBM i shops. 'Kunde' = 'Customer', 'bonuselement' = 'bonus element', etc.
- **No business logic for update/add**: This program is strictly for "showing" (display/lookup) per comments and selection values.
- **Maintenance**: The code is relatively modular, using subroutines for all major actions.

---

## **7. Onboarding Tips**

- **Understand Subfile Processing**: Reading, loading, clearing, displaying, and cursor logic are all managed manually via subroutines.
- **Know Your Indicators**: Classic RPG behavior is controlled using numbered indicators. Frequent use of `*ON`/`*OFF`.
- **Parameter Handling**: Input is through the PLIST, so this code is not typically run as a stand-alone menu option.
- **Adding Business Logic**: To support changes (add, update, delete), you will need to extend the SELECTION logic and subfile handling routines.
- **Navigation**: Main logic is effectively a loop between displaying the subfile, handling input, and processing until the user exits.

---

## **8. Key Terminology**

| Field     | Meaning             | Used for              |
|-----------|---------------------|-----------------------|
| b2rkat    | Discount category   | Header display        |
| b2kund    | Customer number     | Header display        |
| b1sfl     | Subfile record      | Main list display     |
| c2bld     | Detail display      | Viewing record details|
| *inXX     | Indicator           | Function key/flow     |
| ekbei1    | Bonus element file  | List population       |

---

## **9. Program Summary**

1. **Receives parameters** (company, customer, product, dates, etc.).
2. **Looks up and displays header fields** (descriptions).
3. **Loads a subfile** (list) of bonus elements matching the selection.
4. **Allows navigation and detail viewing** using function keys and selection fields.
5. **Repeats** until the user exits.

---

> **For new RPG developers**: Focus on understanding the subfile design pattern, key list usage for file IO, and classic RPG use of indicators and control tags. The logic for navigation and subfile management is directly mapped to indicator-based function keys and subroutines. This code style is representative of many classic IBM i green-screen applications.