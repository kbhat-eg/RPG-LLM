# ILE RPG Program FO7301 – Explanation

## Overview

This program (`FO7301`) is designed to update order transactions ("transer"), focusing on recalculating and updating values such as prices, discounts, and totals for order lines and order headers. It is a traditional fixed-format RPG program, heavily commented and tailored for a Norwegian-speaking business context. The program works with several database files (order headers, order lines, item masters, etc.) and interacts with external routines for price and discount logic.

The main use-case is to make sure that line and header totals are recalculated correctly after changes, with special handling for items like "skaftevarer" (special-order goods/VA goods) and return-fees.

---

## Structure Overview

- **File Definitions:** Declares logical and update files for header, detail, item, and various support tables.
- **Data Definitions/Variables:** Includes parameters, key fields, accumulator variables, and structures for price calculation.
- **External Program Prototypes:** Prepares for calls to external programs (`CO402R`, `VP900R`, etc.).
- **Initialization:** Reads input parameters, builds key lists, and checks configuration flags (e.g., whether to apply return fees or use "Solve" VA logic).
- **Main Processing Loop:** Reads order lines, calculates/retrieves prices and discounts, updates each line and accumulates totals.
- **Subroutines:** Handles price retrieval, price group fetch, header update, and program initialization.

---

## Key Sections Breakdown

### 1. File Declarations

```rpg
ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
ffohelu    uf   e           k disk    rename(fohepfr:fohelur)
ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
ffodtlu    uf   e           k disk    rename(fodtpfr:fodtlur)
...
```
- **fohel1/fohelu:** Order header (inquiry and update versions).
- **fodtl1/fodtlu:** Order lines (inquiry and update).
- **vltyl1:** Line type lookup (to skip text lines etc).
- **vvarl1:** Item master lookup.
- **fod2l1:** Lookup for return fee logic.

---

### 2. Data Definitions

- **Parameters:** Passed in at program entry (`p_enor`, `p_firm`, `p_numm`, `p_suff`) — these identify the order.
- **Work variables:** For accumulating totals (`w_sald`, `w_sumr`, `w_tots`, etc.), storing intermediary results, and controlling logic.
- **Data structures:** E.g., `hirec`/`horec` for passing input/output buffers to price calculation programs.

---

### 3. Initialization (`*inzsr`)

- Reads entry parameters, stores them to work variables.
- Assembles RPG key-lists for all files using these parameters.
- Calls external program `CO402R` to configure:
    - **Return fee (returgebyr)** logic (`AKTIVER_RETURGEBYR`)
    - **"Solve" VA logic**, a business-specific flag (`SOLVE_VA`)

---

### 4. Main Program Logic

**Step-by-step:**
1. **Read the Order Header** (`fohel1_key chain fohel1r`)
   - Aborts if not found.
2. **Process All Order Lines** (loop over `fodtl1`)
   - **Skip Text Lines:** If line type indicates a text line, line is skipped.
   - **Fetch Price Group:** Calls subroutine for price group information for each line.
   - **Item Master Lookup:** Reads item information needed for further calculations.
   - **Set Calculation Variables:** Temporary variables for price, discount, etc., loaded from current line/item.
   - **Conditional Discount/Price Recalculation:**
     - Depending on business flags/fields (`fdlvre`, `fdprtx`, `fdkpri`), certain logic may be skipped (e.g., SKAFFEVARER, lines already changed, etc.).
   - **Calculate Totals:**
     - Calculates line total, discounts (multiple levels), cost price, and (if enabled) applies return fee.
   - **Update Order Line:** Writes back newly calculated values to the update file.
   - **Accumulate Totals:** For totalizing header-level fields.

3. **After Lines:**
   - **Update Order Header:** Calls subroutine to refresh header totals and meta-data, then calls another program to update memo-balances if needed.

---

### 5. Subroutines

#### a) `hent_pris` (Get Price)

- Prepares input data structure for external price calculation program.
- May clear customer/project fields if discount category is overridden.
- Handles "VA" (special order) item logic.
- Calls external price calculation program `VP900R`.
- Loads prices/discounts from the output structure.

#### b) `hent_prisgr` (Get Price Group)

- Calls external program `VL712R` to determine the price group for the order line.

#### c) `oppdat_hode` (Update Header)

- Recalculates the header-level totals and adjustments.
- Updates the order header record.
- Calls program `FO763R` post-update for memo balance handling.

---

### 6. Special Features/Business Logic

- **Discount Logic:** Supports several layers of discounts (`rab1`, `rab2`, `brr1`, `brr2`) and accumulates them accordingly.
- **Return Fee:** If enabled, calculates return fees based on a per-line configuration in external side table (`fod2l1`).
- **"Solve" VA Logic:** Special logic for VA goods if flagged.
- **Accumulators:** Totals for the entire order are recalculated at the line and header level.
- **Date/Time/Operator Tracking:** Applies current timestamp and user to updated records.
- **Item line skipping:** Text lines are not processed for price/discount.

---

## Summary Table

| Area                 | Purpose                                          |
|----------------------|--------------------------------------------------|
| File declarations    | Access order, item, type, and side tables        |
| Parameters           | Get input needed to identify and update the order|
| Main loop            | For each line: calculate/adjust price and totals |
| Subroutines          | Price retrieval, price group, header update      |
| Business logic       | Multi-level discounts, "VA" (make-to-order)      |
| Special Handling     | Return fee, Solve flag, skipping text lines      |
| External Programs    | CO402R, VP900R, VL712R, FO763R                   |

---

## Typical Flow Example

1. Called for order 001234:
2. Reads order header.
3. For each order line:
    - Skips text lines.
    - Looks up item, price group.
    - Calls external program to get correct price and discounts.
    - Handles special cases (SKAFFEVARER, return fees).
    - Updates line.
    - Totals to accumulators.
4. After all lines, updates header.
5. Optionally updates customer memo balance.
6. Exits.

---

## How to Onboard/Customize

- **Understand field naming:** Prefixes like `fo`, `fd`, `vv` mean header, detail, and vare/item, respectively.
- **Key lists:** Always check what keys are built in initialization; ensure any new logic uses the correct key.
- **External routines:** Much complex logic is delegated; ensure you know the input/output of called programs.
- **Business flags:** Many branches depend on configuration (return fee, Solve VA, etc.). Test these scenarios as business rules might change.
- **Accumulators:** Totals are recalculated for data integrity. Never update lines/headers separately.
- **Text lines:** Skipped!
- **Error handling:** Minimal; any failed update may cause missing data. May want to extend with better error handling in future.

---

## In Summary

This program ensures order lines and header are always consistent with current price and discount logic. It factors in complex business logic, flags, and is extensible by means of several subroutines and external programs. Onboarding a developer means understanding both RPG idioms and the specific business rules encoded here.