# RPG Program Explanation: RH651R  
**Hovedbok - revisjonsjournal - utvelgelse**  
> This program processes accounting journal entries for a revision journal selection, reading and filtering main ledger, customer, and vendor postings to produce output files for further auditing or reporting.

---

## 1. Header and Documentation
- The **header** (`H DATEDIT(*DMY) OPTION(*NODEBUGIO)`) sets date format and disables debug I/O for performance.
- **Description** comments (in Norwegian) specify:
  - The program name and purpose: revision journal selection from the general ledger.
  - A brief change log and references.
  - Indicator usage conventions (function key mapping, file indicators, etc.).

---

## 2. File Declarations
- **Disk Files** (all externally described, most with renamed record formats):
    - `rhtrl1` → general ledger main entries
    - `rktrl2` → customer ledger
    - `rltrl2` → vendor ledger
    - `rhjopf` → revision journal register
    - `rhw2pf` → output file for selected entries

---

## 3. Data Definitions
- **Uds Section**: Overlay for standard I/O buffer setup, not detailed here.
- **Work Fields**:
  - `rhpkda`, `rhprår`, `rhpper`, etc.: likely selection parameters (period/year, block, screen).
  - `l_wsid`, `l_user`, `l_firm`, `l_fnav`: environment/user info.
  - `w_firm`, `w_raar`: work fields mirroring parameters for selection.

---

## 4. Main Logic Summary

### Initialization 
- Set up from initial parameters, file keys, and work variables.
- Subroutine `*INZSR` copies initial values and builds composite keys for file access.

---

### A. General Ledger Processing (`rhtrl1`)
1. **Set starting position** in `rhtrl1` (main ledger).
2. **Loop through entries** until end of file (`*in60 = *off`).
   - **Filter out** entries already in revision journal (`rhpskr = ' '` and `rbrmrk = '1'`).
   - **Period filter:** only process records with `rbrper <= rhpper`.
   - **If valid:**  
     - Mark entry as 'H' (main ledger).
     - Write to `rhw2pf`.
     - For newly processed entries, also add corresponding journal number in `rhjopf`.
3. **Read next record and repeat**.

---

### B. Customer Ledger Processing (`rktrl2`)
1. **Set starting position** in `rktrl2`.
2. **Loop** until end of file.
   - **Filter on year and period:** `rnraar = rhprår` and `rnrper <= rhpper`.
   - **Check if journal entry already exists** in `rhjopf` (using a chain operation and indicator 61).
   - **If not present:**  
     - Build and output data for customer ledger record (set `rbstat = 'K'` and map various fields).
     - Write to `rhw2pf`.
3. **Read next customer record and repeat**.

---

### C. Vendor Ledger Processing (`rltrl2`)
1. **Set starting position** in `rltrl2`.
2. **Loop** until end of file.
   - **Filter on year and period:** `roraar = rhprår` and `rorper <= rhpper`.
   - **Check for presence** in `rhjopf` by journal number.
   - **If not present:**
     - Build and output data for vendor ledger record (set `rbstat = 'L'` and map fields).
     - Write to `rhw2pf`.
3. **Read next vendor record and repeat**.

---

### D. Program Ending
- Set LR indicator (`*INLR = *ON`) to close files and end program.

---

## 5. Subroutine: *INZSR (Initialization)
- Copies selection/program parameters to working variables.
- Initializes file positions for customer and vendor ledgers.
- Defines composite key lists for efficient disk access.

---

## 6. Indicator and Key Usage
- **Indicators:**
  - `*IN60`, `*IN61`: End of file or record found for respective file operations.
  - Others reserved for various user interface or error signalling per documentation.
- **Key Lists:**
  - Used for SETLL, READE, and CHAIN operations to efficiently fetch records by composite keys.

---

## 7. Business Logic Highlights
- **Purpose:**  
  Collate all relevant main ledger, customer, and vendor postings up to a specified period/year, excluding already processed entries, and output them for revision/audit.
- **Output:**  
  All selected entries are written to an output file (`rhw2pf`). New journal numbers are added to the revision journal register (`rhjopf`) as needed.

---

## 8. Additional Notes
- **Code is written in fixed-format ILE RPG (RPG IV).**
- **Field names** are in Norwegian and likely correspond to accounting/business terms (e.g., "hovedboksposteringer" = main ledger postings).
- **Modular Structure:** All three main sections (main ledger, customer, vendor) use a similar structure for reading, filtering, and writing records.
- **Extensive field mapping** is performed to transfer data from input records to the output format, following business rules for each type of ledger entry.

---

### Summary Table

| Section                | Source File(s) | Filter    | Output                                          |
|------------------------|---------------|-----------|-------------------------------------------------|
| General Ledger         | rhtrl1        | Period,   | rhw2pf, optionally add journal to rhjopf        |
| Customer Ledger        | rktrl2        | Year/Per  | rhw2pf if not already present in rhjopf         |
| Vendor Ledger          | rltrl2        | Year/Per  | rhw2pf if not already present in rhjopf         |

---

## Key Takeaways
- This program selects accounting transactions for auditing, ensuring only relevant and unprocessed entries are included, and updates both the output and journal register as needed.
- It is highly structured, with clear separation of main, customer, and vendor ledger processing, and leverages indicators and composite keys for efficient file handling.