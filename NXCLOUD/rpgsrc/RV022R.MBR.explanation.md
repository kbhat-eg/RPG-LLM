## Program Overview

**Program Name:** RV002R  
**System:** ASOFAK  
**Purpose:**  
This program reads invoice lines from the BOVF file and outputs them in a comma-separated (CSV) format for import into the Duett accounting system. The process involves gathering and transforming data from various master files (customers, invoices, accounts, etc.), performing business-specific lookups and formatting, and writing the result in the required output structure.

## High-Level Workflow

1. **Initialization:**  
   - Checks if the company (firma) matches the required value.
   - Clears and resets all work fields and data structures.

2. **Data Preparation:**  
   - Reads and formats dates (invoice, due, etc.).
   - Initializes fields for output, including customer and vendor information.

3. **Business Logic and Lookups:**  
   - Looks up and possibly converts voucher codes.
   - Determines department code, customer information, and vendor information based on account numbers and other references.
   - Handles special business rules (e.g., KID number conversion, name field parsing).

4. **Output Construction:**  
   - Builds a CSV line with all required fields, in the order and format expected by Duett.
   - Writes the output record.

5. **Subroutines:**  
   - `control_init`: Fetches and prepares invoice head and customer/vendor data.
   - `w_flytt`: Moves customer master data into working fields, with logic to split names if they contain commas.
   - `*inzsr`: Initializes key lists for file lookups.

## File Relationships

- **Input Files:**
  - `bovfl1`: Invoice lines (primary input).
  - `sohel1`: Invoice header (for additional information, renamed to `sohel1r`).
  - `rkunl1`: Customer master (renamed to `rkunl1r`).
  - `votyl1`: Order type master (for routine lookups).
  - `aforl1`: Routine master file.
  - `rb10l1`: Voucher code conversion table.

- **Output File:**
  - `rv02pf`: Output file for the CSV-formatted records.

## Key Business/Domain-Specific Logic

### 1. Company (Firma) Filtering
Early in processing, the program checks if the current company matches the expected one (`l_firm <> bffirm`). If not, it exits processing for that record. This ensures data is only exported for the relevant legal entity.

### 2. Date Formatting
Dates are manipulated in multiple formats to match the output requirements. There are several data structures for both invoice and due dates, split into year, month, day, etc., to allow flexible formatting.

### 3. Voucher Code Conversion
Voucher (bilags) codes may require conversion using the `rb10l1` table. If a mapping is found, the converted code is used in the output; otherwise, the original is retained.

### 4. Customer and Vendor Data Retrieval
- The program retrieves customer and vendor information based on account numbers from the invoice line.
- If the debit account (`bfdkto`) is above 9999, it is assumed to be a customer and looked up in `rkunl1`.
- If not, the credit account (`bfckto`) is checked.
- The subroutine `w_flytt` copies relevant customer data into work fields for output.

### 5. Name Field Parsing
Both customer and vendor names are checked for embedded commas. If a comma is found (and is not at the start or end), the name is split into two parts, which are then recombined with a space—this is likely to separate last and first names for systems that expect them in a particular order.

### 6. KID Number Handling
Special logic is included for KID (customer identification) numbers, including possible conversion via a call to external program `AK710R` if a certain routine code is found in the order type and routine tables.

### 7. Output Record Construction
The output CSV line is built by concatenating all required fields, taking care to:
- Enclose string fields in quotes.
- Insert zeroes or blanks where required by the Duett format.
- Insert all customer and vendor details, including extended fields such as phone, email, and address.
- Some fields are commented as "??????" indicating unclear or placeholder mappings—these may need further business clarification.

### 8. Character Translation (Commented)
There are commented-out `xlate` statements for translating special Norwegian characters (æ, ø, å) to specific code points. This suggests that character encoding issues have been considered, but the translation is currently not active.

## Notable Design Decisions and Conventions

- **Versioned Change Log:**  
  The header contains a detailed change log with version numbers and developer initials, providing traceability for business and technical changes.

- **Field and Data Structure Naming:**  
  Variable and field names closely follow Norwegian business terminology (e.g., `bilagsnr`, `kundereg`, `forfallsdato`), which is consistent with the domain and may require orientation for non-Norwegian speakers.

- **Legacy RPG Conventions:**  
  The code uses fixed-format RPG, with explicit use of `eval`, `move`, `chain`, and indicator variables (e.g., `*in90`).  
  Key lists (`klist`) are defined in the `*inzsr` subroutine for indexed file access.

- **Blanking and Zeroing Fields:**  
  Before each record is processed, all work fields are cleared to avoid data leakage between records.

- **Conditional Logic for Data Population:**  
  Many fields are conditionally populated based on business rules (e.g., which account number to use for customer lookup, whether to perform KID conversion, etc.).

- **Subroutine Organization:**  
  - `control_init`: Handles all the logic for looking up and preparing header, customer, and vendor data.
  - `w_flytt`: Handles moving customer data into work fields, including name/field parsing.
  - `*inzsr`: Initializes key lists for file lookups.

- **Error Handling:**  
  Use of indicators and `goto` for error and end-of-data handling is consistent with traditional RPG style.

## Interactions with Other Modules/APIs

- **External Program Call:**  
  If a certain routine code is found, the program calls `AK710R` to convert the KID number. This is a business-specific routine for handling customer identification numbers.

- **Master Data Files:**  
  The program is tightly coupled to master data files for customers, vendors, order types, and routines, reflecting a typical ERP environment.

## Summary Table: Key Fields in Output

| Output Field             | Source / Logic                                         |
|-------------------------|--------------------------------------------------------|
| Transaction Type        | Hardcoded as 1                                         |
| Posting Date            | System date                                            |
| Voucher Number          | From `bfbiln`                                          |
| Voucher Date            | From `w_dato_al1` (formatted)                          |
| Voucher Code            | Converted via `rb10l1` if possible                     |
| Voucher Text            | From `bftext`, quoted                                  |
| Department              | From `w_avde`                                          |
| Project Number          | From `bfproj`                                          |
| Debit Account           | From `bfdkto`                                          |
| Credit Account          | From `bfckto`                                          |
| VAT Code                | From `w_mkod` (with fallback logic)                    |
| Currency Code/Rate/Amount| Hardcoded as 0 or from `bfvalb`                       |
| Line Amount             | From `bfbelp`                                          |
| Due Date                | From `w_dato_alf` (formatted)                          |
| Customer Number         | From `w_kund`                                          |
| Customer Name           | From `w_navn` (parsed for commas)                      |
| Customer Address        | From `w_gate`, `w_adr2`                                |
| Customer Phone/Email    | From `w_tlfn`, `rkemal`                                |
| Vendor Name/Address     | From `w_lnav`, `w_ladr1`, `w_ladr2`, etc.              |
| KID Number              | From `sokidd`, possibly converted                      |
| ...                     | ... (see code for full mapping)                        |

## Recommendations for New Developers

- **Familiarize yourself with the master data file layouts** (`bovfl1`, `sohel1`, `rkunl1`, etc.), as much of the code revolves around field-level data manipulation from these files.
- **Understand the business rules for customer/vendor handling**, especially the logic for splitting names, handling KID numbers, and voucher code conversion.
- **Pay attention to field formatting and output structure**, as the target system (Duett) expects a very specific CSV format.
- **Review the change log and version comments** for context on why certain logic is present or how it has evolved.

## Points for Further Clarification

- Some fields in the output have comments like "??????"—these may require business input to ensure correct mapping.
- The commented-out character translation logic for Norwegian letters suggests potential encoding issues that may need to be addressed depending on the target system's requirements.

---

This documentation should provide experienced RPG developers with the necessary context to understand, maintain, and extend the RV002R program within the ASOFAK system.