# Program RP621R – Result Report Export to PC

## Overview

This program, `RP621R`, is a core part of the ASOKON system, responsible for generating a financial result report for export to PC. The report includes actuals, budgets, and prior year balances, grouped and summarized by departments (avdelinger) and periods, with flexible options for subtotaling. The program reads from several files, aggregates data, and writes formatted output for further processing.

---

## Main Data Files and Their Roles

- **rrf0l1** (renamed to `rrf0l1r`): Report master, contains report headings and metadata.
- **rrf5l1** (renamed to `rrf5l1r`): Report line definitions, describes each line in the report.
- **rrf9l1** (renamed to `rrf9l1r`): Report register, holds balances for each report line, department, year, and type (actual, budget, etc.).
- **ra07l1** (renamed to `ra07l1r`): Department master, used to iterate over departments in the report.
- **re02pf**: Output file for the report, written as `re02pfr`.

---

## Key Data Structures

- **sal, sa�, saf, sab**: Arrays (14 elements) holding balances for each period and totals.
    - `sal`: Current period balances.
    - `sa�`: Year-to-date balances for the current year.
    - `saf`: Year-to-date balances for the previous year.
    - `sab`: Year-to-date budget balances.
- **pfirm, pnavn, puser, ...**: Input parameters, typically passed from the calling program or job (company, user, date, year, period, department range, report code, subtotal indicator).
- **l_user, l_firm, l_navn**: Fields for logging or display purposes.
- **wa07ok**: Flag indicating if department iteration is active.

---

## Core Logic Flow

1. **Initialization (`*INZSR`)**
    - Sets up work variables, computes previous year, and fetches the report heading.
    - Writes the report heading to the output file.
    - Initializes pointers and key lists for the various files.

2. **Main Processing Loop**
    - Begins at label `les`.
    - Reads the next report line from `rrf5l1r`.
    - If EOF or outside the desired company/report range, exits (`slutt`).
    - Resets the balance arrays to zero for each new report line.
    - Determines starting department (`ragkod`), based on input or defaults.
    - Loops over departments (`ra07l1r`) within the specified range.

3. **Department Iteration**
    - For each department, fetches balances from `rrf9l1r`:
        - Actuals for the current year.
        - Budgets for the current year.
        - Actuals for the previous year.
    - Balances are accumulated into the arrays.

4. **Subtotal Handling**
    - If subtotaling (`psumm = 'J'`), aggregates across all departments.
    - Otherwise, processes each department individually.

5. **Writing Output**
    - For each report line and department (or subtotal), writes a record to `re02pfr`:
        - Includes period and year-to-date actuals, budgets, and prior year actuals.
        - Uses array elements to compute period and year-to-date totals.

6. **Loop Control**
    - Handles special report lines (type 'T'), subtotal logic, and department iteration as appropriate.
    - Returns to `les` for next report line or `avdlop` for next department.

---

## Notable Business Logic and Patterns

- **Period Handling**: Arrays are sized for 13 periods plus a total (element 14). This supports both monthly and year-to-date calculations.
- **Flexible Department Range**: By allowing both a "from" and "to" department (`pavdf`, `pavdt`), the report can be scoped to any subset of the organization.
- **Subtotal Option (`psumm`)**: The program supports two modes:
    - `'J'`: Summarize across departments.
    - `'N'`: List each department separately.
- **Dynamic Keying**: Key lists (`klist`) are defined and used for efficient indexed access to the various files.
- **Separation of Concerns**: The program separates the fetching of balances, department iteration, and output writing, making the flow easier to follow and maintain.

---

## File Interactions

- **Reads**:
    - `rrf5l1r`: Sequentially, for each report line.
    - `ra07l1r`: For each department in range.
    - `rrf9l1r`: By key, to fetch balances for each line/department/year/type combination.
    - `rrf0l1r`: Once, to fetch the report heading.

- **Writes**:
    - `re02pfr`: For each output line (report line x department or subtotal).

---

## Special Considerations and Conventions

- **Norwegian Field Names**: Many variables and comments are in Norwegian. For example, "avdeling" = department, "saldo" = balance, "fjor" = last year, "budsjett" = budget.
- **Exit Points**: Uses `goto` and labels (`slutt`, `avdlop`, `skrlin`, etc.) for flow control, which is common in legacy RPG but may be non-obvious to those used to structured programming.
- **Indicator Usage**: RPG indicators (`*IN11`, `*IN10`, `*IN99`) are used for EOF and error handling on file operations.
- **Year Handling**: Previous year is computed as `praar - 1` and used to fetch prior year balances.

---

## Summary Table of Main Variables

| Variable   | Description                              |
|------------|------------------------------------------|
| `sal`      | Period balances (actuals)                |
| `sa�`      | Year-to-date balances (actuals)          |
| `saf`      | Year-to-date balances (prior year)       |
| `sab`      | Year-to-date budget balances             |
| `pfirm`    | Company number                           |
| `pnavn`    | Company name                             |
| `puser`    | User ID                                  |
| `pdato`    | As-of date                               |
| `prapp`    | Report code                              |
| `psumm`    | Subtotal indicator ('J'/'N')             |
| `pavdf`    | Department from                          |
| `pavdt`    | Department to                            |
| `ppert`    | Period                                   |
| `praar`    | Year                                     |

---

## Integration Points

- **Upstream**: Typically called by a controlling job or menu, with parameters set for company, period, year, department range, etc.
- **Downstream**: Output (`re02pfr`) is designed for PC export, likely consumed by reporting tools or spreadsheets.

---

## Key Takeaways for New Developers

- The program is a batch-style report generator, tightly coupled to the ASOKON data model.
- Focus on understanding the department and period handling, as this is central to how the report is built.
- Modifications may require updates to key lists, array sizing, or file layouts—coordinate with data model owners before making structural changes.
- The use of indicators and gotos reflects legacy RPG style; be careful with flow control when refactoring.

---

## Common Customization Points

- **Adding new report types or line definitions**: Update `rrf5l1` and ensure corresponding logic in the program.
- **Changing department or period logic**: Adjust the relevant loops and key lists.
- **Altering output format**: Modify the `write re02pfr` logic.

---

## Further Reading

- ASOKON Data Model Documentation (for file layouts)
- RPG IV Modernization Guidelines (if considering code updates)
- Company-specific reporting requirements (for business logic context)