# RPG Program Explanation: RA513R (Budget Key Inquiry)

---

## 1. **Header and Metadata**

- **`h option(*nodebugio) datedit(*dmy)`**  
  - Program runs without debug for IO operations and uses Day/Month/Year date format.
- **Comments Section:**  
  - System: ASOKON  
  - Program: RA513R  
  - Description: Budget key inquiry (Budsjettnøkler, spørring)
  - Documented change log and indicator usage conventions.

---

## 2. **File Declarations**

- **Physical Files:**  
  - `fra13l1`, `fra13l2`: Disk files, externally described, with renamed record formats.
- **Display File:**  
  - `fra513d`: Workstation (DSPF), using a subfile `b1sfl` with relative record number `w_srrn`.

---

## 3. **Data Definitions**

### a. **Parameter Fields**  
  - `p_firm`, `p_mkod`, `p_mtxt`: Passed-in parameters representing company, key code, and description.

### b. **Key Variables**  
  - `ra13l1_mkod`, `ra13l2_mtxt`: Variables for budget key or description, used for positioning.

### c. **Working Variables**  
  - `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Subfile control (record counts, paging).
  - `w_seqe`, `b_valg_ok`: Selection and control flags.
  - `w_firm`: Company code for use in key lists.

### d. **Constants**  
  - `c_sfil`: Subfile page size (initialized to 8).

---

## 4. **Comments on Indicators and Screen Layout**

- **Indicators:**  
  - E.g., *LR* (last record), *in10* (Roll), *in12* (Sfldsp - subfile display), *in14* (Sflclr - clear), etc.
- **Working Variables (for subfiles):**  
  - e.g., `w_stel` (subfile counter), `w_sfrn` (first record on page), `w_ssrn` (last record on page), etc.

- **Screens Used:**  
  - `B1SFL`: Subfile records  
  - `B2CTL`: Control record for subfile  
  - `B2CMD`: Command key screen

---

## 5. **Main Program Logic**

### a. **Main Loop**

- **Tags and Flow Control:**  
  - `b2taga`, `b2tagb`, `avslutt`: Labels for GOTO-style branching.
- **Write Initial Command Display:**  
  - Writes the `b2cmd` record (possibly to prompt user).

#### **Display/Process Subfile**
- **Exsr dsp_subfile:**  
  - Handles initial subfile display.

- **Page/Position Calculations:**  
  - If a current record is set, calculates the first record number on the page.

#### **Function Key Handling**
- **SELECT Block:**  
  - Handles function keys (e.g., F3/F12=Exit, F5=Refresh, Roll/Rolldown, Home, etc).
  - Calls appropriate subroutines or exits based on key pressed.

#### **Positioning by Entry**
- If either `b2mkod` or `b2mtxt` (entry fields) are populated, runs the `posisjoner` subroutine to reposition the subfile view.

#### **Subfile Processing**
- Calls the `subfile` subroutine to let user select an entry. If selection was made (`b_valg_ok = *on`), exits.

#### **Main Loop Else**
- Loops back to `b2taga` for further user input.

### b. **Exit (`avslutt` tag):**  
  - Sets LR indicator (*inlr = *on*) to end the program.

---

## 6. **Subroutines**

### a. **forny** (Refresh Subfile)

- If `w_sfrn` not zero, attempts to position the display (CHAIN on subfile).
- Positions file pointer by key (`setll`), based on value of `w_seqe` (sequence).
- Clears and rebuilds subfile by calling `clr_subfile` and `crt_subfile`.

---

### b. **posisjoner** (Position to Entry)
- If budget key entered (`b2mkod`), sets up keylist and positions to record (`setll` on `ra13l1`).
- If description entered (`b2mtxt`), sets sequence, prepares keylist, and positions (`setll` on `ra13l2`).
- Clears and rebuilds subfile for new position.
- Clears positioning fields.

---

### c. **subfile** (User Select in Subfile)

- Toggles screen indicator for cursor placement (*in22).
- Sets `w_virn` (current placement) to first record on page.
- Loops through subfile records using `readc`, looking for a user selection (b1valg=1).
- If selected, captures selected key/code into parameters and sets `b_valg_ok = *on`.

---

### d. **clr_subfile** (Clear Subfile)

- Sets indicator to clear subfile, writes out the control record, and resets subfile paging counters.

---

### e. **crt_subfile** (Fill Subfile Page)

- Increments subfile page end marker (`w_spge`).
- Loops reading physical file (`ra13l1` or `ra13l2` as per sequence) and writes up to subfile page size.
- Detects end-of-file or if the record is for another company.
- Populates each subfile record with key fields and writes to display file.
- Updates first and last subfile records for paging logic.

---

### f. **bck_subfile** (Back Page in Subfile)

- If at end of subfile, positions file pointer before current page, reads back one page's worth of records in reverse (`readp`).
- Handles key positioning and repopulates the subfile by calling `clr_subfile` and `crt_subfile`.

---

### g. **dsp_subfile** (Display Subfile)

- If subfile contains records (`w_srrn <> 0`), set display indicators and present control record.
- Handles display and field protection indicators.

---

### h. **Initialization Subroutine (`*inzsr`)**

- Processes the program parameter list.
- Initializes key lists for positioning by key or description.
- Retrieves parameters and sets up initial screen (positions physical file to start, builds first page of subfile).

---

## 7. **Key Points for Onboarding**

- **This RPG program implements an interactive subfile inquiry for budget keys.**
  - It allows users to view, scroll, search, and select entries from a budget-key file.
- **Subfiles and Paging:**  
  - Uses a page-at-a-time subfile (8 rows per page by default).
  - Handles forward and backward paging, as well as search by key or description.
- **Indicator Usage:**  
  - Leverages indicators for subfile operations, control record display, and function key processing.
- **File Handling:**  
  - Data is pulled from two logical files (`ra13l1`, `ra13l2`) depending on search mode.
- **Code Style:**  
  - Heavy use of C-specs, subroutines, and branching via tags/goto for flow control.
- **Customization:**  
  - Easy to adjust page size via constant (`c_sfil`).
  - Extendable for new function keys or extra selection criteria.

---

## 8. **Summary Table: Main Components**

| Section           | Purpose                                              |
|-------------------|------------------------------------------------------|
| Parameters        | Receives company, key, and description from caller   |
| Display File      | Presents subfile and control screens                 |
| Subfile Logic     | Handles display, search, scroll, and select          |
| Navigation        | Supports forward/backward paging and search          |
| Record Selection  | Lets user mark/select a record, passed to caller     |
| Initialization    | Sets up key lists, positions, and initial display    |

---

## 9. **Useful Points for New Developers**

- **Start reading from `*inzsr` (initialization) to see data flow.**
- **Understand how indicators are set/reset during screen writes.**
- **Review `crt_subfile` and `clr_subfile` for subfile mechanics.**
- **The subfile logic is standard for interactive 5250-style RPG applications.**
- **All navigation, search, and select logic is contained in the subroutines.**

---

If you want to change the display format, function key assignments, or add filters, modify the corresponding subroutine and screen layouts.

---

**In summary,** this is a classic, well-structured RPG subfile inquiry program for budget keys, using best practices for paging, searching, and record selection in the IBM i environment.