# RPG Program Explanation: BU925R

This program, **BU925R**, is an ILE RPG program designed for a retail/shop environment on IBM i (AS/400). Its purpose is to fetch the calculated price and discounts for a specified product, customer, and unit, returning these values to the caller. Below you'll find an onboarding guide to understanding its important structures and logic.

---

## 1. **Header & Metadata**
The `h` spec sets program options:
- `option(*nodebugio)`: Disables debug I/O operations for performance.
- `datedit(*dmy)`: Sets the default date format to day-month-year.

The comments document revision history and purpose:
- Program retrieves prices and discounts for a shop system, with enhancements over time, such as extended parameter lists and logic for special assortments.

---

## 2. **File Declarations**
- **rkunl1** (Customer master), **vvarl1** (Item master), **vvenl1** (Item/unit master) are input files (`if`) with external descriptions. They are renamed for code-level record format clarity, e.g., `rkunpfr` as `rkunl1r`.

---

## 3. **Key Fields and Parameters**
- Key fields for file access (e.g., `rkunl1_kund`, `vvarl1_vare`) are defined to match DB keys.
- **Parameters** (`p_` prefix) such as `p_firm`, `p_kund`, `p_vare`, etc., are used for data passed in/out (firm, customer, item, unit, etc.).
- **Output parameters**: Sales price, discounts, cost price, etc.

---

## 4. **Data Structures**

### Input Structure (`hirec`)
- Used for communication with a called program (`VP900R`).
- Overlay fields for each parameter (e.g., `hifirm`, `hikund`, `hivare`), allowing the structure to be populated via assignments.

### Output Structure (`horec`)
- Receives output from the called program.
- Contains calculated price, discount, cost, etc.

---

## 5. **Variables**
- Work variables such as `w_firm`, `w_prgr` (price group), `w_avde` (department), for intermediate calculations and to hold values between steps.

---

## 6. **Main Logic**

### 6.1 Validation

#### Check if the Item Exists
```rpg
eval      vvarl1_vare = p_vare
chain     vvarl1_key vvarl1
if        not %found
  eval    p_stat = 1
  goto    avslutt
endif
```
- If the item doesn't exist, set error status and exit.

#### Check if Item/Unit Combination Exists
```rpg
eval      vvenl1_vare = p_vare
eval      vvenl1_enhe = p_enhe
chain     vvenl1_key vvenl1
if        not %found
  eval    p_stat = 2
  goto    avslutt
endif
```
- If the item/unit combo doesn't exist, set a different error code and exit.

#### Get Customer Discount Category
- Lookup customer; if not found, default the discount category.

### 6.2 Populate Input Structure
- Assigns all input values (firm, customer, item, etc.) into `hirec` (for program call).

### 6.3 Call Pricing Program
```rpg
call 'VP900R'
parm hirec
parm horec
```
- Calls external program `VP900R` to determine pricing and discounts.

### 6.4 Retrieve Output Values
- Fields from `horec` are mapped to output parameters (`p_kpri`, `p_sapr`, `p_kopr`, `p_rab1`, etc.).

### 6.5 Calculate Net Price
- Sequentially applies up to four discounts (two ordinary, two "bruksrettsrabatt" - usage rights discounts):
```rpg
w_raba = (w_sapr - w_sumr) * p_rab1/100
w_sumr = w_sumr + w_raba
```
- The net price is the sales price minus all discounts.

---

## 7. **Program Initialization - *INZSR Subroutine**

### Parameter List
- The entry parameter list specifies all incoming and outgoing fields, matching external callers' requirements.

### Key Lists
- Key lists for file access (`rkunl1_key`, `vvarl1_key`, `vvenl1_key`) are defined for DB lookups.

### Initializations and Lookups
- Internal fields are set from parameters.
- Calls auxiliary programs:
  - **VL712R**: Retrieves price group.
  - **BL710R**: Retrieves item type and supplier info.

### Date Validation
- If the price date is invalid, set it to the current date.

---

## 8. **Error Control**
- The status field `p_stat` is used to indicate error conditions to the caller (e.g., item not found, item/unit not found).

---

## 9. **Exit & Clean-up**
- *INLR is set on (last record indicator) to signal program end and release resources.

---

## 10. **Summary of Flow**
1. **Initialize:** Set up all keys, variables, get price group and item type.
2. **Validate Input:** Check item and item/unit existence.
3. **Get Discount Category:** Lookup customer for discount info.
4. **Call Pricing Engine:** Send/receive all info via DS.
5. **Apply Discounts:** Compute net price after discounts.
6. **Return Results:** Send price/discount values and error status back to caller.

---

## 11. **Typical Usage**
- This program is likely called from an order-entry or price-inquiry process, feeding in the firm, customer, product, unit, etc., and returning price and discount info for display or further processing.

---

## 12. **Customization**
- The program is set up for easy enhancement, e.g., additional discounts, changing external pricing logic, or new items/units.

---

**In summary:**  
BU925R is a robust RPG program that encapsulates the business rules for determining product pricing and discounts in a retail environment, leveraging external programs and DB lookups, and returning results in a structured, modular fashion. It's designed for maintainability with clear input validation, error handling, and modular data exchange.