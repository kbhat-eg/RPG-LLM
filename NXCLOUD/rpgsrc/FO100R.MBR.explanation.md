# RPG Program FO100R – Overview and Explanation

## 1. **Purpose**

This ILE RPG program, named FO100R, is central in handling registration, inquiry, and maintenance of *tilbud* (quotes) and *ordre* (sales orders) within a Norwegian ERP or order processing system. It works with the order header (ORDRE-HODE), order lines, customer registers, customer projects, and has extensive business rules and validations.

The code is annotated with revisions and historical notes, demonstrating an old codebase with frequent adjustments for evolving business processes.

---

## 2. **File Declarations (`F-spec`)**

- **Physical and Logical Files**: The program uses indexed disk files (marked `if` for input, `uf` for update) for customer, order, order lines, project, and dictionaries (code registers).
- **DDS Display Files**: One display file (`fo100d`) for the user interface.
- **Renames**: Most logical file names are "renamed" for local descriptive naming.
- **Arrays**: Example: `a_mld1` - Used for storing multiline messages, like validation errors.

---

## 3. **Data and Variable Declarations (`D-spec`)**

- **Local Data Area / User Space**: The program accesses and parses workspace, user, company code, and system identifiers from the IBM i local data area.
- **Key Variables**: For every file read, a key variable is declared for indexed access.
- **Work Variables**: Many `w_`, `s_` prefixed variables – for working storage and "save" values (snapshotting data for validation, comparison, or re-use).
- **Parameter Area**: Variables prefixed `p_` are used for program entry parameters and inter-program communication.
- **Flags and Constants**: Many 1-byte variables track "ON"/"OFF" or specific conditions (`b_feil`, `b_lety`, etc.).
- **Translation Constants**: For converting between upper/lowercase Norwegian alphabets.

---

## 4. **Main Program Flow**

### a. **Entry Point / Initialization**

- The program receives entry parameters indicating the requested function (`p_valg`), order number, and suffix.
- It loads company/user info, status codes, and other environment settings.
- It initializes (zeros/blanks) work variables and sets up environment switches (e.g., via calls to `CO402R` for company/configuration options).
- Reads default values for order type, binding, etc., from configuration and registers.

### b. **Order Registration/Change Selection**

- If started in "change" mode (`p_valg=2`), it loads the specified order number and suffix, and jumps to the appropriate order handling logic.

### c. **Screen Handling and Main Loop**

- Main interaction happens in a tagged loop (`b1tag`), displaying screens and handling function keys.
- Conditionals check which operation or function key is chosen (F3=Exit, F4=Inquiry, F6=Add Customer, F7=Add Project, etc.).
- Some F-keys trigger calls to separate programs for advanced functionality (e.g., order text maintenance, customer inquiry).

### d. **Input and Validation**

- Before proceeding with order creation/update, a large validation section (`sjekk_input`) performs:
  - Code lookups (order info, order type)
  - Business logic checks (user permissions, customer/project interlocks, credit, required fields, etc.)
  - Date validations (order, delivery, follow-up, expiration dates etc.)
  - Conditional validation per company configuration (field requirements drawn from company rules).
  - Any validation error triggers messages/screens and loops back.

### e. **Order Number Assignment (for new orders)**

- New orders get their order number and suffix assigned by checking and updating a number register, with logic to ensure uniqueness and correct sequencing.

### f. **Order/Customer/Project Data Processing**

- The program reads and writes order header data, customer and project data, updating records as required.
- Customer and project data is loaded based on which customer number is present (delivery or invoice customer), and customer projects are handled with their own logic.
- Customer and project-specific info may override standard order data.

### g. **Order/Line Update and Transaction Handling**

- When an order goes through, the order header is updated/inserted.
- When a change in delivery method, department, or warehouse is detected, all related order lines may be updated to stay consistent.
- Calls out to various external RPG programs for registering order lines, recalculating prices, updating credit/memo balances, and other business process integrations.

### h. **Special Functionality**

- **Project/Activity validation**: Enforces requirements for customer projects when dictated by configuration.
- **Credit/Credit Limit Handling**: Checks if customer is blocked for credit or has exceeded allowed limits, with overriding possibilities for special users or order types.
- **Logging**: Records changes and actions for audit/tracking (e.g., logging quote creation, date changes).
- **NOBB Freight**: Handles freight calculation logic for a specific Norwegian standard (`NOBB`).
- **External Integration**: Integration with external systems (e.g., for transport planning), enabled by configuration switches.

---

## 5. **Subroutines and Modularization**

- Subroutines are coded using RPG's `begsr/endsr` structure and include:
  - Input validation (`sjekk_input`)
  - Data loading (customer, project, order)
  - Order finalization and clean-up (`merke_ordre`)
  - Inquiry handlers (calls to subprograms for lookups/selection)
  - Specialized routines for handling logistics changes, order copying, and synchronization across files and master data.
  - Screen routines for specific popups and information windows.

---

## 6. **Configuration and Customization**

- Heavy use of switches toggled by per-company configuration data (via `CO402R`).
- Field requirements and various business rules are driven by database tables, not hardcoded, to allow flexible business logic that can be changed without program modification.
- Supports per-firm, per-user, and per-process customizations, tracked by many small flags.

---

## 7. **Revision Control**

- The RPG source is annotated with a detailed change history, including dates, developer initials, and explanations, which provides invaluable context for both support and audit.

---

## 8. **Common Patterns**

- **File Access**: Use of CHAIN (find by key), SETLL/READE (position and read), and direct UPDATE/WRITE for record maintenance.
- **Parameter Passing**: Extensive calls to external RPG programs, passing a plethora of variables for advanced business logic (validation, updates, calculations).
- **Condition Handling**: Branching on F-keys (`*INKx`), input indicators, flags for errors and status.
- **Data Correction and Uppercasing**: Cleanse and enforce uppercase on string fields for standardization.

---

## 9. **User Interface**

- Interaction is via IBM i (AS/400) display files, using EXFMT/EXFWin operations for formatted screen handling.
- Multiple pop-up windows and info screens provide context, errors, and inquiry capabilities to users.

---

## 10. **Special Business Logic and Norwegian Localizations**

- **Credit Rules**: Designed for Norwegian business context (memo, extended credit, etc.).
- **NOBB**: Handles Norwegian building product codes and freight logic.
- **1881 Integration**: Connects with an external "1881" customer search service.
- **Field-length Expansion**: Has evolved to accommodate larger customer/project numbers, longer text fields etc.

---

## 11. **Best Practices & Pitfalls**

- **Highly Modular/Configurable**: The program is complex due to high modularity and configuration-driven logic for different firms/users/scenarios.
- **Old-style RPG Syntax**: Uses fixed-format C/EXEC and C-spec code; newer developers may find the syntax less intuitive than free-form RPG IV.
- **Frequent External Calls**: Business rules are often split between this program and external service-programs. Understanding FO100R alone is only half the challenge—one must know (or be able to find documentation for) all called programs.

---

## 12. **Summary Table**

| Area                      | Description |
|---------------------------|-------------|
| **Files Accessed**        | Customer, Order (header/lines), Status, Project, Code/Info Registers, Configuration files |
| **Screen Routine**        | Display file for entry/maintenance, pop-up windows for errors/info/inquiry |
| **Validation**            | Extensive, config-driven, field-level and cross-field |
| **External Integrations** | Price calculation, logging, transport, customer search (1881) |
| **Order Processing**      | New order number assignment, header/line maintenance, credit & block checking, warehouse/department alignment |
| **Customization**         | Per-company, per-user, per-scenario switches driven by external config/tables |
| **Special Support**       | NOBB, Mestergruppen credit, customer/project overrides, history/copying of orders |

---

## 13. **Onboarding Notes for Developers**

- **Get to know the business**: Understand Norwegian order/quote processes, credit rules, and project models.
- **Study key data models**: ORDRE-HODE, KUNDE-REGISTER, PROJECT, INFO-KODE etc.
- **Map out called programs**: Much of the logic is in external programs called from FO100R.
- **Pay attention to configuration-driven logic**: Many validations and field requirements come from database-driven switches.
- **Be very careful with file updates**: The program updates many critical files—understand the impact of your changes thoroughly.
- **Use the in-code documentation**: The developers have provided extensive historical commentary and inline explanations. Leverage these notes for reasoning about changes.
- **Test in all business scenarios**: Because business rules change by company, user, and even order type, thorough testing under all configurations is essential.

---

This program is a cornerstone in a Norwegian ERP/order management system. While it is complex and "old-school" in RPG style, it is robust, heavily documented, and highly adaptable to the business's needs. New developers should take time to familiarize themselves with both the code and the business logic it supports.