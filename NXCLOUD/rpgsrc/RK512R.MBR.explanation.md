# Overview

This RPG (Report Program Generator) source code, for program `RK512R`, is a classic IBM i (AS/400, iSeries) green-screen inquiry application for customer ledger postings ("kundeposteringer, spørring" in Norwegian). It provides various functionalities for users to view, analyze, and perform operations on customer transactions, including:

- Viewing open/all postings and balances,
- Navigating (paging, positioning) through subfiles of postings,
- Viewing detailed document information (voucher, invoice, etc.),
- Viewing statistics and aging,
- Accessing related notes (notatark) on customer or posting,
- Integrating with archive and external modules.

The code is written in "traditional" (fixed-format) ILE RPG, with enhancements ("T", "E", "pdf", etc. tags) showing version-specific changes.

Below is a pedagogical breakdown of main sections and logic, providing context and onboarding for new developers.

---

## 1. File/Display Declarations

### Database Files

- **frktrl9, frktrl8, frktrl2, frkunl1, frkmel1, frktrlu, frklal2, frklal3, fraa1l1, fraa3l1**
  - These are referenced as physical or logical files, some with record format renaming (e.g. `rename(rktrpfr:rktrl9r)`).
  - They hold customer transaction records, customer master, memo balances, notes, etc.
  - `prefix(xn:2)` is used to distinguish field names when reading `frktrl8`.

### Display Files

- **frk512d**: Main display file
  - Uses a subfile (SFL) for listing records: `sfile(b1sfl:w_srrn)`
  - INFDS (`dspfbk`) provides feedback for cursor position, function keys, etc.

---

## 2. Data Structure and Variable Declarations

- **Local Data Area (LDA)**: For user/session data (`l_user`, `l_firm`, etc.).
- **Display Feedback DS**: For managing screen feedback like cursor position, etc.
- **Key Variables**: Used for file access (`rktrl9_kund`, `rktrl8_kund`, etc.).
- **Working Variables**: For subfile control, selection flags, work fields (`w_srrn`, `w_valg_ok`, `w_firm`, `w_biln` etc.).
- **Parameter Structures**: Used to interface with external programs (like archives, note programs, etc.).

---

## 3. Constants

- **c_sfil**: Constant for subfile page size (default 13 rows per page).

---

## 4. Program Documentation

- **Change Log**: At the top, sections like `T5.00`, `T5.40`, etc., document program modifications, feature additions, and bug fixes.
- **Indicator Usage**: Specifies how numbered indicators (`*INnn`) are used—for end-of-program, roll, error messages, etc.

---

## 5. Main Program Flow

### A. Initial Screen Display/Handling (b2taga/b2tagb tags)
- The program starts by displaying the command screen (`write b2cmd`).
- Checks for the presence of customer-level notes (using `frklal2`) and sets indicator for display if present.
- Calls `dsp_subfile` to display the subfile window.

### B. Function Key Handling (select block)
- Handles various function keys (`*INxx`):

  - **F2** (`*INKB`): Open Customer/Post note (calls `notat` subroutine).
  - **F3/F12** (`*INKC`/`*INKL`): Exit program.
  - **F5** (`*INKE`): Refresh (calls `forny`).
  - **F10** (`*IN10`): Next page (calls `crt_subfile`).
  - **F21** (`*IN21`): Home-key (repositions).
  - **F6/F7, etc.**: Toggle between open/all/accumulated postings.

### C. Subfile Record Processing (`subfile` subroutine)
- Reads visible records from SFL, checks for selection (by user), processes actions:
  - **Select (1)**: Returns selected document's key.
  - **View Post (5)**: Calls window to display detailed transaction.
  - **View Matching Entry (6)**: Calls RK513R for matched post.
  - **View Voucher (7)**: Calls RF512R for voucher details.
  - **View Invoice (8)**: Calls RK110C for invoice document.
  - **View Archive (9)**: Calls AP622C (or alternate) to display scanned documents, after access check.

### D. Subfile Management

- **clr_subfile**: Clears/initializes subfile buffer and control variables.
- **crt_subfile**: Populates the subfile with records, conditioned on selection (open, all, accumulated, or currency), updates subfile control variables.

### E. Display Subfile (`dsp_subfile`)
- Manages the actual display of the subfile on the screen depending on subfile state.

---

## 6. Detail Windows and Statistics

### A. View Posting (`xc2win`)
- Shows a pop-up window with full transaction detail.
- Loads transaction data, populates window fields, looks up related codes (department, seller), shows note indicator if note present.
- Handles function keys for exit and notepad display.

### B. Statistics/Aging Analysis (`xe2win`)
- Calculates totals, counts, aging buckets, and memo balances.
- Splits balances into relevant aging intervals.
- Shows totals for unpaid, overdue, written off, in-collection, etc.
- Calls RS205R for VAT calculation if necessary.

---

## 7. External Interfaces

- **Notepad (notat subroutine)**: Calls `RF020R` with required customer/posting keys to display or update a notepad (notatark).
- **Archive (AP622C/AH720C)**: For scanned document retrieval.
- **Other Programs**: RK513R, RF512R, RK110C, RS707R, RS709R, RS205R for related document and code lookups.

---

## 8. Program Initialization (*inzsr)

- Accepts input parameters (selection, customer number, document number, residual amount).
- Sets up all relevant keys for database access.
- Retrieves customer master and memo data.
- Loads configuration such as aging intervals (default to 30/60/90 if missing).
- Positions file cursors and loads initial subfile page.

---

## 9. Indicators and UI Logic

- **Indicators (`*INxx`)**: Classic RPG UI and logic flags, representing field protection, error, selection, color attributes, etc.
- Examples:
  - `*IN14`/`*IN15`: Subfile clear/end detection.
  - `*IN70`, `*IN71`, `*IN72`, `*IN73`: Color indicators for statuses (collection, complaint, notes).
  - `*IN12`, `*IN13`: Display flags for subfile window.

---

## 10. Subfile and Key Explanation

- **Subfile Variables**: 
  - `w_srrn`, `w_ssrn`, `w_sfrn` help manage which records are on which pages, relative record numbers, etc.
  - `w_valg`: Indicates selection (open/all/accumulated).

- **Keylists (`klist`)**: Group variables for keyed file access (you'll see them in chain/read/setll operations).

---

## 11. General Notes

- **Version Handling**: The labels like `T5.40`, `E5.40`, `6.20` indicate maintenance and enhancement resulting in new branches or features.
- **Norwegian Comments**: Much of the code documentation and variable naming is in Norwegian, but field names tend to follow conventions like `kund` (customer), `bilag` (voucher), `saldo` (balance), `rest` (residual), and so on.

---

# Summary

**What does this program do?**

It is a rich green-screen interactive inquiry for customer transaction postings. It allows accountants or customer service users to:

- See and navigate lists of all or open postings for a customer,
- Drill down to transaction/voucher/invoice details,
- Analyze aging/balance/statistics,
- Access attached electronic documents,
- View and maintain related notes at customer or transaction level.

**How does it work?**

- Uses subfiles for listing transactions, with paging and selection logic.
- Integrates with numerous external and internal files and programs.
- Extensively uses indicators for UI state and attribute management.
- Is modular, with clear separation between display logic, database access, and external interface calls.

**What to know as a maintainer/developer?**

- Gain overview of how subfiles, indicators, and keylists operate in RPG.
- Pay special attention to external program interfaces and data structures.
- Watch out for "versioned" code—some features are conditionally included by labels.
- Understand Norwegian terms for field labels and comments, as the business logic is documented in that language.

**Next steps for onboarding:**

- Review the display file (`FRK512D` DSPF) for field mapping.
- Familiarize yourself with the logical files (`FRKTRL9`, etc.) and record layouts.
- Map out the major integration points with external programs.
- Read up on classic RPG subfile and indicator logic if new to the environment.

---

_Note: This summary omits many low-level technical details, focusing on architectural and functional understanding. For deeper work, study the code sections in context of the display file and database record formats._