# Explanation of the RPG Source Code

This program, named **lh715r**, is part of the ASLOGI (presumably logistics) system and is responsible for processing order proposals ("Bestillingsforslag") by splitting detail lines (order lines) by supplier. The program updates existing order headers and creates new ones if detail lines have multiple suppliers, reassigns order lines to the appropriate header, and maintains proper status and sum fields.

## 1. **File Declarations**
The files are all externally described database files, used for reading (`I`), updating (`U`), and writing records (`A`). They are all renamed in the program for clarity and management:

```rpg
flfhel1    if   e           k disk    rename(lfhepfr:lfhel1r)
flfdtl5    uf   e           k disk    rename(lfdtpfr:lfdtl5r)
flfdtpf    uf a e           k disk    rename(lfdtpfr:lfdtpfr)
flfhelu    uf   e           k disk    rename(lfhepfr:lfhelur)
flfhepf    uf a e           k disk    rename(lfhepfr:lfhepfr)
flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
```
Here, `if` is input full procedural, `uf` is update full procedural, `a` allows add, `e` is externally described, and `k` means the file is keyed.

## 2. **Data Definitions**

### Parameters & Local Data Area

- `p_numm` - Input parameter, order proposal number, used throughout as the "current order header".
- `l_user`, `l_firm` - Local data area variables for user and company.

### Key Variables and Working Storage
For identifying/processing records and storing temporary results:
- Key variables (example: `lfdtlx_vlev`, `lfhelx_numm`).
- Arrays and basic work variables (`ar` for suppliers, `i` as an index, quantities, sums, etc.).
- Variables for file fields when updating or writing records.

## 3. **Program Flow – Main Logic**

### Initialization and Read/Process Detail Lines

1. **Find all Suppliers for the Details**
   - Reads details (`lfdtl5`) for the current heading number.
   - Collects unique supplier numbers into the `ar` array.

2. **Update the First Supplier's Header**
   - For the first supplier, retrieves and updates the existing order header (`lfhelu`), possibly with audit/user information.

3. **Create New Heading for Additional Suppliers**
   - For each subsequent supplier found:
     - Calls a subroutine to get a new header number (`hntnum`).
     - Adds a new order header (`lfhel1`).
     - Assigns all matching order detail lines to the new header, updating fields like date, user, etc.
     - Deletes the order detail line from its old location once moved.

4. **Update Sums and Status**
   - Calls an external program (`LH714R`) to calculate and return the sum and status for each new/existing heading.
   - Updates the relevant header file with the calculated sum, weight, and status.

5. **Update the First Heading's Sum and Status**
   - Similarly, recalculates and updates sums/status for the first (original) heading.

## 4. **Subroutines**

### **hntnum**
Handles getting a new heading/order number from a number register, via a call to the external program 'AS100R'.

### **les_ldor**
Fetches supplier information (likely the supplier name or code) based on the supplier number; this is used for populating or updating the header with relevant supplier info.

### **\*INZSR (Initialization)**
Initializes all the key-lists for navigation across files, sets local storage fields, and pulls in the parameter (order number) and company from the local data area. Also chains (looks up) the status master line.

## 5. **Key Lists**
All file keys (for lookup, update, etc.) are defined as `klist` blocks, supporting keyed access throughout the program.

## 6. **Entry Point**
The program expects a single incoming parameter: the current order heading/proposal number (`p_numm`). Sets up the primary work variables before processing.

---

# **Summary of Business Logic**

- **Input:** Order proposal number (heading).
- **Process:**
  1. Read all related order detail lines.
  2. Detect if there are lines with different original suppliers.
  3. For each unique supplier (apart from the first):
      - Create a new header ("heading") for that supplier.
      - Move detail lines for that supplier to the new heading.
      - Create header and update audit fields.
      - Recalculate and update sum & status fields for the new heading.
  4. For the original heading:
      - Remove detail lines that have moved.
      - Recalculate and update sum & status fields.
- **Output:** Updated/created order headings and order lines, now correctly grouped by supplier, with recalculated sums and status.

---

# **Key Takeaways for New Developers**

- **Purpose:** This program splits one order proposal into multiple proposals if there are order details for multiple suppliers, ensuring all order lines in each proposal belong to a single supplier.
- **File Handling:** The code manipulates multiple files—reads, updates, adds, and deletes records, always using keyed access.
- **Audit Trail:** Updates audit fields (`user`, `date`, `time`) whenever headers or details are changed.
- **External Calls:** Relies on external programs for getting new numbers and for calculating the proposal sums and statuses.
- **Code Structure:** Heavy use of subroutines (`begsr` ... `endsr`), classic cycle-control (`dou`, `if`, etc.), and data movement (`eval`, `movel`).

---

# **Tips For Working With This Program**

- **Understand the file relationships:** Headers and details are linked by order numbers and suppliers.
- **Be careful with key definitions:** All data access is keyed; misuse can lead to data integrity problems.
- **Note the subroutine calling conventions:** Classic RPG; watch for variable scope and side effects.
- **Audit requirements are embedded:** Changing how audit fields are handled requires updates throughout.
- **Testing:** Ensure extensive tests when changing supplier splitting logic, as errors could misassign detail lines, corrupting order flow.

---

This program is a typical example of classic batch RPG logic for business process automation in purchasing or inventory management systems.