# Explanation of RPG Program RA519R ("Kontoklasser, sp√∏rring")

This RPG/400 (ILE RPG) program is a terminal-driven inquiry utility for "Kontoklasser" (account classes). It allows users to search, browse, and select account classes using a subfile-based display, supporting various navigation and filtering functions.

Below, you'll find a structured explanation of the code, its organization, and functionality.

---

## Program Overview

- **Purpose:** To let users inquire and select account classes (`Kontoklasser`) through a subfile (paging) interface.
- **Main Features:**
  - Subfile display for account data.
  - Paging (forward/backward).
  - Filtering/positioning based on account class code or description.
  - User selection and return of chosen values.
- **File Access:**
  - Two files: `RA19L1` (accessed as `ra19l1r`) and `RA19L2` (`ra19l2r`).
  - Workstation file: `RA519D`, display file with subfile (`b1sfl`) support.
- **Parameters:**
  - `p_firm` (company), `p_skod` (class code), `p_stxt` (description text).

---

## Declarations

- ### Files:
  - **RA19L1/RA19L2:** Input files holding account class data, different access paths (code vs. description).
  - **RA519D:** Workstation file, with subfile `b1sfl` controlled by record number `w_srrn`.

- ### Data/Variables:
  - **Parameters:** Passed-in company, class code, and class description.
  - **Work Variables:** Subfile counters, page size, current/first/last record numbers, selection status, etc.
  - **Constants:** `c_sfil` (subfile page size, set to 8).
  - **Indicators:** Standard RPG indicators are documented for UI control (paging, error, etc.).

---

## Main Workflow

### 1. **Program Initialization (`*inzsr`):**
   - Receives parameters.
   - Initializes keys and sets initial database position.
   - Populates the subfile for the first time.
   - Enables cursor positioning.

### 2. **Main Control Loop (`b2taga`/`b2tagb` labels):**
   - Sends the command screen (`b2cmd`), then enters the main processing section.
   - Handles user input, paging, selection, and filtering in a loop.
   - Reacts to special function keys (roll up, roll down, home, etc.) and selection fields.

### 3. **Key Functions/Subroutines:**
   - **`dsp_subfile`:** Handles display and user interaction with the subfile.
   - **`crt_subfile`:** Fills the subfile with data for the current page.
   - **`clr_subfile`:** Clears the subfile.
   - **`bck_subfile`:** Handles backward paging (roll down).
   - **`forny`:** Rebuilds the subfile based on the current database position.
   - **`posisjoner`:** Filters/positions to a specified class code or description.
   - **`subfile`:** Handles subfile selection and sets the return values.

### 4. **Termination:**
   - When user requests to exit (function key), indicator LR is set to end the program.

---

## Main Control Flow Breakdown

### Initialization (`*inzsr`)
- Receives parameters, sets up keys for database access.
- Initializes variables and cursor positioning.
- Positions to first record and loads the initial page of the subfile.

### Main Loop (`b2taga`/`b2tagb`)
- Alternates between writing screens and showing subfile.
- Handles function keys:
  - **Exit:** (`*INKC` or `*INKL`) - End program.
  - **Refresh:** (`*INKE`) - Rebuild subfile.
  - **Roll Up/Page Forward:** (`*IN10`) - Advance to next subfile page.
  - **Roll Down/Page Back:** (`*IN11`) - Back to previous subfile page.
  - **Home/Cursor:** (`*IN21`/`*IN22`) - Handle cursor repositioning.
- Handles user search/positioning requests.
- Processes subfile records for selection.

### Subfile Management
- **`clr_subfile`:** Clears the entire subfile, resetting counters and flags.
- **`crt_subfile`:** Fills the subfile with up to `c_sfil` records (default: 8), starting from current position.
- **`bck_subfile`:** Moves back one page in the file and refreshes the subfile display.
- **`dsp_subfile`:** Manages subfile formatting and display, toggling indicators based on whether data is present.
- **`subfile`:** Loops through subfile records, checks for selection (`b1valg`), and returns the chosen values.

---

## Key Data Structures

- **Subfile Variables:**
  - `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Used to manage subfile paging and record numbers.
  - `b1valg`, `b1skod`, `b1stxt`: User selection and display fields.

- **Database Keys:**
  - `ra19l1_key`: Composite key (firm, class code) for positioning by code.
  - `ra19l2_key`: Composite key (firm, description text) for positioning by description.

---

## Navigation and Selection

- **Positioning:**
  - By class code (`b2skod`) or description (`b2stxt`), user can jump directly to matching records.

- **Paging:**
  - Next/Previous page handled via subfile page size (`c_sfil`).

- **Selection:**
  - User marks a record in the subfile, which sets output parameters and ends the loop.

---

## Code Comments and Documentation

- Extensive comments at the top explain indicator usage and variable purpose, especially for subfile logic.
- Subroutines are well-separated for clarity.
- Some Norwegian terms (`beskrivelse`, `plassering`, etc.) refer to "description", "positioning", etc.

---

## Summary

- This program is a typical AS/400 inquiry utility with subfile paging.
- It manages complex inquiry and navigation logic through subroutines, indicators, and a well-documented control loop.
- The clearest way to onboard is to:
  - Understand the subfile mechanics (paging, clearing, filling, selection).
  - Follow the main processing loop and function key handling.
  - Note the dual access paths (by code or description), enabling flexible searches.

---

### If you have specific questions about a subroutine or logic section, let me know!