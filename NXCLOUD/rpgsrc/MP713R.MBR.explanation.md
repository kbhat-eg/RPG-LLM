# Program MP713R Documentation

## Overview

**MP713R** is a component in the ASLAGR system responsible for generating order proposal parameters ("bestillingsforslag - parameter"). Its main function is to collect and prepare parameter data—primarily per supplier and line number—for use in downstream processes, such as order proposal generation and notification via email.

This program is typically invoked from other modules or batch jobs, passing in supplier and line identifiers, and a date value.

---

## Main Components and Logic

### File Declarations

- **mppalr**  
  - File for reading supplier-related parameter records.
  - Renamed as `mppalrr` for local use.
  - Accessed via keyed access.

### Parameters

- **p_ldor**: Supplier code (like `mpldor`)
- **p_lnum**: Line number (like `mplnum`)
- **p_ndat**: Date parameter, ISO format

### Local Data Area (LDA) Usage

- **l_user**: User ID
- **l_firm**: Firm/company code
- **l_fnav**: User name

These are extracted from the LDA for context, especially the firm code (`l_firm`), which is used as part of the key for reading supplier parameters.

### Working Variables

- Variables for date calculations, string handling, and email fields.
- `w_firm`, `w_dato`, `w_dagens`, `w_dager`, etc.
- `w_til`, `w_fra`, `w_subj`: Used for email notification, though not populated in this program (set to blank).

---

### Data Structures

#### Parameter Structure (`d_prec`)

- 256-byte structure overlayed with individual fields for passing parameters to the downstream process (`MP711C`).
- Fields include supplier/line ranges, groupings, flags, quantities, and various numeric and character fields.
- Notably, `d_ndat` (date) and `d_bgen` (generation flag) are set just before calling the next program.

---

## Processing Flow

### Initialization (`*inzsr`)

- Receives parameters via `*entry plist`: supplier, line, and date.
- Builds the key list (`mppalr_key`) for accessing the parameter file:
    - Firm code (`w_firm`), supplier (`mppalr_ldor`), and line (`mppalr_lnum`)
- Sets `w_firm` from LDA to ensure company context.

### Mainline Logic

1. **Parameter Preparation**
    - Sets local variables for supplier and line from the input parameters.

2. **File Access**
    - Attempts to `chain` (keyed read) the supplier/line record from `mppalr`.

3. **If Found:**
    - **Date Handling:**
        - If `mpthor` (number of weeks?) > 0, calculates a future date by adding `mpthor * 7` days to the current date and sets `d_tdat` accordingly.
        - Otherwise, sets `d_tdat` to zero.
    - **Parameter Mapping:**
        - Copies a range of fields from the `mppalr` record to the corresponding fields in the parameter structure (`d_prec` overlays).
        - Resets `d_numm` to zero (purpose: probably to indicate a new run).
    - **Email Preparation:**
        - Sets email fields (`w_til`, `w_fra`, `w_subj`) to blank.
        - Sets `d_bgen` to '1' (flag indicating generation).
        - Sets `d_ndat` to the character representation of the input date.
    - **Call to MP711C:**
        - Calls program `MP711C`, passing the parameter structure (`d_prec`). This likely triggers the actual order proposal generation and/or notification.

4. **If Not Found:**
    - Jumps to program end (`avslutt` tag).

### Program Termination

- Sets LR indicator to `*on` and returns.

---

## Indicators

- The program comments define indicator usage conventions, though most are not used in this particular program. Notably:
    - `LR`: End program
    - 10-15, 21-22, 30, 31-79, 80-99: Reserved for various screen and error handling indicators, suggesting this codebase is UI-aware, but this program is batch/parameter-oriented.

---

## Design/Business Considerations

- **Parameter Passing:**  
  Uses a packed data structure (`d_prec`) for passing a complex set of parameters to the downstream process. This is a common pattern in this codebase for maintaining compatibility and performance between tightly coupled RPG programs.
- **Date Calculations:**  
  Business logic around `mpthor` (possibly "number of weeks to delivery" or similar) determines how far into the future the proposal should be generated.
- **Email Integration:**  
  Email fields are present but not populated here; this suggests the actual notification logic is handled in `MP711C`, with this program only setting flags and required parameters.
- **LDA Usage:**  
  Extracts firm context from the Local Data Area, a codebase convention for multi-company support.

---

## External Dependencies

- **File:** `mppalr` (Supplier parameter file)
- **Program:** `MP711C` (Order proposal generation and/or notification)
- **LDA:** Used for firm/user context

---

## Relationships and Integration

- **Upstream:**  
  Invoked by a controlling program or batch job, passing supplier, line, and date.
- **Downstream:**  
  Passes a populated parameter structure to `MP711C`, which performs the main business function (order proposal and/or emailing).

---

## Notable Conventions and Patterns

- **Overlayed Data Structures:**  
  Used for efficient parameter passing between programs.
- **LDA for Context:**  
  Ensures all operations are company-aware.
- **Minimal Error Handling:**  
  If the parameter record is not found, the program simply exits—error handling is likely managed by the caller or by conventions elsewhere in the system.

---

## Summary

MP713R acts as a parameter preparation and handoff module in the order proposal process, gathering supplier/line-specific settings, performing date calculations, and invoking the main processing module (`MP711C`). It adheres to codebase conventions for parameter passing, company context handling, and modular design, and is designed for integration into larger batch or workflow processes.