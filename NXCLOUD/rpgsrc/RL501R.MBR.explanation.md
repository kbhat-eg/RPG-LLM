# RL501R – Supplier Inquiry Program (Leverandør, spørring)

---

## Program Overview

This ILE RPG program implements an interactive supplier inquiry ("leverandør, spørring") screen with subfile support, typical for IBM i/AS400 terminal applications. The program is highly modular with many enhancements and custom features over time – including sorting, search capabilities, filtering, controlling what information is displayed, and integration with other programs for related inquiries.

### High-Level Flow

1. **Initialization:** Sets up keys, reads the Local Data Area (LDA), gets the date, and populates the initial subfile.
2. **Main Loop:** Waits for user actions (function keys), processes subfile paging/navigation, search, filtering, and launches external programs as needed.
3. **Subfile Management:** Handles reading, clearing, and re-filling the subfile based on search, position, or navigation actions.
4. **External Integration:** Calls other programs to show account statements, summarize payments, postings, etc.

---

## File Declarations

- **frlevlr, frlevl1, frlevl2, frlevl3:** Logical files for various supplier indexes (likely by supplier number, name/alphabetic, postal code, etc.)
- **fapospf:** Postal code index.
- **frlsopf:** Supplier file.
- **frl501d:** Workstation file with subfile B1SFL.

---

## Indicators

- `*inLR`: End program.
- `*in10`/`*in11`: Subfile paging (RollUp/RollDown).
- `*in12-*in15`: Subfile display and control.
- `*in21-*in22`: Home key, cursor handling.
- `*in30`: Field protection.
- `*in31-*in79`: Error messaging/notifications.
- `*in80-*in99`: Work indicators (e.g., which info to show in the subfile).

---

## Data Definitions

- **Keys and Key Fields:** Variables to hold keys for database access and positioning.
- **Subfile Control Variables:** `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` for counting, paging, and managing subfile-relative records.
- **Navigation:** `w_seqe` determines sequence/type of logic for subfile (`S`=search, `A`=alpha, `P`=postal, blank=number).
- **Work Variables:** Supplier number, name, balance, status flags, etc.
- **MultiArchive Variables:** For integration with document archive systems.

---

## Main Control Flow

### Main Line Logic

- **Tags/Flow:** Uses RPG tags (`tag`) and `goto` for main "menu" loops.
- **Display:** Writes the subfile control and awaits user input.
- **Select Statement:** Function key handling, performing different logic based on the pressed key:
  - F3/F12: Exit program
  - F10/F11: Page up/down in the subfile
  - F21: Home-key handling
  - F4/F5/F6/F7/F8/F9/F11: Custom searches, toggling between views, launching related information
- **Search/Positioning:** If user enters search or position data, subroutines handle lookup and repopulates the subfile.
- **Subfile Handling:** Calls subroutine to process subfile records, e.g., showing detail or launching further programs.

---

## Subroutines

### forny – Refresh Subfile
- Determines where to begin reading based on current sequence (search/type/alpha/postal).
- Clears and repopulates the subfile accordingly.

### søk – Search Subfile
- Sets search mode, prepares search texts (calls AS700R to break search text into up to 5 components).
- Clears and repopulates the subfile with search results.

### posisjoner – Position Subfile
- Determines desired start location in the file (by number, alphabetic, or postal code).
- Clears and repopulates the subfile, blanking the positioning fields afterward.

### subfile – Process Subfile
- Loops through the displayed subfile records for actions like:
  - Show details (`b1valg = 5`)
  - Print account statements (`b1valg = 6`)
  - Show payment summary, postings, or archive integration as per user selection
- Handles permission checks and launches external programs for selected actions.

### xc2bld – Show Supplier Details
- Calls another program (`RL502R`) to show supplier detail screen.

### clr_subfile – Clear Subfile
- Writes the control record with option to clear and resets various subfile counters.

### crt_subfile – Populate Subfile
- Determines the number of subfile records to show.
- Based on mode (`w_seqe`), iterates and fetches records from the database or SQL cursor for search.
- Handles advanced searching of supplier names, postal codes, balance filtering, etc.
- Builds subfile screen records for display.

### bck_subfile – Page Back in Subfile
- Reads the previous page of records and repopulates the subfile accordingly.

### dsp_subfile – Display Subfile
- Formats the subfile for display, shows command window if needed.

### posteringer – Show Transactions for a Supplier
- Calls `RL512R` to display postings/transactions for the selected supplier.

### skriv – Print Account Statement
- Calls `RL643C` to print an account statement for the selected supplier.

### xv1win – Prompt for Minimum Balance
- Displays a window to enter a minimum balance value to filter suppliers (for search/filtering).

### *inzsr – Initialization Routine
- Sets up key lists, gets the current date, reads values from LDA, initializes subfile and its variables.

---

## Special/Interesting Points

- **Subfile Paging:** Handles both RPG subfile paging and jump-to-record logic.
- **Multiple Search Modes:** Number, alpha, postal code, or full-text search.
- **Flexible Info Display:** F11 cycles through multiple information views in the subfile (e.g., address, phone, company number, bank).
- **Integration:** Calls to several external programs handle detailed views, summaries, printing, and archive transactions.
- **SQL Integration:** Uses embedded SQL for text search (with Norwegian language support).
- **Archive Handling:** Has logic for invoking different archive variants (MultiArchive/BSA ASP/etc.).

---

## Summary Table of Major Function Keys

| Key         | Action                                                        |
|-------------|---------------------------------------------------------------|
| F3/F12      | Exit                                                          |
| F10/F11     | Page up/down in subfile                                       |
| F4          | Inquiry on payment proposal (calls RL516R)                    |
| F5          | Toggle between active/all suppliers                           |
| F6          | Inquiry on collective payment order (calls RL511R)            |
| F7          | Filter on suppliers with balance greater than entered value   |
| F8          | Inquiry on postings (calls RL510R)                            |
| F9          | Repeat search                                                 |
| F11         | Cycle displayed info in subfile (address, phone, etc.)        |
| Select      | Navigates to details, prints, or shows related info           |

---

## Typical User Actions

1. **View suppliers in a subfile.**
2. **Search or filter suppliers.**
3. **Select a supplier for detailed info, transactions, or printout.**
4. **Page through subfile or jump to a specific supplier (by number, alpha, postal).**
5. **Use function keys for advanced queries or to call related business logic.**

---

## Key Takeaways for Onboarding

- The heart of the program is subfile processing, search, and navigation.
- It is tightly integrated with other inquiry and printing programs.
- The program is highly configurable for viewing different types of supplier info in the subfile.
- Familiarity with subfile programming and typical IBM i file access patterns is essential.
- SQL is used only for the search function; most access is native RPG file I/O.

---

**If you need deeper details on specific subroutines, search logic, or file layouts, refer to the associated DDS, referenced programs (RL5xxR, AP622C, etc.), and physical/logical file specifications.**