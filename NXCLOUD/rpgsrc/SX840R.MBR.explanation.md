# Program Documentation: SX840R (ASSTAT System)

## Overview

**Program Name:** SX840R  
**System:** ASSTAT  
**Purpose:**  
This program updates sales statistics (`sstalu`) with general discounts from receipt line items (`bodtlq`). The main function is to process statistics records, cross-reference them with detailed receipt lines, and recalculate discount breakdowns for reporting and analytics. This is part of back-office processing for retail or POS systems.

---

## Files and Data Sources

### Physical Files

- **SSTALU**  
  - Renamed as `sstalur` in the program.
  - Holds summary/statistics data per firm, period, and item.

- **BODTLQ**  
  - Renamed as `bodtlqr` in the program.
  - Contains detailed receipt line items, including item-level discount breakdowns.

### Data Area

- **Local Data Area (LDA):**  
  - Used for user, firm, and navigation info, though only `l_firm` is referenced (and then overridden).

---

## Key Variables

- **Key Variables for SSTALU:**  
  - `w_firm`, `sstalu_paar` (period/year).

- **Key Variables for BODTLQ:**  
  - `w_firm`, `bodtlq_aarr` (year), `bodtlq_bong` (receipt), `bodtlq_vare` (item).

- **Totals and Calculations:**  
  - `w_totn`: Net total after discounts.
  - `w_tot1`, `w_tot2`: Discount breakdowns for two discount levels.

---

## Program Flow

### Initialization (`*INZSR`)

- Builds key lists for both files.
- Sets `w_firm` to a hardcoded value `200` (likely a test or default firm; previously commented code would set from LDA).
- Sets `w_aarr` to the current year.

### Main Routine

1. **Read Loop:**  
   - Iterates through all `sstalu` records for the current firm and year.
   - For each record:
     - Skips if `sfbong` (receipt number) is blank (not a POS transaction).
     - Calls subroutine `behandle` to process the record.

2. **End-of-File Handling:**  
   - Exits the loop and ends the program.

### Subroutine: `behandle`

- **Key Construction:**  
  - Builds the key for `bodtlq` (receipt line) based on the current statistics record.

- **Receipt Line Lookup:**  
  - Chains into `bodtlqr` to find the matching receipt line.
  - If not found, skips further processing.

- **Discount Check:**  
  - If both discount rates (`bdbrr1`, `bdbrr2`) are zero, skips further processing.

- **Discount Calculations:**  
  - Calculates net amount (`w_totn`) as the statistics amount (`sfsumb`) minus two discount amounts (`sfrab1`, `sfrab2`).
  - Applies the first discount (`bdbrr1`), then the second (`bdbrr2`), both as percentages of the remaining amount.
  - Updates the statistics record's discount breakdown fields (`sfbrk1`, `sfbrk2`).

- **Update:**  
  - Writes the updated statistics record back to `sstalur`.

---

## Business/Domain Logic

- **Receipt-Driven Statistics:**  
  - Only statistics records linked to a receipt (`sfbong` not blank) are processed.
  - Discount breakdowns are recalculated to reflect actual receipt line discounts, ensuring reporting accuracy.

- **Discount Handling:**  
  - Supports two-level discounts per item, a common retail scenario (e.g., campaign discount + loyalty discount).
  - Each discount is applied sequentially to the net value after the previous discount.

- **Firm/Year Segmentation:**  
  - All processing is scoped to a specific firm and year, supporting multi-company and historical/statistical reporting.

---

## Conventions and Design Notes

- **Record Locking:**  
  - `unlock` is explicitly called before skipping records, ensuring no lingering locks.

- **Hardcoding:**  
  - `w_firm` is hardcoded to `200`, which may be a placeholder or test value. In production, this should probably be parameterized or set from the LDA.

- **Field Naming:**  
  - Norwegian naming conventions are used (`bong` = receipt, `rab` = discount, etc.).
  - Historical comments and versioning are maintained in the header.

- **Error Handling:**  
  - Minimal; skips records on missing/invalid data rather than halting or reporting.

- **No Direct User Interaction:**  
  - Batch/statistical processing only.

---

## Integration Points

- **SSTALU/SSTAPFR:**  
  - Must be kept consistent with receipt line details in `bodtlq`.
  - Any changes in receipt processing logic or file layouts must be reflected here.

- **BODTLQ/BODTPFR:**  
  - The integrity of discount values (`bdbrr1`, `bdbrr2`) is critical for accurate statistics.

---

## Summary

This program is a batch updater for sales statistics, ensuring that discount breakdowns in the statistics file reflect the actual discounts applied at the receipt line level. It is firm- and year-specific, supports two discount levels, and is designed for accuracy and integrity in reporting. The program assumes that all necessary data is available and consistent between the statistics and receipt line files. Any changes to discount logic or file structures in the POS system must be coordinated with this program.