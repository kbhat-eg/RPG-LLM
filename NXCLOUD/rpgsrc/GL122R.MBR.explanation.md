# Program Documentation: GL122R – Arbeid med deklarasjonskoder

## Overview

This program, `GL122R`, is part of the ASOKON system and manages "deklarasjonskoder" (declaration codes) via a subfile-driven interactive workstation interface. It supports viewing, adding, updating, and deleting declaration codes, leveraging both subfile and window-based UI patterns. The business logic is tightly coupled to the user interface, with indicator-driven control flow and explicit management of subfile records.

## Main Components

### Files

- **GL122D (WORKSTN, SFILE D1WSF:SRRN01):**  
  The primary display file, including subfile and window records for user interaction.
- **GUDKL1 (DISK, keyed):**  
  The master file containing declaration codes. All CRUD operations target this file.

### Display Elements

- **Subfile (D1WSF):**  
  Used to display and select declaration codes.
- **Windows (A1WIN, S1WIN, D2WCT, D2CMD):**  
  Used for detailed maintenance, command keys, and control records.

### Indicators

The program uses a structured convention for indicator usage:
- KC (F3): Exit program
- KE (F5): Refresh (Forny)
- KL (F12): Cancel
- 10–16: Subfile control (e.g., roll, display, clear, end, readc)
- 30–59: Error/warning handling
- 60–69: File operations (e.g., CHAIN success/failure)
- 70–99: Work indicators for routines and standard subroutines

## Data Structures

- **Subfile Management Fields:**  
  `SRRNnn`, `SPGEnn`, `SFRNnn`, `SSRNnn`, `SVRNnn` are used for subfile record and page control.
- **Window Positioning:**  
  `w_arow` and `w_acol` specify the window's location.
- **Working Fields:**  
  Various fields (`w_endr`, `w_rdec`, etc.) control state across screens and routines.

## Program Flow

### Initialization (`*INZSR`)

- Sets up subfile and window positioning fields.
- Initializes key lists for file access.
- Fills the subfile with initial data from `GUDKL1`.

### Main Loop

The main logic is structured as a loop using tags (`b2taga`, `b2tagb`) and GOTO statements (classic RPG style), alternating between command processing and subfile display/interaction.

#### Command Handling

- **F3 (Exit):** Branches to program end.
- **F5 (Refresh):** Clears and reloads the subfile.
- **Roll (Page up/down):** Rebuilds the subfile display.
- **Positioning:** Allows the user to jump to a specific record.
- **Selection Validation:** Checks if a line number or value has been selected and processes accordingly.

#### File Access

- **CHAIN/SETLL:** Used to position or retrieve records in `GUDKL1`.
- **UNLOCK:** Releases records after update or inquiry.

#### CRUD Operations

- **Add/Change/Delete/Display:**  
  Based on user selection (`b2valg`), the program:
  - Validates existence or non-existence of the code.
  - Loads or initializes screen fields.
  - Invokes the appropriate window for maintenance (`xb2bld`, `xb1bld`).
  - Updates or deletes records as needed.

### Subfile Processing

- **xclr01:** Clears the subfile and resets management fields.
- **xcrt01:** Populates the subfile from `GUDKL1` up to the page size.
- **xdsp01:** Displays the subfile control record, managing subfile display indicators.

### Maintenance Windows

- **xb2bld/xb1bld:**  
  Handle the add/change/delete/display windows for declaration codes, including validation, record locking, and update/delete logic. These routines also enforce business rules, such as not allowing duplicate codes and verifying changes before saving.

## Business/Domain-Specific Logic

- **Deklarasjonskoder:**  
  These are declaration codes, likely tied to regulatory or reporting requirements. The program enforces uniqueness, validates existence before operations, and manages them via a master file (`GUDKL1`).
- **User Actions:**  
  The UI is designed for keyboard-driven navigation, with explicit handling for refresh, paging, and position-to-record operations.
- **Subfile Paging:**  
  The subfile is paged in increments (e.g., 7 records at a time), with explicit management of first/last record numbers per page.

## Design Patterns and Conventions

- **Indicator-driven Control:**  
  The program relies heavily on RPG indicators for state management, following a documented convention for indicator ranges.
- **Tag/GOTO Structure:**  
  Control flow is managed with tags and GOTO statements, typical for traditional, non-ILE RPG.
- **Explicit Subfile Management:**  
  All subfile operations (clear, fill, display) are handled in dedicated subroutines for clarity and reuse.
- **Window-based Maintenance:**  
  Detailed maintenance operations are always performed in a pop-up window, both for adding and editing records, ensuring a consistent user experience.

## Inter-module Relationships

- **GUDKL1 Master File:**  
  Central to all operations, its key structure is used throughout for positioning, retrieval, and updates.
- **Display Files:**  
  The program expects a specific set of display file records and windows, which must be kept in sync with the RPG logic.

## Notable Implementation Details

- **Locking/Unlocking:**  
  The program explicitly locks records for update and unlocks them immediately after, minimizing contention.
- **Validation and Error Handling:**  
  User input and business rules are validated at multiple points, with indicators set to signal error conditions.
- **Field Naming:**  
  Field and variable names use a consistent pattern, with suffixes indicating their role (e.g., `nn` for subfile numbers, `w_` for working fields, `b1`/`b2` for subfile/window context).

## Summary

`GL122R` is a robust, indicator-driven RPG program for managing declaration codes via a subfile-based UI. It demonstrates classic RPG design: explicit control flow, indicator conventions, and close coupling between business logic and the user interface. Understanding its indicator usage, subfile management, and window maintenance routines is key for effective maintenance and extension. The program interacts primarily with the `GUDKL1` file and expects a tightly coordinated set of display file definitions.