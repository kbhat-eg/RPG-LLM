## Program Overview

**Program Name:** LO562R  
**System:** ASLAGR  
**Description:**  
This program implements a supplier order search interface for radio terminals. It provides a subfile-based display for users to browse, select, and interact with purchase orders from a supplier. The interface is tailored for environments where users interact via workstations (terminals), employing subfiles for paginated display and selection.

---

## Key Functional Areas

### 1. File and Data Structure Relationships

- **Physical and Logical Files:**
  - `lohelk` (renamed `lohelkr`): Main order header file, keyed access.
  - `votyl1` (renamed `votyl1r`): Order type lookup, keyed access.
  - `lo562d`: Workstation display file, includes subfile (`b1sfl`) and control records.
- **Display Feedback Data Structure:**  
  - `dspfbk`: Used to capture display feedback, notably the first record number on the current page.

### 2. Program Parameters

On entry, the program receives four parameters:
- `p_firm`: Company/firm identifier.
- `p_ldor`: Supplier (leverandør) identifier.
- `p_numm`: Order number.
- `p_suff`: Order suffix.

These are used to position the display and logic to the appropriate supplier and order context.

### 3. Subfile Management

The heart of the user interface is a subfile (B1SFL), which displays a list of orders for the selected supplier. Key subfile-related fields and their purposes:
- `w_srrn`: Relative record number in subfile.
- `w_spge`: Subfile page size.
- `w_sfrn`, `w_ssrn`: First and last record numbers on the last page.
- `d_fcrn`: First record number currently displayed (from display feedback).

### 4. User Interaction Flow

#### Main Loop
- **Screen Display:**  
  - `b2ctl`: Subfile control record, main interaction screen.
  - `b2cmd`: Command key screen, for function key help or command input.
- **Function Key Handling:**
  - *F3/Exit* (`*INKC`): Ends the program.
  - *F5/Refresh* (`*INKE`): Calls `forny` to refresh subfile from the current position.
  - *Page Down* (`*IN10`): Calls `crt_subfile` to load more records into the subfile.
- **Subfile Processing:**
  - Reads user selections in the subfile. If a selection is made (`b1valg = 1`), sets `b_valg_ok` and returns the selected order number and suffix via parameters.

### 5. Subroutines

#### `forny` (Refresh Subfile)
- Optionally chains to the current subfile record using the display feedback structure.
- Repositions to the supplier in `lohelk`, clears and rebuilds the subfile.

#### `subfile` (Process Subfile)
- Iterates over displayed subfile records.
- Checks for user selection (`b1valg = 1`), and if found, stores selected order number/suffix in parameters and sets `b_valg_ok`.

#### `clr_subfile` (Clear Subfile)
- Sets indicator 14 to clear the subfile display.
- Resets all subfile-related counters.

#### `crt_subfile` (Create/Fill Subfile)
- Increments the subfile page size.
- Reads orders from `lohelk` for the supplier.
- For each order, checks with `votyl1` if the order type is valid (`vaoakk = 1`).
- Adds valid orders to the subfile, populating selection fields and order details.
- Manages subfile paging and end-of-file indicators.

#### `dsp_subfile` (Display Subfile)
- If subfile has records, sets indicator 12 to display subfile.
- Otherwise, displays the command key screen.
- Sets indicator 13 for subfile control, then calls `EXFMT` to display and accept input.

#### `*inzsr` (Initialization)
- Receives entry parameters.
- Sets up key lists for file access.
- Initializes display and subfile for the selected supplier.

---

## Business/Domain-Specific Logic

- **Supplier Order Browsing:**  
  The program is designed for users to browse orders for a specific supplier. It uses company and supplier IDs to position and filter the order list.
- **Order Type Validation:**  
  Only orders of a certain type (where `vaoakk = 1` in `votyl1`) are included in the subfile. This is a business rule to restrict display to "purchase" type orders.
- **Radio Terminal Usability:**  
  The interface and subfile paging are optimized for radio terminal use, with careful management of subfile size and cursor positioning.

---

## Design Patterns and Conventions

- **Indicator Usage:**  
  The codebase uses a well-documented set of indicators for screen and logic control (see initial comments). For example, indicators 12 and 13 control subfile and control record display, 14 is used to clear the subfile, and 15 signals end-of-file in the subfile.
- **Subfile Paging:**  
  The subfile is filled in pages (`c_sfil = 11` records at a time), with state variables tracking the current, first, and last records for smooth paging and roll operations.
- **Key Lists:**  
  Key lists (`lohelk_key`, `votyl1_key`) are used for efficient file positioning and lookup.
- **Parameter Passing:**  
  The program returns the selected order number and suffix via the input/output parameters, allowing calling programs to use the user's selection.

---

## External Relationships

- **Database Files:**  
  The program directly accesses order header and order type files, which are assumed to be maintained elsewhere in the system.
- **Display File:**  
  The program depends on the display file `LO562D`, which defines the subfile and control screens. Any changes to subfile fields or screen layouts must be coordinated with this DDS.

---

## Special Notes

- **Language/Localization:**  
  Comments and some variable names are in Norwegian. For example, "leverandør" = "supplier", "bestilling" = "order/purchase".
- **Error Handling:**  
  The program assumes that file access (CHAIN, READE) will succeed if keys are correct. There is minimal error messaging or recovery logic.
- **Extensibility:**  
  The logic is modular, with subroutines for each major function (clear, fill, display, refresh subfile), facilitating maintenance and future enhancements.

---

## Summary

This program provides a paginated, subfile-based interface for browsing and selecting supplier orders on a radio terminal. It enforces business rules for order type, manages subfile paging and selection, and integrates tightly with the underlying order and order type files. The design follows established conventions for indicator usage, subfile handling, and parameter passing within this codebase.