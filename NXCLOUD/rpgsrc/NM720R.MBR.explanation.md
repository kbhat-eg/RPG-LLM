# Program NM720R Documentation

## Overview

**System:** ASOFAK  
**Program:** NM720R  
**Purpose:**  
- Export product (item) and supplier information to the Blueridge datahub system.
    - Product data: Table `BRITST` (Blueridge "items")
    - Supplier data: Table `BRSOST` (Blueridge "sources")

**Primary Functionality:**  
- For all products of type 'L' (stocked) or 'S' (non-stocked), for each warehouse, collect and transform relevant data and export to DB2 tables for further integration with Blueridge.
- Handles complex business logic for product status, supplier selection, price/weight/volume calculation, and deletion/expiry conditions.
- Maintains audit trail and line numbering for batch exports.

---

## Key Concepts & Business Logic

### Product and Supplier Export

- **Product Export:**  
  Each product-warehouse combination gets a record in the export table, including grouping, pricing, status, and logistics data.

- **Supplier Export:**  
  For each relevant product-warehouse combination, the supplier (or price-giver) is determined and exported with address, contact, and financial information.

### Domain-Specific Rules

- **Product Types:**  
  Only products of type 'L' (lager/stocked) or 'S' (service/non-stocked) are exported.

- **Expiry/Deletion Handling:**  
  Products with expired dates and no stock/orders are flagged for deletion in Blueridge.  
  Special handling if a product is recently switched from 'L' to 'S'.

- **Supplier Determination:**  
  Complex logic to select the correct supplier or price-giver, with several fallback rules, including overrides from special tables (`VLA2ST`).

- **Unit Conversion:**  
  Prices, weights, and volumes are normalized to consistent units, with conversion factors retrieved from unit tables.

- **NOBB Data:**  
  Some product attributes (weight/volume) are sourced from the NOBB (Norwegian building products database) if local master data is unreliable.

---

## Program Structure

### 1. Initialization

- Reads an optional member/batch identifier parameter.
- If not supplied, generates a new batch ID via a call to `AS100R` and composes the batch/member string.
- Initializes counters and local arrays for warehouse codes/names and price groups.

### 2. Warehouse Table Build

- Reads all warehouse codes and names into arrays (`t_lage`, `t_ltxt`), and fetches price group for each warehouse by calling `VL712R`.

### 3. Main Processing Loop

#### a. Product Loop

- Iterates over all products of type 'L' or 'S'.
- For each product:
    - Calls `grp_info` to fetch grouping and supplier info.

#### b. Warehouse Loop

- For each warehouse for the current product:
    - Skips PK1 warehouse (code 99) and non-L/S types.
    - Determines expiry date by comparing dates from warehouse, product, and NOBB; chooses the most recent.
    - If the product is expired and has no stock/orders/purchase, skips further processing.
    - Determines product status (active/inactive/deleted) based on expiry and stock.
    - Checks if product was recently switched from 'L' to 'S' and flags for deletion if so.
    - Calls `var_info` to fetch price, unit, weight, and volume data.
    - Calls `wrt_item` to write the product record to the export table.
    - Writes supplier record if applicable.

### 4. Program Termination

- Calls external program `VP704R` for finalization (price/inventory update).
- Sets LR indicator to end program.

---

## Subroutines

### `grp_info`

- Fetches grouping information (overgroup, main group, subgroup) for the product.
- Calls `hent_levr` to determine supplier and related info.

### `var_info`

- Calculates and normalizes price, cost, and units.
- Handles supplier override logic at warehouse level and via RDS table (`VLA2ST`).
- Calls `VP704R` for price/inventory retrieval.
- Retrieves weight and volume from NOBB tables (`JVPKL2`), with and without supplier, and falls back to local master data if needed.
- Writes supplier record to `BRSOST` if applicable.

### `wrt_item`

- Finalizes and writes the product record to the Blueridge export table (`BRITST`).
- Handles last-minute supplier overrides and resets.

### `hent_levr`

- Supplier selection logic:
    1. If main supplier is missing, use default supplier.
    2. If logistics product, lookup in logistics table and fallback as needed.
    3. If price-giver exists, lookup in price-giver table and fallback as needed.
- Calls `hent_rlev` or `hent_jlev` to fetch supplier details.

### `hent_rlev` / `hent_jlev`

- Fetch supplier details (name, address, contact, currency, country).
- For `hent_jlev`, maps country names to ISO country codes.
- Supports overrides from accounts receivable (NX reskontro).

---

## Key Data Relationships

- **Product Master (`VVARPFR`):** Central product data.
- **Warehouse Master (`VLAGPFR`):** Product/warehouse inventory data.
- **Grouping Tables (`VOGRPFR`, `VHGRPFR`, `VUGRPFR`):** Product categorization.
- **Supplier Tables (`RLEVPFR`, `JLEVPFR`):** Supplier and price-giver info.
- **Unit Tables (`VVENPFR`):** Unit conversion and descriptions.
- **NOBB Tables (`JVPKPFR`):** External product attributes (weight/volume).
- **Override Table (`VLA2ST`):** RDS-specific supplier overrides.
- **Export Tables (`BRITST`, `BRSOST`):** Output to Blueridge.

---

## Notable Design Decisions & Patterns

- **Batch/Member Handling:**  
  Each export run is identified by a unique member/batch string, ensuring traceability and idempotency.

- **In-memory Caching:**  
  Warehouse codes/names and price groups are loaded into arrays at program start to minimize I/O during main processing.

- **Supplier Resolution Pattern:**  
  Supplier is resolved via a prioritized decision tree, with multiple fallbacks and overrides, encapsulated in subroutines for clarity and maintainability.

- **Extensive Use of Subroutines:**  
  Business logic is modularized into subroutines (`grp_info`, `var_info`, `hent_levr`, etc.) to isolate responsibilities and simplify future maintenance.

- **SQL Integration:**  
  Embedded SQL is used for specific queries (e.g., checking recent status changes), leveraging DB2's capabilities within RPG.

- **Change History:**  
  Detailed change log in the source header documents business-driven changes, reflecting the evolving requirements and highlighting areas of complexity.

---

## Interactions with Other Modules

- **AS100R:**  
  Generates next batch/member number.

- **VL712R:**  
  Retrieves price group for warehouse.

- **VP704R:**  
  Retrieves pricing and inventory information for product/warehouse/unit.

- **External Tables:**  
  Reads from and writes to numerous DB2 tables, both for master data and export.

---

## Naming & Coding Conventions

- **Field/Variable Prefixes:**  
  - `w_` : Work variables (local to the program)
  - `t_` : Table/array variables (cached lookups)
  - `brs`/`bri` : Fields for Blueridge export tables
  - `s_` : Temporary storage for supplier override handling

- **Section Numbering:**  
  - Comments and code changes are marked with version numbers (e.g., `8.14`), which correspond to entries in the header change log.

- **Key Lists:**  
  - All file I/O is performed using named key lists for clarity and maintainability.

- **Field Names:**  
  - Field names closely follow Norwegian abbreviations for business terms (e.g., `vare` = item, `lager` = warehouse, `leverand√∏r` = supplier).

---

## Versioning & Change Management

- The program is extensively versioned, with each business-driven change documented in the header and marked in the code.
- Major changes include:
    - Transition to writing directly to DB2 (v8.01)
    - Supplier override logic (v8.05, v8.22)
    - Expanded export fields (various)
    - Enhanced expiry/deletion logic (v8.10, v8.12)
    - NOBB data integration (v8.19)
    - Price group expansion (v8.24)

---

## Summary

This program forms a critical part of the integration between the ASOFAK ERP system and the Blueridge datahub. It encapsulates complex business rules for product and supplier data export, ensuring data consistency, completeness, and compliance with external system requirements. Its design emphasizes modularity, traceability, and adaptability to evolving business logic.