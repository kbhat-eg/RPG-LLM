# ASOFAK: Memo Balance Update in Customer Register (`FO763R`)

## Overview

This program (`FO763R`) is part of the ASOFAK system and is responsible for updating the "memo balance" (memosaldo) for a customer in the customer register. The memo balance reflects open orders and potential liabilities, playing a crucial role in credit evaluation and customer account management.

The program is tailored for the Norwegian business context (as seen in comments and field names) and interacts with several files and an external program for parameterization.

---

## Key Functional Areas

### 1. **Initialization and Parameter Handling**

- **Input Parameters:**  
  The program expects two parameters: company/firm number (`p_fir`) and customer number (`p_kun`).
- **Initialization Subroutine:**  
  The `*inzsr` subroutine is used for program initialization, including:
  - Setting up key lists for customer and order files.
  - Defaulting company/firm fields.
  - Retrieving memo balance extension parameters using external program `CO402R`.

- **External Parameterization (`CO402R`):**  
  - Fetches number of days for memo balance calculation (`w_memodagr`).
  - Fetches percentage for extended credit limit (`w_utvgrns`).
  - These values are parsed from the result buffer `co402_verdi2` after the call.

---

### 2. **File Interactions**

- **Physical Files Used:**
  - `RKMEPF` (Customer Memo Balance Register) - as `rkmelur`
  - `FOHELC` (Order Header Register) - as `fohelcr`
  - `VOTYL1` (Order Type Register) - as `votyl1r`

- **Access Patterns:**
  - The customer memo balance is looked up and, if found, updated; otherwise, a new record is written.
  - Order headers are read sequentially for the given customer to aggregate memo balances.
  - Order type records are referenced for additional logic tied to order types.

---

### 3. **Memo Balance Calculation**

- **Resetting Memo Balances:**  
  Both `rkmems` (memo balance) and `rkmema` (memo discount) are zeroed initially.

- **Order Header Loop:**  
  For each relevant order header (`FOHELC`) for the customer:
  - Only includes orders with an order date (`foldat`) before a calculated threshold (`w_date`).
  - Looks up order type details in `VOTYL1`.
  - If the order group (`vaoogr`) is positive, applies memo balance calculation:
    - **Positive Order Types (`vaokre` â‰  '-'):**  
      Adds order totals and discounts to the memo balance.
    - **Negative Order Types (`vaokre` = '-'):**  
      Subtracts order totals and discounts (to handle returns or credits).

- **Date Handling:**  
  The threshold date for memo inclusion is computed as the current date plus the number of memo days (`w_memodagr`), which may be parameterized.

---

### 4. **Updating the Customer Memo Register**

- **If Customer Exists:**  
  - Updates the memo balance and discount fields.
  - Sets change date/time (`rkmeda`, `rkmeti`) and user (`rkmeus`).
- **If Customer Does Not Exist:**  
  - Creates a new memo record with the calculated balances.
  - Initializes all relevant date/time fields.

---

## Business/Domain-Specific Logic

- **Memo Balance Concept:**  
  The "memo-saldo" represents the sum of open orders (and associated discounts) for a customer, used for credit control.
- **Order Type Handling:**  
  Certain order types (e.g., returns/credits) are handled by subtracting their values from the memo balance.
- **Parameterization:**  
  The number of days and credit limit extension for memo balance calculation are configurable, allowing for customer- or group-specific credit policies.

---

## Notable Design Decisions and Conventions

- **File Rename Usage:**  
  Files are renamed at the F-spec level for clarity and to avoid conflicts.
- **Key Lists:**  
  Key lists (`klist`) are used for file operations, a common pattern in legacy RPG, but may be less familiar to those used to free-form RPG.
- **External Parameter Program:**  
  The use of `CO402R` to fetch business parameters decouples business rules from program logic, supporting easier configuration.
- **Date Calculation:**  
  The calculation of the memo inclusion window (`w_date`) is dynamic and based on configuration.

---

## Relationships and Integration

- **Files:**  
  - Updates `RKMEPF` (customer memo balances).
  - Reads from `FOHELC` (order headers) and `VOTYL1` (order types).
- **External Program:**  
  - Calls `CO402R` for parameter retrieval (memo days, credit extension).
- **User/Session Data:**  
  - Sets the user field (`rkmeus`) from the session/user context (`l_user`).

---

## Versioning and Change History

- The program is actively maintained, with clear versioning and change logs in the comments.
- Recent changes include:
  - Parameterization of memo days and credit extension.
  - Adjusted logic for negative order types.
  - Addition of new change date fields.

---

## Summary

This program is a core component for managing customer credit exposure by maintaining an up-to-date memo balance based on open orders. Its logic is tightly coupled to Norwegian business practices, with parameter-driven flexibility for memo calculation. The code demonstrates a blend of classic RPG patterns (KLISTs, F-spec renaming) and modern practices (external parameterization), and it interacts with both master data files and configuration services. Understanding the business context around "memo-saldo" and how orders are classified is essential for effective maintenance and further development.