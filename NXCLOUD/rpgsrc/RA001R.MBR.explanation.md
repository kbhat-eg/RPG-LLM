# RPG Program Explanation: Maintenance of Status Codes (RA001R)

This RPG (Report Program Generator) source code is for an IBM i (AS/400) system, specifically program **RA001R**, used for the maintenance (vedlikehold) of status codes 1 and 3. Below is an organized walkthrough of the code structure, highlighting its logic, key structures, and business rules.

---

## 1. **Program Metadata and Comments**

- **Program**: RA001R
- **Purpose**: Maintenance of status codes 1 and 3
- **System**: ASOKON
- **Indicators**: Used extensively, assignment based on function (e.g., F1/F3 keys, file indicators, error signaling).
- **Change Log**: At the top, a comment block tracks version, date, description, and signer for each change.

---

## 2. **File Declarations**

```rpg
fraa1l1    if   e           k disk    rename(raa1pfr:raa1l1r)
fraa1lu    uf a e           k disk    rename(raa1pfr:raa1lur)
fraa3l1    if   e           k disk    rename(raa3pfr:raa3l1r)
fraa3lu    uf a e           k disk    rename(raa3pfr:raa3lur)
fra001d    cf   e             workstn
```
- **raa1l1, raa1lu**: Physical and logical file members for status code 1.
- **raa3l1, raa3lu**: Same for status code 3.
- **fra001d**: Workstation file (screen/display).
- **`rename`**: Used to map external record formats to internal program names.

---

## 3. **Data and Working Variables**

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
d w_stat          s              1
d w_firm          s                   like(ra1fir)
```

- **l_user/l_firm/l_fnav**: Fields likely mapped to User Data Section (UDS), storing user ID, firm number, and firm name.
- **w_stat, w_firm**: Working storage for status and firm number.

---

## 4. **Main Program Flow**

### a. **Initialization**

- **INIT Subroutine** (`*INZSR`):
  - Moves firm number from `l_firm` to working variables.
  - Sets up key lists (`KLIST`) for chains into status code 1 and 3 files.

### b. **Load & Display Data (Screen Handling)**

- **Retrieve Status Code 1** (`chain keya1 raa1l1`):
  - If record not found (`*IN60 = *ON`): set some default values.
  - If found: move values from the database record into screen fields.

- **Retrieve Status Code 3** (`chain keya3 raa3l1`):
  - If not found: set default ('N') for a field (a23bør).
  - If found: move multiple period fields and status to screen fields.

- **Show Screen**:
  - `EXFMT a2bld`: Display maintenance screen for editing values.

- **Exit Handling**:
  - If F3/exit (`*INKC` or `*INKL`): jump to exit (`xslutt`).

---

### c. **Business Logic/Validation**

After screen entry, several business rules are validated. On error, a screen indicator (`*IN31` to `*IN49`) is set and control returns to the display:

- **Upper limit for main/customer account**: `a21hrs <= a21hkt`
- **Number of periods**: `a21ape` (accepted values 1..13)
- **Period block - period**: `a21per > a21ape`
- **Period block - year**: If period entered, year must be >= 1980
- **Divergent fiscal year (avvikende regnskapsår)**: 
  - If `a23stp` > 0, then all period fields (a23p01..a23p13) must be nonzero and not exceed the number of periods.

**For each check**: If invalid, set *IN3x, GOTO `a2taga` (re-display).

---

### d. **Update Database (Write-back)**

If validation passes:

- **Update Status Code 1**:
  - Retrieve (`chain`) from update file (`raa1lu`).
  - Move values from screen to database fields.
  - Set current date/time.
  - If record exists, `UPDATE`; else, `WRITE`.

- **Update Status Code 3**:
  - Same logic as above, for status code 3 files.

---

### e. **Program Termination**

- **Exit Tag (`xslutt`)**:
  - Sets LR indicator (`*INLR = *ON`) to end the program and return.

---

## 5. **Special Notes on Indicators**

- **30**: Protect fields in display mode.
- **31-59**: Warnings/error indicators for screen logic.
- **60-69**: File-related indicators (e.g., chain found/not found).
- **70-99**: Working indicators and subroutine/utility logic.

---

## 6. **Summary**

This program:
- Loads status code configuration data for a given firm.
- Displays the data in an entry/update screen.
- Validates user input according to strict business rules.
- Updates or inserts records in related files.
- Provides clear exit, error, and field protection logic via indicators.

**New Developers Should:**
- Understand RPG fixed-format syntax and indicator-based logic.
- Review database file layouts (`raa1pfr`, `raa3pfr`) and display file (`fra001d`).
- Familiarize themselves with the screen format (`A2BLD`).
- Use the change log and comments to understand historical changes and business context.
- When troubleshooting, follow the logic flow from initial chain operations, through screen edits and validation, to file updates, always considering indicator settings.

---

**Tip:** Modernize gradually by using free-format RPG, service programs, and structured error handling for long-term maintainability!