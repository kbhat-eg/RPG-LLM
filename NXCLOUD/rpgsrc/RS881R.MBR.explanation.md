## Overview

This RPG (Report Program Generator) program is used on IBM i (AS/400) systems and is designed to validate if a subproject (underprosjekt) for a given project is valid. The program checks whether a project and its subproject exist, whether it is finished (closed), fetches associated text descriptions, and returns a result code indicating the validity.

Letâ€™s explain each section from top to bottom.

---

### **Header and Documentation**

The program is titled "Kontroll av gyldig prosjekt" ("Validation of valid project"). The comments outline:

- The use of indicator variables 60-61 for file/result codes.
- Return codes:
  - `N` = Project does not exist in register
  - `S` = Project is closed

---

### **File Definitions**

```rpg
frp2ul1    if   e           k disk    rename(rp2upfr:rp2ul1r)
frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
```
- Two physical files are being used:
  - `rp2ul1`: Project subfile (subproject/underprosjekt register).
  - `rp1pl1`: Main project register.
- Each file is referenced with a renamed record format.

---

### **Data and Work Fields**

#### **Data Definitions**

```rpg
d txt             s             30    dim(2) ctdata perrcd(1)
```
- `txt` is an array of 2x30 chars, loaded from compile-time data (likely error messages).

```rpg
d p_firm          s                   like(rp2frm)
d p_pros          s                   like(rp2pro)
d p_pupr          s                   like(rp2upr)
d p_retk          s              1
d p_txt1          s                   like(rp2txt)
d p_txt3          s                   like(rp2txt)
d p_txt2          s                   like(rp2tx2)
```
- `p_*` fields are parameters for input/output to the program (firm, project, subproject, return code, and messages).

```rpg
d w_firm          s                   like(rp2frm)
d rp1pl1_pros     s                   like(rp1pro)
d rp2ul1_pros     s                   like(rp2pro)
d rp2ul1_pupr     s                   like(rp2upr)
```
- Work variables for keys.

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- UDS (User Data Section) fields, providing user and firm info from the program status/data area.

---

### **Parameter List**

```rpg
c     *entry        plist
c                   parm                    p_retk
c                   parm                    p_pros
c                   parm                    p_pupr
c                   parm                    p_txt1
c                   parm                    p_txt2
c                   parm                    p_txt3
```
- Sets up the entry parameters for the program (for example, called from another program or via command).

---

### **Initialization and Clearing Fields**

```rpg
c                   eval      w_firm = l_firm
c                   eval      p_retk = *blank
c                   eval      p_txt1 = *blank
c                   eval      p_txt2 = *blank
c                   eval      p_txt3 = *blank
```
- The work firm (`w_firm`) is set from the user data section. Output parameters are cleared to blank.

---

### **Project/Subproject Validation Logic**

#### **Prepare Key for `rp2ul1`**

```rpg
c                   eval      rp2ul1_pros = p_pros
c                   eval      rp2ul1_pupr = p_pupr
c     rp2ul1_key    chain     rp2ul1r                            60
```
- Loads subproject key parts from parameters and tries to read (`chain`) the subproject record.
- Indicator 60 is set if the record does **not** exist.

#### **Check if Project without Specific Subproject Exists**

```rpg
c                   if        *in60 = *on
c     rp2ul1_key    chain     rp2ul1r                            60
c                   endif
```
- Tries another chain, possibly a repeated check, for error resilience or alternate key lookup (though may be redundant).

#### **Check if Project without Account Exists**

```rpg
c                   if        *in60 = *on
c     rp2ul1_key    chain     rp2ul1                             60
c                   endif
```
- Tries to chain with record format (rp2ul1) instead of (rp2ul1r) if previous attempts failed (when *in60 = *on).

---

#### **Fetch Main Project Text**

```rpg
c                   eval      rp1pl1_pros = rp2pro
c     rp1pl1_key    chain     rp1pl1                             61
c                   if        *in61 = *off
c                   eval      p_txt3 = rp1txt
c                   else
c                   eval      p_txt3 = *blanks
c                   endif
```
- Gets the main project code from the subproject record.
- If found, returns the project description in `p_txt3`.

---

#### **If Subproject Key Without Project Fails**

```rpg
c                   if        *in60 = *on
c                   eval      rp2ul1_pros = *blank
c     rp2ul1_key    chain     rp2ul1                             60
c                   move      txt(1)        p_txt1
c                   endif
```
- If project/subproject was not found, tries key with blank project part (just subproject), and sets error text if still not found.

---

#### **If Still Not Found: Set Return Code `N` and Return Error**

```rpg
c                   if        *in60 = *on
c                   move      'N'           p_retk
c                   move      txt(1)        p_txt1
c                   goto      slutt
c                   endif
```
- If all lookups failed, sets return code (`p_retk`) to `'N'` and returns the error message text.

---

#### **Check if Project is Closed (Commented Out)**

```rpg
c**                 if        rp1sts <> *loval
c**                 move      'S'           p_retk
c**                 endif
```
- Was intended to set return code `S` if project status shows "closed" (field and logic commented out).

---

#### **Return Project Texts**

```rpg
c                   move      rp2txt        p_txt1
c                   move      rp2tx2        p_txt2
```
- Sets output parameters with text fields from the found subproject record.

---

### **End of Main Routine**

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- Labels end of program. Turns on last record indicator (`*inlr`) to close files, then returns.

---

### **Initialization Subroutine**

```rpg
c     *inzsr        begsr
...
c     rp2ul1_key    klist
c                   kfld                    w_firm
c                   kfld                    rp2ul1_pros
c                   kfld                    rp2ul1_pupr

c     rp1pl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rp1pl1_pros
c                   endsr
```
- Defines key lists for chaining into the subproject and project files.

---

### **Compile-Time Data**

At the end, compile-time data includes error messages:

```
**
UNDERPROSJEKT ER UGYLDIG
PROSJEKTET ER AVSLUTTET
```
- These are likely loaded into the `txt` array for error messaging.

---

## **Summary Table**

| Parameter   | Usage                           |
|-------------|---------------------------------|
| p_retk      | Return code ('N', 'S', blank)   |
| p_pros      | Project number                  |
| p_pupr      | Subproject number               |
| p_txt1      | Message text 1                  |
| p_txt2      | Message text 2                  |
| p_txt3      | Main project description text   |

---

## **How the Program is Used**

- Called with project and subproject.
- Checks validity via subproject and project files.
- Returns code and messages indicating:
  - Project/subproject is valid (returns associated text).
  - Project/subproject does **not** exist (`p_retk = 'N'`).
  - Project is closed (`p_retk = 'S'`, but this is currently commented out).
- Text parameters point to description or error message.

---

## **Typical Use Cases**

- Called from another program for UI or batch job validation of a subproject.
- Returns error codes/messages for the user interface or error logging.

---

## **Key RPG Concepts Demonstrated**

- File operations (`CHAIN`) using key lists.
- Use of indicators for I/O result tracking.
- Parameter passing for subroutine-like program calls.
- User data section usage for session context (firm, user).
- Simple error handling and messaging.
- Compile-time data usage for static messages.

---

### **In Summary**

This program modularly checks if a requested project/subproject combination exists and is active, returning appropriate messages and codes to the calling program or interface, supporting robust transaction validation in project/accounting scenarios.