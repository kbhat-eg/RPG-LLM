# ASOFAK Supplier Item Register Loader (FW716R)

## Overview

This program (`FW716R`) is part of the ASOFAK system and is responsible for generating and populating the supplier item register. Its main function is to read item master data from an input file and write relevant details into the supplier item register file, performing necessary data transformations and enrichment along the way. The program also adds audit/tracking information as of version 6.10.

---

## File Definitions

- **Input Files:**
  - `FLVWPF`: Input item master file, keyed access. The main source of item data.
  - `FENKL1`: Unit conversion lookup file, keyed access, renamed as `FENKL1R`. Used to potentially translate or enrich the item's base unit.

- **Output File:**
  - `FLVAPF`: Supplier item register file, output/add mode.

---

## Data Structures

### Local Data Area (LDA)

- `l_user` (positions 911â€“920): Used to capture the user for audit/tracking purposes.

### Input Data Structure (`d_inpu`)

A single buffer (`d_inpu`, 417 bytes) overlays the input record and is further subdivided into fields representing various item attributes, such as item number, description, group codes, weight, volume, pricing, status, and so on. The overlays correspond to fixed positions in the input record, reflecting a flat-file input structure.

Each field is annotated with its business meaning (e.g., `d_vare` = Item number, `d_vtxt` = Item description, etc.).

---

## Parameters

- `p_firm` (3,0): Company/firm identifier.
- `p_ldor` (6,0): Likely a date or batch identifier for processing context.

---

## Key Variables

- `fenkl1_enhf`: Used as a key field for unit conversion lookup in `FENKL1`.

---

## Main Processing Logic

1. **Program Initialization**
   - Entry parameters are received (`p_firm`, `p_ldor`).
   - The company identifier is stored in `w_firm`.
   - The key list (`fenkl1_key`) is prepared for unit conversion lookups.

2. **Main Loop**
   - Reads records from `FLVWPF` (input file).
   - For each record:
     - The entire input record is loaded into the data structure `d_inpu`.
     - Fields are extracted and mapped to the output record fields.
     - Descriptions are split and trimmed for storage.
     - Some fields are set to constants or default values as per business rules (e.g., `fwekod = *blank`, `fwhkod = 1`).
     - Pricing fields are calculated by multiplying unit prices by conversion factors (`d_omrp`).
     - EAN number is moved directly.
     - A lookup is performed in `FENKL1` to potentially override the unit of measure (`fwenhe`) if a conversion exists.
     - If a valid "from date" (`d_fdat`) is present, it is converted and stored.
     - If the pack quantity (`d_anta`) is not 0 or 1 and the unit is not 'PAK', it is set in the output.
     - Tracking/audit fields (`fwodat`, `fwotim`, `fwousr`, `fwedat`, `fwetim`, `fweusr`) are populated with current time and user info.
     - The output record is written to `FLVAPF`.
   - Loop continues until all input records are processed.

3. **Program End**
   - Sets on last record indicator and returns.

---

## Audit/Tracking Enhancements (Version 6.10)

- The program now writes additional tracking information to the output record:
  - Creation and update timestamps (`fwodat`, `fwotim`, `fwedat`, `fwetim`)
  - User IDs (`fwousr`, `fweusr`), sourced from the LDA (`l_user`)

---

## Notable Business/Domain-Specific Logic

- **Unit Conversion:**  
  Before writing out the unit of measure, the program attempts to look up a possible conversion in the `FENKL1` file. If a match is found, the converted unit (`feenht`) is used in place of the original.

- **Date Handling:**  
  The "valid from" date (`d_fdat`) is conditionally converted and stored if present.

- **Pack Quantity:**  
  The logic for setting the pack quantity (`fwbmen`) ensures that it is only set for non-trivial, non-'PAK' units.

- **Description Handling:**  
  The item text is split into two fields (`fwtek1`, `fwtek2`) for storage, using substring and trim operations to ensure field size limits and cleanliness.

---

## Design Patterns and Conventions

- **Overlay Data Structures:**  
  The use of overlays on a single buffer (`d_inpu`) reflects a fixed-format, high-throughput batch processing style, typical for legacy integration.

- **Key Lists for Chains:**  
  The use of named key lists (`fenkl1_key`) is a standard approach for keyed file access, but note that the key includes both the firm and the unit code, ensuring firm-specific unit conversions.

- **Audit Fields:**  
  The inclusion of tracking fields at write-time ensures traceability of both creation and update events, in line with modern data governance practices.

---

## External Dependencies and Interactions

- **Files:**
  - Reads from `FLVWPF` (item master).
  - Optionally looks up `FENKL1` (unit conversion).
  - Writes to `FLVAPF` (supplier item register).

- **No external APIs or service calls** are present; all logic is local and file-based.

---

## Summary

This program is a classic RPG batch loader, designed for high-throughput transformation of item master data into a supplier-specific item register. It incorporates key business logic for unit conversion, price calculation, and audit tracking, and is designed to be adaptable via parameterization (firm, batch/date). The code is structured for maintainability and extensibility, with clear separation of concerns and use of RPG idioms appropriate for the domain and era.