# Overview

This RPG source code is for an IBM i (AS/400) system, written in ILE RPG (RPG IV/free-format with some fixed-format C-specs). The program's purpose is to process invoice data for a system called **ASOFAK** and generate a temporary flat file in EDI format (Electronic Data Interchange) that serves as input used for generating autofakt-faktura (automated invoices).

## General Structure

- **File Declarations**: Defines the input/output and database files used.
- **Data Structures**: Holds intermediate and EDI message data.
- **Variables**: Working variables, flags, keys, parameters.
- **Mainline Logic**: The execution logic for processing invoices and writing EDI records.
- **Subroutines**: Handling initialization, data writing, sectioning logic, and helper routines.

---

## 1. **File Definitions**

Located at the start (fixed-form `F`) lines. These specify all the database files (`disk`), output (`printer`), and a local data area (`UDS`).

- Example:  
  ```rpg
  frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
  ```
  This opens the customer master file and accesses it with record format `rkunl1r`.

- **`fnaxpf`** is the output EDI file (renamed), and **`fo184p`** is a printer file.

---

## 2. **Data Area and Data Structures**

### Local Data Area

```rpg
d                uds
d l_wsid                901    910
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
This defines fields mapped into the local data area (LDA): workstation id, user, firm, and firm name.

### EDI Message Data Structures

A large part of the code defines various data structures matching EDI sections. For example, **ED00** to **ED27** each have a dedicated DS (data structure):

```rpg
d                 ds
d f_ed00                        80
d  f_id00                        4    overlay(f_ed00)
d  f_decs00                      1    overlay(f_ed00:5)
d  f_send00                     13    overlay(f_ed00:6)
d  f_mott00                     13    overlay(f_ed00:19)
d  f_gdat00                      6    overlay(f_ed00:32)
...
```

- `ED00` is the file start section.
- `ED01` is the message header.
- `ED13` is an invoice line (item), etc.

Fields are overlaid for efficient memory use and to allow easy formatting when creating the output record.

---

## 3. **Variables**

There are lots of temporary and working storage variables defined, including for running totals, keys, flags, and intermediate calculations.

### Key Variables

Example:
```rpg
d sohel1_aarr     s                   like(soaarr)
d rkunl1_kund     s                   like(rkkund)
```
Hold key fields for reading from files.

### Working Variables

Quantities, amounts, flags, etc., e.g.:
```rpg
d w_firm          s                   like(rkfirm)
d w_raba          s              5  2
d w_tnto          s             13  2
d b_init          s              1    inz(*off)
```

---

## 4. **Constants and Parameters**

- `c_digits`: A string of all digits, used for validation.
- `p_*`: Variables used for parameters to/from the program (e.g., invoice year, type, file name, etc.)

---

## 5. **Main Program Flow**

### a. Initialization

- Reads firm (company) data.
- Reads "OFK" info (possibly invoice configuration).
- Reads status codes, type info for the invoice.
- Sets up keys for invoice header, line, customer, etc.

### b. Invoice Processing Loop

Iterates through the invoice log, for each invoice found:

- Finds all corresponding invoice headers for the period/type/customer.
- For each invoice header, iterates over all invoice lines for that header.
- For each invoice line:
  - Initializes EDI structures as needed.
  - Calls subroutines to fill and write EDI records for header, lines, and totals.

### c. Writing EDI Output

Each EDI "section" is filled and written to the output file using the `write_outp` subroutine.

---

## 6. **Subroutines**

### a. **skriv_init**

Initializes EDI header (ED00) for the file with sender, receiver, date, time, etc.

### b. **gen_faktura**

Processes and writes all header-related EDI records (`ED01`-`ED12`), such as:

- Invoice message header.
- Date info.
- Buyer/seller info.
- References (e.g., buyer order number, project number).
- VAT and totals.
- Contact persons.

### c. **init_fakth/init_faktl/init_fakts**

Clears data structures for header, line, and total sections before filling them.

### d. **skriv_vlin**

Fills and writes all EDI line records for the invoice (item-level info): product IDs, quantities, item text, prices, discounts, VAT for line, and references.

### e. **skriv_fslut**

Fills and writes all EDI total and summary records at the end of each invoice.

### f. **write_outp**

Writes a prepared 80-character EDI record to the output file (with possible character translations for special characters).

### g. **save_fsum**

Caches header totals for later reporting.

### h. **sjk_uf_log / upd_uf_log**

Checks and updates the outgoing invoice log.

### i. **sjk_saml**

Checks whether the invoice is part of a collective invoice (samlefaktura).

### j. **skr_rapph / skr_rappl / xovrfl**

Handles optional reporting (to printer), including writing headers and checking for page overflow.

---

## 7. **Parameter Handling**

At program entry (`*entry` plist), receives parameters for:

- Invoice year, type, range (number), reporting option, etc.

Also, checks and initializes the input values, prepares keys for file access.

---

## 8. **Notes and Comments**

- Comments are a mix of Norwegian and English.
- Norwegian business terms are used (e.g., "fakturabeh.", "best.nr.", "kunde", "vare", "prosjektnr").
- The code adheres to typical RPG/400 conventions, using overlays, packed decimals, and efficient memory constructs.

---

## 9. **Key Flow Summary**

1. **Initialization:**  
   Read configuration, set up parameters and keys.

2. **Invoice Loop:**  
   For each invoice in the period/type/customer, process:
   - Header: Write EDI header sections.
   - Invoice Lines: For each line, write EDI line records.
   - Totals: Write EDI summary.

   Each section is built in a data structure (80 bytes), then output to the flat file.

3. **Reporting (Optional):**  
   If asked, also writes summary to a report/printer output.

---

## 10. **Business Process in Context**

- Reads company, customer, and invoice data from DB2/400 files.
- Looks up values such as VAT, product info, etc., possibly calling external programs (for example, EAN number fetch).
- Outputs a ready-to-import EDI file containing all necessary invoice data for downstream automated invoice generation.

---

### **Summary Table**

| Section         | Purpose                                                    |
|-----------------|-----------------------------------------------------------|
| File Decls      | Input/output using DB2/400 files and EDI flat file        |
| Data Structures | Mapped to EDI segments for quick field access             |
| Main Logic      | Loops through invoices and lines, handles each in order   |
| Subroutines     | Modular logic for each EDI section and utilities          |
| Output          | Flat file in EDI format, optionally a print report        |

---

# **In Short**

This RPG application automates the conversion of invoice data into a standardized EDI file format, reading from multiple DB2/400 files, building records for each invoice and its lines, and handling all the necessary business logic for references, VAT, buyer/seller info, etc. The result is an 80-byte-per-record flat file that can be further processed by invoice automation systems.

---

If you need further explanation of a specific subroutine, variable, or program flow, please specify which part!