# RPG Program MB103R: Updating Lead Time (Leveringstid)

This RPG program is designed to update the lead time for items (varer) in inventory (lager), supporting various selection criteria such as item number, supplier, or groupings (ogrp, hgrp, ugrp). The program logic is modular, using subroutines for data reading, validation, updating, and reporting.

---

## 1. **Program Header and Documentation**
- Title and description explain that the program updates lead time.
- Detailed maintenance history with versions and notes.
- Indicator conventions are explained:
  - `KC`: Exit (F3)
  - `LR`: End program
  - `30`: Field protection
  - `31-59`: Warnings/errors
  - `70-89`: Work indicators
  - `90-99`: File indicators

---

## 2. **File Definitions**

```rpg
fvvarl8    if   e           k disk    rename(vvarpfr:vvarl8r)
fvvarla    if   e           k disk    rename(vvarpfr:vvarlar)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
fmltilu    uf   e           k disk    rename(mltipfr:mltilur)
fmc103p    o    e             printer
```

- Logical and physical files for item data, grouping, warehouse, etc.
- Printer file for reporting (`mc103p`).

---

## 3. **Data Definitions**

### **Local Data Area**
```rpg
d                uds
d l_wsid                901    910
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
References standard LDA fields for session/user identification.

### **Parameter Record**
A data structure overlays the input parameter block, exposing individual parameters:
- `p_fvar`: From-item
- `p_tvar`: To-item
- `p_flag`: Warehouse
- `p_tlag`: To-warehouse
- `p_fogr`, `p_togr`: From/to group
- ... (similar for high group, user group, supplier, etc.)
- `p_dage`: Lead time to set
- `p_crdo`: Cross-docking flag

### **Working Variables**
Variables for keys, status flags (`b_ok`, `b_head`), date/time, parameter handling, etc.

---

## 4. **Main Logic Flow**

```rpg
c     a1taga        tag
c                   if        p_fvar <> 0
c                   exsr      les_vare
c                   goto      end_pgm
c                   endif
```
- Program entry: Checks which type of selection is in use (`p_fvar`, `p_fugr`, `p_fhgr`, `p_fogr`, `p_levn`).
- Calls appropriate subroutine (`les_vare`, `les_ugr`, `les_hgr`, `les_ogr`, `les_lev`) to process items according to the selection.
- End program with `*inlr = *on`.

---

## 5. **Subroutines**

### **5.1 Data Reading Subroutines**

Each subroutine (`les_vare`, `les_ugr`, `les_hgr`, `les_ogr`, `les_lev`) reads appropriate records from item files, processes each record, and (if valid) calls `upd_lager`.

- **`les_vare`**: Read by item
- **`les_ugr`**: Read by user group
- **`les_hgr`**: Read by high group
- **`les_ogr`**: Read by group
- **`les_lev`**: Read by supplier

### **5.2 Validation – `rec_ktrl`**

Validates that the current record matches criteria:
- Firm matches
- Item type is 'L' (stock item) or 'S' (service)
- Group fields match, if supplied
- Supplier matches, if supplied
- If cross-docking is required: ensure item's cross-docking flag is set

If all checks pass, sets `b_ok = *on`; otherwise, skips.

### **5.3 Update Warehouse – `upd_lager`**

- If a specific warehouse is specified (`p_flag <> 0`), updates that warehouse for the item.
- Otherwise, loops through all warehouses for the item.
- Only updates if the lead time (`vlltid`) actually changes (per version 6.22).
- Sets audit information (date, time, user) on update.
- If the item is flagged for cross-docking, also triggers a print via `skriv`.

- Updates also a parameter record in `mltilur` with current date/time.

### **5.4 Print Cross-Docking Items – `skriv`**

- If first print, writes a header (`a1hdr`).
- Prepares detail line with item number, text, ABC code, and lead time, writes to printer file (`d1det`).

### **5.5 Initialization – `*inzsr`**

- Builds key lists for files.
- Loads the input parameter data area and other session fields.
- Initializes audit fields for printout header.

---

## 6. **Key Lists**

The program defines many keyed access lists for different file lookups, parameterized by firm, item, group, warehouse, etc.

---

## 7. **Parameter Handling**

At entry (see `*inzsr`), the entire parameter record is unpacked and mapped to working variables for use throughout the program. 

---

## 8. **Auditing and Reporting**

Updates to warehouse lead time include:
- Change date (`vledat`), time (`vletim`), user (`vleusr`)
- Audit date/time/user for parameter changes (`vlfeda`, `vlfeti`, `vlfeus`)

Reporting for cross-docked items is printed with item info and new lead time.

---

## 9. **Summary Table**

| Subroutine   | Purpose                                                           |
|--------------|-------------------------------------------------------------------|
| `les_vare`   | Reads and processes a single item.                                |
| `les_ugr`    | Reads and processes items by user group.                          |
| `les_hgr`    | Reads and processes items by high group.                          |
| `les_ogr`    | Reads and processes items by group.                               |
| `les_lev`    | Reads and processes items by supplier.                            |
| `rec_ktrl`   | Validates read item against input parameters.                     |
| `upd_lager`  | Updates warehouse lead time; triggers audit and, if needed, print.|
| `skriv`      | Prints info for cross-docked items.                               |
| `*inzsr`     | Initializes keys, loads parameter and session info.               |

---

## 10. **Key Points for Onboarding**

- **Entry Selection**: The program operates based on which input parameter is supplied (item, group, etc.).
- **Processing Loop**: For each qualified item, it validates—then updates lead time in warehouse records.
- **Audit Trail**: Each change logs audit information and, for cross-docking, triggers a print.
- **Parameter Handling**: All input is via a packed parameter block, unpacked in the initialization section.
- **Indicator Usage**: Classic RPG indicators are used, as documented in the header.

---

This program is a typical batch maintenance utility in classic ILE RPG, designed for flexibility and robust auditing. The modular subroutine structure facilitates code understanding, maintainability, and onboarding for new developers.