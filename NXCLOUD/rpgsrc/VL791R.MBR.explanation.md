# RPG Program VL791R — Explanation and Walkthrough

---

## **General Overview**

This is an ILE RPG program named `VL791R` intended for updating supplier (leverandør) numbers across a series of related files in an ERP-like solution. The process is commonly referred to as "Bytting av leverandørnummer" (Changing supplier number). 

The program accepts three parameters:
- **Company/Firm** code (`p_firm`)
- **Old supplier number** (`p_gldo`)
- **New supplier number** (`p_ldor`)

It finds all records in various files/tables where the old supplier number is present and updates it to the new supplier number. Additionally, it updates standard audit fields (such as date, time, and user) wherever changes are made.

---

## **Key Sections and Flow**

### **File Declarations**

- Many logical and physical files are defined (`F-specs`), each linked to a particular database file (indicated with `disk`) and renamed for local record formats (using `rename()`).
- Files are opened for input or update (`if` = input, `uf` = update, `e` = externally described, `k` = keyed access).

---

### **Data Declarations**

- **Input Parameters (`p_firm`, `p_gldo`, `p_ldor`):** These represent the company, old supplier, and new supplier numbers.
- **Key Variables:** Used to build key structures for record lookup/update in physical files.
- **Work Variables (`w_firm`, `w_gldo`):** Used in building keys and logic.
- **Indicator Variables (e.g., `b_mppa_ny`, `b_mppa_gm`):** Boolean flags for controlling logic in certain parameter file updates and deletions.

---

### **Main Program Logic**

The main code consists of a series of nearly identical code blocks, each of which:

1. **Sets the file pointer** to the records where updates may be needed (using `setll` and `reade`).
2. **Loops through records** where the old supplier code is found.
3. **Updates the supplier number** to the new value.
4. **Updates audit fields** such as date, time, and user.
5. **Writes changes** back to the file.

#### **Per-file Processing**

- **Bestilling-hode (Order header):** Scans and updates supplier numbers in the order header file.
- **Bestilling-linje (Order lines):** Same as above, but for order line items.
- **Bestillingsforslag-linje (Order proposal lines):** More complex; may perform a keyed `chain` operation to update the correct record.
- **Leverandør distribusjonsliste (Supplier distribution list):** Updates supplier numbers here as well.
- **Bestilling-slettet (Deleted orders):** Scans deleted orders and updates supplier numbers.
- **Status:** If the supplier code matches either `laalev` or `laalnr`, it's replaced with the new one.
- **Inng.faktura-hode (Invoice header):** Same processing logic as above.
- **EDI-retur meldinger samlefil (EDI return message file):** Updates supplier as needed.
- **Bestillingsforslag (Order proposals):** Same as above.
- **Leveringstid (Delivery time):** Updates every instance of the supplier in delivery time file.
- **Matrise Prognose (Matrix forecast):** Updates supplier code.
- **Parameter pr. lev. best.forslag (Parameters per supplier for order proposal):** Handles more complex logic—see below.
- **Prognose (Forecast):** Multiple forecast-related files all updated similarly.
- **Lagerregister (Stock register):** Updates stock-related supplier information.

---

#### **Special Logic: Parameter File Handling**

There is a section with specific flags and logic for the file `mppalu` (possibly "purchase proposal parameters"):

- It checks if a parameter exists for both the new and old supplier.
- If *both* exist, it deletes the parameter record for the old supplier to avoid duplicates before updating all others.
- This is done with indicator flags and a delete-loop.

---

### **Initialization Subroutine (`*inzsr`)**

- **Accepts the three parameters** into program variables.
- **Defines key lists** for each file that will be used for chaining or keyed updates (`klist` structures).
- **Prepares work variables** for use in the update loops.

---

## **Audit Fields and User Tracking**

- The program updates the date, time, and user fields in each record whenever a change is made.
- The user is pulled from a local data area (`l_user`), a common technique for tracking who executed the change.

---

## **Indicators and Error Handling**

- The *IN90* and *IN91* indicators are used to check for EOF (end of file) and for record-found conditions after chaining.
- There is little explicit error handling; the program assumes records exist as expected.

---

## **End of Program**

- Sets `*inlr` to *on to indicate last record, closing all files and ending the program.

---

## **Summary of Purpose**

**This program is used to change a supplier number across all relevant tables in a company’s ERP system, ensuring all references are updated, including proposals, orders, status tables, forecasts, etc. It takes care to also update audit information and to handle duplicate parameter records by deleting as needed.**

---

## **Useful Onboarding Notes**

- **This is classic (fixed-format) RPG IV.**
- Variables and field names are predominantly Norwegian.
- Edits to supplier numbers are performed via batch rather than interactively.
- The program must be executed with the correct parameters (`company`, `old supplier`, `new supplier`).
- Extending the supplier number field or adding more files requires changes in both file specs and in the core logic.
- There are several version annotations and comments marking upgrades, so check which "release" or version you are working against.

---

## **Key Takeaways for Maintenance**

- If a new file or module contains supplier references, you must add the update logic here.
- Always respect audit field conventions.
- Test carefully – this updates many critical business records in one go!

---

## **References**

- IBM RPG IV Reference (for file specs, chains, indicators, etc.)
- Your organization's data dictionary (for full meaning of all field names)
- Change logs embedded in the program header for tracking historic modifications

---
