# RPG Program Explanation: LO602R

This documentation describes the RPG/400 (ILE RPG) program `LO602R`, which appears to be part of an order management system running on IBM i (AS/400). The program’s main function is to allow users to retrieve (select) and print orders from the order register (“bestillings-register”) by various selection criteria. The source is interspersed with Norwegian comments, which are translated and explained below.

## 1. **File Declarations (F-specs)**

- **LO602D** — Workstation file for display (WORKSTN), used for user interaction.
- **VOTYL1** — Input disk file for Order Type Register (`ORDRETYPE-REGISTER`), with record format renamed to `VOTYL1R`.
- **LOHELU, LOHEL1, LOHELO** — Input/output disk files for the Order Head Register (`BESTILLING-HODE-REGISTER`) and related, using different record formats.
- **LPLOLU** — Update file for the Pick Parameter Register (`UTPLUKK-PARAM-REGISTER`), renamed.

## 2. **Data Structures (D-specs/DS)**

- **TILKEY**, **LESKEY**: Multi-field keys consisting of company, order type, number, and suffix. Used for keying into files.
- **DSWSID, DSUSER**: Miscellaneous status/user information.
- **DSSFIR**: Company number.

## 3. **Mainline Logic and Control Flow**

### a. **Order Type and Selection Method Input**

- **D0TAGA / D0TAGB**: User is prompted to enter selection criteria for orders, including order type and selection method (via display file `D0BLD`).
- Checks are performed to validate that the provided order types exist in the order type register (`VOTYL1`). Error indicators are set if validation fails, and the prompt is repeated.

### b. **Special Handling for Order Types**

- **D0TAG5**: For specific accumulator codes (`VAOAKK` values 0 and 1), the user is directed to specific subroutines (`XE2WIN`, `XE3WIN`) to handle special cases for order proposals or orders.
- The selection method (`D0SVAR`) determines the next step:
    - 1: Select by range (from/to numbers) → `D1TAGA`
    - 2: Select by date → `D2TAGA`
    - 3: Select specific/random orders → `D3TAGA`
    - If not valid, repeats input (`D0TAGB`).

### c. **Selection by Order Number Range (D1 section)**

- **D1TAGA / D1TAGB**: User provides a range (`from` and `to` numbers). Validates that 'from' is not zero, and 'to' is greater than or equal to 'from' (if specified).
- Initializes the key for reading `LOHELO`.
- Loops through the file from the specified starting point, stopping when record keys exceed the 'to' value. For each record, calls subroutine `OPPORD` to process the order.

### d. **Selection by Date (D2 section)**

- **D2TAGA / D2TAGB**: Prompts for date selection. Validates date format.
- Ensures ‘to’ number is not less than ‘from’ (if specified).
- Reads `LOHELO` sequentially, filtering on order type, date range, amount limit, and order number range, calling `OPPORD` for each valid record.

### e. **Selection by Specific Orders (D3 section)**

- **D3TAGA / D3TAGB**: Prompts for explicit entry of a single order number and suffix. If valid and present in order header file, and order type matches, processes the order with `OPPORD`. Allows multiple specific orders to be handled.

### f. **End of Program**

- **XSLUTT**: Sets LR (last record indicator) and returns, ending program.

## 4. **Subroutines**

### a. **XE2WIN/XE3WIN**:  
Handles screen interactions for special order types (proposals and orders), updating working variables and writing/reading screen formats `E2BLD`/`E3BLD`.

### b. **OPPORD**:  
Processes an order line:
- Checks if the order is already being processed (field `LOKODE`).
- Verifies order type.
- Calls another program (`LO709R`) to mark the order as being handled.
- Updates processing status fields and audit information (date, time, user).
- Adds record to the pick parameter file (`LPLOLUR`) with relevant attributes from the selected order and user context.

### c. **Initialization (*INZSR)**:

- Sets up initial states and defines LIKE/rename mappings for fields and keys.
- Receives program parameters (company, etc.) and initializes related fields.

## 5. **Key-Lists (KLISTs)**

Defines composite keys for frequent file accesses, e.g., `OTYKEY` for order type file, `HEDKEY`/`HOTKEY` for order header files, and `PLOKEY` for the pick parameter file.

## 6. **Program Entry Parameters**

- Receives at least two program parameters: likely selection code and company number (`WPFTOR`, `WPFIRM`).

## 7. **Indicators**

- Classic RPG indicators (e.g., `*IN31`, `*IN32`, etc.) are used to control error display and flow.

---

## **Summary Table**

| Section            | Purpose                                              |
|--------------------|------------------------------------------------------|
| File specs (F)     | Declare interface to database and display files      |
| Data structures (DS)| Group keys and variables for easier handling         |
| Mainline           | Prompt for user selections, validate, direct flow    |
| D1 Section         | Process by order number range                        |
| D2 Section         | Process by date and additional criteria              |
| D3 Section         | Process by specific user-entered orders              |
| OPPORD Subroutine  | Update registers/flags for selected orders           |
| Initialization     | Set up environment, define LIKE fields, load params  |

---

## **Key Takeaways**

- The program is interactive and relies on display files for user input.
- Uses robust validation of input data before attempting any updates.
- Handles multiple selection modes: range, date, random/specific orders.
- Updates order status and logs processing information.
- Uses subroutines and key-lists for modularity and code clarity.
- Indicators are heavily used for control flow and error handling.

---

## **Onboarding Notes**

- Familiarity with classic (fixed-format) RPG coding, legacy AS/400 file handling, and indicator-driven logic is necessary.
- Understanding file relationships (order headers, order types, pick parameters) will speed comprehension.
- For modernization, consider replacing indicators and fixed-format code with /free RPG, modular subprocedures, and service programs.

---

This logic is typical for green-screen order management modules, providing a solid base for order tracking and picking processes.