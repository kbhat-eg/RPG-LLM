# Documentation: HR111R – Radioterminal Transaction, Order Registration

## Overview

**HR111R** is a core program in the ASLAGR system, handling the registration of orders via radio terminals (handheld barcode scanners) into the order proposal subsystem. The program manages scanned product input, subfile (list) display, editing, deletion, and the final transfer of order lines to the order proposal database.

The program is highly parameterized and tightly integrated with the inventory, product, pricing, and supplier modules. It supports advanced business logic such as handling EAN-128 barcodes, supplier-specific order units, campaign pricing, and logistics-specific product variants.

---

## Business Context

- **Purpose:** Enable efficient, accurate order capture and proposal creation from warehouse floor using radio terminals.
- **Users:** Warehouse staff, order managers.
- **Key Features:** 
    - Flexible product identification (by barcode, EAN, supplier number, etc.).
    - Validation against product master, warehouse, and supplier data.
    - Support for campaign and special pricing.
    - Subfile-based editing of order lines.
    - Integration with inventory and order proposal modules.

---

## File and Module Interactions

### Physical and Logical Files

- **hrtrl2, hrtrlr, hrtrlu**: Radio terminal transaction files (header, detail, update).
- **vvarl1, vvarl4**: Product master files (by product number, by supplier product number).
- **rlevl1**: Supplier master.
- **vvenl1, vvenl4, vvenl2, vvepl3**: Product unit and supplier-specific unit files.
- **lstsl1**: Warehouse status codes.
- **vlagl1**: Warehouse stock levels.
- **lodtlv, lohelr**: Order and order header files.
- **lfhelu, lfdtlu**: Order proposal header and detail.
- **vvlel1**: Logistics assortment (timber products).
- **votylr**: Order type master.

### Display Files

- **hr111d**: Main workstation display file, with subfile (B1SFL) for order lines.

### External Programs/Services

- **VV580R**: Product inquiry.
- **VE710R**: EAN lookup.
- **VL710R, VL721R, VL712R**: Warehouse/product/supplier info.
- **HR200R**: Calculator.
- **AS100R**: Number series management.
- **VP700R, VP753R, VP755R**: Pricing engines.
- **JM591R**: Campaign price lookup.
- **HR112R**: Splitting order proposals by supplier.
- **LH714R**: Status/summary update for order proposal header.
- **VD772R**: Period-controlled product validation.

---

## Main Program Flow

### Initialization (`*inzsr`)

- Receives parameters for firm, code, timestamp, order type, supplier, warehouse, dates, department, and salesperson.
- Sets up key lists for all file interactions.
- Retrieves price group for the warehouse/department.
- Loads warehouse status codes.
- Positions on the transaction file for the current session.
- Builds the initial subfile (order line list).

---

### Main Screen Loop (Start at `b2taga`/`b2tagb`)

Handles user interactions on the subfile screen:

- **Function Keys:**
    - F3/Cancel: Exit and process order proposal.
    - F5/Refresh: Reload subfile from database.
    - F10/New: Add new order line.
    - F4/Inquire: Product lookup via VV580R.
- **Scanning:** 
    - If barcode fields are filled, invokes `scanning` subroutine for product identification.
- **Order Line Processing:** 
    - Handles editing (`b1valg=2`) and deletion (`b1valg=4`) of lines via the subfile.
- **Navigation:** 
    - Maintains current subfile page and record position.

---

### Scanning Logic (`scanning` subroutine)

**Product Identification Sequence:**

1. **Alphanumeric:** Treated as supplier product number; checked for logistics products and in product master.
2. **Numeric, Length 26:** Treated as EAN-128; parsed and looked up via VE710R.
3. **Numeric, Length ≤8:** Treated as internal product number.
4. **Numeric, Length ≤14:** Treated as EAN number; looked up via VE710R.
5. **Numeric, Length <26:** Treated as supplier product number.

If found, loads product data for editing; otherwise, sets error indicators.

---

### Editing/Adding Lines (`xc2bld` subroutine)

- Fetches product details, including name, description, and supplier.
- Determines available order units, prioritizing supplier-specific units, then purchase and sales units.
- Loads existing order line if present, or prepares for new entry.
- Supports unit switching and quantity calculation (with calculator).
- Validates input (order type, product type, period control, quantity, expiry date).
- Updates or inserts the line in the radio terminal transaction file.

---

### Deleting Lines (`xd1bld` subroutine)

- Loads product details for confirmation.
- Deletes the line from the transaction file upon confirmation.

---

### Subfile Management

- **`clr_subfile`**: Clears subfile and resets counters.
- **`crt_subfile`**: Loads order lines from transaction file into subfile for display/editing.
- **`dsp_subfile`**: Handles subfile display logic.

---

### Order Proposal Creation (`opprett` subroutine)

- Checks for existing proposals for the current session.
- Prompts for additional information (E1 screen).
- Retrieves next available proposal number via AS100R.
- Writes order proposal header.
- Transfers all lines from the radio terminal transaction file to the order proposal detail file, performing:
    - Data enrichment (supplier, warehouse, campaign info).
    - Price calculation (calls pricing engines, handles campaign pricing, and unit conversion).
    - Status calculation (stock, minimum, cross-docking, etc.).
    - Deletion of transferred lines from the transaction file.
- Updates proposal header with totals and status via LH714R.
- If supplier was not determined up front, calls HR112R to split proposal per supplier.
- Displays completion screen.

---

## Advanced Business Logic & Special Features

- **EAN-128 and EAN Handling:** Supports parsing and lookup of complex barcodes.
- **Unit Management:** Handles supplier-specific, purchase, and sales units, with user ability to switch units.
- **Campaign Pricing:** Integrates with campaign modules (JM591R, VP755R) to ensure correct campaign prices are used, including unit conversion for campaign price.
- **Order Splitting:** If supplier is not determined, proposals are split per supplier automatically.
- **Status Codes:** Calculates order line status (e.g., minimum/maximum stock, cross-docking) for workflow and reporting.
- **Error Handling:** Uses indicator ranges for error/status reporting, with detailed inline comments for indicator usage.

---

## Coding Patterns and Conventions

- **Indicator Usage:** 
    - Ranges are reserved for logical (LR), file IO, screen fields, error/status, and working indicators.
    - Inline comments document indicator allocation.
- **Key Lists:** 
    - All file access uses named key lists for clarity and maintainability.
- **Subfile Paging:** 
    - Implements subfile paging and position maintenance for user-friendly navigation.
- **Business Rule Isolation:** 
    - Business logic (e.g., price calculation, status checking) is encapsulated in subroutines and external programs.
- **Versioning and Change Log:** 
    - Extensive change log at the top, with version numbers and business-related commentary for each change.
- **SQL Integration:** 
    - Uses embedded SQL for certain lookups (e.g., logistics assortment).

---

## Integration Points

- **Product Master:** Central for all product-related data.
- **Supplier Master:** Used for supplier validation and enrichment.
- **Warehouse:** Stock, status, and unit availability.
- **Pricing Engines:** Multiple programs for standard, campaign, and supplier pricing.
- **Order Proposal:** Final destination for all processed lines.

---

## Key Takeaways for New Developers

- **Understand the Data Model:** Familiarize yourself with the product, unit, supplier, and warehouse files, as well as the order proposal structure.
- **External Program Contracts:** Many business rules are enforced or calculated in external programs. Review their interfaces and expected parameters.
- **Indicator Management:** Strict conventions are followed; do not repurpose indicators outside their documented range.
- **Localization:** Some field names/comments are in Norwegian; refer to the business glossary as needed.
- **Error Handling:** All user-facing errors are managed via indicators and subfile fields; ensure any new logic follows this pattern.
- **Testing:** Because of the many external dependencies and business rules, end-to-end testing with actual warehouse data is essential.

---

## Summary

**HR111R** is a central program for warehouse order capture via radio terminals, integrating deeply with inventory, product, supplier, and pricing modules. Its design supports flexible product identification, robust error handling, and seamless transfer to the order proposal system, with extensive support for complex business scenarios such as campaign pricing and logistics assortment. Understanding its flow, data interactions, and conventions is essential for effective maintenance and further development.