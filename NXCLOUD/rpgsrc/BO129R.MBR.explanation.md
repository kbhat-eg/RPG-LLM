```markdown
# BO129R – RPG ILE Program Overview

## 1. Purpose
BO129R generates cost‐price accounting transactions from sales statistics. It:
- Reads a parameter file for controlling which statistics to process  
- Iterates over selected sales statistics records  
- Checks item type (inventory vs. non‐inventory) and order type  
- Determines the applicable cost price  
- Builds and writes accounting postings to both the main journal file and a SQL “RLOG” log table  
- Marks each statistic record as processed (success or failure)  
- Updates voucher (bilag) and bundle (bunt) totals after posting  

---

## 2. Program Header & Change Log
- `h`‐spec: turns off debug I/O and uses DMY date format.  
- Free‐text comment block: documents creation date, developer initials, and version history (v7.01 → v8.16).  

---

## 3. File Declarations
```
fsovki1  uf   e   k  disk  rename(sovkst:sovki1r)   // Parameter file
fsstal1  if   e   k  disk  rename(sstapfr:sstal1r)   // Sales statistics
fvotyl1  if   e   k  disk  rename(votypfr:votyl1r)   // Order types
fvkhvl1  if   e   k  disk  rename(vkhvpfr:vkhvl1r)   // Account mapping
fbovfpf  o    a e  disk                           // Accounting posting file
frlobi1  uf   e   k  disk  rename(rlobst:rlobi1r)   // Transaction log header
frlodi1  if   e   k  disk  rename(rlodst:rlodi1r)   // Transaction log lines
```
- Files are mostly keyed (`k`) and renamed so internal names end with `1r`.

---

## 4. Data & Working‐Storage Variables
- **Local Data Area** (`dcl-ds uds`): holds OS timestamp and program parameters.  
- **Keys** (e.g. `sstal1_paar`, `sovki1_vopd`): mirror record fields used for `CHAIN`, `READ`.  
- **Working Variables** (`w_peri`, `w_belp`, `w_kost`, `w_kund`, `w_fdat`, `w_bunt`, etc.): hold intermediate values (period, amounts, dates, bundle numbers).  
- **Flags** (`b_feil`, `b_negp`, `u_alle`): control error handling, negative‐price marker, and “all‐item” switch.  
- **External Prototype** (`co402r`): calls program CO402R to fetch runtime parameters.

---

## 5. SQL Environment
```rpg
/Exec SQL
  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR, commit=*none
/End-Exec
```
Configures date format, language ID, and disables auto‐commit.

---

## 6. Main Processing Flow

### 6.1 Initialization (`*INZSR`)
- Sets up key lists for all files.  
- Reads cost‐account parameters (`vgkkir`).  
- Builds a new timestamp (`w_logg`) for log entries.  
- Queries the `rlodst` log‐table to find the highest line number used so far (`w_lintel`).  
- Calls `CO402R` to determine:
  - Whether all items (`u_alle`) should be processed or only inventory items  
  - The cost‐type flag (`w_ktyp`)

### 6.2 Loop Over Parameter File
```rpg
READ(e) sovki1 → until %EOF
  b_feil = *off

  // Map fields to sales‐stats key
  sstal1_paar = sovaar; sstal1_binr = sovbil; sstal1_line = sovbli;
  CHAIN sstal1r → if not found → b_feil = *on; goto MRK_STAT;

  // Skip if “order” flag present
  IF sfbong = ' ' 
    GOTO LES_NESTE 
  ENDIF

  // If only inventory items:
  IF u_alle = *off
    EXSR sjekk_vtyp; IF b_feil GOTO MRK_STAT; ENDIF
  ENDIF

  // Check order type
  EXSR sjekk_otyp; IF b_feil GOTO MRK_STAT; ENDIF

  // Determine item cost
  EXSR finn_kost;   IF b_feil GOTO MRK_STAT; ENDIF

  // Set customer: prefer invoicing customer if present
  IF sffkun <> sfvkun AND sffkun <> 0
    w_kund = sffkun
  ELSE
    w_kund = sfvkun
  ENDIF

  // Build & write the postings
  EXSR bygg_post

MRK_STAT:
  // Mark parameter record: '1' = OK, '9' = error
  sovopd = b_feil ? '9' : '1';
  UPDATE sovki1r

LES_NESTE:
  READ(e) sovki1
ENDDO
```

### 6.3 Finalization
```rpg
EXSR upd_bilag   // Update voucher header totals
EXSR upd_bunt    // Update bundle totals via SQL
*INLR = *ON
RETURN
```

---

## 7. Subroutines

### 7.1 sjekk_vtyp
- Uses embedded SQL to fetch the item’s type code from either `vlagpf` (warehouse‐specific) or `vvarpf` (global).  
- Sets `b_feil = *on` unless the type is `'L'` (inventory).

### 7.2 sjekk_otyp
- Loads order‐type record (`votyl1`) via `CHAIN`.  
- Flags `b_negp = *on` if the sales amount (`sfsumk`) is negative, else error if no record found.

### 7.3 finn_kost
- Based on `w_ktyp` ('G' = use average cost, else use summed cost), picks `sfgjkp` or `sfsumk`.  
- Error if cost is zero.

### 7.4 bygg_post
- Chains to account‐mapping file (`vkhvl1`) to get posting account (`vkhvl1_kkod`).  
- Computes the financial period `w_peri` from month/year in the stats record.  
- Prepares two postings:
  1. **Cost debit/credit**: sets `bfdavd` or `bfcavd` based on whether it’s a negative transaction, uses the cost account (`vgkkos`).  
  2. **Offsetting entry**: same logic, but uses offset account (`vakko3`) and flips sign if negative.  
- Both post entries call `EXSR skriv_post`.

### 7.5 skriv_post
- (Optionally) calls `hent_forfall` to fetch due‐date and bundle from prior log lines for the same voucher.  
- Populates `bovfpf` output record fields (`bfdavd`, `bfdkto`, `bfbelp`, etc.)  
- Sets fixed VAT code `'0'` and blank other fields.  
- Writes the record to `fbovfpf`.  
- Calls `EXSR logg_linjer` to insert a corresponding line in the `rlodst` SQL log.

### 7.6 logg_linjer
- Increments line counter (`w_lintel`).  
- Uses embedded SQL `INSERT INTO rlodst` to record the same posting in the RLOG table, storing all relevant keys and amounts.

### 7.7 hent_forfall
- Scans `rlodi1r` (log lines) for prior entries matching the same voucher number (`sfbinr`).  
- Pulls that record’s due‐date (`rldfda`) and bundle ID (`rldbun`) into `w_fdat` and `w_bunt`.

### 7.8 upd_bilag
- Reads all log‐header records (`rlobi1r`) for the current log batch (`w_logg`).  
- For each header, calls `sum_bilag`, then updates its total debit/credit and counts via `UPDATE rlobi1r`.

### 7.9 sum_bilag
- Aggregates line amounts (`rldbel`) for a single voucher (`rlbbil`) within the current log batch.  
- Totals debits, credits, and line counts into `w_dsum`, `w_ksum`, `w_antd`, `w_antk`.

### 7.10 upd_bunt
- Re‐calculates the bundle total (`rlhst.rlhbs1`) for the entire log batch via embedded SQL `UPDATE rlohst`, using the summed line amounts.

---

## 8. Runtime Parameter Call (CO402R)
```rpg
CallP CO402R(l_filg: w_firm: 0: 'POST_KOST': co402_verdi1: co402_verdi2);
u_alle = (co402_verdi2[1] <> ' ');
w_ktyp = co402_verdi2[2];
```
- Reads program‐level switch controlling whether to post all items or only inventory, and selects cost type.

---

## 9. Key Takeaways for New Developers
1. **Keyed File IO**: heavy use of `CHAIN`, `READ` on files renamed with trailing `1r`.  
2. **Embedded SQL**: used for parameter lookup, item type fetch, logging, and final bundle update.  
3. **Modular Structure**: routines (`EXSR/BEGSR/ENDSR`) encapsulate checks, cost determination, posting logic, and logging.  
4. **Control Flags**: `b_feil` aborts processing of a record, `b_negp` handles negative sales, `u_alle` toggles item‐type filtering.  
5. **Logging**: dual‐written to physical file (`bovfpf`) and relational table (`rlodst`) for audit and reprocessing.  
6. **Final Tuning**: voucher and bundle totals must be updated after all detail lines are posted.  

This structure ensures that each sales statistic is processed exactly once, with error handling, and results are fully logged for auditing in both file‐based and SQL‐based logs.