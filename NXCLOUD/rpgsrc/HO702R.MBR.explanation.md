# RPG Program Explanation: HO702R

## Overview

This RPG (Report Program Generator) program, named **HO702R**, is written for IBM i (AS/400, iSeries) systems. It is used for **importing and processing order header data from a handheld terminal system**, specifically for the "PSI" process. 

- **System:** ASLAGR
- **Purpose:** Reads records from a file (hbtrpf), processes each record, and writes to order header and detail files.
- **Main files involved:** 
  - `hbtrpf` (input, keyed)
  - `hohelu` (order header, output, renamed as `hohelur`)
  - `hodtlu` (order detail, output, renamed as `hodtlur`)

## File Definitions

```rpg
fhbtrpf    if   e           k disk          // Input file, keyed, external
fhohelu    uf a e           k disk    rename(hohepfr:hohelur) // Order header, update/add, renamed
fhodtlu    uf a e           k disk    rename(hodtpfr:hodtlur) // Order detail, update/add, renamed
```

## Data Area and Variables

- **Local Data Area (LDA):** Used for passing data like company number (`l_firm`)
- **Working variables:** Various variables for temporary storage and manipulation during processing.
- **Data structure `d_ht`:** Maps to the format of incoming records from the handheld terminal file.

```rpg
d                uds
d l_firm                944    946  0 // Company number from LDA
```

### Data Structure for Handheld Terminal Record

```rpg
d                 ds
d d_ht                          73       // Entire record
d  d_ht_head                    25   overlay(d_ht) // Header, overlay
d  d_ht_dato                     6  0 overlay(d_ht:26) // Date part
d  d_ht_time                     4  0 overlay(d_ht:33) // Time part
d  d_ht_kund                     6  0 overlay(d_ht:38) // Customer number
d  d_ht_refn                     6  0 overlay(d_ht:45) // Reference number (order)
d  d_ht_vare                     8    overlay(d_ht:52) // Item number
d  d_ht_enhe                     3    overlay(d_ht:61) // Unit
d  d_ht_anta                     9    overlay(d_ht:65) // Quantity
// ...includes various separators
```

## Mainline Logic

### Initialization

- On program start, the `*inzsr` subroutine is executed to read the company number from the LDA into the local variable `w_firm`.

### Processing Loop

- The program reads each record from `hbtrpf` in a loop.
- For each record, it calls the `behandling` subroutine.
- The loop ends when EOF is reached.

```rpg
c                   read      hbtrpf                                 90
c                   dow       *in90 = *off
c                   exsr      behandling
c                   read      hbtrpf                                 90
c                   enddo
c                   eval      *inlr = *on
c                   return
```

## Subroutines

### *inzsr (Initialization Subroutine)

- Loads the company (firm) number from the LDA into `w_firm`.

```rpg
c     *inzsr        begsr
c                   eval      w_firm = l_firm
c                   endsr
```

### behandling (Main Processing Subroutine)

This is the "engine" of the program, processing each record:

1. **Map Record Fields:** Overlay the raw record (`hoinfo`) onto the `d_ht` data structure.
2. **Skip Processing If No Item:** If `d_ht_vare` (item number) is blank, skip the record.
3. **Order Header Handling:**
   - If the reference number (`d_ht_refn`) is different from the previous, create a new order header record.
   - Populate fields (`hofirm`, `horefn`, `hokund`, etc.) and write to the header file (`hohelur`).
   - Update the current reference number tracker (`w_refn`).
4. **Order Detail Handling:**
   - Set various fields in the detail file (`hdfirm`, `hdrefn`, etc.).
   - Construct the quantity field (`hdanta`) from parts of `d_ht_anta`.
   - Set date/time fields.
   - Write the new order detail line (`hodtlur`).

```rpg
c     behandling    begsr

// Overlay the current input record into the structure
c                   eval      d_ht = hoinfo

// Skip if item number is blank
c                   if        d_ht_vare = *blank
c                   goto      end_behandl
c                   endif

// New header if reference (order) number changes
c                   if        w_refn <> d_ht_refn
c                   eval      hofirm = w_firm
c                   eval      horefn = d_ht_refn
c                   eval      hokund = d_ht_kund
c                   eval      hoselg = 0
c                   eval      hostat = 0
c                   time                    hodato
c                   time                    hotime
c                   write     hohelur
c                   eval      w_refn = d_ht_refn
c                   endif

// Detail line for this item
c                   eval      hdfirm = w_firm
c                   eval      hdrefn = d_ht_refn
c                   movel     d_ht_vare     hdvare
c                   eval      hdenhe = d_ht_enhe

// Quantity is parsed from substrings and concatenated
c                   eval      w_anta_alf = %subst(d_ht_anta:1:6) +
c                                          %subst(d_ht_anta:8:2) + '0'
c                   move      w_anta_alf    hdanta

// Set date and time
c     *ymd          move      d_ht_dato     hddato
c                   movel     d_ht_time     w_time
c     *hms          move      w_time        hdtime

// Write order detail record
c                   write     hodtlur

c     end_behandl   endsr
```

---

## Summary Table

| File      | Purpose                      | Direction   |
|-----------|------------------------------|-------------|
| hbtrpf    | Input from handheld terminal | Read/Keyed  |
| hohelu    | Order header                 | Write/Update|
| hodtlu    | Order details                | Write/Update|

## Business Flow

1. **Read all records** from the handheld terminal file.
2. **For each record:**
   1. If the item number exists, and the reference (order) number is new, **write a new order header**.
   2. **Write an order detail line** using the data from the record.
3. **Repeat** until all records are processed.

---

## Key Points

- Uses overlays to map raw record data to individual fields.
- Handles both order headers and details, ensuring each header is only written once per order.
- Date/time and quantity fields are parsed and adapted to the required formats.
- LDA is leveraged to get company information for every order.

---

This program is **batch-oriented**, typical for classic ILE RPG, and suited for onboarding anyone new to legacy IBM i data processing programs.