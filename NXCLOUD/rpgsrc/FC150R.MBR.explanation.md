# FC150R – Price Group Copying and Maintenance

## Overview

This program (`FC150R`) is part of the ASOFAK system and is responsible for the maintenance and copying of price groups. It provides a subfile-driven user interface for viewing, creating, updating, copying, and deleting records associated with price group master data. The program supports multiple regions (e.g., MDT, VST, SVE, SOV, NVE, HOL, SKI, ROM, SOR) and implements a number of business rules to govern record creation and maintenance.

## Main Features

- **Subfile-based UI**: Allows users to browse, page, and select records for further actions.
- **CRUD Operations**: Supports Create, Read, Update, Delete, and Copy on price group records.
- **Region Validation**: Ensures only allowed regions are used and enforces master uniqueness per region.
- **User and Firm Context**: Operates within the context of a specific firm and user, loaded from the local data area (LDA).
- **Audit Information**: Tracks user and timestamp for changes.

## File Relationships

The program uses four logical files, all based on the same physical file (`fcplpfr`), each with a different access path:

- `fcpll1`: Main access for subfile display (keyed by firm and price group).
- `fcpll2`: Used for region-based searches (keyed by firm and region).
- `fcpllr`: Used for record existence checks and direct access (keyed by firm and price group).
- `fcpllu`: Used for update/delete operations (keyed by firm and price group).

The display file (`FC150d`) manages the subfile and various control and dialog screens.

## Indicators

The codebase follows a strict indicator convention:
- 10–15: Subfile and display control (roll, rolldown, subfile display, clear, end)
- 21–22: Cursor placement and home key
- 30: Field protection (view mode)
- 31–79: Error/warning indicators
- 80–99: Work indicators

## Main Program Flow

### Initialization (`*inzsr`)

- Sets up key lists for file access.
- Loads firm from LDA.
- Initializes the subfile with the firm's records.

### Main Loop

1. **Display Command Screen (`b2taga`)**
   - Presents the main command interface.

2. **Display Subfile (`b2tagb`)**
   - Shows the subfile list of price groups.
   - Handles function keys for paging, new, copy, update, delete, and view operations.

3. **Function Key Handling**
   - *F3/F12*: Exit program.
   - *F5*: Refresh subfile.
   - *F6*: Add new price group.
   - *Roll Up/Down*: Page through subfile.
   - *Home*: Position cursor.

4. **Positioning**
   - If a position key is entered, the subfile is reloaded starting from the given key.

5. **Subfile Processing**
   - Iterates through subfile records for update, copy, delete, or view based on user selection.

### Subroutines

#### Subfile Management

- **`forny`**: Refreshes the subfile, maintaining position if possible.
- **`posisjoner`**: Repositions subfile display based on user input.
- **`subfile`**: Handles user actions (update, copy, delete, view) on subfile records.
- **`clr_subfile`**: Clears subfile display.
- **`crt_subfile`**: Loads (pages) subfile records for display.
- **`bck_subfile`**: Pages subfile backwards.

#### CRUD Dialogs

- **`xc1bld`**: Handles creation of a new price group. Checks for duplicates and invokes the maintenance dialog (`xc2bld`).
- **`xc1msg`**: Displays a message if the user tries to create a duplicate record.
- **`xc2bld`**: Maintenance dialog for create, update, or view. Handles validation and writes changes to the database.
- **`xd1win`**: Handles delete confirmation and performs the delete.
- **`xk1win`**: Handles copying a record, including duplicate checks and invoking maintenance dialog for the new record.

#### Display

- **`dsp_subfile`**: Manages subfile display, including error and control indicators.

## Business/Domain Logic

### Region Handling

- Only specific region codes are allowed (`MDT`, `VST`, `SVE`, `SOV`, `NVE`, `HOL`, `SKI`, `ROM`, `SOR`).
- Only one "master" (`c2lmas = 1`) per region is allowed. This is enforced during record creation/update.

### Key Uniqueness

- Price group key (`lprg`) must be unique within the firm.
- When copying, the new key must not already exist.

### Audit Trail

- Each record tracks the user and timestamp for both creation and last update.

### Subfile Paging

- The subfile supports paging forward and backward, with the page size defined by constant `c_sfil = 14`.
- Paging logic ensures the user can navigate efficiently through potentially large datasets.

## UI Screens

- **B1SFL**: Subfile record format.
- **B2CTL**: Subfile control (paging, commands).
- **B2CMD**: Command keys screen.
- **C1BLD**: Key entry for new record creation.
- **C1MSG**: Duplicate key warning.
- **C2BLD**: Maintenance (create/update/view) dialog.
- **D1WIN**: Delete confirmation.
- **K1WIN**: Copy dialog.

## Design Decisions and Patterns

- **Single Entry Point**: The main program loop is structured with labeled tags and `goto` statements for clarity in function key handling and screen transitions, a common pattern in classic RPG UI programs.
- **Indicator-Driven UI**: Heavy use of indicators for field and screen control, following established UI conventions in this codebase.
- **File Renaming**: Logical files are renamed for clarity and to match their access patterns.
- **Explicit Key Lists**: Key lists are defined in `*inzsr` to standardize file access throughout the program.
- **Separation of Concerns**: CRUD logic is separated into individual subroutines for maintainability.

## Integration Points

- **Local Data Area (LDA)**: Used to retrieve the current user and firm context.
- **Physical File (`fcplpfr`)**: All logical files are based on this, supporting different access patterns.
- **Display File (`FC150d`)**: Manages all user interaction.

## Notable Conventions

- **Norwegian Comments**: Comments are in Norwegian, reflecting the business language of the customer.
- **Change Log**: The header includes a detailed change log, with references to system modifications for region support and GUI changes.
- **Field Naming**: Prefixes like `b1`, `b2`, `c1`, `c2`, `d1`, `k1` correspond to the various UI screens and their associated fields.

---

## Summary Table: Subroutines

| Subroutine     | Purpose                                             |
|----------------|-----------------------------------------------------|
| forny          | Refresh subfile, maintaining current position       |
| posisjoner     | Position subfile to a specific key                  |
| subfile        | Handle user actions on subfile records              |
| clr_subfile    | Clear subfile display                               |
| crt_subfile    | Load records into subfile for display               |
| bck_subfile    | Page subfile backwards                              |
| dsp_subfile    | Manage display of subfile and control screens       |
| xc1bld         | New record creation dialog                          |
| xc1msg         | Duplicate key warning dialog                        |
| xc2bld         | Create/update/view maintenance dialog               |
| xd1win         | Delete confirmation and execution                   |
| xk1win         | Copy record dialog                                  |

---

## Key Points for New Developers

- Understand the subfile paging and indicator conventions.
- All file access is context-sensitive to the current firm and user.
- Business logic is tightly coupled to region and master uniqueness rules.
- UI navigation relies on explicit tags and subroutine calls, not structured loops.
- Error and warning handling is indicator-based and tied to specific UI fields.

---

For further onboarding, review the display file (`FC150d`) for field layouts and ensure familiarity with the business meaning of the price group and region codes. Integration with other modules is primarily through shared physical files and LDA context.