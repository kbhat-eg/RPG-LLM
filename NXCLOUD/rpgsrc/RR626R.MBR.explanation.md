# Program RR626R Documentation

## Overview

**Program RR626R** is a report generator in the ASOKON system, designed to print a list of accounts ("konti") that are defined in the account balance file but are not included on a particular report. The report is primarily used for reconciliation and auditing purposes, ensuring that all accounts are either accounted for in the main report or clearly listed as exceptions.

The program operates on the following key files:

- **rhsal1** (Account balance register, `rhsapfr`): Contains account balances, one record per account/specification/department/year/type.
- **rrf8l1** (Report line register, `rrf8pfr`): Contains definitions of report lines, including account ranges and report codes.
- **rr626p** (Printer file): Output file for the generated report.

## Business Logic

The core business logic is as follows:

1. **Initialization**: The program sets up working variables and positions file pointers to the start of the relevant files.
2. **Iterate Account Balances**: For each account in the balance register (`rhsal1`), the program checks if the account is included in the report definition (`rrf8l1`).
3. **Account Inclusion Test**: 
    - If the account's number is outside the range defined for the report, it is considered "not included."
    - Additional filtering is performed based on fiscal year, company, and other control fields.
4. **Output**: Accounts not included on the report are printed, along with descriptive text fetched from the account plan (via a call to `RS740R`).
5. **Summation**: The program accumulates totals for the excluded accounts for reporting purposes.

## File and Data Structure Relationships

- **rhsal1** (renamed `rhsal1r`): Main input file, keyed by company, account, specification, department, year, and type.
- **rrf8l1** (renamed `rrf8l1r`): Used to determine which accounts are included on the report, defined by company, report code, account from/to, specification, and department.
- **RS740R**: External program called to retrieve account descriptive text from the chart of accounts.

## Key Data Structures and Variables

- `isa(1:14)`: Array holding balance amounts for each period; `isa(14)` is typically the annual total.
- Data structures `nybrd` and `gmbrd` are overlays used for managing composite keys (account, specification, department).
- `w_8fkt`, `w_8tkt`: Working variables holding the lower and upper account numbers for the currently processed report line.
- `w_text`: Holds the descriptive text for the account, retrieved from the account plan.
- `w_dper`, `w_hitt`: Used for accumulating period and total balances.

## Control Flow

### Main Loop

- **Initialization (`*inzsr`)**: 
    - Zeroes out counters.
    - Initializes working variables.
    - Positions file pointers.
    - Reads the first report line definition.
    - Sets up the initial account range for report inclusion.
    - Writes the report heading.

- **Account Processing (`les` to `test` tags)**:
    - Reads the next account from `rhsal1r`.
    - Checks for company break (end of relevant data).
    - Skips accounts not in the correct fiscal year.
    - If the account is **below** the current report line's range, it is not included; fetches account text, prints, and accumulates totals.
    - If the account is **above** the current report line's range, fetches the next report line and updates account range.
    - If the account is **within** the range, it is implicitly included and not printed.

- **End-of-File and Termination**:
    - When no more accounts or report lines remain, the program sets the last record indicator and ends.

### Subroutines

- **`skriv`**: Writes the report heading (called at the start and on page overflow).
- **`xlsum`**: Accumulates balances for the current account, summing either the annual total or the relevant periods as defined by the report period parameter.

## Notable Design Decisions & Patterns

- **Overlay Data Structures**: Composite keys (account/spec/department) are managed using overlays in data structures for efficient comparison and assignment.
- **Dynamic Range Matching**: The logic for matching accounts to report lines is dynamic, allowing for flexible report definitions (ranges can change mid-run).
- **External Text Retrieval**: Descriptive account text is fetched via a program call (`RS740R`), decoupling text management from the report logic.
- **Conditional Printing**: The program only prints accounts not included in the report, optimizing output and focusing on exceptions.
- **Summation Logic**: The summation subroutine (`xlsum`) supports both annual and period-based totals, controlled by the report period parameter.

## Interactions with Other Modules

- **RS740R**: Called to retrieve account descriptions. Parameters include company, account, specification, department, and a return variable for the text.
- **Printer File (rr626p)**: Handles all report output, including headings and account lines.

## Error Handling and Edge Cases

- **File End Detection**: Uses indicators (*IN10, *IN11) to handle end-of-file conditions for both account and report line files.
- **Company Breaks**: Ensures processing stops when data for the current company ends.
- **Report Range Gaps**: Accounts not matching any report line are correctly identified and processed as exceptions.

## Conventions & Comments

- **Norwegian Variable Names**: Many field and variable names are in Norwegian (e.g., `konti`, `saldofelter`), reflecting the business domain and original system language.
- **Change Log**: Maintained in the header, with version numbers and descriptions of significant changes.
- **Spacing and Tagging**: Uses tags (`les`, `test`, `slutt`, etc.) for structured flow control, a common pattern in legacy RPG code.

## Summary Table of Main Variables

| Variable   | Purpose                                      |
|------------|----------------------------------------------|
| `isa(1:14)`| Balance amounts for each period              |
| `nybrd`    | Composite key: account, spec, department     |
| `gmbrd`    | Composite key for grouping                   |
| `w_8fkt`   | Current report line account-from             |
| `w_8tkt`   | Current report line account-to               |
| `w_text`   | Account description (from RS740R)            |
| `w_dper`   | Period balance accumulator                   |
| `w_hitt`   | Total balance accumulator                    |
| `*IN10`    | EOF indicator for rhsal1r                    |
| `*IN11`    | EOF indicator for rrf8l1r                    |
| `*IN30`    | Page overflow indicator (printer file)       |

## Typical Use Case

1. Run the program for a given company and fiscal year.
2. The program prints a report listing all accounts present in the balance file but not included in the main report, with descriptions and totals.
3. The report is used for reconciliation, ensuring no accounts are omitted unintentionally.

---

**Note:** This program is a crucial tool for financial control and reconciliation within the ASOKON system, ensuring transparency and completeness of financial reporting. Its logic is tightly coupled to the structure of the company's chart of accounts and report definitions. Familiarity with the data files and their relationships is essential for effective maintenance and extension of this code.