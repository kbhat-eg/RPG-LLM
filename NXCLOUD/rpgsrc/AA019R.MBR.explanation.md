# Program AA019R – Printer Properties Management

## Overview

This program (AA019R) is part of the ASPGPL system and is responsible for managing printer properties. It provides a subfile-based interactive interface for users to view, add, change, copy, and delete printer property records. The code is written in RPG/400 and interacts with physical files and display files, handling user input through function keys and subfile operations.

This documentation will explain the program's structure, business logic, and notable design conventions, focusing on onboarding experienced RPG developers to our domain and codebase patterns.

---

## Main Business Logic

The core business goal is to maintain a register of printer properties, allowing users to:

- View a list of printer properties (with paging and positioning)
- Add new printer properties
- Edit existing printer properties
- Copy properties from one printer to another
- Delete printer properties

All these operations are performed via a subfile-driven interface, using several display formats for various screens and pop-up windows.

---

## File Definitions and Relationships

- **afprlr**: Main printer property list file (renamed afprlrr in this program).
- **afpplu**: Additional/lookup file for printer properties (renamed afpplur).
- **aa019d**: Display file with multiple record formats (subfiles, control records, pop-up windows).

The program uses these files as follows:

- afprlr: Drives the main subfile listing and is used for positioning and retrieval.
- afpplu: Used for validation, updates, and additional property data.
- aa019d: Handles all user interaction via subfile and pop-up screens.

---

## Indicator Usage

The program uses RPG indicators extensively for UI and logic control. Notable conventions:

- **LR**: End of program.
- **10/11**: Rollup/Rolldown (paging subfile).
- **12/13**: Subfile display and control.
- **14/15**: Clear subfile/end of subfile.
- **21/22**: Home key and cursor positioning.
- **30**: Field protection during display.
- **31-79**: Error/warning indicators.
- **80-99**: Work indicators.

---

## Data Structures and Variables

### Local Data Area (LDA)

- **l_user, l_filg, l_firm, l_fnav**: User, file, firm, and navigation info, typically loaded at program start for session context.

### Display Feedback Data Structure

- **dspfbk**: Used for retrieving cursor position and other feedback from display file.

### Key Variables

- **afprlr_sfil/sprt, afpplu_vfil/vprt**: Used for building keys to position on the physical files.

### Subfile Paging Variables

- **w_fcrn**: First record number on the page (for paging).
- **w_stel**: Subfile counter.
- **w_spge**: Page size in subfile.
- **w_srrn**: Relative record number in subfile.
- **w_sfrn/w_ssrn**: First/last record number on the last page.
- **w_virn**: Page and cursor position to display.

---

## Display Screens

- **B1SFL**: Subfile records for the main printer property list.
- **B2CTL**: Control record for subfile (header/footer, paging controls).
- **B2CMD**: Command screen for function key help.
- **C1BLD**: Screen for entering a new property key during creation.
- **C1MSG**: Message screen for errors during creation.
- **C2BLD**: Screen for add/edit/view of a property.
- **D1WIN**: Window for delete confirmation.
- **K1WIN**: Window for copy operation.

---

## Main Program Flow

### Initialization (`*inzsr`)

- Loads session context from LDA.
- Initializes key lists for file positioning.
- Positions to the start of the printer property list and loads the initial subfile page.

### Main Loop

- **b2taga**: Entry point for displaying the command screen.
- **b2tagb**: Entry point for displaying/updating the subfile.
- Handles user actions via function keys:
    - **F3/F12**: Exit.
    - **F5**: Refresh subfile.
    - **F6**: Start add new property.
    - **RollUp/RollDown**: Page forward/backward.
    - **Home**: Position cursor.
    - **Positioning field**: Allows direct positioning by key.
- Calls appropriate subroutines for each action, then loops back to display updated screens.

---

## Subfile Management

### Display/Update Subfile (`dsp_subfile`)

- If subfile has records, sets indicator for subfile display; otherwise, shows command screen.
- Handles user input and sets up cursor positioning for the next display.

### Clear Subfile (`clr_subfile`)

- Sets indicator to clear subfile, writes control record, and resets paging variables.

### Create (Populate) Subfile (`crt_subfile`)

- Fills the subfile with the next page of records from afprlr.
- Handles end-of-file and sets paging markers.

### Page Back in Subfile (`bck_subfile`)

- Reads previous records from afprlr to page backward.
- Adjusts subfile contents and paging variables accordingly.

---

## Positioning

- Allows the user to jump to a particular printer property by key (typically via a positioning field).
- Repositions afprlr and reloads the subfile starting from the requested key.

---

## Add, Edit, View, Copy, and Delete Operations

### Add New Property (`xc1bld`)

- Presents the C1BLD screen for entering a new property key.
- Validates if the property already exists; if so, shows C1MSG error screen.
- If valid, calls the maintenance subroutine (`xc2bld`) to enter details.

### Edit/View Property (`xc2bld`)

- Loads the selected property from afpplu.
- Presents the C2BLD screen for editing or viewing, depending on context.
- Validates input and updates or writes the record in afpplu.
- Updates subfile if necessary.

### Copy Property (`xk1win`)

- Presents the K1WIN screen for copying an existing property to a new key.
- Validates that the target key does not already exist.
- Calls maintenance subroutine to create the new property with copied details.

### Delete Property (`xd1win`)

- Presents the D1WIN confirmation window.
- If confirmed, deletes the selected property from afpplu and marks subfile for refresh.

---

## Error Handling and Messaging

- Uses dedicated message screens (e.g., C1MSG) to inform the user when attempting to add a duplicate property or other validation errors.
- Error and warning indicators (31-79) are used to control field highlighting and error messages on the display.

---

## Notable Design Patterns and Conventions

- **Subfile Paging**: The program implements manual subfile paging logic, tracking page size, current/first/last record numbers, and using indicators to control rollup/rolldown.
- **Screen Flow Control**: Uses `goto` tags and subroutine calls to manage screen transitions, which is a common pattern in legacy RPG/400 interactive programs.
- **Indicator-Driven UI**: Heavy use of indicators for controlling subfile state, field protection, error highlighting, and function key handling.
- **File Key Lists**: Uses `klist` and `kfld` for key-based positioning and retrieval in physical files.
- **Session Context via LDA**: Uses the local data area to pass user/session context between programs and for audit fields.

---

## Integration and Dependencies

- **External Program Calls**: Some sections (commented out) show the ability to call external programs for lookups (e.g., department lookup via `RA507R`), passing parameters for integration with other modules.
- **File Relationships**: The program expects consistent relationships between afprlr and afpplu, using keys for validation and updates.

---

## Maintenance and Extensibility Notes

- **Adding New Screens**: Follow the pattern of defining new record formats in the display file and corresponding subroutines for handling them.
- **Adding New File Fields**: Update key lists, validation, and subfile populate logic as needed.
- **Function Key Handling**: Extend the main loop’s select/case structure to handle new function keys or actions.

---

## Summary

This program is a classic example of a subfile-driven maintenance application in RPG/400, tailored for managing printer properties. The code is modular, with clear separation between display logic, file handling, and business rules. It relies on RPG indicators for UI state and uses key lists for efficient file access. The design allows for straightforward extension to support additional printer property fields or related business logic.

For further details on specific display file layouts, refer to the `AA019D` DDS source. For new developers, understanding the subfile paging logic and indicator conventions is key to effective maintenance and enhancement of this codebase.