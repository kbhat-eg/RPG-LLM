# Explanation of the RPG Program RF107R (Avkryssingsrutine kunder/leverandører)

This ILE RPG program, `RF107R`, is an interactive routine used for "avkryssing" (matching, reconciliation or clearing) and updating of open customer (kunder) or supplier (leverandører) items in an accounts receivable/payable context. The program has grown over many releases and contains logic for both automatic and manual matching, handling of differences (agio/disagio/discount/cost), and integration with other programs and archives.

Below is a structured explanation to aid onboarding:

---

## 1. **Overall Structure**

- **Title / Header**: Program name, function, changelog, and comments about indicator and switch usage.
- **File Declarations**: Declaration of all files (physical/logical, input/output) used.
- **Variable & Data Structure Definitions**: Declaration of variables, data structures, arrays, and constants—both for internal processing and user interface.
- **Mainline Logic**: Contains the program flow—screens, user selections, processing loops, and exit logic.
- **Subroutines**: Encapsulated logic blocks for specific tasks, like array handling, display logic, posting, etc.

---

## 2. **Main Functional Areas**

### 2.1 **Initial Screen: New Account Entry (A2BLD)**

- User starts by selecting or entering an account (customer or supplier).
- User can jump to relevant programs for customer/supplier selection.
- Sets indicators for customer (`*in94`) vs. supplier (`*in95`).
- Handles bulk update of outstanding amounts to "restbeløp" (remaining balance).

### 2.2 **Matching Screen: Avkryssing (A5BLD)**

- Core matching happens here. Up to 12 lines of open items are displayed, drawn from arrays (array size recently increased to handle 9999 records).
- User may select items for reconciliation, set matching reference, or choose functions like rollback, different matching methods, etc.
- Handles back/forward paging (roll), switching between NOK and currency view, and screens for difference allocation (agio, discount, cost).
- Handles GUI indicators and input conversion (upper/lowercase).

### 2.3 **Reconciliation Approval (E1WIN / E2WIN)**

- Handles logic when the match leaves a difference (not zero).
- Prompts the user to either enter additional reference or allocate the difference (via code: Agio, Rabatt, Omkostning).
- Approves and updates ledgers accordingly.

### 2.4 **File and Array Handling**

- Data is always processed in arrays for both debit and credit sides.
- Arrays are filled using file reads (with handling for both customers and suppliers).
- Array data is copied to display fields for each 'page' of the UI.

### 2.5 **Automatic/Manual Matching and Difference Handling**

- Handles both manual marking and automatic matching via reference number.
- If matching is not perfect (not zero), user is prompted to allocate the difference via special posting (Agio, Rabatt, Omkostning).
- Updates both subledgers and general ledger as required.

### 2.6 **Subroutines**

Key subroutines include:

- `xcrt01` – Build arrays for open items
- `xclr01` – Clear display lines
- `xmov01`, `xmovdb`, `xmovkr` – Move array data to screen fields
- `xrollf`, `xrollb` – Next/previous page in UI
- `xgodkj` – Validate selected match (avkryssing)
- `xscann` – Attempt auto-matching debet/kredit of equal amount
- `xtrans` – Find transactions for matching (journals)
- `xsaldr` – Attempt auto-matching via reference
- `xdagio`, `xrabat`, `xomkost` – Post agio, discount or cost differences
- `xkonto` – Fetch VAT code from account register
- `xm1win`, `xn1win` – Display different message windows to user
- `xr1win` – Handles mass update of remaining amounts (restbeløp)
- `xx1win` – Account type selection
- `xvisfa` – View invoice or archive entry
- `Null_Bilag` – Zero-out postings for 'Shop' journal

---

## 3. **Key Concepts & Terminology**

- **Reskontroutdrag (Open Items)**: The program is for matching payments/invoices.
- **Avkryssing**: The act of matching invoices and payments (clearing items).
- **Restbeløp**: Remaining open amount on an item (not yet matched).
- **Agio/Disagio**: Currency gain/loss due to rate differences, posted as needed.
- **Kontantrabatt**: Cash discount. Can be allocated to open items.
- **Omkostning**: Miscellaneous cost, can also be posted for differences.
- **Indicators**: RPG indicators (e.g., *in94 for customer, *in95 for supplier, etc.) and program switches (SWTCH1-5) drive the process flow.
- **Paging**: The user interface supports paged display of open items.
- **Reference Number (Refnr)**: Used to attempt automatic matching.

---

## 4. **File Handling**

- **Physical and Logical Files**: Many files represent different parts of the AR/AP subledger, general ledger, and reference files.
- **File Renaming**: RPG allows files to be renamed at declaration to allow multiple logical views.
- **File Key Lists**: Extensively used for searching and updating specific records.

---

## 5. **User Interface/Display**

- **DDS Workstation File**: The display file (`frf107d`) defines screens and fields.
- **Paging/Scrolling**: Supports movement through lists of open items.
- **Indicators**: Many indicators have well-documented purposes (see comments in code).

---

## 6. **Audit and Journal Logic**

- **Posting/Updating**: When matches are approved or differences allocated, postings are written to both subledger(s) and general ledger.
- **Journalkjøring**: Special handling for posting from journal batches; uses additional file/member logic.

---

## 7. **Integration and Special Handling**

- **CO402R**: External program call to determine configuration/behavior.
- **ARCHIVE/Invoice Viewing**: Includes logic to launch programs for document viewing.
- **SHOP/TELE/ADRA**: Handles special cases for postings coming from different systems or sources.

---

## 8. **Recent Modifications and Extensions**

- Larger arrays for more open items.
- Extended to shop/tele/adra automatic logic.
- Supporting additional tables for new releases.
- GUI adaptations.

---

## 9. **Comments and Documentation**

- **Change log**: Each change is tracked by version, date, description, and initials.
- **Indicator/Switch usage**: Thoroughly documented at the start for easier understanding.
- **Field explanations**: Provided for key variables, structures, and screen fields.

---

## 10. **Example Program Flow**

1. **User selects account.**
2. **Program loads open items into arrays (customer/supplier).**
3. **User marks items for matching (manually or via reference).**
4. **Program checks if matched total is zero.**
   - If yes: updates records, posts as needed.
   - If no: prompts user to allocate via agio, discount, cost, or roll back.
5. **All updates reflected in both subledger and general ledger files.**
6. **User can scroll/paginate through open items, view underlying invoices/archives.**
7. **Special integration logic for specific sources (Shop, Tele, Adra).**

---

## 11. **Best Practices and Tips for Working With This Program**

- **Understand indicators and switches**: They control processing flow.
- **Use the comments**: They are extensive and provide much-needed guidance.
- **Add debug output cautiously**: The code is production-level AR/AP logic—errors have real impact.
- **When extending, align with the existing array/file structure**: Consistency is key.

---

## 12. **Conclusion**

This program is a comprehensive AR/AP matching routine for IBM i (AS/400), highly customized for Norse business environments. It demonstrates classic RPG logic and structure, with clear documentation and robust handling of practical, real-world accounting challenges. It draws upon both the depth of classic RPG capabilities and modern RPG enhancements (like large arrays, external program calls, and GUI accommodation).

If you need to modify or troubleshoot RF107R, take special care to understand the array handling, indicator logic, and how each subroutine fits into the overall flow. The code is robust, but non-trivial—review both the comments and the associated display files for full context.

---