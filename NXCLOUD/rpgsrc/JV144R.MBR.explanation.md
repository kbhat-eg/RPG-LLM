# Explanation of RPG Source Code: JV144R

This program, named **JV144R**, is written in **ILE RPG**, typically used for IBM i (AS/400) systems. The program is designed to assist in **transferring and changing units (enheter) in EVR (likely a subsystem or module)**.

The code contains thorough documentation and a version log at the top, which provides a useful history of adjustments and bug fixes.

---

## 1. Header and File Declarations

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: No debug for I/O operations.
- `datedit(*dmy)`: Date fields use day/month/year format.

### File Specifications

```rpg
fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
fjvpkl1    if   e           k disk    rename(jvpkpfr:jvpkl1r)
fjvpglr    if   e           k disk    rename(jvpgpfr:jvpglrr)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)
fjv144d    cf   e             workstn
```
- **Files jvarl1, jvpkl1, jvpglr, vvarl1, vvenl1**: All are externally described disk files, each renamed for use within this program.
- **fjv144d**: Workstation file (likely for user display/input).

---

## 2. Data Definitions

### Parameters to Program

```rpg
d p_firm          s                   like(vvfirm)
d p_vare          s                   like(vvvare)
```
- **p_firm**: Company code, matches the type of `vvfirm`.
- **p_vare**: Item code, matches the type of `vvvare`.

### Working Variables

Several working variables are declared, most using the `like()` keyword, ensuring they match related data types in the files.

Examples:
- `vvarl1_vare`, `vvenl1_vare`, etc.: Used for key fields in file lookups.
- `b_bytt`, `b_pakn`: 1-character flags, initialized to *off.
- `w_Firm`, `w_vare`, `w_genh`, `w_nenh`: Working storage for company/item/unit data.
- `w_dato`: A date field.

---

## 3. Main Program Flow

**The main logic is organized with tags and subroutines:**

### a. Program Initialization

At program start, parameters are read and variables initialized within the `*inzsr` subroutine (at the end of the source).

```rpg
c     *inzsr        begsr
...
c                   endsr
```
- Reads entry parameters.
- Prepares key lists for database file lookups.

### b. Opening Screen Logic (Label: `b1tag`)

```rpg
c     b1tag         tag
c                   exsr      sjekk_sts3
c                   if        b_bytt = *off
c                   goto      avslutt
c                   endif
c                   exfmt     b1bld
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
c                   call      'VV755R'
c                   parm                    w_firm
c                   parm                    w_vare
c                   parm                    w_genh
c                   parm                    w_nenh
```

**Explanation:**
- Calls subroutine `sjekk_sts3` to check item status and eligibility.
- If switching units (`b_bytt`) is not allowed, immediately exits.
- Displays the main screen (`exfmt b1bld`) to the user.
- If function keys (Cancel/Leave) are pressed, exits.
- Otherwise, calls another program `VV755R` to perform the unit swap logic, passing along company, item, and unit information.

### c. Program Exit (Label: `avslutt`)

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks the program for last-record processing and exit.

---

## 4. Subroutines

### a. `sjekk_sts3`: Check If Item Can Be Changed

This subroutine validates that the **item is eligible for a unit change** by checking:
- If the item exists.
- If a matching sales unit exists (and is active).
- If package conversion factors match between the old and new unit.
- If the itemâ€™s status is 'E' (eligible for "enhet" (unit) change).

Relevant section:

```rpg
c     sjekk_sts3    begsr
c                   eval      vvarl1_vare = p_vare
c     vvarl1_key    chain     vvarl1
c                   if        %found(vvarl1)
...
c                   endif
c                   endsr
```

#### Internal Loops and Checks:
- Iterates through possible packages and units.
- Checks if conversion factors and package validity periods match.
- If all checks pass, loads several fields into the display and marks `b_bytt = *on`.

### b. `sjekk_pkdato`: Check If Today's Date Is Within Package's Valid Period

```rpg
c     sjekk_pkdato  begsr
...
c                   endsr
```
- Checks various conditions to determine if the current date (`w_dato`) is within the valid "from/to" period for a package.
- Handles cases where one or both dates are "*loval" (lowest possible value, often means "unbounded").

---

## 5. Key List Definitions

Declared in `*inzsr`. Used for **database file lookups**.

```rpg
c     vvarl1_key    klist
c                   kfld      w_firm
c                   kfld      vvarl1_vare
```
- Each file access uses well-defined keys based on company, item, unit, or vendor.

---

## 6. User Interaction

- **exfmt b1bld**: The main display format.
- Function keys (`*inkc` or `*inkl`) allow the user to exit early.

---

## 7. Call to External Program

If all tests succeed, **calls `VV755R`** with necessary parameters to actually perform the unit change throughout the system.

---

## 8. Comments and Versioning

- The code is well-commented, in Norwegian.
- Version history is clearly tracked at the top of the program, showing maintenance and enhancements over time.

---

# Key Takeaways for Onboarding

- **Purpose**: This program checks if a product can have its sales unit changed in the system, and if so, calls a subroutine/program to effect that change.
- **Process**: Validation includes checking for the correct status, matching conversion factors, and valid date periods.
- **Interaction**: User is presented with a screen; if criteria are met, the change can be triggered.
- **External Calls**: The actual change logic is handled by a separate program (`VV755R`).
- **File I/O**: Relies heavily on keyed file access using composite keys.

## What to Look for as a Developer:

- **Data Definitions**: Make sure you understand the structure of the files being accessed.
- **Unit/Package Logic**: The business rules are encoded in the subroutines.
- **Key Lists**: File operations rely on correctly built key fields.
- **Date Handling**: Pay attention to how date validity is checked.

If changes are needed, they will likely be in the validation or preparation logic, or (if business rules change) in the criteria for eligibility for unit changes.