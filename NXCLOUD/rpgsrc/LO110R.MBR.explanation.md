# High-Level Overview

This RPG program, named `LO110R`, is part of a purchasing/order management application on IBM i (AS/400). The program manages the registration, modification, and inquiry of purchase orders ("bestilling/innkjøp"), containing logic for retrieving, validating, and updating orders as well as related master data like suppliers ("leverandør") and customers ("kunde").

The code is fairly typical for classic ILE RPG, making extensive use of externally described files, subroutines, indicators (`*INxx`), and data structures. It supports both creation of new orders and editing/viewing of existing ones.

---

# Main Sections and Functionality

## 1. File and Variable Declarations

- **Display & Database Files:**  
  `WORKSTN` is a workstation (screen) file. The program reads/writes to many physical files or logical files representing orders, order types, suppliers, customers, and so on.  
  The `RENAME` keyword is used to map external record names to local record formats.
- **Data Structures (`ds`/`DS`)**  
  Used for buffer overlays, storing intermediate values (dates, keys, text, etc.), and mapping file fields.
- **Program Variables**  
  Many variables are declared to handle fields like dates, numbers, keys, user info, and screen values.

## 2. Constants

- Lowercase and uppercase alphabets are defined as constants for easy case conversion.

## 3. Main Order Registration Logic

The core logic revolves around the `B1TAG` label and order-processing loop, which:

- **Processes function-key input** (like F3=Exit, F4=Inquiry, F10=Maintain header, F11=Free text),
- **Validates fields** for correctness (dates, types, supplier existence, etc.),
- **Loads or initializes order data** based on user action,
- **Routes to the appropriate subroutines** for further actions.

## 4. Field Validation

There is detailed validation of:

- **Order type** (must exist in the order type register),
- **Supplier number** (must exist and not be blocked or passive),
- **Date fields** (format checks, logical checks: delivery date >= order date, etc.),
- **Suffixes** (unique for new orders),
- **Confirmed delivery date** (must be >= order date),
- **Custom field-based validation** (driven from AVALPF/firmastyrt validering).

## 5. Data Retrieval and Storage

- **Retrieving Master Data:**  
  Order header and line information are pulled from their respective registers/files, along with customer and supplier details.
- **Updating/Creating Orders:**  
  Order header and related records are updated or inserted as needed; order number assignment is managed for new orders.
- **Interfacing with Other Programs:**  
  For text, order types, fixed info, and number assignment, it calls other programs (modularized business logic).

## 6. Subroutines

The program uses named subroutines for modularity:

- `MRKBES` - Marks an order as not being processed  
- `HNTLEV` - Fetches supplier data into the working fields  
- `HNTKUN` - Fetches customer data for delivery address  
- `HNTBES` - Loads order header info into the screen fields  
- `OPPBES` - Updates/saves the order header  
- `HNTNYT` - Gets the next available order number  
- `SPLEV` - Supplier inquiry  
- `OPLEV` - Create a new supplier  
- `HNTNUM` - Retrieves/updates number register  
- `Sjekk_lager` - Validates warehouse number  
- `*INZSR` - Program initialization  

## 7. Key Handling and File Keys

- Keys for all logical files are clearly defined using `KLIST` blocks.
- `CHAIN`, `READ`, `WRITE`, `UPDATE` operations use these keys to interact with the database.

## 8. Program Initialization (`*INZSR`)

- Resets various working fields and data structures.
- Loads default values from status and user registers.
- Retrieves today's date and time.
- Checks if extra field validation (firmastyrt validering) should be active.

## 9. Parameter Handling

- The entry parameter list allows the program to be driven by other programs or returned to with values set for order number, suffix, etc.

---

# Notable Features and Business Rules

1. **Versioning and Maintenance Notes:**  
   Extensive comments in the header track changes, bug fixes, and functional expansions over time, showing a mature production codebase.

2. **Field Overlay and Data Structure Usage:**  
   Overlaying buffers with fields allows flexible data manipulation for file writes/reads.

3. **Screen Handling and User Feedback:**  
   Indicator values are set for display error messages or to branch the workflow (e.g., *IN25, *IN26, etc.).

4. **Order Uniqueness and Suffixing:**  
   For new orders, the suffix must be zero; for editing, proper matching is enforced.

5. **Supplier and Customer Reference Integrity:**  
   Strong validation ensures referenced supplier/customer records exist and are not blocked.

6. **Date-Driven Validation:**  
   Order and delivery dates must be valid, reasonable, and non-conflicting.

7. **Firm-Specific Field Validation:**  
   At startup, the program reads the AVALPF file to check which fields require validation for this company.

8. **Logging and Audit Trail:**  
   When delivery dates are changed, a log entry is created via `LM900R`.

9. **Multi-Program Coordination:**  
   The program delegates detailed maintenance and text handling to specialized programs (e.g., `LO101R`, `LO104R`).

---

# Typical Flow

1. **Entry/Initialization:**  
   Load default values, fetch required status and user info, set up validation structures.

2. **User Input:**  
   Display main order entry/inquiry screen.

3. **Field Validation:**  
   Validate order type, supplier number, and all critical dates.

4. **Order Lookup/Update:**  
   If order exists, load for edit; if new, assign number and prepare for insert.

5. **Supplier/Customer Fetch:**  
   Retrieve and display associated data.

6. **Write/Update Records:**  
   Save changes to order header and detail lines; manage number register if needed.

7. **Extra Functions:**  
   Open additional screens for fixed info, free text, or order line maintenance as needed.

8. **Exit/Clean Up:**  
   Close out processing, release any marks, cleanup, and set return values.

---

# Special Code Constructs

- **Use of Extended Comments:**  
  The code documents not only the functional requirements but also historical context, which is invaluable for support and onboarding.
  
- **Conditional Compilation / Feature Switches:**  
  Changes between versions (e.g., 6.xx, 7.xx, 8.xx) are tracked inline.

- **Extensive Use of Indicators:**  
  IBM i RPG indicators are heavily used for both validation and screen control.

---

# Reading and Extending the Code

- **For New Developers**:  
  - Focus first on understanding the naming conventions for files and fields (usually prefixes).
  - Refer to the comments at the top for recent fixes and the rationale for business rules.
  - The procedural logic is "label and branch" oriented - use the tag names and structured subroutines to trace flows.
  - Note that screen files (WORKSTN) and display logic (EXFMT) are crucial for understanding user interactions.

- **When Modifying Code**:  
  - Look for the business logic subroutine you're aiming to change or extend.
  - Always consider the broad impact, as many fields and processes are interrelated (e.g., updating a date might trigger line logics).
  - Maintain version headers for traceability.

---

# Norwegian Terms

- "Bestilling" = Order/Purchase order
- "Leverandør" = Supplier
- "Kunde" = Customer
- "Ordretype" = Order type
- "Frislipper ordre ved retur" = Release order on return (business process)
- "Leveringsdato" = Delivery date
- "Bekreftet leveringsdato" = Confirmed delivery date

---

# Summary

**This program is a full-featured order registration and maintenance tool, deeply integrated with surrounding master data (suppliers/customers), featuring robust field validation, support for multiple maintenance screens, audit logging, and flexible configuration for firm-specific rules.**

**Onboarding advice:** New developers should focus on familiarizing themselves with the data structures, file interactions, and subroutines. The business logic is clear but densely intertwined, so careful tracing is key when debugging or extending functionality. The comments/history at the top are a valuable resource for context.