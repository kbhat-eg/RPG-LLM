# RL512R – Vendor Ledger Inquiry Program

## Purpose

This program, `RL512R`, is a core component of the ASOKON system for vendor (leverandør) ledger inquiry and analysis. It provides an interactive subfile-based user interface for displaying, navigating, and drilling into vendor transaction postings, including open items, all items, and accumulated balances. The program supports inquiry into related documents, such as invoices, credit notes, and associated notes (notatark), and integrates with archival and statistics modules.

The code is heavily annotated with change history, outlining ongoing enhancements for business requirements, regulatory changes, and system integrations.

## High-Level Structure

- **File Declarations:** Multiple physical files (vendor ledgers, vendor master, note blocks, etc.) are declared and renamed for local use.
- **Workstation File:** The display file (`RL512D`) is used with subfiles for the inquiry UI.
- **Data Structures:** Local data area, display feedback, and key structures for database access.
- **Variables:** Control flags, working fields, and parameters for subroutines and external program calls.
- **Mainline Logic:** Handles screen interaction, function key processing, subfile maintenance, and navigation.
- **Subroutines:** For subfile creation, clearing, positioning, display, and integration with related modules (notes, statistics, document archive).
- **Initialization:** Loads parameters, positions files, and initializes the subfile for the selected vendor.

## Key Business/Domain Logic

### Vendor Ledger Inquiry

- **Subfile Display:** The main user interface is a subfile listing vendor ledger items (open, all, or accumulated), supporting navigation (roll, rolldown), selection, and drilldown actions.
- **Selection Modes:** Users can toggle between "Open Items", "All Items", and "Accumulated" views. Only current fiscal year items are shown for "all items".
- **Currency Handling:** Supports toggling between NOK and foreign currency postings.
- **Aging Analysis:** Provides breakdowns by due date aging buckets (configurable, defaults to 30/60/90 days if not found in status code files).
- **Vendor Notes:** Integrates with a note block system at both vendor and posting level, visually flagging entries with associated notes.

### Drilldown and Integration

- **Drilldown Actions:** Users can select subfile rows to:
    - View posting details (`Vis post`)
    - View counter-postings (`Vis motpost`)
    - View the entire voucher (`Vis bilag`)
    - View associated invoice (`Vise faktura`)
    - Access document archive (`Vis arkiv`)
- **External Program Calls:** The program calls several other RPG programs for extended functionality:
    - `RL513R`: Counter-posting details
    - `RF512R`: Voucher details
    - `RL110C`: Invoice register
    - `AP622C`/`AH720C`: Document archive (ASP/Multiarchive)
    - `RS703R`/`RS707R`: Fetch payment terms and department text
    - `RF020R`: Note block maintenance

### Visual Cues

- **Color Coding:** Uses indicator bits to set colors for special statuses:
    - White for reclamation (`reklamasjon`)
    - Red for items sent for payment but not yet settled
    - Yellow for postings with an associated note block

### Data Relationships

- **Ledger Files:** Reads from several versions of the vendor ledger (open, all, historical) depending on the inquiry mode.
- **Vendor Master:** Fetches vendor name, balance, and status codes for aging configuration.
- **Status Code Files:** Used to configure aging buckets and other vendor-specific parameters.
- **Note Block Files:** Checked for existence of notes at vendor or posting level.
- **Archive Integration:** Handles both legacy and newer document archive systems, determines document type and reference dynamically.

## Design Decisions and Patterns

- **Subfile Paging:** Subfile page size is controlled by the constant `c_sfil`; paging logic maintains first/last record numbers and current page.
- **Indicator Usage:** The program uses RPG indicators extensively for both UI and internal control (see indicator documentation in the header).
- **Modular Integration:** External program calls are parameterized and abstracted, allowing for business logic to be encapsulated in specialized modules (notes, archive, statistics).
- **Flexible Key Structures:** Key lists (`klist`) are defined for all major file accesses, supporting dynamic positioning and efficient chained reads.
- **Backward Compatibility:** The code contains logic to support both old and new archive systems, and gracefully falls back to default behavior if new document type logic is not available.
- **Change Management:** The header contains a detailed change log, and the code is annotated with version tags (e.g., `T5.00`, `E5.40`) to clarify which changes apply to which releases.

## Notable Conventions

- **File Renaming:** Files are renamed locally to avoid naming conflicts and clarify their use within this module.
- **Field Naming:** Prefixes (`b1`, `b2`, `c2`, `e2`, etc.) are used to distinguish fields associated with different screens or subfiles.
- **Commented Code:** Some lines are commented out with double asterisks (e.g., `6.27 c**`) to indicate deprecated logic or for documentation purposes.
- **Parameter Passing:** Parameters for subroutines and external calls are always explicitly defined, often with overlays for data structures (e.g., note block parameters).

## File Interactions

- **Vendor Ledger Files (`RLTRL2`, `RLTRL9`, `RLTRL8`, `RLTRLU`):** Core data sources for vendor postings, open items, and historical entries.
- **Vendor Master (`RLEVL1`):** For vendor metadata and status codes.
- **Note Block Files (`RKLAL2`, `RKLAL3`):** For note existence checks at vendor and posting level.
- **Status Code Files (`RAA1L1`, `RAA3L1`):** For aging bucket configuration.
- **Workstation File (`RL512D`):** All user interaction is managed through this display file, with subfiles and control records.
- **Archive/Document Files:** Integration with both ASP and Multiarchive systems for document retrieval and display.

## Subroutines Overview

- **`forny`**: Refreshes the subfile, repositions files, and clears/rebuilds the list.
- **`posisjoner`**: Positions the ledger files and refills the subfile according to the current selection.
- **`subfile`**: Handles user interaction with the subfile, including selection and drilldown.
- **`clr_subfile`**: Clears the subfile and resets navigation variables.
- **`crt_subfile`**: Populates the subfile with ledger records based on current filters and modes.
- **`dsp_subfile`**: Manages display and user input for the subfile control screen.
- **`xc2win`**: Displays posting details, fetches related texts, and handles note block integration.
- **`xe2win`**: Performs aging and statistics calculations for the selected vendor.
- **`notat`**: Calls the note block maintenance program for the current vendor/posting.
- **`*inzsr`**: Initialization logic, including parameter loading and initial subfile population.

## Special Features

- **Aging Analysis:** The program calculates and displays an aging analysis of outstanding balances, using either vendor-specific or default buckets.
- **Multi-Archive Support:** Logic to handle document retrieval from multiple archive systems, with fallback to legacy methods.
- **Note Block Integration:** Visual indication and drilldown to notes at both vendor and posting level, including dynamic color changes for subfile rows.
- **Statistics:** Ability to display statistics and credit terms for the vendor, including average credit time and transaction counts.

## Business Rules/Logic Highlights

- **Drilldown Actions:** Only valid if the posting exists and the user has appropriate access.
- **Posting Selection:** Only one posting can be selected at a time for drilldown; multi-select is not supported.
- **Currency Filtering:** Only postings with a non-blank currency code are shown in "Valuta" mode.
- **Year/Period Filtering:** When toggling between modes, the program maintains the user's selected year/period for continuity.

## Integration Points

- **External Inquiry and Archive Programs:** The program is tightly integrated with other inquiry and archive modules, passing all necessary context for seamless navigation.
- **Notes/Annotations:** The note block subsystem is a shared component, called with consistent parameter blocks for both vendor and posting notes.
- **Payment Terms/Departments:** Fetches descriptive texts for payment and department codes from central code tables for display.

## Error Handling/Edge Cases

- **Empty Subfile:** If no postings match the current filter, a message is displayed in the subfile.
- **Invalid Archive Access:** If the user lacks permission, archive actions are skipped.
- **Fallbacks:** Defaults are used for aging buckets and document types if not found.

---

**In summary:**  
`RL512R` is a mature, business-critical inquiry program for vendor ledger management, featuring rich subfile navigation, drilldown, and integration with notes, statistics, and document archives. It is heavily parameterized, modular, and designed for extensibility and compatibility with evolving business requirements. Familiarity with the supporting files and external programs is essential for effective maintenance and development.