# RPG Program RK661R - Customer Interest Note Selection and Calculation

This program processes customer receivables and calculates interest for overdue amounts, preparing data for interest notes (rentenota). It selectively processes customer records and their open items, applying business rules for interest calculation, minimum thresholds, and exclusions. The code features extensive handling of partial payments, reference matching, and updates to related files.

Below is a structured explanation focused on onboarding a new RPG developer.

---

## 1. **Program Options and Control**

- `h option(*nodebugio) datedit(*dmy)`: Specifies no debug I/O and date format as day/month/year.

---

## 2. **File Declarations (`F-Specs`)**

Each file is defined with device type and record format renaming:
- Customer master, open item, posting, and various code tables are used.
- `prefix(x:1)` is used for one of the files to avoid field naming conflicts.

Key files:
- `rkunl1`, `rktrl2`, `rktrlc`, `rktrl8`: Customer and open items.
- `raa3l1`, `raa6l1`, `ra01l1`, `ra11l1`: Various code/parameter tables.
- `rkwbpf`, `rkwblu`: Work files for output/postings.

---

## 3. **Data Structure and Variable Declarations (`D-Specs`)**

- Dates (`w_kdat`, `w_rfda`, `w_rtda`, etc.), counters, numeric values (interest, sums), and arrays for customer selections.
- Local fields for keys and work calculations.
- Parameters/fields passed to or used by the program are mapped as subfields via `uds` (User Defined Structure).

---

## 4. **Main Processing Logic (`C-Specs`)**

### **a. Customer Loop**

- The program loops through the customer master (`rkunl1`), reading records matching the key.

#### **Selection Filters**
- Excludes customers based on "no interest" or "no collections".
- Applies filter criteria from input parameters:
    - Department (`avdeling`)
    - Category
    - Seller
    - Customer number range or specific customers (via array).

#### **Interest Rate Determination**
- Default interest rate is set from parameter; if the customer group has a specific rate, it overrides the default.

#### **Process Customer's Open Items**
- Calls subroutine `les_post` to process open items (invoices, etc.) for the selected customer.

#### **Interest Threshold**
- At the end of each customer, if total calculated interest is below the minimal threshold, related work file entries are deleted (via `slett_post`).

---

### **b. Subroutine: `les_post` (Process Customer Items)**

- Loops through open items/postings (`rktrl2`) for each customer.
- Skips postings already marked as "no interest", already interest-calculated, too small, for future periods, or special cases (e.g., collection, complaints).
- **For negative amounts:** special logic determines if interest applies, and only if certain thresholds/days are met.
- **For fully unpaid past-due items:** calculates interest for overdue period.
- **For partially paid or no reference:** handles accordingly.
- **If references are set (partially paid with reference):** calls `les_motpost` to process matched payments.
- Each valid calculation writes a record to the work output file (`rkwbpf`), with interest, run dates, number of days, and so on.
- The calculation increments a counter and sets a timestamp per transaction.

---

### **c. Subroutine: `les_motpost` (Process Matching/Offset Postings)**

- Handles the matching of partial payments or allocations.
- Searches for transactions referencing the current posting (by references and bilagsnummer).
- Reduces the interest base amount by any matched payments.
- Further checks for cases where no reference matches are found but the rest amount is zero, allowing it to mark the posting as completed.

---

### **d. Subroutine: `beh_motpost` (Handle Single Matched Posting)**

- Determines if the matched posting affects the original item's interest calculation.
- If payment date is before or on the posting/interest date and the interest base reduces to zero, marks as not to be interest-calculated.
- If payment is after interest date or for positive rest, updates interest calculation base.
- Writes posting to output file if interest is correctly calculated and above minimum days/amount.
- Adjusts dates and references accordingly.

---

### **e. Subroutine: `beregn` (Calculate Interest)**

- Calculates number of interest days.
- Ensures no negative days.
- Calculates interest as:  
  `interest = base amount / 100 * interest rate / 360 * days`
- Caps interest at maximum allowed.

---

### **f. Subroutine: `slett_post` (Delete Work File Items for Under-Threshold Interest)**

- Deletes all work file records for a customer if total interest is below the threshold.

---

### **g. Subroutine: `oppdat_post` (Mark Posting as Interest-Processed)**

- Updates open items to mark as "interest processed" if fully paid and meets criteria.
- Adds timestamp and user for audit tracking.

---

### **h. Subroutine: `*inzsr` (Initialization)**

- Sets up keys for file access, maps input parameter values, and pre-loads control tables.
- Sets company code, zeroes out work variables, etc.

---

## 5. **General Business Rules/Features**

- **Interest is not calculated** for items not yet due, too small, already flagged, in future periods, in collection, or marked as a complaint.
- **Negative balances (credit notes/refunds):** Only included if allowed by parameter settings.
- The program **tracks and marks postings** as processed to prevent double interest.
- **Special logic for matched payments** ensures that only correct unpaid amounts are used as basis for interest, even across multiple-part payments.
- **All actions are well-audited** with timestamps and user codes.

---

## 6. **Other Features**

- **Extensive Norwegian business terminology**: "kunde" = customer, "rente" = interest, "bilagskode" = transaction code, "forfalt" = overdue, etc.
- **Modular and revision-marked code**: Comments indicate which developer added each business requirement.
- **Change history and versioning** provide context to the maintenance history.

---

## 7. **Where to Dig Deeper**

If onboarding:
- Familiarize yourself with the structure and content of the various files (`rktrl2`, `rktrlc`, `ra01l1`, etc.).
- Understand the business logic: When is interest calculated, and when not? (Use the comments for business rules!)
- Look for usage of local variables and how parameters (input fields) are mapped and used.
- The calculations and reference handling for matched payments can be trickyâ€”read the `les_motpost` and `beh_motpost` subroutines carefully.

---

**In summary:**  
This program is designed to select the correct customer open items for interest calculation, performing complex business-rule filtering and maintaining audit controls, writing results to a work file for subsequent processing (interest notes). It is modular, thorough, and reflects extensive business-process customization over many years.