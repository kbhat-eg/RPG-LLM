# Program Overview

This ILE RPG program, `RN002R`, is a transaction interface program. Its primary function is to read entries from a document/voucher transaction file (BOVF) and write to a NAV transaction file (IBUTST), with considerable logic for data transformation, cross-referencing, validation, and business rule compliance. It makes use of several files, SQL queries, and external programs for various lookups and processing steps.

## Header Specifications

- `h option(*nodebugio)`: Compile with no debug data for I/O operations.
- `h datedit(*dmy)`: Date fields expect day/month/year format.
- `h decedit('0.')`: Decimal data expects period as decimal separator.

## Files

**Input/Output and lookup files (with record format renames):**

- `bovfl1` – Base transaction file (input).
- `ibutst` – Target transaction file (output).
- Other files like `sohel1`, `ikonir`, `lstsl1`, `rkunl1`, `raa1l1`, `aforl1` are used as lookup/reference/validation.

Each file is opened/declared in traditional fixed-format, with key (`k`) access and external data structure names.

## Data Definitions

### Constants

- `lo` / `up`: For lowercase/uppercase translation (including Norwegian characters).

### Local Data Area

- `l_filg`, `l_firm`, `l_user`: Used to receive company/file/user info from the LDA.

### Working Variables

Variables for keys, processing, and temporary storage:
- `w_firm`, `w_date`, `w_time`: For company number, current date/time.
- `w_bilk`, `w_kidr`, `w_aarr`, `w_kidd`, `w_kida`, etc.: For carrying data between files and processing.
- `w_btex`, `w_sumd`, `w_sumk`, `w_antp`, etc.: Used in "bong" (cash receipt) handling.
- `w_biln`: Voucher number (bilagsnummer).
  
Flags and Switches:
- `b_posb`, `b_siste`: Control "bong" (batch) processing.
- `w_sant`: Indicates whether Santander process rules are in force.
- `w_langk`, `u_ikknl`: Flags for handling KID (customer identification) numbers.

### Prototypes and External Program Calls

- External program `CO402R` is called to retrieve configuration/switch information.

### SQL Options

- SQL set to ISO date, "no commit" mode, and Norwegian language settings.

## Main Processing Flow

### Initialization

- Sets up key fields and assigns initial values.
- Reads company info from LDA.
- Reads conversion info/status tables for special processing rules.
- Checks if voucher numbering per "bong" (receipt) is in effect, and initializes accordingly.
- Determines if "long" or "short" KID codes are used.
- Checks if the company uses "Santander" rules.
- Determines if short KID should be removed when long KID is used.

### Loop Over Transactions (BOVFL1)

1. **Read Each Record**

   Main loop iterates over all BOVFL1 records (source transactions).

2. **Skip Zero-Sum Transactions**

   If the voucher amount is zero, the record is skipped (`goto les_neste`).

3. **Voucher Number Handling per Bong**

   If voucher-per-bong logic is enabled:
   - Checks if the voucher text changed (indicating a new "bong").
   - If so, runs subroutine to finalize previous bong and get new number.
   - Updates running totals and assigns current voucher number.

4. **Voucher Code Conversion**

   For certain voucher codes (e.g., for rounding), the code is cross-referenced/converted using `IKONIR`.

5. **KID (Customer Reference) Lookup**

   Subroutine `finn_kid` attempts to find corresponding KID value through a prioritized search (via SQL from BREFPF, SOHEPF by invoice or credit ref).

6. **Prepare Output Record**

   Fills IBUTST fields using the processed/derived values. Special rules:
   - If it's a credit transaction (`bfckto`), amount is negated.
   - If account matches customer number, KID fields are filled accordingly.
   - Some fields are "hardcoded" or controlled via configs (e.g., type = 'FAKT', payment condition, etc.).
   - If KID is long and flag indicates so, short KID is blanked out.

   Special logic applies for companies using "Santander" (KID only for matching customer names).

7. **Bong Number Extraction**

   Bong number is parsed/extracted from text, if available.

8. **Deposit Payment Check**

   If there's a credit reference, a lookup is performed (subroutine) to flag deposit payments.

9. **Output the Record**

   Writes the transformed record to the IBUTST output file.

10. **Handle Next Record**

    Continues the loop; at EOF, if voucher-per-bong processing is enabled, finalizes the batch.

### Subroutines

#### 1. **finn_kid**
Attempts to find a KID reference number:
- **Priority order:**
  1. SQL select from `BREFPF` by company and voucher.
  2. SOHEPF file lookup by invoice number.
  3. SOHEPF file lookup by credit reference.

#### 2. **ny_bong**
Handles the end/start of a voucher "bong" batch:
- On first call, fetches batch id, deletes old logs.
- Inserts a new batch log record with summary amounts.
- Updates child line items to link to new voucher number.
- Clears running totals, fetches new voucher number if not at last batch.

#### 3. **hent_bilag**
Calls an external program to retrieve and assign a new voucher number for the next bong batch.

#### 4. **sjk_depo**
Checks if the order for the current bong has a deposit; flags output accordingly (`ibdepo` field).

## Keylists

Traditional RPG keylists are used for positioning/lookups in files, especially for multi-field composite keys.

## Special Processing

- **Euro Rounding and Voucher Code Conversion:** Handles conversion of voucher codes for "øreavrunding" (rounding adjustments).
- **KID Handling:** Chooses between short and long KID, clears short if config says so.
- **Company-Specific Logic:** Detects if company uses "Santander" processing, and applies special KID assignment rules.
- **Integration with SQL and CL/RPG subprograms:** For config, parameters, and more complex business logic.

---

# Summary for New Developers

- This program is a "bridge" between financial transaction files, mainly populating the NAV/IBUTST transaction file from BOVF transactions with enforced company- and customer-specific business logic.
- It uses both native RPG database operations and embedded SQL for lookups, and it delegates complex or centralized logic to other programs.
- There are many "versions" and historical changes reflected in comments, showing this code is long-lived and has evolved with business needs (e.g., new companies, new handling for KID numbers, etc.).
- Voucher number assignment can be basic or per "bong" (receipt batch), and handling of KID/customer references is configurable and robust.
- You will need to understand both legacy RPG fixed-format code and modern free-format (especially in subroutines).
- Frequent use of keylists and complex record structures means understanding the database/file layouts is important.

## Key Takeaways

- **Main job**: Transform and move records from BOVF to IBUTST, applying business rules.
- **Handles**: KID assignment, voucher numbering (potentially per receipt), customer-specific overrides (especially for Santander logic), transaction validation (skip zero-amounts), and logs/voucher tracking.
- **Integration points**: Many cross-file lookups and calls to external programs (both RPG pgms and SQL).
- **Heavy use of**: Embedded SQL, keylists, cross-system business logic.
- **Good starting points**: Understand file layouts, keylist usage, main loop and how subroutines are invoked for business rule compliance.

---

For someone onboarding:

- Focus on understanding BOVFL1 and IBUTST file layouts.
- Trace how KID, voucher code, and bong logic are applied.
- Familiarize with the interplay between RPG operations and SQL.
- Note the extensive use of flags and version-specific comments—it helps to know where and why certain logic was added.
- If troubleshooting or enhancing, double-check cross-referenced company, customer, and config data.

---

This code is a representative example of a mission-critical IBM i RPG application, blending legacy techniques with modern enhancements to support complex real-world business logic.