# Program Overview

This program (“FTPVEDLR”) handles the maintenance of FTP transfers for the ASFTP system. It provides subfile-driven screens that allow the user to view, add, change, delete, copy, or schedule FTP records in a job plan. It also supports interactive commands to restart or position the subfile based on certain keys (like host name or a generic identifier).  

## Files and Data Sources

- **AFTPLR / AFTPLU / AFTPL1 / AFTPL2**  
  These physical files (opened with RENAME clauses) hold the core data about FTP transfers. The program uses different file formats (e.g., AFTPLR vs. AFTPL1) for reading the same underlying data in different keyed ways.  
  - AFTPLR and AFTPLU appear to store the same type of data (FTP setup) but may differ in record locking or status fields.  
  - AFTPL1 and AFTPL2 are used for alternative keyed views, especially when the program needs to search by host.  
- **Local Data Area**  
  The fields `l_firm`, `l_fnav`, and `l_user` come from the user data area. Particularly, `l_firm` is used as part of the primary key in each file, and `l_user` is used in certain updates.

## Subfile Design

The program uses a typical RPG subfile flow with:
- A control format (B2CTL)  
- A subfile record format (B1SFL)  
- Additional displays or windows like B2CMD, C1BLD, C2BLD, C3BLD, D1WIN, and K1WIN to handle different operations.

Key subfile variables:  
- `w_srrn`: The current relative record number in the subfile.  
- `w_spge`: The subfile page size.  
- `w_sfrn` and `w_ssrn`: The first/last record number on a page.  
- `b1valg`: The user’s selection input in each subfile record (2=Change, 3=Copy, 4=Delete, etc.).  

Upon subfile interactions:  
1. The program reads each subfile record with `READC` (monitored by indicator 16).  
2. It checks the selection field (`b1valg`) and performs the requested operation (e.g., call a maintenance subroutine, open a window).  
3. If the operation changes the data, the program updates the record and iterates (`ITER`) to handle the next record.

## High-Level Flow

1. **Initialization**  
   - The `*INZSR` subroutine sets up keys, reads the local data area, and positions the database to build the initial subfile.  
   - The subfile is filled using `crt_subfile`.

2. **Main Display Loop**  
   - The program continuously shows the subfile control format (B2CTL) and a small command format (B2CMD).  
   - Various indicators (`*INKC`, `*INKL`, `*INKE`, etc.) correspond to function keys pressed by the user.

3. **Function Key / Command Handling**  
   - F3 / F12 (or equivalent) ends the program (labels `avslutt` or checking for `*INKC`/`*INKL`).  
   - F5 calls the `forny` subroutine to clear and rebuild the subfile from newly positioned data.  
   - User can position directly by entering a name (b2navn) or a host (b2host). The `posisjoner` subroutine sets the relevant key (`w_seqe`) and re-creates the subfile.  
   - F10 triggers `crt_subfile` again to roll forward.  

4. **Subfile Interactions**  
   When subfile lines are read via `READC`:
   - Selection “2” → Edit (xc2bld).  
   - Selection “3” → Copy (xk1win → eventually xc2bld).  
   - Selection “4” → Delete (xd1win).  
   - Selection “5” → Inquiry or display (xc2bld in a protected mode).  
   - Selection “6” → Place the entry in a job plan (xc3bld).  
   - Selection “7” → Submit an FTP job (via SBMJOB or direct call to AF700C).  
   - Selection “8” → Display FTP log (AF110R or AF701C).  
   - Selection “9” → Release a blocked transfer (afstat cleared).  

5. **Screens / Windows**  
   - **C1BLD** (xc1bld): Create a new FTP record. If the user enters a name that already exists, the system shows C1MSG (xc1msg) so the user can confirm or cancel.  
   - **C2BLD** (xc2bld): The main edit/display routine. It loads record data from AFTPLR / AFTPLU, populates fields on the screen, and updates (or creates) if valid.  
   - **D1WIN** (xd1win): A window to confirm record deletion.  
   - **K1WIN** (xk1win): A window for copying an existing entry to a new key.  
   - **C3BLD** (xc3bld): A simple input screen that sets scheduling parameters for the job plan, then calls AF702C.  

6. **Key Domain Logic and Indicators**
   - `afstat` can indicate whether a record is “blocked” (B). Some operations are skipped if blocked.  
   - `afjscd` indicates if a record is in the job plan. Setting this to “J” and calling AF702C anchors the record into a recurring or one-time schedule.  
   - `b_forn` triggers a subfile refresh after certain operations so the updated data becomes visible.  
   - `b_oppr` marks that the user is creating a new record (used in the “new record” subroutine flows).  
   - The program can submit jobs in two ways:  
     1. SBMJOB to QCMDEXC (when function key conditions match).  
     2. Direct call to AF700C or AF701C for immediate running or logging.  

7. **Refilling and Positioning**  
   - The subroutines `clr_subfile` and `crt_subfile` handle clearing and populating the subfile.  
   - The variable `w_seqe` decides whether to read from AFTPL1 or AFTPL2. This lets the user switch between sorting by name or by host.  

8. **External Program Calls**  
   - **AF700C**: Starts or runs an FTP process.  
   - **AF110R** / **AF701C**: Likely show or retrieve an FTP log.  
   - **AF702C**: Schedules the current transfer in the job plan.  
   - **AF500R**: Additional retrieval or validation logic, triggered from the C2BLD or C3BLD process.  

## Notable Considerations and Conventions

- Several subroutines rely on the same data structures but switch keys dynamically (e.g., `setll` on AFTPL1 vs. AFTPL2). This allows flexible lookups (by name or by host).  
- The indicators 31, 32, etc. are used for displaying user error messages on certain input fields (e.g., blank name, record already exists).  
- The use of local data area (`l_user`, `l_firm`) ensures each record is tied to the correct firm code or user context.  
- “Blocked” (“B”) records cannot be deleted or copied as a safeguard.  
- For scheduling, default values (e.g., *CURRENT, *NONE) are assigned to various date/time fields so that the user can skip them if they don’t need custom scheduling.  

## Summary

This program orchestrates all the maintenance tasks for FTP definitions in the ASFTP environment. It utilizes multiple keyed logical files for positioning, updates information through screen-based subfiles, and integrates with separate modules (AF700C, AF702C, etc.) to run or schedule the transfers. Most of the flow is driven by subfile selection fields and function keys, allowing operators or administrators to manage large numbers of FTP configurations efficiently.