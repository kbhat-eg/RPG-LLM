## Program Overview

This program (`VA565R`) is part of the ASOFAK system and is responsible for querying and displaying "Bounstype" (likely "Bonustype" or bonus type) information. It provides a subfile-based interactive display for users to browse, search, and select bonus types, supporting navigation, positioning, and selection within a subfile display. The program is written in traditional (fixed-format) RPG IV and is designed for use with IBM i (AS/400) interactive workstation displays.

---

## Main Functional Components

### 1. File Definitions

- **vbotl1, vbotl2**: Physical files (`vbotpfr`) accessed via two logical views (`vbotl1r`, `vbotl2r`), keyed for different access paths (by bonus type and description).
- **va565d**: Workstation display file, using subfile `b1sfl` with relative record number `w_srrn`. The display feedback data structure (`dspfbk`) is used for cursor management and feedback.

### 2. Parameters

- **p_firm**: Company/firm identifier.
- **p_tbot**: Bonus type parameter.
- **p_tbes**: Bonus description parameter.

These are passed into the program to control the initial positioning and filtering.

### 3. Key Data Structures & Variables

- **Subfile Control**: Variables such as `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`, etc., manage subfile paging, record numbers, and navigation state.
- **w_seqe**: Determines which logical view (by type or description) is active.
- **b_valg_ok**: Indicates if a valid selection has been made.

### 4. Indicators

The program uses standard indicator conventions:

- `LR`: End program.
- `10`, `11`: Roll up/down.
- `12`, `13`, `14`, `15`: Subfile display and control.
- `21`, `22`: Home key and cursor placement.
- `30`: Field protection.
- `31-79`: Error/warning indicators.
- `80-99`: Work indicators.

---

## Program Flow

### Initialization (`*inzsr`)

- Receives parameters and sets up keys for the two logical file access paths.
- Initializes the display and subfile, positioning at the start.

### Main Loop

1. **Display Command Screen**: Writes `b2cmd` (command keys screen).
2. **Display Subfile**: Calls `dsp_subfile` to show the subfile contents.
3. **Function Key Handling** (`select` block):
   - **Exit** (`F3/F12`): Ends program.
   - **Refresh** (`F5`): Calls `forny` to refresh subfile contents.
   - **Roll Up/Down** (`F10/F11`): Calls `crt_subfile` or `bck_subfile` to page through subfile.
   - **Home Key**: Sets up cursor repositioning.
4. **Positioning**: If the user enters a bonus type or description, the subfile is repositioned accordingly.
5. **Subfile Processing**: Handles selection within the subfile; if a valid selection is made, the program exits.

---

## Subroutines

### `forny` (Refresh Subfile)

- Repositions the file pointer based on the current view (`w_seqe`), clears, and rebuilds the subfile.

### `posisjoner` (Position Subfile)

- Allows the user to jump to a specific bonus type or description.
- Updates keys and view selection, clears and rebuilds the subfile, and resets positioning fields.

### `subfile` (Subfile Processing)

- Alternates the cursor indicator for visual feedback.
- Reads subfile records; if a row is selected (`b1valg = 1`), sets output parameters and marks selection as valid.

### `clr_subfile` (Clear Subfile)

- Sets indicator to clear the subfile and resets all related counters and pointers.

### `crt_subfile` (Create/Fill Subfile)

- Pages forward, reading records from the current logical file and writing them to the subfile until the page is filled or EOF is reached.
- Handles both access paths (by type or description) based on `w_seqe`.
- Sets indicators for end-of-subfile and updates subfile pointers.

### `bck_subfile` (Page Backwards in Subfile)

- Pages backwards through the logical file, repositions, and refills the subfile for previous page navigation.

### `dsp_subfile` (Display Subfile)

- Displays the subfile control screen with appropriate display indicators.
- Updates the current cursor position from the display feedback structure.

---

## Business and Domain-Specific Logic

- **Dual Access Paths**: The program supports navigation by both bonus type and description, using two logical files (`vbotl1` and `vbotl2`). The choice is determined by the user's input in the positioning fields.
- **Subfile Paging**: Paging is handled manually, with explicit management of record numbers and subfile indicators. The page size is set by constant `c_sfil` (8 records per page).
- **Selection Logic**: The user can select a bonus type from the subfile, which is then returned via parameters.
- **Display Feedback**: The program uses a display file feedback data structure to manage cursor positioning and user interaction state.

---

## Design Patterns and Conventions

- **Tag/Label-Based Flow**: The program uses RPG tags (`tag`, `goto`) for flow control, which is common in traditional RPG applications but less so in modern free-form code.
- **Indicator Management**: Follows the classic RPG indicator usage, with a clear separation between display, control, error, and work indicators.
- **Explicit Subfile Management**: The code handles all aspects of subfile loading, clearing, and paging, rather than relying on implicit mechanisms.

---

## Interactions with Other Modules

- **Database Files**: Reads from `vbotl1` and `vbotl2` logical files, which are views of the `vbotpfr` physical file. The structure and content of these files are central to how bonus types and descriptions are displayed and selected.
- **Display File**: Interacts with `va565d`, which defines the subfile (`b1sfl`) and control/command screens (`b2ctl`, `b2cmd`).

---

## Summary Table of Key Variables

| Variable         | Purpose                                                    |
|------------------|-----------------------------------------------------------|
| `w_fcrn`         | First record number on the page (for subfile paging)      |
| `w_stel`         | Subfile counter (for paging logic)                        |
| `w_spge`         | Subfile page size                                         |
| `w_srrn`         | Relative record number in subfile                         |
| `w_sfrn`         | First record number on the last page                      |
| `w_ssrn`         | Last record number on the last page                       |
| `w_seqe`         | Current access path: blank = type, 'B' = description      |
| `b_valg_ok`      | Indicates if a valid selection has been made              |
| `w_firm`         | Current firm/company                                      |
| `vbotl1_tbot`    | Key field for bonus type access path                      |
| `vbotl2_tbes`    | Key field for description access path                     |

---

## Notable Implementation Details

- **User Positioning**: The program allows users to jump directly to a specific bonus type or description, which is not always standard in subfile applications.
- **Two-Level Navigation**: By supporting both bonus type and description access paths, the program provides flexible navigation for end-users.
- **Manual Subfile Control**: All subfile operations (clear, fill, page, etc.) are handled explicitly, allowing granular control but requiring careful indicator and pointer management.

---

## Conclusion

`VA565R` is a traditional RPG subfile program for querying and selecting bonus types. Its dual access paths, explicit subfile management, and thorough indicator usage are characteristic of legacy IBM i applications, and understanding its flow is crucial for extending or integrating with this part of the ASOFAK system. The program interacts primarily with the `vbotpfr` file (via two logical views) and the `va565d` display file, returning user selections via parameters.