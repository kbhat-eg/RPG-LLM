# RPG Program GL107R - Batch File Overview and Processing for Remitting

This ILE RPG program, as indicated in the title and comments, is a subprogram (GL107R) for transferring batches to the payment remitting system (DIRREM). The main program is RL106R. The comments and structure explain both the business process and technical approach.

## 1. **Overall Purpose**

- **Operational Context:** Supports Norwegian payment/remittance operations. Works with batch files that are processed and transferred to an external system (DIRREM).
- **Functionality:** Views, deletes, processes, and maintains batch records/files, and updates sequence numbers for control purposes.

## 2. **Files Used**

Many physical files (disk files) are declared at the top, related to different batch types (GU00L1, GU01L1, etc.), suggestion/proposal-files (GUBFL8), supplier transactions (RLTRLU), sequence number files (GUSTPF), and fixed settings (GFASPF). Display file GL107D is used for user interaction.

- **Example:**  
  `fgu00l1    uf   e           k disk`
  - "uf" = User open file
  - "e" = externally described
  - "k" = keyed access
  - "disk" = physical file

- **Display File with Subfile:**
  ```
  fgl107d    cf   e             workstn
  f                                     sfile(r1wsf:srrn02)
  ```
  - Indicates the use of subfiles for record display.

## 3. **Indicator Usage (from Comments)**

- Special use of RPG indicators (e.g., KC/KF/KL for function keys, 10/12/13/14/15/16 for subfile control, 60-69 for file access).

## 4. **Key Data Structures and Fields**

- **Dates:** Several data structures for handling dates (discount dates, due dates, original due date), overlaid for easy field extraction.
- **Subfile Management:** Fields like srrn02, spge02, sfrn02, ssrn02 are subfile-related, managing line numbers, pages, etc.
- **Batch Variables:** Many fields prefixed with 'wp' (work parameter) are used for batch identification and control.
- **Parameter Management:** The *entry parameter list (with fields like wpfgrp, wpfirm, wpride, wpbfnr, wpvalg, etc.) is used for passing values in and out of the program.

## 5. **Mainline Logic (Processing Selection)**

- **Show batch content:** If `wpvalg = '5'`, set up and call routine to display batch contents (`xc5bld`).
- **Delete batch:** If `wpvalg = '4'`, call deletion routine (`xc4bld`).
- **Transfer to remitting:** If `wpvalg = 'O'`, call transfer routine (`xoverf`).
- **Update sequence numbers:**
  - 'O' or 'P': get next sequence number (`xførst`)
  - 'S' or 'T': update last-used sequence numbers (`xsiste`)
- After most actions, it checks if F12 (cancel) is pressed to exit.

## 6. **Subroutines and Their Responsibilities**

### A. **Subfile Handling**

- **xclr02**: Clears (empties) subfile 2, resets record/page counters and flags.
- **xcrt02**: Fills subfile 2 with records from GUBFL8 matching certain criteria, handling both domestic ('TBII') and foreign ('TBIU') batches.
- **xdsp02**: Displays subfile 2 if it contains data.

### B. **Batch Deletion (`xc4bld`)**

- Determines if there are one or two batches for a proposal number (domestic and/or foreign batch).
- Special handling:
  - If both types exist, marks records as obsolete ('U') in the suggestion file (GUBFPF) using line numbers found in transaction files (GU04L1, GU23L1).
  - If only one batch exists, clears the status to blank for all related suggestion file records.
- Physically deletes all batch records across related files (GU00L1, GU01L1, ... GU99L1).

### C. **Show Batch Records in a Window (`xc5bld`)**

- Prepares and positions a window.
- Clears and refills subfile 2, writes the command window, and displays the subfile.
- Handles roll/scroll, positioning, and user selection for viewing details (`xc2bld`).

### D. **Display Proposal Details (`xc2bld`)**

- Reads the selected record from GUBFL8.
- Maps data into the display fields for viewing (and potentially changing, though in this implementation changes are not allowed).
- Handles additional data mapping for date fields, status, reference numbers, etc.
- Handles special cases for null/blank dates, setting zeros if required.

### E. **Transfer to Remitting (`xoverf`)**

- Reads through suggestion file (GUBFPF).
- For records marked 'U' (obsoleted) and not payroll (date field check), deletes the record and clears related transactions.
- For non-obsolete records, unlocks the record (possibly to release locks from previous processing).

### F. **Get and Update Sequence Numbers (`xførst`, `xsiste`)**

- **xførst:** Determines which sequence number (daily/own/common) to use based on settings and processing type. Handles logic for year transitions, and updates files as needed.
- **xsiste:** Updates daily and own/common sequence numbers after processing is done.

### G. **Initialization (`*inzsr`)**

- Sets up the entry parameter list.
- Initializes working variables and key lists for files.
- Key lists are used for all relevant database accesses.

## 7. **Key Lists**

- Multiple named key lists (`key01` through `key08`) define compound keys for accessing files with CHAIN, SETLL, and READE operations. These are defined based on batch group, firm, batch number, and type.

## 8. **Subfile Pattern**

- Subfiles are used for batch display and selection.
- The program supports paging (roll/scroll) and positioning, with indicators and logic for maintaining which records are currently visible.

## 9. **Business Logic Highlights**

- **Batch Types:** Handles both domestic and foreign batches, often needing to coordinate actions between them.
- **Proposal Status (`GASTAT`):** Used to mark records as obsolete or active.
- **Batch Deletion:** Physically removes all related records from a series of files when a batch is deleted.
- **Synchronization:** Carefully updates sequence counters in master files, supports both "own" and "shared" counters, and resets counters at appropriate times (e.g., new day, end of process).

---

# **Summary Table of Important Sections**

| Section | Purpose                           | Key Actions                                                      |
|---------|-----------------------------------|------------------------------------------------------------------|
| Files   | Batch, Suggestion, Transaction    | Open, Read, Update, Delete                                       |
| Indicators | Control flow & subfile mgmt    | Function key, subfile, state indicators                          |
| Subfile Management | Display/Edit/Select    | Clear, Fill, Display, Position, Read/Change subfile rows         |
| Batch Deletion | Remove batches             | Mark suggestion records, delete batch records from all files     |
| Batch View    | Show batch in a window      | Position window, fill subfile, display details                   |
| Sequence Update | Numbering/control         | Get/update own/common/daily sequence numbers                     |
| Initialization | Set up environment         | Set parameters, zero variables, define keys                      |

---

# **How It All Fits Together**

- **Entry:** Program is called with batch info and a control parameter (`wpvalg`) specifying which action to take.
- **Processing:** Depending on the action, it will show, delete, or transfer a batch, or update sequence numbers.
- **Subfiles:** For user interaction and batch record display, subfiles and windows are used with RPG’s display file support.
- **Files/Updates:** Changes are reflected in multiple files to keep all record types in sync (proposals, transactions, master files).
- **Indicators/Keys:** Heavy use of indicators for program logic and IBM i key lists for efficient keyed access to files.

---

# **Key Points for a New Developer**

1. **Read comments—they are extensive and business-focused, helping understand logic.**
2. **Understand the role of each file, especially batch and proposal files.**
3. **Follow the indicator map—these are crucial for subfile and database handling.**
4. **Batch actions (view/delete/transfer) are modularized into their own routines (subroutines).**
5. **Sequence number management ensures unique and correct remittance batches.**
6. **Look at how subfiles are built and maintained—it’s a classic RPG pattern for handling lists.**
7. **Data structures for date handling are critical for correct processing (year-2000 handling is evident).**
8. **Beware of field overlays and the use of MOVE/MOVEL for field assignments.**

---

# **Final Takeaway**

This program is a classic IBM i RPG solution for managing and processing payment/remittance batches, with robust subfile (list) handling, batch management routines, and strict sequence control—designed for reliability, accuracy, and user control in a finance/payment processing context.