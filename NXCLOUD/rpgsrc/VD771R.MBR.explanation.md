## Program Overview

**Program Name:** VD771R  
**System:** ASOFAK  
**Purpose:**  
This program checks if a product (vare) exists in a product assortment (varesortiment) of type 'C' (central warehouse assortment).  
It is meant to be called with a set of parameters and returns a status flag indicating whether the product is found.

**Special Notes:**
- The LR (Last Record) flag must be set to '1' for the program not to set *INLR automatically.
- The program is written in legacy fixed-format RPG IV, with some custom conventions (see below).

---

## Files and Data Structures

### Physical Files

- **VSHEL3** (Assortment Header)
  - Renamed record format: `vshepfr` → `vshel3r`
  - Holds assortment headers, filtered by type (primarily 'C' for central warehouse).
- **VSDTL6** (Assortment Detail)
  - Renamed record format: `vsdtpfr` → `vsdtl6r`
  - Holds the details of which items are included in which assortments.

### Local Data Area (*LDA)
- Used to extract group and user information, but not used in business logic here.

### Key Fields and Variables

- **vshel3_type**: Assortment type (looking for 'C')
- **vsdtl6_vsor**: Assortment number
- **vsdtl6_lage**: Warehouse number
- **vsdtl6_vare**: Product number
- **p_firm**: Firm/Company number (input parameter)
- **p_vare**: Product number (input parameter)
- **p_lage**: Warehouse number (input parameter)
- **p_stat**: Output status (set to '1' if product found in assortment)
- **p_inlr**: LR flag (input parameter, controls program end behavior)
- **w_firm**: Working firm variable (copied from parameter)

---

## Program Flow

### 1. Initialization (`*INZSR`)
- Receives parameters (firm, warehouse, product, status, inlr).
- Sets up key lists for file access (KLIST for both VSHEL3 and VSDTL6).
- Copies `p_firm` to working variable `w_firm`.

### 2. Main Logic

#### a. Search Assortments With Warehouse (`vclage = p_lage`)
- Loops through all VSHEL3 records of type 'C' where the warehouse matches the input parameter.
- For each matching header, calls subroutine `SJEKK_VSOR` to check if the product exists in that assortment.
- If found (`b_sent = *on`), sets `p_stat = '1'` and jumps to program end.

#### b. Search Assortments Without Warehouse (`vclage = 0`)
- Repeats the process for assortments with warehouse number zero (i.e., general/unspecified warehouse).
- Also calls `SJEKK_VSOR` for each, and exits if found.

#### c. Program End
- If `p_inlr` is not *ON, sets *INLR to *ON (signals program end/cleanup).
- Returns to caller.

---

## Subroutines

### `SJEKK_VSOR`
- For the current assortment header, builds the key for VSDTL6 (firm, assortment, warehouse, product).
- Reads VSDTL6 to see if the product is present in the assortment.
- If found, sets `b_sent = *on` (used as the found-flag in the main logic).

### `*INZSR`
- Handles parameter list and key list setup.

---

## Design Decisions and Conventions

- **Parameter Passing:** All input/output is handled via a parameter list (`PLIST`), which is a common convention for RPG service programs.
- **Key Lists (KLIST):** Used for indexed access to physical files, promoting maintainability and reducing code duplication.
- **Two-Pass Search:** First, assortments matching the explicit warehouse are searched; then, those with warehouse zero (general) are checked. This order ensures specific matches are prioritized.
- **Status Flag:** Program sets `p_stat` to '1' if the product is found, otherwise leaves it blank. This is an established pattern in this codebase for simple status returns.
- **LR Flag Handling:** The program only sets *INLR if the input flag `p_inlr` is not *ON. This allows calling programs to control whether the program closes files and releases resources, which is important in batch or multi-call scenarios.

---

## File Relationships

- **VSHEL3** (Assortment Headers):  
  - Each record represents an assortment definition, filtered by type 'C' and warehouse number.
- **VSDTL6** (Assortment Details):  
  - Linked via firm, assortment number, warehouse, and product.
  - Used to check if a specific product is part of the assortment.

---

## Business/Domain Logic

- **Assortment Type 'C':**  
  - The business operates with multiple assortment types; 'C' denotes central warehouse assortments.
- **Warehouse Handling:**  
  - Assortments may be specific to a warehouse or general (warehouse zero).
  - The program checks both, prioritizing explicit warehouse matches.
- **Product Lookup:**  
  - The main purpose is to answer: "Is this product in a central warehouse assortment for this warehouse or in a general assortment?"

---

## Integration Points

- **Calling Conventions:**  
  - This program is likely called from other RPG programs or CL programs, passing parameters for firm, warehouse, product, etc.
- **No External APIs:**  
  - The program interacts only with DB2 files (VSHEL3, VSDTL6) and does not call external APIs or services.

---

## Notable Patterns

- **Goto for Early Exit:**  
  - The use of `GOTO AVSLUTT` is intentional for immediate exit upon finding a match, a legacy RPG pattern.
- **Subroutine for Reusable Logic:**  
  - The assortment detail check is encapsulated in a subroutine for clarity and potential reuse.

---

## Summary

This program is a utility for checking product membership in central warehouse assortments, handling both specific and general warehouse cases. It is structured for efficient indexed file access and controlled resource management, following established patterns in this codebase. Understanding the relationships between VSHEL3 (headers) and VSDTL6 (details) is key to grasping its operation. The logic is optimized for early exit upon finding a match, minimizing unnecessary reads.