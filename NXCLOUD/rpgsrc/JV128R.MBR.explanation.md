```markdown
# ILE RPG Program JV128R - Transfer New Item to EVR (Parameter Program)

## Overview

This RPG program (JV128R) is designed for IBM i (AS/400) systems. Its purpose is to transfer (overføre) a single item (vare) from one system (VA) to another (EVR), often as part of a larger ERP workflow. The program interacts with several physical files and external programs, provides a screen interface, and utilizes parameter data structures for interaction with called programs.

The code contains several customization layers, supports for handling display files and data validation, and is richly commented (primarily in Norwegian). Below is an explanation of the main components and logic.

---

## 1. **Header and File Declarations**

- **H-spec**:  
  - `option(*nodebugio)`: Disable debug for I/O operations.
  - `datedit(*dmy)`: Default date editing in day-month-year format.

- **File Declarations (`F-specs`)**:  
  - Multiple physical files are declared, such as `jlevl1`, `jle9lr`, `jvarl1`, `jvdtl1`, `vvarl1`, `jvdtlu`.  
  - Each file is set up with `K` (keyed), possibly externally described with `E`, and renamed records for internal use.  
  - `jv128d` is a display file (`WORKSTN`).

---

## 2. **Data Definitions**

### Parameters and Local Data Area (LDA):

- `p_ldor_alf`: Temporary field (length 6).
- Local Data Area fields: `l_firm` (company number), `l_fnav` (company name).

### Key Variables:
- Defined as local variables mimicking key fields from database records, used for lookups (`CHAIN`) against files.

### Working Variables:

- Error flags (`b_feil`), error/warning messages (`w_feil`).
- Item and supplier identifiers (`w_firm`, `w_vare`, etc.).
- Numerous fields for prices, units, packaging, codes, etc., used for passing to and from the pricing program.

### Data Structure for Parameter List (`d_list`):

- Overlayed fields used as a parameter block for calling other programs.
- Contains company, group, and other processing codes.

---

## 3. **Main Program Flow (Calculation Specs `C-specs`)**

### Main Entry Point (`b1tag`):

1. **Display Processing**:

   - Uses `EXFMT` to display and input the screen format `b1bld`.
   - Checks which function key was pressed (`select` structure):
     - F3/F12 (`*inkc`/`*inkl`): Exit (`goto avslutt`).
     - F6 (`*inkd`): Call inquiry subroutine (`spørring`), then refresh screen.
   - Loads input item number into working variable, does a `CHAIN` to `jvdtl1` to fetch item details.

2. **Input Validation and Checks**:

   - Executes `sjekk_input` subroutine.
   - If `b_feil` is set, goes back to display input (`goto b1taga`).
   - Checks if item already exists in EVR (`CHAIN` to `vvarl1`). If found, set error, redisplay.

   - For certain release levels, checks if supplier is allowed for this transfer (via `jle9lr`). If not, sets corresponding error.

3. **Fetch Pricing and Additional Validation**:

   - Calls `hent_pris` subroutine to get pricing info from pricing program.
   - Depending on the return status (`w_osts`), sets relevant error messages (detailed `select` structure for different error/status codes, e.g., missing group, missing price, item expired, etc.).
   - If pricing OK, updates status field in `jvdtlu` to "not transferred" (sets `jvdhko = 0`).

4. **Prepare and Call Transfer Program (`JV620C`)**:

   - Sets fields in `d_list` structure.
   - Calls the parameter program (`CALL 'JV620C'`), passing parameter data, the item number, and exhibition flag.
   - Clears the input fields and sets a "Transferred" message.

5. **Exit Handling**:

   - If exit keys are pressed or at end, set `*INLR = *ON` and return.

---

## 4. **Subroutines**

### `spørring`: Inquiry Routine

Handles function key-initiated lookups:
- If the active field is `B1PGIV` (supplier), calls `JL500R` to get supplier name.
- If active field is `B1VARE` (item), calls `JV503R` to display item details.

### `sjekk_input`: Input Validation

- Resets error flags and fields.
- Checks that supplier is entered, exists, and is valid.
- Checks that item is entered, exists, and gets the main description.
- Checks if the exhibition flag is set to '0' or '1'.

### `hent_pris`: Fetch Price/Status

- Calls external program `JV750R` with many fields as parameters.
- On return, `w_osts` contains a status code that is interpreted in the main program (e.g., missing group, price not found, item expired, etc.).

### `*inzsr`: Initialization Subroutine

- Defines key lists for all files.
- Initializes time and company number from LDA.
- Sets exhibition flag to '0'.

---

## 5. **Key RPG/Business Concepts Illustrated**

- **Database Access**: Uses CHAIN operations with constructed key lists for record lookup.
- **Interaction with External Programs**: Parameter passing (`parm`) to other RPG programs, central to modular RPG design.
- **Error Handling**: Uses fields like `w_feil` to set user-facing error messages and redisplay for corrections.
- **Screen Handling**: Uses display files and EXFMT for interactive green-screen UI.
- **Custom Parameter Blocks**: Packs parameters into overlayed data structures (`d_list`) for program calls.

---

## 6. **Summary Table: Key Files and Programs**

| Object     | Type              | Use                                   |
|------------|-------------------|---------------------------------------|
| jlevl1     | Physical File     | Supplier master (lev = leverandør)    |
| jvarl1     | Physical File     | Item master (var = vare)              |
| jvdtl1     | Physical File     | Item details (for transfer status)    |
| vvarl1     | Physical File     | EVR item master (to check existence)  |
| jle9lr     | Physical File     | Supplier exhibition status            |
| jv128d     | Display File      | User input/output screen              |
| JV620C     | Program           | Executes transfer to EVR              |
| JV750R     | Program           | Pricing and validation program        |
| JL500R     | Program           | Supplier lookup                       |
| JV503R     | Program           | Item lookup                           |

---

## 7. **Key Workflows**

- **User enters item/supplier** → **Validate** → **Check for existence/eligibility** → **Fetch price/validate via JV750R** → **If OK, call transfer program (JV620C)** → **Show success/failure message**.

---

## 8. **Error Messages / Status Codes**

The field `w_osts` is loaded with various status codes by the pricing program, and each code maps to a detailed error message (e.g., missing main group, price not found, item expired, negative margin, etc.).

---

## 9. **Version History**

Frequent version updates are tracked, mainly for:
- Parameter expansion.
- GUI adjustments.
- Length changes for fields.
- Additional status handling (exhibition items, two-position price group, etc.).

---

## 10. **Customization/Localization Notes**

- Most comments/messages are in Norwegian.
- Some business rules are specific to the customer ("Mestergruppen").
- Extensively uses overlays and direct field mapping for performance and legacy compatibility.

---

## Conclusion

This RPG program exemplifies a modular, data-driven approach to item transfer in legacy ERP environments, with strong emphasis on validation, error handling, and interaction with other programs/files. The display-based workflow is typical for legacy IBM i applications.
```