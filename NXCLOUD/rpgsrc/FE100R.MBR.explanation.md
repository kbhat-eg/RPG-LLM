# RPG Program FE100R – Unit Conversion Maintenance

This program, written in ILE RPG, maintains and manipulates a unit conversion file via subfile-driven display screens on IBM i (AS/400) systems.

---

## 1. **General Structure and Purpose**

- **Program Name:** FE100R
- **Purpose:** 
  - Handles unit conversion maintenance, including creation, update, view, copy, and deletion.
  - Uses subfiles for list presentation and edit screens for detailed operations.
- **System:** ASOFAK

---

## 2. **File Declarations**

- **Files Used:**
  - `fenkl1`, `fenklr`, `fenklu` — Different access paths to the main unit conversion file, with different record formats (`read`, `update`, etc.).
  - `venhl1` — Used for validating units.
  - `fe100d` — Workstation file (the display file for screens/subfiles). Has subfile `b1sfl`, subfile control record, and other formats.
- **Naming:** The `rename` keyword ties logical files to program-specific record formats.

---

## 3. **Data Structures and Variables**

### a. **Local Data Area**
- `l_user`, `l_firm`, `l_fnav` — Used to extract user, firm, and function navigation data from the LDA.

### b. **Display Feedback Data Structure**
- `dspfbk` — Used to get current cursor row from the display.

### c. **Work Variables / Subfile Controls**
- `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` — Manage paging, cursor, and positions within the subfile.
- `b_oppr`, `b_forn`, `b_anul`, `b_feil` — Flags for operation mode, refresh, user abort, and error.
- `w_firm`, `w_etxt`, `s_enhf` — Used for current firm, text, and temporary key storage.

### d. **Constants**
- `c_sfil` — Constant for subfile page size (14).

---

## 4. **Indicator Usage**

The code makes extensive use of RPG indicators (*INxx). Examples:
- *INLR: End job/program.
- *IN10, *IN11: Roll Up/Down (paging).
- *IN14, *IN15: Subfile control (clear, end indicators).
- *IN22: Cursor placement.
- *IN30: Protect fields in view mode.
- *IN31-*IN79: Error/warning state.
- *IN80-*IN99: Work use.

---

## 5. **Main Processing Loop**

### a. **Entry Points**
- `b2taga` label: Main control screen for the subfile (writes the control record)
- `b2tagb` label: Handles subfile display and navigation.

### b. **Function Key Handling**
- Uses a `SELECT/WHEN` structure to respond to:
  - Cancellation keys
  - Inquiry, refresh (forny), add (xc1bld), paging up/down, etc.
- All major operations are mapped to subroutines.

---

## 6. **Routine/Screen Descriptions**

### a. **Subfile Processing**

- **`dsp_subfile`**: Displays the subfile, sets display indicators, reads the cursor position.
- **`subfile`**: For each visible subfile record:
  - Handles edit (2), copy (3), delete (4), and view (5) requests by calling the appropriate subroutines.
  - Updates or refreshes as needed.

### b. **Subfile Paging**

- **`clr_subfile`**: Clears the subfile.
- **`crt_subfile`**: Fills the subfile with records from the database, up to page size.
- **`bck_subfile`**: Backs up one page in the subfile.

### c. **Positioning and Refreshing**

- **`forny`**: Rebuilds the subfile from the current position.
- **`posisjoner`**: Moves to a specific key, rebuilds subfile accordingly.

### d. **Add/Edit/View Operations**

- **`xc1bld`**: Screen for adding a new record.
  - Checks for duplicates; if found, show a message (`xc1msg`) and allow retry.
  - Calls maintenance screen (`xc2bld`).

- **`xc2bld`**: Add/Edit/View detail screen.
  - Handles validation and update or write logic.
  - Handles inquiry popups and error indicators.

- **`xk1win`**: Copy operation.
  - Loads the source record, populates the copy screen, checks for duplicates, then calls maintenance.

- **`xd1win`**: Delete operation.
  - Loads, displays delete confirmation, and deletes selected record.

### e. **Message Display**

- **`xc1msg`**: Shows a message when attempting to add a duplicate record; allows abort.

### f. **Initialization**

- **`*inzsr`**: (Startup subroutine)
  - Builds key lists for file access.
  - Loads firm from LDA.
  - Fills the subfile from the first record.

---

## 7. **Key Lists**

KLIST structures for use with CHAIN/SETLL/READ/UPDATE:
- For each access path (`fenkl1_key`, `fenklr_key`, etc.), the firm and unit code are prepared as the key.

---

## 8. **Subfile and Paging Logic**

Variables explained:
- `w_fcrn`: First displayed record number in subfile page.
- `w_spge`: Maximum records per page (=14).
- `w_srrn`: Current record number in subfile.
- `w_ssrn`: Last record number in subfile.
- `w_sfrn`: First record number on current page.

---

## 9. **User Interaction**

- **Screens (Format Names):**
  - `B1SFL`: Subfile record format.
  - `B2CTL`: Subfile control record (header/commands).
  - `C1BLD`: Input for new keys.
  - `C2BLD`: Add/update/view details.
  - `D1WIN`: Delete confirmation.
  - `K1WIN`: Copy dialog.
  - `C1MSG`: Duplicate record warning.

- **User selects lines and actions (edit/copy/delete/view/add) using function keys and row options.**

---

## 10. **Error and Input Validation**

- Checks for blank keys and duplicate records.
- Uses indicators *IN31, *IN32 for invalid or duplicate input.
- Inquiry ("spørring") can call another program (VA510R) for lookup.

---

## 11. **Summary Flow**

1. **Startup:**
   - Load firm, initialize subfile with all unit conversions for that firm.
2. **Main Loop:**
   - Display subfile.
   - Handle user navigation and actions via function keys or line commands.
3. **Add/Edit/Delete/Copy:**
   - Call subroutines for each, with displays and validations.
   - Update subfile UI accordingly.
4. **Paging:**
   - Supported via function keys (roll up/down).
5. **Exit:**
   - *INLR = *ON to terminate.

---

## 12. **Scandinavian Comments/Labels**

- The code uses Norwegian/Scandinavian comments and some field names (e.g., "enhet" = "unit", "beskrivelse" = "description", "vedlikehold" = "maintenance").

---

## 13. **Best for Onboarding**

- **Read the "Benytede skjermbilder" section for display file format mapping.**
- **"Bruk av indikatorer" provides a quick reference for what indicators mean.**
- **Focus on subfile routines, as most maintenance logic is within them.**
- **All logic is modularized in subroutines (`begsr`...`endsr`), easy to trace.**
- **All major operations (add, edit, delete, copy, page) have their dedicated subroutines.**
- **Good use of RPG conventions for application maintenance programs on IBM i.**

---

## 14. **Potential Improvements (for Modern RPG)**

- Migrate to free-form RPG for readability.
- Replace indicators and numbered variable names with meaningful constants/fields.
- Externalize messages for multi-language support.

---

### **In essence:**  
This RPG program is a robust unit conversion maintenance panel with subfile-based list handling and CRUD (Create, Read, Update, Delete) operations, typical for legacy business applications on the IBM i platform.