## Program: VA752R – Determine Order Type for Number Series

### Purpose

This program is part of the ASOFAK system and is responsible for determining the correct order type to be used for a number series. In the business domain, certain order types are configured to share a common number series. For example, order types such as `FB`, `K`, and `KB` may all use the number series defined for order type `F`. This program receives an order type and returns the related order type that should be used for the number series. If no override is configured, it returns a blank, indicating that no substitution is necessary.

### High-Level Flow

1. **Initialization**: The program receives three parameters: company/firm code (`p_firm`), order type (`p_otyp`), and a return variable for the order type to be used for the number series (`p_onum`).
2. **Key Construction**: It builds a key from the company code and order type.
3. **Lookup**: It queries the `votyl1` file (logical file over the order type master) to check if a substitute order type for the number series is configured.
4. **Return Value**: If a substitute exists, it returns the associated order type in `p_onum`; otherwise, it returns blank.

---

## Code Structure and Key Elements

### File Declarations

```rpg
fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
```
- **votyl1**: Logical file over the order type master (`votypfr`). This file holds the mapping between order types and their associated number series order type.

### Parameters

```rpg
d p_firm          s                   like(vaofir)
d p_otyp          s                   like(vaotyp)
d p_onum          s                   like(vaonum)
```
- **p_firm**: Company/Firm code (input).
- **p_otyp**: Order type to look up (input).
- **p_onum**: Order type to use for number series (output).

### Key Variables

```rpg
d votyl1_otyp     s                   like(vaotyp)
d w_firm          s                   like(vaofir)
```
- **votyl1_otyp**: Holds the order type for the lookup (initialized from `p_otyp`).
- **w_firm**: Holds the company/firm code for the lookup.

### Main Routine

#### 1. Initialization

```rpg
c                   eval      p_onum = *blank
c                   eval      votyl1_otyp = p_otyp
```
- Clear the output parameter.
- Prepare the key field for the lookup.

#### 2. Lookup

```rpg
c     votyl1_key    chain     votyl1r
c                   if        %found
c                   eval      p_onum = vaonum
c                   endif
```
- Use the key (`w_firm`, `votyl1_otyp`) to look up in `votyl1r`.
- If found, set `p_onum` to the value of `vaonum` from the record (the order type to use for the number series).

#### 3. Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Standard RPG cleanup and return.

---

### Subroutine: *INZSR (Initialization)

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_otyp
c                   parm                    p_onum
...
c     votyl1_key    klist
c                   kfld                    w_firm
c                   kfld                    votyl1_otyp
...
c                   eval      w_firm = p_firm
c                   endsr
```
- Defines the program’s entry parameter list.
- Builds the key list (`votyl1_key`) for the file lookup, consisting of `w_firm` and `votyl1_otyp`.
- Moves the input company/firm code into the working variable for use in the key.

---

## Business Logic and Domain-Specific Notes

- **Order Type Substitution**: The central business rule is that some order types are configured to share a number series. This is managed by storing, for each order type, the "number series order type" in the master file. If this field is blank, then the order type uses its own series.
- **File `votyl1`**: This file must contain the mapping between order types and their number series order type. Maintenance of this file is critical for correct operation.
- **Parameter Passing**: The program is designed to be called from other programs, likely order entry or order management routines, to determine the correct number series to use for a given order type.

---

## Design and Codebase Conventions

- **File Renaming**: The logical file is renamed on input to avoid naming conflicts and clarify its purpose within the program (`votypfr` → `votyl1r`).
- **Key Management**: Keys for file access are built using named KLIST/KFLD constructs, a standard convention in this codebase for clarity and maintainability.
- **Separation of Initialization**: All parameter and key initializations are handled in the `*INZSR` routine, ensuring that the main logic remains clean and focused.

---

## Dependencies and Interactions

- **`votyl1` File**: The program relies entirely on the integrity and correctness of the `votyl1` file for its logic.
- **Calling Programs**: This module is typically called by other order processing modules that require dynamic determination of the number series order type.

---

## Summary

This program encapsulates the logic for determining the correct order type to be used for number series assignments, supporting the business rule that allows multiple order types to share number series. It is a utility module with a tightly focused responsibility and a clear interface, designed for integration with broader order processing workflows. Maintenance of the underlying mapping file (`votyl1`) is essential for correct operation.