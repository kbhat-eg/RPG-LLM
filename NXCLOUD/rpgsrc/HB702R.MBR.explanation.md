# Program HB702R – Order Proposal from Hand Terminal (PSI Format)

## Overview

**HB702R** is a core batch program in the order management suite, responsible for importing order proposals from hand terminal files in PSI format. It processes incoming order lines, enriches them with product, inventory, and pricing data, and generates structured order proposal headers and lines for downstream processing. The program is highly integrated with master data (products, vendors, inventory), supports multi-company operation, and handles special business rules for logistics, pricing, and supplier assignment.

---

## Business Context

- **Domain**: Wholesale/Distribution – order management and replenishment.
- **Use case**: Operators use hand terminals to scan and propose stock orders. The data is uploaded and processed by this program to create formal order proposals in the ERP.
- **Key features**:
  - Reads PSI-format hand terminal files (`hbbepf`).
  - Enriches lines with product, inventory, and pricing data.
  - Handles logistics variants, supplier split, and campaign pricing.
  - Writes proposals to the order suggestion header (`lfhelur`) and line (`lfdtlur`) files.
  - Integrates with several central subprograms for numbering, pricing, and supplier logic.

---

## File/Table Relationships

- **hbbepf**: Input file from hand terminal (raw PSI format).
- **vvarl1**: Product master.
- **vvenl1**: Product unit master.
- **vlagl1**: Inventory master.
- **lodtlv/lohelr**: Existing order lines/headers (for status checks).
- **votylr**: Order type master.
- **rlevl1**: Vendor master.
- **lstsl1**: Inventory status codes.
- **lfhelur/lfdtlur**: Order proposal header/line (target files).

---

## Key Data Structures

- **d_prec**: Parameter area, overlays for input values (order type, supplier, warehouse, etc.).
- **d_ht**: Parsed hand terminal line (header, item, unit, quantity).
- **Local Data Area**: User, company, and session context.

---

## Main Program Flow

1. **Initialization**
   - Receives parameters from the caller (usually a batch controller or upstream process).
   - Loads company context, timestamp, and status codes.
   - Retrieves price group for the warehouse (via `VL712R`).

2. **Obtain Next Proposal Number**
   - Calls subprogram `AS100R` to get the next available order proposal number (from the numbering register).

3. **Process Hand Terminal File**
   - Loops through each record in `hbbepf`.
   - For each line, invokes `behandling` (processing subroutine).

4. **Proposal Header Creation**
   - After all lines are processed, if any lines were added, writes a proposal header (`forsl_hode`).

5. **Update Proposal Status**
   - Updates the status, weight, and value of the proposal header.
   - Calls `LH714R` to recalculate and update these fields.

6. **Supplier Splitting**
   - If the supplier is not specified, calls `HR112R` to potentially split the proposal by supplier.

---

## Subroutine and Business Logic Details

### 1. `behandling` – Process a Hand Terminal Line

- **Purpose**: Parses and validates each line from the hand terminal.
- **Steps**:
  - Parses item, unit, and quantity from the line.
  - Looks up the product in the product master (`vvarl1`).
  - Looks up the unit in the product unit master (`vvenl1`).
  - Calls `VL721R` to resolve the supplier for the warehouse/item.
  - Checks for logistics variants (SQL query on `vvlepf`).
  - Composes and writes a proposal line (`lfdtlur`), incrementing the line number by 10 for each new line (leaving room for inserts).
  - Enriches the line with product group, text, and logistics info.
  - Parses and formats the quantity from the hand terminal string (non-trivial substring logic).
  - Calls `finn_pris` to fetch purchase and cost prices (`VP750R`), including campaign price if relevant.
  - Calls `finn_varelag` to get minimum/economic order quantity from inventory.
  - Calls `sjk_stat` to determine the status code for the line (e.g., order quantity not matching minimum, cross-docking).
  - Writes the finalized line if it does not already exist.

**Notable conventions**:
- Extensive use of overlays and substring logic for parsing hand terminal records.
- Supplier and logistics variant logic is modularized and can be extended.

### 2. `forsl_hode` – Proposal Header Creation

- **Purpose**: Writes the proposal header if any lines have been added.
- **Details**:
  - Populates header fields from input parameters and context (user, date, time, warehouse, department, etc.).
  - If supplier is specified, fetches and sets supplier name (`rlevl1`).
  - Uses current date if no delivery date is given.
  - Writes the header (`lfhelur`).

### 3. `hntnum` – Proposal Number Reservation

- **Purpose**: Reserves a unique order proposal number by calling `AS100R`.
- **Details**:
  - Passes company and proposal type to the subprogram.
  - Stores the result for use in headers and lines.

### 4. `finn_pris` – Price Determination

- **Purpose**: Determines the purchase and cost price for an item.
- **Details**:
  - Calls `VP750R` with company, item, price group, date, unit, etc.
  - Receives purchase price (`w_inpr`), cost price (`w_kopr`), and campaign code (`w_kamp`).

### 5. `finn_varelag` – Inventory Data Retrieval

- **Purpose**: Fetches minimum and economic order quantity for item/warehouse.
- **Details**:
  - Looks up inventory record (`vlagl1`).
  - Assigns minimum/economic order quantities for downstream status checks.

### 6. `sjk_stat` – Status Code Determination

- **Purpose**: Assigns a status code to the order proposal line based on business rules.
- **Logic**:
  - Status '4': Ordered quantity differs from economic order quantity.
  - Status '5': Ordered quantity is a multiple of minimum order quantity.
  - Status '6': Item is already on order and meets conditions (via `sjk_best`).
  - Status '7': Cross-docking item.
  - Defaults to '0' (normal).

### 7. `sjk_best` – Outstanding Order Check

- **Purpose**: Checks if the item is already on order and updates status accordingly.
- **Logic**:
  - Reads open order lines (`lodtlv`), checks for quantity > 0.
  - Chains to order header (`lohelr`) and order type (`votylr`).
  - If order type is flagged for logistics and confirmation, sets status '6'.

### 8. `*inzsr` – Initialization

- **Purpose**: Sets up key lists for all files and loads company context.
- **Details**:
  - Sets up all key lists for chained access.
  - Loads firm number, timestamp, and price group.

---

## Integration Points

- **AS100R**: Numbering register – reserves unique proposal numbers.
- **VP750R**: Pricing engine – returns purchase/cost prices and campaign codes.
- **VL721R**: Supplier logic – determines supplier for item/warehouse.
- **VL712R**: Price group lookup for warehouse.
- **LH714R**: Updates proposal header with status, weight, value.
- **HR112R**: Splits proposal by supplier if needed.

---

## Notable Design Choices

- **Overlay Data Structures**: Heavy use of overlays for parameter passing and parsing fixed-format records.
- **Line Number Incrementation**: Line numbers increment by 10 to allow for later inserts.
- **Supplier/Logistics Handling**: Modularized with external subprograms and SQL for flexibility.
- **Status Code Logic**: Centralized and extensible for business rules.
- **Backward Compatibility**: Comments indicate version-specific logic and extensions (e.g., price group, logistics variants, campaign pricing).
- **SQL Integration**: Embedded SQL for logistics variant lookup (newer versions).

---

## Version History Highlights

- **Support for new order routines, logistics variants, campaign pricing, expanded price group, and supplier logic**.
- **Incremental versioning and comments** allow tracing of business rule evolution.

---

## Error and Edge Case Handling

- **Blank or missing item/unit**: Skips processing for the line.
- **Missing product/unit records**: Skips processing for the line.
- **No inventory record**: Skips minimum/economic order quantity logic.
- **Supplier not specified**: Triggers supplier split logic after processing.

---

## Summary Table of Subprograms and Files

| Subprogram/File | Purpose/Integration                       |
|-----------------|-------------------------------------------|
| AS100R          | Get next available proposal number         |
| VP750R          | Get purchase/cost price, campaign code    |
| VL721R          | Get supplier for item/warehouse           |
| VL712R          | Get price group for warehouse             |
| LH714R          | Update proposal header (status, weight)   |
| HR112R          | Split proposal by supplier if needed      |
| hbbepf          | Input: Hand terminal file (PSI format)    |
| lfhelur         | Output: Proposal header                   |
| lfdtlur         | Output: Proposal line                     |
| vvarl1          | Product master                            |
| vvenl1          | Product unit master                       |
| vlagl1          | Inventory master                          |
| rlevl1          | Vendor master                             |
| lodtlv/lohelr   | Open order lines/headers                  |
| votylr          | Order type master                         |
| lstsl1          | Inventory status codes                    |

---

## Key Conventions for New Developers

- **All file access uses explicit key lists** for maintainability.
- **All external program calls are parameterized and documented** in the code comments.
- **Version-specific logic** is clearly marked and should be maintained for backward compatibility.
- **Business rules for status, pricing, and supplier assignment are centralized** and modular for easy extension.
- **Hand terminal data parsing** is sensitive to format; changes in PSI format require careful update of overlays/substrings.

---

## Onboarding Recommendations

- **Familiarize yourself with the external subprograms** (`AS100R`, `VP750R`, etc.) as they encapsulate much of the business logic.
- **Understand the data model** (especially the relationships between products, inventory, vendors, and proposals).
- **Refer to the version history comments** for context on why certain logic exists or has changed.
- **Test with sample hand terminal files** to see the end-to-end flow.
- **Coordinate with business analysts** before changing status code or supplier logic, as these are tightly coupled to business processes.

---

## Conclusion

**HB702R** is a central integration point between hand terminal order capture and the ERP order proposal process. Its modular structure, extensive use of subprograms, and careful handling of business rules make it robust and adaptable to evolving business needs. Mastery of this program is essential for working on order management and replenishment processes in this codebase.