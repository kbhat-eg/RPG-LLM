# RPG Program Explanation: ASOFAK (FO603R)
## Overview

This program, titled "ASOFAK: Utskrift/Utplukk fra ordre-register" (Print/Selection from Order Registry), is an IBM i ILE RPG program for interacting with an order registration system. It provides users with interactive options to extract orders based on various criteria: by order type, number ranges, sequences, random selection, or other custom criteria.

## High-Level Flow

1. **Start:** The program initializes, reads parameters, and displays a selection screen for choosing order types and extraction methods.
2. **Process Selections:** Based on user input, it validates and collects relevant order types and associated 'next order types'.
3. **Extraction Methods:** Depending on the chosen method (from-to, sequence on customer, random, or other selection), the program executes the corresponding code block.
4. **Order Processing:** For each selected order, the program performs checks and potentially marks or updates certain records.
5. **End:** Once extraction and updating are done, the program concludes.

---

## Data Structures and Files

### Files

- The `F` specifications define files such as:
    - Customer Registers (`rkunl1`, `fkprl1`)
    - Order Type Register (`votyl1`)
    - Order Header Register (`fohelu`, `fohel1`, `fohelo`)
    - Extraction Parameter Register (`fplolu`)
    - Info, User, and Transaction Registers (`vinfl1`, `fusrl1`, `fstsl1`, `fntrl2`, `fntrl1`, `fscnl1`)
    - Order Line Register (`fodtlr`)
    - Deposit Register (`sdepl1`)

Each file is often renamed for clarity and keyed access is established via `KLIST`s in the `*inzsr` (initialization) subroutine.

---

### Key Variables

- **Order Type Arrays:** `oty`, `ot1` to `ot6`, `nty` (arrays for current and next order types)
- **Structures for Order Numbers:** DS (Data Structures) for mixed keys, e.g., `d_kkey_til`/`d_kkey_les`
- **Parameters:** `p_firm`, `p_ftor`, `p_type`, etc., to hold incoming values
- **Working Fields:** `w_firm`, `w_otyp`, `w_numm`, `w_suff`, etc.

---

## Main Selection Logic

### Initial Screen (Order Type Selection)

Users are prompted to type in up to six order types. The program checks:
- If the entered order types exist in the register
- If they're valid for processing (e.g., correct status, not a 'next' type only)
- Populates arrays with order type codes and "next order types"

Special keys allow:
- F3: Exit
- F4: Inquiry mode
- F7: Switch to "old" version (legacy functionality)

### Extraction Method Selection

User chooses extraction method (`d9svar`):
1. **From-To (Range of Order Numbers)**
2. **Sequence on Customer**
3. **Random Order Numbers**
4. **Other Criteria**

Each method leads to a dedicated processing block.

---

## Extraction Methods

### 1. From-To (by Order Number Range)
- Prompts for order number range.
- Validates entries (non-blank, 'to' >= 'from').
- For each selected order type, scans the order header file (`fohelo`), reading all orders in range and processing them (`exsr oppord9`).
- Calls report program (`FO605R`) if any orders were extracted.

### 2. By Sequence on Customer
- Prompts for up to four sequence codes and a customer number range.
- Validates date fields for order and packing slip dates.
- For each selected order type, scans the order header and retrieves customer's sequence code (`rksekv`); supports customer projects.
- Only processes orders matching one of the sequence codes.
- Calls report program as in (1).

### 3. Random Order Numbers
- Prompts for specific order numbers/suffixes.
- Verifies order existence and that its type matches user selections.
- Processes each entered order individually.
- Calls report program as in (1).

### 4. Other Selection
- Allows picking by department, customer, customer project, or info type.
- Validates each filter.
- For each selected order type, loops through orders, applying all entered filters.
- Processes matching orders.
- Calls report program as in (1).

---

## Order Processing Subroutine (`oppord9`)

For each order selected, performs:
1. **Checks:**
   - If already under processing (`fokode`).
   - If the order type is among those selected.
   - If the order has order lines; delete order if none.
2. **Info Register Check:**
   - Looks up order info codes and blocks if forbidden.
3. **User Permission:**
   - Ensures current user (`fbko08`) is authorized.
4. **Special Checks:**
   - Checks for deposit not yet paid.
   - If passes all, marks order for extraction.
   - Updates relevant files: order header, extraction param register.

---

## Inquiries & Utilities

- **F4 Inquiry:** Various utilities to list and search for departments, customers, customer projects, info types, and order types, using external programs.
- **Deposit Check Subroutine (`sjekk_depo`):** Checks if deposit is unpaid before processing.

---

## Initialization (`*inzsr`)

- Establishes all key lists for indexed file access.
- Reads in program parameters (`parm`).
- Loads user data, etc.

---

## Error and Special Cases Handling

- **Multiple Order Types:** The program is careful to not mix incompatible order types (for example, 'order' vs 'return' types or statuses).
- **Soft Deletes:** If the order has no lines, it is deleted with a comment.

---

## Modernization/Readability Notes

- Code is in traditional column-based RPG, using `C` and `D` specs.
- Arrays are used for order types and next types.
- Many fields and screens rely on external display and database definitions.

---

## Conclusion

This program is a comprehensive order extraction/selection utility, strongly driven by interactive input and heavily validated at each stage. It is prepared to update various registers and maintain business logic (e.g., not processing orders with unpaid deposits, or those already in process). 

Understanding key business files and data contents, as well as the mapping between RPG variables and database fields, is essential for onboarding and further development.

---

**If you are new to this program:**
- Focus first on understanding the principle order flow and register relationships.
- Get familiar with the display files (workstn) and how fields like `d9oty1` are input.
- Review the database structure to see what constitutes an 'order', 'order type', etc.
- Carefully trace the `oppord9` subroutine, as it is central to order processing.