# RPG Program Explanation: Utskrift av Salgsstatistikk (Print Sales Statistics)

This legacy RPG (Report Program Generator) application is a comprehensive report generator for sales statistics. The code's primary function is to read sales-related data from a variety of files, summarize and compare them (including against budgets or last year), and print the results in hierarchically structured reports.

Below is an onboarding guide for developers, covering the main sections, data structures, processing logic, and subroutines. All variable and comment text is preserved in Norwegian, so variable names and comment wording assume Norwegian language proficiency.

---

## 1. Purpose and High-Level Structure

- **Program Function**: Generates a structured sales statistics report using data from various files, supporting grouping by company, categories, products, customers, and more.
- **Report Features**:
  - Comparison (vs. last year, vs. budget)
  - Multi-level group summaries (three sorts, plus company)
  - Detail and subtotal levels
  - Calculated values: gross, net, discounts, DB (cover contribution), average prices, deviations in %, gross margin, etc.
- **Main Sections**:
  - File declarations
  - Data structures and field definitions
  - Input specifications
  - Calculation/processing logic
  - Subroutines (for summarization, report text lookup, budget key handling, etc.)
  - Table for report texts

---

## 2. File Declarations (`F-Specs`)

Multiple physical and logical files are read to gather sales and master data. Examples:

- `skwwpf`, `skpml1`: Parameter files
- `rkunl1`, `rlevl1`: Customer and supplier master
- `vvarl1`, `vvasl1`, `vahgl1` etc.: Product/variety master and classification
- `fhgrl1`, `fvaugl1`, etc.: Various groupings, often renamed for single-program convenience
- `skbul1`: Budget data
- `fsf613p`: Printer file for report generation

---

## 3. Data Structures (`D-Specs`)

Significant use of data structures (DS) for composite/overlapping keys, field overlays, and grouping:

- **Array & Tables**:
  - `sal(12)`: Holds monthly sales values (1 per month).
  - `rt(60)`: Table of report texts (Norwegian), each 25 chars.
- **Overlapped Key Structures**:
  - E.g., DS `beg` overlays 6, 5, 4, 3, 2, and 2a digit keys for flexible key parsing.
- **Working DS**:
  - `w_rest`: Parameter record fields, including sort keys, period, etc.
- **Wxkode Structure**:
  - For dynamic keys used in budget key generation.

---

## 4. Variable Definitions

- **Sales and Financial Totals**:
  - Variables prefixed with:
    - `as` (Antall solgt - quantity)
    - `bb` (Brutto beløp - gross amount)
    - `br` (Rabatt - discount)
    - `bn` (Netto beløp - net)
    - `bk` (Kost - cost)
    - `bd` (Dekningsbidrag - contribution margin/DB)
    - Variants for current/previous year, period, and group level (4/5/6/7)
- **Calculated Fields**:
  - Averages (gj.sn.), deviations (avvik), gross margin (dekningsgrad)
  - Temporary work fields for print text, keys, etc.

---

## 5. Input Specification (`I-Specs`)

- Mapping input parameters from parameter files to working variables.
- Reading month sales values (`sal(1)` – `sal(12)`) from the budget file.

---

## 6. Calculation Logic (`C-Specs`)

### a. Initialization

- Set up from parameter file (`skpml1`), map sort/group parameters (`w_srt1`, etc.).
- Determine comparison settings: versus budget (`*in41`), versus last year (`*in42`).
- Build all keylists (for use with `CHAIN`):
  - Product, customer, supplier, groupings, budgets, parameters, etc.

### b. Main Loop (Not Shown, but implied by level break code)

- **Level Break Logic**: 
  - For each group (SRT3, SRT2, SRT1, and company):
    - On detecting a break (change in sort field), zero out summary fields, update print text/unit, and call further processing for subgroup and printing.
    - Subroutines handle summarization “roll-up” to the next level. (see below)
- **Accumulation & Comparison**:
  - For each record, if comparison with budget or last year is triggered, run logic to handle record aging/period checks (`sfpaar < w_paar`, etc.), fetch budget as needed (`exsr budsjett`), and skip/continue as appropriate.
  - Calculate discount, net, contribution margin.
  - Summing for year-to-date and current period, both this year and last.
- **Report Writing**: 
  - Writes to printer file at each break, as controlled by indicator fields.

---

## 7. Subroutines

### Level Breaks

- **l4brd, l5brd, l6brd, l7brd**
  - Roll up accumulated totals to the next group level (propagate subtotals upwards).
  - Move sort keys and labels into print fields.
  - If group print indicators are set, call `beregn` (calculated values for report) and prepare output.

### `beregn` (Calculation Routine)

- Calculates:
  - Average prices (for different periods)
  - Deviations in % (between current and prior year/period, both quantity and amount)
  - Gross margin (%) for all relevant cases
  - Clamps values to sane reporting limits (e.g., max +/-9999.9%)
- Uses “high precision” flag on calculations to avoid truncation.

### `raprut` (Report Text Selection)

- Looks up the name/description for current group code, using `chain` on various files, depending on the grouping (e.g., product group, customer group, seller, etc.).
- Handles custom group types and sort/level.

### `budsjett` (Budget Key Construction and Fetch)

- Builds a multi-dimensional key for the budget file, filling in only the relevant fields per the user's sort/group selection.
- Fetches monthly sales values from budget, sums up to the relevant period, stores in total and period variables for further comparison.

### `hntwxk` (Budget Key Code Builder)

- Dynamically figures out which fields in the budget key structure are relevant, based on current sort order/grouping.

### `*inzsr` (Initialization)

- Called at program start.
- Fetches report parameter record, prepares print texts for each grouping, sets up selection and summation indicators, and prepares all keys for subsequent data access.
- Writes the initial report header.

---

## 8. Table: Report Texts

- Defined at the bottom as `rt(60)` for all possible groupings.
- Used for dynamic report headings and key name resolutions.

---

## 9. Notable RPG Idioms and Practices

- **Level break handling**: classic RPG III/IV style, using labeled tags (`l4`, `l5`, etc.) and subroutines for subtotaling on group changes.
- **Use of *inxx indicators**: Indicator fields control print logic, level break writes, and subroutine flow.
- **Overlaying/structuring keys** for flexible record access.
- **CHAIN** operations: several to various files by complex keys for lookups (master data, groups, texts).

---

## 10. Areas for Refactor/Modernization

- Consider moving to fully free-format RPG (RPGLE) for maintainability.
- Replace level break logic with built-in SQL or data grouping mechanisms if possible.
- Externalize report texts to a DB table.
- Add error handling/logging for file access failures.
- Convert calculations to use modern BIFs and arithmetic, reduce use of indicators/legacy opcodes.

---

## 11. Quick-Reference: Main Variables Used

| Variable Prefix | Meaning          | Example          |
|-----------------|------------------|------------------|
| as              | Antall (Quantity)| asiiu, asifu     |
| bb              | Brutto (Gross)   | bbiiu, bbifu     |
| br              | Rabatt (Discount)| briiu, brifu     |
| bn              | Netto (Net)      | bniiu, bnifu     |
| bk              | Kost (Cost)      | bkiiu, bkifu     |
| bd              | DB (Margin)      | bdiiu, bdifu     |
| gs              | Gjsn. pris (Avg) | gsiiu, gsifu     |
| ba/aa           | Avvik % (Diff)   | baifu, aaifu     |
| dg              | Dekningsgrad (%) | dgiiu, dgifu     |
| ...4,5,6,7      | Level (Sort)     | bbif4, bbif5, ...|
| ...u            | "Utskrift" (Print)| asiiu, asifu    |

---

## 12. Main Flow Summary

1. **Initialize program & read parameters**
2. **Loop through sales data by grouping keys**
3. **On each group change (level break):**
   - Summarize and roll up totals
   - Fetch and print group names
   - Output sub- and grand totals
4. **For each line/item:**
   - Calculate totals and values to be reported
   - Compare with budget or last year if relevant
   - Accumulate into group subtotals
5. **At end, print all final totals and exit**

---

## 13. Useful Norwegian Terms

- Utskrift: Print
- Salgsstatistikk: Sales statistics
- Brudd: Break (in grouping)
- Avdeling: Department
- Lager: Warehouse
- Rabat: Discount
- Faktura: Invoice
- Kunde: Customer
- Vare: Product
- Budsjett: Budget

---

This is a high-level, pedagogical walkthrough: for debugging or minor updates, focus on the subroutine and data structure matching the area of interest (e.g., adding a new grouping, changing a calculation, updating report output, etc.). The code is a “classic” RPG report engine, built for flexibility at a time when little was “dynamic,” so expect a lot of manual field mapping and key construction, and considerable use of indicator and group logic. 

For onboarding to this program, it is crucial to understand both the overall report structure as well as the specific logic for subtotaling, sorting, and key management.

---