# Explanation of RPG Program `RF414R` (Resultatrapport, kopiering)

---

## **Overview**

This program is written in ILE RPG and is designed for IBM i (AS/400) systems. Its purpose is to facilitate copying a "result report" (likely a report template or data structure) from one entity (firm/company) to another. It uses DDS-based display files and subfiles to provide an interactive user interface for selecting, viewing, and copying reports and their related details.

The program uses several database files (physical or logical) and a workstation display with subfiles for user interaction.

---

## **Header and Options**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: Skips debug I/O code.
- `*DMY`: Sets the default date editing to Day-Month-Year.

---

## **File Declarations**

```rpg
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
...
frf414d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **Database Files**: The program works on multiple database files with logical views (e.g., `afirpfr`, `rrf0pfr`, etc.), each renamed for this program.
- **Display File**: `rf414d` is the display file, using subfile `b1sfl` controlled by relative record number `w_srrn`.

---

## **Special Indicators & Their Usage**

The code uses standard RPG indicators (LR, 10-99), each assigned for specific program logic (exit, scrolling, field protection, etc.).
- 10 = Rollup (Page Down)
- 11 = Rolldown (Page Up)
- 12,13,14,15 = Subfile handling
- 21,22 = Home key, cursor positioning
- 30 = Field protection
- 31-99 = Message and work indicators

---

## **Data Structures and Variables**

### **Local Data Area (LDA)**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- These reference positions in the LDA for user, firm, and navigation info.

### **Key and Work Fields**
```rpg
d afirl1_firm     s                   like(aaffir)
...
d w_stel          s              4  0
...
d w_ffir          s              3  0
d w_tfir          s              3  0
```
- Variables are defined for handling file keys, subfile management (record numbers, page numbers), and report-related data (report number, firm number, etc.).

### **Constants & Subfile Explanation**
```rpg
d c_sfil          s              2  0 inz(12)
```
- Subfile page size default is 12.
- Comments describe variables for subfile navigation and screen structures.

---

## **Program Flow**

### **Main Tags (`b2taga`, `b2tagb`, etc.)**

- **b2taga**: Display special key screen first (`b2cmd`).
- **b2tagb**: Main data-handling logic, calls subroutine `dsp_subfile`.

### **Function Key Handling (Main Loop)**

The program processes keys:
- Exit keys (`*INKC`, `*INKL`): Goto exit logic.
- Renew (`*INKE`): Refreshes subfile (`forny`).
- Rollup (`*IN10`): Calls `crt_subfile` (page down).
- Rolldown (`*IN11`): Calls `bck_subfile` (page up).
- Home (`*IN21`): Sets cursor positioning (`*IN22`), returns to main screen.
- Default: Calls `subfile` subroutine for further processing.

---

## **Subroutines**

Each subroutine performs a specific function. Here are the key ones:

### **forny**
- Refreshes subfile data at the current position.
- Positions keys based on current mode (by description or report number).
- Clears and re-populates subfile.

### **posisjoner**
- Positions subfile based on user-specified report number or description.
- If provided, moves to that location in the data, clears, and reloads the subfile.

### **subfile**
- Processes user selection in the subfile.
- Handles the copy action (`b1valg = 3`), calls `kopier`.
- Updates subfile records after copying.

### **kopier**
- The main copying logic.
- Copies:
    - Report headers from the source firm and report to the target firm.
    - Report lines (details).
    - From/to concepts (begrep).
- Uses CHAIN, SETLL, READE, and WRITE for precise record handling.

### **clr_subfile**
- Clears subfile and reset management variables.

### **crt_subfile**
- Fills (loads) the subfile with up to a page size worth of data.
- Reads from the appropriate report file and moves data to the subfile.

### **bck_subfile**
- Handles page up in the subfile.
- Reads previous set of records, then clears and reloads the subfile for the new position.

### **dsp_subfile**
- Manages subfile display logic.
- Decides whether to display the subfile or the command screen.

### **Initialization (`*inzsr`)**
- Sets up program state, keys, and variables at program start.
- Pulls values from the LDA.
- Initializes positioning and subfile with current firm and report data.

---

## **Key Lists (KLIST/KFLD)**

The program uses RPG native KLIST/KFLD to declare database access keys for various logical files: 
- afirl1_key, rrf0l1_key, rrf0l2_key, rrf0lu_key, rrf5l1_key, rrf5lu_key, rrf8l1_key, rrf8lu_key

These are groups of key fields used for file positioning and record selection.

---

## **Database and Subfile Interaction**

The core of the program is record positioning and copying:
- It uses SETLL/READ(E)/READP to navigate records efficiently.
- Subfiles are used for display and user interaction, with support for paging, selection, and updating.
- All record copying ensures unique identification based on firm and report keys.

---

## **User Experience**

User sees a list of reports in a subfile. Through function keys, they can:
- Page up/down
- Position on a specific report or description
- Select a report to copy to another firm/entity

The program maintains visual and logical state across subfile pages, keeping navigation smooth and robust.

---

## **Key Takeaways**

- **Modular**: Uses subroutines for each functional aspect.
- **Subfile-centric**: All interaction is via subfile listing and updates.
- **Record-level processing**: Each report/header/line/concept is handled individually for copying.
- **Legacy Style**: Uses RPG III/400 style with indicators, C-specs, and KLISTs.
- **Well-documented**: Norwegian comments explain indicator and field usage, subfile workings, and overall program structure.

---

## **What to Focus On When Onboarding**

1. **Understand the indicators**: Their mapping to F-keys and workflow.
2. **Know the subfile workflow**: How paging, positioning, and updating is handled.
3. **Familiarize with database keys and file structures**.
4. **See how copy logic works**: Follows report > report lines > concepts.
5. **Navigation/refresh logic**: `forny`, `posisjoner`, `crt_subfile`, `bck_subfile` are the "navigation engine" of the UI.
6. **Legacy constructs**: Knowing how "old school" RPG processes files record-at-a-time.

---

**This program is a robust, subfile-based report copy utility for IBM i, and understanding the flow from the main loop to the specialized subroutines, and how database files interact with subfiles, is essential for effective maintenance and enhancement.**