# RPG Program VG704R – Explanation

---

## Overview

This RPG III/ILE RPG program is designed for IBM i (AS/400) systems, and is used for initializing (setting) the start value for the moving average cost price for all inventory items. It also provides functionality to delete all such start values if required.

The code is written in fixed-format RPG, with Norwegian comments and variable names (some English). Here’s a breakdown of its main components and logic.

---

## File Declarations

```rpg
fvgkpiu    uf a e           k disk    rename(vgkpst:vgkpiur)
fvgkpi1    if a e           k disk    rename(vgkpst:vgkpi1r)
fvgkkir    if   e           k disk    rename(vgkkst:vgkkirr)
fvvarl1    if a e           k disk    rename(vvarpfr:vvarl1r)
fvg704d    cf   e             workstn
```

- **vgkpiu, vgkpi1**: Inventory cost price master and work files (disk files), renamed for local usage.
- **vgkkir**: Cost price parameter file.
- **vvarl1**: Inventory item (product) master file.
- **vg704d**: Display file (workstation display).

"uf" = update file, "if" = input file, "cf" = communication file.

---

## Definition of Variables and Data Structures

### Standard Variables

- Variables with prefix `p_`: Used as parameters for called programs/subroutines.
- `p_frec` (300A): Buffer for cost price factors (faktorer).
- `p_dato` (D): ISO-format date used as parameter, e.g. for price lookup.
- `p_sapr`, `p_gmpr`, etc.: Used for passing prices between programs.

### User Space and Local Data Area

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- Reads user id and firm id from user space/LDA.

### Cost Price Factors (Kostprisfaktorer) Data Structure

Struct `d_frec` holds up to 5 cost price adjustment factors; each has a type, sign, factor, account, and contra account.

---

## Key Variable Definitions

```rpg
d vgkpiu_lage     s              2  0
d vgkpiu_hkod     s                   like(vghkod)
d vgkpiu_vare     s                   like(vgvare)
...
```
- Used for keying into index files for updates, lookups, etc.

---

## Workflow Summary

### 1. Input Processing (`c2taga` tag)
- Presents a screen for user input (`exfmt c2bld`).
- Handles function keys for cancel/exit.
- Validates input for required values: start date and price code.

### 2. Update or Delete Start Values

- **If not delete-all (`c2slta <> 'J'`)**: Calls subroutine `oppd_gkpris` to update start values.
- **If delete-all (`c2slta = 'J'`)**: Calls subroutine `slett_alle` to remove all start values.

### 3. Subroutines

#### Error message handling: `xc1msg`
Shows an error message screen and lets user abort or continue.

#### Start Value Update: `oppd_gkpris`

For each stock item in the item master file (`vvarl1` where `vvvtyp = 'L'`):

- Calls program 'VP730R' to lookup cost prices.
- Calls program 'VG703R' to get cost price factors.
- Applies factors via `finn_kostt` subroutine.
- Adds up initial price and all applicable surcharges.
- Writes/updates new start cost record into cost price file (`vgkpiu`).
- Skips items with zero calculated price.

#### Delete All Start Values: `slett_alle`

- Loops through all records in cost price file.
- Deletes records of type 'S' (start value) for current firm, warehouse, etc.

#### Calculate Cost Price Adjustments: `finn_kostt`

- For each of the 5 possible factors in the cost factor structure:
    - If factor type is not blank, applies factor as surcharge or deduction to base price (`w_inkp`), based on sign.
    - Sums the results to `w_til1` through `w_til5` for use in updating final cost price.

#### Warehouse Search: `sok_lager`
- Calls program 'RA510R' to perform warehouse lookup.

#### Initialization: `*inzsr`

- Sets up key lists (for random access to files).
- Reads firm number from user area.
- Loads standard values from cost price parameter file.

---

## Key Logic Snippets

### Main input validation and branching

```rpg
exfmt c2bld
if *inkc or *inkl
    goto avslutt
endif
if *inkd
    exsr sok_lager
    goto c2taga
endif
if c2slta <> 'J'
    exsr oppd_gkpris
else
    exsr slett_alle
endif
```
- Shows main input screen, handles exit/search keys, and branches to updating or deleting logic.

### Fetching and Setting Cost Prices

```rpg
call 'VP730R'    // price lookup
call 'VG703R'    // fetch cost price factors
exsr finn_kostt  // apply cost surcharges
w_nykp = w_inkp + w_til1 + w_til2 + w_til3 + w_til4 + w_til5

// If price is not zero, creates new record
```

### Calculating Each Factor

```rpg
if d_fty1 <> *blank
    if d_fsi1 = '-'
        w_sign = -1
    else
        w_sign = 1
    endif
    w_til1 = ((w_inkp * d_fak1) / 100) * w_sign
endif
// Repeat for d_fty2..d_fty5
```
- Five similar blocks to handle up to five possible surcharges/deductions.

---

## Conclusion

**What the program does:**
- Interactively lets a user set (or clear) start values for moving average cost price for all inventory items in a warehouse for a specific company.
- Reads product master, looks up cost price and applicable surcharges, and creates cost price records.
- Can also delete all start value records for the selected warehouse.

**User interaction:**  
- Operates from a display file, with user input, confirmation, error message handling, and function keys for operations like search, confirm, and cancel.

**Integration with other programs:**  
- Calls out to price lookup and cost price factor routines.

---

## Onboarding Notes

- **Norwegian variable names:** Most variables and comments are in Norwegian. Key English translations:
    - `kostpris` = cost price
    - `lager` = warehouse
    - `vare` = item/product
    - `tillegg` = addition/surcharge
    - `fradrag` = deduction
    - `faktor` = factor
    - `startverdi` = start value
- **Parameter routines**: Calls out to other programs to get dynamic values.
- **Data structure alignment**: Make sure file layouts and data structures (`ds`, rename) match your database setup.
- **Customization**: Adjustments may be needed if your product/item or cost files differ.

---

**In sum:**  
This RPG program is a batch utility for initializing or clearing start cost prices in the inventory system, driven interactively via a workstation display, and orchestrating several underlying routines for price calculation and factor application.