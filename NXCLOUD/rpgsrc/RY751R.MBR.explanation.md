```markdown
# Overview  
This RPGLE program (`RY751R`) reads a “MAXBO” input file (`jrvapf`), updates purchase prices for items, and creates surcharge records at the item-number level.

---

## Header (Specifications)  
- **h option(\*nodebugio) datedit(\*dmy):**  
  Disables debug I/O and sets dates in day-month-year format.  
- Comments document system, program name, purpose, and change history.

---

## File Declarations  
```rpg
     fjrvapf    if   e           k disk
     fjvarl8    if   e           k disk    rename(jvarpfr:jvarl8r)
     fjvdtl1    if   e           k disk    rename(jvdtpfr:jvdtl1r)
     fjvprlu    uf a e           k disk    rename(jvprpfr:jvprlur)
     fjpfalu    uf a e           k disk    rename(jpfapfr:jpfalur)
```
- **Input Files (IF):**  
  - `jrvapf`: MAXBO source data.  
  - `jvarl8`, `jvdtl1`: lookup files (renamed on open).  
- **Update Files (UF):**  
  - `jvprlu`: item-price update file.  
  - `jpfalu`: surcharge file to be created.

---

## LDA (Local Data Area)  
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- Holds program startup data such as the company number (`l_firm`).

---

## Data Structure for Record Buffer  
```rpg
d                 ds
d d_list                       240
d  d_lvar                       15    overlay(d_list:1)
d  d_inpr                        9  2 overlay(d_list:66)
d  d_gdat                        6  0 overlay(d_list:77)
d  d_saim                        9  2 overlay(d_list:101)
```
- `d_list`: entire input record buffer (240 chars).  
- Overlay fields extract sub-items:  
  - `d_lvar`: supplier item number.  
  - `d_inpr`: purchase price.  
  - `d_gdat`: date field.  
  - `d_saim`: sale price.

---

## Key Variables for Lookups  
```rpg
d jvarl8_ldor     s                   like(jvldor)
d jvarl8_lvar     s                   like(jvlvar)
d jvdtl1_dvar     s                   like(jvdvar)
d jvprlu_vare     s                   like(jxvare)
d w_firm          s              3  0
```
- `jvarl8_*`, `jvdtl1_*`, `jvprlu_vare` mirror key fields of the respective files.  
- `w_firm`: working company number loaded from LDA.

---

## Main Program Logic  
1. **Read Input File**  
   ```rpg
     read jrvapf 90
     dow  *in90 = *off
       eval  d_list = jrvrad
       exsr  oppdater
       read  jrvapf 90
     enddo
   ```
   - Loop until EOF (`*in90`=on).  
   - Move raw record (`jrvrad`) into `d_list`.  
   - Call subroutine `oppdater` to process each record.

2. **End Program**  
   ```rpg
     avslutt tag
       eval  *inlr = *on
       return
   ```

---

## Subroutine: oppdater  
Processes one MAXBO record:

1. **Skip Zero-Price Records**  
   ```rpg
     if d_inpr = 0; leavesr; endif
   ```
2. **Lookup Item by Supplier-Item Key**  
   ```rpg
     eval jvarl8_ldor = 009999
     eval jvarl8_lvar = d_lvar
     chain jvarl8 91; if *in91 = *on; leavesr; endif
   ```
3. **Update Purchase Price**  
   ```rpg
     exsr oppd_pris
   ```
4. **Create Surcharge Record if Sale Price Present**  
   ```rpg
     if d_saim = 0; leavesr; endif
     chain jvdtl1 91; if *in91 = *on or jvdhko = 1; leavesr; endif
     clear jpfalur
     eval jc* fields = from lookup and calculations
     time jcodat; time jcedat; time jcetim
     write jpfalur
   ```
   - Calculates surcharge percentage: `(d_saim / 1.25) / d_inpr`.

---

## Subroutine: oppd_pris  
Updates or writes a new item-price record (`jvprlur`):

1. **Prepare Key and Fields**  
   ```rpg
     eval jvprlu_vare = jvvare
     chain jvprlu 91
     eval jxvare = jvvare
     eval jxpris  = d_inpr
     eval jxldor  = jvldor
     eval jxlvar  = jvlvar
     eval jxgdat  = *loval      // default low date
     eval jxrsts  = 1
     if d_gdat <> 0; move d_gdat jxgdat; endif
   ```
2. **Update or Write**  
   ```rpg
     if *in91 = *off; update jvprlur;
     else write jvprlur; endif
   ```

---

## Key Lists (at Init)  
```rpg
jvarl8_key    klist
  kfld jvarl8_ldor
  kfld jvarl8_lvar

jvdtl1_key    klist
  kfld w_firm
  kfld jvdtl1_dvar

jvprlu_key    klist
  kfld jvprlu_vare
```
- Defines which fields form the keys for chained reads and updates.

---

## Initialization (Optional `*INZSR`)  
- Loads `w_firm` from LDA:  
  ```rpg
    eval w_firm = l_firm
  ```
```

