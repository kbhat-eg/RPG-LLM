# RPG Program CI701R – Internet, Export to File

This RPG (ILE) program is a batch job that extracts product information, together with pricing, campaign, and inventory details, to a flat file for further processing or integration (typically for web/e-commerce usage). It is well-commented and structured with subroutines for clarity and maintainability.

## **High-Level Purpose**
The program loops through all stock items in the system, gathers comprehensive product, price, and inventory data (including campaigns/discounts), performs various calculations (e.g., sales including VAT, stock conversions), and writes the results out as fixed-format records in an export file.

## **Sections Explained**

---

### **Header and History**

- The code header (comment block) describes the purpose, history, and changes.
- The program is named `CI701R`.
- "All values in 1st sales unit," i.e., base units are standardized.

---

### **File Declarations (F-specs)**

Each file is defined as input (`I`), externally-described, keyed (`K`), and optionally renamed for the program.

**Examples:**

- `fra10lx`, `ffstsl1`, ... – input files, likely master and transaction files.
- `fcintpf` – output file for the exported flat file.

---

### **Data Structures (D-specs)**

#### **1. Parameter and Work Data Structures**
- Structures like `d_list` and fields like `d_firm`, `d_avde` hold firm and department identifiers from parameters.

#### **2. Main Export Data Structure**
- `d_int` (520 bytes): overlays define the exported record format. Fields include:
  - `d_vers` – Version
  - `d_ifir`, `d_iavd` – Firm, dept.
  - Product info: `d_vare` (item), `d_nobb` (NOBB code), `d_tek1` (description), etc.
  - Pricing: Recommendation, cost, campaign, VAT-included price, date info, and so on.
  - Inventory: Sales stats, location, stock, etc.

#### **3. Work Variables**
- Used for intermediary calculations, conversions, and to interact with external procedures (e.g., VAT calculation).

---

### **Mainline Logic**

#### **1. Initialization**
- Sets current date/time.
- Determines effective extraction date (special logic for Saturdays).
- Calculates reference dates for sales statistics (1, 3, 12, 15 months ago, 3 days ago).

#### **2. Main Loop: Process all Stock Items**
- Loops through all records in the main item file (`vvarl1`).
- For each item, calls `behandling` subroutine for processing.

#### **3. Program End**
- Sets LR indicator to end program.

---

## **behandling SUBROUTINE (Core Processing)**

This is where all the business logic happens for each product:

### 1. **Initialization**
- Clears export structure, sets export version.
- Initializes all work variables.

### 2. **General Retrievals**
- Copies firm/department into the export record.
- Skips non-stock/non-supply items.
- Validates item type.

### 3. **Product Information**
- Populates product code, NOBB code, description, supplier, and groupings.
- Sets flags for "supply goods" (special-order only).

### 4. **Price Information**
- Determines which supplier ID (`w_ldor`) to use for price lookup.
- Retrieves current selling price using detailed fallback rules (by supplier, price group, unit, etc.).
- Converts prices into standard string format for export.
- Calculates and stores sales prices including VAT.
- Handles 2nd and 3rd sales units with the same fallback process.

### 5. **Campaign (Tilbud) Prices**
- Looks up any active campaign price for the item/price group/sales unit.
- If not found, checks for campaigns with a blank price group, then at group and supplier levels using the `tilb_sjekk` subroutine.
- Campaign price, dates, and times are stored.
- Campaign prices including VAT are also calculated, with high-value safeguards.

### 6. **Supplier Info**
- Fetches and populates supplier name based on supplier ID.

### 7. **Logistics/Assortment Info**
- Performs an embedded SQL SELECT to pick up any logistic assortment NOBB, supplier item#, or supplier code, and overlays these if found.

### 8. **Sales Statistics**
- Loops through the sales statistics file to sum up sales for various periods (3 months, 15-12 months ago).
- Converts sales units if statistics are in a different unit than product master.

### 9. **Order/Packing Information**
- Scans order lines/headers to gather additional sales data, handling returns/negatives, and unit conversions as needed.

### 10. **Inventory Information**
- Retrieves and normalizes stock, on order, inbound, and available balances.
- Adjusts for units of measure as needed.

### 11. **Earliest Confirmed Delivery Date**
- Scans purchase order lines and headers to find the earliest not-yet-received delivery not older than three days ago.

### 12. **Write Export**
- Writes the filled `d_int` record to the export file.

---

## **Key Subroutines**

### **tilb_sjekk**
- Hierarchical subroutine to look up campaign prices at broader grouping and supplier levels if not found specifically for the item/price group.

### **hent_tilb**
- Loops through the campaign file for the current key, checks if the campaign is valid for the export date/time, and computes the discounted campaign price.

### **Initialization (*inzsr)**
- Unpacks parameters.
- Initializes keys for file access.
- Determines warehouse/location for the department.
- Determines price group for the warehouse/department.
- Calls external programs to get VAT rates (including reduced rates).

---

## **Notable Features & RPG idioms**

- Uses overlay data structures extensively for fixed-format record building.
- External file IO with `CHAIN`, `READE`, `SETLL`, and direct key lists.
- Calls to external CL or RPG programs for business logic (e.g., VAT rate lookups).
- Handles campaigns/discounts via multiple fallback paths.
- Includes embedded SQL for advanced data retrieval (assortment master).
- Handles multi-unit pricing (up to three sales units per item).
- Takes care of unit-of-measure conversions for both sales and inventory.
- Subroutines for maintainability and code reuse.

---

## **Summary of Processing Flow**

1. **Param Initializations:** Set keys, firm, warehouse, price group, VAT.
2. **For each product:**
   - Skip if not stock/supply item.
   - Gather product, supplier, group info.
   - Lookup and calculate selling prices (all relevant units).
   - Lookup and calculate campaign prices (all fallback paths, all relevant units).
   - Lookup and calculate cost/stock/movement info.
   - Collect sales, orders, and earliest delivery dates.
   - Output single composite record to export file.

---

## **Maintenance Tips**

- **Adding Fields:** Add to `d_int` and overlays, plus corresponding logic in `behandling`.
- **Pricing Rules:** Review and adjust fallback order for price/campaign logic in both `behandling` and `tilb_sjekk`.
- **Unit Conversions:** Ensure `vvenl1` logic matches for any new units.
- **External Program Calls:** VAT rates determined by external RPG programs (verify if rates change).
- **New Campaign Levels:** If new group levels to be considered, update both `tilb_sjekk` and `hent_tilb`.

---

## **Overall**

This code is a robust, production-oriented RPG batch job with well-defined routines for extracting and normalizing comprehensive product, price, campaign, and stock data for export, suitable for integration with websites, datawarehouses, or other external systems. It's designed for maintainability, with frequent updates documented in the header and logical separation of functions.

---

**Tip:** When onboarding, focus on understanding the data model (file layouts & keys), the sequences of price/campaign lookups, and the way units of measure are converted throughout.