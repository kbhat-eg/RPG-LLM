# RPG Program: LQ700R - Inventory Update from Stock Transactions

## Overview

This RPG program (LQ700R) is designed to update the inventory (lager) based on stock transactions (lagertransaksjoner). It processes inventory bundles and lines, performs quantity conversions to correct inventory units, calls related programs for cost/price adjustments and inventory balance recalculations, and writes updates to inventory files. It is typically part of a larger warehousing or ERP system.

The code is annotated with Norwegian comments, and variable names use abbreviations (often in Norwegian), so a glossary or domain knowledge may be helpful for full comprehension.

---

## 1. File Declarations

The `F` specs define logical files accessed by this program, each given a record format rename for clarity:

```rpg
flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)   // Inventory Status Codes
fllhel1    if   e           k disk    rename(llhepfr:llhel1r)   // Inventory Bundle Header
flldtl1    if   e           k disk    rename(lldtpfr:lldtl1r)   // Inventory Bundle Line
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)   // Item Master
fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)   // Item-Unit Register
fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)   // Extension (Timber assortment, v6.30+)
fvhislr    if   e           k disk    rename(vhispfr:vhislrr)   // Historical Inventory Ledger (v7.01+)
```

---

## 2. Data Structures and Variables

### Input Parameter Structures

- **d_prec, d_numm, d_kode, d_peri, d_dato, d_dumm**  
  The main input parameter structure (often passed from a calling CL or RPG program) containing number, code, period, date, etc.

### Inventory Update Structure

- **hlrec + overlays**  
  Composite structure for a single inventory update record, with overlays for each field (item, warehouse, date, time, type, quantity, reference, etc).

### Variables

- Contains working storage for keys, data elements, flags, working buffers, and subroutine parameters.

---

## 3. Main Processing Flow

### Initialization

The *INZSR (initialization subroutine) loads parameters and sets up keys for subsequent file access.

### 3.1. Read Inventory Bundle Header

```rpg
c     llhel1_key    chain     llhel1
```
Loads bundle header record for the processing batch.

### 3.2. Loop Through Inventory Bundle Lines

```rpg
c     lldtl1_key    setll     lldtl1
c     lldtl1_key    reade     lldtl1
c     dow       not %eof
   ...processing...
c     lldtl1_key    reade     lldtl1
c     enddo
```

Iterates through all line items (`lldtl1`) belonging to the inventory bundle (`llhel1`).

#### For Each Line:

1. **Copy Down Parent Attributes If Missing:**  
   If line's type, warehouse, or destination warehouse is blank/zero, fill in from bundle header.

2. **Skip Text Lines / Zero Quantities:**  
   Only process lines not of type `'TX'` and with non-zero quantity, unless the parent type is adjustment (`'J'`).

3. **Convert Quantity as Needed:**  
   Calls subroutine `omr_antall` to possibly convert quantity into correct inventory unit.

4. **Special Case: Transfer ("OF"/"O "):**  
   Handles transfer lines by first updating from warehouse, then modifying line to represent "to warehouse".

5. **Perform Inventory Update:**  
   Calls subroutine `opplag` to prepare and submit the change.

---

## 4. Subroutines

### 4.1. Inventory Update (`opplag`)

- Maps relevant line fields to the inventory update structure.
- Conditionally builds the reference field (`hlrefr`) with a reason code or text.
- Calls:
  - **VL002R**: Cost price update routine (if relevant).
  - **VL001R**: Inventory register update routine.
  - **LA962R (v7.01+)**: Recalculates inventory balance from the relevant date for the item/warehouse.

### 4.2. Quantity Conversion (`omr_antall`)

- Retrieves item master and unit information.
- If input unit matches inventory unit or is a "miscellaneous" item, quantity is not converted.
- Otherwise, determines conversion factors for each unit and adjusts the quantity accordingly.
- Handles edge cases (missing factors, division by zero).

### 4.3. Initialization Subroutine (`*INZSR`)

- Loads the incoming parameter block.
- Sets up key lists for file lookups.
- Retrieves status code information for subsequent use.

---

## 5. Key List Definitions

`klist`/`kfld` defines primary keys for use in file operations (`CHAIN`, `SETLL`, etc.) for various files.

---

## 6. External Program Calls

- **VL001R**: Performs the actual inventory update (journal/ledger).
- **VL002R**: Adjusts cost prices (if needed).
- **LA962R**: Recalculates inventory balance (used after inventory update to reflect new reality).

---

## 7. Special/Version-Specific Enhancements

- Support for new parameters, additional info (timber assortment), improved historical handling, etc.; see version notes in comments.

---

## 8. Comments and History

- Extensive Norwegian comments describe business rules (e.g., "Legger inn overliggende type dersom blank-type" = "Fill in parent type if blank").
- Change log is kept at the top for traceability.

---

## 9. Summary of Business Logic

1. Load batch and lines to process.
2. For each line:
    - Fill in missing type/warehouse data from header.
    - Ignore text lines and (generally) zero-quantity lines unless adjustments.
    - Convert quantity to correct unit, if needed.
    - Handle transfers between warehouses specially.
    - Map and assemble an update record.
    - Call remote programs as needed for price and inventory update.
    - (If enabled) Recalculate inventory balances from correct date.
3. End.

---

## 10. Key Takeaways for Developers

- This program is central to warehouse/inventory updates.
- Modular design: uses subroutines for quantity conversion and record mapping.
- Relies on several external RPG programs for accounting and recalculationâ€”these must be available and compatible.
- Data integrity is ensured by extensive checking and field mapping.
- Norwegian variable names and comments: understanding the business process (inventory, warehouse management) and some Norwegian is helpful.
- Highly versioned: pay attention to conditional code and version history for maintenance.

---

**If you're onboarding or supporting this program:**
- Start by understanding the inventory structure (header/line model).
- Familiarize yourself with the vocabulary (see overlays and source comments).
- Review how external programs are used, and their parameter contracts.
- Carefully walk through both the main loop and the core subroutines as that's where most of the inventory-specific logic occurs.

---