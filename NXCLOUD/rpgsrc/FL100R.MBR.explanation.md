# RPG Program FL100R - Maintenance of Customer Projects

This program is a maintenance interface for "customer projects". It provides a subfile-based display, filtering, search functions, and the ability to add, update, copy, and delete records. Much of the program deals with managing the subfile, providing search/positioning, and coordinating with other maintenance programs.

Below is a structured explanation, section by section:

---

## 1. Header, Comments, and Version Log

- **Header Block:** Describes the program, its purpose ("Kundeprosjekt, vedlikehold" = Customer Project Maintenance), customization history, and change log with version numbers, dates, and descriptions.
- **Indicators Usage:** Lists standard RPG indicators and their program meanings (e.g., LR = end program, 10 = Roll, 12 = Sfldsp/display subfile, etc.), and work indicators (80-99).
- **Field Explanations:** Describes the usage of various working variables for subfile handling (e.g., w_fcrn = first record number on page).
- **Screen Layout Notes:** Describes which display formats/screens are used for different functionality.

---

## 2. File Declarations (`F`-specs)

- **Physical/Logical Files:**
  - `fkpspf`: Main customer project file.
  - Multiple logical views of `fkpspf` opened, each with its own purpose (e.g., sorted by different keys).
  - `rkunl1`: Customer master file, used for customer name lookup.
- **Workstation File:**
  - `fl100d`: Display device file, defines screens and the subfile (with subfile record format `b1sfl` and control field `w_srrn`).

---

## 3. Data Declarations (`D`-specs)

- **LDA (Local Data Area) Fields**:  
  - `l_user, l_filg`, `l_firm`, `l_fnav` - user, system, company codes, etc.
- **Display File Feedback Structure:**  
  - `dspfbk` - used for things like cursor position (`d_fcrn`).
- **Key Fields for File Access:**  
  - Variables for holding keys to access logicals (e.g., `fkprlr_kund`, etc.).
- **Subfile and Working Fields:**  
  - Used for subfile page calculations, record counters, etc.
- **Other Variables:**  
  - Working fields for filtering, lookup, etc.
- **Constants:**  
  - `c_sfil` sets subfile page size to 11.
- **"Lo" and "Up"**:  
  - Lowercase and uppercase Scandinavian characters for possible case-handling.
- **Field-purpose Comments:**  
  - Further details the usage of subfile-related working variables.

---

## 4. Mainline Logic

### Initial SQL setup (for data formatting):

```rpg
6.3q C/Exec SQL
6.3q C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
6.3q C/End-Exec
```
Ensure date format and collation matches Norwegian standards.

### Main Screen Handling Loop

- **Tags and FLOW:**  
  - `b2taga`, `b2tagb`: Control flow for alternating display/update of main subfile screen.
- **Subfile Display & Function Key Handling:**  
  - Write out the command line (`b2cmd`), then enter main subfile loop (`dsp_subfile`).
  - Standard function keys (F3/F12 = exit, F4 = inquiry, F5 = refresh, F6 = new entry, PgUp, PgDn etc.) handled via `select` statement.
  - Various function keys call relevant subroutines (e.g., F4: inquiry, F5: refresh, F6: create new, etc.).
  - F1 = filter, F9 = repeat search, F13/F14 = additional maintenance screens.

---

## 5. Subroutines

### 5.1. Subfile Management

- **forny:** Refreshes subfile based on current position/filter criteria, sets logical file position, clears and reloads subfile.
- **søk:** Initiates a search, calls external program `AS700R` to split user search text into search keys, reloads subfile with search result.
- **posisjoner:** Positions to a record based on various keys (customer no, project no, name, sales rep, or external project), then reloads subfile.
- **subfile:** Core subfile processing loop. Reads changed subfile rows, and based on user choice invokes edit, copy, delete, or view logic.
- **xc1bld:** Handles the "new row" pop-up, validating input and calling maintenance subroutine.
- **xc2bld:** Calls the core maintenance program for add/update (external `FL105R`), retrieves updated values for display.

### 5.2. Delete and Copy Screens

- **xd1win:** Handles the "delete window", calls external delete program `FL400R`.
- **xk1win:** Handles "copy" window logic, validates input and then processes the copy by calling edit screen.

### 5.3. Subfile Clear & Create

- **clr_subfile:** Clears the current subfile (using indicator 14).
- **crt_subfile:** Fills the subfile, either via cursor/SQL search or by sequential read, applies filters (firm, expired, external project, customer, etc.), writes to subfile record by record.

### 5.4. Subfile Paging

- **bck_subfile:** Handles subfile page-up logic, manages back-paging by reading previous records and filling a page.
- **dsp_subfile:** Displays the subfile, toggling display indicators, managing cursor positioning.

### 5.5. Inquiry Routines

- **spørring:** Handles field-level inquiry (F4) for customer or sales rep, calls inquiry programs `RK500R` (customer) and `RA509R` (sales rep).

### 5.6. Newlook String Cleaning

- **newlo_vask:** (Free-form RPG) Cleans string fields, removing trailing periods or colons to avoid display errors in "Newlook" UI.

### 5.7. Initialization

- **\*inzsr:** Program initialization. Prepares key lists, fetches company code, enables initial indicators, sets today's date, fills the subfile, and checks if maintenance functions for special prices and rebates should be shown by calling external program `CO402R`.

---

## 6. Key Lists

Multiple `klist` structures define composite keys for logical file access:
- By customer/project, external project, name, seller, etc.
- Used to position logical files for fast access based on user criteria.

---

## 7. Filters, Search and User Experience

- **Subfile Filters:**  
  - Handles showing only expired (or non-expired) projects, or only projects for a selected customer or external project.
- **Search:**  
  - Flexible search using user input, broken into up to five tokens for advanced substring searching.
- **Positioning:**  
  - Allows quick navigation via customer, project, name, seller, or external project number.
- **User-Friendly Design:**  
  - Multiple function keys, pop-up windows for editing/copying/deleting, inquiry pop-ups for selection assistance.

---

## 8. Integration Points and Extensibility

- **External Program Calls:**
  - `FL105R`: Customer project maintenance (add/update)
  - `FL400R`: Delete project
  - `FL505R`: View details
  - `RK500R`: Customer selection
  - `RA509R`: Seller selection
  - `CO402R`: Checks control flags for special prices/discounts.

---

## 9. Notable Enhancements (from Comments)

- **Filters on external project number, possibility to show/hide expired, and string manipulation for new GUI compatibility.**
- **Expanded fields and data lengths (email, seller no, etc.)**

---

## 10. General Code Structure and Style

- **Traditional ILE RPG (mostly fixed-form; some free-form for string cleaning).**
- **Strong use of indicators and DO/SELECT for flow control.**
- **Clear separation of concerns for subfile operations, pop-up maintenance, and inquiry logic.**
- **Heavy reliance on display files (DDS) and external maintenance programs (for CRUD operations).**
- **Consistent use of key fields and working storage for fast subfile and filter handling.**

---

## 11. Summary Table for Key Variables

| Variable       | Description                                           |
|----------------|------------------------------------------------------|
| `w_fcrn`       | First record number on current subfile page          |
| `w_srrn`       | Relative record number in subfile                    |
| `w_ssrn`       | Last record number on subfile page                   |
| `w_sfrn`       | First record of last page                            |
| `w_spge`       | Subfile page size                                    |
| `w_seqe`       | Sequence indicator for search/positioning            |
| `b_oppr`       | Flag: in "create new" mode                           |
| `b_forn`       | Flag: refresh/renew screen                           |
| `b_anul`       | Flag: "anul" (cancel) mode (not in current code)     |
| `b_feil`       | Flag: error/validation failed                        |
| `b_open_sok`   | Flag: open SQL search needed                         |
| `b2kund`       | Positioning/search by customer                       |
| `b2kpro`       | Positioning/search by project                        |
| `b2navn`       | Positioning/search by name                           |
| `b2epro`       | Positioning/search by external project               |
| `b2selg`       | Positioning/search by seller                         |

---

## 12. Key Takeaways for New Developers

- **Subfile Control:** The majority of the program's complexity revolves around subfile display, search, positioning, and navigation.
- **External Calls:** Maintenance logic for add/update/delete is handled in external programs (FL105R, FL400R, etc), this program coordinates their calls and updates the subfile accordingly.
- **Filtering/Search:** Offers multi-field, flexible searching and filtering, with user-friendly inquiry windows.
- **Maintainability:** Look out for indicators and logical file positioning; changes in DDS/display file or underlying file indexes could impact how the program works.

---

### If onboarding, pay close attention to:
- The different logical file views for positioning and filtering.
- Subfile paging logic (forward/back).
- How search and filter values are prepared and used.
- Integration points to other programs and what parameters are passed.
- Usage of indicators for display logic.

---

**Overall:**  
FL100R implements a robust, interactive subfile interface for customer project maintenance, with advanced filtering, positioning, search, and full CRUD support via integration with other business modules. This code is a classic example of RPG/400 subfile management with modern enhancements for usability.