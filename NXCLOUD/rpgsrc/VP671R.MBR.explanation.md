# Program VP671R – Price File for Customers

This ILE RPG program is a highly parameterized and versioned batch utility for exporting product and price information from a set of AS/400 (IBM i) database files, supporting multiple output formats for various customers and external systems (e.g., NOBB, CORRADO, REGNEARK, HOLTE, LOGIQ, IBX). The code is mature, with a long change history, and is organized around extensible data structures, subroutines, and parameter blocks.

Below is a structured onboarding-style breakdown explaining the main elements:

---

## 1. **Purpose and Context**

- **Purpose**: To export product pricing data for customers, supporting many formats required by different partners, systems, and spreadsheets.
- **Output Variants**: Each output format (BYGGDATA, NOBB, CORRADO, REGNEARK, etc.) has a corresponding data structure ("record format") and an output file.
- **Customer/Project Specifics**: Numerous version-specific rules, controlled via parameters, determine what product information is selected, how it’s filtered, and how the output is composed.

---

## 2. **File Declarations**

- The `F` specs declare input/output files for master data (products, customers, prices, units) and for all the required output files.
- Files are renamed to expose record formats in a clear and encapsulated way.
- Example:
  ```rpg
  ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
  ```
  This opens the file `fstsl1` for input keyed access (likely a status table), using the record format `fstsl1r`.

---

## 3. **Data Structures**

- **Parameter Blocks**: Large *datastructures* define the fields for passing pricing calculation requests and receiving their results. These overlays allow a fixed-length buffer to be used with different views for different fields.
- **Record Format Structures**: Each export type gets a DS (e.g. `d_bs` for BA-KALK, `d_bd` for BYGGDATA, `d_nobb` for NOBB, etc.) describing the output record layout in detail, often with overlays to facilitate byte-level or field-level moves.
- **Example**:
  ```rpg
  d d_bd                         261
  d  d_bd_ogrp                     2  0 overlay(d_bd:  1)
  d  ...
  d  d_bd_vare                     8    overlay(d_bd: 23)
  d  ...
  ```

---

## 4. **Main Parameter Variables**

- All processing is controlled by a large list of parameters (see the `*entry plist` in *inzsr). These specify the company, customer, output format, product selection criteria, and output file variant.
- **Selection variables** include group, supplier, assortment, warehouse, etc.
- **Format variables**: Control what output format to use and which columns to show.

---

## 5. **Program Flow**

#### a. **Entry/Initialization (`*inzsr`)**
- Receives all main parameters via *plist.
- Builds the various key lists for file access.
- Sets up warehouse and other default variables.
- May adjust warehouse (`w_lage`) if a GLN number (global location number) is specified.
- Handles output format specific header writes (e.g. writes IBX header if selected).
- Loads price group by calling `VL712R`.

#### b. **Main Processing (`C` spec Procedural Flow)**
- **Check for NOBB Format**: If output is NOBB or NOBB_INT and required status is not found, exit early.
- **Get Company/Firm Info**: Reads firm record, translates Norwegian letters for ANSI compatibility for some formats.
- **Get Customer Info**: Looks up customer for use in output.
- **Write Header Rows**: If the output format is CORRADO or REGNEARK, writes column headers to the output file.
- **Determine What Products to Process**:
    - By product group (`behandl_vgrp`)
    - By supplier (`behandl_ldor`)
    - By assortment (`behandl_vsor`)
    - Or the full product database (`behandl_tot`)
- **For Each Product**: Calls the `behandling` subroutine to perform full price and record logic, then goes to the next product.

#### c. **After Processing**
- Updates distribution list with last price transmission date (for tracking and incremental sending).

---

## 6. **Product Processing and Filtering (`behandling` Subroutine)**

For each selected product:
- **Filters out**: Non-distributable products, expired/discontinued, "special" products if not selected, etc.
- **Price Calculation**: Populates the parameter buffer for the pricing calculation program (`VP90XR` or `VP900R`), passes all needed context, and gets pricing details via a program call.
- **Text/Group Handling**: Loads undergroup text, supplier text, and additional attributes via keyed lookups.
- **Output Format Handling**: Jumps to the specific subroutine for the selected record format (e.g., `ba_kalk`, `byggdata`, `regneark`, etc.), which sets up the format-specific output structure and writes it to the corresponding file.

---

## 7. **Subroutines for Output Formats**

Each output format has a dedicated subroutine that:

- **Calculates prices** for the various units (up to three, for formats supporting multiple units).
- **Deals with discounts** (rabatt), net prices, and gross prices according to contract and customer rules.
- **Looks up and formats additional fields** as needed (EAN numbers, supplier names, group texts, etc.).
- **Handles language/character translation** for systems requiring ANSI or special characters (e.g., Norwegian characters for Corrado, Regneark).
- **Composes output records** using the corresponding data structure, moves the fields, and writes the record.
- **Some formats** (e.g., LOGIQ, IBX) issue one or more header lines and have increased richness (e.g., images, URLs, formatted EHF/EDI mappings).

---

## 8. **Supporting Subroutines**

- **enheter**: For each product, fetches up to three possible price/sales units and their conversion factors.
- **gml_varenr**: Attempts to retrieve old/previous item numbers for backward compatibility or customer mapping.
- **tilb_sjekk**/`hent_tilb`: Looks for special offer prices at group or supplier level for applicable formats.
- **sjekk_saen1**: For REGNEARK2 format, confirms pricing unit vs. sales unit 1.

---

## 9. **Key Handling**

- Key lists are defined in the initialization section, using the various selection parameters and variables. They enable efficient indexed access to product, customer, group, and offer files.

---

## 10. **Special Features / Advanced Behaviors**

- **Internationalization**: Deals with Norwegian characters, mapping to ANSI for some partner formats.
- **Highly Dynamic**: Almost every aspect (selection, output fields, calculation) can be customized by input parameter or by customer/project.
- **Defensive Coding**: Output is skipped if data problems (missing EANs, supplies, status issues, etc.) are detected.
- **Rich Change Management and Comments**: The program contains in-line version history, usage notes, and comments for most conditional logic (sometimes in Norwegian).

---

## 11. **Program life cycle**

- The program is **batch and stateless**: starts, processes all selected items, and exits.
- **All selection/state** comes from parameters (via *ENTRY list).
- At the end, LR is set (`*inlr = *on`) to close all files.

---

## 12. **Legacy and Style Notes for the New Developer**

- **C-spec and fixed-format style** – Use of `C` for logic, `F`/`D` for files and data structure. Some modern RPG IV syntax is present, but the program is predominantly traditional fixed-format RPG.
- **Business rule knowledge is key** – Much of the program's complexity stems from mapping business/contract logic to the output. Be prepared to refer to both the program and external specs.
- **Expandable** – New output formats and fields can be added by following the established DS/subroutine pattern.

---

## 13. **Typical Flow in Practice**

1. **External job/program** invokes this RPG program, passing firm, customer, output format, and product-section parameters (assortment, groups, etc.).
2. The program **selects products** by the given criteria.
3. For each product:
    - Looks up all necessary master data.
    - Calls pricing logic to get net/gross price, discounts, etc.
    - Looks up additional info (supplier, EAN, texts).
    - Outputs a record according to the required format.
4. After all products, updates customer distribution status.

---

## 14. **Operational Note**

- **External Programs Called**: The program relies on pricing (`VP90XR`/`VP900R`), VAT (`RS755R`), product texts, and assortment programs to deliver accurate data.
- **Output Files**: Many – you need to know which file is written for which format, as per the F specs and write operations.
- **Modularity**: Adding a new format involves creating a new DS for its record format, a subroutine for output, and updating the main `behandling` subroutine’s SELECT block.

---

# **Summary for Getting Started**

To onboard new developers:

- **Understand parameters**: Know which parameters drive product and output selection.
- **Know the record formats**: Each format has a DS and a write subroutine; learn how to add new ones or modify existing ones.
- **Follow subroutine structure**: Filtering, pricing, and record writing are modular and can be worked on independently.
- **Business rules are king**: Selection, filtering, and transformation are tightly linked to business requirements and customer expectations.
- **Ask questions**: If business rules are unclear, consult comment history or business analysts.

---

**Tip**: When troubleshooting, set up test runs specifying minimal selections and print key variables before each write for debugging! And always check if recent changes to the logic have been documented in the in-line change log.