# FO554R – Documentation

## Purpose and Overview

**Program FO554R** is designed to allow users to search for and select an order number (*bestillingsnummer*) from a list, using a subfile-based interactive display. This is typically used as a lookup or selection pop-up in the context of order processing or related business flows.

The program is part of the ASOFAK system and interacts with the **SIHELK** physical file (renamed as SIHEPKR in the program) and a workstation display file **FO554D**. The business logic is tightly coupled with subfile handling, allowing users to page, scroll, and select from potentially large lists of order numbers.

## File Definitions and Interactions

- **SIHELK (renamed SIHEPKR):**  
  Used as the source for order records. Accessed with keyed operations for efficient lookups and paging.
- **FO554D (workstation display):**  
  Implements the subfile interface, including subfile records (B1SFL) and control records (B2CTL, B2CMD).

## Parameters

The program receives the following parameters (all are likely order-related keys):

- `p_firm` – Company/firm code.
- `p_numm` – Order number.
- `p_ornr` – Order reference number.
- `p_aarr` – Order year.

These are used to position and filter the list of orders presented to the user.

## Key Variables and Subfile Management

The program makes extensive use of subfile-related variables:

- `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` – Subfile record and page management:
  - `w_stel`: Subfile record counter.
  - `w_spge`: Page size (number of records per subfile page).
  - `w_srrn`: Current relative record number.
  - `w_sfrn`, `w_ssrn`: First and last record numbers on the current page.
- `b_valg_ok` – Signals that a selection has been made.
- `b_eof` – End-of-file flag for reading SIHELK.

## Screen Layouts

The display file FO554D comprises:
- **B1SFL:** Subfile record format.
- **B2CTL:** Subfile control format.
- **B2CMD:** Command key screen, possibly for function key handling.

## Indicator Usage

The program adheres to a strict indicator convention, as documented in the header. Notably:
- `*INLR` – End program.
- `*IN10`, `*IN11`, ... – Subfile paging and function keys.
- `*IN14`, `*IN15` – Subfile clear/end.
- `*IN22` – Cursor placement.

## Program Flow

### Initialization (`*INZSR`)

- Parameters are received and assigned to working variables.
- The SIHELK file is positioned using the provided keys.
- The subfile is filled (`crt_subfile`) with the initial set of records.

### Main Loop

1. **Display Command Screen (`b2taga`):**  
   The B2CMD screen is written.
2. **Display Subfile (`b2tagb`):**  
   The subfile is displayed via `dsp_subfile`.
3. **Function Key Handling:**  
   Depending on the function key pressed:
   - Exit keys (`*INKC`, `*INKL`): End program.
   - Refresh (`*INKE`): Refresh subfile data (`forny`).
   - Roll/Page (`*IN10`): Add more records to the subfile (`crt_subfile`).
   - Home (`*IN21`): Set `*IN22` for cursor placement.
4. **Subfile Processing (`subfile`):**  
   Handles user selection from the subfile. If a selection is made (`b_valg_ok`), the program exits.
5. **Repeat:**  
   The loop continues until the user exits or makes a selection.

### Subfile Routines

- **`forny`:** Refreshes the subfile, re-chaining to the first record if needed, clearing and refilling the subfile.
- **`subfile`:** Reads user input from the subfile, detects selection (`b1valg = 1`), and sets output parameters accordingly.
- **`clr_subfile`:** Clears the subfile and resets related counters and indicators.
- **`crt_subfile`:** Fills the subfile with additional records from SIHELK, up to the page size or end of file.

### Display Routine

- **`dsp_subfile`:** Displays the subfile control screen, setting appropriate indicators for display attributes.

## Notable Design and Business Logic

- **Subfile Paging:**  
  The program supports paging through large result sets using a fixed page size (`c_sfil = 10`). Users can roll forward to load more records.
- **Selection Mechanism:**  
  Users select an order by setting `b1valg` to 1 in the subfile. The selected record’s keys are returned via the program parameters.
- **Cursor and Home Key Handling:**  
  Special logic is present for cursor placement and returning to the home position, using indicator 22.
- **Refresh Logic:**  
  The refresh (`forny`) routine ensures the subfile view is consistent with the current database state, especially after navigation or data changes.

## Interactions and Dependencies

- **SIHELK Table:**  
  All order lookup and paging is performed against this table. The key structure is based on company and order number.
- **Display File (FO554D):**  
  The user interface is tightly coupled to the display file’s subfile and control formats.
- **External Conventions:**  
  The program relies on external conventions for indicator usage, subfile layout, and parameter passing, which are shared across the codebase.

## Versioning and Maintenance Notes

- The program header tracks significant changes, including expansion of the number series and GUI-related adjustments.
- Some logic (notably related to date handling) is commented out or marked for DDS-only GUI compatibility, indicating adaptation for new presentation layers.

## Summary

**FO554R** is a subfile-driven selection program for order numbers, designed for integration into broader order processing workflows. It demonstrates standard subfile paging and selection patterns, with careful indicator management and parameter-based communication. Knowledge of the SIHELK table structure and the display file FO554D is essential for effective maintenance or extension of this program.