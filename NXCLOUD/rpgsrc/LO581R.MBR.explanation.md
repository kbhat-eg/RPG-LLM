# Documentation: Program LO581R

## Overview

**Program Name:** LO581R  
**System:** ASLAGR  
**Description:**  
LO581R is responsible for generating a log report (typically order line changes), printing it, and, if applicable, sending the report as an email attachment. The program reads from a workfile (`FWBOLU`), writes the log to a printer file (`LO581P`), and, depending on parameters and data, triggers email delivery with the log as a PDF attachment.

This program is typically invoked as a follow-up to order processing routines, where changes or updates to order lines must be logged and communicated.

**Key Functions:**
- Reads log entries from a workfile.
- Generates a formatted report (printer file).
- Optionally produces and emails a PDF of the report.
- Cleans up the workfile after processing.

---

## File and Data Definitions

### File Declarations

- **FWBOLU**:  
  Workfile containing log entries for order processing.  
  - Mode: Update, keyed, external, renamed to `FWBOLUR`.
- **LO581P**:  
  Printer file for the log report.  
  - Mode: Output, externally described, user open.

### Data Structures and Variables

- **fwbolu_numm/suff**:  
  Key fields for reading/deleting specific entries in `FWBOLU`.
- **w_firm**:  
  Current company/firm identifier, used for keying and headers.
- **w_date/w_time**:  
  Timestamps for report generation.
- **w_fra/w_subj/w_mtxt**:  
  Email sender, subject, and message text.
- **w_tell**:  
  Counter for lines processed (used to determine if email should be sent).
- **b_prnt/b_send**:  
  Flags for controlling report heading output and whether to send an email.
- **p_***:  
  Parameters passed to the program (order number, suffix, email addresses, subject, message lines, contact names).

### Data Areas

- Uses the User Data Area (`*DTAARA`) for session/user context (firm, user, etc.).

---

## Main Processing Flow

### 1. Initialization (`*INZSR`)

- Receives parameters from the calling program (order info, email addresses, etc.).
- Loads session data from the User Data Area.
- Sets up key fields for reading from `FWBOLU`.
- Opens the printer file (`LO581P`).

### 2. Main Logic

#### a. Log Processing

- Checks if `l_mail = 1` (emailing enabled).
- Reads log entries from `FWBOLU` using key fields.
- For each entry:
  - Calls subroutine `prt_line` to write a detail line to the printer file.
  - Sets `b_send = *on` if any lines are processed.

#### b. Report Finalization

- Writes total/totals line to the report (`t1tot`).
- If `b_send = *on` (i.e., at least one line processed):
  - Calls subroutine `spoolnbr` to retrieve spool file information for the generated report.
  - Closes the printer file (note: order of close is business-specific and was changed in a recent version).
  - Calls subroutine `xml_create` to initiate the email sending process (via external program `AP626R`).

#### c. Cleanup

- Calls subroutine `rydd_wf` to delete processed log entries from `FWBOLU`.
- Sets LR indicator to end the program.

---

## Subroutines

### prt_line

- Writes the report header if not already printed.
- Writes detail line for each log entry.
- Increments `w_tell` for specific types (`wftype = 'FRA'`).
- Handles page overflow by rewriting the header.
- Sets `b_send = *on` to indicate that the report should be emailed.

### spoolnbr

- Calls IBM API `QSPRILSP` to retrieve spool file attributes (name, job, number, etc.).
- This info is required for the email attachment.

### rydd_wf

- Deletes all processed entries from the workfile `FWBOLU` (using key fields).

### xml_create

- Sets up parameters for email generation.
- Determines the sender address (`w_fra`), preferring the provided parameter (`p_ema2`) if present, otherwise using a default.
- Calls external program `AP626R` to send the email with the report as a PDF attachment.
- Passes all necessary parameters (spool file info, email addresses, subject, message lines, contact info).

---

## External Interfaces

### IBM API: QSPRILSP

- Used to retrieve information about the last generated spool file for the current job.

### External Program: AP626R

- Handles the actual creation of the email and PDF attachment.
- Receives spool file and email parameters.

---

## Business and Domain-Specific Logic

- **Order Processing Context:**  
  The program is tightly coupled to order line management, logging changes, and communicating them to stakeholders (e.g., customers, internal staff).
- **Conditional Emailing:**  
  Email is only sent if there are relevant log entries. If no lines are processed, no email is sent.
- **Session Data:**  
  Relies on User Data Area for company, user, and session-specific context.
- **PDF Generation:**  
  The email sent includes a PDF generated from the spool file, ensuring recipients receive a formatted, printable summary of changes.

---

## Patterns and Conventions

- **Subroutine Structure:**  
  Core logic is split into subroutines for readability and maintainability.
- **Externalization:**  
  Email sending and PDF creation are handled by a separate program, promoting reuse and separation of concerns.
- **Keyed File Access:**  
  All workfile operations are performed using key fields derived from parameters and session data, ensuring data integrity and isolation per order/session.
- **Flag-Driven Flow:**  
  Use of flags (`b_send`, `b_prnt`) to control when actions (like email sending or header printing) should occur.

---

## Interactions with Other Modules

- **FWBOLU:**  
  Populated by earlier steps in the order processing workflow. This program assumes the workfile is ready for reading and cleanup.
- **AP626R:**  
  Dedicated to email and PDF handling; this program is called with all necessary context after the report is generated.

---

## Non-Obvious Design Decisions

- **Email Sender Logic:**  
  The sender address (`w_fra`) is chosen dynamically; if a secondary email (`p_ema2`) is provided, it is used, otherwise a default is applied.
- **No Email on Empty Log:**  
  If no log lines are present (`b_send = *off`), the program skips email and PDF generation entirely, which avoids unnecessary notifications.
- **Printer File Handling:**  
  The closing of the printer file (`LO581P`) was deliberately moved in the flow to ensure the spool file is complete before email generation.

---

## Summary

LO581R is a reporting and notification utility in the order processing suite. It processes log entries, generates a formatted report, conditionally sends an email with the report attached, and cleans up after itself. All processing is parameter-driven, session-aware, and modular, with responsibilities for email/PDF generation delegated to an external program. The codebase emphasizes clear separation of business logic, robust file handling, and minimal user intervention.