# FW720R – Vendor Item Master Creation (Hov + Dokka)

## Overview

This program, `FW720R`, is a batch utility for creating and updating the vendor item master file for the Hov and Dokka locations. It processes an input file (typically exported from a template spreadsheet), parses and transforms each record, and writes it to the vendor item master file, applying business rules and data cleansing as needed.

The program is primarily used for mass onboarding or maintenance of supplier item data, where the input is expected to follow a specific fixed-format layout.

---

## File Definitions

- **flvwpf** – Input file (disk, keyed, externally described)
  - Contains item records exported from a template (MAL-regneark).
  - Field `fwirad` is read as the raw input string for each record.

- **flvapf** – Output file (disk, externally described, add-only)
  - Receives transformed and validated records for the vendor item master.
  - Record format: `flvapfr`.

---

## Data Structures

### Input Record Layout (`d_inpu`)
A 256-character buffer is overlaid with fields for parsing:

| Field         | Position | Length | Description                          |
|---------------|----------|--------|--------------------------------------|
| d_vare        | 1        | 15     | Item number (Varenr)                 |
| d_tek1        | 16       | 40     | Item description 1 (Varetekst-1)     |
| d_tek2        | 56       | 40     | Item description 2 (Varetekst-2)     |
| d_sapr        | 106      | 10     | Sales price (Salgspris, as char)     |
| d_sapr_kr     | 1 (of d_sapr) | 7  | Sales price, kroner (numeric)        |
| d_sapr_øre    | 9 (of d_sapr) | 2  | Sales price, øre (decimal)           |
| d_inpr        | 116      | 10     | Purchase price (Innkjøpspris, char)  |
| d_inpr_kr     | 1 (of d_inpr) | 7  | Purchase price, kroner (numeric)     |
| d_inpr_øre    | 9 (of d_inpr) | 2  | Purchase price, øre (decimal)        |

This structure enables direct parsing of fixed-position fields, matching the expected input spreadsheet export.

---

## Parameters

- **p_firm** (3,0) – Company identifier, passed to the program.
- **p_ldor** (6,0) – Additional context parameter (likely location or document number).

---

## Key Variables

- **l_user** – User ID from the local data area (positions 911–920); used for audit fields.
- **w_firm** – Working copy of the company code.
- **w_leng** – Working variable for length calculations.
- **tall** – String constant of digits and space, used for numeric validation.
- **Lo/Up** – Lowercase and uppercase alphabets (including Scandinavian characters), for text normalization.

---

## Main Logic Flow

### 1. Initialization

- Parameters `p_firm` and `p_ldor` are received via the *INZSR subroutine.
- `w_firm` is set from `p_firm`.

### 2. Input Processing Loop

For each record in the input file (`flvwpf`):

- **a. Read and Parse**
  - The raw record (`fwirad`) is loaded into `d_inpu`, which overlays all field buffers.

- **b. Data Cleansing**
  - Item number (`d_vare`) is left-trimmed.
  - Purchase and sales price fields (`d_inpr`, `d_sapr`) are normalized: spaces are translated to zeros to ensure numeric conversion.
  - Item descriptions (`d_tek1`, `d_tek2`) are left-trimmed.

- **c. Character Translation**
  - Special character codes (hex values) are mapped to their Scandinavian equivalents (e.g., `X'46'` to `Æ`, `X'A0'` to `Å`, etc.) for both descriptions.
  - All lowercase letters are translated to uppercase, including Norwegian special characters.

- **d. Output Record Preparation**
  - Output fields are populated, including:
    - Key fields: `fwfirm`, `fwldor`, `fwlvar` (item number).
    - Descriptions: `fwtek1`, `fwtek2`.
    - Prices: `fwinpr` and `fwsapr` (sum of kroner and øre parts).
    - Various flags and default values (e.g., `fwenhe` set to 'STK', `fwhkod` set to 1).
    - Audit fields: timestamps and user IDs are set for creation and update.

- **e. Item Number Formatting**
  - If the item number is not blank and is numeric (checked against `tall`), and its trimmed length is ≤ 8:
    - It is left-padded with zeros to 8 characters and stored in `fwtvar`.
    - This ensures consistent item number formatting in the master file.

- **f. Write Output**
  - The record is written to the output file (`flvapf`).

- **g. Loop**
  - Next record is read; the process repeats until EOF.

### 3. Program Termination

- The program sets *INLR to *ON and returns.

---

## Audit and Tracking Enhancements (Version 6.10)

- Timestamps (`fwodat`, `fwotim`, `fwedat`, `fwetim`) and user IDs (`fwousr`, `fweusr`) are set for both creation and update operations, using system time and the local data area user.
- These fields provide traceability for data changes, as per the June 2023 update.

---

## Domain/Business Conventions

- **Source Data**: Input is expected from a standardized spreadsheet export, with fixed field positions. Any deviation will likely cause parsing errors or data corruption.
- **Text Normalization**: Special handling for Scandinavian characters ensures data consistency despite various input encodings.
- **Item Number Policy**: Numeric item numbers are normalized to 8 digits, left-padded with zeros for downstream system compatibility.
- **Default Values**: Several fields are set to system-wide defaults (e.g., unit 'STK', various flags as zero or one) to align with master data requirements.
- **Auditability**: All changes are timestamped and attributed to the user, using system time and the local data area.

---

## Integration Points

- **Input**: Reads from `flvwpf`, which must be populated (typically by external processes or manual upload).
- **Output**: Writes to `flvapf`, which is the vendor item master file. This file is likely referenced by purchasing, inventory, and other supply chain modules.
- **User Context**: Relies on the local data area for user identification, which must be set by the calling environment.

---

## Notable Design Decisions

- **Overlay Structures**: Heavy use of overlays allows parsing of fixed-position fields with minimal code, but requires strict adherence to input layout.
- **Manual Character Translation**: Explicit translation of hex codes to Scandinavian characters addresses legacy encoding issues from spreadsheet exports or file transfers.
- **Minimal Error Handling**: The program assumes well-formed input; error conditions (e.g., invalid data) are only checked for item number formatting.
- **Batch Orientation**: No interactive processing; designed for unattended, batch execution.

---

## Summary

`FW720R` is a batch conversion and import utility for loading vendor item data from a spreadsheet-based template into the master file, with data cleansing, normalization, and audit tracking. It is a critical component in initial data migration and ongoing mass updates for supplier master data, and must be executed in a controlled environment with validated input. The codebase relies on conventions for field layout, character encoding, and auditability that are consistent across the ASOFAK system.