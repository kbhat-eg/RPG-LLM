# XP990R – Order Processing Core Program Documentation

## Overview

**XP990R** is a central program for order processing within the "2DPOINT" solution. It orchestrates the updating and validation of sales orders, including price determination, inventory updates, customer/project logic, and integration with related modules such as ByggDok (construction documentation) and Cobuilder.

The program is designed to be called by other order-related programs and operates primarily on the order header and order line files, handling a wide range of business rules and integrations.

## Program Structure

### File Declarations

- **Order Header/Line Files**
  - `fohel1`, `fohelu` – Order header (read & update)
  - `fodtl1`, `fodtlu` – Order lines (read & update)
- **Reference/Lookup Files**
  - `vvarl1` – Item master
  - `votyl1` – Order type master
  - `fkprl1` – Customer project
  - `amodl1` – Module registry (for ByggDok/Cobuilder activation)
  - `afpslr` – Properties file (feature toggles)
  - `rkunl1` – Customer master
  - `rukpl6`, `rukrlr`, `ruksl1` – Customer contact and card info
  - `avall1` – Company validation rules
  - `fodmiu` – Shadow/logging table for order line pricing
  - `fbdopf` – ByggDok output
  - `fstsl1` – Internal order reference

### Data Structures

- **Parameter and Work Variables**
  - Parameters for order number, suffix, company, status, etc.
  - Working variables for totals, discounts, flags, etc.
- **Overlay Structures**
  - Used for price calculation input/output, inventory updates, etc.
- **Flags**
  - `b_bdo1`-`b_bdo4`, `b_kper`, `b_best`, `b_bygd`, etc. control flow for ByggDok, bestilling, and other features.
- **Key Lists**
  - Defined for each file access pattern, following the codebase convention for maintaining key order and clarity.

### Main Flow

#### 1. **Initialization (`*inzsr`)**

- Sets up file keys and initializes flags.
- Checks if ByggDok or Cobuilder integration is active by examining module and properties files.
- Determines if validation rules for "leveringsmåte" (delivery method) are enabled for the relevant programs.
- Prepares to check for internal order references.

#### 2. **Entry Point**

- Receives parameters: company, order number, suffix, and status.
- Checks for a valid order header; if not found, sets error status and exits.
- Retrieves the price group for the order.
- Loads order type details.
- Prepares ByggDok/Cobuilder integration flags if relevant.
- Loads customer/project data for further business logic.

#### 3. **Main Processing**

- **Inventory Update (`lager` subroutine):**
  - Loops through order lines, prepares a transfer structure, and calls the inventory update program (`VL001R`) for each line.
  - Optionally triggers ByggDok integration if flagged.

- **Order Status Update (`status` subroutine):**
  - Recalculates line discounts and totals.
  - Updates shadow/logging tables with pricing info (see below).
  - Calls external program (`FA922R`) to update memo balances.
  - Checks if the customer has a credit card (for certain order types).
  - Updates the order header with new totals, status, and project/accounting info from customer/project if applicable.
  - Handles specific business rules for order type assignment (e.g., for handheld/project customers).
  - If the order is a negative internal order, reverses line signs and recalculates.

- **(Optional) Bestillingsbehov (`bestill` subroutine):**
  - Logic for automatic purchase order generation is present but commented out as of version 6.35.

#### 4. **Exit**

- Sets the LR indicator and returns to the caller.

## Key Business/Domain Logic

### ByggDok/Cobuilder Integration

- Activation is controlled by module and property file entries.
- If enabled and relevant for the customer/project, the program attempts to find a contact person with a "BYGGDOK" or "COBUILDER" role.
- Prepares and writes records to the ByggDok output file, prioritizing contact info from the customer project if available.

### Price Calculation and Logging

- Price group is fetched via external program (`VL712R`) based on company, warehouse, and department.
- The program calculates line prices and discounts, calling external programs (`VP900R`, `VP700R`, `VP703R`) for price determination.
- Results are logged in a shadow table (`fodmiu`), supporting later invoice reconciliation and audit.

### Order Type and Project Handling

- Order type details are loaded from the master file.
- For project customers, special logic assigns order types and handles negative/return orders.
- Project and accounting fields are updated on the order header as needed.

### Customer Credit Card Handling

- Checks if the customer has a credit card by searching the customer card and card type files.
- Updates order header fields with card type and status info if relevant.

### Delivery Method Validation

- If company validation rules require a delivery method, ensures this is set and fetches associated text via external program (`RS717R`).

### Negative Internal Orders

- If an internal order is negative, all line signs are reversed, and totals are recalculated by calling an external program (`FO730R`).

## Non-Obvious Design Decisions & Conventions

- **Shadow Table Logging:** The use of `fodmiu` for logging original and calculated prices per line is a custom extension for price traceability.
- **Feature Flags:** ByggDok/Cobuilder and other features are toggled via module and property files, allowing for flexible deployment across customers/firms.
- **Overlay Data Structures:** Heavily used for efficient parameter passing to/from external programs, following a pattern common in this codebase.
- **Key List Usage:** Keys are always defined in `*inzsr` for clarity and code consistency, not inline in each operation.
- **Commented-Out Sections:** Code for automatic bestilling (purchase order generation) is retained but disabled, reflecting changing business requirements over time.

## Integration Points

- **External Programs:**
  - `VL001R` – Inventory update
  - `VP900R`, `VP700R`, `VP703R` – Price calculation
  - `FA922R` – Memo balance update
  - `FO700R`, `FO730R` – Order recalculation/processing
  - `RS717R` – Delivery method text
- **Other Modules:**
  - ByggDok/Cobuilder integration for construction documentation.
  - Validation rules via `avall1` for company-specific requirements.

## Version History Notes

- The program is actively maintained, with changes for domain-specific requirements (e.g., price group expansion, project/accounting integration, ByggDok/Cobuilder support).
- Comments in Norwegian document all significant changes and business rule additions.

## Summary Table of Key Subroutines

| Subroutine      | Purpose                                                        |
|-----------------|----------------------------------------------------------------|
| `lager`         | Inventory update per order line, calls `VL001R`                |
| `status`        | Recalculates discounts/totals, updates order header, logs prices|
| `bestill`       | (Disabled) Automatic purchase order generation                 |
| `sbform`        | Fetches and sets delivery method text                          |
| `byggdok`       | Handles ByggDok/Cobuilder integration and output               |
| `lag_skygge`    | Logs price info to shadow table (`fodmiu`)                     |
| `hent_pris`     | Calls `VP900R` for price calculation                           |
| `hent_prisgr`   | Calls `VL712R` to fetch price group                            |
| `neg_intord`    | Reverses sign on order lines for negative internal orders      |

---

## Onboarding Notes

- **Business understanding is essential:** Many routines are tightly bound to domain logic (construction, project orders, Norwegian market).
- **Expect frequent external program calls:** These are core to the system architecture.
- **Data integrity is enforced via subroutines:** Updates to order headers/lines always recalc totals, discounts, and validate business rules.
- **Feature toggles are common:** Always check module/property files for activation logic.
- **Legacy and ongoing changes:** Some code is retained for reference or future reactivation; always consult version history in comments.

---

For further questions on specific modules, file layouts, or business rules, consult the functional specifications or reach out to the domain experts.