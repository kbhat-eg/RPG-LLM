# IBM ILE RPG Program LI210R – Explanation and Onboarding Notes

---

## Overview

This program, **LI210R**, is designed for warehouse goods receiving, specifically for **scanning and processing SSCC (Serial Shipping Container Code) codes** associated with pallets/colli (goods units) on an incoming packing slip. The program heavily uses subfiles for display and enables the operator to validate, register, and correct scanned pallets, as well as update order and receipt statuses. 

The code is written in ILE RPG (formerly RPG IV), using native database file operations.

---

## High-Level Flow

1. **Authorization Check:** Confirms user/terminal is authorized for this module.
2. **Screen Display:** Presents a subfile-driven interface for scanning and processing pallets/colli.
3. **Function Key Processing:** Handles user actions:
    - Add/scan new SSCC
    - Register colli as received
    - Complete receiving process
    - Reverse/undo scanning
    - Navigate subfile pages
4. **Database Updates:** For each operation, updates multiple tables/files to track status, lock/unlock orders, and maintain receipt integrity.

---

## Key RPG Concepts Used

- **Files Definitions (`F-Specs`):** Multiple physical files, many renamed for program context, are used to represent headers, colli, order lines, etc.
- **Indicators:** Standard RPG indicators are mapped to function keys, file states, etc. (e.g., LR for last record, *INKx for function keys).
- **Data Structures:** Custom DS for LDA (Local Data Area) and display feedback for handling cursor/row positioning.
- **Subroutines (`BEGSR`/`ENDSR`):** Code is modularized into logical operations for clarity and reuse.
- **Subfiles:** Used to display and page through scanned/receivable colli.

---

## Major Data Files

- **LPHOIU/LPHOI1**: Packing slip header (possibly current and staging/alternate).
- **LPKOIU/LPKOI2/LPKOI3**: Colli (pallet) details registered to a packing slip.
- **LPKL/R/LPKL/IU/LIU**: Colli line details.
- **LBHOIU/LBHOI3**: Order header details related to each colli.
- **LBLI/I2/I3**: Order line details.
- **LOHELU**: Locking mechanism for orders.
- **LODTPFR/LODTL1**: Order line details.
- **LI210D**: Display file (workstation), with subfile for listing scanned colli.

---

## Key Variables

- **SSCC Codes** (`w_sscc`, `b2sscc`): Unique identifier for each pallet/colli.
- **Status Fields** (`postat`, `phstat`, `plstat`, `b1stat`): Tracks scan/receive/progress state.
- **Subfile Controls** (`w_srrn`, `w_ssrn`, `w_spge`): Handles paging, record positions in subfiles.
- **Function Key Controls** (`*INKx`): Used to drive main function logic.
- **Flags** (`b_forn`, `b_scan`, `b_eror`): Used to manage special states (e.g., request to refresh subfile, error encountered).
- **Order/Colli Identifiers** (`p_type`, `p_mnum`, `p_aarr`, etc.): Used as keys for database lookups.

---

## Main Processing Flow

### 1. **Authorization**

- Calls AX700R to verify access.
- If unauthorized (`w_tilg = '1'`), program exits.

### 2. **Subfile Display Loop**

- **b2taga:** Writes the command display screen (controls).
- **b2tagb:** Calls `dsp_subfile` to display the subfile with scanned colli and process user input.
- **Function Key Handling:** Processes user commands (scan, register, finish, reverse, navigate).
- **Colli Selection:** After user selects/enters a new SSCC, validates and processes accordingly.

### 3. **Validation & Registration (SSCC Processing)**

- **`sjk_sscc` Subroutine:** Validates the entered SSCC code:
    - Checks if code is entered, exists, and is valid for current packing slip.
    - Checks for manual receiving process being in effect.
    - Sums pending colli for total/counter display.

- **`xb6win` Subroutine:** Registers a scanned colli:
    - Ensures not already scanned.
    - Verifies eligibility (not picked up elsewhere, all references valid).
    - Updates status fields in all related files (colli, order line, etc.)

### 4. **Complete Goods Receiving**

- **`xb7win` Subroutine:** Checks that at least one colli is scanned, then finalizes the goods receiving by calling LI305R.

### 5. **Undo/Reverse Receiving**

- **`xb9win` Subroutine:** Checks if it's valid to reverse scanned colli; resets statuses and unlocks orders where possible. Prevents reversal if already finalized.

### 6. **Subfile Paging and Display**

- **`crt_subfile`/`clr_subfile`/`bck_subfile`/`dsp_subfile`:**
    - Handles building, clearing, paging back, and displaying the subfile with scanned colli.
    - Each subfile line shows colli status, scanned marker, etc.

### 7. **Miscellaneous Operations**

- **`xb8win`:** Switch to EDI packing slips.
- **Lock/Unlock Orders:** When a colli is selected/unselected, order headers are locked/unlocked to prevent concurrent processing.

---

## Function Key Assignments (as per code comments)

| Indicator | Function      | Usage in Code                 |
|-----------|--------------|-------------------------------|
| *INKC     | F3           | Exit program                  |
| *INKL     | F12          | Cancel/Exit                   |
| *INKE     | F5           | Refresh subfile               |
| *INKF     | F6           | Register SSCC as received     |
| *INKG     | F7           | Complete goods receiving      |
| *INKH     | F8           | Switch to EDI mode            |
| *INKI     | F9           | Reverse receiving             |
| *IN10     | Page Down    | Next page in subfile          |
| *IN11     | Page Up      | Previous page in subfile      |

---

## Error Handling

Errors and user messages are shown using soft messages (calls to 'AA005R'), and process is often short-circuited if a validation fails (`goto ...end`, with `b_eror` set).

---

## Special Handling & Business Rules

- **Cannot Re-scan or Reverse Finalized Colli:** Colli with final status (‘90’) or where portions are already completed can’t be reversed.
- **Order Locking:** As colli are scanned, corresponding orders are locked to prevent double-processing.
- **Manual Receiving:** If packing slip is selected for manual receiving, cannot process scan.
- **Status Updates:** When scanning, updating, or reversing, all related files (colli, packing slip, orders) are updated for integrity.

---

## Customization and Enhancements (as per version comments)

- Many fixes and features are tracked by version (e.g., reading all colli, validation of references, prevention of reversal post-receipt, etc.). Code is well-commented regarding what each “KXXX” version change achieves.

---

## Typical Data Flow

1. **User scans SSCC (pallet):**
    - System checks if it belongs to the current packing slip.
    - Updates colli status and associates with the order.
    - Locks relevant order header.

2. **User finishes receiving:**
    - Confirms at least one colli is received.
    - Finalizes the receipt for all scanned colli.
    - Calls additional processes/programs as necessary (LI305R).

3. **User reverses:**
    - If no colli is finalized, resets statuses and unlocks orders.

---

## Onboarding Guidance

- **Start with the subfile architecture:** Understand how paging and display logic works (how `crt_subfile`, `clr_subfile`, and `dsp_subfile` interrelate).
- **Trace one scan to status update:** Follow the data from entering an SSCC through to all affected files.
- **Study error handling:** All blocking conditions are handled early with user feedback.
- **Refer to file field lists:** As files are renamed in code, refer to database file layouts for field origin/usage.
- **Function key map:** Know the UI-to-indicator mapping for rapid navigation.

---

## Summary

This program is a robust, subfile-driven goods receiving application for handling scanned SSCC codes. It manages validation, status updates, error handling, and order locking/unlocking across several files. Its code is modular, with dedicated subroutines for each core function, ensuring maintainability. The versioning comments provide a clear history of ongoing adjustments and business rule changes. 

**For onboarding, focus on understanding the subfile loop, SSCC validation routines, and the file update cascades when scanning, completing, or reversing an operation.**