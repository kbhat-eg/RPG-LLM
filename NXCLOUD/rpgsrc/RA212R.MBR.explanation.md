# Program RA210R – Customer Data Export for Adra Match

## Overview

This program, part of the ASOKON system, extracts and formats customer and invoice information for export to Adra Match, a reconciliation and matching solution. The main function is to read customer, invoice, and payment-related data from several files, assemble complex payment identifiers (KID), and output records in a fixed format for further downstream processing.

The code is written in RPG III/400 (with some RPG IV built-ins), using a traditional cycle with subroutines and file I/O. The business domain is Norwegian accounting, and the program is tailored for handling KID numbers, which are structured payment references used in Norway.

## Files and Data Sources

- **rktrld (rktrpfr)**: Customer main file (renamed rktrldr)
- **rktal1 (rktapfr)**: Customer account details (renamed rktal1r)
- **akidl3 (akidpfr)**: Invoice KID mapping (renamed akidl3r)
- **akidl1 (akidpfr)**: KID check digit lookup (renamed akidl1r)
- **rltrl9 (rltrpfr)**: Supplier-related transactions (renamed rltrl9r)
- **adrktra**: Output file, 256-character fixed record

## Key Data Structures

- **Working fields (`w_*`)**: Hold current values for customer, invoice, KID, bank account, and formatting purposes.
- **KID-related fields**: `w_kid21`, `w_kid22`, `w_kidbv`, `w_kidb2`, `w_kidb3`, `w_kidgn` – represent different KID numbers for various transaction types (main, payment reminders, inkasso, general, etc.).
- **Bank account fields**: `w_bnrbv`, `w_bnrb2`, `w_bnrb3`, `w_bnrgn` – associated with KIDs.
- **krec**: Final output record buffer.

## Program Flow

### Initialization (`*inzsr`)

- Sets up key lists for file access.
- Loads firm number from user data into working variables for KID lookups.
- Receives a function group (`w_fgr`) parameter.

### Main Processing

#### Customer Records

- Loops through customer records, performing the following steps for each:
  1. **KID Lookup**: Attempts to pull KID and bank account numbers from `rktal1` using the current firm and transaction type.
  2. **Fallbacks**: If KID is missing or blank, attempts to retrieve from `akidl3` using constructed keys for:
     - Ordinary invoicing
     - Interest notes
     - Inkasso (collections) notices  
    This is done by manipulating the KID key with customer and invoice numbers in specific positions.
  3. **KID Check Digit**: For each KID found, looks up the check digit in `akidl1` and inserts it into the correct position.
  4. **Formatting**: Converts amounts (replacing decimal points with commas), strips leading zeros from customer and invoice numbers, and formats the date as YYYYMMDD.
  5. **Record Assembly**: Concatenates all fields into a 256-character output record (`krec`) in a prescribed layout.
  6. **Output**: Writes the record to `adrktra` via EXCEPT statement.

#### Supplier Records

- After customer processing, loops through supplier transaction records in `rltrl9`.
- Calls subroutine `lever` for each, which applies similar logic as above for KID and bank account handling, amount formatting, and output.

### Subroutines

#### `lever`

- Processes supplier-related records, applying the same KID, bank, and formatting logic as for customers.
- Outputs the record in the same format.

#### `*inzsr`

- As described above, initializes keys and working fields.

## Business and Domain-Specific Logic

- **KID Construction**: The program dynamically constructs KID keys by embedding customer and invoice numbers at fixed positions, depending on the context (ordinary invoice, interest note, inkasso).
- **Check Digits**: For each KID, the program ensures that the check digit is correct by looking it up and inserting it at the correct position. This is critical for payment matching in Norwegian banking.
- **Fallback Hierarchy**: There is a clear hierarchy for KID retrieval: main record, then invoice, then interest note, then inkasso, ensuring the best possible match.
- **Output Formatting**: The output record is strictly formatted, with fixed field positions and padding, to meet the requirements of downstream systems (Adra Match).

## Notable Design and Implementation Details

- **File Renaming**: Files are renamed in the F-specs to avoid naming conflicts and clarify their role in the program.
- **Manual String Manipulation**: Extensive use of `move`, `movel`, `%subst`, and `%xlate` for precise control over field content and formatting.
- **Debug Code**: There are conditional blocks for debugging specific customer or invoice numbers, left in place for support and troubleshooting.
- **Versioning and Change History**: The code is annotated with changes (e.g., v6.30) and comments for maintainability.
- **EXCEPT Output**: Uses RPG’s EXCEPT statement for writing formatted records, a legacy but effective approach for fixed-format output.

## Interactions with Other Modules

- **Data Dependency**: Relies on the integrity and completeness of the referenced physical files (`rktrld`, `rktal1`, `akidl3`, `akidl1`, `rltrl9`).
- **Output Consumption**: The output file (`adrktra`) is intended for import into Adra Match, or potentially other reconciliation systems.

## Conventions and Patterns

- **KID Handling**: The program standardizes KID construction and validation across all transaction types, encapsulating Norwegian payment reference practices.
- **Field Zero-Stripping**: Leading zeros are stripped from customer and invoice numbers for cleaner output, as required by business rules.
- **Legacy RPG Patterns**: The codebase uses traditional RPG patterns (e.g., MOVE, MOVEL, subroutines, EXCEPT), reflecting its age and the stability required for financial systems.

## Maintenance Notes

- **Extending KID Types**: To support new KID types or formats, update the KID construction and lookup logic in both the main loop and the `lever` subroutine.
- **Output Format Changes**: Any change to the output record layout must be reflected in both the `krec` assembly and the EXCEPT statement.
- **Debug Blocks**: Remove or update debug code as needed for production deployments.

---

### Summary

This program is a robust, business-critical component for exporting customer and supplier transaction data to Adra Match, with specialized logic for Norwegian KID references and strict output formatting. Understanding the relationships between the various files and the detailed KID handling is essential for maintaining and extending this code.