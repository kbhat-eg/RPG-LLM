## Program Overview

This program, **AA015R**, is part of the ASPGPL system and is responsible for the maintenance of PDF parameters in a routine register ("Rutineregister, vedlikehold PDF parametre"). It allows users to view, update, or create records related to PDF handling for specific routines. The program is interactive, using a workstation display file and several physical files, and includes logic for both standard and exceptional ("avvik") maintenance scenarios.

---

## Key Data Sources and Relationships

- **afoppfr / afopl1r, afoplur**: Main physical file for routine PDF parameters. `afopl1r` is the standard record, `afoplur` is for updates.
- **afotpfr / afotl1r**: Template or default values for routines.
- **Display file (AA015D)**: Handles all user interactions.
- **Local Data Area (LDA)**: Used for session/user info (user, company, etc.).
- **External Program AA018R**: Called for exceptional PDF information maintenance.

---

## Main Data Flows

1. **Initialization**:
    - Reads input parameters (routine ID and edit mode).
    - Loads user/session data from LDA.
    - Prepares keys for file access.
    - Loads existing PDF parameter data (if any) or template defaults.

2. **Display/Edit Cycle**:
    - Presents the C2BLD screen for user interaction.
    - Handles user requests: exit, inquiry, or exceptional ("avvik") maintenance.
    - Validates input.
    - Updates or creates records in the PDF parameter file.

3. **Special Maintenance**:
    - If the user requests "avvik" handling, calls subprogram AA018R.

---

## Program Structure

### Header and Indicators

- **Indicators**: The program uses a range of indicators for screen control (rollup, rolldown, subfile handling, error flags, etc.), following a documented convention:
    - 10–15: Display/subfile controls
    - 21–22: Cursor/home key
    - 30: Field protection
    - 31–79: Error/messaging
    - 80–99: Work indicators

### File Declarations

- **afopl1, afotl1, afoplu**: Physical files for routine PDF parameter data.
- **AA015D**: Workstation file (display file).

### Data Area and Variables

- **LDA Usage**: User, company, and firm info are extracted from the LDA for auditing and display.
- **Key Variables**: Used to chain into the physical files for routine lookup and update.
- **Working Variables**: Used for UI state, sequence, operation flags, etc.

### Main Logic

#### Initialization (`*inzsr`)

- Receives routine ID and edit mode as parameters.
- Sets up keys for file access.
- Loads LDA data.
- Chains to the update file (`afoplu`) to retrieve or initialize PDF parameters.
- Calls `ds_splitt` subroutine to populate screen fields with either existing or template values.

#### Display/Edit Loop

- Displays screen (`exfmt c2bld`).
- Handles user actions:
    - **Exit**: On specific indicators, exits display.
    - **Inquiry**: On inquiry indicator, redisplays.
    - **Avvik**: On avvik indicator, calls `pdf_avvik` subroutine (which delegates to AA018R).
    - **Validation**: Checks if input is within allowed range; sets error indicators if not.
    - **Update/Create**: Updates existing record or creates a new one in `afoplu`, stamping with current user and timestamp.

#### Subroutines

- **ds_splitt**: Loads data from `afoplu` or, if not found, from the template file (`afotl1`). Initializes screen fields accordingly.
- **pdf_avvik**: Calls external program AA018R to handle exceptional PDF information for the given routine.
- **Initialization (`*inzsr`)**: As above, sets up state and loads data.

---

## Business/Domain-Specific Logic

- **Routine-centric**: All operations are tied to a specific routine (identified by `ruti`). The user can only edit parameters for that routine.
- **PDF Parameter Maintenance**: The main purpose is to let users maintain how PDFs are handled for each routine (e.g., whether to create PDFs, send mail, archive, use templates, etc.).
- **Template Fallback**: If no specific PDF parameter record exists for a routine, the system falls back to a template (`afotl1`), allowing for defaulting and less data duplication.
- **Audit Trail**: All updates are stamped with user and timestamp from LDA, supporting traceability.

---

## Design Patterns and Conventions

- **Indicator-driven UI**: Follows standard S/36-style RPG indicator usage for UI and logic flow.
- **Separation of Concerns**: File access, UI, and exceptional handling are modularized into subroutines.
- **Externalization**: Exceptional maintenance is handled by a separate program (AA018R), keeping core logic focused.
- **Parameter Passing**: Uses parameter lists for subprogram calls and initialization, supporting modularity.

---

## Interactions with Other Modules

- **AA018R**: Called for exceptional ("avvik") PDF maintenance. Receives routine ID and edit mode.
- **afotl1**: Provides template/default values for routines.
- **LDA**: Supplies user and firm context for auditing and display.

---

## Noteworthy Implementation Details

- **Lowercase Acceptance**: As of version 6.10, the program accepts lowercase input, which may be relevant for user experience.
- **Field Protection**: Edit mode (w_edit) controls whether fields are protected or editable.
- **Subfile Handling**: Although subfile indicators are defined, this specific program appears to only use single-record display (C2BLD), but the conventions are in place for possible expansion.
- **Legacy RPG**: The program uses fixed-format RPG IV, reflecting the codebase’s age and style.

---

## Summary Table: Key Fields and Their Purpose

| Field      | Source/File | Purpose                                         |
|------------|-------------|-------------------------------------------------|
| afprut     | afoppfr     | Routine identifier                              |
| afppdf     | afoplur     | PDF creation flag                               |
| afpmai     | afoplur     | Email sending flag                              |
| afpexl     | afoplur     | Excel export flag                               |
| afparc     | afoplur     | Archive flag                                    |
| afpprv     | afoplur     | Preview flag                                    |
| afplan     | afoplur     | Country/language code                           |
| afpxlm     | afoplur     | XML template                                    |
| afpjas     | afoplur     | Jasper template                                 |
| afplog     | afoplur     | Logo                                            |
| afpeus     | afoplur     | Last updated user                               |
| afpeda     | afoplur     | Last updated date                               |
| afpeti     | afoplur     | Last updated time                               |
| afpous     | afoplur     | Created by user                                 |
| afpoda     | afoplur     | Created date                                    |
| afpoti     | afoplur     | Created time                                    |

---

## Extension Points

- **Adding new PDF parameters**: Extend afoplur and corresponding display fields.
- **Additional validation**: Enhance validation logic before update.
- **Integration**: Additional subprograms can be called for other document types or output formats.

---

## Conclusion

This program is a focused maintenance utility for routine-specific PDF parameters, supporting both standard and exceptional maintenance workflows, with clear separation between data access, user interface, and business logic. It is tightly integrated with the rest of the ASPGPL system via shared files, templates, and external subprograms.