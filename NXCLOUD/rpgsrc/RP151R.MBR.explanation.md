# RPG ILE Code Explanation for RP150R

This RPG program, `RP150R`, is a typical IBM i (AS/400) ILE RPG application from the "prosjekt" system, dealing with querying and displaying the status of projects, including their actuals and budgets at project, subproject, or activity level.

## Program Overview

- **Purpose**: Query and present status (incomes, expenses, budgets, etc.) for a project, which may have sub-projects and activities.
- **Files Used**: The program works with several physical/logical files containing project, budget, accounting, and descriptive information.
- **User Interface**: Uses a display file (`rp151d`) to interact with the user.
- **Init/Entry**: Receives parameters (company, project, subproject, activity) and prepares the data for display.
- **Calculation**: Gathers actual and budget figures, computes variances, and presents the results.
  
## Header and File Definitions

- `h option(*nodebugio) datedit(*dmy)`: Compiler options to remove debug I/O overhead, and edit dates in DMY format.
- Several **file declarations** with `F` specs, most with key access (`k disk`) and external file names renamed to local format.

  Example:
  ```rpg
  frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
  ```

- `cf` spec declares the display file (`workstn`).

## Data Structures

### Local Data Area (LDA)

- Variables like `l_pros`, `l_upro`, `l_akti`, and user info are mapped into the LDA for persistent session state.

### Parameters

- `p_firm`, `p_pros`, `p_upro`, `p_akti`, etc. are the main parameters for company, project, subproject, and activity.

### Key Variables

- Used to construct keys for file access in the logical files.

### Work Variables

- `w_rkst`, `w_kkst`, etc.: Work variables for actual/budget income/expenses and intermediate calculations.

### Constants and Subfile Control

- Subfile and control fields for display management (`b2ctl` record format).

## Main Control Flow

The program is structured as a traditional RPG cycle with tagged control and subroutines (`begsr`/`endsr`).

### Initialization (`*inzsr`)

- Receives input parameters.
- Initializes key lists for accessing the various files.
- Determines which budget alternative to use by calling an external program (`CO402R`).
- Loads project, subproject, and activity descriptive data for display.

### Main Loop

- Writes the start of the display (subfile control format).
- Main display record (`exfmt`) is presented to the user.
- **Function Keys**: If user presses certain function keys, program exits.
- Otherwise, loops back to refresh the screen.

### Data Gathering

#### GetReal (Subroutine)

- Collects **actual (posted) amounts** from the accounting file (`rhtrlc`) for the selected company/project/account.
- Separates income (account 3000–3999) and expenses (4000–4999).
- If subproject or activity is entered, further restricts selection.

#### GetKalk (Subroutine)

- Collects **budgeted values**:
    - If using the "total" alternative, uses a single field from the project master.
    - Otherwise, aggregates budget values from detail budgets (`rpval3`), respecting project/subproject/activity granularity and budget status.

- Both income and expenses are aggregated at relevant levels (master, subproject, activity).

### Calculations

- **Variance Analysis**: Computes differences and percentage variances between budgeted and actual values.
- **Date Handling**: Gets current date in ISO format, transforms it for display.
- **Display Preparation**: Builds the final project path/name for the display.

### External Program Call

- `CO402R`: Determines the active budget alternative to use, via a program call interface (`DCL-PR`/`CallP`).

## Key Points

- **File Keying:** File accesses are always keyed by company and appropriate project/subproject/activity fields.
- **Subfile Control:** The subfile display is managed using standard record formats and function key handling.
- **Parameterization:** The program is highly dependent on runtime parameters for context.
- **Extensible Structure:** By modularizing actual and budget gathering, it’s easy to alter calculations or add further breakdowns.
- **Program End:** Cleans up and returns as per RPG standards.

---

## Code Summary (Example)

```rpg
// Initialization: Set up keys, get display strings, call CO402R for budget alternative
// Main loop: 
//   - Run GetReal (get actuals)
//   - Run GetKalk (get budgets)
//   - Perform variance calculations
//   - Display results until exit key pressed

// GetReal: 
//   For each accounting record for this company, project, account:
//     If income account, subtract amount from income total
//     If expense account, add amount to expense total

// GetKalk:
//   If budget alternative is 'T', get budget from master
//   Else, sum budget detail records for relevant keys and status

// At end: set *INLR = *ON and return
```

---

## Onboarding Tips

- **Keyed File Access:** Understand how logical file keys map to the `klist`/`kfld` constructs.
- **Parameter Flow:** Follow how user input and program parameters control scope of queries.
- **Data Layer:** Familiarize yourself with the company’s project/account structures (file layouts).
- **External Calls:** Know how to use program calls for configuration/settings (like budget alternative).
- **Screen Logic:** Review the display file to understand what is shown to the user.

---

**This program is a classic, robust RPG project status inquiry. With modular subroutines and clear file structure, it should be straightforward to adapt for further needs such as drilldowns, new budget alternatives, or enhanced reporting.**