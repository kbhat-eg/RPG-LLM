```markdown
# Program JL540R Overview

This RPG ILE program displays a screen where the user can select a supplier and a change-date, then calls a print program (`JL541R`) to show stock or price changes history for that supplier.

---

## H-Specification

```
     h option(*nodebugio) datedit(*dmy)
```

- `option(*nodebugio)`: No debug I/O code generated  
- `datedit(*dmy)`: Date fields use DD/MM/YYYY format on screen

---

## File Specifications (F-Specs)

```
     fjstslu    if   e           k disk    rename(jstspfr:jstslur)
     fjl540d    cf   e             workstn
```

1. **Input File** `jstslu`  
   - External, disk file  
   - Keyed access only  
   - Renamed from physical file `jstspfr` to internal name `jstslur`  
2. **Display File** `jl540d`  
   - Workstation file for screen I/O

---

## Data Definitions (D-Specs)

### Local Data Area (LDA)

```
     d                uds
     d l_firm                944    946  0
```

- `l_firm`: Company number loaded from the calling environment (positions 944–946 in LDA)

### Program Variables

```
     d b_feil          s              1      // Error indicator
     d w_firm          s              3  0   // Working company number
     d w_dato          s               d   datfmt(*iso) // Working date in ISO
```

- `b_feil`: Boolean flag (`*on` if input error)  
- `w_firm`: Holds the selected company number  
- `w_dato`: Holds the selected change date

---

## Program Flow

### 1) Initialization Subroutine (`*INZSR`)

```rpg
     c     *inzsr        begsr
     c                   eval      w_firm = l_firm
     c                   eval      b1kevr = 1
     c                   eval      b1kpri = 1
     c                   jstslu_key    chain  jstslu
     c                   if        jaaopd <> *loval
     c     *dmy          move      jaaopd        b1aopd
     c                   endif
     c                   endsr
```

- Sets default company (`w_firm = l_firm`)  
- Initializes selection fields on screen:  
  - `b1kevr = 1` (show EVR filter on)  
  - `b1kpri = 1` (show price-change filter on)  
- Reads the last update date (`jaaopd`) from file `jstslu` and places it into the screen field `b1aopd`

### 2) Main Screen Loop (`B1TAG`)

```rpg
     c     b1tag         tag
     c                   exfmt     b1bld
     c                   if        *inkc or *inkl
     c                   goto      avslutt
     c                   endif
```

1. **EXFMT** displays the screen layout `B1BLD`.  
2. If the user presses **Cancel** or **Exit** (`*INKC`/`*INKL`), go to end.

### 3) Input Validation (`SJ_ECK_INPUT` Subroutine)

```rpg
     c                   exsr      sjekk_input
     c                   if        b_feil = *on
     c                   goto      b1tag
     c                   endif
```

- Calls `sjekk_input` to validate date entry and mandatory fields  
- If an error occurs (`b_feil = *on`), redisplay screen

### 4) Call Print Program

```rpg
     c     *dmy          move      b1dato        w_dato
     c                   call      'JL541R'
     c                   parm                    w_firm
     c                   parm                    w_dato
     c                   parm                    b1kevr
     c                   parm                    b1kpri
```

- Converts screen date (`b1dato`) into internal date field (`w_dato`)  
- Calls `JL541R`, passing:  
  1. Company number  
  2. Change date  
  3. EVR flag (`b1kevr`) – show only suppliers with items in EVR  
  4. Price-change flag (`b1kpri`) – show only suppliers with price changes

### 5) Exit (`AVSLUTT`)

```rpg
     c     avslutt       tag
     c                   eval      *inlr = *on
     c                   return
```

- Sets the last-record indicator (`*INLR = *ON`) to clear program from memory  
- Returns to caller

---

## Subroutine: `sjekk_input`

```rpg
     c     sjekk_input   begsr
     c                   eval      b_feil = *off

     // Check that a date is entered
     c                   if        b1dato = 0
     c                   eval      *in31 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif

     // Check for valid date format
     c     *dmy          test(d)   b1dato   32
     c                   if        *in32 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif

     c     end_sjekk     endsr
```

- Clears `b_feil` at start  
- If `b1dato` is zero (blank), set error indicator and exit subroutine  
- Uses `TEST(D)` to ensure the date is valid; if not, set `b_feil` and exit  

---

### Key Points

- The program enforces two filters:  
  1. Only suppliers with items in the EVR table (`b1kevr`)  
  2. Only suppliers who had price changes (`b1kpri`)  
- The screen is redisplayed until the user either correctly enters a date or chooses to exit  
- On valid input, `JL541R` generates the requested history report
```