# Explanation of RPG Program LX101R

This RPG (Report Program Generator) program, named `LX101R`, is designed for IBM i (AS/400, iSeries) systems. The main function is to process historical invoice records, updating specific files (`LOHE` and `SIHE`) with message numbers from EDI (Electronic Data Interchange), thus linking these records to their respective EDI messages.

## High-Level Description

- **Purpose:** Reads the `LEDI` file and updates the `LOHE` and `SIHE` files with EDI message numbers (`limnum`). This is for better traceability between invoice/order history and EDI documents.
- **Files Involved:**
  - `LEDILR` (invoices/messages from EDI, input)
  - `SIHELK` (statistics or historical orders, update)
  - `LOHELU` (orders, update)
- **History:** The program includes documentation about enhancements, such as extending the message number from 6 to 8 digits.

---

## File Declarations

```rpg
fledilr    if   e           k disk    rename(ledipfr:ledilrr)
fsihelk    uf   e           k disk    rename(sihepfr:sihelkr)
flohelu    uf   e           k disk    rename(lohepfr:lohelur)
```
- `fledilr` is the main input file (LEDI register), key-sequenced.
- `fsihelk` is an update file for SIHE (historical orders/statistics).
- `flohelu` is an update file for LOHE (orders).

The `rename()` clause maps external record formats to internal names.

---

## Data Declarations

```rpg
d sihelk_numm     s                   like(shnumm)
d lohelu_numm     s                   like(lonumm)
d lohelu_suff     s                   like(losuff)
d w_firm          s                   like(l_firm)
```
- Temporary variables used as keys or for updates, defined to match fields in the files.

```rpg
d                uds
D l_firm                944    946  0
d l_user                911    920
```
- Data area fields.
- `l_firm` and `l_user` are likely set via User Data Space (UDS), representing the company and user.

---

## Main Program Logic

```rpg
c     ledilr_key    setll     ledilr
c     ledilr_key    reade     ledilr                                 90
c                   dow       *in90 = *off
...
c     ledilr_key    reade     ledilr                                 90
c                   enddo
```
- The program loops over the `LEDILR` file, reading all records for the current company (`w_firm`). The `setll` and subsequent `reade` establish and continue the keyed read.

### For Each Record:
```rpg
c                   if        linumm > 0 and
c                             limlin = 100001
```
- If the order number (`linumm`) exists and the line number is `100001`:
    - This likely represents a valid, top-level order line.

#### Update in `LOHELU` (Order file)
```rpg
c                   eval      lohelu_numm = linumm
c                   eval      lohelu_suff = lisuff
c     lohelu_key    chain     lohelu
c                   if        %found
c                   eval      lomnum = limnum
c                   update    lohelur
c                   endif
```
- Sets up keys for the order, attempts to find a matching record in `LOHELU`.
- If found, updates the EDI message number (`lomnum`) for that order.

#### Update in `SIHELK` (Order Statistics/History)
```rpg
c                   eval      sihelk_numm = linumm
c     sihelk_key    setll     sihelk
c     sihelk_key    reade     sihelk
c                   dow       not %eof(sihelk)
c                   if        lisuff = shsuff
c                   eval      shmnum = limnum
c                   update    sihelkr
c                   endif
c     sihelk_key    reade     sihelk
c                   enddo
```
- Loops through matching `SIHELK` history records for the order.
- If the suffix matches (`lisuff = shsuff`), updates the EDI message number.

---

## Program Termination

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- When complete, sets on the last record indicator (`*inlr`) to close files and end the program.

---

## Initialization Subroutine (`*inzsr`)

Used to initialize keys and set starting values.

```rpg
c     *inzsr        begsr
...
c                   eval      w_firm = l_firm
c                   endsr
```
- Sets up key lists for file access based on the company (`w_firm`).

---

## Key Points

- **Main Input:** Reads `LEDILR` for all records belonging to the company.
- **Conditional Update:** Only processes records with a valid order number and main line indicator.
- **Updates:** Both the active order (`LOHELU`) and all history records (`SIHELK`) get updated with the corresponding EDI message number.
- **Keys:** All file access is done by company and order, sometimes including a suffix.
- **Modularity:** Uses key lists and initialization subroutine for clarity and maintainability.

---

## Typical Flow of Data

1. Read all EDI records for a company from `LEDILR`.
2. For each valid record:
   - Update the main order if present.
   - Update all matching historical/statistics records.
3. End program.

---

## Business Value

This program ensures that all order and history records are marked with the correct EDI message number, allowing later processes, queries, or audits to reliably trace which EDI messages relate to which orders or statistics. This is especially important for organizations with complex EDI integration needs and traceability requirements.

---

## Coding Style

- The program uses classic (fixed-form) RPG IV code, with explicit file and key management.
- Documentation is in Norwegian, but code/field names are mostly concise and descriptive.
- In-line documentation and a clear change log help with long-term maintenance.

---

**In summary:**  
LX101R is a utility program that enhances the traceability between EDI records and order/order history by injecting EDI message numbers into related files. This process is keyed per company and order, ensuring accurate cross-referencing.