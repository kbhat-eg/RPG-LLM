# RPG Program RA508R Explanation

## Overview

This legacy ILE RPG program (RA508R) runs on IBM i (formerly AS/400) and implements a subfile-based inquiry screen for "Distrikter" (Districts). It allows the user to scroll through a list of districts, search by code or description, and select a district for return to a calling program.

The code is rich in traditional RPG indicators and is structured around subfile handling patterns common in green-screen (5250) interactive programming.

---

## File Declarations

```rpg
fra08l1    if   e           k disk    rename(ra08pfr:ra08l1r)
fra08l2    if   e           k disk    rename(ra08pfr:ra08l2r)
fra508d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- **fra08l1, fra08l2:** Two logical files over the same physical file, used for different keys (by code and by description).
- **fra508d:** Display file with a subfile (B1SFL), using `w_srrn` as the relative record number.

---

## Parameter & Variable Declarations

### Program Parameters

```rpg
d p_firm          s                   like(rahfir)
d p_hkod          s                   like(rahkod)
d p_htxt          s                   like(rahtxt)
```
- **p_firm**: Firm/company code.
- **p_hkod**: District code (input/output).
- **p_htxt**: District description (input/output).

### Subfile and Key Variables

```rpg
d ra08l1_hkod     s                   like(rahkod)
d ra08l2_htxt     s                   like(rahtxt)
```
- For dynamic setting of keys for subfile positioning.

### Subfile Control Variables

```rpg
d w_stel          s              4  0  // Subfile counter
d w_spge          s              4  0  // Subfile page size
d w_srrn          s              4  0  // Relative record number
d w_sfrn          s                   like(w_srrn) // First record on page
d w_ssrn          s                   like(w_srrn) // Last record on page
d w_firm          s                   like(rahfir)
d w_seqe          s              1    // Sequence indicator
d b_valg_ok       s              1    inz(*off) // Selection made flag
```

### Constants

```rpg
d c_sfil          s              2  0 inz(8)
```
- **c_sfil**: Number of records per subfile page (8).

---

## Indicator Usage

The comments define which indicators are assigned to which functions (scroll, clear, screen control, errors, etc.), following standard RPG/400 practice.

---

## Main Logic Flow

### Entry Tags

```rpg
c     b2taga        tag
c                   write     b2cmd
```
- **b2taga**: Writes the command key display (likely a function key legend).

### Display Subfile & Subfile Paging

```rpg
c     b2tagb        tag
c                   exsr      dsp_subfile
```
- **b2tagb**: Display subfile page.

#### Cursor Positioning Calculation

```rpg
c                   if        w_curn > 0
c                   eval      w_sfrn = w_curn / c_sfil
c                   eval      w_sfrn = w_sfrn * c_sfil + 1
c                   endif
```
- Ensures current record and page position are calculated for cursor movement.

#### Function Key Handling

```rpg
c                   select
c                   when      *inkc or *inkl // F3 or F12 = Exit
c                   goto      avslutt
c                   when      *inke           // F5 = Refresh
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10           // F10 = Page Up
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   when      *in11           // F11 = Page Down
c                   exsr      bck_subfile
c                   goto      b2tagb
c                   when      *in21           // Home
c                   eval      *in22 = *on
c                   goto      b2taga
c                   endsl
```
- **F3/F12**: Exit
- **F5**: Refresh display & subfile
- **F10/F11**: Page through records
- **Home**: Reset cursor to start

#### Positioning by Search

```rpg
c                   if        b2hkod <> 0 or
c                             b2htxt <> *blank
c                   exsr      posisjoner
c                   goto      b2tagb
c                   endif
```
- If the user entered a code or description, position to that record.

#### Subfile Handling

```rpg
c                   exsr      subfile
c                   if        b_valg_ok = *on
c                   goto      avslutt
c                   endif
c                   goto      b2taga
```
- Processes selection from subfile; if selected, exit.

---

## Main Exit

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets last record indicator to close files, then returns.

---

## Subroutines

### forny (Refresh Subfile)

- Repositions data pointer and rebuilds the subfile page, based on current search sequence (by code or description).
- Clears & recreates the display subfile.

---

### posisjoner (Position to Search)

- Checks if the user entered a code or description, then sets keys to position to that record in either index.
- Clears and refills the subfile.
- Clears search fields afterwards.

---

### subfile (Handle Subfile Display and Selection)

- Reads subfile (with READC to get changed records)
- If selection made (`b1valg = 1`): sets output parameters and flags successful selection.

---

### clr_subfile (Clear Subfile)

- Uses indicator *IN14 to clear subfile.
- Zeros out subfile counters and page variables.

---

### crt_subfile (Create/Fill Subfile Page)

- Fills the subfile with records up to the page size.
- Reads from the current position (by code or by description).
- If EOF or firm mismatch, sets end-of-list indicator.

---

### bck_subfile (Page Backwards in Subfile)

- Handles logic for paging up in the subfile (using READP to read previous records).

---

### dsp_subfile (Display Subfile)

- Shows the subfile; decides if there are records to display.
- Controls which screen format is shown via indicators.

---

### *inzsr (Initialization)

- Sets up the key lists for file access.
- Initializes main variables with parameter values.
- Positions file to the beginning.
- Fills subfile with the initial set of records.

---

## General Design

This program implements a classic AS/400 subfile maintenance/inquiry pattern:
- Supports search/positioning by both code and description.
- Provides page-up, page-down, and selection function keys.
- Handles record positioning, subfile clearing/filling, and output parameter passing robustly.

---

## Onboarding Notes

- **Subfile structure** (B1SFL, B2CTL, etc.) is central: find these in the display file (DSPF) for field details.
- **Indicators** drive screen logic; refer to the comment block for indicator assignment.
- Uses `setll`, `read`, and `readp` heavily for database navigation.
- The code is classic fixed-format RPG, not free-form. Familiarity with indicator usage is essential.
- Handles both search by code (likely numeric) and by description (text).
- **Parameters out**: the selected code/description are returned to the caller if a record is chosen.

---

## Conclusion

The program is a robust, standard example of interactive subfile handling in an IBM i RPG application. It's structured for maintainability with clear subroutines and copious comments. The main logic is event-driven (function keys, user input), and all CRUD/subfile operations are broken out into reusable routines. 

For extending or debugging:
- Focus on subfile screen definitions in DSPF.
- Mind use of indicators for flow control and screen state.
- Changing file or key structure will require updates at both the database and display logic layers.