# Program MM702R - Sales Update for Past Weeks

## Overview

**Program ID:** MM702R  
**System:** ASLOGI  
**Purpose:**  
This program updates sales statistics for products, looking back over a 5-week period and up to 20 weeks back. It processes sales data, aggregates it per product and warehouse, and updates or inserts weekly sales forecasts into the `mprulu` file. The logic is designed for batch processing and supports various selection criteria for products (by assortment, group, product number, etc.).

**Domain:**  
Wholesale/retail sales, inventory, and forecasting.  
**Language:** RPG (ILE, fixed format).

---

## Main Data Files

- **sstali**: Sales statistics (historical sales transactions)
- **vvarl1, vvarlr, vvarl8**: Product master files (with different key structures)
- **vsdtl6**: Product assortment (assortment/collection of products)
- **vlagl1**: Warehouse stock records
- **mmatl**: Product matrix (for forecast parameters)
- **mprulu**: Weekly forecast/prognosis (target for updates)

---

## High-Level Process Flow

1. **Initialization**
   - Read parameters (date, number of weeks, selection criteria).
   - Establish keys for file access.

2. **Determine Weeks to Process**
   - Using the starting date and number of weeks, build a list of (year, week) pairs for which to update sales.

3. **Product Selection**
   - Products can be selected by:
     - Direct product number
     - Assortment (sortiment)
     - Product group (over-/main-/sub-group)
   - If no specific selection, all products are processed.

4. **For Each Product**
   - Validate against selection criteria.
   - For each warehouse where the product exists:
     - Check warehouse-specific product type and ABC code.
     - For each week in the target period:
       - Aggregate sales from `sstali`.
       - Update or insert weekly forecast (`mprulu`).

---

## Detailed Logic and Notable Sections

### Parameter Handling and Initialization

- Parameters are passed as a 128-byte list, with overlays for each field (assortment, group, product, date, etc.).
- The program reads and parses these into local variables.
- The `*inzsr` subroutine sets up file keys and parses input parameters.

#### Notable:
- The date parameter is adjusted to go back 217 days (approx. 31 weeks), and the number of weeks is set to 26 by default.
- The program reads the user and firm from the LDA (Local Data Area).

---

### Week Calculation (`ukeaar` subroutine)

- Builds arrays `a_aar` and `a_uke` with (year, week) pairs for the processing period.
- Calls external program `AX711R` to determine week/year for each date.
- Skips week 53 (remapped to week 52 for consistency).

#### Notable:
- This ensures the program always works with valid week numbers and aligns with business reporting standards.

---

### Product Selection (`les_utvalg` and related subroutines)

- Depending on parameters, products are selected by:
  - Direct product number (`les_vare`)
  - Assortment (`les_vsor`)
  - Subgroup (`les_ugr`)
  - Main group (`les_hgr`)
  - Over group (`les_ogr`)
- Each of these subroutines reads the relevant product records and calls `beh_vare` for processing.

#### Notable:
- The selection logic is ordered: specific product > assortment > subgroup > main group > over group.
- Each selection subroutine uses the appropriate file and key structure.

---

### Product Processing (`beh_vare` subroutine)

- Validates the product against selection criteria (`rec_ktrl`).
- For each warehouse entry (`vlagl1`) for the product:
  - Checks warehouse code matches (if applicable).
  - Validates product type (`vlvtyp` must be 'L' or 'S').
  - Uses ABC code from warehouse record if present.
  - For each week in the period:
    - Calls `finn_salg` to aggregate sales and update forecast.

#### Notable:
- The program supports warehouse-specific ABC codes and product types.
- Only products with valid types and matching criteria are processed.

---

### Sales Aggregation (`finn_salg` and `les_stat` subroutines)

- `finn_salg`:
  - For each (product, warehouse, year, week), calls `les_stat` to sum sales.
  - If sales found, updates or inserts the forecast (`mprulu`).
  - Handles both update (if record exists) and insert (if not) scenarios.
  - Updates user and timestamp fields for traceability.

- `les_stat`:
  - Reads `sstali` for matching records (product, warehouse, year, week).
  - Sums `sfanta` (sales quantity) for relevant transaction types.
  - Only includes specific transaction types, defined by `mmlt01`...`mmlt10`.

#### Notable:
- The program is robust against missing data and ensures only relevant sales are aggregated.
- Handles both newly created and existing forecast records.

---

### Product Matrix Parameter Check (`les_parm`)

- Checks if a product is present and active in the product matrix (`mmatl`).
- Used to determine if a product should be included in processing based on matrix settings.

---

## Domain-Specific Conventions and Design Decisions

- **Selection Hierarchy:** The code supports multiple, mutually exclusive selection methods for products, prioritizing the most specific.
- **ABC Codes:** If a warehouse-specific ABC code exists, it takes precedence over the product's default.
- **Product Types:** Only products of type 'L' or 'S' are processed (likely "stocked" or "saleable" types).
- **Week Handling:** Week 53 is ignored to ensure year-on-year comparability.
- **Audit Fields:** User and timestamp fields are updated both on insert and update for traceability.
- **Transaction Filtering:** Only certain transaction types are included in sales aggregation, based on predefined codes.
- **Extensibility:** The code is structured for easy adjustment of selection criteria, transaction types, and week calculation logic.

---

## External Dependencies

- **AX711R:** External program used to convert dates to (year, week) and status.
- **File Relationships:** The program relies on consistent keys across product, warehouse, and statistics files. Changes in master data structures must be reflected in key lists and selection logic.

---

## Error Handling and Robustness

- The program is designed to skip over invalid or non-matching records gracefully.
- Invalid dates or parameters cause the program to exit early.
- All file operations check for record existence and handle both found/not found scenarios.

---

## Summary

MM702R is a batch program for updating weekly sales forecasts, looking back over a configurable period. It supports flexible selection of products and warehouses, robust aggregation of sales statistics, and careful update/insert logic for forecast records. The program is extensible and maintains audit trails for all changes, supporting the business’s need for accurate and traceable sales forecasting.

---

## Key Takeaways for New Developers

- **Understand the file structures and key definitions**—they are central to how data is selected and updated.
- **Pay attention to the selection logic**—it determines which products and weeks are processed.
- **Be aware of domain-specific rules** (e.g., week 53 handling, ABC code precedence).
- **Auditability is built-in**—user and timestamp fields are always updated.
- **External program dependencies** (AX711R) are critical for correct week/year calculations.
- **Code extensibility**—the modular structure allows for business rule changes with minimal impact.

If you need to add new selection criteria or adjust aggregation logic, follow the established subroutine structure and update the appropriate key lists and processing routines.