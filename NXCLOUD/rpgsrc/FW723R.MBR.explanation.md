# RPG Program Explanation: FW723R "Danning av leverandør vareregister, Norske Røtter"

## Overview

This ILE RPG program, named `FW723R`, is part of the ASOFAK system and is designed to process supplier product records ("varer") for “Norske Røtter”. Data is read from a source file (presumably loaded from a spreadsheet), normalized (uppercased, special Norwegian characters handled), and written to the supplier product register. The program includes tracking logic for auditing purposes.

---

## Data Definitions

### Files

```rpg
fflvwpf    if   e           k disk  // Input file (produktsource)
fflvapf    o  a e             disk  // Output file (supplier product register)
```

- **flvwpf**: Input file containing product records (possibly from a spreadsheet).
- **flvapf**: Output file where transformed product data is stored.

---

### Local Data Area

```rpg
d                uds
d l_user                911    920
```
- For tracking user information (AUDIT fields).

---

### Data Structures

#### Record Description (`d_inpu`)

```rpg
d                 ds
d d_inpu                       143
d  d_vare                       15    overlay(d_inpu:1)      // Product number
d  d_tek1                       45    overlay(d_inpu:16)     // Product text 1
d  d_tek2                       35    overlay(d_inpu:61)     // Product text 2
d  d_tek3                       10    overlay(d_inpu:96)     // Product text 3
d  d_eann                       13  0 overlay(d_inpu:106)    // EAN number
d  d_enhe                        5    overlay(d_inpu:119)    // Unit
d  d_inpr                       10    overlay(d_inpu:124)    // Purchase price (decomposed)
d   d_inpr_kr                    7  0 overlay(d_inpr:1)      // Purchase kr
d   d_inpr_øre                   2  2 overlay(d_inpr:9)      // Purchase ører
d  d_saim                       10    overlay(d_inpu:134)    // Sales price (decomposed)
d   d_saim_kr                    7  0 overlay(d_saim:1)      // Sales kr
d   d_saim_øre                   2  2 overlay(d_saim:9)      // Sales ører
```
- Reads a 143-byte input record and overlays fields for individual attributes.

---

### Parameters

```rpg
d p_firm          s              3  0  // Company
d p_ldor          s              6  0  // Unknown, likely a document/order reference
```

---

### Working Variables

```rpg
d w_firm          s              3  0
d w_udat          s               d   datfmt(*iso)
d w_mvap          s              6  2  // VAT percent
d w_mvat          s              5  4  // VAT value
d w_mvaf          s             10  9  // VAT factor (for calculation)
d w_vtxt          s             90     // Combined varetekst
```

---

### Constants

```rpg
d Lo              c     'abcdefghijklmnopqrstuvwxyzæøå'
d Up              c     'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅ'
```
- For converting to uppercase, including Norwegian characters.

---

## Main Program Logic

### Initialization

- The *INZSR (initialization subroutine) handles:
  - Accepting parameters (`p_firm`, `p_ldor`)
  - Setting the company working variable (`w_firm`)
  - Retrieving the current date (`w_udat`)
  - Calling program `FØ705R` to get VAT info (VAT percentage, value, and factor)

---

### Main Loop

#### 1. **Read an Input Record**

```rpg
c     read      flvwpf
c     dow       *in90 = *off
```
- Reads from the input file, continues in a loop until EOF.

#### 2. **Map Input to Data Structure**

```rpg
c     eval      d_inpu = fwirad
```
- Moves the current input record to the `d_inpu` data structure so its fields can be accessed.

#### 3. **Text Normalization**

- **Trimming**: Remove trailing spaces from the three text fields.
- **Translate Characters**: Several `xlate` statements are used to translate known problematic byte values (e.g., ASCII/CP437/CP850 code points for Norwegian characters) to the correct Norwegian letters (`æ`, `ø`, `å`).
- **Uppercase Conversion**: Translates all text to uppercase using `xlate` from `Lo` (lowercase) to `Up` (uppercase) for the three text fields.

#### 4. **Preparing Output Record**

- Assigns mapped fields from input to output:
    - Product number, EAN, unit, prices.
    - VAT calculations: sales price is multiplied by a VAT factor.
    - Other fields are set to blank, zero or default as required.
    - A rolling counter (`fwline`) is incremented for each record (possibly a line number).
- Concatenates the three text fields into one (`w_vtxt`), then splits this into two 35-character fields for `fwtek1` and `fwtek2`.

#### 5. **Audit/Tracking Fields**

- Captures operation time and user (`fwodat`, `fwotim`, `fwousr`, `fwedat`, `fwetim`, `fweusr`).

#### 6. **Write to Output File**

```rpg
c     write     flvapfr
```

#### 7. **Read Next Input**

```rpg
c     read      flvwpf
```
- Loop control; gets next record.

---

### End of Program

- Sets the LR (Last Record) indicator and returns.

---

## Special Logic

- **Bestillingsmengde (Order Quantity) Calculation** is commented out, but if enabled, would calculate order quantity based on two fields, `d_antk` and `d_antp`.

---

## Subsystems and Subroutines

### *INZSR - Initialization

- Handles parameter intake and calls external code (FØ705R) to obtain VAT factors.

---

## Summary

- **Purpose**: Imports data from a spreadsheet, cleans and normalizes product records, translates text to uppercase and corrects characters, calculates VAT-inclusive prices, and writes out to a supplier product registration file, all with tracking information.
- **Special Focus**: Norwegian language character support and VAT handling.
- **Auditability**: Enhanced with user and timestamp fields for each output record.
- **Typical Usage**: Run as a batch job to import/update supplier product catalogs.

---

## Key RPG Concepts Used

- **Data Structures and Overlays**: Efficient unpacking of fixed-format records.
- **Character Translation (XLATE)**: Handling of locale/language specific issues.
- **Files & Record Level Access**: Classic RPG read/write logic.
- **Subroutines and Parameters**: Initialization, external program calls for lookups.

---

This program is an excellent example of legacy RPG/400 (or RPG IV in fixed-format) for data transformation and cleansing in a business context, with attention to both technical and business requirements such as audit trails and Norwegian data handling.