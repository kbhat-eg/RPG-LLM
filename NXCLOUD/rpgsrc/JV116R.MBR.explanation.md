# Documentation: Program JV116R â€“ Maintenance of Upsell / Cross-sell (BM Info)

## Overview

**Program:** JV116R  
**System:** ASVADM  
**Purpose:**  
This program provides maintenance and display functionality for upsell ("oppsalg") and cross-sell ("mersalg") information related to products (BM info). It is primarily used to view and update upsell/cross-sell text details associated with a product, along with related product, category, and supplier information.

**Business Context:**  
- "Oppsalg" refers to upsell information tied to a product.
- "Mersalg" refers to cross-sell information.
- The program is designed for maintenance, but as per comments, all BM fields are currently shown in view mode only (`*IN30` is used to indicate this).
- All updates are performed directly to the relevant physical files, reflecting changes immediately.

---

## File Dependencies

The program interacts with the following logical/physical files:

| File Name | Usage | Description | Record Format Alias |
|-----------|-------|-------------|--------------------|
| JVARL3    | Input | Product master (lookup by product number) | JVARL3R |
| JVOML1    | Input | Upsell/cross-sell text master (lookup by object/type) | JVOML1R |
| JVOMLU    | Update | Upsell/cross-sell text update (write/update by object/type) | JVOMLUR |
| JLEVL1    | Input | Supplier master (lookup by supplier code) | JLEVL1R |
| JKATL1    | Input | Category master (lookup by category code) | JKATL1R |
| JV116D    | Workstn | Display file for user interface | N/A |

---

## Data Flow and Structure

### Parameters and Local Data

- **Entry Parameters:**
  - `p_onob`: Product number (key for all lookups/updates).
  - `p_valg`: 1-character option code (usage not shown in code).

- **Local Data Area:**
  - Retrieves user ID (`l_user`) and full name (`l_fnav`) for audit fields.

- **Key Variables:**
  - Variables for constructing keys to access logical files (e.g., `jvoml1_onob`, `jvoml1_otyp`).

- **Working Variables:**
  - `b_feil`: 1-char error flag (not used in current logic).

---

## Main Program Flow

### Initialization (`*INZSR`)

- Loads entry parameters.
- Sets up key lists for all relevant files.
- Retrieves product master data (`JVARL3`) for the given product number.
- Loads product details (number, description) for display.

### Main Processing

1. **Set View Mode:**  
   Sets indicator `*IN30` to *ON, enforcing view-only mode (as per specification).

2. **Display and Edit Loop (`xc2bld` subroutine):**
   - **Clear Display Fields:**  
     Resets all display fields to blank or zero.
   - **Load Product Data:**  
     - Fills display fields with product sorting, supplier, and category information by chaining to `JLEVL1` (supplier) and `JKATL1` (category).
     - Decodes product status (`jvutko`) to human-readable text.
   - **Load Existing Upsell/Cross-sell Data:**  
     - Upsell (`O`): Chains `JVOML1` with type 'O', loads text and dates if found.
     - Cross-sell (`M`): Chains `JVOML1` with type 'M', loads text if found.
     - If not found, clears associated display fields.
   - **Display Screen:**  
     Uses `EXFMT` to display the screen and wait for user input.
   - **Function Key Handling:**  
     - If F3 (Cancel, `*INKC`) is pressed, program exits.
   - **Update Logic:**  
     - On exit from display, writes/updates upsell and cross-sell records in `JVOMLU`:
       - If a record exists, updates text, audit fields, and timestamps.
       - If not, writes a new record with creation and update audit fields.

3. **Program Exit:**  
   - Sets last record indicator (`*INLR`) and returns.

---

## Subroutines

### `xc2bld`

Handles the core logic for preparing, displaying, and updating upsell/cross-sell information for the given product:

- Loads and displays all relevant product, supplier, and category info.
- Retrieves and displays both upsell and cross-sell text (if existing).
- Handles user input and updates the corresponding records with audit information (user ID, timestamps).

### `*INZSR`

Initialization routine:

- Maps parameters to internal variables.
- Sets up key lists for all file operations.
- Loads initial product data for display.

---

## Design Decisions & Conventions

- **File Naming:**  
  All logical/physical files are prefixed (`JV`, `JK`, `JL`) according to business object (product, category, supplier), with suffixes (`L1`, `L3`, `LU`) indicating master, lookup, or update files.
- **Record Format Renaming:**  
  All files are renamed on input for clarity and to avoid conflicts.
- **Audit Fields:**  
  All updates capture user ID and timestamp for both creation and last update.
- **View Mode Enforcement:**  
  The program is currently set to view-only mode (`*IN30`), as per business request.
- **Text Handling:**  
  Upsell/cross-sell text is split into two 50-character fields for display but stored as a single 100-character field in the database.

---

## Integration Points

- **Display File (`JV116D`):**  
  All user interaction is driven through this display file.
- **External Data Sources:**  
  The program integrates with product, supplier, and category master files for lookup and display purposes.
- **Audit Trail:**  
  User and timestamp information is pulled from the local data area, ensuring all changes are tracked.

---

## Noteworthy Points

- The program is designed to be extensible for future edit functionality (currently view-only).
- All business logic is encapsulated in the `xc2bld` subroutine, simplifying future maintenance.
- Key management is handled explicitly via named key lists for clarity and consistency.
- The code uses Norwegian variable and field names, reflecting the domain and user base.

---

## Summary

JV116R is a maintenance program for managing product upsell and cross-sell information. It provides a unified interface to display and (potentially) update BM info, ensuring data consistency across related entities (products, categories, suppliers) and maintaining a full audit trail for all changes. The codebase follows clear naming conventions, explicit key management, and enforces current business rules (view-only mode) as requested.