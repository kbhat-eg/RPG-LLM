# ASOFAK FO182R – RPG Program Explained

This document provides an in-depth explanation of the ILE RPG program `FO182R`. The program’s main objective is to generate invoices in a Logiq/Norgros (EDI) format, with extensive configuration options, audit trails, and detailed output records. The code is a result of many years of development, reflecting various business requirements and data standards.

---

## 1. **Purpose and Functionality**

- The program reads invoice (faktura) data from several database files, processes and formats the information, and outputs records in a specified EDI (Electronic Data Interchange) format.
- It is tailored for Norwegian wholesalers (e.g., Logiq/Norgros format), supporting both regular and collective invoices, credit notes, net pricing, and more.
- The solution handles advanced business logic, such as special invoice types, handling of various VAT (MVA) rates, customer projects, factoring, and logistics.

---

## 2. **Program Structure**

### a. **Header Section**

- Contains details about revisions, authors, and what each version changed.
- `h option(*nodebugio) datedit(*ymd)` and `h decedit('0,')` define compile options, especially for date and decimal formatting.

### b. **File Declarations (F-specs)**

- **Input Files:** Various customer, invoice, product, and reference tables (`frkunl1`, `frkunl5`, `fsohelr`, `fsodtl1`, etc.), all defined as keyed disk files with re-named record formats.
- **Output Files:** Main EDI output (`ffnedpf`) and printer file (`ffo182p`).

### c. **Data Definitions (D-specs)**

- **LDA (Local Data Area):** Used for passing data such as user, workstation ID, and some flags.
- **Work Variables:** For processing lines, amounts, tax computations, array handling (for VAT breakdown), buffer fields for overlays (e.g., numeric string manipulation).
- **Constants:** Field separator (`|`), version string, etc.
- **Procedure Prototypes:** For calling external programs.
- **Switches:** Feature toggles (e.g., to control behavior based on configuration tables).

### d. **Main Logic**

- **Initialization:** Handles input parameter list, file open logic, and setup.
- **Main Loop:** Iterates over the invoice log (facturalogg), processes each eligible invoice, and writes formatted output records with several subroutines for each section of the output.
- **Record Handling:** Divided into header (01), invoice header (10), partner info (20), order header (35), invoice lines (40), discounts (50), text lines (41), and summary/footer (80, 81, 90) – each with different subroutine handlers.

### e. **Subroutines**

Key ones include:

- `gen_fakthod` – Generates invoice header records.
- `skriv_olin` – Writes order header per invoice.
- `skriv_vlin` – Writes invoice line (product/service).
- `skriv_ftxl` – Handles free text lines on invoices.
- `skriv_fslut` – Writes invoice summary footer.
- `write_outp` – Outputs a single EDI-formatted line.
- `sjk_uf_log` / `upd_uf_log` – Manage status of invoice records.
- `sjk_50rec` – Ensures discount lines (50) are written in the correct sequence.
- VAT array handlers (`xarray`), array accumulators for VAT bases and amounts.

---

## 3. **Core Logic Flow**

### Step-by-Step:

1. **Startup**
    - Receives parameters: year, invoice type, (optionally) start/end invoice numbers, rerun flag, report flag, etc.
    - Resets key working variables and prepares file keys.

2. **Firm and Setup Data**
    - Fetches firm data (for sender info), OFAK info, status codes, etc.

3. **Selects Invoices to Process**
    - Depending on run type (normal or rerun), sets appropriate pointers.
    - Loops through the invoice log; for each invoice:
        - Checks if the invoice should be processed (using business and status rules).
        - Fetches associated orders and lines.

4. **Invoice Generation**
    - For each invoice:
        - **Header Record (01)**: Sender/receiver identifiers, message type, date/time.
        - **Invoice Header (10)**: Invoice/credit indicator, number, dates, buyer order references, customer info, KID, contract, collective invoice marker, delivery terms, etc.
        - **Partner Records (20)**: Buyer (BY), seller (SU), invoice recipient (IV), delivery point (DP), each built according to rich lookup and field requirements.
        - **Order Headers (35)**: For collective invoices, outputs order summary lines.
    - For each order line:
        - **Invoice Line (40)**: Product/service code, text, quantities, prices, VAT, etc. Handles special cases for supplier codes, external item numbers, logistics, etc.
        - **Text Line (41):** Optional, for additional free-text per invoice line.

5. **Discount/Allowance Lines (50)**
    - For each applicable line, outputs discount/allowance data.

6. **Footer/Summary Records (80/81/90)**
    - **Sum Record (80):** Invoice totals: net, VAT basis, VAT, gross, totals by VAT rate, rounding, etc.
    - **VAT Breakdowns (81):** Per VAT rate for advanced reporting.
    - **Final Record (90):** End-of-file indicator, total count of invoices/lines.

7. **Update Status**
    - Optionally marks invoices as exported/processed.

---

## 4. **Advanced & Special Handling**

- **Switch-Driven Behavior:** Several `CallP CO402R` calls retrieve config switches (from central config tables) to enable/disable features at runtime (e.g., special handling for factoring, priskode handling, avdeling vs firma info, etc.).
- **Factoring Logic:** Determines if a customer/order is excluded from factoring based on codes/settings.
- **VAT Array Handling:** Aggregates bases and VAT amounts for up to 9 different VAT rates per invoice.
- **Logistics/GTIN/NOBB:** Special subroutines to lookup and populate supplier/logistics-specific fields.
- **Special Customer/Project Logic:** Handles both internal/external customer project numbers.
- **String/Field Sanitization:** Scans output lines for invalid characters before writing (important in EDI).

---

## 5. **Key Data Structures**

- **Arrays:** `mko`, `msa`, `mgr`, `mbe`, etc. used for VAT rate aggregation per invoice.
- **Overlay Data Structures:** For manipulating numbers as character strings for formatting (sign handling, etc.).
- **Extensive Work Fields:** For temporary storage of amounts, strings, codes, dates, etc., to meet the complex output requirements.

---

## 6. **Input/Output Record Types**

Each EDI output line starts with a 2-character record type:

- **01:** Invoice identification
- **10:** Invoice header
- **13:** External references (project numbers, etc.)
- **20:** Party information (buyer, seller, recipient, delivery)
- **35:** Order summary (for collective invoices)
- **40:** Invoice item/line (product/service)
- **41:** Text line
- **50:** Allowance/charge (discounts)
- **80:** Invoice sum/totals
- **81:** VAT rate breakdown
- **90:** End of file (summary)

Each is built according to specifications, separated by the field separator constant (`|`).

---

## 7. **Notable Subroutines**

### `gen_fakthod`
Builds and writes the invoice header section, handling KID, references, customer/project data, delivery, and more.

### `skriv_vlin`
Outputs a line for each invoice item, with extensive logic for item codes, VAT, pricing, and discount handling.

### `skriv_fslut`
Outputs invoice totals, calculating VAT bases for all applicable rates, and special logic for "byggmester-faktura" (builder’s invoices).

### `sjk_uf_log` / `upd_uf_log`
Checks and updates invoice log entries to manage which invoices have been processed/exported.

### `sjk_saml`
Determines if an invoice is a collective invoice and sets associated indicators.

### `xarray`
Manages/fills VAT breakdown arrays.

### `sjekk_minus`
Ensures that numeric values are formatted with a leading minus sign when negative.

---

## 8. **Error Handling and Data Protection**

- Jumps to `avslutt` (exit) if required master data is not found.
- Skips or ends processing gracefully if a document is already exported or does not match selection criteria.

---

## 9. **Configuration and Extensibility**

- Maintains a long list of enhancements, frequently using configuration switches for business logic.
- Uses field overlays and string manipulation for flexible, standards-conformant output.
- External references (calls to other programs) are used for VAT, project, price, and logistics lookups—allowing for modular growth.

---

## 10. **Best Practices and Onboarding Tips**

- **Start from Main Loop:** Focus on how invoices are selected and processed.
- **Follow EDI Record Types:** Each output routine correlates to an EDI section; understand their business requirements.
- **Understand Switch Flags:** Many business functions are controlled by runtime switches—ensure you check these before making business changes.
- **Data Lookups:** Not all data is held in one file; careful attention to when and how lookups (`chain`, `setll`, `reade`) are performed is crucial for both correctness and performance.
- **Maintain Alignment with EDI Specs:** Since output is for EDI, field order, separators, and "dummy" fields (c_fsep fillers) must not be altered without coordination.
- **Review Documentation:** Use the commented change log as an orientation to understand historical drivers for logic.

---

## 11. **Conclusion**

`FO182R` is a robust, industrial-strength RPG program for generating highly formatted electronic invoices according to Norwegian B2B standards. Its modular subroutine structure, heavy use of file lookups, and configuration switches mean it can adapt to many business scenarios, but also require careful onboarding and understanding of both RPG and the business domain.

For onboarding:

- **Trace a single invoice scenario** (from input to output) through the main loop and subroutines.
- **Map data paths:** Be aware of where each key field comes from.
- **Use debug runs:** Since some business logic is switch-driven, test with various feature toggles on/off.

Always verify changes against business (and EDI) requirements, and collaborate closely with business analysts familiar with the invoice/EHF/Logiq/Norgros standards.

---

**If you have a particular section or function you want explained in detail, please ask!**