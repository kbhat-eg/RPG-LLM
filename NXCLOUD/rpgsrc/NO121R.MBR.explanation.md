# NO121R – EDI Order Transfer to Internal Order (Ekstern ordre-hode, overføring av EDI-bestilling til ordre)

## Overview

This program (NO121R) is responsible for transferring external orders received via EDI (Electronic Data Interchange) into the internal sales order system. It handles the mapping and validation of external order headers and lines, creates corresponding internal order records, and ensures business rules (such as credit limit, customer status, and project overrides) are applied during the transfer.

The program is a close variant ("blåkopi") of NO120R, tailored for EDI orders. Over time, it has been extended to handle special cases for certain customers (e.g., Mestergruppen), additional business logic (e.g., memosaldo calculations, credit limit extensions), and integration with other modules (e.g., project and customer registers).

---

## Structure and Main Flow

### File Declarations

- **Input/Update Physical Files:** The program interacts with a range of files representing external order headers/lines, internal order headers/lines, customer/project registers, and various lookup tables.
- **Workstation File:** Used for interactive display (B1BILD).
- **SQL:** Used for specific queries (notably for duplicate offer detection).

### Parameters

- `p_firm`, `p_fsys`, `p_tell`: Company, system code, and external order reference, passed as entry parameters.

### Local Data Area

- Used to retrieve the workstation ID and user.

### Main Logic

1. **Initialization (`*inzsr`):**
   - Reads parameters and initializes keys.
   - Loads company and status info.
   - Retrieves VAT rates and credit extension/memosaldo parameters (including conditional "Utvidet memosaldo" logic via CO402R).
   
2. **External Order Header Validation:**
   - Checks if the external order exists; aborts if not found.
   - Optionally retrieves supplemental EDI/proffnett information.

3. **Order Type Determination:**
   - Uses order type from external order, with fallbacks and overrides (e.g., for system code 'TBU').

4. **Customer and Credit Checks:**
   - Loads customer data; checks for credit stop flags and credit limit violations.
   - Handles memosaldo logic, including extensions for specific customers (Mestergruppen).
   - Checks for "almenning" (common) amount limits, both customer-specific and via subroutine FO106R.

5. **Interactive Display:**
   - Presents summary and validation results to the user.
   - Aborts on user cancel or credit stop.

6. **Order Creation:**
   - **Order Header (`ordre_hode`):**
     - Retrieves next available order number (with possible type override).
     - Initializes and populates the internal order header from external data, customer, and project info.
     - Handles special EDI fields (e.g., delivery terms, top text).
     - If the order is a TBU with a parent reference, checks for an existing offer with the same reference and deletes it (via XL700R/FO410R).
   - **Order Lines (`ordre_linje`):**
     - Determines the next available line number.
     - Transfers each external order line to an internal order line, calling the appropriate subroutines for standard, special (e.g., procurement), or parent-ref (price-protected) lines.
     - Transfers associated text lines (top text, line text) as needed.
     - Updates EDI copy registers with assigned order and line numbers.

7. **Order Totals and Memosaldo Update (`oppdat_ordre`):**
   - Sums order amounts, discounts, and calculates the total for the order.
   - Calls FA922R to update memosaldo with the new order values.
   - Updates the internal order header with calculated totals.

8. **External Order Header Update:**
   - Updates the external order header with the assigned order number and audit information.

9. **Order Processing:**
   - Calls FO100R for further order processing (post-creation handling).

10. **Program End:**
    - Ends the program and sets LR indicator.

---

## Business and Domain-Specific Logic

### Credit and Memosaldo Handling

- The program includes complex logic for credit checks, including:
  - Standard credit limit checks.
  - "Almenning" (common) amount limits, with customer override or default lookup.
  - Memosaldo (memo balance) calculation, optionally including VAT, with support for extensions (e.g., more days to include in the balance, or a higher credit limit for certain customers).
  - "Utvidet memosaldo" (extended memosaldo) logic is switch-controlled and parameterized, with values fetched from a central parameter service (CO402R).

### EDI and Offer Handling

- If an incoming EDI order refers to an existing offer (via parent reference), the program:
  - Searches for a matching offer.
  - If found, deletes it (calls to XL700R and FO410R).
  - Ensures that prices and discounts are preserved for such orders (i.e., not recalculated).

### Project and Customer Overrides

- If the order is linked to a project, project-specific overrides are applied for fields like discount, payment terms, etc.
- If the customer has a separate invoice customer, the order is created using invoice customer data.

### Text Handling

- The program supports transferring both top-level and line-level text from the external order to the internal order, ensuring that important notes/messages are preserved.

### Order Numbering

- The order number is allocated based on the order type, with possible overrides for specific cases (e.g., EDI order types, or as set by other subprograms such as VA752R).

---

## File and Module Interactions

- **nohel1/nohelur:** External order header (input and update).
- **nodtl1:** External order lines.
- **fohelur/fodtl1:** Internal order header and lines.
- **rkunl1/rkmel1:** Customer and memo balance registers.
- **fkprl1:** Project register.
- **fusrl1:** User register (for seller info).
- **votyl1:** Order type configuration.
- **fstsl1:** Order status.
- **edtxlr:** EDI text lines.
- **fotxlu:** Top/bottom text lines for orders.
- **eddtl3/edhel4:** EDI copy registers (for updating with assigned order/line numbers).
- **ra09l1:** Seller reference lookup.
- **afpslrr:** Parameter file (for memosaldo/credit limit extensions).
- **SQL**: Used for duplicate offer detection.

**External Programs Called:**
- `FO763R`: Calculate memosaldo for a customer.
- `FO106R`: Retrieve "almenning" (common) amount limit.
- `AS100R`: Allocate next order number.
- `FO415R`: Check for existing order relations.
- `VA752R`: Override order type for number series.
- `FA922R`: Update memosaldo with new order.
- `FO100R`: Further order processing.
- `FD111R`, `FD106R`, `FD116R`, `FD109R`, `ND105R`: Order line and text creation, with variations for specific line types.
- `XL700R`, `FO410R`: Deletion of existing offers/orders.
- `CO402R`: Retrieve extended memosaldo/credit limit parameters.
- `RS205R`: Retrieve VAT rate.

---

## Design Decisions and Conventions

- **Versioning and Audit Trail:** Extensive change history is maintained in comments, with references to business requirements and customer-specific adaptations.
- **Key Lists:** All file access is done via klist/kfld key lists for clarity and maintainability.
- **Indicator Usage:** RPG indicators are used for flow control, especially for error and credit stop handling.
- **Subroutines:** Main logic is modularized into subroutines for header, lines, numbering, and updates.
- **Parameterization:** Business rules (e.g., memosaldo days, credit extension) are parameterized and can be centrally maintained.
- **SQL Integration:** Used for specific lookups (e.g., duplicate offer detection), supporting more complex queries than native RPG IO.
- **Text Handling:** Both direct text transfer and file-based text transfer are supported, ensuring all relevant order communication is preserved.

---

## Noteworthy Patterns

- **Flexible Business Logic:** The program is designed to be highly adaptable, with many code paths controlled by parameters, switches, or customer/project-specific data.
- **Extensive Inter-module Communication:** The program acts as an orchestrator, invoking many subprograms to perform specialized tasks (e.g., calculation, numbering, deletion).
- **Data Integrity:** Care is taken to update all relevant registers (e.g., EDI copy registers) when creating or updating orders, ensuring traceability and consistency.
- **Backward Compatibility:** Many code branches are versioned (e.g., 5.32, 6.10, 7.13), with comments explaining the rationale for changes and reversions, reflecting a long-lived and evolving codebase.

---

## Summary

NO121R is a robust, business-critical program for importing and converting EDI orders into the internal order system, with extensive validation, customer/project adaptation, and integration with multiple supporting modules and registers. It ensures that orders are created accurately, all business rules are observed, and that both internal and external traceability is maintained throughout the order lifecycle. 

New developers should familiarize themselves with the supporting subprograms, the customer/project register structures, and the parameterization approach (especially for credit/memosaldo logic) to effectively maintain and extend this program.