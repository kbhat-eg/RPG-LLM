     h option(*nodebugio : *srcstmt) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : FD105R
      * Beskrivelse . . : Ordre-linje, vedlikehold av varelinje
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       250901 HKO  Nytt program
5.01  * R5.01 241002 AMD  Lagt om rutiner for oppdatering av lager
      *       240203 HKO  Rettet feil med at enhet ikke ble lagret ved
      *                   inntasting av enhet på vare uten enhet.
      *       250303 HKO  Lagt inn logikk for å hindre at DB sprekker på
      *                   størrelse
      *       261103 HKO  Viser utgår-dato dersom denne er utfylt
      *       151203 HKO  Viser bruksrett-rabatt og flagg for overstyring
      *                   til privat-salg
      *       051203 HKO  Trekker fra bruksrett-rabatt i nettobeløpene
5.31  * R5.31 100104 ASK  Lagt inn endringer for lager på linjenivå.
5.32  * R5.32 120204 AMD  Lagt inn oppdatering av linjetype
5.32  *       240504 HKO  Oppdaterer opprinnelig pris
      *       260504 HKO  Endret parameter ved kall til VP900R
5.33  * R5.33 140904 GRO  Lagt inn tilleggsspesifikasjon av linjer
      *       180904 HKO  Lagt inn avtalenotat. Vises automatisk
5.33  *       221004 AMD  Lagt inn overgang til Pakke og Lengde
5.33  *                   (Modifisering av 5.33 lagt inn av Geir)
      *       041104 HKO  Endret parameter ved kall til VP900R
5.51  *       281005 BOF  Nullstilling av bestillingsreferanser
      *       071205 HKO  Lagt inn test for å unngå sprekk på netto
      *                   salgspris inkl. mva
5.41  * R5.41 100806 AMD  Endret program for å unngå produsering av
      *                   av poster til historisk lagerbok når f.eks.
      *                   kun en pris korrigeres.
5.70  * PRGR  290908 SST  Prisgruppe
5.71  *       281008 bof  Fjernet C1PRIV (bruksrett)
5.61  * R5.61 290908 AMD  Programmet feilet når det ble lagt på et
      *                   prosjektnummer (økonomi) på varelinja.
      *                   Parameterlista var ikke riktig. I tillegg er
      *                   det lagt inn mulighet for spørring (F4) på
      *                   aktivitet også.
      * 6.10  240609 BSA  Oppdatert med sporingsinformasjon
6.11  * 6.10  290609 bof  Utivdet eannr til 14 og brukt std. oppslag
6.12  * 6.10  140909 bof  Utivdet med pakningsklasse på vare-enhet-prisg.
6.13  * 6.10  240909 ASK  Nye parametre til VL001R
6.14  * 6.10  280909 bof  Endring av lager, justert i forb. prisgruppe
6.15  * 6.10  280909 bof  Utvidet med gtin-nr, hvis scannet følger dette gtin
6.15  *                   med fra scanningen.
6.16  * 6.10  090810 bof  Sjekke om antall overskrider lagerbeholdning
      *                   Dette skal parameterstyres. Pr. nå hardkodes det
      *                   til 0, dvs. ingen sjekk.
6.17  * 6.10  150611 bof  Takler alt for høye antall i beregning nettosum
6.18  * 6.10  060712 bsa  Endrer program for innhenting av GTIN nummer.
6.18  *                   (Sjekker også VA)
6.1a  * R6.10 070513 bof  EHF krever avrunding av FDSUMS
6.20  * 6.20  021110 bof  Utvidet med utg.dato pr. lager
6.21  * 6.20  281110 bof  Lagt ut en rød info om skaffevare
6.20  * 6.20  151110 NHO  Proj er nå alfa
6.23  * 6.20  150211 bof  Sjekker om beh.på lager ihht. til kode på status
6.24  * 6.20  080311 nho  Sjekk av skaffevare (Felt FAALBE)
      *                   0 = ingen sjekk
      *                   1 = melding, men kan komme videre
      *                   2 = melding, kommer ikke videre
      *                   3 = melding, kommer ikke videre
6.25  * 6.20  250511 bof  Varetype fra lager, rettelse
6.26  * 6.20  270511 bof  Justert på logikk vedr. endr. lager og varetype
6.28  * 6.20  090112 bof  Flere justeringer kontroll lager
6.29  * 6.20  130112 bof  Lev.nr fra lager hvis den finnes til ordrelinje
6.2a  * 6.20  230112 bof  Mer kontroll rundt varetype når man endrer lager
6.2b  * 6.20  290212 bof  Endret logikk vedr.hente varetype v/endring
6.2c  * 6.20  220212 bof  Kontroll på at varen finne på vlagpf hvis lagersjekk
6.2d  * 6.20  290212 bof  Justert hente pris ihht. lev.nr på lager
6.2e  * 6.20  090812 bsa  Endret program for innhenting av GTIN nummer (NEB)
6.2f  * 6.20  170713 bkv  Lagt inn støtte for endring av enhet etter prisendring
6.2g  * 6.20  240913 bof  ikke tillatt å endre lev.type hvis bestilling eller
6.2g  * 6.20         bof  bestillingsforslag er dannet.
6.2h  * 6.20  240913 bof  En del felter er fjernet fra bilde, rydder opp i input
6.2h  *                   kontroll på disse feltene.
6.2i  * 6.20  030114 bof  Endr.levtype og akktype >=2 gi melding
6.2j  * 6.20  110414 bsa  Kan oppgi negativ dekningsgrad
6.2k  * 6.20  070116 bsa  Send med leveringstype inn i prisberegning
6.30  * 6.30  080114 bof  BM MODUL : vise oppsalg/mersalg på varer
6.31  * 6.30  140114 bof  sjekk om tilbudspris finnes på annen ordre.
6.32  * 6.30  050314 bof  felt som er fjernet fra bildet
6.33  * 6.30  020414 bkv  Kun samme vare sjekk for ikke kontakt kund
6.34  * 6.30  030414 bof  rettelse BM info popup
6.NU  * R6.30 260514 bsa  Programmet gjennomgått mtp nummerutvidelser.
6.35  * 6.30  080814 bof  Viser erstattet av nobbnr.
6.36  * 6.30  041114 bsa  Lagt inn kommandotast for visning av NOBB info
6.37  * 6.30  130115 bof  Fjernet RKU2PF, sydd inn i rkunpf.
6.35a * 6.30  280514 bof  Justering vedr. tilbudspris vedr. rabatter
6.36a * 6.30  050614 bkv  Justering vedr. tilbudspris vedr. endre enhet
6.37a * 6.30  060614 bkv  Ikke vis tilbudspris ved endring
6.38  * 6.30  040615 bkv  Ordre økt fra 6 til 8
6.39  * 6.30  300316 bof  Feilretting vedr. rab1/2 når pris fra tilbud
6.3a  * 6.30  040517 bkv  Feilretting tilbudspris feil ved bytt av enhet
6.3b  * 6.30  180418 bkv  Vise negativ DG
6.3c  * 6.30  191017 bof  Kode som hindrer at tilbudspriser blir vist (faak05)
6.3d  * 6.30  050719 bkv  Ekstra sjekk på om antall får stort
6.3e  * 6.30  170918 bkv  Utvidet med trelast sortiment
6.3f  *       030419 NHO  Skal ikke kunne vedlikeholde varetekst
6.3f  *                   dersom type L eller S Sjekk mot AVALL1
7.xx  * 7.00  190216 bsa  Endringer reltart til ny GUI. NB Kan kun gjelde DDS
7.00  * 7.00  080519 bkv  Hvis nobb frakt:  kostpris = inn pris
7.01  * 7.00  020719 bkv  Henter GTIN på nytt ved enhet bytte
7.02  * 7.00  130919 bkv  Rettet feil i visning av kostpris < 1
7.03  * 7.00  130919 bsa  Lagt inn F tast for visning av VA info.
7.04  * 7.00  160919 nho  Henter  % sats fra FGEBL1 ved 4=retur/rekl
7.04  *                   2 nye felt på bildet Returgebyr/Returkode
7.04  *                   Skal trekke % fra nettobeløp
7.05  * 7.00  180220 bkv  Rettelser på returgebyr
7.06  * 7.00  260420 bkv  Konfiguering av returgebyr av/på
7.07  *k00    110920 bof  feilretting vedr. å hente pris på prisgr.
7.08  *K000   020221 bsa  Feilretting rundt returgebyr. Må også logge
7.08  *K000               slettegrunn ved opprettelse av vare.
7.09  *K000   240221 bsa  Skal ikke trigge hvis ikke gebyr.
7.10  *K000   190521 bsa  Legger ut tabeller for å logge priser osv
7.10  *                   Opprinnelige priser legges kun ut førte gang
7.10  *                   Hvis pris ikke er opprettet tidligere, må
7.10  *                   "bruttopris" også kalkuleres.
7.11  *K000   190521 sst  Legge ut prosjekt og aktivitet på fodtpf fra fohepf
7.12  *K000   190521 bof  Endret posisjon til hopasl
7.13  *K000   190521 bsa  Sjekker disponibelsituasjon relatert til levering
7.13  *K000               og ordredato. Ny F tast for visning av disponibelsituasjon.
7.14  *K000   190521 bsa  Endret noe på funksjonaliteten rundt koden for
7.14  *K000               "innkjøpspris=kostpris". Styres av andre switcher.
7.14  *K000               (ref 7.00)
7.15  * K000  021120 bsa  Skal være mulig å endre kostpris uansett om koden er satt.
      *
7.fb  *       210217 bof  Sjekk mot depositum 100 % betalt.
7.f1  * 7.10  050517 bof  Sjekker om erstatning av varel. før evt. depsjekk
7.f2  * 7.10  220920 bsa  Sjekk mot depositum uansett. Skal ikke overstige
7.f2  * 7.10              grenseverdier uansett.
      *
8.01  *K000   090921 bsa  Vi henter også innkjøpspris uansett.
8.02  *K000   090322 bsa  Skal ikke være mulig å endre linjetype. Skal bare vises
8.02  *K000               Endring kun i skjermfila.
8.03  *K000   150322 bsa  Henter inn innkjøpspris på nytt, hvis de endret enhet.
8.04  *K000   190422 bsa  Ny kode på kunde som må slå til for at det skal beregnes
8.04  *K000               beregnes returgebyr.
8.05  *K000   090323 bsa  Feil fortegn på lagertransaksjon ved endring av lager
8.05  *K000               på linje som allerede er plukket til pakkseddel.
8.05  *K000               Endret rettelse 6.14
8.06  *K000   061123 bsa  Feiler ved DG beregning hvis salgspris settes manuelt.
8.06  *K000               Dekningsgrad beregnes ihht inneligende salgspris, og
8.06  *K000               det blir veldig feil.
8.07  *K000   131123 bsa  Hvis rabatt er endret, hvis pris/beløp på nytt
8.08  *PRG2   080622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner (hopasl ikke i bruk)
8.09  *PRG2   200324 bsa  Endring 8.06 reversert.
8.10  *PRG2   160525 bsa  Legg på avdeling fra ordrehodet når en oppretter ordren.
      *
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
7.fb ffst2l1    if   e           k disk    rename(fst2pfr:fst2l1r)
5.70 fra30lr    if   e           k disk    rename(ra30pfr:ra30lrr)
     ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvltpl1    if   e           k disk    rename(vltppfr:vltpl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     fvenhl1    if   e           k disk    rename(venhpfr:venhl1r)
6.12 fvvepl1    if   e           k disk    rename(vveppfr:vvepl1r)
     ffpril1    if   e           k disk    rename(fpripfr:fpril1r)
     ffprnl1    if   e           k disk    rename(fprnpfr:fprnl1r)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
     ffodtlu    uf a e           k disk    rename(fodtpfr:fodtlur)
6.16 fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
6.2c fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
6.2g flfdtl6    if   e           k disk    rename(lfdtpfr:lfdtl6r)
6.30 famodl1    if   e           k disk    rename(amodpfr:amodl1r)
6.30 fjvoml1    if   e           k disk    rename(jvompfr:jvoml1r)
6.30 fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
6.30 fjkatl1    if   e           k disk    rename(jkatpfr:jkatl1r)
6.30 fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
6.33 frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
8.04 frku2l1    if   e           k disk    rename(rku2pfr:rku2l1r)
6.3e fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
6.3f favall1    if   e           k disk    rename(avalpfr:avall1r)
7.00 ffoh2l1    if   e           k disk    rename(foh2pfr:foh2l1r)
7.04 ffgebl1    if   e           k disk    rename(fgebpfr:fgebl1r)
7.04 ffod2lu    uf a e           k disk    rename(fod2pfr:fod2lur)
7.04 ffod2l1    if   e           k disk    rename(fod2pfr:fod2l1r)
7.04 fra50l1    if   e           k disk    rename(ra50pfr:ra50l1r)
7.10 ffodmiu    uf a e           k disk    rename(fodmst:fodmiur)
7.fb fsdepl1    if   e           k disk    rename(sdeppfr:sdepl1r)
      *
     ffd105d    cf   e             workstn
      *
      * Definering av parametre
      *
     d p_kode          s              1
     d p_firm          s                   like(fdfirm)
     d p_numm          s                   like(fdnumm)
     d p_suff          s                   like(fdsuff)
     d p_line          s                   like(fdline)
     d p_ltyp          s                   like(fdltyp)
     d p_lety          s                   like(fdlety)
     d p_vare          s                   like(fdvare)
     d p_anta          s                   like(fdanta)
     d p_enhe          s                   like(fdenh1)
     d p_kost          s              1
6.15 d p_eann          s                   like(fdeann)
5.70 d p_vtyp          s                   like(vvvtyp)
6.2e d p_ldor          s              6  0
6.36 d p_nobb          s              8
7.10 d p_inlr          s              1
7.13 d p_behl          s                   like(vlbehl)
7.13 d p_dato          s                   like(fdldat)
7.13 d p_time          s                   like(fdotim)
7.13 d p_lenh          s                   like(fdenh1)
7.13 d p_kalk          s              1
7.f1 d p_flag          s              1
7.f1 d p_erst          s              1  0
      *
      * Definering av Local data area
      *
     d                uds
     d l_user                911    920
7.00 d l_filg                931    933
7.xx d l_firm                944    946  0
7.xx d l_fnav                951    980
      *
      * Definering av datastrukturer
      *
7.04 d                 ds
7.04 d g1text                  1     60
7.04 d  g1tex1                 1     30
7.04 d  g1tex2                31     60
      *
      * Parametre for henting av pris -inn
      *
     d                 ds
     d hirec                        120
     d  hifirm                        3  0 overlay(hirec)
     d  hirkat                        3  0 overlay(hirec:4)
     d  hikund                        6  0 overlay(hirec:7)
     d  hikpro                        6  0 overlay(hirec:13)
     d  hivare                       15    overlay(hirec:19)
     d  hilety                        1  0 overlay(hirec:34)
     d  hienhe                        3    overlay(hirec:35)
     d  hidato                         d   overlay(hirec:38) datfmt(*iso)
     d  hitime                         t   overlay(hirec:48) timfmt(*iso)
6.nu d  hinumm                        8  0 overlay(hirec:56)
6.nu d  hikode                        1    overlay(hirec:64)
6.nu d  hidekn                        5  2 overlay(hirec:65)
6.nu d  hiavgf                        1  0 overlay(hirec:70)
6.nu d  hipriv                        1  0 overlay(hirec:71)
6.nu d  hitilb                        1    overlay(hirec:72)
6.nu d  hiskaf                        1    overlay(hirec:73)
6.nu d  hildor                        6  0 overlay(hirec:74)
6.nu d  hisapr                        9  2 overlay(hirec:80)
6.nu d  hikopr                        9  2 overlay(hirec:89)
8.08 d  hiprgr                        2    overlay(hirec:98)
     d  hiinlr                        1    overlay(hirec:120)
      *
      * Parametre for henting av pris -ut
      *
     d                 ds
     d horec                         80
     d  holety                        1  0 overlay(horec)
     d  hokpri                        1    overlay(horec:2)
     d  hooppr                        9  2 overlay(horec:3)
     d  hosapr                        9  2 overlay(horec:12)
     d  hokopr                        9  2 overlay(horec:21)
     d  horab1                        5  2 overlay(horec:30)
     d  horab2                        5  2 overlay(horec:35)
     d  hodekn                        5  2 overlay(horec:40)
     d  hopros                        5  2 overlay(horec:45)
     d  hokamp                        5    overlay(horec:50)
     d  hoalme                        4  0 overlay(horec:55)
     d  hobrty                        1  0 overlay(horec:59)
     d  hobrr1                        5  2 overlay(horec:60)
     d  hobrr2                        5  2 overlay(horec:65)
     d  hoomva                        1    overlay(horec:70)
8.08 d  hoprgr                        2    overlay(horec:71)
8.08 d* hopasl                        5  2 overlay(horec:73)
      *
      * Lageroppdatering
      *
6.13 d                 ds
6.nu d hlrec                        128
6.13 d  hlvare                       15    overlay(hlrec)
6.13 d  hllage                        2  0 overlay(hlrec:16)
6.13 d  hldato                         d   overlay(hlrec:18) datfmt(*iso)
6.13 d  hltime                         t   overlay(hlrec:28) timfmt(*iso)
6.13 d  hlotyp                        2    overlay(hlrec:36)
6.13 d  hlltyp                        2    overlay(hlrec:38)
6.13 d  hlanta                       11  3 overlay(hlrec:40)
6.13 d  hlkopr                        9  2 overlay(hlrec:51)
6.13 d  hlrefr                       20    overlay(hlrec:60)
6.13 d  hlsyst                        1    overlay(hlrec:80)
6.13 d  hlaltk                        2    overlay(hlrec:81)
6.13 d  hlrest                        1    overlay(hlrec:83)
6.13 d  hltype                        1    overlay(hlrec:84)
6.13 d  hlenhe                        3    overlay(hlrec:85)
6.13 d  hlinlr                        1    overlay(hlrec:88)
6.13 d  hllety                        1    overlay(hlrec:89)
6.nu d  hlonum                        8  0 overlay(hlrec:90)
6.nu d  hlolin                        4  0 overlay(hlrec:98)
      *
      * Definering av variabler i nøkler
      *
     d fusrl1_user     s                   like(fbuser)
5.70 d ra30lr_dkod     s                   like(redkod)
     d vvarl1_vare     s                   like(vvvare)
     d vltpl1_lety     s                   like(vylety)
     d vltyl1_ltyp     s                   like(valtyp)
     d venhl1_eenh     s                   like(vaeenh)
6.12 d vvepl1_pvar     s                   like(vepvar)
6.12 d vvepl1_penh     s                   like(vepenh)
6.12 d vvepl1_pldo     s                   like(vepldo)
5.70 d fpril1_prgr     s                   like(fpprgr)
     d fpril1_rkat     s                   like(fprkat)
     d fpril1_kkat     s                   like(fpkkat)
     d fpril1_kund     s                   like(fpkund)
     d fpril1_kpro     s                   like(fpkpro)
     d fpril1_vare     s                   like(fpvare)
     d fpril1_enhe     s                   like(fpenhe)
     d fpril1_lety     s                   like(fplety)
     d fprnl1_nkun     s                   like(fpnkun)
     d fprnl1_nkpr     s                   like(fpnkpr)
     d fprnl1_nvar     s                   like(fpnvar)
6.16 d votyl1_otyp     s                   like(vaotyp)
6.2c d vlagl1_vare     s                   like(vlvare)
6.2c d vlagl1_lage     s                   like(vllage)
6.2g d lfdtl6_ornr     s                   like(lfornr)
6.30 d amodl1_modu     s                   like(axmodu)
6.30 d jvoml1_onob     s                   like(jvonob)
6.30 d jvoml1_otyp     s                   like(jvotyp)
6.30 d jvarl1_vare     s                   like(jvvare)
6.30 d jkatl1_kate     s                   like(jkkate)
6.30 d jlevl1_ldor     s                   like(jlldor)
6.37 d rkunl1_kund     s                   like(rkkund)
6.3f d avall1_apgm     s                   like(avapgm)
7.10 d fodmiu_numm     s                   like(fdnumm)
7.10 d fodmiu_suff     s                   like(fdsuff)
7.10 d fodmiu_line     s                   like(fdline)
7.fb d sdepl1_numm     s                   like(sknumm)
7.fb d sdepl1_kund     s                   like(skkund)
7.fb d sdepl1_tell     s                   like(sktell)
      *
6.3f d u_tek1          s              1    inz(*off)
      *
      * Definering av variable
      *
     d b_endr          s              1    inz(*off)
     d b_forn          s              1    inz(*off)
5.31 d b_feil          s              1    inz(*off)
5.41 d b_lage          s              1    inz(*off)
6.20 d b_inlr          s              1    inz(*off)
6.26 d b_skaf          s              1    inz(*off)
6.28 d b_behl          s              1    inz(*off)
6.2g d b_bfoh          s              1    inz(*off)
6.30 d b_opme          s              1    inz(*off)
6.33 d b_kont          s              1    inz(*off)
7.fb d b_100p          s              1    inz(*off)
      *
6.20 d w_ddat          s               d   datfmt(*iso)
6.20 d w_udat          s               d   datfmt(*iso)
6.20 d w_ldor          s                   like(vvldor)
6.3e d w_lv_nobb       s                   like(vvlnob)
6.3e d w_lv_modn       s                   like(vvlmod)
6.3e d w_lv_lldo       s                   like(vvlnle)
6.3e d w_lv_llva       s                   like(vvllva)
6.3e d w_nobb          s                   like(vvnobb)
6.3e d w_nmod          s                   like(vvnmod)
6.3e d w_lvar          s                   like(vvlvar)
6.26 d w_vvty          s                   like(vvvtyp)
     d w_mvap          s              6  2
     d w_mvat          s              5  4
     d w_mvaf          s             10  9
     d w_omr2          s             12  6
     d w_omr3          s             12  6
     d w_stat          s              1
     d w_sald          s             11  2
     d w_retk          s              1
     d w_kont          s              5  0
     d w_spes          s              4  0
     d w_txt1          s             30
     d w_txt2          s             30
5.61 d w_utxt          s             30
     d w_ldat          s               d   datfmt(*iso)
6.31 d w_tilb          s                   like(fdsapr)
6.31 d w_tra1          s                   like(fdrab1)
6.31 d w_tra2          s                   like(fdrab2)
6.31 d w_enhe          s                   like(fdenh1)
7.04 d w_frat          s                   like(fdsapr)
7.04 d w_fra1          s                   like(fdsapr)
7.04 d w_frre          s                   like(fdsapr)
7.04 d xxsapr          s                   like(fdsapr)
7.10 d w_time          s               t   timfmt(*iso)
      *
     d w_firm          s                   like(vvfirm)
6.NU d w_numm          s                   like(fonumm)
     d w_suff          s                   like(fosuff)
     d w_line          s                   like(fdline)
      *
     d w_raba          s                   like(fdsums)
     d w_sumr          s                   like(fdsums)
     d w_sums          s                   like(fdsums)
     d w_enh1          s                   like(fdenh1)
     d w_sap1          s                   like(fdsapr)
     d w_bup1          s                   like(fdsapr)
     d w_enh2          s                   like(fdenh1)
     d w_sap2          s                   like(fdsapr)
     d w_bup2          s                   like(fdsapr)
     d w_enh3          s                   like(fdenh1)
     d w_sap3          s                   like(fdsapr)
     d w_bup3          s                   like(fdsapr)
     d w_bupr          s                   like(fdsapr)
     d w_sapr          s                   like(fdsapr)
     d w_kopr          s                   like(fdkopr)
     d w_ltxt          s                   like(vybesk)
     d w_rab1          s                   like(fdrab1)
5.33 d w_totm          s                   like(fdanta)
5.31 d w_jtxt          s             30
5.31 d w_jadr          s             30
5.31 d w_jpnr          s              4  0
5.31 d w_jste          s             30
5.31 d w_javd          s              4  0
5.70 d w_prgr          s                   like(fdprgr)
7.00 d w_lety          s                   like(folety)
7.00 d w_lenh          s                   like(fdenh1)
7.00 d w_inpr          s                   like(fdinpr)
7.00 d w_inpr2         s                   like(fdinpr)
7.00 d w_kopr2         s                   like(fdkopr)
7.00 d w_sapr2         s                   like(fdsapr)
7.00 d w_bupr2         s                   like(fdsapr)
7.00 d w_hlev          s              1  0
7.04 d fgebl1_otyp     s                   like(fgotyp)
7.05 d ra50l1_dkod     s                   like(regkod)
5.70 d w_iprg          s                   like(fdprgr)
5.70 d w_oprg          s                   like(fdprgr)
5.70 d w_vare          s                   like(fdvare)
5.70 d w_dtxt          s                   like(redtxt)
5.70 d w_pgav          s                   like(foavde)
5.70 d w_pgla          s                   like(fdlage)
6.11 d w_east          s              1
6.11 d w_eann          s                   like(fdeann)
6.38 d w_numa          s              8
5.02 d w_lina          s              4
7.10 d w_rabt          s             15  4
7.fb d w_sumi          s             11  2
7.fb d w_sumu          s             11  2
7.fb d w_avik          s             11  2
7.fb d w_ntsu          s             11  2
7.fb d w_ntsug         s             11  2
7.fb d w_mld1          s             50
      *
     d s_ant1          s                   like(fdanta)
     d s_ant2          s                   like(fdanta)
     d s_ant3          s                   like(fdanta)
     d s_anta          s                   like(fdanta)
     d s_enhe          s                   like(fdenh1)
6.2f d s_enh2          s                   like(fdenh1)
     d s_sapr          s                   like(fdsapr)
     d s_rab1          s                   like(fdrab1)
     d s_rab2          s                   like(fdrab2)
     d s_lety          s                   like(fdlety)
     d s_kopr          s                   like(fdkopr)
7.15 d s_kop1          s                   like(fdkopr)
     d s_dekn          s                   like(fdpasl)
     d s_priv          s                   like(fdpriv)
5.41 d s_lage          s                   like(fdlage)
5.70 d s_prgr          s                   like(fdprgr)
5.70 d s_prgro         s                   like(fdprgr)
     d s_antal         s                   like(fdanta)
7.10 d s_osap          s                   like(fdosap)
7.10 d s_otip          s                   like(fdotip)
7.10 d s_okop          s                   like(fdokop)
7.10 d s_oinp          s                   like(fdoinp)
7.10 d s_oppk          s                   like(fdoppk)
7.10 d s_okpr          s                   like(fdokpr)
7.10 d s_okr1          s                   like(fdokr1)
7.10 d s_okr2          s                   like(fdokr2)
7.10 d s_okpk          s                   like(fdokpk)
8.05 d s_lag0          s                   like(fdlage)
      *
7.10 d x_sapr          s                   like(fdsapr)
7.10 d x_bupr          s                   like(fdsapr)
7.10 d x_tipr          s                   like(fdsapr)
7.10 d x_kopr          s                   like(fdsapr)
7.10 d x_inpr          s                   like(fdsapr)
      *
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
7.00 d u_nobf          s              1    inz(*off)                            fraktkalkulator
7.00 d u_rgeb          s              1    inz(*off)                            returgebyr
7.06 d u_rgpa          s              1  0 inz(0)                               returgebyr sjekkboks
      *
      * Definering av konstanter
      *
     d lo              c                   'abcdefghijklmnopqrstuvwxyzæøåäö'
     d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅÄÖ'
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Henter vareinformasjon
      *
     c                   eval      vvarl1_vare = p_vare
     c     vvarl1_key    chain     vvarl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
6.3e  *
6.3e  * henter evt logistikkvare
6.3e c                   eval      c1lage = folage
6.3e c                   exsr      hent_vtyp
6.3e c                   if        w_lv_nobb > 0
6.3e c                   eval      w_nobb = w_lv_nobb
6.3e c                   eval      w_nmod = w_lv_modn
6.3e c                   eval      w_lvar = w_lv_llva
6.3e  *
6.3e  * henter info fra VA
6.3e c                   movel     w_lv_nobb     jvarl1_vare
6.3e c*                   eval      jvarl1_vare = w_lv_nobb
6.3e c     jvarl1_key    chain     jvarl1
6.3e c                   if        %found(jvarl1)
6.3e c                   eval      c1enob = jvenob
6.3e c                   else
6.3e c                   eval      c1enob = 0
6.3e c                   endif
6.3e c                   else
6.3e c                   eval      w_nobb = vvnobb
6.3e c                   eval      w_nmod = vvnmod
6.3e c                   eval      w_lvar = vvlvar
6.3e  *
6.3e  * henter info fra VA
6.3e c                   eval      jvarl1_vare = vvvare
6.3e c     jvarl1_key    chain     jvarl1
6.3e c                   if        %found(jvarl1)
6.3e c                   eval      c1enob = jvenob
6.3e c                   else
6.3e c                   eval      c1enob = 0
6.3e c                   endif
6.3e c                   endif
6.30  *
6.30  * sjekker om det finnes oppsalg/mersalg info
6.30  *
6.30 c                   eval      b_opme = *off
     c                   eval      c7opp1 = *blank
     c                   eval      c7opp2 = *blank
     c                   eval      c7mer1 = *blank
     c                   eval      c7mer2 = *blank
6.3e c*                   eval      jvoml1_onob = vvnobb
6.3e c                   eval      jvoml1_onob = w_nobb
6.30 c                   eval      jvoml1_otyp = 'O'
6.30 c     jvoml1_key    chain     jvoml1
6.30 c                   if        %found(jvoml1)
6.30 c                   eval      c7opp1 = %subst(jvotx1:1:50)
6.30 c                   eval      c7opp2 = %subst(jvotx1:51:50)
6.30 c                   eval      c1opp1 = %subst(jvotx1:1:69)
6.30 c                   eval      b_opme = *on
6.30 c                   endif
6.3e c*                   eval      jvoml1_onob = vvnobb
6.3e c                   eval      jvoml1_onob = w_nobb
6.30 c                   eval      jvoml1_otyp = 'M'
6.30 c     jvoml1_key    chain     jvoml1
6.30 c                   if        %found(jvoml1)
6.30 c                   eval      c7mer1 = %subst(jvotx1:1:50)
6.30 c                   eval      c7mer2 = %subst(jvotx1:51:50)
6.30 c                   eval      c1mer1 = %subst(jvotx1:1:69)
6.30 c                   eval      b_opme = *on
6.30 c                   endif
6.31  *
6.31  * sjekker om det finnes tilbudspris på annen ordre.
6.31  * kun sjekk ved nye
6.37ac     fodtl1_key    chain     fodtl1
6.37ac                   if        not %found
6.33 c                   if        b_kont = *off
6.31 c                   eval      w_tilb = 0
6.31 c                   eval      w_tra1 = 0
6.31 c                   eval      w_tra2 = 0
6.31 c                   eval      w_enhe = *blank
6.3c c                   if        faak05 = 0
6.31 c                   call      'FO751R  '
6.31 c                   parm                    w_firm
6.31 c                   parm                    fonumm
6.31 c                   parm                    fokund
6.31 c                   parm                    p_vare
6.31 c                   parm                    w_tilb
6.31 c                   parm                    w_tra1
6.31 c                   parm                    w_tra2
6.31 c                   parm                    w_enhe
6.3c c                   endif
6.33 c                   endif
6.37ac                   endif
      *
5.70  * Henter prisgruppe ut fra heading
5.70  *
5.70 c                   eval      w_pgla = folage
5.70 c                   eval      w_pgav = foavde
5.70 c                   exsr      hent_prisgr
     c                   eval      s_prgro = w_prgr
      *
      * Kaller program for henting av pris-informasjon på tre enheter
      *
     c                   call      'VP715R'
     c                   parm                    w_firm
     c                   parm                    vvvare
5.70 c                   parm                    w_prgr
6.2d c                   parm                    folage
     c                   parm                    p_lety
     c                   parm                    fobdat
     c                   parm                    w_enh1
     c                   parm                    w_sap1
     c                   parm                    w_bup1
     c                   parm                    w_enh2
     c                   parm                    w_sap2
     c                   parm                    w_bup2
     c                   parm                    w_omr2
     c                   parm                    w_enh3
     c                   parm                    w_sap3
     c                   parm                    w_bup3
     c                   parm                    w_omr3
      *
     c                   eval      hopros = 0
      *
      * Initierer ordre-linje
      *
     c                   clear                   fodtlur
      *
     c     fodtl1_key    chain     fodtl1
     c                   if        %found
     c                   eval      b_endr = *on
     c                   else
     c                   eval      b_endr = *off
     c                   exsr      ny_linje
     c                   endif
      *
      * Viser registreringbildet
      *
     c     tc1win        tag
      *
     c                   exsr      xc1win
     c                   if        *inkc or *inkl
     c                   goto      avslutt
     c                   endif
      *
      * Gjør oppslag mot ordre-linje for oppdatering
      *
     c     fodtlu_key    chain     fodtlur
      *
      * Opprinnelig pris
      *
     c***                eval      fdoppr = hooppr
      *
      * Henter verdier fra skjermbildet
      *
     c                   eval      fdanta = c1anta
     c                   eval      fdenh1 = c1enhe
     c                   eval      fdsapr = c1sapr
     c                   eval      fdrab1 = c1rab1
     c                   eval      fdrab2 = c1rab2
     c                   eval      fdlety = c1lety
5.32 c                   eval      fdltyp = c1ltyp
     c                   eval      fdkpri = c1kpri
     c                   eval      fdkopr = c1kopr
     c                   eval      fdtek1 = c1tek1
     c                   eval      fdtek2 = c1tek2
     c                   eval      fdpasl = c1dekn
     c                   eval      fdlass = c1lass
6 32 c*                  eval      fdproj = c1proj
6.32 c*                  eval      fdakti = c1akti
     c                   eval      fdldat = *loval
     c                   eval      fdalme = c1alme
     c                   eval      fdomva = c1omva
     c                   eval      fdbrty = c1brty
     c                   eval      fdbrr1 = c1brr1
     c                   eval      fdbrr2 = c1brr2
5.71 c*                  eval      fdpriv = c1priv
5.31 c                   eval      fdlage = c1lage
5.70 c                   eval      fdprgr = c1prgr
     c                   eval      fdoprg = 0
     c                   if        c1prgr <> s_prgro
     c                   eval      fdoprg = 1
     c                   endif
      *
     c                   if        c1ldat <> 0
     c     *dmy          move      c1ldat        fdldat
     c                   endif
      *
      * Beregning av totaler
      *
6.1a c*                  eval      w_sums = fdsapr * fdanta
6.1a c                   eval(h)   w_sums = fdsapr * fdanta
     c                   eval      w_sumr = 0
      *
      * Rabatt
      *
     c                   if        vvkord = 0
     c                   eval(h)   w_raba = (w_sums * forabp) / 100
     c                   eval      w_sumr = w_raba
     c                   endif
      *
     c                   if        fdrab1 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdrab1 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
      *
     c                   if        fdrab2 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdrab2 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
      *
     c                   if        fdbrr1 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdbrr1 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
      *
     c                   if        fdbrr2 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdbrr2 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
7.04  *
7.04 c                   if        c1sats <> 0 and
7.04 c                             c1geby = 1
7.04 c                   eval(h)   w_raba = (w_sums - w_sumr) * c1sats / 100
7.04 c                   eval      w_sumr = w_sumr + w_raba
7.04 c                   endif
7.04  *
      *
      * Kostpris  (*** ?)
      *
     c                   if        fdkopr = 0
     c                   eval      fdkopr = fdsapr * hopros
     c                   endif
      *
      * Legger inn totaler
      *
     c                   eval      fdsums = w_sums
     c                   eval      fdsumr = w_sumr
     c                   eval      fdsumk = fdkopr * fdanta
      *
      * Dersom kredit-linjetype må summene korrigeres
      *
     c                   eval      vltyl1_ltyp = fdltyp
     c     vltyl1_key    chain     vltyl1
     c                   if        valkre = '-'
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumr = fdsumr * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   endif
      *
      * Legger inn faste opplysninger fra vare og ordre
      *
     c                   eval      fdotyp = footyp
     c                   eval      fdkakk = 0
     c                   eval      fdkgeb = 0
      *
     c                   eval      fdkund = fokund
     c                   if        folkun <> 0
     c                   eval      fdkund = folkun
     c                   endif
      *
6.18 c                   eval      fdeann = c1eann
6.3e c*                   eval      fdnobb = vvnobb
6.3e c                   eval      fdnobb = w_nobb
6.3e c*                   eval      fdlvar = vvlvar
6.3e c                   eval      fdlvar = w_lvar
6.29 c                   if        w_ldor <> 0
6.29 c                   eval      fdldor = w_ldor
6.29 c                   else
     c                   eval      fdldor = vvldor
6.29 c                   endif
     c                   eval      fdogrp = vvogrp
     c                   eval      fdhgrp = vvhgrp
     c                   eval      fdugrp = vvugrp
      *
      * Oversetter varetekst til store bokstaver dersom dette er valgt
      *
     c                   if        faahoy = 1
     c     lo:up         xlate     fdtek1        fdtek1
     c     lo:up         xlate     fdtek2        fdtek2
     c                   endif
7.04  *
7.04  * Hvis c1geby = 0 dvs at ingen retur skal beregnes og
7.04  * ordrenummer/linje ligger i tilleggsregister FOD2PF
7.04  *
7.04 c                   if        c1geby = 0
7.04 c     fod2lu_key    chain     fod2lur
7.08  * Opprettes hvis den ikke finnes
7.09 c                   if        not %found and
7.09 c                             c1geby = 1
7.08 c                   eval      fd2sat = c1sats
7.08 c                   eval      fd2kod = c1dkod
7.08 c                   eval      fd2ber = c1geby
7.08  * Legg ut tekst til returkode
7.08 c                   if        c1dkod <> *blank
7.08 c                   eval      ra50l1_dkod = c1dkod
7.08 c     ra50l1_key    chain     ra50l1
7.08 c                   if        %found(ra50l1)
7.08 c                   eval      fd2rtx = regtxt
7.08 c                   endif
7.08 c                   else
7.08 c                   eval      fd2rtx = *blank
7.08 c                   endif
7.08 c                   eval      fd2ors = *blank
7.08 c                   eval      fd2fir = w_firm
7.08 c                   eval      fd2num = w_numm
7.08 c                   eval      fd2suf = w_suff
7.08 c                   eval      fd2lin = w_line
7.08 c                   time                    fd2dat
7.08 c                   time                    fd2tim
7.08 c                   eval      fd2oou = l_user
7.08 c                   time                    fd2eda
7.08 c                   time                    fd2eti
7.08 c                   eval      fd2eus = l_user
7.08  * Spør om slettegrunn
7.08 c                   exfmt     g1win
7.08 c                   if        *inkc or *inkl
7.08 c                   goto      ikslet2
7.08 c                   endif
7.08 c                   movel     g1kom1        g1tex1
7.08 c                   movel     g1kom2        g1tex2
7.08 c                   movel     g1text        fd2ors
7.08 c                   eval      fd2ber = 0
7.08 c     ikslet2       tag
7.08 c                   write     fod2lur
7.08 c                   endif
7.08  *
7.05 c*                   if        fd2ber = 1
7.05 c                   if        %found(fod2lu) and fd2ber = 1
7.04 c                   exfmt     g1win
7.04 c                   if        *inkc or *inkl
7.04 c                   goto      ikslet
7.04 c                   endif
7.04 c                   movel     g1kom1        g1tex1
7.04 c                   movel     g1kom2        g1tex2
7.04 c                   movel     g1text        fd2ors
7.04 c                   eval      fd2ber = 0
7.04 c                   update    fod2lur
7.04 c                   endif
7.05 c*                   endif
7.04 c                   endif
7.04  *
7.04 c     ikslet        tag
7.04  *
7.04  * Gjør oppslag mot tilleggsregister for ordreline
7.04  * for oppdatering dersom returgebyr inneholder % sats
7.04  * og kode er satt til '1'
7.04  *
7.04 c                   if        c1sats <> 0 and
7.04 c                             c1geby = 1
7.04  *
7.04 c     fod2lu_key    chain     fod2lur
7.04  *
7.04 c                   eval      fd2sat = c1sats
7.04 c                   eval      fd2kod = c1dkod
7.04  *
7.05 c                   eval      fd2ber = c1geby
7.04  * Legg ut tekst til returkode
7.05 c                   if        c1dkod <> *blank
7.04 c                   eval      ra50l1_dkod = c1dkod
7.04 c     ra50l1_key    chain     ra50l1
7.04 c                   if        %found(ra50l1)
7.05 c                   eval      fd2rtx = regtxt
7.04 c                   endif
7.05 c                   else
7.05 c                   eval      fd2rtx = *blank
7.05 c                   endif
7.04  *
7.04 c                   eval      fd2ors = *blank
7.04  *
7.04 c                   if        %found(fod2lu)
7.04 c                   time                    fd2eda
7.04 c                   time                    fd2eti
7.04 c                   eval      fd2eus = l_user
7.04 c                   update    fod2lur
7.04 c                   else
7.04  *
7.04 c                   eval      fd2fir = w_firm
7.04 c                   eval      fd2num = w_numm
7.04 c                   eval      fd2suf = w_suff
7.04 c                   eval      fd2lin = w_line
7.04 c                   time                    fd2dat
7.04 c                   time                    fd2tim
7.04 c                   eval      fd2oou = l_user
7.04 c                   time                    fd2eda
7.04 c                   time                    fd2eti
7.04 c                   eval      fd2eus = l_user
7.04 c                   write     fod2lur
7.04 c                   endif
7.04  *
7.04 c                   endif
      *
      *
      * Oppdaterer ordre-linje
      *
7.11 c                   eval      fdproj = foproj
7.11 c                   eval      fdakti = foakti
      *
     c                   if        %found(fodtlu)
6.10 c                   time                    fdedat
6.10 c                   time                    fdetim
6.10 c                   eval      fdeusr = l_user
     c                   update    fodtlur
     c                   else
     c                   eval      fdfirm = w_firm
     c                   eval      fdnumm = w_numm
     c                   eval      fdsuff = w_suff
     c                   eval      fdline = w_line
     c                   eval      fdbenr = 0
5.51 c                   eval      fdbsuf = 0
5.51 c                   eval      fdblin = 0
8.10 c*                  eval      fdavde = 0
8.10 c                   eval      fdavde = foavde
     c                   eval      fdkont = 0
     c                   eval      fdspes = 0
6.10 c                   time                    fdodat
6.10 c                   time                    fdotim
6.10 c                   eval      fdoous = l_user
6.10 c                   time                    fdedat
6.10 c                   time                    fdetim
6.10 c                   eval      fdeusr = l_user
     c                   write     fodtlur
     c                   endif
7.10  *
7.10  * Oppretter skyggetabell for logging ved statistikk
7.10  *
7.10 c                   exsr      lag_skygge
      *
      * Oppdatering av lager
      *
     c                   exsr      oppdat_lager
      *
      * Legger inn kode som sier at minst en linje er registrert, og
      * returnerer om kostpris skal vises eller ikke
      *
     c                   eval      p_kode = *on
     c                   eval      p_kost = *in86
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Initierer ny ordre-linje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     ny_linje      begsr
      *
5.70 c                   eval      w_pgla = folage
5.70 c                   eval      w_pgav = foavde
5.70 c                   exsr      hent_prisgr
6.2d c                   eval      c1lage = folage
6.2d c                   exsr      hent_vtyp
      *
      * Fyller opp ordre-linje
      *
     c                   eval      fdltyp = p_ltyp
     c                   eval      fdvare = vvvare
     c                   eval      fdanta = p_anta
     c                   eval      fdenh1 = p_enhe
     c                   eval      fdtek1 = vvtek1
     c                   eval      fdtek2 = vvtek2
     c                   eval      fdlety = p_lety
     c                   eval      fdpasl = fopasl
5.31 c                   eval      fdlage = folage
6.15 c                   eval      fdeann = w_eann
      *
     c                   if        p_enhe = *blank
     c                   eval      fdenh1 = w_enh1
     c                   endif
      *
      * Henter inn priser og rabatter
      *
     c                   eval      hienhe = fdenh1
     c                   eval      hilety = fdlety
     c                   eval      hidekn = fdpasl
     c                   eval      hiavgf = fomkod
     c                   eval      hipriv = 0
7.07 c*                  eval      hiprgr = c1prgr
7.07 c                   eval      hiprgr = w_prgr
      *
     c                   exsr      hent_pris
      *
     c                   eval      fdoppr = hooppr
6.31 c                   if        b_endr = *off and
6.31 c                             w_tilb <> 0   and
6.31 c                             (w_enhe = w_enh1 or
6.31 c                              w_enhe = w_enh2 or
6.31 c                              w_enhe = w_Enh3)
6.31 c                   exsr      tilb_omre
6.31 c                   eval      fdsapr = w_tilb
6.31 c                   eval      fdrab1 = w_tra1
6.31 c                   eval      fdrab2 = w_tra2
6.31 c                   eval      fdkpri = 'A'
7.10 c                   eval      s_okpr = hosapr
7.10 c                   eval      s_okr1 = w_tra1
7.10 c                   eval      s_okr2 = w_tra2
7.10 c                   eval      s_okpk = 'A'
6.31 c                   else
     c                   eval      fdsapr = hosapr
6.35ac                   eval      fdrab1 = horab1
6.35ac                   eval      fdrab2 = horab2
6.31 c                   eval      fdkpri = hokpri
7.10 c                   eval      s_okpr = hosapr
7.10 c                   eval      s_okr1 = horab1
7.10 c                   eval      s_okr2 = horab2
7.10 c                   eval      s_okpk = hokpri
6.31 c                   endif
     c                   eval      fdkopr = hokopr
7.10 c                   eval      s_okop = hokopr
6.39 c*                  eval      fdrab1 = horab1
6.39 c*                  eval      fdrab2 = horab2
     c                   eval      fdpasl = hodekn
     c                   eval      fdkamp = hokamp
     c                   eval      fdalme = hoalme
     c                   eval      fdomva = hoomva
     c                   eval      fdbrty = hobrty
     c                   eval      fdbrr1 = hobrr1
     c                   eval      fdbrr2 = hobrr2
     c                   eval      fdpriv = 0
5.70 c                   eval      fdprgr = hoprgr
     c                   eval      s_prgro = hoprgr
8.01  *
8.01  * Hent inn innkjøpspris, hvis den ikke finnes fra før.
8.01  *
8.01 c                   if        fdinpr = 0
8.01 c                   eval      w_lety = fdlety
8.01 c                   eval      w_lenh = fdenh1
8.01 c                   exsr      innpri
8.01 c                   endif
      *
7.00  * NOBB frakt
      *
7.00 c                   if        u_nobf = *on
7.00 c                   eval      w_lety = fdlety
7.00 c                   eval      w_lenh = fdenh1
7.00 c                   exsr      innpri
7.00 c                   if        w_inpr > 0 and w_inpr <> fdkopr
7.00 c                   eval      fdkopr = w_inpr
7.00 c                   endif
7.00 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avtalenotat
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     notat         begsr
      *
      * Finner nivået som spesialprisen er hentet fra:
      *
      * Kunde/kundeprosjekt
      *
5.70 c                   eval      fpril1_prgr = c1prgr
     c                   eval      fpril1_rkat = 0
     c                   eval      fpril1_kkat = 0
     c                   eval      fpril1_kund = fokund
     c                   eval      fpril1_kpro = fokpro
     c                   eval      fpril1_vare = c1vare
     c                   eval      fpril1_enhe = c1enhe
     c                   eval      fpril1_lety = c1lety
      *
     c                   if        folkun <> 0
     c                   eval      fpril1_kund = folkun
     c                   endif
      *
     c     fpril1_key    chain     fpril1
      *
     c                   if        not %found and
     c                             c1lety <> 0
     c                   eval      fpril1_lety = 0
     c     fpril1_key    chain     fpril1
     c                   endif
      *
     c                   if        not %found
     c                   eval      fpril1_enhe = *blank
     c                   eval      fpril1_lety = c1lety
     c     fpril1_key    chain     fpril1
     c                   if        not %found and
     c                             c1lety <> 0
     c                   eval      fpril1_lety = 0
     c     fpril1_key    chain     fpril1
     c                   endif
     c                   endif
      *
      * Kunde
      *
     c                   if        not %found and
     c                             fokpro <> 0
      *
     c                   eval      fpril1_kpro = 0
     c                   eval      fpril1_enhe = c1enhe
     c                   eval      fpril1_lety = c1lety
      *
     c     fpril1_key    chain     fpril1
      *
     c                   if        not %found and
     c                             c1lety <> 0
     c                   eval      fpril1_lety = 0
     c     fpril1_key    chain     fpril1
     c                   endif
      *
     c                   if        not %found
     c                   eval      fpril1_enhe = *blank
     c                   eval      fpril1_lety = c1lety
     c     fpril1_key    chain     fpril1
     c                   if        not %found and
     c                             c1lety <> 0
     c                   eval      fpril1_lety = 0
     c     fpril1_key    chain     fpril1
     c                   endif
     c                   endif
      *
     c                   endif
      *
      * Avbryter dersom spesialpris ikke ble funnet
      *
     c                   if        not %found
     c                   leavesr
     c                   endif
      *
     c                   eval      fprnl1_nkun = fpril1_kund
     c                   eval      fprnl1_nkpr = fpril1_kpro
     c                   eval      fprnl1_nvar = fpril1_vare
      *
     c     fprnl1_key    chain     fprnl1
     c                   if        %found
     c                   call      'FP550R'
     c                   parm                    w_firm
     c                   parm                    fpril1_kund
     c                   parm                    fpril1_kpro
     c                   parm                    fpril1_vare
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * C1 Behandle bilde for registrering av varelinje med antall
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc1win        begsr
      *
      * Initierer skjermbildet
6.2b  *
6.2b  * Kaller program for henting av Varetype fra lager/vare
6.2b  *
6.2b c                   eval      c1lage = fdlage
8.05 c                   eval      s_lag0 = fdlage
6.2a c                   exsr      hent_vtyp
6.2b  *
6.2b c                   eval      *in50  = *off
6.2b c                   if        p_vtyp = 'S'
6.2b c                   eval      *in50  = *on
6.2b c                   endif
7.04  *
7.04  * Finner Gebyr % -sats / Default satt til 1, at de skal ha retgeb
7.04 c*                   eval      c1geby = 1
7.04  * Sjekk først om linje i tileggsregister allered ligger inne med
7.04  * % sats
7.04 c     fod2l1_key    chain     fod2l1r
7.04 c                   if        %found(fod2l1)
7.04 c                   eval      c1sats = fd2sat
7.04 c                   eval      c1dkod = fd2kod
7.04 c                   eval      c1text = fd2rtx
7.04 c                   eval      c1geby = fd2ber
7.04 c                   else
7.04  *
7.04 c                   eval      fgebl1_otyp = footyp
7.04 c     fgebl1_key    setll     fgebl1
7.04  *
7.04 c     nyles         tag
7.04  *
7.04 c                   read      fgebl1
7.04  *
7.04 c                   if        %eof or
7.04 c                             fgfirm <> w_firm
     c                   eval      *in51 = *off
7.04 c                   goto      ettest
7.04 c                   endif
7.04  * Tester om kode = 4 og at kundekat = 0, da skal alle ha % sats
7.04 c                   if        fgotyp = footyp and
7.04 c                             fgtype = 4 and
7.04 c                             fgkkat = 0
7.04 c                   eval      c1sats = fgsats
7.06 c                   eval      c1geby = u_rgpa
7.05 c                   goto      ettest
7.04 c                   endif
7.04  * Tester om kode = 4 og at kundekat = fra filen er lik kkat på
7.04  * kunden
7.04 c                   if        fgotyp = footyp and
7.04 c                             fgtype = 4 and
7.04 c                             fgkkat = rkkatg
7.04 c                   eval      c1sats = fgsats
7.06 c                   eval      c1geby = u_rgpa
7.05 c                   goto      ettest
7.04 c                   else
7.04 c                   goto      nyles
7.04 c                   endif
7.04 c                   endif
7.04  *
7.04 c     ettest        tag
7.04  *
      *
6.12  * Finner pakningsklasse
6.12  *
6.12 c                   eval      c1pkla = *blank
6.12 c                   eval      vvepl1_pvar = fdvare
6.12 c                   eval      vvepl1_penh = fdenh1
6.12 c                   eval      vvepl1_pldo = vvldor
6.12 c     vvepl1_key    chain     vvepl1
6.12 c                   if        %found(vvepl1)
6.12 c                   eval      c1pkla = vepkla
6.12 c                   endif
      *
     c                   eval      *in81 = w_enh1 = *blank
      *
     c                   eval      *in82 = w_enh2 = *blank
     c                   eval      *in83 = w_enh3 = *blank
      *
6.20 c                   eval      *in84 = w_udat <> *loval
     c                   eval      *in85 = fdpriv = 1 or
     c                                     fdbrr1 <> 0 or
     c                                     fdbrr2 <> 0
      *
     c                   eval      *in88 = fdkpri = 'A'
      *
     c                   eval      c1anta = fdanta
6.28 c                   eval      s_antal  = fdanta
     c                   eval      c1enhe = fdenh1
     c                   eval      c1sapr = fdsapr
     c                   eval      c1rab1 = fdrab1
     c                   eval      c1rab2 = fdrab2
     c                   eval      c1lety = fdlety
     c                   eval      c1kpri = fdkpri
     c                   eval      c1kopr = fdkopr
     c                   eval      c1ltyp = fdltyp
6.3f  *
6.3f c                   if        u_tek1 = *on
6.3f c                   eval      *in47  = '0'
6.3f c                   if        p_vtyp = 'S' or
6.3f c                             p_vtyp = 'L'
6.3f c                   eval      *in47 = '1'
6.3f c                   endif
6.3f c                   endif
6.3f  *
     c                   eval      c1tek1 = fdtek1
     c                   eval      c1tek2 = fdtek2
     c                   eval      c1enh1 = w_enh1
     c                   eval      c1enh2 = w_enh2
     c                   eval      c1enh3 = w_enh3
     c                   eval      c1vare = fdvare
7.xx c                   eval      c1kund = fokund
6.3e c*                   eval      c1nobb = vvnobb
6.3e c                   eval      c1nobb = w_nobb
6.3e c*                  eval      c1nmod = vvnmod
6.3e c                   eval      c1nmod = w_nmod
6.15 c                   eval      c1eann = fdeann
5.70 c                   eval      c1vtyp = p_vtyp
     c                   eval      c1saim = 0
     c                   eval      c1dekn = fdpasl
     c                   eval      c1pasl = 0
     c                   eval      c1lass = fdlass
     c                   eval      c1ldat = 0
6.32 c*                  eval      c1proj = fdproj
6.32 c*                  eval      c1akti = fdakti
     c                   eval      c1ant1 = 0
     c                   eval      c1ant2 = 0
     c                   eval      c1ant3 = 0
     c                   eval      c1alme = fdalme
     c                   eval      c1omva = fdomva
     c                   eval      c1brty = fdbrty
     c                   eval      c1brr1 = fdbrr1
     c                   eval      c1brr2 = fdbrr2
5.71 c*                  eval      c1priv = fdpriv
6.2b c*                  eval      c1lage = fdlage
5.70 c                   eval      c1prgr = fdprgr
     c                   eval      c1udat = 0
      *
     c                   if        fdldat <> *loval
     c     *dmy          move      fdldat        c1ldat
     c                   endif
      *
6.20 c                   if        w_udat <> *loval
6.20 c     *dmy          move      w_udat        c1udat
     c                   endif
6.15  *
6.15  * Kaller program for henting av ean-nr
6.15  *
6.15 c                   if        fdeann = 0
6.2e c                   eval      p_ldor = *zeros
6.2e c**                 call      'VE711R'
6.3e c* lev er allerede funnet i VL710R
6.3e c                   if        w_ldor = 0
6.18 c                   eval      w_ldor = foldor
6.3e c                   endif
6.18 c                   if        p_enhe = *blank
6.18 c                   eval      p_enhe = c1enh1
6.18 c                   endif
6.2e c                   call      'VE713R'
6.15 c                   parm                    w_firm
6.18 c                   parm                    w_ldor
6.18 c**                 parm                    p_ldor
6.15 c                   parm                    p_vare
6.15 c                   parm                    p_enhe
6.15 c                   parm                    c1eann
6.15 c                   parm                    w_east
6.15 c                   endif
      *
      * Kaller subrutine for å vise antall i andre enheter
      *
     c                   exsr      kalkulator
      *
     c                   if        w_enh1 = *blank
     c                   eval      c1enh1 = fdenh1
     c                   eval      c1ant1 = fdanta
     c                   endif
      *
      * Henter lagerbeholdning
      *
     c                   exsr      lagerbeholdn
      *
      * Tar vare på eksisterende verdier
      *
     c                   eval      hosapr = c1sapr
      *
     c                   eval      s_ant1 = c1ant1
     c                   eval      s_ant2 = c1ant2
     c                   eval      s_ant3 = c1ant3
     c                   eval      s_anta = c1anta
     c                   eval      s_enhe = c1enhe
     c                   eval      s_sapr = c1sapr
     c                   eval      s_lety = c1lety
     c                   eval      s_kopr = c1kopr
7.15 c                   eval      s_kop1 = c1kopr
     c                   eval      s_dekn = c1dekn
5.71 c*                  eval      s_priv = c1priv
5.41 c                   eval      s_lage = c1lage
5.70 c                   eval      s_prgr = c1prgr
      *
      * Viser avtalenotat dersom avtalt pris og ny linje
      *
     c                   if        c1kpri = 'A'
     c                   exsr      notat
     c                   endif
      *
      * Viser bildet
      *
     c     c1tagb        tag
      *
     c                   eval      s_rab1 = c1rab1
     c                   eval      s_rab2 = c1rab2
      *
     c                   eval      c1ntpr = c1sapr
     c                   if        c1rab1 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1rab1 / 100)
     c                   endif
     c                   if        c1rab2 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1rab2 / 100)
     c                   endif
     c                   if        c1brr1 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1brr1 / 100)
     c                   endif
     c                   if        c1brr2 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1brr2 / 100)
     c                   endif
      *
7.04  *
7.04 c                   if        c1sats <> 0 and
7.04 c                             c1geby = 1
7.04 c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1sats / 100)
7.04 c                   endif
7.04  *
     c                   if        (c1ntpr * w_mvat) > 9999999,99
     c                   eval      c1ntim = 0
     c                   else
     c                   eval      c1ntim = c1ntpr * w_mvat
     c                   endif
      *
     c                   eval      c1odek = 0
     c                   if        c1kopr <> 0 and
     c                             c1ntpr <> 0
     c                   select
     c                   when      (100 - (c1kopr * 100 / c1ntpr)) > 999,99
     c                   eval      c1odek = 999,99
     c                   when      (100 - (c1kopr * 100 / c1ntpr)) < -999,99
     c                   eval      c1odek = -999,99
     c                   other
     c                   eval(h)   c1odek = 100 - (c1kopr * 100 / c1ntpr)
     c                   endsl
     c                   endif
      *
6.17 c                   if        (c1ntpr*c1anta) < 999999999,99 and
6.3d c                             ((c1ntpr*c1anta) * w_mvat) < 999999999,99
     c                   eval      c1ntsu = c1ntpr * c1anta
     c                   eval      c1nisu = c1ntsu * w_mvat
6.17 c                   else
6.17 c                   eval      *in49 = *on
6.17 c                   eval      c1ntsu = 999999999,99
6.17 c                   eval      c1nisu = 999999999,99
6.17 c                   endif
      *
     c                   exfmt     c1win
      *
      *
     c                   eval      b_forn = *off
      *
      * F2=Manuell beregning av kostpris
      *
     c                   if        *inkb = *on
     c                   call      'FO524R'
     c                   parm                    w_kopr
     c                   if        w_kopr <> 0
     c                   eval      c1kopr = w_kopr
     c                   eval      s_kopr = w_kopr
     c                   if        c1dekn <> 0
     c                   exsr      dekning
     c                   endif
     c                   endif
     c                   goto      c1tagb
     c                   endif
      *
      * F3=Gå tilbake
      *
     c                   if        *inkc or *inkl
     c                   leavesr
     c                   endif
      *
      * F4=Spørring
      *
     c                   if        *inkd  = *on
      *
     c                   if        w_afld = 'C1LETY'
     c                   call      'VY500R'
     c                   parm                    w_firm
     c                   parm                    c1lety
     c                   parm                    w_ltxt
     c                   goto      c1tagb
     c                   endif
      *
6.2h  * vises ikke i bildet lenger
6.2h c*                  if        w_afld = 'C1PROJ'
6.2h c*                  call      'RP500R'
6.2h c*                  parm                    w_firm
6.2h c*                  parm                    c1proj
6.2h c*                  parm                    c1akti
6.2h c*                  parm                    w_kont
6.2h c*                  parm                    w_spes
6.2h c*                  parm                    w_txt1
6.2h c*                  goto      c1tagb
6.2h c*                  endif
5.61  *
5.61  * Call program for aktivitet
5.61  *
6.2h  * vises ikke i bildet lenger
6.2h c*                  if        w_afld = 'C1AKTI'
6.2h c*                  call      'RA521R'
6.2h c*                  parm                    w_firm
6.2h c*                  parm                    c1akti
6.2h c*                  parm                    w_utxt
6.2h c*                  goto      c1tagb
6.2h c*                  endif
      *
5.31 c                   if        w_afld = 'C1LAGE'
5.31 c                   call      'RA510R'
5.31 c                   parm                    w_firm
5.31 c                   parm                    c1lage
5.31 c                   parm                    w_txt1
5.31 c                   goto      c1tagb
5.31 c                   endif
      *
7.04  *
7.04 c                   if        w_afld = 'C1DKOD'
7.04 c                   call      'VY600R'
7.04 c                   parm                    w_firm
7.04 c                   parm                    c1dkod
7.04 c                   parm                    w_ltxt
7.04 c                   movel     w_ltxt        c1text
7.04 c                   goto      c1tagb
7.04 c                   endif
      *
6.2h  * er bare output i bildet, tar bort spørring på det
6.2h c*                  if        w_afld = 'C1PRGR'
6.2h c*                  call      'RA530R'
6.2h c*                  parm                    w_firm
6.2h c*                  parm                    c1prgr
6.2h c*                  parm                    w_dtxt
6.2h c*                  goto      c1tagb
6.2h c*                  endif
      *
     c                   endif
      *
      * F8=Produktinformasjon
      *
     c                   if        *inkh = *on
     c                   call      'FO704C'
     c                   parm                    w_firm
     c                   parm                    fdvare
     c                   goto      c1tagb
     c                   endif
      *
      * F9=Lagerinformasjon
      *
     c                   if        *inki = *on
     c                   call      'LL502R'
     c                   parm                    w_firm
     c                   parm                    fdvare
     c                   goto      c1tagb
     c                   endif
      *
      * F10=Notat
      *
     c                   if        *inkj = *on
     c                   exsr      notat
     c                   goto      c1tagb
     c                   endif
6.30  *
6.30  * F10=Oppsalg /Mersalg
6.30  *
6.30 c                   if        *inkq = *on
6.34  *                  if        b_opme = *on and
6.30 c                   if        *in29  = *on
6.30 c                   exsr      xc7win
6.30 c                   goto      c1tagb
6.30 c                   endif
6.30 c                   endif
5.33  *
5.33  * F06=Tilleggsspesif./linjer
5.33  *
5.33 c                   if        *inkf = *on
5.33 c                   call      'FD115R'
5.33 c                   parm                    w_firm
5.33 c                   parm                    p_numm
5.33 c                   parm                    p_suff
5.33 c                   parm                    p_line
5.33 c                   parm                    fdvare
5.33 c                   parm                    w_totm
5.33 c                   eval      c1anta = w_totm
5.33 c                   eval      c1ant1 = w_totm
5.33 c                   goto      c1tagb
5.33 c                   endif
5.33  *
5.33  * F07=Pakketre
5.33  *
5.33 c                   if        *inkg = *on
5.33 c                   call      'FD117R'
5.33 c                   parm                    w_firm
5.33 c                   parm                    p_numm
5.33 c                   parm                    p_suff
5.33 c                   parm                    p_line
5.33 c                   parm                    fdvare
5.33 c                   parm                    w_totm
5.33 c                   eval      c1anta = w_totm
5.33 c                   eval      c1ant1 = w_totm
5.33 c                   goto      c1tagb
5.33 c                   endif
7.13  *
7.13  * F11=Vis disponibelsituasjon
7.13  *
7.13 c                   if        *inkk = *on
7.13 c                   call      'LL506R'
7.13 c                   parm                    fdvare
7.13 c                   parm                    fdlage
7.13 c                   goto      c1tagb
7.13 c                   endif
9.01  *
9.01  * F14=Vis VA info
9.01  *
9.01 c                   if        *inkn = *on
9.01 c                   exsr      vis_VA
9.01 c                   goto      c1tagb
9.01 c                   endif
6.36  *
6.36  * F18=NOBB informasjon
6.36  *
6.36 c                   if        *inks = *on
6.36 c                   exsr      vis_nobb
6.36 c                   goto      c1tagb
6.36 c                   endif
      *
      * F23=Skifte mellom skjul/vis kostpris (dersom tillatt på bruker)
      *
     c                   if        *inkx = *on and
     c                             fbko01 = 1
     c                   if        *in86 = *off
     c                   eval      *in86 = *on
     c                   else
     c                   eval      *in86 = *off
     c                   endif
     c                   goto      c1tagb
     c                   endif
      *
      * Enhet må oppgis dersom varen ikke har enhet
      *
     c                   if        w_enh1 = *blank
      *
     c                   if        c1enh1 = *blank
     c                   eval      *in31 = *on
     c                   goto      c1tagb
     c                   endif
      *
     c                   eval      venhl1_eenh = c1enh1
     c     venhl1_key    chain     venhl1
     c                   if        not %found
     c                   eval      *in32 = *on
     c                   goto      c1tagb
     c                   endif
      *
     c                   endif
7.fb  *
7.fb  * sjekker om avvik større enn tillatt
7.f2 c                   if        b_100p = *on
7.f2 c**                           p_erst = 0
7.fb c                   exsr      sjekk_depsum
7.fb c                   if        b_feil = *on
7.fb c                   goto      c1tagb
7.fb c                   endif
7.fb c                   endif
      *
      * Sjekker og behandler antall
      *
     c                   if        c1ant1 = 0 and
     c                             c1ant2 = 0 and
     c                             c1ant3 = 0 and
     c                             c1anta = 0
     c                   eval      *in33 = *on
     c                   goto      c1tagb
     c                   endif
      *
     c                   select
     c                   when      c1ant1 <> s_ant1 and
     c                             c1ant1 <> 0 or
     c                             w_enh1 = *blank and
     c                             c1ant1 <> 0
     c                   eval      s_ant1 = c1ant1
     c                   eval      c1anta = c1ant1
     c                   eval      c1enhe = c1enh1
5.41 c                   eval      b_lage = *on
     c                   when      c1ant2 <> s_ant2 and
     c                             c1ant2 <> 0
     c                   eval      s_ant2 = c1ant2
     c                   eval      c1anta = c1ant2
     c                   eval      c1enhe = c1enh2
5.41 c                   eval      b_lage = *on
     c                   when      c1ant3 <> s_ant3 and
     c                             c1ant3 <> 0
     c                   eval      s_ant3 = c1ant3
     c                   eval      c1anta = c1ant3
     c                   eval      c1enhe = c1enh3
5.41 c                   eval      b_lage = *on
     c                   endsl
8.05  * Hvis avvikende lager, skal det også oppdateres lager
8.05 c                   if        c1lage <> s_lag0
8.05 c                   eval      b_lage = *on
8.05 c                   endif
8.05  *
6.12 c                   eval      c1pkla = *blank
6.12 c                   eval      vvepl1_pvar = fdvare
6.12 c                   eval      vvepl1_penh = c1enhe
6.12 c                   eval      vvepl1_pldo = vvldor
6.12 c     vvepl1_key    chain     vvepl1
6.12 c                   if        %found(vvepl1)
6.12 c                   eval      c1pkla = vepkla
6.12 c                   endif
5.31  *
5.31  * Sjekk gyldig lager
5.31  *
5.31 c                   exsr      sjekk_lager
5.31 c                   if        b_feil = *on
5.31 c                   eval      *in38 = *on
5.31 c                   goto      c1tagb
5.31 c                   endif
      *
      * Sjekk leveringstype
      *
     c                   eval      vltpl1_lety = c1lety
     c     vltpl1_key    chain     vltpl1
     c                   if        not %found
     c                   eval      *in34 = *on
     c                   goto      c1tagb
     c                   endif
6.2i  *
6.2i  * Hvis man endrer lev.type og akk.type >= 2, så feil
6.2i  *
6.2i c                   if        c1lety <> s_lety and
6.2i c                             vaoakk >=2
6 2i c                   eval      *in46  = *on
6.2i c                   goto      c1tagb
6.2i c                   endif
6.2g  *
6.2g  * Hvis man endrer lev.type, ikke tillatt hvis bestilling er
6.2g  * dannet.
6.2g  *
6.2g c                   exsr      sjekk_bestf
6.2g c                   if        c1lety <> s_lety and
6.2g c                             (fdbenr <> 0  or
6.2g c                              b_bfoh = *on)
6.2g c                   eval      *in45 = *on
6.2g c                   goto      c1tagb
6.2g c                   endif
5.32  *
5.32  * Sjekk linjetype
5.32  *
5.32 c                   eval      vltyl1_ltyp = c1ltyp
5.32 c     vltyl1_key    chain     vltyl1                             90
5.32 c                   if        *in90 = *on
5.32 c                   eval      b_feil = *on
5.32 c                   eval      *in42 = *on
5.32 c                   goto      c1tagb
5.32 c                   endif
5.32  *
5.32  * Tekst-linjetype og vare kan ikke oppgis samtidig
5.32  *
5.32 c                   if        valktx = 1 and
5.32 c                             c1vare <> *blank
5.32 c                   eval      b_feil = *on
5.32 c                   eval      *in43 = *on
5.32 c                   goto      c1tagb
5.32 c                   endif
5.32  *
5.32  * Vare må oppgis sammen med vare-linjetype
5.32  *
5.32 c                   if        valktx = 0 and
5.32 c                             c1vare = *blank
5.32 c                   eval      b_feil = *on
5.32 c                   eval      *in44 = *on
5.32 c                   goto      c1tagb
5.32 c                   endif
      *
      * Sjekk varetekst
      *
     c                   if        c1tek1 = *blank
     c                   eval      *in35 = *on
     c                   goto      c1tagb
     c                   endif
      *
      * Salgspris inkl.mva, DG og påslag kan ikke endres samtidig
      *
     c                   select
     c                   when      c1saim <> 0
     c                   if        c1dekn <> s_dekn and
     c                             c1dekn <> 0 or
     c                             c1pasl <> 0
     c                   eval      *in36 = *on
     c                   goto      c1tagb
     c                   endif
     c                   when      c1dekn <> s_dekn and
     c                             c1dekn <> 0
     c                   if        c1saim <> 0 or
     c                             c1pasl <> 0
     c                   eval      *in36 = *on
     c                   goto      c1tagb
     c                   endif
     c                   when      c1pasl <> 0
     c                   if        c1saim <> 0 or
     c                             c1dekn <> s_dekn and
     c                             c1dekn <> 0
     c                   eval      *in36 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endsl
      *
      * DG og påslag kan ikke oppgis når kostpris = 0
      *
     c                   if        c1kopr = 0
     c                   if        c1dekn <> 0 or
     c                             c1pasl <> 0
     c                   eval      *in37 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Sjekk leveringsdato
      *
     c                   if        c1ldat <> 0
     c     *dmy          test(d)                 c1ldat                 40
     c                   if        *in40 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Sjekk om leveringsdato er større enn ordredato
      *
     c                   if        c1ldat <> 0
     c     *dmy          move      c1ldat        w_ldat
     c                   if        w_ldat < fobdat
     c                   eval      *in41 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Sjekk prosjekt
      *
      * vises ikke lenger i bildet
6.2h c**                 if        c1proj <> 0 and
6.2h c*                  if        c1proj <> *blank and
6.2h c*                            c1proj <> fdproj
6.2h c*                  eval      w_kont = 0
6.2h c*                  eval      w_spes = 0
6.2h c*                  call      'RS770R'
6.2h c*                  parm                    w_retk
6.2h c*                  parm                    c1proj
6.2h c*                  parm                    c1akti
6.2h c*                  parm                    w_kont
6.2h c*                  parm                    w_spes
6.2h c*                  parm                    w_txt1
6.2h c*                  parm                    w_txt2
6.2h c*                  if        w_retk <> *blank
6.2h c*                  eval      *in45 = *on
6.2h c*                  goto      c1tagb
6.2h c*                  endif
6.2h c*                  endif
6.2h  *
6.2h  * Sjekk aktivitet
6.2h  *
6.2h  * vises ikke bildet lenger
6.2h c*                  if        c1akti <> *blank and
6.2h c*                            c1akti <> fdakti
6.2h c*                  call      'RS721R'
6.2h c*                  parm                    w_retk
6.2h c*                  parm                    c1akti
6.2h c*                  parm                    w_txt1
6.2h c*                  if        w_retk <> *blank
6.2h c*                  eval      *in46 = *on
6.2h c*                  goto      c1tagb
6.2h c*                  endif
6.2h c*                  endif
5.70  *
5.70  * Sjekk prisgruppe
5.70  *
6.2h  * ligger som output i bildet, dropper inputkontroll
6.2h c*                  if        c1prgr <> *blank and
6.2h c*                            c1prgr <> fdprgr
6.2h c*                  eval      ra30lr_dkod = c1prgr
6.2h c*    ra30lr_key    chain     ra30lr
6.2h c*                  if        not  %found(ra30lr)
6.2h c*                  eval      *in47 = *on
6.2h c*                  goto      c1tagb
6.2h c*                  endif
6.2h c*                  endif
      * Kaller subrutine for å vise antall i andre enheter
      *
     c                   if        w_enh2 <> *blank
     c                   exsr      kalkulator
     c                   eval      s_ant1 = c1ant1
     c                   eval      s_ant2 = c1ant2
     c                   eval      s_ant3 = c1ant3
     c                   endif
      *
      * Henter ny lagerbeholdning dersom enhet er endret
      *
6.28 c                   if        c1enhe <> s_enhe or
6.28 c                             c1lage <> s_lage
6.2a c                   exsr      hent_vtyp
     c                   exsr      lagerbeholdn
     c                   endif

5.70  * Hvis lager er endret hentes prisgr. på nytt
5.70  *
5.70 c                   if        c1lage <> s_lage
5.70 c                   eval      w_pgla = c1lage
5.70 c                   exsr      hent_prisgr_v
     c                   if        c1prgr <> w_oprg
     c                   exsr      xc1msg2
5.70 c                   endif
5.70 c                   endif
      *
      * Dersom enhet, leveringstype eller lager er endret hentes ny pris
      * og rabatt.
      *
     c                   if        c1enhe <> s_enhe or
     c                             c1lety <> s_lety or
5.70 c                             c1prgr <> s_prgr or
5.70 c                             c1lage <> s_lage
5.71 c*                            c1priv <> s_priv
      *
6.2f c                   if        c1sapr > 0 and c1sapr <> s_sapr
6.2f c                   eval      s_enh2 = s_enhe
6.36ac                   elseif    b_endr = *off and
6.36ac                              w_tilb <> 0   and
6.36ac                              (w_enhe = w_enh1 or
6.36ac                              w_enhe = w_enh2 or
6.36ac                              w_enhe = w_Enh3)
6.26ac                   eval      s_enh2 = s_enhe
6.2f c                   endif
     c                   eval      s_enhe = c1enhe
     c                   eval      s_lety = c1lety
     c                   eval      s_dekn = c1dekn
5.71 c*                  eval      s_priv = c1priv
5.70 c                   eval      s_prgr = c1prgr
6.14 c                   eval      s_lage = c1lage
      *
     c                   eval      hienhe = c1enhe
     c                   eval      hilety = c1lety
     c                   eval      hidekn = c1dekn
     c                   eval      hiavgf = fomkod
5.71 c                   eval      hipriv = 0
5.70 c                   eval      hiprgr = c1prgr
6.2k c                   eval      hilety = c1lety
     c                   exsr      hent_pris
8.03  * Hent innkjøpspris på nytt, da enhet er endret.
8.03 c                   eval      w_lety = c1lety
8.03 c                   eval      w_lenh = c1enhe
8.03 c                   exsr      innpri
      *
     c                   eval      c1alme = hoalme
     c                   eval      c1omva = hoomva
     c                   eval      c1brty = hobrty
     c                   eval      c1brr1 = hobrr1
     c                   eval      c1brr2 = hobrr2
      *
      * Oppdater ny pris bare dersom pris ikke er overstyrt og dersom
5.70  * pris ikke er forsjellig fra null og prisgruppe har endret seg
      *
     c                   if        hosapr <> 0
6.35ac                   if        b_endr = *off and
6.35ac                             w_tilb <> 0   and
6.35ac                             (w_enhe = w_enh1 or
6.35ac                              w_enhe = w_enh2 or
6.35ac                              w_enhe = w_Enh3)
6.26ac*                  eval      s_enh2 = s_enhe
6.35ac                   exsr      tilb_omre2
6.35ac*                  eval      c1sapr = w_tilb
6.35ac                   eval      c1rab1 = w_tra1
6.35ac                   eval      c1rab2 = w_tra2
6.35ac                   eval      c1kopr = hokopr
6.35ac                   eval      c1kpri = 'A'
7.10 c                   eval      s_okpr = hosapr
7.10 c                   eval      s_okr1 = w_tra1
7.10 c                   eval      s_okr2 = w_tra2
7.10 c                   eval      s_okpk = 'A'
6.35ac                   else
6.2f c                   if        (c1sapr = s_sapr or
5.70 c                             c1sapr = 0  or
6.2f c                             s_prgr <> hoprgr) and
6.2f c                             s_enh2 = *blank
     c                   eval      c1sapr = hosapr
     c                   eval      c1kopr = hokopr
     c                   eval      c1kpri = hokpri
     c                   eval      c1rab1 = horab1
     c                   eval      c1rab2 = horab2
5.70 c                   eval      c1prgr = hoprgr
7.10 c                   eval      s_okpr = hosapr
7.10 c                   eval      s_okr1 = horab1
7.10 c                   eval      s_okr2 = horab2
7.10 c                   eval      s_okpk = hokpri
     c                   eval      s_anta = c1anta
     c                   eval      s_sapr = c1sapr
     c                   eval      s_rab1 = c1rab1
     c                   eval      s_rab2 = c1rab2
5.70 c                   eval      s_prgr = c1prgr
     c                   eval      b_forn = *on
6.2f c                   elseif    s_enh2 <> c1enhe
6.36ac                   exsr      overst_omre
6.2fac                   endif
     c                   endif
6.35ac                   endif
      *
      * Henter GTIN på nytt, ved ny enhet
7.01 c                   call      'VE713R'
7.01 c                   parm                    w_firm
7.01 c                   parm                    foldor
7.01 c                   parm                    p_vare
7.01 c                   parm                    c1enhe
7.01 c                   parm                    c1eann
7.01 c                   parm                    w_east
      *
     c                   endif
7.00  * NOBB frakt
7.00 c                   if        u_nobf = *on
7.15 c                   if        c1kopr <> s_kop1 and c1lety = 1
7.15 c                   goto      kost_ok
7.15 c                   endif
7.00 c                   eval      w_lety = c1lety
7.00 c                   eval      w_lenh = c1enhe
7.00 c                   exsr      innpri
7.00 c                   if        w_inpr > 0 and w_inpr <> c1kopr
7.00 c                   eval      c1kopr = w_inpr
7.00 c                   endif
7.15 c     kost_ok       tag
7.00 c                   endif
      *
      * Behandling av salgspris inkl.mva.
      *
     c                   if        c1saim <> 0
     c                   eval(h)   c1sapr = c1saim * w_mvaf
     c                   eval      c1dekn = 0
     c                   eval      c1saim = 0
     c                   goto      c1tagb
     c                   endif
      *
      * Behandling av kostpris
      *
     c                   if        c1kopr <> s_kopr
     c                   eval      s_kopr = c1kopr
     c                   eval      s_dekn = c1dekn
     c                   if        c1dekn <> 0 and
     c                             c1pasl = 0
     c                   exsr      dekning
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Behandling av DG
      *
     c                   if        c1dekn = s_dekn and
     c                             c1dekn <> 0
     c                   if        c1rab1 <> s_rab1 or
     c                             c1rab2 <> s_rab2
     c                   eval      c1dekn = 0
     c                   eval      s_dekn = 0
     c                   eval      s_rab1 = c1rab1
     c                   eval      s_rab2 = c1rab2
     c                   endif
     c                   endif
      *
     c                   if        c1dekn <> s_dekn
     c                   eval      s_dekn = c1dekn
     c                   if        c1dekn <> 0
     c                   exsr      dekning
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Behandling av påslag
      *
     c                   if        c1pasl <> 0
     c                   eval(h)   w_sapr = c1kopr + (c1kopr * c1pasl / 100)
     c                   eval(h)   c1dekn = 100 - (c1kopr * 100 / w_sapr)
     c                   eval      c1pasl = 0
     c                   eval      s_dekn = c1dekn
     c                   if        c1dekn <> 0
     c                   exsr      dekning
     c                   endif
     c                   goto      c1tagb
     c                   endif
      *
      * Viser bildet på nytt dersom dette er angitt
      *
     c                   if        b_forn = *on
     c                   goto      c1tagb
     c                   endif
      *
      * Viser bildet på nytt dersom varen har flere enheter, antall er
      * endret og bildet ikke allerede er vist
      *
     c                   if        w_enh2 <> *blank and
     c                             c1anta <> s_anta
     c                   eval      s_anta = c1anta
     c                   goto      c1tagb
     c                   endif
      *
      * Sjekk pris
      *
     c                   if        c1sapr <= 0,01
     c                   eval      *in39 = *on
     c                   goto      c1tagb
     c                   endif
6.16  *
6.16  * Sjekker lagerbeholdning
6.16  *
6.28  * 0=ingen sjekk
6.28  * 1=sjekkes, men du kan gå videre
6.28  * 2=sjekkes, går ikke videre med neg. behold.
6.28  *
6.28 c                   eval      b_behl = *off
6.28  *
6.28 c                   if        faalag = 1 and                               B1
6.28 c                             p_vtyp = 'L' and
6.28 c                             folety = 0   and
6.28 c                             vaoakk > 0   and
6.28 c                             faabeh > 0
6.2c  *
6.2c  * kontroller at vare ligger på vlagpf
6.2c  * bør ikke forekomme, men skal stoppes !!
6.2c c                   eval      vlagl1_vare = c1vare
6.2c c                   eval      vlagl1_lage = c1lage
6.2c c     vlagl1_key    chain     vlagl1
6.2c c                   if        not %found(vlagl1)
6.2c c                   exfmt     c6msg
6.2c c                   goto      c1tagb
5.2c c                   endif
6.28  *
6.28  * her er antall endret - kun endringen skal sjekkes mot lager
6.28 c                   if        b_endr = *on                                 B2
6.28 c                   if        s_antal <> c1anta and                        B3
6.28 c                             (c1anta - s_antal) > c1disp
6.28 c                   eval      b_behl = *on
6.28 c                   endif                                                  E3
6.28 c                   else                                                   X2
6.28  * nyregistrering
6.28 c                   if        c1anta  > c1disp                             B3
6.28 c                   eval      b_behl = *on
6.28 c                   endif                                                  E3
6.28 c                   endif                                                  E2
6.28  *
6.28 c                   if        b_behl = *on                                 B2
6.28  *
6.28 c                   if        faabeh = 1                                   B3
6.28 c                   exfmt     c2msg
6.28 c                   if        *inkc or *inkl                               B4
6.28 c                   goto      c1tagb
6.28 c                   endif                                                  E4
6.28 c                   else                                                   x3
6.28 c                   exfmt     c5msg
6.28 c                   goto      c1tagb
6.28 c                   endif                                                  E3
6.28 c                   endif                                                  E2
6.28 c                   endif                                                  E1
      *
      * Sender advarsel dersom netto salgspris < kostpris
      *
     c                   eval      w_sapr = c1sapr
     c                   if        c1rab1 > 0
     c                   eval(h)   w_sapr = w_sapr - (w_sapr * c1rab1 / 100)
     c                   endif
     c                   if        c1rab2 > 0
     c                   eval(h)   w_sapr = w_sapr - (w_sapr * c1rab2 / 100)
     c                   endif
      *
     c                   if        c1kopr > w_sapr
     c                   exfmt     c1msg
     c                   if        *inkc or *inkl
     c                   goto      c1tagb
     c                   endif
     c                   endif
8.07  *
8.07  * Hvis endret rabatt, vis bildet på nytt
8.07  *
8.07 c                   if        c1rab1 <> s_rab1 or
8.07 c                             c1rab2 <> s_rab2
8.07 c                   goto      c1tagb
8.07 c                   endif
6.2a  *
6.2a  * henter av varetype fra lager/vare
6.2a  *
6.2a c                   exsr      hent_vtyp
6.2a  *
6.24  * Sjekk om det er en 'S' vare
6.24  * Ingen sjekk dersom kode = 0
6.24 c*                  eval      *in50 = '0'
6.24 c                   if        faalbe = 0
6.24 c                   goto      end_skaf1
6.24 c                   endif
6.24  *
6.24  * Kode = 1
6.24 c                   if        p_vtyp = 'S' and faalbe = 1
6.26 c                   exsr      xc3msg
6.26 c                   if        b_skaf = *on
6.26 c                   goto      end_skaf1
6.26 c                   endif
6.26 c                   goto      c1tagb
6.24 c                   endif
6.24  *
6.24  *
6.24  * Kode = 2
6.24 c                   if        p_vtyp = 'S' and
6.24 c                             (faalbe = 2 or faalbe = 3)
6.26 c                   exsr      xc4msg
6.24 c                   goto      c1tagb
6.24 c                   endif
6.24  *
6.24 c     end_skaf1     tag
      *
      * Korrigerer vekk fra lager dersom linjen er endret
      *
     c                   if        b_endr = *on
     c                   eval      fdanta = fdanta * -1
     c                   exsr      oppdat_lager
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * C1 gir melding ved endring av lager og at prisgruppe er endret
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc1msg2       begsr
     c                   exfmt     c1msg2
     c                   if        *inkc or *inkl
6.14 c                   eval      c1prgr = s_prgr
     c                   goto      end_xc1msg2
     c                   endif
     c                   eval      c1prgr = w_oprg
      *
     c     end_xc1msg2   endsr
6.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.26  * C3msg gir melding ved skaffevare og evt. spørring på lager
6.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.26  *
6.26 c     xc3msg        begsr
6.26 c                   eval      b_skaf = *off
6.26  *
6.26 c                   exfmt     c3msg
6.26  *
6.26 c                   select
6.26 c                   when      *inkc
6.26 c                   goto      end_xc3msg
6.26 c                   when      *inkg
6.26 c                   eval      c1lage = s_lage
6.26 c                   eval      w_vvty  = 'L'
6.26 c                   call      'LL510R '
6.26 c                   parm                    vvvare
6.26 c                   parm                    w_vvty
6.26 c                   parm                    c1lage
6.2a c                   exsr      hent_vtyp
6.26 c                   other
6.26 c                   eval      b_skaf = *on
6.26 c                   endsl
6.26  *
6.26 c     end_xc3msg    endsr
6.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.26  * C4msg gir melding ved skaffevare og evt. spørring på lager
6.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.26  *
6.26 c     xc4msg        begsr
6.26 c                   eval      b_skaf = *off
6.26  *
6.26 c                   exfmt     c4msg
6.26  *
6.26 c                   if        *inkg
6.26 c                   eval      w_vvty  = 'L'
6.26 c                   eval      c1lage  = s_lage
6.26 c                   call      'LL510R '
6.26 c                   parm                    vvvare
6.26 c                   parm                    w_vvty
6.26 c                   parm                    c1lage
6.2a c                   exsr      hent_vtyp
6.26 c                   endif
6.26  *
6.26 c     end_xc4msg    endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.30  * C7 gir popup på oppsalg og mersalg (BM Modul)
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.30  *
6.30 c     xc7win        begsr
      * blanker info
     c                   eval      c7sort = *blank
     c                   eval      c7sldo = 0
     c                   eval      c7slna = *blank
     c                   eval      c7utko = *blank
     c                   eval      c7bran = *blank
     c                   eval      c7knav = *blank
6.30  * henter info fra VA
6.30 c                   eval      jvarl1_vare = vvvare
6.30 c     jvarl1_key    chain     jvarl1
6.30 c                   if        %found(jvarl1)
6.30 c                   movel     jvsort        c7sort
6.30 c                   eval      c7sldo = jvsldo
6.30 c                   eval      jlevl1_ldor = jvsldo
6.30 c     jlevl1_key    chain     jlevl1
6.30 c                   if        %found(jlevl1)
6.30 c                   eval      c7slna = jlnavn
6.30 c                   endif
6.30 c                   select
6.30 c                   when      jvutko = '1'
6.30 c                   eval      c7utko = 'Utstilt'
6.30 c                   when      jvutko = '2'
6.30 c                   eval      c7utko = 'Utstilt og lagerført'
6.30 c                   other
6.30 c                   eval      c7utko = *blank
6.30 c                   endsl
6.30 c
6.30 c                   eval      c7bran = jvbran
6.30 c                   eval      jkatl1_kate = jvkate
6.30 c     jkatl1_key    chain     jkatl1
6.30 c                   if        %found(jkatl1)
6.30 c                   eval      c7knav = jknavn
6.30 c                   endif
6.30 c                   endif
6.30 c
6.30 c                   exfmt     c7win
6.30 c                   if        *inkc or *inkl
6.30 c                   goto      end_c7win
6.30 c                   endif
6.30 c                   eval      b_opme = *off
6.30  *
6.30 c     end_c7win     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Henter kalkulert pris på varen
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_pris     begsr
      *
     c                   eval      hifirm = w_firm
     c                   eval      hirkat = 0
      *
     c                   eval      hikund = fokund
     c                   if        folkun <> 0
     c                   eval      hikund = folkun
     c                   endif
      *
     c                   eval      hikpro = fokpro
     c                   eval      hivare = vvvare
     c                   eval      hidato = fobdat
     c                   eval      hitime = *loval
     c                   eval      hinumm = 0
     c                   eval      hikode = fopask
     c                   eval      hiskaf = *off
6.2d c                   eval      hildor = w_ldor
     c                   eval      hisapr = 0
     c                   eval      hikopr = 0
      *
     c                   call      'VP900R'
     c                   parm                    hirec
     c                   parm                    horec
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Kalkulator for omregning mellom enheter
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     kalkulator    begsr
      *
     c                   if        c1enhe <> *blank
      *
     c                   eval      c1ant1 = 0
     c                   eval      c1ant2 = 0
     c                   eval      c1ant3 = 0
      *
     c                   select
     c                   when      c1enhe = w_enh1
     c                   eval      c1ant1 = c1anta
     c                   if        w_omr2 <> 0
     c                   eval(h)   c1ant2 = c1anta / w_omr2
     c                   endif
     c                   if        w_omr3 <> 0
     c                   eval(h)   c1ant3 = c1anta / w_omr3
     c                   endif
     c                   when      c1enhe = w_enh2
     c                   eval(h)   c1ant1 = c1anta * w_omr2
     c                   eval      c1ant2 = c1anta
     c                   if        w_omr3 <> 0
     c                   eval(h)   c1ant3 = c1ant1 / w_omr3
     c                   endif
     c                   when      c1enhe = w_enh3
     c                   eval(h)   c1ant1 = c1anta * w_omr3
     c                   if        w_omr2 <> 0
     c                   eval(h)   c1ant2 = c1ant1 / w_omr2
     c                   endif
     c                   eval      c1ant3 = c1anta
     c                   endsl
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Henter beholdingstall dersom lagervare og lager kjøres
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     lagerbeholdn  begsr
      *
     c                   eval      *in87  = *off
7.13 c                   eval      *in89  = *off
     c                   eval      c1behl = 0
     c                   eval      c1bbes = 0
     c                   eval      c1pakk = 0
     c                   eval      c1disp = 0
      *
     c                   if        faalag = 1 and
5.70 c                             p_vtyp = 'L'
     c                   call      'VL700R'
     c                   parm                    p_firm
     c                   parm                    fdvare
6.28 c                   parm                    c1lage
     c                   parm                    c1enhe
     c                   parm                    c1behl
     c                   parm                    c1bbes
     c                   parm                    c1pakk
     c                   parm                    c1disp
     c                   eval      *in87 = *on
7.13  *
7.13  * Vi henter reell disponibelsituasjon basert på leveringsdato på ordren.
7.13  *
7.13 c                   if        fdldat <> *loval
7.13 c                   eval      p_dato = fdldat
7.13 c                   elseif    foldat <> *loval
7.13 c                   eval      p_dato = foldat
7.13 c                   elseif    fobdat <> *loval
7.13 c                   eval      p_dato = fobdat
7.13 c                   endif
7.13  *
7.13 c                   eval      p_time = *loval
7.13 c                   eval      p_kalk = *blanks
7.13 c                   eval      p_behl = 0
7.13 c                   eval      p_lenh = *blanks
7.13 c                   call      'VL718R'
7.13 c                   parm                    p_firm
7.13 c                   parm                    fdvare
7.13 c                   parm                    c1enhe
7.13 c                   parm                    c1lage
7.13 c                   parm                    p_dato
7.13 c                   parm                    p_time
7.13 c                   parm                    p_kalk
7.13 c                   parm                    p_behl
7.13 c                   parm                    p_lenh
7.13 c                   parm                    p_inlr
7.13  *
7.13 c                   eval      c1disp = p_behl
7.13 c                   if        c1disp < 0
7.13 c                   eval      *in89 = *on
7.13 c                   endif
7.13 c     *dmy          move      p_dato        c1ddat
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Beregner salgspris og rabatt i.h.t. dekningsgrad (DG)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dekning       begsr
      *
     c                   eval(h)   c1sapr = (100 * c1kopr) / (100 - c1dekn)
     c                   eval      c1rab1 = 0
     c                   eval      c1rab2 = 0
      *
     c                   if        fopask = *blank
     c                   if        hosapr > 0,01
     c                   eval(h)   w_rab1 = (hosapr - c1sapr) * 100 / hosapr
8.09 c*                  eval(h)   w_rab1 = (c1kopr - c1sapr) * 100 / c1kopr
     c                   if        w_rab1 >= 0
8.09 c                   eval      c1sapr = hosapr
     c                   eval      c1rab1 = w_rab1
     c                   endif
     c                   endif
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for oppdatering av lager
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppdat_lager  begsr
      *
     c                   if        faalag = 1 and
5.70 c                             p_vtyp = 'L'
     c                   else
     c                   leavesr
     c                   endif
5.41  *
5.41  * Ingen lageroppdatering dersom dette er endring og
5.41  * antall, enhet og lager er urørt
5.41  *
5.41 c                   if        b_endr = *on    and
5.41 c                             b_lage = *off   and
5.41 c                             c1anta = s_anta and
5.41 c                             c1ant1 = s_ant1 and
5.41 c                             c1ant2 = s_ant2 and
5.41 c                             c1ant3 = s_ant3 and
5.41 c                             c1enhe = s_enhe and
5.41 c                             c1lage = s_lage
5.41 c                   leavesr
5.41 c                   endif
      *
      * Legger over verdier i overførings-felter
      *
     c                   eval      hlvare = fdvare
5.31 c                   eval      hllage = fdlage
     c                   eval      hlenhe = fdenh1
     c                   eval      hldato = *loval
     c                   eval      hltime = *loval
     c                   eval      hlotyp = footyp
     c                   eval      hlltyp = fdltyp
      *
     c                   eval      hlanta = fdanta
     c                   eval      hlkopr = fdkopr
      *
     c                   eval      hlrefr = *blank
     c                   eval      hlsyst = 'F'
     c                   eval      hlaltk = *blank
     c                   eval      hlrest = *blank
3.12  *
     c                   move      fdnumm        w_numa
     c                   move      fdline        w_lina
     c                   eval      hlrefr = 'O:' + w_numa +
     c                                      ' L:' + w_lina
6.13 c                   eval      hlonum = fdnumm
6.13 c                   eval      hlolin = fdline
3.12 c                   move      fdlety        hllety
      *
      * Kaller lageroppdaterings-program
      *
     c                   eval      w_stat = *blank
      *
     c                   call      'VL001R'
     c                   parm                    w_stat
     c                   parm                    hlrec
      *
     c                   endsr
5.31  *
5.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.31  * Sjekker gyldig lager
5.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.31  *
5.31 c     sjekk_lager   begsr
5.31  *
5.31 c                   eval      b_feil = *off
5.31  *
5.31 c                   call      'FÅ720R'
5.31 c                   parm                    p_firm
5.31 c                   parm                    c1lage
5.31 c                   parm                    w_jtxt
5.31 c                   parm                    w_jadr
5.31 c                   parm                    w_jpnr
5.31 c                   parm                    w_jste
5.31 c                   parm                    w_javd
5.31 c                   parm                    w_retk
5.31  *
5.31 c                   if        w_retk <> '0'
5.31 c                   eval      b_feil = *on
5.31 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * ERROR-rutine
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *pssr         begsr
      *
     c                   eval      *in49 = *on
     c                   goto      tc1win
      *
     c                   endsr
      *
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.70  * Henter prisgruppe
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.70  *
5.70 c     hent_prisgr   begsr
5.70  *
5.70  * Henter prisgruppe
5.70  *
5.70 c                   call      'VL712R   '
5.70 c                   parm                    w_firm
5.70 c                   parm                    w_pgla
5.70 c                   parm                    w_pgav
5.70 c                   parm                    w_prgr
5.70  *
5.70 c                   endsr
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.70  * Henter prisgruppe på spesifikk vare
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.70  *
5.70 c     hent_prisgr_v begsr
5.70  *
5.70  * Henter prisgruppe
5.70  *
5.70 c                   call      'VL712R   '
5.70 c                   parm                    w_firm
5.70 c                   parm                    w_pgla
5.70 c                   parm                    w_pgav
5.70 c                   parm                    w_iprg
5.70  * sjekker om valgt vare har denne prisgruppen
5.70  *
     c                   eval      w_vare = vvvare
5.70 c                   call      'VL713R   '
5.70 c                   parm                    w_firm
5.70 c                   parm                    w_iprg
5.70 c                   parm                    w_vare
5.70 c                   parm                    c1enhe
5.70 c                   parm                    c1lety
5.70 c                   parm                    w_oprg
5.70  *
5.70 c                   endsr
6.2a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2a  * Subrutine for å hente varetype ut fra lager / vare
6.2a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2a  *
6.2a c     hent_vtyp     begsr
6.2a c
6.2a c                   call      'VL710R'
6.2a c                   parm                    w_firm
6.2a c                   parm                    vvvare
6.2a c                   parm                    c1lage
6.2a c                   parm                    p_vtyp
6.2a c                   parm                    w_udat
6.2a c                   parm                    w_ldor
6.2a c                   parm                    b_inlr
6.3e c                   parm                    w_lv_nobb
6.3e c                   parm                    w_lv_modn
6.3e c                   parm                    w_lv_lldo
6.3e c                   parm                    w_lv_llva
6.2a  *
6.2a c                   eval                    c1vtyp = p_vtyp
6.2a  *
6.2a c                   endsr
6.2g  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2g  * Subrutine for å sjekke om det finnes best.forslag heading
6.2g  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2g  *
6.2g c     sjekk_bestf   begsr
6.2g  *
6.2g c                   eval      b_bfoh = *off
6.2g c                   eval      lfdtl6_ornr =   fonumm
6.2g c     lfdtl6_key    setll     lfdtl6
6.2g c     lfdtl6_key    reade     lfdtl6
6.2g c                   dow       not %eof(lfdtl6)
6.2g c                   eval      b_bfoh = *on
6.2g c     lfdtl6_key    reade     lfdtl6
6.2g c                   enddo
6.2g c                   endsr
      *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Subrutine for å omregne tilbudspris til gjeldende enhet
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     tilb_omre     begsr
6.31  *
6.31 c                   select
6.31 c                   when      w_enhe = w_enh1
6.31 c                   eval      w_tilb = w_tilb
6.31 c                   when      w_enhe = w_enh2
6.31 c                   eval      w_tilb = w_tilb * 1 / w_omr2
6.31 c                   when      w_Enhe = w_enh3
6.31 c                   eval      w_tilb = w_tilb * 1 / w_omr3
6.31 c                   endsl
6.31 c                   endsr
6.35a * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.35a * Subrutine for å omregne tilbudspris ved enring av enhet.
6.35a * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 .35a *
6.35ac     tilb_omre2    begsr
6.35a *
6.35ac                   select
6.35ac                   when      s_enh2 = w_enh1
6.35ac                   if        c1enhe = w_enh2
6.35ac                   eval(h)   c1sapr = w_tilb * w_omr2
6.35ac                   eval(h)   c1kopr = c1kopr * w_omr2
6.35ac                   endif
6.35ac                   if        c1enhe = w_enh3
6.35ac                   eval(h)   c1sapr = w_tilb * w_omr3
6.35ac                   eval(h)   c1kopr = c1kopr * w_omr3
6.35ac                   endif
6.35ac                   when      s_enh2 = w_enh2
6.35ac                   if        c1enhe = w_enh1
6.35ac                   eval(h)   c1sapr = w_tilb / w_omr2
6.35ac                   eval(h)   c1kopr = c1kopr / w_omr2
6.35ac                   endif
6.35ac                   if        c1enhe = w_enh3
6.35ac                   eval(h)   c1sapr = w_tilb * (w_omr3/w_omr2)
6.35ac                   eval(h)   c1kopr = c1kopr * (w_omr3/w_omr2)
6.35ac                   endif
6.35ac                   when      s_enh2 = w_enh3
6.35ac                   if        c1enhe = w_enh1
6.35ac                   eval(h)   c1sapr = w_tilb / w_omr3
6.35ac                   eval(h)   c1kopr = c1kopr / w_omr3
6.35ac                   endif
6.35ac                   if        c1enhe = w_enh2
6.35ac                   eval(h)   c1sapr = w_tilb * (w_omr2/w_omr3)
6.35ac                   eval(h)   c1kopr = c1kopr * (w_omr2/w_omr3)
6.35ac                   endif
6.35ac                   endsl
      *
6.3A c                   eval(h)   w_tilb = c1sapr
      *
6.35ac                   endsr
6.36a *
6.36a * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.36a * Subrutine for å omregne pris ved overstyrt pris og bytte av enhet
6.36a * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.36a *
6.36ac     overst_omre   begsr
6.36a *
6.36ac                   select
6.36ac                   when      s_enh2 = w_enh1
6.36ac                   if        c1enhe = w_enh2
6.36ac                   eval(h)   c1sapr = c1sapr * w_omr2
6.36ac                   eval(h)   c1kopr = c1kopr * w_omr2
6.36ac                   endif
6.36ac                   if        c1enhe = w_enh3
6.36ac                   eval(h)   c1sapr = c1sapr * w_omr3
6.36ac                   eval(h)   c1kopr = c1kopr * w_omr3
6.36ac                   endif
6.36ac                   when      s_enh2 = w_enh2
6.36ac                   if        c1enhe = w_enh1
6.36ac                   eval(h)   c1sapr = c1sapr / w_omr2
6.36ac                   eval(h)   c1kopr = c1kopr / w_omr2
6.36ac                   endif
6.36ac                   if        c1enhe = w_enh3
6.36ac                   eval(h)   c1sapr = c1sapr * (w_omr3/w_omr2)
6.36ac                   eval(h)   c1kopr = c1kopr * (w_omr3/w_omr2)
6.36ac                   endif
6.36ac                   when      s_enh2 = w_enh3
6.36ac                   if        c1enhe = w_enh1
6.36ac                   eval(h)   c1sapr = c1sapr / w_omr3
6.36ac                   eval(h)   c1kopr = c1kopr / w_omr3
6.36ac                   endif
6.36ac                   if        c1enhe = w_enh2
6.36ac                   eval(h)   c1sapr = c1sapr * (w_omr2/w_omr3)
6.36ac                   eval(h)   c1kopr = c1kopr * (w_omr2/w_omr3)
6.36ac                   endif
6.36ac                   endsl
6.36ac
6.36ac                   eval      s_enh2 = s_enhe
6.36ac                   eval      s_anta = c1anta
6.36ac                   eval      s_sapr = c1sapr
6.36ac                   eval      s_rab1 = c1rab1
6.36ac                   eval      s_rab2 = c1rab2
6.36ac                   eval      b_forn = *on
6.36ac                   endsr
6.35a *
6.31  *
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.36  * Vis NOBB informasjon for varen. Samme prinsipp som preview av utskrifter
6.36  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.36  *
6.36 c     vis_nobb      begsr
6.36 c
6.36 c                   eval      p_nobb = %char(c1nobb)
6.36 c                   call      'AP633R'
6.36 c                   parm                    p_nobb
6.36  *
6.36 c                   endsr
7.00  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.00  *  Hent innkjøpspris                                              *
7.00  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.00  *
7.00 c     innpri        begsr
7.00  *
7.00 c                   call      'VP712R'
7.00 c                   parm                    w_firm
7.00 c                   parm                    fdvare
7.00 c                   parm                    w_ldor
7.00 c                   parm                    w_prgr
7.00 c                   parm                    w_lenh
7.00 c                   parm                    w_lety
7.00 c                   parm                    w_ddat
7.00 c                   parm                    b_inlr
7.00 c                   parm                    w_sapr2
7.00 c                   parm                    w_bupr2
7.00 c                   parm                    w_kopr2
7.00 c                   parm                    w_inpr
7.00 c                   parm                    w_inpr2
7.00 c                   parm                    w_hlev
7.00  *
7.00 c                   eval      fdinpr = w_inpr
7.00  *
7.00 c                   endsr
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  * Viser VA info
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  *
7.03 c     vis_VA        begsr
7.03  *
7.03 c                   call      'JV145R'
7.03 c                   parm                    w_firm
7.03 c                   parm                    fdvare
7.03 c                   parm                    w_prgr
7.03 c                   parm                    fdlety
7.03 c                   parm                    fobdat
7.03 c                   parm                    fdldor
7.03  *
7.03 c                   endsr
7.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.10  * Lager skyggetabell for senere oppdatering ved fakturering
7.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.10  *
7.10 c     lag_skygge    begsr
7.10  *
7.10 c                   eval      p_inlr = *blanks
7.10  * Hent inn std priser
7.10 c                   call      'VP700R'
7.10 c                   parm                    w_firm
7.10 c                   parm                    fdvare
7.10 c                   parm                    w_prgr
7.10 c                   parm                    fdenh1
7.10 c                   parm                    fdlety
7.10 c                   parm                    fobdat
7.10 c                   parm                    w_time
7.10 c                   parm                    p_inlr
7.10 c                   parm                    x_sapr
7.10 c                   parm                    x_bupr
7.10 c                   parm                    x_tipr
7.10 c                   parm                    x_kopr
7.10  *
7.10 c                   if        x_sapr <> 0
7.10 c                   eval      s_osap = x_sapr
7.10 c                   eval      s_otip = x_tipr
7.10 c                   eval      s_okop = x_kopr
7.10 c                   else
7.10 c                   eval      s_osap = fdsapr
7.10 c                   eval      s_otip = 0
7.10 c                   eval      s_okop = fdkopr
7.10 c                   endif
7.10  *
7.10 c                   if        x_tipr <> 0
7.10 c                   eval      s_oppk = 'T'
7.10 c                   else
7.10 c                   eval      s_oppk = ' '
7.10 c                   endif
7.10  * Hent inn innkjøpspris
7.10 c                   call      'VP703R'
7.10 c                   parm                    w_firm
7.10 c                   parm                    fdvare
7.10 c                   parm                    w_prgr
7.10 c                   parm                    fdenh1
7.10 c                   parm                    fdlety
7.10 c                   parm                    fobdat
7.10 c                   parm                    p_inlr
7.10 c                   parm                    x_sapr
7.10 c                   parm                    x_bupr
7.10 c                   parm                    x_kopr
7.10 c                   parm                    x_inpr
7.10  *
7.10 c                   if        x_inpr <> 0
7.10 c                   eval      s_oinp = x_inpr
7.10 c                   else
7.10 c                   eval      s_oinp = fdinpr
7.10 c                   endif
7.10  *
7.10 c     fodtlu_key    chain     fodmiu
7.10 c                   if        not %found(fodmiu)
7.10 c                   clear                   fodmiur
7.10 c                   eval      fdfirm = w_firm
7.10 c                   eval      fdnumm = w_numm
7.10 c                   eval      fdsuff = w_suff
7.10 c                   eval      fdline = w_line
7.10 c                   time                    fdodat
7.10 c                   time                    fdotim
7.10 c                   eval      fdousr = l_user
7.10 c                   exsr      finn_salgspr
7.10  * Beregn nettopris - kun hvis
7.10 c                   if        s_okpr <> 0
7.10  *
7.10 c                   if        s_okr1 <> 0
7.10 c                   eval      w_rabt = (s_okpr * s_okr1) / 100
7.10 c                   eval      s_okpr = s_okpr - w_rabt
7.10 c                   endif
7.10 c                   if        s_okr2 <> 0
7.10 c                   eval      w_rabt = (s_okpr * s_okr2) / 100
7.10 c                   eval      s_okpr = s_okpr - w_rabt
7.10 c                   endif
7.10  *
7.10 c                   endif
7.10 c                   eval      fdokpr = s_okpr
7.10 c                   eval      fdokr1 = s_okr1
7.10 c                   eval      fdokr2 = s_okr2
7.10 c                   eval      fdokpk = s_okpk
7.10 c                   endif
7.10  *
7.10 c                   eval      fdosap = s_osap
7.10 c                   eval      fdotip = s_otip
7.10 c                   eval      fdokop = s_okop
7.10 c                   eval      fdoinp = s_oinp
7.10 c                   eval      fdoppk = s_oppk
7.10 c                   time                    fdtmst
7.10 c                   time                    fdedat
7.10 c                   time                    fdetim
7.10 c                   eval      fdeusr = l_user
7.10  *
7.10 c                   if        not %found(fodmiu)
7.10 c                   write     fodmiur
7.10 c                   else
7.10 c                   update    fodmiur
7.10 c                   endif
7.10  *
7.10 c                   endsr
7.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.10  * Henter inn priser og rabatter
7.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.10  *
7.10 c     finn_salgspr  begsr
7.10  *
7.10  * Henter inn priser og rabatter
7.10  *
7.10 c                   eval      hienhe = fdenh1
7.10 c                   eval      hilety = fdlety
7.10 c                   eval      hidekn = fdpasl
7.10 c                   eval      hiavgf = fomkod
7.10 c                   eval      hipriv = 0
7.10 c                   eval      hiprgr = w_prgr
7.10  *
7.10 c                   exsr      hent_pris
7.10  *
7.10 c                   if        hosapr <> 0
7.10 c                   eval      s_okpr = hosapr
7.10 c                   eval      s_okr1 = horab1
7.10 c                   eval      s_okr2 = horab2
7.10 c                   eval      s_okpk = hokpri
7.10 c                   else
7.10 c                   eval      s_okpr = fdsapr
7.10 c                   eval      s_okr1 = fdrab1
7.10 c                   eval      s_okr2 = fdrab2
7.10 c                   eval      s_okpk = fdkpri
7.10 c                   endif
7.10  *
7.10 c                   endsr
7.10  *                                                                 - -
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  * Sjekker om inntastet beløp blir større enn tillatt avvik
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  *
7.fb c     sjekk_depsum  begsr
7.fb c                   if        faatjp = 0
7.fb c                   leavesr
7.fb c                   endif
7.fb  *
7.fb c                   eval      b_feil = *off
7.fb c                   eval      w_sumi = 0
7.fb c                   eval      w_sumu = 0
7.fb  * Beregn ordretotal
7.fb c                   eval      w_ntsu = c1sapr * c1ant1
7.fb c                   eval      w_ntsug = c1sapr * c1anta
7.fb c                   if        c1rab1 > 0
7.fb c                   eval(h)   w_ntsu = w_ntsu - (w_ntsu * c1rab1 / 100)
7.fb c                   eval(h)   w_ntsug = w_ntsug - (w_ntsug * c1rab1 / 100)
7.fb c                   endif
7.fb c                   if        c1rab2 > 0
7.fb c                   eval(h)   w_ntsu = w_ntsu - (w_ntsu * c1rab2 / 100)
7.fb c                   eval(h)   w_ntsug = w_ntsug - (w_ntsug * c1rab2 / 100)
7.fb c                   endif
7.fb c                   if        c1brr1 > 0
7.fb c                   eval(h)   w_ntsu = w_ntsu - (w_ntsu * c1brr1 / 100)
7.fb c                   eval(h)   w_ntsug = w_ntsug - (w_ntsug * c1brr1 / 100)
7.fb c                   endif
7.fb c                   if        c1brr2 > 0
7.fb c                   eval(h)   w_ntsu = w_ntsu - (w_ntsu * c1brr2 / 100)
7.fb c                   eval(h)   w_ntsug = w_ntsug - (w_ntsug * c1brr2 / 100)
7.fb c                   endif
7.fb  *
7.fb c                   if        (w_ntsu * w_mvat) > 9999999,99
7.fb c                   eval      w_ntsu = 0
7.fb c                   eval      w_ntsug= 0
7.fb c                   else
7.fb c                   eval      w_ntsu = w_ntsu * w_mvat
7.fb c                   eval      w_ntsug = w_ntsug * w_mvat
7.fb c                   endif
7.fb  *
7.fb c                   if        b_endr = *off
7.fb c                   eval      w_ntsug = 0
7.fb c                   endif
7.fb  *
7.fb c                   eval      w_sumi = 0
7.fb c                   eval      w_sumu = 0
7.fb c                   call      'FO704R '
7.fb c                   parm                    w_firm
7.fb c                   parm                    p_numm
7.fb c                   parm                    p_suff
7.fb c                   parm                    w_sumi
7.fb c                   parm                    w_sumu
7.fb c                   eval(h)   w_avik = w_sumi * faatjp/100
7 fb  *
7.fb c                   if        ((w_ntsu + w_sumi - w_ntsug) >
7.fb c                             (w_avik + skdepb)) or
7.fb c                             ((w_ntsu + w_sumi - w_ntsug) <
7.fb c                             (skdepb - w_avik))
7.fb c                   eval      w_mld1 = 'Sum er for høy i for+
7.fb c                                       hold til depositum.  +
7.fb c                                                '
7.fb c                   call      'AA005R'
7.fb c                   parm                    w_mld1
7.fb c                   eval      b_feil = *on
7.fb c                   endif
7.fb  *
7.fb c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_kode
     c                   parm                    p_firm
6.NU c                   parm                    p_numm
     c                   parm                    p_suff
     c                   parm                    p_line
     c                   parm                    p_ltyp
     c                   parm                    p_lety
     c                   parm                    p_vare
     c                   parm                    p_anta
     c                   parm                    p_enhe
     c                   parm                    p_kost
6.15 c                   parm                    p_eann
7.f1 c                   parm                    p_flag
7.f1 c                   parm                    p_erst
      *
      * Key for oppslag på status
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
5.70  *
5.70  * Key for oppslag på prisgruppe
5.70  *
5.70 c     ra30lr_key    klist
5.70 c                   kfld                    w_firm
5.70 c                   kfld                    ra30lr_dkod
      *
      * Key for oppslag på bruker
      *
     c     fusrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fusrl1_user
      *
      * Key for oppslag på vare
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for oppslag på leveringstype
      *
     c     vltpl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltpl1_lety
      *
      * Key for oppslag på linjetype
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for oppslag på enhet
      *
     c     venhl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    venhl1_eenh
6.12  *
6.12  * Key for oppslag på vare  enhet
6.12  *
6.12 c     vvepl1_key    klist
6.12 c                   kfld                    w_firm
6.12 c                   kfld                    vvepl1_pvar
6.12 c                   kfld                    vvepl1_penh
6.12 c                   kfld                    vvepl1_pldo
      *
      * Key for oppslag på spesialpris
      *
     c     fpril1_key    klist
     c                   kfld                    w_firm
5.70 c                   kfld                    fpril1_prgr
     c                   kfld                    fpril1_rkat
     c                   kfld                    fpril1_kkat
     c                   kfld                    fpril1_kund
     c                   kfld                    fpril1_kpro
     c                   kfld                    fpril1_vare
     c                   kfld                    fpril1_enhe
     c                   kfld                    fpril1_lety
      *
      * Key for oppslag på spesialpris notat
      *
     c     fprnl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fprnl1_nkun
     c                   kfld                    fprnl1_nkpr
     c                   kfld                    fprnl1_nvar
      *
      * Key for oppslag på ordre-hode
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
7.00  *
7.00  * Key for oppslag på ordre-hode SIDETABELL
7.00  *
7.00 c     foh2l1_key    klist
7.00 c                   kfld                    w_firm
7.00 c                   kfld                    w_numm
7.00 c                   kfld                    w_suff
7.04  *
7.04  * Key for posisjonering på ordretype / Gebyr påslag
7.04 c     fgebl1_key    klist
7.04 c                   kfld                    w_firm
7.04 c                   kfld                    fgebl1_otyp
7.04  *
7.04  *
7.04  * Key for chain på returkode
7.04 c     ra50l1_key    klist
7.04 c                   kfld                    w_firm
7.04 c                   kfld                    ra50l1_dkod
7.04  *
      *
      * Key for oppdatering av ordre-linje
      *
     c     fodtlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
     c                   kfld                    w_line
7.04  *
7.04  * Key for oppdatering av ordre-linje SIDETABELL
7.04  *
7.04 c     fod2lu_key    klist
7.04 c                   kfld                    w_firm
7.04 c                   kfld                    w_numm
7.04 c                   kfld                    w_suff
Z.04 c                   kfld                    w_line
7.04  *
      *
      * Key for oppslag på ordre-linje
      *
     c     fodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
     c                   kfld                    w_line
7.04  *
7.04  * Key for oppslag på ordrelinje SIDETABELL
Z.04  *
7.04 c     fod2l1_key    klist
7.04 c                   kfld                    w_firm
7.04 c                   kfld                    w_numm
7.04 c                   kfld                    w_suff
7.04 c                   kfld                    w_line
6.16  *
6.16  * Key for ordretyperegister
6.16  *
6.16 c     votyl1_key    klist
6.16 c                   kfld                    w_firm
6.16 c                   kfld                    votyl1_otyp
6.2c  *
6.2c  * Key for oppslag på lager
6.2c  *
6.2c c     vlagl1_key    klist
6.2c c                   kfld                    w_firm
6.2c c                   kfld                    vlagl1_vare
6.2c c                   kfld                    vlagl1_lage
6.2g  *
6.2g  * Key for file : best.forslag linjer
6.2g  *
6.2g c     lfdtl6_key    klist
6.2g c                   kfld                    w_firm
6.2g c                   kfld                    lfdtl6_ornr
6.30  *
6.30  * Key for les av moduler Nexstep
6.30  *
6.30 c     amodl1_key    klist
6.30 c                   kfld                    amodl1_modu
6.30  *
6.30  * Key for oppslag på vare oppsalg /mersalg
6.30  *
6.30 c     jvoml1_key    klist
6.30 c                   kfld                    jvoml1_onob
6.30 c                   kfld                    jvoml1_otyp
6.30  *
6.30  * Key for oppslag på vare i VA
6.30  *
6.30 c     jvarl1_key    klist
6.30 c                   kfld                    jvarl1_vare
6.30  *
6.30  * Key for oppslag på kategori ansvarlig
6.30  *
6.30 c     jkatl1_key    klist
6.30 c                   kfld                    jkatl1_kate
6.30  *
6.30  * Key for oppslag på VA leverandør
6.30  *
6.30 c     jlevl1_key    klist
6.30 c                   kfld                    jlevl1_ldor
6.37  *
6.37  * Key for oppslag på kunde
6.37  *
6.37 c     rkunl1_key    klist
6.27 c                   kfld                    w_firm
6.37 c                   kfld                    rkunl1_kund
      *
6.3f  *
6.3f  * Key for file : Firmastyrt validering
6.3f  *
6.3f c     avall1_key    klist
6.3f c                   kfld                    w_firm
6.3f c                   kfld                    avall1_apgm
7.10  *
7.10  * Key for oppslag på skygge tabell
7.10  *
7.10 c     fodmiu_key    klist
7.10 c                   kfld                    w_firm
7.10 c                   kfld                    fodmiu_numm
7.10 c                   kfld                    fodmiu_suff
7.10 c                   kfld                    fodmiu_line
7.fb  *
7.fb  * Key for oppslag på ofak-koderegister sideregister
7.fb  *
7.fb c     fst2l1_key    klist
7.fb c                   kfld                    w_firm
7.fb  *
7.fb  * Key for depositum
7.fb  *
7.fb c     sdepl1_key    klist
7.fb c                   kfld                    w_firm
7.fb c                   kfld                    sdepl1_numm
7.fb c                   kfld                    sdepl1_kund
7.fb c                   kfld                    sdepl1_tell
      *
      * Henter parametre
      *
     c                   eval      w_firm = p_firm
     c                   eval      w_numm = p_numm
     c                   eval      w_suff = p_suff
     c                   eval      w_line = p_line
7.00  *
7.00  * Test om nobb fraktkalkulator er av eller på
7.14  *  Endret nøkkel på styring
7.00  *
7.14   CallP CO402R(l_filg:w_firm:0:'AUTOMATISK_NOBB_FRAKTKALKULATOR':
7.00                    co402_verdi1:co402_verdi2);
7.00   if co402_verdi1 = '1';
7.00   chain foh2l1_key foh2l1r;
7.00   if %found and fo2nbf = 1;
7.00     u_nobf = *on;
7.00   endif;
7.00   endif;
7.04  *
7.04  * Test om returgrebyr er av eller på
7.04  *
7.04   CallP CO402R(l_filg:w_firm:0:'AKTIVER_RETURGEBYR':
7.04                    co402_verdi1:co402_verdi2);
7.04   if co402_verdi1 = '1';
7.04     u_rgeb = *on;
7.04     *in51 = *on;
7.04   endif;
7.06  *
7.06  * Test om returgrebyr sjekkboks er på
7.06  *
7.06   CallP CO402R(l_filg:w_firm:0:'RETURGEBYR_PAA':
7.06                    co402_verdi1:co402_verdi2);
7.06   if co402_verdi1 = '1';
7.06     u_rgpa = 1;
7.06   endif;
      *
      * Henter dagens dato
      *
     c                   time                    w_ddat
      *
      * Legger inn type for oppdatering av lager (R=Registrering)
      *
5.01 c                   eval      hltype = ' '
      *
      * Hent opplysninger fra ofak koderegister
      *
     c     fstsl1_key    chain     fstsl1r
7.fb c     fst2l1_key    chain     fst2l1r
      *
      * Henter opplysninger fra ofak bruker
      *
     c                   eval      fusrl1_user = l_user
     c     fusrl1_key    chain     fusrl1
      *
      * Sett indikator som styrer kostpris i henhold til parameter
      *
     c                   eval      *in86 = p_kost
      *
      * Hent opplysninger fra ordre-hode
      *
     c     fohel1_key    chain     fohel1r
      *
6.20 c                   eval      votyl1_otyp = footyp
6.20 c     votyl1_key    chain     votyl1r
      *
      * Henter mva-sats
      *
     c                   call      'FÅ705R'
     c                   parm                    p_firm
     c                   parm                    fobdat
     c                   parm                    w_mvap
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
      *
      * Initierer skjermbildet
      *
     c                   eval      c1vare = p_vare
6.15 c                   eval      w_eann = p_eann
6.30  *
6.30  * Sjekker om BM Modul
6.30  *
6.30 c                   eval      amodl1_modu = 'BM_MODUL'
6.20 c     amodl1_key    chain     amodl1
6.30 c                   if        %found(amodl1)
6.30 c                   eval      *in29  = *on
6.30 c                   endif
6.33  *
6.3f  * Firmastyrt validering av utvalgte felter
6.3f  *
6.3f  *
6.3f c                   eval      avall1_apgm = 'FD105R'
6.3f c     avall1_key    setll     avall1
6.3f c     avall1_key    reade     avall1
6.3f c                   dow       not %eof(avall1)
6.3f c                   if        avaflt = 'FDTEK1'  and
6.3f c                             avaval = 1
6.3f c                   eval      u_tek1 = *on
6.3f c                   endif
6.3f c     avall1_key    reade     avall1
6.3f c                   enddo
      *
6.33  * sjekker om kunde har kontant-kunde satt på
6.33  *
6.33 c                   eval      b_kont = *off
6.37 c                   eval      rkunl1_kund = fokund
6.37 c     rkunl1_key    chain     rkunl1                             90
6.37 c                   if        %found(rkunl1) and
6.37 c                             rkkoti = 1
6.37 c                   eval      b_kont = *on
6.37 c                   endif
8.04  * Slå også opp mot tilleggsregister for å sjekke mot returgebyr
8.04 c     rkunl1_key    chain     rku2l1
8.04 c                   if        not %found
8.04 c                   eval      rk2rgb = 0
8.04 c                   endif
8.04 c                   if        rk2rgb = 0
8.04 c**                 eval      *in51 = *off
8.04 c**                 eval      u_rgeb= *off
8.04 c                   eval      u_rgpa = 0
8.04 c                   endif
7.10  *
7.10 c                   eval      s_osap = 0
7.10 c                   eval      s_otip = 0
7.10 c                   eval      s_okop = 0
7.10 c                   eval      s_oinp = 0
7.10 c                   eval      s_oppk = *blanks
7.10 c                   eval      s_okpr = 0
7.10 c                   eval      s_okr1 = 0
7.10 c                   eval      s_okr2 = 0
7.10 c                   eval      s_okpk = *blanks
7.10 c                   time                    w_time
      *
7.fb  * sjekker om depositum
7.fb c                   eval      b_100p = *off
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
7.fb c     sdepl1_key    chain     sdepl1r
7.fb c                   if        %found(sdepl1)
7.fb  * sjekker om 100 % og betalt
7.fb c                   if        sk100p = 1     and
7.fb c                             skdepb <> 0
7.fb c                   eval      b_100p = *on
7.fb c                   endif
7.fb c                   endif
      *
     c                   endsr
