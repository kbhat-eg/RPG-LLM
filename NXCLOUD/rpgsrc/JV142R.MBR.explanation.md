# RPG Program JV142R – Onboarding Guide

This program, written in ILE RPG, is a large and complex maintenance program for handling product (“vare”) pricing and conditions for a Norwegian ERP solution. It facilitates the transfer to EVR (possibly an external system), calculation of product prices, maintenance of discounts/surcharges, and related functions. The code is mature and has evolved with many versions, so onboarding requires understanding of its program architecture, data model, and business rules.

Below is a structured walkthrough of the code and its main components.

---

## 1. **Header and History**

- **Header**:  
  - `h option(*nodebugio) datedit(*dmy)`  
    - Sets compile options: disables debug I/O, date edit is day/month/year.
  - Extensive documentation in Norwegian specifying system, program ID, purpose (e.g., "Transfer to EVR – calculation of product"), and history of functional/technical changes with version numbers.

---

## 2. **File Declarations**

- **Physical and Logical Files**:  
  - Multiple “f”-specs for files like `jvarl1`, `jvdtl1`, `jlevl1`, etc.
  - Files are renamed (`rename(x:y)`) for use with the program’s record formats.
  - Some files are for input and update (`uf a e k disk` for random access, keyed).

- **Workstation File**:  
  - `fjv142d    cf   e             workstn`  
    - For interactive screen I/O.

---

## 3. **Global Variables and Data Structures**

- **Parameter Definitions**:  
  - The `d` specs define parameters received by the program, e.g.:
    - `p_firm`, `p_vare` – like `jvdfir` (company number), `jvvare` (product number).
    - Additional flags for product type, delivery type, etc.
    - Extended with history (versioning comments).

- **LDA (Local Data Area)**:  
  - Used to retrieve user and company context (`l_user`, `l_fnav`).

- **Variables for Key Fields**:  
  - Used for file access keys.

- **General Working Variables**:  
  - E.g., for prices, factors, dates, codes, descriptions, etc.
  - Many used for intermediate calculations and screen presentation.

---

## 4. **Main Program Logic**

### 4.1. **Initialization**

- Receives input parameters via PLIST (entry parameter list).
- Sets up key fields, retrieves current date and time, and set MVA (VAT) factor to 1.25 (Norwegian standard VAT).

### 4.2. **Main Loop (`b1tag` and `b1tagb` labels)**

- **Fetch Product and Details**:
  - Chain to product master file. If not found, exit.
  - Optionally, call subroutine to find logistics product info.

- **Fetch Price Information**:
  - Calls external programs (e.g., `VP713R`, `JV750R`) to obtain additional data and pricing.

- **Store Existing Field Values**:
  - Save current values for later comparison (to detect changes).

- **Screen Interaction**:
  - Present the main screen (record b1bld).
  - Handle function keys (standard for IBM i). For example:  
    - F3/F12: exit.
    - F5: inquiry popups (b1win, b2win, b3win).
    - F13: status codes.
    - F15/F17 etc.: popups for package info, maintenance, viewing NOBB info (Norwegian product database).
    - F21/F22: save temporary/permanent changes.

- **Change Handling and Calculation**:
  - If key fields change, re-fetch/re-calculate.
  - Use flags to manage state and errors.
  - Subroutines for:
    - Price calculation (`kalk_kopr`, `kalk_saim`, `kalk_sapr`)
    - Validation (`sjekk_input`, `sjekk_pris`)
    - Maintenance and update of related files (`oppd_detaljer`, `oppd_beti`, `oppd_element`, `oppd_fakt`).

---

## 5. **Subroutines**

### 5.1. **Price Calculation**

- **`kalk_kopr`**:  
  Calculates up to cost price, considering if price/factor fields have changed.
- **`kalk_saim`**:  
  Calculates sales price including VAT, and updates related fields.
- **`kalk_sapr`**:  
  Reverse: calculates sales price excluding VAT if the inclusive value was manually changed.

### 5.2. **Validation**

- **`sjekk_input`**:  
  Validates user input and value combinations for logical consistency (e.g., factors/prices consistent, valid units present).
- **`sjekk_pris`**:  
  Validates overall price logic (e.g., cost not higher than purchase, sales price present for all units, etc.).

### 5.3. **Database Updates**

- **`xb1win/xb2win/xb3win`**:  
  Manage popups for temporary price registration, permanent condition updates, and cost/purchase price display.
- **`oppd_detaljer`**:  
  Write changes to the product detail file.
- **`oppd_beti`/`oppd_element`**:  
  Update or create product conditions and their associated rebate elements.
- **`oppd_fakt`**:  
  Update or create surcharge factors at product level.

### 5.4. **Specialized Routines**

- **`spørring`**:  
  Handles user pop-up inquiries about delivery types and price groups.
- **`finn_logivar`**:  
  For logistics-linked products, finds correct related product/pricing info via embedded SQL.

---

## 6. **SQL Usage**

- Embedded SQL is used in some subroutines to fetch advanced logistics info (`finn_logivar`), which allows complex joins and selection not possible with normal RPG file I/O.

---

## 7. **Keys and Access Patterns**

- Extensive use of `klist/kfld` for key lists, ensuring keyed I/O is consistently constructed for file access.

---

## 8. **Screen and User Interaction**

- Workstation file drives the user interface. The program uses the classic interactive RPG cycle:
  - EXFMT to display/receive screens.
  - Conditionals to respond to user function keys and field changes.
  - Re-entrant loop structure for data entry/correction.

---

## 9. **Error Handling**

- Subroutine `*pssr` is a standard RPG error routine, sets an indicator and returns to the display.

---

## 10. **Business Logic and Model**

- **Product Pricing**:  
  Supports multi-level pricing (cost, purchase, sales per unit), with factors/surcharges, VAT, rounding, and validation.
- **Conditions (Betingelser)**:  
  Maintains product conditions and links them to rebates and surcharges, both temporary and permanent.
- **Logistics/Variants**:  
  Can reference and pull info from associated logistical products (multi-variant).
- **History/Change Tracking**:  
  Many fields/time/user stamps for audit trail.

---

## **Summary for New Developers**

- **Function**: This is a multifaceted maintenance program for product pricing and conditions, with integration to external price info, product logistics, and rebate elements.
- **Approach**: Data is fetched and validated, then presented interactively to the user for maintenance; changes are validated and written back as required.
- **Key Concepts**:
  - Understanding the database model (files and relationships).
  - Familiarity with Norwegian ERP/product/pricing terminology.
  - Experience with interactive RPG programming (cycle, EXFMT, function keys).
  - Awareness of VAT handling and price calculations.
- **Navigation**: The code is structured in large blocks for mainline logic and subroutines. Pay attention to labeled sections (e.g., `b1tag`, subroutine headers) for orientation.

---

## **Tips for Onboarding**

- **Start Small**: Trace the mainline logic from initialization through a single update scenario.
- **Understand the Files**: Review DDS (data descriptions) for all referenced files to grasp their structure.
- **Test Interactively**: If you have access, run the program to see the workstation I/O in practice.
- **Leverage Comments**: The historical comments are helpful for context on why things may seem more complex than necessary—they reflect real-world business changes.

---

If you have more specific questions about any section, subroutine, or data flow, feel free to ask!