# Documentation for Program BU729R: Export of Deleted Items

## Overview

**Program:** BU729R  
**System:** ASSHOP  
**Description:**  
This program is responsible for exporting records of deleted items ("slettede varer") for a specific store ("butikk"). It reads from the deleted items file and writes relevant records to an export file, applying business rules around deletion date and time. This is typically used as part of a data synchronization or archival process.

## File Definitions

### Input File

- **vvasl1** (renamed as `vvasl1r`)
  - Keyed, externally described file.
  - Represents deleted items (likely a "deleted items log" or similar).
  - Key field(s) are defined in the subroutine for use in keyed access.

### Output File

- **bovsst** (renamed as `bovsstr`)
  - User open, externally described file.
  - Used to write exported deleted item records.
  - The structure is cleared at program start to ensure a clean export.

## Parameters

- `p_firm`: Store/Company identifier (same type as `vvfirm`).
- `p_dato`: Date parameter (ISO format).
- `p_time`: Time parameter (ISO format).

These parameters are passed on program invocation and control which records are exported.

## Variables

- `w_firm`: Local variable holding the firm/store identifier, initialized from the parameter.

## Main Processing Logic

### Initialization

- The output record format (`bovsstr`) is cleared at the start.
- The local firm variable is set from the input parameter.

### Record Selection and Export

1. **Positioning and Reading Deleted Items**
   - The program positions (`setll`) and reads (`reade`) the deleted items file (`vvasl1`) using the key defined as the firm/store.
   - It processes all records for the specified firm.

2. **Filtering Logic**
   - For each record, the following conditions are checked:
     - The deletion date (`vvsdat`) must not be the lowest possible value (`*loval`).
     - The record is selected if:
       - No date parameter is provided (`p_dato = *loval`), **or**
       - The record's deletion date is after the parameter date, **or**
       - The record's deletion date equals the parameter date and the deletion time is later than or equal to the parameter time.
   - This logic ensures only records deleted after the specified date and time are exported (or all if no date/time is specified).

3. **Exporting**
   - For each qualifying record:
     - Key fields (`vare`, `sdat`, `stim`, `susr`) are set from the deleted item record.
     - The record is written to the export file (`bovsstr`).

### Program Termination

- The program sets on LR (`*inlr = *on`) and returns, ensuring proper cleanup.

## Subroutine: *inzsr (Initialization)

- Handles parameter entry and local variable initialization.
- Defines the key list for accessing the deleted items file by firm.
- Ensures the program is ready to process only the relevant firm's data.

## Business/Domain-Specific Logic

- **Deleted Items Export:** The program is tightly focused on exporting only those items that have been deleted, as tracked in `vvasl1`.
- **Firm/Store Segregation:** All processing is scoped to a single firm/store, as defined by the parameter and enforced by keyed access.
- **Incremental Export:** The date and time filtering allows for incremental exports (e.g., for nightly jobs or catch-up processing).
- **Data Integrity:** By clearing the export record format at the start and using explicit write logic, the program avoids accidental data leakage or duplication.

## Design Conventions and Patterns

- **Consistent Naming:** File and field names follow a clear, domain-driven convention (e.g., `vvasl1` for deleted items, `bovsst` for export).
- **Parameter Passing:** Uses standard *entry plist for parameter handling.
- **Keyed File Access:** Employs `setll`/`reade` pattern for efficient, keyed processing.
- **Conditional Logic:** Business rules for export are encapsulated in a single, readable conditional block.

## Interactions with Other Modules

- **Upstream:** Expects that the deleted items file (`vvasl1`) is maintained elsewhere in the system, likely by item maintenance or deletion routines.
- **Downstream:** The export file (`bovsst`) is presumably consumed by another system or process for further processing, archival, or reporting.

## Non-Obvious Points

- **Date/Time Filtering:** The use of `*loval` for both date and time allows the program to handle both full and incremental exports without changing code.
- **Record Clearing:** Explicit `clear bovsstr` at the start ensures that stale data is not inadvertently exported.
- **No Debug I/O:** The `*nodebugio` H-spec option is set, which may be a performance or security consideration.

## Summary

BU729R is a focused batch export program for deleted items, designed for robustness and incremental processing. Its design leverages keyed file access, parameter-driven filtering, and clear separation of firm/store data, aligning with best practices for batch exports in retail or inventory-driven domains.