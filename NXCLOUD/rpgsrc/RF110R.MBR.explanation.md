# RPG Program RF110R: Update of Ledger and Subledger

## Overview

This RPG program (`RF110R`) is designed for processing and updating records in accounting ledgers and subledgers (customers, vendors, projects) on IBM i (AS/400). The program reads journal postings and updates related balances in summary tables and subledgers, manages period breaks, and provides detailed logging and error handling. The logic has evolved over time as indicated by revision comments.

The main flow handles different posting types ("H" - Main Ledger, "K" - Customer, "L" - Vendor), updates corresponding summary/transaction tables, and maintains key counters like last-used journal numbers.

---

## Structure Summary

- **Header**: Program metadata, changelog, and documentation (primarily in Norwegian).
- **File Declarations**: Input/output file definitions for journals, customers, vendors, ledgers, etc.
- **Data Definitions**: Standalone fields, data structures, constants, and variables used throughout the program.
- **Mainline Logic**: Initialization, main loop, dispatch on record type, updating records, and finalization.
- **Subroutines**: Specialized logic for updating different parts of the system:
    - Main Ledger (`opd_hovb`, `opd_hovb_bel`, `opd_hovb_mng`)
    - Customer Ledger/Transactions (`opd_kund`, `opd_kund_tra`)
    - Vendor Ledger/Transactions (`opd_levr`, `opd_levr_tra`)
    - Projects (various routines, much commented out)
    - Handling period/year breaks (`brd_raar`)
    - Logging and error handling
    - Special handling for deposits (`depositum`)
    - Initialization (`*inzsr`)

---

## Detailed Walkthrough

### File Declarations

- Files representing journals, customers, vendors, ledgers, projects.
- Some files are input (`I`), update (`U`), or output (`O`) and are often renamed for logical clarity.
- Example: `frkunlr` (input) and `frkunlu` (update) for customer master.

### Data Definitions

- Extensive use of working variables, key fields, timestamp and logging fields, and temporary amounts for calculations.
- Arrays for monthly balances (e.g., `sal` for 14 periods).
- String constants, e.g., `c_numm` for numeric checks.
- Variables to store user and client information.

### Logging Support

- Parameters and prototypes declared for external logging programs (`CO402R`, `AB700R`, `AB705R`).
- Conditional logic based on logging flag `u_logg`.

### Mainline Processing

**Initialization (`*inzsr`):**
- Sets up working variables, retrieves current date/time, determines if running from client, and builds key-lists for file access.

**Logging Start:**
- If logging is enabled, records starting information by calling external logging routines.

**Journal Loop:**
- Reads the journal file (`rjoupf`) in a loop.
- On member break, or error, or at end-of-file, does cleanup, possibly writes log, and exits.
- On company change, updates company context.
- On year change, manages the last-used journal number via subroutine `brd_raar`.

**Record Dispatch:**
- For each read journal record, dispatches based on the type (`rjreid`):
    - 'H': Main ledger update (`opd_hovb`)
    - 'K': Customer ledger update (`opd_kund`)
    - 'L': Vendor ledger update (`opd_levr`)
- If main ledger and project specified, additional project update (`opd_pro`).

**Balance Adjustments:**
- After updates, marks the journal record as updated, sets timestamps, writes back.

**Loop Continuation:**
- Returns to the start of the loop to process the next journal record.

### Subroutines

#### Main Ledger (`opd_hovb`, `opd_hovb_bel`, `opd_hovb_mng`)
- Updates the main ledger's balance matrix for the posting.
- Handles both amounts and, if applicable, quantity updates as a separate type.
- Maintains monthly and annual figures, splits based on special posting codes.
- Updates or writes summary rows as needed, using timestamps and user info.

#### Customer Ledger (`opd_kund`, `opd_kund_tra`)
- Ensures department information is present (fetches from master if missing).
- Updates customer transaction tables with amounts, status, and timestamp.
- Updates summary balances (open, this/last year purchases, etc.).
- Writes updated summary/customer records.

#### Vendor Ledger (`opd_levr`, `opd_levr_tra`)
- Mirror logic to customer ledger, adapted for vendors.
- Updates both transactional and summary balances, writes results.

#### Project Handling (`opd_pro` and others)
- **Note**: Much of the project update logic is commented out, indicating it may be deprecated or awaiting future re-activation.
- The design suggests similar summary/transactional update logic for projects, including both amounts and quantities.

#### Year Break Handling (`brd_raar`)
- Manages last-used journal number tracking across years.
- Looks up or creates a tracking record for the year, updating or initializing as appropriate.
- Ensures the journal numbers are sequential for each year.

#### Special Deposit Handling (`depositum`)
- Called for certain customer deposit postings (based on key fields).
- Calls an external program to process deposit logic.

#### Error Handling (`*pssr`)
- If an error occurs and running under a client, logs a fatal error and ends program.

#### Logging (`u_logg`)
- Start, end, and error points log to an audit trail if activated by configuration.

---

## Key Mechanisms

- **Keylists**: Used for keyed file access, combining company, account, and other fields.
- **Timestamping & User Tracking**: Each update writes the user and current timestamp for audit trail.
- **Flexible File Processing**: Uses `chain` (keyed read), `update`, and `write` methods for record management.
- **Member-sensitive Processing**: Loop is member based; tracks member switching for multi-member physical files.
- **Conditional Flow**: Handles company/year/period breaks gracefully.
- **Extensible**: Provisions for handling future sub-systems (project, status, etc.).

---

## Additional Notes

- **Language**: Many comments and variable names are in Norwegian (e.g., "Oppdatering av regnskap/reskontro" = "Update of ledger/subledger").
- **Historical Evolution**: Lines with version tags (e.g., `6.31`, `E5.30`, etc.) show where logic was added/changed, often tied to bug-fixes or enhancements.
- **Performance**: Updates summary records in-place, minimizing row-level locks and unnecessary file I/O.
- **External Interfaces**: Calls logging and deposit management programs externally.

---

## Onboarding Advice

- **Understand IBM i File Concepts**: Know difference between physical/logical files, members, keyed I/O.
- **Trace Process Flow**: The heart is a loop over journal postings, dispatched by type, updating necessary balances. For each posting:
    - The correct update subroutine is called
    - Balances are updated in summary and transaction tables accordingly
- **Balance Arrays**: The use of 14-element arrays (`sal`) for period balances is central to understanding the main ledger updates.
- **Key Construction**: Review how keys are constructed for file access via keylists.
- **Error and Logging**: Know how to enable/disable logging and how errors are processed.
- **Customization Points**: Some project logic is potentially re-usable if that sub-system is to be re-enabled.

---

## Common Tasks for New Developers

- **Add new summary fields**: Mirror logic as shown for amounts/quantities.
- **Fix year/period handling**: See `brd_raar` subroutine for year break logic.
- **Enable/Disable logging**: Via configuration and variables at start of program.
- **Enhance error handling**: Expand in-line or centralized PSSR routine.
- **Re-activate or adjust project logic**: Un-comment and test project-related routines as needed per business requirements.

---

## Conclusion

This program is a central accounting batch process for updating all key ledgers (main, customer, vendor, project) based on journal postings. It is robust, auditable, and extensible for future enhancements. Onboarding requires a solid understanding of RPGâ€™s file and subroutine model, as well as knowledge of the business rules reflected in the file layouts and update logic.