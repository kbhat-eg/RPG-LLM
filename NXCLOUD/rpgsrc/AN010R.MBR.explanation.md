# Program AN010R Documentation

## Overview

**Program AN010R** is part of the ASPGPL system and is responsible for the maintenance and entry of parameters for night batch routines ("nattrutine"). The application provides an interactive interface for selecting, viewing, and updating parameters that control automated nightly jobs, including backup routines, extra job execution, and subsystem management.

This program interacts with several physical files, display files, and external programs, and follows established conventions for user interaction, error handling, and data persistence.

---

## Key Components and Data Flows

### Files

- **AVERL1**: Main parameter file (input, keyed), renamed as `averl1r`.
- **AVERLU**: Update file for parameters (update, keyed), renamed as `averlur`.
- **AN010D**: Workstation display file (user interface).

### Data Structures

- **d_valg**: A 128-character data structure with overlays for all parameter fields. Used to gather and pass parameters to external programs (notably for printing via `AN012C`).
- **averl1_vkey**: Key variable for accessing parameter records.

### Main Workflow

1. **Job Selection (a1tag)**
    - The user selects which night job to maintain (ASNAT1, ASNAT2, ASNAT3).
    - The corresponding key is loaded for subsequent record access.

2. **Parameter Maintenance (b1tag)**
    - If a record exists, previous values are loaded for editing.
    - The user is presented with a parameter entry screen.
    - Special function keys (F4, F10, etc.) allow for additional actions (e.g., lookups, editing extra jobs, or subsystems).
    - Various business rules are enforced (e.g., consistency between backup codes and savefile usage, validation of extra job codes).

3. **Extra Job Editing (c1tag)**
    - Allows the user to define extra jobs to be executed during the night batch.
    - Ensures consistency between job codes and job definitions.

4. **Subsystem Maintenance (e1tag)**
    - Provides editing for subsystems to be started as part of the night batch.
    - As of version 6.20, uses a dedicated subsystem table, maintained via external program `AA073R`.

5. **Parameter Confirmation and Program Generation (f1tag, xopdat)**
    - Final confirmation screen. If the user chooses to generate the program (`b1genp = 1`), parameters are packed into `d_valg` and sent to the external CL program `AN012C` for report generation.
    - Updated parameters are written back to the database.

6. **Exit (xslutt)**
    - Program cleanup and return.

---

## Business Logic and Rules

- **Backup and Savefile Validation**: Enforces logical consistency between backup type (`b1back`) and savefile usage (`b1savf`). For example, certain combinations are invalid and prompt the user for correction.
- **Extra Job Consistency**: Ensures that if the extra job code is set, at least one job is defined, and vice versa.
- **Subsystems**: Subsystem definitions are now managed via a separate table and maintained through a dedicated program, reflecting a modular approach to subsystem configuration.

---

## User Interaction Patterns

- **Screen Navigation**: Uses tags (e.g., `a1tag`, `b1tag`, etc.) for screen flow control, with `exfmt` for display file interaction.
- **Function Keys**: Special keys (`*inkc`, `*inkd`, `*inkf`, `*inkl`) are used for actions like exit, lookup, subsystem edit, and cancel.
- **Error Handling**: Sets indicator fields (`*in31`, `*in32`, etc.) to flag input errors or inconsistent states, returning the user to the relevant input screen.

---

## External Program Calls

- **AA020C**: Invoked for extra job definitions from other program libraries.
- **AA073R**: Manages the subsystem table (introduced in version 6.20).
- **AN012C**: Handles printing or further processing of the packed parameter set.

---

## Noteworthy Conventions and Design Decisions

- **Overlayed Data Structure (`d_valg`)**: Instead of passing many discrete parameters, all values are packed into a single structure with overlays, simplifying parameter passing to external programs.
- **Modular Editing**: Each major aspect (main parameters, extra jobs, subsystems) has its own edit screen and logic, making the UI extensible and maintainable.
- **Record Handling**: Uses `chain` to retrieve and `update`/`write` to persist data. If a record does not exist, it is created.
- **Versioned Enhancements**: Comments indicate clear versioning and rationale for changes, e.g., subsystem table refactoring in version 6.20.

---

## Key Variables and Their Roles

- **b1ttmm**: Time parameter for the batch job.
- **b1rorg, b1back, b1ssbs, b1prc1, b1prc2, b1strt, b1slut, b1genp, b1savf, b1smap**: Various flags and codes controlling job options.
- **b1dens**: Density parameter (likely for tape backup).
- **c1pro1, c1bib1, c1sys1, c1pro2, c1bib2, c1sys2**: Extra job definitions (procedure, library, subsystem).
- **e1sbs1...e1sbs0, e1lib1...e1lib0**: Subsystem and library definitions for the batch job.

---

## Integration Points

- **Parameter Files (`AVERL1`, `AVERLU`)**: Central storage for all night batch parameters.
- **Subsystem Table**: Managed externally by `AA073R`.
- **Printing/Reporting**: Via `AN012C` using the packed parameter structure.

---

## Summary

**AN010R** is the central maintenance utility for night batch routines, providing comprehensive parameter editing, validation, subsystem management, and integration with reporting and job control. The program is modular, extensible, and maintains clear separation between user interaction, business logic, and data persistence. It is tightly integrated with other system components and emphasizes consistency and user guidance through strong validation and error feedback mechanisms.