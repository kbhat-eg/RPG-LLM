# RPG Program Explanation: FO798R – "Send Print as E-mail"

This RPG program is used to prepare and send output (print) as an e-mail, allowing the user to fill in/override addresses and text, lookup email addresses from various sources, and interface with other programs for recipient lookup.

## High-level Overview

- Retrieves e-mail addresses for customers, suppliers, projects, and contact persons.
- Lets users enter additional message lines and select recipient/copy.
- Looks up the sender’s e-mail (based on salesperson).
- Allows interactive screen entry and validation.
- Supports special business rules, roles, and external queries for addresses and contacts.
- Program is designed for expansions: projects, copies, different sources of e-mails, subject line handling, etc.
- Provides a full-screen interface.
- Maintains compatibility with legacy and customized flows.

---

## Main Sections

### 1. File Definitions

Files are defined for customers, suppliers, projects, orders, employees, and contact persons. Some files have record format renames for easier access.

### 2. Variable and Parameter Definitions

- Parameters for program entry (`*entry plist`) and work variables.
- Many are defined `LIKE(somefield)` for easy mapping to DB fields.
- E-mail fields, project fields, contact person number, subject and message line fields, etc.
- Support variables for tracking key values for file lookups.

### 3. Main Logic Flow

#### Initialization

- Clears working fields (`eval b1kund = *zero`, etc.).
- If the code indicates a customer ('K'), looks up customer and fills in name and main e-mail.
- If a customer project is supplied, looks up project and gets project-level e-mail, if any.
- For contact persons, looks up contact in order header/contact files and sets additional e-mail slots.
- If supplier ('L'), similar logic for supplier and their contacts.
- Looks up sender’s e-mail (based on salesperson code); if a mobile number is present, includes it in the signature line.
- Looks up business routine code to find default subject lines and info.

#### Parameter Overriding

- If 'K' (customer), 'L' (supplier), or blank (' '), logic determines where to take e-mails from, giving preference to most specific sources.
- If parameters (via call) supplied e-mail addresses/text lines, these override lookups.

#### Routine Register Lookup

- Looks up sender/recipient e-mail addresses (if present) in a routine register as an additional fallback.

#### Main Screen Loop

- Presents the data screen to the user to allow edits.
- Handles F3 (Exit), F4 (Inquiry — opens a contact person lookup program).
- Validates input (requires at least one recipient e-mail).
- If valid, moves values back to program parameters and exits.

---

### 4. Subroutine Details

#### Inquiry (`spørring`)

- If user presses F4 in the e-mail field, calls external programs (`RK503R` or `RL503R`) to let the user choose a contact person.
- Returns selected e-mail and name.

#### Input Validation (`sjekk_input`)

- Ensures at least one recipient e-mail is present.
- Flags error otherwise.

#### Move to Parameter (`flytt_par`)

- Moves screen field values into parameter variables for the calling program to consume.

#### Initialization (`*inzsr`)

- Sets up input parameters (`*entry`).
- Defines key lists for DB lookups.
- Sets firm number and moves order number into alpha field for subject construction.

---

## Key Business Logic

- **Source Priority for E-mail**: Tries project, then customer; for suppliers, by supplier and then by contact person.
- **Multiple Recipients**: Supports up to three e-mail fields and copy (CC).
- **Subject Construction**: Builds subject including order, suffix, customer/project names — can be overridden by input.
- **Sending User**: Grabs sender's e-mail based on salesperson, includes mobile/contact info in signature.

---

## Notable Enhancement History (from comments)

- Added support for multiple message lines, more flexible recipient lookup (project, contact, supplier).
- Overriding logic for parameters vs. DB values.
- Customizations for special customer requirements (roles, full-screen, wide screens, subject lines, mobile numbers).
- Routine register integration for default e-mails (sender/recipient fallback).

---

## Summary Table: Key Data Sources

| Code (`p_kule`) | Lookup Priority                    | E-mail fields set           |
|-----------------|-----------------------------------|-----------------------------|
| 'K' (Customer)  | 1. Project > 2. Customer card     | b1emal, b1ema2, b1ema3      |
| 'L' (Supplier)  | 1. Supplier > 2. Contact person   | b1emal/b1ema3               |
| ' ' (Blank)     | Takes all e-mails from parameters | b1emal, b1ema2, etc.        |

---

## Interaction with User

- Screen (`b1bld`) is displayed for user review/edit.
- Supports exit, inquiry (contact person search), and input validation.
- Moves final data to parameters for caller to use for the actual e-mail transmission.

---

## Error Handling

- Will not proceed without at least one e-mail recipient.
- Error indicators set to highlight missing data.

---

## Programmers Onboarding Advice

- Review the many file definitions and the relationship between customers, projects, contacts, suppliers.
- Pay close attention to the enhancement history in comments for business context and why certain lookups/overrides exist.
- Note the separation between display fields (b1...) and parameter fields (p_...).
- For custom flows involving specific customers/suppliers, check the latest versioning section for overrides or custom routines.
- The *inzsr section is the starting point for initialization and parameter handoff.
- Understand the use of key lists (klist) for chaining to files.
- Cross-reference with external programs called for contact lookup for integration points.

---

Let me know if you want a deeper dive into any specific section, a visual data flow, or record layouts!