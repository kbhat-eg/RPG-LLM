# Overview

This RPG III (possibly RPG IV with fixed-form syntax) program is called **FO188R**, and its purpose is to print a report based on outgoing invoice files ("Utskrift av rapport utg. fakturafiler" in Norwegian). This is typically part of a business process for reporting or archiving invoice data.

The program reads records from several files, processes them, updates history as needed, and prints a formatted journal/report to a printer.

---

## Structure

### Header Section

- **h-specs** set decimal and date formats:
    - `decedit('0,')`: Decimal editing: use ',' as thousands separator.
    - `datedit(*dmy)`: Date editing: day-month-year format.
- **/TITLE** gives a title for the program listing.
- Block comments describe:
    - Program name, version, and change log.
    - Descriptions in Norwegian.

---

### File Declarations (`f-specs`)

The program works with these files:

- `sohel1`, `sohelu`: Main invoice header files.
- `rkunl1`           : Customer master file.
- `aforl1`           : Formula/template file.
- `fntrl1`           : Transaction/number register.
- `fo684p`           : Printer output.

`rename` is used to map external file formats to internal names.

---

### Data Structure Definitions (`d-specs`)

- **dsparm**: 32-byte input parameter structure.
    - Contains year, type, from/to number, and program name, broken out as overlays.
- **UDS (User Data Space)**: Holds job/user context, extracted from the LDA (Local Data Area).
- **Variables**: Various working variables to hold key values, company, number, customer, time, etc.
- **Key fields**: For use with file accesses (`CHAIN`, etc.).

---

### Logic Sections (`c-specs`)

#### Initialization (`*inzsr`)

- Sets up variables, key definitions, and retrieves the input parameter.
- Sets user/screen info for report heading.
- Extracts keys for further file processing.

#### Parameter Processing (`*entry`)

- Accepts the input parameter in `wpparm` and overlays it onto the `dsparm` structure.
- Sets up key information for report context (year, type, from/to numbers).
- Loads user and workstation data for the printout.

#### Main Control Routine

- Checks if this is the first cycle; if so, runs the startup routine (`xstrsr`).
- Primary loop reads invoice headers from `sohel1` until EOF (`*in61 = *off`)
    - Checks if the record is for a new company or year (`sofirm` or `soaarr` changed).
    - Prepares key variables for the number file (`fntrl1`), attempts to chain; skips if not found.
    - Applies filters based on selection criteria (from/to number, invoice status).
    - Runs processing routines:
        - `xajour`: Prepares invoice data, fetches customer info, updates history if needed.
        - `xprint`: Writes the line to the report printer.

#### Subroutines

1. **hntnum**
    - Calls an external program (`AS100R`) to retrieve the next available number from the number register.

2. **xajour**
    - Prepares data for print: formats dates, fetches customer name, sets up print variables.
    - Sums up invoice amounts.
    - If a new invoice, and no specific number selection, updates the historic invoice register (`sohelu`) with journaled status, user/time.

3. **xprint**
    - Writes one invoice detail line to the printer.
    - If the printer line overflow indicator (`*in30`) is on, calls the overflow subroutine (`xovrfl`).

4. **xovrfl**
    - Writes report heading for page overflow.

5. **xstrsr**
    - Startup routine: sets cycle, key values, gets next available number if needed, positions invoice header file, writes report heading.

---

### Key Lists (`klist`)

Defines composite keys for file accesses:
- Company/year/number/suffix for invoices.
- Company/customer for customer file.
- Routine for formula file.
- Number/suffix for transaction file.

---

## Step-by-Step Flow

1. **Program Entry**
    - Receives a 32-byte parameter (possibly year, type, from/to numbers, etc.)
    - Loads context (user, workstation, date).
2. **Initialization**
    - Prepares keys, gets context/formula data.
3. **Startup (`xstrsr`)**
    - Sets up for processing a new report (company/year).
    - Gets initial numbering if needed.
    - Positions to the correct place in the invoice file.
    - Writes report heading.
4. **Main Loop**
    - Processes each invoice header:
        - Filters by company/year, number range, journal status.
        - For qualifying records:
            - Prepares report data and updates print variables.
            - Optionally updates the historical invoice register.
            - Writes detail line to report.
    - On new company/year or end of data, writes total and terminates.
5. **Termination**
    - Sets LR (`*inlr` = *on) to end the program.

---

## Important Details

- **Selection logic**:
    - Only includes invoices within certain number ranges and journal status, based on input parameters.
- **History update**:
    - If processing for the full file (not a number range), marks invoices as journaled.
- **External program call**:
    - Gets next available number from a central register.
- **Report Structure**:
    - Detail lines (`A1DET`), headings (`A1HDR`), and totals (`T1TOT`) are written to the printer file.
- **Page Overflow**:
    - When printer buffer overflows, a new heading is written.

---

## Recommended Reading

- If new to RPG, learn about **fixed-form RPG** syntax, how subroutines and key lists work.
- Understand **file terms**: "chain" (random access), "read" (sequential), "update" (write back).
- Understand business data: invoices, customers, registers.

---

## Comments in the Code

- The code is extensively commented in Norwegian.
- Key routines and logic changes are described in block comments.

---

## Summary

**FO188R** is a batch reporting RPG program that:
- Reads and filters invoice headers.
- Gathers customer and formula data as needed.
- Updates invoice history for new journals.
- Writes a structured report to a printer file, handling page headings and totals.
- Is parameter-driven, designed to be robust and auditable, with good support for tracking changes and handling data for multiple companies and years.

For further onboarding, focus on:
- The meaning of each file (get data dictionaries).
- The parameter structure and how it's passed from upstream systems.
- How the output report is formatted and used.
- The external number routine and its interface (`AS100R`).