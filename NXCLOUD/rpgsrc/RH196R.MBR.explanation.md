# Program Documentation: RH196R – Budget-Based Allocation

## Overview

**Program Name:** RH196R  
**System:** ASOKON  
**Description:** Allocation based on budget (“Fordeling utfra budsjett”)  
**Primary Function:**  
This program automates the allocation of accounting entries (postings) based on budgeted balances. It reads entries from the budget balance register, applies a series of business rules and filters, and generates corresponding postings in the transaction file and updates the batch header.

---

## File Interactions

- **rhsal1** (`rhsapfr` → `rhsal1r`, Input, Keyed):  
  Reads budget balance records (saldo-register).
- **rbunlu** (`rbunpfr` → `rbunlur`, Update, Keyed):  
  Updates batch header records for postings.
- **rtrapf** (`rtrapfr` → `rtrapfr`, Output, Keyed):  
  Writes generated transaction postings.

---

## Data Structures and Key Variables

- **sal(14):**  
  Array holding up to 14 periods of balances per account (saldo).
- **txt(1):**  
  Text array (likely description for postings).
- **w_mem1, w_mem2:**  
  User/member fields passed to the program for audit or filtering.
- **w_biln, w_bunt, w_firm, w_linj, w_psum, w_pdeb, w_pkre, w_rper, w_sist:**  
  Work variables for document number, batch number, firm, line number, posting sums, etc.
- **rtbelø:**  
  Calculated posting amount for the current entry.

---

## Processing Logic

### Initialization (`*INZSR`)

- Receives parameters `w_mem1` and `w_mem2` (user/member).
- Initializes work variables, including batch number and line number.
- Determines the next available batch number for IB-postings (initial balances).
- Initializes saldo-register and batch file keys.

### Main Processing Loop

1. **Read Budget Balance Record:**  
   Reads next record from `rhsal1` (budget saldo-register).

2. **Business Rule Filters:**  
   - **Firm Check:** Skips records for firms beyond the current.
   - **Fiscal Year Check:** Only processes records matching the specified year.
   - **Record Type Check:** Only processes records of type 3.
   - **Account and Department Range:** Only processes accounts and departments within specified 'from' and 'to' ranges.

3. **Calculate Posting Amount:**  
   - Sums balances across a specified period range (`rhppef` to `rhppet`).
   - Skips if the calculated amount is zero.

4. **Prepare and Write Posting:**  
   - Prepares a posting record in `rtrapf` (transaction file) with all required fields.
   - If the amount is positive, posts as a debit; if negative, posts as a credit (flipping sign and fields accordingly).
   - Sets a large number of fields to zero or blank as required by the business logic.
   - Includes user/member/audit fields and timestamps.
   - Writes the record to the transaction file.

5. **Loop Control:**  
   - Continues reading and processing until end-of-file.

### Batch Header Update

- After all postings, updates the batch header file (`rbunlu`):
  - Sets status, fiscal year, period, sums, and audit fields.
  - Writes the updated batch record.

---

## Special Notes and Design Considerations

- **Period Summing:**  
  The program supports allocation over a range of periods, not just a single period, reflecting flexible budget allocation requirements.

- **Dynamic Batch Number Assignment:**  
  It determines the next available batch number by reading the batch file in reverse order (`readp`) and incrementing.

- **Audit and User Tracking:**  
  User/member fields (`w_mem1`, `w_mem2`) are propagated throughout for traceability.

- **Field Initialization:**  
  Many fields in the posting records are explicitly zeroed or blanked, reflecting strict requirements for clean posting records.

- **Legacy RPG III/IV Style:**  
  The code uses fixed-format RPG with some free-form elements (not modern fully free-form RPG). It employs tags and goto for flow control, which is typical in legacy systems.

- **Change Log:**  
  The header documents several specific business changes, such as extending tables, handling blank fields, and year field corrections.

---

## Relationships with Other Modules

- **Budget Module:**  
  Reads from the saldo-register, which is likely maintained by the budgeting module.
- **Posting/Transaction Module:**  
  Writes to the transaction file, which is processed by downstream accounting or ledger modules.
- **Batch Control:**  
  Interacts with the batch header file for grouping and tracking sets of postings.

---

## Domain-Specific Logic

- **Account and Department Filtering:**  
  Only processes accounts and departments within specific ranges, supporting partial allocations.
- **Posting Types:**  
  Differentiates between debit and credit postings based on the sign of the calculated amount.
- **Period Control:**  
  Allows allocations over specified periods, supporting complex budgeting scenarios.

---

## Error Handling and Exit

- **Graceful Exit:**  
  If no more records or if filters exclude all records, the program exits cleanly.
- **No Explicit Error Logging:**  
  The program does not include explicit error logging or messaging; errors are handled by skipping records or ending processing.

---

## Summary

This program is a batch utility for generating accounting postings based on budget balances. It enforces a series of business rules for filtering and allocation, supports flexible period-based allocations, and ensures auditability by tracking user/member information. It is a core part of the budget-to-ledger integration in the ASOKON system, and interacts closely with budget, transaction, and batch control modules. The code reflects legacy RPG conventions and should be approached with care regarding flow control and field handling.