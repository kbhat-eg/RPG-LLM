# RPG Program RP601R Documentation

## Overview

**Program:** RP601R  
**System:** ASOKON  
**Description:** Inquiry and maintenance of subprojects (Underprosjekt)  
**Main Functionality:**  
- Provides a subfile-based interface for querying, navigating, and (optionally) registering new subprojects and activities within a project management context.
- Allows users to search, page, and select subprojects, with logic for filtering and positioning based on project, subproject, or description.
- Supports controlled registration of new projects and subprojects, including business rules for project splitting.

---

## Main Data Sources and Display Files

- **Physical Files:**
    - `RP2UL1`, `RP2UL2`, `RP2UL3`: Variants of the subproject file `RP2UPFR`, keyed differently for various access paths.
    - `RP1PLU`: Main project file, from `RP1PPFR`.
- **Display File:**
    - `RP601D`: Workstation display file, using subfile `B1SFL` for list display, with control records `B2CTL` and `B2CMD`.

---

## Business Domain Context

- **Projects (Prosjekt) and Subprojects (Underprosjekt):**  
  The program operates on a hierarchical structure where projects can be divided into subprojects/activities. Certain business rules apply (e.g., not all projects can be split into subprojects without explicit permission).
- **Subfile Navigation:**  
  Users interact with a subfile to view and select subprojects, with support for paging, positioning, and filtering based on various criteria.

---

## Key Indicators and Their Usage

- **LR**: Program termination.
- **10/11**: Subfile paging (roll/rolldown).
- **12/13/14/15**: Subfile display, control, clear, and end.
- **21/22**: Home key and cursor positioning.
- **30**: Field protection.
- **31-79**: Error/message indicators.
- **80-99**: Work indicators.

---

## Program Flow and Structure

### Initialization (`*INZSR`)
- Receives parameters (project, subproject, customer, texts, dates, etc.).
- Initializes key lists for file access.
- Positions the database and fills the subfile with initial data.

### Main Display Loop

1. **Display Command Screen (`B2CMD`)**
   - Entry point for the user to interact.
2. **Display Subfile (`dsp_subfile` subroutine)**
   - Shows the list of subprojects according to current filter/position.
3. **Function Key Handling**
   - **Exit (F3/F12):** Ends the program.
   - **Refresh (F5):** Rebuilds the subfile from current position.
   - **Register new (F6):** Initiates new project/subproject registration.
   - **Page Down/Up (F10/F11):** Navigates subfile pages.
   - **Home (F21):** Repositions cursor.
   - **Positioning Fields:** If the user enters values in project, subproject, or description fields, the subfile is repositioned accordingly.
   - **Subfile Selection:** If a subfile row is selected, relevant data is returned and the program exits.

---

## Subroutines

### `forny` (Refresh Subfile)
- Chains to the current record if possible, then repositions the relevant access path.
- Clears and rebuilds the subfile for a fresh display.

### `regny` (Register New Project/Subproject/Activity)
- Checks if the project can be split into subprojects (`rp1rup` field); prompts the user if not.
- If allowed, calls program `RP110R` to perform the registration, passing parameters.
- Refreshes the subfile after registration.

### `posisjoner` (Position Subfile)
- Positions the subfile based on user input in project, subproject, or description fields.
- Selects the appropriate access path and sets the sequence mode (`w_seqe`).
- Clears and fills the subfile from the new position.
- Resets positioning fields after use.

### `subfile` (Subfile Processing)
- Toggles cursor positioning indicator.
- Reads and processes records from the subfile; if a row is selected, loads the corresponding project/subproject data and sets the selection flag.

### `clr_subfile` (Clear Subfile)
- Sets the subfile clear indicator, writes the control record to clear the screen, and resets subfile counters.

### `crt_subfile` (Create/Fill Subfile)
- Fills the subfile page with records according to the current access path and filters.
- Applies business rules:
    - Skips closed subprojects (`rp2sts = 'A'`).
    - If a main project is selected, only shows subprojects for that project.
    - If no main project, filters by registered customer.
- Sets subfile counters and end-of-page indicators.

### `bck_subfile` (Page Back in Subfile)
- Reads backward through the selected access path to fill the previous page.
- Applies the same business rules as `crt_subfile`.
- Repositions the file pointer and refills the subfile.

### `dsp_subfile` (Display Subfile)
- Controls display indicators and presents either the subfile or the command screen depending on subfile state.

---

## Special Design and Conventions

- **Multi-Access Path Logic:**  
  The program uses three logical views (`rp2ul1`, `rp2ul2`, `rp2ul3`) of the same physical subproject file, each keyed for different types of positioning (by project, by description, by subproject). The `w_seqe` variable determines which access path is active.
- **Paging and Positioning:**  
  Subfile paging is handled by incrementing counters and reading the correct number of records per page (`c_sfil`). Backward paging uses `READP` and similar logic.
- **Soft Locking and Update:**  
  When registering a new subproject, the program checks and, if necessary, updates the project split-allowed flag (`rp1rup`) with user confirmation, ensuring business rules are enforced interactively.
- **External Calls:**  
  - `AA007R`: Used for prompting the user with a message and getting a response.
  - `RP110R`: Called to register a new project/subproject/activity, passing all relevant parameters.
- **Parameter Passing:**  
  The program is designed to be called with a comprehensive parameter list, allowing it to be used as a modular inquiry/maintenance component in a larger system.

---

## File and Field Relationships

- **`RP2UL1`, `RP2UL2`, `RP2UL3`**  
  All are logical files over `RP2UPFR`, keyed for different inquiry needs:
    - By project/subproject
    - By project/description
    - By subproject/project
- **`RP1PLU`**  
  Used to check project status and retrieve main project description.
- **Display File Subfiles:**  
  - `B1SFL`: Subfile record format for list display.
  - `B2CTL`: Control record for subfile screen.
  - `B2CMD`: Command screen for function key handling.

---

## Notable Business Logic

- **Project Splitting:**  
  Only projects with `rp1rup = 'J'` can be divided into subprojects. The user is prompted to allow splitting if not already enabled.
- **Filtering:**  
  - If a project is specified, only subprojects for that project are shown.
  - If no project is specified, only subprojects for the registered customer are shown.
  - Subprojects with status 'A' (closed) are excluded from display.
- **Selection:**  
  When a subfile row is selected, the program retrieves and returns project/subproject details for further processing by the caller.

---

## Interaction with Other Modules

- **`AA007R`:**  
  Standard dialog/message program for user confirmations.
- **`RP110R`:**  
  Handles the actual registration of new projects or subprojects, receiving all context from this program.
- **Display File:**  
  The program relies on externally defined display file formats and subfile records, which must be kept in sync with the RPG logic.

---

## Summary

RP601R is a subfile-based inquiry and maintenance program for subprojects within a project management system. It supports flexible navigation, positioning, and selection of subprojects, enforces business rules around project splitting, and interacts with other modules for registration and user messaging. The codebase uses multiple logical views for efficient access and filtering, and encapsulates subfile handling in well-structured subroutines. New developers should familiarize themselves with the access path strategy and the business rules around project and subproject maintenance.