# RPG Program RH620R – Explanation

This RPG (Report Program Generator) code is used on IBM i (AS/400) systems, written in RPG/400 using the fixed-format style. The main purpose of the program is to handle user input for the “Hovedbok - saldobalanse” (General ledger - balance output/parameters), validate these parameters, and prepare them for further processing or reporting.

## High-Level Structure

1. **Header Section**: Program description, history, indicator usage conventions
2. **File Definitions**: The `rh620d` display file used for workstation I/O
3. **Field & Variable Declarations**: Both externally described fields and internal work variables
4. **Main Logic**:
   - Screen handling loop
   - Field validation (account, cost bearer, dates, fiscal year, periods)
   - Error handling and user prompts
   - Parameter assignment
5. **Subroutines**:
   - Message window for confirmation
   - Initialization routine
6. **Program End**

---

## Detailed Breakdown

### 1. Header Section

Contains:
- Program name, description, and history of changes (with Norwegian comments)
- Documentation on how indicators are used (see `KC`, `LR`, etc.)
- Comments about which indicators are used for what (error messages, file I/O, etc.)

### 2. File Definitions

```rpg
frh620d    cf   e             workstn
```

- Associates the program with the workstation file `rh620d`, used for user interaction.

### 3. Field & Variable Declarations

**External display fields (`A2BLD` screen):**
- Many packed, zoned, and character fields like `rhpkda`, `rhprår`, `rhpper`, etc.
- These are used for date (posting date), year/period, account ranges, department and cost bearer ranges, etc.
- Some are conditionally defined for specific versions (e.g., `rhpspb`, `rhpspa`).

**Internal variables:**
- `waar`, `wmnd`, `wpakod`, etc., are local work variables used for temporary calculations.

**Initialization parameters:**
- E.g., `l_user`, `l_firm`, used to get session or user info.

### 4. Main Logic

#### Tags for Flow Control

- Using RPG “tag” statements (`tag`) and `goto` for flow control, looping back to re-display the screen or end the program.

#### Screen Input/Output

```rpg
c     exfmt     a2bld
```
- Presents the parameter selection screen to the user.

#### Exit Handling

```rpg
c     if        *inkc = *on
c     move      '1'           p_in03
c     goto      xslutt
c     endif
```
- If F3 (exit) is pressed, set the return value and exit.

#### Field Validations

Multiple checks to ensure parameters make sense before proceeding, such as:
- **Department range** (`a2pavf > a2pavt`)  
  Set error indicator 31, loop back.
- **Cost bearer range** (`a2pbåf > a2pbåf`)  
  Set error indicator 36, loop back.
- **Account range** (`a2pktf > a2pktt`)  
  Set error indicator 32, loop back.
- **Posting date** (`a2pkda = *zero`)  
  If missing, use current system date.

Date validation uses `test(d)` to check if the date is valid, sets error indicator 33 if not.

**Fiscal Year Warning:**
- If `a2prår` (selected year) is greater than system year, prompts the user for confirmation using the `xm1win` subroutine.

**Period Range Validation:**
- Checks that the 'from' period is not after the 'to' period.

#### Assign Validated Parameters

If validations pass, all screen fields are moved into the program's variables (`rhpkda`, `rhprår`, etc.) for further processing or passing to another program.

### 5. Subroutines

#### `xm1win` – Message Window for Confirmation

- Used when the user selects a fiscal year greater than the system year.
- Sets window position, displays the message, and handles user response (Yes/No).

#### `*inzsr` – Initialization Subroutine

- Sets default values for the screen fields.
- Uses current user, firm, system date, year, and month for the initial values.
- Handles period calculation, including wrap-around to previous year in January.

### 6. Program End

```rpg
c     xslutt        tag
c     eval      *inlr = *on
c     return
```
- Standard way to end an RPG program: set the LR (Last Record) indicator to release resources and exit.

---

## Additional Notes

- **Indicators:** RPG/400 uses numeric indicators (`*INxx`) for flow control, field protection, error handling, etc.
- **Screen/Display files:** A lot of business logic is delegated to the display file format (`rh620d`), not shown in this snippet.
- **User Experience:** The program is highly interactive. User mistakes (like bad range or invalid date) will cause immediate feedback.
- **Extensibility:** Many fields and checks are version-controlled using comments and conditional code (marked, e.g., `T5.30`, `T400`).

---

## Summary

- **Purpose:** Collect, validate, and return parameters for a general ledger balance report.
- **Usage:** Interactive; users select criteria, program validates, and prompts for correction or confirmation.
- **Techniques:** Heavy use of RPG indicators, classic field validation patterns, use of subfiles for pop-up windows, dated code for extensibility.

This program is a good example of classic, interactive ILE RPG programming, tightly coupled with IBM i workstation display files, designed for robust data entry and validation in an accounting context.