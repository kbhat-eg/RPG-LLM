# RK977R – Update Customer Reminder Dates

## Overview

This program (`RK977R`) is part of the ASOKON system and is responsible for updating the "reminder date" (`purredato`) on customer posting records in the `rktrlu` physical file. The primary business logic is to set the reminder date (`rnpdat`) to a new value (`rppdat`) if the current date field (`rnfdat`) is less than this new date; otherwise, it resets the reminder date. The program also updates audit/tracking fields for each record processed.

## Main Functional Areas

### File Declarations

- **rktrlu**: Main file containing customer posting records. Opened for update (`uf e k disk`). The record format is renamed from `rktrpfr` to `rktrlur` for internal reference.

### Data Area and Variable Definitions

- **Local Data Area (LDA) Fields:**
    - `rpfirm` (positions 300-310): Company number.
    - `rppdat` (date, ISO format): New reminder date to be applied.
    - `l_user` (911-920): User ID for tracking.
    - `l_firm` (944-946): Company number.
    - `l_fnav` (951-980): Company name.

- **Working Storage:**
    - `w_firm`: Local copy of company number, used as a key in file operations.

### Initialization (`*inzsr`)

- Loads the company number from the LDA into `w_firm`.
- Sets up the key list (`rktrlu_key`) for record access, keyed by `w_firm`.

### Main Processing Loop

1. **Set Lower Limit and Read First Record:**
    - Positions to the first customer posting (`setll`/`reade`) for the current company.

2. **Loop Through Records:**
    - Continues while records exist for the company (`dow *in90 = *off`).

3. **Business Logic:**
    - **If** the existing date (`rnfdat`) is less than the new reminder date (`rppdat`):
        - Set the reminder date (`rnpdat`) to `rppdat`.
    - **Else:**
        - Reset the reminder date to the lowest possible value (`*loval`).

4. **Audit/Tracking Fields (Version 6.10):**
    - `rnedat`: Set to current system date.
    - `rnetim`: Set to current system time.
    - `rneusr`: Set to current user from LDA (`l_user`).

5. **Update Record:**
    - Writes changes back to the file (`update rktrlur`).

6. **Read Next Record:**
    - Moves to the next record for the company.

### Program Termination

- Sets on LR (`*inlr = *on`) to close files and release resources.
- Returns to the caller.

## Business/Domain-Specific Logic

- **Reminder Date Management:** The core function is to ensure that each customer posting’s reminder date is up to date based on a company-wide new date (`rppdat`). If the record’s existing date is already current or newer, the reminder date is cleared.
- **Audit Trail:** The program maintains a simple audit trail by updating date, time, and user fields on every change (introduced in version 6.10).
- **Company-Scoped Processing:** All operations are restricted to records belonging to the current company (`w_firm`), which is loaded from the LDA.

## Design Decisions & Conventions

- **LDA Usage:** The program relies heavily on the Local Data Area for passing in control parameters (company number, new date, user info). This is a common pattern in legacy AS/400 applications.
- **Physical File Processing:** Direct access and update of the physical file (`rktrlu`) using native RPG cycle and key lists.
- **Record Renaming:** The renaming of the record format (`rename(rktrpfr:rktrlur)`) is used to avoid naming conflicts and to clarify the context within this program.
- **Minimal Error Handling:** The program assumes the presence and validity of all required input data in the LDA and does not perform explicit error checking.

## External Interactions

- **Data Source:** The only data source is the `rktrlu` file, scoped to the current company.
- **No External APIs:** There is no interaction with other modules or APIs; all logic is contained within this program.

## Versioning and Change History

- **Initial Release:** 2019-12-02 (KOB)
- **Version 6.10 (2022-09-09, BSA):** Added audit/tracking fields (`rnedat`, `rnetim`, `rneusr`) to each updated record.

## Summary Table

| Field      | Purpose                                | Source        |
|------------|----------------------------------------|---------------|
| rnfdat     | Existing date on customer posting      | rktrlu file   |
| rnpdat     | Reminder date to be updated            | rktrlu file   |
| rppdat     | New reminder date to apply             | LDA           |
| w_firm     | Company number for keying              | LDA           |
| rnedat     | Update date (audit)                    | System time   |
| rnetim     | Update time (audit)                    | System time   |
| rneusr     | Update user (audit)                    | LDA           |

## Key Takeaways

- The program is a batch updater for customer posting records, scoped by company, and driven by control data in the LDA.
- It ensures reminder dates are current and maintains a basic audit trail.
- The code is straightforward, with business logic focused on date comparison and update, and follows typical AS/400 RPG conventions for file and LDA handling.