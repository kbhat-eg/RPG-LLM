# RPG Program Explanation: Utskrift av salgsstatistikk (Sales Statistics Printout)

---

## General Overview

This RPG/400 (ILE RPG) program, **SF625R**, produces a printed report of sales statistics, with options for various summary levels, grouping, and comparisons against budget and previous years. It reads multiple database files, performs calculations and roll-ups (level breaks), and prints results using layout defined in the printer file `SF625P`. The program uses multi-level summarization—typically product/group/customer/firm—and supports comparison to "budget" and "last year" for sales and margin quantities/values.

The source is heavily commented in Norwegian; variable names and comments reflect this.

---

## File Definitions (`F-specs`)

- A large number of database (`DISK`) files are defined for retrieving master data, hierarchies, product/customer info, and sales/budget details.
- The output is sent to a printer file (`SF625P`), with overflow handling via indicator `*IN30`.

---

## Key Data Structures and Variables

### Arrays

- `sal(12)`: Holds values (e.g., sales amounts) per month, read from budget records.
- `rt(60)`: Array of up to 60 report labels/text entries, loaded using CTDATA.

### Data Structures

- `w_rest`: Holds parameters/settings loaded from the parameter file.
- `beg`, with subfields like `k6`, `k5`, `k4`, `k3`, `k2`, etc.: Used for extracting/splitting keys for lookup.
- `l_wsid`, `l_user`, `l_firm`, `l_navn`: User/session/firm/context info from parameter data.

### Working Fields

- Many working fields (`w_...`) are defined for group, product, customer, and other keys, often reused across files.
- `wxkode`: A DS to store current "budget key type" per level (used when constructing lookup keys for budget amounts).

### Statistical Accumulators

- For every level (firm, group1, group2, group3, etc.), accumulators are defined for:
  - Antall (quantity): `aspiX`, `asiiX`, `aspfX`, `aspbX`, etc.
  - Netto (net amount): `bnpiX`, `bniiX`, `bnpfX`, `bnpbX`, etc.
  - X = 4,5,6,7 indicating which level (see code comments).

---

## Main Program Logic

### Initialization (INZSR)

- Loads parameters and descriptions for the report, selection parameters, and initializes the report heading.
- Determines which grouping/summarization levels are active.
- Sets up key indicators to control which totals are to be printed (based on parameter flags and data values).
- Loads report texts into heading lines.
- Constructs the budget key mask (`wxkode`) based on selected sorting/break fields.

### Input Loop and Level Breaks

- **Main processing** is driven by an implicit input loop, where each input record is parsed and accumulated into the structures, with breaks on each sort level (l6, l5, l4, l7).
- At each logical break (change in the sort field value), a "break routine" (`l4brd`, `l5brd`, etc.) is called to:
  - Summarize data from the lower to the higher level.
  - If enabled, print the summary for that break.
- Special handling for overflow of the printer page, via `overflow` subroutine.

### Calculations

- For each input record, data is extracted for the current period, and—if budget or last year comparisons are enabled—handled accordingly.
- Key variables are
  - Rabatter (discounts): `w_rab`
  - Netto: `w_net`
  - Dekningsbidrag (profit): `w_bid`
- Values are distributed into accumulators for current period, YTD, previous year, and budget.

### Summarization/Break Subroutines

E.g., `l4brd` (level 4 break):

- Moves accumulators up a level (from 4 to 5).
- If printing is enabled for this level, moves the correct descriptions and quantities/values into print fields, and calls `beregn` to calculate derived values (e.g., % difference vs. budget/last year).
- Similar logic in `l5brd`, `l6brd`, and `l7brd` for higher summary levels.

### Calculated Value Subroutine (`beregn`)

- Calculates percentage variances between actual and budget/previous year values, handling both Quantity (Antall) and Amount (Beløp) for period and accumulated figures.
- Results are stored in corresponding fields for output.

### Budget Lookup (`budsjett`)

- Prepares the "budget key" using the current context to look up the correct budget register record.
- Retrieves budgeted quantity and net amount for both YTD and current period.
- Updates the equivalent accumulators that hold "budget" data for later comparison.

### Budget Key Mask Construction (`hntwxk`)

- Sets bits in the `wxkode` DS depending on which sorting/summary fields are used, so the right subset of budget is selected on lookup.

---

## Report/Heading Labels

- The last section defines a table of report labels indexed by number, e.g.:
  - 11: "Alt. hovedgruppe" (Alternative main group)
  - 21: "Kundekategori" (Customer category)
  - 31: "Varenummer" (Item number)
  - ... and so on up to 60.

---

## Subroutines for Description Lookup (`raprut`)

- For each summary/group value (e.g., group code, customer category, district, etc.), `raprut` performs the correct lookup in the relevant master file and fetches the description, which is moved into print fields for the summary/break.

---

## Notable Code Features

- **Level Break Processing**: A classic RPG report structure with multi-level break logic for summaries, handled using conditional indicators and subroutines.
- **Budget/Comparison**: Comparison to budget and previous year's figures is integrated at all summary levels.
- **Flexible Grouping**: The use of the "mask" (`wxkode`) supports arbitrary grouping fields for budgets, required because sales and budgets may not align at all levels.
- **Highly Parameterized**: Report content, grouping, and calculations are parameter-driven, supporting many variations without code changes.
- **Array-based Report Texts**: Flexible label text is drawn from a table using indices, allowing dynamic report headings.

---

## Typical Flow

1. **Initialization**: Load parameter settings, determine which group/summary levels to use, load headings.
2. **Reading Input**: Loop over input sales data, updating accumulators for current, previous, and budget periods.
3. **On Level Breaks**: Summarize and roll-up totals; if enabled, print current summary and zero/reset lower-level accumulators.
4. **Budget**: If budget comparison is needed, lookup the corresponding record and update budget accumulators.
5. **Printing**: Output is written to the printer file at each break as appropriate.
6. **Calculations**: At each summary, `beregn` computes % variances for reporting.
7. **Description Lookup**: For each summary value, the associated description is fetched from the master file for print clarity.

---

## Onboarding Summary

- **Purpose**: Generates a multi-level, flexible sales statistics report, with comparisons (budget, previous year).
- **Structure**: File-driven, parameterized, and highly modularized with break/summary subroutines.
- **To Extend/Modify**:
  - Most parameters and groupings can be handled by changing selection data, not code.
  - New summaries or report lines may require changes in label tables or additional file lookups.
- **Debugging**: Indicator-driven logic, key fields, and heavy use of accumulators require good understanding of level break handling and RPG indicator usage.

---

## Further Reading

- If new to RPG, study how indicators (`*INxx`) are used for controlling logic.
- Review how arrays and data structures are used for accumulator roll-ups.
- Compare to modern event-driven summary/report code; many patterns are similar but may use objects/collections rather than flat arrays and indicator flags.

---

**This code is representative of flexible, enterprise-grade RPG batch reporting—robust, but requiring careful management of fields, indicators, and file layouts.**