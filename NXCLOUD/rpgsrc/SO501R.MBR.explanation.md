# Explanation of RPG Source Code for Faktura, St�rring System

This source code is a comprehensive RPG IV program designed for handling invoices and related queries within the ASOFAK system. It includes detailed comments, version history, and various subroutines to manage data display, search, and maintenance functionalities.

---

## Program Overview

- **Program Name:** SO501R
- **System Name:** ASOFAK
- **Purpose:** To perform invoice inquiries, display, and management functions.

---

## Version History and Changes

- Tracks updates from initial development in 1999 to more recent modifications.
- Introduces new features such as archive handling, support for multi-archive environments, GUI updates, and data cleanup routines.

---

## Key Concepts

### Use of Indicators

- **Indications for flow control and UI interactions**, such as:
  - `LR` to signal program end.
  - `10-15` for scrolling, selection, and input control.
  - `80-99` for processing indicators.

### Files and Data Structures

- Multiple **external files** are referenced:
  - Customer info, invoice details, archive files, etc.
- **Data structures** (`ds`) are defined for screen feedback.
- **Local variables** for key values, search parameters, and subfile control are established.

---

## File Mappings and Renaming

- Files like `SOHELR`, `SOHEL1`, etc., are mapped with the `RENAME` keyword for aliasing, simplifying references throughout the program.
- Example:
  - `fsohelr` is mapped, with possible renames like `sohelrr`.
  - Files like `rkunl1` relate to customer data.

---

## Screen and Subfile Management

### Subfile Handling

- **Subfile control files** like `B1SFL` and `B2CTL` are used to display records.
- **Subroutine `clr_subfile`** to clear the subfile for fresh data.
- **Subroutine `crt_subfile`** to populate the subfile with data.

### Subroutine `dsp_subfile`

- Responsible for displaying the subfile on the screen.
- Checks if data exists (`w_srrn <> 0`), then activates the display.
- Uses `EXFMT` to present the data on the screen.

### Subroutine `newlo_vask`

- Cleans specific string fields to remove characters that might cause display issues in the Newlook GUI.
- Replaces dots (`.`) and colons (`:`) with empty strings.

---

## Search and Positioning Logic

### Subroutine `posisjoner`

- Positions the cursor or search pointer based on the last used record.
- Checks various key fields:
  - Invoice number (`b2binr`)
  - Order number (`b2numm`)
  - Order type (`b2otyp`)
  - Invoice date (`b2fkda`)
  - Customer alphanumeric search (`b2kuna`)
  - Address (`b2navn`)
  - Archive search (`b2fsok`)

- Uses `SETLL` to set the current record position for subsequent reads.
- Calls `clr_subfile` and `crt_subfile` to reset and refill the subfile after positioning.

---

## Data Retrieval & Cursor Usage

- Uses embedded SQL for dynamic queries:
  - Prepares statements (`PREPARE`) with variables (`sqlquery`).
  - Declares and opens cursors (`DECLARE`, `OPEN`) for fetching data.
  - Fetches data in a loop for the current invoice or order.

- Key logic ensures:
  - Record matches search parameters (`w_firm`, `w_aarr`, `p_otyp`, etc.).
  - Data is retrieved via cursors for efficient processing.
  - End-of-file conditions (`sqlcod=100` or `sqlstt='02000'`) are handled gracefully.

---

## Data Processing Subroutines

### `subfile`

- Reads individual records from the subfile.
- Uses `READC` and `READ` commands.
- Incorporates logic to handle different record types based on `w_seqe`:
  - Invoice display (`SO510R`)
  - Invoice copy (`FO681R`)
  - Deleted order lines (`FO506R`)
  - Order headers (`SO515R`)
  - Archive access through special calls (`AX700R`).

- Maintains record counters (`w_srrn`, `w_ssrn`, `w_fcrn`) to manage record positioning.

### `clr_subfile`

- Clears subfile display area.
- Writes a blank control record and resets position counters.

### `crt_subfile`

- Populates subfile based on search criteria.
- Sets up SQL queries dynamically based on user inputs.
- Executes SQL statements with parameter binding.
- Loops through the result set, writing each record to the subfile.
- Handles pagination and record position updates.

---

## Initialization and Program Entry

### `*inzsr`

- Entry point for initializing program state.
- Sets key fields for lookups.
- Loads initial data, such as company code and parameters.
- Fills initial subfile with default search data.

---

## Additional Features

### Data Cleaning (`newlo_vask`)

- Removes problematic characters from text fields, ensuring compatibility with GUI tools like Newlook.

### Error Handling & Loop Control

- Uses SQL return codes (`sqlcod`) and statement status (`sqlstt`) to manage end-of-data conditions.
- Employs `LEAVE` and `ITER` to control loop flows, ensuring proper processing and exit strategies.

---

## Summary

This RPG program is a sophisticated tool for invoice inquiries and management, utilizing:
- External SQL queries for data access.
- Subfile techniques for user-friendly display.
- Multiple search keys and dynamic query building.
- Special routines for cleaning, positioning, and display refresh.

It’s designed with modular subroutines to facilitate maintenance, scalability, and GUI integration.

---

**Note:** For onboarded developers, understanding the subfile control logic, embedded SQL interactions, and the screen flow will be critical in maintaining and enhancing this system.