# Program Documentation: SX821R

## Overview

**Program Name:** SX821R  
**System:** ASSTAT  
**Description:**  
This batch program updates the `SSTAPF` statistics file with the original sales price (`opprinnelig salgspris`) for new registers (cash registers). It processes transaction records (bonger) from new registers where the original price is missing. The program is meant to be run in batch mode.

**Key Business Logic:**  
- Identifies records in the statistics file (`SSTAPF`) missing original sales price for new cash registers.
- Retrieves the correct sales price by calling a pricing API (`VP700R`).
- Updates the statistics file with the calculated original sales price.

---

## File and Data Structures

### File Declaration

```rpg
fsstal9    uf   e           k disk    rename(sstapfr:sstal9r)
```
- **sstal9**: User-controlled, externally described, keyed disk file.  
- **Renamed**: The external format `sstapfr` is referenced as `sstal9r` in this program.  
- **Purpose**: Represents the `SSTAPF` statistics file to be updated.

### Data Area & Key Fields

- **LDA (Local Data Area):**  
  - `l_firm` (positions 944-946): Used to retrieve the current company code from the LDA.

- **Key Variables:**  
  - `sstal9_paar`: Key field, similar to `sfpaar`, typically denotes accounting year or period.

### Working Variables

- **Price Variables:**  
  - `w_sapr`, `w_bupr`, `w_tipr`, `w_kopr`: Various price components, all packed(9,2).
- **Other:**  
  - `w_time`: Time value, ISO format.
  - `b_inlr`: Boolean flag, initialized ON, used for API call.
  - `w_firm`: Company code, like `sffirm`.

---

## Main Logic Flow

### Initialization (`*INZSR`)

- **Purpose:**  
  - Sets up the key list for accessing the statistics file.
  - Retrieves the company code from LDA into `w_firm`.
- **Details:**  
  - The key list (`sstal9_key`) is set up using `w_firm` and `sstal9_paar`.
  - `sstal9_paar` is hardcoded to `2005` (likely a year or period).

---

### Main Processing Loop

```rpg
eval      sstal9_paar = 2005
sstal9_key    setll     sstal9r
read      sstal9r
dow       not %eof and sffirm = w_firm
    exsr      oppdat
    read      sstal9r
enddo
```

- **Process:**  
  1. Sets the key to start reading records for the given company and period.
  2. Loops through all matching records in `sstal9r`.
  3. For each record, calls the `oppdat` subroutine to potentially update the original sales price.
  4. Continues until EOF or company code changes.

---

### Subroutine: `oppdat`

**Purpose:**  
- Updates the original sales price in the statistics file if it is missing for a record.

**Logic:**
1. **Skip Conditions:**  
   - If any of the following are true, the record is skipped:
     - `sfbong` (voucher/receipt number) is blank.
     - `sfvare` (item number) is blank.
     - `sfsumo` (original sales price) is NOT zero (i.e., already set).
   - If `sfbong` contains a hyphen (`-`), skip the record as well (special-case exclusion).

2. **Price Retrieval:**  
   - Calls external program `VP700R` to fetch the sales price for the item.
   - Passes company, item, unit, type, date, and other parameters.
   - Receives the original sales price in `w_sapr`.

3. **Update Calculation:**  
   - Sets `sfsumo` (original sales price) to `w_sapr * sfanta` (unit price times quantity).
   - Updates the record in the file.

---

### Subroutine: `*INZSR`

- **Initializes** the key list and loads company code from LDA.
- Ensures all processing is scoped to the correct company and period.

---

### Program Termination

- Sets on LR (`*INLR = *ON`), ending the program and closing files.

---

## External Interactions

### Pricing API: `VP700R`

- **Purpose:** Returns various price components for a given item.
- **Parameters Passed:**
  - `w_firm` (company)
  - `sfvare` (item)
  - `sfenhe` (unit)
  - `sflety` (type)
  - `sforda` (date)
  - `w_time` (time)
  - `b_inlr` (flag)
  - `w_sapr` (original price, output)
  - `w_bupr`, `w_tipr`, `w_kopr` (other price components, output)
- **Note:** Only `w_sapr` is used for updating the statistics file.

---

## Conventions and Patterns

- **Key List Usage:**  
  - The key list (`sstal9_key`) is defined for efficient keyed access and updates.
- **LDA for Company Context:**  
  - The company code is always fetched from LDA, ensuring company-specific processing.
- **External Price Logic:**  
  - All price calculations are delegated to the external `VP700R` program, centralizing pricing logic.
- **Record Skipping:**  
  - Explicit business rules for which records to skip (blanks, already updated, special bongs).

---

## Business/Domain-Specific Notes

- **"Bong":** Refers to a receipt or transaction record from a cash register.
- **"Opprinnelig salgspris":** The original sales price, which may have been missing on records from new registers.
- **"Kasse":** Cash register; the program is specifically for new registers with incomplete data.
- **"Statistikk":** The statistics file (`SSTAPF`) is a core part of the reporting infrastructure.

---

## Maintenance/Extension Notes

- The period (`sstal9_paar`) is hardcoded to `2005`. If you need to process other periods, this must be parameterized.
- If new fields are added to the statistics file or new price components are needed, update the call to `VP700R`.
- The logic for skipping records is tightly coupled to business rules; changes in receipt structure or item coding may require updates.

---

## Summary

**SX821R** is a batch job for retroactively updating missing original sales prices in the statistics file for new cash registers. It filters relevant records, fetches the correct price via an external API, and updates the file, ensuring data integrity for downstream reporting and analytics. All company-specific context is drawn from the LDA, and pricing rules are centralized in the external program.