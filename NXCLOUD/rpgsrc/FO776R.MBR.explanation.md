```markdown
# FO776R – Order Splitting by Suffix Based on Picking Area

## 1. Program Overview
FO776R reads an existing order (header + detail lines) and, when order lines belong to different picking‐areas (warehouses), splits the order into multiple “suffixes” so that each suffix contains lines for exactly one picking‐area.  
– Suffix 0 always holds items without a defined picking‐area.  
– Service/“T” lines and text lines always stay on suffix 1.  
– New suffix numbers are generated by calling program **AS110R** to find the highest existing suffix, then incrementing by one.  
– For each new suffix created, the order header and the matching detail lines are written; original lines are deleted.  
– After splitting, summaries (totals) are recalculated by calling **FO700R** for each suffix.

## 2. File and Data Definitions

### 2.1 Files (Disk Tables)
– **FOHEL1/FOHELR/FOHELU** – Order header (read, update, delete).  
– **FODTL1/FODTLU** – Order detail lines.  
– **LPOML1** – Picking‐area setup by item/warehouse, item‐group, etc.  
– **VVARL1** – Item master (to get item type, module, group).  
– **FVLSLR/FVLSLU** – Length/width specs for an item (optional).  
– **JVARL1** – Alternate item file for special lookups.  
– **LODTLU** – Purchase‐order lines, to update “linked” PO when splitting.

### 2.2 Key Variables and Arrays
- `p_firm, p_numm, p_suff` – Entry parameters: company, order number, original suffix.  
- `i` – Count of distinct picking‐areas found.  
- `a_plom(*)` – Array holding distinct picking‐area codes (strings up to 10).  
- `a_plla(*)` – Array holding corresponding warehouse codes for each picking‐area.  
- `a_suff(*)` – Array that collects all suffixes created.  
- `w_nysuff` – Newly assigned suffix number in `splitt`.  
- `w_plom` / `w_plla` – Current detail line’s picking‐area and warehouse.  
- `b_trel`, `b_blan` – Flags to indicate presence of “real” picking‐area vs. blank.  
- `s_plom` – Saving previous line’s picking‐area for text lines.

### 2.3 Data‐Structures & LDA
- **`d_urec`** – Unified 80‐byte record used for logging calls (date/time/user).  
- **`hlrec`** – 128‐byte record passed to **VL001R** for inventory movements.  
- **LDA** – Local data area holds user and workstation names.

## 3. Main Flow

1. **Initialize**  
   - `w_suff = 0`  
   - Call `*INZSR` / entry routine to load `p_firm`, `p_numm`, `p_suff`, and zero out arrays `a_suff`.

2. **Check If Splitting Needed** (`sjk_splitt`)  
   - Clears arrays, sets flags off.  
   - Reads order‐header.  
   - Loops through all detail lines of the original suffix:
     - Skips text lines and blanks.
     - Chains to **VVARL1** (item master) to exclude service items (type ‘T’) or missing items.
     - Calls `finn_plom` to determine the picking‐area (`w_plom`) and warehouse (`w_plla`) based on item master / LPOML1 rules.
     - Marks flags `b_blan`/`b_trel` depending on `w_plom`.
     - Adds distinct `w_plom` into `a_plom` array and `w_plla` into `a_plla`.
   - Upon return, `i =` number of distinct picking‐areas found.

3. **If More Than One Suffix**  
   - `if i > 0`: call subroutines:
     1. `splitt`     – actually create new suffixes and move lines.
     2. `nye_summer` – recalculate totals on each suffix.
     3. `sjk_ohead`  – (optionally) delete suffix 0 header if no lines remain.

4. **Return**  
   - Sets `p_anta = i` (number of suffixes) and `*INLR = *ON`.

## 4. Key Subroutines

### 4.1 sjk_splitt (Check for Split)
– Gathers distinct picking‐areas/warehouses into `a_plom(*)`/`a_plla(*)`.  
– Skips text lines & service items so they remain on the first suffix.

### 4.2 finn_plom (Determine Picking‐Area)
1. Look up LPOML1 by `(warehouse=item’s fdlage, item=fdvare)`.  
2. Else by `(ware, module, blank item)` using item’s module.  
3. Else by `(ware, groups)` in decreasing specificity: item‐group, subgroup, etc.  
4. If none found → `w_plom = *BLANK`.

### 4.3 splitt (Perform the Split)
1. **Chain** original header.  
2. Loop `x = 1 to i` (each picking‐area):  
   - Call **hent_suff** to set `w_nysuff = highest existing suffix + 1`.  
   - Copy header record, assign `fosuff = w_nysuff`, timestamps, user, then `WRITE FOHELU`.  
   - Save `a_suff(x) = w_nysuff`.  
   - Loop through **all detail lines** of original suffix:
     - For each line, determine if it belongs to this suffix:
       - If line’s `w_plom = a_plom(x)` OR it’s a service/text on first suffix.
     - Modify `fdsuff = w_nysuff`, timestamps, user, then `WRITE FODTLU` and `DELETE FODTL1R`.
     - If warehouse changed, call `opplag` subroutine twice to reverse then apply inventory.
     - (Optionally) Update length/width specs `FVLSLUR/FVLSLRR`.  
     - (Optionally) Update linked PO lines in `LODTLU`.  
3. End loop over suffixes.

### 4.4 hent_suff (Generate New Suffix)
– Calls program **AS110R** with input `fonumm`, output `x_suff` = highest existing suffix.  
– Sets `w_nysuff = x_suff + 1`.

### 4.5 nye_summer (Recalculate Totals)
– Set pointer to each header suffix (`SETLL/READE FOHEL1`), then for each:
  - Call **FO700R** with `fofirm, fonumm, fosuff` to rebuild summaries.
  - Optionally log suffix creation (via **upd_logg**).

### 4.6 upd_logg (Write Change Log)
– Builds `d_urec` record (company, order, suffix, date/time, user, elapsed years).  
– Calls **FU900R** to update status/log register.

### 4.7 opplag (Inventory Movement)
– Fills out `hlrec` (item, warehouse, date/time, qty, user, reference “O:nnnn L:llll”).  
– Calls **VL001R** to post inventory adjustment.

### 4.8 sjk_ohead (Delete Empty Suffix 0 Header)
– If after splitting the original suffix 0 has no detail lines, delete its FOHELU record.

## 5. Notes on Version History
– Suffix 0 is always items **without** picking‐area.  
– Text and service lines forced onto suffix 1.  
– If item master indicates a different warehouse, inventory movements adjust both old/new.  
– External references cleared for orders originally from system “NGN”.  
– Logic enhancements over time to ensure text lines follow preceding item lines, proper suffix‐number retrieval, and PO‐line updates.

---
*End of FO776R explanation.*  
```