# AT123R RPG Program Explanation

This RPG (Report Program Generator) program, named **AT123R**, is a classic ILE RPG application running on IBM i (formerly AS/400). It is designed for managing user menu entries (`meny bruker` means "menu user" in Norwegian), supporting subfile display, creation, update, deletion, and inquiry of menu-user records from a database table (presumably `amnust`).

Below, the program is broken down into its core sections, with explanations and onboarding notes for developers.

---

## 1. **Header and Setup**

```rpg
h option(*nodebugio : *srcstmt) datedit(*dmy)
```
- Sets debugging and source options.
- Dates are edited as day/month/year.

---

## 2. **Documentation and Indicator Usage**

There is extensive documentation (in Norwegian) on the logical use of indicators, e.g.,  
`LR = Avslutt program` ("End program"),  
`10 = Rollup`,  
`30 = Protect fields on display`,  
`31-79 = Error/message indicators`, etc.

---

## 3. **File Declarations**

```rpg
fAT123D    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- `AT123D`: Workstation display file, containing a subfile (`b1sfl`) with relative record number `w_srrn`.
- Display feedback data structure: `dspfbk`.

---

## 4. **Data Structures and Variables**

**Local Data Area (LDA):**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- These fetch user, firm, and navigation info from the LDA.

**Display Feedback DS:**
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Used for tracking the 'First record on page' in subfile processing.

**Variables for Subfile and Logic:**
```rpg
d w_date          s               d   datfmt(*iso)
d w_time          s               t   timfmt(*iso)
d w_fcrn, w_stel, w_spge,
  w_srrn, w_sfrn, w_ssrn          s              4  0
```
- ISO formatted date/time.
- Subfile control variables: record numbers, counters.

```rpg
d b_forn, b_oppr, b_anul         s              1    inz(*off)
```
- Boolean flags: forny ("refresh"), opprett ("create"), anul ("cancel").

**SQL and Messaging:**
```rpg
d sqlquery        s           4096
d w_frisok        s             30
d w_teller        s              3  0
d b_open_sok      s              1    inz(*off)
d w_firm          s              3  0
```
- Variables supporting dynamic SQL query, search logic, and company value.

**Constants:**
```rpg
d c_sfil          s              2  0 inz(18)
```
- Subfile page size; 18 records per page.

---

## 5. **SQL Setup**

```rpg
C/Exec SQL
C+  Set Option DatFmt=*ISO, commit=*none, DlyPrp=*YES
C+  , SRTSEQ=*LANGIDSHR, LANGID=NOR
C/End-Exec
```
- Configures embedded SQL to default to ISO dates, Norwegian sort/language.

---

## 6. **Main Processing Loop**

### **Entry Point and Main Screen Logic**

- The main processing loop is controlled with tags (`b2taga`, `b2tagb`, etc.) and `goto` statements. The program displays the main menu, handles function keys, refreshes subfiles, and processes user choices.
- Function keys are processed in a `select` statement (`when *inkc or *inkl`, etc.).
- The program can process create (F10), refresh/query (F12), and exit (F3/ESC).

---

## 7. **Subfile Processing**

### **Subfile Control and Operations**

#### **forny** — Refresh subfile

- If subfile position indicator is set, chain to subfile.
- Flags the search to be refreshed, clears and re-creates the subfile.

#### **posisjoner** — Position in subfile

- Clears and re-creates subfile based on search position.
- Blanks position fields.

#### **subfile** — Handles subfile actions

- Iterates through displayed subfile records, processes row actions:
  - **2:** Edit – Calls edit subroutine.
  - **3:** Copy – Calls copy/create subroutine.
  - **4:** Delete – Calls delete subroutine.
  - **5:** View – Calls view subroutine.
- After an update, may refresh the subfile (`forny`).
- Maintains first, last, and current record positioning via several variables.

---

## 8. **Create, Edit, View, Delete Screens**

### **xc1bld** — New Record (Create)

- Handles creation of new records.
- Checks for duplicates (via SQL `count(*)` into `w_teller`), shows a message if record exists.
- If creation is valid, passes control to maintenance subroutine.

### **xc1msg** — Duplicate Entry Message

- Screen informs the user of the duplicate, lets them cancel.

### **xd1win** — Delete Confirmation

- Fetches record data for confirmation screen.
- If not canceled, deletes the record from the database with `DELETE FROM amnust`.

### **xc2bld** — Edit/View/Maintain

- If creating, initializes fields from new record variables; otherwise, fetches from DB.
- Presents maintenance screen.
- If a change is made (`*in30`), performs an update or insert in the DB.

---

## 9. **Subfile Maintenance**

### **clr_subfile** — Clear subfile

- Marks subfile for clearing, writes control record, resets counters.

### **crt_subfile** — Fill the subfile

- Prepares SQL query for the subfile, applies search criteria if present.
- Executes the query and writes records into the subfile page-by-page.
- Handles cursor/statement management for SQL.
- Maintains subfile record/page pointers, handles end-of-file/empty data correctly.

### **dsp_subfile** — Display subfile

- If there are records, sets indicators and displays control record.

---

## 10. **Other Key Logic**

- **spørring** subroutine exists for custom queries/search (currently empty, but reserved for search logic).
- The `*inzsr` (initialization) subroutine:
  - Loads firm from LDA.
  - Sets up default screen and time, initializes subfile.

---

## 11. **Workflow Summary**

1. **Program startup**: `*inzsr` runs, sets environment and fills initial subfile.
2. **User interaction**: Main loop displays subfile screen, processes function keys and row actions.
3. **Data maintenance**: User can Create, Edit, Copy, View, or Delete subfile rows, with immediate feedback and validation (e.g., duplicate checking).
4. **Subfile management**: Data written/read using SQL, with dynamic queries for filter/search.
5. **Exit**: On function key, sets LR (`*inlr = *on`), ending the program.

---

## 12. **Key Notes for Onboarding Developers**

- **Subfile operations** use many indicators and variables; understanding their purpose (see comments on indicator usage) is essential.
- **Embedded SQL** is used for all DB access (INSERT, UPDATE, DELETE, SELECT).
- **Norwegian variable and comment names**: Use translation if needed; most logic is understandable through context.
- **Screen formats** (`B1SFL`, `B2CTL`, etc.) are referenced but not defined in this code—check display file source (`AT123D`) for details.
- **Error handling** is basic—be sure to check how `sqlcod` is handled after SQL operations.
- **Goto and tags** are liberally used—be careful when updating the flow.
- **Subroutines** (`exsr label`, `begsr/endsr`) are used for modularity; RPG IV/ILE syntax is used, but logic is "classic" in style.

---

## 13. **Ideas for Improvement**

- Consider refactoring using more modern (free-form) RPG syntax.
- Add more robust error handling, logging.
- Modularize complex subfile and database routines.
- Externalize magic numbers/indicator usage for clarity.
- Expand the `spørring` subroutine for user-initiated search/filter input.

---

**Summary:**  
This RPG program is a full-featured subfile handler for a menu-user table, supporting CRUD operations with classic ILE RPG and embedded SQL. It’s highly interactive, indicator-driven, and designed for fast terminal-based data maintenance. A clear understanding of subfile programming (paging, record handling), indicator logic, and the display file screens is essential for maintenance and further development.