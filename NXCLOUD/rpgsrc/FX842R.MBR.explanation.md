## Overview

This RPG/400 (ILE RPG) program is designed to process product pricing information for suppliers in an IBM i environment. The main purpose is to **remove supplier-specific prices that do not belong to the primary supplier for a given item**, and to ensure that supplier-related stock information is also updated accordingly.

The program is structured with initialization, main logic for processing prices, a subroutine for warehouse updates, and proper cleanup.

---

## File Declarations

```rpg
fvvprl3    if   e           k disk    rename(vvprpfr:vvprl3r)
fvvprlu    uf   e           k disk    rename(vvprpfr:vvprlur)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
```
- **vvprl3**: Price records (item prices per supplier)
- **vvprlu**: Price records, updatable (for deletion)
- **vvarl1**: Item master data
- **vlaglu**: Warehouse item-supplier links, updatable

Files are renamed for local use.

---

## Data Structures & Variables

- Local Data Area (LDA) fields for user and firm (`l_user`, `l_firm`)
- **Parameters**: `p_firm`, `p_ldor` — passed into the program (firm number, supplier number)
- **Work variables**: prefixed with `w_` (work copies of parameters)
- **Key fields**: for chaining/setting file positions

---

## Initialization (`*inzsr`)

- Imports parameters: firm and supplier
- Sets up key lists for access and update operations on physical files
- Initializes work variables

---

## Main Logic

### Looping Through Supplier Prices

```rpg
eval      vvprl3_ldor = w_ldor
vvprl3_key    setll     vvprl3
vvprl3_key    reade     vvprl3
dow       not %eof(vvprl3)
    ...
    read      vvprl3
enddo
```
- Sets the file pointer to the first price record for the given supplier (`w_ldor`).
- Loops through all price records for this supplier.

### For Each Price Record

1. **Find Associated Item in Item Master**  
   Uses `vpvare` (item number) from the price record to CHAIN into `vvarl1` (item master).
   
2. **Check Supplier Status**
   - If found, and the supplier is *not* the primary supplier of that item (`vpldor <> vvldor`), proceed to delete.
   
3. **Delete Non-Primary Supplier Price**
   - Set up full key fields and CHAIN to the updatable price record (`vvprlu`).
   - If found, DELETE the record.
   - Call `sjekk_lager` subroutine to remove this supplier from the warehouse(s) for this item.

---

## `sjekk_lager` Subroutine

Checks if the given item for the supplier exists in any warehouse:

- Loops through all warehouse records for the item.
- If the supplier for the warehouse is the one being removed, sets the supplier field to `0` (removes supplier from warehouse).
- Updates date, time, and user for the change.

---

## Program End

After all processing, the program sets the last record indicator (`*INLR = *ON`) and returns.

---

## Key Lists

Defined for efficient file access:

- **vlaglu_key**: firm, item
- **vvarl1_key**: firm, item
- **vvprl3_key**: firm, supplier
- **vvprlu_key**: firm, item, supplier, price group, unit, price type, price date

---

## Workflow Summary

1. The program receives a firm and supplier number.
2. It loops through all prices for the supplier.
3. For prices where the supplier is not the main one on the item, the price record is deleted.
4. Any warehouse records for that item owned by the supplier are updated to remove the supplier.
5. Cleanup and end.

---

## Key Concepts

- **Primary supplier**: Only price records for the main supplier of an item are kept.
- **Data integrity**: Ensures both price and warehouse/supplier links are properly updated.
- **Modular design**: Uses subroutines for repeated logic (like warehouse update).

---

## Onboarding Notes

- **vvprl3** and **vvprlu** reference the same underlying file, but `vvprlu` is opened for update/delete.
- *CHAIN* is used for random access; *READE* for reading records matching the leftmost key fields.
- This is a *batch* program—no interactive input, receives parameters and processes to completion.
- Comments are in Norwegian; variable and field names are based on Norwegian abbreviations (e.g., `ldor` = "leverandør", supplier).

---

## Dependencies

- Expects properly defined physical files as per `f` specs.
- LDA (Local Data Area) must contain the user and firm codes.
- Should be called with suitable parameters for firm and supplier.

---

## Typical Use Case

**Clean up all secondary supplier prices for a specific supplier/firm and ensure warehouse data does not link those items to the supplier anymore.**