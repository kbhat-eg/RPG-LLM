# RPG Program FO506R â€“ Explanation

This is a comprehensive breakdown of the RPG program FO506R, based on the provided code. This guide is intended for developers and maintainers to understand both the structure and purpose of the code.

---

## **General Purpose**

- **Program FO506R** displays deleted order lines ("vise slettede ordrelinjer").
- It is an interactive program utilizing subfiles (SFL) to list and manage records via a 5250 display, typical for IBM i (AS/400) systems.

---

## **Header (h-spec):**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio` disables debug input/output information (for performance).
- `datedit(*dmy)` sets the default date format to day-month-year.

---

## **File Definitions (f-specs):**

Several files are defined for input and for display.

- `sohel1`, `fohel1`, `rkunl1`, `fdesl1`, `vpkol1`, `vltyl1` are all physical files. Many are renamed for clarity.
- `fo506d`: Display file, using a subfile (SFL) for listing records with associated indicators (e.g., `infds` for feedback data structure).

---

## **Data Structures and Variables (d-specs):**

- **Local Data Area:** Used for storing parameters, e.g., `l_fnav`.
- **Display Feedback (`dspfbk`):** Used to get display feedback like cursor position.
- **Detail Line Structure:** Overlays a large text field with subfields for item, description, count, unit, discount, amount, etc.
- **Parameters:** Variables like company, customer, number, suffix, etc., are defined, and later mapped to parameters from external callers.
- **Key Variables:** For reading/updating specific records from files.
- **Subfile Control Variables:** Variables to track subfile pagination, current row, etc.
- **Constants:** E.g., `c_sfil` defines a default subfile page size (`12`).

---

## **Documentation and Comment Blocks**

The code is well documented with:
- Changelog.
- Indicator usage: which indicators control what (E.g., `LR` for end, 10 for roll, 12 for subfile display, etc.).
- Explanation of variables used for subfile navigation.

---

## **Mainline Logic**

### 1. **Initialization**
- Calls the `control_init` subroutine: Loads the order/invoice header for display control.

### 2. **Subfile Creation**
- Uses `setll` to position to the first record in the "deleted order line" file.
- Calls `crt_subfile` to fill the subfile with the first page of data.

### 3. **Display Loop**
- Uses display file B2CTL/B2CMD for user interaction.
- Displays the subfile (`dsp_subfile`).

### 4. **Command/Function Key Handling**
- Handles standard function keys (`select`):
    - Next/previous page, refresh, reposition cursor, etc.
- Handles special function keys (F9, F14, F21), triggering other programs (e.g., item info, customer info).
- Manages subfile actions (call `subfile`).
- Loops until exit (when *inLR is set).

---

## **Subroutines**

### **control_init**
- Reads order/invoice header from `fohel1` or `sohel1`.
- Populates screen fields (customer, name, address, etc.).
- Loads customer name from `rkunl1` if needed.

### **forny**
- Repositions on the current record if returning to list.
- Clears and regenerates the subfile.

### **subfile**
- Toggles cursor positioning indicator.
- Reads the subfile page, processes any actions (e.g., view details on selection).

### **clr_subfile**
- Sets subfile clear indicator, writes the control record (effectively erasing).
- Resets subfile counters.

### **crt_subfile**
- Fills the subfile with a page of records.
- For each record:
    - Loads header/line/type info.
    - Determines if it's a text line or item line.
    - Calculates discounts, text, formatting.
    - Writes each record to the subfile.
- Sets counters indicating page boundaries.

### **dsp_subfile**
- If page has rows, enables subfile display indicators and shows the control record.
- Updates cursor position.
  
### **Initialization (*inzsr)**
- Receives entry parameters (company, account year, customer, number, etc.).
- Builds key lists for all relevant files.
- Loads values into working variables.
- Prepares subfile cursor indicator.

---

## **Key Concepts**

### **Subfiles**
- Subfiles are used to display a page-oriented list, with support for paging, clearing, and selection.
- Variables like `w_srrn`, `w_spge`, etc., track subfile state and paging.

### **Indicators**
- Numerous indicators are used to control UI state, subfile mode, and handle different function keys.

### **Database Reads**
- `chain`, `reade`, `setll`, and `readc` are used for indexed and sequential reads from files.

### **Calling Other Programs**
- Function keys F9, F14, F21 trigger calls to entirely separate RPG programs for item, customer, and item/price queries.

---

## **File Keylists**

Several keylists are defined:
- For reading headers, lines, customers, price codes, and line types.

---

## **Common Fields**

- **w_firm**: Company code.
- **w_kund**: Customer number.
- **w_numm**: Order/Invoice/document number.
- **w_suff**: Suffix.
- **w_binr**: Likely branch number.
- Fields from files (e.g., fsvare, fslety, etc.) represent items, line types, quantities, etc.

---

## **Summary**

- **FO506R** is a classic IBM i RPG program for browsing deleted order lines, designed for an interactive environment.
- Makes heavy use of subfiles to display and interact with data.
- Highly modular with clear subroutines for display control, subfile management, and data retrieval.
- Relies on physical files (database tables), indicators, and external programs to provide a rich, interactive user experience.

---

**Onboarding Recommendation:**  
- Understand subfiles and display file DDS on IBM i.
- Review the referenced physical files (headers, customers, price code, line types).
- Familiarize yourself with the company's indicator conventions and keylist usage for record access.  
- Test function key actions to see how the program flow changes.

---

If you need specific details on any section, please ask!