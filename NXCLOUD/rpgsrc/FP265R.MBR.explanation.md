# RPG Program FP265R – Explanation and Onboarding Guide

This analysis covers the IBM ILE RPG program `FP265R`, which automates the creation of an export file in the "Pricer" format for electronic shelf labels. The program reads product and inventory registers, fetches units, sales prices, and possible offer prices for sales units.

## 1. **High-Level Purpose**

- **Automates** export file generation for electronic shelf-edge labels (Pricer format).
- **Reads** inventory register (`lagerregister`), product master, and other related files.
- **Fetches**: unit information, sales price, campaign/offer price, and other attributes for selected products or entire inventory (dependent on chosen selection).
- **Supports** full or partial exports, with logic to avoid redundant exports (logging).

---

## 2. **Program Structure Overview**

1. **Header (H-Spec) & Comments:**  
   - Specifies date edit format, disables debug for I/O.
   - Detailed change log and historical context (in Norwegian).

2. **File Declarations (F-Spec):**
   - Multiple input/output files for products, inventory, suppliers, sales, statistics, and logs.
   - File renaming for logical file definitions.

3. **Data Definitions (D-Spec):**
   - Includes parameters, working variables, arrays, and constants for processing.
   - Extensively defines all fields needed for computation, file operations, and export formatting.

4. **External Program Definitions (DCL-PR/DCL-S):**
   - Calls to external programs for prices, VAT, and more.
   - Modern free-format RPG for new routines.

5. **Mainline Logic (C-Spec):**
   - Based on input parameters, calls a specific subroutine to process all products, selected warehouse, or explicit item lists.
   - Handles graceful program exit and file closure.

6. **Subroutines:**  
   - **Selection routines:** (`les_fil`, `les_lager`, `les_vare`) – Determines which products to include.
   - **Data gathering and calculation:** (`hent_pris`, `klar_pris`, `klar_rest`) – Retrieves product/price info, prepares export fields.
   - **Export:** (`skriv`) – Formats and writes data to the export file.
   - **Helpers:** (`hent_omr`, `lukk_prog`) – For unit conversion, resource cleanup, etc.

7. **Initialization (`*inzsr`):**
   - Handles parameter intake, key lists setup, variable initialization, and control logic based on system parameters.

---

## 3. **Key Functional Areas**

### **A. File Access & Data Flow**

- **File Renaming:** Logical files are given short aliases for code clarity.
- **Access Pattern:** The program chains and reads through product, inventory, sales, purchase, and supplier master files.
- **Data Sourcing:** Draws sales and purchase statistics for periods such as last 12 months or last month.

### **B. Parameter Control & Selection Logic**

- **Parameters:** Passed at program start, controlling:
  - Warehouse to process (`p_lage`)
  - Entire inventory/all products or selection (`p_alle`, `p_full`)
  - Export type/scope
- **Selection Flow:**
  - `les_fil`: Reads an explicit list (via parameter file).
  - `les_lager`: Reads all items for a warehouse.
  - `les_vare`: Reads all products in master file (with handling for default warehouse logic).

### **C. Price and Unit Calculation**

- **Calls External Programs:** To fetch and calculate price data, including handling of discount/offers and comparison prices.
- **Handles multiple units:** Main sales unit (SE1), comparison/secondary (SE2/SE3), and mapping to GTIN/EAN codes.
- **VAT, rounding:** Fetches appropriate VAT info, then calls external routines for currency rounding.

### **D. Output Construction**

- **String Building:** Constructs a delimited string with many fields (EAN, prices, quantities, text, codes, etc.), mapped to Pricer format.
- **Conditional Fields:** Some fields depend on product status (e.g., discontinued, special unit conversions, campaign/offer flags).
- **Write/Update Logic:** Maintains a "log" to avoid redundant exports unless a price change is detected or a forced full export is set.

---

## 4. **Major Subroutines — Details**

#### **Selection Subroutines**

- **`les_fil`:** Reads product EAN codes from a parameter file and processes matching items.
- **`les_lager`:** Processes all inventory items for the selected warehouse, then fetches product data.
- **`les_vare`:** Processes all products in the product master file, with default or specified warehouse logic.

#### **Data Preparation Subroutines**

- **`hent_pris`:**
  - Calls external routines to fetch pricing and product data for up to three sales units.
  - Tries to get GTIN for each unit, sets calculation basis accordingly.
  - Sets flags if campaign/offer periods are active.

- **`klar_pris`:**
  - Prepares final price values (net/gross, comparison price, campaign price).
  - Applies VAT.
  - Rounds using external rounding subroutine.
  - Sets status flags for NULL/missing prices.

- **`klar_rest`:**
  - Fetches supplier text (brand/description), last purchase and sales dates.
  - Calculates sales for last 12 months and last month.
  - Prepares auxiliary fields for output, including cleaning up text fields for invalid characters.

#### **Output Subroutine**

- **`skriv`:**
  - Flags items for writing if price changed (or full export).
  - Builds the full export string in Pricer format, including custom fields.
  - Writes data to the output file.

#### **Other Helpers**

- **`hent_omr`:** Finds unit conversion factors between different sales units.
- **`lukk_prog`:** Calls external programs with "close" indicators to clean up file handles/resources (modern addition).
- **`*inzsr`:** Initializes parameters and variables, gets system/runtime configuration, sets up key lists.

---

## 5. **Noteworthy Logic/Business Rules**

- **Product Type Filtering:** Only includes items of type 'L' (likely "lager" = stocked) or 'S' (possibly "skaffe" = to be fetched/on request).
- **Discontinued Items:** Items marked as discontinued (`utgått`) or with expired dates are handled with special flags.
- **Multiple Units Handling:** Tries up to three sales units to find a valid GTIN/EAN for labeling; falls back as needed.
- **Offer Periods:** Checks date/time to see if an item is in a campaign/offer period and applies offer price fields.
- **Sales & Inventory Metrics:** Records last sale/purchase date, sales for last 12 months and last month.
- **String Formatting:** Uses Norwegian-specific formatting (commas for decimal), and pads/cleans fields for external system compatibility.

---

## 6. **Modern Free-Format Additions**

- As of enhancement 7.06, uses free-format RPG for new external program calls (e.g., `CO402R`) and variable declarations.
- Incorporates system switches/parameters fetched at runtime for operational control.

---

## 7. **How to Onboard and Evolve**

- **Understand the master data structure:** How products, units, prices, and inventory are organized in the files.
- **Get familiar with external program interfaces:** Pricing, VAT, rounding, and conversion logic is in external RPG or CL programs.
- **Learn the Pricer format:** Changes or new requirements here will impact how the output string and fields are built.
- **Be attentive to Norwegian formatting and text cleaning:** Character translation (xlate), decimal/thousand separators.
- **Check enhancement markers:** All changes are commented with version numbers; newer code may be in free format.
- **Test with real data:** Especially for offers/campaigns and multi-unit products, due to the complexity of fallback logic.

---

## 8. **Summary Table: Key Concepts**

| Concept                   | Implementation/Notes                                           |
|---------------------------|---------------------------------------------------------------|
| **Product/Inventory selection** | Parameter-driven, multiple subroutines for various modes       |
| **Price fetching**             | Calls to external programs, handles offers and campaigns      |
| **GTIN/EAN management**        | Iterates through up to 3 sales units to find a valid GTIN     |
| **Sales statistics**           | Calculates over 1-month and 12-month intervals               |
| **Rounding & VAT**             | Applies relevant routines for correct financial amounts       |
| **Export format**              | Assembles a large delimited string for Pricer system         |
| **Redundancy avoidance**       | Maintains a log to avoid resending unchanged prices          |
| **Discontinued handling**      | Checks expiration dates and NOBB registry for status         |
| **On-demand/full exports**     | Controlled via run parameters and system switches            |

---

## 9. **Next Steps**

- Set up test cases for each export type (`les_fil`, `les_lager`, `les_vare`).
- Document or diagram key file relationships.
- Review external program documentation for precise parameter/format requirements.
- Plan for migration to fully free-format RPG for future maintainability.

---

**If you have further questions about specific subroutines, file structures, or a desire for a flowchart, feel free to ask!**