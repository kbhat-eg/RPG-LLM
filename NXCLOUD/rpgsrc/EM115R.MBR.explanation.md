# RPG Program Explanation – EM115R

This RPG/400 (ILE RPG, fixed-format) program is designed to update customer *payment bonus* records by copying from a "bonus template". The program operates on several physical files and manages bonus information for customers.

---

## 1. **Header and Documentation**

- `h option(*nodebugio) datedit(*dmy)`
  - Compiler directive: disables debug I/O and sets date editing to day-month-year.

- **Comments Section**
  - Describes the program, its system, name, purpose, customizations, and a change log.
  - Lists the usage of RPG indicators (LR = end program, rollup, rolldown, etc.), which are referenced throughout the code.

---

## 2. **File Declarations**

```rpg
fekboiu    uf a e           k disk    rename(ekbost:ekboiur)
fekboic    uf a e           k disk    rename(ekbost:ekboicr)
fekbeiu    uf a e           k disk    rename(ekbest:ekbeiur)
fekbtiu    uf a e           k disk    rename(ekbtst:ekbtiur)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
```
- Declares several files for update or input, using `RENAME` for record formats.
  - `ekboiu`, `ekboic`, `ekbeiu`, `ekbtiu` – different bonus/payment files.
  - `rkunl1` – customer file.

---

## 3. **Data Structure Declarations**

### *Local Data Area (LDA) Extraction*
```rpg
d                uds
d  l_dato               101    108
d  l_tek1               201    270
d  l_tek2               301    370
d  l_tek3               401    470
d  l_user               911    920
d  l_firm               944    946  0
d  l_fnav               951    980
```
- Declares fields mapped from the user data area (LDA), holding date, user, firm, and text fields.

### *Display Feedback Structure*
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Used to interact with display file feedback, e.g., cursor position.

---

## 4. **Working Variables and Keys**

- Variables are defined for keys and fields used in the bonus/customer files.
- There are working variables for dates, times, type codes, and constants.

---

## 5. **Main Logic – Bonus Template Copy Subroutine**

### **Clearing Old Records**

- The program starts by setting the `b_bonus` flag to *off*.
- Removes all old bonus records for the specified customer (`p_kund`) and bonus type (`p_tbot`) from the bonus files, except if a "lock" code (`eksper`) is set.
- For each bonus at the customer/type level:
  1. If not locked, all detail records for that customer and bonus combination (`ekbeiu`) are deleted.
  2. Then, the header/summary record itself (`ekboicr`) is deleted.

### **Writing New Bonus Type Information**

- After cleanup, checks if a bonus entry for the customer/type exists in the `ekbtiu` (customer bonus type) file.
- If not found:
  - A new header record is written with keys set from parameters and from the customer register (`rkkatg`) and firm (`w_firm`).
  - System time and user are stamped.

### **End of Program**

- Sets *INLR (Last Record) indicator on to end the program and release resources.

---

## 6. **Initialization Subroutine (\*INZSR)**

- Receives input parameters: `p_kund` (customer), `p_tbot` (bonus type), `p_hmnr` (??, possibly a sequence).
- Initializes key lists for various files using the working variables.
- Retrieves firm from the LDA and the current date/time.

---

## 7. **Key Lists for File Access**

- Key lists (`klist`/`kfld`) are defined for all major files so they can be used for CHAIN, SETLL, READE, etc.
- This makes keyed access to physical files more manageable.

---

## 8. **General Workflow**

1. **Initialization**
   - Parameters and environment variables loaded (\*INZSR).
2. **Processing**
   - For the given customer and bonustype:
     - Delete old bonus details, unless locked.
     - Delete bonus header.
     - Add new header if missing.
3. **Termination**
   - End program.

---

## 9. **Functional Highlights**

- **Customer and Bonus Handling:** Safely removes all traces of a bonus type for a customer, with safety checks for locked entries.
- **File Interactions:** Keyed access ensures only relevant records are processed.
- **Audit Trail:** Timestamps and user fields are maintained during creation.

---

## 10. **Notes**

- Many variable names are Norwegian or have business-specific meaning (`bonus`, `kund`, `boty`, etc.).
- The program appears to run in batch or as a called program, with little (if any) UI interaction.
- The business logic seems to focus on synchronizing bonus arrangements for a given customer, resetting their payment-bonus setup according to a template.

---