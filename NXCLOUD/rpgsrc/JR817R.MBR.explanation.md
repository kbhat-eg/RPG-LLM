# Program Documentation: JR817R

## Overview

**Program:** JR817R  
**System:** ASVADM  
**Purpose:**  
This program processes an input file with record format `INTEG` to create or update prices (`priser`) for existing items (`varer`) in the LVR system. It assumes that the item (identified by NOBB number) already exists in the VA (item master) file.

**Key Functions:**
- Reads item and associated price/packaging data from an input file.
- Updates or creates item price records in the LVR price file.
- Maintains related price surcharges (`påslag`) for each item.
- Ensures data consistency by removing old price/surcharge records before new creation.

---

## File Usage and Relationships

The program interacts with the following files, using specific record formats and key structures:

| File      | Usage       | Record Format | Purpose/Notes                        |
|-----------|-------------|--------------|--------------------------------------|
| JRVAPF    | Input, IF   |              | Main input file (with records 1,2,3) |
| JRAPL1    | Input, IF   | JRAPPLR      | Reporter/master data                 |
| JLEVL1    | Input, IF   | JLEVPFR      | Supplier/master data                 |
| JVARL3    | Input, IF   | JVARPFR      | Item master (lookup by NOBB)         |
| JVPRL1    | Input, IF   | JVPRPFR      | Price lookup (single record)         |
| JVPRLU    | Update, UF  | JVPRPFR      | Price update (multiple records)      |
| JPFAL6    | Update, UF  | JPFAPFR      | Surcharge update (single record)     |
| JPFALU    | Update, UF  | JPFAPFR      | Surcharge update (multiple records)  |

- All file access is keyed. Some files are renamed locally for clarity and to allow multiple usage of the same physical file with different formats.

---

## Data Structures

Several data structures are defined to represent the record layouts for items, packaging, and prices. Overlays are used for field extraction from flat records.

### Key Structures

- **Item Record (`d_vrec`)**: Holds all item-related data, including NOBB number, groupings, texts, EAN, and supplier info.
- **Packaging Record (`d_erec`)**: Holds packaging-related data (dimensions, units, EAN, etc.).
- **Price Record (`d_prec`)**: Holds price, date, EAN, and related pricing fields.

### Arrays

- **a_erec**: Array of packaging records (up to 99 per item).
- **a_prec**: Array of price records (up to 99 per item).

### Key Variables

- **w_firm**: Company code, extracted from input parameter.
- **w_etel/w_ptel**: Counters for packaging and price records per item.
- **w_rect**: Record type indicator ('1'=item, '2'=packaging, '3'=price).
- **b_frst**: Boolean, indicates if processing the first item in the batch.

---

## Program Flow

### Initialization

- The program receives a parameter list (`p_list`) containing company, reporter, and date.
- Local data structures and keys are initialized for file access.

### Main Logic

1. **Reporter Lookup**  
   - Uses reporter code to validate the reporter in `JRAPL1`.  
   - If not found, the program exits.

2. **Supplier Lookup**  
   - Uses supplier code from the item record to validate in `JLEVL1`.

3. **File Processing (`les_fil` Subroutine)**  
   - Reads through `JRVAPF` sequentially.
   - Records are classified by `w_rect`:
     - `'1'`: New item record. If not first, triggers processing of the previous item (`behandling`).
     - `'2'`: Packaging record. Stored in `a_erec` array.
     - `'3'`: Price record. Stored in `a_prec` array.
   - After the last record, processes the final item.

4. **Item Processing (`behandling` Subroutine)**
   - Checks if the item exists in `JVARL3` (by NOBB number).
   - If not found, skips further processing.
   - For each price in `a_prec`, attempts to update (`endr_pris`) or create (`oppr_pris`) the price in `JVPRLU`.
   - Calls external program `JV790R` to update search text for the item if needed.

5. **Price Creation (`oppr_pris` Subroutine)**
   - Deletes any existing price records for this item/supplier in `JVPRLU`.
   - Creates a new price record with the current input data.
   - Calls `dann_paslag` to handle surcharge creation.

6. **Price Update (`endr_pris` Subroutine)**
   - If the price has changed, updates the existing price record.
   - Calls `dann_paslag` to update surcharge.

7. **Surcharge Handling (`dann_paslag` Subroutine)**
   - Deletes any existing surcharge records for the item in `JPFAL6`.
   - If both sales and purchase prices are present, calculates the surcharge ratio and writes a new surcharge record.

---

## Business/Domain-Specific Logic

- **NOBB Number**: The NOBB number is a unique item identifier in Norwegian building materials industry.
- **Reporter/Supplier Validation**: Ensures data integrity by only processing items with valid reporter and supplier codes.
- **Price & Surcharge Model**: Only one price per item/supplier is allowed at a time. Old prices are deleted before new ones are created.
- **Surcharge Calculation**: The surcharge (`påslag`) is calculated as the ratio of sales price to purchase price, and is only stored if both prices are non-zero.
- **External Program (`JV790R`)**: Called to update search indexes or texts for the item after price changes.

---

## Notable Implementation Details

- **Record Type Handling**: The input file uses a flat structure where the first character of each record indicates its type (item, packaging, price). Arrays are used to accumulate related records before batch processing.
- **Overlay Usage**: Heavy use of `overlay` in data structures to extract fields from flat records.
- **File Renaming**: Files are renamed locally to allow multiple logical views (e.g., `JVPRPFR` as both `JVPRL1R` and `JVPRLUR`).
- **Key Lists (`klist`)**: Used extensively for all file operations, ensuring consistent and maintainable keyed access.
- **Field Movement**: Use of `movel` (instead of `eval`) for certain assignments, likely due to field length or type compatibility requirements.
- **Date/Time Stamping**: All updates and creations are timestamped using system time for traceability.
- **Conditional Surcharge Creation**: Surcharge records are only created if both sales and purchase prices are present and non-zero.

---

## Error Handling and Data Integrity

- **Missing Reporter/Supplier**: If a reporter or supplier is not found, the program skips processing for that entry.
- **Item Existence**: Only existing items (in `JVARL3`) are processed; new items are not created by this program.
- **Cleanup Before Create**: Old price and surcharge records are deleted before new ones are written, preventing duplicates.

---

## Conventions and Patterns

- **Naming**: Prefixes like `jv`, `jr`, `jc` indicate file or record type (item, price, surcharge, etc.).
- **Subroutine Structure**: Main processing is organized into clear subroutines (`les_fil`, `behandling`, `oppr_pris`, `endr_pris`, `dann_paslag`) for maintainability.
- **Parameter Passing**: Uses data structures for both input parameters and internal data passing.
- **Localization**: Some field and comment names are in Norwegian, reflecting the business domain.

---

## Integration Points

- **External Program Call**: Calls `JV790R` for updating search text after price changes.
- **Data Dependencies**: Relies on existing data in item master (`JVARL3`), reporter master (`JRAPL1`), and supplier master (`JLEVL1`).

---

## Summary

JR817R is a batch-processing program that reads structured item, packaging, and price data from a flat file, validates and updates the LVR system's price and surcharge records, and ensures data integrity through careful deletion and recreation of related records. The program is designed for environments where data consistency and traceability are critical, and it is tightly integrated with the LVR/VA master data infrastructure.