# Program Overview

This ILE RPG program (`FP219R`) is designed to print shelf labels (etiketter) in a warehouse/inventory environment. It reads records from a physical file (`vaw1pf`), processes the data according to business rules and printer types, and formats the output for various types of label printers. The code supports multiple label printers and label types, adjusting output commands and formats as required for each device.

The program's comments and variable names are primarily in Norwegian. "Vare" means item/product, "etikett" means label, "lagerplass" means storage location, etc.

---

## Structure and Key Sections

### 1. File Declarations

```rpg
fvaw1pf    if   f  512    64aidisk
fEtikett   o    f  132        Printer oflind(*inof)
```
- `vaw1pf` is the input file, likely a database of products/items
- `Etikett` is the output printer file, set up for label printers

---

### 2. Data Structures and Variables

- **Special variables for user, firm, item texts, etc.**, mapped to the program's *LDA (Local Data Area)* fields.
- **Working variables** for various fields like printer type, shelf type, alternative numbers, label data lengths, flags, etc.

---

### 3. Input File Layout

The `I` (Input) specification defines the layout of each field in the input record. Examples:
- `vaanta` (quantity), `vattxt` (item text), `vatvar` (item number), `vatenh` (unit), `vatpri` (price), `vadato` (date), `vabesk` (price code), `vaplas` (storage location), etc.
- Extended to handle up to 8-character shelf locations, alternative item numbers, minimum/maximum quantities, etc.

---

### 4. Main Program Logic

#### Record Reading Loop

```rpg
c     read      vaw1pf                                 61
c     dow       *in61 = *off
...
c     read      vaw1pf                                 61
c     enddo
```
- Reads input records in a loop; ends loop when no more records (*IN61=on after READ).

#### Printer & Label Type Filtering

```rpg
c     if        vaetyp <> 7
c     goto      neste
c     endif
```
- Processes only records where `vaetyp` (label type) is 7 (shelf label).

#### Per-Record Processing

- **Determine required printer/label layout codes**
- **Load/format fields for the label** (date, alternative numbers, price comparison, order info, shelf position, etc)
- **Choose and output device-specific formatting** using `EXCEPT` (printer control keywords)
- **Handles alternative item numbers, order points/amounts, price comparison units**
- **Formats supplier item number, trims and validates numerics**
- **Determines bar code type for output**
- **Handles label printing for various printer types:**
    - Meto 8100 (Twinax, Standard)
    - Meto Bandit
    - Meto mi-4
    - Datamax EX-2 (handled similar to mi-4)

#### Example: Selecting Bar Code Output

Depending on shelf type (`vahyle`), flags (*IN20-*IN23) are set to select between different bar code data (main item number, supplier item number, EAN, NOBB, etc).

#### Example: Preparing Supplier Item Number

```rpg
c     digits        check     valvar                                 90
c     if        *in90 = *on
c     movel     nuller        w_lvar
c     else
c     eval      w_lvar = %trim(valvar)
c     endif
```
- Checks if the supplier item number (`valvar`) is numeric only, if not, overwrite with zeros.

#### Example: Label Output

For each printer type, data is formatted with the required commands. For example:

- **Meto 8100 Twinax**:
  - Output is structured with control codes (`&02&20&03`, `&02&53000005&03`, etc.)
- **Meto 8100 Standard**:
  - Commands use curly braces (`{ ... }`)
- **Meto Bandit**:
  - Uses bracket format and text commands (`[M w "38.0:0:0:1"]`, etc.)
- **Meto mi-4 / Datamax Ex-2**:
  - Uses tilde commands (`~n`, `~c0000`, etc.)
- **Label fields** (`vatek1`/2, `w_best`, `w_altv`, `vaplas`, etc.) are inserted into output
- **Barcodes** change according to label type

---

### 5. End-of-Job Handling

```rpg
c     avslutt       tag
c     w_skty        ifeq      2
c     except    �end2
c     endif
c     eval      *inlr = *on
c     return
```
- Ends the output for the Bandit printer and returns/ends the job.

---

### 6. Output Specifications

- **O-specs** generate the actual control sequences for the printers.
- Each EXCEPT block (`�clr0`, `�pgm0`, `�data0`, etc.) is a template for a set of output lines for each printer/label scenario.
- Conditional output for optional fields and barcodes.
- "Antall etiketter" (number of labels) controlled by fields as well.

---

## Key Concepts

- **Device-Dependent Output**: The RPG program is highly device-dependent, generating specific control languages for each supported printer type.
- **Label Composition**: For each item, the program builds a label with item text, codes, barcodes, shelf info, and variable fields according to the label type and printer.
- **Flexible Data Handling**: Code supports conditional data formatting and output based on input data and settings.
- **Norwegian Business Logic**: All field names and comments use Norwegian, but the structure is typical for warehouse/inventory labeling.

---

## How to Extend or Modify

- **New printers**: Add new EXCEPT templates and output logic blocks.
- **New label types/fields**: Add new flags, input fields, and output lines.
- **Business rules**: Update `select`/`when` logic for data handling as needed.

---

## Common Onboarding Points

- **Understand printer command codes**: Each printer needs a different set of control codes—refer to printer manuals for adjustments.
- **Pay attention to field lengths and positions**: The I-specs must match the file's structure.
- **Bar code selection logic**: Know which field is used for each label.

---

## Summary Table

| Printer Type      | RPG Printer Type code | Output EXCEPT blocks | Output Syntax      |
|-------------------|----------------------|----------------------|--------------------|
| Meto 8100 Twinax  | 0                    | `�clr0`, `�pgm0`, `�data0` | `&02...&03...`|
| Meto 8100 Standard| 1                    | `�clr1`, `�pgm1`, `�data1` | `{...}`           |
| Meto Bandit       | 2                    | `�pgm2`, `�data2`, `�end2` | `[...]`           |
| Meto mi-4         | 4                    | `�data4`              | `~...`             |
| Datamax Ex-2      | 6                    | `�data4` (special flag 66) | `~...`             |

---

## Summary

This program reads item data and prints shelf labels using the correct format for the selected printer type, including support for barcodes and numerous label fields. Its logic and output are determined by both item data and programmable settings, with clear modularization for each supported device.

If onboarding, focus on:
- Understanding field mapping (input record layout)
- How conditional flags (*INxx) control output blocks
- How data is prepared (trimming, validation, selection)
- The structure of device-specific output "EXCEPT" templates

For updates, carefully coordinate RPG logic, input file I-specs, and output block structure to avoid format misalignments.