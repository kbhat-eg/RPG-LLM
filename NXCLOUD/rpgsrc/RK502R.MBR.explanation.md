# IBM ILE RPG Program: RK502R - Customer Inquiry

This program is called **RK502R** and is used for customer inquiry ("Kunder, sp√∏rring"). It is written in classic ILE RPG (fixed-format), and handles customer data, displaying various information and allowing the user to access more detailed records and related windows.

Below is a structured explanation with the main points and sections, so new developers can understand the program's flow, data usage, and maintenance history.

---

## 1. **Header and Documentation**
- **OPTIONS:**
  - `*NODEBUGIO` - Disables debug information for database I/O.
  - `*DMY` - Dates are in Day-Month-Year format.
- **Program description:** Customer inquiry.
- **Modification log:** Detailed entries noting version, date, and change description (mainly in Norwegian).

---

## 2. **Indicator Use Convention**
- RPG uses a set of indicators (`*IN01` - `*IN99`) for UI navigation, file status, error handling, etc.
- Example:
  - `KC` = *IN03 = F3 to exit
  - `KE` = *IN05 = F5 to refresh
  - `KL` = *IN12 = F12 to cancel
  - 60-69: File operations (e.g., CHAIN error)
  - 80-89: Working indicators

---

## 3. **File Declarations (F-Specs)**
- Several physical and logical files for customer, address, and posting information:
  - `RKUNL1`, `RAA1L1`, `APOSPF`, etc.
  - Most are declared as keyed input (I) files, some renamed for clarity.
- Workstation file (`RK502D`) for screen I/O.

---

## 4. **Data Definitions (D-Specs)**
- **Local Data:**
  - User, firm, and name fields from some area in the user space (`l_user`, etc).
- **Key variables** to use with CHAIN/SETLL/RETRIEVE for DB access.
- **Parameter variables**: Used for communication with subprograms (e.g., for fetching descriptions).
- **Work fields** for logic, error status, temporary display fields, etc.
- **Copybook include**: `RF020PAR` defines a data structure for an external program interface.
- **Initialization**: Some defaults set.

---

## 5. **Screen/Image Descriptions**
- Multiple screen formats/windows are referenced, each used for detailed display/view:
  - `C2BLD`: Main view
  - `F2WIN`: OFAK codes
  - `E2WIN`: Visiting address
  - `G2WIN`: Invoice customer/EAN
  - `K2WIN`: Auto giro
  - `I2WIN`: Distribution/shipment details
  - `J2WIN`: Agreement specification

---

## 6. **Main Routine Flow**

### a. Entry Point (`*INZSR`)
- Initializes variables.
- Gets firm and customer number from parameters.
- Loads key customer and status records from relevant files.

### b. Main Display Loop (`C2BLD`)
1. **Display Initial Screen** with `WRITE`.
2. **Fetch Customer Data** (CHAIN on customer file).
   - If found, moves DB fields to screen fields.
   - Fetches and displays related codes (e.g., address, payment, language, bank, etc).
   - Special logic to convert dates, handle not-found, or default values.
   - Fetches visiting address data and associated city by chaining into postal codes.
   - Fetches additional info (e.g., agreement spec, status, etc).

3. **Fetch "Tekster" (Texts):** Calls subroutine `XSR020` to retrieve/personally fetch explanatory texts for certain codes.

4. **Notepad Check:** Checks if a notepad entry exists for the customer and sets indicator on the screen if so.

### c. **User Navigation and F-key Handling**
- After displaying the main screen (`EXFMT C2BLD`), checks which F-key (indicator) was pressed and branches accordingly:
  - F3/F12 (Exit/Cancel): Exits the program.
  - F5 (Refresh): Calls posting subroutine.
  - Various others: Opens relevant windows/screens, makes calls to other programs (`RF210R` for contacts, `RF220R` for cards, etc).
  - If notepad requested or required, calls notepad program (`RF020R`) and returns.

### d. **Subroutines for Windows/Screens**
- Each window (`E2WIN`, `F2WIN`, `G2WIN`, etc) has a simple subroutine (`BEGSR...ENDSR`) which displays the window and waits for exit/cancel indicators.
- Some windows (like `I2WIN`) also call external programs to fetch and display correct descriptions for shipment, payment terms, carrier, etc.

---

## 7. **Supporting Subroutines**

### `XE2BLD`
- Calls `RK512R` to fetch transactions/postings for customer.

### `XE2WIN`, `XF2WIN`, `XG2WIN`, `XH2WIN`, `XI2WIN`, `XJ2WIN`
- Each handles display of specialized screens/windows and associated logic.

### `XSR020`
- Fetches and builds textual descriptions for various customer fields/codes by calling numerous reference programs (`RS703R`, `RS716R`, etc).
- Handles errors and assigns text to display fields.

---

## 8. **Keylists**
- Each logical file CHAIN or SETLL operation uses a pre-defined keylist for multi-part keys (firm + customer).
- Keylists give maintainability and modularity.

---

## 9. **Other Notes**
- Uses Norwegian variable and field names: e.g., `kunde` (customer), `navn` (name), `postnr` (postal code).
- Code includes compatibility and upgrade support by managing changes through version tags and inline comments.
- Program flow is modular and heavily organized around the subroutine-per-window paradigm, which is common for RPG display file programs.

---

### **Summary Table: Main Program Path**

| Action             | RPG Code/Section             | Description                                 |
|--------------------|-----------------------------|---------------------------------------------|
| Entry/init         | `*INZSR`                    | Init variables, fetch main data             |
| Write/display main | `WRITE B2CMD`, `EXFMT C2BLD`| Display main customer info                  |
| Fetch/assign fields| `MOVE`, `CHAIN`             | Field-by-field DB fetch and assignment      |
| F-key branching    | `IF *INKx = *ON GOTO XXX`   | Handle user navigation                      |
| Subroutines        | `XyyyWIN`, `XE2BLD`, etc    | Screen-specific logic, data fetch, calling  |
| Fetch texts/codes  | `XSR020`                    | Fills out descriptive texts per code fields |
| End/Exit           | `*INLR = *ON`, `RETURN`     | Clean end                                   |

---

## **KEY TAKEAWAYS**
- The program is a **modular, screen-driven customer inquiry** tool.
- **Data movement** between files and screen fields is explicit and thorough.
- **External programs** are used as lookups for code translation.
- **Navigation** is handled via F-keys mapped to indicators.
- **Well-structured subroutines** encapsulate each type of detailed view.
- **Modification tracking** and version control is rigorous and well-documented.

---

**A new developer should review the related display (DSPF) files, the external lookup programs, and the customer file layouts to fully understand the data flow. The program is typical for classic RPG business applications, with strong conventions and modularization.**