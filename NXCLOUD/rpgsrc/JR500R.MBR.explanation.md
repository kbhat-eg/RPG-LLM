# RPG Program Explanation: JR500R

This RPG/400 (ILE RPG) program is a classic inquiry and reporting routine, using subfiles for data display and selection. The code is well-documented in Norwegian and implements a user interface driven by a subfile for displaying and selecting records, with various function keys for navigation and selection.

Below is an explanation organized by function and code sections.

---

## **1. File Declarations**

```rpg
fjrapl1    if   e           k disk    rename(jrappfr:jrapl1r)
fjrapl2    if   e           k disk    rename(jrappfr:jrapl2r)
fjr500d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- `fjrapl1` and `fjrapl2`: Input files, likely representing two logical views over the same physical file, perhaps sorted by different keys (e.g., by reporter or by name).
- `fjr500d`: Display file with a subfile (`b1sfl`, using `w_srrn` as record number) for the subfile display. The `infds(dspfbk)` clause provides feedback from the display file such as cursor position, etc.

---

## **2. Data Declarations**

**Parameters:**
```rpg
d p_firm          s                   like(jrfirm)
d p_rapp          s                   like(jrrapp)
d p_navn          s                   like(jrnavn)
```
- Program parameters representing firm code (`jrfirm`), reporter (`jrrapp`), and name (`jrnavn`).

**Display Feedback:**
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Feedback data structure to get current cursor record in the subfile.

**Variables (keys, working vars, constants):**
```rpg
d jrapl1_rapp     s                   like(jrrapp)
d jrapl2_navn     s                   like(jrnavn)
...
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
...
d c_sfil          s              2  0 inz(8)
```
- Various variables used for subfile management, cursor and paging, etc.
- Constants: `c_sfil` sets the subfile page size to 8 records.

---

## **3. Indicator Usage**

```rpg
*       LR = End of program
*       10 = Roll (page down)
*       11 = Rolldown (page up)
*       12 = Sfldsp (display subfile)
*       13 = Sfldspctl (display control)
*       14 = Sflclr (clear subfile)
*       15 = Sflend (end of subfile)
*       21 = Home-key
*       22 = Cursor positioning
*       30 = Field protection
*    31-79 = Error/Warning indicators
*    80-99 = Work indicators
```
- Classic RPG III/400 approach using numbered indicators for display logic and flow control.

---

## **4. Main Control Flow (Program Logic)**

The main part of the program is a loop, driven by display and subfile operations, which reacts to user input (function keys, cursor, etc.).

### **Entry Point and Initial Display**

- The program starts at tag `b2taga` (send the "command" panel).

```rpg
c     b2taga        tag
c                   write     b2cmd
```
- Shows the command panel, possibly listing function key options.

### **B2TAGB: Main Subfile Work Area**

```rpg
c     b2tagb        tag
c                   exsr      dsp_subfile
```
- Enters subfile display logic.

#### **Function Key Handling**
```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inke
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   when      *in11
c                   exsr      bck_subfile
c                   goto      b2tagb
c                   when      *in21
c                   eval      *in22 = *on
c                   goto      b2taga
c                   endsl
```
- Function keys detected by indicators:
  - F3/F12 (`*INKC`/`*INKL`): Exit program.
  - F5 (`*INKE`): Refresh subfile.
  - F10 (`*IN10`): Page forward.
  - F11 (`*IN11`): Page back.
  - F21 (`*IN21`): Home/cursor; triggers custom positioning.

#### **Custom Positioning**

```rpg
c                   if        b2navn <> *blank or b2rapp <> 0
c                   exsr      posisjoner
c                   goto      b2tagb
c                   endif
```
- Allows the user to position the subfile by name or reporter.

#### **Default Subfile Handling and Exit**

```rpg
c                   exsr      subfile
c                   if        b_valg_ok = *on
c                   goto      avslutt
c                   endif
c                   goto      b2taga
```
- Handles subfile display and selection. If selection is made (`b_valg_ok = *on`), program exits.

### **Program Exit**

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Standard end-of-program sequence.

---

## **5. Subroutines (EXSR)**

### **Forny (Refresh Subfile)**
- Re-positions the database depending on which sequence (by reporter or name) is active.
- Clears and re-creates the subfile.

### **Posisjoner (Position Subfile)**
- Positions the subfile list to a specific name or reporter, depending on input fields provided.
- Clears and refills the subfile based on new position.

### **Subfile (Selection)**
- Handles reading subfile records and checking for a user selection (e.g., a "select" field is set to 1).
- On selection, sets output parameters and signals to exit.

### **clr_subfile (Clear Subfile)**
- Activates clear subfile indicator, writes control record, resets record counters.

### **crt_subfile (Create/Fill Subfile)**
- Adds up to `c_sfil` (default 8) new entries into the subfile, starting where the current list left off.
- Reads next batch of records from the appropriate file (by reporter or by name).

### **bck_subfile (Page Back)**
- Handles paging backward in the subfile (using RPG's read previous, `readp`).

### **dsp_subfile (Display Subfile)**
- Displays the subfile or command panel, depending on context.
- Tracks first record number for paging.

### ***inzsr (Program Initialization)**
- Loads parameters passed into the program.
- Sets up key lists, initializes display, positions the database, and fills the first page of the subfile.

---

## **6. Subfile Mechanism**

- Uses RPG's classic subfile approach:
  - Subfile record format: `b1sfl`
  - Control record format: `b2ctl`
  - Fills the subfile with 8 records per page, supports page forward/backward, selection, and positioning.
  - Uses indicators (`*IN12`, `*IN13`, ...) for subfile display, control, field protection, etc.
  - Field values such as `w_srrn`, `w_fcrn`, etc., keep track of subfile position, loaded records, and paging state.
  - Supports both sequence by "name" or "reporter" toggled by `w_seqe`.

---

## **7. Overall Behavior**

The program presents a list of records in a subfile, allowing the user to page forward or backward, select a record, and perform positioning by name or reporter. It responds to function keys as per IBM i panel standards. Selected data is passed out via program parameters.

---

## **Summary Cheat Sheet**

- **File access:** Two logical files for browsing; record selection uses a subfile.
- **Display:** Subfile for list; command/control panels for action keys.
- **Navigation:** Page up, down, home, refresh, and position-by-field.
- **Selection:** User can select a record; result is returned in parameters.
- **Exit:** Standard RPG exit with LR and return.
- **Indicators:** Classic RPG indicator usage for display logic.

---

## **Legacy RPG Notation**

- This program is written in RPG/400 or early ILE RPG style (fixed format, C-specs, indicator variables, manual parameter passing).
- For onboarding, familiarity with subfile processing, indicator-driven logic, and the RPG cycle is essential.

---

**Bottom line:**  
This is a robust, traditional subfile inquiry/select program—for instance, to let a user choose a report or entity by name or ID—with paging, search/positioning, and classic RPG subfile techniques.