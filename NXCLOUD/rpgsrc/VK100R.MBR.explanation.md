# RPG Program VK100R – Onboarding Guide

This RPG (ILE RPG, fixed format) program, documented in Norwegian, is designed for maintaining product group assignments ("Varegruppeknytning, vedlikehold") within an IBM i environment. Below is a comprehensive breakdown that should help new developers understand its structure and flow.

---

## 1. High-Level Purpose

The program is primarily a maintenance interface for assigning or managing the relationships between products and product groups (overgroups, main groups, subgroups, and suppliers). It supports viewing, adding, copying, deleting, and updating relationships via a subfile-driven display.

---

## 2. Program Structure Overview

- **File Declarations:** Multiple logical and update files, mainly handling product group data, alternative group data, and supplier data.
- **Subfiles and Workstn Display:** Use of subfiles for displaying sets of records and allowing batch operations.
- **Data Structures:** For indicator management, feedback information, and key handling.
- **Key Lists:** For various setll/read/chain operations.
- **Main Logic:** Mostly driven by subroutines (`begsr`/`endsr`), tags, and indicator-based branching.
- **Field Usage:** Many fields and variables are "LIKE" definitions, inheriting types from elsewhere (likely from a /COPY or externally defined DDS).

---

## 3. File Definitions

```rpg
fvvgkl1    if   e           k disk    rename(vvgkpfr:vvgkl1r)
...
fvvgklu    uf a e           k disk    rename(vvgkpfr:vvgklur)
...
fvk100d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- **fvvgkl1..fvvgklu:** Logical files for various levels/groups and an update file for group assignments.
- **fvogrl1, fvhgrl1, fvugrl1:** Files for overgroup, main group, and subgroup details.
- **frlevl1:** Supplier details.
- **fvaugl1:** Alternative group details.
- **fvk100d:** Display file, with subfile B1SFL and various records for controlling the screen.

---

## 4. Indicator Usage

The program uses classic RPG indicators for UI and program flows:

- `LR`: Last record, triggers program exit.
- 10–15: Subfile navigation (roll up/down, display, clear, end).
- 30: Field protection.
- 31–79: Screen/message error indicators.
- 80–99: Work indicators.

---

## 5. Key Variables and Structures

- **Local Data Area (LDA):** Used for passing user and firm info.
- **Feedback Data Structure:** Used for retrieving the current record (cursor) on screen.
- **Key Variables:** A comprehensive set of variables defined to be used as key fields for data operations (e.g., for chaining or setting a position in a file).

---

## 6. Main Program Flow

### **Entry Point and Loop**

- **Initial Entry:** Program execution starts at tag `b2taga` and cycles through UI display and function key handling in a "menu loop" style.
- **Display Subfile:** Shows the main subfile with records, handles function key input.
- **Function Key Handling:** Selects among exit, refresh, create, rollup/rolldown, positioning, etc.

### **Subfile Management**

- **clr_subfile:** Clears the current subfile display.
- **crt_subfile:** Loads records into the subfile from the database, according to the active level or filter (overgroup, main group, etc.).
- **bck_subfile / forny:** Handles page navigation (forward/backwards) and refreshing after changes.

### **Record Operations**

- **xc1bld:** Handles the "create new row" operation (new assignment).
- **xc1msg:** Displays a message if a row already exists.
- **xc2bld:** Handles editing, copying, and viewing details on individual assignments.
- **xd1win:** Handles delete confirmation and record deletion.
- **xk1win:** Handles the copy operation.

### **Data Validation and Query**

- **sjekk_input:** Validates entered key fields and fetches descriptions for display.
- **hent_info:** Loads descriptions based on the currently entered group levels.
- **spørring:** Handles lookups for group and supplier fields via external "search" programs.

---

## 7. Subroutines Detail

### **Subfile Paging/Navigation**

- **bck_subfile & crt_subfile:** 
    - These fill the subfile buffer as user pages up/down, using setll/read and corresponding keys based on the sequence level (overgroup, main group, subgroup, etc.).
    - The subfile screen size is configurable (`c_sfil`), typically 12 records.

### **Screen to DB Synchronization**

- After each operation (create, update, delete, copy), the subfile is refreshed to display the latest data.

### **Function Key Mapping**

```rpg
select
   when *inkc or *inkl
      goto avslutt
   when *inke
      exsr forny
      goto b2tagb
   ...
```
- Maps PF-keys to branching logic.  
    - KC/KL: Exit
    - KE: Refresh/renew
    - KF: Create/new entry
    - 10/11: Paging
    - 21: Positioning

### **External Program Calls**

Many lookups for field values use external programs (`VG510R`, `VG511R`, `VG512R`, `RL500R`, `VF510R`, `VF511R`). These act as pop-up selection/search dialogs.

---

## 8. Special Field & Screen Explanation

- **w_fcrn, w_srrn, w_ssrn, w_virn**: Track current, relative, and virtual positions in the subfile.
- **w_afld**: Active field name (used for context-sensitive lookups).
- **b1sfl, b2ctl, ...**: Screen records for subfile entry, subfile control, command line, and window overlays (copy, delete, etc.).

---

## 9. Error Handling & User Feedback

- The program sets indicators (e.g., *in31, *in32, etc.) to trigger messages or error highlighting on the UI.
- Use of explicit "message windows" and validation screens to ensure a robust edit/validation loop.

---

## 10. Initialization

- In `*inzsr`, the program:
    - Initializes all file key lists.
    - Pulls in company code from LDA.
    - Sets initial positioning for the subfile.
    - Loads the first page of data.

---

## 11. Additional Notes

- **Naming Convention:** Most variable prefixed with 1–2 characters indicating their context: b1 (subfile entry), c1 (create), d1 (delete), k1 (copy), etc.
- **Extensibility:** Many routines can be extended easily to add new function keys or new subgroup/level handling.
- **External Programs:** All value help and validations for group fields and suppliers are delegated to standard search programs, making UI code quite clean.

---

## 12. Summary Table

| Section         | Key Functionality                       |
|-----------------|----------------------------------------|
| File Section    | Database and display file declarations  |
| DS/Vars         | Key fields, LDA, work variables         |
| Indicators      | All UI and work logic                   |
| Main Loop       | Menu/UI loop, key handling              |
| Subroutines     | CRUD for assignments, paging, UI logic  |
| External Calls  | Lookups for groups/suppliers            |
| Error Handling  | UI indicators, message screens          |
| Initialization  | Key lists, first subfile fill           |

---

## 13. Suggestions for New Developers

- **Get familiar with subfiles** in RPG: how the cycle of clear/fill/display works.
- **Check the DDS** for display file VFK100D for exact screen layouts and indicator usage.
- **Learn external value-help programs** (VG510R, etc.).  
- **Study key list management:** Sets and chains are central for positioning file access and for updates.
- **Test changes with various group/supplier combinations** to understand the navigation logic.

---

This guide should give you a strong foundation for understanding, maintaining, and extending the program VK100R. If you have further questions, refer to the comments in the source code (they are quite thorough), or reach out to team members familiar with the value-help and back-end files involved.