# Documentation: Program FP266R – Export File Generation for Electronic Shelf Labels

---

## Overview

**Program:** FP266R  
**System:** ASOFAK  
**Purpose:**  
Automates the generation of an export file for electronic shelf edge labels (ESL).  
Reads inventory and product master data, collects essential product information (units, sales price, promotional price), and formats it for export.

---

## Business Context

- **Domain:** Retail inventory, pricing, and shelf labeling.
- **Main Function:** Prepares and exports product data for integration with an ESL system, ensuring up-to-date price and product information on store shelves.
- **Data Sources:** Product master, inventory, EAN/GTIN registry, supplier, sales, and purchasing history.

---

## Key Features and Logic

### 1. **Entry Point and Parameter Handling**

- **Parameters:** Warehouse (p_lage), selection type (p_alle), export file name (p_filg), company (p_firm), status (p_stat).
- **Selection Logic:**  
  - `P`: Process from parameter file (`les_fil`)
  - `L`: Process all items in a warehouse (`les_lager`)
  - `A`: Process all items (`les_vare`)
- **Logging:** Updates a log record indicating the export file was generated.

---

### 2. **Data Files and Relationships**

- **Master/Product Data:**  
  - `vvarl1` (Product master)
  - `vlagl2` (Inventory per warehouse)
  - `veanl1` (EAN/GTIN registry)
  - `rlevl1` (Supplier master)
- **Sales/Purchasing:**  
  - `sistl2`, `sstal2`, `sstal2` (Statistics)
  - `lodtlv`, `fodtlv` (Order lines)
  - `lohel1`, `fohel1` (Order headers)
- **ESL Export:**  
  - `vetxpf` (Export file)
  - `vetllu` (ESL update log)
- **Auxiliary:**  
  - `jvpkl3` (GTIN registry with length/type)
  - `aelhlu` (Export file log)

---

### 3. **Main Processing Flows**

#### a. **Process by Parameter File (`les_fil`)**
- Reads EANs from a parameter file (`autppf`).
- For each EAN:
  - Looks up in EAN registry.
  - Retrieves product master data.
  - Applies business filters (product type, etc.).
  - Fetches price, prepares data, writes to export.

#### b. **Process by Warehouse (`les_lager`)**
- Reads all items for a warehouse from the inventory file.
- For each item:
  - Gathers location, stock, min/max, etc.
  - Fetches product master data.
  - Applies business filters.
  - Fetches price, prepares data, writes to export if GTIN present.

#### c. **Process All Products (`les_vare`)**
- Iterates over all items in the product master.
- Same downstream logic as above.

---

### 4. **Subroutine Highlights**

#### a. **Price Fetch and Calculation (`hent_pris`, `klar_pris`)**
- Calls external pricing programs (`VX716R`, `VX720R`) to retrieve prices for up to three units (base, comparison, promotional).
- Handles campaign logic:  
  - If campaign K750, suppresses promo price.
  - Ensures promo price is only used if lower than regular price.
- Calculates VAT using external programs (`FØ705R`, `FØ706R`).
- Rounds prices using external program (`FX910R`).
- Handles price group, unit conversions, and comparison prices.

#### b. **Data Preparation for Export (`klar_rest`)**
- Fetches supplier name.
- Calculates last purchase and sales dates, quantity sold in last month/year.
- Converts product texts to valid format (removes invalid characters).
- Fetches purchasing unit and cost price (`VX750R`).
- Flags discontinued products.

#### c. **Export Record Write (`skriv`)**
- Formats all gathered information into a single export record.
- Handles GTIN length logic (8, 12, 13, 14 digits) via `jvpkl3`.
- Writes to export file (`vetxpf`).
- Updates/creates log entry in ESL update log (`vetllu`).

#### d. **Unit Conversion Factor (`hent_omr`)**
- Calculates conversion factors between different units for sales statistics normalization.

#### e. **Program Initialization (`*inzsr`)**
- Sets up keys, initializes variables, retrieves company-level settings.

---

## Notable Design Decisions & Patterns

- **External Program Calls:**  
  - Pricing, VAT, and rounding logic are delegated to external service programs, ensuring consistency with business rules and reusability.
- **Business Rule Implementation:**  
  - Only products of certain types (`L`, `S`) are processed.
  - Special handling for campaign products (e.g., K750).
  - Promo price is only used if lower than the regular price.
- **Flexible Data Selection:**  
  - The program can process a subset (parameter file), by warehouse, or all products, supporting different operational needs.
- **GTIN Handling:**  
  - Dynamically determines correct GTIN length to export, using a dedicated registry.
- **Audit and Logging:**  
  - All export actions are logged for traceability, both in file and ESL logs.

---

## Key Variables and Fields

- `w_pri1`, `w_pri2`, `w_pspr`: Prices for main, secondary, and comparison units.
- `w_enh1`, `w_enh2`, `w_enps`: Units for the above prices.
- `w_tfda`, `w_ttda`, `w_tfti`, `w_ttti`: Promo price valid date/time range.
- `w_eann`: GTIN/EAN for the product/unit.
- `w_desc`, `w_des2`: Product descriptions.
- `w_lok1`, `w_lok2`, `w_lok3`: Warehouse location fields.
- `w_skaf`, `w_prik`: Product flags (special order, net price).
- `w_salg1`, `w_salg12`: Sales quantities (last month, last 12 months).
- `w_kjdt`, `w_sadt`: Last purchase and sales dates.
- `w_utga`, `w_utgat`: Discontinued product indicators.

---

## Integration Points

- **Pricing & VAT:**  
  - `VX716R`, `VX720R`, `VX750R`, `FX910R`, `FØ705R`, `FØ706R`
- **GTIN Registry:**  
  - `jvpkl3` for GTIN type/length
- **ESL System:**  
  - `vetxpf` (export file), `vetllu` (update log)
- **Inventory & Master Data:**  
  - Multiple files for products, inventory, EAN, supplier, statistics

---

## Special Considerations

- **Performance:**  
  - Contains logic to limit test runs (commented out in production).
- **Data Quality:**  
  - Text fields are sanitized for special characters.
  - Only products with valid GTIN/EAN are exported.
- **Extensibility:**  
  - Modular subroutine structure allows for easy updates as business rules evolve.
- **Internationalization:**  
  - Handles Norwegian characters and date formats.

---

## Version History Highlights

- **210318:** Optimization to run only necessary subroutines.
- **181018:** Special campaign handling (K750).
- **130818/190918:** Price and GTIN enhancements.
- **211119:** Export product description for all selections.
- **301122:** Extended parameter list for price fetch programs.

---

## Summary

FP266R is a central batch utility for preparing product and pricing data for electronic shelf edge label systems. It integrates with core master data, pricing engines, and sales/purchasing statistics, applying complex business rules to ensure only valid, up-to-date, and relevant information is exported. The program is highly parameterized and modular, supporting various operational scenarios and future business changes.