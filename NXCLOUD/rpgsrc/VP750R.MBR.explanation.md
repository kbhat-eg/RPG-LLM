# VP750R – Documentation

## Purpose

This program, `VP750R`, is responsible for determining the correct purchase unit (enhet), cost price (kostpris), and purchase price (innkjøpspris) for an item (vare) in a given company (firma), based on a set of input parameters: company, item, price group, delivery type, and date. It is primarily used to fetch the primary purchase unit and associated prices, with fallback logic to ensure a price is always returned, even if some specific data is missing.

The program is highly domain-specific, dealing with the Norwegian inventory and pricing system, and integrates with several master and transaction files for item, unit, and price information. 

## Inputs and Outputs

**Inputs (via parameter list):**
- Company (firma)
- Item number (vare)
- Price group (prisgr)
- Delivery type (lev.type)
- Date (dato)
- (Optionally) Campaign/offer code (kampanje)

**Outputs (via parameter list):**
- Unit (enhet)
- Cost price (kostpris)
- Purchase price (innkjøpspris)

If the purchase price is not found, it is set equal to the cost price.

## File Dependencies

- `vvprl1` (Item price register)
- `vvenl4` (Item unit register - purchase units)
- `vvenl2` (Item unit register - sales units)
- `vvarl1` (Item master)
- `vtill9` (Campaign/offer register)
- `vveppf` (Item-unit-price group, via SQL)

## Key Business/Domain Logic

### Price Resolution Strategy

1. **Primary Source:** Attempt to find the purchase price for the item's primary purchase unit (enhet 1) in the price register.
2. **Fallbacks:**
   - If not found, check all purchase units for the item.
   - If still not found, check all sales units.
   - If no purchase price is found, set purchase price = cost price.

3. **Campaign/Offer Handling:**  
   If a campaign code is provided, check if there are special prices in the campaign/offer register. Prices from campaigns are only used if they are specified for the unit, and conversion factors are not applied (to ensure the price is valid for the specified unit only).

4. **Price Group and Delivery Type:**  
   The program tries to match on the given price group and delivery type, with fallback logic:
   - If no price is found for the specified price group, try with a blank price group.
   - If no price is found for the specified delivery type, try with delivery type 0.

### Special Handling

- **Multiple Purchase Units:**  
  If multiple purchase units exist, the program prefers the one marked as primary (`vepbes = 1`) and follows the sequence from the item-unit-price group file.
- **Supplier Resolution:**  
  The program calls an external program (`VL721R`) to resolve the supplier for the item and warehouse.
- **Date Validity:**  
  All price records are checked for validity against the given date.

### SQL Usage

- The subroutine `sjekk_vvep` uses embedded SQL to select purchase units from `vveppf` (joined with `vvenpf`) that are bestillbare (orderable), prioritizing those marked as primary and ordering by sequence. This allows for flexible handling of items with multiple purchase units.

## Program Structure

### Initialization (`*inzsr`)

- Sets up input/output parameters.
- Initializes keys for file access.
- Sets working variables for company and date.
- Ensures output parameters start blank/zeroed.

### Main Logic

1. **Supplier Lookup:**  
   Calls `VL721R` to determine the supplier for the item and warehouse.
2. **Item Master Chain:**  
   Reads item master to confirm existence.
3. **Purchase Unit Price Group Check:**  
   Calls subroutine `sjekk_vvep` to see if there are any special purchase units/prices.
4. **Purchase Unit Loop:**  
   Loops through purchase units (from `vvenl4`), attempting to fetch price info.
   - Tries, in order: supplier for warehouse, main supplier, and finally supplier 0.
5. **Sales Unit Loop (Fallback):**  
   If no purchase unit price is found, loops through sales units (from `vvenl2`) as a fallback.
6. **Final Fallback:**  
   If still no purchase price, sets purchase price = cost price.

### Subroutines

#### `hent_pris`

- Attempts to find price information for the current unit.
- If a campaign code is provided, checks the campaign/offer register for matching prices, including fallback to blank price group.
- If no campaign price is found, reads the item price register (`vvprl1`) for matching records, with fallback logic on delivery type and price group.
- Sets output parameters if a valid price is found.

#### `sjekk_vvep`

- Uses SQL to fetch all purchase units from `vveppf` joined with `vvenpf`, prioritizing those marked as primary (`vepbes = 1`) and ordered by sequence.
- For each unit, checks if it is the primary purchase unit.
- For each found unit, attempts to fetch price info using the same supplier fallback logic as main.
- Returns as soon as a price is found.

## Design Decisions and Conventions

- **Fallback Logic:**  
  The program is defensive, ensuring a price is always returned (even if the purchase price must be defaulted to cost price).
- **Extensive Use of Subroutines:**  
  Business logic for price resolution is encapsulated in subroutines for maintainability.
- **SQL Integration:**  
  Uses embedded SQL for complex queries (notably in handling multiple purchase units), which allows more flexible and efficient data retrieval than native record-level access.
- **Key Lists:**  
  Key lists (`klist`) are used extensively to standardize file access and make key composition clear and consistent.
- **Parameter Passing:**  
  All I/O is via a parameter list, typical for callable RPG programs in this environment.
- **Date Handling:**  
  Dates are always checked for validity to ensure that only current/valid prices are used.

## Interactions with Other Modules

- **VL721R:**  
  Called to determine the supplier for a given item and warehouse.
- **Database Files:**  
  Reads from several files (see above), including via SQL.
- **Campaign/Offer Register:**  
  Special logic for campaigns/offers, with specific rules when a campaign code is provided.

## Notable Patterns

- **Multi-level Fallback:**  
  Repeated pattern of trying the most specific match first, then falling back to less specific matches (e.g., price group, delivery type).
- **Direct File Access and SQL:**  
  Mixes native file access for standard lookups and embedded SQL for more complex, cross-file queries.
- **Switches and Flags:**  
  Uses boolean flags (`b_pris`, `b_inlr`) to control flow and indicate when a price has been found.

## Summary

This program is a robust, business-critical component for resolving the correct purchase unit and prices for items, with comprehensive fallback logic and special handling for campaigns and multiple purchase units. It interfaces deeply with the item, unit, and price master files, and uses both traditional RPG file access and embedded SQL for flexibility and performance. The logic is tailored to the domain's requirements for price validity, supplier specificity, and campaign handling, ensuring accurate and reliable pricing information for downstream processes.