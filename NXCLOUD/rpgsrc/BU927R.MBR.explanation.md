**Overview**  
This program (BU925R) is part of the ASSHOP system. Its primary responsibility is to retrieve and calculate the final price and discounts for a given item (varenummer) and unit (enhet) combination, based on various parameters such as customer (kunde), warehouse (lagr), and date (prisdato). It performs lookups against local files and then calls external programs to obtain additional pricing information. Finally, it performs its own net price calculation, which includes handling multiple types of discounts (rabatt and bruksrettsrabatt).

---

## Purpose and Flow

1. **Parameter Initialization (Entry Parameters)**  
   - The program receives a set of input parameters such as:
     - Firm (p_firm)  
     - Customer number (p_kund)  
     - Customer project (p_kpro)  
     - Item number (p_vare)  
     - Unit (p_enhe)  
     - Delivery type (p_lety)  
     - Warehouse (p_lagr)  
     - Price date (p_dato)  
     - Customer club indicator (p_klub)  
   - It also declares output parameters to return values such as:
     - Calculated sales price (p_sapr)  
     - Discount percentages (p_rab1, p_rab2)  
     - “Usage rights” discount percentages (p_brr1, p_brr2)  
     - Pricing code (p_kpri)  
     - Campaign code (p_kamp)  
     - Net price (p_netp)  
     - Cost price (p_kopr)  
     - A status/error indicator (p_stat)  

2. **Validation of Vare and Enhet**  
   - The program first checks if the item (`vvarl1`) exists. If not found, `p_stat` is set to 1 and it exits.  
   - Next, it checks the item/unit combination in `vvenl1`. If that record does not exist, `p_stat` is set to 2 and it exits.  

3. **Lookup of Customer Discount Category**  
   - The program checks the `rkunl1` file with the provided customer number to retrieve the customer’s discount category (`rkrabk`). If not found, the discount category is set to 0 by default.

4. **Constructing the Input Data Structure for the Price Program**  
   - A data structure (`hirec`) is populated with all necessary information:  
     - Firm / Discount category / Item / Unit / Date / and various flags.  
   - Notice that the code sets additional fields such as time (`hitime`) and numeric or code fields to default values (`0` or blanks).  

5. **Calling the External Program (VP900R)**  
   - Once `hirec` is ready, the program calls `VP900R` with two parameters:  
     - `hirec` (input)  
     - `horec` (output)  
   - After `VP900R` completes, the output data structure (`horec`) is parsed to fill the program’s output parameters (`p_sapr`, `p_rab1`, `p_rab2`, etc.).  

6. **Net Price Calculation**  
   - The program locally calculates a net price (`p_netp`) after applying multiple layers of discounts:  
     - Two generic discounts (`p_rab1`, `p_rab2`)  
     - Two “usage rights” discounts (`p_brr1`, `p_brr2`)  
   - Each discount is computed cumulatively on the (sales price minus all previously applied discounts). The result becomes the final net price that is returned through `p_netp`.

7. **Finalization**  
   - The code sets the LR indicator (`*inlr`) to `*on` at the end, concluding the program’s execution.  

---

## External References and Interactions

1. **VP900R**  
   - The main pricing engine. BU925R prepares `hirec` with key item, customer, and date details, calls VP900R, and retrieves values in `horec`. VP900R presumably handles standard price acquisition logic shared across the system.

2. **VL712R**  
   - Called to retrieve or derive a “price group” (w_prgr) based on the firm/warehouse combination. This is critical in certain pricing scenarios that group items or warehouses together.

3. **BL710R** (Previously VL710R)  
   - Retrieves the item type (w_vtyp) and related data, such as the “leverandør” (supplier). This is relevant for extended logic around items that might require special processing or discounts.

4. **Files**  
   - `rkunl1` (Customer file) – Identifies the customer’s discount category (rkrabk).  
   - `vvarl1` (Item master file) – Verifies existence of the item.  
   - `vvenl1` (Item/Unit details) – Checks if the unit is valid for that item.

---

## Notable Design Points

- **Use of KLIST / KFLD**  
  Key lists (klist) are used for each file to assemble compound keys (firm + customer/item/unit). This is a common way in this codebase to keep the file access consistent and maintainable.

- **Managing Different Discount Types**  
  The code handles both a generic discount (p_rab1, p_rab2) and a “usage rights” discount (p_brr1, p_brr2). Their calculation is additive on the sales price (p_sapr). This layered approach to discounting is a local business rule.

- **Status/Error Handling**  
  The `p_stat` indicator is used to store error codes (1 or 2) when the item or item/unit combination is not found, preventing unhandled conditions later in the pricing logic.

- **Overlay Data Structures (hirec/horec)**  
  Instead of passing multiple fields individually to VP900R, the code places them into well-defined data structures using `overlay`. This approach makes it easier to adapt if the external program’s interface changes, as long as the overall structure alignment remains consistent.

- **Customer Club Flag**  
  Field p_klub is explicitly carried from the input, through the call to VP900R, and back out again. It influences whether special club discounts or logic apply.

---

## Summary

BU925R is a specialized program that retrieves and calculates the final net price for an item/unit combination using multiple logic steps:

1. Validate item and unit.  
2. Determine customer-specific discount category.  
3. Call the main pricing program (VP900R) to pick up base prices, discounts, and other price-related data.  
4. Perform any additional discount combining (including “usage rights” discounts).  
5. Return the final net price to the caller.  

Its design follows a pattern of using local file lookups and external programs (VP900R, VL712R, BL710R) to keep core pricing logic consistent across the system and to handle specialized domain rules for discounting and net price calculation.