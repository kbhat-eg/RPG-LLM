## Program Overview

This program, **HR130R**, is part of the ASLAGR system and is designed for use with radio terminals in the warehouse receiving process ("varemottak"). Its primary function is to validate and process order parameters entered by the user, and then to launch the actual registration program (HR131R) for warehouse receipt transactions. The program is interactive, operating with a workstation display file.

The code is heavily customized for business logic related to order handling, item lookup (including EAN, supplier, and internal numbers), and supplier validation. It also makes use of several external programs and files for lookups and validations.

---

## Key Files and Data Areas

- **Physical Files:**
    - `vvarl1`, `vvarl3`, `vvarl4` (item master, NOBB number, supplier item number)
    - `rlevl1` (supplier master)
    - `lohelr` (order header)
    - `votyl1` (order type, for business rule validation)
- **Workstation File:**
    - `hr130d` (screen display)
- **Local Data Area:**
    - Used to retrieve the current company number (`l_firm`).

---

## Main Flow

### Initialization

- The program starts by initializing display indicators and error flags.
- Company number (`w_firm`) is loaded from the LDA.

### User Interaction Cycle

- The main loop (`b1tag`/`b1tagb`) presents the screen and waits for user input.
- Function keys are handled:
    - `*INKC`: Exit program.
    - `*INKD`: Run inquiry subroutine (`spørring`), then return to input.
- The program then determines how to process the input:
    - If **order number** (`b1numm`) is entered:
        - Looks up the order in `lohelr`.
        - Validates order status and order type via `votyl1`.
        - Ensures the order is not already received or closed.
    - If **supplier number** (`b1ldor`) is entered:
        - Validates supplier via `sjekk_levr` subroutine.
        - Calls external program `LO562R` to retrieve order.
    - If **item number** (`b1vvar`) is entered:
        - Validates item via `sjekk_vare` subroutine.
        - Calls external program `LO552R` to retrieve order.
    - If no valid search term is entered, signals error.

### Order Number Finalization

- If a unique order is found, subroutine `finn_onr` is called to:
    - Retrieve and set order number, supplier order number, and last log code if available.
    - Calls external program `LM501R` for log code lookup.

### Registration

- If all checks pass, the program calls `HR131R` to perform the actual receipt registration, passing all relevant parameters.

---

## Subroutines

### `spørring` (Inquiry)

Handles F4-inquiries for supplier or item fields, launching external inquiry programs:
- `RL580R` for supplier lookup.
- `VV580R` for item lookup.

### `sjekk_levr` (Supplier Validation)

Checks that the supplier exists in `rlevl1`. If not, sets error indicators.

### `sjekk_vare` (Item Validation)

Performs a multi-stage lookup to resolve the entered item number:
- **EAN number:** If input is all digits and longer than 8, calls `VE710R` to resolve to internal item.
- **Logistics item number:** Uses embedded SQL to check mapping in `vvlepf`.
- **Supplier item number:** Looks up in `vvarl4`.
- **NOBB number:** Looks up in `vvarl3`.
- **Internal item number:** Direct lookup in `vvarl1`.
- On failure, sets error indicators.

### `finn_onr` (Find Order Number)

Given order number and suffix, retrieves:
- Internal order number (`loornr`)
- Supplier order number (`losorn`)
- Last log code and description via `LM501R`
Sets indicators for each found value.

### `*INZSR` (Initialization)

Builds key lists for file lookups, and loads company number from LDA.

---

## Notable Business/Domain-Specific Logic

- **Order Status Checks:** Orders already received or closed cannot be processed again. This is governed by `lokode` and `vaoakk` fields.
- **Order Type Validation:** Uses `votyl1` to ensure the order type allows for receiving.
- **EAN and NOBB Handling:** The system supports multiple item identification schemes (EAN, NOBB, supplier, internal), reflecting Norwegian building materials industry standards.
- **Logistics Item Mapping:** Embedded SQL is used to support cross-referencing between logistics and sales item numbers, a customization for specific product assortments (e.g., "trelast-sortiment").
- **Log Code Handling:** Integrates with a logging system to fetch the latest action code on an order.

---

## External Program Calls

- **LO552R / LO562R:** Used to retrieve orders based on item or supplier.
- **HR131R:** The main registration program for warehouse receipts.
- **VE710R:** Resolves EAN numbers to internal item numbers.
- **RL580R / VV580R:** Inquiry programs for supplier/item.
- **LM501R:** Retrieves last log code for an order.

---

## Design Patterns and Conventions

- **Tag/Goto Structure:** The main loop uses tags and gotos for control flow, a common pattern in legacy RPG applications.
- **Indicator Usage:** Uses *INxx indicators for screen error and control feedback.
- **Parameter Passing:** Data is passed to external programs via `CALL/PARM` pattern, typical for modular RPG applications.
- **Subroutines for Modular Logic:** All validation and lookup logic is encapsulated in subroutines for clarity and reuse.
- **Key Lists:** All file accesses use well-defined key lists, initialized in the `*INZSR` subroutine.

---

## Integration Points

- **Master Data Files:** Heavy reliance on master files for items, suppliers, and orders.
- **External Programs:** Many business rules and lookups are delegated to external RPG programs, which must be present and correctly parameterized.
- **SQL Integration:** Embedded SQL is used for specific cross-reference lookups, indicating an evolving codebase that mixes traditional and modern RPG techniques.

---

## Error Handling

- **User Feedback:** Error conditions (e.g., not found, invalid, already received) are signaled to the display file via *INxx indicators.
- **Program State:** Flags like `b_feil` and `b_fonr` are used to control flow and prevent repeated actions.

---

## Summary

This program acts as a parameter validation and handoff module for the warehouse receiving process, ensuring that only valid, open orders and items are processed, and that all lookups are performed consistently with company and industry standards. It is tightly integrated with the rest of the ASLAGR system through both database files and external programs, and is designed to support a variety of item identification schemes typical in the Norwegian building materials sector. 

For maintenance or extension, pay special attention to:
- The sequence and logic of lookups in `sjekk_vare`
- The handling of order status and type
- The integration points with external programs and files
- The use of indicators and flags for error and flow control

All enhancements should preserve these business rules and integration patterns.