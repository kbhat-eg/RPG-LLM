# RPG Program MB101R Explanation

This program is written in IBM ILE RPG (Report Program Generator) and is part of a system called **ASLOGI**. The specific program is named **MB101R**. Its main purpose is to provide detailed management and analysis of goods/items using the **ABC analysis** method (classifying items according to their value or importance), typically for inventory or warehouse management.

This is a classic green-screen, subfile-based application. Subfiles are used to display lists with scrolling and update capabilities.

---

## 1. **Header and Documentation**

The header (`h` spec) indicates settings like:
- `option(*nodebugio)` - disables File I/O debugging.
- `datedit(*dmy)` - dates are in day-month-year format.

The documentation (lots of comments) describes changes, version history, usage of indicators, and what different indicators mean (e.g., indicator 10 = Rollup, 14 = Sflclr, 80-99 = working indicators).

---

## 2. **Files: Physical and Display**

### Physical Files

Files are defined for reading/updating inventory and product records, e.g.:

```rpg
fmabclr    if   e           k disk    rename(mabcpfr:mabclrr)
fmabdl1    if   e           k disk    rename(mabdpfr:mabdl1r)
fmabdlu    uf a e           k disk    rename(mabdpfr:mabdlur)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
```

- Most are `if` (input, full procedural), some are `uf` (update, full procedural).
- `rename` is used to refer to specific record formats (for multiple logical files over one physical file).

### Display File

```rpg
fMB104D    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- `MB104D` is the display file, using subfile `b1sfl`.
- The subfile record number variable is `w_srrn`.
- Display feedback info DS `dspfbk` is used.

---

## 3. **Data Structures and Variables**

- Many `d` specs define variables, data structures, and constants.
- Local Data Area (`uds`) access (e.g., `l_user`, `l_firm`), for user/session data.
- Variables for keys to files, subfile control, and working variables (`w_fcrn`, `w_srrn`, etc.)
- Several data structures for record keys. Constants (like `c_sfil = 12`) for subfile sizing.

#### Notable Working Variables:

- `w_fcrn` - first record number on page
- `w_stel` - subfile counter
- `w_spge` - subfile page size
- `w_srrn` - relative record number in subfile
- `w_ssrn`, etc - for pagination and navigation
- `w_firm`, `w_lagk`, etc - current working keys for company, warehouse, etc.
- `b_oppr`, `b_forn`, etc - flags for status/action

---

## 4. **Main Logic and Subroutines**

### Main Loop

The main logic is a loop handling the display, function keys, and subfile operations.

#### Entry Points

- `b2taga:` / `b2tagb:` — Tags for main program and data section.
- `goto avslutt` — To terminate the program.

#### Function Keys and Navigation

- Function keys (`*INKA`, `*INKC`, etc.) are mapped to different features:
    - Open windows
    - Refresh data
    - Inquiry/messaging
    - Paging up and down
    - Exit (F3, F8, F9, etc.)

#### Subfile Handling

- `exsr dsp_subfile` — Display the subfile.
- `exsr subfile` — Process subfile (read user input, update records)
- `exsr forny` — Refresh subfile (clears and rebuilds).

---

### Subroutines

The program is highly organized into subroutines (`begsr`/`endsr`), each handling a specific function.

#### forny

- Refreshes the subfile based on current sequence (`w_seqe`).
- Sets read keys for the correct file/sequence.
- Calls `clr_subfile` (clear) and `crt_subfile` (populate).

#### posisjoner

- Positions the list based on entered criteria (e.g., ABC code, item number, quantity, turnover).
- Sets the correct sequence for reading the file and fills the subfile accordingly.
- Clears input fields after positioning.

#### subfile

- Reads subfile entries and processes user selections (e.g., change/modify).
- Calls `xc2bld`, `xc3bld` to handle record updates.
- Iterates through the currently loaded subfile records.

#### xc2bld / xc3bld

- Handles record display and updating for change/view (C2BLD, C3BLD, possibly different screens/formats).
- Loads detail data for the item, populates display fields, validates user input, writes changes to the database.

#### fin_pris

- Calls an external program `VP750R` to get an item's price.

#### hent_prisgr

- Calls an external program `VL712R` to get an item's price group.

#### upd_prog_abc

- Calls an external program `MM747R` to update the ABC code used for forecasts.

#### clr_subfile / crt_subfile

- `clr_subfile`: Clears current subfile records and resets counters.
- `crt_subfile`: Reads records from the database and fills the subfile up to the current page size (`c_sfil`).

#### bck_subfile

- Allows scrolling back one page in the subfile by reading previous records and repopulating the subfile.

#### dsp_subfile

- Displays or refreshes the subfile control record and loads the correct page.

#### spørring

- Performs inquiry for additional info (calls `VV500R`), e.g., item text.

---

## 5. **Key Lists**

At the end, key lists (`klist`) define database access patterns for each file, used in `chain`, `read`, `setll`, etc.

---

## 6. **Initialization (`*inzsr`)**

- Called at the program start.
- Sets up runtime parameters, key fields, and initializes the subfile for display.
- Loads selection criteria from the Local Data Area.
- Calls subroutines to position and populate the subfile.

---

## 7. **Indicator Usage**

The program makes extensive use of RPG indicators (`*inxx`):

- Control display options, function key presses, paging, subfile operations, and error flags.
- Indicators 30-79 — for error/display messages.
- 10 = Rollup (page down), 11 = Rolldown (page up), etc.

---

## 8. **Business Logic**

- **ABC Analysis**: Central to the program. Items are classified and manipulated by their ABC code, crucial for inventory management.
- **Subfile Paging**: Allows users to navigate large lists of items by pages.
- **Item Update**: Users can change ABC codes and other information for each item, which is then written back to multiple files (master, warehouse-level, etc.).
- **External Calls**: Key business logic (e.g., price calculation) is delegated to other programs.

---

## 9. **User Interaction**

Users:
- View a list of items (with subfile paging).
- Enter or adjust ABC codes, quantities, etc.
- Use function keys for inquiry, help, navigation, and data manipulation.
- Can drill down to details or edit screens for each item.

---

## 10. **Summary**

**MB101R** is a classic interactive RPG subfile program for analyzing and maintaining item master data using ABC classification. It supports:
- Detailed browsing and updating of items and their ABC info.
- Multi-level file management (item, warehouse, groupings, etc.).
- Paging and positioning in lists.
- Integration with other modules for pricing and forecasting.

### **Key Takeaways:**
- **Subfile** is the central UI pattern.
- **ABC/XYZ codes** control filtering, display, and logic branching.
- **Indicators** are critical for function key handling and screen control.
- **External calls** provide modular business logic for pricing and forecasting.
- **Key lists** and variable management enable efficient file access and update.

If you are new to this program, focus on:
- Understanding subfile handling (`crt_subfile`, `clr_subfile`, `dsp_subfile`).
- How indicators are used for UI control.
- How ABC logic is used to filter, display, and update item data.
- The structure and purpose of each subroutine.
- Integration points with other programs (calls to `VP750R`, `VL712R`, `MM747R`, etc.)

---

**Tip:** Keep a subfile and indicator cheat sheet handy when navigating and modifying this style of RPG code. Understanding the flow of indicator states and subfile logic is crucial.