# RPG Program RM002R — Detailed Explanation

## Overview

This RPG program (RM002R) reads accounting transaction lines from the `BOVF` file and writes them out to a semicolon-separated flat file, suitable for import or integration with external systems. The program is tailored for a Norwegian accounting context, with enhancements over time to handle mapping of VAT and posting codes, resolve customer information, and attach related project numbers.

---

## High-Level Flow

1. **File Declarations**: The program opens several database files, including the main posting file (`BOVF`), customer files, code translation files, and output file (`RM02PF`).
2. **Initialization**: Local working storage is initialized, including fields for company, keys, and output fields.
3. **Main Loop**: For each record in the `BOVF` input file,
    - Various fields are mapped and transformed, including date handling, account and code translation, and customer lookups.
    - An output string is constructed, formatted as a semicolon-separated values (CSV) line.
    - The output record is written.
4. **Cleanup**: Sets LR (last record indicator) and ends program.

---

## Key Components Explained

### 1. File Declaration Section

```rpg
fbovfut    if   e             disk
frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frb00l1    if   e           k disk    rename(rb00pfr:rb00l1r)
fra04l1    if   e           k disk    rename(ra04pfr:ra04l1r)
frb10l1    if   e           k disk    rename(rb10pfr:rb10l1r)
frm02pf    o    e           k disk
```

- **BOVF**: Input, accounting transactions.
- **RHOVL1, RKUNL1**: Lookup files for accounts and customers.
- **RB00L1, RB10L1**: Code translation/mapping files (VAT codes, posting types).
- **RM02PF**: Output file (semicolon-separated flat file).

### 2. Key Data Definitions

- **Local Data Area (LDA)** used to determine the current company.
- Numerous work fields used for record assembly and transformation (e.g., date handling, currency amounts, account numbers).

#### Example:

```rpg
d w_belk  s   15  2   // Amount field for output
d w_navn  s         like(rknavn)     // Name from customer file
d w_proj  s    6      // Project number
```

### 3. Main Logic Loop

**Process:**

```rpg
c     read      bovfut
c     dow       not %eof
   ... // Many processing steps
c     write     rm02pfr
c     exsr      blank      // Blank work fields for next record
c     read      bovfut
c     enddo
```

#### Within the Loop:

- **Company Filtering**: Only processes records for the selected company (`l_firm`).
- **Identification**: Sets a static identifier `GBAT10` for each line.
- **Bilagstype (Posting Type) Translation**:
    - If a code translation is found in `RB10L1`, overwrites the default posting type code.
- **Dates Handling**: Splits and manipulates date fields between different formats.
- **Account Number Logic**:
    - Picks debit or credit account depending on which side has data.
    - If accounts are above a certain number, they may be mapped via another file (`RA04L1`).
- **VAT Code Translation**:
    - If `bfdmom` is present, uses it; otherwise falls back to `bfcmom`.
    - If a translation is found in `RB00L1`, uses the mapped value.
    - Special logic for zeroing VAT code for special account numbers.
- **Balance/Amount Handling**:
    - If a credit entry, the amount is negated.
- **Customer Lookup**:
    - Retrieves customer details (name, address, etc.) from `RKUNL1` using the customer number.
- **Due Date and Invoice Info**:
    - Handles due date formatting.
    - Captures invoice text/number.
- **Account (Ledger) Lookup**:
    - Looks up additional descriptive info for bank accounts in `RHOVL1`.
- **Project Number**:
    - Pulls from `bfproj` field if available.
- **Output Record Assembly**:
    - Concatenates all fields into a single semicolon-separated string, field by field, quoting where appropriate.
- **Write**: Writes the string to the output file.
- **Field Reset**: Calls subroutine to blank fields in preparation for the next record.

---

### 4. Subroutines

#### **BLANK** — Blank All Output Fields

Resets all working fields before building the next output record.

```rpg
c     blank         begsr
c                   eval      w_ponr = *blanks
c                   eval      w_navn = *blanks
... (all fields reset)
c                   endsr
```

#### **INZSR** — Initialization (Run Once)

Establishes keys for file lookups and sets up firm context for rest of the program.

```rpg
c     *inzsr        begsr
   ... // Set up keylists for chained file access
   ... // Retrieve and store firm number from LDA
c                   endsr
```

---

### 5. Lookup Keys

Key lists are defined for all relevant files to perform efficient chained lookups:

- **rhovl1_key**: Used for ledger lookup based on firm and account.
- **rkunl1_key**: Used for customer lookup.
- **rb00l1_key**: VAT code translation.
- **rb10l1_key**: Posting code translation.
- **bovfl1_key**: For positioning in the main posting file (not used for direct access in main logic).

---

### 6. Comments and Code Evolution

The code contains detailed inline comments and a change log at the top, indicating various enhancements (such as handling for special VAT code mapping, project numbers, and customer account logic).

---

## Summary

- The core task is to **read each posting line, transform/translate fields as needed**, and **output a flat file record** in a translatable, semicolon-separated format.
- Code modularity is achieved through subroutines for blanking fields and initialization.
- Extensive use of work fields ("w_...") ensures output is formatted and mapped exactly as needed, abstracting away the raw database field names.
- Business rules are enforced through chained lookups, field translation, and custom logic (especially around account and VAT code mapping).
- The program is highly tailored for its business context (Norwegian accounting, Mamut integration).

---

### Programmers Onboarding Notes

- **File Dependencies**: Ensure all referenced physical/logical files and data areas (`BOVF`, `RHOVL1`, `RKUNL1`, etc.) are present and match expected layouts.
- **Field Lengths**: Observe size constraints and type compatibility with your integration targets.
- **Mapping/Translation**: Business mappings are handled via lookup files, not hardcoded; update these files for business rule changes.
- **Output Format**: The output is not "true" CSV (quotes only on some fields), but semicolon-separated, matching Norwegian/European conventions. Adjust if integrating with systems expecting a different format.

---

**In short:**  
This program is a robust data extraction and transformation batch process, typical in ERP/accounting data integrations, carefully organizing and mapping accounting line items for external consumption.