# RPG Program RS205R - MVA Code Validation and Rate Calculation

This RPG/400 program ("RS205R") is used to validate VAT (MVA) codes and return relevant rates and calculation factors. It interacts with a physical file (`RA05PFR`) containing VAT code definitions, validates input codes, determines the rates based on date, and calculates percentage and factors for further use.

---

## **1. Header and Documentation Area**

- `h datedit(*dmy) option(*nodebugio)`:  
  Source-level options:
  - Default date editing in DMY (day-month-year) format.
  - `*NODEBUGIO` disables debug support for file I/O.

- Program description and version/change history are included as comments for audit and maintenance.

---

## **2. File Definition**

```rpg
fra05l1    if   e           k disk    rename(ra05pfr:ra05l1r)
```
- Declares `RA05PFR` as a keyed, externally described file, renamed internally to `ra05l1r`.
- Used to retrieve VAT code information.

---

## **3. Parameter Definitions**

```rpg
d p_stat          s              1
d p_ekod          s                   like(raekod)
d p_etxt          s                   like(raetxt)
d p_dato          s                   like(raemda)
d p_bpro          s                   like(raebpr)
d p_mvas          s              6  2
d p_mvat          s              5  4
d p_mvaf          s             10  9
```
- `p_stat`: Status flag (e.g., 'N' for not valid).
- `p_ekod`: Input/return parameter for the VAT code.
- `p_etxt`: Text/description for the VAT code.
- `p_dato`: Date for which VAT rate is checked.
- `p_bpro`: Calculation percentage.
- `p_mvas`: VAT percentage rate to apply (e.g., 25.00).
- `p_mvat`: VAT factor (for multiplying).
- `p_mvaf`: VAT fraction (for dividing).

---

## **4. Local Data Area (LDA) Usage**

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Reads values from the Local Data Area, e.g., user, firm number, firm name.

---

## **5. Key and Working Variables**

```rpg
d ra05l1_ekod     s                   like(raekod)
d w_dato          s               d   datfmt(*iso)
d w_firm          s                   like(raefir)
```
- Intermediate variables used for file key and date handling.

---

## **6. Main Program Logic (Calculations and Checks)**

### **a. VAT Code Validation**

```rpg
c                   eval      ra05l1_ekod = p_ekod
c     ra05l1_key    chain     ra05l1r
c                   if        not %found
c                   eval      p_stat = 'N'
c                   eval      p_etxt = 'Koden er ugyldig  '
c                   goto      avslutt
c                   endif
```
- Assigns input code to local key variable.
- Tries to fetch the record from `RA05PFR` using the provided code and firm.
- If not found:
  - Sets status to 'N' (Not valid).
  - Returns an error message.
  - Exits.

### **b. Date Handling**

```rpg
c                   if        p_dato = *loval
c                   time                    w_dato
c                   else
c                   eval      w_dato = p_dato
c                   endif
```
- If no date was provided, sets the working date to the current system date.

### **c. VAT Rate Determination**

```rpg
c                   if        w_dato >= raemda
c                   eval      p_mvas = raepro
c                   else
c                   eval      p_mvas = raegpr
c                   endif
```
- If the date is after a certain effective VAT date (`raemda`), uses the "current" rate (`raepro`), otherwise uses the "older" rate (`raegpr`).

### **d. VAT Factor Calculations**

```rpg
c                   eval      p_mvat = (p_mvas + 100) / 100
c                   eval(h)   p_mvaf = 100 / (p_mvas + 100)
```
- Calculates multiplication and fraction factors for VAT, with proper decimal scaling.

### **e. Calculation Percentage Selection**

```rpg
c                   if        w_dato >= raepda
c                   eval      p_bpro = raebpr
c                   else
c                   eval      p_bpro = raebgp
c                   endif
```
- Depending on the date, chooses between the standard or older calculation percentage field.

---

## **7. Program Termination**

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets indicator to close the program and release resources.

---

## **8. Initialization Subroutine**

- **Executed on program start** to initialize parameters and prime the key:

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_stat
c                   parm                    p_ekod
c                   parm                    p_etxt
c                   parm                    p_dato
c                   parm                    p_mvas
c                   parm                    p_mvat
c                   parm                    p_mvaf
c                   parm                    p_bpro
c     ra05l1_key    klist
c                   kfld                    w_firm
c                   kfld                    ra05l1_ekod
c                   eval      w_firm = l_firm
c                   eval      p_stat = *blank
c                   eval      p_etxt = raetxt
c                   eval      p_mvas = 0
c                   eval      p_mvat = 1
c                   eval      p_mvaf = 1
c                   endsr
```
- Defines entry parameters.
- Sets the primary key list (firm and code) for the file lookup.
- Reads the firm number from the LDA.
- Sets initial (default) values for the output parameters.

---

## **Summary of Flow**

1. Parameters are initialized, mostly from input and LDA.
2. The VAT code is looked up for the current firm.
3. If found, the code details (rate, description, factors) are populated according to the input or current date.
4. If not found, an error is returned.
5. The calculated values (rate, factors) can be used by the calling program for billing, reporting, etc.

---

## **Key Takeaways**

- **Central purpose:** Validate a VAT/mva code and return correct percentage/factors based on an effective date.
- **Parameter-driven:** Receives and returns values through parameters defined in the entry parameter list.
- **Firm specific:** Always factors in the firm using LDA.
- **Date-sensitive:** Can handle changes in VAT rates and calculations over time.

This program would typically be called from billing, accounting, or ERP modules to ensure VAT is calculated according to the latest rules for each firm and transaction date.