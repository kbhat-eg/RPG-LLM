# RPG Program Explanation: Integration with Transport Service

This source code is an ILE RPG program (AP058R) designed for IBM i, interfacing with external transport APIs (notably Solwr's, based on the comments). It prepares and sends transport order data (in JSON format) for deliveries, processes responses, and maintains logs and control information. The code is well-annotated with a change log and is evolved with many features, checks, and external dependencies.

Below is a breakdown of its structure, purpose, and key logic.

---

## 1. **Program Structure and Setup**

- **Control Specifications:**
  - `H decedit('0.') datedit(*dmy-) ...` sets numeric and date editing, disables debug I/O, and sets binding directories for external procedures (specifically CGIDEV2, used for web/JSON file handling).
  - `Dcl-s` and `/copy` directives include prototypes and bind specifications.

- **File Declarations (`F-specs`):**
  - Multiple database (physical) files are declared, each being renamed for local usage within this program. Files cover orders, customers, log files, transport info, item registry, and more. Some files are flagged as update-capable.

- **Key Data Structures and Variables:**
  - **LDA (Local Data Area)** fields for user, environment, firm, etc.
  - **Parameter fields** for program input via parameter list (`plist`).
  - **Work fields** for building requests, storing intermediate values (e.g., weights, addresses, JSON fragments).
  - **Table arrays**, like `tr_item(445)`, for keeping collections of relevant article numbers.

- **SQL SET OPTION:**
  - Ensures the embedded SQL uses ISO dates, Norwegian language/collation, no commitment control, and delayed preparation.

---

## 2. **Main Flow Overview**

### **Startup / Parameter Intake**

- The `*inzsr` subroutine initializes the program; parameters (company, order number, etc.) are read into working variables. Many key values are loaded from the database using embedded SQL based on configuration.

### **Control Checks**

- **"Fl√∏testyring" / Flow Control:**  
  Checks if transport order flow control is enabled for the delivery method and warehouse. If not, execution terminates early with the `p_stat` field set to an error code.

- **Order and Customer Data Fetch:**
  - Order header and customer data are pulled from the database for constructing the transport request.

- **Transport Order Not Sent for Internal or RDS Orders:**  
  Contains checks to prevent sending orders for certain types (e.g. internal transfers, or if the supplier is an RDS provider).

- **Log Code Validation:**  
  Validates that the order is at a suitable "ready/dispatchable" state by examining log codes in multiple places (including earlier years).

### **Data Gathering and Request Preparation**

- **Counts and Sums:**
  - Collects the number of packages, total weight, and total volume for the shipment.
  - If missing, attempts are made to calculate or estimate these values from product/package data.

- **Contact Information:**
  - Fetches contacts for customer and warehouse, including fallbacks if data is missing.

- **Address and JSON Data:**
  - Prepare sender/receiver ("consignor"/"consignee") address and contact fields for the JSON request, supporting both normal and reverse (return) flows.

- **Sanitizing Text:**
  - Uses SQL REGEXP_REPLACE to clean address/text fields for any characters that could cause JSON or API issues.

- **Line Item Processing:**
  - Loops through order lines, calculating and outputting each row's package/weight/volume data to the JSON template.

### **Request Building and API Integration**

- **CGIDEV2 HTML Buffer:**  
  - CGIDEV2 procedures are used to populate a JSON "template" (via UpdHTMLVar), which is then written to the IFS (IBM i integrated file system) as the request payload.

- **Headers File:**  
  - An "eg-apps-token" line containing the API key is created in a separate headers file.

- **Web Service Call:**  
  - Calls the external program `AW702C` to perform a POST request to the remote API, passing along the path to the JSON request, headers, etc.

- **Response Handling:**  
  - After the API call, reads the corresponding response file back from IFS.
  - Looks for the consignment reference in the response and updates a tracking file in the local database.
  - Handles CCSID (character encoding) conversion as necessary for correct data handling.

- **File Cleanup:**  
  - Deletes request, response, and headers files from IFS unless debugging.

---

## 3. **Logging and Error Handling**

- Logging is available (controlled by `b_logg`) and traces key steps, errors, or abnormal situations using dedicated logging programs (`AB700R`, `AB705R`, etc.).
- There is no *PSSR universal error routine; it has been intentionally removed, likely to avoid masking exceptions.

---

## 4. **Special Subroutines**

- **`kalk_linje`:**  
  Calculates the weight and volume for each order line, with logic to handle missing direct values by fallback to package conversion or alternative registry lookup.

- **`sjk_tr_item` and `sjk_trp_ord`:**  
  - Split and check if all order lines are "transport articles" (e.g., for certain business logic or to flag 'supplementtransportorder' in the JSON).

- **Logging subroutines:**  
  - `logg_start`, `logg_debug` manage interaction with the job/event log, creating entries at job start or for specific debug events.

---

## 5. **Notable Features and Business Rules**

- Flexible architecture supports configuration and runtime switches (for flow control, internal order transfer, text conversion, etc.), primarily via database configuration and external programs.
- Handles both new orders and returns (with flipped sender/receiver logic).
- Attempts to ensure data integrity and proper formatting before API calls, including character set conversion and cleaning of request text.
- Extensive use of comments and version tags shows active maintenance and enhancement over time.

---

## 6. **Key External Dependencies**

- **Database Files:**  
  - For order headers/lines, customers, product registry, log/history, and system configuration.
- **CGIDEV2 procedures:**  
  - For handling HTML buffers and writing files to IFS.
- **External Programs:**  
  - For additional data lookup, configuration retrieval, web API calls, and logging.
- **AW702C:**  
  - Handles actual HTTP POST to transport API.
- **SQL:**  
  - Embedded SQL is used for retrieving configuration and user-data.

---

## 7. **Parameters**

The main entry parameters are:
- `p_firm` (company number)
- `p_numm` (order number)
- `p_suff` (order suffix)
- `p_skaf` (flag for "skaffevare", i.e., special item sourcing)
- `p_logg` (logging flag)
- `p_stat` (output status code/result)

---

## 8. **Conclusion**

This program is a robust, production-grade RPG application for interfacing IBM i-based order management with a transport company's API. Its responsibilities include:

- Validating and preparing orders for dispatch.
- Building JSON requests from ERP data.
- Calling an external web service and handling its response.
- Maintaining related local records.
- Extensive control logic to handle a wide variety of business cases and error situations.

It is a central integration piece between internal order management and external transport/shipping systems, and is built for reliability, auditability, and configurability.

---

### **Onboarding Recommendation for Developers**

- **Familiarize** yourself with the database file structures, as these drive most business logic.
- Understand the **CGIDEV2** toolkit for handling JSON/HTTP communication.
- Get used to the **versioning comments** (e.g., `8.05 K000`) which show when/why changes were made.
- Check out the **external programs** and how they fit into the wider application landscape.
- Review the **error and logging flows**, as they are crucial for production support.
- Be careful when modifying flow control or API integration, as these are interwoven with business rules and external contracts.

---