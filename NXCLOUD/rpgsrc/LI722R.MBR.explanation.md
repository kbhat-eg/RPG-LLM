# RPG Program Explanation: LI722R

This RPG/400 program is designed for the IBM i (AS/400) and processes approved EDI order confirmations. The program reads, updates, and logs various files associated with EDI messaging.

This summary gives a structured walkthrough for new developers.

---

## **1. Program Header**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- *option(*nodebugio)*: Disables debug I/O for efficiency.
- *datedit(*dmy)*: Specifies the date format (day-month-year) for date operations.

---

## **2. Program Description and Change Log**

Commented for context:  
- **System**: ASLAGR  
- **Program**: LI722R  
- **Function**: Reads in approved EDI order confirmations  
- **Special Version**: Gipling  
- **History**: Original program created 29 Oct 2018.

---

## **3. File Declarations**

```rpg
fledil1    if   e           k disk    rename(ledipfr:ledil1r)
fledilr    if   e           k disk    rename(ledipfr:ledilrr)
fledilu    uf a e           k disk    rename(ledipfr:ledilur)
felogl3    uf   e           k disk    rename(elogpfr:elogl3r)
```
- Connects and renames logical files for input/output to typically match internal naming conventions.
    - `ledil1`/`ledilr`/`ledilu`: EDI message line files.
    - `elogl3`: Logging file.

---

## **4. Data Structure Definitions**

### **LDA (Local Data Area)**
```rpg
d                uds
d l_user                911    920
d l_fnav                951    980
```
- Accesses user and name information from the Local Data Area.

---

### **Parameter Inputs**
```rpg
d p_stat          s              1
d p_type          s                   like(litype)
d p_mnum          s                   like(limnum)
d p_mlin          s                   like(limlin)
```
- Parameters for status, message type, message number, and message line.

---

### **Composite and Overlayed Data Structure**
```rpg
d                 ds
d d_prec                        32
d  d_firm                        3  0 overlay(d_prec)
d  d_type                        4    overlay(d_prec:4)
d  d_mnum                        8  0 overlay(d_prec:8)
d  d_mlin                        6  0 overlay(d_prec:16)
d  d_biln                        8  0 overlay(d_prec:22)
d  d_kode                        1    overlay(d_prec:30)
d  d_ekod                        1    overlay(d_prec:31)
```
- Uses overlays for efficient field referencing within a block of memory (`d_prec`).

---

### **Other Key and Variable Declarations**
- Variables for file keys, error/status handling, constants, and work variables.
- `klist`/`kf`/`uf` for various file accesses.

---

## **5. Constants**

```rpg
d c_sfil          s              2  0 inz(10)
d lo              c                   'abcdefghijklmnopqrstuvwxyz�����'
d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZ�����'
d digit           c                   '0123456789 '
d null            c                   '0000000000000'
```
- Constants for simple reference (e.g., lower/uppercase alphabet, digits).

---

## **6. Mainline Logic**

### **Initialize Status**
```rpg
c                   eval      p_stat = *blanks
```
- Clear parameter status.

---

### **Check for Complete EDI Message**
```rpg
c                   eval      ledil1_type = 'OBKR'
c                   eval      ledil1_mnum = p_mnum
c                   eval      ledil1_mlin = 100001
c     ledil1_key    chain     ledil1
c                   if        %found
    ...
c                   exsr      gen_ordre
c                   endif
```
- Builds key for `ledil1` (message header for "OBKR" type, main line 100001, specific number).
- If found, process the order via subroutine `gen_ordre`.

---

### **End Program**
```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks program for termination and cleanup.

---

## **7. Subroutine: gen_ordre**

### **Purpose**:
Automates update of approved EDI messages.

#### **Steps**:

1. **Setup composite data**
    ```rpg
    c                   eval      d_firm = w_firm
    c                   eval      d_type = p_type
    c                   eval      d_mnum = p_mnum
    c                   eval      d_mlin = p_mlin
    c                   eval      d_kode = *blanks
    c                   eval      w_prec = d_prec
    ```
2. **Call Purchase System for OBKR type**
    ```rpg
    c                   select
    c                   when      d_type = 'OBKR'
    c                   call      'LI710R'
    c                   parm                    w_prec
    c                   parm                    w_errk
    c                   endsl
    ```
    - Calls another program (`LI710R`) with relevant data.

3. **Mark messages as updated**
    - Reads the `ledilr` file for all matching lines for this order.
    - For each line, chains to `ledilu`, updates status fields if found.
    - Updates status code (`likode = 'G'`), status (`listat = '9'`), timestamps, and user ID.

4. **Log the update**
    - Chains to `elogl3`, updates log record with date/time/user.

---

## **8. Subroutine: *inzsr (Initialization)**

### **Purpose**:
Runs on program start.

#### **Steps**:

- Loads parameters from the program entry.
- Sets up key-lists for each file access method.
- Gets current system time and date for logging and processing.

---

## **9. Key Lists for File Access**

Example:
```rpg
c     ledilu_key    klist
c                   kfld                    w_firm
c                   kfld                    ledilu_type
c                   kfld                    ledilu_mnum
c                   kfld                    ledilu_mlin
```
- Establishes composite keys for efficient chained access to files.

---

## **10. General Processing Flow**

1. **Initialization (`*inzsr`)** gets parameters and environment ready.
2. **Mainline code** checks for presence of a full EDI confirmation in the `ledil1` file.
3. If the message is complete, **process via `gen_ordre`**:
   - Calls backend purchase system for updates.
   - Updates message line files' statuses.
   - Writes logs for auditing.
4. **Ends program** and cleans up.

---

## **11. Notable Code Practices**

- **Data overlays** are used for efficient memory and parameter passing.
- **Clear modularity** via subroutines (`begsr`/`endsr`) for maintainability.
- **Full historical record** via logging and comment blocks.
- **Key lists for files** improve readability and reduce error in keyed file access.

---

## **12. Terminology**

- **OBKR**: Likely a message type for "order confirmation".
- **EDI**: Electronic Data Interchange.
- **MELDINGSLINJER**: Message lines (order message details).
- **GODKJENTE**: Approved.
- **Bruker (user)** and timestamps are logged for traceability.

---

### **Summary Table of Files & Usage**

| File      | Purpose                          |
|-----------|----------------------------------|
| ledil1    | EDI message lines (header)       |
| ledilr    | EDI message (related lines)      |
| ledilu    | EDI message line updates         |
| elogl3    | Logging of operations            |

---

## **13. Onboarding Notes**

- **Know the database files' layouts**: This code depends heavily on file structures.
- **Understand the EDI message process in the company**: `OBKR` and other codes are business-specific.
- **Modifying the workflow**: Edits should maintain the established subroutine and file-access patterns.

---

**In summary:**  
This program automates the validation, updating, and logging of approved EDI order confirmations, interacting with both application data files and a logging system, using classic ILE RPG patterns for modular and efficient batch processing.