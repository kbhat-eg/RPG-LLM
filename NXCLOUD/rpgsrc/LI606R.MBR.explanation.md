# RPGLE (ILE RPG) Program: LI606R – EDI Invoice Print/Export

## Overview

This RPGLE program, LI606R, is responsible for printing or exporting EDI invoices ("Faktura") with support for multiple output formats, including direct printing, PDF, and XML/Jasper integration for advanced reporting and mailing. It handles EDI message parsing, mapping to output templates, and integrates with external utilities for email, archiving, and print management.

**Key features:**
- Reads EDI invoice data from physical files.
- Builds and prints advanced invoice layouts.
- Exports invoice data to XML for JasperReports (PDF generation).
- Supports emailing and archiving of generated documents.
- Highly parameterized to support customer and document variations.

---

## High-Level Structure

- **Header Section (`H`)**: Specifies program metadata and runtime options (title, debug options, date/decimal edit, binding to CGIDEV2).
- **File Definitions (`F`)**: Declares database and print files, with conditional inclusion for additional files as features evolve.
- **Data Structures (`D`)**:
  - Transmission/parameter structures.
  - Invoice header, line item, totals, references, and party info (with explicit overlays for field mapping).
  - Local data area (LDA) overlays for workflow and environment parameters.
  - Email/Mailing structures.
  - Various workfields for temporary and formatting use.
- **Constants (`C`)**: Define key strings for document types and reporting.
- **Procedures/Subroutines (Subr)**: For environment setup, XML integration, formatting, and specialized processing.

---

## Main Processing Flow

### Initialization (`*inzsr`)
- Loads entry parameters and sets up file keys.
- Reads company/routine info to prime context.
- Determines if Jasper/XML output is required via flags in LDA or parameters.
- Prepares environment and logging for output type chosen.

### Main Body

1. **Fetch EDI Invoice Header**  
   - Chains to the main EDI message line based on composite keys.
   - Loads key invoice header fields for later merging into output templates.
   - Determines document type (Invoice vs. Credit Note).

2. **Populate Party/Address Information**  
   - Specialized subroutine (`part_info`) processes party roles (recipient, supplier, consignee) for address and name overlays.

3. **Write Output Header**  
   - Depending on output mode (plain print or XML/PDF), writes to a print file or calls XML/Jasper routines.

4. **Handle Free-text Lines**  
   - Loops through and writes (or exports to XML) any free-text invoice lines attached to the header.

5. **Process Invoice Line Items**
   - Iterates through invoice line detail records.
   - Extracts item, price, quantity, discount, and computes display fields.
   - Writes detail lines to print or XML as per mode.

6. **Print/Export Invoice Totals and Charges**
   - Finalizes with totals, VAT calculations, and summary lines.
   - Handles extra charges (additions/deductions), using specialized text mapping when descriptive text is missing.

7. **Finish Invoice**
   - Concludes output: writes footers, triggers archiving/email as necessary, and releases resources.

---

## Key Routines and Subroutines

### `part_info`
- Loops through party information lines (BY = Invoice recipient, DP = Goods recipient, SU = Supplier).
- Carefully overlays address lines for each role, maintaining compatibility with different record layouts.

### `fakt_avsl`
- Handles the output of summary lines (totals, VAT, and footers).
- Reiterates through charges/allowances lines and generates additional output lines accordingly.

### XML/Jasper Integration Routines

- `xml_envm` – Initializes XML/Jasper environment variables (batch, user, printer, etc.)
- `xml_head` – Builds XML tags for the invoice header, including address/contact fields (with string cleaning).
- `xml_deta`, `xml_netto`, `xml_charges`, `xml_vat`, `xml_totaler` – Output specific sections of the invoice as XML tags, mapping to their corresponding sections (line items, totals, VAT, etc.).
- `xml_end` – Finalizes the XML document, writes tags for archiving, meta tags, and writes the actual file to disk. Also triggers sniffer (for automated processing) if configured.

### Email & Mail Handling
- Email addresses are fetched through customer, order, or seller records.
- Subject and message body are dynamically composed, extracting relevant field values, and passed to external programs for email sending.
- Strings are "washed" (sanitized) before being used in mail fields to remove invalid characters, ensuring compliance with email and XML standards.

### Miscellaneous

- **Version-controlled development notes** are included in the comments, indicating changes, feature additions, and bug fixes down to the line and field level.
- **Subroutine for hardcoded charge descriptions (`sr_6text`)**: Maps codes to Norwegian descriptive texts if missing in data.

---

## Key Architectural Considerations

- **Backward Compatibility**: Overlay usage and conditional logic allow the code to work with changing field lengths and additional customer requirements without breaking existing formats.
- **Internationalization**: Address components, free-text, and output strings are handled carefully, including Norwegian special characters and encoding.
- **Robust Error Handling**: Key lookups, output routing, and parameter validation include error checking, logging, and fallback logic.
- **Separation of Data & Presentation**: Heavy use of temporary fields and overlays for clean mapping from file/database fields to output sections, especially important for XML/Jasper integration.
- **Extensibility**: Version history shows frequent additions for new fields, mail workflow, and output customizations, all managed without major rewrites.

---

## Output Modes & Integration Points

- **ASCII Print**: Traditional *SCS* spool file writing for direct printing.
- **PDF via JasperReports**: XML document generation, with parameters passed to Jasper for PDF rendering.
- **Mail/Archiving**: XML/email output mode, including archive tagging and job tracking.
- **Sniffer Trigger**: Optionally writes to a data queue, which can be monitored by an external Java "sniffer" for further automation.

---

## Key Takeaways for New Developers

- The program is **heavily data-driven**, expecting consistency in file layouts and parameter passing.
- Output can go to multiple targets (printer, disk, mail) based on LDA and runtime flags.
- **Understanding the keys** for database lookups is crucial: chaining and reading by composite keys is everywhere.
- **XML/Jasper integration** requires awareness of the strict mapping between RPG variables and XML tag names/sections.
- **String cleanup** for email/XML fields is a recurring theme — always check if your changes affect external or customer-facing output.
- **Extensive versioning and commenting**: Always read the historical comments before making changes to any section.
- Pay attention to **conditional logic** (`b_pdfp`, `l_mail`, etc.) as it toggles entire blocks of output logic.

---

## References

- **CGIDEV2**: Used for web/HTML/XML output operations and Jasper integration.
- **External Programs**: `AP612R`, `AP611R`, `AM705C`, `FO798R`, `AP613R`, and others are called for auxiliary tasks (printing, email, string conversions, etc.).
- **Prototype, UseC** includes: Provide external procedure definitions (not shown in full source).

---

## Summary

**LI606R** is a complex, robust EDI invoice handler leveraging both legacy print and modern XML/PDF output, adaptable to customer requirements and new output channels. It is maintainable by its clear structure, versioned change tracking, and carefully abstracted output routines. New developers should focus on understanding the data mapping, output toggling logic, and how new requirements are usually handled through overlays and versioned extensions.

---

**For onboarding:**  
- Start by running test cases in both print and PDF modes.
- Trace parameter flows from the entry point through initialization to header and line item processing.
- When debugging, use `%found`, `%eof`, key lists, and overlays to understand the program state at each record.
- For changes: always maintain consistency with overlays and consider both print and XML output impacts.