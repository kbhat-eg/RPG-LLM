# RPG Program FO798R — Detailed Explanation

This RPG (Report Program Generator) code is for an IBM i (AS/400) environment, written in the ILE RPG IV language. The main purpose of this program is to fetch and manage email addresses and message content, typically related to sending output (like reports or documents) as email. It's highly integrated with the business's customer, project, and employee master files.

## 1. Header & Change History

The header contains documentation on:
- Program name: **FO798R**
- Purpose: **"Sende utskrift som e-mail"** (Send printout as e-mail)
- Extensive modification history with version numbers, dates, developer initials, and explanations (in Norwegian) describing changes in logic, data handling, UI expansion, and more.

## 2. File Declarations

These `F`-specs declare files to be used as indexed disk files (`IF`) or workstation files (`CF`):

- **Customer master (`rkunpf`)**
- **Project master (`fkprl1`)**
- **Department, storage, salesperson, routine master files**
- **Various "rename" keywords**: Map physical file records to specific RPG record formats.
- **Display file (`ffm798d`)**: For user input/output.

## 3. Data Definitions

### Parameters (fields passed to/from calling program):

- Customer, project, contact, email fields (primary and alternatives), subject, message lines (up to 4 lines), etc.
- Field names like `p_kund` (customer), `p_kpro` (project), `p_emal` (email), `p_txt1` ... `p_txt4` (message lines), `p_pers` (personal/closing line), etc.

### Local Data Area (LDA):

Offsets into the LDA are used to fetch values like the routine code, user, and firm number.

### Key Variables

These are used to build keys for file lookups: customer number, project number, department/storing codes, etc.

### Work Variables

- `b_feil`: Indicates input error (**boolean**)
- `w_firm`: Firm number
- `w_krol`: Role code
- `w_numm`: Order number, etc.

## 4. Core Logic and Processing Flow

### Opening Screen Logic

- **Initializes display fields**: Sets display/input fields to blank or zero.
- **Clears alternative recipient fields** if a special role is present (`p_kule` not blank).
- **Customer email lookup**: Fetches main customer info and email (`rkunpf`).
- **Contact person email lookup**: If a contact is linked, fetches and prioritizes their email over customer.
- **Project email lookup**: If project number is present, fetches project-specific email (if available, this may override customer email).
- **Department/Lager info**: Looks up department or warehouse codes for the display message.
- **Sender determination**: Fetches sender's email (the salesperson) and builds a "closing" line (`b1pers`) with a name and possible mobile number for the email signature.
- **Routine register lookup**: If routine data provides recipient/sender email, these override previous values.
- Prepares the generated subject line (`b1emn1`, `b1emn2`, `b1emn3`) from static text and customer/order/project data.

### Main Display Loop

- **`exfmt b1bld`**: Shows the screen and gets user input.
- **Function keys**:
    - **F3**: Exit/return.
    - **F4**: Inquiry; calls a subroutine (e.g., to select a contact person).
- **Input validation**: Calls `sjekk_input`; if no email provided, flags an error and returns to input.
- **Moves user screen input to program parameters** (`flytt_par`).
- **Program then exits.**

## 5. Subroutines

### `spørring` (Inquiry)

Handles F4 inquiry:
- If the field active is an email field, allows lookup of contact person and retrieves email/ID to screen.

### `sjekk_input` (Input validation)

Ensures at least one email address is provided for sending — if not, marks the field in error and returns.

### `flytt_par` (Transfer fields to parameters)

Moves screen input to the corresponding program parameters for transfer to the calling program. Concatenates and trims subject lines.

### `*inzsr` (Initialization)

Handles:
- Entry parameter list setup (`plist`)
- Key list (`klist`) definitions for file lookups, mapping key fields to the structure used in `chain` operations.
- Sets up defaults for variables such as `w_firm` and formatting order numbers.

## 6. Key Points and Practices

- **File lookups** (`chain`): Used throughout to retrieve matching database records using constructed keys.
- **Field Prioritization**: Email is first sought from the project, then the contact person, then the customer.
- **Multiple Recipient Fields**: Accommodates up to three recipient emails, a copy (`CC`) field, and custom message lines.
- **Change Markers**: Version numbers in comments and field additions show maintenance best practice.
- **Coding Style**: Heavily uses global variables, single-letter indicators, and program-defined, prefixed variable names.
- **Language**: Comments and field names often in Norwegian.

## 7. Summary Table (Email Address Priority)

| Priority            | Source                           | Field      |
|---------------------|----------------------------------|------------|
| 1. Project Email    | Project master (`fkprl1`)        | `flmail`   |
| 2. Contact Person   | Contact person (`rukpl1`)        | `rumail`   |
| 3. Customer Email   | Customer master (`rkunpf`)       | `rkemal`   |


## 8. Typical Use Case Flow

1. **The calling program starts FO798R**, passing customer/order/project/etc.
2. **User sees an input screen** (for review/edits).
3. **Program fills in best-guess emails and subject lines** based on database priority.
4. **User may adjust addresses, choose contact, add message lines**.
5. **Validation**: Program ensures an email address is set.
6. **Fields are moved back to parameters**, for the calling program (which may then email a report/attachment).

---

**In summary**:  
FO798R is a utility RPG program for preparing and validating email content and recipient addresses for reporting purposes, with sophisticated prioritization of email sources, deep integration with the firm's master data, and multi-tenant (company) support. It is tailored for "Mestergruppen" and evolved over many years to support various business requirements in customer communication workflow.