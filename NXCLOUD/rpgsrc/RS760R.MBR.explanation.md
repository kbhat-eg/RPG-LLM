# Explanation of RPG Source Code: Kontroll av gyldig leverandørnummer

## Overview

This RPG source code is a program designed to validate a supplier (leverandør) number within a specific system environment (most likely IBM i/AS400). The program checks:

- Whether the supplier exists in the register.
- Whether the supplier is blocked ("sperret").
- Whether the supplier is marked as passive.

It returns appropriate codes and messages depending on the status of the supplier.

---

## Key Components

### Header and Metadata

```rpg
h datedit(*dmy) option(*nodebugio)
```
- `datedit(*dmy)`: Sets default date format to day-month-year.
- `option(*nodebugio)`: Disables debug information during I/O.

The comments at the top document the program's purpose, revision history, return codes, and special instructions.

---

### File Declarations

```rpg
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
```
- Declares a logical file `rlevl1` for supplier data, referencing the physical file `rlevpfr` and giving it a record format name `rlevl1r`.

---

### Constants and Data Structures

```rpg
d txt             s             30    dim(3) ctdata perrcd(1)
```
- `txt` is a 3-element array of 30-character messages, loaded from compile-time data (at the bottom of the source).

**Parameter Variables:**
```rpg
d p_levr          s                   like(rllevr)
d p_navn          s                   like(rlnavn)
d p_retk          s              1
```
- `p_levr`: Parameter for supplier number.
- `p_navn`: Parameter for supplier name (output).
- `p_retk`: Return code ("N", "S", or "P").

**Miscellaneous Variables:**
- `w_firm`, `w_levr`: Work variables for firm and supplier number, modeled after file fields.
- `l_user`, `l_firm`, `l_fnav`: Fields from incoming data (positions specified), likely part of a data structure for external calls or I/O buffers.
- `rlevl1_levr`: Work variable for chaining on supplier number.

---

### Parameter List

```rpg
c     *entry        plist
c                   parm                    p_retk
S500 c***                parm                    p_firm
c                   parm                    p_levr
c                   parm                    p_navn
```
- *Entry point* for the program uses a parameter list:
    - `p_retk` (return code OUT)
    - `p_levr` (supplier number IN)
    - `p_navn` (supplier name OUT)

    *Note: `p_firm` is commented out (removed in version V5.00, per comments).*

---

### Main Logic Steps

#### 1. Initialize Variables

```rpg
c                   eval      w_firm = l_firm
c                   eval      p_retk = *blank
c                   eval      p_navn = *blank
```
- Set work variable `w_firm` from input data.
- Clear the return code and supplier name.

#### 2. Check if Supplier Exists

```rpg
c                   eval      rlevl1_levr = p_levr
c     rlevl1_key    chain     rlevl1r                            60
```
- Loads the input supplier number into the work variable.
- Chains (retrieves record) against the supplier file using the firm and supplier number as key.

#### 3. Supplier Not Found

```rpg
c                   if        *in60 = *on
c                   move      'N'           p_retk
c                   move      txt(1)        p_navn
c                   goto      slutt
c                   endif
```
- If the chain fails (`*in60` is on):  
    - Set return code to "N" (not found).
    - Set supplier name to error message: "LEVERANDØRNUMMER ER UGYLDIG".
    - Jump to end of program.

#### 4. Supplier is Blocked

```rpg
c                   if        rlsprk = 'J'
c                   move      'S'           p_retk
c                   move      txt(2)        p_navn
c                   goto      slutt
c                   endif
```
- If field `rlsprk` indicates blocked ("J"):  
    - Set return code to "S".
    - Message: "LEVERANDØREN ER SPERRET".
    - Jump to end.

#### 5. Supplier is Passive (version 6.30 and up)

```rpg
c                   if        rlpass = 'J'
c                   move      'P'           p_retk
c                   move      txt(3)        p_navn
c                   goto      slutt
c                   endif
```
- If field `rlpass` is "J":  
    - Set code to "P".
    - Message: "LEVERANDØREN ER PASSIV".

#### 6. Supplier is Valid

```rpg
c                   move      rlnavn        p_navn
```
- If all checks pass, output the supplier name.

---

### Subroutine: Key List for Supplier Search

```rpg
c     rlevl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rlevl1_levr
```
- Defines the key for chaining to the supplier file: combo of firm and supplier number.

---

### Program End & Clean-up

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- Program label for clean exit.
- `*inlr = *on` signals program end and resource release.

---

### Compile-Time Data (Messages)

```rpg
**
LEVERANDØRNUMMER ER UGYLDIG
LEVERANDØREN ER SPERRET
LEVERANDØREN ER PASSIV
```
- These are loaded into the `txt` array for use as error/special state messages.

---

## Return Codes

- **N**: Supplier not found
- **S**: Supplier is blocked
- **P**: Supplier is passive
- **" "**: (blank) means valid supplier

The parameter `p_retk` (return code) is set accordingly and `p_navn` contains either the supplier name or the appropriate message.

---

## Summary Table

| Return Code (`p_retk`) | Meaning                           | Name Returned (`p_navn`)          |
|------------------------|-----------------------------------|------------------------------------|
| N                      | Not found in register             | "LEVERANDØRNUMMER ER UGYLDIG"     |
| S                      | Supplier is blocked               | "LEVERANDØREN ER SPERRET"         |
| P                      | Supplier is passive               | "LEVERANDØREN ER PASSIV"          |
| (blank)                | Supplier is valid                 | Supplier name                      |

---

## Key Takeaways

- The program provides a robust way to validate supplier numbers with clear reasons for rejection.
- Uses RPG's file handling and parameter passing for modular validation.
- Easy to adapt if new supplier statuses need to be handled.

---

If you maintain or extend this code, focus on keeping the status checks updated with business rules, and ensure the compile-time message data aligns with possible status codes.