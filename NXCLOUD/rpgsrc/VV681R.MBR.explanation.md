# Program Overview

This RPG program (`VV681R`) is responsible for selecting (and, presumably after further processing, deleting) inventory items ("varer") that meet strict criteria for batch deletion, such as not having been sold or created within a certain period, not being on order or in stock, etc. It's specialized to delete obsolete and unsold items from the product master file, supporting complex business logic governed by many parameters.

## Key Sections

- **Header & Change Log**:  
  Documents the program's purpose, its system (`ASOFAK`), main operations, and a chronological log of changes.
- **File Definitions**:  
  Several input and output logical files related to inventory, stock, counting, and sales statistics.
- **Data Structures**:  
  - Multiple data structures for parsing parameters, sorting, grouping, and keys.
- **Variables**:  
  - Variables for state (flags), dates, and fields used in processing logic.
- **Prototypes & External Calls**:  
  - Defines and calls external programs (notably `VL710R`, `VV490R`, and `CO402R`) for specialized logic.

---

## Core Logic

### 1. **Initialization**
- Accepts a parameter string (`p_list`) containing various selection criteria (firm, counter, batch number, sort orders, months since creation/sale, obsolete item flag, etc.).
- Copies parameters into a structure for easier field access.
- Sets up key lists for later file access.
- Fetches the company number from the parameters.
- Calls program `CO402R` to set a flag (`u_s701`) which affects later processing (controls if we check for certain item types).

### 2. **Date Calculations**
- Determines dates "so many months ago" for both:
  - Creation date (`w_dato_o`) — current date minus `d_anto` months.
  - Last sale date (`w_dato_s`) — current date minus `d_ants` months.
- These dates are used as cutoffs for item selection.

### 3. **Main Item Selection Loop**
- Reads through the item master file (`vvarl1`).
- For each item:
  - Calls `VL710R` to retrieve item type and other info.
  - **Filters by item type** unless overridden by parameter (`u_s701`).
  - **Creation date check**: skips recent items.
  - **Order/Stock Check**:
    - Calls `VV490R` to see if the item is on order or in stock.
    - Excludes items on order.
    - Excludes items in stock if not batch-counted.
    - If batch number is selected, checks against physical and counted inventory batches, only passing if the item isn’t present.
  - **Sale Check**:
    - Excludes items with sales within the cutoff period.
  - **Optional: Obsolete Item Test** (if parameter dictates):
    - Calls subroutine `utg_vare` to check if the item or all its stock locations are marked obsolete, as of the current date.
    - If not obsolete, skip.
  - **Sorting Key Assembly**:
    - Builds a sorting key for the output file, based on up to four sort parameters.
  - **Output**:
    - Writes the candidate item to a workfile (`vvawpf`).

### 4. **Termination**
- Ends properly, setting on the LR (last record) indicator.

---

## Subroutines

### `utg_vare`
Used to determine if an item or all its stocks are obsolete.  
- **Checks at Item Level**: If item-level obsolete date (`vvudat`) is set and has passed, marks as obsolete.
- **Checks at Stock Level**: Iterates all stock locations (`vlagl1`) for that item, marks as obsolete if all locations’ obsolete dates have passed.

### `*inzsr`
- Handles program initialization.
- Unpacks parameters, sets up key fields for file access.
- Might perform an initial supplier/type check for further filtering.

---

## External Calls

- `VL710R`: Retrieves item type and extra info for a given item.
- `VV490R`: Checks if an item exists on order or in stock.
- `CO402R`: Looks up configuration to control item type checking.

---

## Parameters (Derived from Data Structures)

- **Firm**: Company number.
- **Batch**: Used for filtering counted/physical stock.
- **Sort orders**: Up to 4 sorts (group, supplier, description, item number).
- **Months**: How many months back for last sale/creation.
- **Obsolete Flag**: Whether to filter by obsolete status.

---

## Key Business Rules

- Candidate items must:
  - Belong to specified item types (unless overridden).
  - Not have been created or sold within cutoff months.
  - Not be in order, in packing slip, counted, or have inventory.
  - If batch-counted, must not appear in relevant batches.
  - Optionally, be obsolete (item-level or all stockpoints).

---

## Comments on Code Quality and Maintenance

- **Highly parameterized**: Designed for batch jobs with flexible criteria.
- **Heavily commented and versioned**: Shows a long maintenance history.
- **Complex logic delegation**: Uses external CL/RPGLE programs for encapsulating business rules.
- **Hardcoded field names**: Typical for legacy RPG, but can hinder maintainability.
- **Data structures**: Overlays are used for parsing parameter strings—common in RPG, but can be confusing for new developers.

---

## Onboarding Notes

- **Understand the external programs** (`VL710R`, `VV490R`, `CO402R`) as business logic is delegated there.
- **Parameter structure** is critical: know what each offset/field means.
- **The workfile (`vvawpf`)** is the main output; it will be processed elsewhere (for actual deletion?).
- To extend or alter criteria, adjust parameter parsing, or the selection logic as appropriate.
- For new development, consider modularizing with RPG IV/free-format code if possible for readability and maintainability.

---

## In Summary

This program selects items from inventory master data for deletion, according to user-supplied criteria (age, sales, type, batch, obsolete status, etc.), with many business rules enforced via code or external subprograms, and outputs a list for batch deletion. It is a good example of a highly parameterized legacy RPG batch processing utility.