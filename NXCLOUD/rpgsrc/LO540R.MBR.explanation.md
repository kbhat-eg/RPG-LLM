# RPG Program LO540R - Code Explanation

---

## Overview

This source code is an **ILE RPG (RPG IV)** program for IBM i (AS/400) and is named **LO540R**. The program manages queries on "purchase orders (not yet received per supplier)" for a business application. It uses green-screen (5250) user interfaces via display files and subfiles.

It covers display, data validation, subfile population, navigation, and interfacing with related programs for further order details or printing.

Code comments/variables are in Norwegian; this guide uses English for clarity and onboarding.

---

## Structure and Components

### File Declarations (`F-Specs`)

- **lohel1 / loheld**: Logical files over the purchase order header file (`lohepfr`), accessed by key.
- **rlevl1**: Logical file over supplier master (`rlevpfr`).
- **votyl1**: Logical file for order type validation (`votypfr`).
- **LO540d**: Display file (workstation) with subfile support and a feedback data structure (`infds(dspfbk)`) for handling screen positioning and function keys.

### Data Structures and Work Variables (`D-Specs`)

- **LDA fields**: Loads user, company, and warehouse info from system area.
- **Display feedback data structure**: Used for remembering cursor position.
- **Key variables**: For chaining to indexed files.

- **Work variables**: 
    - Control subfile (page size, screen record number)
    - Search/filter fields (date, supplier, warehouse)
    - State flags (e.g., `b_forn`, indicates subfile needs refresh)
    - Temporary fields for date calculations and current selections.

### Constants

- Defines constants like `c_sfil` for subfile page size, etc.

---

## Main Logic Flow

### 1. **Program Start**

- Entry point: the code starts by calling subroutine `xa1win` (filter screen), validates user inputs (date, supplier, warehouse).
- If user cancels (`*inkc`), the program ends.

### 2. **Date Calculation**

- Calculates the date to filter orders (`w_dato_p`) based on user input and additional days (`a1dagr`).

### 3. **Subfile Population**

- Positions the order header file (`loheld`) to the start position, then calls `crt_subfile` to fill the subfile (visible list on screen).

### 4. **Main Display Loop**

- Handles the main loop for the subfile control display:
    - Writes command footer (`b2cmd`).
    - Displays the subfile and control record (`b2ctl`).
    - Handles function keys via a `SELECT` statement:
        - Page up/down, print, refresh, exit, etc.
        - Each function triggers subroutines for their functionality.
    - After handling keys, controls the cycle of subfile display, renewal, and user actions.

### 5. **Exit Handling**

- `*inlr = *on` ensures cleanup and program end.

---

## Key Subroutines

### `xa1win` - Filter Screen Input

- Presents the filter/form (date, supplier, warehouse).
- Validates fields:
    - Supplier exists
    - Date is valid
    - Warehouse is valid (via external call to `RS710R`)
- Handles F-key actions; if validation fails, highlights error and requests correction.

### `forny` - Refresh Subfile

- Decides which order date to position to.
- Clears and repopulates subfile from current position.
- Resets the `b_forn` flag.

### `subfile` - Handle Subfile Actions

- Reads user entries in subfile (using `READC`).
- Handles line-specific actions:
    - Value "5": View order details (`vis_best`)
    - Value "2": Change order (`ovg_best`)
- Marks `b_forn` if subfile needs to be rebuilt after action.

### `ovg_best` / `vis_best` - Call Other Programs

- Call external programs (`LO500R` or `LO505R`) for order change or order view, passing relevant keys.

### `clr_subfile` - Clear Subfile

- Writes control record with an indicator to clear screen.
- Resets subfile control variables.

### `crt_subfile` - Build/Fill Subfile

- Loops to read the next `c_sfil` records matching filters.
- Applies complex filtering:
    - Order type must be valid
    - Supplier and warehouse matches (if specified)
    - Filters by expected and actual dates per user choice
    - Skips records that do not match the filters
- Fills subfile records with all user-readable order data.
- Sets subfile page and record range tracking variables.

### `bck_subfile` - Page Up in Subfile

- Reads backwards in the file up to one subfile page.
- Applies same data selection/filtering as normally.
- Rebuilds subfile for previous page.

### `dsp_subfile` - Display Subfile

- Shows the subfile page if there are entries, or the command line if not.
- Handles 5250 subfile indicators for display and protection.

### `spørring` - Inquiry for Supplier or Warehouse

- If cursor is on supplier: calls supplier info program (`RL500R`).
- If cursor is on warehouse: calls warehouse info program (`RA510R`).

### `utskrift` - Print List

- Calls external print/list program (`LO614C`) with current filters.

### `*INZSR` - Initialization

- Defines file keys for all logical files.
- Loads initial user, company, and warehouse values from LDA.
- Sets initial order date to two days ago.

---

## Indicator Usage

- **LR**: Last record, triggers program end.
- **10–16**: Subfile page, display, and navigation.
- **30**: Field protection for display.
- **31–79**: Error/validation indicators.
- **80–99**: Working/file indicators.

---

## Screens, Subfiles, and Display Files

- **A1BLD**: Input screen for filter/criteria.
- **B1SFL**: Subfile for listing matching orders.
- **B2CTL**: Control record for subfile.
- **B2CMD**: Command keys screen.

---

## External Calls

- **LO500R**: Order change screen.
- **LO505R**: Order view screen.
- **LO614C**: Print program.
- **RL500R**: Supplier lookup.
- **RA510R**: Warehouse lookup.
- **RS710R**: Warehouse validation.

---

## Common Norwegian Terms in Variables

| Norwegian | English               |
|-----------|-----------------------|
| bestilling| purchase order        |
| leverandør| supplier              |
| lager     | warehouse             |
| dato      | date                  |
| navn      | name                  |
| type      | type                  |
| antall    | number/quantity       |
| visning   | display/view          |
| endring   | change                |

---

## Summary
- **LO540R** is a green-screen interactive RPG program for querying open (unreceived) purchase orders.
- It incorporates rich user navigation, subfile handling, validation, and integration with other order management modules.
- The code is structured with clear modular subroutines for maintainability.
- Understanding the named indicators and their use is key to following the program flow in RPG/5250 applications.
- The file and field names, though Norwegian, follow standard IBM i naming conventions for business applications. 

If onboarding to this codebase, focus on understanding subfile processing, RPG indicator handling, and how external programs are called for extended functions.