# FA120R – Jobb-register Status Maintenance (ASOFAK)

## Overview

This program, **FA120R**, is part of the ASOFAK system and is responsible for the maintenance of job status records (“Jobb-register status, Vedlikehold”). It provides an interactive workstation interface for viewing and updating the status of up to 10 job steps per job, including tracking of user activity and timestamps. It also facilitates inquiry into who performed each job step.

## Key Files and Data Structures

### Physical and Logical Files

- **fjobl1** (input, keyed, disk): Logical file over the job register, used for reading job status records. Renamed record format `fjobl1r`.
- **fjoblu** (update, keyed, disk): Logical file over the job register, used for updating/writing job status records. Renamed record format `fjoblur`.
- **fausrl1** (input, keyed, disk): User register, used to resolve user IDs to user names. Renamed record format `ausrl1r`.
- **fa120d** (workstation): Display file for user interaction.

### Variables

- **w_firm**: Current firm/company number (from `l_firm`).
- **w_bnav**: User name, resolved from the user register.
- **ausrl1_user**: User ID for lookup in user register.
- **l_user, l_firm, l_fnav**: Loaded from the user session/environment, used for audit fields.

## Main Program Flow

### 1. Initialization (`*inzsr`)

- Sets up key lists for file access.
- Loads the firm number (`l_firm`) into `w_firm` for use in file operations.

### 2. Main Loop (`a1taga` tag)

#### a. Fetch Job Status

- Chains into `fjobl1` using the firm as key.
- If found, loads job step statuses (`fajb01`–`fajb10`) into screen variables (`a1jb01`–`a1jb10`).
- If not found, initializes all fields to zero.

#### b. Display and User Interaction

- Displays the main maintenance screen (`a1bld`).
- Handles function keys:
  - **F3/Exit**: Jumps to program end.
  - **F1/Inquiry**: Allows user to inquire who performed a specific job step.

#### c. Inquiry Logic (F1)

- Determines which job step is selected for inquiry based on the field (`w_afld`).
- For the selected step:
  - Sets `ausrl1_user` to the corresponding user ID (`faus0X`).
  - Calls subroutine `x_user` to resolve the user name from `fausrl1`.
  - Loads user name, user ID, workstation ID, date, and time into display variables for the inquiry screen (`a2bld`).
- Displays inquiry screen, then returns to the main screen.

#### d. Update Logic

- Chains into `fjoblu` for update.
- Updates job step statuses in the job register.
- If record exists, updates audit fields (edit date/time, user).
- If record does not exist, writes a new record and sets creation and edit audit fields.

### 3. Program End (`xslutt` tag)

- Sets LR indicator on and returns.

## Subroutines

### `x_user`

- Looks up the user name (`abnavn`) in the user register (`fausrl1`) for the given user ID (`ausrl1_user`), and stores it in `w_bnav`.

### `*inzsr`

- Initializes key lists for all files.
- Loads firm number into `w_firm`.

## Business and Domain-Specific Logic

- **Job Register**: Each job can have up to 10 steps, each tracked with a status, user, date, and time.
- **User Inquiry**: Users can inquire about who performed each job step, with the system resolving user IDs to names via the user register.
- **Audit Trails**: All updates are audited with user ID, date, and time fields for both creation and last edit.
- **Special Locking**: Comments indicate additional logic for EDI import and Compello/Navision integration, possibly affecting locking or job step 7 (`A1JB07`), though that logic is not explicit in this code.

## Notable Design Decisions and Conventions

- **Record Renaming**: All logical file record formats are renamed for clarity and to avoid conflicts.
- **Key List Usage**: Key lists are defined for each file, improving maintainability.
- **Audit Fields**: Audit fields are consistently updated for both new and existing records.
- **User Name Resolution**: Abstracted to a subroutine for maintainability and reuse.
- **Field Mapping**: The code uses a repetitive pattern to map each job step’s status/user/date/time fields, which could be refactored but is kept explicit for clarity and maintainability.
- **Display Files**: Two screens are used: one for job status maintenance, one for inquiry.

## External Relationships

- **Job Register Files (`fjobl1`, `fjoblu`)**: Central data source for job status.
- **User Register (`fausrl1`)**: Used for resolving user IDs to user names.
- **Display File (`fa120d`)**: Handles all user interaction.

## Summary Table

| Functionality         | File(s)         | Purpose                                    |
|----------------------|-----------------|---------------------------------------------|
| Read job status      | fjobl1          | Load job status for display                 |
| Update job status    | fjoblu          | Update or add job status records            |
| User lookup          | fausrl1         | Resolve user ID to user name                |
| User interaction     | fa120d          | Display/update/inquire job status           |

## Maintenance Notes

- If adding more job steps, replicate the inquiry and update logic.
- If changing audit requirements, update both update and write branches.
- For integration with other modules (e.g., EDI, Compello/Navision), review comments and ensure locking or job step handling is consistent.

---

**In summary:**  
FA120R is a maintenance program for managing job status records, supporting both updates and detailed inquiries into user activity, with full audit tracking and a clear separation of business logic for job steps and user resolution. The code is explicit and repetitive for clarity, with conventions ensuring data integrity and traceability.