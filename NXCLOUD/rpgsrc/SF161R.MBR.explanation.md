# RPG Program SF561R – Explanation

This program is written in RPG IV (ILE RPG, /FREE and fixed format) and is part of a sales statistics system processing orders on IBM i (AS/400). The design is typical for maintenance of subfile-based inquiry or registration screens for orders, invoices, and associated statistics.

Below, the code is broken down into logical components, focusing on the program's structure, key data, subroutines, and business logic.

---

## **1. Header/Metadata**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: No debug for file I/O, for performance.
- `datedit(*dmy)`: Default date handling is Day-Month-Year.

The long comment header documents the program, change history, special versions, and indicator usage conventions.

---

## **2. File Specifications**

There are multiple disk files, mostly renamed for local use, all defined as keyed and externally described. These files represent various sales, customer, and order records.

- `sstal3`...`sstal8`: Sales statistics files by different keys.
- `rkunl1`: Customer master.
- `fkprl1`: Customer project master.
- `sohel1`, `bohel1`: Invoice and receipt headers.
- `fstsl1`, `fohel1`, `fodtl1`: More sales, order headers, and detail files.

A workstation file is defined for the main display and subfile:
```rpg
fsf161d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- `sf161d`: Display file using subfile `b1sfl` with relative record number `w_srrn`.
- `infds(dspfbk)`: Special data structure for display feedback (e.g. cursor location).

---

## **3. Data and Variable Definitions**

### **Parameters**
Variables such as `p_kode`, `p_firm`, `p_paar`, `p_vkun`, etc., represent parameters passed in and mapped to certain fields in the files.

### **Local Data Area**
Used for storage of user, company, and name information pulled from the LDA.

### **Key Variables**
Variables to build keys for file access (e.g., `sstal3_vare`, `sstal3_kpro`, etc.).

### **Working Variables**
Used for subfile and screen management:
- `w_fcrn`: First record number on the page.
- `w_stel`: Subfile record counter.
- `w_spge`: Subfile page size.
- `w_srrn`: Subfile relative record number.
- `w_sfrn`, `w_ssrn`: First and last subfile record numbers.

Others hold company, year, customer, item, etc., for different business logic.

### **Constants**
- `c_sfil`: Subfile page size constant.

---

## **4. Indicator Usage**

Indicators are mapped and explained in comments, e.g.,
- `LR = Avslutt program`: Last record, end program.
- `10 = Roll`, `11 = Rolldown`: Paging in subfiles.
- `14 = Sflclr`: Subfile clear.

---

## **5. Subfiles and Screen Management**

Subfiles allow the display and editing of multiple rows of data per screen. Common subfile focuses:
- `B1SFL`: Main data subfile.
- `B2CTL`: Control record.
- `B2CMD`: Command key record.

Subfile handling involves loading, clearing, updating, and paging through subfile records.

---

## **6. Main Processing Loop**

The main logic cycles through the following steps, using *EXSR* and GOTO control flow:

1. **Display Subfile** and command keys.
2. **Function Key Handling** with SELECT/WHEN:
   - e.g., F3/F12 (`*inkc`/`*inkl`) exits, F6 (`*inke`) refreshes, F10/F11 for paging, etc.
3. **Text Line Registration** (`F2`) via subroutine `tekstlinje`.
4. **Positioning** if one of the search fields (`b2vare`, `b2tek1`, etc.) is set, via `posisjoner`.
5. **Subfile Editing/Updating** via subroutine `subfile`.
6. **Exit**.

---

## **7. Key Subroutines**

### **forny (Refresh Subfile)**
- Positions appropriate file using key list depending on the last search mode, clears and reloads subfile records.

### **posisjoner (Position in Subfile)**
- Determines how to position the subfile view depending on which search field is set (item, text, project, invoice date, invoice number, order number).
- Sets keys and positions files accordingly.
- Always clears and reloads the subfile, then blanks out position/search fields.

### **subfile**
- Reads all changed subfile records with `readc b1sfl` (changed records).
- Handles business logic based on user actions (show sales details, print invoice copy, register new line, etc.), calling external programs as required (`SF510R`, `FD130R`, etc.).
- Resets selection/flag fields and updates the subfile.

### **clr_subfile (Clear Subfile)**
- Sets indicators, clears the subfile, and resets record counters.

### **crt_subfile (Create/Fill Subfile)**
- Loops to fill subfile page by page, reading records from the correct sales statistics file depending on last search.
- Maps fields from file to subfile and calculates derived values (e.g., price per item).
- Applies filters on project and posting date if specified.
- Calls `newlo_vask` subroutine for Newlook screen compatibility fixes.

### **bck_subfile (Page Back in Subfile)**
- Reads records back a page, positions the file, fills the subfile with a previous set of records.

### **dsp_subfile (Display Subfile)**
- Handles display logic, writes control record, manages indicators, updates `w_fcrn` from the display feedback.

### **spørring (Inquiry/Prompting)**
- Calls external programs for item or project lookup and fills in results.

### **tekstlinje (Registering Text Line)**
- Calls external routine (`FD110R`) to register a new text line for the order.

### **hent_total (Get Order Totals)**
- Sums up order totals from detail lines for total and returned amount.

### **vise (Show Invoice/Receipt)**
- Shows invoice or sales receipt details, calls the corresponding program based on which type of document is on the current line.

### **skriv (Print Invoice Copy)**
- Prints a copy of the invoice or receipt, handles special case for old sales system receipts.

### **newlo_vask (Newlook Data Cleanup)**
- Cleans up field content (such as removing trailing periods or colons) to prevent screen rendering issues in Newlook emulator.

---

## **8. Initialization (`*inzsr`)**

- Handles parameter passing on program entry.
- Chains to appropriate records to fill out initial data (company, order, project, etc.).
- Initializes subfile for display.

---

## **9. Key Lists for File Access**

Key lists (`klist` and `kfld` statements) are defined for easy indexed access to the various files for positioning and lookup.

---

## **10. External Program Calls**

The code makes multiple calls to external programs for business logic not implemented here, such as:
- `SF510R`, `BO310R`, `SO510R`, `FO681R`: Invoice/receipt displays, and printing.
- `FD110R`, `FD130R`: Order line and text line registration.
- `VV500R`, `FL501R`: Lookups for items and customer projects.

Parameters for these calls are carefully mapped and supplied from the current working variables or fields the user has input/selected.

---

## **11. Indicators and Error Handling**

- Indicators (e.g., `*in12`, `*in14`, etc.) are heavily used to control screen behavior and program flow.
- Special care is taken to handle not found records, end-of-file, and to avoid division by zero.

---

## **Summary: The Program Flow**

1. On entry, receives key input parameters.
2. Initializes screen fields and subfile.
3. Loops to allow user to page, search, select, or update lines in the statistics subfile.
4. Handles function keys and triggers business logic via subroutines and external programs.
5. Manages screen fields, indicators, and subfile records accordingly.
6. Allows for searching/positioning by various fields (item, text, project, date, etc.).
7. Graceful exit and cleanup.

---

## **Key Takeaways for Onboarding**

- **Subfiles** are central: Most processing is about loading, clearing, or paging subfiles and acting based on user input per subfile line.
- **External program calls** are used for core business actions (display, register, print).
- **Indicators** and **key lists** are essential tools for navigation and data manipulation.
- **Variables with common prefixes** (e.g., `w_`, `b1`) are for working (in-memory) and subfile fields, respectively.
- **Screen and field handling** is closely tied to indicator and feedback data structure usage.

---

This program is a good example of classic RPG maintenance logic, suitable for onboarding new developers in the context of IBM i green-screen applications, especially those based around subfiles and inquiry/update screens.