# RPG Program Explanation

This RPG program is designed to extract data from an accounting database (`RHTRPF`), process it, and output it as XML in a standard format. It is tailored to handle Norwegian company accounting entries ("hovedbok" = general ledger), and it supports flexible XML output based on control files and parameter data areas.

---

## File Declarations

```rpg
frxmll1    if   e           k disk    rename(rxmlpfr:rxmll1r)
frhtrl5    if   e           k disk    rename(rhtrpfr:rhtrl5r)
faxmlut    o    e             disk
```
- **frxmll1**: Input file, likely holding XML template/specification lines.
- **frhtrl5**: Input file with accounting transactions (the general ledger entries).
- **faxmlut**: Output file for the generated XML lines.

---

## Key Data Structures and Fields

- Many `d` specifications define fields used to hold data from these files, control parameters, work variables (e.g., company, periods, account numbers, XML building work fields).
- There are fields for key structures for setting and reading the correct records in each file.

---

## Initialization (`*inzsr` subroutine)

- Reads processing parameters from a data area (`ax000par`) including:
  - Start/stop periods
  - Comment string (possibly for the XML header)
  - Company code: `w_firm`
- Initializes first positions in input files (`rxmll1`, XML templates).

---

## Main Logic

### High-level Flow

1. **Initialize keys and set position in files**
2. **Skip to required voucher (bilag) if needed**
3. **Read and output any XML header lines for the ledger until marker 'S'**
4. **For each accounting voucher:**
   - Process each by calling the `Bilag` subroutine.
5. **Output any XML footer lines**
6. **End**

---

### Subroutine: `Bilag` (Process a Voucher / Bilag)

- For each voucher:
  1. Reset to the correct XML template lines for a voucher
  2. Output any start XML lines
  3. Save current voucher number and date
  4. For each line in the voucher, process by account with `BehKonto`
  5. Output any end XML lines for the voucher

---

### Subroutine: `BehKonto` (Process an Account Posting)

- For each account posting within a voucher:
  1. Find the corresponding XML template lines
  2. Output all lines until marker 'E' (end of account)
  3. Read next posting for the same voucher

---

### Subroutine: `SXMLUT` (Output XML Line)

This is a **complex routine** responsible for parsing the XML template line (`axxmlt`), determining if it should be output, and performing variable substitution:

- **Skip or conditionally output lines:**  
  Based on template codes (`axmaop`, `axfast`, `axfelt`, `axtype`).
- **Substitute variables:**  
  - `?V?` is replaced with a value from the current posting or parameter
  - Handles date, character, numeric, parameter, and fixed fields
- **Output the processed XML line** using `write axmlutr`.
- **Special handling** for:
  - Numeric fields: Formatting, decimal placement, handling negative numbers, and currency/foreign exchange lines
  - Date and text character cleaning and XML escaping (e.g., replacing `&`, `<`, `>`, `'`, `"` with XML entities)

---

### Subroutine: `redefnum`

- Formats text representations of numeric values correctly for XML
  - Removes leading zeros
  - Inserts decimal point appropriately
  - Handles special case for zeroes

---

### Subroutine: `redmvak`

- Maps specific text (often codes or letters A, B, ...) to two-digit or special numeric codes
  - Used for value-added tax (MVA) codes

---

### Subroutine: `spstgn`

- Cleans and standardizes Norwegian special characters (æøå ØÆÅ etc.) to legal encodings for XML output
- Escapes XML special characters.

---

### Key Concepts

- **Control via Template File (`rxmll1`)**:  
  The XML to be output is "driven" by template records which may include in-line substitution codes.
- **Dynamic Field Substitution**:  
  The code can insert fields' values in the XML based on the context (voucher/account/parameter).
- **Conditional Output**:  
  Some XML tags are only emitted if certain criteria are met, e.g., skipping if a value is zero.
- **Multi-currency Handling**:  
  When exporting amounts, if currency is not NOK, outputs extra XML lines for currency code, amount, and exchange rate.

---

## Comments on Code Structure

- **Heavily Subroutine-driven**:  
  Most processing is done via internal subroutines (`begsr`, `endsr` pairs).
- **Legacy Syntax**:  
  Uses fixed-format RPG with some enhancements (e.g. `%scan`, `%subst`, `%trim`).
- **Localization**:  
  Several comments and variable names are in Norwegian; be aware of domain-specific terminology.

---

## Extension/Modification Points

- **Change or expand the XML output format**:  
  Modify `rxmll1` template file or logic in `SXMLUT`.
- **Add fields**:  
  Update the file interface, processing logic, and potentially the XML templates.
- **Modify voucher/account selection**:  
  Change initial positioning logic or filtering conditions.

---

## Summary

**Purpose:**  
This program transforms accounting journal transactions into structured XML, using a template-data-driven approach and strong support for conditional output and data transformation.

**Key points for onboarding:**
- Understand the role of `rxmll1` (XML templates) and `rhtrl5` (journal data)
- Study `SXMLUT` for XML output logic
- Familiarize with Norwegian ledger/accounting terms as used in the code and data

---

**Tip:**  
To modify the output structure, adjust the templates and variable substitution logic, rather than hardcoding XML lines in the program. The program is designed to be flexible and data-driven in this respect.