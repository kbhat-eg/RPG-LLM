# Program Overview

This RPG application, `FO910R`, is a complex and business-critical program for generating quotations (tilbud) in a Norwegian business context, with extensive support for printing, archiving, emailing, and exporting to XML/JasperReports. The code is written in traditional fixed-format RPG with modern RPGLE/free-format extensions for integration (e.g., CGIDEV2 APIs for XML). It handles customer/order data, pricing, VAT calculations, and supports multi-channel output (physical printers, email, archiving, and PDF/XML/preview generation).

## Main Features

- **Order/Quote Output:** Prints and exports customer quotations.
- **Multi-format Output:** Supports classic spooled output, email, XML export for JasperReports, and preview/PDF generation.
- **Customer/Order/Item handling:** Reads various master and transaction files for order, customer, items, prices, departments, etc.
- **VAT/Discount logic:** Calculates line-level and document-level discounts, VAT, and handles multiple VAT rates.
- **Archiving/Meta Tagging:** Exports detailed metadata for archiving and downstream processes.
- **Configurable:** Driven by parameters, LDA values (for firm, user, output queue, etc.), and supports different output formats.

---

## High-level Structure

1. **File Definitions:** Input/output files for orders, order lines, customers, pricing, etc.
2. **Work Variables:** Extensive work fields for all aspects of the document.
3. **Parameter Passing and Initialization:** Handles entry parameters for external control (e.g., customer no., mail flag).
4. **Main Processing Loop:** Interprets records from input, branches to appropriate handlers for header, line, text, totals.
5. **Section Handlers:** Subroutines/tags for distinct document sections (header, line, text, totals).
6. **VAT Array Handling:** Manages multiple VAT rates via arrays.
7. **Email/XML Integration:** Special subroutines for mail commands and generating XML/Jasper archives.
8. **Overflow Handling:** Ensures proper page formatting and splitting for printed documents.

---

## Core Workflow

1. **Startup and Initialization:**
   - Maps parameters, initializes work fields and arrays.
   - Reads LDA for firm, user, outq, special flags.
   - Determines output type (printer, email, XML/Jasper, preview).

2. **Processing Input Records:**
   - Reads input record, determines record type (header, line, text).
   - For each type, routes to the correct section via tags/subroutines.

3. **Header Processing (A1HDR, A2HDR, A4HDR):**
   - Retrieves order header data.
   - Fetches customer info, payment terms, delivery address, references.
   - Applies firm/department overrides as needed.
   - Calculates and formats customer contact info.
   - Handles both print and XML/export output differently.

4. **Detail Line Processing (D1DET, D2DET):**
   - Retrieves and formats item info (item number, text, unit, type).
   - Handles discounts, VAT, net/gross calculations.
   - Deals with length specifications if present.

5. **Text Line Processing (E1DET):**
   - Retrieves and writes free-text lines related to the order/lines.
   - Integrates with XML export as needed.

6. **Totals (T1TOT and related):**
   - Calculates document totals, applies global discounts, totals VAT.
   - Writes the summary section.

7. **Archiving/Meta Data:**
   - If exporting/archiving, writes XML/Jasper meta tags with comprehensive order data.

8. **Email Handling:**
   - If "email" is selected as output, composes mail, sets recipients, message body, and SMTP info.

9. **Overflow and Printing:**
   - Handles page overflow, ensures headings are repeated as necessary.

10. **XML/Jasper Export:**
    - Writes XML file to IFS for JasperReports integration.
    - Handles previewing via external launch.

---

## Important Data Structures and Variables

- **Array Variables (for VAT):** Arrays for managing up to 9 VAT rates.
    - `mko` : VAT code
    - `msa` : VAT percentage
    - `mgr`, `mor`, `mog`, `mbe`: VAT calculational arrays

- **Input/Output Files** (first column on file lines gives version when added):
    - Customer, item, pricing, and order master/transaction files.
    - Printer file (FO910P) for classic output.

- **Parameter Variables:**
    - `p_mail`, `p_kund`, `p_kpro`, `p_numm`, `p_selg`, etc. are used for controlling output type, recipient, and message content.

- **Integration fields:**
    - Fields for email and XML output (`p_emal`, `p_ema2`, etc.), file paths, flags for preview, archiving, etc.

- **LDA Data:**
    - LDA is used to pass runtime parameters such as user, outq, department, etc.

---

## Key Subroutines

### 1. **SBBETB (Payment Terms)**
   - Calls external program to fetch payment terms and fills in description fields.

### 2. **XOVRFL (Overflow Handler)**
   - Handles output overflow, writing transfer and header lines as needed.

### 3. **XARRAY (VAT Array Handler)**
   - Manages VAT arrays for multiple VAT rates on one document.

### 4. **XSTRSR (Startup)**
   - Initializes variables, looks up company/order types, resets arrays.

### 5. **XML/Jasper Subroutines**
   - `xml_envm`: Writes environmental and reporting variables for XML output.
   - `xml_head`, `xml_deta`, `xml_rabatt`, `xml_netto`, `xml_vat`, `xml_totaler`:
     - Write distinct XML sections for different document parts.
   - `xml_topt_str`, `xml_topptxt`, `xml_topt_end`: Top text handling.
   - `xml_bott_str`, `xml_bunntxt`, `xml_bott_end`: Bottom text handling.
   - `xml_end`: Finalizes XML, writes meta tags, and commits archive info.

### 6. **hnt_avde**
   - Fetches department information for output.

### 7. **skr_leng / xml_spec**
   - Handles length specifications for line items, both for print and XML contexts.

---

## Special Note: Output Modes

- **Classic Print:** Writes to spooled file (`FO910P O E PRINTER`) in structured formats (headers, details, totals).
- **PDF/XML/Jasper:** Uses CGIDEV2 routines (`UpdHTMLVar`, `WrtSection`, etc.) to build XML for downstream processing by JasperReports/PDF.
- **Email:** Gathers email recipients and body, invokes mail handling routines.
- **Preview:** Generates all output but launches PDF viewer instead of printing.

---

## Business Logic Highlights

- **Customer/Partner selection:** Various rules for selecting the right customer address (order customer, invoice customer, or project customer).
- **Discount and VAT calculation:** Fully supports line-level and order-level discounts, multiple VAT rates.
- **Text and Meta Data:** Extensive text fields are available at all document levels (header, line, free-text) for customer and internal purposes.
- **Configurable archiving:** Each document exported to XML/Jasper has rich meta tagging for later retrieval and audit.

---

## Version Control and Comments

- The code is heavily commented with a running log of enhancements by version and date (in Norwegian).
- Each function/subroutine is documented inline.
- Many enhancements relate to extensions for export, XML, archiving, and integration with other systems.

---

## Integration Points

- **External Programs:** Calls to programs for:
    - VAT calculation (`RS205R`)
    - Fetching payment terms, customer info, department info, document templates
    - Email handling (`AM705C`, `FO798R`, `FM798R`)
    - Logging/archiving (`AB705R`, `AS100R`)
    - PDF preview (`AP621R`)
    - CGIDEV2 HTML/XML routines

---

## Summary For New Developers

- This program is a robust, legacy RPG application with modern enhancements for document output and integration.
- Output is highly flexible: print, email, archive, preview, and XML/Jasper.
- It is modular; major document sections handled by branching/tag/subroutine techniques.
- Document formatting and output are driven by business rules, runtime parameters, and extensive master data lookup.
- Email and XML integration are handled using both classic RPG and modern procedures (CGIDEV2, `UpdHTMLVar`, `WrtSection`).
- All business logic (customer handling, address, reference logic, price/discount/VAT calculation) is explicit and well-documented.
- The codebase has a history of continuous improvement and is a key part of the quotation/order output process.

---

### **Onboarding Tips**
- Study the file definitions and work variables to understand the data landscape.
- Review the main processing sequence: initialization → record type branching → section handlers.
- Pay close attention to array handling for VAT and the multiple-output logic.
- Use the inline comments for understanding business rule changes by version.
- For XML/Jasper integration, understand how data is mapped to XML via `UpdHTMLVar` and `WrtSection`.
- For debugging/extension: identify which output type you want (print, email, XML), and trace logic along that branch.

---

**If you have a specific area or process flow you're interested in (e.g., only email handling, or VAT calculations), let me know for a deeper dive!**