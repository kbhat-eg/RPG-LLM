# Explanation of GL120R RPG Program

## Overview

**Program Name:** GL120R  
**System:** ASOKON  
**Purpose:** Maintenance of master data for electronic payment processing, specifically updating and maintaining records in the GFASPF file.  
**Date:** Original - October 28, 1994, with several historical modifications  
**Author:** Annotated (RH, NHO)

This program has a workstation interface for user input, validates entries, manages interaction with several physical and logical files, and allows calls to other programs for related tasks.

---

## Main Functions (Business Logic)

- Maintains master data about electronic payment processing.
- Presents a main maintenance screen (A1BLD) for input and changes.
- Reads, updates, or inserts records in the **GFASPF** (payment data), **GUSTL1** (customer?), and **DIRREM** (sequence numbers for payment files).
- Provides function key logic for navigation, calling sub-functions, and error handling.
- Performs basic field validation.
- Handles default values for some payment communication types (like IFS).

---

## Key Files

- **GL120D:** Workstation Display
- **GUSTL1:** Logical file, key access, for subsidiary data
- **DIRREM:** Physical file for retrieving last used sequence numbers (sequential access)
- **GFASPF / GFASLU:** Master file for payment processing, both input and output (rename for different access paths)

---

## Indicator Usage

- **KC:** `F3` = Exit
- **KL:** `F12` = Cancel
- **LR:** Last record, end of program
- **31-59:** Error/warning indicators for user messages/UI feedback
- **60-69:** File indicators (e.g., found/not found on CHAIN, etc.)

---

## Key Data Structures

- **oin/out:** Arrays for character manipulation (operator number padding/formatting)
- **dsdat1/dsdat2:** Used to swap date formats between YYYYMMDD and DDMMYYYY
- **dsqrem:** Used to extract sequence and other fields from DIRREM record

---

## Initialization (`*inzsr` Subroutine)

- Sets up key lists and working storage.
- Sets default values and screen positions.
- Attempts to read GFASPF for current company (`l_firm`).
- If found, loads data onto the maintenance screen.

---

## Screen Loop Logic

The main loop:

1. Displays the main maintenance screen (`a1bld`).
2. Handles `F3` or `F12` for program exit.
3. Runs field validation (`xa1tst`).
4. If validation errors, redisplay with highlights.
5. If operator number needs formatting (DnB bank), pads/fixes as needed.
6. Updates file with entered values (`xovfa1`).
7. Handles function keys to call out to:
    - **GL122R:** Declaration codes
    - **GL114R:** Agreement register
    - **GL121R:** Sequence counters (may exit if special condition returned)
    - **GL321C:** PC file naming (with group, firm, and communication type params)
    - Shows window with last used sequence numbers if requested

---

## Field Validation (`xa1tst` Subroutine)

- Checks for mandatory fields:
    - Company number (`a17fin`)
    - Sequence number (`a17efs`)
    - Bank code (`a17ban`)
    - Communication type (`a17kom`)
    - Sorting and merge fields (`a17sbf`/`a17sam`)
    - Special checks if communication type is 'IFS' (directory must be entered)
    - Payroll routine type must be '3'
- Sets screen indicators if errors are found

---

## Record to Screen/Screen to Record Transfer

- **xovfdi:** Loads data from GFASPF to screen fields, including:
    - Field mapping
    - Date format swapping
    - Sets default for IFS directory if blank
- **xovfa1:** Writes screen fields back to GFASPF record
    - Updates or writes new record (using indicator 60 to determine found/not found)
    - Updates or creates associated customer record in GUSTL1 if needed

---

## Date Handling

- Dates are managed via data structures, allowing fields to be swapped from one format (YYYYMMDD) to another (DDMMYYYY) for display vs. storage.

---

## Special Business Rules

- For DnB bank (`a17ban = 'DN'`), operator number is reformatted: trailing spaces are replaced with leading zeros.
- On first display, if communication type is 'IFS', sets directory default to '/Bankfiler/'.
- Calls to other programs use parameters for passing context (such as group, firm, and communication type).

---

## Selected Code Snippets (Clarified)

### 1. Date Format Swapping

```rpg
d dsdat1                         8
d  dsuår1                        4  0 overlay(dsdat1)
d  dsumn1                        2  0 overlay(dsdat1:5)
d  dsuda1                        2  0 overlay(dsdat1:7)
d dsdat2                         8
d  dsuda2                        2  0 overlay(dsdat2)
d  dsumn2                        2  0 overlay(dsdat2:3)
d  dsuår2                        4  0 overlay(dsdat2:5)

...
movel     gefdat        dsdat1
eval      dsuår2 = dsuår1
eval      dsumn2 = dsumn1
eval      dsuda2 = dsuda1
movel     dsdat2        a17dat
```
**Purpose:** Swaps date from YYYYMMDD to DDMMYYYY for display.

---

### 2. DnB Operator Number Formatting

```rpg
if        a17ban = 'DN'
  movea     a17ope        oin
  eval      i = 1
  dow       i <= 11
    if        oin(i) = *blanks
      goto      red
    endif
    eval      i = i + 1
  enddo
red
  eval      i = i - 1
  eval      j = 11
  dow       i > 0
    move      oin(i)        out(j)
    eval      i = i - 1
    eval      j = j - 1
  enddo
  dow       j > 0
    move      '0'           out(j)
    eval      j = j - 1
  enddo
  movea     out           a17ope
endif
```
**Purpose:** Right-justifies and zero-pads operator number for DnB.

---

### 3. File Update or Insert

```rpg
key01   chain     gfaslu                             60
if        *in60 = *off
  update    gfaspfu
else
  write     gfaspfu
endif
```
**Purpose:** Updates existing record or writes new if not found, using indicator 60.

---

### 4. External Program Calls

```rpg
if        *inkh = *on
  call      'GL122R'
  goto      a1taga
endif
if        *inki = *on
  call      'GL114R'
  goto      a1taga
endif
if        *inkj = *on
  call      'GL121R'
  parm                    a17fin
  parm                    w_in12
  if w_in12        cabeq     1
    xslutt
  goto      a1taga
endif
```
**Purpose:** Handles F-key navigation to related maintenance programs.

---

## Final Notes for Developers

- The program is structured for interactive 5250 display, maintaining state via indicators.
- Heavy use of overlays, move, and eval for field mapping and data manipulation.
- Field validation and screen control logic is tightly coupled to display file indicator conventions.
- Modifications over time have introduced support for additional fields/logic, e.g., IFS, new communication types.
- Norwegian variable names and comments dominate; be aware of domain terms (e.g., "foretaksnummer", "sammenslåing", etc.).
- Maintenance typically involves updating validation logic and mappings to/from the GFASPF file and related programs.

---

## Onboarding Advice

- Familiarize yourself with the `GFASPF` file structure and related files.
- Understand how program indicators (`INxx`) flow for field validation and UI feedback.
- If customizing, keep business rules tightly coupled with user interface and validation routines.
- Use the provided subroutines for any field-to-screen or screen-to-field expansion.
- Be aware of external program interface conventions (CALL/PARM).

This program is a good RPG example of file-maintenance with a strong focus on data integrity and user guidance.