# ILE RPG Code Explanation: Customer Account List Printout (`RK646R`)

This RPG program is designed to print a customer account (reskontro) list, including balances and transactions, for a given set of customers within an IBM i environment. Below is a structured explanation to help new developers understand the codebase.

---

## 1. **Header Section**

- **`/TITLE` and Comments:**  
  The document provides the title and a detailed change log, including enhancements for PDF support and changes for meta-tagging and printer file handling.
- **Special Compile Options:**  
  - `h datedit(*dmy)`: Dates use day-month-year format.
  - `h option(*nodebugio)`: No debug I/O.

---

## 2. **File Declarations**

- **Input Disk Files:**  
  ```rpg
  frkw1l1    if   e           k disk    rename(rkw1pfr:rkw1l1r)
  frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
  frktrl1    if   e           k disk    rename(rktrpfr:rktrl1r)
  fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
  fra01l1    if   e           k disk    rename(ra01pfr:ra01l1r)
  ```

  Each input file is specified with renaming for record format clarity.

- **Output Printer File:**  
  ```rpg
  frk646p    o    e             printer oflind(*in30)
  ```
  Printer file for output, with overflow indicator.

- **PDF Support:**  
  Conditional file open (`usropn`) for PDF processing.

---

## 3. **Data Declarations**

- **Arrays and Texts:**  
  - `txt`: Unknown text messages.
  - `kna`: Customer names (up to 10 customers).
- **Working Data Structure:**  
  `wkwrec` overlays: Fields `wkfirm`, `wkkund`, `wknavn`.
- **Work Fields:**  
  Various fields for balance, totals, dates, and counters.

- **Selection Parameters:**  
  Strings and fields for departments, categories, sellers, currency, sort order, etc.

- **PDF & Meta Fields:**  
  For PDF spool file management and meta information (tags for XML, Jasper integration, etc.).

- **Error Structures:**  
  For API error handling.

---

## 4. **Importing Copybooks**

- `/COPY QCPYLESRC,RPARRKDS`  
  Includes additional field definitions (record layouts) necessary for processing.

---

## 5. **Main Processing Loop**

### **Customer Main Loop**

```rpg
c     nyles         tag
c                   eval      *in14 = *off
c                   read      rkw1l1                                 60
c                   if        *in60 = *on
c                   eval      *inlr = *on
c                   goto      slutt
c                   endif
```

- Reads from main customer control file (`rkw1l1`).
- If end-of-file (`*in60`), set last record (`*inlr`) and exit.

### **Retrieve Customer and Transactions**

```rpg
c                   movel     rwkrec        wkwrec
c                   eval      page = 0
c                   move      wkkund        rkunl1_kund
c     rkunl1_key    chain     rkunl1                             61
c                   exsr      les_kuntr
```

- Moves record from `rwkrec` to work record.
- Resets page numbers, loads customer number, and chains to customer master.
- Calls subroutine to read customer transactions.

### **Counters and Printing**

- Increments customer counters (`w_antkund`, `w_antusal`, etc.).
- Writes totals per customer if the balance or postings exist.

### **Loop Control**

- Resets balance fields, restarts the main loop (`goto nyles`).

---

## 6. **Transaction Processing: `les_kuntr` Subroutine**

This subroutine reads all transaction records for the current customer and period.

- **Set Position:**  
  `setll`, `reade` by customer key in transactions file.
- **Loop Over Transactions:**  
  - Checks period/year against parameters.
  - Calculates balances for various cutoff dates.
  - Writes header lines and details as needed.
  - Handles overflow (`*in30`), sets indicators for debit/credit.
  - Counts postings.

---

## 7. **PDF/Export Integration**

- **Spool Number Retrieval (`spoolnbr`):**  
  Calls the `QSPRILSP` API to retrieve the latest spool file info for PDF export.
- **Generate XML (`xml_create`):**  
  Calls an external program (`AP627R`), passing meta fields for further PDF/XML processing.
- **PDF Preview (`pdf_preview`):**  
  Optionally launches an external program (`AP621R`) to display the file in a browser.

---

## 8. **Program Initialization: `*inzsr` Subroutine**

- **Field Initialization:**  
  Sets up work fields, key lists, and loads company info.
- **Parameter Handling:**  
  Reads and sets up selection parameters (department, category, seller, etc.).
- **Customer Name Lookup:**  
  Loops over selected customer numbers (`kun`), attempts to retrieve names or sets as unknown.
- **Sum/Sort Flags:**  
  Sets flags and text for different sorts and summary outputs.

---

## 9. **Printout Formatting**

- **Writing Reports:**  
  Uses output specifications (not shown, but referenced like `h101`, `d101`) for report sections, headers, and totals.

---

## 10. **Miscellaneous**

- **Indicators:**  
  Many indicators (`*inXX`) are used for controlling logic flow, printing, overflow, etc.
- **Meta Tagging:**  
  Several fields are now prepared for integration with XML or Jasper Reports.

---

## 11. **Messages/Texts**

- At the bottom: text constants for report sections (Department, Category, Seller, Unknown).

---

# **Summary for Developers**

This program processes customer account records, printing transaction lists and balances, supports selection criteria, and is enabled for both standard spool file output and enhanced PDF/XML export. It relies on legacy RPG constructs (fixed-format C specs, indicators) but illustrates common business logic patterns on IBM i.

Key things to look for when onboarding:

- Understand the input files and their record layouts (copybook).
- Focus on how the main loop retrieves, processes, and summarizes data per customer.
- Pay attention to the use of indicators, which control both program logic and report formatting.
- The program has been enhanced with routines for PDF generation and meta-taggingâ€”see the corresponding subroutines.
- The initialization subroutine (`*inzsr`) is critical for prepping lookups, customer names, and report structure.

**Tip:** You will need access to referenced objects (files, copy members, and called programs) as well as a good understanding of legacy RPG code structure!