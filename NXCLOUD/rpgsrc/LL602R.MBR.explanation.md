# RPG Program LL602R: Picking Inventory Records for Stock List

This ILE RPG program, named `LL602R`, is designed to extract ("utplukk") records from an inventory register for the purpose of producing a goods inventory listing. The comments and structure indicate a Norwegian system, explaining terminology like "lagernr" (warehouse number), "varenr" (item number), etc. The code is written in fixed-format RPG IV.

Below is a walk-through of the program structure and logic:

---

## Program Overview

- **Purpose:** Select records from inventory files based on a variety of selection criteria and write the results to a work file for further processing (e.g., reporting stock levels).
- **Input Parameters:** Item range, warehouse range, group ranges, supplier, handler, sort order, etc.
- **Files Used:**
  - Inventory file (`vlagl1`)
  - Item master (`vvarl1`)
  - Grouping files (`vogrl1`, `vhgrl1`, `vugrl1`)
  - Work/output file (`lwa1lu`)

---

## Header Section

- `h datedit(*dmy) option(*nodebugio)`
  - Date fields use DD/MM/YY format.
  - Debug I/O is disabled for performance.

---

## Indicator Usage

- `LR`: End-of-program indicator.
- `31-59`: For messages, error signaling, or screen indicators.
- `70-79`: Temporary/subroutine indicators.
- `80-89`: General-purpose working indicators.
- `90-99`: File indicators (e.g., for `CHAIN`, `READ` errors).

---

## File Declarations

- **Input Files:**
  - `vlagl1` (inventory, renamed to `vlaglur`)
  - `vvarl1` (item master, renamed to `vvarl1r`)
  - `vogrl1`, `vhgrl1`, `vugrl1` (group files)
- **Output File:**
  - `lwa1lu` (work/output, renamed to `lwa1lur`)

---

## Data Structures

- **Local Data Area:** For shared variables, e.g. `l_firm` (company code).
- **Parameter Data Structure:** Receives packed input data and overlays fields for easier access (item from/to, warehouse from/to, group from/to, supplier, handler, etc.).
- **Composite Key Structures:** For sorting/grouping in the work file.
- **Group Structures:** For handling group codes (over, main, sub groups).
- **Variable & Key Fields:** Aliases for fields used as keys on file operations.

---

## Main Logic: Processing Loop

### 1. Main Loop (`les_lager`)

- **Read Next Inventory Record:**  
  `read vlagl1` sets indicator `*in90` if EOF.
  - If EOF (`*in90=on`), jump to `end_pgm`.

- **Check Company:**  
  Skip record if `vlfirm` (record's company) doesn't match `l_firm`.

- **Check Item Number Range:**  
  Skip if item not in parameter range.

- **Check Warehouse Number Range:**  
  Skip if warehouse not in parameter range.

- **Check if Item Exists in Master:**  
  Use `chain` to `vvarl1` using item number, skip if not found.

- **Check Group Range:**  
  Constructs group codes (`ogrp`, `hgrp`, `ugrp`) and skips if not in range.

- **Check if Group is Stock-Controlled:**  
  Looks up in `vugrl1` (subgroup), `vhgrl1` (main group), `vogrl1` (overgroup) whether the group is flagged as stock-controlled. Skips if not.

- **Check Supplier:**  
  If a supplier is specified, skip if not matching.

- **Check Handler:**  
  If a handler is specified, skip if not matching in any group level.

- **Check Item Type:**  
  If not a warehouse item (`vlvtyp <> 'L'`), skip.

### 2. Build Sort Key

- Clears the sort key structure.
- Depending on `p_sort`, sets up the sort fields (item+warehouse, group+item+warehouse, etc.).
- Transfers the sort key to the work file key.

### 3. Write to Work File

- Moves and copies all necessary data fields from the input record to the output structure (`lwa1lu`).
- Writes the record to the work file.
- Continues to next record (`goto les_lager`).

---

## Program End (`end_pgm`)

- Sets the last record indicator (`*inlr = *on`) to end the program.

---

## Initialization Subroutine (`*inzsr`)

- **Constructs Keys:**  
  Defines how to build keys for all the files involved.
- **Processes Input Parameters:**  
  Transfers the parameter string and overlays the fields accordingly.
- **Sets Starting Points:**  
  Establishes the starting key for reading the inventory file, based on from/to item and warehouse.
- **Builds Group Ranges:**  
  Prepares composite group codes for faster comparison in main processing.

---

## Summary Table

| Step                  | Field/Section         | Purpose                                                                              |
|-----------------------|----------------------|--------------------------------------------------------------------------------------|
| File Read             | vlagl1               | Reads each inventory record                                                          |
| Parameter Overlay     | p_*                  | Supports packed input parameters for flexible selection                              |
| Range Checks          | Item, Warehouse, Group| Ensures only records in selected ranges are processed                                |
| Existence Check       | vvarl1 (`chain`)     | Ensures inventory item exists in master                                              |
| Group Stock-Controlled| vugrl1/vhgrl1/vogrl1 | Filters by group stock control flag                                                  |
| Supplier/Handler      | vvldor, *pra fields  | Additional filter if selected                                                        |
| Sort Key Build        | d_mkey/d_mk*         | Allows dynamic sorting in work file                                                  |
| Write Output          | lwa1lu               | Selected and mapped record written out                                               |

---

## Key Takeaways for New Developers

- **Parameterization:** Program is highly configurable via parameter data structure that overlays raw input, enabling flexible selections.
- **Group-Oriented Logic:** Filtering by multiple levels of groups is core to the selection process.
- **Sort-Order Flexibility:** Sort key is dynamically built based on input parameter.
- **Work File Output:** All selected data is mapped and output to a work file for external processing or reporting.

**Pro Tip:** Start debugging or extending the program by focusing on the main loop logic: how records are read, filtered, and transferred. Use the initialization routine to understand how parameters are delivered and interpreted.

---

**This program is a classic inventory extract for reporting, with flexibility for selection, grouping, and sorting, written in traditional fixed-format ILE RPG.**