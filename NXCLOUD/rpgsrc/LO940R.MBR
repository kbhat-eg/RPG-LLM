     H/TITLE  Utskrift av Inngående faktura
6.30 h option(*nodebugio) datedit(*dmy.) decedit('0.')
6.30 h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
6.30  /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      * Program . . . . : LO940R                                        *
      * Beskrivelse . . : Utskrift av Inngående faktura                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      * Spesialversjon. :                                               *
      * Tilpasset for . :                                               *
      *                                                                 *
      * Referanse  Dato   Endringsbeskrivelse                      Sign.*
      * --------- ------  ----------------------------------------------*
6.10  * R6.10 070909 BSA  Utskriften endret pga utvidelse av referansefelter.
6.nu  * R6.30 120614 bof  Gjennomgått mtp. nummerutvidelse              *
6.30  * R6.30 220814 bsa  Innnført full PDF funksjonalitet              *
6.31  * R6.30 150914 bsa  Utvidet parameterliste til FO798R. Håndtering av
6.31  *                   flere mailfelter.                             *
6.32  * R6.30 180914 bsa  Endret mva håndtering. Flere satser           *
6.33  * 6.30  051214 Bsa  Utvidet parameterliste til FÅ707R
6.34  * 6.30  280115 bsa  Skriver til datakø for å trigge java sniffer
6.35  * 6.30  050615 bsa  Nullstill minne for bruk av XML
6.36  * 6.30  040915 bsa  Legger ut avdeling som tagg for arkiveringsformål.
6.37  * 6.30  220217 bsa  Justert layout i grønt pga utvidelser av felter
6.38  * 6.30  150517 nhu  Tatt 4 posisjoner fra tekst da ører ikke ble er
6.38  *                   vist i beløp
6.39  * 6.30  081018 bof  Utvidet med trelast sortiment
7.01  * K000  290713 bof  Legger ut Ref. ordre
      *
8.01  * K000  250522 bsa  Scanner flere felter for ugyldige tegn
8.02  * K000  181023 bsa  Logikk for samlefaktura
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     FLSTSL1    IF   E           K DISK    RENAME(LSTSPFR:LSTSL1R)
     FVOTYL1    IF   E           K DISK    RENAME(VOTYPFR:VOTYL1R)
     FVLTYL1    IF   E           K DISK    RENAME(VLTYPFR:VLTYL1R)
     FSIHEL1    IF   E           K DISK    RENAME(SIHEPFR:SIHEL1R)
     FSIDTL1    IF   E           K DISK    RENAME(SIDTPFR:SIDTL1R)
     FVVARL1    IF   E           K DISK    RENAME(VVARPFR:VVARL1R)
     Frlevl1    IF   E           K DISK    RENAME(RLEVPFR:rlevl1R)
     FAFIRL1    IF   E           K DISK    RENAME(AFIRPFR:AFIRL1R)
     FAFORL1    IF   E           K DISK    RENAME(AFORPFR:AFORL1R)
6.30 fra09l1    if   e           k disk    rename(ra09pfr:ra09l1r)
6.30 fra07pf    if   e           k disk
      *
     FLO940P    O    E             PRINTER
      *
     D/EJECT
      *
      * - - - - - - - - - - - - - -
      * Datastruktur for kid-feltet
      * - - - - - - - - - - - - - -
      *
     D                 DS
     D  DSKKID                 1     21
     D  DSKKUS                 1     20
     D  DSKFIR                 1      3  0
     D  DSKKOD                 4      4  0
6.nu D  DSKTYP                 5      5  0
6.nu D  DSKLED                 6      6  0
6.nu D  DSKKTO                 7     12  0
6.nu D  DSKBIL                13     20  0
     D  DSKMOD                21     21  0
      *
      * - - - - - - - - - - - - - -
      * Datastruktur parameter-inn
      * - - - - - - - - - - - - - -
      *
     D                 DS
6.nu D  DSPARM                 1     34
     D  DSAARR                 1      4  0
     D  DSOTYP                 5      6
6.nu D  DSFFNR                 7     14  0
6.nu D  DSTFNR                15     22  0
6.nu D  DSPROG                23     32
      *
      * - - - - - - - - - - - - - - - -
      * Datastruktur for foretaksnummer
      * - - - - - - - - - - - - - - - -
      *
     D                 DS
     D  DSFFTX                 1     30
     D  DSFF01                 1      8
     D  DSFF02                 9     11
     D  DSFF03                12     21
     D  DSFF04                22     25
     D  DSFF05                22     25
      *
      *
      * - - - - - - - - - - - - - -
      * Henter inn data fra LDA
      * - - - - - - - - - - - - - -
      *
     D                UDS
6.30 d l_poff                584    584
6.30 d l_utqm                585    594
6.30 d l_bach                595    635
6.30 d l_arch                636    636  0
6.30 d l_skje                637    637  0
6.30 d l_land                638    638  0
6.30 d l_exlp                639    639  0
6.30 d l_mail                640    640  0
6.33 d l_prfi                750    750  0
6.30 d l_ruti                800    809
6.30 d  l_outq               810    819
6.30 d l_copy                838    843  0
     D  DSALIN               856    858  0
     D  DSOCRK               885    885  0
6.30 d  l_wsid               901    910
6.30 d  l_user               911    920
6.30 d  l_filg               931    933
     D  DSFIRM               944    946  0
6.36 d  l_avde               947    950  0
      *
      * Definering av variable
      *
     d w_csts          s              1
     d w_ctx2          s             20
     d w_dato          s               d   datfmt(*iso)
      *
6.30 d ra09l1_ikod     s                   like(raikod)
6.30 d ra07pf_avde     s                   like(ragkod)
6.30  *
6.30  * Definering av parametre
6.30  *
6.30 d p_serv          s             35
6.30 d p_stat          s              1
6.30 d p_mail          s              1
6.30 d p_kund          s              6  0
6.30 d p_kpro          s              6  0
6.30 d p_numm          s              8  0
6.31 d p_suff          s                   like(shsuff)
6.30 d p_selg          s              4  0
6.30 d p_kule          s              1
6.30 d p_navn          s             30
6.30 d p_emal          s             50
6.31 d p_ema2          s             50
6.31 d p_ema3          s             50
6.30 d p_kopi          s             50
6.30 d p_emne          s             50
6.30 d p_txt1          s             50
6.30 d p_txt2          s             50
6.30 d p_txt3          s             50
6.30 d p_txt4          s             50
6.30 d p_pers          s             50
6.30 d p_inif          s             40
6.30 d p_in03          s              1
6.30 d p_ok            s              1
6.30 d p_lr            s              1
6.30 d p_str_in        s            512
6.30 d p_str_out       s            512
6.34 d p_filg          s             10
6.34 d p_xmlf          s            256
6.30  *
6.30 d b_pdfp          s              1    inz(*off)
6.30 d b_samf          s              1    inz(*off)
6.30 d b_orde          s              1    inz(*off)
6.30 d b_topt          s              1    inz(*off)
6.30 d b_bott          s              1    inz(*off)
6.30  *
6.30 d x_numm          s             15
6.30 d x_vref          s             25
6.30 d x_betb          s             42
6.30 d w_bdat          s               d   datfmt(*iso)
6.30 d w_date          s               d   datfmt(*iso)
6.30 d w_kode          s              1
6.30 d w_firm          s                   like(shfirm)
6.30 d w_fell          s              6
6.30 d w_type          s              2
6.30 d w_fast          s             10
6.30 d w_ruti          s             10
6.30 d w_numm          s              8  0
6.30 d w_pdf           s              1  0
6.30 d w_jnav          s             15
6.30 d w_jkey          s             41
6.30 d w_jtxt          s             35
6.30 d w_txt           s             35
6.30 d w_pdf_ds        s            512
6.30 d w_mtxt          s            200
6.30 d w_spol          s              5
6.30 d w_land          s              9
6.30 d w_jstat         s              2  0
6.30 d w_jtext         s            200
6.30 d w_str_in        s            512
6.30 d w_str_out       s            512
6.30 d w_x             s              3  0
6.30 d w_path          s            256
6.30 d w_emal          s             50
6.30 d w_dspl          s            250
6.30 d w_tek1          s            512
6.30 d w_tek2          s            512
6.30 d w_tek0          s            512
6.30 d w_1dref         s            512
6.30 d w_1vref         s            512
6.30 d w_1fnav         s             50
6.30 d w_1fad1         s             50
6.30 d w_1fad2         s             50
6.30 d w_1navn         s             50
6.30 d w_1gate         s             50
6.30 d w_1adr2         s             50
6.30 d w_2navn         s             50
6.30 d w_2adr1         s             50
6.30 d w_2adr2         s             50
6.30 d w_copy          s              3  0
6.30 d w_ptxt1         s             75
6.30 d w_ptxt2         s             75
6.30 d w_ptxt3         s             75
6.30 d w_ptxt4         s             75
6.30 d w_ppers         s             75
6.30 d w_pemne         s             75
6.30 d w_rekv          s             50
6.30 d crlf            c                   const(X'0d25')
6.30 d w_lmtx          s             50
6.30 d w_lbtx          s             50
6.30 d w_ddeno         s                   like(ragkod)
6.30 d w_dnavn         s             50
6.30 d w_dadr1         s             50
6.30 d w_dadr2         s             50
6.30 d w_dpcde         s                   like(ragpnr)
6.30 d w_dpstd         s             50
6.30 d w_dphon         s                   like(ragtlf)
6.30 d w_dfaxn         s                   like(ragfax)
6.30 d w_ldat          s              6  0
6.30 d w_lddt          s              6  0
6.30 d w_draw1         s             25
6.30 d w_draw2         s             25
6.30 d w_skuf          s             25
6.30 d w_dtray         s             10
6.30 d w_gtray         s             10
6.30 d w_refn          s             50
6.30 d w_lvar          s             50
6.30 d w_bach          s                   like(l_bach)
6.30 d w_ttxt          s            300
6.30 d w_ttx1          s            100
6.30 d w_ttx2          s            100
6.30 d w_ttx3          s            100
6.33 d w_mail          s             50
6.33 d w_weba          s             50
6.38 d d1tek1          s                   like(sltek1)
6.39 d w_lv_lvar       s                   like(vvlvar)
8.01 d w_1fste         s            100
8.01 d w_1sted         s            100
8.01 d w_2sted         s            100
6.30  *
6.30 d XML_Output      s            256a   Varying
6.30 d XML_path        s            256a   Varying
6.30 d                                     Inz('/home/asp/print/adb')
6.30 d jasper_mal      s            256a   inz('file:/home/asp/print/maler/+
6.30 d                                     ink_pakks/INK_PAKKSEDDEL.jasper')
6.30 d jasper_logo     s            256a   Varying
6.30 d tmpdate         s               D
6.30 d tmptime         s               T
6.30  *
6.30 d d_pdf_ds        ds
6.30 d  d_xmlm                       75
6.30 d  d_jasm                       75
6.30 d  d_logo                       75
6.30 d  d_path                      100
6.30 d  d_emal                       50
6.34 d  d_fifo                       75
6.34 d  d_kopi                        1
6.34 d  d_dtaq                        1
6.34 d  d_sign                        1
6.30  /copy prototypeb
6.30  /copy usec
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Definering av formater                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      * Benyttede formater
      * - - - - - - - - - -
      *
      * A1HDR  - Heading A1 på rapport
      * A3HDR  - Heading A3 på rapport, Ordrehode Deres ref + rekv.
      * A4HDR  - Heading A4 på rapport, Ordrehode over varelinje
      * D1DET  - Detail  D1 på rapport, Varelinje
      * D2DET  - Detail  D2 på rapport, Tekstlinje
      * E1DET  - Detail  E1 på rapport, Tekstlinje
      * O1DET  - Detail  O1 på rapport, Overføring til/fra neste side
      * R1TOT  - Total   R1 på rapport, ordrerabatt
      * T1TOT  - Total   T1 på rapport
      *
      *
      * Forklaring på variabler
      * - - - - - - - - - - - -
      *
      * D1ANT0 - Antall med 0 desimaler
      * D1ANT1 - Antall med 1 desimaler
      * D1ANT2 - Antall med 2 desimaler
      * D1ANT3 - Antall med 3 desimaler
      * D1BPRI - Brutto pris
      * D1NBEL - Netto  beløp
      * D1RABP - Rabatt i prosent (Sum prosent 1 og 2)
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Styre-rutine                                                    *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
6.39 C/Exec SQL
6.39 C+  Set Option DatFmt=*ISO
6.39 C/End-Exec
      * Initierings-rutine
      *
     C     FCYCLE        CASEQ     *ZERO         XSTRSR
     C                   ENDCS
      *
      * Behandle ordrehode
      *
     C     HTAG01        TAG
     C     *IN61         CABEQ     *ON           XSLUTT
     C     SHFIRM        CABNE     WWFIRM        XSLUTT
     C     SHAARR        CABNE     DSAARR        XSLUTT
     C     SHBINR        CABGT     DSTFNR        XSLUTT
     C     SHOTYP        CABNE     DSOTYP        NTAG03
     C     SHBINR        IFNE      QQBINR
     C                   EXSR      XHODE1
     C                   ELSE
     C                   EXSR      XHODE2
     C                   ENDIF
     C                   MOVE      SHBINR        QQBINR
      *
      * Behandle varelinje
      *
     C                   MOVE      SHBINR        WWBINR
     C                   MOVE      SHNUMM        WWNUMM
     C                   MOVE      SHSUFF        WWSUFF
     C                   MOVE      *ZERO         WWKTXT
     C                   MOVE      *ZERO         WWLINE
      *
     C     KEY02         SETLL     SIDTL1
     C                   READ      SIDTL1                                 62
      *
     C     VTAG01        TAG
     C     *IN62         CABEQ     *ON           NTAG02
     C     SLFIRM        CABNE     SHFIRM        NTAG02
     C     SLBINR        CABNE     SHBINR        NTAG02
     C     SLNUMM        CABNE     SHNUMM        NTAG03
     C     SLSUFF        CABNE     SHSUFF        NTAG03
      *
     C                   EXSR      XVARE1
     C                   READ      SIDTL1                                 62
     C                   GOTO      VTAG01
      *
      * Ny faktura
      *
     C     NTAG02        TAG
     C                   Z-ADD     1             A1SIDE
     C                   EXSR      XORRAB
     C                   EXSR      XTOTAL
     C                   READ      SIHEL1                                 61
     C                   GOTO      HTAG01
      *
      * Ny ordre
      *
     C     NTAG03        TAG
     C                   EXSR      XORRAB
     C                   READ      SIHEL1                                 61
     C                   GOTO      HTAG01
      *
      * Ferdig
      *
     C     XSLUTT        TAG
6.30  *
6.30 c                   if        b_pdfp = *on
6.30  * Skriv xml fila på disk
6.30 c                   exsr      xml_end
6.30  * Hvis forhåndvisning må vi kjøre linken
6.30 c                   if        l_skje = 1 and
6.30 c                             l_bach = w_jkey
6.30 c                   exsr      pdf_preview
6.30 c                   endif
6.30  * Avslutt jobbiden
6.30 c                   call      'AB710R'
6.30 c                   parm                    l_bach
6.30  *
6.30 c                   endif
6.30  *
     C                   SETON                                        LR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * A1HDR Behandle heading A1                                       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XHODE1        BEGSR
      *
6.30  * Skriv ut forrige PDF, lager ny batch
6.30 c                   if        qqbinr <> 0 and
6.30 c                             b_pdfp = *on
6.30  * Skriv xml fila på disk
6.30 c                   exsr      xml_end
6.30  * Avslutt jobbiden
6.30 c                   call      'AB710R'
6.30 c                   parm                    w_bach
6.30  * Lager nytt batchnummer
6.30 c                   exsr      proa_nummer
6.30  *
6.30 c                   eval      w_jnav = 'PDF' + %char(w_numm)
6.30 c                   eval      w_jtxt = 'Utskrift av inng. faktura via +
6.30 c                                      Jasper'
6.30 c                   call      'AB700R'
6.30 c                   parm                    w_jnav
6.30 c                   parm                    w_jkey
6.30 c                   parm                    w_jtxt
6.30  *
6.30 c                   eval      w_bach = w_jkey
6.30  * Vi logger at utskriftprogrammet har startet
6.30 c                   eval      w_jstat = 10
6.30 c                   eval      w_jtext = 'Utskrift av faktura har startet'
6.30 c                   call      'AB705R'
6.30 c                   parm                    w_jkey
6.30 c                   parm                    w_jstat
6.30 c                   parm                    w_jtext
6.30  * Vi skriver xml for miljø formater
6.30 c                   exsr      xml_envm
6.30 c                   endif
      * Null-stilling av
      * variabler
      *
     C                   Z-ADD     0             O1TRSP
     C**                 Z-ADD     0             A1LDAT
     C                   Z-ADD     0             A1FKDA
     C                   Z-ADD     0             A1FFDA
     C                   Z-ADD     0             W6KJOP
     C                   Z-ADD     0             W6KJOF
     C                   Z-ADD     0             W6RK1P
     C                   Z-ADD     0             W6RK1F
     C                   Z-ADD     0             W6RK2P
     C                   Z-ADD     0             W6RK2F
     C                   Z-ADD     0             W6RKOP
     C                   Z-ADD     0             W6RKOF
     C                   Z-ADD     0             W6MVAG
      *
     C                   EXSR      XHODEF
      *
     c**                 if        shldat <> *loval
     c**   *dmy          move      shldat        a1ldat
     c**                 endif
      *
     c                   if        shfkda <> *loval
     c     *dmy          move      shfkda        a1fkda
     c                   endif
      *
     c                   if        shffda <> *loval
     c     *dmy          move      shffda        a1ffda
     c                   endif
      *
      * Legg inn tilbudsnummer
      *
     C                   MOVE      SHNUMM        A1NUMM
     C                   MOVEL     '/'           A1SUFF
     C                   MOVE      SHSUFF        A1SUFF
      *
      * Hente inn kunderegister
      *
     C                   MOVE      SHLDOR        WWKUND
     C     KEY04         CHAIN     rlevl1R                            64
     C                   MOVE      SHLDOR        A1LDOR
     C                   MOVE      RLNAVN        A1NAVN
     C                   MOVE      RLGATE        A1GATE
     C                   MOVE      RLADR2        A1ADR2
     C                   MOVE      RLSTED        A1STED
      *
      * Sjekke tilbuds-kunden
      *
     C     SHLDOR        IFEQ      W0LDOR
     C                   MOVE      SHLELE        SHLDOR
     C                   MOVE      SHNAVN        A1NAVN
     C                   MOVE      SHADR1        A1GATE
     C                   MOVE      SHADR2        A1ADR2
     C                   MOVE      SHSTED        A1STED
     C                   MOVE      *ZERO         SHLELE
     C                   MOVE      *BLANK        SHNAVN
     C                   MOVE      *BLANK        SHADR1
     C                   MOVE      *BLANK        SHADR2
     C                   MOVE      *BLANK        SHSTED
     C                   END
      *
      * Finner hvilken mva-sats
      * som skal benyttes
      *
     c                   call      'FÅ705R'
     c                   parm                    wwfirm
     c                   parm                    shbdat
     c                   parm                    WPMVAS
     c                   parm                    WPMVAT
     c                   parm                    WPMVAF
      *
      * Hente inn betalings-
      * betingelser
      *
     c                   call      'FÅ703R'
     c                   parm                    wwfirm
     c                   parm                    shbetb
     c                   parm                    shfkda
     c                   parm                    w_csts
     c                   parm                    w_dato
     c                   parm                    a1ctxt
     c                   parm                    w_ctx2
      *
      * Er det registrert
      * leveringsadresse?
      *
     C                   MOVE      *OFF          *IN31
     C     SHNAVN        IFNE      *BLANK
     C                   MOVE      *ON           *IN31
     C                   MOVE      SHNAVN        A2NAVN
     C                   MOVE      SHADR1        A2ADR1
     C                   MOVE      SHADR2        A2ADR2
     C                   MOVE      SHSTED        A2STED
     C                   ENDIF
      *
      * Er det registrert
      * leveringsdato?
      *
     C                   MOVE      *OFF          *IN32
     C     SHLDAT        IFNE      *loval
     C                   MOVE      *ON           *IN32
     C                   ENDIF
      *
      * Er det registrert
      * leveringsmåte?
      *
     C                   MOVE      *OFF          *IN34
     C     SHLMTX        IFNE      *BLANK
     C                   MOVE      *ON           *IN34
     C                   MOVE      SHLMTX        A1LMTX
     C                   ENDIF
      *
      * Flytte øvrige felter
      *
     C                   MOVE      SHBINR        A1BINR
7.01 c                   if        shornr <> 0
7.01 C                   MOVE      shornr        a1ornr
7.01 c                   eval      *in39 = *on
7.01 c                   else
7.01 c                   eval      *in39 = *off
7.01 c                   endif
      *
      * Skrive heading
      *
6.30 c                   if        b_pdfp = *off
     C                   Z-ADD     0             WLTELL
     C                   WRITE     A1HDR                                30
6.30 c                   endif
      *
      * Skriv heading 1
      * over varelinjer
      *
     C                   MOVE      *OFF          *IN40
     C     *IN33         IFEQ      *ON
     C                   MOVE      *ON           *IN40
     C                   ENDIF
     C     *IN35         IFEQ      *ON
     C                   MOVE      *ON           *IN40
     C                   ENDIF
     C     *IN40         IFEQ      *ON
6.30 c                   if        b_pdfp = *off
     C                   ADD       1             WLTELL
     C                   WRITE     A3HDR                                30
6.30 c                   endif
     C                   ENDIF
      *
      * Skriv heading 2
      * over varelinjer
      *
6.30 c                   if        b_pdfp = *off
     C                   ADD       1             WLTELL
     C                   WRITE     A4HDR                                30
6.30 c                   endif
      *
6.30  * Vi skriver til XML taggene for heading
6.30 c                   if        b_pdfp = *on
6.30 c                   eval      b_samf = *off
6.30 c                   eval      b_orde = *on
6.30 c                   exsr      xml_head_inv
6.30 c                   exsr      xml_head_ord
6.30 c                   endif
      *
     C                   ENDSR
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Flere ordre pr.faktura                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XHODE2        BEGSR
      *
     C                   EXSR      XHODEF
      *
      * Legge inn ordrenr
      * og suffix
      *
     C                   MOVE      SHNUMM        A1NUMM
     C                   MOVEL     '/'           A1SUFF
     C                   MOVE      SHSUFF        A1SUFF
      *
      * Skriv heading 1
      * over varelinjer
      *
     C                   MOVE      *OFF          *IN40
     C     *IN33         IFEQ      *ON
     C                   MOVE      *ON           *IN40
     C                   ENDIF
     C     *IN35         IFEQ      *ON
     C                   MOVE      *ON           *IN40
     C                   ENDIF
     C     *IN40         IFEQ      *ON
6.30 c                   if        b_pdfp = *off
     C                   ADD       1             WLTELL
     C                   WRITE     A3HDR                                30
     C                   ENDIF
6.30 c                   endif
      *
      * Er det overflow ?
      *
     C     *IN30         CASEQ     *ON           XOVRFL
     C                   ENDCS
      *
      * Skriv heading 2
      * over varelinjer
      *
6.30 c                   if        b_pdfp = *off
     C                   ADD       1             WLTELL
     C                   WRITE     A4HDR                                30
      *
      * Er det overflow ?
      *
     C     *IN30         CASEQ     *ON           XOVRFL
     C                   ENDCS
6.30 c                   endif
      *
6.30  * Vi skriver til XML taggene for heading
6.30 c                   if        b_pdfp = *on
6.30 c                   eval      b_samf = *on
6.30 c                   eval      b_orde = *on
6.30 c                   exsr      xml_head_ord
8.02 c                   eval      b_orde = *on
6.30 c                   endif
     C                   ENDSR
      *
     C/EJECT
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Felles rutine for XHODE1 og XHODE2                              *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XHODEF        BEGSR
      *
      * Summere salg og
      * rabatter
      *
     C                   MOVE      *ZERO         A1BDAT
     C                   MOVE      *BLANK        A1VREF
     C                   MOVE      *BLANK        A1DREF
     C                   MOVE      *BLANK        A1REKV
      *
     C                   ADD       SHKJOP        W6KJOP
     C                   ADD       SHKJOF        W6KJOF
     C                   ADD       SHRK1P        W6RK1P
     C                   ADD       SHRK1F        W6RK1F
     C                   ADD       SHRK2P        W6RK2P
     C                   ADD       SHRK2F        W6RK2F
     C                   ADD       SHRKOP        W6RKOP
     C                   ADD       SHRKOF        W6RKOF
      *
      * Snu ordredato
      *
     c                   if        shbdat <> *loval
     c     *dmy          move      shbdat        a1bdat
     c                   endif
      *
      * Er det registrert
      * kundens referanse?
      *
     C                   MOVE      *OFF          *IN33
     C     SHDREF        IFNE      *BLANK
     C                   MOVE      *ON           *IN33
6.10 C                   movel     SHDREF        A1DREF
     C                   ENDIF
      *
      * Er det registrert
      * rekvisisjon?
      *
     C                   MOVE      *OFF          *IN35
     C     SHREKV        IFNE      *BLANK
     C                   MOVE      *ON           *IN35
     C                   MOVE      SHREKV        A1REKV
     C                   ENDIF
      *
      * Er det registrert
      * vår referanse?
      *
     C                   MOVE      *OFF          *IN38
     C     SHVREF        IFNE      *BLANK
     C                   MOVE      *ON           *IN38
6.10 C                   movel     SHVREF        A1VREF
     C                   ENDIF
      *
     C                   ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * D1DET Behandle detail D1                                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XVARE1        BEGSR
      *
      * Nullstilling av variabler
      *
     C                   MOVE      *BLANK        D1VARE
     C                   MOVE      *BLANK        D1TEK1
     C                   MOVE      *BLANK        D1ENH1
     C                   MOVE      *BLANK        D1TINE
     C                   MOVE      *BLANK        D1INFO
     C                   MOVE      *ZERO         D1ANT0
     C                   MOVE      *ZERO         D1ANT1
     C                   MOVE      *ZERO         D1ANT2
     C                   MOVE      *ZERO         D1ANT3
     C                   MOVE      *OFF          *IN44
     C                   MOVE      *OFF          *IN46
      *
      * Sjekker om tekstlinjer
      * fra F11
      *
     C     SLKTXT        CABEQ     1             TAG02A
     C     SLKTXT        CABEQ     5             TAG02A
      *
      * Hent linje-type
      *
     C                   MOVE      SLLTYP        WWLTYP
     C     KEY08         CHAIN     VLTYL1R                            68
      *
      * Sjekker om linjen ikke skrives på ordretypen
      *
     C     SLOTYP        CABEQ     VALO01        VSLUTT
      *
     C     SLOTYP        CABEQ     VALO02        VSLUTT
      *
     C     SLOTYP        CABEQ     VALO03        VSLUTT
      *
     C     SLOTYP        CABEQ     VALO04        VSLUTT
      *
      * Tekstlinjer på
      * varelinjenivå ? (F2)
      *
     C     VALKTX        CABEQ     1             TAG02A
      *
      * Oppslag mot vareregister
      *
6.39  * sjekker om logistikk-vare
6.39 c                   eval      w_lv_lvar = *blank
6.39 c/exec sql
6.39 c+ select vvllva
6.39 i+ into   :w_lv_lvar
6.39 c+ from   vvlepf
6.39 c+ where  vvlvnr = :slvare and
6.39 c+        vvlldo = :shldor
6.39 c+ fetch first 1 rows only
6.39 c/end-exec
      *
     C                   MOVE      SLVARE        WWVARE
     C     KEY11         CHAIN     VVARL1R                            69
      *
      * Sjekk om beløp ikke skal
      * inngå i ordrerabattgrl.
      *
     C*>         SLKORD    IFEQ 1
     C*>                   MOVE '*'       D1INFO
     C*>                   END
      *
      * Sjekk om avgiftsfri
      *
     C*>         SLKMVA    IFEQ 1
     C*>                   MOVE 'F'       D1INFO
     C*>                   END
      *
      * Test på antall desimaler
      *
     C     VVDESI        COMP      0                                      40
     C     VVDESI        COMP      1                                      41
     C     VVDESI        COMP      2                                      42
     C     VVDESI        COMP      3                                      43
     C   40              Z-ADD     SLANTA        D1ANT0
     C   41              Z-ADD     SLANTA        D1ANT1
     C   42              Z-ADD     SLANTA        D1ANT2
     C   43              Z-ADD     SLANTA        D1ANT3
      *
      * Varelinje
      *
     C                   MOVE      SLVARE        D1VARE
     C                   MOVE      SLTEK1        D1TEK1
6.38 C                   MOVEL     SLTEK1        D1TEKX
     C                   MOVE      SLENH1        D1ENH1
      *
      * Brutto pris
      *
     C                   Z-ADD     SLIPNY        D1BPRI
      *
      * Beregne snittrabatt
      *
     C     100           SUB       SLRAB1        W1RAB1
     C                   MULT      SLRAB2        W1RAB1
     C                   DIV       100           W1RAB1
     C                   ADD       SLRAB1        W1RAB1
     C                   Z-ADD     W1RAB1        D1RABP
      *
      * Netto beløp
      *
     C     SLANTA        MULT(H)   SLIPNY        D1NBEL
     C                   SUB       SLRKR1        D1NBEL
     C                   SUB       SLRKR2        D1NBEL
      *
      * Akkumuler til overføringssum
      *
     C                   ADD       D1NBEL        O1TRSP
      *
      * Skriv varelinjer/
      * tekstlinjer
      *
     C     TAG02A        TAG
      *
      * Skriv tekstlinjer
      * fra F11
      *
     C     SLKTXT        IFEQ      1
     C     SLKTXT        OREQ      5
     C                   ADD       1             WLTELL
     C                   MOVE      SLTEK1        D1TEK1
6.38 C                   MOVEL     SLTEK1        D1TEKX
     C                   MOVE      SLTEK2        D1TEK2
     C                   MOVE      *ON           *IN44
6.30 c                   if        b_pdfp = *off
     C                   WRITE     D2DET                                30
6.30 c                   else
6.30 c                   if        slktxt = 1
6.30 c                   if        b_topt = *off
6.30 c                   exsr      xml_topt_str
6.30 c                   eval      b_topt = *on
6.30 c                   endif
6.30 c                   exsr      xml_topptxt
6.30 c                   else
6.30 c                   if        slktxt = 5
6.30 c                   if        b_bott = *off
6.30 c                   exsr      xml_bott_str
6.30 c                   eval      b_bott = *on
6.30 c                   endif
6.30 c                   exsr      xml_bunntxt
6.30 c                   endif
6.30 c                   endif
6.30 c                   endif
     C                   GOTO      TAG03A
     C                   END
      *
      * Skriv varelinjer
      * ordinær/tekst
      *
6.30 c                   if        b_pdfp = *off
     C     VALKTX        IFNE      1
     C                   ADD       1             WLTELL
     C                   WRITE     D1DET                                30
     C                   ELSE
     C                   ADD       1             WLTELL
     C                   MOVE      SLTEK1        D1TEK1
6.38 C                   MOVEL     SLTEK1        D1TEKX
     C                   MOVE      SLTEK2        D1TEK2
     C                   MOVE      *ON           *IN44
     C                   WRITE     D2DET                                30
     C                   END
6.30 C                   endif
6.30  * Skriv varelinjer
6.30 c                   if        b_pdfp = *on
6.30 c                   exsr      xml_deta
6.30 c                   endif
      *
     C     TAG03A        TAG
      *
      * Er det overflow ?
      *
     C     *IN30         CASEQ     *ON           XOVRFL
     C                   ENDCS
      *
     C     VSLUTT        ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for ordre-rabatt                                      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XORRAB        BEGSR
      *
     C     SHRABP        IFNE      *ZERO
     C                   ADD       1             WLTELL
     C                   Z-ADD     SHRABP        R1RABP
     C     SHRBGP        ADD       SHRBGF        R1RABG
     C     SHRKOP        ADD       SHRKOF        R1RABB
     C                   MULT      -1            R1RABB
6.30 c                   if        b_pdfp = *off
     C                   WRITE     R1TOT                                30
6.30 c                   else
6.30 c                   exsr      xml_ord_end
6.30 c                   exsr      xml_disc
6.30 c                   endif
     C                   ENDIF
      *
     C                   ENDSR
      *
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * T1TOT Behandle total T1                                         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      * Null-stille variabler
      *
     C     XTOTAL        BEGSR
6.32 C**                 Z-ADD     0             T1MVAS
     C                   Z-ADD     0             T1TMVA
      *
      * Grunnlag mva.
      *
     C     W6KJOP        SUB       W6RK1P        T1MVAG
     C                   SUB       W6RK2P        T1MVAG
     C                   SUB       W6RKOP        T1MVAG
      *
      * Netto beløp
      *
     C     W6KJOP        ADD       W6KJOF        T1TNET
     C                   SUB       W6RK1P        T1TNET
     C                   SUB       W6RK1F        T1TNET
     C                   SUB       W6RK2P        T1TNET
     C                   SUB       W6RK2F        T1TNET
     C                   SUB       W6RKOP        T1TNET
     C                   SUB       W6RKOF        T1TNET
      *
      * Skal mva. beregnes ?
      *
     C     W6KJOP        IFNE      0
     C     T1MVAG        MULT(H)   WPMVAT        WWTOTB
6.32 C**   WWTOTB        SUB       T1MVAG        T1TMVA
6.32 c     shfsum        sub       shmvgp        t1tmva
6.32 C**                 Z-ADD     WPMVAS        T1MVAS
     C                   ELSE
     C                   Z-ADD     0             T1MVAG
     C                   ENDIF
      *
     C                   Z-ADD     SHFSUM        T1TOTB
      *
      * Behandler direkte fakturasum
      *
     C     VAOKRE        IFEQ      '-'
     C                   EVAL      T1FSUM = SHTOTF * -1
     C                   ELSE
     C                   EVAL      T1FSUM = SHTOTF
     C                   ENDIF
      *
     C     T1FSUM        SUB       SHFSUM        T1DIFF
      *
     C                   MOVE      *OFF          *IN38
     C     T1FSUM        IFNE      *ZERO
     C                   MOVE      *ON           *IN38
     C                   ENDIF
      *
      *
      * Finne ut om det er
      * plass til å skrive
      * avslutning uten å
      * skifte til ny side
      * først.
      *
      * Trekker ut heading
      *
     C     DSALIN        SUB       24            WLTEST
      *
      * Trekker ut antall
      * linjer skrevet
      *
     C                   SUB       WLTELL        WLTEST
      *
      * Trekker ut plassbehov
      * for avslutning
      *
     C                   SUB       8             WLTEST
      *
      * Skrive ny heading ?
      *
     C     WLTEST        IFLT      0
6.30 c                   if        b_pdfp = *off
     C                   WRITE     A1HDR                                30
6.30 c                   endif
     C                   Z-ADD     0             WLTELL
     C                   ENDIF
      *
      * Skrive totalsum
      *
6.30 c                   if        b_pdfp = *off
     C                   WRITE     T1TOT                                30
6.30 c                   else
6.30 c                   exsr      xml_ord_end
6.30 c                   exsr      xml_netto
6.30 c                   exsr      xml_vat
6.30 c                   exsr      xml_total
6.30 c                   endif
      *
      * Klargjøre kidfelt
      * + modulusberegn.
      * + splitte kr/øre
      *
     C                   MOVE      WWFIRM        DSKFIR
     C                   MOVE      *ZERO         DSKKOD
     C                   MOVE      *ZERO         DSKLED
6.nu C                   MOVE      *ZERO         DSKTYP
     C                   MOVE      SHLDOR        DSKKTO
     C                   MOVE      SHBINR        DSKBIL
      *
     C                   ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for overflow                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XOVRFL        BEGSR
      *
     C                   ADD       1             A1SIDE
     C                   MOVE      *ON           *IN45
     C                   WRITE     O1DET                                30
     C                   WRITE     A1HDR                                30
     C                   MOVE      *OFF          *IN45
     C                   WRITE     O1DET                                30
     C                   Z-ADD     0             WLTELL
      *
     C                   ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for oppstart                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XSTRSR        BEGSR
      *
     C                   Z-ADD     1             A1SIDE
     C                   Z-ADD     1             FCYCLE            1 0
      *
      * Legger inn firma i nøkkel
      *
     C                   MOVE      DSFIRM        WWFIRM
      *
      * Legger inn år i nøkkel
      *
     C                   MOVE      DSAARR        WWAARR
      *
      * Klargjøre resterende
      * nøkkelbegrep
      *
     C                   MOVE      DSFFNR        WWBINR
     C                   MOVE      *ZERO         WWNUMM
     C                   MOVE      *ZERO         WWSUFF
     C                   MOVE      *ZERO         WWKTXT
     C                   MOVE      *ZERO         WWLINE
      *
     C     KEY01         SETLL     SIHEL1
     C                   READ      SIHEL1                                 61
     C                   MOVE      *ZERO         WWKTXT
     C                   MOVE      *ZERO         WWLINE
      *
      * Klargjøring dersom firma -
      * opplysninger skal printes ut
      *
     C     AFPRFI        IFEQ      1
     C     KEY06         CHAIN     AFIRL1R                            66
     C                   MOVE      AAFNAV        A1FNAV
     C                   MOVE      AAFAD1        A1FAD1
     C                   MOVE      AAFAD2        A1FAD2
     C                   MOVE      AAFSTE        A1FSTE
     C                   MOVE      'Foretak:'    DSFF01
     C                   MOVE      ' NO'         DSFF02
     C                   MOVE      AAFFTN        DSFF03
     C                   MOVE      ' MVA'        DSFF04
     C                   MOVE      DSFFTX        A1FFTX
     C                   MOVE      'Tlf/fax:'    A1TFAX
     C                   MOVE      AAFTLF        A1FTLF
     C                   MOVE      AAFFAX        A1FFAX
6.33 C                   eval      w_mail = aamail
6.33 C                   eval      w_weba = aaweba
      *
     C                   ENDIF
      *
      * Hente Kunde-tilbuds-nummer
      *
     C     KEY09         CHAIN     LSTSL1R                            69
      *
     C     *IN69         IFEQ      *OFF
     C                   MOVE      LAALEV        W0LDOR
     C                   END
      *
      * Slår opp ordretype
      *
     C                   MOVE      DSOTYP        WWOTYP
     C     KEY07         CHAIN     VOTYL1R                            67
      *
      * Er ordretype negativ ?
      *
     C     VAOKRE        IFEQ      '-'
     C                   MOVE      *ON           *IN36
     C                   ENDIF
      *
     C                   ENDSR
      *
      *
     C/EJECT
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_envm      begsr
6.30  * Hvis skjermvisning skal vi ikke lagre i spoolfile
6.30 c                   if        l_skje = 1
6.30 c                   eval      w_spol = 'true'
6.30 c                   else
6.30 c                   eval      w_spol = 'false'
6.30 c                   endif
6.30  *
6.30  /Free
6.30       // Finne nytt batch nummer
6.30           UpdHTMLVar('BatchNo':               w_jkey);
6.30           UpdHTMLVar('Batchtype':  'incominginvoice');
6.30           UpdHTMLVar('Username':              l_user);
6.30           WrtSection('Topp');
6.30       // Finn report command variabler
6.30           UpdHTMLVar('User':                l_user);
6.30           UpdHTMLVar('PW':                     ' ');
6.30           UpdHTMLVar('IPAdr':                  ' ');
6.30           UpdHTMLVar('Schema':        'ADB'+l_filg);
6.30           UpdHTMLVar('Companyno':    %char(dsfirm));
6.36           UpdHTMLVar('Departmentnoarkiv': %char(l_avde));
6.30           WrtSection('Credential');
6.30       // Finn report command variabler
6.30           UpdHTMLVar('Jaspertemplate':      d_jasm);
6.30           UpdHTMLVar('Logo':           jasper_logo);
6.30           UpdHTMLVar('Keepspool':           w_spol);
6.30           WrtSection('ReportCommand');
6.30  /End-free
6.30  *
6.30  * Hvis skjermvisning skal ikke PDF skrives
6.30  *
6.30 c                   if        l_skje = 0 and
6.30 c                             l_mail = 0
6.30  * Hvis *ARKIV er valgt som skriver, skal det ikke skrives ut
6.30 c                   if        l_utqm <> '*ARKIV'
6.30  *
6.30 c                   if        l_land = 1
6.30 c                   eval      w_land = 'LANDSCAPE'
6.30 c                   else
6.30 c                   eval      w_land = 'PORTRAIT'
6.30 c                   endif
6.30  * Sjekk at valgt outq støttes av skriveren. Kan skli gjennom hvis
6.30  * jobben legges på jobbkø.
6.30 c                   eval      p_ok = '0'
6.30 c                   call      'AP612R'
6.30 c                   parm                    l_filg
6.30 c                   parm                    l_outq
6.30 c                   parm                    p_ok
6.30  * Hvis feil utkø, logges dette i transaksjonsloggen
6.30 c                   if        p_ok = '0'
6.30 c                   eval      w_jstat = 20
6.30 c                   eval      w_jtext = 'Ugyldig utkø '+ l_outq + ' er val+
6.30 c                             gt. Ingen utskrift er generert. Utskrift kan+
6.30 c                              arkiveres.'
6.30 c                   call      'AB705R'
6.30 c                   parm                    l_bach
6.30 c                   parm                    w_jstat
6.30 c                   parm                    w_jtext
6.30 c                   else
6.30  * Hent inn skuffinformasjon for skriveren
6.30 c                   eval      w_dtray = *blank
6.30 c                   eval      w_gtray = *blank
6.30 c                   call      'AP611R'
6.30 c                   parm                    l_filg
6.30 c                   parm                    l_outq
6.30 c                   parm                    w_dtray
6.30 c                   parm                    w_gtray
6.30  * Hent inn skuffinformasjon for skriveren - default inskuff
6.30 c                   eval      w_draw1 = *blank
6.30 c                   movel     w_dtray       w_skuf
6.30 c                   call      'AP614R'
6.30 c                   parm                    l_outq
6.30 c                   parm                    w_skuf
6.30 c                   parm                    w_draw1
6.30  *
6.30 c                   if        l_copy > 0
6.30 c                   eval      w_copy = l_copy
6.30 c                   else
6.30 c                   eval      w_copy = 1
6.30 c                   endif
6.30  *
6.30  /Free
6.30       // Finn print informasjon
6.30           UpdHTMLVar('Printername':         l_outq);
6.30           UpdHTMLVar('Copies':        %char(w_copy));
6.30           UpdHTMLVar('Papersource':        w_draw1);
6.30           UpdHTMLVar('Lastpagedrawer':         ' ');
6.30           UpdHTMLVar('Duplex':             'false');
6.30           UpdHTMLVar('Quality':                ' ');
6.30           UpdHTMLVar('Sorting':                ' ');
6.30           UpdHTMLVar('Staple':              'true');
6.30           UPDHTMLVar('Alignment':           w_land);
6.30           WrtSection('PrintCommand');
6.30  /End-free
6.30 c                   endif
6.30 c                   endif
6.30 c                   endif
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Heading                 *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_head_inv  begsr
6.30  *
6.30 c                   eval      w_str_in = *blanks
6.30 c                   eval      w_str_out = *blanks
6.30 c                   eval      w_mtxt = *blanks
6.30 c                   eval      x_betb = %char(shbetb)
6.30  *
6.30  * Hvis mail skal skrives, må vi hente mail informasjon
6.30  *
6.30 c                   if        l_mail = 1
6.30 c                   eval      p_kule = 'L'
6.30 c                   eval      p_kund = shldor
6.30 c                   eval      p_kpro = 0
6.30 c                   eval      p_numm = shnumm
6.31 c                   eval      p_suff = shsuff
6.30 c                   eval      p_selg = shinnk
6.30 c                   eval      p_in03 = *off
6.30  * Henter ut mailserver
6.30 c                   eval      p_serv = *blank
6.30 c                   eval      p_stat = *blank
6.30 c                   call      'AM705C'
6.30 c                   parm                    p_serv
6.30 c                   parm                    p_stat
6.30  *
6.30 c                   call      'FO798R'
6.30 c                   parm                    p_kule
6.30 c                   parm                    p_kund
6.30 c                   parm                    p_kpro
6.30 c                   parm                    p_numm
6.31 c                   parm                    p_suff
6.30 c                   parm                    p_selg
6.30 c                   parm                    p_navn
6.30 c                   parm                    p_emal
6.31 c                   parm                    p_ema2
6.31 c                   parm                    p_ema3
6.30 c                   parm                    p_emne
6.30 c                   parm                    p_txt1
6.30 c                   parm                    p_txt2
6.30 c                   parm                    p_txt3
6.30 c                   parm                    p_txt4
6.30 c                   parm                    p_pers
6.31 c                   parm                    p_kopi
6.30 c                   parm                    p_inif
6.30 c                   parm                    p_in03
6.30  * Scann av strenger
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_emne        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_pemne
6.30  * Scann av strenger
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt1
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt2
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt3        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt3
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt4        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt4
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_pers        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ppers
6.30  *
6.30 c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
6.30 c                                      %trim(w_ptxt2) + crlf +
6.33 c                                      %trim(w_ptxt3) + crlf +
6.30 c                                      %trim(w_ptxt4) + crlf +
6.30 c                                      %trim(w_ppers)
6.30  *
6.31 c                   if        p_kopi = *blanks
6.31 c                   eval      p_kopi = d_emal
6.30 c                   endif
6.30  *
6.30 c                   if        p_in03 = *off
6.30  *
6.30  /Free
6.30       // Skriv mailinformasjon
6.31           WrtSection('MailCommandStart');
6.31       //  UpdHTMLVar('Receivers':           p_emal);
6.31           if %Trim(p_emal)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_emal);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema2)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema2);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema3)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema3);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.30           UpdHTMLVar('CC':                     ' ');
6.31           UpdHTMLVar('BCC':                 p_kopi);
6.31           UpdHTMLVar('Sender':              p_kopi);
6.30     //    UpdHTMLVar('Subject':             p_emne);
6.30           UpdHTMLVar('Subject':             w_pemne);
6.30           UpdHTMLVar('Message':             w_mtxt);
6.30           UpdHTMLVar('SMTPServer':          p_serv);
6.30           UPDHTMLVar('SMTPUser':               ' ');
6.30           UPDHTMLVar('SMTPPw':                 ' ');
6.31      //   WrtSection('MailCommand');
6.31           WrtSection('MailCommandEnd');
6.30  /End-free
6.30 c                   endif
6.30 c                   endif
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Firma
6.30 c                   eval      w_1fnav = *blank
6.30 c                   eval      w_1fad1 = *blank
6.30 c                   eval      w_1fad2 = *blank
6.30 c                   eval      w_1navn = *blank
6.30 c                   eval      w_1gate = *blank
6.30 c                   eval      w_1adr2 = *blank
6.30 c                   eval      w_2navn = *blank
6.30 c                   eval      w_2adr1 = *blank
6.30 c                   eval      w_2adr2 = *blank
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1fnav        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1fnav
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1fad1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1fad1
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1fad2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1fad2
      * Vi må oversette aktuelle tekster til "xml" tegn - Partner
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1navn        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1navn
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1gate        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1gate
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1adr2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1adr2
      * Avdelingsinformasjon - navn
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_dnavn       P_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_dnavn
      * Avdelingsinformasjon - adresse
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_dadr1       P_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_dadr1
      * Avdelingsinformasjon - adresse 2
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_dadr2       P_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_dadr2
      * Avdelingsinformasjon - poststed
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_dpstd       P_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_dpstd
8.01  * Firma - poststed
8.01 c                   eval      w_1fste  = *blanks
8.01 c                   eval      p_str_in = *blank
8.01 c                   eval      p_lr = '0'
8.01 c                   movel     a1fste        P_str_in
8.01 c                   call      'AP613R'
8.01 c                   parm                    p_str_in
8.01 c                   parm                    p_str_out
8.01 c                   parm                    p_lr
8.01 c                   movel     p_str_out     w_1fste
8.01  * Partner - poststed
8.01 c                   eval      w_1sted  = *blanks
8.01 c                   eval      p_str_in = *blank
8.01 c                   eval      p_lr = '0'
8.01 c                   movel     a1sted        P_str_in
8.01 c                   call      'AP613R'
8.01 c                   parm                    p_str_in
8.01 c                   parm                    p_str_out
8.01 c                   parm                    p_lr
8.01 c                   movel     p_str_out     w_1sted
6.30  /Free
6.30
6.30       // Skriv firmavariabler
6.30           UpdHTMLVar('Reporttext':            a1txt1);
6.30           UpdHTMLVar('CompanyName':          w_1fnav);
6.30           UpdHTMLVar('Companyadress1':       w_1fad1);
6.30           UpdHTMLVar('Companyadress2':       w_1fad2);
6.30           UpdHTMLVar('Companypostalcode':        ' ');
8.01      //   UpdHTMLVar('Companypostoffice':     a1fste);
8.01           UpdHTMLVar('Companypostoffice': %trim(w_1fste));
6.30           UpdHTMLVar('Companyphone':          a1ftlf);
6.30           UpdHTMLVar('Companyfax':            a1ffax);
6.30           UpdHTMLVar('Companyorgno':   %char(aafftn));
6.30           UpdHTMLVar('Companygiro':    %char(aafbgi));
6.33           UpdHTMLVar('Companyemail':   %trim(w_mail));
6.33           UpdHTMLVar('Companywebpage': %trim(w_weba));
6.30           WrtSection('Company');
6.30
6.30           UpdHTMLVar('Departmentno':    %char(shavde));
6.30           UpdHTMLVar('Departmentname':        w_dnavn);
6.30           UpdHTMLVar('Departmentadress1':     w_dadr1);
6.30           UpdHTMLVar('Departmentadress2':     w_dadr2);
6.30           UpdHTMLVar('Departmentpostalcode':      ' ');
6.30           UpdHTMLVar('Departmentpostoffice':  w_dpstd);
6.30           UpdHTMLVar('Departmentphone':       w_dphon);
6.30           UpdHTMLVar('Departmentfax':         w_dfaxn);
6.30           WrtSection('Department');
6.30
6.30           test(de) *dmy a1fkda;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(a1fkda : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
6.30
6.30           test(te) *hms a1time;
6.30           if %error;
6.30           tmptime = *loval;
6.30           else;
6.30           tmptime = %time(a1time : *hms);
6.30           endif;
6.30           UpdHTMLVar('Creationtime': %char(tmptime : *hms));
6.30           WrtSection('Creation');
6.30
6.30           UpdHTMLVar('Partnerno':      %char(a1ldor));
6.30           UpdHTMLVar('Partnercategory':%char(rlkatg));
6.30           UpdHTMLVar('Partnername':          w_1navn);
6.30           UpdHTMLVar('Partneradress1':       w_1gate);
6.30           UpdHTMLVar('Partneradress2':       w_1adr2);
6.30           UpdHTMLVar('Partnerpostalcode':        ' ');
8.01     //    UpdHTMLVar('Partnerpostoffice':     a1sted);
8.01           UpdHTMLVar('Partnerpostoffice': %trim(w_1sted));
6.30           UpdHTMLVar('Partnerphone':          rltlfn);
6.30           UpdHTMLVar('Partnercellphone':      rlmobn);
6.30           UpdHTMLVar('Partnerfax':            rltlfx);
6.30           UpdHTMLVar('Salesdocumentno':%char(a1binr));
6.30           WrtSection('Partner');
6.30
6.30  /End-free
6.30  *
6.30 c                   if        %trim(a2navn) <> *blank
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Prosjekt
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a2navn        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_2navn
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a2adr1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_2adr1
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a2adr2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_2adr2
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     shlbtx        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_lbtx
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1lmtx        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_lmtx
8.01  * Prosjekt - poststed
8.01 c                   eval      w_2sted = *blanks
8.01 c                   eval      p_str_in = *blank
8.01 c                   eval      p_lr = '0'
8.01 c                   movel     a2sted        P_str_in
8.01 c                   call      'AP613R'
8.01 c                   parm                    p_str_in
8.01 c                   parm                    p_str_out
8.01 c                   parm                    p_lr
8.01 c                   movel     p_str_out     w_1fste
6.30  *
6.30  /Free
6.30       // Prosjekt informasjon
6.30           UpdHTMLVar('Projectno':                '0');
6.30           UpdHTMLVar('Projectname':          w_2navn);
6.30           UpdHTMLVar('Projectadress1':       w_2adr1);
6.30           UpdHTMLVar('Projectadress2':       w_2adr2);
6.30           UpdHTMLVar('Projectpostalcode':        ' ');
8.01      //   UpdHTMLVar('Projectpostoffice':     a2sted);
8.01           UpdHTMLVar('Projectpostoffice': %trim(w_2sted));
6.30           WrtSection('Project');
6.30  /End-free
6.30 c                   endif
6.30  /Free
6.30
6.30           test(de) *dmy a1ffda;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(a1ffda : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Duedate':   %char(tmpdate : *iso));
6.30
6.30           UpdHTMLVar('Currency':                 shvalk);
6.30           UpdHTMLVar('Discountcat':       %char(shrkat));
6.30           UpdHTMLVar('Agent':             %char(shsped));
6.30           UpdHTMLVar('Paymentcondition':         a1ctxt);
6.30           WrtSection('InfoHead1');

6.30           UpdHTMLVar('Deliverymethod':               w_lmtx);
6.30           test(de) *dmy w_ldat;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(w_ldat : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Deliverydate':   %char(tmpdate : *iso));
6.30           UpdHTMLVar('Deliverytype':                     ' ');
6.30           UpdHTMLVar('Deliveryterms':                 w_lbtx);
6.30           UpdHTMLVar('Drivingroute':           %char(shkjor));
6.30           WrtSection('DeliveryInfo');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Heading                 *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_head_ord  begsr
6.30  *
6.30  * Sørg for at xml er lukket skikkelig hvsi samlefaktura
6.30  *
6.30 c                   if        b_samf = *on
6.30 c                   exsr      xml_ord_end
6.30 c                   endif
6.30  *
6.30 c                   eval      w_str_in = *blanks
6.30 c                   eval      w_str_out = *blanks
6.30 c                   eval      w_mtxt = *blanks
6.30 c                   eval      w_rekv = *blanks
6.30 c                   eval      x_numm = %char(a1numm)+a1suff
6.30 c                   eval      x_vref = %char(shinnk)+' '+a1vref
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1dref        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1dref
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1vref        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1vref
      *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     a1rekv        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_rekv
6.30  /Free
6.30
6.30       // Ordre informasjon
6.30           UpdHTMLVar('Orderno':              x_numm);
6.30
6.30           test(de) *dmy a1bdat;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(a1bdat : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Orderdate': %char(tmpdate : *iso));
6.18           UpdHTMLVar('Requisitionno':            w_rekv);
6.30
6.30           test(de) *dmy a1bdat;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(a1bdat : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Deliverydate': %char(tmpdate : *iso));
6.30           UpdHTMLVar('Refordernumber':        %char(shornr));
6.30           UpdHTMLVar('Headwarehouse':         %char(shlage));
6.30           UpdHTMLVar('Ordertype':                    shotyp);
6.30           UpdHTMLVar('Supplierinvoiceno':     %trim(shlfnr));
6.30           UpdHTMLVar('Supplierorderno':       %trim(shlonr));
6.30           UpdHTMLVar('Edimessageno':            %char(shmnum));
6.30           WrtSection('OrderStart');
6.30
6.30       // Vår og deres ref
6.30           UpdHTMLVar('Salesrefno':            %char(shinnk));
6.30           UpdHTMLVar('Salesrefname':         %trim(w_1vref));
6.30           UpdHTMLVar('Salesrefemail':                   ' ');
6.30           UpdHTMLVar('Salesrefcellphone':               ' ');
6.30
6.30           UpdHTMLVar('Partnerrefname':       %trim(w_1dref));
6.30           UpdHTMLVar('Partnerrefphone':                 ' ');
6.30           UpdHTMLVar('Partnerrefmail':                  ' ');
6.30           WrtSection('References');
6.30
6.30       //  Legg ut 'heading' på linje
6.30           WrtSection('Invoicelines');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Detaljer                *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_deta      begsr
6.30  * Sørg for at vi har skrevet siste tag for topptext før vi begynner
6.30  * med detaljer.
6.30 c                   if        b_topt = *on
6.30 c                   exsr      xml_topt_end
6.30 c                   eval      b_topt = *off
6.30 c                   endif
6.30  *
6.30 c                   eval      w_lvar = *blank
6.30 c                   eval      w_tek1 = *blank
6.30 c                   eval      w_tek2 = *blank
6.30 c                   movel     sltek1        d1tek1
6.30 c                   movel     sltek2        d1tek2
6.30  *
6.30 c                   if        valktx <> 1
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Varetekster
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     d1tek1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_tek1
6.30  *
6.30 c                   if        d1tek2 <> *blank
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     d1tek2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_tek2
6.30 c                   endif
      * Lev.varenummer
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.39 c                   if        w_lv_lvar <> *blank
6.39 c                   movel     w_lv_lvar     p_str_in
6.39 c                   else
6.30 c                   movel     vvlvar        P_str_in
6.39 c                   endif
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_lvar
6.30  * Håndtere riktig antall desimaler
6.30 c                   if        *in40 = *on
6.30 c                   callp     updHTMLVar('Quantity':%char(d1ant0))
6.30 c                   callp     updHTMLVar('NoDecimals':        '0')
6.30 c                   elseif    *in41 = *on
6.30 c                   callp     updHTMLVar('Quantity':%char(d1ant1))
6.30 c                   callp     updHTMLVar('NoDecimals':        '1')
6.30 c                   elseif    *in42 = *on
6.30 c                   callp     updHTMLVar('Quantity':%char(d1ant2))
6.30 c                   callp     updHTMLVar('NoDecimals':        '2')
6.30 c                   elseif    *in43 = *on
6.30 c                   callp     updHTMLVar('Quantity':%char(d1ant3))
6.30 c                   callp     updHTMLVar('NoDecimals':        '3')
6.30 c                   endif
6.30  *
6.30 c                   if        shldat <> *loval
6.30 c     *dmy          move      shldat        w_lddt
6.30 c                   endif
6.30  *
6.30  /Free
6.30       // Skriv detaljer
6.30           UpdHTMLVar('Itemno':             d1vare);
6.30           UpdHTMLVar('Text1':              w_tek1);
6.30           UpdHTMLVar('Text2':              w_tek2);
6.30           UpdHTMLVar('Unit':                d1enh1);
6.30           UpdHTMLVar('Currency':           shvalk);
6.30           UpdHTMLVar('Pricecode':    %trim(d1tine));
6.30           UpdHTMLVar('Priceexvat':   %char(d1bpri));
6.30           UpdHTMLVar('Amountexvat':  %char(d1nbel));
6.30           UpdHTMLVar('Netamountexvat': %char(d1nbel));
6.30           UpdHTMLVar('Discount':     %char(d1rabp));
6.30           UpdHTMLVar('Nobbno':      %char(slnobb));
6.30           UpdHTMLVar('Bookingno':     %char(slornr));
6.30           UpdHTMLVar('Lineno':        %char(slline));
6.30           UpdHTMLVar('Warehouse':     %char(sllage));
6.30           test(de) *dmy w_lddt;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(w_lddt : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Deliverydate': %char(tmpdate : *iso));
6.30           UpdHTMLVar('Partneritemno':%trim(w_lvar));
6.30           UpdHTMLVar('Campaign':               ' ');
6.30           UpdHTMLVar('Gtin':           %char(sleann));
6.30           UpdHTMLVar('Infocode':       %trim(d1info));
6.30           WrtSection('Line');
6.30
6.30  /End-free
6.30  *
6.30 c                   else
6.30 c                   eval      w_tek1 = *blank
6.30 c                   eval      w_tek2 = *blank
6.30 c                   movel     sltek1        d1tek1
6.30 c                   movel     sltek2        d1tek2
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Tekstlinjer
6.30 c                   movel     d1tek1        w_str_in
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     d1tek1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_tek1
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     d1tek2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_tek2
6.30  *
6.30 c                   if        %subst(d1tek1:35:1) = ' ' or
6.30 c                             %subst(d1tek2:1:1) = ' '
6.30 c                   eval      w_tek0 = %trim(w_tek1) + ' ' + %trim(w_tek2)
6.30 c                   else
6.30 c                   eval      w_tek0 = %trim(w_tek1) + %trimr(w_tek2)
6.30 c                   endif
6.30  *
6.30  /Free
6.30      //   UpdHTMLVar('Text1':              d1tek1);
6.30           UpdHTMLVar('Text1':       %trim(w_tek0));
6.30           UpdHTMLVar('Text2':                 ' ');
6.30           WrtSection('TextLine');
6.30  /End-free
6.30  *
6.30 c                   endif
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Lukk ordre              *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_ord_end   begsr
6.30  *
6.30 c                   if        b_orde = *on
6.30 c                   eval      b_orde = *off
6.30  * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
6.30  * avslutter.
6.30 c                   if        b_bott = *on
6.30 c                   exsr      xml_bott_end
6.30 c                   eval      b_bott = *off
6.30 c                   endif
6.30  *
6.30  /Free
6.30
6.30       // Ordre informasjon
6.30           WrtSection('EndOrderTag');
6.30
6.30  /End-free
6.30  *
6.30 c                   endif
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Rabatt                  *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_disc      begsr
6.30  *
6.30  /Free
6.30
6.30       // Ordre informasjon
6.30           UpdHTMLVar('Discountinpercent':   %char(r1rabp));
6.30           UpdHTMLVar('Discountbasis':       %char(r1rabg));
6.30           UpdHTMLVar('Sumdiscount':         %char(r1rabb));
6.30
6.30           WrtSection('DiscountLine');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Nettolinje              *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_netto     begsr
6.30  *
6.30  /Free
6.30
6.30       // Ordre informasjon
6.30           UpdHTMLVar('Sumnettoexcvat':   %char(t1tnet));
6.30
6.30           WrtSection('Nettoline');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - mva linje               *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_vat       begsr
6.30  *
6.30  /Free
6.30
6.30       // Ordre informasjon
6.32       //  UpdHTMLVar('Vatpercent':          %char(t1mvas));
6.32           UpdHTMLVar('Vatpercent':                    '0');
6.30           UpdHTMLVar('Vatbasis':            %char(t1mvag));
6.30           UpdHTMLVar('Sumvat':              %char(t1tmva));
6.30
6.30           WrtSection('VatLine');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Total                   *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_total     begsr
6.30  *
6.30  /Free
6.30       // Skriv spesifikasjoner
6.30           UpdHTMLVar('Sumtotal':         %char(t1totb));
6.30           UpdHTMLVar('Sumtotaldiff':     %char(t1diff));
6.30           UpdHTMLVar('Sumtotalinvoice':  %char(t1fsum));
6.30
6.30           WrtSection('TotalLine');
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Topptekst start         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_topt_str  begsr
6.30  *
6.30  /Free
6.30       // Skriv tekstlinjer
6.30           WrtSection('TopTextStart');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Topptekst               *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_topptxt   begsr
6.30  *
6.30 c                   eval      w_ttx1 = *blank
6.30 c                   eval      w_ttx2 = *blank
6.30 c                   eval      w_ttx3 = *blank
6.30  *
6.30 c                   if        %trim(sltek1) <> *blank
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
6.30 c                   eval      w_ttx1 = *blank
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     sltek1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ttx1
6.30 c                   endif
6.30  *
6.30  * Flyttet for å slå sammen begge linjene da de hører sammen
6.30  *
6.30 c                   if        %trim(sltek2) <> *blank
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
6.30 c                   eval      w_ttx2 = *blank
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     sltek2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ttx2
6.30 c                   endif
6.30  *
6.30 c                   if        %trim(sltek3) <> *blank
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
6.30 c                   eval      w_ttx3 = *blank
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     sltek3        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ttx3
6.30 c                   endif
6.30  * Så slår vi sammen linjene
6.30 c                   eval      w_ttxt = *blank
6.30 c                   eval      w_ttxt = %trim(w_ttx1)+%trim(w_ttx2)+
6.30 c                                      %trim(w_ttx3)
6.30  *
6.30 c                   if        %trim(w_ttxt) <> *blank
6.30  /Free
6.30       // Skriv tekstlinjer 1
6.30           UpdHTMLVar('Toptext':     w_ttxt);
6.30           WrtSection('TopTextLine');
6.30  /End-free
6.30 c                   endif
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Topptekst slutt         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_topt_end  begsr
6.30  *
6.30  /Free
6.30       // Skriv tekstlinjer
6.30           WrtSection('TopTextEnd');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Bunntekst start         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_bott_str  begsr
6.30  *
6.30  /Free
6.30       // Skriv tekstlinjer
6.30           WrtSection('BottomTextStart');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Bunntekst               *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_bunntxt   begsr
6.30  *
6.30 c                   eval      w_ttx1 = *blanks
6.30 c                   eval      w_ttx2 = *blanks
6.30 c                   eval      w_ttx3 = *blanks
6.30  *
6.30 c                   if        %trim(sltek1) <> *blank
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     sltek1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ttx1
6.30 c                   endif
6.30  *
6.30  * Flyttet for å slå sammen begge linjene da de hører sammen
6.30  *
6.30 c                   if        %trim(sltek2) <> *blank
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     sltek2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ttx2
6.30 c                   endif
6.30  *
6.30 c                   if        %trim(sltek3) <> *blank
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     sltek3        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ttx3
6.30 c                   endif
6.30  * Så slår vi sammen linjene
6.30 c                   eval      w_ttxt = *blank
6.30 c                   eval      w_ttxt = %trim(w_ttx1) + %trim(w_ttx2)+
6.30 c                                      %trim(w_ttx3)
6.30  *
6.30 c                   if        %trim(w_ttxt) <> *blank
6.30  /Free
6.30       // Skriv bunntekst
6.30           UpdHTMLVar('Bottomtext':  w_ttxt);
6.30           WrtSection('BottomTextLine');
6.30
6.30  /End-free
6.30 c                   endif
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Bunntekst slutt         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_bott_end  begsr
6.30  *
6.30  /Free
6.30       // Skriv slutt på bunntext
6.30           WrtSection('BottomTextEnd');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Slutt                   *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_end       begsr
6.30  *
6.30  /Free
6.30           WrtSection('EndInvoiceDocument');
6.30  /End-free
6.30  *
6.30  * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
6.30  *
6.30 c                   if        l_arch = 1
6.30  * Lag tag for vising i arkivklienten
6.30 c                   eval      w_dspl = *blank
6.30 c                   eval      w_dspl=%Trim(a1txt1)+' '+%char(a1binr) +
6.30 c                             ' Leverandør: '+ %trim(%char(a1ldor) + ' - '+
6.30 c                             %trim(a1navn))
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_dspl        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_dspl
6.30  * Referansetagg
6.30 c                   eval      w_refn = *blank
6.30 c                   eval      w_refn = %char(%subdt(w_date:*years)) +
6.30 c                             %char(a1binr)
6.30  /Free
6.30       // Skriv metattags
6.30
6.30           UpdHTMLVar('Refno':          %trim(w_refn));
6.30           UpdHTMLVar('Displaytag':     %trim(w_dspl));
6.30           WrtSection('ArchiveCommandStart');
6.30
6.30           UpdHTMLVar('Metavalue':      %char(a1binr));
6.30           UpdHTMLVar('Metakey':  'INNGFAKTURANUMMER');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':      %char(a1ldor));
6.30           UpdHTMLVar('Metakey':         'LEVERANDØR');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':            w_1navn);
6.30           UpdHTMLVar('Metakey':     'LEVERANDØRNAVN');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':      %char(shnumm));
6.30           UpdHTMLVar('Metakey':         'BESTILLING');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':      %trim(shlfnr));
6.30           UpdHTMLVar('Metakey':          'LEVFAKTNR');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':      %char(shornr));
6.30           UpdHTMLVar('Metakey':        'ORDRENUMMER');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             l_user);
6.30           UpdHTMLVar('Metakey':             'BRUKER');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue': %char(w_date:*iso));
6.30           UpdHTMLVar('Metakey':               'DATO');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             a1txt1);
6.30           UpdHTMLVar('Metakey':         'RUTINETEKST');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             l_ruti);
6.30           UpdHTMLVar('Metakey':             'RUTINE');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             l_wsid);
6.30           UpdHTMLVar('Metakey':             'SKJERM');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':      %char(dsfirm));
6.30           UpdHTMLVar('Metakey':              'FIRMA');
6.30           WrtSection('MetaTag');
6.30
6.30           WrtSection('ArchiveCommandEnd');
6.30  /End-free
6.30  *
6.30 c                   endif
6.30  *
6.30  /Free
6.30           WrtSection('Footer');
6.30  /End-free
6.30  *
6.30 c                   eval      XML_Output = XML_path + l_filg +'/'+
6.30 c                             'Inng_fakt_'+ %trim(w_jkey) + '.xml'
6.30  *
6.30 c                   callp     WrtHtmlToStmf(XML_Output: 819)
6.34  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
6.34 c                   if        d_dtaq = '1'
6.34 c                   eval      p_xmlf = xml_output
6.34 c                   eval      p_filg = 'ADB'+l_filg
6.34 c                   call      'AP629C'
6.34 c                   parm                    p_filg
6.34 c                   parm                    p_xmlf
6.34 c                   endif
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     pdf_preview   begsr
6.30  *
6.30  * Vi kaller program for launch av PDF i browser
6.30 c                   call      'AP621R'
6.30 c                   parm                    w_jkey
6.30  *
6.30 c                   endsr
6.30  *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Detaljer                *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     hnt_avde      begsr
6.30  * Hent inn avdelingsinformasjon
6.30 c
6.30 c                   eval      w_ddeno = shavde
6.30 c                   eval      w_dnavn = *blank
6.30 c                   eval      w_dadr1 = *blank
6.30 c                   eval      w_dadr2 = *blank
6.30 c                   eval      w_dpcde = *zeros
6.30 c                   eval      w_dpstd = *blank
6.30 c                   eval      w_dphon = *blank
6.30 c                   eval      w_dfaxn = *blank
6.30  *
6.30 c                   eval      ra07pf_avde = shavde
6.30 c     ra07pf_key    chain     ra07pfr                            90
6.30 c                   if        *in90  = *off
6.30 c                   eval      w_dnavn = ragtxt
6.30 c                   eval      w_dadr1 = ragadr
6.30 c                   eval      w_dadr2 = ragad2
6.30 c                   eval      w_dpcde = ragpnr
6.30 c                   eval      w_dpstd = (%char(ragpnr) + ' ' + ragste)
6.30 c                   if        ragtlf <> *blank
6.30 c                   eval      w_dphon = ragtlf
6.30 c                   endif
6.30 c                   if        ragfax <> *blank
6.30 c                   eval      w_dfaxn = ragfax
6.30 c                   endif
6.33  * Sjekk om info skal hentes fra avdeling
6.33 c                   if        l_prfi = 2
6.33 c                   eval      w_mail = ragmai
6.33 c                   eval      w_weba = ragweb
6.33 c                   endif
6.30 c                   endif
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Sluttag ordre           *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     proa_nummer   begsr
6.30  *
6.30  * Henter inn nytt nummer for bruk i xml filnavn
6.30  *
6.30 c                   eval      w_kode = '0'
6.30 c                   eval      w_firm = dsfirm
6.30 c                   eval      w_fell = 'NXTKLI'
6.30 c                   eval      w_type = *blank
6.30 c                   eval      w_fast = *blank
6.30 c                   eval      w_numm = *zero
6.30  *
6.30 c                   call      'AS100R'
6.30 c                   parm                    w_kode
6.30 c                   parm                    w_firm
6.30 c                   parm                    w_fell
6.30 c                   parm                    w_type
6.30 c                   parm                    w_fast
6.30 c                   parm                    w_numm
6.30  *
6.30 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     *INZSR        BEGSR
      *
     C     *LIKE         DEFINE    LAALEV        W0LDOR
     C     *LIKE         DEFINE    VAOTYP        WWOTYP
     C     *LIKE         DEFINE    SHLDOR        WWKUND
     C     *LIKE         DEFINE    SHFIRM        WWFIRM
     C     *LIKE         DEFINE    SHAARR        WWAARR
     C     *LIKE         DEFINE    SHBINR        WWBINR
     C     *LIKE         DEFINE    SHBINR        QQBINR
     C     *LIKE         DEFINE    SHKJOP        W6KJOP
     C     *LIKE         DEFINE    SHKJOF        W6KJOF
     C     *LIKE         DEFINE    SHRK1P        W6RK1P
     C     *LIKE         DEFINE    SHRK1F        W6RK1F
     C     *LIKE         DEFINE    SHRK2P        W6RK2P
     C     *LIKE         DEFINE    SHRK2F        W6RK2F
     C     *LIKE         DEFINE    SHRKOP        W6RKOP
     C     *LIKE         DEFINE    SHRKOF        W6RKOF
     C     *LIKE         DEFINE    SHRKOP        W6MVAG
     C     *LIKE         DEFINE    SHRKOP        W6MVAB
     C     *LIKE         DEFINE    SHKJOP        WWTOTB
     C     *LIKE         DEFINE    SHWSID        WWWSID
     C     *LIKE         DEFINE    SHNUMM        WWNUMM
     C     *LIKE         DEFINE    SHSUFF        WWSUFF
     C     *LIKE         DEFINE    SLLINE        WWLINE
     C     *LIKE         DEFINE    SLLTYP        WWLTYP
     C     *LIKE         DEFINE    SLKTXT        WWKTXT
     C     *LIKE         DEFINE    VVVARE        WWVARE
     C     *LIKE         DEFINE    SLIPNY        W1RAB1
      *
     C     *LIKE         DEFINE    SLIPNY        WLBELW
      *
      *  Nullstilling av felter som ikke kan redefineres
      *
     C                   MOVE      *BLANK        WPRETK            1
     C                   MOVE      *BLANK        DSCTXT           20
     C                   MOVE      *BLANK        WPTXT2           20
     C                   MOVE      *ZERO         WPKRAB            4 2
      *
     C                   MOVE      *BLANK        WPQMVA            1
     C                   MOVE      *BLANK        WPMVAX           30
     C                   MOVE      *ZERO         WPMVAS            6 2
     C                   MOVE      *ZERO         WPMVAT            5 4
     C                   MOVE      *ZERO         WPMVAF           10 9
      *
     C                   MOVE      *BLANK        WWRUTI           10
     C                   MOVE      *ZERO         WLTELL            3 0
     C                   MOVE      *ZERO         WLTEST            3 0
     C                   MOVE      *ZERO         N                 2 0
      *
      * Key for Heading-file
      *
     C     KEY01         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWAARR
     C                   KFLD                    WWBINR
     C                   KFLD                    WWNUMM
     C                   KFLD                    WWSUFF
      *
      * Key for Detalj-file
      *
     C     KEY02         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWAARR
     C                   KFLD                    WWBINR
     C                   KFLD                    WWNUMM
     C                   KFLD                    WWSUFF
     C                   KFLD                    WWKTXT
     C                   KFLD                    WWLINE
      *
      * Key for Tekst-linjer
      *
     C     KEY03         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWNUMM
     C                   KFLD                    WWSUFF
     C                   KFLD                    WWLINE
      *
      * Key for leverandør-register
      *
     C     KEY04         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWKUND
      *
      * Key for firmaregister
      *
     C     KEY06         KLIST
     C                   KFLD                    WWFIRM
      *
      * Key for ordretyper
      *
     C     KEY07         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWOTYP
      *
      * Key for linjetyper
      *
     C     KEY08         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWLTYP
      *
      * Key for statusregister
      *
     C     KEY09         KLIST
     C                   KFLD                    WWFIRM
      *
      * Key for formular-register
      *
     C     KEY10         KLIST
     C                   KFLD                    WWRUTI
      *
      * Key for vare-register
      *
     C     KEY11         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWVARE
6.30  * Key for posisjonering på selgere
6.30  *
6.30 c     ra09l1_key    klist
6.30 c                   kfld                    wwfirm
6.30 c                   kfld                    ra09l1_ikod
6.30  *
6.30  * Key for oppslag på avdelings-register
6.30  *
6.30 c     ra07pf_key    klist
6.30 c                   kfld                    w_firm
6.30 c                   kfld                    ra07pf_avde
      *
      * Hente inn rutinenavn
      * og meldingstekst
      *
6.30 C                   MOVE      l_ruti        WWRUTI
      *
     C     KEY10         CHAIN     AFORL1R                            69
     C  N69              MOVE      AFTXT1        A1TXT1
     C  N69              MOVE      AFMLD1        T1MLD1
      *
6.30  *
6.30  * Sjekk om vi skal bruke JASPER og XML generering av dokumenter
6.30 c                   if        l_poff = '1'
6.30 c                   eval      b_pdfp = *off
6.30 c                   eval      b_samf = *off
6.30 c                   eval      b_orde = *off
6.30 c                   eval      w_pdf = 0
6.30 c                   eval      w_pdf_ds = *blanks
6.30 c                   eval      w_ruti = l_ruti
6.30  *
6.30 c                   call      'AP609R'
6.30 c                   parm                    w_ruti
6.30 c                   parm                    w_pdf
6.30 c                   parm                    w_pdf_ds
6.30 c                   eval      d_pdf_ds = w_pdf_ds
6.30  * Vi skal kjøre med jasper
6.30 c                   if        w_pdf = 1 and
6.30 c                             %trim(d_xmlm) <> *blanks
6.30 c                   eval      p_mail = '0'
6.30 c                   eval      w_jkey = l_bach
6.30  *
6.30  * Hent inn xml templaten
6.30  *
6.30 c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
6.35 c                   callp     ClrHtmlBuffer
6.30  *
6.30  * Finn hvor xml'en skal legges
6.30  *
6.30 c                   eval      XML_path = *blanks
6.30 c                   eval      XML_path = %trim(d_path)
6.30  *
6.30  * Finn path til logo
6.30  *
6.30 c                   eval      jasper_logo = *blanks
6.30 c                   eval      jasper_logo = %trim(d_logo)
6.30  *
6.30  * Jobbnummer er allerede generert i AP600R. Overføres i *lda
6.30  *
6.30 c                   time                    w_date
6.30 C                   time                    wutime           12 0
6.30 C                   movel     wutime        a1time            6 0
6.30  * Vi logger ar utskriftprogrammet har startet
6.30 c                   eval      w_jstat = 10
6.30 c                   eval      w_jtext = 'Utskrift av innkommende faktura+
6.30 c                                        har startet'
6.30 c                   call      'AB705R'
6.30 c                   parm                    l_bach
6.30 c                   parm                    w_jstat
6.30 c                   parm                    w_jtext
6.30  * Vi skriver xml for miljø formater
6.30 c                   exsr      xml_envm
6.30 c                   eval      b_pdfp = *on
6.30  *
6.30 c                   endif
6.30 c                   else
6.30 c                   eval      b_pdfp = *off
6.30 c                   endif
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Tar inn parameter fra forrige program                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     *ENTRY        PLIST
6.nu C                   PARM                    WPPARM           34
      *
     C                   MOVE      *ZERO         DSAARR
     C                   MOVE      *BLANK        DSOTYP
     C                   MOVE      *ZERO         DSFFNR
     C                   MOVE      *ZERO         DSTFNR
     C                   MOVE      WPPARM        DSPARM
      *
      *
     C                   ENDSR
