# RPG Source Code Explanation

## Overview

This program (`FO412R`) is written in the ILE RPG language for IBM i systems. Its purpose is **deleting picking records and clearing the marking fields of an order**. In Norwegian, this is referred to as _"Sletting av utplukk og merking av ordren"_.

It operates on several physical files:
- **fohelu** (Order Header Register / ORDRE-HODE-REGISTER)
- **fplolu** (Picking Parameter Register / UTPLUKK-PARAM-REGISTER)
- **fplll1** & **fplllu** (Picking Line Register / UTPLUKK-LINJE-REGISTER)

## File Declarations (`F-Spec`)

```rpg
ffohelu    uf   e           k disk    rename(fohepfr:fohelur)
ffplolu    uf   e           k disk    rename(fplopfr:fplolur)
ffplll1    if   e           k disk    rename(fpllpfr:fplll1r)
ffplllu    uf   e           k disk    rename(fpllpfr:fplllur)
```
- External physical files are declared and renamed for their usages.
- Both input (`I`) and update (`U`) access is used.

## Data Definitions (`D-Spec`)

### Parameters
- `p_retu`, `p_firm`, `p_numm`, `p_suff`: Input parameters (return value, firm no, order number, order suffix), types are matched from the files.

### Local Variables
- Key variables for each file are defined for use with indexed lookup.
- Some work variables, e.g., `w_alf1`, `w_firm`.

### User Space
- `l_user` and `l_firm`â€”used to track the current user and firm, extracted from the local data area.

## Main Program Logic (`C-Spec`)

### 1. **Delete Picking Line Entries**

```rpg
c     fplll1_key    setll     fplll1r
c     fplll1_key    reade     fplll1r                                90
c                   dow       *in90 = *off
  ...
c                   eval      fplllu_llin = fkllin
c     fplllu_key    chain     fplllur                            91
c                   if        *in91 = *off
c                   delete    fplllur
c                   endif
  ...
c     fplll1_key    reade     fplll1r                                90
c                   enddo
```

- Loops through all picking line records matching the order and deletes associated entries in the update file (`fplllu`).

### 2. **Delete Picking Parameter Entry**

```rpg
c     fplolu_key    chain     fplolur                            92
c                   if        *in92 = *off
c                   delete    fplolur
c                   endif
```

- Locates a picking parameter record and deletes it for the order.

### 3. **Clear Flags in Order Header**

```rpg
c     fohelu_key    chain     fohelur                            90
c                   if        *in90 = *off
c                   eval      fokode = *zero
c                   eval      fokoda = *loval
c                   eval      fokoti = *loval
c                   eval      fokous = *blank
c                   eval      fokows = *blank
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
c                   update    fohelur
c                   endif
```

- Retrieves the order header.
- Resets various "marking" fields (zeros, blanks, low values).
- Updates date/time (`foedat`, `foetim`) and user (`foeusr`) for audit purposes.
- Updates the record.

### 4. **End of Program**

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Sets Last Record Indicator (`*INLR`) to ensure program cleanup.
- Returns from the program.

---

## Initialization Subroutine (`*INZSR`)

- Sets up file key lists (`KLIST`) for indexed access using input parameters.
- Loads entry parameters into key and work variables.

```rpg
c     *entry        plist
c                   parm                    p_retu
c                   parm                    p_firm
6.nu c                   parm                    p_numm
c                   parm                    p_suff
```
- Expects parameters for return value, firm, order, and suffix.
- These values are then loaded into relevant variables that will be used for keying the files during processing.

---

## Additional Notes

- **Indicators:** `*IN90`, `*IN91`, `*IN92` are used for EOF or "not found" after file operations.
- **Key Lists:** Defined for each file to facilitate key-based access (CHAIN, READE, etc.).
- **Audit Columns:** Updates user and timestamps on order changes.
- **Comments:** The source includes thorough comments, mostly in Norwegian.

---

## Summary of Program Flow

1. For the given firm, order number, and suffix:
   - **Delete** all related picking lines (lookup in `fplll1` and delete from `fplllu`).
   - **Delete** the picking parameter record (from `fplolu`).
   - **Clear** marking fields in the order header (`fohelu`).
2. Set `*INLR` to finish the program.

---

## Usage Context

This program is likely part of a larger order management system, handling cleanup when a picking process (the selection of items from inventory in preparation for shipping) for an order is to be cancelled or reset.

---

### A new developer should:

- Review the file layouts: `fohelu`, `fplolu`, `fplll1`, `fplllu`.
- Understand the key structure and relationships between order header, picking parameter, and picking line files.
- Be aware of indicator handling in classic RPG for file status.
- Note audit field handling (date, time, user).