## Program Overview

This program (`XF703R`) is part of the **ASFTP** system and is designed to check the status of FTP transfers. The code is written in RPG IV (RPGLE) and is focused on status management and validation of FTP transfer records, likely as part of a larger workflow for reporting or process control.

---

## Business/Domain Context

- **Domain**: FTP transfer management and monitoring.
- **Primary Function**: The program checks the status of a specific FTP transfer record, based on key fields (firm and name), and determines if it is available, busy, or locked.
- **Usage**: Typically called as a utility or subroutine from other programs or batch processes to validate or update the status of FTP transfer records.

---

## Structure and Flow

### File Definition

```rpg
faftplu    if   e           k disk      rename(aftppfr:aftplur)
```
- **File**: `AFTPPFR` is referenced as `AFTPLUR` in this program.
- **Access**: Indexed (`k`), external description (`e`), input (`i`), full procedural (`f`).
- **Domain Note**: This file contains FTP transfer records, with key fields likely being company/firm and transfer name.

---

### Parameter and Variable Definitions

- **Parameters**:
    - `p_navn`: The name/key of the FTP transfer to check (matches `afnavn` field in the file).
    - `p_status`: The status code to check or set ('B' for busy, etc.).

- **Variables**:
    - `aftplu_navn`: Local copy of transfer name (`afnavn`).
    - `w_firm`: Local copy of the firm/company code (`affirm`).
    - `l_firm`: Presumably a global or system-level firm identifier, extracted from user data space.

---

### Main Logic

#### Key Construction and File Access

```rpg
c     aftplu_key    chain     aftplur
```
- **Purpose**: Attempts to retrieve the FTP record matching the current firm and transfer name.

#### Not Found Handling

```rpg
c                   if        not %found
c                   eval      p_status = 'N'
c                   goto      slutt
c                   endif
```
- **Logic**: If the record does not exist, set status to 'N' (not found) and exit.

#### Busy/Locked Handling

```rpg
c                   if        p_status = 'B' and afstat = 'B'
c                   eval      p_status = 'L'
c                   goto      slutt
c                   endif
```
- **Logic**: If the requested status is 'B' (busy) and the record is already 'B', set status to 'L' (locked) and exit.
- **Business Rule**: Prevents multiple processes from marking the same transfer as busy simultaneously.

#### (Commented Out) Status Update

```rpg
c**                 eval      afstat = p_status
c**                 update    aftplur
```
- **Note**: The code to update the status in the database is commented out. This program, in its current form, only checks and reports status, not changes it.

#### Program Termination

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- **Logic**: Standard program termination and cleanup.

---

### Initialization Subroutine (`*INZSR`)

#### Parameter List Setup

```rpg
c     *entry        plist
c                   parm                    p_navn
c                   parm                    p_status
```
- **Purpose**: Receives parameters from the caller.

#### Key List Setup

```rpg
c     aftplu_key    klist
c                   kfld                    w_firm
c                   kfld                    aftplu_navn
```
- **Purpose**: Defines the key for file access (firm + transfer name).

#### Variable Initialization

```rpg
c                   eval      w_firm = l_firm
c                   eval      aftplu_navn = p_navn
```
- **Logic**: Initializes local variables from parameters and global fields.

---

## Indicators

The program documentation lists a comprehensive indicator usage convention for the project (see comments). While not all indicators are used in this program, be aware that indicators 31-99 are reserved for error, work, and file status handling across the codebase.

---

## Design Notes and Conventions

- **Key Construction**: Always uses a composite key of firm + transfer name for record access, supporting multi-company operation.
- **Status Codes**: 
    - 'N' = Not found
    - 'B' = Busy
    - 'L' = Locked (already busy)
- **Non-obvious**: The actual update of status is commented out, suggesting this program is currently read-only or is used in a context where updates are handled elsewhere.
- **Extensibility**: The structure allows for easy modification to enable status updates by uncommenting the relevant lines.

---

## Integration Points

- **Called By**: Other programs or batch processes that need to check (and potentially set) the status of FTP transfers.
- **File Dependency**: Relies on the `AFTPPFR`/`AFTPLUR` file structure. Ensure this file is available and keyed as expected.
- **Global Data**: Uses `l_firm` from a user data space, which must be initialized by the calling environment.

---

## Summary Table

| Element              | Purpose/Usage                                      |
|----------------------|----------------------------------------------------|
| `AFTPLUR`            | FTP transfer status records                        |
| `p_navn`             | Transfer name parameter                            |
| `p_status`           | Status code parameter/output                       |
| `w_firm`, `l_firm`   | Firm/company code                                  |
| `aftplu_navn`        | Local transfer name                                |
| Status codes         | 'N' = Not found, 'B' = Busy, 'L' = Locked          |
| Key construction     | By firm + transfer name                            |
| Update commented out | Currently only checks status, does not update      |

---

## Key Takeaways for New Developers

- This module checks (but does not update) FTP transfer record status for a given firm and transfer name.
- Be aware of the business rules around the 'busy' and 'locked' statuses.
- The program expects certain data (firm code) to be available in the user data space.
- Status change logic is present but disabledâ€”coordinate with the team before enabling updates.
- Follow project conventions for indicator and status code usage when extending or integrating this program.