# Overview  
This RPGLE program (`VP704R`) retrieves various prices for a given item/unit combination, based on company, price group, unit, delivery type, date, supplier, and warehouse. It returns sales price, purchase price, cost price and store price.  

---

## 1. Program Header & Metadata  
- `h option(*nodebugio) datedit(*dmy)`  
  - Disables debug I/O and sets date format to DDMMYYYY.  
- Comment block describes:  
  - System name, program name, purpose.  
  - Input/Output parameters.  
  - Change history.  

---

## 2. File Declarations  
```rpg
fvvprl1    if   e           k disk  rename(vvprpfr:vvprl1r)
fvvarl1    if   e           k disk  rename(vvarpfr:vvarl1r)
fvugrl1    if   e           k disk  rename(vugrpfr:vugrl1r)
```  
- Three keyed-disk files:  
  1. **VVPRL1** – price records  
  2. **VVARL1** – item master  
  3. **VUGRL1** – item subgroup  
- Each file is renamed at compile time to an easier internal name.

---

## 3. Parameter Definitions  
```rpg
d p_firm   s                   like(vpfirm)
d p_vare   s                   like(vpvare)
d p_prgr   s                   like(vpprgr)
...  
d p_inlr   s              1     // Flag to control *INLR  
```  
- **Input parameters**: company (`p_firm`), item (`p_vare`), price group (`p_prgr`), unit (`p_enhe`), delivery type (`p_lety`), date (`p_dato`), supplier (`p_ldor`), warehouse (`p_lage`), LR‐flag (`p_inlr`).  
- **Output parameters**: sales price (`p_sapr`), store price (`p_bupr`), cost price (`p_kopr`), purchase price (`p_inpr`).  

---

## 4. Working Variables  
```rpg
d w_firm    s                   like(vpfirm)
d w_dato    s                   like(vppdat)
d w_ldor    s                   like(vvldor)
d w_lage    s              2 0  
d b_pris    s              1    inz(*off) // Flag: price found?  
d b_inlr    s              1    inz(*off) // Temp copy of p_inlr  
```  
- `w_` prefix = working copy of parameters.  
- `b_pris` indicates if a valid price was found.  

---

## 5. Main Logic Flow  
1. **Initialize working fields**  
   ```rpg
   eval w_firm = p_firm  
   eval w_lage = p_lage  
   eval w_ldor = p_ldor  
   ```
2. **Retrieve item‐supplier link**  
   - Chain on `VVARL1` using `(w_firm, p_vare)` to get default supplier info for that warehouse.  
3. **Initialize date**  
   ```rpg
   eval w_dato = p_dato  
   if w_dato = *LOVAL; time w_dato; endif  
   ```
4. **Zero out output prices**  
   ```rpg
   eval p_sapr = 0; p_bupr = 0; p_kopr = 0; p_inpr = 0;
   ```
5. **Call `hent_pris` routine**  up to three times to find a valid price:  
   - First attempt with warehouse‐supplier from item record (`w_ldor`).  
   - If none found and `w_ldor ≠ default supplier`, try default supplier.  
   - If still none, try supplier = 0 (generic).  
6. **If no price found** → `goto avslutt` (end).  
7. **Compute cost price if zero**  
   - Uses item or subgroup margin % (`vvdekn`).  
   - `p_kopr = p_sapr – (p_sapr * margin / 100)`.  
8. **Set purchase price = cost price** if `p_inpr = 0`.  
9. **Exit**  
   ```rpg
   avslutt:
     if p_inlr <> *ON; eval *inlr = *ON; endif  
     return  
   ```

---

## 6. Subroutine: hent_pris  
Begins at label `hent_pris`. Responsible for searching the price file (`VVPRL1R`) with multiple fallbacks:  

1. **First pass** uses provided price group & delivery type.  
2. **If not found and `p_lety ≠ 0`**, retry with `lety = 0`.  
3. **If still not found and `p_prgr ≠ *BLANK`**, retry with `prgr = *BLANK`.  
4. **Within each attempt**:  
   - `SETLL` then `READE` retrieves entries in key order.  
   - Loop until record date (`vppdat`) is > working date.  
   - First match with valid date → set `b_pris = *ON` and populate `p_sapr`,`p_bupr`,`p_kopr`,`p_inpr`.  

Key fields used:  
```
(w_firm, p_vare, supplier, p_prgr, p_enhe, p_lety)
```

---

## 7. Initialization Subroutine (`*INZSR`)  
- Defines parameter lists (`plist`) and key lists (`klist`) for each file:  
  - `vvprl1_key` for price file  
  - `vvarl1_key` for item file  
  - `vugrl1_key` for subgroup file  
- Automatically runs at program start to set up chain/SETLL keys.

---

# Summary  
- **Entry**: receives item, unit, date, warehouse, supplier, etc.  
- **Flow**: lookup default supplier → initialize date → zero outputs → call `hent_pris` with fallbacks → calculate derived prices → return.  
- **Subroutine Logic**: layered search for matching price records, with graceful degradation on delivery type and price group.