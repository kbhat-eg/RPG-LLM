# RPG Program FM101R â€“ Detailed Explanation

This program, written in IBM ILE RPG, handles the maintenance of card/invoice agreements (kort/fakt.avtaler) with parameter-driven operations for reading, writing, updating, and deleting records in associated files.

---

## 1. **Header and Program Metadata**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: Disables debug for file I/O.
- `datedit(*dmy)`: Date fields are edited/displayed in day/month/year format.

The comment block describes the system, program, and revision history.

---

## 2. **File Declarations**

```rpg
ffmkal1    if   e           k disk    rename(fmkapfr:fmkal1r)
ffmkalu    uf a e           k disk    rename(fmkapfr:fmkalur)
frukrl1    if   e           k disk    rename(rukrpfr:rukrl1r)
```
- **fmkal1**: Input file, externally described, with key access, alias `fmkal1r`.
- **fmkalu**: Update file, externally described, with key access, alias `fmkalur`.
- **rukrl1**: Input file, externally described, with key access, alias `rukrl1r`.

---

## 3. **Data Declarations**

### Parameter Variables

```rpg
d p_ofir          s              3  0
d p_okun          s              6  0
d p_opro          s              6  0
d p_okpn          s              6  0
d p_otyp          s              2  0
d p_otsq          s              4  0
d p_oper          s              1
```
- **p_ofir**: Firm number (3 digits)
- **p_okun**: Customer number (6 digits)
- **p_opro**: Product number (6 digits)
- **p_okpn**: ?? (also 6 digits, not otherwise used in code)
- **p_otyp**: Type (2 digits)
- **p_otsq**: Sequence (4 digits)
- **p_oper**: Operation code (`D`=Delete, `W`=Write, `U`=Update)

### Local Data Area (LDA)

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Accesses User Data Structure slots for current user, firm, etc.

### Key Variables

```rpg
d fmkal1_kund     s                   like(fmkund)
...
d rukrl1_ktsq     s                   like(ruktsq)
```
- Variables to store key fields for file access; use types from external file descriptions.

### Working Variables

```rpg
d w_firm          s                   like(fmfirm)
```
- Holds firm number for use in key lists.

---

## 4. **Mainline Logic**

### Operation Switch

```rpg
c                   if        p_oper = 'D'
c                   exsr      slett_kort
c                   goto      avslutt
c                   endif
```
- If operation is Delete (`D`), call the `slett_kort` subroutine and end program.

### Lookup for Existing Record

```rpg
c                   eval      rukrl1_kund = p_okun
c                   eval      rukrl1_kpro = p_opro
c                   eval      rukrl1_ktyp = p_otyp
c                   eval      rukrl1_ktsq = p_otsq
c     rukrl1_key    chain     rukrl1
```
- Prepare the lookup key for `rukrl1` based on parameters.
- `chain` reads record by key.

### Handling Found Record

```rpg
c                   if        %found
c                   if        p_oper = 'W'
c                   exsr      skriv_kort
c                   endif
c                   if        p_oper = 'U'
c                   exsr      oppd_kort
c                   endif
c                   endif
```
- If record is found:
  - If operation is Write (`W`), call `skriv_kort` subroutine.
  - If operation is Update (`U`), call `oppd_kort` subroutine.

### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks end of program.
- Sets the *Last Record indicator, closes files, returns.

---

## 5. **Subroutines**

### 5.1. **skriv_kort (Write New Record)**

```rpg
c     skriv_kort    begsr
...
c     fmkal1_key    chain     fmkal1
c                   if        %found
c                   leavesr
c                   endif
...
c                   write     fmkalur
c                   endsr
```
- Sets up key and checks if record exists in `fmkal1`.
- If exists, leaves subroutine (prevents duplicate creation).
- Otherwise, prepares the new record:
  - Sets key and data fields from parameters and LDA.
  - Card number assignment: If `rukknr` fits in 16 digits, uses it; otherwise assigns 9999999999999999 (see revision 7.01).
  - Writes new record to `fmkalur`.

### 5.2. **oppd_kort (Update Record)**

```rpg
c     oppd_kort     begsr
...
c     fmkalu_key    chain     fmkalu
c                   if        not %found
c                   leavesr
c                   endif
...
c                   update    fmkalur
c                   endsr
```
- Sets up key, attempts to find record in `fmkalu`.
- If not found, exits subroutine.
- If found, updates fields and writes changes with `update fmkalur`.

### 5.3. **slett_kort (Delete Record)**

```rpg
c     slett_kort    begsr
...
c     fmkalu_key    chain     fmkalu
c                   if        %found
c                   delete    fmkalur
c                   endif
c                   endsr
```
- Sets up key, tries to find the record.
- If found, deletes it from `fmkalur`.

### 5.4. **Initialization Subroutine (\*inzsr)**

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_ofir
...
c                   parm                    p_oper
...
c     fmkal1_key    klist
c                   kfld                    w_firm
...
c     rukrl1_key    klist
...
c                   eval      w_firm = p_ofir
c                   endsr
```
- Handles program initialization and parameter assignment.
- Builds key lists for record operations using firm and parameter variables.

---

## 6. **Key Lists**

- **fmkal1_key**: Used for lookup in `fmkal1`.
- **fmkalu_key**: Used for update/delete in `fmkalu`.
- **rukrl1_key**: Used for lookup in `rukrl1`.

Each key list is constructed using firm, customer, product, type, and sequence.

---

## 7. **Special Notes**

- The code is parameter-driven, designed to be called from elsewhere with the operation code indicating what to do.
- Revision 7.01 includes logic to handle long card numbers by assigning a default value if too long.
- Variable and comment names are in Norwegian, reflecting the business context.

---

## 8. **Summary Table of File Use**

| File      | Purpose           | Ops             | Alias      |
|-----------|-------------------|-----------------|------------|
| fmkal1    | Read (check exist)| chain           | fmkal1r    |
| fmkalu    | Update/Delete     | chain/update/delete | fmkalur    |
| rukrl1    | Read (source data for write/update) | chain  | rukrl1r    |

---

## 9. **Main Flow**

1. **Initialize**: Pick up passed parameters and LDA.
2. **Delete?** If so, delete record and end.
3. **Lookup** related record in `rukrl1`.
   - If not found, do nothing.
   - If found & operation is Write: attempt to create.
   - If found & operation is Update: attempt to update.
4. **End**: Close out program and return.

---

**In summary:**  
This program performs parameter-driven maintenance (write, update, delete) of card/invoice agreement records, with all file access strictly by composite keys. It includes business rule logic to prevent duplicate creation, handle validation of card number lengths, and ensure data integrity through controlled subroutines.