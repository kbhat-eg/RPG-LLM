# Program RF501R – Overview and Documentation

## Purpose and Business Context

**RF501R** is a core module in the NEXSTEP system, providing a display and management interface for transaction log lines ("regnskapstransaksjoner – linjer"). It is designed for accounting users who need to review, update, or delete individual transaction lines within a batch (bunke) or by voucher (bilag). The program uses subfiles for efficient paging and interaction, and enforces business rules for user access, data integrity, and domain-specific validations.

## Main Features

- **Display of accounting transaction log lines** with paging (subfile).
- **View, update, and delete** individual transaction lines, with access control.
- **Business rule enforcement**: Only authorized users can update/delete; can't modify journaled vouchers; checks for inconsistent due dates.
- **Integration with SQL tables**: Reads and updates `rlodst` (transaction log lines), `fusrpf` (user permissions), and `rlobst` (voucher status).
- **Localized for Norwegian accounting standards** (date formats, language, etc).

---

## High-Level Structure

- **File Declarations**:
  - `rlodi1`/`rlodir`: Transaction log line files (input, keyed, renamed for dual use).
  - `rf502d`: Display file with subfile support.
- **Data Structures**:
  - LDA (Local Data Area): Company, user, etc.
  - Display feedback DS: Cursor position, etc.
- **Variables**:
  - Key fields, working variables for subfile management, business logic.
- **Constants**:
  - Subfile page size, etc.
- **SQL Initialization**:
  - Sets language, date, and collation options for embedded SQL.

---

## Program Flow

### Initialization (`*inzsr`)

- Receives timestamp (`w_dts1`) and voucher number (`w_bila`) as parameters.
- Loads company from LDA.
- Sets up key lists for accessing transaction log lines.
- Reads the first line for display heading.
- Checks user access rights (`sjk_user`).
- Positions to the start of the log and populates the subfile for display.

### Main Loop

- Displays command screen (`b2cmd`).
- Enters main subfile processing loop:
  - Reads display info from `rlodir`.
  - Converts timestamp for display.
  - Calls `dsp_subfile` to show the subfile page.
  - Handles function keys (roll up/down, refresh, etc).
  - Calls `subfile` subroutine to process user actions on subfile lines (view, update, delete).

### Subfile Management

- **`clr_subfile`**: Clears subfile and resets counters.
- **`crt_subfile`**: Reads log lines and fills subfile page.
- **`bck_subfile`**: Moves back one page in the subfile.
- **`dsp_subfile`**: Displays the current subfile page, handles cursor positioning.

### Line Processing

- **View (`xb3win`)**: Shows line details, allows update if authorized and not journaled.
- **Delete (`xb4win`)**: Shows line details, allows delete if authorized and not journaled.
- **Update (`oppd_lin`)**: Updates the line in the database, with period and date fields.
- **Delete (`slet_lin`)**: Deletes the line from the database.

### Business Rule Enforcement

- **User Authorization (`sjk_user`)**: Checks if user has sufficient access code (`fbko11` from `fusrpf`).
- **Journaled Voucher Check (`sjk_bilag`)**: Prevents update/delete if voucher is journaled (`rlobst`).
- **Due Date Consistency (`sjk_ffdato`)**: Ensures all lines in a voucher/batch have the same due date.

---

## Key Business/Domain Logic

- **Access Control**: Only users with `fbko11 = 2` can update/delete transaction lines. Enforced in both view and delete routines.
- **Journaled Voucher Protection**: If a voucher has both debit and credit amounts posted and no error code, it is considered journaled and cannot be changed or deleted.
- **Due Date Consistency**: When updating lines, checks that all lines for a voucher/batch have the same due date. If not, update is blocked (`b_ffeil` flag).
- **Paging**: Subfile size is fixed (18 lines per page). Handles roll up/down, cursor positioning, and page boundaries.
- **SQL Integration**: All updates and deletes are performed via embedded SQL, with explicit commit control for transactional integrity.

---

## Design Decisions & Conventions

- **Subfile Paging**: Fixed-size subfiles for predictable UI and performance.
- **Key Lists**: Used for both direct access (`chain`) and positioning (`setll`/`read`).
- **Feedback Data Structures**: Used for cursor management and display logic.
- **Indicator Usage**: Follows a strict convention for function keys, UI state, and business logic separation (see comments in code).
- **Error Handling**: Uses flags and message screens for user feedback on business rule violations (e.g., unauthorized, journaled, inconsistent data).
- **Versioning and Change Log**: Inline comments document business requirement changes by version and date.

---

## Integration Points

- **Database Tables**:
  - `rlodst`: Main transaction log lines (view, update, delete).
  - `fusrpf`: User permissions (for access control).
  - `rlobst`: Voucher status (to determine if voucher is journaled).
- **Display File (`rf502d`)**:
  - Contains subfile (`b1sfl`) and various screens for detail, messages, and command entry.
- **Local Data Area (LDA)**:
  - Supplies initial context: company, user, etc.

---

## Notable Subroutines

### `sjk_user`
Checks if the current user (`l_user`) has update/delete rights in the current company (`w_firm`). Sets `w_ovfok` (must be 2 for authorization).

### `sjk_bilag`
Checks if the voucher is journaled by summing debit/credit and checking for error codes. Sets `b_biln` flag if journaled.

### `sjk_ffdato`
Ensures all lines for a voucher or batch have the same due date. Sets `b_ffeil` if an inconsistency is found.

### `oppd_lin`
Updates a transaction log line with new data, including period, dates, and various accounting fields. Uses embedded SQL and sets `b_linopd` to trigger consistency checks.

### `slet_lin`
Deletes a transaction log line using embedded SQL.

---

## User Interaction Flow

1. **Entry**: User enters via timestamp/voucher.
2. **Display**: Sees a paged list of transaction lines.
3. **Actions**:
   - View details of a line.
   - Update line (if authorized and not journaled).
   - Delete line (if authorized and not journaled).
   - Page up/down through the list.
4. **Business Rule Feedback**: If an action is not allowed, user receives a message and must acknowledge before proceeding.

---

## Version/Change Highlights

- **8.01**: Changed access code requirement for update/delete.
- **8.02**: Added ability to update period in log file.
- **8.03**: Fixed sporadic subfile error.
- **8.04**: Added control for inconsistent due dates across lines.

---

## Summary

RF501R is a robust, business-rule-driven module for managing accounting transaction log lines in NEXSTEP. It balances user flexibility with strict enforcement of accounting controls and data integrity. The code is structured for maintainability, with clear separation of UI, business logic, and data access, and is well-documented for ongoing evolution. 

**For new developers:**  
Familiarize yourself with the subfile handling conventions, indicator usage, and the embedded SQL patterns, as these are foundational to both this program and other modules in the NEXSTEP system. Pay special attention to the business rules around user access and journaled vouchers, as these are critical for compliance and data integrity.