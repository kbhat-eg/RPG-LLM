# Program Documentation: SP123R – Utvalg Distrikt

## Overview

**Program:** SP123R  
**System:** ASSTAT  
**Description:**  
The program provides maintenance and selection of “Distrikt” (district) entries via a subfile-based display. It is designed for interactive use (WORKSTN), supporting add, update, delete, and validation operations for district records. The code is tailored for DDS-based GUIs and interacts with several files that manage district master data and related reference information.

---

## Main Files and Data Structures

### Display and Subfile
- **sp123d**: Display file, using subfile `b1sfl` with relative record number `w_srrn`.
- **b1sfl**: Subfile for listing and maintaining districts.
- **b2ctl/b2cmd**: Subfile control and command screens.

### Database Files
- **skpml1**: Main list file for districts (read).
- **skpmlr**: Reference file for districts (read).
- **skpmlu**: Update file for districts (update/write/delete).
- **ra08pf**: Reference file for additional info/validation.

### Local Data Area
- Used to retrieve firm number and user details at program initialization.

---

## Key Variables and Conventions

- **w_firm**: Current firm number, sourced from LDA.
- **wptype/wpkode**: Type and code for the selection, passed as parameters.
- **wptext/wprtxt**: Text description for the selection.
- **w_srrn/w_ssrn/w_sfrn/w_spge**: Subfile record and page management.
- **b_forn, b_anul, b_feil**: Flags for refresh, cancel, and error states.
- **b2valg, b2hkod**: Control field values for subfile actions and key input.
- **c_sfil**: Constant for subfile pagination (12 records per page).

**Conventions:**
- All file keys are built using a combination of firm, type, code, and value.
- All add/update/delete logic is centralized in subroutines for maintainability.
- Function key indicators (`*inxx`) are used for navigation and action control.

---

## Program Flow

### Initialization (`*inzsr`)
- Builds file keys for all relevant files.
- Retrieves firm number and user info from LDA.
- Initializes subfile by positioning and loading the first page.

### Main Loop (Display and Action Handling)
- **b2taga**: Write command screen.
- **b2tagb**: Display subfile (calls `dsp_subfile`).
- Handles function keys for exit, refresh, add, and page navigation.
- Processes subfile control actions (add/delete) and subfile row actions.

### Subfile Operations

#### Refresh (`forny`)
- Repositions to the start of the district list.
- Clears and reloads the subfile.

#### Positioning (`posisjoner`)
- Positions the subfile based on a provided key value (`b2hkod`).
- Clears and refills the subfile starting from the positioned record.

#### Control Handling (`control`)
- Handles add (`b2valg = '1'`) and delete (`b2valg = '4'`) actions from subfile control.
- Performs key validation and sets error indicators as needed.
- Triggers refresh as appropriate.

#### Subfile Row Processing (`subfile`)
- Iterates through subfile rows, processing row-level delete actions.
- Calls delete routine (`xd1win`) for marked rows.
- Triggers subfile refresh if any modification occurred.

---

## Record Maintenance Routines

### Add/Edit/View Record (`xc1bld` / `xc2bld`)
- **xc1bld**: Handles display and entry of new district record.
  - Handles function keys for lookup (calls `RA508R` for code lookup).
  - If record exists, displays message and prevents duplicate creation.
  - If new, proceeds to entry/edit screen (`xc2bld`).
- **xc2bld**: Handles add/update of district record.
  - If record exists, updates; otherwise, writes new record.
  - Updates subfile as needed.

### Delete Record (`xd1win`)
- Displays confirmation screen for delete action.
- If confirmed, deletes the selected record from the update file.

### Subfile Management
- **clr_subfile**: Clears the subfile and resets management variables.
- **crt_subfile**: Loads up to 12 district records into the subfile, with pagination.
- **dsp_subfile**: Presents the subfile to the user, handling empty subfile cases.

---

## Error and Message Handling

- Error indicators are set for missing or invalid keys (`*in31`, `*in32`).
- Duplicate add attempts trigger an informational message screen (`xc1msg`).
- All error and confirmation messages are handled via dedicated DDS display formats.

---

## Integration and Dependencies

- **RA508R**: Called for district code lookup during add/edit.
- **LDA**: Used for firm and user context.
- **Parameter Passing**: Receives selection type and text from the calling program.
- **Data Model**: Assumes all district records are uniquely identified by firm, type, code, and value.

---

## Notable Design Decisions

- **Subfile Paging**: Uses a fixed page size (12) for manageable display and performance.
- **Centralized Key Management**: All file operations use consistently built keys, aiding maintainability.
- **DDS-Driven UI**: The program relies heavily on DDS for all user interactions, suited to traditional IBM i GUI paradigms.
- **Flag-Based Control Flow**: Uses flag variables and indicators to manage state between subroutines and user actions.
- **Separation of Concerns**: Distinct subroutines for control, subfile, add/edit, delete, and messaging enhance readability and ease of modification.

---

## Business/Domain Logic

- The program is designed for maintaining a list of districts (or similar entities), supporting multi-firm environments.
- All actions are validated against master/reference files to prevent duplicates and ensure referential integrity.
- The user interface is optimized for keyboard-driven navigation, typical for green screen or DDS-based GUIs.
- Only authorized users (based on LDA context) can perform add/delete operations.

---

## Summary

SP123R is a robust, interactive district maintenance program, built with modularity and data integrity in mind. It leverages subfiles for user-friendly maintenance of district records, with clear separation between control, data, and UI logic. The codebase follows established IBM i conventions, making it straightforward for experienced RPG developers to extend or integrate with other modules in the ASSTAT system.