# RPG Program JR785R - Explanation

## High-Level Purpose

This program processes an input file with record format SKYDDA to update/create items (varer) and their prices in the LVR system.  
- **New items** are created as standalone items in LVR, not under a price-giving supplier.  
- **Price updating** is matched on the supplier's item number.  
- The program is designed to import via a template spreadsheet (mal-regneark).

## File Definitions

The `F` specifications at the start define a set of files, mostly master and lookup for items, prices, packaging, groups, etc. Most files are keyed and externally described, many with renamed record formats for clarity and to avoid field name conflicts.

Example:
- `fjrvapf` - Input file, likely from spreadsheet
- `fjvarl8`, `fjvarlu`, etc. - Item master tables
- `fjstslu` - Status register (for item numbers)
- `ffenkl1` - Unit conversion table

## Data Structures

The program uses data structures for:
- **Parameters**: `p_list` and `d_list`, parsed into fields like firm, report code, and date.
- **Record overlays**: Used to map incoming records to meaningful fields (`d_vare`, `d_tek1`, etc.) via overlays on a 512-byte input buffer.

## Constants

Constants are defined for lowercase/uppercase translation and digits.

## Main Program Flow

1. **Parameter/Initialization**: The *INZSR subroutine initializes by reading input parameters, sets up key lists for all logical file accesses.
2. **Get Reporter Info**: Looks up the report/informant in `jrapl1` using keys. If not found, the program exits (`goto avslutt`).
3. **Main Loop**: For each record in the input file:
    - Calls subroutine `oppdater` to update/create item and price.
    - Reads next record until EOF.
4. **Exit**: Control set to *INLR = *ON and returns cleanly.

---

### Subroutine: oppdater (Main Processing)

#### 1. **Input Record Handling**
- Parses the input line into fields.
- Skips blank records or records where item number is not numeric.

#### 2. **Data Normalization**
- Converts spaces to zeros for numeric fields.
- Trims strings and translates special/non-ASCII codes in item text and unit fields to standard characters.
- Converts input data for internal processing (names, units, etc.).

#### 3. **Unit Conversion**
- Looks up unit code in the conversion table; if found, replaces the code.

#### 4. **Item Processing**
- **Check if Item Exists** (by supplier and item number):
  - If found: `endr_vare` subroutine is called to process existing item.
  - If not: `ny_vare` subroutine is invoked to create a new item.
- Loads or assigns values for update/write, splits description, sets tracking fields, etc.
- Looks up item group using the reporter's group reference table.

#### 5. **Write/Update Records**
- Updates or writes the item record.
- If it's a new item, also creates an entry in the item detail register.

#### 6. **Packaging & Pricing**
- Calls `oppd_forpakn` to handle packaging (units, packs, etc.).
- Calls `oppd_pris` to add a price entry.

#### 7. **Search Texts (SÃ¸ketekster)**
- Calls an external program `JV790R` to update the search texts (item synonyms, keywords).

---

### Subroutine: endr_vare (Change Existing Item)

- **Preserves item status**: If status is 0, 1, or 4, sets it to 1. Otherwise keeps as is.
- **Packaging Cleanup**: Deletes packaging and price records for the item that are not manually registered.
- **JVLEPF Deletion (if version >= 6.31)**: Cleans up additional item-supplier records.

---

### Subroutine: ny_vare (Create New Item)

- Sets item status to 2 (new).
- Fetches the next available item number from the status register and increments it atomically.
- Initializes group fields to 0.
- Sets creation dates.

---

### Subroutine: oppd_forpakn (Packaging Creation)

- Creates base packaging for the item.
- Handles special logic for unit-2 packaging based on content (w_innh), count per package (w_antp), etc.
- Always writes a base package, with possible additional packages if the input justifies it (e.g., content/unit conversions).

---

### Subroutine: oppd_pris (Price Creation)

- Creates new price records for the item.
- Handles base price fields, sets various control and timestamp fields.
- (Version 6.31) Also creates an entry in the supplier-item relationship file.

---

### Subroutine: *inzsr (Initialization)

- Parses parameters and sets up all the key lists used for indexed access during the process.

---

## Key Lists

Key lists are used for:
- File access for reading/updating specific items, packages, prices, units, etc.
- Split out for each logical access pattern.

---

## Business Rules & Logic

- New items are always created with a unique number, not under a price-giving supplier.
- If an item already exists, old packaging and price records (not manually entered) are deleted and replaced.
- Multiple translations and normalizations are performed to account for national/international character sets and spreadsheet quirks.
- Group mappings and price records are created/updated based on the import file and lookups.

---

## Notable Features

- Heavy use of overlays in data structures for memory-efficient parsing of fixed-width input files.
- Character and code translation logic is robust for handling ASCII/EBCDIC/Unicode input mismatch.
- Keyed access and update patterns ensure data consistency throughout the process.
- External program call for search text management allows for logical separation and reusability.
- Good use of comments and version/documentation headers for maintainability.

---

## Summary Diagram

```text
Input File (SKYDDA)
      |
      v
+-------------------+
|   Main Loop       | <--------------+
| For each record:  |                |
|                   |                |
|  -> oppdater      |                |
+-------------------+                |
      |                               |
      v                               |
    Parse line                        |
      |                               |
      v                               |
  Check/normalize fields              |
      |                               |
      +---------------------------+   |
      | Item exists?              |   |
      +-----------+---------------+   |
                  |                   |
              Yes |                   | No
                  v                   v
          endr_vare subr.         ny_vare subr.
    (Clean old pkg, price)    (Get new item#)
                  \              /
                   \            /
                    +----------+
                    | Assign/update data fields
                    +----------+
                        |
                +-------+-------+
                |               |
          oppd_forpakn      oppd_pris
        (Packaging recs) (Price recs, supplier records)
                |
                v
        Call JV790R (update search texts)
```

---

## Onboarding Advice

- Review the structure of the records in all referenced files, especially field layout and key logic.
- Understand the external program JV790R for search text handling.
- Pay attention to translations (xlate) and data normalization, especially if changing input source or expanding international usage.
- When modifying logic, keep in mind the strict sequencing of create/update/delete operations for consistency.
- Carefully review any changes to item number assignment (status register) and cross-application impacts.

---

**This code is a strong example of batch data integration and master/transaction record handling in RPG, designed for robust file-based ETL.**