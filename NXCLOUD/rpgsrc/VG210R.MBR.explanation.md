# ILE RPG Program VG210R - Explanation

This program is written in ILE RPG and is developed for IBM i (AS/400) systems. The code manages "Fakturatyper" (invoice types) and provides a subfile-based user interface for maintenance functions such as create, update, display, delete, and copy of type records. This explanation is structured to help you understand the program's overall flow, file usage, key concepts, and subroutines.

---

## 1. Program Overview

- **Purpose**: To maintain a file of invoice types via an interactive subfile-driven screen.
- **Major Functions**:
  - List invoice types in a subfile.
  - Create, update, copy, or delete invoice type records through various screen windows.
  - Validate accounts from the chart of accounts.
  - Position and page through the subfile.

---

## 2. File Declarations

```rpg
fvgktiu    uf a e           k disk    rename(vgktst:vgktiur)
fvgkti1    if   e           k disk    rename(vgktst:vgkti1r)
frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
fvg210d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- **vgktiu / vgkti1**: Files containing the main 'invoice type' data. Used for update and inquiry.
- **rhovl1**: Chart of accounts (kontoplan), used for account validation and display.
- **vg210d**: Workstation display file, containing the subfile (b1sfl) and various screens (windows).

---

## 3. Data Areas and Variables

### Local Data Area (LDA)
Values are retrieved from the LDA for the user, firm, and menu navigation:

```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```

### Key and Working Variables

- `vgktiu_ftyp`, `vgkti1_ftyp`: Current invoice type keys.
- `rhovl1_kont`, `rhovl1_spes`, `rhovl1_avde`: Chart of account (kontoplan) keys.
- Subfile navigation variables (`w_stel`, `w_spge`, `w_srrn`, etc.): Track subfile and page positions.
- Operation flags (`b_oppr`, `b_forn`, `b_fnul`): Indicate create/copy state, renewal needed, null flags, etc.
- `w_kont`, `w_spes`, `w_avde`, `w_tx30`: For retrieving and storing account information and texts.

### Constants

- `c_sfil` (2): Subfile page size increment.

---

## 4. Indicator Usage (As per Comments)

- LR: Last record — end program.
- *IN10, *IN11: Paging keys (rollup, rolldown).
- *IN12, *IN13: SFLDSP, SFLDSPCTL.
- *IN14, *IN15: SFLCLR, SFLEND.
- *IN21, *IN22: Home and cursor placement.
- *IN30: Protect fields on view.
- 31–79: Warnings, messages, screen indicators.
- 80–99: Work indicators.

---

## 5. Main Program Flow

The main logic is structured around a display subfile loop and a command window:

1. **Startup (`*inzsr`)**:
   - Initializes keys and reads values from LDA.
   - Positions to the correct spot in the file.
   - Fills the subfile for initial display.

2. **Main Display Loop**:
   - Uses tags (`b2taga`, `b2tagb`) to alternate between command window and subfile, depending on user action.
   - Handles function keys for:
     - Exiting (`*INKC`, `*INKL`)
     - Refresh (`*INKE`)
     - Create (`*INKF`)
     - Copy (`*INKG`)
     - Paging up/down (`*IN10`, `*IN11`)
     - Home position (`*IN21`)
   - Handles subfile positioning based on input to `b2ftyp`.
   - Calls subroutines for subfile maintenance and screen updates.

---

## 6. Subroutines

### Subfile Management

- `clr_subfile`: Clears subfile and resets counters.
- `crt_subfile`: Fills subfile with a page of invoice types from the database.
- `bck_subfile`: Moves to the previous page in the subfile.
- `dsp_subfile`: Displays the subfile or command screen as appropriate.
- `subfile`: Handles row-level actions (edit, copy, delete, view) as entered by the user in the subfile.

### Row Actions

- **Create (`xc1bld`)**: Opens the creation window for a new type. Validates if record already exists.
- **Message Display (`xc1msg`)**: Shows a message window when attempting to create a duplicate record.
- **Edit/Display (`xc2bld`)**: Allows viewing and editing of a record. Includes input validation, account lookups, and updates/writes the record.
- **Delete (`xd1win`)**: Opens delete confirmation window and, if confirmed, deletes the record.
- **Copy (`xk1win`)**: Opens copy window, checks for existing record with the same key, then calls edit window (`xc2bld`) for the new key.

### Support

- `hent_txt`: Fetches account names for display fields from the chart of accounts (both main and counter account).
- `forny`: Refreshes the current subfile page.
- `posisjoner`: Repositions to a specific record in the subfile view.
- `param`: Calls a parameter maintenance program for cost price factors.

---

## 7. Input Validation (in `xc2bld`)

During edit/create, the program validates:
- Calculation type must be filled.
- Both account fields must be complete or empty.
- Accounts must exist in the chart of accounts; if not, error indicators are returned and messages displayed.

---

## 8. Use of Subfiles

Key variables in subfile paging and navigation:
- `w_spge`: Current page size (subfile records per page).
- `w_srrn`, `w_sfrn`, `w_ssrn`: Relative, first, and last record numbers of subfile page.
- Paging is smooth, allowing scrolling and positioning.

---

## 9. External Program Calls

- `RH500R`: Called to choose/validate an account from the kontoplan (account plan).
- `VG205R`: Called from `param` subroutine for cost price factor maintenance.

---

## 10. Summary Table of Subfile Screens

| Screen   | Description                                     |
|----------|------------------------------------------------|
| B1SFL    | Subfile record (list of invoice types)         |
| B2CTL    | Control record for subfile (header, keys)      |
| B2CMD    | Dedicated command screen for function keys     |
| C1BLD    | Entry screen for creating new types            |
| C1MSG    | Message window for creation errors             |
| C2BLD    | Edit/display screen for updating/viewing types |
| D1WIN    | Delete confirmation window                     |
| K1WIN    | Copy window                                    |

---

## 11. Comments and Maintenance

- The code is well commented (in Norwegian), indicating indicator usage and variable purposes.
- Subroutines are logically separated and named with `begsr/endsr`.
- Tags and gotos are used for loop and state control (old-style RPG structure).
- File operations use CHAIN, READ, UPDATE, WRITE, and DELETE opcodes against keyed files.

---

## 12. Key Points for New Developers

- **Subfile handling**: Understand the flow of clearing, filling, and paging subfiles.
- **Screen control**: Switching between control/command screens and edit/view/copy/delete windows is done via subroutine tags and function key checks.
- **Validation**: Most data entry screens have layered validation with user feedback via indicators and message subroutines.
- **Account lookups**: Integration with the chart of accounts is heavily used for validation and display.
- **File keys**: All file access is keyed, often with a company (`w_firm`) plus a specific type or account number as key fields.
- **Indicators**: Heavily used for both logic and controlling what is displayed/enabled on the DSPF.

---

## 13. Suggestions for Modernization

- The code uses fixed format and GOTO tags. Consider refactoring to /free format and more structured logic when possible.
- Move heavy validation logic into separate modules or service programs if extending.
- More extensive use of named indicators and constants could improve readability.

---

## 14. Final Notes

- This is a "main-menu-driven" interactive maintenance program, very typical for IBM i business applications.
- All subfile handling, paging, and CRUD operations are handled tightly within the RPG logic and interactive display file.

If you are onboarding, focus on understanding the subfile mechanisms, the individual edit/copy/delete screens, and the structure of the underlying files (vgktiu, vgkti1, rhovl1) as that will make extending or debugging much easier.
