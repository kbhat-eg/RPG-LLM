# RPG Program VT120R: Detailed Explanation

---

## 1. **Context and Purpose**

This program, `VT120R`, is part of a larger application running on IBM i (AS/400), written in classic ILE RPG/400. The purpose of this program is to **maintain special offer prices** ("tilbudspriser"), with respect to a "customer club" and related groupings of products, price groups, suppliers, campaigns, and units. The system provides a highly parameterized interface for managing these prices, supporting multi-level groupings, supplier relations, and detailed time/date constraints.

**Key Features:**
- Subfile-based maintenance (work with lists/screens).
- Multi-keyed file handling for offers, product groups, suppliers, etc.
- Input validation and lookup for product, group, supplier, and price group details.
- Special routines for insert, update, copy, and delete of rows ("tilbudspriser").
- Complex key/positioning logic for efficient navigation (paging, positioning in subfile, rolling).
- Calculations for pricing including tax.

---

## 2. **File Definitions**

The program heavily utilizes externally described files (database physicals & display files):

- **Offer Prices (vklupfr)**: Multiple record formats, renamed per logical file (vklulr, vklulu, vklul1, vklul2, vklul3, vklul4, vklul5, vklul6, vklul8, vklul9). Each logical supports a specific access path (by product, by group, by supplier, etc).
- **Product, Supplier, Group Lookups** (`vvarl1`, `vltpl1`, `ra30l1`, `vvenl1`, `rlevl1`, etc): All are accessed read-only or for lookups.
- **Display File (`vt120d`)**: Contains subfiles and control records for interactive screen management.

---

## 3. **Data Structures and Key Variables**

### **3.1. Local Data Area (LDA) Fields**
- `l_user`, `l_firm`, `l_fnav`, `l_lagr`: Used to fetch user/firm context and settings.

### **3.2. Information Data Structure**
- `dspfbk`: Used to get cursor position and other display feedback.

### **3.3. Key Fields for Files**
- Variables with names like `vklulr_ogrp`, `vklulr_hgrp`, etc, are set up to hold the values for the key fields for the various logical file lookups.
- This enables the code to build keys dynamically for different access paths.

### **3.4. Working Variables for Subfile and Screen Management**
- `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`, `w_curn`, `w_virn`: Used to manage subfile pages, record numbers, cursor line, etc.

### **3.5. User Input Buffer Variables**
- Variables such as `b2vare`, `b2prgr`, `b2lety`, `b2fdat`, etc, represent fields on the subfile control screen (B2CTL).
- The `b1*` variables represent subfile rows.

### **3.6. Indicator Variables**
- `b_oppr`, `b_forn`, `b_anul`, `b_feil`, etc: Used to control program logic for insert, refresh, cancel, and error handling.

---

## 4. **Indicator Usage**

The program uses RPG indicators for both function key detection and control of screen attributes.

- `LR`: End of program
- `*IN10`, `*IN11`, etc: Special keys (Roll, Roll Down)
- `*IN30`, `*IN31`-`*IN79`: Error or status messages
- `*IN80`-`*IN99`: Work indicators (processing status, etc)

---

## 5. **Main Program Flow**

This program’s entry point is a **screen loop** handling subfile (list) display, navigation, and CRUD (Create, Read, Update, Delete) operations.

### **5.1. Main Loop (Tag: b2taga, b2tagb)**

- **Display Command Screen (`b2cmd`)**
- **Display Subfile (`dsp_subfile` subroutine)**
    - Shows list of current prices according to filter/positioning fields.

### **5.2. Function Key Handling**
- **Function key indicators (`select` statement):**
    - Launches other programs (e.g., `VT101R`, `VT102R`).
    - Calls search/lookup, refresh, add, roll, home, etc.
    - Each key usually causes a branch or calls a subroutine to process the intent.

### **5.3. Subfile and Positioning Logic**
- **Positioning**: If filter fields are changed, invokes `posisjoner` subroutine, which sets up key fields for the desired access path/logical file.
- **Paging**: Handles roll-up, roll-down, page up, page down, etc by manipulating subfile record pointers.

---

## 6. **Subfile Management**

### **6.1. Subroutines:**

- **clr_subfile**: Clears current subfile.
- **crt_subfile**: Fills subfile with rows matching current filter/positioning keys.
- **bck_subfile**: Handles "back a page" logic.
- **dsp_subfile**: Reads and displays subfile, processes row-level commands (edit, copy, delete, view).

### **6.2. Processing Subfile Rows**

- For each subfile row (`do w_ssrn`):
    - Reads and processes selection indicator (`b1valg`):
        - `2` = Edit
        - `3` = Copy
        - `4` = Delete
        - `5` = View
    - Calls appropriate subroutine for each (e.g., `xc2bld` for edit/view).
    - For creation or update: validates input, checks for duplicate, and updates/writes file.

---

## 7. **Add/Edit/View/Delete Operations**

### **7.1. Edit/Add (`xc1bld`, `xc2bld`)**
- Prompts user for input (edit/add screens).
- Validates required fields (`sjekk_input`, `hent_info`).
- Handles duplicate, key collision, and other errors.
- Writes/updates the offer price record.
- Displays appropriate messages if record already exists or input is invalid.

### **7.2. Copy (`xk1win`)**
- Loads fields from existing row (source row).
- Allows user to modify fields for the new row.
- Checks if new row exists; if not, creates it.

### **7.3. Delete (`xd1win`)**
- Gets confirmation and then deletes the record from the database.

---

## 8. **Field Level Help/Lookup (Spørring)**

- If user presses a help/query key on a specific field (`w_afld`), the program calls the relevant lookup program (`VG510R`, `VV500R`, etc.) and displays description or possible values.

---

## 9. **Input Validation and Lookup (`sjekk_input`, `hent_info`)**

- Performs relational validation (e.g., a product number cannot be supplied together with a product group or supplier; required fields must be present).
- Looks up group/supplier/product/price group/ delivery type to verify existence and fetch display descriptions.
- Validates date and time fields (start/end), and ensures correct sequence.

---

## 10. **Price Calculation and VAT Logic**

- Includes logic (see `auto_beregn` and `xc2bld`) to automatically calculate offer prices including VAT, based on percentage rates, and ensures price integrity across units.
- When editing, updating, or copying, the program can auto-calculate prices for other units based on the provided conversion rates and input values.

---

## 11. **Subroutines for Specialized Tasks**

- **auto_beregn**: Calculates derived prices for units 2 and 3 based on input for unit 1 (or vice versa).
- **hent_info**: Fetches and populates display fields with descriptions (for product, group, supplier, etc.).
- **spørring**: Handles on-screen queries for code help or description lookup.

---

## 12. **Initialization (`*inzsr`)**

- Sets up all keyed lists (klist) for file access.
- Loads firm/user context from LDA.
- Fetches VAT rates via external program.
- Fills subfile with initial values.

---

## 13. **General Code Organization**

- The code uses a **tagged goto structure** for main control flow, which is common in classic RPG.
- Uses subroutines (`begsr`/`endsr`) for modular handling of distinct actions (display, validation, calculation).
- Makes extensive use of indicators for error/status management and screen field protect/unprotect.

---

## 14. **Screen and Subfile Layouts (Referenced by Comments)**

- Screens: B1SFL (subfile), B2CTL (control), C1BLD/C2BLD (edit/add/view), D1WIN (delete), K1WIN (copy), etc.
- Each screen and subfile record maps to a set of buffer variables (b1*, b2*, c1*, c2*, etc.) used in logic.

---

# **Summary Table**

| Section    | Functionality Summary |
|------------|----------------------|
| File defs  | Maps to logical views of offer price data, products, groups, etc. |
| Data area  | Fetches firm/user context. |
| Subfile    | Handles display, paging, selection, and action on offers. |
| Key mgmt   | Dynamic key setting for various lookups/positionings. |
| Indicators | Error/status management, screen interactivity. |
| Main loop  | Processes function keys, branching/dispatching per request. |
| Validation | Ensures correct combinations of group, product, supplier. |
| Lookups    | Fetches descriptions and validates codes for all entities. |
| Price calc | VAT-inclusive and unit-multiplicative price determination. |
| CRUD ops   | Add/edit/view/copy/delete an offer price. |
| Query      | Online lookup/help per field. |
| Init       | Prepares klist, screen, and main subfile data. |

---

# **Summary for Onboarding Developers**

- This program is a classic, indicator-driven RPG application for robustly maintaining price offers in a retail system.
- Its key strength is flexible, multi-key navigation with extensive validation, descriptive lookups, and intelligent subfile-based UI.
- Strategic use of subroutines, key lists, and field variables enables maintainability despite old-fashioned control flow.
- Understanding the various access paths and the user journey through screens/subfiles is essential; the vast majority of user interaction is controlled via the subfile, function keys, and modal input popups.
- For modifications, pay close attention to key list definitions, field buffer mapping, and indicator usage for both screen control and error handling.

---

If you have specific questions about a subroutine or a function key’s handling, please ask for a focused explanation!