# Explanation of the RPG Source Code

This RPG (Report Program Generator) source code is for a program named **RF951R**. The overall purpose of the program is to **remove (delete) a journal number for a specific year**, with considerations for linked transactions, especially handling customer postings and adjusting remaining balances where relevant.

Below, the code is explained section by section to help onboard a new developer.

---

## **Header Specifications**

```rpg
h option(*nodebugio) datedit(*dmy)
```

- `option(*nodebugio)`: Compiles the program with no debug I/O information.
- `datedit(*dmy)`: Specifies the date format as day/month/year.

---

## **Documentation/Comments**

These are extensive inline comments (in Norwegian) for revision history, purpose, etc. Key updates:
- Removal of file RPTRPF (no longer in use).
- Functionality for returning the rest amount on crossed transactions.

---

## **File Specifications**

The program works with multiple physical files, each representing a specific posting type (main ledger, customer, supplier, project).

```rpg
frhtrlu    upe  e           k disk    rename(rhtrpfr:rhtrlur)
frktrlu    use  e           k disk    rename(rktrpfr:rktrlur)
frltrlu    use  e           k disk    rename(rltrpfr:rltrlur)
frktrl8    uf   e           k disk    rename(rktrpfr:rktrl8r)
f                                     prefix(rx:2)
f**rptrlu    use  e           k disk    rename(rptrpfr:rptrlur)
```

- `rhtrlur`: Main ledger postings.
- `rktrlur`: Customer postings.
- `rltrlur`: Supplier postings.
- `rktrl8r`: Used for adjusting/restoring remaining balances for customer postings (added in version 6.31).
- `prefix(rx:2)`: All fields from `rktrl8r` are prefixed with `rx` to avoid naming conflicts.

---

## **Data Definitions**

Variables and fields are defined for storing intermediate and key data:

```rpg
d rktrl8_firm     s                   like(rnfirm)
d rktrl8_kund     s                   like(rnkund)
d rktrl8_biln     s                   like(rnbiln)
```
- These are used as keys to read records from `rktrl8r`.

Main variables to hold data for deletion criteria:
```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
The subfield notation (`300 305 0`, etc.) indicates offsets/sizes for fields (historically in fixed-format RPG).

---

## **Input Specifications**

Denote different files by a zone number for multi-format files:

```rpg
irhtrlur       01   // Main ledger postings
irktrlur       02   // Customer postings
irltrlur       03   // Supplier postings
i**rptrlur     04   // Project postings (commented out, no longer in use)
```

---

## **Main Logic**

### **Main Ledger Postings (01)**

```rpg
B001 c   01              if        l_firm = rbfirm and
B002 c                             rhpjof = rbjour and
B003 c                             rhpr�r = rbraar
 003 c                   delete    rhtrlur
E003 c                   endif
```
- Deletes a main ledger record if:
    - `l_firm` matches the record's firm
    - `rhpjof` (posting journal number) matches
    - `rhprår` (posting year) matches

---

### **Customer Postings (02)**

```rpg
B001 c   02              if        l_firm = rnfirm and
B002 c                             rhpjof = rnjour and
B003 c                             rhpr�r = rnraar
6.31 c                   if        rnbilk = 87
6.31 c                             and rnrefn <> 0
6.31 c                   exsr      SettRest
6.31 c                   endif
 003 c                   delete    rktrlur
E003 c                   endif
```
- Deletes a customer posting if `l_firm`, `rhpjof`, and `rhprår` match.
- **Version 6.31**: If `rnbilk = 87` (special code) and `rnrefn <> 0` (reference number present) then call subroutine `SettRest` **before** deleting, to restore any previously crossed remaining amounts.

---

### **Supplier Postings (03)**

```rpg
B001 c   03              if        l_firm = rofirm and
B002 c                             rhpjof = rojour and
B003 c                             rhpr�r = roraar
 003 c                   delete    rltrlur
E001 c                   endif
```
- Deletes a supplier posting matching firm, journal number, and year.

---

### **Project Postings (04)**

```rpg
6.30 c*  04              if        l_firm = rdfirm and
6.30 c*                            rhpjof = rdjour and
6.30 c*                            rhpr�r = rdraar
6.30 c*                  delete    rptrlur
6.30 c*                  endif
```
- **Commented out** and not active in code. Was previously used for project postings.

---

## **Subroutine: SettRest (Restore Remaining Balance)**

```rpg
6.31 c     SettRest      begsr
6.31 c                   eval      rktrl8_firm = rnfirm
6.31 c                   eval      rktrl8_kund = rnkund
6.31 c                   eval      rktrl8_biln = rnrefn
6.31 c     rktrl8_key    setll     rktrl8
6.31 c     rktrl8_key    reade     rktrl8
6.31 c                   dow       not %eof(rktrl8)
6.31 c                   if        rxkund = rnkund
6.31 c                             and rxbiln = rnrefn
6.31 c                             and rxrefn = rnbiln
6.31 c                   eval      rxrest = rxrest + rnbelø * -1
6.31 c                   eval      rxrefn = *zero
6.31 c                   update    rktrl8r
6.31 c                   leave
6.31 c                   endif
6.31 c     rktrl8_key    reade     rktrl8
6.31 c                   enddo
6.31 c                   endsr
```

- Used when a customer transaction that was offset/linked (crossed) needs its remaining balance restored because the crossing is undone.
- Sets up a key (`rktrl8_firm`, `rktrl8_kund`, `rktrl8_biln`).
- Reads matching records in `rktrl8r` file.
- For each matching record (where customer, posting no., and reference match):
    - Adjusts the rest amount by subtracting the amount of the now-cancelled transaction.
    - Clears the reference.
    - Updates the record.
    - Leaves the loop after updating the correct record.

---

## **Subroutine: Initialization (`*inzsr`)**

```rpg
c     *inzsr        begsr
6.31 c     rktrl8_key    klist
6.31 c                   kfld                    rktrl8_firm
6.31 c                   kfld                    rktrl8_kund
6.31 c                   kfld                    rktrl8_biln
c                   endsr
```

- Defines the key list for referencing customer posting records in `rktrl8r`.
- No other initialization logic is present.

---

## **Summary**

- **RF951R** is a utility program to delete postings (journal entries) for a selected year, by firm, journal number, and other keys.
- It covers main ledger, customer, and supplier postings, with projects commented out.
- For customer postings, special care is taken: if a posting that is part of a crossed reference is deleted, the rest amount is restored via the `SettRest` subroutine.
- The code is in traditional, fixed-format RPG; modern RPG would use free format, but the logic is clear and modular.

---

## **Further Reading for RPG Development**

For new RPG developers, you may want to learn:
- Data file handling and record-level operations in RPG IV
- Use of subroutines (`begsr`/`endsr`)
- Fixed-format RPG syntax and migration to free format
- Handling multi-format files and keys

This program is a good example of typical IBM i batch utility logic, with thorough handling of accounting records.