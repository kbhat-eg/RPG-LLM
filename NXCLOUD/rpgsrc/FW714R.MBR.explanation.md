# RPG Source Code Explanation

This RPG program (`FW714R`) is designed for the ASOFAK system, specifically for Sandvik, to create a supplier product register. Below is a breakdown of the code, its structure, and operational flow for easier onboarding and understanding.

---

## Purpose and Overview

- **Goal:** Generate/update a supplier product register by reading input items, formatting their details, fetching pricing information (if available), and outputting records for further processing.
- **Special Features:**
  - Sets unit to "STK" and price date to today's date.
  - Fetches sales prices when available in a related register (EVR).
  - Maintains audit and tracking information.

---

## File Definitions (F-Specs)

```rpg
fflvwpf    if   e           k disk
fvvarl5    if   e           k disk    rename(vvarpfr:vvarl5r)
fflvapf    o  a e             disk
```
- **flvwpf:** Input file (likely containing product information to be processed).
- **vvarl5:** Lookup file (supplier item register); renamed for clarity.
- **flvapf:** Output file (where the processed records are written).

---

## Data Structures and Variables

### Local Data Area

```rpg
d                uds
d l_user                911    920
```
- **l_user:** User ID from the User Data Space starting at position 911.

### Input Record Data Structure

```rpg
d                 ds
d d_inpu                       124
d  d_side                        5    overlay(d_inpu:1)     // Page
d  d_vare                       24    overlay(d_inpu:6)     // Product number
d  d_tek1                       30    overlay(d_inpu:30)    // Product text
d  d_eann                       13    overlay(d_inpu:60)    // EAN number
d  d_brpr                        9    overlay(d_inpu:73)    // Wholesale price
d  d_vgrp                        3    overlay(d_inpu:82)    // Product group
d  d_vekt                        8    overlay(d_inpu:85)    // Weight
d  d_anta                        6    overlay(d_inpu:93)    // Quantity per package
d   d_bmen                       6  0 overlay(d_anta:1)
d  d_inpr                        9    overlay(d_inpu:99)    // Purchase price
d   d_inpr_kr                    6  0 overlay(d_inpr:1)
d   d_inpr_øre                   2  2 overlay(d_inpr:8)
d  d_best                        7    overlay(d_inpu:108)   // Order number
d  d_rab1                        5    overlay(d_inpu:115)   // Discount 1
d  d_rab2                        5    overlay(d_inpu:120)   // Discount 2
```
Structurally, data is read as a 124-byte string and parsed by overlaying relevant fields.

### Other Variables

- **p_firm, p_ldor:** Parameters for firm and supplier—passed to the program.
- **vvarl5_lvar:** Used when looking up supplier item number.
- **w_lety, w_inlr:** Work variables (single character/flag).
- **w_udat:** Date variable (ISO format); today’s date.
- **w_firm, w_ldor, w_bupr, w_kopr, w_inpr:** Work variables for firm, supplier, and prices.
- **w_prgr:** Price group (2 characters as of version 8.01).

---

## Main Program Logic

### Initialization

```rpg
c                   time                    w_udat
```
- Fetches and stores today’s date.

### Core Processing Loop

1. **Read input (`flvwpf`) and process until EOF:**
    - `read flvwpf 90`
    - Loop: `dow *in90 = *off`

2. **Input mapping:**
    - `eval d_inpu = fwirad`  
      (Assumes `fwirad` is the buffer from the input file.)

3. **Data cleansing:**
    - Replaces spaces with zeroes in numeric fields: `xlate ' ':'0' d_anta d_anta` etc.

4. **Prepare output record fields:**
    - Assigns firm, supplier, and standardizes output fields such as text, unit ('STK'), dates, etc.
    - `fwlvar = %trim(d_vare)` trims spaces.
    - Quantity, price, and EAN are populated from the input record.

5. **Fetch Sales Price if Product is found in Supplier Register (`EVR`):**
    - If trimmed product is not blank:
        - Sets lookup key (`vvarl5_lvar = fwlvar`).
        - Does a keyed lookup (`chain`) in the supplier item file.
        - If found (*in91 = *off), calls program `'VP701R'` to fetch pricing and group info, passing/returning relevant parameters.

6. **Audit/Tracking Fields:**
    - Stores current timestamp and user in multiple fields for creation/update tracking.

7. **Write the record:**
    - `write flvapfr` writes processed record to the output file.

8. **Repeat:** Reads the next input and loops.

### End Routine

- Sets LR indicator (`*inlr = *on`) and returns—clean program close.

---

## Initialization Subroutine (`*inzsr`)

- Entry parameters are expected: `p_firm`, `p_ldor`.
- Key list for supplier item lookup is set up (`vvarl5_key`), consisting of firm, supplier, and item number.
- Calls a program (`VL711R`) to get/update the price group (`w_prgr`).
- Copies parameters to local work variables.

---

## Summary Table

| Section      | Functionality                                        |
|--------------|------------------------------------------------------|
| **File Specs**       | Declare input, lookup, and output files         |
| **Variables**        | Set up all fields, work areas, parameters      |
| **Main Loop**        | For each input record, parse and clean fields  |
| **Price Lookup**     | If product is found, fetch sales price         |
| **Audit Fields**     | Set creation/update date, time, user           |
| **Output**           | Write formatted output record                  |
| **End**              | Close program with proper LR handling          |
| **Initialization**   | Handle parameters, setup keys, call helpers    |

---

## Notes for Onboarding Developers

- **Input record parsing uses overlays**—critical to ensure the structure matches input file.
- **External Calls** to `'VP701R'` and `'VL711R'`—understand the interfaces and returned values.
- **Field Population:** Many output fields are zeroed or blanked for standardization.
- **Numeric Field Cleansing:** Spaces replaced with zeroes, might need updates if field formats change.
- **Audit Trail:** Strong focus on tracking changes, dates, and users.

---

**In summary,** this program reads product data, augments it with supplier pricing and audit info, and outputs to a supplier product register, with careful handling of field formats and data integrity.