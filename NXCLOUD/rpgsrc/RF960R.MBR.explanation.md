# RF960R – Postnummer Update Program

This program (RF960R) is part of the ASOKON system and updates postal code information in customer and supplier records. It displays a screen (via the “rf960d” display file) for interactive input and calls other modules when needed. It reads and updates data in three primary physical files:

• Customer register (RKUNLU)  
• Supplier register (RLEVLU)  
• Postal register (APOSPF)

Below is an overview of the program’s main responsibilities, structure, and notable design details.

---

## Purpose and High-Level Flow

1. The user is presented with a screen (A1BLD) to provide:  
   - A source (old) postal code: A1FPNR  
   - A target (new) postal code: A1TPNR  

2. The program then:  
   - Looks up the corresponding city/place for both postal codes (subroutine HENT_STED).  
   - Validates the entries and, if requested (by pressing the appropriate function key), calls subroutine OPPDAT to update:  
     - The customer file (RKUNLU) records whose postal code matches the old postal code.  
     - The supplier file (RLEVLU) records whose postal code matches the old postal code.  

3. Subroutines are used for:  
   - Prompting or searching for postal codes (SPR_RUT).  
   - Retrieving city/place names (HENT_STED).  
   - Processing user input and updating files (OPPDAT).  

4. The program then ends (XSLUTT) when the user signals termination.

---

## Data Sources and Interactions

- **RKUNLU / RLEVLU**  
  These files store customer and supplier master data. They have postal code fields (RKPONR / RLPONR) that are updated with the new postal code if a match is found.  

- **APOSPF**  
  This file holds postal codes and related city/place names. It is used to validate and retrieve text descriptions for each postal code.  

- **AF010R**  
  An external program (called via CALL) that can be used for more advanced postal code lookups. It returns the chosen postal code to this program, which then updates the displayed fields.

---

## Key Subroutines

### A1TAGA (Screen Interaction Loop)
This label/tag is the core loop that handles user input from the display file (EXFMT A1BLD). Depending on the function keys pressed:

- F3 or similar (INKC): Exit the program (go to XSLUTT).  
- F4 or similar (INKD): Call SPR_RUT to prompt for postal code.  
- F10 or similar (INKG): Call OPPDAT to update the files using the entered from/to postal codes.  

If no action is triggered, the code checks the from/to values, loads the city names via HENT_STED, and refreshes the screen.

### SPR_RUT (Prompting for Postal Codes)
This subroutine handles function key prompting for postal code lookups. It checks which field is being prompted (A1FPNR or A1TPNR), calls AF010R to fetch a postal code, then retrieves and displays the city name via HENT_STED.

### HENT_STED (Fetching City/Place for a Postal Code)
This subroutine chains into APOSPF (keyed by the postal code) to retrieve the city/place. If the postal code is not found, it returns “Ugyldig poststed” (invalid postal place).

### OPPDAT (Updating Customer and Supplier Registers)
1. Sets a record pointer in RKUNLU (customer).  
2. Reads each record (READE). If the record’s postal code matches the old code, it replaces it with the new postal code and updates the city/place text. Certain fields track who made the change, at what time, and from which program (RF960R).  
3. Repeats the same process in RLEVLU (supplier).  

Note that “V6.10” and “V6.11” references in comments reflect different tracking mechanisms for changes (e.g., earlier code used rkesig / rlesig, while the newer version references different date/time fields).

---

## Noteworthy Points

1. **Rename Clauses**  
   The RKUNLU and RLEVLU files are renamed internally (via RENAME) to a suffix “R” (e.g., RKUNPFR : RKUNLUR) for the UPDATE operations. This is a common convention in this codebase for distinguishing the base record format (RKUNPFR) from the record format name used when updating (RKUNLUR).

2. **Sporingsfelter (Tracking Fields)**  
   The references to “rkesig,” “rkesig,” “rk2dpt,” “rlepgm,” etc., indicate that version 6.10 introduced some form of significance/tracking fields. Then version 6.11 shows different fields (rk2dpt vs. rkedat, etc.). This suggests that the program handles or logs changes differently depending on the environment or version.

3. **Use of SetLL and READE**  
   The program sets a lower limit (SETLL) on the customer/supplier files, then reads sequentially (READE) based on the matching key. Checking *IN90 prevents reading beyond the file. This design ensures that all relevant records with the old postal code are updated properly.

4. **Calling External Program AF010R**  
   Instead of searching directly for a postal code, the user can invoke AF010R, which likely provides a more elaborate search or listing. After returning from AF010R, the postal code is reassigned locally, then validated via HENT_STED.

---

## Summary

RF960R is an interactive program to update old postal codes to new ones across customer and supplier registers. It allows the user to specify from/to postal codes, fetches city/place details from the APOSPF file, and performs a batch update of any matching records. The code also incorporates usage logging, indicated by the presence of tracking fields that store the user ID and timestamps for auditing purposes.