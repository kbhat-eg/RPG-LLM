# Program SH401R: Invoice Blocking (Faktura, spørring)

## 1. Overview
This ILE RPG program displays and navigates a subfile of invoice headers (`SIHEPF`), allowing the user to:
- Position on invoices by various keys (invoice number, order number, type, date, supplier or free‐text search).
- Call other programs to view the invoice, print copy, view archive, or display order header.
- Handle paging, refresh, and function keys on a 5250 display.

## 2. Metadata & Configuration
- **Title**: ASLAGR Faktura, spørring  
- **Program**: SH401R  
- **Options**: `*NODEBUGIO`, `DATEDIT(*DMY)`  
- **Free‐format SQL**: Date format ISO, delayed prepare, language Norwegian.

## 3. File Definitions
```rpg
FSIHELr  IF   E           K   Disk  Renamed to SIHELF header keyed file  
FSIHEL1  IF   E           K   Disk  ... position by invoice number  
FSIHEL3  IF   E           K   Disk  ... position by order number  
FSIHEL4  IF   E           K   Disk  ... position by order type  
FSIHEL5  IF   E           K   Disk  ... position by invoice date  
FSIHELA  IF   E           K   Disk  ... position by supplier alpha  
FSIHEL6  IF   E           K   Disk  (unused in main logic)  
FRLEVL1  IF   E           K   Disk  Supplier master lookup  
FSH401D  CF   E           WorkStn  Subfile data / control  
```

## 4. Parameters
- `p_firm` – Company code  
- `p_aarr` – Financial year  
- `p_otyp` – Filter: order/invoice type  
- `p_levr` – Filter: supplier number  

## 5. Key Data & Indicators
- **Indicators**  
  - `*INLR` = End‐of‐program  
  - `*IN10` = PF10 (page roll)  
  - `*IN14` = Clear subfile control  
  - `*IN15` = Subfile end  
  - `*IN16` = ReadC end  
  - `*IN21` = Home key  
  - `*IN22` = Cursor placement  
- **Cursor/Paging**  
  - `w_spge` = Subfile page size  
  - `w_sfrn` = First record on page  
  - `w_ssrn` = Last record on page  
  - `w_srrn` = Current relative record number  
  - `w_visrn` = Record to display when paging  

## 6. Main Loop (B2CTL)
1. **Write command line** (`B2CMD`).  
2. **Display** control record (`B2CTL`) + read PF keys.  
3. **Function key handling** (via `SELECT`):
   - PF3/PF12 = Exit  
   - PF5 (F5) = Refresh subfile (`CRTsfl`)  
   - PF10 (F10) = Roll page  
   - PF21 = Home (cursor at command line)  
   - PF21 (F21) = Free‐text search setup (7.02+)  
4. **Positioning**: if any position‐fields entered, call `POSISJONER` to rebuild subfile starting at key.  
5. **Populate subfile**: call `SUBFILE` subroutine.  
6. **Loop** back to display.

## 7. Subroutines

### 7.1 INZ (Entry, *INZSR)
- Initializes key lists for all file access (SIHEL1 … SIHELA, RLEVL1).  
- Loads program parameters into work vars (`w_firm`, `w_aarr`, etc.).  
- Sets `*IN22` on so that the display will show first page cursor at command area.  
- Positions on first invoice key (`SETLL SIHEL1`) and calls `CRT_SUBFILE`.

### 7.2 FORNY (Refresh)
- Determines the key‐sequence (`w_seqe`) set by last position or search.  
- Performs the appropriate `SETLL` on SIHEL1, SIHEL3, SIHEL4, SIHEL5 or SIHELA.  
- Clears subfile (`CLR_SUBFILE`) and rebuilds it (`CRT_SUBFILE`).

### 7.3 POSISJONER
- Checks each position‐field in turn:
  1. Invoice number (`b2BINR`)  
  2. Order number (`b2NUMM`)  
  3. Order type (`b2OTYP`)  
  4. Invoice date (`b2FKDA`)  
  5. Supplier alpha (`b2LEVA`)  
  6. Free search (`b2FSOK`, v7.02+)  
- Sets `w_seqe` to indicate which key is active.  
- Executes `SETLL` for that file key.  
- Calls `CLR_SUBFILE`/`CRT_SUBFILE` then clears the position inputs.

### 7.4 CLR_SUBFILE
- Writes the control record (`B2CTL`) with `*IN14=*ON` to blank out the subfile.  
- Resets the page counters: `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`, `*IN15=*OFF`.

### 7.5 CRT_SUBFILE
- Increments `w_spge` by page‐size constant (12).  
- Loops until `w_srrn = w_spge` (fill one page):
  - **v7.02+:** if free‐text search, prepare/execute SQL to fetch matching invoices from `SIHEPF` joined with `RLEVPF`.  
  - Otherwise use keyed file reads (`READ`, `READC`).  
  - Skip until matching company/year and optional filters (`p_otyp`, `p_levr`).  
  - For each valid record:
    - Retrieve last order sum for invoice (`READE SIHELR`).  
    - Populate subfile fields (`b1BINR`, `b1NUMM`, `b1OTYP`, `b1NAVN`, `b1LDOR`, `b1FSUM`).  
    - Write subfile record (`WRITE B1SFL`).  
- After loop, set up `w_sfrn`, `w_ssrn`, `wvisrn`.

### 7.6 SUBFILE
- Toggles `*IN22` to force cursor off the subfile area.  
- Loops `DO w_ssrn` reading subfile records with `READC B1SFL 16`.
- For each record:
  - If user presses F5‐“View”: calls program `SH410R` with invoice keys.  
  - F6‐“Print copy”: calls `LO681R`.  
  - F7‐“View order”: calls `SH415R`.  
  - F9‐“View archive” (5.60+): calls access‐check `AX700R`, then `AP622C` or `AH720C`.  
  - Clears `b1VALG`, updates subfile line (`UPDATE B1SFL`), continues.

### 7.7 DSP_SUBFILE
- Displays the control record + subfile: `EXFMT B2CTL`.  
- Manages indicators `*IN12`, `*IN13` for display logic.

## 8. Free‐Text Search (v7.02+)
- User can enter a string in `b2FSOK`.  
- Program calls subroutine to translate to SQL‐LIKE patterns (`%term%`).  
- Builds dynamic `WHERE` clause across multiple fields (name, supplier, invoice number, address, weekday name, detail lines).  
- Prepares and opens a single SQL cursor, then `FETCH` each matching row in `CRT_SUBFILE`.

## 9. External Calls
- SH410R – Detailed invoice display.  
- LO681R – Invoice copy print.  
- AX700R – Authorization for archive.  
- AP622C/AH720C – Archive viewer.  
- SH415R – Order header display.

## 10. Summary
- **Navigation**: PF keys, paging, refreshing.  
- **Positioning**: via keyed file starts or free‐text search.  
- **Display**: subfile control then records.  
- **Actions**: view, print, archive, order‐display calls.  
- **Enhancements**: v7.02 introduced SQL‐based free‐text filtering.