# RPGLE Program VV116R – Product Merging Utility

## Header & Program Metadata

- `h option(*nodebugio) datedit(*dmy)`:  
  - `*nodebugio`: Disables debug data for I/O operations (program optimized for production).
  - `datedit(*dmy)`: Date fields expect Day-Month-Year format.
- Comments describe the program’s purpose:
    - **System:** ASOFAK
    - **Program ID:** VV116R
    - **Functionality:** Deletes a product ("vare") and its relations; merges inventory balances; calls standard programs to swap product numbers in various tables.
    - **Modification Log:** Detailed historical changes, versioned and signed by developers, marking functionality expansion over time.

---

## File Declarations

All files are externally described (from DDS/PF), using the `rename` keyword to use specific record formats.

- **Primary tables:**  
    - `vvarlu` / `vvarlur`: Main product table.
    - `vvaslu` / `vvaslur`: Deleted products registry.
    - Multiple other files for product relationships (pricing, units, inventory, etc.), each suffixed appropriately (`lu`, `lur`, etc.) and sometimes aliased with `prefix` for fields.

- **Note on versioning:**  
  Some lines are version-tagged (e.g., `6.11`) to indicate at which version the code/file was introduced or altered.

---

## Data Definitions

- **Program Parameters:**  
    - `p_firm`: Firm/company number, type like `vvfirm`.
    - `p_gvar`: Old product number, type like `vvvare`.
    - `p_nvar`: New product number, type like `vvvare`.

- **LDA User Extraction:**  
    - `l_user`: User extracted from the *Local Data Area* (positions 911–920).

- **Key Work Variables:**  
    Used for table lookup and update keys:
    - `vvarlu_vare`, `anotlu_syst`, `anotlu_noid`, `vlaglu_vare`, `vlaglu_lage`, etc.

- **General Work Variables:**  
    - Control flags, e.g., `b_inlr` (set to *off*), and variable versions of parameters for working context, e.g., `w_firm`, `w_gvar`, `w_nvar`.

---

## Main Program Logic

### Initialization (`*inzsr` Subroutine)

1. **Parameter handling:** Values received via `*entry`:
    - `p_firm`, `p_gvar`, `p_nvar`
2. **Key list initialization:** Key fields are set up for various file access needs throughout the program.
3. **Work variables setup:** `w_firm` set from parameter; `w_gvar` and `w_nvar` set accordingly.

---

### Main Processing Steps

1. **Delete Old Product Record**
    - `chain` for old key in `vvarlur`. If not found, exit program.
    - If found, delete the record.

2. **Register Deleted Product**
    - `chain` for old key in `vvaslur`.  
    - If found, unlock the record. If not, populate audit fields (user & timestamps), then `write` a new record.

3. **Remove Old Product from Relationships**
    - For each related table (units, unit-price givers, suppliers, prices, search text, labels, inventory, offers, special price, discounts, notes, etc.):
        - Set LL and read using the old product number as key.
        - Loop: `dow not %eof`, delete all occurrences.
        - (Some relationships only deleted if the new product exists — to prevent accidental removal.)

    - **Special Cases:**
        - **Vare-enhet-prisgiver (`vveplu`):** If a GTIN (Global Trade Item Number) exists, subroutine `sjekk_vean` is called to possibly migrate it to the new product.
        - **Suppliers (`vvlelu`):** Loop and delete all linked suppliers for the old product.
        - **Notes (`anotlu`):** If the new product has a note, unlock it. Then, loop all old product notes and delete them.

4. **Inventory Merge (`vlagl1` and `vlaglu`):**
    - For all inventory records tied to the old product:
        - Try to find a matching record for the new product at each warehouse.
        - If found:
            - Sum up quantities and balances from old to new.
            - Some fields are only copied if the new-product value is zero.
            - Some fields (labels, types, etc.) are always overwritten.
            - Timestamps and user fields are updated for tracking.
            - Update the new product’s inventory.
            - Delete the old product’s inventory record.
        - Repeat for all warehouses.

5. **Call Standard Number-Replacement Programs**
    - `VV740R` and `FO740C` are called with parameters, which handle further number replacements in their respective domains (possibly updating more tables or modules).

6. **Exit**
    - `*inlr` set to `*on`, then program returns.

---

## Subroutines

### 1. `sjekk_vean`
- Checks if a GTIN from an old product’s unit/price record should be added to the new product in the GTIN file (`veanlu`).
- If the GTIN isn’t present for the new product, it writes a new record (with audit data); otherwise, it unlocks the record.

### 2. `*inzsr`
- See above: Handles program initialization, keys, and work variable setup.

---

## Key Lists (`klist`)

Reusable key sets for DB operations, named for clarity:
- `vvarlu_key`: For product updates.
- `key_gml`: Old product.
- `key_ny`: New product.
- `anotlu_key`: For notes (system, number id).
- `vlaglu_key`: For inventory (product/warehouse).
- `veanlu_key`: For GTIN file.

---

## General Observations

- **Robust Cleanup:** The program removes the old product’s footprint from a wide range of related tables.
- **Controlled Merging:** Inventory balances are merged intelligently; critical parameters are only overwritten when appropriate.
- **Auditability:** User and timestamp fields are diligently managed.
- **Extensibility:** Through version tagging and modular structure (subroutines, key lists), the program is maintainable and extendable.
- **Failsafes:** Only proceeds with deletes if the new product exists (prevents data loss).

---

## Summary

**VV116R** is a legacy RPG program for merging two products in a comprehensive, auditable manner. It removes the old product from all relevant tables, sums inventory balances, registers deletions, and coordinates further updates through system-standard routines, ensuring data integrity and traceability. The code is well-commented, historically annotated, and robustly engineered for complex product master data management in an IBM i ERP system.