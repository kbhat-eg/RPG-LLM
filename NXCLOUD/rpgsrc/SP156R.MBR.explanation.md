# RPG Program Explanation: SP156R "Utvalg Leverandør"

This RPG (ILE RPG, fixed-format) program is a maintenance utility focused on managing supplier ("leverandør") selection, using subfiles for interactive work on an IBM i (AS/400) workstation. Below is a structured walkthrough to help a developer understand its architecture, flow, and main logic.

---

## 1. **Program Overview**

- **Title**: "ASSTAT Utvalg Leverandør"
- **Program**: SP156R
- **Purpose**: Provides a screen interface for users to view, add, update, and delete supplier entries related to statistical groups, via subfiles. It's part of the "ASSTAT" system.
- **Data Files**:
  - `sp156d` (workstn, with subfile SFILE)
  - `skpml1`, `skpmlr`, `skpmlu` (keyed physical/logical files, supplier master and related)
  - `rlevl1` (keyed file, additional supplier master info)

- **Key Concepts**:
  - Uses *subfiles* for interactive lists.
  - Uses *subroutines* for major logic branches (e.g., create, update, delete, refresh, etc.).
  - Handles *function keys* for navigation and actions.
  - Gets *parameters* from the calling program and the LDA (Local Data Area).

---

## 2. **File Declarations**

- `sp156d`: Workstation file, using a subfile named `b1sfl` (with record relative number `w_srrn`).
- `skpml1`, `skpmlr`, `skpmlu`: Supplier details, likely representing different logical views: list, read, and update.
- `rlevl1`: Additional supplier info.

---

## 3. **Data Area and Variables**

- Key variables for file access (e.g., `skpml1_type/kode/valg`), using `LIKE()` from DB fields.
- Work variables for subfile state (e.g., counters, page numbers).
- Status flags (`b_forn`, `b_anul`, `b_feil`) for process flow and error handling.
- Constants (e.g., `c_sfil`, the subfile page size).
- Local Data Area is mapped to retrieve `user`, `firm`, and other info.

---

## 4. **Main Control Flow**

### **Initialization logic** (`*INZSR`)
- Defines *key lists* for database access.
- Receives parameters for type and description (`wptype`, `wptext`).
- Retrieves the firm number from the LDA (`w_firm = dsfirm`).
- Sets up initial values for all views (`skpml1_`, `skpmlu_`, `skpmlr_`).
- Positions to the start of the database (with `setll`) and builds the first subfile page (`exsr crt_subfile`).

---

### **Main Loop**
- **Write initial command screen** (`b2cmd`).
- Enter main input loop (`exsr dsp_subfile`), process user input and function keys via `select`.
- **Function keys and their effects**:
  - *F3/F12*: Exit (`goto avslutt`)
  - *F5*: Refresh (`exsr forny`)
  - *F6*: Create new entry (`exsr xc1bld`)
  - *F10*: Add page to subfile (`exsr crt_subfile`)
  - *F21*: Change to alternate screen

---

## 5. **Subroutines and Their Roles**

### **Subfile Management**
- **clr_subfile**: Clears subfile and resets counters.
- **crt_subfile**: Reads records from DB, fills subfile until the specified page size is reached.
- **dsp_subfile**: If subfile is not empty, enables subfile display, otherwise writes a blank command screen.

### **Entry Handling**
- **posisjoner**: Positions the subfile list to a specific supplier based on user input.
- **forny**: Refreshes the list after changes.
- **subfile**: Handles user updates/deletes on subfile rows via readc.

### **Command Bar / Action Subroutines**
- **control**: Processes main screen actions (create, delete, validation).
- **xc1bld**: Handles add/change of a supplier (calls `xc1msg` to confirm overwrites, then goes to registration via `xc2bld`).
- **xc1msg**: Shows a message if trying to add a supplier that already exists.
- **xc2bld**: Processes the registration/update screen for a supplier.
- **xd1win**: Handles the delete window, performs the actual record deletion.

---

### **Subfile Page/Row Process:**
- Adding a new supplier row invokes `xc1bld` -> (optionally) `xc1msg` -> `xc2bld`.
- Deleting a supplier row involves selecting option '4', calling `xd1win` for confirmation, and actually deleting the record if confirmed.
- All relevant fields are moved between screen work fields and physical file key/data fields for consistency.

---

### **Error and State Handling**
- Error flags (`b_feil`, `b_anul`) used to control further processing.
- Field indicators (e.g., `*IN31`, `*IN32`) triggered to display errors/warnings.

---

## 6. **Database Access Patterns**

- Uses `setll` and `read` for sequential access, and `chain` for keyed access.
- Key lists (`klist`) defined for all major files to facilitate keyed operations.
- All updates/deletes/writes are wrapped in subroutines with clear separation of concerns.

---

## 7. **Typical User Flow:**

1. User starts program (parameters for type and description passed in).
2. Program initializes, reads firm from LDA, fills subfile with suppliers for type.
3. User can:
    - Page through the list (F10, scrolling).
    - Select a supplier for update.
    - Add a new supplier (F6).
    - Delete a selected supplier.
    - Refresh (F5).
    - Exit (F3/F12).
4. Subfile and database synchronize with each action.

---

## 8. **Best Practices in This Code**

- **Modular subroutines** for all significant logic.
- **Indicator-based screen control** (active on IBM i).
- **Good use of key fields and LIKE()** for data consistency.
- **Clear error handling and user feedback**.
- **Separation of concerns** between UI logic and data update logic.

---

## 9. **Areas for Modernization**

- The code uses fixed-format RPG IV (ILE RPG), which can be modernized with free-format RPG.
- Indicator-heavy screen handling can now be replaced by more modern UI frameworks.
- Consider refactoring logic into procedures for better modularity.

---

## 10. **Summary Table of Main Subroutines**

| Subroutine     | Purpose                                   |
|----------------|-------------------------------------------|
| *INZSR         | Program initialization                    |
| clr_subfile    | Clear subfile and reset paging            |
| crt_subfile    | Read/fill subfile with next batch         |
| dsp_subfile    | Display subfile or command screen         |
| forny          | Refresh subfile after updates             |
| posisjoner     | Position subfile to a given supplier      |
| control        | Process main screen actions (add/del/etc) |
| subfile        | Process subfile row actions (update/del)  |
| xc1bld         | New/change supplier; open details screen  |
| xc1msg         | Msg if supplier exists before adding      |
| xc2bld         | Detail registration/update window         |
| xd1win         | Delete confirmation and execution         |

---

**In conclusion**:  
This program orchestrates supplier record selection and maintenance in a batch-friendly, subfile-based green-screen application. It is a solid example of classic ILE RPG with modular, function-driven code suited for onboarding suppliers in a legacy IBM i environment.