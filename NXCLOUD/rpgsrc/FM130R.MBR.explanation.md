## High-level Overview

This program (FM130R) is an ILE RPG program for maintaining an invoice log ("fakturalogg, vedlikehold"). It interacts with various files (database tables) and display files, providing features such as subfile handling, search/filtering, editing, viewing, and deleting invoice records. The code is structured using RPG/400 syntax, with subroutines (begsr/endsr blocks) implementing discrete actions. UX is mainly via subfiles (scrollable lists in 5250 screens).

---
## File & Display Declarations

- Multiple physical files (database tables) are defined with `F` specs, many with key fields and renamed record formats.
  - Example: `ffnufl1` ... `ffnuflu` deal with invoice log files at different levels (log, types, details, updates).
  - `ffmftl1`, `frkunl1` for invoice type and customer lookup.
- `ffm130d`: Display file, with subfile (`sfile(b1sfl:w_srrn)`).

---
## Data Structures and Variables

- **Local Data Area** (`d uds`): For user, firm, and name info passed between programs.
- **Fields for subfile navigation and state:**  
  - `w_fcrn`, `w_srrn`, `w_ssrn`, etc., keep track of subfile page/record pointers.
- **Various flags:** For detecting states like "renew" (`b_forn`), "edit in progress", errors, etc.
- **Filter/parameter variables:** Used for searching and key lists.

---
## Key Lists

- RPG key lists (`klist`) are defined for positioning/reading/updating the different files based on company, year, etc.
- These are reusable for file operations (`chain`, `setll`, etc.).

---
## Indicator Usage

- Legacy RPG indicators (`*in10`, etc.) control subfile logic, screen fields, error states, etc.
- Comment block explains mapping.

---
## Program Flow

1. **Initialization (`*inzsr`):**
   - Entry parameter (`p_aarr`, likely a year).
   - Extracts company from data area.
   - Sets up key variables, positions main file, and loads first subfile page.
   - Determines initial year to display: from parameter or current system date.

2. **Main Processing Loop:**
   - Tags/labels (`b2taga`, `b2tagb`) manage control flow for the main subfile maintenance screen.
   - **Subfile is displayed and functional keys (F-keys) are handled:**
     - F3/F12 (`*inkc`, `*inkl`): Exit program.
     - F10: Add new record (not shown explicitly here).
     - F21: Set cursor; etc.
     - Calls associated subroutines for each action.

3. **Subfile Handling (`subfile`, `forny`, `clr_subfile`, `crt_subfile`, `dsp_subfile`):**
   - `clr_subfile`: Clears subfile contents.
   - `crt_subfile`: Populates subfile with records from the invoice log, applying any active filters.
   - `dsp_subfile`: Handles screen display logic for subfiles, dealing with scrolling and page pointers.
   - `subfile`: Processes updates (edit, delete, view) based on user's selection in the subfile, calling the relevant subroutines for each option.
     - **Edit:** `xc2bld` — brings up the edit/view screen (C2BLD).
     - **Delete:** `xd1win` — brings up the delete window (D1WIN).
     - **View:** Also uses `xc2bld`.

4. **Edit/View Details (`xc2bld`):**
   - Loads detail record, copies fields to screen variables.
   - Handles update if the user makes changes.
   - Protects fields if record is viewed rather than edited.

5. **Delete Logic (`xd1win`):**
   - Loads record, displays deletion confirmation window.
   - Deletes the record if confirmed.

6. **Filter/Lookup (`xh1win`):**
   - Handles filter screen (H1WIN), supports customer/type lookups and date validation.

7. **Subfile Paging/Navigation:**
   - Manages which records are displayed, loading more records as the user scrolls.

8. **End Program (`avslutt`):**
   - Program ends when user exits.

---
## Comments and Field Usage

- Extensive comments document indicator purposes, screen field mapping, and the roles of each subroutine.
- Special attention to subfile management: record/page numbers, first/last record calculations, navigation logic.
- Comments explain which screens are used for which purposes.

---
## Special Notes

- The code uses old-style RPG/400 C-specs and indicators; it's strongly tied to 5250 green-screen workstation UX.
- Field and variable names are Norwegian; e.g., "kund" (customer), "faty" (invoice type), "besk" (description), "binr"/"aarr" (possibly invoice number/year).
- Maintenance history (at the top) shows how the program has evolved over time.
- File/field locking, validation, error handling are accomplished via RPG idioms (indicators, iterative loops, etc.).

---
## Key Takeaways For Onboarding

- **Understand subfiles:** Most user interaction is via subfiles (scrollable tables in IBM i). Grasp how `w_srrn`, `w_ssrn`, etc. work.
- **Navigation flow:** Entry points are managed by tags and heavy use of `goto` (common in old RPG).
- **Key lists:** Learn how they're used for chaining, reading, updating the right rows.
- **Actions:** Edits, deletes, and views are all handled by passing data between subfile variables and detail screens.
- **Indicators:** Learn which ones matter (see comments), since they control program state.
- **Filtering:** Users can filter invoices by customer, type, date, etc., via a filter window, and the code checks these in subfile population.
- **Legacy style:** Modern RPG is very different but knowing these idioms will help you read similar code.

---
## If you're new to this codebase:

- **Start with the initialization routine** to see how data is loaded.
- **Follow the main processing loop** to understand user interaction.
- **Review subfile routines** to see how pages are cleared and filled.
- **Try running/debugging** with display files to see the UI flow in action.
- **Consult the indicator and screen field comments** to connect code to UI.

---

**Summary:**  
This is a robust "work with invoice log" program in classic green-screen RPG, featuring: subfile management, filter/search, CRUD operations (edit, delete, view), and strong use of indicators and subroutines. The comments are good, but the code is old-style. Understanding subfile processing, key lists, and RPG indicators will be key to working with it effectively.