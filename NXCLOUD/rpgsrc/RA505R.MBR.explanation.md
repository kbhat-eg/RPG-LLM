```markdown
## Overview

This RPG IV (ILE RPG) program is designed for the IBM i (AS/400) system. Its main purpose is to provide an interactive inquiry (sp√∏rring) for "MVA-koder" (Value Added Tax codes), allowing users to browse and select VAT codes and their descriptions via a subfile user interface. The code is written in classic fixed format, with C-spec calculation lines and D-spec data definition.

---

## Header and Program Information

- The H-specs set program options:
  - `*NODEBUGIO`: Disables debug data for I/O operations (improves performance, reduces debug data).
  - `DATEDIT(*DMY)`: Specifies the date edit format (Day/Month/Year).

- The header comments describe the purpose, system, and change history. The program name is **RA505R**, used for MVA (VAT) codes.

---

## Indicator Usage

The comments enumerate special uses for indicators, which are boolean flags in RPG for managing flow, screens, and errors:

- `LR` - Last Record: Program end
- `10` - Roll key (Page Down)
- `11` - Rolldown (Page Up)
- `12` - Show subfile indicator
- `13` - Subfile control indicator
- `14` - Subfile clear
- `15` - Subfile end
- `21/22` - Cursor/home
- `30` - Field protection
- `31-79` - Warnings/messages
- `80-99` - Work indicators

---

## File Declarations

- **Physical Files**
  - `FRA05L1` and `FRA05L2`: Both are keyed disk files with `RENAME` to use record formats `RA05L1R` and `RA05L2R`. These likely correspond to two views (by code, by text).
- **Display File**
  - `FRA505D`: Workstation file with subfile (`SFILE(B1SFL:w_srrn)`). The subfile is used for displaying multiple selectable records.

---

## Data Definitions

### Parameters

- `p_firm`, `p_ekod`, `p_etxt` - Input/output parameters for firm (company), code, and description, respectively.

### Key Variables

- `ra05l1_ekod` - Used for setting the key on file `ra05l1` (search by code)
- `ra05l2_etxt` - Used for key on file `ra05l2` (search by description/text)

### Working Variables (Subfile)

- `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` - Manage subfile paging:
  - **w_stel**: Subfile record counter
  - **w_spge**: Page size
  - **w_srrn**: Relative record number in subfile
  - **w_sfrn**: First record number on page
  - **w_ssrn**: Last record number on page

- `w_seqe`: Sequence ('B' = search by description)
- `b_valg_ok`: Indicates if the user made a selection

- `w_firm`: Current firm in context

### Constants

- `c_sfil`: Number of records per subfile page (initialized to 8)

---

## Subfile/Screen Explanation

- The main user interface uses a subfile for showing MVA codes.
  - **B1SFL**: Subfile record format
  - **B2CTL**: Subfile control format
  - **B2CMD**: Command keys screen

---

## Main Program Logic

### Initial Screen (`b2taga` tag)
- Presents the main menu or screen.
- Writes the command screen (`b2cmd`).

### Subfile Display Loop (`b2tagb` tag)
- Calls subroutine `DSP_SUBFILE` to display the subfile.
- Handles positioning of the subfile based on user cursor.

### Function Key Handling (`select` statement)
Processes special function keys:
- `*INKC` or `*INKL`: Exit/Cancel
- `*INKE`: Refresh (calls `FORNY`)
- `*IN10`: Page Down (`CRT_SUBFILE`)
- `*IN11`: Page Up (`BCK_SUBFILE`)
- `*IN21`: Home key (sets *IN22 and goes to initial screen)

### Search/Positioning
- If the user enters data in the code or description fields (`b2ekod`/`b2etxt`), invokes `POSISJONER` to position to matching records.

### Subfile Processing
- Calls `SUBFILE` for row selection.
- If a valid selection is made (`b_valg_ok = *on`), exits.

---

## Subroutines Summary

### Subfile Management

#### `FORNY`
- Repositions in the subfile (after refresh)
- Uses `CHAIN` to retrieve the record at the first visible position.
- Calls `CLR_SUBFILE` and `CRT_SUBFILE` to clear and refill the subfile.

#### `POSISJONER`
- Positions the subfile cursor based on MVA code or description.
- Sets up the appropriate search key and calls position (`SETLL`) on the relevant file.
- Clears and refills the subfile.
- Resets search fields.

#### `SUBFILE`
- Processes user selection in the subfile.
- Reads each displayed record (`READC`).
- If `b1valg = 1`, copies the selected code and text to parameters, sets `b_valg_ok`, and exits.

#### `CLR_SUBFILE`
- Blanks the subfile by setting indicator 14, writing the control record, and resetting counters.

#### `CRT_SUBFILE`
- Fills (loads) the subfile with a new page of records.
- Reads from the appropriate file (`ra05l1` or `ra05l2`), depending on search mode.
- Stops filling at the end of file or when the company changes.
- Writes each subfile record (`WRITE B1SFL`).

#### `BCK_SUBFILE`
- Pages up (previous page) in the subfile.
- Backs up one page in the file (`READP`).
- After repositioning, clears and reloads the subfile.

#### `DSP_SUBFILE`
- Controls display of the subfile.
- If there are records, sets indicator 12 (to display subfile); otherwise, shows command screen.
- Sets indicator 13 (display control), performs display (`EXFMT B2CTL`).

---

### Initialization (`*INZSR`)
- Receives parameters via procedure interface (`PLIST`/`PARM`).
- Sets up keys (`KLIST`s) for fast lookup by code and description.
- Initializes company (`w_firm`) and search indicators.
- Positions to the first code.
- Loads the first page of the subfile.

---

## High-level Data Flow

1. **Program starts**: Runs `*INZSR`, initializes data, loads subfile.
2. **Main screen**: Shown to the user. User can:
   - Navigate pages (up/down)
   - Search by code or description
   - Select a record
   - Exit
3. **User selection**: If a code is selected, sets parameters and exits with those values.

---

## Important RPG idioms

- **Indicators (`*INxx`)** are used to manage the state of the display, function key processing, field protection, etc.
- **Subfiles** provide a paged list that users can scroll through, select from, or search within.
- **Tag/GOTO** is used for structured looping and menu management, common in older RPG code.

---

## Summary Table of Main Subroutines

| Subroutine   | Purpose                                     |
| ------------ | ------------------------------------------- |
| FORNY        | Refresh (renew) the subfile contents        |
| POSISJONER   | Position subfile to code or description     |
| SUBFILE      | Process user selection in the subfile       |
| CLR_SUBFILE  | Clear (blank out) the subfile               |
| CRT_SUBFILE  | Load (create) a new page in the subfile     |
| BCK_SUBFILE  | Page up (back) in the subfile               |
| DSP_SUBFILE  | Control the subfile display                 |
| *INZSR       | Initialization, parameter handling          |

---

## Key RPG Operations

- **CHAIN**: Randomly retrieves a record by key.
- **SETLL/SETGT**: Positions to a key value (for sequential reading).
- **READ/READP**: Reads records sequentially (READP = backward).
- **WRITE**: Writes a record (to the subfile or display file).
- **READC**: Reads changed records from the subfile (for data entry/select).
- **DO/LEAVE/ENDDO**: Looping constructs.

---

## Takeaway

This program is a classic ILE RPG subfile-based inquiry/selection utility for managing and looking up VAT codes. It uses traditional RPG constructs for user interaction, file access, and paging. The code is well-commented and demonstrates structured use of subfiles, indicators, and subroutines for interactive display programming on IBM i.
```