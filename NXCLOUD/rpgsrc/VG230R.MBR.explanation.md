# RPG Program Explanation for `VG230R`

This program is written in IBM ILE RPG (RPG IV in fixed format). It manages maintenance for "deviation percentages" (likely pricing or inventory deviations), organized by product groupings and suppliers. The data is maintained and displayed in a subfile on a workstation screen. Below is a breakdown and explanation of the main components of the program.

---

## 1. **Header and Documentation**

- The header comments (lines starting with `*`) describe the program name (`VG230R`), its purpose, and modification history.
- The program manages "Avviks prosenter gj.kostpris, vedlikehold" (Deviation percentages average cost price, maintenance).
- Usage of RPG indicators is documented for understanding their purpose (e.g., LR = end of program, 10 = rollup, etc.).

---

## 2. **File Declarations (`F-Specs`)**

- There are several disk files declared (`F`-specs) with various record formats, most of which are renamed for internal reference.
- The program uses logical files (indexed views) for accessing data related to product groups, suppliers, modules, and items.
- `VG230D` is a display file used for interactive input/output, with a subfile (`b1sfl`) for listing records.

---

## 3. **Data/Variable Declarations (`D-Specs`)**

The variables are grouped into:
- **Local Data Area references:** For retrieving user/session details (`l_user`, `l_firm`, etc.)
- **Key Fields:** Temporary variables matching key fields in various files for record access via `CHAIN` and `SETLL`.
- **Work variables:** For text fields, record numbering, screen control, subfile paging, and indicator flags.
- **Constants:** Such as `c_sfil` for subfile page size.

Clear comments explain what variables like `w_stel`, `w_spge`, `w_srrn`, etc. are used for (all related to subfile positioning and paging).

---

## 4. **Main Control Flow (`C-Specs`)**

### High-Level Structure

- The main loop alternates between displaying a menu/control screen (`b2cmd`), refreshing (via subroutines—EXSR), and responding to user actions (function keys).
- Tagged sections with `TAG` and `GOTO` are used for structured jumps in the control flow.

### Main Menu Handling

- `b2taga`/`b2tagb` tags: These manage control display and "bare data" (showing the subfile).
- User function keys are handled in a `SELECT` block, each key (test: *INxx) calls the appropriate subroutine (e.g., search, create, update, navigate, etc.) or ends the program (`goto avslutt`).

### Subfile Navigation

- Rollup (IN10) and Rolldown (IN11) keys trigger paging subroutines (`crt_subfile`/`bck_subfile`).
- Home (IN21) positions the cursor to a default field.

---

## 5. **Subroutines**

### Subfile Handling

- **Forny:** Refresh subfile from the database at a given position.
- **clr_subfile:** Clears the subfile area, resets counters, and turns on/off display indicators.
- **crt_subfile:** Reads records sequentially from the database into the subfile, manages page counts.
- **bck_subfile:** Moves back one page in the subfile.
- **dsp_subfile:** Handles display logic, turning on/off display control indicators as appropriate.
- **subfile:** Loops over subfile records (`readc b1sfl`), handling edits, deletes, views, and test operations as selected by the user.

### Record Maintenance

- **xc2bld:** Main maintenance screen (add/update/view). Handles:
    - Both create and edit logic.
    - Calls sub-screens (popups) for group/module/item/supplier lookup via `CALL` to other programs (VG510R, RL500R, etc.).
    - Input validation (does related record exist?) and error messaging.
    - If all validations pass, writes or updates the main file (vgkaiu).
    - Sets a flag to refresh the subfile.

- **xd1win:** Handles delete confirmation screen and deletion of a record from the main file.

- **xc1msg:** Displays a message window if error conditions are met (e.g., duplicate entry).

- **xb9win:** Subroutine for a calculation/test window, calls another program (VG707R) for calculation.

### Lookup Routines

- **hent_txt:** Looks up and loads text descriptions for product groups, supplier names, modules, and item numbers for the screen display.

### Search and Initialization

- **sok:** Searches based on current field (e.g., group or warehouse) by calling external programs.
- **\*inzsr:** Initialization subroutine, sets up keys, initializes indicators, positions database, and fills the initial subfile.

### Key List Definitions

- Key lists (`KLIST`/`KFLD`) are used for indexed file access (CHAIN/SETLL).
- Each logical file has a `KLIST` block defined for multi-field keys (typically, company + group fields).

---

## 6. **Indicators**

- Documented at the top.
- Used extensively for controlling flow, display, and error messaging.
- E.g., *IN14 and *IN15 control subfile clearing and end-of-data states.

---

## 7. **External Program Calls**

- The program does lookups using `CALL` to external programs (e.g., `VG510R` for product group, `RL500R` for supplier, and `JU500R` for module).
- These are used for user-assisted search and validation.

---

## 8. **Subfile Record Handling**

- Subfile mechanics are central (B1SFL is the subfile).
- Records are read, written, and updated in the subfile buffers for display/edit, then written back to disk as necessary.

---

## 9. **Program Termination**

- Uses RPG’s LR (Last Record) indicator to signal end-of-job and return control.

---

# **Summary of Use**

This RPG program is a typical interactive maintenance screen for a business database, centered around deviation percentages for product/supplier records. It supports:
- Browsing records in a paged subfile interface.
- Adding, updating, and deleting records with full validation.
- Lookup popups for related entities.
- Error messaging and user guidance.

The source is well commented, using meaningful variable names (in Norwegian), and follows IBM i subfile programming best practices for classic green-screen applications.

---

# **Onboarding Tips**

- **Understand the data model:** Know what each logical file (vgkaiu, vgkai1, etc.) contains.
- **Function key handling:** See which indicators trigger which actions.
- **Subfile navigation:** Grasp subfile paging and how display indicators are toggled.
- **External programs:** Know where to find the CALLED programs for lookups/validations.
- **Indicators and error handling:** Many *INxx indicators are used for flow, screen control, and errors.
- **User session context:** Uses LDA (Local Data Area) for session info like company and user.

This program is a solid example of legacy RPG for interactive business applications on IBM i.