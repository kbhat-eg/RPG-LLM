# IBM ILE RPG Program (FD120R) - Onboarding Explanation

## Purpose

**FD120R** is a maintenance program for order lines in a sales/order system, focused on managing item (product) lines—including "skaffe" (procurement/indent) registration. The program enables creation and update of order lines, handling of prices and discounts, integration of promotions/campaigns, and manages various item and order attributes.

## Structure Overview

1. **Header & Revision Log**
   - Comments at the top describe the system, program, and a detailed history log of changes.
   - Provides context for maintenance and feature additions over a long period.

2. **File Declarations (`F-specs`)**
   - Several disk files (physical/logic) are declared and renamed for use, e.g. item master, suppliers, campaigns, customer, order headers and details, and more.
   - A display file (`workstn`) is used for interactive screen I/O.

3. **Data Definitions (`D-specs`)**
   - **Parameters:** Variables passed to/from the program (order/line identifiers, item number, quantity, etc.).
   - **Local Data Area (LDA):** For user and session-based values.
   - **Data Structures:**
     - For price calculations (input/output to pricing programs).
     - For search keys to access database records.
   - **Working Variables:** For status flags, working totals, item info, pricing, text, etc.
   - **Constants:** For upper/lowercase translation, etc.
   - **External Procedure (ILE):** e.g. `CO402R` for configuration checks.

4. **Main Program Logic (C-specs)**
   - **SQL Initialization:** Sets environment for date formats and language.
   - **Item Lookup:** Validates target item and fetches details.
   - **Obsolete Item Check:** Checks for item expiry date and handles expired items.
   - **Upsell/Cross-sell Info:** Looks up and presents related promotional info.
   - **Logistics/Alternate Supplier Data:** For items using special logistic/supplier rules.
   - **Order Line Initialization:** Detects new versus existing lines and runs relevant initialization subroutines.

5. **Screen Handling and Data Collection**
   - **Data Entry Screen:** Executes subroutine to collect input from the user via a workstation display (screen). Validations are triggered for item, quantities, units, prices, and other attributes.
   - **Field Enablement/Disablement:** Controls which fields and function keys are enabled, based on context and previous input.

6. **Data Persistence**
   - **Order Line Update/Insert:** Based on findings, either updates an existing order line or adds a new one, ensuring all fields are set correctly before writing.

7. **Calculations**
   - **Total Price & Discounts:** Calculates total line amount, applying multiple discounts/overrides.
   - **Cost Price Calculation:** Ensures cost price is set, including special rules for credit lines.
   - **Gross/Net Calculations:** Handles recalculations in case of changes in unit, discounts, etc.

8. **MVA (VAT) Handling**
   - **MVA Code Lookup:** Determines the correct VAT code for the order line, considering customer/project overrides and order header info.

9. **Subroutines**
   - **Order Line Handling:** For both changed or new lines—fetches and sets up all display and logic variables.
   - **Calculator:** Converts quantities across up to 3 different units.
   - **Dekning (Coverage/Gross Margin):** Computes sales price/discount based on a desired gross margin.
   - **Pricer/Condition Logic:** Identifies if there are multiple price-giving suppliers/conditions.
   - **Campaign Check:** Finds if there is an active campaign for the item and applies special pricing if so.
   - **NOBB Info:** Fetches NOBB (Norwegian building product database) info for the item.
   - **BM Module:** For “oppsalg/mersalg” (upsell/cross-sell) info.
   - **Error Handling:** Handles unexpected errors and redisplays the screen for correction.

10. **Initialization (`*inzsr`)**
    - Sets up the environment, fetches initial context (status, order header, MVA codes, price groups, etc.), and reads in context-specific configuration flags.

## Key Business Logic Details

- **Complex Pricing:** Integrates with external RPG programs (e.g., `VP900R`, `JV751R`, etc.) to fetch base prices, cost prices, and campaign pricing.
- **Unit Conversion:** Supports products with up to 3 sales units (e.g., piece, package, pallet) and manages conversion factors.
- **Discounts:** Handles up to 4 different discounts (main, extra, campaign, etc.), applied in a chain.
- **Special Conditions:** Lots of logic for campaign-based pricing, supplier selection, and logistics variants.
- **Validation:** Enforces business rules such as not allowing non-inventory line types for inventory items, ensuring required fields, checking date consistency, etc.
- **Screen Interactivity:** User can choose price-giving supplier, conditions, run calculators, view NOBB info, and more, via function keys.

## Technical & Design Notes

- **Highly Modular/Procedural:** Heavy use of subroutines to break logic into manageable chunks.
- **Data-Driven:** Many lookups to files based on constructed keys, supporting flexible business rules.
- **Legacy RPG Style:** Uses fixed-format RPG IV (`ILE RPG`), heavily commented for maintenance.
- **SQL Embedded:** Some direct SQL is used for special lookups (e.g., logistics and campaign info).
- **Strong Change Management:** In-line change comments (with versioning), making it clear where new features and bugfixes were introduced.
- **Extensive Error Handling:** User validation feedback is surfacing to the user quickly, often with direct messaging.
- **Language:** Many comments and variable/field names are in Norwegian, following the domain terminology.

---

## Key File/Program Interactions

- **Database Files:** Item master, suppliers, price/discount files, campaign files, order headers, and lines.
- **External Programs:** For price calculations, campaign checks, price group fetches, GTIN/NOBB/other lookups, calculators.
- **Display File:** For user data entry, confirmation and error correction.

---

## Typical Program Flow (Simplified)

1. **Initialization:** Gather run context (order, item, config).
2. **Fetch Item:** Validate item and ensure it is orderable.
3. **Check for Expiry/Obsolete:** Prevents processing discontinued items.
4. **Check for Upsell/Cross-sell:** Notifies user of available add-ons.
5. **Line Handling:** If line exists, load for edit; if not, prepare new line.
6. **User Edits:** Show input screen, validate as user enters data.
7. **Calculate Totals:** Based on entered/selected values, price, discounts, units.
8. **Check/Apply Campaigns:** Modify pricing if item is on campaign.
9. **Update/Insert Order Line:** Save the completed (valid) line back to the order.
10. **Return Status:** Pass back code indicating success/failure for calling program.

---

## Onboarding Recommendations

- **Read the Top Comments:** They give invaluable insight into the evolution of rules and features.
- **Understand Key Files:** Familiarize yourself with files like item master (`jvarl1`), supplier files, price/discount files, and how their keys are constructed.
- **Trace a Use Case:** Step through, for example, *adding a new order line*, and observe which subroutines are called, in what sequence, and what external programs are involved.
- **Note All Side Effects:** Many routines not only set values but also adjust *other* variables and flags, in response to business rules.
- **Observe Function Key Handling:** Much interactive logic is tied to workstation function keys (F2 = manual cost, F4 = lookup, etc.). 
- **Validate with the Business:** Many rules are domain-specific (e.g., NOBB, campaign logic, delivery types)—work with a business analyst if these are unclear.
- **Check for Implicit Dependencies:** Some logic relies on initializations or settings from prior subroutines—ensure variables are properly initialized before reuse.
- **Consult Revision Comments:** For understanding *why* a piece of code is present or why it changed.

---

## Summary

FD120R is a key program in an order management system, responsible for detailed and compliant handling of order lines, with deep integration for pricing, discounts, campaigns, and validation. Its design reflects the complexity and flexibility required for a modern sales system in the building materials sector, with a strong focus on maintainability and traceability over time. If you’re new to this codebase, focus on understanding the core subroutines, file interactions, and how user inputs are processed and validated before the final update/insert of order lines.