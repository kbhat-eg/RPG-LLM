# RPGLE Program FO788R – Explanation

This program is an ILE RPG program designed for IBM i (AS/400) systems. Its main function is to process unsent collections of "byggdok" (building documentation) entries and send calls for those that have not yet been transmitted. It may also interact with the "Cobuilder" integration depending on configuration.

Below, you’ll find a breakdown of its key sections and the program flow.

---

## 1. **Header and Documentation**

- `h option(*nodebugio) datedit(*dmy)`
  - Compiler options: no debug I/O, date editing in day/month/year format.

- Extensive comments document the purpose of the program, what each indicator is used for, and changes over time.

---

## 2. **Files Declaration**

- **Physical/Logical Files:**
  - `fbdol1` → `fbdopfr`: Main collection file for byggdok, renamed.
  - `afpslr` → `afpspfr`: Properties/control file, renamed.
  - `amodl1` → `amodpfr`: Module definitions, renamed.

Each file is declared as a keyed disk file (`if   e           k disk`).

---

## 3. **Data Structures and Variables**

### a. **Local Data Area (LDA) Fields**
Extracted using `uds` (user data space), picking out:
- `l_user`  (positions 911-920)
- `l_filg`  (931-933)
- `l_firm`  (944-946)
- `l_fnav`  (951-980)

### b. **Keys for Files**
- `afpslr_ufil` (like `l_filg`)
- `afpslr_uide` (like `afuide`)
- `amodl1_modu` (like `axmodu`)

### c. **Working Variables**
Includes various fields for company (`w_firm`), buffer (`w_brpt`), command (`w_cmd200`), job details, document number, and control flags (`w_bdok`, `w_cobu`).

---

## 4. **Initialization and Activation Check**

### a. **Check Activation of BYGGDOK**
- Loads module `BYGGDOK` from `amodl1`.
- If not found, the program exits.

- Loads properties from `afpslr` where `uide='BYGGDOK'`.
- If found, sets `w_bdok = *on`.

### b. **Check Activation of COBUILDER**
- Loads properties for `uide = 'COBUMALNY'`.
- If found, sets `w_cobu = *on`.

- If neither is active, program ends.

**Purpose:**  
Only proceeds if one or both modules (BYGGDOK, COBUILDER) are enabled for the current company.

---

## 5. **SQL Cursor Declaration and Data Fetch**

- Sets SQL date format to ISO.
- Declares an SQL cursor `sok_o` to find unique combinations of:
  - `fwbfir` (company id)
  - `fwbnum` (document number)
- Restrictions:
  - Only documents for the current company (`fwbfir = :w_firm`)
  - And either:
    - `fwbovf = 0` and BYGGDOK is active
    - OR `fwcovf = 0` and COBUILDER is active

This means only unsent records for the relevant integration get selected.

---

## 6. **Main Processing Loop**

- Opens the cursor and loops through every returned record.
- For each:
  - If BYGGDOK is active, calls program `FO787R` with the document number.
  - If COBUILDER is active, calls program `FO793R` with the document number.

  *(Old/alternative code for calling another program and forming a command string is commented out.)*

- When no more records are left (SQLCODE=100/sqlstt='02000'), the loop ends and the program exits.

---

## 7. **Program End and Error Handling**

- `avslutt`: Sets last-record indicator (`*inlr`) and returns.
- `*pssr`: Error subroutine, just branches to the end.

---

## 8. **Subroutines**

- `*inzsr`: Initialization subroutine
  - Builds key lists for properties and module file
  - Sets `w_firm` to the current firm from LDA

---

## 9. **Key List Definitions**

- `afpslr_key`: Uses `afpslr_ufil` and `afpslr_uide` as composite key.
- `amodl1_key`: Uses `amodl1_modu` as key.

---

## 10. **Indicators (Summary from Comments)**

- Standard indicators are mapped for screen operations and program control.
- 31-79: Error and screen warnings
- 80-99: Work indicators

---

# **Summary of Execution Flow**

1. **Checks if BYGGDOK or COBUILDER are enabled** for the current company using the module and properties files.
2. **Selects unsent byggdok or cobuilder records** for the company.
3. **For each record:** 
    - Calls the relevant RPG program(s) to process/send the document.
4. **Exits** when all processing is done or if not activated.

---

# **Useful to Know When Onboarding**

- **Central configuration** is done via `amodl1` and `afpslr`.
- The **main logic is SQL-driven**: filters unsent records based on configuration.
- **Subprocessing is externalized** to other RPG programs (`FO787R` for Byggdok, `FO793R` for Cobuilder).
- **Simple error handling**: on any error, exits cleanly.

---

**If you need to enable/disable BYGGDOK or COBUILDER for a company, you do so by maintaining records in `amodl1` and `afpslr`.**

**When debugging or enhancing, the most critical logic is around how the SQL cursor is built and what triggers sub-calls to the handler programs.**

---

**Let me know if you need more details on a specific section or integration!**