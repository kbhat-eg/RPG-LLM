# Explanation of RPG Program RA112R ("Landkoder, vedlikehold")

This RPG program is designed for the maintenance of country codes (landkoder) in an IBM i (AS/400) environment. The functions supported include display, add, change, copy, and delete country code records, using subfiles for user interaction.

Below is a breakdown of the main structures and logic.

---

## Header and Documentation

**Header:**  
- `option(*nodebugio) datedit(*dmy)` sets compilation options: disables debug IO and uses date edit in day-month-year format.
- The header comment block documents system, program, purpose, special versions, references, and change history.

---

## Files

- **Physical Files (Input/Update):**
  - `fra12l1`, `fra12l2`, `fra12lr`, `fra12lu` -- all from the same physical file `ra12pfr` but different record formats (r, l1r, l2r, lur).
  - These are used for keyed access to country code data.

- **Display File:**
  - `fra112d` -- the display (workstation) file, with a subfile (`sfile(b1sfl:w_srrn)`), used for presenting lists of countries and interacting with users.

---

## Data Definitions

### Local Data Area (LDA)

- Used for passing session/user information.
- Fields include user ID, firm number, and other parameters.

### Key Variables

- Variables like `ra12l1_lkod`, `ra12l2_ltxt` etc. are defined to hold values for keyed access.

### Working Variables

- Counters and flags for handling subfiles:
  - `w_stel`, `w_spge`, `w_srrn`, etc. for tracking subfile paging.
  - Various flags: `b_oppr`, `b_forn`, `b_anul`, `b_feil`.
- Control and status variables for access control and state tracking.
- Constant(s): `c_sfil = 14` for subfile page size.

### Access Control (7.01 Feature)

- Control for access permissions with variables for authorization checks.
- Declarations for external program `CO402R` (possibly for security or access control).

---

## Subfile and Display Fields

- The comments describe all subfile fields and their purpose (record number, page size, current, first, last etc.).
- `B1SFL`, `B2CTL`, `B2CMD`, `C1BLD`, `C1MSG`, `C2BLD`, `D1WIN`, `K1WIN` are display file record formats for various screens.

---

## Main Control Flow

There are two main control blocks (branches using tags `b2taga` and `b2tagb`), which handle the primary loop of the program. The flow generally is:

1. Display function key screen (`B2CMD`).
2. Call subroutines to display or refresh the subfile (`dsp_subfile`, `crt_subfile`, etc.).
3. Check for access control on function keys (7.01 version).
4. Handle function key presses and call corresponding subroutines.
   - Exit, refresh, add, roll-forward/backward, position, etc.
5. After processing, loop back to the main tag to continue.

---

## Access Control Logic (7.01 version)

- Checks user access for specific function keys (like F6).
- Calls external program `AD005R` to validate access.
- If the user is "Sperret" (locked out), the function is not allowed.

---

## Subfile Processing

### Subfile Handler (`subfile` subroutine)

- Loops through all records in the subfile, reading changed records (`READC`).
- For each row, checks if the user has authority for the selected action (7.01: copy, change, delete, view).
- Depending on the user's selection:
  - **Change:** Show edit screen for the row (`xc2bld`).
  - **Copy:** Calls copy window (`xk1win`).
  - **Delete:** Calls delete window (`xd1win`).
  - **View:** Opens view-only screen (`xc2bld` with protected fields).

### Add New Record (`xc1bld` / `xc1msg`)

- `xc1bld`: Handles user input for creating a new row.
- If the country code exists, displays `xc1msg` message screen.
- On confirmation, calls maintenance subroutine `xc2bld` to add.

### Change/View Record (`xc2bld`)

- Reads country data.
- Displays entry/edit screen.
- On confirmation, updates or writes the record.

### Copy Record (`xk1win`)

- Prompts for the new key, checks exists, calls maintenance routine to create a copy.

### Delete Record (`xd1win`)

- Prompts for delete confirmation, then deletes the record.

---

## Subfile Paging

- **Clear subfile:** (`clr_subfile`) -- marks subfile as empty for redisplay.
- **Create subfile page:** (`crt_subfile`) -- fills subfile with the next page of records, up to `c_sfil` per page.
- **Back page:** (`bck_subfile`) -- handles subfile page-back navigation.

---

## Initialization (`*inzsr`)

- Sets up key lists for various record access patterns.
- Calls access control routine (`CO402R`) to determine if access control is active for this user.
- Loads LDA values and positions the subfile for the first display.
- Fills the initial subfile page for display.

---

## Function Key and Indicator Usage

- RPG indicators (such as `*IN10`, `*IN11`, etc.) are used throughout for function key and state tracking.
- Special indicators are documented in comments (e.g. `LR = end of program`, `10 = rollup`).

---

## General Comments

- The program is structured as a typical subfile maintenance utility in 'green screen' IBM i environments.
- It includes many layered access and authority checks.
- Extensive use of subroutines makes for logical separation of tasks: initialization, paging, CRUD actions, display handling.
- Comments are (helpfully) in Norwegian, and provide good mapping to field usage and display screens.

---

## Summary Table of Major Subroutines

| Subroutine        | Purpose |
| ----------------- | ------- |
| `forny`           | Refresh (forny) subfile based on position |
| `posisjoner`      | Position subfile on key or description     |
| `subfile`         | Main loop: process actions on subfile rows |
| `xc1bld`          | Create new record screen                   |
| `xc1msg`          | Message if record exists                   |
| `xc2bld`          | Edit/view record screen                    |
| `xd1win`          | Delete confirmation                        |
| `xk1win`          | Copy record screen                         |
| `clr_subfile`     | Clear subfile                              |
| `crt_subfile`     | Fill subfile page                          |
| `bck_subfile`     | Page backward in subfile                   |
| `dsp_subfile`     | Display subfile                            |
| `*inzsr`          | Initialization                             |

---

## Final Notes

- **User Authority:** The program is retrofitted for access control via external programs. The latest changes (7.01) add systematic checks to prevent unauthorized access to certain actions or the entire routine.
- **Subfile Use:** Paging and positioning allow for efficient large-table maintenance.
- **Modularity:** Subroutines (BEGSR/ENDSR) separate each discrete action for clarity and maintainability.
- **Display Files:** Rely heavily on predefined DSPF layouts for interactions.

This code provides a strong and somewhat typical example of interactive RPG (green screen) maintenance programming, with both CRUD logic and layered access control. If you need onboarding for specific parts, like subfile handling, indicator usage, or access control, let me know!