# Explanation of the RPG Source Code

This source code is an ILE RPG program (RH656R) designed to produce a **tabular balance report** (tabellarisk saldobalanse) for the general ledger, grouped either by account or department, with various levels of subtotaling and printing, based on parameters.

## 1. **Program Structure Overview**

- **Header Section:**  
  `h datedit(*dmy) option(*nodebugio)`  
  Specifies date edit (day/month/year) and disables debug I/O.

- **File Declarations:**  
  - `frhsal1` and `frhsal2`: Input files (disk, keyed), reading balance records by account or by department.  
  - `frh656p`: Output file for printer (with overflow indicator *IN30).

- **Data Structures:**  
  - `sal`: Array for monthly/year-to-date balances (`dim(13)`).  
  - Several data structures (DS) and user-defined data structures (UDS) for "break" (brudd) control at various grouping levels (account, group, class, etc.).
  - Many working fields for totals, differences, and reporting (such as `l1bevp`, `l2salh`, etc.; each "level" corresponds to a subtotal/grouping in the report).
  - Variables for controlling printing, indicators, and calling external programs to fetch descriptions or texts (like account, group, class, and department names).

- **Input Record Formats:**  
  `rhsal1r`, `rhsal2r`  
  Both formats map `risa01`...`risa13` to the `sal(01)`...`sal(13)` array for easier per-period processing.

- **Mainline Code:**  
  - **Initialization:** Sets up variables, processes parameters, and positions files via SETLL.
  - **Processing Loop:** Reads records, checks for end-of-file, and for breaks in control fields (i.e., group changes such as account or department).
  - **Break Processing:** When a control break is detected (change in a key grouping), performs subtotals, prints group subtotals, resets subtotal fields, and fetches descriptive text for headings.
  - **Subroutines:**  
    - Calculation of balances for periods/ranges.
    - Handling of breaks at different levels (specification, account, group, class, department).
    - Calculation and printing of headings, lines, and summaries.
  - **Program End:** Final calculations and last page printout.

---

## 2. **Key Concepts and Data Flow**

### **A. Files and Input Data**

- The program reads from two physical files:  
  - **Account order:** `frhsal1` (rhsapfr:rhsal1r)  
  - **Department order:** `frhsal2` (rhsapfr:rhsal2r)  
  One is chosen depending on the sorting parameter.

- Each record contains balance amounts by period, as well as keys (firm, account, specification, department, year, type).

### **B. Grouping and Break Handling**

- **Break ("brudd") Fields:**  
  The program monitors when certain fields (account, department, group, class, spec) change, which signals a "break" and triggers subtotaling and printing for the previous group.
- Data structures like `nybrd`, `gmbrd`, etc., store "new/current" and "old" break values for comparison.

### **C. Subtotaling and Reporting Levels**

Each subtotal has its own group of variables (e.g., l1xxx for spec, l2xxx for account, l3xxx for group, etc.):

| Level | Field Set Example | Meaning                        |
|-------|-------------------|-------------------------------|
| L1    | l1bevp, l1salh    | Specification                 |
| L2    | l2bevp, l2salh    | Account                       |
| L3    | l3bevp, l3salh    | Account group                 |
| L4    | l4bevp, l4salh    | Account class                 |
| L5    | l5bevp, l5salh    | Department                    |

When a break is detected, the program:
- Calculates and saves subtotals/differences.
- Optionally calls external programs to get text descriptions.
- Prints subtotal lines.
- Resets subtotal accumulators for the new group.

### **D. External Program Calls**

- `RS707R`, `RS719R`, `RS720R`, `RS740R`:  
  Called to fetch textual descriptions for department, class, group, or accounts, which are used in the headings and report output.

---

## 3. **Logic Flow Summary**

### **A. Initialization (`*inzsr`)**

- Resets totals and working fields.
- Handles input parameters (controls for what to compare, how to aggregate, etc.).
- Selects which file to use (account/department order), and sets file position.
- Fetches the initial department heading.
- Prints the first page heading.

### **B. Read and Process Loop**

- **Reads the next record:**
  - Uses different files/keys based on sort parameter.
  - Loops until EOF.
- **Checks for group (break) changes:**
  - On a break, calls the appropriate break-processing subroutine (e.g., `brkto` for account, `brgrp` for group).
- **Adds record amounts to current group totals** using subroutines like `rsum` (which itself calls `hsum` for period sums).
- **After EOF**, processes the last group, and prints the final page.

### **C. Subroutines**

#### **1. rsum/hsum (Record Summation)**
- Handles addition of values for current period or range of periods, depending on the parameters.

#### **2. brsps/brkto/brgrp/brkla/bravd (Break Handlers)**
- Each handles subtotaling at a specific break (specification, account, group, class, department).
- They print group totals (if applicable), and reset their subtotal variables.
- They fetch text for the report when needed.

#### **3. brukt**
- Calculates percentage-used statistics for the report (used/achieved versus planned or previous).

#### **4. skriv**
- Writes page report headings and increments page/section counters.

---

## 4. **Key RPG Techniques Used**

- **OVERLAY:**  
  Data structures are overlaid to extract subfields without moving data.

- **External Calls for Texts:**  
  Modularizes fetching text labels for report headings.

- **Indicators:**  
  Classic indicator variables for overflow, end-of-file, and controlling report lines.

- **Array-based Period Handling:**  
  Allows easy summing across periods using `sal(n)`.

- **Control Level Breaks:**  
  RPG classic "break logic" groups records by key, totalizes, and reacts to group changes.

---

## 5. **Parameters and Controls**

- **`rhpsrt`:** Sort order ('K' for account, 'A' for department)
- **`rhpsml`:** Report comparison type (budget, previous year, average, etc.)
- **`rhpavv`:** Usage/achievement calculation method.
- **`rhpktf`, `rhpktt`:** Account range.
- **`rhpavf`, `rhpavt`:** Department range.
- **`rhppef`, `rhppef`:** Period/fiscal range.
- **`w_firm`, `l_firm`:** Firm/company code.

---

## 6. **Report Output**

- Lines are written to the printer output file (`frh656p`), using logical page breaks and headings.
- Subtotal lines are written after each break, with proper fetching of their description text.
- A summary is printed at the end, including totals and differences.

---

## 7. **Typical Usage**

1. Called by a controlling program or command with parameters.
2. Reads and processes balances (from accounts or departments).
3. Subtotals and prints by subgroups (specification, account, group, class, department).
4. Outputs a formatted, multi-level subtotaled report for auditing, financial control, or summary purposes.

---

## 8. **Onboarding Notes**

- **To Change/Enhance the Report:**  
  - Modify break-handlers or add fields in the subtotal data structures.
  - Add new sort/grouping fields as needed.
- **To Understand Output:**  
  - The output structure mirrors the break hierarchy: within each department/class/group/account/spec, subtotals are shown.
- **To Debug:**  
  - Ensure input files are correctly populated, external programs return text, and key fields align with your company data.

---

### **In summary:**
This program is a robust, classic RPG implementation of a tabular GL balance report generator, making heavy use of break logic, subtotaling, and dynamic report text. It can be adapted to various grouping and subtotaling requirements by accounting and finance operations. 

If you are new to RPG, focus on:
- How breaks and groupings are handled.
- How subroutines modularize subtotaling and page/line management.
- The use of indicators and overlays for classic RPG data handling.