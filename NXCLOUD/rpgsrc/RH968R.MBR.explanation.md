# RH968R – Main Ledger Journal Rerun/Selection

## Overview

This program, `RH968R`, serves as a batch extraction and transformation utility for ledger transactions in the ASOKON system. Its primary function is to select, filter, and reformat transactions from the main ledger, customer, and vendor journals, and to write the results to a work file (`rhwapf`). This process is typically part of a rerun or reprocessing workflow for journal entries, possibly in support of reporting, auditing, or migration tasks.

The program reads from three main input files (all journal-based physical files, each with a corresponding record format):

- **Main Ledger Transactions** (`rhtrl1`)
- **Customer Transactions** (`rktrl1`)
- **Vendor Transactions** (`rltrl1`)

It writes output records to a work file (`rhwapf`).

## Data Structures and Key Fields

### Work Key Data Structure (`wksort`)

A composite data structure (`wksort`) overlays several fields, which are used both for sorting and for building the output record key. This structure is populated for each selected transaction, ensuring consistent keying across different transaction types.

**Fields in `wksort`:**

- `wkfirm`: Company code
- `wkjour`: Journal/customer identifier
- `wkbiln`: Voucher number
- `wkbdat`: Voucher date (ISO format)
- `wkkont`: Account/customer/vendor number
- `wkspes`: Special code
- `wkavde`: Department code
- `wkrper`: Period
- `wktist`: Timestamp

### LDA Parameters

Parameters are extracted from the Local Data Area (LDA), which are used to control the selection logic:

- `rhprår`: Year (Norwegian: "år")
- `rhppet`: To period (tilperiode)
- `rhppef`: From period (fraperiode)
- Other fields control various aspects of selection and processing.

### Local Working Variables

Numerous working variables (`g*`, `w_*`) are used for intermediate storage and for key construction.

## Processing Logic

The program processes each journal file in sequence, applying filtering and transformation logic tailored to each source.

### 1. Main Ledger Transactions (`rhtrl1`)

- **Selection by Period:** Only include records where the period (`rbrper`) is within the specified range (`rhppef` to `rhppet`).
- **Exclude Auto-Postings:** Transactions with `rbbilk` = 94 or 95 are skipped (these represent auto-postings for customer/vendor subledgers).
- **Transformation:** Selected records have their key and relevant fields mapped to the work structure, then written to `rhwapf`.

### 2. Customer Transactions (`rktrl1`)

- **Selection by Year and Period:** Only include records for the specified year (`rhprår`) and period range.
- **Transformation:** 
    - Customer account number (`rnkund`) is mapped as the account field.
    - Several fields (e.g., special code, department) are zeroed out, as they are not applicable.
    - Additional fields are populated or cleared to ensure the output record matches the required format.
    - The result is written to `rhwapf`.

### 3. Vendor Transactions (`rltrl1`)

- **Selection by Year and Period:** Same logic as customer transactions, using vendor-specific fields.
- **Transformation:** 
    - Vendor account number (`rolevr`) is mapped as the account field.
    - Non-applicable fields are zeroed or blanked.
    - Output is written to `rhwapf`.

## Key Design and Business Rules

- **Normalization:** All transaction types are normalized to a common work record structure for downstream processing.
- **Period Filtering:** Strict period and year checks ensure only relevant transactions are selected.
- **Auto-Posting Exclusion:** Main ledger transactions that are auto-generated from subledgers are excluded to avoid duplication.
- **Field Mapping:** Fields are mapped carefully to ensure compatibility across different transaction types, with non-applicable fields set to zero or blank.

## File Interactions

- **Input:**
    - `rhtrl1` (Main Ledger) – renamed from `rhtrpfr`
    - `rktrl1` (Customer Ledger) – renamed from `rktrpfr`
    - `rltrl1` (Vendor Ledger) – renamed from `rltrpfr`
- **Output:**
    - `rhwapf` – work file for extracted and transformed transactions

## Initialization (`*INZSR` Subroutine)

- Sets up key lists for each journal file, based on company (`w_firm`) and year (`w_raar`).
- Values for these keys are taken from LDA parameters.

## Notable Conventions and Patterns

- **Overlaying Data Structures:** The use of overlays for `wksort` enables efficient packing of key fields for sorting and output.
- **Tag/GOTO for Loop Control:** Uses `TAG`/`GOTO` for early exit within loops, a common idiom in legacy RPG for readability and control flow.
- **Zeroing/Blanking Non-Applicable Fields:** Ensures output records have a consistent structure, regardless of source.
- **No Debug I/O:** The `H` spec disables debug I/O for performance and to prevent accidental data exposure.

## Relationships to Other Modules

- This program is likely called as part of a batch job, possibly by a controller or scheduler.
- The output work file (`rhwapf`) is intended for further processing, such as reporting, reconciliation, or migration.
- The naming conventions (`rb*`, `rn*`, `ro*`) suggest tight integration with other ledger and accounting modules in the system.

## Business Domain Notes

- The terminology and field names are Norwegian (e.g., `bilag` = voucher, `kunde` = customer, `leverandør` = vendor, `periode` = period, `år` = year).
- The logic reflects standard accounting practices, such as period-based filtering and the distinction between main ledger and subledger postings.
- Exclusion of auto-postings is critical to prevent double-counting transactions that are already reflected in subledgers.

---

**In summary:**  
`RH968R` is a batch extraction program that consolidates and normalizes main ledger, customer, and vendor transactions for a specified company, year, and period range, outputting results to a work file for further processing. The code uses overlays and careful field mapping to ensure consistent output, and applies business rules to exclude irrelevant or duplicate records.