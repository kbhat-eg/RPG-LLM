# ILE RPG Program RA518R â€“ Explanation

This program is written in IBM ILE RPG (Report Program Generator) and is designed to handle a subfile inquiry for "Leveringsbetingelser" (delivery terms/conditions). Throughout, it interacts with subfiles and display files to allow the user to search, scroll, and select delivery conditions.

Let's break down its major components, structures, logic, and purpose.

---

## 1. **Program and File Specifications**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Specifies debug and date editing options.

**File Definitions:**
```rpg
fra18l1    if   e           k disk    rename(ra18pfr:ra18l1r)
fra18l2    if   e           k disk    rename(ra18pfr:ra18l2r)
fra518d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- `fra18l1` and `fra18l2`: Input files, both externally described, renamed records.
- `fra518d`: Workstation file (display file), uses a subfile (`b1sfl`) controlled by the variable `w_srrn`.

---

## 2. **Data & Variable Declarations**

**Parameters:**
```rpg
d p_firm          s                   like(rarfir)
d p_rkod          s                   like(rarkod)
d p_rtx1          s                   like(rartx1)
```
- Parameters are company code, condition code, and description.

**Variables:**
- Variables are declared for subfile management (`w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`) and for record keys (`ra18l1_rkod`, `ra18l2_rtx1`).
- `w_seqe`: Used to determine which file/sequence to use.
- `b_valg_ok`: Indicates if a selection has been made.
- `w_firm`: Local copy of company code from parameters.
- `c_sfil`: Constant for subfile page size (initialized to 8).
- Detailed explanations are provided in comments (in Norwegian) for each variable.

---

## 3. **Indicator Usage**

The comment block explains which indicators (`*INxx`) are used:
- E.g. `LR` = end of program, `10/11/12/13/14/15/21/22/30/...` used for screen/subfile control.

---

## 4. **Screen Handling and Main Program Loop**

The main logic is built around handling the display and subfile (paging, scrolling, selection):

**Main Tags and Loops:**
- `b2taga`/`b2tagb`: Main control tags for display actions.
    - Write full screen or just data as needed.
    - Depending on user input, process keys (F-keys), positioning, subfile management.

**Key Processing:**
```rpg
select
   when *inkc or *inkl  // F3/Cancel or F12/Cancel
      goto avslutt
   when *inke           // F5/Refresh
      exsr forny; goto b2tagb
   when *in10           // F10/Page Down
      exsr crt_subfile; goto b2tagb
   when *in11           // F11/Page Up
      exsr bck_subfile; goto b2tagb
   when *in21           // Home-key
      *in22 = *on; goto b2taga
endsl
```

- User can browse, refresh, and position the subfile using function keys.

---

## 5. **Subroutines Overview**

### a. **forny (Refresh Subfile)**
- Repositions database and repopulates the subfile after refresh.
- If positioned by description (`w_seqe = 'B'`) or by code, uses the appropriate file and key.

### b. **posisjoner (Positioning)**
- Positions the file pointer according to the user's criteria (either by code or description).
- Clears and recreates the subfile accordingly.
- Resets position input fields after use.

### c. **subfile (Process Subfile)**
- Alternates indicator 22 (cursor placement) to highlight records.
- Loops through subfile records with `readc`.
- Checks for user selection (`b1valg = 1`), updates return parameters, and exits if found.

### d. **clr_subfile (Clear Subfile)**
- Turns on indicator 14 (clear).
- Writes control record to clear subfile.
- Resets counters.

### e. **crt_subfile (Create/Fill Subfile Page)**
- Fills the subfile with a page of records.
- Handles end-of-file and page boundaries.
- Adds records with `write b1sfl`.

### f. **bck_subfile (Back One Page)**
- Reads the previous page in reverse order.
- Repositions and re-fills the subfile to display the previous page.

### g. **dsp_subfile (Display Subfile)**
- Outputs the subfile page to the screen.
- Handles display indicators.

### h. **Initialization (*inzsr)**
- Handles program startup, parameter receipt, and initial subfile population.
- Initializes positioning keys for both files.

---

## 6. **Subfile Logic and Paging**

- The core of the program is managing a display subfile (paged display in green screen environments).
- `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` manage subfile rows/position.
- User can scroll, jump, position, and select records.

---

## 7. **User Interaction Flow**

1. **Initial Display**: On start, subfile page is filled and displayed.
2. **Navigation**: User can use function keys to scroll (F10/11), refresh (F5), or position by code/description.
3. **Selection**: User can select a delivery condition. Selection causes the program to exit with parameters set (`p_rkod`, `p_rtx1`).
4. **Exit**: F3/F12 or after selection.

---

## 8. **Screen Formats**

- `b1sfl`: Subfile record format.
- `b2ctl`: Subfile control format.
- `b2cmd`: Full-screen command/key input format.

---

## 9. **Indicators and Field Protection**

- Various indicators are used to control display attributes, cursor placement, field protection, etc.
- These are handled consistently per IBM RPG subfile best practices.

---

## 10. **Summary**

**The program RA518R is a classical display file handler for searching, viewing, scrolling, and selecting "leveringsbetingelser" (delivery terms) in a subfile-driven green-screen UI on IBM i. Its code is structured around subfile paging, efficient display handling, and user-driven navigation.**

---

### Key Takeaways for Onboarding Developers

- **Subfiles**: Understand how paging and cursoring in subfiles work in RPG.
- **Indicators**: Vital for controlling display and back-end logic.
- **Record Navigation**: Uses RPG's file positioning opcodes (`setll`, `chain`, `read`, `readp`).
- **Modularization**: Common RPG/400-style, with subroutines (`begsr`/`endsr`) instead of procedures.
- **Parameter Flow**: Returns values in the parameters provided on entry when a selection is made.

---

### Next Steps for New Developers

- Review the display file (`fra518d`) to understand the input/output fields (beyond RPG scope).
- Familiarize with the referenced physical and logical files (`fra18l1`, `fra18l2`).
- Test the program to see subfile interaction in action.
- Practice modifying subfile size and adding new navigation features if needed. 

---

Feel free to ask about specific sections or to get workflow diagrams for this program!