# Program LO647R – Documentation

## Purpose

**LO647R** generates a report listing deleted purchase orders ("bestilling-slettet-liste"). The program reads from multiple files to gather details of deleted orders, enriches the data with supplier information, updates tracking fields in the deletion register, and prints a formatted report. It also manages unique numbering for each "deleted list" using an external number register.

This program is part of the **ASLAGR** system and is tailored for handling logistics or inventory-related processes, specifically tracking and reporting on deleted purchase orders.

---

## Structure Overview

- **Files Used:**  
  - `rlevl1` (Supplier master, renamed `rlevl1r`)
  - `lstsl1` (Status codes, renamed `lstsl1r`)
  - `ldell1` (Deleted orders, renamed `ldell1r`)
  - `ldellu` (Deleted orders update, renamed `ldellur`)
  - `lo647p` (Printer file for report output)

- **Report Formats:**  
  - `A1HDR` – Report Heading  
  - `D1DET` – Report Detail  
  - `T1TOT` – Report Total  

- **External Program Call:**  
  - `AS100R` – Retrieves the next available number from the number register for list numbering.

---

## Key Business Logic and Data Flow

### 1. Initialization (`*inzsr`)

- **Parameter Handling:**  
  Receives a 64-character parameter block (`w_parm`), which is mapped to a data structure (`d_prec`). This block contains control values, including an indicator (`d_val1`) that determines if the number register should be updated and if order records should be marked as printed.

- **Key Lists Setup:**  
  Key lists are set up for all file accesses (supplier, status, deleted orders), using the current firm and relevant key fields.

- **Firm and User Info:**  
  Loads firm (`l_firm`) and user (`l_user`) information from the local data area, mapping these to report heading fields.

- **Status Code Lookup:**  
  Reads the status code record for the firm to potentially resolve status descriptions (though not explicitly used in the main logic).

---

### 2. Report Heading (`A1HDR`)

- **Number Register Integration:**  
  If the control parameter (`d_val1`) is set to 1, the program initializes the "deleted list" number by calling subroutine `hntnum`, which retrieves the next available number from the number register via external program `AS100R`.

- **Heading Output:**  
  The report heading is written using the `A1HDR` format.

---

### 3. Report Detail Processing (`D1DET`)

- **Main Loop:**  
  Iterates over all records in the deleted orders file (`ldell1`) for the current firm.

- **Supplier Information Enrichment:**  
  For each deleted order, the supplier number is used to retrieve the supplier name from the supplier master (`rlevl1`). This name is included in the report detail line.

- **Marking Orders as Printed:**  
  If the control parameter (`d_val1`) is 1, the program attempts to mark the deleted order as "printed" in the update file (`ldellu`). It updates tracking fields:  
    - `lyprtk` (printed flag) set to 1  
    - `lyedat` and `lyetim` updated with current date and time  
    - `lyeusr` updated with the current user

- **Report Detail Output:**  
  Each processed deleted order is output as a detail line (`D1DET`).

- **Page Overflow Handling:**  
  If the printer overflow indicator (`*IN30`) is set, a new heading is written.

---

### 4. Totals and Program End (`T1TOT`)

- **Totals Output:**  
  At the end of processing, a total line (`T1TOT`) is printed.

- **Program Termination:**  
  The program sets the last record indicator (`*INLR`) to end.

---

### 5. Number Register Handling (`hntnum` Subroutine)

- **Purpose:**  
  Retrieves the next available "deleted list" number for the report.

- **Parameters:**  
  Calls external program `AS100R` with parameters for code, firm, department, type, fixed value, and the number itself.

- **Design Note:**  
  The code, type, and fixed value are blanked out before the call, suggesting a generic or default numbering sequence is used.

---

## Design Decisions and Conventions

- **File Renaming:**  
  All physical files are renamed on the F-spec for clarity and to avoid conflicts. This is a standard in this codebase to support modularity and future changes.

- **Parameter Block:**  
  Control and context are passed as a single packed parameter block, enabling flexible invocation and chaining from other programs.

- **Tracking and Audit:**  
  The program updates tracking fields on the deleted order records to record print actions, user, date, and time, supporting audit requirements.

- **External Number Register:**  
  List numbering is delegated to an external program, ensuring centralized and consistent numbering across the system.

- **Report Format Management:**  
  Printer file formats are clearly separated for heading, detail, and totals, supporting flexible report layout and easier maintenance.

---

## Interactions with Other Modules

- **External Program `AS100R`:**  
  Provides numbering services. Any changes in numbering logic or format must be coordinated with this program.

- **Supplier Master (`rlevl1`):**  
  Used for enriching the report with supplier names.

- **Deleted Orders (`ldell1`/`ldellu`):**  
  The main data source and update target for the report.

- **Status Codes (`lstsl1`):**  
  Loaded during initialization, possibly for future expansion or for use in report headings or filtering.

---

## Noteworthy Patterns

- **Conditional Logic via Parameter:**  
  The program's behavior (e.g., whether to update the number register and mark records as printed) is controlled via the incoming parameter, allowing for flexible reuse in different contexts.

- **Use of Local Data Area:**  
  User and firm context are loaded from the LDA, a common pattern in legacy RPG systems for session-level data.

- **Subroutine-based Structure:**  
  Key operations (initialization, number handling) are encapsulated in subroutines for clarity and reuse.

- **Overflow Handling:**  
  The program proactively manages printer overflow, ensuring report readability.

---

## Summary Table

| Component        | Purpose/Role                                          |
|------------------|------------------------------------------------------|
| rlevl1/rlevl1r   | Supplier master, for name lookup                     |
| lstsl1/lstsl1r   | Status codes, loaded at startup                      |
| ldell1/ldell1r   | Deleted orders, main data source                     |
| ldellu/ldellur   | Deleted orders, update file for marking as printed   |
| lo647p           | Printer file for report output                       |
| AS100R           | External program for list numbering                  |
| *inzsr           | Initialization subroutine                            |
| hntnum           | Subroutine for number register access                |

---

## Maintenance and Extension Notes

- **Adding Fields:**  
  To include additional information in the report, extend the detail format and update the enrichment logic in the main loop.

- **Changing Numbering Logic:**  
  Any changes to how deleted lists are numbered require updates to both this program and the external `AS100R`.

- **Audit/Tracking:**  
  The update logic for printed records is centralized; any changes to audit requirements should be implemented here.

- **Localization:**  
  Some comments and field names are in Norwegian; coordinate with business analysts for translation or clarification if needed.

---

## Conclusion

LO647R is a reporting program centered on deleted purchase orders, integrating data from several master and transaction files, and providing robust tracking and audit features. It follows established patterns for modular RPG development in the ASLAGR system and interacts with key components for numbering and supplier information. New developers should familiarize themselves with the parameter block structure, file naming conventions, and the external numbering program for effective maintenance and extension.