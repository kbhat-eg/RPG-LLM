# RPG Program Explanation - SR100R (ASSTAT System)

---

## Purpose

This RPG program is designed for maintaining a purchasing parameter file ("parameterfil, innkjøp") in the ASSTAT system. It provides functions for viewing, adding, changing, copying, deleting, and printing parameter records related to purchasing statistics. It uses subfiles for screen presentation and allows flexible handling of parameter types, selections, sorting, and periods.

---

## Key Concepts & Data Structures

### File Definitions

- **Workstation File**
  - `SR100D` - Display file, uses a subfile (`B1SFL`) with record number `SRRN01`.

- **Database Files**
  - `AUSRL1` - User table, renamed as `AUSRL1R`.
  - `SLPML1` - Parameter register, renamed as `SLPML1R`.
  - `SLPMLU` - Parameter update file, renamed as `SLPMLUR`.

### Data Structures & Variables

- **Display/Work variables**
  - Arrays for messages (`MLD`), report texts (`RPT`), reference numbers (`REF`), and record action pointers (`RAP`).
  - Several variables for tracking state (record numbers, keys, values).

- **Program State**
  - `WWREST_00`, `WWTEXT_00`, ... - Work storage for parameter information fields.
  - `WWFIRM`, `WWTYPE`, `WWKODE`, `WWVALG` - Current firm/type/code/selection.
  - `B1VALG`, `B1ENDR`, etc. - Fields used in the subfile for user input/actions.

- **Keys (KLIST)**
  - `AUSRL1_KEY` - For user lookups.
  - `KEY01`, `KEY02` - For parameter record chaining by firm/type/code/selection.

---

## Main Logic Flow

### 1. Initialization (`*INZSR`)
- Sets up default work variables, keys, and reference tables.
- Positions at the start of the parameter file and builds the initial subfile page for display.

### 2. Main Menu (Openscreen) Handling
- Handles user actions (buttons/commands) from the main control screen.
- Depending on user input, branches to processing routines for:
    - Details view
    - Refresh
    - Exit
    - Positioning
    - Various actions based on the value in selection fields (`B2VALG`, `B1VALG`).

### 3. Subfile Processing
- Handles user manipulations within the subfile (one line per parameter record).
- Allows Change, Copy, Delete, Show, Print, Selection routines for each parameter listed.

### 4. Action Routines (by selection)
Each action (add, change, copy, delete, show, print, selection, sort, sum) has its own subroutine, responsible for:
  - Showing the corresponding screen.
  - Loading/saving data to/from the file(s).
  - Validating user input.
  - Executing the requested action on the database.

### 5. Subfile Maintenance
- **Clear** — Erases the subfile before repopulation.
- **Create (`XCRT01`)** — Refills the subfile with parameter records, with filter conditions for "current firm", detail vs. summary mode, etc.

### 6. Other Supporting Subroutines
- **Display (`XDSP01`)**
- **Parameter Editing/Display for Add/Change/Copy** (`XC2BLD`, `XC3BLD`, `XC4BLD`, `XC5BLD`, etc.)
- **Delete Handling** (`XD1WIN`)
- **Copy Handling** (`XK1WIN`)
- **Printing/Export Handling** (`XP0WIN`, `XP1WIN`, `XP2WIN`, `XP3WIN`)

### 7. Lookup & Selection Calls
- Can call out to many subprograms (e.g., `SR111R`, `SR112R`, ...) depending on what type of parameter grouping or selection the user is working with.

---

## Special Considerations

- **Firm Filtering**  
  Always checks firm (`SRFIRM`) before adding records to the subfile (see the `5.41` patch).  
- **Detail vs. Summary Mode**  
  Displayed via the variable `WW_DETALJER` which switches the screens and authorized actions.
- **Navigation, Validation, and Feedback**  
  Uses *INxx indicators for screen control, error feedback, and command branching.

---

## Patch/Version Notes

- Version 5.41 ensures that only records matching the current firm are shown in the subfile.  
- Comments and table at the end describe what code values (such as '11', '12', etc.) mean for types of grouping or selection.

---

## Common Operations

- **Adding a parameter record:**  
  User selects "Ny post" (code 001), fills out the form, and confirms. The program checks for duplicates and writes the new record.
- **Changing:**  
  Loads the fields for the existing record, allows editing, then updates.
- **Showing:**  
  Presents parameter details without edit options.
- **Copying:**  
  Enables cloning parameter records to new keys.
- **Deleting:**  
  User confirms; program may delete just one or all matching records depending on context/detail mode.
- **Printing/Export:**  
  Several routines support parameters for statistical printing/export (handled by called subprograms like `SI610C`, `SI620C`).

---

## Table Reference (at bottom of source)

Shows the codes (like 11 = Hovedgruppe, 13 = Rabattgrp) which are used for selection, grouping, and filtering options.

---

## Summary

This program is a classic green-screen RPG application for interactive maintenance of a parameter file with rich options for searching, filtering, selection, and reporting, including subfile management, multiple screens, user action routing by indicator, and external subprogram calls for specialized selection/grouping.

The code is structured around a main loop of screen display and user command handling, with modular routines for each type of parameter operation.

---

### Onboarding Tips

- **Start** by reviewing the data files and the display file (`SR100D`).
- **Familiarize** yourself with the subfile handling: The add/change/delete/copy/print flows are repeated but with different layouts/screens and file interactions.
- **Pay attention** to the key lists (`KLIST`) and data structure overlays—they are crucial for navigating and updating the parameter records.
- **Remember** that most of the business rules (e.g., valid selection codes, screening for firm) are implemented procedurally in the C-spec code.
- **External program calls** (for selections/groups) are handled via `CALL` and `PARM`.

---

For further development or maintenance, first check the relevant subroutine (by code or screen), then trace the data flow through the associated variables and file operations. This will help navigate the relatively complex interactions resulting from the flexible parameter structure and its many actions.