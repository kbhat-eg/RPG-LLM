# RPG Source Code Explanation

This RPG (Report Program Generator) program is written in the IBM ILE RPG (possibly RPG IV or RPG/400) language and is responsible for producing a control list printout of factoring records. The code is annotated in Norwegian and includes both business and technical comments. Below is a breakdown of its key components:

---

## 1. **Header Specifications**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `option(*nodebugio)`: Disables debug I/O support for faster performance.
- `datedit(*dmy)`: Sets date editing to day-month-year format.

---

## 2. **File Declarations**

```rpg
frkwbl2    if   e           k disk    rename(rkwbpfr:rkwbl2r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frk682p    o    e             printer oflind(*in30)
```
- `frkwbl2`: Input file, keyed, external, disk file, renamed format.
- `frkunl1`: Input file, keyed, external, disk file, renamed format.
- `frk682p`: Output printer file, external, writes report, page overflow indicated by *IN30.

---

## 3. **Data Declarations**

### Standalone Fields and Arrays

```rpg
d sub             s              3  0 dim(13)
```
- Defines `sub` as a 13-element array of 3-digit integers.

### User Data Structure (Commented As UDS)

```rpg
d                uds
d  pfirm                300    302  0
d  pnavn                303    332
d  puser                333    342
d  pparam               300    490
```
- Data structure starting at byte 300, mapping out fields like firm number (`pfirm`), name, user, and parameters.

### More Standalone and Like Fields

```rpg
d  l_wsid               901    910
d  l_user               911    920
d  l_fgrp               931    933
d  l_firm               944    946  0
d  l_fnav               951    980
d w_bdat          s              6  0
d w_fdat          s              6  0
d wkjdat          s              6  0
d w_firm          s                   like(rnfirm)
d w_kund_gml      s                   like(rnkund)
d rkunl1_kund     s                   like(rnkund)
d w_forp          s             11  2
d w_fort          s             11  2
d w_alf9          s              9
d w_al11          s             11
d n               s              3  0
```
- These are working variables for business logic (dates, customer numbers, amounts, etc.), some based on external record format fields (`like()`).
---

## 4. **Main Procedure Logic**

### File Positioning and Reading Loop

```rpg
c     rkwbl2_key    setll     rkwbl2r                                61
c     rkwbl2_key    reade     rkwbl2r                                61
```
- Set lower limit and read using the keyed field from `rkwbl2r`.

```rpg
c                   dow       *in61 = *off
```
- Loop until end of file indicator (*IN61) is set.

### Customer Number Break Processing

```rpg
c                   if        rnkund <> w_kund_gml
  ...
c                   eval      w_kund_gml = rnkund
c                   endif
```
- Checks if the customer number has changed (break logic).
- On first occurrence, processes and writes customer header information.

### Customer Master File Chain

```rpg
c                   eval      rkunl1_kund = rnkund
c     rkunl1_key    chain     rkunl1                             10
```
- Uses the current customer number to chain into customer master file and retrieve customer details.

### Page Overflow Handling

```rpg
c                   if        *in30 = *on
c                   write     a1hdr
c                   eval      *in30 = *off
c                   endif
```
- On page overflow, output page header and reset the overflow indicator.

### Date and Amount Calculations

```rpg
c     *dmy          move      rnbdat        w_bdat
c                   if        rnfdat <> *loval
c                   eval      *in35 = *off
c     *dmy          move      rnfdat        w_fdat
c                   else
c                   eval      *in35 = *on
c                   endif
```
- Moves date fields from record formats to work fields, utilizing date edit.
- Sets indicators based on due date.

### Company/Personal ID Handling

```rpg
c                   move      rkftnr        w_alf9
c                   move      rkpenr        w_al11
c                   if        rkftnr <> 0
c                   eval      w_komm = 'F.nr: ' + w_alf9
c                   endif
c                   if        rkpenr <> 0
c                   eval      w_komm = 'P.nr: ' + w_al11
c                   endif
```
- Formats and stores business or personal ID for output if present.

### Accumulating Sums and Writing Details

```rpg
c                   eval      w_forp = w_forp + rnrest
```
- Accumulates the residual amount for the customer.

```rpg
c                   write     d1det
```
- Writes record details to the output.

#### Loop Continuation

```rpg
c     rkwbl2_key    reade     rkwbl2r                                61
```
- Reads the next record in the loop.

---

## 5. **End of Report and Cleanup**

```rpg
c                   move      *on           *inlr
c                   write     t1tot
```
- Sets last record indicator and writes the total line.

---

## 6. **Initialization Subroutine (`*inzsr`)**

```rpg
c     *inzsr        begsr
  ...
c                   write     a1hdr
c                   endsr
```
- Sets up keys for input files.
- Initializes variables and output by writing the report header.

---

## 7. **Summary of Program Flow**

- **Initialization:**
  - Prepare file keys, initialize variables, write report header.
- **Main Loop:**
  - Read each factoring record.
  - On customer change, output customer header.
  - Fetch customer details from master file.
  - Format data (dates, IDs).
  - Accumulate totals.
  - Handle page overflow.
  - Write detail lines.
- **End:**
  - Write total summary.
  - Set program completion flag.

---

## 8. **Special Notes**

- Indicators (e.g., *IN30, *IN61) control flow and printing logic.
- Norwegian comments guide business rules and document changes.

---

## 9. **Key Terms**

- **setll / reade**: Position/read a record by key.
- **chain**: Random access to a keyed file.
- **move/eval**: Assign or calculate values.
- **write**: Output records (to printer).

---

**This program is typical of RPG reporting applications, combining file IO, page and record formatting, business rule handling, and summary calculations.**