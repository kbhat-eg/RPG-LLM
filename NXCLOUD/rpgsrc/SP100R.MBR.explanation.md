# RPG Source Code Explanation — "ASSTAT Vedlikehold av parameterfil" (Program: SP100R)

This RPG program is a classic ILE RPG/400 application designed for IBM i ("AS/400") systems, used for maintaining a parameter file (`PARAMETER-REGISTER`). It is part of the "ASSTAT" system, which seems to be a statistics or reporting system, perhaps used for sales or inventory, based on field names and documentation.

The application heavily leverages subfiles for display and user interaction, and it supports a variety of operations including creating, changing, deleting, viewing, and printing parameter records.

Below are the key architectural and functional explanations:

---

## **1. General Overview**

- **Purpose:** Maintenance of a parameter file for the ASSTAT system.  
- **User Interface:** Uses workstation file (`sp100d`) with subfile support (SFL) for record maintenance.  
- **Key Functions:** Create, update, delete, copy, display, print parameters; handle selection, sorting, and summaries.

---

## **2. File Declarations**

- **sp100d:** Workstation display file using a subfile (b1sfl).
- **ausrl1:** User file (probably for user details).
- **skpml1/skpmlu:** Main parameter register files (disk), with different record formats and purposes (main, update, copy, etc.).

---

## **3. Data Structures and Variables**

There are several data structures for:

- **Tabular messages (`mld`)** and **reference tables (`rpt`, `ref`, `rap`)** for field labels and value mappings.
- **User and firm identifiers (`l_user`, `l_firm`, etc.).**
- **Work variables** for subfile row numbers, counters, detail flags, copy/source types, etc.
- **Parameter record buffer structures (`wwrest_00`, `wwrest_41`),** containing all parameter fields for manipulation and screen display.

---

## **4. Processing Flow (Control Section)**

### **A. Main Entry and Navigation**

- The application is menu- and screen-driven, using `goto` and `tag` statements for control flow, typical for green screen applications.
- User choices (b2valg, b2type) determine navigation (create, copy, delete, view, print, etc.).

### **B. Subfile Maintenance**

- **Filling the Subfile:**  
  The `xcrt01` subroutine reads all matching records (by firm, type, etc.) from the parameter register and writes them into the subfile for display.
- **Clearing the Subfile:**  
  `xclr01` resets all subfile counters, clearing old entries.

### **C. "Open/Opening Screen" Processing (`B2BLD`)**

- Responds to function keys, selection fields, and menu choices.
- Handles details toggle, refresh (renew), record creation, rolling subfile pages, setting home position, and positioning on specific keys.

### **D. Subfile Row Actions**

- For each subfile record, the user can choose to change (2), copy (3), delete (4), view (5), print (6), make selection (7), sort (8), or summarize (9).
- Each choice invokes an appropriate subroutine or branch of logic.

### **E. Detail Screens and Subroutines**

- **C1BLD:** For new record creation.
- **C2BLD:** For changing/showing record details.
- **C3BLD:** For sorting order selection.
- **C4BLD:** For specification/summarization.
- **C5BLD:** For selection/filters.
- **D1WIN:** For deletions.
- **K1WIN:** For copying records.
- **P0WIN - P3WIN:** For printout configuration and printing.

### **F. External Calls**

- Certain operations (like printing reports, parameter selection, sub-routines for customer, product, department selection, etc.) are managed by calling external RPG programs (e.g., 'SF610C', 'SP121R', etc.)

---

## **5. User Input Handling**

- **Function Keys:**  
  Conditional logic is used to check function key indicators (`*inkc`, `*inkl`, etc.) and respond accordingly (e.g., cancel, refresh, options).
- **Selection Fields:**  
  User entries in subfile option columns trigger various actions based on the value (2=change, 3=copy, etc.).

---

## **6. Data Integrity and Validation**

- Consistent use of **setll, chain, reade** for keyed file I/O, ensuring that only the correct records are manipulated.
- Record existence checks are performed before attempting updates, deletes, or copies.
- When copying, the program checks that the target parameter does not already exist.

---

## **7. Key Subroutines and Their Roles**

### **Initialization (`*inzsr`)**

- Sets up key structures, loads reference tables, and pre-populates the subfile with current firm parameters.

### **Display, Print, Copy, and Delete Subroutines**

- Each has dedicated logic blocks for reading, presenting, and maintaining parameter records, often with feedback to the user via screen fields.

### **Subfile Page Management**

- Handles page up/down, home/end, and proper updating of page counters.

---

## **8. Auxiliary Tables ("TABELLER")**

- At the end of the program are static mappings of codes to their descriptive meanings. These are used for:
  - Option codes for actions (e.g., 001=New, 002=Change, 003=Show, etc.)
  - Sort and filter codes (e.g., 11=Alt. hovedgruppe, 21=Kundekategori, etc.)
  - These mappings are used when calling other programs or updating parameter records.

---

## **9. Comments and Version History**

- The code is well-documented (in Norwegian), with clear version history and comments indicating major changes (e.g., adaptation for new GUI versions, handling of special parameter codes, etc.).

---

## **10. Highlights & Notable Points**

- The program is modular, using many subroutines for maintainability.
- It is designed for extensibility; new selection and report codes can be added with minimal change.
- Many standard green screen UI paradigms are present: function-key navigation, subfile actions, confirmation dialogs.
- Strong use of keyed access for both display and update/copy/delete scenarios.
- Comments indicate a mature, production-grade system maintained over many years.

---

## **Summary Table: Key User Operations**

| Action   | Option Key | Description                      | Subroutine  |
|----------|------------|----------------------------------|-------------|
| New      | 1          | Create a new parameter           | c1taga/c1bld|
| Change   | 2          | Change parameter                 | xc2bld      |
| Copy     | 3          | Copy parameter                   | xk1win      |
| Delete   | 4          | Delete parameter                 | xd1win      |
| Show     | 5          | View parameter                   | xc2bld      |
| Print    | 6          | Print selection/statistics       | xp0win, etc.|
| Filter   | 7          | Filter parameter                 | xc5bld      |
| Sort     | 8          | Sort parameter                   | xc3bld      |
| Summarize| 9          | Summarize parameter              | xc4bld      |

---

## **Takeaways for New Developers**

- **Familiarize yourself with subfile operations in RPG:** Lots of logic revolves around reading, updating, and navigating subfiles.
- **Pay attention to field mapping:** Data structures mirror the file layouts, and small errors can lead to incorrect updates.
- **Understand the selection/sorting/summarization codes:** These drive a lot of the functionality and tie directly to external routines.
- **The application is function-key driven:** Know which function key does what.
- **You may need to trace external program calls** (`CALL 'SF610C' ...` etc.) for the full business logic.
- **If you do not read Norwegian:** Run variable and comment names through translation — the code is well commented if you do!

---

## **Typical Use Cases**

- Selecting a parameter group to maintain
- Viewing existing parameters for a firm/type
- Creating a new configuration for sales/statistics
- Deleting, copying, or updating parameter definitions
- Sorting/filtering parameter records for reporting
- Printing reports/statistics based on selection

---

**This program is an excellent example of classic green-screen business application architecture on IBM i, using all the standard RPG techniques for subfile processing and multi-screen data maintenance.**