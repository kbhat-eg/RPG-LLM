# Program Overview: RP100R – Project Maintenance

This program, written in ILE RPG for IBM i (AS/400), is a project maintenance module. It manages projects and related data such as subprojects, activities, budgets, project leaders, clients, and various project-related codes. RP100R interacts with database files, subfiles (for screen lists), and calls multiple external programs for further editing, lookups, and reporting.

## Structure & Files

- The program uses multiple physical files (e.g., `rp1pl1`, `rp1pl2`, ...), all seemingly describing different indexes or aspects of the primary project file (`rp1ppfr`).
- Various other files provide support for users, clients, codes, and financial records.
- The display file (`rp100d`) defines screens (standard subfile setup) and has data structures for DSPF feedback (cursor location, etc.).

## Main Logic Flow

### Initialization (`*inzsr`)

- Loads parameters for positioning (if any).
- Sets up keys (KLISTs) for various indexed access.
- Retrieves user’s default department and project leader (if found).
- Calls an authorization program (`AD005R`) to check if the user can override default department/leader.
- Builds the initial subfile (list of projects).

### Main Loop

- If program is called with specific parameters (e.g., a starting date), it immediately skips to project creation (subroutine `xc1bld`).
- Handles moving into subproject or activity maintenance if flags are set, via calls to `RP110R` or `RP120R`.
- Standard interactive loop for handling function keys, command keys, and subfile selection.
- Calls `dsp_subfile` to display the main list of projects.

### Function Keys and User Actions

- **F3 / F12**: Exit program.
- **F5**: Refresh/renew subfile.
- **F6**: Add new record (calls subroutine `xc1bld`).
- **F7...F10**: Varying reporting and data views.
- **Home**: Cursor positioning.
- **Selection fields**: Filtering by active projects, department, project leader, etc.

### Subfile Handling

- Subfile contains a list of projects. The user can select:
    - 1: Status
    - 2: Edit
    - 3: Copy
    - 4: Delete
    - 5: View
    - 6: Print report
    - 7: View order lines
    - 8: View transactions
    - 9: View purchase orders

### Subroutines

#### `forny` (Renew/List Refresh)
- Positions to the correct file/index based on search criteria.
- Clears and rebuilds the subfile.

#### `posisjoner` (Subfile Positioning)
- Sets start position for project, description, department, or project leader.
- Rebuilds subfile accordingly.
- Clears search input fields.

#### `subfile` (Handle Subfile Selections)
- Reads subfile for user selections and processes actions (status, edit, copy, delete, view, report, etc.).
- After edits, may trigger navigation into subprojects/activities.

#### `xc1bld` (Create New Project)
- Handles creation of a new project record.
- Supports automatic allocation of project numbers.
- Checks for existing projects to avoid duplicates.
- Calls the main edit subroutine for actual data entry.

#### `xc2bld` (Edit/View Project)
- Loads project record for edit/view.
- Supports lookups (project leader, department, client, project type, budget, etc.).
- Validates input: mandatory fields, existence checks, correct status codes.
- Updates or creates the project record (with audit trail fields).
- Also updates corresponding records in related files.

#### `getbudsj` (Aggregate Budget)
- Calculates budget by summing over subprojects or activities as needed.

#### `xc3bld` (Print Project Report)
- Gathers report parameters from user and calls the appropriate report program.

#### `reddato` (Date Editor)
- Cleans and formats user-entered dates.

#### `xd1win` (Delete Window)
- Handles deleting a project, with checks for dependent transactions.

#### `xk1win` (Copy Window)
- Facilitates copying a project by prompting for a new key and running through the edit routine.

#### `clr_subfile` and `crt_subfile`
- Clear and refill the display subfile with project data, applying active filters and performing text search.

#### `dsp_subfile`
- Handles displaying the subfile list.

#### `finn_sum`
- Aggregates financial totals (income, expenses, etc.) for a project using related files and codes.

## Key Techniques and Features

- **Subfile Processing**: A core pattern for interactive lists on IBM i screens.
- **Indexed Access & KLISTs**: Efficient file access using multiple indexes for various search/filter operations.
- **External Program Calls**: Standard approach on IBM i for code reuse (lookup windows, reports, etc.).
- **Validation & Error Handling**: Checks for required fields, referential integrity, status codes, etc.
- **Audit Trail**: Maintains created/changed timestamps and users.
- **Parameter-Driven Navigation**: Program can be entered "in the middle" by other programs or menu functions.

## Notable Customizations (as per version comments)

- Support for project categories.
- Automatic project number allocation.
- Integration with other modules for subprojects/activities.
- Flexible project leader sourcing (from leader or salesperson, depending on config).
- Context-sensitive function key handling and error message display.
- Various auxiliary features (client/order lookups, security checks, etc.).

## Variables and Data Structures

- **Local Data Area** (`l_user`, `l_firm`, etc.): Used for passing environment/user info.
- **Display Feedback DS** (`dspfbk`): Gets cursor position and screen feedback.
- **Work Fields**: Many fields for tracking state, subfile pointers, search criteria, etc.
- **Selection/Filter Fields**: For department, project leader, activity, status, etc.
- **Constants**: For special values, subfile page size, and character translation (lower/upper case).

## Indicator Usage

- Indicators are heavily used for managing screen flow, user options, error signaling, and process state.
- Comments describe standard indicator assignments for F-keys, subfile control, messaging, etc.

## Typical User Flow

1. User sees a filtered list of projects.
2. User can filter/search, select, or create (add) projects.
3. Upon selecting/adding, the user enters/edit project details (with lookups and validations).
4. Projects can be copied, deleted, or have subprojects/activities managed.
5. Financial summaries and reports are available via function keys.

## Error Handling & Messages

- Several input conditions set special indicators to alert the screen (e.g., required fields, invalid codes).
- Calls to `AA007R`, `AA005R`, etc., display messages and warnings.

## Extensibility

- Many routines are versioned and commented for business-specific logic.
- The code suggests ample hooks for integrating into a larger suite (HR, finance, order, etc.).

---

### For Onboarding RPG Developers

- **Understand Subfile Programming**: This code is a classic example.
- **Become familiar with key lists (KLIST) and indexed file access**.
- **External program (CALL) integration is crucial in IBM i ecosystems**.
- **Indicators drive almost all UI flow and error states**.
- **Read comments (“Ref.” and in-line) for business rule context**.

---

### Useful Entry Points

- The `*inzsr` routine shows startup logic and how defaults are retrieved from user profiles.
- The main C-specs after initialization form a classic interactive menu and subfile loop.
- Subroutines (`begsr/endsr`) are modular, each handling one aspect of project management (list, edit, report, etc.).

---

**Summary:**  
RP100R is a comprehensive RPG application for project maintenance, providing interactive management, validation, subproject/activity support, budget handling, reporting, and integration with other modules. Despite procedural and indicator-driven style, its modular subroutines and clear comments make it a solid IBM i maintenance module.