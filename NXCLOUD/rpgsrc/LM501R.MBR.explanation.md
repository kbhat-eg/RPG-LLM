# RPG Program Explanation: LM501R (Retrieve Last Log Code)

---

## Overview

- **System:** ASOFAK  
- **Program:** LM501R  
- **Purpose:**  
  - Reads a log file to retrieve the last log code for a specific firm, number, and suffix.
  - Returns both the code and its textual description (from a code table).
- **Modifications:**  
  - 6.20: New program (bsa)
  - 6.30: Adjustment for number expansion (bof)
- **Indicator Usage:**  
  - LR: End program
  - 80-99: Working indicators

---

## File Declarations

```rpg
fllogl3    if   e           k disk    rename(llogpfr:llogl3r)
flloglr    if   e           k disk    rename(llogpfr:lloglrr)
fllokl1    if   e           k disk    rename(llokpfr:llokl1r)
```

- **llogl3:** Main log file (renamed from physical file llogpfr).
- **lloglr:** Log details (renamed from llogpfr).
- **llokl1:** Log code descriptions (renamed from llokpfr).

---

## Parameter Definitions

```rpg
d p_firm          s                   like(lmfirm)
d p_numm          s                   like(lmnumm)
d p_suff          s                   like(lmsuff)
d s_logk          s                   like(lmkode)
d p_logk          s                   like(lmkode)
d p_lbes          s                   like(lntext)
```

- **p_firm:** Input: Firm/Company identifier.
- **p_numm:** Input: Number (likely a unique key or document number).
- **p_suff:** Input: Suffix.
- **s_logk:** Work variable for the log code found.
- **p_logk:** Output: Last log code found.
- **p_lbes:** Output: Description text for the log code.

---

## Key/Work Variables

Variables for use in keyed operations (*setll*, *reade*, *chain*), mirroring fields in the files.

---

## Main Logic

### 1. Initialize for Log Search

```rpg
c                   eval      llogl3_date = *loval
c                   eval      llogl3_time = *loval
```
- Set date and time to "lowest value" to start reading from the beginning.

### 2. Position and Read through Log Records

```rpg
c     llogl3_key    setll     llogl3
c     llogl3_kel    reade     llogl3
c                   dow       not %eof(llogl3)
   ... // save code
c     llogl3_kel    reade     llogl3
c                   enddo
```
- **setll llogl3_key llogl3:** Position log file by key (firm, number, date, time).
- **reade llogl3:** Start reading log entries for this firm and number.
- **Loop:** For each record found:
  - Save last log code found (`s_logk`, `p_logk`).
  - Continue until end-of-file for key range.

### 3. Get Description Text from Code Table

```rpg
c                   eval      p_lbes = *blank
c                   if        s_logk <> *blanks
c                   eval      llokl1_type = s_logk
c     llokl1_key    chain     llokl1r
c                   if        %found
c                   eval      p_lbes = lntext
c                   endif
c                   endif
```
- If a log code is found (not blanks):
  - Use it as key into code-description file (`llokl1`).
  - **chain**: Retrieve description if code is found.
  - Set output `p_lbes` accordingly.

### 4. Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Standard shutdown: Set LR (last record indicator) to finish program and return.

---

## *INZSR Initialization Subroutine

- **Handles initial parameter, variable, and key list setup.**
- **Parameter List:** Declares the order and purpose of entry parameters.
- **Key Lists:** Prepares key lists for subsequent file operations.

```rpg
c     *inzsr        begsr
   ... // parameter list and key list definitions
c                   eval      w_firm = p_firm
c                   eval      llogl3_numm = p_numm
c                   eval      llogll_numm = p_numm
c                   eval      p_logk = *blanks
c                   eval      p_lbes = *blanks
c                   endsr
```

- Copies input parameters into local work variables.
- Initializes output parameters (`p_logk`, `p_lbes`) to blanks.

---

## Key List Explanations

Each *klist* block defines the sequence of fields used as a composite key for *setll*, *reade*, *chain*, etc. They match logical access paths in the DDS or DDL of the files.

---

## Summary of Program Flow

1. **Accept Input:** Firm, number, suffix.
2. **Find All Log Entries:** For that firm and number.
3. **Save Last Code:** As you read through, remember the last log code found.
4. **Look Up Code Description:** In the code table.
5. **Return:** The last log code and its description as output parameters.

---

## Business Use Case

When you want to know the last (most recent) log code and its description for a given entity (firm + number), call this program with the relevant parameters. It returns the code and its human-readable meaning (if available).

---

## General Notes

- **No Debug I/O:** Specified via `h option(*nodebugio)`.
- **Date Editing:** Dates handled with day/month/year format (`datedit(*dmy)`).
- **Old-Style RPG IV Free/Form:** Logic is coded in C-specs, not fully free-form.

---

## Onboarding Tips

- Look up the DDS/DDL for the logical files (llogl3, lloglr, llokl1) to understand record layouts and keys.
- Understand the parameter passing convention: This program is meant to be called from another program or perhaps a CL job.
- The main logic is a single loop (read all records for the key, keep the latest code).
- Key lists, parameter setup, and variable naming all focus on clarity and extendability.

---