# RPG Program IT111R – Customer Information Update

This RPG program, `IT111R`, is designed to update customer information from NAV (likely a system or external source). The program supports inserting, updating, or deleting customer records in the `rkunlu` physical file. Below is a breakdown and explanation of the code and its various sections.

---

## Program Structure and Flow

### Header and Metadata

- **H-Specs**  
  ```
  h option(*nodebugio) datedit(*dmy)
  ```
  - Sets program options: disables debug IO, date format is Day-Month-Year.
- The source code contains a comment block that documents the program and its change history.
- The program language is Norwegian (for variable naming and comments).

### File Declarations

- **File Definition:**  
  ```
  frkunlu    uf a e           k disk    rename(rkunpfr:rkunlur)
  ```
  - File `rkunlu` is defined as update-capable, keyed, externally described, and renamed in program to `rkunlur`.

---

## Data Structures and Variables

### Parameters

- Defined as stand-alone fields (these are incoming parameters):
  - `p_firm`: Company code (like the file field `rkfirm`)
  - `p_comd`: Command ('INSERT', 'UPDATE', 'DELETE')
  - `p_parm`: Parameter block – contains all customer fields (2048 chars)
  - `p_user`: User name
  - `p_stat`: Status flag (returned)

### Key Variables

- `rkunlu_kund`: Customer number (key field for I/O operations), same type as file field `rkkund`.

### Data Structure for Parameters

- **`d_parm` DS**: This data structure overlays `p_parm` and breaks it into named subfields (such as `d_kund`, `d_navn`, `d_adr1`, etc.), each corresponding to customer master data fields.

### Working Variables

- Multiple variables for dates, keys, credit limits, etc.

---

## Main Program Logic

### Initialization

- The *INZSR subroutine acts as the entry point, processing the parameter list and setting up the key list for file access. It retrieves the current date and time for record timestamping.

### Blank-to-Zero Conversion

The code loops through all numerical fields in the `d_parm` data structure, converting blank fields to zeroes using the `xlate` operation. This ensures that numeric-convert operations don't fail due to blank values (common when mapping from external APIs or flat files).

### Parameter Field Extraction

- **Customer Number:**  
  ```
  eval w_kund = %dec(d_kund:6:0)
  ```
  Converts the 6-character `d_kund` field to numeric (customer number).

- **Credit Limit:**  
  Parses field `d_kreg` for a possible minus sign (negative value). Extracts the number portion and converts it to a numeric value. The credit limit is divided by 1000 (`w_kgrn = w_kgrt / 1000`) – possibly to store in thousands.

### Command Processing

- Uses RPG's `select/when/endsl` construct to determine which operation to perform based on `p_comd`:
    - `'INSERT'` or `'UPDATE'`: Calls `NyEndrK` subroutine (add/change customer).
    - `'DELETE'`: Calls `sletkund` subroutine (delete customer).

### Ending the Program

- Sets on `*INLR` (last record indicator) and returns to caller.

---

## Subroutines

### NyEndrK (Add/Update Customer Record)

1. **File Positioning and Key Setup**
    - Sets working fields and chains to the customer record using the key.
2. **Field Population:**  
    - Assigns fields to the customer record structure from the parameter data structure or working fields.
    - Special logic: If `d_land = 'NO'`, sets country code blank (likely because 'NO' is the default).
    - Some fields (like flags) are handled with conditional logic.
    - If record does not exist (`not %found(rkunlu)`), fills additional fields and writes a new record.
    - Otherwise, updates the existing record.

### sletkund (Delete Customer Record)

- Chains to the customer record; if found, deletes it.

### *pssr (Error Routine)

- Sets status to blank, signals program end.

### *inzsr (Initialization Subroutine)

- Handles parameter passing, key list setup, and captures current date/time for record stamping.

---

## Key Programming Techniques / Highlights

- **Parameter Passing:**  
  Uses RPG's classic parameter list style for calling from other programs.

- **Dynamic Data Structure Mapping:**  
  Uses a fixed-length char parameter (`p_parm`, 2048 bytes) mapped to a structured DS (`d_parm`) for individual field access.

- **Blank-to-Zero Cleansing:**  
  Before converting char fields to decimal, ensures that only valid digits are present.

- **Upsert Logic:**  
  Uses RPG's `chain` followed by either `write` (if not found) or `update` (if found), allowing a single code path for both insert and update.

- **Date and Time Stamping:**  
  On every customer record change, the record's date/time and user are updated.

- **Special Field Handling:**  
  For some fields like country, division, and certain flags, business rules are embedded (e.g., do not update division if a special invoice code is set).

---

## What a New Developer Should Know

- **Interface:** Called by passing company code, command, parameter data block, user, and a status flag.
- **Extensibility:** To add new fields, update `d_parm` and related logic in `NyEndrK`.
- **Data Conversion:** Key logic exists to convert external (API/flat file) customer data into the internal format expected by the `rkunlu` file; maintain this with care.
- **Error Handling:** Minimal, handled via a single error subroutine (`*pssr`). Consider enhancing for richer error feedback.
- **Testing:** Since many operations depend on field positions within `p_parm`, ensure any upstream system matches the RPG's expectations.

---

## Summary of Responsibilities

- Receives a parameter block with all customer information.
- Cleans and prepares that information for database operations.
- Inserts, updates, or deletes customer records in the customer master file based on the command.

---

## Reference Table: Common Fields in d_parm

| Field Name | Meaning | Usage in Program |
|------------|--------|------------------|
| d_kund     | Customer number | Used as key |
| d_navn     | Name   | Customer master name field |
| d_adr1     | Address 1 | Main address line |
| d_ponr     | Postal number | Used for city info |
| d_pste     | City/Post office | Appended to postal number |
| d_land     | Country | Blank if 'NO', otherwise assigned |
| d_fort     | Corporate number | Converted to numeric |
| d_valk     | Currency code | Assigned directly |
| d_kreg     | Credit limit | Special string processing |
| ...        | ...    | ... |

---

## Conclusion

This RPG program is a classic ILE RPG batch-style handler for maintaining customer master data on the IBM i platform. It is modularly organized, easy to extend, with clear entry points and business logic. It expects strictly well-formatted input and has basic error handling.

---

**Tip for getting started:**  
Focus on understanding the data structure mappings and the subroutine `NyEndrK` for update/insert logic. For debugging, you may want to insert temporary dumps or logging, since *NODEBUGIO disables interactive debugging of file I/O.