# RPG Program RP140R - Overview and Explanation

This RPG/400 (ILE RPG) program is part of an IBM i system and is focused on project budgeting per account ("Prosjekt, Budsjett pr konto"). It is designed to allow users to view, edit, and manage budgeting details by project/account on a subfile-based display. The code is well-commented in Norwegian and employs classic subfile, keyed file, and screen handling patterns. 

Below, the code is broken down into its major parts, with explanations for key features, logic, and flows.

---

## 1. **Header and Program Options**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- The source is compiled *without* debug IO and uses *day-month-year* date editing.

---

## 2. **Documentation/Change Log**

- The initial block is developer documentation, with program name, description, and a detailed change log denoting enhancements, bug fixes, and authors, along with dates.

---

## 3. **Indicator Usage**

- Special indicators (LR, *INxx) are mapped to functional actions (End program, Roll, protect fields, etc.), including error and work indicators.

---

## 4. **File Declarations**

```rpg
frpval3    if   e     k disk    rename(rpvapfr:rpval3r)
...
frp140d    cf   e       workstn sfile(b1sfl:w_srrn)
```
- Several database files are referenced, using external definitions, `rename` for record format aliasing.
- The display file is declared with a subfile (b1sfl) for screen management.

---

## 5. **Data Area and Local Data Declarations**

```rpg
d                uds
d l_pros                101    106
...
d l_firm                944    946  0
```
- The *User Data Space* (UDS) is mapped for data sharing/persistence across programs. Specific positions indicate prosjektnr, brukernavn, firmakode, etc.

---

## 6. **Parameter Definitions**

```rpg
d p_firm          s     like(rpvfir)
...
d p_text          s     like(b1text)
```
- These variables will be passed into the program (from a calling program/menu/process) and represent firm, project, subproject, activity, account, etc.

---

## 7. **Work Variables and Key Variables**

```rpg
d w_buds_alt      s     1 inz('T')
...
d w_srrn          s     4  0
```
- Variables for paging, subfile navigation, selection, budgeting options (`w_buds_alt`), etc.
- Key variables are defined for locating records in physical/indexed files.

---

## 8. **Prototypes and External Procedure Calls**

```rpg
dcl-s co402_verdi1  char(1);
dcl-s co402_verdi2  char(2048);
DCL-PR CO402R EXTPGM('CO402R');
...
```
- Modern /free format declarations for calling external programs (CO402R), which provides configuration ("budsjett alternativ").

---

## 9. **Main Processing Loop**

The mainline processes function keys (F-keys), displays the subfile, and performs selection logic. It uses tags and `goto` blocks for navigation (common in classic RPG).

### a. **Screen and Function Key Handling**

- **Display/refresh subfile:** Subroutine `dsp_subfile`, `crt_subfile`, `clr_subfile`.
- **Function keys:** 
    - F3/F12 → exit (goto avslutt)
    - F5 → refresh (forny)
    - F6 → call NO100R to process external order (now commented out/disabled in 7.01)
    - F10/F11 → subfile paging (roll up/down)
    - F21 → home key, sets cursor
    - F20/W/X/Y → select budget display mode (`w_buds_alt`)
    - F9 → query account (calls RH500R)
    - F4/F5 → show or delete records, open detail (calls RP145R), update selection and refresh

- **Branching:** Uses `goto` and tags such as `b2taga`, `b2tagb` to control main loop.

### b. **Selection and Positioning**

- Positioning by account number or description, with respective subroutines and key lists.
- If a position is requested, the subfile is cleared/refilled, and screen fields reset.

---

## 10. **Subroutines**

The program uses classic fixed-form `c-spec` subroutines for:

### a. **forny** (Refresh)
- Repositions the file pointer (`setll`), clears and refills the subfile with data for the selected project/account.

### b. **posisjoner** (Position)
- Allows positioning the subfile by account or text, resets the subfile accordingly.

### c. **subfile**
- Core loop for subfile record processing.
- Reads changed records (`readc`), processes selections:
    - **4 = Delete** - deletes the record from budgeting, logs the event
    - **5 = View** - opens RP145R to show details
    - **9 = Inquiry** - calls RH500R to look up account, updates subfile
    - **Budget update** - if budget value changed, writes update, logs the event

### d. **clr_subfile**
- Blanks the subfile for a new page.

### e. **crt_subfile**
- Fills subfile page with current data. Includes:
    - Read record(s) for the specified account/project
    - Summing budgeted/actuals
    - Fetch account name (kontoplan)
    - Writes data to subfile
    - Fills blank rows to end of page

### f. **HentKost** (Fetch Cost)
- Totals all budgeted costs for the current project/criteria.

### g. **bck_subfile**
- Handles back paging with `readp` (read previous records).

### h. **dsp_subfile**
- Sets up and displays the subfile (write/exfmt to display file).

### i. ** *inzsr ** (Initialization Subroutine)
- Handles program entry point, receives parameters, initializes keys, fetches descriptions for project/subproject/activity, sets up the subfile, and loads the first page.

---

## 11. **Special Concepts and Features**

- **Budget Alternatives:**  
    - Controlled by `w_buds_alt` (T=Total, K=Per Account, V=Per Line).
    - CO402R external program is called at startup to determine default budgeting granularity.

- **Key Lists:**  
    - Multiple key lists are defined for chaining/setting file pointers for performance and accuracy.

- **Audit Logging:**  
    - Actions like budget updates/deletes are logged into SLOGLU for traceability.

- **Subfile Navigation:**  
    - Classic subfile paging, with logic for current/first/last shown record, blank-lining, and dynamic page sizing.

---

## 12. **Screen Field Documentation**

- Extensive comments explain the meaning and intent of fields like w_stel (subfile counter), w_srrn (relative record), w_forny, etc.

---

## 13. **Error, Exit, and Work Indicators**

- Error handling, update confirmations, and interactive message popups are handled by calling standard subroutines (like AA007R for "do you want to update cost?").

---

## **Summary/Typical Usage Flow**

1. **Program Entry:** Receives project/account info as parameters, initializes key variables, determines budgeting mode, loads account/project info into subfile display.
2. **Display Loop:** User interacts with the subfile:
    - Navigates pages, positions by account, queries account, views or deletes budget lines, or switches budget alternatives (total/account/line).
3. **Budget Edits:** If the user updates any budget, changes are written and logged.
4. **Exit:** Ensures any cost changes are offered to be committed, then ends program.

---

## **Who Should Read This?**

- **RPG Developers** onboarding to Norwegian project/accounting systems on IBM i, especially handling budgeting and subfile management.
- **Analysts/Users** wishing to understand how budgeting per account/project/subproject is supported on the platform.

---

## **Special Notes**

- The code shows a mix of classic RPG (fixed-form C specs) and newer /free enhancements.
- Some parts are commented out or marked obsolete by version tags (e.g., 7.01, 7.03), so always check for the actual `when` and flow in production.
- The subfile logic and refresh/positioning patterns are standard for IBM i green-screen applications.

---

**In summary:**  
RP140R is a robust, traditional RPG program that provides a subfile-driven interface for project budgeting, offering features for add/view/delete, navigation, configuration, and audit logging, all parameterized and modular for ease of enhancement and integration.