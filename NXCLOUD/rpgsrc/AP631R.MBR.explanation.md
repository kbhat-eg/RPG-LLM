# Program Documentation: AP631R – Bilagskode Archive Lookup

## Overview

**Program Name:** AP631R  
**System:** ASPGPL  
**Description:** Archive lookup and maintenance for "bilagskode" (voucher code).  
**Primary Function:**  
- Provides a subfile-driven interface for users to view, create, update, copy, and delete voucher codes (bilagskode) in an archive.
- Handles user interaction, subfile paging, and database operations for bilagskode records.
- Integrates with other modules for extended lookup and validation.

---

## File and Data Definitions

### Database Files

- **AKOBLR** (renamed `akoblrr`): Keyed, used for reading voucher codes (archive/lookup).
- **AKOBLU** (renamed `akoblur`): Keyed, used for updating voucher codes.

### Display Files

- **AP631D**: Workstation file. Uses a subfile (B1SFL, controlled by B2CTL) for list display and various screens for data entry and messaging.

### Data Structures

- **Local Data Area (LDA) fields**: Used for user, firm, and screen context.
- **Display Feedback Data Structure (`dspfbk`)**: Used for cursor positioning and display feedback.

---

## Business and Domain-Specific Logic

### Voucher Code (Bilagskode)

- Represents an accounting or transactional code used in business processes.
- Each voucher code record contains fields such as type, year, creation/modification dates, and user info.

### Subfile Usage

- The subfile (B1SFL) displays a pageable list of voucher codes.
- Supports standard paging (roll up/down), positioning, and direct record manipulation (edit, copy, delete, view).

### Screen Layouts

- **B1SFL**: Subfile record format.
- **B2CTL**: Subfile control record.
- **B2CMD**: Command key screen.
- **C1BLD**: Screen for entering a new voucher code.
- **C1MSG**: Message screen for duplicate detection.
- **C2BLD**: Maintenance screen for create/edit/view.
- **D1WIN**: Delete confirmation window.
- **K1WIN**: Copy voucher code window.

---

## Indicator Usage

- **LR**: End of program.
- **10/11**: Roll up/down.
- **12/13/14/15**: Subfile control (display, clear, end).
- **21/22**: Home key, cursor placement.
- **30**: Field protection when viewing.
- **31–79**: Error/warning indicators.
- **80–99**: Work indicators.

---

## Program Flow and Subroutines

### Main Loop

- **b2taga / b2tagb**: Main tags for command processing and subfile display.
- **dsp_subfile**: Displays the subfile or command screen as appropriate.
- **Function Key Handling**: Branches to relevant subroutines based on user input (create, edit, copy, delete, view, paging, etc.).
- **posisjoner**: Positions the subfile based on input values.
- **subfile**: Processes user actions on the subfile rows.

### Subfile Maintenance

- **clr_subfile**: Clears the subfile before repopulating.
- **crt_subfile**: Populates the subfile with records from the database, handling paging and record limits.
- **bck_subfile**: Handles paging backward in the subfile.

### Record Maintenance

- **xc1bld**: Handles the creation of a new voucher code. Includes duplicate checking and calls maintenance screen.
- **xc1msg**: Shows a message if a duplicate voucher code is detected.
- **xc2bld**: Handles edit/view of a voucher code. Validates input and performs update or insert as needed.
- **xd1win**: Handles deletion of a voucher code, with user confirmation.
- **xk1win**: Handles copying a voucher code, including validation and duplicate checking.

### Initialization

- **\*inzsr**: Initializes keys, retrieves context from LDA, positions and loads the initial subfile.

---

## Notable Design Decisions and Patterns

- **Subfile Paging**: Manual management of subfile record numbers, page sizes, and boundaries for efficient paging and positioning.
- **Indicator-Driven UI**: Heavily utilizes RPG indicators for both display control and error handling, following a strict convention.
- **Modular Subroutines**: Each logical operation (create, edit, delete, copy, paging) is encapsulated in its own subroutine for clarity and maintainability.
- **Duplicate Detection**: Before creating or copying a voucher code, the program checks for existing records and prompts the user.
- **Separation of Read/Update Files**: Uses separate logical files for reading (`AKOBLR`) and updating (`AKOBLU`) voucher code records.
- **Integration Points**: Calls out to external program `RA501R` for advanced lookup/validation of voucher codes.

---

## Interactions with Other Modules

- **RA501R**: Invoked for advanced voucher code lookup and validation, passing firm, voucher code, and description fields as parameters.

---

## Special Field and Variable Usage

- **w_fcrn, w_srrn, w_ssrn, w_spge, w_sfrn**: Subfile paging and record navigation control.
- **b1valg**: Indicates user action on a subfile row (edit, copy, delete, view).
- **b_forn**: Work indicator for subfile refresh.
- **b_oppr**: Indicates if the program is in create mode.
- **b_anul**: Used to abort creation after duplicate detection.

---

## Error Handling and User Feedback

- **Indicators 31–79**: Used for displaying specific error or warning messages.
- **C1MSG**: Special screen for duplicate record messages.
- **Input Validation**: All maintenance screens validate required fields and handle errors/feedback via indicators and messages.

---

## Summary of Key Subroutines

| Subroutine      | Purpose                                                           |
|-----------------|-------------------------------------------------------------------|
| forny           | Refreshes subfile after changes                                   |
| posisjoner      | Positions subfile on a specific voucher code                      |
| subfile         | Handles row-level actions (edit, copy, delete, view)              |
| xc1bld          | Handles creation of new voucher code                              |
| xc1msg          | Duplicate detection message handling                              |
| xc2bld          | Edit/view maintenance for voucher code                            |
| xd1win          | Delete voucher code with confirmation                             |
| xk1win          | Copy voucher code with validation                                 |
| clr_subfile     | Clears the subfile                                                |
| crt_subfile     | Populates the subfile with records                                |
| bck_subfile     | Handles paging backward in the subfile                            |
| dsp_subfile     | Displays the subfile or command screen                            |
| *inzsr          | Program initialization and context setup                          |

---

## Integration and Extensibility Notes

- The program is designed to be extensible for additional voucher code types or business logic by adding new subroutines or expanding existing ones.
- The modular subroutine structure and consistent indicator usage make it straightforward to maintain or enhance.
- The use of external programs (like `RA501R`) allows for business rule centralization and reuse.

---

## Conventions and Patterns

- **Norwegian variable and comment naming**: Most variable names and comments are in Norwegian, reflecting business terminology.
- **Consistent indicator mapping**: Indicator usage is documented and strictly followed.
- **Separation of display and update logic**: Ensures clarity and avoids unintended data changes.
- **Explicit subfile management**: Manual control over subfile behavior, rather than relying on implicit RPG subfile processing.

---

## Summary

AP631R provides a robust, indicator-driven interface for managing voucher codes in an archive. It leverages subfiles for efficient record navigation and manipulation, integrates with external validation modules, and follows established RPG patterns for modularity and maintainability. The codebase is well-structured for onboarding new developers familiar with RPG, and the business logic is clearly separated into manageable subroutines.