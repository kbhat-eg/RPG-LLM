<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LO500R RPG Program Explanation</title>
</head>
<body>

<h1>Overview</h1>
<p>
  LO500R is an IBM ILE RPG program on AS/400 (ASLAGR) for <strong>inquiry and search of purchase orders</strong>.  
  It displays a scrollable subfile of orders, lets the user filter by various criteria, and invoke many functions:
  creating, changing, copying, deleting, matching to a sales order, printing, picking, transferring to supplier, etc.
</p>

<h2>File and Data Definitions</h2>
<ul>
  <li><strong>File Specs (F-records)</strong>
    <ul>
      <li>Multiple physical files (e.g. LOHEPF, FOHEPFR, RLEVPF, …) all keyed by firm, order number and suffix.</li>
      <li>A workstation file <code>FLO500D</code> defines a subfile <code>B1SFL</code> and control record <code>B2CTL</code>.</li>
    </ul>
  </li>
  <li><strong>Indicators</strong>   
    <ul>
      <li><code>LR</code> – End program</li>
      <li><code>10</code> – Subfile “roll” key pressed</li>
      <li><code>12</code>, <code>13</code>, <code>14</code>, <code>15</code> – Subfile display flow control</li>
      <li><code>16</code> – <code>READC</code> found no more records</li>
      <li><code>21</code>, <code>22</code> – Home‐ and cursor‐positioning</li>
      <li><code>30</code> – Protect fields in display, <code>31–79</code> error flags, <code>80–89</code> work flags, <code>90–99</code> file indicators</li>
    </ul>
  </li>
  <li><strong>Parameters</strong>
    <ul>
      <li><code>p_numm</code> – Order number to position on entry</li>
      <li><code>p_lpro</code> – Calling program indicator (blank or 'L')</li>
      <li><code>p_stat</code> – Used when matching an order (55)</li>
    </ul>
  </li>
  <li><strong>Local Data</strong>
    <ul>
      <li>Arrays for messages (<code>a_mld1</code>, <code>a_mld2</code>).</li>
      <li>Work variables: subfile controls (<code>w_srrn</code>, <code>w_spge</code>, …), filter fields (<code>b2numm</code>, <code>b2suff</code>, <code>b2datum</code>, <code>b2lena</code>, <code>b2otyp</code>, <code>b2fsok</code>), and user input/output (<code>w_numm</code>, <code>w_suff</code>, <code>w_otyp</code>, …).</li>
      <li>Flags: <code>b_forn</code> (refresh), <code>b_exit</code>, <code>b_feil</code> (input error), <code>b_open_sok</code> (SQL open search), etc.</li>
      <li>Session variables from LDA: <code>l_firm</code> (firm), <code>l_user</code>, <code>l_wsid</code>, <code>l_fnav</code>, etc.</li>
    </ul>
  </li>
  <li><strong>External Programs</strong>
    <ul>
      <li><code>CO402R</code> – Read configuration values for feature-flags (u_703, u_704, u_705, u_706).</li>
      <li>Many subprogram calls: <code>LO110R</code> (create/change order), <code>LO300R</code> (copy), <code>LO400R</code> (delete), <code>LO505R</code> (display single order), <code>LO512R</code> (block order), <code>LO526R</code> (show line items), <code>LO580R</code> (match order), <code>FO550R</code> (history), <code>LO600R</code> (print parameters), <code>LO736R</code> (picking), <code>LO740R</code> (transfer to supplier), etc.</li>
    </ul>
  </li>
</ul>

<h2>Main Logic</h2>
<ol>
  <li><strong>Initialization</strong> (entry routine)
    <ul>
      <li>Read LDA to set <code>w_firm</code>, <code>l_user</code>, <code>l_avde</code> if feature flagged.</li>
      <li>Call <code>CO402R</code> to initialize feature flags <code>u_703</code>…<code>u_706</code>.</li>
      <li>Get today’s date into <code>w_udat</code> and tax rate via <code>FO705R</code>.</li>
      <li>Position database keyed on <code>lohel1</code> (firm + <code>p_numm</code>) and build subfile with <code>CRT_SUBFILE</code>.</li>
    </ul>
  </li>
  <li><strong>Opening Screen (B2CTL)</strong>
    <ul>
      <li>Write the command line record <code>B2CMD</code> to show F-key prompts.</li>
      <li>Jump to tag <code>B2TAGB</code> where only the subfile is displayed via <code>DSP_SUBFILE</code>.</li>
    </ul>
  </li>
  <li><strong>Function‐Key Handling</strong>  
    <ul>
      <li>F1 – Browse options &amp; search (<code>XH1WIN</code>).</li>
      <li>F2 – Select “orders from‐to” via program <code>LO602R</code>.</li>
      <li>F3 or F12 – Exit (<code>*INLR = *ON</code>).</li>
      <li>F5 – Refresh the subfile (<code>FORNY</code>).</li>
      <li>F6 – Create or change order (<code>LO110R</code>).</li>
      <li>F7 – Show item‐order lines (<code>LO526R</code>).</li>
      <li>F9 – Show single item/order lines (<code>FO520R</code>).</li>
      <li>F10 – Show order history (<code>HISTORIKK</code> subroutine).</li>
      <li>F11 – Block order (<code>LO512R</code>).</li>
      <li>F15 – Start print (<code>LO604R</code>).</li>
      <li>F16 – Show picking (<code>LO736R</code>).</li>
      <li>F21 – Free‐text search toggle (<code>B2FSOK</code>).</li>
      <li>F22 – Toggle include/exclude VAT in totals.</li>
      <li>F23 – Toggle display format between date/value columns.</li>
      <li>*IN10 – “Roll” subfile page (<code>CRT_SUBFILE</code>).</li>
      <li>*IN21 – Cursor repositioning.</li>
    </ul>
  </li>
  <li><strong>Input Validation</strong>  
    <ul>
      <li><code>XSJEKK_INP</code> – Validates date fields (<code>B2DATO</code>).</li>
    </ul>
  </li>
  <li><strong>Positioning or Filtering</strong>  
    <ul>
      <li>If any filter fields (<code>B2NUMM</code>, <code>B2SUFF</code>, <code>B2DATO</code>, …) are set, call <code>POSISJONER</code> to set the appropriate file key.</li>
      <li>Clear and rebuild the subfile (<code>CLR_SUBFILE</code>, <code>CRT_SUBFILE</code>).</li>
    </ul>
  </li>
  <li><strong>Subfile Processing</strong>  
    <ul>
      <li><code>SUBFILE</code> loops <code>READC</code> through <code>B1SFL</code> records.</li>
      <li>For each row, <code>B1VALG</code> indicates user action on that line:
        <ul>
          <li>0 – No action</li>
          <li>1 – Show lines</li>
          <li>2 – Change order</li>
          <li>3 – Copy order</li>
          <li>4 – Delete order</li>
          <li>5 – View order details</li>
          <li>6 – Choose for printing</li>
          <li>8 – Show who holds the order</li>
          <li>9 – Unbind order (delete binding)</li>
          <li>10 – History</li>
          <li>11 – Split an incoming packing slip</li>
          <li>16 – Pick order</li>
          <li>18 – Transfer order to supplier</li>
          <li>26 – Update linked sales order</li>
          <li>36 – Synchronize suffix</li>
          <li>46 – Show deleted orders (<code>LY500R</code>)</li>
          <li>50 – Transfer back to calling program (FO500R)</li>
          <li>55 – “Match” to a sales order</li>
          <li>60 – Show order log (<code>LM500R</code>)</li>
        </ul>
      </li>
      <li>Before each action, it checks:
        <ul>
          <li>User permission (<code>AD005R</code>).</li>
          <li>Order being in use (<code>XSJEKK_ORD1</code>).</li>
          <li>Package/invoice rights (<code>XSJEKK_PAKS</code>).</li>
          <li>Partial‐delivery restrictions (<code>SJK_DELLEV</code>).</li>
        </ul>
      </li>
      <li>After each call, the row is updated (<code>UPDATE B1SFL</code>) and processing continues.</li>
    </ul>
  </li>
  <li><strong>Finalization</strong>
    <ul>
      <li>If <code>B_EXIT</code> was set by F50, leaves subroutine and returns to caller.</li>
      <li>Finally, <code>*INLR = *ON</code> and <code>RETURN</code>.</li>
    </ul>
  </li>
</ol>

<h2>Key Subroutines and Windows</h2>
<ul>
  <li><strong>DSP_SUBFILE</strong>:  
    Prepares the display of <code>B1SFL</code> records and calls <code>EXFMT B2CTL</code>.</li>
  <li><strong>CLR_SUBFILE</strong>:  
    Clears the subfile by writing control record with <code>*IN14</code> and resets row/page counters.</li>
  <li><strong>CRT_SUBFILE</strong>:  
    Reads and writes each qualifying database row into the subfile, applying filters, calculating values, coloring rows (<code>XFARGE</code>), and capturing log‐status (<code>LM701R</code>).</li>
  <li><strong>POSISJONER</strong>:  
    Positions the keyed file on the appropriate starting value based on filter criteria (order number, supplier name, order date, delivery date, free‐text, order type).</li>
  <li><strong>FORNY</strong>:  
    Sets the key list depending on last sort (<code>W_SEQE</code>), clears and rebuilds the subfile.</li>
  <li><strong>NEWLO_VASK</strong>:  
    Clean trailing “.” and “:” characters from names so NewLook GUI will not misinterpret.</li>
  <li><strong>VASK2</strong>:  
    Replace “–” with space in <code>B2FSO2</code> free-text field for GUI safety.</li>
  <li><strong>XB3WIN</strong>, <strong>XB4WIN</strong>, <strong>XB6WIN</strong>, <strong>XB9WIN</strong>, <strong>XB16WI</strong>, <strong>XB18WI</strong>, <strong>XB26WI</strong>:  
    Dialog windows for copy, delete, print, binding removal, picking, transfer to supplier, update linked sales order, respectively.</li>
  <li><strong>XSJEKK_INP</strong>:  
    Validates input fields (dates).</li>
  <li><strong>XSJEKK_ORD1</strong>, <strong>XSJEKK_PAKS</strong>:  
    Check if order is already reserved or if user has packet/invoice rights.</li>
  <li><strong>SJK_DELLEV</strong>:  
    Check for partial delivery – only allow matching if single suffix across all lines.</li>
  <li><strong>HNTNUM</strong>:  
    Retrieve next available order number from number register via <code>AS100R</code>.</li>
  <li><strong>HISTORIKK</strong>:  
    Call <code>FO550R</code> to display order history.</li>
  <li><strong>SPØRRING</strong>:  
    Dialog for querying supplier, order type, info type, department, seller.</li>
</ul>

<h2>SQL-Based Free-Text Search (version 7.02+)</h2>
<p>
  Starting in version 7.02, if free-text search <code>B2FSOK</code> is enabled:
  <ul>
    <li>Builds a dynamic WHERE clause with <code>LIKE</code> on multiple fields (supplier name, part number, references, day‐name, lines text).</li>
    <li>Prepares and opens an SQL cursor (<code>CURSOR FOR SQL_STMT</code>), fetches rows into host variables.</li>
    <li>Combines SQL and the existing keyed‐file logic seamlessly in <code>CRT_SUBFILE</code>.</li>
  </ul>
</p>

<h2>Summary of Flow</h2>
<ol>
  <li>Initialize program (read LDA, config flags, date, VAT, position key, build subfile).</li>
  <li>Display B2CTL command line, then subfile.</li>
  <li>Process F-keys (refresh, navigation, create/change, copy, delete, print, pick, match, transfer, etc.).</li>
  <li>Validate inputs, apply filters, position file, clear &amp; rebuild subfile.</li>
  <li>In <code>SUBFILE</code>, loop through orders, present rows, detect row‐level actions (<code>B1VALG</code>), invoke subprograms, check permissions, update file row.</li>
  <li>Exit on F3/F12 or transfer to caller (FO500R).</li>
</ol>

</body>
</html>