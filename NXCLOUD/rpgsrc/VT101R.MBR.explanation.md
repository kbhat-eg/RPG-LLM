# RPG Program VT101R - Explanation

This RPG program (`VT101R`) is designed for IBM i (AS/400) and is used to delete "tilbudspriser" (offer prices or promotional prices) from a database. The code is written in RPG/400 (fixed format), and includes logic for interactive screens, parameter validation, and deletion routines.

Below is a detailed breakdown of the key components and logic:

---

## Header and Documentation

- `h option(*nodebugio) datedit(*dmy)`:  
  - `*nodebugio`: Disables debug for I/O operations.
  - `datedit(*dmy)`: Specifies date format as Day-Month-Year for all date operations.
- Extensive comments cover:
  - Program name, system, and description.
  - Usage of indicator lights (*inXX) for controlling logic.
  - Change history (with dates and initials).

---

## File Declarations (`F-Spec`)

- `fausrl1 ...` : Input file, keyed, disk file.
- `fvtill5 ... rename(vtilpfr:vtill5r)`:  
  - Unformatted, keyed, disk file, renamed record format (`vtilpfr` â†’ `vtill5r`).
- `fvtill3 ... rename(vtilpfr:vtill3r)`:  
  - Similar to above, another file, different logical view.
- `fvt101d ... workstn`:  
  - Display file for interactive screen.

---

## Data Declarations (`D-Spec`)

- Working storage for date and time ranges:
  - `w_fdat`, `w_tdat`: Date from/to (6 digits).
  - `w_ftim`, `w_ttim`: Time from/to (6 digits).
- Variables with `like(...)` inherit their data types from database fields for consistency.
- Local Data Area (LDA) mapping (`uds`):
  - `l_user`, `l_firm`, `l_fnav`: User, firm number, and firm name.
- Miscellaneous indicators:
  - `w_firm`, `w_in03`: Firm number, exit indicator.

---

## Main Program Logic (`C-Spec`)

### 1. Main Interactive Screen (`A2BLD`)

- `exfmt a2bld`: Display the main input screen for the user to enter criteria.
- Reset error indicators (IN37-43) before use.
- Exit if F3 pressed (`*INKC`):
  - Move '1' to `w_in03`, jump to `xslutt` (exit routine).

### 2. Parameter Handling

- Assign user input values to work fields (`w_fdat`, `w_ftim`, `w_tdat`, `w_ttim`).
- *Campaign Check*:
  - If no campaign and both from/to dates are zero, set error indicator IN43 and exit validation.
- *Date/Time Validation*:
  - Validate dates and times using `test(d)` and `test(t)`. Set corresponding indicators and exit if invalid.
  - Convert and move input into working date/time fields.
  - Check that `from` date/time is not after `to` date/time (set IN41/IN42 as needed).

### 3. Confirm Deletion

- `exfmt a2msg`: Show a confirmation message before proceeding.
- If the user presses F3, go back for corrections.

### 4. Deletion Routine

- `exsr sletilb`: Call subroutine to perform the deletion.
- End program (`goto xslutt`).

---

## Subroutines

### 1. `sletilb` (Delete Records)

Handles the actual deletion of offer price records, based on criteria.

#### a. When a campaign is specified (`a2kamp`):

- Set up campaign value. Position to the right records (`setll` + `reade` loop on `vtill5`).
- For each record:
  - If a date/time interval is specified, check that the record falls within it.
  - If the campaign name matches, delete the record (`delete vtill5r`).

#### b. When only date/time is specified (no campaign):

- Position to the date range on file `vtill3`.
- For each matching record:
  - Exit loop if firm or date doesn't match (`leavesr`).
  - If the record is within the date range (and optionally time range), delete it (`delete vtill3r`).

### 2. `*inzsr` (Initialization)

- Set up key lists for file access (`vtill5_key`, `vtill3_key`).
- Set the firm number from the LDA.

---

## Key RPG Idioms

- **Indicators:**  
  Used extensively to manage error states and user actions (e.g., IN37 for invalid from-date, INKC for F3/Exit, IN41/42 for date/time consistency errors).

- **`setll`/`read(e)/reade`:**  
  File positioning and keyed read to process selected records.

- **`delete` keyword:**  
  Deleting records directly from the database.

- **Screen Formats (`EXFMT`):**  
  Interactive display for entering parameters and viewing messages.

- **Goto Statements:**  
  Used for control flow (older RPG practice).

---

## Error Handling

- Error indicators are set for:
  - Invalid dates or times.
  - "From" date/time later than "To."
  - Missing required fields.

- After each error, the program returns to the input screen for correction.

---

## Control Flow Diagram (Simplified)

```text
User Input (A2BLD)
   |
   V
Validate parameters (dates, times, campaign)
   |
   +--[Error]--- Return to Input Screen (show error)
   |
   V
Show Confirmation Message (A2MSG)
   |
   V
If OK -> Run Deletion Subroutine (sletilb)
   |
   V
End Program
```

---

## Summary

- **Purpose:** Delete offer prices based on campaign and/or date/time intervals.
- **User Interaction:** Guided by screens for parameter entry and confirmation.
- **Validation:** Robust checks for campaign presence and valid date/time intervals.
- **Deletion:** Efficiently loops over the relevant records, conditionally deletes.
- **Structure:** Modular, using subroutines, short sections, and indicator-driven error handling.

This is a well-documented, production-style RPG/400 program for batch maintenance with interactive control and robust validation.