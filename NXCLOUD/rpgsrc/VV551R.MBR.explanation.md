# RPG Program Explanation – VV551R

This program is a large and mature ILE RPG (possibly RPG IV, fixed-format) application for IBM i (AS/400) that performs **item inquiry and price calculation** on selected items, with details such as customer discounts, campaigns, and unit conversions. It's a typical application for a wholesale/retail ERP, where users can access information about items, their prices, applicable discounts, and perform "what-if" calculations.

Below is a guided walkthrough of the code for onboarding a developer. You'll see section-wise explanations along with notes on prominent features, logic, and interactions.

---

## 1. **Header & Revision History**

- **Header info**: Name, description, system (ASOFAK), and purpose (item/price inquiry).
- **Revision history**: Extensive comments trace the program’s evolution, showing support for new fields, program calls, bugfixes, and logic modifications.
- **`h` spec**: 
  - `option(*nodebugio)`: Disables debug input/output.
  - `datedit(*dmy)`: Sets the date editing format.

---

## 2. **File Declarations (`f` specs)**

Declares logical/physical files:
- **vvarl1**: Item master (basic item data)
- **vugrl1**: Item subgroup
- **rlevl1**: Supplier master
- **rkunl1**: Customer master
- **fkprl1**: Customer project master
- **vltpl1**: Delivery type master
- **fusrl1**: User master (security)
- **fstsl1**: OFAK code table
- **jvarl1, vvlel1**: Other item-related, possibly for external item references (NOBB, VA)
- **vv551d**: Workstation display file (user interface – screen formats)

---

## 3. **Data Definitions (`d` specs)**

- **Local Data Area variables**: For user info, etc.
- **DS: hirec/d_orec**:
  - Data structures for passing parameters to/from called programs (especially VP900R).
- **Parameter and Working Variables**:
  - For storing program input (company, item, customer, etc.).
  - For keys to files.
- **Calculation variables**:
  - Prices, taxes, quantities, units, date/time, discount, etc.

---

## 4. **Mainline Logic (`c` specs)**

### **Startup**

- **Item existence check**: 
  - `chain` to item file with item key. If not found, exit program.
- **Fetches item type and various info** by calling subprogram `VL710R` and parses the output into local fields.

### **NOBB/VA Info**
- NOBB/VA are likely external item coding systems (often used in Norway). 
- Looks up NOBB number if present; fetches from VA file if not.

### **EAN/Barcode Info**
- Calls `VE722R` to get EAN codes and related info.

### **Populate Display Fields**
- Moves info from master files to screen variables (`c2xxxx` fields).

### **Get Expiry Date**
- Calls `VL720R` to get expiration date for the item/warehouse combination.

### **Fetch Prices for 3 Units**
- Calls `VP726R` to retrieve prices (up to 3 units), campaign data, cost prices, time limits, etc.

### **Calculate Suggested Sales Price**
- Populates fields like campaign period, price, etc.

### **Description Lookup**
- Fetches textual description for item subgroup (vugrl1), supplier name (rlevl1).

### **Tax/MVAT Calculation**
- Calls `FÅ705R` and `FÅ706R` to get standard and reduced VAT rates.

### **Calculate Offer Price Including VAT**
- If campaign prices are available, calculates gross price including tax.

### **Price Calculations for All Units**
- For each of the three unit levels, applies appropriate VAT and finalizes gross price by calling `FA909R`.

### **Customer/Project Handling**
- Calls subroutine `ny_kunde` to refresh customer/project-related fields and prices.

### **Screen Loop**
- Uses `exfmt` in a loop to process user interaction.
- Handles function keys for:
  - Exit (F3/F12)
  - Inquiries (customer, project, delivery type)
  - Show product info, inventory, cost price, NOBB info, VA info, item card, etc.

---

## 5. **Major Subroutines**

### **ny_kunde**
- Resets and fetches customer and project names, and looks up personal net prices/discounts for up to three units by calling `nettopris`.

### **nettopris**
- Builds and passes a data structure for calling `VP900R`, which calculates the net price and discounts for the customer/project/unit/date.

### **hent_antall**
- Calculates the conversion between units (e.g., boxes to pieces), setting appropriate display fields.

### **kalkulator**
- Main calculation engine:
  - Handles user changes to quantity, unit, discount, net price, gross price, recalculating everything accordingly.
  - Handles discounts as either percent or calculated by difference.
  - Invokes `hent_info` to get gross prices including VAT and cost price margins (DG).

### **hent_info**
- For each unit level, calculates price including VAT, calls `FA909R`, and computes DG (contribution margin) as a percentage, checking for campaign overlap.

### **spørring**
- Handles pop-up/inquiry functions for customer, customer project, and delivery type using other display programs.

### **sjekk_input**
- Validates user input:
  - Checks the existence of customer, project, delivery type, and that unit selection is legal.
  - Prevents conflicting changes (e.g., manually overriding both net and gross price).

### **beholdning**
- Shows inventory levels by calling `VL750C`.

### **vis_kost**
- Controls display of cost prices and margin, only if the user has permission, checked via the user file.

### **vis_nobb / vis_va / vis_vkort**
- Function key routines to display in-depth info about NOBB, VA, or the item ("item card"), calling respective print preview or inquiry programs.

### **Initialization (`*inzsr`)**
- Fetches parameters (firm, item, customer, project, delivery type, warehouse).
- Constructs key lists for each file chain.

---

## 6. **General Comments**

- **External Program Calls**: The program relies heavily on calling other RPG/Cobol subprograms for lookups/calculations (VL710R, VP900R, VP726R, FA909R, etc.), following the modular IBM i program design.
- **Field Naming**: Standard Norwegian RPG naming style, with prefixes for each major field (vv = item, c2 = screen field, w_ = work, etc.).
- **Error Handling**: Many chain operations set `*IN91` when a record isn’t found, and display error messages accordingly.
- **Screen Handling**: Uses workstation file and common RPG screen loop via `exfmt`.
- **Key Lists**: Uses `klist` for chained file access.
- **Feature Evolution**: The program has seen numerous version-based enhancements for new external codes, price groups, warehouse logic, campaign prices, etc.

---

## 7. **Summary Table of Main Functions**

| Functionality            | Implementation                                             |
|------------------------- |-----------------------------------------------------------|
| Item/price inquiry       | Mainline, calls to subprograms and file lookups           |
| Discount calculation     | In `nettopris`, `kalkulator`, `hent_info`                 |
| Customer/project lookup  | Files: rkunl1, fkprl1, subroutine `ny_kunde`              |
| Expiry, campaign info    | Calls to VL710R, VL720R, input fields                     |
| Inventory display        | `beholdning` subroutine                                   |
| Cost price/margin (DG)   | `vis_kost` subroutine, cost price calculations            |
| Unit conversions         | `hent_antall`, unit/quantity fields                       |
| Field validation         | `sjekk_input` subroutine                                  |
| Function keys            | Handled in mainline logic, mapped to subroutines          |
| Extended codes (NOBB/VA) | Support in data structures and display subroutines        |

---

## 8. **Onboarding Notes for Developers**

- **Know your master files**: Understand structure and relations of vvarl1, vugrl1, rlevl1, etc.
- **Study the called programs**: Subprograms do much of the heavy lifting for price, tax, and description logic.
- **UI/UX**: The screen fields (`c2xxxx`) are mapped tightly to the display file (vv551d). Know how screen flow works.
- **Validation & Error**: Carefully validate all chained file accesses and user entries.
- **Unit & Tax Logic**: Comprehend how the three-level unit system works, and when to use different VAT rates.

---

## 9. **Key Business Rules Encoded**

- Only show sensitive info (cost) to privileged users.
- Expiry/campaign info is date and time sensitive: prices and cost prices can change depending on current date/time.
- Discounts can be either pre-set or calculated on the fly, but not both set by user simultaneously.
- Pricing, campaigns, and discounts can differ by customer, project, warehouse, and delivery type.

---

This program is a quintessential IBM i RPG application: modular, externally coupled, and highly tailored for a specific business process—a robust, extensible inventory and pricing inquiry module. New developers should focus on understanding the file interfaces, subprogram APIs, and the business logic linked to each functional section.