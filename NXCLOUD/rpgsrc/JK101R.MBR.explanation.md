# Documentation for RPG Program JK101R

## Overview

**Program**: `JK101R`  
**System**: `ASVADM`  
**Description**:  
This program updates "logistics items" (`logistikkvare`) that have been changed today. It receives a "sub-item" (`undervare`) as a parameter and updates the corresponding logistics item with information from the sub-item.

The program is designed for batch or scheduled execution and is part of a logistics/materials management solution, likely in the building materials sector (as indicated by references to NOBB and "byggdok").

---

## Main Purpose & Flow

- **Input**: Optionally receives a sub-item identifier (`undervare`) as a parameter.
- **Function**: For all logistics items (or a specific one, if parameterized) that have been changed today:
    - Updates logistics item records with current data from sub-items.
    - Handles associated price, supplier, and packaging data.
    - Ensures related records (such as supplier and packaging links) are synchronized.
- **Error Handling**: SQL errors are logged to the application journal files, and the program terminates cleanly.

---

## Key Files and Data Structures

- **Physical Files**:
    - `JVKHPF`, `JVKLPF`, `JVARPF`, `JVPRPF`, `JVLEPF`, `JVPKPF` — Core item, price, supplier, and packaging files.
    - `AFPSLR` (renamed to `AFPSLRR`) — Properties/configuration file.
- **Data Structures**:
    - External DS mapped to the above files for record manipulation.
    - Local Data Area (LDA) fields used for user, company, and file context.

---

## Program Structure

### 1. Initialization (`*inzsr`)

- Reads the input parameter (sub-item number).
- Retrieves company, file, and user information from the LDA.
- Looks up configuration in `AFPSLR` (for special activation flags, e.g., "byggdok" or "cobuilder").
- Sets up key variables for the session.

### 2. Main Processing

#### a. Refresh Items (`fornyvare` subroutine)

- Builds a dynamic SQL query to select logistics items that:
    - Are related to the current company.
    - Have been changed today (`jvedat = current_date`).
    - Optionally, match the specific item passed as a parameter.
- For each selected item:
    - Calls program `JK702R` to perform the actual update logic for the logistics item.
    - (Commented code indicates there was previously or optionally a subroutine to copy NOBB data to the logistics item.)

#### b. Refresh Prices (`fornypris` subroutine)

- Similar logic as above, but operates on the price file (`JVPRPF`).
- For each relevant price record:
    - Calls `JK702R` for further processing.
    - (Commented code indicates there was previously or optionally a subroutine to copy price data.)

### 3. Error Handling (`sjekk_sql` subroutine)

- If an SQL error occurs (`sqlcod < 0`):
    - Logs the error to the application journal (`AJLTPF`) using programs `AB700R` and `AB705R`.
    - Terminates the program.

---

## Domain-Specific and Business Logic Highlights

### Logistics Item Synchronization

- **Logistics items** and **sub-items** are closely linked. The program ensures that any changes to sub-items are propagated to the logistics items.
- **NOBB**: References to NOBB indicate integration with the Norwegian building materials database. Special care is taken not to overwrite NOBB data if the logistics item is an active NOBB item.

### Use of Dynamic SQL

- The program constructs SQL queries at runtime to flexibly handle both individual and multiple item updates.
- Uses parameterized queries to avoid SQL injection and to allow reuse of prepared statements.

### Modular Update Logic

- The actual update of logistics items, prices, and related records is delegated to the external program `JK702R`. This keeps the main program focused on selection logic and orchestration.

### Configuration via Properties File

- The `AFPSLR` file is used to control special features or activation flags (e.g., toggling integration with external systems like "byggdok" or "cobuilder").

### Defensive Looping

- Loops fetching SQL results are capped by `w_maxv` (default 9999) to prevent runaway loops in case of unexpected data volumes.

### Error Logging

- Errors from SQL operations are logged with context, including program name, key, and error message.
- The program ensures that resources are closed and the session is ended upon error.

---

## Notable Conventions and Patterns

- **Use of *LDA**: The program relies on the Local Data Area for user and session context, a common pattern in legacy RPG systems.
- **Commented/Legacy Code**: There are large sections of commented-out code, especially for copying NOBB and price information. These may be legacy routines or toggled for special processing.
- **Externalized Update Logic**: By calling `JK702R`, the program separates data selection from update logic, supporting maintainability and reuse.
- **Extensive Use of Data Structures**: External DS definitions for file records enable easy field-level manipulation and SQL FETCH INTO operations.

---

## Integration Points

- **Other RPG Programs**:
    - `JK702R`: Handles the actual update of logistics item, supplier, and packaging records.
    - `AB700R` and `AB705R`: Used for error and event logging.
- **Database**:
    - Multiple files are joined and updated via embedded SQL.
    - Uses both direct file access and SQL for flexibility and performance.
- **Configuration**:
    - Reads from `AFPSLR` for run-time flags.

---

## Key Variables

- `p_vare`: Input parameter, sub-item number to process (optional).
- `w_firm`: Company identifier.
- `w_vare_p`: The specific item to process, if provided.
- `w_ldor`, `w_ldox`: Used for supplier/packaging link logic.
- `sqlquery`: Holds the dynamic SQL statement.
- `w_maxv`, `w_tell`: Control SQL fetch loops.
- `ds_jvarpf`, `ds_jvprpf`, `ds_jvlepf`: Data structures for file records.

---

## Special Cases & Comments

- **NOBB Handling**:  
  The commented-out `nobbkopivare` and `nobbkopipris` subroutines show logic for copying NOBB data to logistics items and prices, but are not currently active. This logic is complex and involves:
    - Copying or updating item records.
    - Copying supplier links (including dual links for both logistics and NOBB suppliers).
    - Copying packaging records, with logic to handle both logistics and NOBB variants.
    - Copying/updating price records, adjusting for factors such as packaging size.

- **Activation Flags**:  
  The program can be configured to behave differently based on flags in the properties file, allowing for customer- or environment-specific logic.

---

## Summary

`JK101R` is a batch utility for synchronizing logistics item master data with recent changes from sub-items, with optional focus on a single item. It is tightly integrated with the company's item, price, supplier, and packaging master files, and is designed to be robust, configurable, and extensible for various business processes in the building materials domain. Error handling and process logging are first-class concerns, and the program is built to be maintainable and adaptable to evolving business rules.