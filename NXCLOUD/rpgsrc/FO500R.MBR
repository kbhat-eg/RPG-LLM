     h option(*nodebugio : *srcstmt) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : FO500R
      * Beskrivelse . . : Spørring / søking etter ordre
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *                 ______________________________________________
      *                 Siste endring  8.07  Krditgrense som i FD100R
      *                 ______________________________________________
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       090399 AMD  Nytt program
      * R3.11 150200 AMD  Viser bestillingsnummer på bestilte ordre
      * R3.12 160200 AMD  Oppdaterer subfile også der hvor nye program
      *                   kalles.  Ny subrutine ajo_subfile
      * R3.13 180200 AMD  Lagt inn varselbilde ved valg 18 på ordre som alle
      *                   rede er satt i bestilling
      * R3.14 210300 AMD  Lagt inn sperre på endring av pakkseddel dersom
      *                   bruker ikke har tilgang til dette.
3.15  * R3.15 160500 AMD  Lagt inn kontroll på om bruker har lov til å opp-
3.15  *                   heve sperret ordre, gi varsel og slipp rec. lock
3.16  * R3.16 070900 AMD  Lagt inn mulighet for selektering på leveringsmåte
3.17  * R3.17 241000 AMD  Informasjon i slettevinduet ble dratt med fra
      *                   forrige ordre dersom kopiering m/sletting.
3.31  * R3.31 070201 AMD  Bilde for valg v/F1 er utvidet til også å ha med
      *                   bestillingsnummer. Det kan nå også velges inntil
      *                   3 ordretyper. I tillegg er det lagt inn direkte
      *                   overgang til bestillingssystemet, valg 50.
3.32  * R3.32 020301 AMD  Hvilken kode som skal slås av/på ved valg 98,
      *                   hentes nå fra status-register.
3.33  * R3.33 020301 AMD  Kontroll på om infokode skal kunne fjernes v/98.
      *                   Status på infokode-register sier om denne kode
      *                   skal sjekkes mot brukerregister (om bruker har lov)
3.34  * R3.34 020301 AMD  Det er lagt inn mulighet for å styre farge på
      *                   infokoden som legges ut i skjermbildet.
3.35  * R3.35 070301 AMD  Det er nå lagt opp en egen kode for om bruker har
      *                   lov til å endre en pakkseddel.
3.36  * R3.36 080301 AMD  Etter at man har vært inne på H1WIN (F1) fylles
      *                   subfile pånytt fra ordre 0.
3.37  * R3.37 150301 AMD  Dersom valg 1 er foretatt (for oppretting av ny
      *                   ordre) posisjonerer programmet på denne ordre ved
      *                   retur til oversiktsbildet.
      *                   I tillegg til dette er det lagt inn justeringer
      *                   ved kopiering av pakkseddel m/sletting.  Pakkseddel
      *                   kunne da slettes selv om bruker ikke hadde lov.
3.38  * R3.38 230501 AMD  Overgang til slettet-register
3.39  * R3.39 160801 AMD  Lagt inn nye spørreprogram mot lager.(Fjernet igjen)
3.39  * R3.39 280801 AMD  Lagt inn kontroll slik at det ikke kan kopieres
3.39  *                   annet enn tilbud til kunder med kredittsperre.
3.39  * R3.39 290801 AMD  Lagt inn selektering på avdeling
3.39  * R3.39 131101 AMD  Justering av spørring på bestilling m/suffix
      *       130302 HKO  Lagt inn ny logikk + ny posisjonering etter
      *                   oppretting av ordre
5.01  * R5.01 060502 AMD  Lagt inn mulighet for oppheving av kode som
5.01  *                   sier at pakkseddel er skrevet.
5.01  *                   (Dersom bruker har lov til dette)
5.02  * R5.02 241002 AMD  Lagt om rutiner for oppdatering av lager
      *       230403 HKO  Test på beløpsstørrelse ved vising av inkl.mva
5.03  * R5.03 190503 ASK  Lagt inn kontroll på at man bare kan kopiere
5.03  *                   til en ordretype som har systemkode = 0
5.20  * R5.20 291003 AMD  Lagt inn mulighet for å inkludere/utelate
5.20  *                   ordretyper, samt lagre valg på bruker
5.32  * R5.32 080904 AMD  Lagt inn ordretype for nummerserie (se dok)
5.33  * R5.33 100904 AMD  Problemer med subfile ved bruk av F22 er
5.33  *                   korrigert (skiftet posisjonering)
5.34  * R5.34 011204 GRO  Endret overgang FO500R/LO500R mhp startverdi
5.34  *                   og indikator for kallende prog.
      *
5.41  * R5.41 260805 AMD  Lagt inn søk på lagernummer. NB! Søker ned
      *                   på linjenivå og kan ta lenger tid.
5.42  * R5.42 250905 AMD  Lagt inn selektering på selger
      *
      *       041005 HKO  Behandler tilbud med slettede varer ved kopiering
      *                   av tilbud
      *
5.51  * R5.51 201005 AMD  Lagt inn valg om kundeprosjekt skal tas med
      *                   eller ikke.
      *       301005 HKO  Initierer ikke *in22 dersom parmeter som input-
      *                   parameter
      *       311005 HKO  Endret og samordnet logikk for setting av ordre
      *                   i bestilling
      *       150206 HKO  Kaller forskjellige programmer for bestillingre
      *                   avhengig av paramtersetting
5.52  * R5.52 140206 AMD  Lagt inn F4-søk på bruker-register
5.54  * R5.54 280307 AMD  Legger ut en streng for info/ordrestatus/kode
5.55  * R5.55 151107 bof  Sjekker på siste kode, ikke høyeste
5.56  * R5.56 150108 bof  Hindre pkt. 18 hvis man kommer fra Bestilling
5.60  * R5.60 070108 bof  Utvidet logg med år
5.61  * R5.61 310108 bof  Tester om kjørek. før man legger ut kj.k.koder
5.62  * R5.62 220508 AMD  Hvis depositum er betalt kan ikke ordre slettes
5.63  * R5.63 220508 AMD  Sjekk om depositum er betalt hvis plukk til best.
      * 6.10  240609 BSA  Oppdatert med sporingsinformasjon
6.11  * 6.11  110310 AMD  Ved kode 9 for oppheving av låst ordre, skal
6.11  *                   bilde for hvem som behandler vises først.
6.12  * 6.10  021210 bsa  Filtrerer ut ordre med kortkode.
6.13  * 6.10  181011 bsa  Utvider med ekstra kontroll mot at kunden reelt sett
6.13  *                   har kort liggende på seg. Er koden feilsatt, blir den
6.13  *                   nullet ut.
6.12x * 6.10  160512 BOF  Lagt inn ryddeprogram ved oppr.av ordre
6.20  * R6.20 270410 bof  Sjekk om bruker har rettighet til å gå til besti.
6.21  * R6.20 100511 bof  Gir melding hvis pkt 18 og man kommer fra bestilling
6.22  * R6.20 280410 AMD  Flere muligheter rundt kredit-alternativer
6.23  * R6.20 100112 bof  Utplukk, sjekk om krav til leveringsdato
6.24  * R6.20 130112 bsa  Ved kall til FO550R sendes med kode for hvilket type
6.24  *                   nummer som overføres.
6.25  * R6.20 090612 bof  Utvidet tabell med feilmeldinger
6.26  * R6.20 140113 bof  Slette ordre, slett også evt. best.forslag.
6.27  * R6.20 230713 bof  Skal uansett ikke slette best.forslag med ordnr = 0
6.NU  * R6.30 260514 bsa  Programmet gjennomgått mtp nummerutvidelser.
6.30  * R6.30 101014 bsa  Ordre som er sendt til trekk hos kortselskap kan ikke
6.30  *                   ikke frigis.
6.28  * R6.20 121114 bkv  Ikke slette order ved kopi, når depositum
6.29  * R6.20 220615 nho  Ikke lov til å registrere manuelt ordrenr
6.29  *                   dersom FAAMAN = 0
6.31  * 6.30  080715 ask  Brukerbegr. endre/slette fakt skal kun kunne
      *                   gjøres av de som har tillatelse til å fakturere
6.32  * 6.30  110915 bsa  Justert skjermbildet pga JIT GUI
6.33  * 6.30  040117 bof  Sletting, gir melding hvis det ligger bestilling
6.34  * 6.30  060217 bof  6.33 kun melding, skal kunne gå videre.
6.35  * 6.30  300418 bof  Lagt inn ekstra test på fobdat om gyldig dato
7.xx  * 7.00  200116 bsa  Endringer reltart til ny GUI. NB Kan kun gjelde DDS
7.01  * 7.00  161116 bkv  Lagt inn H felt i DDS for bruk i OA
7.02  * 7.00  110217 bkv  Slått av Bytt Info for OA. F23
7.03  * 7.00  090617 bkv  Lagt inn kundetilpassinger fra MGR
7.04  * 7.00  150617 bkv  Kopiering. Byttet fra int til string for å få radio i gui
7.05  * 7.00  230318 bkv  Nytt frisøk
7.06  * 7.00  210418 bkv  Fix for feil i OA posisjonering
7.07  * 7.00  071218 bkv  Posisjonering på mobil (fra sgr)
7.08  * 7.00  150219 bkv  Sortering på kuna
7.09  * 7.00  120319 bkv  Bedre OA sjekk
7.10  * 7.00  150219 bkv  Sortering på kuna II test
Q.01  * 7.00  080219 bsa  Quick wins - forhåndsvis og email (80 og 81)
Q.02  * 7.00  140219 bsa  Quick wins - sette klar til plukking - valg 82
7.11  *       210519 ask  Utvidet logg tilbudsslett. med konkurrentprispfølging
7.12  * 7.00  310519 bkv  Vasker vekk probl Newlook tegn
7.13  * 7.00  110619 bsa  Endring av sjekk mot rettigheter for endring av ordre med
7.13  *                   behandlingskode 3. Justering av endring 6.31
7.14  *       110619 bof  Nye filtre, lev.type og loggkode.
7.15  *       110619 ask  Nytt bilde for sletting av tilbud - tilbudsoppfølging
      *                   Hører sammen med 7.11
7.16  *       110619 sst  Logging av tilbudsaktiviteter
7.17  * MGR   110619 sst  Lagt inn test på kreditgrense ved kopiering ordre
      *                   Hente parameter meosaldo fra AFPSPF
7.18  *       110619 ask  Lagt inn sperre mot plukk til bestilling fra hovedordre
7.19  *       110619 sst  Kun tillate ordretype T ved tilbudskunde
7.20  *       110619 sst  Ev. rekalulering av tibud ved kopiering
7.21  *       210619 bsa  Sjekk om loggkoder alltid skal vises
7.22  *       310719 bof  Forkorte tekst i kopiering av tilbud
7.23  *       060819 bkv  Stiller seg på ny ordre etter kopiering
7.24  *       160819 bkv  Fjernet info om ordre i b3wint pga problem for newlook
7.25  *       300819 bsa  Hvis direktelevert ordre, skal den ikke settes til
7.25  *                   plukking.
7.26  *       040919 bkv  Beholder frisøk når en kommer tilbake til listen igjen
7.27  *       250919 bkv  Fiks på søk/sort K:
7.28  *       250919 bkv  Kun søk på dag, hvis ord slutter på dag
7.29  *       020119 bkv  Etter F1, endre kun på seq hvis filter på bestnr
7.2A  *       030119 bkv  Utvidet vask
7.2B  *       300120 bkv  Flyttet FU706 pga hastighet
7.2C  *       040320 bkv  132 bilde
7.2d  *       150320 bkv  CoolSpool Excel eksport
7.2e  *       160320 bkv  Frisøk utvidet: Eksternsys og ref
7.2f  *       250320 bkv  CoolSpool Excel eksport linjer
7.2g  *       270320 bkv  Lagt inn flere options. tatt en linje fra subfile
7.2h  *       270320 bkv  Fjernet OA kode
7.2i  *       120221 ask  Lagt inn søk på forsendelsesmåte
7.2j  *K000   220421 bsa  Hvis ordren er sperret for å sendes til plukking
7.2j  *K000               må det også sjekke ved hurtigtast (Q.02)
7.2k  *       250521 BOF  Utvidet order by med fofirm, tuning
      *
7.fb  * 7.10  040117 bof  Hvis depositumskrav og ikke betalt.
7.f1  * 7.10  260117 bof  Nye filter vedr. forskuddsbetalt.
7.f2  * 7.10  150420 bsa  Endret rekkefølge for å unngå rotete bilde
7.f3  * 7.10  210920 bsa  Feil i F1 skjermbildet
7.f4  * K000  300920 bsa  Parameterstyring av fargevalg på ordre med depositumskrav.
      *
8.01  * K000  250322 bsa  Hvis ordren kommer fra NGN, settes NG som sperrekode. Skal
8.01  * K000              ikke kunne låses opp via valg 9.
8.02  * K000  110122 bsa  Legger ut varekunde i skjermbilde, hvis både varekunde,
8.02  * K000              fakturakunde og prosjektnummer.
8.03  * K000  231122 sst  Flyttet ant memo-dager og utv.kreditgrense til  UTVIDET_MEMOSALDO (nx)
8.04  * K000  081212 bsa  Unngår ugyldige tegn i kundenavn.
8.05  * K000  170323 sst  RKMEMS inkl mva
8.06  * K000  100523 bsa  Liten justering rundt visning ifbm varekund/prosjekt.
8.07  * K000  120523 sst  Tilpasse test på kreditgrense som i FD100R
8.08  * K000  070623 bsa  Felt er ikke definert inn i SQL. Da blir det tilfeldig hva
8.08  * K000              hvilken ordre den hentes fra.
8.09  * K000  070623 bsa  Feil ved sletting av tilbud. Problemer med slettekode.
8.10  * K000  070723 bsa  Hvis ny ordretype er av type 'T', skal vi ikke sjekke
8.10  * K000              kreditgrense.
8.11  * K000  301023 bsa  Hvis det er kontantkunde, skal det ikke kunne plukkes  til
8.11  * K000              annet enn tilbud. Justert endring 7.19. Tester ikke lenger
8.11  * K000              på hardkodet kundenummer.
8.12  *PRG2   200622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner
8.14  *K0000  090824 bsa  Sneket seg inn en feil ved kopiering av sjekk mot memosaldo
8.14  *K0000              Ordreverdi allerede beregnet inn i memosaldi via kall til
8.14  *K0000              FO763. Skal ikke tas hensyn til en gang til.
8.15  *K0000  090824 bsa  Ikke nok med sjekk på akkumulatortype, ta også om ordren
8.15  *K0000              er med i ordregrunnlaget.
8.16  *K0000  110924 bsa  Vasker frisøksfelt da det kan ødelegge for visning i
8.16  *K0000              newlook.
8.17  *K0000  230924 bsa  Etter overgang til slettede ordre, oppdater subfile
8.18  *K0000  050525 bsa  Lagt inn valg for utsendelse av SMS.
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Bruk av indikatorer:
      *
      *       LR = Avslutt program
      *       10 = Roll
      *       11 = Rolldown
      *       12 = Sfldsp
      *       13 = Sfldspctl
      *       14 = Sflclr
      *       15 = Sflend
      *       21 = Home-key
      *       22 = Plassering av cursor
      *       30 = Protect av felter ved vise
      *    31-79 = Varsle m/feilmeldinger/skjermindikatorer
      *    80-99 = Arbeidsindikatorer
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     ffohelr    if   e           k disk    rename(fohepfr:fohelrr)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffohela    if   e           k disk    rename(fohepfr:fohelar)
     ffoheld    if   e           k disk    rename(fohepfr:foheldr)
     ffohell    if   e           k disk    rename(fohepfr:fohellr)
     ffohelo    if   e           k disk    rename(fohepfr:fohelor)
     ffohelv    if   e           k disk    rename(fohepfr:fohelvr)
     ffohelu    uf   e           k disk    rename(fohepfr:fohelur)
3.11 ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
7.fb ffst2l1    if   e           k disk    rename(fst2pfr:fst2l1r)
     flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
     ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
5.20 ffusrlu    uf   e           k disk    rename(fusrpfr:fusrlur)
3.31 flohel1    if   e           k disk    rename(lohepfr:lohel1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
3.33 fvinfl1    if   e           k disk    rename(vinfpfr:vinfl1r)
3.33 fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
5.62 fsdepl1    if   e           k disk    rename(sdeppfr:sdepl1r)
5.62 fsdeplu    uf   e           k disk    rename(sdeppfr:sdeplur)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
6.13 frukrl5    if   e           k disk    rename(rukrpfr:rukrl5r)
6.26 flfhelr    if   e           k disk    rename(lfhepfr:lfhelrr)
6.26 flfhelu    uf   e           k disk    rename(lfhepfr:lfhelur)
6.26 flfdtlu    uf   e           k disk    rename(lfdtpfr:lfdtlur)
6.30 frksjl1    if   e           k disk    rename(rksjpfr:rksjl1r)
8.03 f*afpslr    if   e           k disk    rename(afpspfr:afpslrr)
7.17 frkmel1    if   e           k disk    rename(rkmepfr:rkmel1r)
7.15 fxtkkl1    if   e           k disk    rename(xtkkpfr:xtkkl1r)
7.15 fxtsll1    if   e           k disk    rename(xtslpfr:xtsll1r)
      *
7.2C ffo500d    cf   e             workstn sfile(b1sfl:w_srrn)
     f                                     infds(dspfbk)
5.34  *
5.34  * Definering av parametre
5.34  *
6.nu d p_numm          s                   like(fonumm)
5.34 d p_lpro          s              1
8.18 d p_syst          s              1
      *
      * Definering av array
      *
6.20 d a_meld          s             50    dim(5) ctdata perrcd(1)
      *
      * Definering av Local data area
      *
     d                uds
     d l_wsid                901    910
     d l_user                911    920
7.00 d l_filg                931    933
     d l_firm                944    946  0
     d l_fnav                951    980
      *
      * Definering av Information Data Structure - display feedback
      *
     d dspfbk          ds
     d  d_fcrn               378    379I 0
      *
7.02 d ProgStatus     sds
7.02 d CurPgmNam               1     10
7.02 d CurPgmLib              81     90
      *
      * Definering av variabler i nøkler
      *
     d fohelr_numm     s                   like(fonumm)
     d fohelr_suff     s                   like(fosuff)
     d fohelr_num2     s                   like(fonumm)
     d fohelr_suf2     s                   like(fosuff)
     d fohel1_numm     s                   like(fonumm)
     d fohel1_suff     s                   like(fosuff)
     d fohela_kuna     s                   like(fokuna)
     d foheld_bdat     s                   like(fobdat)
     d fohell_ldat     s                   like(foldat)
     d fohelo_otyp     s                   like(footyp)
     d fohelv_navn     s                   like(fonavn)
     d fohelu_numm     s                   like(fonumm)
     d fohelu_suff     s                   like(fosuff)
3.11 d fodtl1_numm     s                   like(fdnumm)
3.11 d fodtl1_suff     s                   like(fdsuff)
     d rkunl1_kund     s                   like(rkkund)
     d fusrl1_user     s                   like(fbuser)
5.20 d fusrlu_user     s                   like(fbuser)
3.31 d lohel1_numm     s                   like(lonumm)
3.39 d*lohel1_suff     s                   like(losuff)
     d votyl1_otyp     s                   like(vaotyp)
3.33 d vinfl1_ityp     s                   like(vaityp)
3.33 d vvarl1_vare     s                   like(vvvare)
5.62 d sdepl1_numm     s                   like(sknumm)
5.62 d sdepl1_kund     s                   like(skkund)
7.fb d sdepl1_tell     s                   like(sktell)
5.62 d sdeplu_numm     s                   like(sknumm)
5.62 d sdeplu_kund     s                   like(skkund)
7.fb d sdeplu_tell     s                   like(sktell)
6.13 d rukrl5_ktyp     s                   like(ruktyp)
6.13 d rukrl5_kkun     s                   like(rukkun)
6.13 d rukrl5_kpro     s                   like(rukpro)
6.26 d lfhelu_numm     s                   like(lhnumm)
6.26 d lfdtlu_numm     s                   like(lfnumm)
6.30 d rksjl1_jnum     s                   like(rsjnum)
6.30 d rksjl1_jsuf     s                   like(rsjsuf)
8.03 d*afpslr_ufil     s                   like(afufil)
8.03 d*afpslr_uide     s                   like(afuide)
7.15 d xtsll1_firm     s                   like(xsfirm)
7.15 d xtsll1_skod     s                   like(xsskod)
7.15 d xtkkl1_firm     s                   like(xkfirm)
7.15 d xtkkl1_kkod     s                   like(xkkkod)
      *
      * Definering av variable
      *
     d w_fcrn          s              4  0
     d w_stel          s              4  0
     d w_spge          s              4  0
     d w_srrn          s              4  0
     d w_sfrn          s                   like(w_srrn)
     d w_ssrn          s                   like(w_srrn)
      *
     d w_seqe          s              1
     d b_forn          s              1    inz(*off)
     d b_anul          s              1    inz(*off)
     d b_feil          s              1    inz(*off)
     d b_subf          s              1    inz(*off)
     d b_sjek          s              1    inz(*off)
3.14 d b_stop          s              1    inz(*off)
5.34 d b_exit          s              1    inz(*off)
5.34 d b_slet          s              1    inz(*off)
5.62 d b_depo          s              1    inz(*off)
6.13 d b_kunde         s              1    inz(*off)
Q.02 d b_pluk          s              1    inz(*off)
      *
     d w_belp          s              9  0
7.01 d w_belp2         s                   like(fotots)
     d w_salg          s             13
      *
     d w_firm          s                   like(fofirm)
     d w_knav          s                   like(rknavn)
     d w_ityp          s                   like(foityp)
     d w_itxt          s             35
7.2i d w_ftxt          s             35
3.39 d w_gtxt          s             20
5.42 d w_itx2          s             20
     d w_udat          s               d   datfmt(*iso)
     d w_mvap          s              6  2
     d w_mvat          s              5  4
     d w_mvaf          s             10  9
     d b_moms          s              1    inz(*off)
      *
7.07 d w_mobi          s                   like(fomobi)
     d w_enor          s              1
     d w_ftor          s              1
     d w_retu          s              1
     d w_vare          s             15
     d w_kund          s                   like(fokund)
6.nu d w_numm          s                   like(fonumm)
5.60 d w_aarr          s              4  0
     d w_suff          s                   like(fosuff)
6.nu d w_numx          s                   like(fonumm)
     d w_sufx          s                   like(fosuff)
     d w_otyp          s                   like(footyp)
6.nu d w_benr          s                   like(fdbenr)
5.32 d w_onum          s                   like(vaonum)
     d w_pdir          s              1  0
     d w_outq          s             10
     d w_typd          s              4
     d w_kom1          s             30
     d w_kom2          s             30
     d w_fell          s              6
     d w_type          s              2
     d w_fast          s             10
     d w_kode          s              1
5.54 d w_kod2          s              1
5.02 d w_opdt          s              1
     d w_val2          s              2  0
     d w_valg          s              2  0
     d w_mld1          s             50
     d w_mld2          s             50
6.34 d w_svar          s              1
6.34 d w_in12          s              1  0
5.41 d w_funn          s              1  0
5.52 d w_user          s             30
6.12 d w_slag          s              2  0
6.12 d w_sbes          s             30
6.24 d w_ntyp          s              1
7.fb d w_sumi          s             11  2
7.fb d w_sumu          s             11  2
7.fb d w_depb          s             11  2
7.01 d w_datn          s              6  0
8.07 d w_date          s               d   datfmt(*iso)
7.2h d* w_oa_on         s              2  0
7.2h d* w_oa_on1        s              2  0 inz(0)
7.2h d* w_oa_on2        s              2  0 inz(0)
7.2h d* w_oa_on3        s              2  0 inz(0)
7.2h d* w_oa_on4        s              2  0 inz(0)
7.04 d w_3krab         s              1  0
7.05 d b_open_sok      s              1    inz(*off)
7.05 d w_navn          s                   like(b2navn)
7.05 d w_ste1          s             35
7.05 d w_ste2          s             35
7.05 d w_ste3          s             35
7.05 d w_ste4          s             35
7.05 d w_ste5          s             35
7.05 d sqlquery        s           4096
7.05 d sql_fri_s       s             50
7.05 d sql_fri_sl      s             50
7.28 d sql_fri_day     s             50
7.28 d w_temp          s             50
7.05 d x               s              1  0
7.05 d lo              c                   'abcdefghijklmnopqrstuvwxyzæøå'
7.05 d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅ'
7.06 d w_oaposn        s                   like(b1numm)
7.06 d w_oaposs        s                   like(b1suff)
7.10 d* w_fsrt          s                   like(b2fsrt)
Q.01 d w_acti          s              1
Q.01 d w_stat          s              1
7.12 d w_len           s              3  0
7.12 d w_teller        s              3  0
7.15 d w_aktp          s             15
7.15 d w_sgru          s             60
7.15 d w_kkko          s              1
7.17  *w_utvgrns = utvidelse av memosaldo(Mestergruppen)
7.17 d w_utvgrns       s              2  0
7.17  *w_memodagr = antall dager ordre skal med i memosaldo
7.17 d w_memodagr      s              3  0
8.07 d w_memodat       s               d   datfmt(*iso)
7.17 d w_3x            s              3
7.17 d p_fir           s              3
7.17 d p_kun           s              6
7.17 d w_kgrn          s                   like(rksald)
7.17 d w_ksal          s                   like(rksald)
7.20 d w_tilgko        s             10
7.20 d w_felt          s             10
7.20 d w_rutine        s             10
7.20 d w_adv           s              3
7.20 d w_status        s             10
7.20 d w_omber_tilb    s              3
7.2d d w_sqlwhere      s           8000
7.2d d w_excel_url     s            100
8.16 d w_posw          s              2  0
      *
3.37 d s_otyp          s                   like(footyp)
      *
      * Eksternt program
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
7.11 d u_711           s              1    inz(*off)
7.13 d u_713           s              1    inz(*off)
7.14 d u_714           s              1    inz(*off)
7.16 d u_716           s              1    inz(*off)
7.17 d u_717           s              1    inz(*off)
7.18 d u_718           s              1    inz(*off)
7.19 d u_719           s              1    inz(*off)
7.20 d u_720           s              1    inz(*off)
7.21 d u_721           s              1    inz(*off)
7.2d d u_72D           s              1    inz(*off)
7.2j d u_72j           s              1    inz(*off)
8.03 d u_kmem          s              1    inz(*off)
8.11 d u_til           s              1    inz(*off)
      *
      * Definering av konstanter
      *
7.2g d c_sfil          s              2  0 inz(14)
      *
      * Forklaring på spesielle felter
      * som benyttes ved sub-files.
      * - - - - - - - - - - - - - - - - -
      * w_fcrn - Første recordnummer på siden
      * w_stel - Subfile-teller
      * w_spge - Sidestørrelse i subfile (page)
      * w_srrn - Relativt recordnummer i subfile
      * w_sfrn - Første recordnummer på siste side
      * w_ssrn - Siste recordnummer på siste side
      * w_curn - Current recordnummer på siden
      * w_virn - Side og cursorplassering som skal vises
      * w_afld - Aktivt feltnavn
      * w_arow - Aktiv rad for cursor
      * w_acol - Aktiv kolonne for cursor
      *
      * Benyttede skjermbilder.
      * - - - - - - - - - - - - - - - - -
      * B1SFL  - B1 Subfile - record
      * B2CTL  - B2 Subfile - control record
      * B2CMD  - B2 Eget skjermbilde for CMD-taster
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * B2CTL Behandle åpningsbildet med subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Send Alt
      *
     C/Exec SQL
7.08 C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
     C/End-Exec
7.2h   //  // det er forskjellige navn på OA bibliotek
7.2h   //  // OA er std 700
7.2h   //  // GUIO er for XL
7.2h   //  // ASKUNDxxxO skal være std for kundebibl
7.2h   //   *in48 = *off;
7.2h   //   w_oa_on = 0;
7.2h   //   w_oa_on1 = %scan ('OA' : CurPgmLib);
7.2h   //   w_oa_on2 = %scan ('GUIO' : CurPgmLib);
7.2h   //   if ( %len(%trim(CurPgmLib)) = 10);
7.2h   //     if (%subst(CurPgmLib:1:6) = 'ASKUND');
7.2h   //       if (%subst(CurPgmLib:10:1) = 'O');
7.2h   //         w_oa_on3 =1 ;
7.2h   //       endif;
7.2h   //     endif;
7.2h   //   endif;
7.2h   //   if ((w_oa_on1<>0) or (w_oa_on2<>0) or (w_oa_on3<>0)
7.2h   //                or (w_oa_on4<>0));
7.2h   //     w_oa_on = 1;
7.2h   //    *in48 = *on;
7.2h   //   endif;

     c     b2taga        tag
      *
     c                   write     b2cmd
      *
      * Bare data
      *
     c     b2tagb        tag
      *
     c                   exsr      dsp_subfile
      *
      * Behandling av funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   eval      p_lpro = *blank
     c                   goto      avslutt
     c                   when      *inke
     c                   exsr      forny
     c                   goto      b2tagb
     c                   when      *inkj
     c                   eval      w_numm = 0
     c                   exsr      historikk
     c                   goto      b2tagb
7.05 c                   when      *in10
7.05 c*                  exsr      clr_subfile
7.05 c                   exsr      crt_subfile
7.05 c                   goto      b2tagb
7.05 c*                  when      *in11
7.05 c*                  exsr      bck_subfile
7.05 c*                  goto      b2tagb
7.xx c*                  when      *in21
7.xx c*                  eval      *in22 = *on
7.xx c*                  goto      b2taga
     c                   endsl
      *
      * F1=Bla-alternativer
      *
     c                   if        *inka
     c                   exsr      xh1win
     c                   goto      b2taga
     c                   endif
      *
      * F2=Velg ordre fra - til
      *
     c                   if        *inkb
     c                   call      'FO602R'
     c                   parm                    w_ftor
     c                   parm                    w_firm
     c                   goto      b2tagb
     c                   endif
      *
      * F6=Opprett
      *
     c                   if        *inkf
     c                   eval      w_valg = 1
     c                   eval      w_numm = 0
     c                   eval      w_suff = 0
     c                   call      'FO100R'
     c                   parm                    w_valg
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   if        w_numm <> 0
     c                   eval      b2numm = w_numm
     c                   exsr      posisjoner
     c                   endif
     c                   goto      b2tagb
     c                   endif
      *
      * F7=Vise vare/bestillingslinjer
      *
     c                   if        *inkg
     c                   call      'FO526R'
     c                   parm                    w_ftor
     c                   parm                    w_firm
     c                   goto      b2tagb
     c                   endif
7.2d  *
7.2d  * F8=Excel eksport
7.2d  *
7.2d c                   if        *inkh
7.2d c                   call      'FO503C'
7.2d c                   parm                    w_firm
7.2d c                   parm                    w_sqlwhere
7.2d c                   parm                    w_excel_url
7.2d c                   goto      b2taga
7.2d c                   endif
      * F9=Vise varenr/ordrelinjer
      *
     c                   if        *inki
     c                   call      'FO520R'
     c                   parm                    w_ftor
     c                   parm                    w_firm
     c                   parm                    w_vare
     c                   goto      b2tagb
     c                   endif
      *
      * F15=Starter utskrift
      *
     c                   if        *inkp
     c                   call      'FO604R'
     c                   parm                    w_ftor
     c                   parm                    w_firm
6.nu c                   parm                    w_numx
     c                   parm                    w_sufx
     c                   parm                    w_otyp
     c                   parm                    w_pdir
     c                   parm                    w_outq
     c                   goto      b2tagb
     c                   endif
      *
      * F16=Vise utplukk
      *
     c                   if        *inkq
     c                   call      'FO736R'
     c                   parm                    w_ftor
     c                   parm                    w_firm
6.nu c                   parm                    w_numx
     c                   parm                    w_sufx
     c                   goto      b2taga
     c                   endif
7.05  *
7.05  * F21=Hent søk
7.05  *
7.05 c                   if        *inkv
7.05 c                   eval      b2navn = w_navn
7.05 c                   eval      *in22 = *on
7.05 c                   goto      b2tagb
7.05 c                   endif
      *
      * F22=Vise inkl/eks mva.
      *
     c                   if        *inkw
     c                   if        *in71   = *on
     c                   if        b_moms  = *off
     c                   eval      b_moms  = *on
     c                   eval      b2hed2  = 'Inkl. mva.'
     c                   else
     c                   eval      b_moms  = *off
     c                   eval      b2hed2  = 'Ordreverdi'
     c                   endif
     c                   endif
     c                   exsr      forny
     c                   goto      b2taga
     c                   endif
      *
      * F23=Vise alternativ informasjon
      *
     c                   if        *inkx
     c                   if        *in71  = *off
     c                   eval      *in71  = *on
     c                   eval      b2hedd = 'Ordredato'
     c                   eval      b2hed2 = 'Ordreverdi'
     c                   else
     c                   eval      *in71  = *off
     c                   eval      b2hedd = 'Lev. dato'
     c                   eval      b2hed2 = '     Best.'
     c                   endif
7.05 c                   if        w_seqe = 'S'
7.05 c                   eval      b2navn = b2nav2
7.05 c                   endif
     c                   exsr      forny
7.05 c                   eval      b2navn = *blank
     c                   goto      b2taga
     c                   endif
      *
      * Sjekker input-felter
      *
     c                   exsr      xsjekk_inp
     c                   if        b_feil = *on
     c                   eval      b_feil = *off
     c                   goto      b2tagb
     c                   endif
      *
      * Posisjonering
      *
     c                   if        b2numm <> 0      or
     c                             b2dato <> 0      or
7.05 c*                            b2kuna <> *blank or
     c                             b2navn <> *blank or
7.10 c*                             w_fsrt <> b2fsrt or
     c                             b2otyp <> *blank
     c                   exsr      posisjoner
     c                   goto      b2tagb
     c                   endif
      *
      * Behandling av subfile
      *
     c                   exsr      subfile
      *
7.26 c*                   if        w_oa_on > 0 and w_oaposn > 0
7.26 c*                   eval      b2numm = w_oaposn
7.26 c*                   eval      b2suff = w_oaposs
7.26 c*                   exsr      posisjoner
7.26 c*                   eval      w_oaposn = 0
7.26 c*                   eval      w_oaposs = 0
7.26 c*                   eval      b2numm = 0
7.26 c*                   eval      b2suff = 0
7.26 c*                   eval      w_seqe = 'S'
7.26 c*                   endif
      *
5.34 c                   if        b_exit = *off
     c                   goto      b2taga
5.34 c                   endif
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for fornying av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     forny         begsr
      *
     c                   if        w_fcrn <> 0
     c     w_fcrn        chain     b1sfl
     c                   endif
      *
     c                   select
7.05 c                   when      w_seqe = 'S'
7.05 c                   eval      b2nav2 = b2navn
7.05 c                   eval      b_open_sok = *on
     c                   when      w_seqe = 'A'
     c                   eval      fohela_kuna = b1kuna
     c     fohela_key    setll     fohela
     c                   when      w_seqe = 'D'
     c                   if        b1dato <> 0
     c     *dmy          move      b1dato        foheld_bdat
     c                   endif
     c     foheld_key    setll     foheld
     c                   when      w_seqe = 'L'
     c                   if        b1dato <> 0
     c     *dmy          move      b1dato        fohell_ldat
     c                   endif
     c     fohell_key    setll     fohell
     c                   when      w_seqe = 'O'
     c                   eval      fohelo_otyp = b1otyp
     c     fohelo_key    setll     fohelo
     c                   when      w_seqe = 'V'
     c                   eval      fohelv_navn = b1navn
     c     fohelv_key    setll     fohelv
     c                   other
     c                   eval      fohel1_numm = b1numm
     c                   eval      fohel1_suff = b1suff
     c     fohel1_key    setll     fohel1
     c                   endsl
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for posisjonering i subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     posisjoner    begsr
      *
      * Posisjoner startverdi på ordrenummer
      *
     c                   if        b2numm <> 0
7.05 c                   eval      b2nav2 = *blank
     c                   eval      w_seqe = ' '
     c                   eval      fohel1_numm = b2numm
     c                   eval      fohel1_suff = b2suff
     c     fohel1_key    setll     fohel1
     c                   goto      end_pos
     c                   endif
      *
      * Posisjoner startverdi på ordretype
      *
     c                   if        b2otyp <> *blank
7.05 c                   eval      b2nav2 = *blank
     c                   eval      w_seqe = 'O'
     c                   eval      fohelo_otyp = b2otyp
     c     fohelo_key    setll     fohelo
     c                   goto      end_pos
     c                   endif
      *
      * Posisjoner på ordrenummer dersom ordretype er
      * valgt både som posisjonering og selektering
      *
     c                   if        b2otyp <> *blank
     c                   if        h1otyp <> *blank
7.05 c                   eval      b2nav2 = *blank
     c                   eval      w_seqe = ' '
     c                   eval      fohel1_numm = *zero
     c                   eval      fohel1_suff = *zero
     c     fohel1_key    setll     fohel1
     c                   goto      end_pos
     c                   endif
     c                   endif
      *
      * Posisjoner startverdi på kundenavn
      *
7.05 c*                   if        b2kuna <> *blank
7.05 c*                   eval      w_seqe = 'A'
7.05 c*                   eval      fohela_kuna = b2kuna
7.05 c*     fohela_key    setll     fohela
7.05 c*                   goto      end_pos
7.05 c*                   endif
      *
      * Posisjoner startverdi på vareadresse
      *
7.05 c*                   if        b2navn <> *blank
7.05 c*                   eval      w_seqe = 'V'
7.05 c*                   eval      fohelv_navn = b2navn
7.05 c*     fohelv_key    setll     fohelv
7.05 c*                   goto      end_pos
7.05 c*                   endif
7.05  *
7.05  * Posisjoner startverdi på frisøk
7.05  *
7.05 c                   if        b2navn <> *blank
7.10 c*                   if        b2navn <> *blank or
7.10 c*                             w_fsrt <> b2fsrt
7.10 c*                   eval      w_fsrt = b2fsrt
7.05 c                   eval      b2nav2 = b2navn
7.05 c                   eval      w_navn = b2navn
7.05 c                   eval      b_open_sok = *on
7.05 c                   eval      w_seqe = 'S'
7.05 c                   goto      end_pos
7.05 c                   endif
      *
      * Posisjoner startverdi på ordredato
      *
     c                   if        b2dato <> 0
     c                   if        *in71  =  *on
7.05 c                   eval      b2nav2 = *blank
     c                   eval      w_seqe = 'D'
      *
     c     *dmy          move      b2dato        foheld_bdat
     c     foheld_key    setll     foheld
     c                   goto      end_pos
     c                   endif
     c                   endif
      *
      * Posisjoner startverdi på leveringsdato
      *
     c                   if        b2dato <> 0
     c                   if        *in71  =  *off
7.05 c                   eval      b2nav2 = *blank
     c                   eval      w_seqe = 'L'
      *
     c     *dmy          move      b2dato        fohell_ldat
     c     fohell_key    setll     fohell
     c                   goto      end_pos
     c                   endif
     c                   endif
      *
     c     end_pos       tag
      *
      * Blanker subfile, og fyller opp i.h.t. posisjonering
      *
     c                   eval      *in22 = *off
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
      * Blanker posisjoneringsfelter
      *
     c                   eval      b2numm = 0
     c                   eval      b2suff = 0
     c                   eval      b2dato = 0
     c                   eval      b2otyp = *blank
7.05 c*                  eval      b2kuna = *blank
     c                   eval      b2navn = *blank
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     subfile       begsr
      *
     c                   eval      b_forn = *off
5.34 c                   eval      b_exit = *off
      *
     c                   if        *in22 = *off
     c                   eval      *in22 = *on
     c                   else
     c                   eval      *in22 = *off
     c                   endif
      *
     c                   eval      w_virn = w_fcrn
      *
      * Leser og behandler subfile
      *
     c                   do        w_ssrn
     c                   readc     b1sfl
      *
     c                   if        %eof
     c                   leave
     c                   endif
      *
     c                   eval      *in22 = *off
     c                   eval      w_virn = w_srrn
      *
7.06 c                   if        b1valg = 0
7.06 c                   eval      w_oaposn = 0
7.06 c                   eval      w_oaposs = 0
7.06 c                   else
7.06 c                   eval      w_oaposn = b1numm
7.06 c                   eval      w_oaposs = b1suff
7.06 c                   endif
      *
      * Hvem behandler ordre ?
      *
     c                   if        b1valg = 8
     c                   call      'FO710R'
     c                   parm                    w_firm
6.nu c                   parm                    b1numm
     c                   parm                    b1suff
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Slette binding av ordre
5.01  * eller kode som sier at
5.01  * pakkseddel er skrevet
      *
     c                   if        b1valg = 9
6.11 c                   call      'FO710R'
6.11 c                   parm                    w_firm
6.nu c                   parm                    b1numm
6.11 c                   parm                    b1suff
6.11 c*
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
     c                   exsr      xb9win
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Er ordre ledig for bruk ?
      *
     c                   exsr      xsjekk_ord1
     c                   if        b_sjek = *on
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
3.14  * Endring av ordre, har bruker lov ?
3.14  *
3.14 c                   if        b1valg = 2
3.14 c                   eval      fohelr_numm = b1numm
3.14 c                   eval      fohelr_suff = b1suff
3.14 c                   exsr      xsjekk_paks
3.14 c                   if        b_stop = *on
3.14 c                   eval      w_mld1 = a_meld(3)
3.14 c                   call      'AA005R'
3.14 c                   parm                    w_mld1
3.14 c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
3.14 c                   update    b1sfl
3.14 c                   iter
3.14 c                   endif
3.14 c                   endif
      *
      * Endre
      *
     c                   if        b1valg = 2
      *
     c                   eval      w_val2 = b1valg
     c                   eval      w_numm = b1numm
     c                   eval      w_suff = b1suff
     c                   call      'FO100R'
     c                   parm                    w_val2
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
      *
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
     c     fohelr_key    chain     fohelr                             90
     c                   if        *in90  = *off
     c                   eval      b1salg = (fotots - fototr)
     c                   eval      b1ityp = foityp
7.2h c*                   if        *in71 or w_oa_on > 0
7.2h c                   if        *in71 = *on
     c                   eval      w_salg = %editw(b1salg : '         ,  -')
     c                   move      w_salg        b1info
     c                   endif
     c                   endif
      *
3.12 c                   exsr      ajo_subfile
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Kopier
      *
     c                   if        b1valg = 3
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
     c                   exsr      xb3win
7.23 c                   eval      w_seqe = 'S'
7.23 c                   eval      b_open_sok = *on
7.23 c                   eval      b_forn = *on
7.23 c                   eval      b1suff = 0
7.23 c                   eval      b1valg = 0
7.23 c                   eval      w_oaposn = 0
7.23 c                   eval      w_oaposs = 0
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Slett
      *
     c                   if        b1valg = 4
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
5.62 c                   exsr      xb4wint
5.62 c                   if        b_depo = *off
     c                   exsr      xb4win
5.62 c                   endif
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vis
      *
     c                   if        b1valg = 5
     c                   eval      w_numm = b1numm
     c                   eval      w_suff = b1suff
      *
     c                   call      'FO505R'
     c                   parm                    w_firm
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Velge ordre til utskrift
      *
     c                   if        b1valg = 6
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
     c                   exsr      xb6win
     c                   eval      b1valg = 0
     c                   eval      b_forn = *on
3.12 c                   exsr      ajo_subfile
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vise historikk på ordre
      *
     c                   if        b1valg = 10
     c                   eval      w_numm = b1numm
     c                   exsr      historikk
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Velge utplukk av ordre
      *
     c                   if        b1valg = 16
      *
      * Ordretype/beh.kode = 0
      * skal nå kunne plukkes
      *
     c                   eval      votyl1_otyp = b1otyp
     c     votyl1_key    chain     votyl1r                            90
      *                  if        vaoakk = 0
      *                  eval      b1valg = 0
3.34  *                  exsr      xfarge
      *                  update    b1sfl
      *                  iter
      *                  endif
      *
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
     c                   exsr      xb16wi
     c                   eval      b1valg = 0
     c                   eval      b_forn = *on
     c                   iter
     c                   endif
      *
      * Velge utplukk av ordre til bestilling
      *
     c                   if        b1valg = 18
7.18 c                   if        u_718 = *on
7.18 c                   if        b1otyp = 'HO'
7.18 c                   exsr      xb18msg3
7.18 c                   eval      b1valg = 0
7.18 c                   update    b1sfl
7.18 c                   leavesr
7.18 c                   endif
7.18 c                   endif
7.18  *
5.56 c                   if        p_lpro <> *blank
6.21 c                   exsr      xb18msg2
5.56 c                   eval      p_lpro = *blank
5.56 c                   eval      b_exit = *on
5.56 c                   leavesr
5.56 c                   else
5.63 c                   exsr      xb18msg
5.63 c                   if        b_depo = *off
     c                   eval      w_numm = b1numm
     c                   eval      w_suff = b1suff
     c                   if        laaabe = 1
     c                   call      'FO740R'
     c                   parm                    w_firm
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   else
     c                   call      'FO734R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   endif
5.63 c                   endif
7.fb c                   eval      b_forn = *on
     c                   eval      b1valg = 0
3.12 c                   exsr      ajo_subfile
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
5.56 c                   endif
     c                   endif
      *
      * Velge vise bestilling
      *
     c                   if        b1valg = 26
      *
     c                   eval      w_kund = b1kund
     c                   eval      w_numm = b1numm
     c                   eval      w_suff = b1suff
     c                   eval      w_valg = 26
      *
     c                   call      'FO720C'
     c                   parm                    w_kund
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_valg
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Velge vise bestilling (Datokontroll)
      *
     c                   if        b1valg = 27
      *
     c                   eval      w_kund = b1kund
     c                   eval      w_numm = b1numm
     c                   eval      w_suff = b1suff
     c                   eval      w_valg = 27
      *
     c                   call      'FO720C'
     c                   parm                    w_kund
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_valg
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Velge rutine for oppdatering av utgangspunkt ordre
      *
      * Er foreløpig ikke i fuksjon.. ***
      *
     c                   if        b1valg = 28
      *
      * Kun behandlingkode = 1
      * skal kunne plukkes
      *
     c                   eval      votyl1_otyp = b1otyp
     c     votyl1_key    chain     votyl1r                            90
     c                   if        vaoakk <> 1
     c                   eval      *in31  = *on
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   leave
     c                   endif
      *
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
     c                   exsr      xb28wi
     c                   iter
     c                   endif
      *
      * Velge å sam-kjøre ordre igjen
      *
     c                   if        b1valg = 36
     c                   eval      w_numm = b1numm
     c                   eval      w_suff = b1suff
     c                   call      'FO104R'
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Velge å generere spesialpris fra tilbud
      *
     c                   if        b1valg = 38
      *
      * Kun behandlingskode = 0, skal kunne velges
      *
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1r                            90
     c                   if        vaoakk <> 0
     c                   eval      w_mld1 = a_meld(1)
     c                   call      'AA005R'
     c                   parm                    w_mld1
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
     c                   eval      w_retu = *blank
     c                   eval      w_numm = b1numm
     c                   eval      w_suff = b1suff
     c                   call      'FP720R'
     c                   parm                    w_retu
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
3.38  *
3.38  * Gå direkte til Slette-register
3.38  *
3.38 c                   if        b1valg = 46
3.38 c                   call      'FY500R'
3.38 c                   eval      b1valg = 0
8.17 c                   eval      b_forn = *on
3.38 c                   update    b1sfl
3.38 c                   iter
3.38 c                   endif
3.31  *
3.31  * Gå direkte til bestillingssystem
3.31  *
3.31 c                   if        b1valg = 50
6.20 c                   if        fbko15 = 0
6.20 c                   eval      w_mld1 = a_meld(5)
6.20 c                   call      'AA005R'
6.20 c                   parm                    w_mld1
6.20 c                   eval      b1valg = 0
6.20 c                   exsr      xfarge
6.20 c                   update    b1sfl
6.20 c                   iter
6.20 c                   endif
5.34 c                   if        p_lpro <> *blank
5.34 c                   eval      p_lpro = *blank
5.34 c                   eval      b_exit = *on
5.34 c                   leavesr
5.34 c                   else
     c                   exsr      finn_best
5.34 c                   eval      p_lpro = 'F'
     c                   call      'LO500R'
6.nu c                   parm                    w_benr
5.34 c                   parm                    p_lpro
3.31 c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
3.31 c                   update    b1sfl
3.31 c                   iter
     c                   endif
3.31 c                   endif
5.54  *
5.54  * Viser loggfilen med ordrehistorikk
5.54  *
5.54 c                   if        b1valg = 60
5.60 c                   eval      w_aarr = %subdt(b1bdat:*years)
5.54 c                   eval      w_numm = b1numm
5.54 c                   eval      w_suff = b1suff
5.54 c                   call      'FU500R'
5.54 c                   parm                    w_firm
5.60 c                   parm                    w_aarr
6.nu c                   parm                    w_numm
5.54 c                   parm                    w_suff
5.54 c                   eval      b1valg = 0
5.54 c                   exsr      xfarge
5.54 c                   update    b1sfl
5.54 c                   iter
5.54 c                   endif
Q.01  *
Q.01  * Forhåndsvisning
Q.01  *
Q.01 c                   if        b1valg = 80
Q.01  * NB Skal ikke kunne kjøre ut faktura/kreditnota
Q.01 c                   eval      votyl1_otyp = b1otyp
Q.01 c     votyl1_key    chain     votyl1
Q.01 c                   if        vaoakk = 3
Q.01 c                   update    b1sfl
Q.01 c                   iter
Q.01 c                   endif
Q.01  *
Q.01 c                   exsr      ex_preview
Q.01 c                   eval      b1valg = 0
Q.01 c                   update    b1sfl
Q.01 c                   iter
Q.01 c                   endif
Q.01  *
Q.01  * Email
Q.01  *
Q.01 c                   if        b1valg = 81
Q.01  * NB Skal ikke kunne kjøre ut faktura/kreditnota
Q.01 c                   eval      votyl1_otyp = b1otyp
Q.01 c     votyl1_key    chain     votyl1
Q.01 c                   if        vaoakk = 3
Q.01 c                   update    b1sfl
Q.01 c                   iter
Q.01 c                   endif
Q.01  *
Q.01 c                   exsr      ex_email
Q.01 c                   eval      b1valg = 0
Q.01 c                   update    b1sfl
Q.01 c                   iter
Q.01 c                   endif
Q.02  *
Q.02  * Settes klar for plukking
Q.02  *
Q.02 c                   if        b1valg = 82
Q.02 c                   eval      fohelr_numm = b1numm
Q.02 c                   eval      fohelr_suff = b1suff
7.2j  *
7.2j  * Gi varsel dersom ordre er direktelevering
7.2j  *
7.2j c                   if        footyp = 'HO' and
7.2j c                             u_72j = *on
7.2j c                   eval      w_mld1 = 'Varsel: Hovedordre kan +
7.2j c                                       ikke sendes til plukk'
7.2j c                   call      'AA005R'
7.2j c                   parm                    w_mld1
7.2j c                   eval      b1valg = 0
7.2j c                   goto      b2taga
7.2j c                   else
7.25  *
7.25  * Gi varsel dersom ordre er direktelevering
7.25  *
7.25 c     fohelr_key    chain     fohelr
7.25 c                   if        %found
7.25 c                   if        folety = 1
7.25 c                   eval      w_mld1 = 'Varsel: Kan ikke plukkes +
7.25 c                                       da det er direktelevering'
7.25 c                   call      'AA005R'
7.25 c                   parm                    w_mld1
7.25 c                   eval      b1valg = 0
7.25 c                   eval      b_forn = *on
7.25 c                   update    b1sfl
7.25 c                   iter
7.25 c                   else
Q.02 c                   exsr      ex_pluk
Q.02 c                   eval      b1valg = 0
Q.02 c                   eval      b_forn = *on
Q.02 c                   exsr      ajo_subfile
Q.02 c                   exsr      xfarge
Q.02 c                   update    b1sfl
Q.02 c                   iter
7.25 c                   endif
7.25 c                   endif
7.2j c                   endif
Q.02 c                   endif
7.2f  *
7.2f  * Ordrelinjer eksport
7.2f  *
7.2f c                   if        b1valg = 83 and u_72D = *on
7.2f  *
7.2f c                   call      'FD101C'
7.2f c                   parm                    w_firm
7.2f c                   parm                    b1numm
7.2f c                   parm                    b1suff
7.2f c                   parm                    w_excel_url
7.2f c                   eval      b1valg = 0
7.2f c                   update    b1sfl
7.2f c                   iter
7.2f c                   endif
8.18  *
8.18  * Send SMS
8.18  *
8.18 c                   if        b1valg = 84
8.18 c                   exsr      ex_snd_SMS
8.18 c                   eval      b1valg = 0
8.18 c                   eval      b_forn = *on
8.18 c                   update    b1sfl
8.18 c                   iter
8.18 c                   endif
      *
      * Holde tilbake en ordre
      *
     c                   if        b1valg = 98
      *
      * Oppdatere ordrehode med
      * med holde/frigi
      *
     c                   eval      fohelu_numm = b1numm
     c                   eval      fohelu_suff = b1suff
     c     fohelu_key    chain     fohelur                            90
     c                   eval      w_ityp = foityp
6.30  *
6.30  * Ordre som er forsøkt sendt til belastning hos kortselskap
6.30  * kan ikke frigis.
6.30  *
6.30 c                   eval      rksjl1_jnum = b1numm
6.30 c                   eval      rksjl1_jsuf = b1suff
6.30 c     rksjl1_key    chain     rksjl1r
6.30 c                   if        %found
6.30 c                   if        rsjsta = 'S'
6.30 c                   goto      no_info
6.30 c                   endif
6.30 c                   endif
3.33  *
3.33  * Hent inn ordre-info-kode i inforegister
3.33  *
3.33 c                   eval      vinfl1_ityp = w_ityp
3.33 c     vinfl1_key    chain     vinfl1r                            92
3.33 c                   if        *in92  = *on
3.33 c                   eval      vaiusr = *blank
3.33 c                   endif
      *
3.32  * Sett kode til den som er angitt
3.32  * i status-register eller i bruker-register
      *
     c                   if        *in90  =  *off
     c                   if        w_ityp =  *blank
3.32 c                   eval      foityp =  faak98
3.32 c                   if        fbko98 <> *blank
3.32 c                   eval      foityp =  fbko98
3.32 c                   endif
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   endif
     c                   endif
3.15  *
3.13  * Fjerne kode som har krav om brukerkontroll
3.15  * Gi varsel dersom bruker ikke har lov,
3.15  * og slipp da opp igjen record lås.
3.15  *
3.15 c                   if        *in90  = *off
3.15 c                   if        fbko06 = 0
3.33 c                   if        vaiusr = '1'
3.15 c                   eval      w_mld1 = a_meld(4)
3.15 c                   call      'AA005R'
3.15 c                   parm                    w_mld1
3.15 c                   unlock    fohelu
3.15 c                   endif
3.15 c                   endif
3.15 c                   endif
      *
3.33  * Fjerne kode som har krav om brukerkontroll
      * dersom bruker har lov til dette
      *
     c                   if        *in90  = *off
     c                   if        fbko06 = 1
3.33 c                   if        vaiusr = '1'
     c                   eval      foityp = *blank
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   endif
     c                   endif
     c                   endif
      *
      * Fjerne øvrige koder
      *
     c                   if        *in90  =  *off
3.33 c                   if        vaiusr <> '1'
     c                   if        w_ityp <> *blank
     c                   eval      foityp =  *blank
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   endif
     c                   endif
     c                   endif
      *
     c                   eval      b1ityp = foityp
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
6.30  *
6.30 c     no_info       tag
6.30  *
     c                   endif
      *
      * Legge på egen ordre-info
      *
     c                   if        b1valg = 99
      *
      * Oppdatere ordrehode med
      * med egen ordre-info
      *
     c                   eval      fohelu_numm = b1numm
     c                   eval      fohelu_suff = b1suff
     c     fohelu_key    chain     fohelur                            90
     c                   eval      w_ityp = foityp
3.33  *
3.33  * Hent inn ordre-info-kode i inforegister
3.33  *
3.33 c                   eval      vinfl1_ityp = w_ityp
3.33 c     vinfl1_key    chain     vinfl1r                            92
3.33 c                   if        *in92  = *on
3.33 c                   eval      vaiusr = *blank
3.33 c                   endif
     c                   if        *in90  = *off
3.33 c                   if        vaiusr = ' ' or
3.33 c                             vaiusr = '1' and
3.33 c                             fbko06 = 1
     c                   call      'VA540R'
     c                   parm                    w_firm
     c                   parm                    w_ityp
     c                   parm                    w_itxt
     c                   eval      foityp = w_ityp
     c                   endif
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   endif
     c                   eval      b1ityp = foityp
     c                   eval      b1valg = 0
3.34 c                   exsr      xfarge
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - -
     c                   enddo
      * - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   if        b_forn = *on
     c                   exsr      forny
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * B9 Behandle bilde for sletting av behandlingskode og utplukk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xb9win        begsr
      *
      *  Henter inn opplysninger fra ORDRE-HODE-REGISTER
      *
     c     fohelr_key    chain     fohelrr                            90
8.01  *
8.01  *  Hvis kode er 9 (NGN), skal det ikke være mulig å løse sperren.
8.01  *
8.01 c                   if        fokode = 9
8.01 c                   eval      w_mld1 = 'Varsel: Ordren vedlikeholdes +
8.01 c                                       i NGN. Kan ikke frigis'
8.01 c                   call      'AA005R'
8.01 c                   parm                    w_mld1
8.01 c                   goto      xb9slt
8.01 c                   endif
      *
     c                   eval      b9numm = fonumm
     c                   eval      b9navn = fokuna
     c                   eval      w_numm = fonumm
     c                   eval      w_suff = fosuff
5.01  *
5.01  *  Henter inn kunderegister
5.01  *
5.01 c                   eval      rkunl1_kund = fokund
5.01 c                   eval      b9navn = fokuna
5.01 c                   eval      b9adre = *blank
5.01 c                   eval      b9sted = *blank
5.01 c     rkunl1_key    chain     rkunl1r                            90
5.01 c                   if        *in90  = *off
5.01 c                   eval      b9navn = rknavn
5.01 c                   eval      b9adre = rkgate
5.01 c                   eval      b9sted = rksted
5.01 c                   endif
      *
      *  Send Alt
      *
5.01 c                   eval      b9ordr = 0
5.01 c                   eval      b9paks = 0
     c     xb9tag        tag
     c                   write     b9win
     c                   exfmt     b9win
      *
      *  F12=Avslutt subrutinen
      *
     c                   if        *inkc or *inkl
     c                   goto      xb9slt
     c                   endif
      *
      *  Har bruker lov til å slette binding til ordre ?
      *
5.01 c                   if        b9ordr = 1
     c                   if        fbko03 = 0
     c                   if        fokode = 1
     c                   eval      *in31  = *on
     c                   goto      xb9tag
     c                   endif
     c                   endif
5.01 c                   endif
      *
      *  Kaller opp subprogrammet for sletting av utplukk
      *  og blanking av behandlinskode i ORDRE-HODE-REGISTER
      *
5.01 c                   if        b9ordr = 1
     c                   call      'FO412R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
5.01 c                   endif
      *
      *  Beregner nye summer for ordre
      *
5.01 c                   if        b9ordr = 1
     c                   eval      w_enor = *blank
     c                   call      'FO730R'
     c                   parm                    w_enor
     c                   parm                    w_firm
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
5.01 c                   endif
5.01  *
5.01  *  Har bruker lov til å oppheve skrevet pakkseddel ?
5.01  *
5.01 c                   if        b9paks = 1
5.01 c                   if        fbko09 = 0
5.01 c                   if        fopaks = 1
5.01 c                   eval      *in31  = *on
5.01 c                   goto      xb9tag
5.01 c                   endif
5.01 c                   endif
5.01 c                   endif
5.01  *
5.01  *  Opphev kode for skrevet pakkseddel
5.01  *
5.01 c                   if        b9paks = 1
5.01 c                   if        fopaks = 1
5.01 c                   eval      fohelu_numm = w_numm
5.01 c                   eval      fohelu_suff = w_suff
5.01 c     fohelu_key    chain     fohelur                            90
5.01 c                   eval      fopaks = 0
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
5.01 c                   update    fohelur
5.01 c                   endif
5.01 c                   endif
      *
      *  Nullstiller kode i subfile
      *
     c                   eval      b1kode = *blank
      *
     c     xb9slt        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for sjekking av input-felter
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xsjekk_inp    begsr
      *
     c                   eval      b_feil = *off
      *
      * Dato
      *
     c                   if        b2dato <> 0
     c     *dmy          test(d)                 b2dato                 34
     c                   if        *in34  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Sjekk om ordren allerede er til behandling (subfile)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xsjekk_ord1   begsr
      *
     c                   eval      b_sjek = *off
      *
      *  Sjekk, er denne ordren allerede til behandling
      *
     c                   if        b1kode <> *blank
     c                   eval      b_sjek =  *on
     c                   endif
      *
      *  Sjekk, er denne ordren allerede til behandling,
      *         Denne sjekken må utføres fordi subfilen
      *         ikke alltid er oppdatert
      *
     c                   if        b_sjek = *off
     c                   eval      fohelr_numm = b1numm
     c                   eval      fohelr_suff = b1suff
     c     fohelr_key    chain     fohelrr                            90
     c                   if        *in90  =  *off
     c                   if        fokode <> 0
     c                   eval      b_sjek =  *on
     c                   endif
     c                   endif
     c                   endif
      *
      *  Dersom det er valgt 5 for å vise ordre, skal det ikke
      *  være noen sperre på å få fram ordren.  I så fall
      *  nullstilles koden igjen for å kunne vise alle ordre.
      *
     c                   if        b1valg = 5
     c                   eval      b_sjek = *off
     c                   endif
      *
     c                   endsr
      *
3.14  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.14  *  Sjekker om bruker har lov til å endre pakkseddel
3.14  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.14  *
3.14 c     xsjekk_paks   begsr
3.14  *
3.14 c                   eval      b_stop = *off
3.14  *
3.14  *  Henter inn opplysninger fra ORDRE-HODE-REGISTER
3.14  *
3.14 c     fohelr_key    chain     fohelrr                            90
3.14  *
3.14  *  Henter inn opplysninger fra ORDRE-TYPE-REGISTER
3.14  *
3.14 c                   eval      votyl1_otyp = footyp
3.14 c     votyl1_key    chain     votyl1r                            90
3.14  *
3.14  *  Sjekk,  Har bruker lov til å endre ?  (gjelder pakkseddel)
3.14  *
3.14 c                   if        vaoakk = 2
3.35 c                   if        fbko07 = 0
3.14 c                   eval      b_stop = *on
3.14 c                   endif
3.14 c                   endif
6.31  *
6.31  *  Sjekk,  Har bruker lov til å endre ?  (gjelder faktura)
6.31  *
6.31 c                   if        vaoakk = 3
7.13 c                   if        u_713 = *on
7.13 c                   if        fbko11 = 0
7.13 c                   eval      b_stop = *on
7.13 c                   endif
7.13 c                   else
6.31 c                   if        fbko08 = 0
6.31 c                   eval      b_stop = *on
6.31 c                   endif
7.13 c                   endif
6.31 c                   endif
3.14  *
3.14 c                   endsr
5.41  *
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  *  Sjekker om oppgitt lager finnes på linje-nivå
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  *
5.41 c     xsjekk_lag    begsr
5.41  *
5.41  * Sjekker om oppgitt lagernummer er representert på
5.41  * en av varelinjene på ordren
5.41  *
5.41 c                   eval      w_funn = 0
5.41 c                   eval      fodtl1_numm = fonumm
5.41 c                   eval      fodtl1_suff = fosuff
5.41 c     fodtl1_key    setll     fodtl1
5.41 c     fodtl1_key    reade     fodtl1
5.41  *
5.41 c                   dow       not %eof
5.41 c                   if        fdlage = h1lage
5.41 c                   eval      w_funn = 1
5.41 c                   leave
5.41 c                   endif
5.41 c     fodtl1_key    reade     fodtl1
5.41 c                   enddo
5.41  *
5.41 c                   endsr
      *
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  * Sjekker om det finnes slettede varer blant varene i et tilbud
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  *
5.41 c     xsjekk_tilb   begsr
5.41  *
5.41 c                   eval      b_slet = *off
5.41  *
5.41 c                   eval      fodtl1_numm = fonumm
5.41 c                   eval      fodtl1_suff = fosuff
5.41 c     fodtl1_key    setll     fodtl1
5.41 c     fodtl1_key    reade     fodtl1
5.41 c                   dow       not %eof
      *
     c                   if        fdvare <> *blank and
     c                             fdlvre = 0
     c                   eval      vvarl1_vare = fdvare
     c     vvarl1_key    chain     vvarl1
     c                   if        not %found
     c                   eval      b_slet = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
5.41 c     fodtl1_key    reade     fodtl1
5.41 c                   enddo
5.41  *
5.41 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  B3 Behandle bilde for kopiere
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xb3win        begsr
      *
      * Henter inn opplysninger fra ordre-hode
      *
     c     fohelr_key    chain     fohelrr
6.28  *
6.28  * Hent opplysninger fra Depositum-fil
6.28  *
6.28 c                   eval      sdepl1_numm = fonumm
6.28 c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
6.28 c     sdepl1_key    chain     sdepl1r
6.28 c                   if        %found
6.28 c                   if        skdepo <> 0 or
6.28 c                             skdepb <> 0 or
6.28 c                             skdept <> 0
6.28 c                   eval      b_depo = *on
6.28 c                   endif
6.28 c                   endif
      *
     c                   eval      b3numm = fonumm
     c                   eval      b3navn = fonavn
3.37  *
      * Tilbud med slettede varer kan ikke kopieres
      * Dersom ordre som kopieres er et tilbud som inneholder slettede
      * varer, får bruker beskjed om dette og mulighet til å gå rett over
      * i vedlikehold av tilbudet
      *
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1
     c                   if        %found and
     c                             vaoakk = 0
     c                   exsr      xsjekk_tilb
     c                   if        b_slet = *on
     c                   exfmt     b3wint
     c                   if        *inkc = *off
     c                   eval      w_val2 = 2
     c                   eval      w_numm = fonumm
     c                   eval      w_suff = fosuff
     c                   call      'FO100R'
     c                   parm                    w_val2
6.nu c                   parm                    w_numm
     c                   parm                    w_suff
     c                   endif
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Kopiering av ordre
      *
3.37  * Ta vare på ordretype fra 'Fra-ordren'
3.37  *
3.37 c                   eval      s_otyp = footyp
      *
      * Nullstiller/Blanker felter som blir benyttet i bildet
      *
     c                   eval      b3nonr = 0
     c                   eval      b3otyp = *blank
     c                   eval      b3kund = fokund
7.04 c                   eval      b3krab = '0'
     c                   eval      b3kcop = 0
7.16 c                   if        u_716 = *on
7.16 c                   if        footyp = 'T '
7.16 c                   eval      b3kcop = 1
7.16 c                   eval      *in47  = *on
7.16 c                   else
7.16 c                   eval      *in47  = *off
7.16 c                   endif
7.16 c                   endif
5.51 c                   eval      b3xpro = 0
      *
      * Send Alt
      *
     c                   write     b3win
      *
     c     b3tagb        tag
      *
      * Bare data
      *
     c                   exfmt     b3win
      *
7.04 c                   move      b3krab        w_3krab
      *
      * F3=Avslutt subrutinen
      *
     c                   if        *inkc or *inkl
     c                   leavesr
     c                   endif
      *
      * F4=Spørring
      *
     c                   if        *inkd
      *
      *  Kunde
      *
7.xx c                   if        w_afldb3 = 'B3KUND'
     c                   call      'RK500R'
     c                   parm                    w_firm
     c                   parm                    b3kund
     c                   parm                    w_knav
     c                   goto      b3tagb
     c                   endif
      *
      *  Ordre-type
      *
7.xx c                   if        w_afldb3 = 'B3OTYP'
     c                   call      'VA550R'
     c                   parm                    w_firm
     c                   parm                    b3otyp
     c                   goto      b3tagb
     c                   endif
      *
     c                   goto      b3tagb
     c                   endif
      *
6.29  * Feilmelding, manuelt ordrenr kan ikke registreres
6.29 c                   if        b3nonr <> 0 and
6.29 c                             faaman = 0
6.29 c                   eval      *in39 = *on
6.29 c                   goto      b3tagb
6.29 c                   endif
6.29  *
      * Feilmelding dersom ordre finnes fra før
      *
     c                   eval      fohelr_num2 = b3nonr
     c                   eval      fohelr_suf2 = 0
     c     fohelr_ke2    chain     fohelrr
     c                   if        %found
     c                   eval      *in31 = *on
     c                   goto      b3tagb
     c                   endif
      *
      * Sjekk, Finnes ordretype i kode-register
      *
     c                   eval      votyl1_otyp = b3otyp
     c     votyl1_key    chain     votyl1r
     c                   if        not %found
     c                   eval      *in32 = *on
     c                   goto      b3tagb
     c                   endif
5.03  *
5.03 c                   if        vaosys <> 0
5.03 c                   eval      *in32 = *on
5.03 c                   goto      b3tagb
5.03 c                   endif
      *
      * Sjekk, Finnes vare-kunde-nummer i kunde-register
      *
     c                   eval      rkunl1_kund = b3kund
     c     rkunl1_key    chain     rkunl1r
     c                   if        not %found
     c                   eval      *in33 = *on
     c                   goto      b3tagb
     c                   endif
8.11  *
8.11  * Flyttet til etter oppslag mot kundetabell
7.19  *     Kun tillate ordretype 'T' på tilbudskunde
7.19  *
8.11 c*                  if        u_719 = *on
8.11 c*                  if        b3kund = 59998
8.11 c                   if        u_til = *on
8.11 c                   if        b3kund = faakun
7.19 c                             and b3otyp <> 'T'
7.19 c                   eval      *in68 = *on
7.19 c                   goto      b3tagb
7.19 c                   endif
7.19 c                   endif
      *
      * Sjekk, Er kunde sperret for registrering
      *
     c                   if        rksprk = 'J'
     c                   eval      *in35 = *on
     c                   goto      b3tagb
     c                   endif
3.39  *
3.39  * Kopiering til ordretype/beh.kode <> 0
3.39  * skal stoppes dersom kunden har kredittsperre.
3.39  *
3.39 c                   if        rkkres =  1
3.39 c                   if        vaoakk <> 0
3.39 c                   eval      *in36 = *on
3.39 c                   goto      b3tagb
3.39 c                   endif
3.39 c                   endif
6.22  *
6.22  * Kopiering til ordretype/beh.kode  > 1
6.22  * skal stoppes dersom kunden er kun kontant
6.22  *
6.22 c                   if        rkkres =  2
6.22 c                   if        vaoakk >  1
6.22 c                   eval      *in37 = *on
6.22 c                   goto      b3tagb
6.22 c                   endif
6.22 c                   endif
6.28  *
6.28  * Kan ikke slette ordre, hvis ordre har depositum
6.28  *
6.28 c                   if        b_depo = *on and b3kcop = 1
6.28 c                   eval      *in38 = *on
6.28 c                   goto      b3tagb
6.28 c                   endif
8.07  *  ______________________________________________________ 8.07 _
7.17  * Sjekk om kunde det kopieres til har passert kredit grense
7.17  *
8.07  *  Foreløpig hopp til ny løsning
8.07 c                   goto      t_806
7.17  *
7.17 c                   if        u_717 = *on
7.17  * Beregne memosaldo pr dato
7.17 c                   if        w_memodagr > 0
7.17 c                   move      w_firm        p_fir
7.17 c                   move      b3kund        p_kun
7.17 c                   call      'FO763R'
7.17 c                   parm                    p_fir
7.17 c                   parm                    p_kun
7.17 c                   endif
8.07  *    Dagens løsning starter her ______________________________
7.17  * Hent inn memosaldo
7.17 c     rkunl1_key    chain     rkmel1
7.17  * Sjekk, er kredittgrense overskredet
7.17  *
7.17 c                   if        rkgrns <> 0
7.17 c                   eval      w_ksal = rksald +
8.05 c**                                    (rkmems * w_mvat)
8.05 c                                      rkmems
7.17  *   Utvide kreditgrense   (Mestergruppen løsning 2017_01)  sst
7.17 c                   if        w_ksal < rkgrns * 1000
7.17 c                   eval      w_kgrn = rkgrns * 1000 *
7.17 c                                      (1+w_utvgrns/100)
7.17 c                   else
7.17 c                   eval      w_kgrn = rkgrns * 1000
7.17 c                   endif
7.17 c                   eval      w_ksal = w_ksal +
7.17 c                             (fotots - fototr) * w_mvat
7.17 c                   if        w_ksal > w_kgrn
7.17 c                   eval      *in40 = *on
7.17 c                   goto      b3tagb
7.17 c                   endif
7.17 c                   endif
8.07  *    Endif-717
7.17 c                   endif
8.07  *    Dagens løsning slutter her ______________________________
8.07 C     t_806         TAG
8.10  *
8.10  * Hvis ny ordretype er av typen "tilbud", dsv akkumulatortype 0
8.10  * skal det ikke sjekkes kreditgrenser.
8.15  * Ordretypen må også være satt til å telle med i ordregrunnlag.
8.10  *
8.15 c                   if        vaoakk > 0 and
8.15 c                             vaoogr > 0
8.10  *
8.07  *    Løsning fra FD100R starter her __________________________
7.17  * Beregne memosaldo pr dato
7.17 c                   move      w_firm        p_fir
7.17 c                   move      b3kund        p_kun
7.17 c                   call      'FO763R'
7.17 c                   parm                    p_fir
7.17 c                   parm                    p_kun
8.07  *
8.07  * Hent opplysninger fra kunderegister
8.07  *
8.07 c                   move      p_kun         rkunl1_kund
8.07 c     rkunl1_key    chain     rkunl1                             90
8.07  * hent inn informasjon om memosaldo
8.07 c     rkunl1_key    chain     rkmel1                             90
8.07  * Sjekk, er kredittgrense overskredet
8.07  *
8.07 c                   if        rkgrns <> 0
8.07 c                   if        u_kmem = *on
8.07 c                   eval      w_ksal = rksald +
8.07 c                                      rkmems
8.07 c                   eval      w_memodat = w_date + %days(w_memodagr)
8.07 c                   if        foldat <= w_memodat
8.14 c                   eval      w_ksal = w_ksal * w_mvat
8.14 c*                  eval      w_ksal = w_ksal +
8.14 c*                                     (fotots - fototr) * w_mvat
8.07 c                   endif
8.07  *   Utvide kreditgrense   (Mestergruppen løsning 2017_01)  sst
8.07 c                   if        w_ksal > rkgrns * 1000
8.07 c                   eval      w_kgrn = rkgrns * 1000 *
8.07 c                                      (1+w_utvgrns/100)
8.07 c                   else
8.07 c                   eval      w_kgrn = rkgrns * 1000
8.07 c                   endif
8.07  *
8.07  *   Else    u_kmem = *ON
8.07 c                   else
8.07 c                   if        (rksald + (rkmems * w_mvat)) < 999999999,99
8.14 c                   eval      w_ksal = (rksald + rkmems) * w_mvat
8.14 c*                  eval      w_ksal = rksald + rkmems +
8.14 c*                                     (fotots - fototr) * w_mvat
8.07 c                   else
8.07 c                   eval      w_ksal = 999999999,99
8.07 c                   endif
8.07 c                   eval      w_kgrn = rkgrns * 1000
8.07  *
8.07  *   Endif_  u_kmem = *ON
8.07 c                   endif
8.07  *
8.07 c                   eval      g1totl = w_ksal - w_kgrn
8.07  *
8.07 c                   eval      *in41 = *off
8.07 c                   if        w_ksal <= w_kgrn
8.07 c                             and ((fotots - fototr) * w_mvat) > w_kgrn
8.07 c                   eval      *in41 = *on
8.15 c*                  eval      g1totl = w_kgrn
8.15 c                   eval      g1totl = w_ksal +
8.15 c                                      ((fotots-fototr)*w_mvat) - w_kgrn
8.07 c                   endif
8.07  *
8.07 c                   if        w_ksal > w_kgrn
8.07 c                             or ((fotots - fototr) * w_mvat) > w_kgrn
8.07  *
8.07  * Kredittgrense er overksredet, send g1win
8.07  *
8.07 c     g1tagb        tag
8.07  *
8.07 c                   exfmt     g1win
8.07  *
8.07  * F18=Godkjenn overskridelsen
8.07  *
8.07 c                   if        *inks
8.07 c                   if        rkkgrk = 'J'
8.07  * Skal ikke vise bilde dersom kreditgrense er oversteget,
8.07  * skal kun vise og vedlikeholde tekstlinjer
8.07 c                   exfmt     g3win
8.07 c                   goto      g1tagb
8.07 c                   endif
8.07 c                   else
8.07 c                   leavesr
8.07 c                   endif
8.07  *
8.07  *   Endif_  w_ksal > w_kgrn
8.07 c                   endif
8.07  *
8.07  *   Endif_  RKGRNS > 0
8.07 c                   endif
8.07  *
8.07  *    Løsning fra FD100R slutter her __________________________
8.10  *
8.10 c                   endif
8.10  *
7.16  * Dersom det er kopiering av ORdretype 'T' til ny 'T' skal ikke
7.16  * fra tilbud slettes
7.16  *
7.16 c                   if        u_716 = *on
7.16 c                   if        *in47  = *on  and
7.16 c                             b3otyp = 'T'
7.16 c                   eval      b3kcop = 0
7.16 c                   eval      *in47  = *off
7.16 c                   endif
7.16 c                   endif
      *
      * Henter neste ledige ordrenummer, dersom ordrenummer til ikke
      * er utfylt
      *
     c     b3tagx        tag
      *
     c                   if        b3nonr = 0
      *
     c                   eval      w_kode = '0'
     c                   eval      w_numm = 0
     c                   exsr      hntnum
     c                   eval      fohelr_num2 = w_numm
     c                   endif
      *
     c     fohelr_ke2    chain     fohelrr
     c                   if        %found
     c                   goto      b3tagx
     c                   endif
7.20  *
7.20  * 3-306 Sjekk om rekalkulering skal foretas
7.20  *
7.20 c                   if        u_720 = *on
7.20 c                   Eval      w_omber_tilb = 'Nei'
7.20 c                   if        %diff(w_udat: fobdat: *d) > 30
7.20 c                             and footyp = 'T'
7.20 c                   eval      w_tilgko = l_user
7.20 c                   eval      w_rutine = 'TilbRekalk'
7.20 c                   eval      w_adv    = *blank
7.20 c                   eval      w_status = 'Uten'
7.20 c                   call      'AD005R'
7.20 c                   parm                    w_tilgko
7.20 c                   parm                    w_rutine
7.20 c                   parm                    w_adv
7.20 c                   parm                    w_status
7.20  *                            Valg om rekalk skal utføres
7.20 c                   if        w_status = 'VA'
7.20 c                   eval      w_mld1 = 'Tilbudet er > 30 dager og vil'
7.20 c                   eval      w_mld2 = 'bli rekalkulert, Er du enig?'
7.20 c                   eval      w_svar = 'J'
7.20 c                   call      'AA007R'
7.20 c                   parm                    w_mld1
7.20 c                   parm                    w_mld2
7.20 c                   parm                    w_svar
7.20 c                   parm                    w_in12
7.20 c                   endif
7.20 c                   if            w_status = 'VA'
7.20 c                             and w_svar   = 'J'
7.20 c                             or  w_status = 'AU'
7.20  *   Omebergning utsatt til etter kopiering og kjøres på ny ordre
7.20 c                   eval      w_omber_tilb = 'Ja'
7.20 c                   endif
7.20 c                   endif
7.20 c                   endif
      *
      * Kaller opp subprogram for kopiering av ordre
      *
     c                   call      'FO310R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.nu c                   parm                    fohelr_numm
     c                   parm                    fohelr_suff
6.nu c                   parm                    fohelr_num2
     c                   parm                    b3otyp
     c                   parm                    b3kund
7.04 c                   parm                    w_3krab
5.51 c                   parm                    b3xpro
     c                   parm                    b3ktxt
7.20  *
7.20  * 3-306 Ev. rekalkulering kjøres
7.20  *
7.20 c                   if        u_720 = *on
7.20 c                   if        w_omber_tilb = 'Ja'
7.20 c                   eval      w_enor = 'J'
7.20 c                   call      'FO730R'
7.20 c                   parm                    w_enor
7.20 c                   parm                    w_firm
7.20 c                   parm                    fohelr_num2
7.20 c                   parm                    fohelr_suff
7.20 c                   endif
7.20 c                   endif
7.16  *
7.16  *    Logge aktivitet mot tilbud
7.16  *
7.16  *
7.16  *  Kaller loggprogram for tilbudsoppfølging
7.16  *
7.16 c                   if        u_716 = *on
7.16 c                   if        footyp = 'T ' or
7.16 c                             s_otyp = 'T '
7.16 c                   eval      w_aktp = 'ORDRE'
7.16 c                   eval      w_sgru = *blank
7.16sc                   if        b3otyp = 'T'
7.16sc                   eval      w_sgru = 'Kopiert tilbud: ' +
7.16sc                                       %char(fohelr_num2)
7.16sc                   else
7.16 c                   eval      w_sgru = 'Overført ordre: ' +
7.16 c                                       %char(fohelr_num2)
7.16sc                   endif
7.16  *
7.16 c                   call      'XL700R'
7.16 c                   parm                    fohelr_numm
7.16 c                   parm                    w_aktp
7.16 c                   parm                    b4slko
7.16 c                   parm                    b4kkko
7.16 c                   parm                    w_sgru
7.16 c                   endif
7.16 c                   endif
      *
      * Kaller opp subprogrammet for sletting av ordre
      * dersom ordren skal slettes etter kopiering
      *
     c                   eval      b4kom1 = *blank
     c                   eval      b4kom2 = *blank
     c                   if        b3kcop = 1
3.17 c                   eval      b4numm = fonumm
3.17 c                   eval      b4navn = fonavn
7.16 c                   if        u_716 = *on and s_otyp = 'T '
7.22 c                   eval      b4kom1 = 'Tilbud er overført O: ' +
7.16 c                                      %char(fohelr_num2)
7.16 c                   goto      b3tagd
7.16 c                   else
     c                   write     b4win
     c     b3tagc        tag
     c                   exfmt     b4win
      *
      * F3=Anuller sletting
      *
     c                   if        *inkc or *inkl
     c                   leavesr
     c                   endif
3.37  *
3.37  * Sjekk, Har bruker lov til å slette ? (gjelder pakkseddel)
3.37  *
3.37 c                   eval      votyl1_otyp = s_otyp
3.37 c     votyl1_key    chain     votyl1r                            90
3.37 c                   if        vaoakk = 2
3.37 c                   if        fbko04 = 0
3.37 c                   eval      *in32  = *on
3.37 c                   goto      b3tagc
3.37 c                   endif
3.37 c                   endif
6.31  *
6.31  * Sjekk, Har bruker lov til å slette ? (gjelder faktura)
6.31  *
6.31 c                   if        vaoakk = 3
7.13 c                   if        u_713 = *on
7.13 c                   if        fbko11 = 0
7.13 c                   eval      *in32  = *on
7.13 c                   goto      b3tagc
7.13 c                   endif
7.13 c                   else
6.31 c                   if        fbko08 = 0
6.31 c                   eval      *in32  = *on
6.31 c                   goto      b3tagc
6.31 c                   endif
7.13 c                   endif
6.31 c                   endif
      *
      * Slettegrunn kan ikke være blank
      *
     c                   if        b4kom1 = *blank
     c                   eval      *in31  = *on
     c                   goto      b3tagc
     c                   endif
7.16  *
7.16 c                   endif
7.16  *    Kommer hit dersom slettegrunn er produsert automatisk
7.16 c     b3tagd        tag
      *
      * Kaller opp subprogrammet for sletting av ordre
      *
     c                   eval      w_typd = '*KOP'
     c                   eval      w_kom1 = b4kom1
     c                   eval      w_kom2 = b4kom2
     c                   call      'FO410R'
     c                   parm                    w_firm
6.nu c                   parm                    fohelr_numm
     c                   parm                    fohelr_suff
     c                   parm                    w_typd
     c                   parm                    w_kom1
     c                   parm                    w_kom2
5.02 c                   parm                    w_opdt
      *
      * Oppdater subfile
      *
5.33 c                   eval      b1knav = *blank
5.33 c                   eval      b1knav = 'Slettet'
5.33 c                   eval      b1navn = *blank
7.2C c                   eval      b1kpro = *zero
     c                   eval      b1info = *blank
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  B4 Behandle bilde for sletting av ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xb4win        begsr
      *
      *  Henter inn opplysninger fra ORDRE-HODE-REGISTER
      *
     c     fohelr_key    chain     fohelrr                            90
     c                   eval      b4numm = fonumm
     c                   eval      b4navn = fokuna
6.33  *
6.33  * Sjekk, Finnes det fortsatt bestilling på denne ?
6.33  * gir melding.
6.33  *
6.33 c                   eval      fodtl1_numm = fonumm
6.33 c                   eval      fodtl1_suff = fosuff
6.33 c     fodtl1_key    setll     fodtl1
6.33 c     fodtl1_key    reade     fodtl1
6.33  *
6.33 c                   dow       not %eof
6.33 c                   if        fdbenr <> 0
6.33 c                   eval      lohel1_numm = fdbenr
6.33 c     lohel1_key    chain     lohel1
6.33 c                   if        %found(lohel1)
6.33 c                   eval      w_mld1 = 'Bestilling ' +
6.33 c                             %char(fdbenr) + ' knyttet til ' +
6.33 c                             'denne ordren!'
6.34 c                   eval      w_mld2 = 'Vil du slette alikevel ?'
6.34 c                   eval      w_svar = 'N'
6.34 c                   call      'AA007R'
6.33 c                   parm                    w_mld1
6.34 c                   parm                    w_mld2
6.34 c                   parm                    w_svar
6.34 c                   parm                    w_in12
6.34  *
6.34  * F12 er tatt
6.34  *
6.34 c                   if        w_in12 = 1
6.34 c                   leavesr
6.34 c                   endif
6.34  *
6.34 c                   if        w_svar = 'N'
6.34 c                   leavesr
5.02 c                   endif
6.34 c                   goto      b4taga
6.33 c                   endif
6.33 c                   endif
6.33 c     fodtl1_key    reade     fodtl1
6.33 c                   enddo
6.34 c     b4taga        tag
      *
      *  Henter inn opplysninger fra ORDRE-TYPE-REGISTER
      *
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1r                            90
7.11  *
7.11  *  Setter indikator for styring av tilbudssletting
7.11  *
7.11 c                   eval      *in41 = *off
7.11 c                   if        u_711 = *on
7.11 c                   if        footyp = 'T '
7.11 c                   eval      *in41 = *on
7.11 c                   eval      b4slko = 0
7.11 c                   eval      b4kkko = 0
7.11 c                   eval      b4sltx = *blank
7.11 c                   eval      b4kktx = *blank
7.11 c                   else
7.11 c                   eval      *in41 = *off
7.11 c                   endif
7.11 c                   endif
      *
      *  Send Alt
      *
      *
     c                   eval      b4kom1 = *blank
     c                   eval      b4kom2 = *blank
     c                   write     b4win
     c     b4tagc        tag
7.15 c                   if        u_711 = *on
7.15 c                   if        b4kom1 = *blank
7.15 c                   movel     b4sltx        b4kom1
7.15 c                   endif
7.15 c                   endif
     c                   exfmt     b4win
      *
      *  F12=Avslutt subrutinen
      *
     c                   if        *inkc or *inkl
     c                   goto      b4tag1
     c                   endif
7.15  *
7.15  *  F4=Spørring
7.15  *
7.15 c                   if        u_711 = *on
7.15 c                   if        *inkd
7.15 c                   if        w_afld = 'B4SLKO'
7.15 c                   call      'XS500R'
7.15 c                   parm                    w_firm
7.15 c                   parm                    b4slko
7.15 c                   parm                    b4sltx
7.15 c                   parm                    w_kkko
7.15 c                   goto      b4tagc
7.15 c                   endif
7.15 c                   if        w_afld = 'B4KKKO'
7.15 c                   call      'XK500R'
7.15 c                   parm                    w_firm
7.15 c                   parm                    b4kkko
7.15 c                   parm                    b4kktx
7.15 c                   goto      b4tagc
7.15 c                   endif
7.15 c                   endif
7.15  *   Slettekode må være utfyllt
7.15 c                   if        footyp = 'T '
7.15 c                   eval      xtsll1_firm = w_firm
7.15 c                   eval      xtsll1_skod = b4slko
7.15 c     xtsll1_key    chain     xtsll1
7.15 c                   if        not %found(xtsll1)
7.15 c                   eval      *in33 = *on
7.15 c                   goto      b4tagc
7.15 c                   endif
7.15 c                   eval      b4sltx = xsteks
8.09 c                   if        %trim(b4kom1) = *blanks
8.09 c                   eval      b4kom1 = %trim(xsteks)
8.09 c                   endif
7.15  *   Hvis slettekode har krav om konkurentkode må denne fylles ut
7.15 c                   if        xskkko = 'J'
7.15 c                   if        b4kkko = *zero
7.15 c                   eval      *in34  = *on
7.15 c                   goto      b4tagc
7.15 c                   endif
7.15  *
7.15 c                   eval      xtkkl1_firm = w_firm
7.15 c                   eval      xtkkl1_kkod = b4kkko
7.15 c     xtkkl1_key    chain     xtkkl1
7.15 c                   if        not %found(xtkkl1)
7.15 c                   eval      *in35  = *on
7.15 c                   goto      b4tagc
7.15 c                   endif
7.15 c                   eval      b4kktx = xkteks
7.15 c                   endif
7.15 c                   endif
7.15 c                   endif
      *
      *
      *  Sjekk,  Har bruker lov til å slette ? (gjelder pakkseddel)
      *
     c                   if        vaoakk = 2
     c                   if        fbko04 = 0
     c                   eval      *in32  = *on
     c                   goto      b4tagc
     c                   endif
     c                   endif
6.31  *
6.31  * Sjekk, Har bruker lov til å slette ? (gjelder faktura)
6.31  *
6.31 c                   if        vaoakk = 3
7.13 c                   if        u_713 = *on
7.13 c                   if        fbko11 = 0
7.13 c                   eval      *in32  = *on
7.13 c                   goto      b4tagc
7.13 c                   endif
7.13 c                   else
6.31 c                   if        fbko08 = 0
6.31 c                   eval      *in32  = *on
6.31 c                   goto      b4tagc
6.31 c                   endif
7.13 c                   endif
6.31 c                   endif
      *
      *  Sjekk,  Dersom det er gitt en Akseptfrist, kan ikke
      *          dato for utgåttdato være utfylt, ved sletting
      *
     c***>               if        fotkod = 'A'
     c***> Ny            if        fotdat <> *loval
     c***> Løsning       eval      *in31  =  *on
     c***>               endif
     c***>               endif
      *
      *  Slettegrunn kan ikke være blank
      *
     c                   if        b4kom1 = *blank
     c                   eval      *in31  =  *on
     c                   goto      b4tagc
     c                   endif
7.15  *
7.15  *  Kaller loggprogram for tilbudsoppfølging
7.15  *
7.15 c                   if        u_711 = *on
7.15 c                   if        footyp = 'T '
7.15 c                   eval      w_aktp = 'SLETTET'
7.15 c                   eval      w_sgru = b4kom1 + b4kom2
7.15  *
7.15 c                   call      'XL700R'
7.15 c                   parm                    fonumm
7.15 c                   parm                    w_aktp
7.15 c                   parm                    b4slko
7.15 c                   parm                    b4kkko
7.15 c                   parm                    w_sgru
7.15 c                   endif
7.15 c                   endif
      *
      *
      *  Kaller opp subprogrammet for sletting av ordre
      *
     c                   eval      w_typd = '*STD'
     c                   eval      w_kom1 = b4kom1
     c                   eval      w_kom2 = b4kom2
     c                   call      'FO410R'
     c                   parm                    w_firm
6.nu c                   parm                    fohelr_numm
     c                   parm                    fohelr_suff
     c                   parm                    w_typd
     c                   parm                    w_kom1
     c                   parm                    w_kom2
5.02 c                   parm                    w_opdt
5.62  *
5.62  *  Sletter post i depositum-file
5.62  *
5.62 c                   eval      sdeplu_numm = fonumm
5.62 c                   eval      sdeplu_kund = fokund
7.fb c                   eval      sdeplu_tell = 0
5.62 c     sdeplu_key    chain     sdeplur
5.62 c                   if        %found
5.62 c                   delete    sdeplur
5.62 c                   endif
6.26  *
6.26  *  Sletter evt. best.forslag på denne ordre
6.27  *  Tester om bestillingsforslag har opprinnelse fra Ordre
6.26  *
6.27 c                   if        b4numm <> 0
6.27  *
6.26 c     lfhelr_key    setll     lfhelrr
6.26 c     lfhelr_key    reade     lfhelrr
6.26 c                   dow       not %eof(lfhelr)
6.27 c                   if        b4numm = lhornr and
6.27 c                             lhoppr = 'O'
6.26 c                   eval      lfhelu_numm = lhnumm
6.26 c     lfhelu_key    chain     lfhelu
6.26 c                   if        %found(lfhelu)
6.26 c                   delete    lfhelur
6.26 c                   endif
6.26 c                   eval      lfdtlu_numm = lhnumm
6.26 c     lfdtlu_key    setll     lfdtlu
6.26 c     lfdtlu_key    reade     lfdtlu
6.26 c                   dow       not %eof(lfdtlu)
6.26 c                   delete    lfdtlur
6.26 c     lfdtlu_key    reade     lfdtlu
6.26 c                   enddo
6.26 c                   endif
6.26  *
6.26 c     lfhelr_key    reade     lfhelrr
6.26 c                   enddo
      *
6.27 c                   endif
      *
      *  Oppdater subfile
      *
5.33 c                   eval      b1knav = *blank
5.33 c                   eval      b1knav = '*Slettet'
     c                   eval      b1navn = *blank
7.2C c                   eval      b1kpro = *zero
     c                   eval      b1info = *blank
      *
     c     b4tag1        tag
      *
     c                   endsr
5.62  *
5.62  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.62  *  B4T Sjekker om verdier i depositum - kan ikke slette da
5.62  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.62  *
5.62 c     xb4wint       begsr
5.62  *
5.62  * Hent Ordrehode
5.62  *
5.62 c     fohelr_key    chain     fohelrr                            90
5.62  *
5.62  * Hent opplysninger fra Depositum-fil
5.62  *
5.62 c                   eval      sdepl1_numm = fonumm
5.62 c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
5.62 c     sdepl1_key    chain     sdepl1r
5.62 c                   if        %found
5.62 c                   if        skdepo <> 0 or
5.62 c                             skdepb <> 0 or
5.62 c                             skdept <> 0
5.62 c                   exfmt     b4wint
5.62 c                   eval      b_depo = *on
5.62 c                   endif
5.62 c                   endif
5.62  *
5.62 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  B6 Behandle bilde for utskrift av ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xb6win        begsr
6.23  *
6.23  * sjekker om lev.dato utfylt hvis krav
6.23  *
6.23 c                   if        faalds = 1
6.23 c     fohelr_key    chain     fohelr
6.23 c                   eval      votyl1_otyp = footyp
6.23 c     votyl1_key    chain     votyl1r
6.23 c                   if        vaoakk > 0 and
6.23 c                             foldat = *loval
6.23 c                   exsr      xb16msg
6.23 c                   leavesr
6.23 c                   endif
6.23 c                   endif
      *
      *  Kaller opp subprogrammet for utskriftsvalg
      *
     c                   call      'FO600R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.nu c                   parm                    fohelr_numm
     c                   parm                    fohelr_suff
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  B16 Behandle bilde for utplukk av en ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xb16wi        begsr
6.23  *
6.23  * sjekker om lev.dato utfylt hvis krav
6.23  *
6.23 c                   if        faalds = 1
6.23 c     fohelr_key    chain     fohelr
6.23 c                   eval      votyl1_otyp = footyp
6.23 c     votyl1_key    chain     votyl1r
6.23 c                   if        vaoakk > 0 and
6.23 c                             foldat = *loval
6.23 c                   exsr      xb16msg
6.23 c                   leavesr
6.23 c                   endif
6.23 c                   endif
      *
      *  Kaller opp subprogrammet for utplukksvalg
      *
     c                   call      'FO736R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.nu c                   parm                    fohelr_numm
     c                   parm                    fohelr_suff
      *
     c                   endsr
5.63  *
5.63  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.63  *  Sjekk om depositum er betalt - en forutsetning for bestilling
5.63  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.63  *
5.63 c     xb18msg       begsr
7.fb  *
7.fb c                   eval      w_sumi = 0
7.fb c                   eval      w_sumu = 0
7.fb  * hvis krav til beløp, sjekk først om ordre er større enn dette
7.fb c                   if        faak11 = 1 and
7.fb c                             faakbs <> 0
7.fb  * Beregn ordretotal
7.fb c                   eval      w_sumi = 0
7.fb c                   eval      w_sumu = 0
7.fb c                   call      'FO704R '
7.fb c                   parm                    w_firm
7.fb c                   parm                    b1numm
7.fb c                   parm                    b1suff
7.fb c                   parm                    w_sumi
7.fb c                   parm                    w_sumu
7.fb c                   eval(h)   w_depb = w_sumi * faamap/100
7.fb c                   endif
7.fb  * Sjekker om depositum er betalt
7.fb  * 2 muligheter, hvis man kjører depositumsløsning og kode kontant-kode satt, sjekk eller at
7.fb  * man ikke kjører depositumsløsning
7.fb c                   if        faak11 = 0 or
7.fb c                             (faak11 = 1 and
7.fb c                              faak12 = 1)
7.fb c                   eval      fohel1_numm = b1numm
7.fb c                   eval      fohel1_suff = b1suff
7.fb c     fohel1_key    chain     fohel1
7.fb c                   if        %found(fohel1)
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
7.fb c     sdepl1_key    chain     sdepl1
7.fb c                   if        %found(sdepl1)
7.fb c                   if        skdepo < w_depb
7.fb c                   eval      b_depo  = *on
7.fb c                   eval      w_mld1 = 'Depositumbeløp for lite  på ordren'
7.fb c                   call      'AA005R'
7.fb c                   parm                    w_mld1
7.fb c                   leavesr
7.fb c                   endif
7.fb c                   if        skdepb < skdepo
7.fb c                   eval      b_depo  = *on
7.fb c                   exfmt     b18msg
7.fb c                   leavesr
7.fb c                   endif
7.fb c                   else
7.fb c                   if        faak12 = 1
7.fb  * sjekk om kunde er kontantkunde
7.fb  *
7.fb c                   eval      rkunl1_kund = fokund
7.fb c     rkunl1_key    chain     rkunl1
7.fb c                   if        %found(rkunl1) and
7.fb c                             rkkres = 2
7.fb c                   eval      b_depo  = *on
7.fb c                   eval      w_mld1 = 'Det mangler depositum på ordren'
7.fb c                   call      'AA005R'
7.fb c                   parm                    w_mld1
7.fb c                   leavesr
7.fb c                   endif
7.fb  *  eller har BM-kort eller Santander
7.fb c                   if        fopsuf = 5 or fopsuf = 6
7.fb c                   eval      b_depo  = *on
7.fb c                   eval      w_mld1 = 'Det mangler depositum på ordren'
7.fb c                   call      'AA005R'
7.fb c                   parm                    w_mld1
7.fb c                   leavesr
7.fb c                   endif
7.fb c                   endif
7.fb c                   endif
7.fb c                   endif
7.fb c                   endif
5.63  *
5.63 c                   endsr
5.63  *
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  *  Gir melding hvis man tar valg 18 og kommer fra bestilling
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  *
6.21 c     xb18msg2      begsr
6.21 c                   exfmt     b18msg2
6.21  *
6.21 c                   endsr
7.18  *
7.18  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.18  *  Gir melding hvis man tar valg 18 på hovedordre
7.18  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.18  *
7.18 c     xb18msg3      begsr
7.18 c                   exfmt     b18msg3
7.18  *
7.18 c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  *  Gir melding hvis man tar valg 16 eller 6 og lev.dato ikke er
6.21  *  utfylt
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  *
6.21 c     xb16msg       begsr
6.21 c                   exfmt     b16msg
6.21  *
6.21 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  B28 Behandle bilde for tilbakestilling av plukket ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xb28wi        begsr
      *
      *  Kaller opp subprogrammet for tilbakestilling
      *
     c                   call      'FD710R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.nu c                   parm                    fohelr_numm
     c                   parm                    fohelr_suff
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for lesing av historikk på ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     historikk     begsr
      *
6.24 c                   eval      w_ntyp = '1'
     c                   call      'FO550R'
6.nu c                   parm                    w_numm
6.24 c                   parm                    w_ntyp
      *
     c                   endsr
      *
Q.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.01  * Forhåndsvisning
Q.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.01  *
Q.01 c     ex_preview    begsr
Q.01  *
Q.01 c                   eval      w_numm = b1numm
Q.01 c                   eval      w_suff = b1suff
Q.01 c                   eval      w_acti = 'P'
Q.01 c                   eval      w_stat = *blanks
Q.01 c
Q.01 c                   call      'QO600C'
Q.01 c                   parm                    w_numm
Q.01 c                   parm                    w_suff
Q.01 c                   parm                    w_acti
Q.01 c                   parm                    w_stat
Q.01  *
Q.01 c                   endsr
Q.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.01  * E-mail
Q.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.01  *
Q.01 c     ex_email      begsr
Q.01  *
Q.01 c                   eval      w_numm = b1numm
Q.01 c                   eval      w_suff = b1suff
Q.01 c                   eval      w_acti = 'E'
Q.01 c                   eval      w_stat = *blanks
Q.01 c
Q.01 c                   call      'QO600C'
Q.01 c                   parm                    w_numm
Q.01 c                   parm                    w_suff
Q.01 c                   parm                    w_acti
Q.01 c                   parm                    w_stat
Q.01  *
Q.01 c                   endsr
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  *  Behandle valg for plukking
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  *
Q.02 c     ex_pluk       begsr
Q.02  *
Q.02  * Kaller program som sjekker og gjør utplukk
Q.02  *
Q.02 c                   eval      b_pluk = *on
Q.02 c                   call      'QO736R'
Q.02 c                   parm                    fohelr_numm
Q.02 c                   parm                    fohelr_suff
Q.02 c                   parm                    b_pluk
Q.02  *
Q.02 c                   endsr
Q.02  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter/Oppdatering av NUMMER-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hntnum        begsr
      *
     c                   eval      w_fell = faaork
     c                   eval      w_type = b3otyp
     c                   eval      w_fast = l_wsid
5.32  *
5.32  * Hente inn eventuell overstyrt
5.32  * ordretype for nummerserie
5.32  *
5.32 c                   call      'VA752R'
5.32 c                   parm                    w_firm
5.32 c                   parm                    b3otyp
5.32 c                   parm                    w_onum
5.32  *
5.32 c                   if        w_onum <> *blank
5.32 c                   eval      w_type = w_onum
5.32 c                   endif
      *
      *  Kaller opp subprogram for henting av nummer fra NUMMER-REGISTER
      *
     c                   call      'AS100R'
     c                   parm                    w_kode
     c                   parm                    w_firm
     c                   parm                    w_fell
     c                   parm                    w_type
     c                   parm                    w_fast
6.nu c                   parm                    w_numm
      *
6.12x * sjekker at ordrenr ikke har tidligere relasjoner liggende
6.12x *
6.12xc                   call      'FO415R '
6.12xc                   parm                    w_firm
6.nu c                   parm                    w_numm
      *
     c                   endsr
3.34  *
3.34  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.34  * Setter opp farge på infokode
3.34  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.34  *
3.34 c     xfarge        begsr
3.34  *
3.34  * Hent inn ordre-info-kode i inforegister
3.34  *
3.34 c                   eval      vinfl1_ityp = b1ityp
3.34 c     vinfl1_key    chain     vinfl1r                            92
3.34 c                   if        *in92  = *on
3.34 c                   eval      vaifrg = *blank
3.34 c                   endif
3.34  *
3.34 c                   if        vaifrg = ' '
3.34 c                   eval      *in41  = *off
3.34 c                   eval      *in42  = *off
3.34 c                   eval      *in43  = *off
3.34 c                   eval      *in44  = *off
3.34 c                   endif
3.34  *
3.34 c                   if        vaifrg = 'H'
3.34 c                   eval      *in41  = *on
3.34 c                   eval      *in42  = *off
3.34 c                   eval      *in43  = *off
3.34 c                   eval      *in44  = *off
3.34 c                   endif
3.34  *
3.34 c                   if        vaifrg = 'G'
3.34 c                   eval      *in41  = *off
3.34 c                   eval      *in42  = *on
3.34 c                   eval      *in43  = *off
3.34 c                   eval      *in44  = *off
3.34 c                   endif
3.34  *
3.34 c                   if        vaifrg = 'B'
3.34 c                   eval      *in41  = *off
3.34 c                   eval      *in42  = *off
3.34 c                   eval      *in43  = *on
3.34 c                   eval      *in44  = *off
3.34 c                   endif
3.34  *
3.34 c                   if        vaifrg = 'R'
3.34 c                   eval      *in41  = *off
3.34 c                   eval      *in42  = *off
3.34 c                   eval      *in43  = *off
3.34 c                   eval      *in44  = *on
3.34 c                   endif
3.34  *
5.54  * Legger sammen alle tre koder til en variabel
5.54  *
5.54 c                   eval      b1alle = b1ityp + b1kod2 + b1kode
      *
7.14 c                   if        u_714 = *on
7.14 c                   eval      *in45  = *off
7.14 c                   eval      *in46  = *off
7.14 c                   if        b1lety = 1
7.14 c                   eval      *in45  = *on
7.14 c                   endif
7.14 c                   if        b1kres = 2
7.14 c                   eval      *in46  = *on
7.14 c                   endif
7.14 c                   endif
7.fb  * sjekker om depo, setter på farge.
7.fb c                   exsr      sjekk_depo
5.54  *
3.34 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * xh1win  Bilde for behandling av bla-alternativer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xh1win        begsr
      *
     c     h1taga        tag
      *
     c                   write     h1win
     c                   exfmt     h1win
      *
      * Behandling av funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   leavesr
     c                   when      *inkd
     c                   exsr      spØrring
5.20 c                   when      *inki
5.20 c                   exsr      lagring
     c                   goto      h1taga
     c                   endsl
      *
      * Legg inn 'O' dersom over/under
      * er blank og beløp er oppgitt
      *
     c                   if        h1belp <> 0
     c                   if        h1valg =  *blank
     c                   eval      h1valg =  'O'
     c                   endif
     c                   endif
7.29  **
7.29  ** Etter at man har vært inne i dette vindu (H1WIN)
7.29  ** velges logisk fil tilbake til ordrerekkefølge
7.29  ** og sub-file fylles på nytt.
7.29  **
7.29 c*                   eval      w_seqe = *blank
7.29 c*                   eval      fohel1_numm = 0
7.29 c*                   eval      fohel1_suff = 0
3.31  *
3.31  * Dersom bestillingsnummer er lagt inn,
3.31  * slå opp mot ordrehode i bestilling for å
3.31  * finne ordrenummer og posisjoner på dette.
3.31  *
3.31 c                   if        h1benr <> 0
7.29  *
7.29  * Etter at man har vært inne i dette vindu (H1WIN)
7.29  * velges logisk fil tilbake til ordrerekkefølge
7.29  * og sub-file fylles på nytt.
7.29  *
7.29 c                   eval      w_seqe = *blank
7.29 c                   eval      fohel1_numm = 0
7.29 c                   eval      fohel1_suff = 0
3.31 c                   eval      lohel1_numm = h1benr
3.39 c*                  eval      lohel1_suff = 0
3.39 c     lohel1_key    setll     lohel1                                 93
3.39 c     lohel1_key    reade     lohel1                                 93
3.31 c                   if        *in93  = *off
3.31 c                   eval      fohel1_numm = loornr
3.31 c                   eval      fohel1_suff = loorsu
3.31 c                   else
3.31 c                   eval      loornr = 0
3.31 c                   eval      loorsu = 0
3.31 c                   endif
7.29  *
7.29  * Fyller subfile på nytt
7.29  *
7.29 c     fohel1_key    setll     fohel1
7.29 c                   else
7.29 c                   if        w_seqe = 'S'
7.29 c                   exsr      forny
7.29 c                   leavesr
7.29 c                   endif
3.31 c                   endif
7.29  **
7.29  ** Fyller subfile på nytt
7.29  **
7.29 c*     fohel1_key    setll     fohel1
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c                   endsr
      *
3.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.12  * Subrutine for ajourføring av subfile
3.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.12  *
3.12  * Det er laget en egen subrutine for ajourføring av subfile.
3.12  * Denne blir aktivisert når det er et valg som betinger call til et
3.12  * nytt program som oppdaterer ordre.  For å få ajourført subfile
3.12  * uten ny posisjonering må det gjøres et nytt oppslag mot ordren.
3.12  *
3.12 c     ajo_subfile   begsr
3.12  *
3.12 c                   eval      fohelr_numm = b1numm
3.12 c                   eval      fohelr_suff = b1suff
3.12 c     fohelr_key    chain     fohelrr                            90
3.12  *
3.12  * Ajourfør subfile
3.12  *
     c                   eval      b1numm = fonumm
     c                   eval      b1suff = fosuff
     c                   eval      b1otyp = footyp
     c                   eval      b1navn = fonavn
7.2C c                   eval      b1kpro = fokpro
     c                   eval      b1info = *blank
3.12 c                   eval      b1ityp = foityp
3.12  *
3.12 c     *dmy          move      fobdat        b1dato
3.12  *
7.02 c                   exsr      finn_best
7.2h c*                   if        *in71  =  *off and w_oa_on = 0
7.2h c                   if        *in71  =  *off
3.12 c                   eval      b1dato =  0
3.12 c                   if        foldat <> *loval
3.12 c     *dmy          move      foldat        b1dato
3.12 c                   endif
7.02 c*                  exsr      finn_best
3.12 c                   if        w_benr <> 0
3.12 c                   move      w_benr        b1info
3.12 c                   endif
3.12 c                   endif
3.12  *
3.12 c                   eval      b1kode = *blank
3.12 c                   if        fokode <> 0
3.12 c                   eval      b1kode = '**'
3.12 c                   endif
3.12 c                   if        fokode = 2
3.12 c                   eval      b1kode = 'UT'
3.12 c                   endif
3.12 c                   if        fokode = 3
3.12 c                   eval      b1kode = 'OK'
3.12 c                   endif
3.12 c                   if        fokode = 5
3.12 c                   eval      b1kode = 'VE'
3.12 c                   endif
3.12 c                   if        fokode = 7
3.12 c                   eval      b1kode = 'BU'
3.12 c                   endif
8.01  * Hvis sperrekoden kommer NGN, sett kode NG.
8.01 c                   if        fokode = 9
8.01 c                   eval      b1kode = 'NG'
8.01 c                   endif
3.12  *
5.33 c                   eval      b1knav      = *blank
8.06 c                   if        folkun <> 0
8.06 c                   eval      rkunl1_kund = folkun
8.06 c                   else
3.12 c                   eval      rkunl1_kund = fokund
8.06 c                   endif
3.12 c     rkunl1_key    chain     rkunl1r                            90
3.12 c                   if        *in90
5.33 c                   eval      b1knav = fokuna
3.12 c                   else
5.33 c                   eval      b1knav = rknavn
3.12 c                   endif
8.02  * Egen logikk ved hvis varekunde, fakturakunde og prosjektnummer
8.02 c                   if        folkun <> fokund and
8.02 c                             fokpro <> 0
8.02 c                   eval      b1knav = fokuna
8.02 c                   endif
3.12 c                   eval      b1kund = fokund
5.33 c                   eval      b1kuna = fokuna
3.12  *
3.12 c                   eval      b1salg = (fotots - fototr)
3.12 c                   if        b_moms = *on
     c                   if        (b1salg * w_mvat) > 999999999,99
     c                   eval      b1salg = 999999999,99
     c                   else
     c                   eval      b1salg = (b1salg * w_mvat)
     c                   endif
3.12 c                   endif
7.2h c*                   if        *in71 or w_oa_on > 0
7.2h c                   if        *in71 =*on
3.12 c                   eval      w_salg = %editw(b1salg : '         ,  -')
3.12 c                   move      w_salg        b1info
3.12 c                   endif
3.12  *
7.2C c                   eval      b1llda = 0
7.01 c                   if        (foldat <> *loval)
7.01 c     *dmy          move      foldat        w_datn
7.2C c     *dmy          move      foldat        b1llda
7.01 c                   eval      b1ldat = %editw(w_datn : '  .  .  ')
7.01 c                   else
7.01 c                   eval      b1ldat = ''
7.01 c                   endif
7.01 c                   eval      b1benr = w_benr
7.01 c                   eval      b1oous = fooous
7.01 c                   eval      b1eusr = foeusr
7.01 c                   if        (fodate <> *loval)
7.01 c     *dmy          move      fodate        w_datn
7.01 c                   eval      b1date = %editw(w_datn : '  .  .  ')
7.01 c                   else
7.01 c                   eval      b1date = ''
7.01 c                   endif
7.03 c                   eval      b1dref = fodref
7.03 c                   eval      b1lety = folety
7.2C c                   eval      b1lmat = folmat
7.01 c                   eval      b1mobi = fomobi
7.01 c                   eval      w_salg = %editw(fototr : '         ,  -')
7.01 c                   move      w_salg        b1rabt
7.01 c                   eval      w_belp2 = (fotots - fototr)
7.01 c                   if        (w_belp2 * w_mvat) > 999999999,99
7.01 c                   eval      w_belp2 = 999999999,99
7.01 c                   else
7.01 c                   eval      w_belp2 = (w_belp2 * w_mvat)
7.01 c                   endif
7.01 c                   eval      w_salg = %editw(w_belp2 : '         ,  -')
7.01 c                   move      w_salg        b1inkm                            *
      *
7.2A c                   exsr      newlo_vask
      *
3.12 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for tømming av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     clr_subfile   begsr
      *
     c                   eval      *in14  = *on
     c                   write     b2ctl
     c                   eval      *in14  = *off
      *
     c                   eval      *in15  = *off
     c                   eval      w_srrn = 0
     c                   eval      w_sfrn = 0
     c                   eval      w_ssrn = 0
     c                   eval      w_spge = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å fylle opp subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     crt_subfile   begsr
      *
     c                   eval      w_spge = w_spge + c_sfil
     c                   eval      w_srrn = w_ssrn
      *
7.05  * Initierer SQL for søk
7.05  *
7.05 c                   if        b_open_sok = *on
7.05  *
7.05 c                   select
7.05 c                   when      w_seqe = 'S'
7.05 c/exec sql
7.05 c+ close STMT
7.05 c/end-exec
7.2d c                   eval      w_sqlwhere = ''
7.05 c                   eval      sqlquery  = 'select +
7.05 c                              fofirm +
7.05 c                             ,fonumm +
7.05 c                             ,fosuff +
7.05 c                             ,footyp +
7.05 c                             ,fonavn +
7.05 c                             ,foityp +
7.05 c                             ,fobdat +
7.05 c                             ,fodref +
7.05 c                             ,folety +
7.2C c                             ,fokpro +
7.05 c                             ,fokuna +
7.05 c                             ,foldat +
7.05 c                             ,fokode +
7.05 c                             ,fokund +
8.08 c                             ,folkun +
7.05 c                             ,fotots +
7.05 c                             ,fototr +
7.05 c                             ,fooous +
7.05 c                             ,foeusr +
7.05 c                             ,fodate +
7.05 c                             ,fomobi +
7.05 c                             ,fotime +
7.05 c                             ,foavde +
7.05 c                             ,foedat +
7.05 c                             ,foetim +
7.05 c                             ,folmat +
7.05 c                             ,fopaks +
7.05 c                             ,fopsuf +
7.05 c                             ,forekv +
7.05 c                             ,foselg +
7.05 c                             ,fotdat +
7.05 c                             ,fouser +
7.05 c                               from   fohepf +
7.05 c                               left outer join rkunpf on rkfirm = fofirm +
7.05 c                                  and  rkkund = fokund +
7.05 c                               '
7.05 c                   eval      sqlquery  = %trim(sqlquery) + ' +
7.05 c                               where  fofirm = ? '
7.05  * Utleder søketekster ut av søketekst
7.05  *
7.05 c     lo:up         xlate     b2navn        b2navn
7.05 c                   call      'AS700R'
7.05 c                   parm                    b2navn
7.05 c                   parm                    w_ste1
7.05 c                   parm                    w_ste2
7.05 c                   parm                    w_ste3
7.05 c                   parm                    w_ste4
7.05 c                   parm                    w_ste5
7.05 c
7.05 c                   eval      w_ste1 = %ScanRpl('%' : ' ' : w_ste1)
7.05 c
7.27 c                   if        %SUBST(B2NAVN:1:2) = 'K:'
7.27 c                   if        %TRIM(w_ste1) = 'K:'
7.08 c                   eval      sql_fri_s = '''' + %trim(w_ste2) + ''''
7.27 c                   else
7.27 c                   eval      sql_fri_s = '''' + %trim(w_ste1) + ''''
7.27 c                   endif
7.08 c
7.08 c     up:lo         xlate     sql_fri_s     sql_fri_sl
7.08 c                   eval      sql_fri_sl = %ScanRpl('%' : '' : sql_fri_sl)
7.08 c
7.08 c                   eval      sqlquery  = %trim(sqlquery) + ' +
7.08 c                             and ( +
7.08 c                              upper(fokuna) >=' +%trim(sql_fri_s)+ ' +
7.08 c                               )'
7.08 c                   eval      sqlquery  = %trim(sqlquery) + ' +
7.08 c                               order by +
7.2k c                               fofirm +
7.2k c                               ,fokuna +
7.08 c                               '
7.08 c                   else
     c
7.05 c     1             do        5             x
7.05 c                   select
7.05 c                   when      x=1
7.05 c                   if        w_ste1 = *blank
7.05 c                   leave
7.05 c                   endif
7.05 c                   eval      sql_fri_s = '''%'+%trim(w_ste1)+'%'''
7.05 c                   when      x=2
7.05 c                   if        w_ste2 = *blank
7.05 c                   leave
7.05 c                   endif
7.05 c                   eval      sql_fri_s = '''%'+%trim(w_ste2)+'%'''
7.05 c                   when      x=3
7.05 c                   if        w_ste3 = *blank
7.05 c                   leave
7.05 c                   endif
7.05 c                   eval      sql_fri_s = '''%'+%trim(w_ste3)+'%'''
7.05 c                   when      x=4
7.05 c                   if        w_ste4 = *blank
7.05 c                   leave
7.05 c                   endif
7.05 c                   eval      sql_fri_s = '''%'+%trim(w_ste4)+'%'''
7.05 c                   when      x=5
7.05 c                   if        w_ste5 = *blank
7.05 c                   leave
7.05 c                   endif
7.05 c                   eval      sql_fri_s = '''%'+%trim(w_ste5)+'%'''
7.05 c                   endsl
7.05 c
7.05 c     up:lo         xlate     sql_fri_s     sql_fri_sl
7.05 c                   eval      sql_fri_sl = %ScanRpl('%' : '' : sql_fri_sl)
7.28    Exec SQL Set :w_temp = Right('    ' concat Trim(:sql_fri_sl), 4);
7.28 c                   eval      sql_fri_day = ''
7.28 c                   if        w_temp  = 'dag'''
7.28 c                   eval      sql_fri_day = ' or lower(DAYNAME(fobdat)) +
7.28 c                              = '+sql_fri_sl
7.28 c                   endif
7.05 c
     c
7.2d c                   eval      w_sqlwhere  = %trim(w_sqlwhere) + ' +
7.05 c                             and ( +
7.05 c                             fonavn like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or fokuna like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or rknavn like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or fokund like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or fonumm like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or foadr1 like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or foadr2 like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or fosted like ' +%trim(sql_fri_s)+ ' +
7.05 c                             or fomobi like ' +%trim(sql_fri_s)+ ' +
7.05 c*                             or UPPER(fovref) like '+%trim(sql_fri_s)+ ' +
7.05 c                             or UPPER(fodref) like '+%trim(sql_fri_s)+ ' +
7.05 c                             or UPPER(fonref) like '+%trim(sql_fri_s)+ ' +
7.2e c                             or UPPER(fofsys) like '+%trim(sql_fri_s)+ ' +
7.2e c                             or UPPER(forekv) like '+%trim(sql_fri_s) +
7.2d c                              %trim(sql_fri_day) + ' +
7.05 c                             or ((SELECT COUNT(*) FROM FODTPF +
7.05 c                             WHERE FDFIRM=FOFIRM AND FDNUMM = FONUMM AND +
7.05 c                             FDSUFF = FOSUFF AND +
7.05 c                             FDTEK1 LIKE '+%trim(sql_fri_s)+ ' ) <> 0)   +
7.05 c                             or ((select count(*) from fodtpf +
7.05 c                             where fdfirm=fofirm and fdnumm = fonumm and +
7.05 c                             fdsuff = fosuff and +
7.05 c                             fdvare LIKE '+%trim(sql_fri_s)+ ' ) <> 0)   +
7.05 c                               )'
7.05 c                   enddo
7.2d c                   eval      sqlquery  = %trim(sqlquery) + ' '+
7.2d c                                              %trim(w_sqlwhere) + ' '
7.05 c
7.10 c*                   if        (b2fsrt=2)
7.10 c*                   eval      sqlquery  = %trim(sqlquery) + ' +
7.10 c*                               order by fokuna +
7.10 c*                               '
7.10 c*                   else
7.05 c                   eval      sqlquery  = %trim(sqlquery) + ' +
7.05 c                               order by +
7.2k c                               fofirm +
7.2k c                               ,fodate desc +
7.05 c                               , fotime desc +
7.05 c                               , fonumm +
7.05 c                               , fosuff +
7.05 c                               '
7.10 c*                   endif
7.08 c                   endif

7.05 c                   eval      sqlquery  = %trim(sqlquery) + ' +
7.05 c                               for read only +
7.05 c                               '
7.05 c
7.05 c/exec sql
7.05 c+ PREPARE SQL_STMT FROM :sqlquery
7.05 c/end-exec
7.05 c
7.05 c/exec sql
7.05 c+ DECLARE STMT CURSOR FOR SQL_STMT
7.05 c/end-exec
7.05 c
7.05 c                   if        sqlcod = 100 or sqlstt = '02000'
7.05 c                   eval      *in15 = *on
7.05 c                   leavesr
7.05 c                   endif
7.05 c
7.05 c
7.05 c/exec sql
7.05 c+ OPEN STMT using :w_firm
7.05 c/end-exec
7.05 c
7.05 c
7.05 c*/exec sql
7.05 c*+                  declare sok_o cursor for
7.05 c*+                  select fofirm,
7.05 c*+                         fonumm,
7.05 c*+                         fosuff,
7.05 c*+                         footyp,
7.05 c*+                         fonavn,
7.05 c*+                         foityp,
7.05 c*+                         fobdat,
7.05 c*+                         fodref,
7.05 c*+                         folety,
7.05 c*+                         fokuna,
7.05 c*+                         foldat,
7.05 c*+                         fokode,
7.05 c*+                         fokund,
7.05 c*+                         fotots,
7.05 c*+                         fototr,
7.05 c*+                         fooous,
7.05 c*+                         foeusr,
7.05 c*+                         fodate,
7.05 c*+                         fomobi,
7.05 c*+                         fotime,
7.05 c*+                         foavde,
7.05 c*+                         foedat,
7.05 c*+                         foetim,
7.05 c*+                         folmat,
7.05 c*+                         fopaks,
7.05 c*+                         fopsuf,
7.05 c*+                         forekv,
7.05 c*+                         foselg,
7.05 c*+                         fotdat,
7.05 c*+                         fouser
7.05 c*+                  from   fohepf
7.05 c*+                  where  fofirm = :w_firm
7.05 c*+                  order by fodate desc, fotime desc, fonumm, fosuff
7.05 c*+                  for read only
7.05 c*/end-exec
7.05 c*/exec sql
7.05 c*+                  close sok_o
7.05 c*/end-exec
7.05 c*/exec sql
7.05 c*+                  open sok_o
7.05 c*/end-exec
7.05  *
7.05 c                   endsl
7.05  *
7.05 c                   endif
7.05  *
     c                   dou       w_srrn = w_spge
      *
     c                   select
7.05 c                   when      w_seqe = 'S'
7.05 c*/exec sql
7.05 c*+                  fetch next
7.05 c*+                  from  sok_o
7.05 c*+ into  :fofirm,:fonumm,:fosuff,:footyp,:fonavn,:foityp,:fobdat,:fodref
7.05 c*+       ,:folety,:fokuna,:foldat, :fokode,:fokund,:fotots
7.05 c*+       ,:fototr,:fooous,:foeusr,:fodate,:fomobi,:fotime
7.05 c*+       ,:foavde,:foedat,:foetim,:folmat,:fopaks,:fopsuf,:forekv,:foselg
7.05 c*+       ,:fotdat,:fouser
7.05 c*/end-exec
7.05 c/exec sql
7.05 c+ fetch STMT
7.05 c+ into  :fofirm,:fonumm,:fosuff,:footyp,:fonavn,:foityp,:fobdat,:fodref
8.08 c+       ,:folety,:fokpro,:fokuna,:foldat, :fokode,:fokund,:folkun,:fotots
7.05 c+       ,:fototr,:fooous,:foeusr,:fodate,:fomobi,:fotime
7.05 c+       ,:foavde,:foedat,:foetim,:folmat,:fopaks,:fopsuf,:forekv,:foselg
7.05 c+       ,:fotdat,:fouser
7.05 c/end-exec
7.05 c                   if        sqlcod = 100 or sqlstt = '02000'
7.05 c                   eval      *in15 = *on
7.05 c                   endif
      *
     c                   when      w_seqe = 'A'
7.05 c                   read      fohela                                 15
     c                   when      w_seqe = 'D'
7.05 c                   read      foheld                                 15
     c                   when      w_seqe = 'L'
7.05 c                   read      fohell                                 15
     c                   when      w_seqe = 'O'
7.05 c                   read      fohelo                                 15
     c                   when      w_seqe = 'V'
7.05 c                   read      fohelv                                 15
     c                   other
7.05 c                   read      fohel1                                 15
     c                   endsl
      *
7.05 c                   if        *in15 = *on or
     c                             fofirm <> w_firm
     c                   leave
     c                   endif
      *
3.31 c                   if        h1benr <> 0 and
3.31 c                             fonumm <> loornr
     c                   eval      *in15 = *on
3.39 c                   leave
3.31 c                   endif
3.39  *
     c                   exsr      chk_subfile
     c                   if        b_subf = *on
     c                   iter
     c                   endif
      *
      * Fyll opp subfile
      *
     c                   eval      w_srrn = w_srrn + 1
      *
     c                   select
     c                   when      w_seqe = 'A'
     c                   eval      fohela_kuna = fokuna
     c                   when      w_seqe = 'D'
     c                   eval      foheld_bdat = fobdat
     c                   when      w_seqe = 'L'
     c                   eval      fohell_ldat = foldat
     c                   when      w_seqe = 'O'
     c                   eval      fohelo_otyp = footyp
     c                   when      w_seqe = 'V'
     c                   eval      fohelv_navn = fonavn
     c                   other
     c                   eval      fohel1_numm = fonumm
     c                   eval      fohel1_suff = fosuff
     c                   endsl
      *
     c                   eval      b1valg = 0
     c                   eval      b1numm = fonumm
     c                   eval      b1suff = fosuff
     c                   eval      b1otyp = footyp
     c                   eval      b1navn = fonavn
7.2C c                   eval      b1kpro = fokpro
7.2C c                   eval      b1info = *blank
     c                   eval      b1ityp = foityp
7.2C c                   eval      b1bdat = fobdat
7.2C c     *dmy          move      fobdat        b1bbda
7.2C c                   eval      b1dref = fodref
7.03 c                   eval      b1lety = folety
7.2C c                   eval      b1lmat = folmat
7.2C  *
7.14 c                   if        u_714 = *on
7.14 c                   eval      rkunl1_kund = fokund
7.14 c     rkunl1_key    chain     rkunl1
7.14 c                   eval      b1kres = rkkres
7.14 c                   endif
      *
3.34 c                   exsr      xfarge
      *
6.35 c                   if        fobdat <> *loval
     c     *dmy          move      fobdat        b1dato
6.35 c                   else
6.35 c                   eval      b1dato = 0
6.35 c                   endif
      *
7.02 c                   exsr      finn_best
7.2h c*                   if        *in71  =  *off and w_oa_on = 0
7.2h c                   if        *in71  =  *off
     c                   eval      b1dato =  0
     c                   if        foldat <> *loval
     c     *dmy          move      foldat        b1dato
     c                   endif
7.02 c*                  exsr      finn_best
3.12 c                   if        w_benr <> 0
3.12 c                   move      w_benr        b1info
3.12 c                   endif
     c                   endif
      *
     c                   eval      b1kode = *blank
     c                   if        fokode <> 0
     c                   eval      b1kode = '**'
     c                   endif
     c                   if        fokode = 2
     c                   eval      b1kode = 'UT'
     c                   endif
     c                   if        fokode = 3
     c                   eval      b1kode = 'OK'
     c                   endif
     c                   if        fokode = 5
     c                   eval      b1kode = 'VE'
     c                   endif
     c                   if        fokode = 7
     c                   eval      b1kode = 'BU'
     c                   endif
8.01  * Hvis sperrekoden kommer NGN, sett kode NG.
8.01 c                   if        fokode = 9
8.01 c                   eval      b1kode = 'NG'
8.01 c                   endif
      *
5.33 c                   eval      b1knav      = *blank
8.06 c                   if        folkun <> 0
8.06 c                   eval      rkunl1_kund = folkun
8.06 c                   else
     c                   eval      rkunl1_kund = fokund
8.06 c                   endif
     c     rkunl1_key    chain     rkunl1r                            90
      *
     c                   if        *in90
5.33 c                   eval      b1knav = fokuna
7.03 c                   eval      b1kres = 0
     c                   else
5.33 c                   eval      b1knav = rknavn
7.03 c                   eval      b1kres = rkkres
     c                   endif
     c                   eval      b1kund = fokund
5.33 c                   eval      b1kuna = fokuna
      *
8.06 c*                  if        folkun <> fokund and
8.06 c*                            fokpro <> 0
8.06 c*                  eval      b1knav = fokuna
8.06 c*                  endif
      *
     c                   eval      b1salg = (fotots - fototr)
     c                   if        b_moms = *on
     c                   if        (b1salg * w_mvat) > 999999999,99
     c                   eval      b1salg = 999999999,99
     c                   else
     c                   eval      b1salg = (b1salg * w_mvat)
     c                   endif
     c                   endif
      *
7.2h c*                   if        *in71 or w_oa_on > 0
7.2h c                   if        *in71 = *on
     c                   eval      w_salg = %editw(b1salg : '         ,  -')
     c                   move      w_salg        b1info
     c                   endif
7.2B  **
7.2B  ** Henter inn høyeste ordrestatus
7.2B  ** og legger over alt i en streng
7.2B  **
7.2B c*                   eval      w_kod2 = *blank
7.2B c*                   eval      w_aarr = %subdt(b1bdat:*years)
7.2B c*                   call      'FU706R'
7.2B c*                   parm                    w_aarr
7.2B c*                   parm                    b1numm
7.2B c*                   parm                    b1suff
7.2B c*                   parm                    w_kod2
5.54  *
7.2B c                   eval      w_kod2 = *blank
7.21 c                   if        u_721 = *off
5.61 c                   if        faakjk = 1
7.2B c                   exsr      sjk_lstatus
7.2B c                   eval      b1kod2 = w_kod2
5.61 c                   else
5.54 c                   eval      b1kod2 = *blank
5.61 c                   endif
7.21 c                   else
7.2B c                   exsr      sjk_lstatus
7.2B c                   eval      b1kod2 = w_kod2
7.21 c                   endif
5.54 c                   eval      b1alle = b1ityp + b1kod2 + b1kode
      *
7.2C c                   eval      b1llda = 0
7.01 c                   if        (foldat <> *loval)
7.01 c     *dmy          move      foldat        w_datn
7.01 c                   eval      b1ldat = %editw(w_datn : '  .  .  ')
7.2C c     *dmy          move      foldat        b1llda
7.01 c                   else
7.01 c                   eval      b1ldat = ''
7.01 c                   endif
7.01 c                   eval      b1benr = w_benr
7.01 c                   eval      b1oous = fooous
7.01 c                   eval      b1eusr = foeusr
7.01 c                   if        (fodate <> *loval)
7.01 c     *dmy          move      fodate        w_datn
7.01 c                   eval      b1date = %editw(w_datn : '  .  .  ')
7.01 c                   else
7.01 c                   eval      b1date = ''
7.01 c                   endif
7.01 c                   eval      b1mobi = fomobi
7.01 c                   eval      w_salg = %editw(fototr : '         ,  -')
7.01 c                   move      w_salg        b1rabt
7.01 c                   eval      w_belp2 = (fotots - fototr)
7.01 c                   if        (w_belp2 * w_mvat) > 999999999,99
7.01 c                   eval      w_belp2 = 999999999,99
7.01 c                   else
7.01 c                   eval      w_belp2 = (w_belp2 * w_mvat)
7.01 c                   endif
7.01 c                   eval      w_salg = %editw(w_belp2 : '         ,  -')
7.01 c                   move      w_salg        b1inkm                                  *
7.12 c                   exsr      newlo_vask
     c                   write     b1sfl
      *
     c                   enddo
      *
     c                   if        w_srrn > w_ssrn
     c                   eval      w_sfrn = w_ssrn + 1
     c                   endif
      *
     c                   eval      w_ssrn = w_srrn
     c                   eval      w_virn = w_sfrn
      *
7.02 c                   eval      b_open_sok = *off
7.02  *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å bla tilbake en side i subfilen
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     bck_subfile   begsr
      *
7.05 c                   if        w_seqe = 'S'
7.05 c                   eval      b2navn = b2nav2
7.05 c                   exsr      forny
7.05 c                   eval      b2navn = *blank
7.05 c                   goto      end_bck
7.05 c                   endif
      *
     c                   if        *in15
     c                   select
     c                   when      w_seqe = 'A'
     c     fohela_key    setgt     fohela
     c                   readp     fohela
     c                   when      w_seqe = 'D'
     c     foheld_key    setgt     foheld
     c                   readp     foheld
     c                   when      w_seqe = 'L'
     c     fohell_key    setgt     fohell
     c                   readp     fohell
     c                   when      w_seqe = 'O'
     c     fohelo_key    setgt     fohelo
     c                   readp     fohelo
     c                   when      w_seqe = 'V'
     c     fohelv_key    setgt     fohelv
     c                   readp     fohelv
     c                   other
     c     fohel1_key    setgt     fohel1
     c                   readp     fohel1
     c                   endsl
     c                   endif
      *
      * Leser tilbake en side
      *
     c                   eval      w_stel = 0
      *
     c                   dou       w_stel = w_ssrn + c_sfil
      *
     c                   select
     c                   when      w_seqe = 'A'
     c                   readp     fohela
     c                   when      w_seqe = 'D'
     c                   readp     foheld
     c                   when      w_seqe = 'L'
     c                   readp     fohell
     c                   when      w_seqe = 'O'
     c                   readp     fohelo
     c                   when      w_seqe = 'V'
     c                   readp     fohelv
     c                   other
     c                   readp     fohel1
     c                   endsl
      *
     c                   if        %eof or
     c                             fofirm <> w_firm
     c                   leave
     c                   endif
      *
3.31 c                   if        h1benr <> 0 and
3.31 c                             fonumm <> loornr
3.39 c                   leave
3.31 c                   endif
3.39  *
     c                   exsr      chk_subfile
     c                   if        b_subf = *on
     c                   iter
     c                   endif
      *
     c                   eval      w_stel = w_stel + 1
      *
     c                   select
     c                   when      w_seqe = 'A'
     c                   eval      fohela_kuna = fokuna
     c                   when      w_seqe = 'D'
     c                   eval      foheld_bdat = fobdat
     c                   when      w_seqe = 'L'
     c                   eval      fohell_ldat = foldat
     c                   when      w_seqe = 'O'
     c                   eval      fohelo_otyp = footyp
     c                   when      w_seqe = 'V'
     c                   eval      fohelv_navn = fonavn
     c                   other
     c                   eval      fohel1_numm = fonumm
     c                   eval      fohel1_suff = fosuff
     c                   endsl
      *
     c                   enddo
      *
     c                   if        %eof
     c                   select
     c                   when      w_seqe = 'A'
     c     fohela_key    setll     fohela
     c                   when      w_seqe = 'D'
     c     foheld_key    setll     foheld
     c                   when      w_seqe = 'L'
     c     fohell_key    setll     fohell
     c                   when      w_seqe = 'O'
     c     fohelo_key    setll     fohelo
     c                   when      w_seqe = 'V'
     c     fohelv_key    setll     fohelv
     c                   other
     c     fohel1_key    setll     fohel1
     c                   endsl
     c                   endif
      *
      * Blanker og fyller opp subfile
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
7.02 c     end_bck       endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å sjekke om rad skal være med i subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     chk_subfile   begsr
      *
     c                   eval      b_subf = *off
      *
      * Skal ordretype være med ?
5.20  * (Utelate er satt lik ' ')
      *
5.20 c                   if        h1utla = ' '
3.31 c                   if        h1otyp = *blank and
3.31 c                             h1oty2 = *blank and
3.31 c                             h1oty3 = *blank
3.31 c                   goto      xtamed
3.31 c                   endif
3.31  *
3.31 c                   if        h1otyp <> *blank and
3.31 c                             h1otyp =  footyp
3.31 c                   goto      xtamed
3.31 c                   endif
3.31  *
3.31 c                   if        h1oty2 <> *blank and
3.31 c                             h1oty2 =  footyp
3.31 c                   goto      xtamed
3.31 c                   endif
3.31  *
3.31 c                   if        h1oty3 <> *blank and
3.31 c                             h1oty3 =  footyp
3.31 c                   goto      xtamed
3.31 c                   endif
5.20 c                   endif
5.20  *
5.20  * Skal ordretype være med ?
5.20  * (Utelate er satt lik '-')
5.20  *
5.20 c                   if        h1utla = '-'
5.20 c                   if        h1otyp = *blank and
5.20 c                             h1oty2 = *blank and
5.20 c                             h1oty3 = *blank
5.20 c                   goto      xdropp
5.20 c                   endif
5.20  *
5.20 c                   if        h1otyp <> *blank and
5.20 c                             h1otyp =  footyp
5.20 c                   goto      xdropp
5.20 c                   endif
5.20  *
5.20 c                   if        h1oty2 <> *blank and
5.20 c                             h1oty2 =  footyp
5.20 c                   goto      xdropp
5.20 c                   endif
5.20  *
5.20 c                   if        h1oty3 <> *blank and
5.20 c                             h1oty3 =  footyp
5.20 c                   goto      xdropp
5.20 c                   endif
5.20  *
5.20 c                   goto      xtamed
5.20  *
5.20 c                   endif
5.20  *
5.20 c     xdropp        tag
3.31  *
3.31 c                   eval      b_subf = *on
     c                   leavesr
3.31  *
3.31 c     xtamed        tag
      *
      * Uaktuell ordre-info-type?
      *
     c                   if        h1ityp <> *blank and
     c                             h1ityp <> foityp
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
      *
      * Uaktuell bruker ?
      *
     c                   if        h1user <> *blank and
     c                             h1user <> fouser
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
      *
      * Uaktuell kunde ?
      *
     c                   if        h1kund <> 0 and
     c                             h1kund <> fokund
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
5.42  *
5.42  * Uaktuell selger ?
5.42  *
5.42 c                   if        h1selg <> 0 and
5.42 c                             h1selg <> foselg
5.42 c                   eval      b_subf = *on
5.42 c                   leavesr
5.42 c                   endif
3.31  *
3.39  * Uaktuell avdeling ?
3.39  *
3.39 c                   if        h1avde <> 0 and
3.39 c                             h1avde <> foavde
3.39 c                   eval      b_subf = *on
     c                   leavesr
3.39 c                   endif
5.41  *
5.41  * Uaktuelt lager ?
5.41  *
5.41 c                   if        h1lage <> 0
5.41 c                   exsr      xsjekk_lag
5.41 c                   if        w_funn =  0
5.41 c                   eval      b_subf = *on
5.41 c                   leavesr
5.41 c                   endif
5.41 c                   endif
      *
      * Uaktuell rekvisisjon ?
      *
     c                   if        h1rekv <> *blank and
     c                             h1rekv <> forekv
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
7.07  *
7.07  * mobil nr
7.07  *
7.07 c                   if        h1mobi <> *blank
7.07  /FREE
7.07   w_mobi = fomobi;
7.07   DoW %Scan(' ': %TRIMR(w_mobi)) > *Zeros;
7.07    w_mobi = %Replace('' : w_mobi: %Scan(' ': %TRIMR(w_mobi)): 1);
7.07   EndDo;
7.07  /END-FREE
7.07 c                   if        h1mobi <> w_mobi
7.07 c                   eval      b_subf = *on
7.07 c                   leavesr
7.07 c                   endif
7.07 c                   endif
      *
      * Oppgitt beløpsgrense ?
      * Over   = O
      * eller <> U
      *
     c                   if        h1belp <> 0
     c                   eval      w_belp =  (fotots - fototr)
     c                   if        h1valg <> 'U'
     c                   if        w_belp <  h1belp
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
     c                   endif
     c                   endif
      *
      * Oppgitt beløpsgrense ?
      * Under =  U
      *
     c                   if        h1belp <> 0
     c                   eval      w_belp =  (fotots - fototr)
     c                   if        h1valg =  'U'
     c                   if        w_belp >  h1belp
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
     c                   endif
     c                   endif
3.16  *
3.16  * Uaktuell leveringsmåte
3.16  *
3.16 c                   if        h1lmat <> 0  and
3.16 c                             h1lmat <> folmat
3.16 c                   eval      b_subf = *on
     c                   leavesr
3.16 c                   endif
      *
      * Velge ut på ordreanmerkning ?
      *
     c                   if        h1oanm = '**' and
     c                             fokode <> 1
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
      *
     c                   if        h1oanm = 'UT' and
     c                             fokode <> 2
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
      *
     c                   if        h1oanm = 'OK' and
     c                             fokode <> 3
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
      *
     c                   if        h1oanm = 'VE' and
     c                             fokode <> 5
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
      *
     c                   if        h1oanm = 'BU' and
     c                             fokode <> 7
     c                   eval      b_subf = *on
     c                   leavesr
     c                   endif
8.01  *
8.01 c                   if        h1oanm = 'NG' and
8.01 c                             fokode <> 9
8.01 c                   eval      b_subf = *on
8.01 c                   leavesr
8.01 c                   endif
6.12  *
6.12  * Korttype ?
6.12  *
6.13 c                   if        fopsuf <> *zero
6.13 c                   eval      b_kunde = *off
6.13 c                   exsr      sjk_kunde
6.13 c                   endif
6.13  *
6.12 c                   if        h1kort <> *zero and
6.12 c                             h1kort <> fopsuf
6.12 c                   eval      b_subf = *on
6.12 c                   leavesr
6.12 c                   endif
7.03  *
7.03  * Uaktuell loggkode
7.03  *
7.03 c                   if        h1logg <> *blank
7.03  *
7.03  * sjekke hvilken loggkode.
7.03  *
7.03 c                   eval      w_kod2 = *blank
7.03 c                   eval      w_aarr = %subdt(b1bdat:*years)
7.03 c                   call      'FU706R'
7.03 c                   parm                    w_aarr
7.03 c                   parm                    fonumm
7.03 c                   parm                    fosuff
7.03 c                   parm                    w_kod2
7.03  *
7.03  * Uaktuell loggkode
7.03  *
7.03 c                   if        h1logg <> *blank and
7.03 c                             h1logg <> w_kod2
7.03 c                   eval      b_subf = *on
7.03 c                   leavesr
7.03 c                   endif
7.03 c                   endif
7.03  *
7.03  * Uaktuell leveringstype
7.03  *
7.03 c                   if        h1lety <> 0  and
7.03 c                             h1lety <> folety
7.03 c                   eval      b_subf = *on
7.03 c                   leavesr
7.03 c                   endif
7.f1  *
7.f1  * Forskuddsbetalt/Delbetalt
7.f1  *
7.f1 c                   if        h1100k <> 0 or
7.f1 c                             h1100i <> 0 or
7.f1 c                             h1delk <> 0 or
7.f1 c                             h1deli <> 0
7.f1 c                   exsr      filt_depo
7.f1 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for display av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dsp_subfile   begsr
      *
     c                   if        w_srrn <> 0
     c                   eval      *in12  = *on
     c                   else
     c                   write     b2cmd
     c                   endif
      *
     c                   eval      *in13  = *on
     c                   exfmt     b2ctl
      *
     c                   eval      *in12  = *off
     c                   eval      *in13  = *off
      *
     c                   eval      w_fcrn = d_fcrn
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av spørring
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     spØrring      begsr
5.52  *
5.52  * Bruker
5.52  *
7.xx c                   if        w_afldh1 = 'H1USER'
5.52 c                   call      'AA522R'
5.52 c                   parm                    h1user
5.52 c                   parm                    w_user
5.52 c                   leavesr
5.52 c                   endif
      *
      * Kunde
      *
7.xx c                   if        w_afldh1 = 'H1KUND'
     c                   call      'RK500R'
     c                   parm                    w_firm
     c                   parm                    h1kund
     c                   parm                    w_knav
     c                   leavesr
     c                   endif
5.42  *
5.42  * Selger
5.42  *
7.xx c                   if        w_afldh1 = 'H1SELG'
5.42 c                   call      'RA509R'
5.42 c                   parm                    w_firm
5.42 c                   parm                    h1selg
5.42 c                   parm                    w_itx2
5.42 c                   leavesr
5.42 c                   endif
3.39  *
3.39  * Avdeling
3.39  *
7.xx c                   if        w_afldh1 = 'H1AVDE'
3.39 c                   call      'RA507R'
3.39 c                   parm                    w_firm
3.39 c                   parm                    h1avde
3.39 c                   parm                    w_gtxt
3.39 c                   leavesr
3.39 c                   endif
      *
      * Ordre-type
      *
7.xx c                   if        w_afldh1 = 'H1OTYP'
     c                   call      'VA550R'
     c                   parm                    w_firm
     c                   parm                    h1otyp
     c                   leavesr
     c                   endif
      *
      * Ordre-info-type
      *
7.xx c                   if        w_afldh1 = 'H1ITYP'
     c                   call      'VA540R'
     c                   parm                    w_firm
     c                   parm                    w_ityp
     c                   parm                    w_itxt
     c                   eval      h1ityp = w_ityp
     c                   leavesr
     c                   endif
6.12  *
6.12  * Korttype
6.12  *
7.xx c                   if        w_afldh1 = 'H1KORT'
6.12 c                   call      'RA532R'
6.12 c                   parm                    w_firm
6.12 c                   parm                    h1kort
6.12 c                   parm                    w_slag
6.12 c                   parm                    w_sbes
6.12 c                   leavesr
6.12 c                   endif
      *
7.2i  * Forsendelses måte
7.2i  *
7.2i c                   if        w_afldh1 = 'H1LMAT'
7.2i c                   call      'RA517R'
7.2i c                   parm                    w_firm
7.2i c                   parm                    h1lmat
7.2i c                   parm                    w_ftxt
7.2i c                   leavesr
7.2i c                   endif
      *
     c                   endsr
      *
3.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.11  * Subrutine for å hente inn bestillingsnummer
3.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.11  *
3.11 c     finn_best     begsr
3.11  *
3.11  * Hente inne bestillingsnummer fra første varelinje
3.11  * hvor det eventuelt måtte ligge
3.11  *
3.11 c                   eval      w_benr = 0
3.11 c                   eval      fodtl1_numm = fonumm
3.11 c                   eval      fodtl1_suff = fosuff
3.11 c     fodtl1_key    setll     fodtl1
3.11 c     fodtl1_key    reade     fodtl1                                 91
3.11  *
3.11 c                   dow       *in91  = *off
3.11 c                   if        fdbenr <> 0
3.11 c                   eval      w_benr = fdbenr
3.11 c                   leave
3.11 c                   endif
3.11 c     fodtl1_key    reade     fodtl1                                 91
3.11 c                   enddo
3.11  *
3.11 c                   endsr
5.20  *
5.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.20  * Subrutine for å lagre valg i h1win på bruker
5.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.20  *
5.20 c     lagring       begsr
5.20  *
5.20  * Hente inn bruker-register for oppdatering
5.20  *
5.20 c                   eval      fusrlu_user = l_user
5.20 c     fusrlu_key    chain     fusrlur
5.20  *
5.20 c                   if        %found
5.20 c                   eval      fbutla = h1utla
5.20 c                   eval      fboty1 = h1otyp
5.20 c                   eval      fboty2 = h1oty2
5.20 c                   eval      fboty3 = h1oty3
5.20 c                   eval      fbityp = h1ityp
5.20 c                   eval      fbuse2 = h1user
5.20 c                   eval      fbkund = h1kund
5.20 c                   eval      fbbenr = h1benr
5.20 c                   eval      fbsel2 = h1selg
5.20 c                   eval      fbavde = h1avde
5.20 c                   eval      fblage = h1lage
5.20 c                   eval      fbrekv = h1rekv
5.20 c                   eval      fbbelp = h1belp
5.20 c                   eval      fbvalg = h1valg
5.20 c                   eval      fblmat = h1lmat
5.20 c                   eval      fboanm = h1oanm
6.10 c                   time                    fbedat
6.10 c                   time                    fbetim
6.10 c                   eval      fbeusr = l_user
5.20 c                   update    fusrlur
5.20 c                   endif
5.20  *
5.20 c                   endsr
7.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2B  * Henter inn høyeste ordrestatus og legger over alt i en streng
7.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2B c     sjk_lstatus   begsr
7.2B  *
7.2B  * Henter inn høyeste ordrestatus
7.2B  * og legger over alt i en streng
7.2B  *
7.2B c                   eval      w_kod2 = *blank
7.2B c                   eval      w_aarr = %subdt(b1bdat:*years)
7.2B c                   call      'FU706R'
7.2B c                   parm                    w_aarr
7.2B c                   parm                    b1numm
7.2B c                   parm                    b1suff
7.2B c                   parm                    w_kod2
7.2B c                   endsr
      *
6.13  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.13  * Sjekker at kortinformasjon finnes
6.13  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.13 c     sjk_kunde     begsr
6.13  *
6.13  * Les kortregister for kunde, og sjekk om det skal legges ut info.
6.13  *
6.13 c                   eval      rukrl5_kkun = fokund
6.13 c                   eval      rukrl5_kpro = 0
6.13 c                   eval      rukrl5_ktyp = fopsuf
6.13 c     rukrl5_key    chain     rukrl5
6.13 c                   if        %found
6.13  * NB Må være fullmakt
6.13 c                   if        rukobl = 1
6.13  * Hent infomasjon om kortet, sjekk oppfølgingmetode
6.13 c                   eval      b_kunde = *on
6.13 c                   endif
6.13 c                   endif
6.13  * Fjern merket fra ordrehodet
6.13 c                   if        b_kunde = *off
6.13 c                   eval      fohelu_numm = fonumm
6.13 c                   eval      fohelu_suff = fosuff
6.13 c     fohelu_key    chain     fohelu
6.13 c                   if        %found
6.13 c                   eval      fopsuf = 0
6.13 c                   update    fohelur
6.13 c                   endif
6.13 c                   endif
6.13  *
6.13 c                   endsr
7.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.12  * Newlook vask av data
7.12  *  Fjerner tegn som gjør at Newlook feiltolker
7.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.12  *
7.12   begsr newlo_vask;
      *
8.16 c                   eval      w_posw = %scan('-':b2nav2)
8.16 c                   if        w_posw > 0
8.16       b2nav2 = %replace(' ':b2nav2:w_posw);
8.16 c                   endif
      *
7.2A c     x'1C':' '     xlate     b1navn        b1navn
7.2A c     x'1C':' '     xlate     b1dref        b1dref
7.2A c     x'1C':' '     xlate     b1knav        b1knav
7.2A c     x'25':' '     xlate     b1navn        b1navn
7.2A c     x'25':' '     xlate     b1dref        b1dref
7.2A c     x'25':' '     xlate     b1knav        b1knav
      *
7.12     for w_teller = 1 to 5 ;
7.12       w_len = %len(%trim(b1navn));
7.12       if (w_len > 0);
7.12       b1navn = %ScanRpl('.':'':b1navn:w_len); // newlook tåler ikke . på slutten
7.12       endif;
7.12       w_len = %len(%trim(b1navn));
7.12       if (w_len > 0);
7.12       b1navn = %ScanRpl(':':'':b1navn:w_len); // newlook tåler ikke : på slutten
7.12       endif;
7.12       w_len = %len(%trim(b1dref));
7.12       if (w_len > 0);
7.12       b1dref = %ScanRpl('.':'':b1dref:w_len); // newlook tåler ikke . på slutten
7.12       endif;
7.12       w_len = %len(%trim(b1dref));
7.12       if (w_len > 0);
7.12       b1dref = %ScanRpl(':':'':b1dref:w_len); // newlook tåler ikke : på slutten
7.12       endif;
8.04       w_len = %len(%trim(b1knav));
8.04       if (w_len > 0);
8.04       b1knav = %ScanRpl('.':'':b1knav:w_len); // newlook tåler ikke . på slutten
8.04       endif;
8.04       w_len = %len(%trim(b1knav));
8.04       if (w_len > 0);
8.04       b1knav = %ScanRpl(':':'':b1knav:w_len); // newlook tåler ikke : på slutten
8.04       endif;
7.12     endfor ;
7.12   endsr;
7.fb  * - - - - - - - - - - - - - - - - - - - -- - - - - - - - - - - - - -
7.fb  * Subrutine for å sjekke om linje har ubetalt depositumskrav
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  *
7.fb c     sjekk_depo    begsr
7.fb c                   eval      b_depo = *off
7.f4 c**                 eval      *in45  = *off
7.f4 c**                 eval      *in46  = *off
7.f4 c                   eval      *in50  = *off
7.f4 c                   eval      *in51  = *off
7.f4 c                   eval      *in52  = *off
7.f4 c                   eval      *in53  = *off
7.f4 c                   eval      *in54  = *on
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
7.fb c     sdepl1_key    chain     sdepl1r
7.fb c                   if        %found(sdepl1)
7.fb c                   if        skdepo <> 0 and
7.fb c                             skdepo > skdepb
7.fb c                   eval      b_depo = *on
7.f4 c**                 eval      *in45  = *on
7.f4 c                   if        faaprn = 'R'
7.f4 c                   eval      *in50 = *on
7.f4 c                   eval      *in54 = *off
7.f4 c                   elseif    faaprn = 'O'
7.f4 c                   eval      *in51 = *on
7.f4 c                   eval      *in54 = *off
7.f4 c                   endif
7.fb c                   endif
7.fb c                   if        skdepo <> 0 and
7.fb c                             skdepb >= skdepo
7.f4 c**                 eval      *in46 = *on
7.f4 c                   if        faaprp = 'B'
7.f4 c                   eval      *in52 = *on
7.f4 c                   eval      *in54 = *off
7.f4 c                   elseif    faaprp = 'T'
7.f4 c                   eval      *in53 = *on
7.f4 c                   eval      *in54 = *off
7.f4 c                   endif
7.fb c                   endif
7.fb c                   endif
7.fb c                   endsr
7.f1  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.f1  * Subrutine for å sjekke depositum mot filter
7.f1  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.f1  *
7.f1 c     filt_depo     begsr
7.f1 c                   eval      b_subf = *on
7.f1 c                   eval      sdepl1_numm = fonumm
7.f1 c                   eval      sdepl1_kund = fokund
7.f1 c                   eval      sdepl1_tell = 0
7.f1 c     sdepl1_key    chain     sdepl1r
7.f1 c                   if        %found(sdepl1)
7.f1 c                   if        h1100k = 1 or
7.f1 c                             h1100i = 1
7.f1  * forhåndbetalte krav
7.f1 c                   if        sk100p = 1
7.f1  * er forhåndbetalt krav, men ikke betalt
7.f1 c                   eval      b_subf = *on
7.f1 c                   if        h1100k = 1  and
7.f1 c                             skdepb <  skdepo
7.f1 c                   eval      b_subf = *off
7.f1 c                   endif
7.f1  *
7.f1  * forhåndbetalt krav, innbetalt
7.f1 c                   if        h1100i = 1  and
7.f1 c                             skdepb >= skdepo
7.f1  *innbetalt
7.f1 c                   eval      b_subf = *off
7.f1 c                   endif
7.f1 c                   endif
7.f1 c                   endif
7.f1  ***** Forhåndsbetalt slutt, Delbetaling start
7.f1 c                   if        h1delk = 1 or
7.f1 c                             h1deli = 1
7.f1 c                   if        sk100p = 0
7.f1  * Delbetaling
7.f1 c                   eval      b_subf = *on
7.f1 c                   if        h1delk = 1  and
7.f1 c                             skdepb <  skdepo
7.f1 c                   eval      b_subf = *off
7.f1 c                   endif
7.f1  *
7.f1  * Delbetaling, innbetalt
7.f1 c                   if        h1deli = 1  and
7.f1 c                             skdepb >= skdepo
7.f1  *innbetalt
7.f1 c                   eval      b_subf = *off
7.f1 c                   endif
7.f1 c                   endif
7.f1 c                   endif
7.f1 c                   endif
7.f1  *
7.f1 c                   endsr
8.18  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.18  * Subrutine for å sende SMS
8.18  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.18  *
8.18 c     ex_snd_SMS    begsr
8.18  *
8.18  * Start program for sending av SMS
8.18  *
8.18 c                   eval      p_syst = 'O'
8.18 c                   call      'QO500R'
8.18 c                   parm                    w_firm
8.18 c                   parm                    b1numm
8.18 c                   parm                    b1suff
8.18 c                   parm                    p_syst
8.18  *
8.18 c     endsms        endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
5.34  *
5.34  * Parametre
5.34  *
5.34 c     *entry        plist
6.nu c                   parm                    p_numm
5.34 c                   parm                    p_lpro
      *
      * Key for oppslag på ordre/suffix
      *
     c     fohelr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohelr_numm
     c                   kfld                    fohelr_suff
      *
     c     fohelr_ke2    klist
     c                   kfld                    w_firm
     c                   kfld                    fohelr_num2
     c                   kfld                    fohelr_suf2
      *
      * Key for posisjonering på ordre/suffix
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohel1_numm
     c                   kfld                    fohel1_suff
      *
      * Key for posisjonering på kundenavn
      *
     c     fohela_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohela_kuna
      *
      * Key for posisjonering på ordre-dato
      *
     c     foheld_key    klist
     c                   kfld                    w_firm
     c                   kfld                    foheld_bdat
      *
      * Key for posisjonering på leverings-dato
      *
     c     fohell_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohell_ldat
      *
      * Key for posisjonering på ordretype
      *
     c     fohelo_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohelo_otyp
      *
      * Key for posisjonering på vareadresse
      *
     c     fohelv_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohelv_navn
      *
      * Key for oppdatering av ordrehode
      *
     c     fohelu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohelu_numm
     c                   kfld                    fohelu_suff
3.11  *
3.11  * Key for ordrelinje-register
3.11  *
3.11 c     fodtl1_key    klist
3.11 c                   kfld                    w_firm
3.11 c                   kfld                    fodtl1_numm
3.11 c                   kfld                    fodtl1_suff
      *
      * Key for kunderegister
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Key for ofak kode-register
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
7.fb  *
7.fb  * Key for oppslag på ofak-koderegister sideregister
7.fb  *
7.fb c     fst2l1_key    klist
7.fb c                   kfld                    w_firm
      *
      * Key for lager/innkjøp kode-register
      *
     c     lstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for brukerregister
      *
     c     fusrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fusrl1_user
5.20  *
5.20  * Key for brukerregister (update)
5.20  *
5.20 c     fusrlu_key    klist
5.20 c                   kfld                    w_firm
5.20 c                   kfld                    fusrlu_user
3.31  *
3.31  * Key for bestillings-hode-register
3.31  *
3.31 c     lohel1_key    klist
3.31 c                   kfld                    w_firm
3.31 c                   kfld                    lohel1_numm
3.39 c***                kfld                    lohel1_suff
      *
      * Key for ordretyperegister
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
3.33  *
3.33  * Key for oppslag på ordre-info-type
3.33  *
3.33 c     vinfl1_key    klist
3.33 c                   kfld                    w_firm
3.33 c                   kfld                    vinfl1_ityp
      *
3.33  * Key for oppslag på vare
3.33  *
3.33 c     vvarl1_key    klist
3.33 c                   kfld                    w_firm
3.33 c                   kfld                    vvarl1_vare
5.62  *
5.62  * Key for oppslag på depositum-fil
5.62  *
5.62 c     sdepl1_key    klist
5.62 c                   kfld                    w_firm
5.62 c                   kfld                    sdepl1_numm
5.62 c                   kfld                    sdepl1_kund
7.fb c                   kfld                    sdepl1_tell
5.62  *
5.62  * Key for oppdatering av depositum-fil
5.62  *
5.62 c     sdeplu_key    klist
5.62 c                   kfld                    w_firm
5.62 c                   kfld                    sdeplu_numm
5.62 c                   kfld                    sdeplu_kund
7.fb c                   kfld                    sdeplu_tell
6.13  *
6.13  * Key for kundekort
6.13  *
6.13 c     rukrl5_key    klist
6.13 c                   kfld                    w_firm
6.13 c                   kfld                    rukrl5_ktyp
6.13 c                   kfld                    rukrl5_kkun
6.13 c                   kfld                    rukrl5_kpro
6.26  *
6.23  * Key for les av best.forslag
6.26  *
6.26 c     lfhelr_key    klist
6.26 c                   kfld                    w_firm
6.26  *
6.26  * Key for oppdatering av best.forslag
6.26  *
6.26 c     lfhelu_key    klist
6.26 c                   kfld                    w_firm
6.26 c                   kfld                    lfhelu_numm
6.26  *
6.26  * Key for oppdatering av best.forslag linnjer
6.26  *
6.26 c     lfdtlu_key    klist
6.26 c                   kfld                    w_firm
6.26 c                   kfld                    lfdtlu_numm
6.30  *
6.30 c     rksjl1_key    klist
6.30 c                   kfld                    w_firm
6.30 c                   kfld                    rksjl1_jnum
6.30 c                   kfld                    rksjl1_jsuf
7.17  *
7.17  * Key for propertiesfil
7.17  *
8.03 c*    afpslr_key    klist
8.03 c*                  kfld                    afpslr_ufil
8.03 c*                  kfld                    afpslr_uide
7.15  *
7.15  * Key for Slettekoder
7.15  *
7.15 c     xtsll1_key    klist
7.15 c                   kfld                    xtsll1_firm
7.15 c                   kfld                    xtsll1_skod
7.15  *
7.15  * Key for Konkurentkoder
7.15  *
7.15 c     xtkkl1_key    klist
7.15 c                   kfld                    xtkkl1_firm
7.15 c                   kfld                    xtkkl1_kkod
      *
      *
      * Henter firma fra LDA
      *
     c                   eval      w_firm = l_firm
7.11  *
7.11  * Endring 7.11
7.11  *
7.11   CallP CO402R(l_filg:w_firm:0:'FO500R_711':
7.11                    co402_verdi1:co402_verdi2);
7.11   if co402_verdi1 = '1';
7.11     u_711 = *on;
7.11   endif;
7.13  *
7.13  * Endring 7.13
7.13  *
7.13   CallP CO402R(l_filg:w_firm:0:'FO500R_713':
7.13                    co402_verdi1:co402_verdi2);
7.13   if co402_verdi1 = '1';
7.13     u_713 = *on;
7.13   endif;
7.14  *
7.14  * Endring 7.14
7.14  *
7.14   CallP CO402R(l_filg:w_firm:0:'FO500R_714':
7.14                    co402_verdi1:co402_verdi2);
7.14   if co402_verdi1 = '1';
7.14     u_714 = *on;
7.14   endif;
7.16  *
7.16  * Endring 7.16
7.16  *
7.16   CallP CO402R(l_filg:w_firm:0:'FO500R_716':
7.16                    co402_verdi1:co402_verdi2);
7.16   if co402_verdi1 = '1';
7.16     u_716 = *on;
7.16   endif;
7.17  *
7.17  * Endring 7.17
7.17  *
7.17   CallP CO402R(l_filg:w_firm:0:'FO500R_717':
7.17                    co402_verdi1:co402_verdi2);
7.17   if co402_verdi1 = '1';
7.17     u_717 = *on;
7.17   endif;
7.18  *
7.18  * Endring 7.18
7.18  *
7.18   CallP CO402R(l_filg:w_firm:0:'FO500R_718':
7.18                    co402_verdi1:co402_verdi2);
7.18   if co402_verdi1 = '1';
7.18     u_718 = *on;
7.18   endif;
7.19  *
7.19  * Endring 7.19
7.19  *
7.19   CallP CO402R(l_filg:w_firm:0:'FO500R_719':
7.19                    co402_verdi1:co402_verdi2);
7.19   if co402_verdi1 = '1';
7.19     u_719 = *on;
7.19   endif;
7.20  *
7.20  * Endring 7.20
7.20  *
7.20   CallP CO402R(l_filg:w_firm:0:'FO500R_720':
7.20                    co402_verdi1:co402_verdi2);
7.20   if co402_verdi1 = '1';
7.20     u_720 = *on;
7.20   endif;
7.21  *
7.21  * Endring 7.21
7.21  *
7.21   CallP CO402R(l_filg:w_firm:0:'FO500R_721':
7.21                    co402_verdi1:co402_verdi2);
7.21   if co402_verdi1 = '1';
7.21     u_721 = *on;
7.21   endif;
7.2d  *
7.2d  * Endring 7.2d
7.2d  * OBS!!  Felles for alle filgrupper og firma
7.2d   *in49 = *off;
7.2d   CallP CO402R('   ':0:0:'NX_EXCEL_URL':
7.2d                    co402_verdi1:co402_verdi2);
7.2d   if co402_verdi1 = '1';
7.2d     u_72D = *on;
7.2d     w_excel_url = co402_verdi2;
7.2d     *in49 = *on;
7.2d   endif;
7.2j  *
7.2j  * Endring 7.2j
7.2j  * NB - det er riktig at den benytter seg av nøkkel FD100R_714 !!
7.2j  * Fjernet mulighet for å legge hovedordre til plukking
7.2j  *
7.2j   CallP CO402R(l_filg:w_firm:0:'FD100R_714':
7.2j                    co402_verdi1:co402_verdi2);
7.2j   if co402_verdi1 = '1';
7.2j     u_72j = *on;
7.2j   endif;
      *
      * Initierer skjermbilde
      *
     c                   if        p_numm = 0
     c                   eval      *in22 = *on
     c                   endif
      *
     c                   eval      b2hed2 = 'Ordreverdi'
     c                   eval      b2hedd = 'Ordredato'
     c                   eval      *in71  = *on
     c                   eval      w_numx = *zero
     c                   eval      w_sufx = *zero
      *
      * Henter dagens dato
      *
     c                   time                    w_udat
      *
      * Finner moms-sats
      *
     c                   call      'FÅ705R'
     c                   parm                    w_firm
     c                   parm                    w_udat
     c                   parm                    w_mvap
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
      *
      * Hente inn brukerregister
      *
     c                   eval      fusrl1_user = l_user
     c     fusrl1_key    chain     fusrl1r                            90
      *
      * Hente inn kode-registre
      *
     c     fstsl1_key    chain     fstsl1r
7.fb c     fst2l1_key    chain     fst2l1
     c     lstsl1_key    chain     lstsl1r
      *
     c                   eval      w_fell = faaork
      *
      * Posisjonerer databasen, og fyller opp subfile
      *
5.34 c                   eval      fohel1_numm = p_numm
     c                   eval      fohel1_suff = 0
     c     fohel1_key    setll     fohel1
5.20  *
5.20  * Hente inn verdier fra brukerregister,
5.20  * for å oppdatere H1-bildet med valg
5.20  *
5.20 c                   eval      h1utla = fbutla
5.20 c                   eval      h1otyp = fboty1
5.20 c                   eval      h1oty2 = fboty2
5.20 c                   eval      h1oty3 = fboty3
5.20 c                   eval      h1ityp = fbityp
5.20 c                   eval      h1user = fbuse2
5.20 c                   eval      h1kund = fbkund
5.20 c                   eval      h1benr = fbbenr
5.20 c                   eval      h1selg = fbsel2
5.20 c                   eval      h1avde = fbavde
5.20 c                   eval      h1lage = fblage
5.20 c                   eval      h1rekv = fbrekv
5.20 c                   eval      h1belp = fbbelp
5.20 c                   eval      h1valg = fbvalg
5.20 c                   eval      h1lmat = fblmat
5.20 c                   eval      h1oanm = fboanm
      *
7.10 c*                  eval      b2fsrt = 1
7.10 c*                  eval      w_fsrt = b2fsrt
      *
7.05 c                   if        p_numm <> 0
7.05 c                   eval      w_seqe = ' '
7.05 c                   else
7.05 c                   eval      w_seqe = 'S'
7.05 c                   eval      b_open_sok = *on
7.05 c                   endif
7.05 c                   exsr      crt_subfile
      *
7.01  *
7.01  * Utvidet memosaldo
8.03  *   Hent inn ant dager fram ordre skal med i memosaldo
8.03  *   Hent inn % utvidelse av kreditgrense
8.03  *
8.03 c                   eval      w_memodagr = 999
8.03 c                   eval      w_utvgrns  = 0
8.07 c                   time                    w_date
8.03  *
8.03   CallP CO402R(l_filg:w_firm:0:'UTVIDET_MEMOSALDO':
7.01                    co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     u_kmem = *on;
8.03     if  %subst(co402_verdi2:1:3) <> *blank;
8.03       w_memodagr = %dec(%subst(co402_verdi2:1:3):3:0);
8.03     endif;
8.03     if  %subst(co402_verdi2:133:2) <> *blank;
8.03       w_utvgrns = %dec(%subst(co402_verdi2:133:2):2:0);
8.03     endif;
7.01   endif;
8.11  *
8.11  * Endring 8.11 Tilbudskunde
8.11  *
8.11   CallP CO402R(l_filg:w_firm:0:'FO736_707':
8.11                   co402_verdi1:co402_verdi2);
8.11   if co402_verdi1 = '1';
8.11     u_til = *on;
8.11   endif;
      *
     c                   endsr
      *
**     M e l d i n g e r
Feil, Den valgte ordretype er ikke tilbud         <---
Denne ordre er allerede plukket til bestilling    <---
Det er ikke tillatt å endre dokumentet, bruk vise.<---
Bruker har ikke lov til å oppheve holdt ordre     <---
Dette valget er ikke tillatt for bruker           <---
