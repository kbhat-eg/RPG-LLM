# RPG Program Explanation â€“ VV130R

This RPG program is for IBM i (AS400) using the ILE RPG/400 (RPG IV) language. Its main function is to manage and display information about product-supplier relationships using subfiles and interactive displays. Below is a guided walkthrough, broken up into logical sections.

---

## 1. **Program Specifications and File Declarations**

### Header Specification (`H`)
```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: Disables debug for I/O operations.
- `datedit(*dmy)`: Date fields use day-month-year format.

### File Definitions (`F`)

- Three physical files are declared:
  - **vvarl1**: Products file, keyed, external, with rename.
  - **rlevl1**: Suppliers file, keyed, external, with rename.
  - **vvlel1**: Product-supplier linkage, keyed, external, with rename.
- **VV130d**: Display file, with subfile `b1sfl` and record format `b2ctl`. Also uses an information data structure (`infds`).

---

## 2. **Data Structures and Variables**

### Local Data Area (LDA)
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Extracts specific ranges from the LDA for `user`, `firm`, and `fnav`.

### Display File Feedback (infds)
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Used to track display feedback, notably the first record number on the screen (`d_fcrn`).

### Key Variables
Variables like `vvarl1_vare`, `rlevl1_ldor`, `vvlel1_lldo` are used to construct keys for relevant physical files.

### Working Variables
Variables such as:
- `w_fcrn`, `w_stel`, `w_spge`, etc.: Subfile page and record counters.
- `w_seqe`: Sequence indicator.
- `b_oppr`, `b_forn`, etc.: Binary flags for various states.

### Constants
```rpg
d c_sfil          s              2  0 inz(14)
```
- Subfile page size: 14 entries per subfile page.

### Cursor and Subfile Field Documentation
The comments describe the use of these working variables.

---

## 3. **Indicator Usage**
- Standard indicator mapping is described (e.g., 10 = RollUp, 14 = SFLCLR, 15 = SFLEND).
- 31-79: Used for error/warning indicators.

---

## 4. **High-Level Screen Flow**

### Main Loop Tags
- `b2taga` and `b2tagb`: Entry points for screen logic.
- Shows CMD display, processes subfile operations, and handles user function keys.

### Function Key Handling
- *INKC, *INKL: Exit keys (Cancel/Exit).
- *INKE: Refreshes the subfile.
- *IN10: Create subfile page.
- *IN11: Scroll back a subfile page.
- *IN21/*IN22: Cursor positioning.
- Custom routines (subroutines or "subrs") process these actions.

---

## 5. **Subroutine Overview**

### 1. **forny**: Refresh Subfile
- If there's a saved cursor position, tries to chain to it.
- Positions the file pointer, clears and re-creates the subfile.

### 2. **posisjoner**: Position in Subfile
- Handles logic to jump to a specific logical position in the subfile, based on user input.

### 3. **subfile**: Subfile Input Handling
- Reads through the displayed subfile records.
- If a specific "valg" (choice) code is seen (typically `5` for "view"), pops up a detail screen.

### 4. **xc2bld**: Maintain/View Detail Record (C2BLD)
- Reads detail data for the selected linkage, displays it in an editable/viewable window.
- Handles function keys for exit and re-display.

### 5. **clr_subfile**: Clear Subfile
- Triggers the SFLCLR function to clear out the current subfile display.

### 6. **crt_subfile**: Create Subfile Entries
- Loads up to a full subfile page from the product-supplier linkage file.
- Reads related product and supplier data for display.

### 7. **bck_subfile**: Scroll Backward in Subfile
- Scrolls one page back in the subfile, loading the correct records for display.

### 8. **dsp_subfile**: Display Subfile
- Handles writing/control of subfile and its control record, including handling cursor-based display logic.

### 9. **\*inzsr**: Initialization
- Entry point initializes from program parameters and sets up the first subfile page.

---

## 6. **Key Lists (KLIST)**
Defines composite keys for file lookups:
- `vvlel1_key`: For product-supplier linkage.
- `vvarl1_key`: For products.
- `rlevl1_key`: For suppliers.

---

## 7. **Program Entry and Setup**
- On entry (`*inzsr`), program receives `firm` and `lvnr` (supplier number) as parameters.
- Reads info from product file and stores in both internal and screen variables.
- Initializes subfile and displays first page.

---

## 8. **Subfile Paging**

The subfile is managed via the following operations:
- **Next page:** Adds records with `crt_subfile`
- **Previous page:** Paginates back with `bck_subfile`
- **Position to:** Jumps using `posisjoner` and pointer logic
- **Refresh:** Reloads current page with `forny`

---

## 9. **Display File Formats**

Used record formats include:
- `b1sfl`: The subfile format for listing records.
- `b2ctl`: Subfile control record.
- Other detail/edit screens (C1BLD, C2BLD) for input/modification.

---

## 10. **General Observations**

- The program is built for interactive use (5250 green-screen).
- It uses traditional RPG IV fixed format and indicator usage, heavy reliance on subroutine blocks and display file interaction.
- Comments and variable names are in Norwegian, but logic is generic for subfile maintenance.

---

# **Onboarding Summary**

A new developer should focus on:
- Understanding subfile logic (paging, clearing, reading, and populating)
- The use of indicators for screen state management
- The interaction pattern between RPG logic and the display file
- Key construction for file access
- Initialization flow and parameter passing

This program is a classic example of subfile-driven maintenance applications often found on IBM i, and understanding its subroutines and indicator-driven state machine is crucial for effective support and extension.