# Explanation of the RPG IV (ILE RPG) Code: FP255R

This RPG program is named **FP255R** and is used for "Utskrift av etiketter fra radioterminal" (Printing labels from radio terminals). It is designed for the **ASOFAK** system and outputs print instructions for label programs based on parameters or database lookups.

Below, you'll find an explanation of each section for onboarding developers.

---

## 1. **Header and Documentation**
The code starts with extensive comments describing:
- System: ASOFAK
- Program: FP255R
- Purpose: Printing labels based on parameters.
- Author, version, and change history.

---

## 2. **File Declarations**

```rpg
Fvfaspf    if   e           k disk
Fparam     o  a f  128        disk
```
- **vfaspf**: Input file, keyed access, external, disk file.
- **param**: Output file, add mode, externally described, 128-byte records, disk file.

---

## 3. **Data Definitions**

### *Local Data Area* (LDA) Variables

These D-specs correspond to positions in the user space (UDS), often for job or session state sharing:
```rpg
D                uds
D l_etyp                111    111  0
D l_etpr                112    112  0
D l_ken1                113    113  0
D l_ken2                114    114  0
D l_dato                115    120  0
D l_sort                121    121  0
D l_ruti                800    809
D l_user                911    920
D l_firm                944    946  0
D l_fnav                951    980
```
- `l_etyp`, `l_etpr`, `l_ken1/2`, etc., are single-character/number fields for controlling label print types, sorting, dates, etc.

### *Working Variables*

```rpg
D wpin03          s              1
D w_firm          s              3  0
D w_dato          s               d   datfmt(*iso)
D w_anta          s              1  0 inz(1)
D p_vare          s             15
D p_type          s              1
D w_type          s              1  0
D p_pris          s              1
D w_pris          s              1  0
```
- `w_firm`: Firm number (3-digit integer)
- `w_dato`: Date (in ISO format)
- `w_anta`: Quantity, default (1)
- `p_vare`, `p_type`, `p_pris`: Input parameters (item, type, price)
- `w_type`, `w_pris`: Working copies of type and price.

---

## 4. **Calculation (Main Logic)**

### *Initialization and Setting Parameters*
- The main calculation area starts by outputting a record with the `EXCEPT add001` opcode.

- **LDA Fields Update:**
  ```rpg
  C                   eval      l_etyp = w_type
  C                   eval      l_etpr = w_pris
  C                   eval      l_sort = vnsort
  C                   eval      l_ken1 = 1
  C                   eval      l_ken2 = 2
  C     *dmy          move      w_dato        l_dato
  ```
  Sets LDA values based on working variables.

---

### *Choosing Label Print Program Based on Type*
- The program assigns a print routine (e.g. 'FP213 ', 'FP214 ', etc.) to `l_ruti` depending on label type (`l_etyp`).  
- Each label type represents a label format/size:
    - 1: Price label
    - 2: Shelf label 75x28 mm
    - 3: Shelf label 100x28 mm
    - 4: Rack label 202x60 mm
    - 5: Shelf label 76x39 mm
    - 6: Shelf label 48x38 mm
    - 7: Shelf label 100x38 mm
    - 8: Rack label 210x60 mm
    - 9: Shelf label 76x39 mm (Laser/Interform)

---

### *End of Job and Cleanup*
```rpg
C     slutt         tag
C                   eval      *inlr = *on
```
- Mainline ends, program signals "last record" (`*inlr = *on`) to close files and clean up.

---

## 5. **Subroutine: Program Initialization (`*inzsr`)**

Called automatically on program start.

- **Current Time / Date:**
    ```rpg
    C                   time                    w_dato
    ```
    Puts current time into `w_dato`.

- **Firm Number:**
    ```rpg
    C                   move      l_firm        w_firm
    ```
    Loads the firm number from LDA.

- **Parameters:**
    ```rpg
    C     *entry        plist
    C                   parm                    p_vare
    C                   parm                    p_type
    C                   parm                    p_pris
    ```
    Defines entry parameters.

- **Fetch Label Information:**
    - If label type parameter = '0', then look up the type in `vfaspf` database.
      - On not found, default type = 1.
      - On found, use `vnetyp` field from file.
    - Otherwise, type is parameter's integer value.
    - `w_pris` always set from price parameter.

    - **Key definition (`KLIST`):**  
      Used for chained reads in `vfaspf`, keyed by firm.

---

## 6. **Output Specifications**

```rpg
Oparam     eadd         add001
O                                            1 'A'
O                       w_firm               4
O                       p_vare              19
O                       w_anta              20
```
- Writes records to the `param` file for downstream label programs.
    - Record identifier: 'A'
    - Field positions: firm (positions 1â€“3), item code, quantity, etc.

---

## **Summary**

- The program receives (via parameters) an item, type, and price.
- If type is not specified (`'0'`), it looks up the item in a database to find the label type.
- Sets working values and LDA fields accordingly.
- Chooses the correct print program code for the label type (e.g., 'FP213').
- Outputs a record for the print subsystem to process.

**All logic is compact and specific for driving automatic label printing in a warehouse or production setting. The code is straightforward, using classic fixed-format RPG logic with some use of the LDA.**

---

**For new developers:**  
- Understand the database (`vfaspf`) and output file layouts are crucial.
- Most business logic involves mapping input values to the correct print job based on simple rules.
- Entry point is via parameters; main use is in batch or with a calling program (not interactive).