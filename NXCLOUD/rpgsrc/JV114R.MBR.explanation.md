# Program Overview

This RPG/400 (ILE RPG) program is called `JV114R` and is part of an AS/400 (IBM i) system named ASVADM. It is described as "Avgifter, vedlikehold" (Fees, maintenance), likely managing a list of fees (avgifter) and their maintenance in a subfile-based display. The source is extensively commented in Norwegian and structured into subroutines for clarity and maintainability.

---

## File Definitions

### Database Files

- **JVARL3**: Input keyed file, renamed record format `jvarl3r`.
- **JVAVL1**: Input keyed file, renamed `jvavl1r`.
- **JVAVLR**: Input keyed file, renamed `jvavlrr`.
- **JVAVLU**: Update keyed file, renamed `jvavlur`.

### Display Files

- **JV114d**: Display file with subfiles and control records:
  - Subfile: `B1SFL` with relative record number `w_srrn`
  - Control: `B2CTL`, `B2CMD`, etc.
  - Info Data Structure: `dspfbk` for display feedback

---

## Data Definitions

### Local Data Area

- **l_user**: User id (positions 911–920)
- **l_firm**: Firm number (944–946)
- **l_fnav**: Firm name (951–980)

### Display Feedback Data Structure

- **d_fcrn**: First record number on page (feedback from display)

### Work Variables

- **w_fcrn, w_stel, w_spge, w_srrn, w_sfrn, w_ssrn**: Working variables for managing subfile positioning and scrolling
- **b_oppr, b_forn, b_anul, b_feil**: Various binary (on/off) flags for program state
- **b1valg**: Action code from subfile line (0 = none, 2 = edit, 3 = copy, 4 = delete, 5 = view)

### Key Variables

- **jvavl1_akod, jvavlr_akod, jvavlu_akod, s_akod**: Key fields for searching/updating records in various files

### Constants

- **c_sfil**: Subfile page size (default 13)

---

## Indicator Usage

The code uses indicators for program flow and display logic. Notable indicators:

- **LR**: Last Record – end program
- **10/11**: Rollup/Rolldown (page forward/back)
- **12/13/14/15**: Subfile display/clear/end logic
- **21/22**: Home key/cursor positioning
- **30**: Field protection
- **31–99**: Error/message/working indicators

---

## Display Record Formats

- **B1SFL**: Main subfile with records of fees
- **B2CTL**: Subfile control record
- **B2CMD**: Command key window
- **C1BLD, C1MSG**: Entry and message screens for adding new record
- **C2BLD**: Maintain/view entry record
- **D1WIN**: Delete confirmation window
- **K1WIN**: Copy confirmation window

---

## Program Flow

### Mainline

- **Start**: 
  - Write `B2CMD` (F-key window)
  - Display/search/position subfile using tags and subroutines

- **User Function Keys Handling**: 
  - Handles keys for exit (`*INKC`, `*INKL`), refresh, add new, page forward/back, home, cursor, etc.

- **Subfile Processing**: 
  - Reads the subfile, processes user actions on each line (edit, copy, delete, view)

- **Subroutines**: 
  - All major tasks (refresh, position, edit, copy, delete, clear, fill, display subfile, etc.) are performed in named subroutines.

---

## Key Subroutines Explained

### `forny`: Refresh Subfile
- Positions to the current subfile record.
- Clears and refills the subfile.

### `posisjoner`: Position Subfile
- Used when searching for a key value.
- Positions database, clears and refills the subfile from that key.

### `subfile`: Process Subfile
- Handles user actions (edit, copy, delete, view) on each subfile row.

### `xc1bld`: Add New Record Screen (C1BLD)
- User enters key for new record.
- Validates input; checks for duplicates.
- Calls `xc2bld` for edit/view logic if record is new.

### `xc1msg`: Duplicate Key Message (C1MSG)
- Shows message if trying to add a duplicate key.

### `xc2bld`: Edit/View Record (C2BLD)
- Retrieves existing data for given key (if present).
- Allows editing of fields.
- Updates or adds records as appropriate to `jvavlur`.

### `xd1win`: Delete Confirmation (D1WIN)
- Shows confirmation, then deletes the record.

### `xk1win`: Copy Record (K1WIN)
- Shows copy panel.
- Validates, aborts if target key exists.
- Calls `xc2bld` to create the new entry.

### `clr_subfile`: Clear Subfile
- Turns on subfile clear indicator, writes control record to empty out subfile.

### `crt_subfile`: Fill Subfile
- Fills subfile with next page of entries.
- Handles end of file and paging logic.

### `bck_subfile`: Page Back
- Pages backwards in the database to previous subfile page.

### `dsp_subfile`: Display Subfile
- Shows the subfile to the user, with appropriate indicators.

### `*inzsr`: Initialization Subroutine
- Loads parameters, initializes screen fields, positions database, fills initial subfile.

---

## User Operation

1. **Program Started**: Loads firm info, fills subfile.
2. **User Views, Pages, or Positions**: 
    - Can page forward/back, position to a specific code, or use the home key.
3. **Record Actions**:
    - **Edit** (2): Opens edit popup for the selected code.
    - **Copy** (3): Opens copy dialog, allowing duplication to a new key.
    - **Delete** (4): Opens delete confirmation dialog.
    - **View** (5): Opens record in "view only" mode.
    - **Add New**: Via a function key, prompts for new code and details.

4. **All interactions are handled in a loop, with subfile and screen state being maintained by the working variables and indicators.**

---

## Noteworthy Design Points

- **Subfile Paging**: Handled via `w_srrn`, `w_ssrn`, etc., with standard subfile clear/fill logic.
- **Flexible Input Handling**: Uses RPG indicators for key/command handling at all critical points.
- **Modular Design**: Each operation is a self-contained subroutine, which improves clarity and maintainability.
- **Data Integrity**: Validates keys before operations; duplicate detection; error/message indicators.
- **Display Feedback**: Uses the INFDS (dspfbk) to maintain subfile scroll/cursor position.

---

## Summary Table

| Subroutine    | Purpose                                         |
|---------------|-------------------------------------------------|
| forny         | Refresh/renew subfile                           |
| posisjoner    | Position to specified key in subfile            |
| subfile       | Loop: handle user actions/edit/copy/delete/view |
| xc1bld        | New entry key input + validation                |
| xc1msg        | Message if adding duplicate                     |
| xc2bld        | Main entry edit/view logic                      |
| xd1win        | Delete record                                   |
| xk1win        | Copy record                                     |
| clr_subfile   | Clear (empty) subfile                           |
| crt_subfile   | Fill subfile page with data                     |
| bck_subfile   | Page backward in subfile                        |
| dsp_subfile   | Display subfile to user                         |
| \*inzsr       | Initial program setup                           |

---

## Onboarding Tips

- **Familiarize with indicators**: See comments for their meaning.
- **Trace the mainline logic**: Program loops between displaying command windows and subfile actions using tags and `goto`.
- **Learn the subfile/pageing pattern**: Classic RPG model for scrolling lists.
- **Each "panel" is a display format**: See the "Benytte skjermbilder" section.
- **Most subfile actions (edit/copy/delete) are dispatched from a single loop reading subfile lines**.

---

## Additional Notes

- The code makes extensive use of old-style fixed-format RPG, with a clear separation of data definitions, file specs, calculations, and subroutines.
- The comments (mostly in Norwegian) are thorough, aiding maintenance and onboarding.
- Many variables are named closely after the display file and database field names.

---

**In short:** This program presents a subfile UI for maintaining fee codes, supporting CRUD operations with paging, input validation, and user feedback, structured using classic, modular RPG subroutines. If you are new to AS/400 and RPG, start by walking through each subroutine in the order they are called from the mainline to understand the user interaction flow.