# Documentation for Program RB003R

## Overview

**Program Name:** RB003R  
**System:** ASOFAK  
**Description:**  
This program reads transaction lines from the BOVF file (likely a voucher or journal entry detail file) and outputs them in a comma-separated format suitable for import into an external system ("Visma Business"). The output is written to the `RV02PF` file, which appears to be a sequential output file for data transfer.

The program is tailored for a Norwegian business setting, with several business-specific conventions and requirements, such as date handling and firm filtering.

## Business/Domain-Specific Logic

- **Firm Filtering:** Only records matching the current firm (`l_firm` vs. `bffirm`) are processed.
- **Date Handling:** Dates are extracted and reformatted from various fields for output and key construction.
- **Voucher Data Export:** Voucher lines are exported with a specific structure and set of fields, including debit/credit information, amounts, and additional metadata.
- **Department Handling:** Department (`avdeling`) information is optionally included from the invoice header (`SOHE` file).
- **File Layout:** The program outputs both metadata/header lines and transactional detail lines, using a specific text format expected by the downstream system.

## File Relationships

- **BOVFL1:** Input file, likely containing voucher/journal entry lines.
- **SOHEL1:** Input file, likely containing invoice headers, renamed to `sohel1r` for local reference.
- **RV02PF:** Output file, receives the formatted, comma-separated export lines.

## Key Data Structures

- **Local Data Area:** The program uses the LDA to retrieve the current firm (`l_firm`).
- **Date Structures:** Multiple data structures are defined for handling valuation date, due date, and voucher date, each split into components (year, month, day).
- **Key Structures:** A KLIST (`sohel1_key`) is defined for looking up invoice headers based on firm, year, and invoice number.

## Main Processing Flow

1. **Firm Filtering:**  
   At the start of each record, the program checks if the current record's firm matches the one in the LDA. If not, it skips processing (`goto slutt`).

2. **Header Output:**  
   On the first record (`tell = 0`), the program writes several header lines to the output file, indicating the start of a firm section and defining the import method and column descriptions.

3. **Current Date Handling:**  
   The current system date is retrieved and formatted for output.

4. **Voucher Line Export:**  
   For each voucher line:
   - Dates (voucher, due, valuation) are reformatted.
   - Amounts are formatted with four decimal places.
   - Debit and credit VAT codes are determined based on account ranges.
   - Department information is retrieved from the invoice header if available.
   - A formatted output line is constructed, concatenating all relevant fields, and written to the output file.

5. **Invoice Header Lookup:**  
   The `control_init` subroutine uses the key fields to locate the corresponding invoice header in `SOHEL1`. If found, department information is extracted.

## Notable Design Decisions and Conventions

- **Header Lines:** The output begins with several metadata lines, using a custom format (e.g., `@FIRM_BEGIN`, `@IMPORT_METHOD`). These are likely required by the downstream import process.
- **Date Extraction:** Dates are handled as substrings and numeric conversions, reflecting a need to map between internal and external formats.
- **Account Range Checks:** VAT codes are only output if account numbers are within the 1000â€“9999 range, aligning with Norwegian chart of accounts conventions.
- **Department Handling:** The department is fetched from the invoice header only if the header is found; otherwise, it is set to zero.
- **Blanking/Zeroing Fields:** Several fields are explicitly cleared before use, ensuring no data leakage between records.
- **Tag/GOTO Usage:** The program uses tags and GOTO for flow control, which is a common pattern in legacy RPG codebases.

## Interactions with Other Modules

- **SOHEL1 (Invoice Header):** The program performs keyed lookups to enrich the output with department information.
- **LDA (Local Data Area):** Used to retrieve the current firm, enforcing firm-level data separation.

## Version History Highlights

- **6.22:** Adjusted field spacing.
- **6.23:** Added firm filtering.
- **6.24:** Changed valuation date to match voucher date.
- **6.30:** Checked for number expansion.
- **7.00:** Added department to sales postings.

## Key Variables and Fields

- **l_firm:** Firm number from LDA.
- **bffirm, bfbiln, bfbilk, bfdkto, bfckto, bftext, bfbelp, bfdmom, bfcmom, bfproj:** Fields from BOVF input.
- **soavde:** Department from SOHEL1.
- **rvdata:** Output buffer for RV02PF.
- **zfbelp:** Amount with four decimals for output.
- **f1momd, f1momc:** VAT codes for debit/credit.
- **f1avde:** Department for output.

## Output Format

Each exported line contains (in order):

1. Voucher number
2. Voucher date
3. Valuation date (now set to voucher date)
4. Voucher type
5. Voucher text
6. Debit account
7. Debit VAT code
8. Credit account
9. Credit VAT code
10. Invoice number
11. Amount (4 decimals)
12. Department (may be blank)
13. Due date
14. KID number (customer identification, may be blank)
15. Project (may be blank)

All fields are quoted and space-separated, matching the requirements of the import process.

## Summary

This program is a specialized data exporter, transforming voucher line records into a structured, comma-separated format for import into an external accounting/business system. It enforces firm-level filtering, reformats dates and amounts, and enriches output with department information when available. The design reflects both legacy RPG conventions and business-specific requirements, particularly those relevant to Norwegian accounting practices and the Visma Business system.