# RPG Program RP100R â€“ Maintenance and Inquiry for Projects

## Overview

This RPG (Report Program Generator) program is a classic ILE RPG IV (fixed format, C-spec) application intended for the maintenance (CRUD operations) and inquiry of projects and their subprojects, with extended subfile handling and integration with various master data (such as customers, project leaders, departments).

It features a typical green-screen UI, allowing users to browse, maintain, and report on project hierarchies, budget and actual figures, and perform related lookups.

The program is modular, highly structured into routines (subroutines), and annotated throughout with Norwegian business terminology.

---

## 1. **Header Section and Metadata**

```rpg
h option(*nodebugio) datedit(*dmy)
```

- **option(*nodebugio):** Prevents debug information for file I/O.
- **datedit(*dmy):** Ensures default date edit word is dd.mm.yyyy.

**Comments:**  
- The initial block documents system, author, purpose, and change history.
- Provides indicator usage (LR, 10-99), helping new developers understand the "flag" system.

---

## 2. **File Declarations**

Example:
```rpg
frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
frp2ul1    if   e           k disk    rename(rp2upfr:rp2ul1r)
frp2ulu    uf a e           k disk    rename(rp2upfr:rp2ulur)
...
frp110d    cf   e             workstn sfile(b1sfl:w_srrn)
             infds(dspfbk)
```

- **Input/Output Files:** Various database files for projects, subprojects, activities, customers, departments, etc. Some are reused with different internal record formats via `rename`.
- **Display File:** `frp110d` is the main display file, with subfile handling (`sfile`). `infds` is display feedback data structure.

---

## 3. **Data Structure / Variable Declarations**

- **Constants for ASCII translation (lo/up):** For case transformation.
- **Local Data Area (LDA):** User and firm identification pulled from system LDA.
- **Feedback Data Structure:** Used to get the current record number etc. from the display infds.

A wide set of variables is defined for:
- Record keys (`rp1pl1_pros`, `rp2ul1_upro`, etc.).
- Working variables for pagination and subfile mechanics (`w_fcrn`, `w_srrn`, `w_spge`, etc.).
- Data exchange with external programs (`p_pros`, `p_firm`, etc.).
- Formatting/labels for subfile columns.

---

## 4. **Subfile and Screen Handling**

**Subfile Navigation Variables:**
- **w_fcrn, w_srrn, w_ssrn, w_spge, w_sfrn:** For paging, scrolling, positioning records within the subfile.

**Screen Labels:**
- Various labels configured for dynamic column headings in the subfile (e.g., switching between date, budget, cost views depending on state variable `w_a51`).

---

## 5. **Mainline Logic**

### Initial Project Selection and Creation

- Checks if a project date (`p_fdat`) is provided; if so, jumps straight to the creation screen.
- Provides the ability to go directly to project activities (`RP120R`) if relevant flag is set.

### Main Event Loop

- Uses RPG tags (e.g., `b2taga`, `b2tagb`) to structure the user interaction loop.
- `write b2cmd` displays the command line.
- Calls subroutines based on user action: e.g. `exsr dsp_subfile` to display the subfile.

### Function Key Processing

- Handles function key presses such as:
    - Program exit (`*inkc`, `*inkl`)
    - Refresh/Forny (`*inke`)
    - Print/Report (`*inkf`)
    - Various switching of view (`*inkk`)
    - Paging (`*in10`, `*in21`)
- Conditional navigation and calls based on flags and values in data entry/screens.

### Filtering

- Supports filtering the subfile on activity status, department, project leader, and search/positioning based on subproject ID or text.

---

## 6. **Subroutines**

### forny

- Positions and clears subfile based on selection mode (`w_seqe`).
- Calls subroutines to clear and create subfile.

### posisjoner

- Positions the subfile to a specific subproject or description if provided, then refreshes.

### subfile

- Loops through subfile records, handling user edits:
    - Status changes, update, copy, delete, view details, order lines, postings, etc.
    - Supports navigation to other maintenance programs on demand.
    - Sets processing flags as needed.

### xc1bld (Creation Screen)

- Handles entry of a new subproject/task:
    - Loops until valid entry or cancellation.
    - Validates for duplicates, shows error if already exists.
    - Calls main maintenance screen on success.

### xc2bld (Maintenance Screen)

- Main maintenance (edit/view) screen for subprojects:
    - Loads data from database if exists, otherwise initializes.
    - Handles dynamic field lookups for project leaders, departments, customers, etc.
    - Validates all fields before commit.
    - Updates or creates records.

### getbudsj

- If subproject is divided into activities (`c2rak = 'J'`), totals budget from all activities.

### xc3bld (Report Parameter Screen)

- Handles report parameter input and launches project report programs.

### reddato

- Parses and normalizes user-entered date fields.

### xd1win / xk1win

- Handles the delete and copy popup windows for subproject rows.

### clr_subfile / crt_subfile

- Clears subfile, initializes paging variables.
- Fills the subfile with records according to filters, handles multiple view modes (dates, budget, cost, etc.).
- Calls subroutines to compute actual/accumulated amounts when requested.

### dsp_subfile

- Displays the subfile page, sets up the record number/cursor correctly.

### finn_sum

- Gathers sums for income and expense accounts for the current project/subproject by scanning various sections in the project transaction file.

---

## 7. **INZSR and Key Lists**

- **INZSR:** Program initialization. Handles entry parameters (for navigation from other programs), prepares key lists for chained file access.
- **Key Lists:** Explicitly defined for each file/indexed access, e.g. `rp2ul1_key`, `rkunl1_key`, etc., matching the underlying DB file structure.

---

## 8. **External Calls**

- The program frequently calls other RPG programs for:
    - Project activity maintenance (`RP120R`)
    - Project posting/ledger inquiry (`RP510R`)
    - Customer inquiry (`RK500R`)
    - Project leader lookup (`RP603R`, `RA509R`)
    - Various report writers (`RP801C`, `RP802C`)
    - Pop-up informational or error windows (`AA005R`, etc.)

---

## 9. **Business Logic Highlights**

- **Activity Splitting:** If a subproject uses activities, budgets are loaded from activities, not entered directly.
- **Project Leader Source:** Logic to decide if project leader is fetched from project leader or seller file, driven by setting.
- **Subfile Handling:** Robust paging, record positioning, search, and partial refresh.
- **Usage of Indicators:** For error handling, validation feedback, field protection, and UI interaction.

---

## 10. **Summary**

This RPG program is a well-structured, business-specific application for project and subproject management on IBM i (AS/400) systems. It leverages:
- Classic fixed-format RPG structures.
- Subfile mechanics for user-friendly navigation.
- Extensive use of subroutines for modularity.
- Integration with many related master data tables and business processes.

**Onboarding Tip:**  
Understanding the variable naming conventions ("w_" for work, "b1", "b2" for subfile levels, "c1", "c2" for different screen records, etc.), the indicator usage, and the RPG file model (external DB files and display files) is crucial for effective maintenance and further development.

**Reference**:  
This program is typical of complex green-screen ERPs on IBM i and is a good source to learn advanced subfile usage, modular RPG design, and application integration.