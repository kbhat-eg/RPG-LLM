# Explanation of ILE RPG Program: GL100R "Uttrekk av poster til betalingsforslag"

This program, written in ILE RPG, processes transactions for generating payment proposals (“utbetalingsforslag”) in an accounting/payroll system. The code is well-commented (in Norwegian), and handles both standard payments and payroll transactions. It also provides functions for reporting and archiving (including PDF/XML integration in later versions).

Below is a structured explanation to help a new developer understand the purpose, structure, and main logic of this program.

---

## 1. **Purpose and Context**

- **System**: ASOKON
- **Program name**: GL100R
- **Main Function**: Extract transactions (postings) to create payment proposals, including special logic for payroll (“lønns-transaksjoner”).
- **Modes of Operation (Parameter `wpparm`)**:
  - `'R'`: Standard extraction for payment proposal.
  - `'L'`: Transfers payroll transactions to payment proposal.
  - `'F'`: Information that there are no payroll transactions to transfer.

## 2. **Files and Data Sources**

The program uses multiple files, with records renamed to local names for clarity:

- **gl100d**: Workstation (Display) file.
- **afir*l1**: Company information.
- **rlbapf**: Bank account information.
- **gfaslu**: Company/static parameters.
- **rltrl9 / rltrl*u**: Supplier transaction files.
- **rlevl1**: Supplier master.
- **ra03l1**: Payment terms.
- **gavtl2**: Agreement (contract) file.
- **glonl1**: Payroll file.
- **gabf*pfX**: Various temporary/working files for proposals.
- **gl100p**: Output/Printer file.

---

## 3. **Variables and Data Structures**

- **levf/levt, katf/katt**: Arrays holding supplier/category intervals for selection.
- **txt**: Message text (for different display messages).
- **Dates**: Many variables representing dates in different formats for various fields (transaction/posting, payment, proposal, etc.).
- **wtamed**: Helper to indicate "YES"/"NO" for special handling.
- **KID**: Arrays and helpers for customer identification/structured references.

### Parameter Area

- `wpparm`: Main parameter for job mode.
- `wpuser`: User ID executing the job.
- `wwbfnr`: Proposal number.

---

## 4. **Program Flow**

### a. **Initialization** (`*inzsr`)

- Reads entry parameters.
- Sets up variables, helper fields.
- Loads company/static data and essential master records.
  
### b. **Handling No Payroll Transactions**

- If `wpparm='F'`, show info and exit.

### c. **Payroll Transaction Transfer**

If `wpparm='L'`:
- Loops through payroll transactions (`glonl1`).
- For each, creates a corresponding proposal line (`gabfpfu`), filling key fields (amount, recipient, etc.).
- After all, calls `GL102C` to print the proposal, then gives feedback to the user.

### d. **Screen Interaction and Main Menu**

- Presents main screen/form for parameter entry.
- Handles function keys: Exit (F3), Renew (F5), Cancel (F12).
- Allows viewing and editing of supplier/category intervals.
- Validates input fields (dates, intervals, supplier/category selections).
- Handles adding intervals to internal tables, with a maximum of 50.

### e. **Extracting Transactions (`xlestr`)**

- For each selected transaction (from `rltrl9`):
  - Applies extensive business rules to determine if the post should be included (see next section).
  - Writes eligible transactions to the proposal file.
- After processing, can perform credit note adjustment (“avregning”) and line renumbering.

---

## 5. **Key Business Rules (Extraction Phase)**

The `xwrite` subroutine executes the core logic for deciding if a transaction should be included:

- **Rest amount (`rorest`) must be > 0**.
- **Must not have a complaint code (`rorekl`)**.
- **Must be attested if required (`roatts`)**.
- **Returns handling**: Only include certain return statuses if allowed.
- **Remittance logic**: Handles posts already sent for remittance, avoiding duplicates unless specifically permitted.
- **Supplier selection**: Only include posts for selected suppliers/categories.
- **Currency and account logic**: Ensures correct bank/currency use.
- **Payment terms**: Pulls from supplier if not present.
- **Discount (Rabatt) calculation**: Determines discount eligibility and calculates adjusted payment dates/amounts if applicable.
- **Excludes future-dated posts or those not meeting date requirements**.
- **Special KID/structural references logic**.

---

## 6. **Post-Extraction Processing**

### a. **Credit Note Adjustment (Avregning)**

- If chosen, attempts to offset credit notes against invoices.
- Two options:
  - **On invoice due date**: Matches by due date and adjust accordingly.
  - **On largest due date**: Reassigns due dates to enable maximum offsetting.
- Marks and updates proposal file lines as needed.

### b. **Proposal Printing**

- Outputs summary and parameters.
- Calls `GL102C` to print or display the proposal according to user selections.

### c. **Archiving and XML/PDF Integration (Version 6.x)**

- In newer versions, after proposal generation:
  - Retrieves spool information,
  - Generates XML files for archiving (`AP627R`),
  - Launches PDF previews if requested (`AP621R`).

---

## 7. **Indicators & Key Usage**

- RPG indicators (`*inxx`) are heavily used for controlling flow, error handling, and file operations.
- Key lists (`klist`) are defined for complex database access and record searches, e.g. for supplier, proposal, transaction, etc.

---

## 8. **Error Handling and Messaging**

- The code uses fields, indicators, and message windows to inform the user of missing data, errors in intervals, and process progress.
- Inline message texts are displayed depending on context (e.g., during long processing, when no records found, or user action needed).

---

## 9. **Special/Advanced Features**

- **Proposal number logic**: Handles overflow (rolls back to 1 after 999).
- **KID field validation/normalization**: Ensures proper format for payment reference fields, including left-justification and content validation.
- **Payroll handling**: For payroll, certain fields (like voucher date) are always blank, with minimal field population.

---

## 10. **Modularity and Maintainability**

- The program is split into numerous subroutines (labelled as `begsr`) to encapsulate logic for validation, extraction, KID handling, reporting, archiving, etc.
- Uses comprehensive inline documentation, including a changelog.
- Integrates with external programs for reporting and archiving.

---

## 11. **Typical Customization/Parameters**

- **Supplier/Category Intervals**: Users can specify up to 50 supplier or category number intervals for extraction.
- **Date Filters**: Both run date and “to due date” can be set.
- **Discount and Credit Note Handling**: Options toggle logic for advanced matching/rabatt/credit balancing.

---

## 12. **Summary for Onboarding**

- **Entry Point**: `*inzsr` and mainline logic select operational mode.
- **File Handling**: Extensive use of disk files; read, chain, write, update operations.
- **Business Rules**: Core is in `xwrite`, applying numerous selection and eligibility tests.
- **Flexibility**: Modular design allows for different payment workflows.
- **Reporting/Archiving**: Integrated output, PDF, XML support.

**For onboarding:**

- Focus first on understanding the parameter entry and main selection logic.
- Then, step through the `xlestr` and `xwrite` routines for key business rule application.
- Review the credit note balancing logic (`xavreg` etc.).
- Finally, become familiar with how output (print, archive) is triggered and handled.

---

**Note:** The code is adapted over decades and thus supports a wide range of business scenarios and legacy data situations, with many exceptions and special cases. This is reflected in the number of version-specific comments and conditionally executed code blocks.