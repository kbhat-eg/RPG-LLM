# RPG Program MB105R - Explanation and Onboarding Guide

This is an ILE RPG (RPG IV) application that manages and analyzes ABC codes for inventory items (varer) using subfiles on a display file. The code includes display logic, data/file operations, and state management for interactive programs in the IBM i (AS/400) environment.

Below is a structured explanation to help developers understand and maintain the program.

---

## 1. **Program Overview**

- **Purpose**:  
  The program supports "ABC-analysis" for inventory items. ABC coding groups inventory by importance (A/B/C), and the program allows users to view, update, and analyze these codes via subfile-based screens.

- **History/Changelog**:  
  The initial version dates back to 2004. Over time, features like extended price groups, forecast integration, and GUI changes have been added.

---

## 2. **File Declarations**

The RPG code defines several logical and physical files, all with external definitions (e.g., `fmabclr`, `fmabdl1`), for reading and updating ABC data. Key points:

- Files like `mabclr`, `mabdl1`, etc., are renamed locally for clarity in the code.
- Suffixes (`l1`, `l3`, etc.) indicate different logical views or orderings (e.g., by item, by code, etc.).
- Files with `uf` are update-capable and can be added (A) or changed (`e`).
- `MB105D` is the display file, using subfile `b1sfl:w_srrn` and feedback DS `dspfbk`.

---

## 3. **Data Area and Structure**

- **Local Data Area (LDA)**:  
  Used to get the current user, company (firm), and other session variables (`l_user`, `l_firm`, `l_fnav`).
- **Display Feedback (`dspfbk`)**:  
  Used for getting the cursor row on the display.
- **Key Variables**:  
  Variables like `mabdl1_vare` correspond to key fields in physical/logical files.

---

## 4. **Main Variables**

- Variables for subfile management (`w_fcrn`, `w_spge`, `w_srrn`, etc.).
- Logical flags for processing states (`b_oppr`, `b_forn`, etc.).
- Work variables for business logic (`w_kabc`, `w_akkp`, etc.).
- Input parameters (e.g., `p_lagk`, `p_vsor`), mostly passed in to drive the analysis.

---

## 5. **Indicators**

- Classic RPG indicators are used for both screen fields and program logic (e.g., `*inlr` for last record, `*in10` for function keys).
- Comment block documents the usage (10=Rollup, 11=Rolldown, 12=Subfile display, etc.).

---

## 6. **Main Logic Flow**

### **Program Entry and Initialization (INZSR)**

- Called when the program is loaded.
- Reads parameters (`*ENTRY PLIST`) into working variables.
- Sets up display keys and subfile starting positions.
- Reads header info and initializes key analysis parameters.
- Calls `hent_prisgr` to get price group.
- Positions the detail file (`mabdl5`) at starting key.
- Fills the subfile (`crt_subfile`).

---

### **Main Processing Loop**

#### **Labels/Tags and Subroutines**

- `b2taga` and `b2tagb` are entry points to control the program state.
- `dsp_subfile` displays the subfile.
- User interaction is handled by catching function keys and branching via `select/when`.

#### **Function Key Handling**

- Each function key (`*inka`, `*inkc`, etc.) calls a specific subroutine or alters program state.
  - E.g., `*inka` calls help window (`xh1win`), `*inkd` triggers inquiry (`spørring`), `*inkg` sets exit value, etc.

#### **Positioning and Subfile Handling**

- On certain inputs, subfile is re-positioned based on key fields (item, code, turnover, percent).
- Calls `posisjoner` to do this logic, then re-blanks and re-creates the subfile.

#### **Subfile Update/Inquiry**

- `subfile` reads all changed subfile records, processing updates or calls to subscreens for each.
- Handles both "change" and "view" logic by calling `xc2bld` and `xc3bld` respectively.

---

## 7. **Subroutines**

### **forny**
- Refreshes the current subfile page based on position and context.
- Calls `clr_subfile` and `crt_subfile`.

### **posisjoner**
- Sets file position for subfile viewing by populating the correct key fields.
- Handles each type of position (item number, code, percent, turnover).

### **subfile**
- Iterates through changed subfile records (`readc b1sfl`), processing any changes or updates.
- For change, calls `xc2bld`; for view, calls `xc3bld`.

### **xc2bld / xc3bld**
- Handles display and update of a single ABC detail, including input validation and back-end updates.
- Updates main files and possibly dependent register files (`vvarlur`, `vlaglur`).
- Calls out to external programs for price calculation and forecast ABC code update.

### **xh1win / xh2win**
- Handle display of help/option and explanation windows.

### **clr_subfile / crt_subfile**
- Manage clearing and filling pages of the subfile, including key filtering and value formatting.

### **bck_subfile**
- Handles rolling back (page backward) in the subfile listing.

### **dsp_subfile**
- Presents the subfile; sets screen indicators for display management.

### **finn_pris**
- Finds (calculates) the item's price by calling an external program (VP750R), passing all relevant fields.

### **hent_prisgr**
- Gets the price group for a given warehouse and assigns it to `w_prgr`.

### **upd_prog_abc**
- Calls external program (MM747R) to update forecast table with new ABC code.

### **spørring**
- Inquiry routine for items, calls an external item info program.

---

## 8. **Key Lists**

Key lists (`klist`) define compound keys for file access. This enables fast and accurate access for setll/chain/read operations.

---

## 9. **External Calls**

Some routines call external programs for:
- Price calculation (`VP750R`)
- Item info inquiry (`VV500R`)
- Price group lookup (`VL712R`)
- Forecast update (`MM747R`)

These are likely CL or RPG programs in the wider ERP ecosystem.

---

## 10. **Screen/Display File Handling**

- The program is built around a display file with subfiles.
- Several screens defined for subfile (main list), control, command, and detailed item change/view.
- Uses RPG classic subfile patterns: load, display, read changed, update.

---

## 11. **Special Details**

- Handles both item-level (`vvarl1`, `vvarlu`) and warehouse-level (`vlagl1`, `vlaglu`) ABC coding and lock status.
- Manages both ABC code and XYZ groupings.  
- Extensive use of indicators and subfile fields for display and processing control.

---

## 12. **General Tips for Onboarding**

- **Understand Subfiles**: Familiarity with IBM i subfile display patterns is crucial.
- **Know the Data Model**: Study the physical files (`mabcpfr`, `vvarpfr`, etc.) and their logical views.
- **External Programs**: Be aware that business logic is distributed; trace and understand the called programs.
- **Indicators and Data Structures**: The program uses many flags; careful tracking of their use is important for modifying flow or adding features.
- **Norwegian Language**: Some field and comment text is Norwegian; use translation if necessary.

---

## 13. **Summary Table of Main Components**

| Section        | Purpose                                                    |
|----------------|------------------------------------------------------------|
| File Section   | File declarations and renaming for ABC & item data         |
| Data Section   | Working variables, LDA, constants, indicators              |
| Main Loop      | User interaction, subfile management, function key logic   |
| Subroutines    | Subfile operations, display, update, position              |
| External Calls | Price, item, and code update routines (external programs)  |
| Init Section   | Reads parameters, initializes, and fills first subfile     |

---

## 14. **Quick References**

- **Common Operations**:
    - Clear subfile: `clr_subfile`
    - Fill/load subfile: `crt_subfile`
    - Update/view item: `xc2bld`, `xc3bld`
    - Price lookup: `finn_pris`
    - Update forecast ABC: `upd_prog_abc`

- **File Keys**:
    - Most operations use compound keys for quick setll/read; understand which variables build up which key.

- **Indicators**:
    - Look at the initial comment for meaning (e.g., 10=Rollup, 11=Rolldown, etc.)

---

**In summary**:  
The MB105R program is an interactive, subfile-driven RPG application handling ABC analysis for inventory, allowing for advanced navigation and detail update via tightly controlled key-based file access and CL/RPG program calls. Understanding the subfile model, key handling, and integration points is critical for effective maintenance and enhancement.