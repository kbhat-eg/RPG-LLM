# AX240R Program Documentation

## Overview

**Program:** AX240R  
**Purpose:** Generates and exports XML records for SAF-T (Standard Audit File for Tax) reporting, specifically for "Prosjekt" (project) analysis data.  
**Business Domain:** Norwegian accounting/tax reporting (SAF-T compliance).  
**Function:** Reads project master data from the application database, formats it into an XML structure according to SAF-T requirements, and writes the output to a designated file.

---

## Data Sources and Files

### Input Physical Files

- **rp1pl1 (RPROPF):**  
  Project master file. Each record represents a project.  
  - Key fields: `rp1frm` (Company), `rp1pro` (Project code).
  - Renamed record format: `rp1ppfr` → `rp1pl1r`.

- **rxmll1 (RXMLPFR):**  
  XML template file for SAF-T output.  
  - Used to fetch XML structure templates for each XML line to be generated.
  - Key fields: `axhead`, `axlinj`.
  - Renamed record format: `rxmlpfr` → `rxmll1r`.

### Output File

- **axmlut:**  
  Output file where the generated XML records are written.

---

## Key Variables

- **w_firm / l_firm:** Current company (firma) being processed.
- **rp1pl1_pros:** Project code for keying into the project file.
- **rxmll1_head / rxmll1_linj:** Used for keying into the XML template file.
- **text:** Temporary buffer for text fields to be inserted into XML.
- **w_x_dat:** Temporary buffer for date fields.
- **p_perfm, p_perfa, p_pertm, p_perta:** Period parameters, loaded from data area `ax000par`.
- **p_hcom:** Company header/comment, loaded from data area.
- **axxmlt, axfast, axtype, axmaop:** Fields from the XML template record, used for dynamic XML line construction.

---

## Program Flow

### 1. Initialization (`*inzsr`)

- Loads period and company parameters from data area `ax000par`.
- Initializes key fields for both input files.
- Sets file position to the start of the project master file for the current company.

### 2. Main Processing Loop

- Reads the first project record for the current company.
- For each project:
    - Sequentially generates a set of XML lines, each corresponding to a specific SAF-T "ANALYSIS" element or sub-element, as follows:
        - **100:** Start of ANALYSIS table (template only, not written).
        - **200:** Start of TableEntry (written).
        - **300:** ANALYSIS Type ("P" for Project).
        - **400:** ANALYSIS Type Description ("Prosjekt").
        - **500:** ANALYSIS ID (Project code).
        - **600:** ANALYSIS ID Description (Project name/description).
        - **700:** ANALYSIS Start Date (project start date, with override if a specific date exists).
        - **800:** ANALYSIS Status ("Active").
        - **900:** End of TableEntry (written).
        - **1000:** End of ANALYSIS table (template only, not written).
    - For each line, fetches the corresponding XML template from `rxmll1`, substitutes variable placeholders, and writes the resulting XML record to the output file as appropriate.
    - Loops to the next project for the current company.

### 3. XML Line Editing and Writing (`redut` subroutine)

- Handles the substitution of variable placeholders in the XML template lines:
    - `?V?`: Replaced with the value in `text` or `axfast`, depending on context.
    - `?F?`: Replaced with `axfast`.
- Writes the completed XML line to the output file.
- Resets the `text` buffer.

---

## Business Logic and Domain-Specific Notes

- **SAF-T "ANALYSIS" Table:**  
  The program is specifically tailored to generate the "ANALYSIS" section of the SAF-T file, representing project (prosjekt) data, which is a Norwegian extension to the standard SAF-T specification.
- **Template-Driven XML Generation:**  
  All XML output lines are based on templates stored in the `rxmll1` file. This allows for flexible changes to the XML structure without modifying program logic.
- **Dynamic Value Substitution:**  
  Placeholders in the templates (`?V?`, `?F?`) are dynamically replaced at runtime, supporting both standard and company-specific data.
- **Selective Output:**  
  Only certain template lines are written to the output (see commented-out `write` statements for lines 100 and 1000), following SAF-T structure requirements.

---

## Design Conventions and Patterns

- **Key Lists (`klist`, `kfld`):**  
  Used for efficient keyed access to both the project master and XML template files.
- **Subroutines (`begsr/endsr`):**  
  Used for modularity: initialization (`*inzsr`) and XML editing/writing (`redut`).
- **"Goto" for Looping:**  
  The program uses RPG's `goto` to loop within the main processing section for each project, which is a legacy pattern but common in older RPG codebases.
- **Template File Coupling:**  
  The program assumes a 1-to-1 mapping between the logical structure of the XML output and the records in the template file, keyed by type and line number.

---

## External Dependencies

- **Data Area `ax000par`:**  
  Period and company parameters must be maintained in this data area for correct operation.
- **File Layouts:**  
  The structure of `rp1pl1` and `rxmll1` must be consistent with the program's expectations.
- **Output File:**  
  The output file (`axmlut`) must be defined in the environment and have the expected record format.

---

## Error Handling

- **Minimal Error Handling:**  
  The program assumes all required records exist in the template file and the project master file. There is no explicit error handling for missing templates or I/O errors.

---

## Interaction with Other Modules

- **Upstream:**  
  Expects the project master (`rp1pl1`) and XML template (`rxmll1`) files to be populated by other processes.
- **Downstream:**  
  The output XML file is likely consumed by a SAF-T reporting engine, archiving process, or transmitted to authorities.

---

## Summary

This program is a specialized batch utility for generating the "ANALYSIS" section of SAF-T XML files for Norwegian accounting compliance. It is highly template-driven, supports dynamic data substitution, and is tightly coupled to the structure of both the project master and XML template files. The code follows legacy RPG coding patterns but is modularized for maintainability.

For onboarding, ensure you are familiar with the structure and maintenance of the template and master files, as well as the specific requirements for SAF-T reporting in the Norwegian context. Changes to the XML output should generally be made via the template file, not program code.