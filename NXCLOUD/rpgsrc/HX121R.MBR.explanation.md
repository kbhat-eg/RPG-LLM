# Program HR121R – Radio Terminal Transaction, Inventory Counting Batch Lines

## Purpose and Business Context

This program, `HR121R`, is a core component of our warehouse management system, specifically designed for **inventory counting via radio terminals**. It manages the process of scanning items, validating them, and updating temporary transaction files, which are later transferred into permanent batch lines (tellebunt-linjer). The program supports both manual entry and barcode/EAN scanning, handles unit conversions, and integrates with various master data files (item, unit, supplier, etc.).

The workflow centers around a **subfile-based user interface** for reviewing, editing, and confirming counted items before finalizing the batch.

---

## Key Features and Flow

1. **Initialization**: Sets up keys, parameters, and loads initial data into the subfile for the current session/user.
2. **Subfile Management**: Displays, updates, and manages a list of scanned/entered items.
3. **Scanning Logic**: Handles item lookups by EAN-128, EAN, supplier item number, or direct item number entry.
4. **Item Validation and Editing**: Allows editing of item quantities and units, with business logic for unit conversion and validation.
5. **Batch Creation**: On completion, moves all temporary transaction lines into the permanent batch file, creating header and detail records.
6. **Integration**: Interacts with item master, unit master, supplier master, and external programs for item lookup and calculator functions.

---

## File Relationships

- **hrtrl2/hrtrlr/hrtrlu**: Temporary radio terminal transaction files (header, detail, update).
- **vvarl1/vvarl4**: Item master files (by item number and by supplier item number).
- **vvenl2**: Item unit master (sales units).
- **lstsl1**: Warehouse status codes.
- **lbhelu/lbdtlu**: Permanent inventory batch header and detail files.
- **hr121d**: Display file (subfiles and control records for UI).

---

## RPG Conventions and Patterns

- **Indicator Usage**: Extensive use of RPG indicators for file I/O, subfile control, error messaging, and UI state management. (See header comments for mapping.)
- **Subfile Paging**: Implements paging logic for subfile display (`w_srrn`, `w_spge`, etc.).
- **Multi-key Chains**: Uses composite keys for all file access, defined in the `*inzsr` subroutine.
- **External Program Calls**: Invokes external programs for item lookup (`VV580R`), calculator (`HR200R`), EAN resolution (`VE710R`), and error handling (`JV871R`).
- **SQL Integration**: Uses embedded SQL for supplier item number resolution.

---

## Main Data Structures and Variables

- **w_firm, w_kode, w_tims**: Firm, code, and timestamp—used as session keys.
- **w_scan**: Holds the current scan input (barcode, EAN, etc.).
- **d_e128**: Data structure for parsing EAN-128 barcodes.
- **b1sfl**: Subfile for displaying counted items.
- **b1valg**: Subfile selection field (edit, delete, etc.).
- **c1vare/c1enhe**: Current item and unit in context.
- **c2enh1/2/3**: Up to three sales units for the item.

---

## High-Level Code Structure

1. **File Declarations**: All relevant physical files are declared and renamed for clarity.
2. **Variable and Data Structure Declarations**: Includes overlays for barcode parsing and work variables for subfile management.
3. **Subroutines**:
    - **scanning**: Main logic for processing scan input, resolving to an item, and handling errors.
    - **forny**: Refreshes the subfile from the database.
    - **subfile**: Handles subfile row edits and deletes.
    - **xc2bld**: Manages the edit/view dialog for an item, including unit selection and validation.
    - **xd1bld**: Handles delete confirmation dialog for an item.
    - **clr_subfile**: Clears the subfile.
    - **crt_subfile**: Populates the subfile from the transaction file.
    - **dsp_subfile**: Controls subfile display and paging.
    - **opprett**: Finalizes the batch, moving lines from the radio terminal file to the permanent batch files.
    - **\*inzsr**: Program initialization, key list setup, and initial subfile population.

---

## Domain-Specific/Non-Obvious Logic

### Scanning and Item Resolution

- **EAN-128 Parsing**: If the scan input is 26 characters, it's parsed as EAN-128 using overlays. The EAN and other fields are extracted and resolved via `VE710R`.
- **Multiple Lookup Paths**: If the scan is not EAN-128, the code attempts to resolve the input as EAN, supplier item number (using SQL), or item number, in that order.
- **Fallback/Error Handling**: If resolution fails, an error indicator is set and an external error handler is called.

### Unit Handling

- **Sales Units**: Up to three sales units are fetched for an item and presented for selection. The code supports toggling between units (F1).
- **Unit Changes**: If the unit is changed during edit, the old record is deleted and a new one is created.

### Subfile UI

- **Paging and Positioning**: The subfile supports paging, and the current/visible record is tracked for user convenience.
- **Edit/Delete Actions**: Users can edit or delete lines directly from the subfile; these actions are handled in the `subfile` subroutine.

### Batch Finalization

- **Header Creation**: When finalizing, the program checks if a batch header exists and creates one if not.
- **Line Transfer**: All temporary lines are transferred to permanent batch lines, with item master data joined in for descriptive fields.
- **Cleanup**: The temporary transaction lines are deleted after transfer.

### Integration Points

- **VV580R**: External item inquiry (F4).
- **VE710R**: EAN/EAN-128 to item resolution.
- **HR200R**: Calculator for quantity calculation (F2).
- **AS100R**: Generates new batch numbers.
- **JV871R**: Handles scan errors/unresolved items.

---

## Error Handling and Messaging

- **Indicators 31-79**: Used for various error and message flags, e.g., invalid input, scan errors, etc.
- **UI Feedback**: Errors and messages are surfaced via subfile indicators and conditional logic.

---

## Special Versioning and Customizations

- The header comments provide a detailed change log, including business-driven customizations, such as support for EAN-128, supplier item numbers, new product assortments, and tracking information.

---

## Summary of Main Interactions

- **User scans or enters items** → **Program resolves item** (barcode, EAN, supplier/item number) → **Item is added/edited in subfile** → **User reviews/edits/deletes lines in subfile** → **Upon confirmation, lines are moved to permanent batch files**.

---

## Key Takeaways for New Developers

- **Subfile Handling**: Central to the user experience; learn the paging and selection logic.
- **Item Resolution**: Robust, multi-path logic; understand the order and fallback mechanisms.
- **Integration**: Many external calls—be aware of dependencies and interfaces.
- **Indicator Usage**: Heavily used for both business and UI logic; refer to the header for mapping.
- **Batch Transfer**: Pay attention to how temporary data is moved to permanent storage, including data enrichment from master files.

---

## References

- **File Layouts**: Review the DDS for all referenced files, especially `hrtrl2`, `hrtrlr`, `hrtrlu`, `vvarl1`, `vvenl2`, `lbhelu`, `lbdtlu`.
- **External Programs**: `VV580R`, `VE710R`, `HR200R`, `AS100R`, `JV871R`.
- **Change Log**: For business rationale behind recent changes.

---

If you have further questions on specific subroutines, integration points, or business rules, please refer to the relevant section above or contact the system architect.