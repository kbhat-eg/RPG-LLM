# Program Documentation: BU924R (ASSHOP System)

## Overview

**Program:** BU924R  
**System:** ASSHOP  
**Description:**  
Retrieves customer project information for a given store (butikk).  
The program receives firm, customer, and project identifiers as input parameters and returns a packed information structure containing customer and project details.

## Purpose and Business Logic

This program is used to fetch and assemble detailed information about a customer project, including address, contact information, project metadata, and additional related fields. The data is returned in a single packed structure for consumption by other modules or external systems.

The main business logic flow is:

1. **Parameter Intake**: Receives firm, customer, and project identifiers as input parameters.
2. **Project Lookup**: Searches for the customer project in the `fkprl1` file (customer project master).
3. **Postal Place Lookup**: If a postal number is present, fetches the corresponding place name from `aposl1` (postal code register).
4. **Data Assembly**: Populates a 400-character packed data structure with all relevant fields.
5. **Return**: Returns the packed structure via a parameter.

## File Interactions

- **fkprl1** (renamed from `fkprpfr`):  
  The primary file containing customer project records.  
  Key fields: Firm number, customer number, project number.

- **aposl1** (renamed from `apospfr`):  
  Postal code register. Used to fetch the name of the place corresponding to a postal number.

## Parameters

| Parameter | Type      | Usage                                  |
|-----------|-----------|----------------------------------------|
| p_firm    | Char(3)   | Firm identifier                        |
| p_kund    | Zoned(6,0)| Customer number                        |
| p_kpro    | Zoned(6,0)| Project number                         |
| p_pinf    | Char(400) | Output: Packed customer/project info   |

## Data Structure: Packed Information (`d_pinf`)

A 400-byte structure overlays the output parameter. Each segment is mapped to a specific piece of customer/project data, including:

- **Dates** (ISO format): d_fdat, d_tdat, d_opda, d_odat, d_edat
- **Strings**: Name, address, postal number, place, project description, contact info, email, user
- **Numerics**: Seller, private indicator, driver info, project number, customer/project keys, etc.
- **Other**: Dummy byte at the end set to '*' for integrity/checking.

See the code for exact overlays and field lengths.

## Key RPG Design and Conventions

- **File Renaming**:  
  Files are renamed on the F-spec for clarity and to avoid naming conflicts.

- **Overlay Data Structure**:  
  The output parameter is a flat 400-byte field, overlaid with a DS for easy field assignment. This pattern is common in legacy integration scenarios or when returning complex data via a single parameter.

- **Key Lists (KLIST)**:  
  Used for chaining into indexed files.  
  - `fkprl1_key`: Firm, customer, project
  - `aposl1_key`: Postal number

- **Conditional Lookups**:  
  The program only attempts to fetch the postal place if the postal number is non-zero.

- **Initialization and Parameter Passing**:  
  Standard *ENTRY PLIST* pattern for parameter passing, with explicit variable assignments.

- **Early Exit on Not Found**:  
  If the customer project is not found, the program exits immediately, leaving the output structure unpopulated.

## Field Population Details

- Most fields in the packed structure are directly mapped from the `fkprl1` record.
- The postal place (`d_sted`) is fetched from `aposl1` if the postal number is present.
- The postal number (`d_ponr`) is set to blank initially, but overwritten with the value from the project record at the end (possibly to ensure correct formatting or to handle legacy field content).
- Dates and times are handled in ISO format for consistency.
- The dummy byte (`d_dumm`) is always set to '*' as a marker.

## Error Handling

- If the customer project is not found in `fkprl1`, the program exits without populating the output structure.
- There is no explicit error message or status code returned; the calling program must interpret an empty or unchanged output structure as "not found."

## Integration Points

- **Upstream**:  
  This program is likely called by other application modules needing consolidated customer/project info, possibly for display, reporting, or further processing.

- **Downstream**:  
  Reads from `fkprl1` (customer project master) and `aposl1` (postal code register).  
  Changes in these files' structures may require updates here.

## Notable Non-Obvious Decisions

- **Packed Output Structure**:  
  The use of a single packed 400-byte structure allows for easy parameter passing, especially in environments with limited parameter support or for integration with non-RPG systems.

- **Overlay Usage**:  
  Overlays provide a way to treat a flat buffer as a structured record, but require strict field alignment and maintenance.

- **Legacy Field Types**:  
  Some fields (e.g., project number as alpha vs. numeric) reflect historical changes in the business domain (see comment about "prosjekt er alfa" in version 6.20).

- **Minimal Error Feedback**:  
  The program does not return explicit error codesâ€”this is typical in legacy RPG, but may require callers to check output carefully.

## Maintenance Notes

- Any changes to the structure or length of the packed output parameter (`p_pinf`/`d_pinf`) must be coordinated with all programs that consume its output.
- If new fields are added to `fkprl1` or `aposl1` and are required in the output, update the overlays and assignment logic accordingly.
- The program assumes input parameters are valid and does not perform extensive validation.

## Summary

This program acts as a data retrieval and packing utility for customer project information in the ASSHOP system. It exemplifies legacy RPG design patterns for data integration and efficient parameter passing, and is tightly coupled to the structure of the underlying database files. Care must be taken when modifying the data structure or file layouts due to the use of overlays and packed buffers.