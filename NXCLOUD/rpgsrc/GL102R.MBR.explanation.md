# GL102R – "Utskrift av forslag til utbetaling"  
**System:** ASOKON  
**Purpose:** Print payment proposal reports (including payroll proposals) with validation and messaging for missing or inconsistent supplier/payment information, and support for archiving/PDF/XML output.

---

## Business Context

This program is central in the payment processing workflow. It reads payment proposal files, validates supplier and payment data, prints detailed and summary reports, and generates output for archiving or further processing (XML/PDF). It handles both standard supplier payments and payroll-related payments, with special logic for foreign payments and factoring arrangements.

---

## High-Level Flow

1. **Initialization:**  
   - Receives parameters (company number, proposal number, type indicator).
   - Sets up variables, keys, and retrieves static information (e.g., company name).

2. **Processing:**  
   - Determines type of proposal (standard or payroll) and dispatches to appropriate routine.
   - Reads payment proposal records, grouped and sorted either by supplier number or name.
   - For each group/break (supplier, due date, currency, KID status), prints details and totals.
   - Performs validation and writes messages for missing/invalid data (e.g., missing bank info, address, currency issues).

3. **Finalization:**  
   - Prints final totals.
   - If archiving is enabled, generates XML and PDF, and calls archiving routines.

---

## Key Data Structures and Files

### Files

- **rlevl1**: Supplier master (by supplier number)
- **rlbapf**: Supplier bank info (for foreign payments)
- **rltrl2**: Payment transfer log (for identifying previously transferred payments)
- **gubfl1/gubfl4**: Payment proposal detail (sorted by supplier number or name)
- **gfaspf**: Company static info
- **gl102p**: Printer file for report output

### Data Structures

- **gaforf**: Due date as packed(8,0), with overlays for year, month, day.
- **dslist**: For unpacking parameter list (company number, proposal number).
- **Various work fields**: For tracking current/previous supplier, due date, currency, KID, totals, etc.

---

## Main Processing Logic

### Entry

- **Parameters:**  
  - `wplist`: Packed parameter list (company and proposal number)
  - `wpparm`: Type indicator ('L' for payroll, others for standard)

- **Dispatch:**  
  - If `wpparm <> 'L'` → `xrappo` (standard)
  - Else → `xrappl` (payroll)

### Standard Payment Proposal (`xrappo`)

- Initializes key fields.
- Writes report header.
- Reads proposal records via `gubfl1` (by supplier number) or `gubfl4` (by supplier name), depending on `gefsbf` flag.
- For each record:
  - Checks for group breaks (supplier, due date, currency, KID).
    - On break: writes totals, messages, resets group accumulators.
  - Transfers data from file to print fields.
  - Validates data (e.g., bank info, address, currency).
  - Writes detail lines and handles page overflow.
- Writes final totals and messages.

### Payroll Proposal (`xrappl`)

- Similar to standard, but always sorted by supplier number.
- Simpler break logic (no currency/KID break).
- Writes payroll-specific detail and totals.

---

## Validation and Messaging

### Indicators

- Various *INxx indicators signal specific validation failures or message conditions (see comment block in code).
- Examples:
  - *IN36: Missing giro number for domestic payment.
  - *IN41: Missing SWIFT code for foreign payment.
  - *IN43: Missing supplier name.
  - *IN35: Unknown currency code.

### Subroutines

- **xt1brk / xt2brk:**  
  Set message indicators on group breaks (due date/currency/KID or supplier).
- **xerrt1 / xerrt2:**  
  Write message lines to the report based on set indicators.
- **xnulin:**  
  Resets all message indicators for next group.

### Bank/Foreign Payment Logic

- When country ≠ 'NO' or currency ≠ 'NOK', fetches bank info from `rlbapf`.
- If SWIFT and account are both blank, triggers message.
- If SWIFT is blank, bank address lines must be filled.
- Loosened requirements if SWIFT is present (see comments referencing "30049").

---

## Factoring Support

- If supplier has a factoring company, retrieves and prints factoring company info instead of supplier info.
- Validates presence of factoring name/address.

---

## Output and Integration

### Report Output

- Detail and total lines are written to `gl102p` printer file.
- Overflow handling: If page overflow (*IN30), report header is rewritten.

### Archiving and XML/PDF

- If archiving is enabled (`l_poff = '1'`):
  - Calls `spoolnbr` to retrieve spool file info.
  - Closes printer file before generating XML.
  - Calls `xml_create` (calls program `AP627R`) to generate XML for archiving.
  - Calls `pdf_preview` (calls program `AP621R`) to display PDF in browser if requested.

---

## External Calls and APIs

- **RS716R**: Currency code validation (replaces earlier RS116R).
- **QSPRILSP**: IBM API to retrieve spool file information.
- **AP627R**: Internal program to generate XML for archiving.
- **AP621R**: Internal program to launch PDF preview in browser.
- **AB710R**: Job/session finalization.

---

## Design Notes and Conventions

- **Break Processing:**  
  All group break and subtotal logic is handled in subroutines, using work fields to track current group state.
- **Indicator Usage:**  
  Strict indicator usage for message handling, overflow, and file I/O status.
- **Field Overlays:**  
  Heavy use of overlays in data structures for unpacking packed fields and parameter lists.
- **Sorting:**  
  Proposal records can be processed sorted by supplier number or name, controlled by the `gefsbf` flag.
- **Legacy and Evolution:**  
  Code comments reference historical changes and business rules (e.g., SWIFT/address requirements, currency validation, etc.).
- **Internationalization:**  
  Handles both domestic and foreign payments, with specific validation for each.
- **Factoring:**  
  Special handling for suppliers using factoring companies.

---

## Module Interactions

- **Reads:**  
  - Supplier master (`rlevl1`)
  - Supplier bank info (`rlbapf`)
  - Payment proposal details (`gubfl1`/`gubfl4`)
  - Company info (`gfaspf`)
  - Payment transfer log (`rltrl2`)
- **Writes:**  
  - Report printer file (`gl102p`)
- **External Calls:**  
  - Currency code validation (`RS716R`)
  - Spool file info (`QSPRILSP`)
  - XML generation (`AP627R`)
  - PDF preview (`AP621R`)
  - Job/session close (`AB710R`)

---

## Error Handling and Messaging

- All validation errors are reported in the printed report, with specific lines indicating the nature of the problem (e.g., missing giro number, missing address, unknown currency).
- Multiple errors can be flagged and reported per supplier or payment group.

---

## Versioning and Change History

- The header block documents all significant changes, including business rule adjustments (e.g., SWIFT/address requirements, currency validation logic), architectural changes (e.g., PDF/XML support), and program renovations.

---

## Onboarding Guidance

- **Familiarize yourself with the indicator conventions** (see header block) as these drive much of the error/messaging logic.
- **Understand the break/subtotal logic**: Grouping is key to the report's structure and validation.
- **Review the external program interfaces** for archiving and currency validation.
- **Business rules** (especially for foreign payments and factoring) are embedded in the validation subroutines—study these to understand compliance requirements.
- **Many fields and routines are reused for both standard and payroll proposals**, but some are specific—note the differences in `xrappo` vs `xrappl`.

---

## Summary Table

| Functionality         | Implementation Details                                        |
|----------------------|--------------------------------------------------------------|
| Proposal printing    | Read from GUBFL1/GUBFL4, print to GL102P                     |
| Validation           | Subroutines xt1brk/xt2brk/xerrt1/xerrt2 + indicators         |
| Factoring support    | Additional lookup in RLEVL1 for factoring company            |
| Foreign payments     | RLBAPF lookup, SWIFT/bank address checks                     |
| Payroll proposals    | Special routine xrappl                                       |
| Archiving/PDF/XML    | Spool info via QSPRILSP, XML via AP627R, PDF via AP621R      |
| Currency validation  | External call to RS716R                                      |

---

## Common Pitfalls

- **Indicator confusion:** If you misinterpret or incorrectly set/reset indicators, messaging and break logic will fail.
- **Break logic errors:** Not updating the work fields on each read will result in incorrect group breaks or missed totals/messages.
- **External interface changes:** Changes to programs like `RS716R`, `AP627R`, or `AP621R` may require updates here.
- **Factoring logic:** Ensure factoring company lookups are handled for any supplier with a factoring arrangement.

---

## Conclusion

This program is a robust, business-critical component for payment proposal reporting, with extensive validation, messaging, and integration for modern output formats. Understanding its structure and conventions is key to maintaining or extending payment processing in ASOKON.