# Comprehensive Documentation of FO920R (Ordrebekreftelse)

Below is an overview of the program’s objectives, structure, and the business logic behind the code for generating order confirmations (“ordrebekreftelse”). This functionality deals with retrieving order data, preparing output for printing or emailing, optionally generating XML via Jasper, applying domain-specific rules such as deposit/prepayment (forskuddsbetaling) and business logic for discounts (rabatter), VAT (mva), and archiving.

---

## Purpose

• This program (FO920R) produces a formal order confirmation document for orders.  
• It can output to a standard printer, an email channel, or generate an XML file for further processing and/or archiving.  
• It supports multiple advanced domain rules:  
  - Handling of VAT (mva) rates.  
  - Inclusion of top (heading) and bottom (footer) text lines.  
  - Embedding deposit/prepayment information (kid, konto, beløp).  
  - Logging each generated confirmation within a shipping or dispatch “kjørekontor” setup.  
  - Combining data from multiple database files, including user preferences in LDA (Local Data Area).  

---

## High-Level Flow

1. **Reading Input (Cycle Handling):**  
   The code checks the record type in the input file (FPSOL1) by looking at FKSKOD. If it’s “H” (heading), it processes order header logic. If it’s “V” (item line), it processes item detail logic. If it’s “K” (comment line), it processes text lines. Each type triggers different subroutines.

2. **Order Header Processing:**  
   - Retrieves order header fields from FOHEL1 (via KEY01).  
   - Determines date fields (order date, delivery date), references, billing addresses, and shipping addresses.  
   - Retrieves additional data from:
     - Customer file (RKUNL1) for name, address, and (when indicated) any linked “tilbudskunde” (an alternate customer number for the order).  
     - Customer project (FKPRL1) if a project code is defined.  
     - Payment terms (via subroutine SBBETB) often using FØ703R or RS203R.  
     - MVA rate logic (disabled or replaced in some parts, but historically done by calling RS205R).  
   - Merges or overrides certain phone/fax/mobile from the order header if present.  

3. **Item Detail Processing:**  
   - Uses the order line file FODTL1R (via KEY02).  
   - Looks up the line type in VLTYL1; if certain line types are flagged not to print, the code exits.  
   - Retrieves related item data from VVARL1.  
   - Applies domain-specific discount logic:
     - Single or combined discount percentages (FDRAB1 and FDRAB2).  
     - Optionally merges these discounts into net prices if the order is flagged for nettopriser.  
     - Calculates line-level amounts and accumulates overall net and VAT.  
   - Allows for separate handling of text lines vs. normal item lines (e.g., “VALKTX = 1” signals a text-only line).  
   - Maintains measures like quantity decimals (0–3 decimals) and writes them out accordingly.

4. **Text/Comment Line Processing (K):**  
   - Reads from the text file FOTXL1R.  
   - Writes out free-form text either on the same page or at the bottom if it’s a final text block.  

5. **Totals and Order Finish Logic:**  
   - Summarizes net amounts, applies any “ordrerabatt” (order-level discount), and calculates total with or without MVA.  
   - Uses array-based accumulation for multiple VAT rates (d_xarray subroutine), then prints or generates blocks for each VAT percentage.  
   - If a “kjørekontor-løsning” is active, calls FU900R to log that the order confirmation has been processed.

6. **Handling of Prepayment/Deposit (Forskuddsbetaling):**  
   - If deposit info is discovered in SDEPL1 (based on the order and customer number), the code calculates or retrieves a “kid” (customer identification) using AK720R, then logs it to AK700R and updates the deposit record.  
   - Conditionally prints or injects the deposit data into the final document or the XML tags.

7. **Archiving and Logging:**  
   - Resource calls to AB700R, AB705R, AB710R are used for archiving and logging processes. The code writes to XML for archiving if L_ARCH = 1.  
   - Adds “metatags” such as Ordrenummer, Kunde, Dato, and Beløp for searching in an archive solution.  

8. **Output Variants:**  
   - **Standard Print**: Writes to spool file using traditional printer file lines (A1HDR, A2HDR, D1DET, E1DET, T1TOT, etc.).  
   - **Email**: Uses E_MAIL_ASP outq. Calls FO798R (or FM798R if a special mail logic is indicated), retrieving or building addresses, CC, BCC, subject lines, etc.  
   - **XML + Jasper**: If L_POFF=1, triggers generation of an XML structure with tags for each line type, heading, top/bottom text, discounts, totals, etc. This is then used by JasperReports to produce a PDF, to handle spool logic, or to preview in a browser.

9. **Subroutines Organization:**  
   - The code is structured around subroutines (BEGSR/ENDSR) like XSTRSR (initialization), XOVRFL (overflow handling for spool), XARRAY (VAT accumulation), and the main entry point (INZSR) for parameter and environment initialization.  
   - Additional subroutines (e.g., SBBETB for payment terms, HNT_AVDE for retrieving department info, DANN_KID for building the KID reference, LIST_FORSKU for deposit prints, XML_* for building XML blocks) separate domain logic from spool instructions.

---

## Non-Obvious Design Choices and Conventions

1. **Mixed Print and XML Output**:  
   The program conditionally writes to a traditional printer file (O-specs with headings like A1HDR) or constructs an XML structure for Jasper. Managing both approaches is done through flags (like L_POFF) and subroutines that wrap identical business rules but produce different outputs.

2. **Array-Based VAT Logic**:  
   Multiple VAT rates (mko, msa, mgr, mbe, etc.) are tracked in arrays. The code accumulates net amounts for each distinct VAT code and calculates totals. This allows dynamic handling of multiple rates on the same order.

3. **Runtime-Driven Flow**:  
   Program flow heavily depends on external indicators in the order header (e.g., “foneto = 1” means net-only prices, “faakjk = 1” triggers kjørekontor logic). Many queries to smaller sub-programs (FØ* or RS* modules) refine logic for things like phone retrieval, deposit references, or scanning for invalid characters.

4. **Character Conversion (AP613R)**:  
   The program repeatedly calls AP613R to sanitize or “scan” strings for special characters or encodings that might not be valid in XML or might be restricted by the spool system. This scanning occurs for data like addresses, references, subject lines, and text blocks.

5. **Archiving Hooks (AB70xR)**:  
   Additional calls to AB700R, AB705R, and AB710R manage logging and historical references, which can be used for reprints or external archival systems.

6. **KID Generation for Forskuddsbetaling**:  
   The deposit logic is an example of specialized Norwegian payment references. The code calculates a check digit (via “AK720R”), merges it into a “kid” variable, and logs it in AK700R or updates SDEPL1 (the deposit file).

---

## Interaction with Other Modules and Data Sources

• **FPSOL1** / **FODTL1** / **FOTXL1**: Order solution files for header, detail lines, and text lines.  
• **FKPRL1**: Customer project references (eksternt kundeprosjekt).  
• **RKUNL1**: Customer master data used to display shipping/billing info.  
• **FSTSL1**: Additional status data or “tilbuds-kunde” references.  
• **VVARL1**, **VOTYL1**, **VLTYL1**: Various domain lookups for item data, order types, and line types.  
• **FU900R**, **AB70xR**: Logging calls.  
• **AP61xR**: Specialized spool or XML routines (AP613R to scan strings, AP611R for drawer info, AP621R for PDF browser launch, etc.).  
• **FO798R / FM798R**, **AM705C**: Email assembly logic.  
• **AK7xxR**: Payment references / KID generation.  
• **SDEPL1**: Deposit references.  
• **LDA** fields: The code picks up environment settings, e.g., L_POFF for controlling PDF output or L_MAIL for email.  

---

## Conclusion

FO920R consolidates order information from multiple files, applies domain-specific rules (discounts, deposit handling, date/format scanning, MVA calculations), and outputs a fully composed order confirmation either to a spool printer, email system, or a dynamically generated XML feed (for JasperReports or archiving). Multiple “sub-program” calls embed extended functionality, such as special mail logic (FO798R), deposit references, scanning for invalid characters, or archiving with specialized metadata.  

This setup is typical in complex ERP environments, where legacy spool output coexists with more modern PDF/HTML solutions, ensuring business continuity while accommodating new output channels or client platforms.