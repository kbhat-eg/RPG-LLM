## Program Overview

This RPG program, FX952R, is a utility within the ASOFAK system designed to automatically delete items ("varer") that meet specific criteria. The intent is to clean up the item master file by removing obsolete products. The main conditions for deletion are:

- The item's expiry date has passed.
- The item has no outstanding "orders" other than quotes (with similar logic as the 'delete item' process).
- The item has no inventory on hand.

This is not a standalone item deletion—it is a batch process run, potentially periodically, to archive or purge obsolete items for a particular company (firm).

---

## File Usage and Relationships

The program interacts with these files (physical or logical):

- **VVARPFR (renamed to VVARL1R):** Item master file.
- **LODTPFR (renamed to LODTLVR):** Order detail lines.
- **LOHEPFR (renamed to LOHEL1R):** Order header file.
- **VLAGPFR (renamed to VLAGL1R):** Inventory locations or stock balances.

Key fields relating to the company (w_firm) and item/id are used to join these files.

---

## High-Level Flow

1. **Program Initialization:** 
   - The *INZSR subroutine sets up keyed access lists for all accessed files using the company number (`w_firm`), which is obtained from LDA (`l_firm`), and various identifiers (item numbers, etc).

2. **Main Loop:**
   - The program scans through each item in `VVARL1R` for the current firm by setting a key list.
   - For each item:
     - Checks if an expiry (out-of-date: `vvudat`) is set and if it is before today.
     - Calls program `VV490R` (most likely a business check routine), passing relevant context and flags for order/inventory status.
     - Executes the `sjekk_lager` subroutine to determine if there is any active stock or linked orders present.
     - If the item **has no open orders** (`b_ordr = *off`) **and** **has no stock/inventory** (`b_lagr = *off`), it calls `VV400R` (presumably the actual delete routine for the item).

3. **Subroutine: `sjekk_lager`**
   - Scans the inventory file (`VLAGL1R`) for the item. If any quantity is non-zero (`vlbehl <> 0`), sets the `b_lagr` flag.
   - Then, checks the order detail file (`LODTLVR`) for any associated sales lines. For each one, it also chains to the order header (`LOHEL1R`) to verify status. The flags ensure that only quotes (with processing code 0) are not considered as blocking the delete (note: actual logic on this seems partial in the sample). If an active order is found, sets `b_lagr` to *on.

---

## Important Domain-Specific and Design Notes

- **LDA Use:** The company (`l_firm`) is set from a standard LDA data area. This allows the program to be run in batch/multi-company contexts without code modification.
- **Key List Use:** Keys for file access are systematically defined in the *INZSR and re-used throughout the codebase. This reduces duplicated key-building logic and supports maintainability.
- **External Program Calls:**
  - `VV490R` is called as a status check—a convention in this codebase to encapsulate business logic in external programs (e.g., to determine if an item is "safe" to delete).
  - `VV400R` is called to perform the actual deletion. Both programs take the same context/parameters, allowing for modular business logic.
- **Order and Stock Checks:** Care is taken to avoid deleting items involved in any active order (including quotes, depending on logic) or any with stock on hand, which aligns with standard ERP data integrity rules.
- **Batch Processing Loop:** The program processes all items for a company, not just a single item. It uses sequential READE processing.

---

## Conventions and Codebase Patterns

- **Flags (b_inlr, b_ordr, b_lagr):** Used to track status throughout the program and across calls, as a mechanism to avoid state in global variables.
- **Explicit Subroutine Use:** The main code and checks are kept separate via subroutines, especially for checks that may be needed elsewhere or in other routines.
- **Error Indicators/EOF Handling:** Uses fixed indicators (e.g., *IN90) for READE and EOF handling, a legacy approach but consistent with traditional RPG III/400 practices.

---

## Inter-Module Relationships

- Relies on two other modules/programs, `VV490R` and `VV400R`, for detailed business logic around item status and deletion.
- Supports multi-company environments via the LDA, and could be rerun by changing the LDA only.

---

## Summary for New Developers

This program is an item-purge tool for the ASOFAK system, ensuring that obsolete items (those past expiry, not on order, and not in inventory) are safely removed, relying on external routines to encapsulate key business rule logic. The program expects company context via LDA, uses keying conventions for file access, and adheres to strict checks before any deletion occurs to preserve data integrity. 

When onboarding, note the reliance on external modules for business logic, and be familiar with the firm's conventions for keyed file access, LDA use, and indicator-based loops/flags. Understanding these patterns is crucial for both maintenance and enhancement tasks.