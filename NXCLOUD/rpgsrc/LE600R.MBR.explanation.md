# Documentation for RPG Program LE600R

## Overview

**Program:** LE600R  
**System:** ASLAGR  
**Purpose:**  
This program manages the parameter entry and preparation for printing a counting list ("telle-liste") in the warehouse management context. The program handles user input for batch numbers, selection and validation of various filtering and sorting parameters, and then delegates the actual list generation to another program. It is designed for interactive use and integrates with multiple data sources, external programs, and display files.

---

## High-Level Flow

1. **Batch Number Entry:**  
   Prompts for or retrieves the batch number (possibly from a data area), validates it, and retrieves batch-related data.

2. **Parameter Input:**  
   Guides the user through a two-step parameter entry process:
   - **Sorting and list type selection**
   - **Filter criteria for the items to be included in the list**

3. **Validation:**  
   Extensive validation of input parameters, including logical checks on ranges (e.g., "from" cannot be greater than "to").

4. **Parameter Passing:**  
   Prepares a packed parameter structure and calls the next program (`LE601C`) for further processing.

5. **Inquiry Support:**  
   Provides subroutines for field-level lookups (inquiries) to assist the user during input.

---

## Key Data Structures

### 1. File and Display Definitions

- **le600d**: Display file for user interaction (workstn).
- **lbchl1**: Batch register file (disk, keyed, renamed record format).
- **lbc1l1**: Side table (disk, keyed, renamed record format).

### 2. File-Member Data Structure

```rpg
d                 ds
d d_memb                        10
d  d_mbok                        1    overlay(d_memb)
d  d_mfir                        3  0 overlay(d_memb:2)
d  d_mnum                        6  0 overlay(d_memb:5)
```

- Used to build a file/member identifier for downstream processing.
- Overlays allow for easy access to subfields within the packed string.

### 3. Parameter List Data Structure

```rpg
d                 ds
d d_prec                       128
d  d_batc                       10    overlay(d_prec)
d  d_fvar                       15    overlay(d_prec:11)
d  d_tvar                       15    overlay(d_prec:26)
d  ... (other overlays)
```

- Holds all parameters required for the list generation, including batch, item ranges, group ranges, warehouse, sorting, and type flags.
- Overlays are used for efficient packing/unpacking and parameter passing to called programs.

### 4. Local Data Area (LDA)

```rpg
d lda            uds
d l_prtf                800    809
d l_chgv                844    844
d l_firm                944    946  0
d l_fnav                951    980
d l_batc               1006   1015
```

- Used for inter-program communication and default value retrieval (e.g., default batch number, company number).

---

## Main Logic Details

### 1. Batch Number Handling

- If a batch number is found in LDA (`l_batc`), it is used directly.
- Otherwise, the program calls `LC500R` to prompt the user for a batch number.
- If the user cancels, the program exits.
- The batch number is then used to retrieve batch information from `lbchl1` and related info from `lbc1l1`.

### 2. Sorting and List Selection Screen

- The user is prompted to select sorting options and list type (main or sublist).
- Default values are set based on batch info (`lcstel`, `lcnumm`).
- Function keys:
  - **F3 (INKC):** Exit program.
  - **F12 (INKD):** Trigger inquiry subroutine (`sp_input`).
- Validates that a main list exists before allowing sublist selection.
- Validates that cyclic counting is only allowed with correct parameters.

### 3. Filter Parameter Input Screen

- The user enters various range and selection criteria (items, groups, warehouse, etc.).
- Default and maximum values are automatically filled if left blank.
- Logical checks ensure all "from" values are not greater than "to" values.
- Special validations for cyclic counting and sublist constraints.
- On successful input, parameters are packed into `d_prec` and `d_memb`.

### 4. Downstream Processing

- Calls `LØ900R` to get the latest sequence number for the file/member.
- Sets up the file/member structure for output.
- Calls `LE601C` with the packed parameter structure and file/member info for actual list creation/printing.

### 5. Inquiry Subroutine (`sp_input`)

- Handles field-level lookups based on the current screen and field.
- Calls various programs to retrieve descriptions or valid values for:
  - Item types (`VA570R`)
  - Items (`VV500R`)
  - Groups (`VG510R`, `VG511R`, `VG512R`)
  - Warehouses (`RA510R`)
  - Product managers (`RA526R`)
  - Suppliers (`RL500R`)
- Results are returned for display or further input pre-filling.

### 6. Initialization Subroutine (`*inzsr`)

- Loads the LDA for output.
- Prepares key lists for file access.
- Loads company number into working variables and parameter structures.

---

## Notable Design and Business Logic

- **Parameter Packing:**  
  All parameters are packed into a single structure (`d_prec`) for easy passing between programs, a common pattern in this codebase.

- **Overlay Usage:**  
  Heavy use of overlays for both data structures and parameter lists, optimizing memory usage and aligning with legacy conventions.

- **Extensive Input Validation:**  
  The program enforces business rules at data entry, especially around range logic and dependencies between parameters (e.g., cyclic counting logic).

- **Inquiry Integration:**  
  The design supports field-level inquiries, improving user experience and data integrity by integrating with various master data lookup programs.

- **Batch and Company Context:**  
  Most operations are batch- and company-dependent; these values are propagated throughout the process and used as keys in file access and external calls.

- **Exit and Error Handling:**  
  Uses indicators and goto-based flow to loop back on invalid input, with user feedback via display file indicators.

---

## Key External Dependencies

- **Display Files:**  
  - `le600d`: Main user interface for parameter entry.

- **Database Files:**  
  - `lbchl1`: Batch register (batch metadata).
  - `lbc1l1`: Side table (possibly batch or list configuration).

- **External Programs:**  
  - `LC500R`: Batch number entry.
  - `LE601C`: List generation/printing.
  - `LØ900R`: Retrieves latest sequence number for file/member.
  - Various inquiry programs (`VA570R`, `VV500R`, `VG510R`, `VG511R`, `VG512R`, `RA510R`, `RA526R`, `RL500R`).

---

## Version and Change Notes

- The program has evolved to support new GUI standards, additional sorting options, and improved parameter handling.
- Recent changes (8.04) relate to correct warehouse value handling in parameter screens (`NXS-20626`).

---

## Conventions and Patterns

- **Indicator-based control flow** is prevalent, both for display file feedback and for function key handling.
- **Goto and Tag** usage for screen re-entry and validation loops—typical for interactive RPG programs.
- **Parameter overlays and packed structures** are a standard pattern in this application suite for efficient inter-program communication.
- **Field overlays** in data structures allow for multi-purpose use of storage and alignment with file layouts.

---

## Integration Points

- **Downstream Process:**  
  After parameter entry and validation, this program hands off to `LE601C` for the actual list processing, passing all relevant parameters and context.

- **Master Data:**  
  All lookups and validations are performed against master data files via dedicated programs, ensuring centralized data management.

---

## Summary

LE600R is a central parameter entry and validation program for warehouse counting list printing. It integrates tightly with master data, enforces business logic at the point of entry, and prepares all parameters for downstream processing in a robust, user-friendly manner. The design balances legacy RPG idioms with business requirements for accuracy, traceability, and maintainability.