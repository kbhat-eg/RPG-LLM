# Program Overview

This RPG program (RK504R) manages "Kontaktpersoner, spørring"—i.e., Contact Persons Inquiry. It is a copy of a previous program (503), extended with additional parameters and adjusted for a new GUI and rules. The system stores and queries contact person records associated with customers and companies.

## High-Level Structure

- **File Definitions** (`F-specs`):      
  - `rukpl8`: Physical file, likely the contact register, read with a key.
  - `rk504d`: Display file, with a workstation subfile (`b1sfl`). The `infds` keyword provides feedback data structure after screen interactions.

- **Parameters**:      
  - The program receives several parameters (e.g., company, customer, name, email, contact number, mobile phone).

- **Data Structures & Variables**:      
  - Used for managing key fields, screen state, subfile navigation, and display control.

- **Indicators**:      
  - Used for both program control (e.g., LR to end program) and UI response (e.g., roll keys, errors, subfile actions). Indicator usage is thoroughly documented in the comments.

- **Subroutines**:      
  - Central logic and functions revolve around managing the subfile, handling navigation (paging, rolling up/down), refreshing data, and responding to screen function keys.

---

# Detailed Section Breakdown

## 1. **File Declarations**

```rpg
frukpl8    if   e           k disk    rename(rukppfr:rukpl8r)
frk504d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **rukpl8**: Input file, keyed, renamed record format.
- **rk504d**: Display file, subfile control using `b1sfl`, uses feedback data structure.

---

## 2. **Parameter Definitions**

Parameters are declared for passing to/from the program—company, customer, name, email, contact number, and mobile.

---

## 3. **Variable Definitions**

- Variables manage subfile navigation and logical control (e.g., first/last record, current page, record counters, flags).
- Some variables are used to handle subfile keys and UI interaction.

---

## 4. **Mainline and Screen Loop**

### **Main Tags**
- **b2taga / b2tagb**: Tags for the program's main loop.
  - **b2taga**: Writes the command display.
  - **b2tagb**: Handles the subfile display and user interaction.
  
### **Function Key Handling**
- Uses a `SELECT` statement to branch based on which function key was pressed (e.g., roll up, roll down, refresh, page up/down, home key).
- Calls subroutines as appropriate for each action.
- Logic for field positioning and cursor placement.

### **Subfile Processing**
- Loops through subfile entries for selection/interaction.
- If a user selects an entry, the contact person's details are copied into output parameters.

### **Program End**
- When complete, sets LR indicator and returns.

---

## 5. **Subroutines**

### **forny**
- Refreshes/renews the subfile from the database.

### **posisjoner**
- Positions the subfile based on input from the user.

### **subfile**
- Processes records in the subfile, looking for selected records.
- Copies record data to parameters for output when a selection is made.

### **clr_subfile**
- Clears the subfile (removes its current contents and resets counters/flags).

### **crt_subfile**
- Fills the subfile with records from the file, for one page.
- Handles field movement and record writing to the subfile display.

### **bck_subfile**
- Scrolls back one page in the subfile.
- Reads previous records and repositions accordingly.

### **dsp_subfile**
- Displays the subfile (with or without contents, depending on state).
- Updates the current record indicator.

### ** *inzsr **
- Initialization subroutine.
- Sets up parameters, positions to the correct place in the database, and initially fills the subfile.

---

# Key Concepts and Data Flow

## **1. Subfile Paging**

- Subfiles are a standard IBM i technique for listing records with paging (like a "grid view").
- `w_fcrn`, `w_srrn`, `w_ssrn`, etc., manage current, relative, and last record numbers for the subfile page.
- **Paging up/down** is handled by reading forward/back in the file and redrawing the subfile.

## **2. User Interaction**

- The program responds to function keys (roll up/down, Enter, Home, etc.) to navigate or select.
- Indicator variables (`*INnn`) are used to track function key status and UI state.

## **3. Data Passing**

- When an entry is selected, the program populates output parameters (`p_navn`, `p_emal`, etc.) which the caller can use.

## **4. Initialization and Positioning**

- On startup, program receives keys (company, customer) for quick positioning.
- Subfile is filled from this position for efficient navigation.

---

# Comments on Style and Maintenance

- **Extensive commenting** (in Norwegian) explains indicator usage, field meanings, and change history.
- Various **sections are clearly delineated** for initialization, mainline logic, and all subroutines—makes maintenance easier.
- Logic is organized as single-pass with a main loop, relying on subroutines for clarity and code reuse.
- **Indicator-based UI control** is typical for pre-RPG IV applications.

---

# Summary

**This RPG program implements an interactive inquiry (lookup) on contact persons, using keyed database access and a paged subfile display to enable efficient browsing and selection.** The program is event-driven by function keys, supports navigation, selection, and dynamic data refresh. Output is communicated via parameter-passing back to the caller. The code is carefully commented (much in Norwegian), making it maintainable and relatively easy to follow, especially for developers familiar with IBM i subfile processing.