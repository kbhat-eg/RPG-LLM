# RPG Program: General Ledger Report and Export (RH631R)

This RPG/400 program (RH631R) is a classic IBM i (AS/400) ILE RPG application that reads General Ledger transactions and produces a report. Over its history, the program has been enhanced to output in several formats: printed report, PDF, and Excel (via XML/Jasper integration). Below, you'll find a detailed, onboarding-friendly explanation of its key concepts, structure, and major logic.

---

## 1. **Program Header and Options**
- **h spec** sets options:
    - `*nodebugio`: disables debug I/O.
    - `datedit(*dmy-)`, `decedit('0.')`: date/numeric editing.
    - *Bind directory* indicates use of CGIDEV2 for web integration.
    - `DftActgrp(*No)`: disables default activation group (ILE).
- `/copy` statements import header, prototypes, and CGI routines.

---

## 2. **File Declarations**
- **Input Files:**
    - `rhw1pf` - Main work file with GL transactions.
    - `aforl1`, `afirl1`, `rhtrlu`, `raa1lu` - Supporting tables for codes, routines, history, etc.
- **Output Files:**
    - `rh631p` - Printer file for the report.
    - For PDF output: special handling for open/close.
- **INFDS Data Structure** for printer (line/page number extraction).

---

## 3. **Data Structures & Working Fields**
- **Parameter Area (LDA):** Fields starting with `rhp...` and `l_...` hold runtime parameters (period, firm, output options, etc.).
- **Work fields** for calculations, text/labels, and interim values.
- **XML- and PDF-related** fields for integration with external systems (Jasper, Excel, IFS paths, mail, etc.).
- **Subroutine variables** for controlling breaks (account/department/cost-bearer), output logic, etc.

---

## 4. **Program Documentation Block**
- Outlines system, program name, description, revision history, usage of indicators, and documentation conventions.

---

## 5. **Indicator Usage**
- Describes how RPG indicators are used:
    - Special keys (function, exit, LR - last record, protects, warnings, etc.)
    - File and subroutine indicators.

---

## 6. **Main Program Logic**

### 6.1. **Initialization (`*inzsr`)**
- Decides output mode (Excel/XML or PDF/spool):
    - If Excel/XML: initializes XML buffer, retrieves template.
    - If not Excel: opens printer file for report output.
- Sets up working values based on runtime parameters.

### 6.2. **Main Loop**
- Reads GL transactions (`rhw1pf`).
    - On read, fetches department/cost-bearer texts from supporting code tables by calling external programs (`RS707R`, `RS728R`).
    - On first record, writes heading (if not Excel/XML export).
- **Break logic**:
    - Checks for breaks (account, department, cost-bearer) and calls respective subroutines: `brkto`, `bravd`, `brsps`.
- **Calculation logic:**
    - Summarizes entries for balances: opening, movement, closing balances at several levels (account, department, company).
- **Writing output:**
    - If Excel/XML: gathers data for XML output.
    - If printed: writes line to printer file. Handles page overflow.
- **Update logic:**
    - For specified ledgers, updates auxiliary files to mark processed or posted records.

### 6.3. **End-of-File/Post-Loop**
- Processes and outputs totals and summaries for the last account, department, cost-bearer, and company.
- Handles archive/export logic for XML/PDF/Excel output.

---

## 7. **Subroutine Descriptions**

### 7.1. **Break Subroutines**
- **`brkto` (Account break):** Calculates and writes account totals/headers.
- **`bravd` (Department break):** Totals at department level, outputs summary.
- **`brsps` (Cost bearer break):** Similar, for cost-bearer.

### 7.2. **Supporting Subroutines**
- **`skriv`:** Handles heading and overflow formatting.
- **`spoolnbr`:** Locates the spool file produced by this job.
- **`xml_create`:** Calls external program to generate XML for print/PDF/Excel.
- **`pdf_preview`:** Launches PDF in browser, if requested.
- **`xml_envm`, `xml_head`, `xml_head_val`, `xml_detal`, `xml_line_val`, `xml_end`:** Write various XML/Jasper sections for Excel export using CGIDEV2/HTMLVAR routines.

---

## 8. **XML and Jasper Integration**
- If Excel output or PDF generation via Jasper is requested, the program builds XML documents representing the report ("document," "header," "detail line," etc.).
- Uses CGIDEV2-style routines (`UpdHTMLVar`, `WrtSection`) to build output, and external programs to create PDF, send mail, or trigger downstream Java processing.
- Mailing info is optionally fetched and included for exports.
- Archive/metadata tags are conditionally written.

---

## 9. **External Calls**
- The program makes extensive use of external programs (called by name, e.g., `'RS707R'`, `'AP627R'`, `'AP621R'`) for:
    - Fetching code/label texts.
    - XML/PDF generation.
    - Logging/reporting job status.
    - Extracting or updating reference data.
    - String scanning and validation.

---

## 10. **Indicators and Conditional Logic**
- Many `if` statements (driven by output mode, break logic, record content, and user options) select what to do:
    - When to sum, write, chain, or call routines.
    - When to output to printer vs. XML.
    - When to call mail or browser routines.

---

## 11. **Key Lists and File Access**
- RPG Key Lists (`klist`/`kfld`) define composite keys for chaining into supporting files (lookups for history, company, routines, etc.).
- Extensive use of `chain` (random access) and `read` (sequential) accesses to workfiles and code tables.

---

## 12. **Error/Overflow Handling**
- Checks for spool file or buffer overflows.
- Writes headings or summary lines on overflow or at each report section break.

---

## 13. **Feature Flags and Enhancements**
- Many features are controlled by fields like `l_poff`, `b_excl`, `l_exlp`, `l_mail`, and indicator variables.
- The `b_excl` flag switches between classic print output and Excel/XML mode.
- Comments and revision tags (`6.30`, `pdf`, etc.) document new features and bug fixes over time.

---

## 14. **Reporting/Output Logic**
- **Classic RPG print logic:** write formatted lines and headings, handle overflow/page breaks.
- **Modern export logic:** build XML/HTML for downstream conversion to Excel, PDF, email, or archive.

---

# **Summary Table**

| Area               | Purpose                                                     |
|--------------------|-------------------------------------------------------------|
| File Declarations  | Defines GL, codes, history, company, and output destinations|
| Data Structures    | Holds all runtime parameters, calculation fields, etc.      |
| Main Loop          | Reads, calculates, and outputs transactions                 |
| Break Subroutines  | Handle account, department, and cost-bearer level summaries |
| Export Integration | Builds and outputs XML (and triggers mail/PDF/Excel)        |
| External Programs  | Used for lookups, string handling, archiving, job control   |

---

# **ONBOARDING TIPS**

- **Follow the logic:** The main loop reads transactions, checks for "breaks" (changes in account, department, etc.), and outputs lines accordingly.
- **Subroutines:** Nearly all break and output-specific logic is modularized in named subroutines.
- **External calls:** Many business rules (e.g., fetching names/codes, XML output) are implemented in external programs.
- **Output Formats:** The mode (`b_excl` and related flags) fundamentally determines whether output is classic printed, XML for Excel, or PDF (with or without mailing).
- **Indicators:** RPG indicators control conditional logic, so understanding the indicator usage section is critical.
- **Enhancements:** Comments and version tags explain features added across releases.

---

This program is a classic example of a financial reporting RPG application, modernized to support document generation and integration with external (Jasper/Excel/PDF) platforms via CGIDEV2 and IFS. The code is heavily modularized, uses external services for much of its data enrichment/export, and manages complex format and output requirements using flags and indicators.