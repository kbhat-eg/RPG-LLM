# Explanation of the RPG Source Code for BO313R

## Overview

This RPG program (`BO313R`) is a cash register reconciliation (kasseoppgjør) screen/report "head" program with subfile handling for displaying, paging, positioning, and updating records. It's tailored for an IBM i environment (IBM i/AS400) using classic ILE RPG (RPG IV, fixed-format) and interacts heavily with display files (subfiles), physical files, and local data areas (LDA).

Code comments and variable names are mainly in Norwegian.

---

## Main Program Structure

### 1. **Program Options and Metadata**

```rpg
h option(*nodebugio) datedit(*dmy)
* ... extensive comments...
```
- `*nodebugio`: No debug I/O.
- `*dmy`: Date edit mask is day-month-year.
- Header comments describe version history, function key usage, and used display formats.

---

### 2. **File Definitions**

```rpg
fbotri1    if   e           k disk    rename(botrst:botri1r)
fbotri2    if   e           k disk    rename(botrst:botri2r)
fbotri3    ... etc.
fbo313d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- Several physical files (with rename) for cash transaction headers, differences, dates, etc.
- `fbo313d` is the display file with subfile support (`sfile(b1sfl:w_srrn)`).

---

### 3. **Data Structures and Fields**

#### **Local Data Area (LDA)**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
These fields are mapped into the LDA for user, firm, navigation, etc.

#### **Display Feedback Structure**
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
Used for reading display feedback info (such as cursor position).

---

#### **Working Variables**

Most working variables are named with `w_` (work), `b_` (Boolean switches), `s_` (subfile counters), and so on.

- Examples: `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_seqe`, `b_oppr`, `b_forn`, `w_firm`, `s_tell`.
- Indicators (`*inXX`): Used for field protection, subfile status, cursor, errors, etc.

---

#### **Constants**

```rpg
d c_sfil          s              2  0 inz(14)
```
Subfile page size.

---

### 4. **Subfile and Display Handling**

#### **Key Concepts**
- **Subfile**: Used for showing lists of records with paging, rollup, rolldown, and positioning.
- **Subfile Control**: Managed by a series of indicators and subroutines to clear, populate, and render the subfile.
- **Function Key Handling**: Main program loop waits for and dispatches based on function key input.

---

### 5. **Main Loop and Command Handling**

The main program uses a tag-based infinite loop (`brtaga`, `brtagb`) for processing screen actions. Program flow includes:

- `exsr dsp_subfile`: Show the current subfile page.
- `select ... when *inka`: F1 (filter), F3/F12 (exit), F5 (refresh), RollUp, RollDown, Home Key, etc.
- Conditional positioning if certain positioning fields (`b2tell`, `b2diff`) are set.
- Calls subroutines for subfile display and paging.

---

### 6. **Subroutines**

#### **forny**: Refreshes the subfile.
- Repositions according to the last active key/type.
- Calls `clr_subfile` and `crt_subfile` to clear and refill the list.

#### **posisjoner**: Positions the subfile cursor and page based on key fields.
- Handles positioning by teller, difference, or created date.
- Clears positioning fields after use.

#### **subfile**: Main subfile processing loop.
- Reads changed records (using `readc`).
- Handles display, edit, and custom actions (e.g., viewing details, calling another program).

#### **xc2bld**: Handles the edit/view detail popup (C2BLD screen).
- Fills detail fields from the database, displays the window for editing/viewing.
- Handles approval (`godkjenn`), exits.

#### **clr_subfile**: Clears the subfile and resets all counters.

#### **crt_subfile**: Fills the subfile page by reading records from the appropriate file (based on mode).
- Applies filters (via `chk_subfile`).
- Writes records to the subfile with all necessary fields.

#### **bck_subfile**: Handles rolldown/back page in subfile.
- Reads backwards, skips unwanted, refills the subfile.

#### **dsp_subfile**: Displays the current state of the subfile, manages indicators.

#### **filter (F1)**: Handles filter window, lets the user enter filter criteria, then populates the subfile accordingly.

#### **chk_subfile**: Checks if a record matches the current filter (e.g., difference > 0, approved or not).

#### **godkjenn**: Approves a reconciliation, updates fields, and marks as approved.

#### **\*inzsr**: Initialization subroutine.
- Sets up keys, reads firm ID from LDA, sets initial subfile page, positions DB, fills subfile.

---

### 7. **Key Lists (KLIST)**

Multiple KLISTs are defined for various key structures to support `SETLL`, `CHAIN`, `READ`, etc. on the various files for teller, difference, and date.

---

### 8. **Workflow Summary**

**Main flow**:
1. Initializes the screen, reads LDA for firm/user.
2. Populates the subfile with head records.
3. Waits for user interaction (paging, filtering, viewing details, approving).
4. Refreshes or repositions the subfile, allowing for filter and approval actions.
5. Exits gracefully on F3/F12.

---

## ### Notes for New Developers

- **Subfiles**: Central concept for IBM i display programming; much of the code is about populating/handling them.
- **Indicators** (`*inXX`): Boolean switches for fields/controlling behaviors—common in non-free RPG, carefully managed.
- **Paging**: Rollup and rolldown process handled explicitly by reading and filling subfile data one page at a time.
- **Filtering**: User can filter the list (e.g., only differences, only not approved), see routine `filter` and `chk_subfile`.
- **Approval**: Details can be viewed, and records approved, which updates the database and display.

**Translation**: Variable and field names are in Norwegian, e.g., 
- `kasseoppgjør` = cash register settlement
- `differanse` = difference
- `godkjenne` = approve,
- `opprettet dato` = created date

---

## ### High-Level Flow Chart

```text
[Init] --> [Show/Fill Subfile] <---> [User Input (Keys)]
              |      ^                   |
              v      |                   v
         [Filter] [Paging]         [View/Edit/Approve]
               \______/  <--->   [Exit]
```

---

### **If you are new to IBM i or subfile programming:**

- Learn the basics of subfile handling, indicators, and display files (DDS).
- Understand how data is mapped between display and database using KLIST, CHAIN, SETLL, etc.
- This code is "modular" in the old RPG sense: long with many subroutines, each handling a specific part of the UI or data logic.

---

## **Conclusion**

This is a classic IBM i subfile-driven maintenance program for cash reconciliation headers, with paging, filtering, approval, and detailed view/edit support. It follows established patterns for green-screen RPG applications and is well-annotated for the benefit of future maintainers.