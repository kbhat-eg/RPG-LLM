     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : VP726R (variant av VP716R som brukes i spørring
      *                           vare pris - der skal ikke prisforslag
      *                           legge seg ut som veilende pris)
      * Beskrivelse . . : Vare-pris, henter priser på tre salgsenheter II
      *
      *                   Input:  Firma, vare, prisgrp., lev.type,
      *                           dato og tidspunkt
      *                   Output: Enhet, salgspris, butikkpris, kostpris,
      *                           og innkjøpspris for enhet-1
      *                           Enhet, salgspris, butikkpris og
      *                           omregningsfaktor volum for enhet-2 og
      *                           enhet-3 i forhold til enhet-1
      *                           Prisdato for enhet-1, enhet-2 og enhet-3
      *                           Tilbudsperiode og kampanje
      *                           Tilbudspris for enhet-1, enhet-2 og
      *                           enhet-3
      *                           Kostpris i tilbudsperioden i forhold til
      *                           enhet-1
      *                           Innkjøpsenhet og prissammenligningsenhet
      *
      *                           Vær oppmerksom på at dersom det ikke
      *                           blir treff på tilbud, returneres tilbuds-
      *                           verdier i henhold til siste tilbud på
      *                           varen
      *
      * Spesialversjon. :
      * Tilpasset for . :

      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       260499 HKO  Nytt program
      *       301104 HKO  Returnerer første innkjøpsenhet og
      *                   enhet og pris for prissammenligning
      *       020805 HKO  Endret les mot vare-enhet for å finne salgsenheter
      *                   og innkjøpsenhet
5.70  *       ry1008 BOF  Utvidet med prisgruppe
6.10  *       352222 BOF  Før den går videre og henter gammelt tilbud
      *                   så sjekkes det om det finnes tilb. prgr=blank
6.20  *       220311 BOF  Utvidet med prisgiver på vare-pris
6.21  *       240411 BOF  Utvidet med tilbudspris med varegruppe og leverandør
6.22  *       070312 BOF  Justering på hente tilbudspris vareruppe og leverandør
6.23  *       080312 BOF  Utvidet med lager i parameter
6.24  *       210214 NHO  Leverandørnr blankes fra nøkkel når aktivt
      *                   tilbud ikke ble funnet
7.01  *       120718 BOF  Henter beste tilbudspris
      *
8.01  *       170323 BOF  Dette skal brukes fra VV551R
8.02  *PRG2   090124 bsa  Utvidet prisgruppe fra 1 til 2 posisjoner. Kompilert
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
     fvvenl2    if   e           k disk    rename(vvenpfr:vvenl2r)
     fvvenl4    if   e           k disk    rename(vvenpfr:vvenl4r)
     fvtill1    if   e           k disk    rename(vtilpfr:vtill1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
      *
      * Definering av pamametre
      *
     d p_firm          s                   like(vpfirm)
     d p_vare          s                   like(vpvare)
5.70 d p_prgr          s                   like(vpprgr)
6.23 d p_lage          s              2  0
     d p_lety          s                   like(vplety)
     d p_dato          s                   like(vppdat)
     d p_time          s                   like(vtftim)
     d p_enh1          s                   like(vpenhe)
     d p_sap1          s                   like(vpsapr)
     d p_bup1          s                   like(vpbupr)
     d p_kop1          s                   like(vpkopr)
     d p_inp1          s                   like(vpinpr)
     d p_pda1          s                   like(vppdat)
     d p_enh2          s                   like(vpenhe)
     d p_sap2          s                   like(vpsapr)
     d p_bup2          s                   like(vpbupr)
     d p_omr2          s                   like(veomre)
     d p_pda2          s                   like(vppdat)
     d p_enh3          s                   like(vpenhe)
     d p_sap3          s                   like(vpsapr)
     d p_bup3          s                   like(vpbupr)
     d p_omr3          s                   like(veomre)
     d p_pda3          s                   like(vppdat)
     d p_fdat          s                   like(vtfdat)
     d p_ftid          s                   like(vtftim)
     d p_tdat          s                   like(vttdat)
     d p_ttid          s                   like(vtttim)
     d p_kamp          s                   like(vtkamp)
     d p_tip1          s                   like(vttip1)
     d p_tkp1          s                   like(vtkop1)
     d p_tip2          s                   like(vttip2)
     d p_tip3          s                   like(vttip3)
     d p_enin          s                   like(veenhe)
     d p_enps          s                   like(vvenps)
     d p_pspr          s                   like(vpsapr)
      *
      * Definering av variable i nøkler
      *
     d vvprl1_vare     s                   like(vpvare)
6.20 d vvprl1_ldor     s                   like(vpldor)
5.70 d vvprl1_prgr     s                   like(vpprgr)
     d vvprl1_enhe     s                   like(vpenhe)
     d vvprl1_lety     s                   like(vplety)
     d vvenl2_vare     s                   like(vevare)
     d vvenl2_saen     s                   like(vesaen)
     d vvenl4_vare     s                   like(vevare)
     d vvenl4_inen     s                   like(veinen)
6.21 d vtill1_ogrp     s                   like(vtogrp)
6.21 d vtill1_hgrp     s                   like(vthgrp)
6.21 d vtill1_ugrp     s                   like(vtugrp)
6.21 d vtill1_ldor     s                   like(vtldor)
     d vtill1_vare     s                   like(vtvare)
5.70 d vtill1_prgr     s                   like(vtprgr)
     d vtill1_lety     s                   like(vtlety)
     d vvarl1_vare     s                   like(vvvare)
     d vugrl1_uogr     s                   like(vguogr)
     d vugrl1_uhgr     s                   like(vguhgr)
     d vugrl1_uugr     s                   like(vguugr)
      *
      * Definering av variable
      *
     d x               s              1  0
     d b_pris          s              1    inz(*off)
6.20 d b_inlr          s              1    inz(*off)
      *
     d w_firm          s                   like(vpfirm)
     d w_dato          s                   like(vppdat)
     d w_time          s                   like(vtftim)
     d w_omr1          s                   like(veomre)
     d w_omr2          s                   like(veomre)
     d w_omr3          s                   like(veomre)
6.20 d w_ldor          s                   like(vvldor)
6.20 d w_lage          s              2  0
6.21 d w_lety          s                   like(vplety)
6.21 d w_prgr          s                   like(vpprgr)
6.21 d w_pldo          s                   like(vpldor)
      *
7.01 d s_tip1          s                   like(vttip1)
7.01 d s_tip2          s                   like(vttip1)
7.01 d s_tip3          s                   like(vttip1)
      *
6.20 d                uds
7.01 d l_filg                931    933
6.20 d l_lage               1001   1002  0
      *
7.01 d u_s701          s              1    inz(*off)                            Finne beste pris
7.01  *
7.01  * Definering av eksterne prg
7.01  *
7.01   dcl-s co402_verdi1  char(1);
7.01   dcl-s co402_verdi2  char(2048);
7.01   DCL-PR CO402R EXTPGM('CO402R');
7.01     p_filgrp            char(3)     const;
7.01     p_firm              packed(3:0) const;
7.01     p_lager             packed(2:0) const;
7.01     p_nokkel            char(50)    const;
7.02     p_verdi1            char(1);
7.01     p_verdi2            char(2048);
7.01   END-PR;
7.01  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.23 c                   eval      w_lage = p_lage
6.20  *
6.20  * Henter leverandør for vare og lager
6.20  *
6.20 c                   call      'VL721R  '
6.20 c                   parm                    w_firm
6.20 c                   parm                    p_vare
6.20 c                   parm                    w_lage
6.20 c                   parm                    w_ldor
6.20 c                   parm                    b_inlr
      *
      *
      * Henter vareinformasjon
      *
     c                   eval      vvarl1_vare = p_vare
     c     vvarl1_key    chain     vvarl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      * Leser salgsenheter på vare, og henter prisinformasjon
      *
     c                   eval      x = 0
      *
     c                   eval      vvenl2_vare = p_vare
     c                   eval      vvenl2_saen = 1
     c     vvenl2_key    setll     vvenl2
     c     vvenl2_key2   reade     vvenl2                                 90
     c                   dow       *in90 = *off and
     c                             x < 3
      *
6.20  * 1. leverandør for lageret
6.20 c                   eval      vvprl1_ldor = w_ldor
6.20 c                   exsr      hent_pris
6.20 c                   if        b_pris = *off  and
6.20 c                             w_ldor <> vvldor
6.20  * 2. hovedleverandør
6.20 c                   eval      vvprl1_ldor = vvldor
     c                   exsr      hent_pris
6.20 c                   if        b_pris = *off
6.20  * siste mulighet...
6.20 c                   eval      vvprl1_ldor = 0
6.20 c                   exsr      hent_pris
6.20 c                   endif
6.20 c                   endif
      *
     c     vvenl2_key2   reade     vvenl2                                 90
     c                   enddo
      *
      * Finner omregningsfaktor volum for enhet 2 og 3
      *
     c                   if        w_omr1 = 0
     c                   eval      w_omr1 = 1
     c                   endif
      *
     c                   eval(h)   p_omr2 = w_omr2 / w_omr1
     c                   eval(h)   p_omr3 = w_omr3 / w_omr1
      *
      * Henter eventuelle tilbudspriser
      *
7.01 c                   eval      s_tip1 = *hival
6.21 c                   eval      vtill1_ogrp = 0
6.21 c                   eval      vtill1_hgrp = 0
6.21 c                   eval      vtill1_ugrp = 0
6.21 c                   eval      vtill1_ldor = 0
     c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = p_prgr
     c                   eval      vtill1_lety = p_lety
     c     vtill1_key    setll     vtill1
     c     vtill1_key    reade     vtill1                                 90
     c                   dow       *in90 = *off
     c                   if        w_dato >= vtfdat and
     c                             w_dato <= vttdat
     c                   if        w_dato <> vtfdat or
     c                             w_dato = vtfdat and
     c                             w_time >= vtftim
     c                   if        w_dato <> vttdat or
     c                             w_dato = vttdat and
     c                             w_time <= vtttim
      *
     c                   exsr      bestem_tilb
      *
7.01 c                   if        u_s701 = *on
7.01 c                   if        p_tip1 < s_tip1
7.01 c                   eval      s_tip1 = p_tip1
7.01 c                   eval      s_tip2 = p_tip2
7.01 c                   eval      s_tip3 = p_tip3
7.01 c                   endif
7.01 c                   else
     c                   leave
7.01 c                   endif
      *
     c                   endif
     c                   endif
     c                   endif
     c     vtill1_key    reade     vtill1                                 90
     c                   enddo
      *
      * Dersom tilbud ikke ble funnet på oppgitt leveringstype, letes det
      * etter tilbud på leveringstype 0
      *
     c                   if        p_tip1 = 0 and
     c                             p_tip2 = 0 and
     c                             p_tip3 = 0 and
     c                             p_lety <> 0
      *
7.01 c                   eval      s_tip1 = *hival
     c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = p_prgr
     c                   eval      vtill1_lety = 0
     c     vtill1_key    setll     vtill1
     c     vtill1_key    reade     vtill1                                 90
     c                   dow       *in90 = *off
     c                   if        w_dato >= vtfdat and
     c                             w_dato <= vttdat
     c                   if        w_dato <> vtfdat or
     c                             w_dato = vtfdat and
     c                             w_time >= vtftim
     c                   if        w_dato <> vttdat or
     c                             w_dato = vttdat and
     c                             w_time <= vtttim
      *
     c                   exsr      bestem_tilb
      *
7.01 c                   if        u_s701 = *on
7.01 c                   if        p_tip1 < s_tip1
7.01 c                   eval      s_tip1 = p_tip1
7.01 c                   eval      s_tip2 = p_tip2
7.01 c                   eval      s_tip3 = p_tip3
7.01 c                   endif
7.01 c                   else
     c                   leave
7.01 c                   endif
      *
     c                   endif
     c                   endif
     c                   endif
     c     vtill1_key    reade     vtill1                                 90
     c                   enddo
      *
     c                   endif
6.10  *
6.10  * Dersom tilbud ikke ble funnet på oppgitt prisgruppe,letes det  et
6.10  * etter tilbud på prisgruppe blank, først med p_lety
6.10  *
6.10 c                   if        p_tip1 = 0 and
6.10 c                             p_tip2 = 0 and
6.10 c                             p_tip3 = 0 and
6.10 c                             p_prgr <> *blank
6.10  *
7.01 c                   eval      s_tip1 = *hival
6.10 c                   eval      vtill1_vare = p_vare
6.10 c                   eval      vtill1_prgr = *blank
6.10 c                   eval      vtill1_lety = p_lety
6.10 c     vtill1_key    setll     vtill1
6.10 c     vtill1_key    reade     vtill1                                 90
6.10 c                   dow       *in90 = *off
6.10 c                   if        w_dato >= vtfdat and
6.10 c                             w_dato <= vttdat
6.10 c                   if        w_dato <> vtfdat or
6.10 c                             w_dato = vtfdat and
6.10 c                             w_time >= vtftim
6.10 c                   if        w_dato <> vttdat or
6.10 c                             w_dato = vttdat and
6.10 c                             w_time <= vtttim
6.10  *
6.10 c                   exsr      bestem_tilb
6.10  *
7.01 c                   if        u_s701 = *on
7.01 c                   if        p_tip1 < s_tip1
7.01 c                   eval      s_tip1 = p_tip1
7.01 c                   eval      s_tip2 = p_tip2
7.01 c                   eval      s_tip3 = p_tip3
7.01 c                   endif
7.01 c                   else
     c                   leave
7.01 c                   endif
6.10  *
6.10 c                   endif
6.10 c                   endif
6.10 c                   endif
6.10 c     vtill1_key    reade     vtill1                                 90
6.10 c                   enddo
6.10  *
6.10 c                   endif
6.10  *
6.10  * Dersom tilbud ikke ble funnet på oppgitt prisgruppe,letes det  et
6.10  * etter tilbud på prisgruppe blank, først med p_lety
6.10  *
6.10 c                   if        p_tip1 = 0 and
6.10 c                             p_tip2 = 0 and
6.10 c                             p_tip3 = 0 and
6.10 c                             p_lety <> 0
6.10  *
7.01 c                   eval      s_tip1 = *hival
6.10 c                   eval      vtill1_vare = p_vare
6.10 c                   eval      vtill1_prgr = *blank
6.10 c                   eval      vtill1_lety = 0
6.10 c     vtill1_key    setll     vtill1
6.10 c     vtill1_key    reade     vtill1                                 90
6.10 c                   dow       *in90 = *off
6.10 c                   if        w_dato >= vtfdat and
6.10 c                             w_dato <= vttdat
6.10 c                   if        w_dato <> vtfdat or
6.10 c                             w_dato = vtfdat and
6.10 c                             w_time >= vtftim
6.10 c                   if        w_dato <> vttdat or
6.10 c                             w_dato = vttdat and
6.10 c                             w_time <= vtttim
6.10  *
6.10 c                   exsr      bestem_tilb
6.10  *
7.01 c                   if        u_s701 = *on
7.01 c                   if        p_tip1 < s_tip1
7.01 c                   eval      s_tip1 = p_tip1
7.01 c                   eval      s_tip2 = p_tip2
7.01 c                   eval      s_tip3 = p_tip3
7.01 c                   endif
7.01 c                   else
     c                   leave
7.01 c                   endif
6.10  *
6.10 c                   endif
6.10 c                   endif
6.10 c                   endif
6.10 c     vtill1_key    reade     vtill1                                 90
6.10 c                   enddo
6.10  *
6.10 c                   endif
      *
7.01 c                   if        u_s701 = *on
7.01 c                   if        s_tip1 <> *hival
7.01 c                   eval      p_tip1 = s_tip1
7.01 c                   eval      p_tip2 = s_tip2
7.01 c                   eval      p_tip3 = s_tip3
7.01 c                   endif
7.01 c                   endif
6.21  *
6.21  * Dersom tilbud ikke ble funnet på oppgitt vare/prisgruppe/leveringstupe
6.21  * sjekkes varegruppe / leverandør
6.22  *
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_prgr = p_prgr
6.22 c                   exsr      tilb_sjekk
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0 and
6.22 c                             p_prgr <> *blank
6.22 c                   eval      vtill1_prgr = *blank
6.22 c                   exsr      tilb_sjekk
6.22 c                   endif
6.22 c                   endif
6.22 c
      *
      * Dersom aktivt tilbud ikke ble funnet, hentes nyeste tilbud på vare
6.24  *
6.24 c                   eval      vtill1_ldor = 0
6.24  *
     c                   if        p_tip1 = 0 and
     c                             p_tip2 = 0 and
     c                             p_tip3 = 0
      *
     c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = p_prgr
     c                   eval      vtill1_lety = p_lety
     c     vtill1_key    chain     vtill1                             90
     c                   if        *in90 = *off
     c                   exsr      bestem_tilb
     c                   endif
      *
     c                   endif
      *
      * Dersom tilbud ikke ble funnet på oppgitt leveringstype, letes hentes
      * nyeste tilbud på leveringstype 0
      *
     c                   if        p_tip1 = 0 and
     c                             p_tip2 = 0 and
     c                             p_tip3 = 0 and
     c                             p_lety <> 0
      *
     c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = p_prgr
     c                   eval      vtill1_lety = 0
     c     vtill1_key    chain     vtill1                             90
     c                   if        *in90 = *off
     c                   exsr      bestem_tilb
     c                   endif
      *
     c                   endif
5.70  *
5.70  * Dersom tilbud ikke ble funnet på oppgitt prisgruppe, letes hentes
5.70  * nyeste tilbud på prisgruppe = blank
5.70  *
5.70 c                   if        p_tip1 = 0 and
5.70 c                             p_tip2 = 0 and
5.70 c                             p_tip3 = 0 and
5.70 c                             p_prgr <> *blank
5.70  *
5.70 c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = *blank
5.70 c                   eval      vtill1_lety = p_lety
5.70 c     vtill1_key    setll     vtill1
5.70 c     vtill1_key    reade     vtill1                                 90
5.70 c                   dow       *in90 = *off
5.70 c                   if        w_dato >= vtfdat and
5.70 c                             w_dato <= vttdat
5.70 c                   if        w_dato <> vtfdat or
5.70 c                             w_dato = vtfdat and
5.70 c                             w_time >= vtftim
5.70 c                   if        w_dato <> vttdat or
5.70 c                             w_dato = vttdat and
5.70 c                             w_time <= vtttim
5.70  *
5.70 c                   exsr      bestem_tilb
5.70  *
5.70 c                   leave
5.70  *
5.70 c                   endif
5.70 c                   endif
5.70 c                   endif
5.70 c     vtill1_key    reade     vtill1                                 90
5.70 c                   enddo
5.70  *
5.70  * Dersom tilbud ikke ble funnet på oppgitt leveringstype, letes det
5.70  * etter tilbud på leveringstype 0
5.70  *
5.70 c                   if        p_tip1 = 0 and
5.70 c                             p_tip2 = 0 and
5.70 c                             p_tip3 = 0 and
5.70 c                             p_lety <> 0
5.70  *
5.70 c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = *blank
5.70 c                   eval      vtill1_lety = 0
5.70 c     vtill1_key    setll     vtill1
5.70 c     vtill1_key    reade     vtill1                                 90
5.70 c                   dow       *in90 = *off
5.70 c                   if        w_dato >= vtfdat and
5.70 c                             w_dato <= vttdat
5.70 c                   if        w_dato <> vtfdat or
5.70 c                             w_dato = vtfdat and
5.70 c                             w_time >= vtftim
5.70 c                   if        w_dato <> vttdat or
5.70 c                             w_dato = vttdat and
5.70 c                             w_time <= vtttim
5.70  *
5.70 c                   exsr      bestem_tilb
5.70  *
5.70 c                   leave
5.70  *
5.70 c                   endif
5.70 c                   endif
5.70 c                   endif
5.70 c     vtill1_key    reade     vtill1                                 90
5.70 c                   enddo
5.70  *
5.70 c                   endif
5.70  *
5.70  * Dersom aktivt tilbud ikke ble funnet, hentes nyeste tilbud på vare
5.70  *
5.70 c                   if        p_tip1 = 0 and
5.70 c                             p_tip2 = 0 and
5.70 c                             p_tip3 = 0
5.70  *
5.70 c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = *blank
5.70 c                   eval      vtill1_lety = p_lety
5.70 c     vtill1_key    chain     vtill1                             90
5.70 c                   if        *in90 = *off
5.70 c                   exsr      bestem_tilb
5.70 c                   endif
5.70  *
5.70 c                   endif
5.70  *
5.70  * Dersom tilbud ikke ble funnet på oppgitt leveringstype, letes hentes
5.70  * nyeste tilbud på leveringstype 0
5.70  *
5.70 c                   if        p_tip1 = 0 and
5.70 c                             p_tip2 = 0 and
5.70 c                             p_tip3 = 0 and
5.70 c                             p_lety <> 0
5.70  *
5.70 c                   eval      vtill1_vare = p_vare
5.70 c                   eval      vtill1_prgr = *blank
5.70 c                   eval      vtill1_lety = 0
5.70 c     vtill1_key    chain     vtill1                             90
5.70 c                   if        *in90 = *off
5.70 c                   exsr      bestem_tilb
5.70 c                   endif
5.70  *
5.70 c                   endif
5.70  *
5.70 c                   endif
      *
      *
      * Dersom kostpris er 0 hentes kostpris på bakgrunn av DG-% på vare
      * eller undergruppe
      *
     c                   if        p_kop1 = 0
      *
     c                   if        vvdekn = 0
     c                   eval      vugrl1_uogr = vvogrp
     c                   eval      vugrl1_uhgr = vvhgrp
     c                   eval      vugrl1_uugr = vvugrp
     c     vugrl1_key    chain     vugrl1
     c                   if        %found
     c                   eval      vvdekn = vgudek
     c                   endif
     c                   endif
      *
     c                   eval(h)   p_kop1 = p_sap1 * vvdekn / 100
     c                   if        p_kop1 <> 0
     c                   eval      p_kop1 = p_sap1 - p_kop1
     c                   endif
      *
     c                   endif
      *
      * Henter første innkjøpsenhet
      *
     c                   eval      p_enin = p_enh1
      *
     c                   eval      vvenl4_vare = p_vare
     c                   eval      vvenl4_inen = 1
     c     vvenl4_key    setll     vvenl4
     c     vvenl4_key2   reade     vvenl4
     c                   if        not %eof
     c                   eval      p_enin = veenhe
     c                   endif
      *
      * Dersom prissammenligningenhet ikke er oppgitt på vare hentes denne
      * fra undergruppe
      *
     c                   eval      p_enps = vvenps
      *
     c                   if        p_enps = *blank
     c                   eval      vugrl1_uogr = vvogrp
     c                   eval      vugrl1_uhgr = vvhgrp
     c                   eval      vugrl1_uugr = vvugrp
     c     vugrl1_key    chain     vugrl1
     c                   if        %found
      *
     c                   if        vguep1 <> *blank
     c                   if        vguep1 = p_enh1 or
     c                             vguep1 = p_enh2 or
     c                             vguep1 = p_enh3
     c                   eval      p_enps = vguep1
     c                   endif
     c                   endif
     c                   if        p_enps = *blank and
     c                             vguep2 <> *blank
     c                   if        vguep2 = p_enh1 or
     c                             vguep2 = p_enh2 or
     c                             vguep2 = p_enh3
     c                   eval      p_enps = vguep2
     c                   endif
     c                   endif
      *
     c                   endif
     c                   endif
      *
      * Henter pris på prissammenligningsenhet
      *
     c                   if        p_enps <> *blank
     c                   select
     c                   when      p_enps = p_enh1
     c                   eval      p_pspr = p_sap1
     c                   when      p_enps = p_enh2
     c                   eval      p_pspr = p_sap2
     c                   when      p_enps = p_enh3
     c                   eval      p_pspr = p_sap3
     c                   other
     c*** henter pris på annen enhet...
     c                   endsl
     c                   endif
      *
     c                   if        p_pspr = 0
     c                   eval      p_enps = *blank
     c                   endif
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for henting av prisinformasjon for salgsenhet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_pris     begsr
      *
     c                   eval      b_pris = *off
      *
     c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = p_prgr
     c                   eval      vvprl1_enhe = veenhe
     c                   eval      vvprl1_lety = p_lety
     c     vvprl1_key    setll     vvprl1
     c     vvprl1_key    reade     vvprl1                                 91
      *
     c                   if        *in91 = *off
     c                   eval      x = x + 1
     c                   eval      b_pris = *on
     c                   endif
      *
     c                   dow       *in91 = *off
      *
     c                   select
     c                   when      x = 1
     c                   eval      p_enh1 = vpenhe
     c                   eval      p_sap1 = vpsapr
     c                   eval      p_bup1 = vpbupr
     c                   eval      p_kop1 = vpkopr
     c                   eval      p_inp1 = vpinpr
     c                   eval      w_omr1 = veomre
     c                   eval      p_pda1 = vppdat
     c                   when      x = 2
     c                   eval      p_enh2 = vpenhe
     c                   eval      p_sap2 = vpsapr
     c                   eval      p_bup2 = vpbupr
     c                   eval      w_omr2 = veomre
     c                   eval      p_pda2 = vppdat
     c                   when      x = 3
     c                   eval      p_enh3 = vpenhe
     c                   eval      p_sap3 = vpsapr
     c                   eval      p_bup3 = vpbupr
     c                   eval      w_omr3 = veomre
     c                   eval      p_pda3 = vppdat
     c                   endsl
      *
6.21 c                   eval      w_pldo = vpldor
     c                   if        w_dato >= vppdat
     c                   leave
     c                   endif
      *
     c     vvprl1_key    reade     vvprl1                                 91
     c                   enddo
      *
      * Dersom priser ikke finnes for oppgitt leveringstype, hentes priser
      * fra leveringstype 0
      *
     c                   if        b_pris = *off and
     c                             p_lety <> 0
      *
     c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = p_prgr
     c                   eval      vvprl1_enhe = veenhe
     c                   eval      vvprl1_lety = 0
     c     vvprl1_key    setll     vvprl1
     c     vvprl1_key    reade     vvprl1                                 91
      *
     c                   if        *in91 = *off
     c                   eval      x = x + 1
     c                   eval      b_pris = *on
     c                   endif
      *
     c                   dow       *in91 = *off
      *
     c                   select
     c                   when      x = 1
     c                   eval      p_enh1 = vpenhe
     c                   eval      p_sap1 = vpsapr
     c                   eval      p_bup1 = vpbupr
     c                   eval      p_kop1 = vpkopr
     c                   eval      p_inp1 = vpinpr
     c                   eval      w_omr1 = veomre
     c                   eval      p_pda1 = vppdat
     c                   when      x = 2
     c                   eval      p_enh2 = vpenhe
     c                   eval      p_sap2 = vpsapr
     c                   eval      p_bup2 = vpbupr
     c                   eval      w_omr2 = veomre
     c                   eval      p_pda2 = vppdat
     c                   when      x = 3
     c                   eval      p_enh3 = vpenhe
     c                   eval      p_sap3 = vpsapr
     c                   eval      p_bup3 = vpbupr
     c                   eval      w_omr3 = veomre
     c                   eval      p_pda3 = vppdat
     c                   endsl
6.21 c                   eval      w_pldo = vpldor
      *
     c                   if        w_dato >= vppdat
     c                   leave
     c                   endif
      *
     c     vvprl1_key    reade     vvprl1                                 91
     c                   enddo
      *
     c                   endif
5.70  *
5.70  * Dersom priser ikke finnes for oppgitt prisgruppe, hentes priser
5.70  * fra prisgruppe = blank
5.70  *
5.70 c                   if        b_pris = *off and
5.70 c                             p_prgr <> *blank
5.70  *
5.70 c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = *blank
5.70 c                   eval      vvprl1_enhe = veenhe
5.70 c                   eval      vvprl1_lety = p_lety
5.70 c     vvprl1_key    setll     vvprl1
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70  *
5.70 c                   if        *in91 = *off
5.70 c                   eval      x = x + 1
5.70 c                   eval      b_pris = *on
5.70 c                   endif
5.70  *
5.70 c                   dow       *in91 = *off
5.70  *
5.70 c                   select
5.70 c                   when      x = 1
5.70 c                   eval      p_enh1 = vpenhe
5.70 c                   eval      p_sap1 = vpsapr
5.70 c                   eval      p_bup1 = vpbupr
5.70 c                   eval      p_kop1 = vpkopr
5.70 c                   eval      p_inp1 = vpinpr
5.70 c                   eval      w_omr1 = veomre
5.70 c                   eval      p_pda1 = vppdat
5.70 c                   when      x = 2
5.70 c                   eval      p_enh2 = vpenhe
5.70 c                   eval      p_sap2 = vpsapr
5.70 c                   eval      p_bup2 = vpbupr
5.70 c                   eval      w_omr2 = veomre
5.70 c                   eval      p_pda2 = vppdat
5.70 c                   when      x = 3
5.70 c                   eval      p_enh3 = vpenhe
5.70 c                   eval      p_sap3 = vpsapr
5.70 c                   eval      p_bup3 = vpbupr
5.70 c                   eval      w_omr3 = veomre
5.70 c                   eval      p_pda3 = vppdat
5.70 c                   endsl
6.21 c                   eval      w_pldo = vpldor
5.70  *
5.70 c                   if        w_dato >= vppdat
5.70 c                   leave
5.70 c                   endif
5.70  *
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70 c                   enddo
5.70  *
5.70  * Dersom priser ikke finnes for oppgitt leveringstype, hentes priser
5.70  * fra leveringstype 0
5.70  *
5.70 c                   if        b_pris = *off and
5.70 c                             p_lety <> 0
5.70  *
5.70 c                   eval      vvprl1_vare = p_vare
5.70 c                   eval      vvprl1_prgr = *blank
5.70 c                   eval      vvprl1_enhe = veenhe
5.70 c                   eval      vvprl1_lety = 0
5.70 c     vvprl1_key    setll     vvprl1
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70  *
5.70 c                   if        *in91 = *off
5.70 c                   eval      x = x + 1
5.70 c                   eval      b_pris = *on
5.70 c                   endif
5.70  *
5.70 c                   dow       *in91 = *off
5.70  *
5.70 c                   select
5.70 c                   when      x = 1
5.70 c                   eval      p_enh1 = vpenhe
5.70 c                   eval      p_sap1 = vpsapr
5.70 c                   eval      p_bup1 = vpbupr
5.70 c                   eval      p_kop1 = vpkopr
5.70 c                   eval      p_inp1 = vpinpr
5.70 c                   eval      w_omr1 = veomre
5.70 c                   eval      p_pda1 = vppdat
5.70 c                   when      x = 2
5.70 c                   eval      p_enh2 = vpenhe
5.70 c                   eval      p_sap2 = vpsapr
5.70 c                   eval      p_bup2 = vpbupr
5.70 c                   eval      w_omr2 = veomre
5.70 c                   eval      p_pda2 = vppdat
5.70 c                   when      x = 3
5.70 c                   eval      p_enh3 = vpenhe
5.70 c                   eval      p_sap3 = vpsapr
5.70 c                   eval      p_bup3 = vpbupr
5.70 c                   eval      w_omr3 = veomre
5.70 c                   eval      p_pda3 = vppdat
5.70 c                   endsl
6.21 c                   eval      w_pldo = vpldor
5.70  *
5.70 c                   if        w_dato >= vppdat
5.70 c                   leave
5.70 c                   endif
5.70  *
5.70 c     vvprl1_key    reade     vvprl1                                 91
5.70 c                   enddo
5.70  *
5.70 c                   endif
5.70  *
5.70 c                   endif
5.70  *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for henting av tilbudspriser
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     bestem_tilb   begsr
      *
     c                   eval      p_fdat = vtfdat
     c                   eval      p_ftid = vtftim
     c                   eval      p_tdat = vttdat
     c                   eval      p_ttid = vtttim
     c                   eval      p_kamp = vtkamp
      *
     c                   select
     c                   when      p_enh1 = vtenh1
     c                   eval      p_tip1 = vttip1
     c                   if        vtkop1 <> 0
     c                   eval      p_tkp1 = vtkop1
     c                   endif
     c                   when      p_enh1 = vtenh2
     c                   eval      p_tip1 = vttip2
     c                   if        vtkop2 <> 0
     c                   eval      p_tkp1 = vtkop2
     c                   endif
     c                   when      p_enh1 = vtenh3
     c                   eval      p_tip1 = vttip3
     c                   if        vtkop3 <> 0
     c                   eval      p_tkp1 = vtkop3
     c                   endif
     c                   endsl
      *
     c                   if        p_enh2 <> *blank
     c                   select
     c                   when      p_enh2 = vtenh1
     c                   eval      p_tip2 = vttip1
     c                   when      p_enh2 = vtenh2
     c                   eval      p_tip2 = vttip2
     c                   when      p_enh2 = vtenh3
     c                   eval      p_tip2 = vttip3
     c                   endsl
     c                   endif
      *
     c                   if        p_enh3 <> *blank
     c                   select
     c                   when      p_enh3 = vtenh1
     c                   eval      p_tip3 = vttip1
     c                   when      p_enh3 = vtenh2
     c                   eval      p_tip3 = vttip2
     c                   when      p_enh3 = vtenh3
     c                   eval      p_tip3 = vttip3
     c                   endsl
     c                   endif
      *
     c                   endsr
      *
6.22  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.22  * Subrutine for å hente sjekke om det finnes tilbud på varegr.nivå
6.22  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.22  *
6.22 c     tilb_sjekk    begsr
6.22  *
6.22  *  overgruppe,hovedgruppe,undergruppe
6.22  *
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_ogrp = vvogrp
6.22 c                   eval      vtill1_hgrp = vvhgrp
6.22 c                   eval      vtill1_ugrp = vvugrp
6.22 c                   eval      vtill1_ldor = 0
6.22 c                   eval      vtill1_lety = 0
6.22 c                   eval      vtill1_vare = *blank
6.22 c                   exsr      hent_tilb
6.22 c                   endif
6.22  *  overgruppe,hovedgruppe
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_ugrp = 0
6.22 c                   exsr      hent_tilb
6.22 c                   endif
6.22  *  overgruppe
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_hgrp = 0
6.22 c                   exsr      hent_tilb
6.22 c                   endif
6.22  *  overgruppe,hovedgruppe,undergruppe, leverandør
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_ogrp = vvogrp
6.22 c                   eval      vtill1_hgrp = vvhgrp
6.22 c                   eval      vtill1_ugrp = vvugrp
6.22 c                   eval      vtill1_ldor = w_pldo
6.22 c                   exsr      hent_tilb
6.22 c                   endif
6.22  *  overgruppe,hovedgruppe              leverandør
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_ugrp = 0
6.22 c                   exsr      hent_tilb
6.22 c                   endif
6.22  *  overgruppe                          leverandør
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_hgrp = 0
6.22 c                   exsr      hent_tilb
6.22 c                   endif
6.22  *  leverandør
6.22 c                   if        p_tip1 = 0 and
6.22 c                             p_tip2 = 0 and
6.22 c                             p_tip3 = 0
6.22 c                   eval      vtill1_ogrp = 0
6.22 c                   exsr      hent_tilb
6.22 c                   endif
6.22  *
6.22 c                   endsr
6.20  *
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  * Subrutine for å hente tilbudspris på varegruppe/leverandørnivå
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  *
6.20 c     hent_tilb     begsr
6.20  *
6.21 c     vtill1_key    setll     vtill1
6.21 c     vtill1_key    reade     vtill1                                 90
6.21 c                   dow       *in90 = *off
6.21 c                   if        w_dato >= vtfdat and
6.21 c                             w_dato <= vttdat
6.21 c                   if        w_dato <> vtfdat or
6.21 c                             w_dato = vtfdat and
6.21 c                             w_time >= vtftim
6.21 c                   if        w_dato <> vttdat or
6.21 c                             w_dato = vttdat and
6.21 c                             w_time <= vtttim
6.21  *
6.21 c                   eval      p_fdat = vtfdat
6.21 c                   eval      p_ftid = vtftim
6.21 c                   eval      p_tdat = vttdat
6.21 c                   eval      p_ttid = vtttim
6.21 c                   eval      p_kamp = vtkamp
6.21  *
6.21 c                   eval(h)   p_tip1 = p_sap1 -
6.21 c                                      (p_sap1 * vtpro1)/100
6.21  *
6.21 c                   if        p_enh2 <> *blank
6.21 c                   eval(h)   p_tip2 = p_sap2 -
6.21 c                                      (p_sap2 * vtpro1)/100
     c                   endif
6.21  *
6.21 c                   if        p_enh3 <> *blank
6.21 c                   eval(h)   p_tip3 = p_sap3 -
6.21 c                                      (p_sap3 * vtpro1)/100
6.21 c                   endif
6.21  *
6.21 c                   leave
6.21  *
6.21 c                   endif
6.21 c                   endif
6.21 c                   endif
6.21 c     vtill1_key    reade     vtill1                                 90
6.21 c                   enddo
6.21  *
6.21 c                   endsr
6.21  *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_firm
     c                   parm                    p_vare
5.70 c                   parm                    p_prgr
6.23 c                   parm                    p_lage
     c                   parm                    p_lety
     c                   parm                    p_dato
     c                   parm                    p_time
     c                   parm                    p_enh1
     c                   parm                    p_sap1
     c                   parm                    p_bup1
     c                   parm                    p_kop1
     c                   parm                    p_inp1
     c                   parm                    p_pda1
     c                   parm                    p_enh2
     c                   parm                    p_sap2
     c                   parm                    p_bup2
     c                   parm                    p_omr2
     c                   parm                    p_pda2
     c                   parm                    p_enh3
     c                   parm                    p_sap3
     c                   parm                    p_bup3
     c                   parm                    p_omr3
     c                   parm                    p_pda3
     c                   parm                    p_fdat
     c                   parm                    p_ftid
     c                   parm                    p_tdat
     c                   parm                    p_ttid
     c                   parm                    p_kamp
     c                   parm                    p_tip1
     c                   parm                    p_tkp1
     c                   parm                    p_tip2
     c                   parm                    p_tip3
     c                   parm                    p_enin
     c                   parm                    p_enps
     c                   parm                    p_pspr
      *
      * Key for les på vare-pris-register
      *
     c     vvprl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvprl1_vare
6.20 c                   kfld                    vvprl1_ldor
5.70 c                   kfld                    vvprl1_prgr
     c                   kfld                    vvprl1_enhe
     c                   kfld                    vvprl1_lety
      *
      * Key for les på vare-enhet-register
      *
     c     vvenl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl2_vare
     c                   kfld                    vvenl2_saen
      *
     c     vvenl2_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl2_vare
      *
     c     vvenl4_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl4_vare
     c                   kfld                    vvenl4_inen
      *
     c     vvenl4_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl4_vare
      *
      * Key for les på tilbuds-register
      *
     c     vtill1_key    klist
     c                   kfld                    w_firm
6.21 c                   kfld                    vtill1_ogrp
6.21 c                   kfld                    vtill1_hgrp
6.21 c                   kfld                    vtill1_ugrp
6.21 c                   kfld                    vtill1_ldor
     c                   kfld                    vtill1_vare
5.70 c                   kfld                    vtill1_prgr
     c                   kfld                    vtill1_lety
      *
      * Key for oppslag på vare-register
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for oppslag på undergruppe-register
      *
     c     vugrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vugrl1_uogr
     c                   kfld                    vugrl1_uhgr
     c                   kfld                    vugrl1_uugr
      *
      *
      * Henter firma fra parameter
      *
     c                   eval      w_firm = p_firm
      *
      * Initierer dato og tidspunkt
      *
     c                   eval      w_dato = p_dato
     c                   eval      w_time = p_time
      *
     c                   if        w_dato = *loval
     c                   time                    w_dato
     c                   endif
      *
     c                   if        w_time = *loval
     c                   time                    w_time
     c                   endif
      *
      * Initierer output-parametre
      *
     c                   eval      p_enh1 = *blank
     c                   eval      p_sap1 = 0
     c                   eval      p_bup1 = 0
     c                   eval      p_kop1 = 0
     c                   eval      p_inp1 = 0
     c                   eval      p_pda1 = *loval
     c                   eval      p_enh2 = *blank
     c                   eval      p_sap2 = 0
     c                   eval      p_bup2 = 0
     c                   eval      p_omr2 = 0
     c                   eval      p_pda2 = *loval
     c                   eval      p_enh3 = *blank
     c                   eval      p_sap3 = 0
     c                   eval      p_bup3 = 0
     c                   eval      p_omr3 = 0
     c                   eval      p_pda3 = *loval
     c                   eval      p_fdat = *loval
     c                   eval      p_ftid = *loval
     c                   eval      p_tdat = *loval
     c                   eval      p_ttid = *loval
     c                   eval      p_kamp = *blank
     c                   eval      p_tip1 = 0
     c                   eval      p_tkp1 = 0
     c                   eval      p_tip2 = 0
     c                   eval      p_tip3 = 0
     c                   eval      p_enin = *blank
     c                   eval      p_enps = *blank
     c                   eval      p_pspr = 0
7.01  *
7.01  * Bruke beste pris uansett tilbud
7.01  *
7.01   CallP CO402R(l_filg:w_firm:0:'BESTE_PRIS':
7.01   co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     u_s701 = *on;
7.01   endif;
7.01  *
      *
     c                   endsr
