# IBM ILE RPG Program: FO604R  
_Start Printing of Order Documents (Ordrepapirer Utkskrift)_

---

This RPG program controls the initiation and parameter setup for order document printing (ordrepapirer), invoice runs, and related tasks. It supports both direct and batch printing, manages parameters through various registers, and enforces business rules concerning periods, statuses, and system conditions.

Below is an explanation of the main components and logic.

---

## 1. **Header and Maintenance History**

- The program has an extensive comment block documenting:
  - Description and purpose: Starting print/execution of order documents.
  - Change history: Which releases introduced which changes, by whom, including functional enhancements and bug fixes.
  - Version control and business rules notes.

## 2. **File Declarations**

- Several physical files (tables) are defined for input/output (disk files):
  - `votypfr`: Order type register (`votyl1r`)
  - `fstspfr`: Order/invoice status register (`fstsl1r`)
  - `raa1pfr`: Code/status 1 register (`raa1l1r`)
  - `fpm1pfr`: Plukk-1 linje register (`fpm1lur`)
- A workstation display file (`fo604d`) for interactive I/O.

## 3. **Data Structures**

- **LDA (Local Data Area) Fields**: For workstation id, user, firm number, etc.
- **Member Name DS**: Constructs a 10-char member name, with overlays for subfields (prefix, firm, number).
- **Period DS**: Breaks a 4-char numeric period into month/year components.

## 4. **Standalone Variables**

- **Parameters**: Passed in from other programs (p_dirk, p_firm, p_numm, etc.)
- **Working Variables**: For periods, dates, user input, status, keys, etc.

## 5. **Main Logic Flow**

### **A. Printing Mode Determination**
- If an order number (`p_numm`) is passed in, direct printing is assumed; some variables are set accordingly and the parameter setup is skipped.

### **B. Print Type Selection**
- The user selects the printing type, such as:
  - Offer (TILBUD)
  - Order confirmation (ORDREBEKREFT.)
  - Packing slip (PAKKSEDDEL)
  - Invoice (FAKTURA)
  - Credit note (KREDITNOTA)

### **C. Job Queue Option**
- If the user presses F4, the job will run in the job queue (`p_dirk` set to 2).

### **D. Order Type Validation**
- Checks that the selected order type exists in the order type register.
- If not found, loops back for selection.

### **E. Period and Date Entry**
- For certain types (e.g., invoices), the user must enter period and invoice date.
- Dates and periods are validated:
  - Non-blank
  - Correct format
  - Within allowed ranges
  - Not before "closed" periods (pulled from status file)
  - Invoice date must fall within period (check month/year match)
  - Year deviation limited to ±1 year from current

### **F. System State Checks**
- Calls out to other programs to check if:
  - Invoicing is already in progress elsewhere (`FA730R`)
  - Transfer to finance/accounting is in progress (`FA730R`)
- If so, it warns or exits.

- Marks the start of invoicing in `FA720R` so other sessions know.

### **G. Parameter Register Update**
- Calls the `param` subroutine to:
  - Write the selected values to the parameter file, either updating or creating a new entry.
  - Handles order number, period, date, order type, output queue, etc.
  - Prepares the necessary information for the print job.

### **H. Start Printing**
- Calls a system program (`FO612C`) to actually begin the print process, passing the member name.

### **I. Clean Program Exit**
- Sets on LR (`*inlr = *on`) and returns.

## 6. **Subroutines**

### **param**
- Updates or creates entries in the plukk-1 linje register, with all relevant print parameters.
- Handles period/year conversion for 2-digit years.

### **Initialization (`*inzsr`)**
- Sets up initial values, prepares key lists for chained file access.
- Retrieves initial order types and status info for the company.
- Builds the next free member name, ensuring it's not already in use.

### **Entry Parameter List (`*entry`)**
- Receives parameters from the calling program, sets up working variables.
- Fetches status from files needed for validation later.

## 7. **Important Business Rules Enforced**

- **Cannot invoice or transfer to finance if already in progress elsewhere.**
- **Cannot print for periods that are closed or not set up.**
- **Invoice date must match period both in month and year.**
- **Only allows certain print types based on context.**
- **Member names are managed to avoid duplication.**

## 8. **Use of External Programs**

- **SJKSWITCH**: Checks access through a switch register (security or state).
- **FA730R / FA720R**: System-wide status checks for invoicing and transfers.
- **FA920R**: Gets the latest member number for file members.
- **FO604C**: Checks whether a file member is already in use.
- **FO612C**: Initiates actual job execution for printing.

---

## **Summary Table**

| Section                | Purpose                                                                          |
|------------------------|----------------------------------------------------------------------------------|
| File definitions       | Set up access to necessary data and display files                                |
| Data structures        | Organize parameters, periods, keys, and member handling                          |
| Parameter handling     | Receive and process parameters for the print job                                 |
| Validation             | Enforce business logic on period/date, system status, and allowed actions        |
| Parameter registration | Store all needed parameters for the print/processing job                         |
| Job invocation         | Call print job processor with the correct member (parameter set)                 |
| Subroutines            | Modularize repetitive or procedural work                                         |

---

## **Onboarding Takeaways**

- **This program is the entry point for batch/interactive printing of order documents and invoices, enforcing all business rules for period and date, system status, and user selection.**
- **All parameters are written to a "parameter member" file, which is then passed to a secondary system program for execution.**
- **The code is heavily commented and uses tags and GOTO for flow control, which is typical of legacy RPG.**
- **Several system files must be in sync with current business rules – especially the status and order type records.**
- **Whenever you change how order types, periods, or status are handled, investigate this program!**
- **Key external programs provide cross-system locking and status checks to avoid conflicting invoicing or financial jobs.**

---

**If you need to debug or enhance order document print flows, period handling, or invoicing lockout logic, this is a critical component to understand.**