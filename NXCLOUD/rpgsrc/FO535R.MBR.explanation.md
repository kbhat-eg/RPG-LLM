# Fo535R – KID Generation for Santander Payments

## Overview

This program (`Fo535R`) is responsible for generating unique KID numbers used in Santander payment processing. The KID (Customer Identification Number) is a domain-specific numeric identifier used in Norwegian banking/payment systems to reference transactions unambiguously. The program constructs a KID based on the current timestamp, formats it into a specific structure, and calculates a check digit using an external module (`AK720R`).

## Domain-Specific Context

- **KID (Kundeidentifikasjonsnummer):** A structured numeric identifier, often with a check digit, used for transaction reconciliation in Scandinavian banking.
- **Santander:** Refers to the business context—this KID generation logic is tailored for Santander's payment requirements.

## Key Design Aspects

- **Timestamp-Based Uniqueness:** The KID is derived from the system timestamp, ensuring uniqueness for each invocation.
- **Structured Data Overlays:** The KID is split and recombined using overlays to conform to required KID formatting.
- **External Check Digit Calculation:** The check digit is calculated by calling a separate program (`AK720R`), supporting modularity and reuse of check digit logic.
- **Parameter Interface:** The generated KID is returned via a parameter, enabling use as a service/subroutine in broader batch or online flows.

## Structure & Logic

### Data Structure Definitions

#### KID Assembly Structures

- `d_kidr` (26A): Temporary workspace for timestamp string. Overlays (`d_part_01` to `d_part_15`) break this into segments for further processing.
- `d_kida` (18A): Final KID workspace. Overlays (`d_del_01` to `d_del_08`, `d_kmod`) split the KID into segments, with the last byte reserved for the check digit.

**Overlay Usage:** 
- Overlay fields are used to map parts of the timestamp (`d_kidr`) into the final KID structure (`d_kida`). This allows flexible reformatting without explicit substring operations.

#### Parameters and Working Variables

- `p_kida` (18A): Output parameter, receives the generated KID.
- `w_tmstp` (Z): Holds the current timestamp.
- `w_kkus` (24A): Working variable for check digit calculation.
- `w_ksif` (1P0): Receives the calculated check digit from `AK720R`.

### Entry and Initialization

- The program uses a *parameter list* (`*entry plist`) to receive a pointer to the output KID (`p_kida`).

### Main Logic Flow

1. **Timestamp Acquisition:**
    - `time w_tmstp` retrieves the current timestamp.
    - `movel w_tmstp d_kidr` moves the timestamp (as a string) into the workspace.

2. **KID Field Assembly:**
    - Overlay fields (`d_part_01` ... `d_part_14`) extract segments of the timestamp.
    - These are then mapped into the final KID structure (`d_kida`) via corresponding overlays (`d_del_01` ... `d_del_08`).
    - The mapping has evolved (see commented-out lines) to fix field alignment and length issues (notably in v7.02).

3. **Check Digit Calculation:**
    - The KID without its check digit (`d_del`) is moved into `w_kkus`.
    - `call 'AK720R'` invokes the external check digit routine with the KID body (`w_kkus`) as input and receives the check digit in `w_ksif`.
    - The check digit is written into the final byte of the KID (`d_kmod`).

4. **Output Assignment:**
    - The assembled KID (`d_kida`) is copied to the output parameter (`p_kida`).

5. **Program Termination:**
    - Sets LR indicator to end the program and returns.

### Subroutine: *inzsr

- Handles program initialization and parameter mapping.
- Reads the output parameter address (`p_kida`) from the caller.

## Notable Implementation Details

- **Field Overlaying:** The use of overlays for both the timestamp buffer and the KID structure allows for efficient, position-based mapping, which is crucial for conforming to external format specifications.
- **Versioned Changes:** Comments and code changes (notably in v7.01 and v7.02) reflect adjustments for correct field lengths and timestamp handling, indicating ongoing alignment with external requirements or bugfixes.
- **External Module Dependency:** The check digit logic is encapsulated in `AK720R`. This program expects the KID body and returns the check digit, decoupling business logic from validation routines.

## Interactions

- **External Program `AK720R`:** Handles check digit calculation. Any changes to the check digit algorithm should be made in this module.
- **Caller:** The program is typically called from another program, passing a variable to receive the generated KID.

## Maintenance Notes

- **Timestamp Format:** Changes to timestamp format or KID length require corresponding changes to overlay definitions.
- **Check Digit Logic:** If the check digit algorithm changes, verify the interface with `AK720R`.
- **Parameter Interface:** Ensure the caller provides an 18-character variable for the output KID.

## Summary Table

| Structure/Variable | Purpose                                   |
|--------------------|-------------------------------------------|
| `d_kidr`           | Timestamp workspace, 26A, overlays used   |
| `d_kida`           | Final KID, 18A, overlays for segments     |
| `w_tmstp`          | Current timestamp (Z)                     |
| `w_kkus`           | KID body for check digit calculation      |
| `w_ksif`           | Calculated check digit                    |
| `AK720R`           | External check digit calculation program  |
| `p_kida`           | Output parameter for generated KID        |

---

This program is a utility for generating KID numbers with guaranteed uniqueness (timestamp-based) and integrity (check digit), tailored to Santander's payment processing requirements. The design emphasizes modularity, format compliance, and maintainability through overlays and externalized validation logic.