# Explanation of the RPG Source Code (FO657R: KJØRELISTE SAMMENDRAG)

---

## Overview

This RPG program generates a summary printout ("sammendrag") of a driver's trip list (kjøre-liste), primarily for the Norwegian market, given the language in comments and field names. In later versions, it was enhanced to support PDF output and export to Excel (XLS).

The code processes orders for a given company ("firma") and prints a report of trips carried out (per route), including volume and weight totals, and optionally exports order details.

---

## Main Structure

### File Declarations
```rpg
f... (various disk files) ... k disk    rename(....)
f... (printer file) ... o e printer (with USROPN for PDF logic)
```
- Multiple disk files are declared and renamed, which serve as the various master and transaction files (orders, items, customers, statuses, etc.).
- The printer file (`fo658p`) is for output, optionally user-opened for PDF functionality.

---

### Data Definitions

#### Input Parameters
```rpg
d p_firm     s   ...  Company (firma)
d p_kjor     s   ...  Route (kjørenr)
d p_lage     s   ...  Warehouse (lager)
d p_ldat     s   ...  Delivery date
d p_excl     s   ...  Export to Excel flag (9.01)
```

#### Work/Temp Variables
- Many work variables for storing keys, current record fields, totals, etc.
- Variables for customer, order, item, route, company, etc.

#### PDF/XML Variables (if PDF output requested)
- Fields for spooled file and job identification, XML construction parameters, etc.

---

### Program Flow

#### 1. Program Start / Parameter Initialization

At `*inzsr`, the program:
- Receives parameters (company, warehouse, route, date, Excel flag)
- Sets up key lists for file access
- Initializes print headers with user, workstation, current date/time
- Loads company and status info for heading.

#### 2. Main Driver Loop

```rpg
c if p_kjor = 0 ... else ... endif

c setll fohelb
c read fohelb
c dow not %eof(fohelb)
  c if p_kjor <> 0 and fokjor > p_kjor
    c goto totalt
  c endif

  c exsr chk_ordre   // Check if this order should be included

  c if b_list = *on
    c exsr behandle
  c endif

  c read fohelb
c enddo
```
- Loops through the order header file (`fohelb`) - either for all routes if p_kjor=0 or for a given route.
- For each header, checks if the order is relevant using `chk_ordre`.
- If so, processes the order (`behandle`), which prints the order and details.

#### 3. End of Processing

- After the loop, checks if grand totals need printing (`total2`).
- If PDF output requested, generates XML and triggers PDF preview.
- Ends the program.

---

### Key Subroutines

#### **chk_ordre**
- Determines if the current order should be included in the printout:
  - Checks if "kjørekontorløsning" is active.
  - Warehouse and delivery date filtering.
  - Checks delivery type and process code (only include certain types).
  - Calls external program (`FU706R`) to get the last status code for order and only allows codes 2–7 (certain allowed order stages).
  - If all pass, sets `b_list=*on` to process this order.

#### **behandle**
- Prints header for the route (`hode1`), printing once per route.
- Prints header for the order (`hode2`), including fetching customer/project info.
- Loops through detail lines (`fodtl1`), processing each item (`vare`).
- Totals per order and calls `total` (writes sub-totals).

#### **hode1**, **hode2**
- Prepare and print report headings for route and order.
- Look up human-readable route text via a call to `RS725R`.
- Look up customer and project info.

#### **vare**
- Processes an order item line:
  - Gets item master data.
  - Determines quantity decimals.
  - Looks up item/unit dimensions and weight.
  - Calculates total volume and weight for the line, adds to totals.
  - Writes detail line.
  - Optionally writes Excel line (`skriv_list` if Excel flag set).

#### **total**, **total2**
- Print subtotal per order and grand total for all processed trips.

#### **chk_ordre**
- Handles all filtering logic for which orders to include (see above).

#### **xls_hode, skriv_list** (Excel export functions)
- Write Excel-compatible header and detail lines to a dedicated file (`lwexpfr`).

---

### PDF Handling

When PDF output is requested (`l_poff = '1'`):
- The program generates spool file information via QSPRILSP API.
- Calls separate routines for generating XML (`xml_create`), launching PDF preview (`pdf_preview`), and closes the printer file.

---

### External Program Calls

- **RS725R**: Fetch route description text.
- **FU706R**: Fetch latest status code for order.
- **AP627R**: Generate XML for report.
- **AP621R**: Start PDF preview in browser.
- **QSPRILSP**: API to retrieve spool file attributes.
- **AB710R**: End batch job ID.

---

### Integration with Files/Tables

- **fohelb**: Order header
- **fodtl1**: Order detail
- **rkunl1**: Customer master
- **vvarl1**: Item master
- **vvenl1**: Item/unit master (for dimensions/weight)
- **vltyl1 / votyl1 / ra17l1 / fkprl1 / afirl1**: Various codes and lookup tables

---

## Versioning and Change History

- The code contains detailed version comments, documenting enhancements (route number expansion, PDF, project fields, Excel export, etc.).

---

## Summary

**This program:**
- Reads order headers for a given company, (optionally) route, warehouse, and date.
- Filters orders based on delivery types, process codes, and statuses.
- For each qualifying order, fetches details and item master data, prints structured summary including item, weight, and volume.
- Prints summary sub-totals and grand totals.
- Optionally outputs results as PDF or as an Excel-compatible file.
- Is modular, calling external programs for special logic (customer, project, status, route text, etc.).

**Key Takeaway for New Developers:**
- The main logic is in the subroutines, especially `chk_ordre`, `behandle`, `vare`, and the Excel/PDF routines.
- Much of the logic is file-driven (record-level operations) and has been adapted over time for integration and export features.
- Understanding the business rules implemented in `chk_ordre` is crucial for onboarding or modifying filtering behavior.
- PDF and Excel support is managed via conditionally executed routines, using additional parameters and APIs.

---

**Note:** The Norwegian field names (e.g. kjøre, liste, kunde, vare) and comments indicate specific business logic, which may require further clarification with business users or translators for absolute precision.