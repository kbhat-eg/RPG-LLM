# Documentation: IT119R – Update Cost Centres from NAV

## Overview

**Program:** IT119R  
**System:** ASNAVIOKO  
**Description:** Updates cost centre records (kostnadsbærere) based on data received from NAV (likely an external system).  
**Author/History:** Created 26.02.2014 by "ask" as a new program.

This program is a service-style RPG application responsible for maintaining (insert/update/delete) cost centre master data in the `RA28LU` physical file. It is designed to be called with parameters specifying the action and data; the logic then performs the corresponding file operation.

---

## Purpose and Business Logic

- **Target Entity:** The cost centre master file (`RA28LU`), which stores cost centre codes and related metadata.
- **External Integration:** Receives data from NAV (an external system) for synchronization.
- **Operation Mode:** The program is parameter-driven, supporting three operations:
  - **INSERT:** Add a new cost centre record.
  - **UPDATE:** Modify an existing cost centre record.
  - **DELETE:** Remove a cost centre record.

The program also manages audit fields such as update date/time and user.

---

## Structure and Flow

### 1. File Declarations

```rpg
fra28lu    uf a e           k disk    rename(ra28pfr:ra28lur)
```
- **RA28LU** is the main file, renamed in the program as `RA28LUR` (for output).
- File is keyed, externally described, and used for both read and write operations.

---

### 2. Parameter Handling

#### Input Parameters (via *ENTRY plist)
- **p_firm**: Company code (like `rebfir` field)
- **p_comd**: Command (`INSERT`, `UPDATE`, `DELETE`)
- **p_parm**: Data payload (2048 bytes, contains cost centre code and description)
- **p_user**: User ID
- **p_stat**: Status flag (1=success, blank=error)

#### Data Structure for Parameter
```rpg
d d_parm          ds          2048
d  d_bkod                        4
d  d_besk                       30
```
- `d_bkod`: Cost centre code (char, 4 bytes)
- `d_besk`: Cost centre description (char, 30 bytes)

The program expects `p_parm` to be a packed string containing these fields.

---

### 3. Key Variables and Audit Fields

- **w_firm**: Work variable for company code
- **w_bkod**: Work variable for cost centre code (numeric)
- **w_date/w_time**: Date and time stamps (ISO format), set at start of execution for audit purposes

---

### 4. Main Program Logic

#### Parameter Preparation

- Copies `p_parm` into `d_parm` DS for field extraction.
- Calls `red_num` and `red_flt` subroutines (see below) to sanitize and convert fields.

#### Command Dispatch

- Uses a `SELECT` block to branch based on `p_comd`:
  - `INSERT` → `nyrec` subroutine
  - `UPDATE` → `oppdrec` subroutine
  - `DELETE` → `sletrec` subroutine

#### Program Termination

- Sets LR on and returns.

---

### 5. Subroutine Details

#### a. *inzsr (Initialization)

- Defines *ENTRY parameter list.
- Builds a key list for record access: company + cost centre code.
- Captures current date and time for audit fields.

#### b. red_num (Sanitize Numeric Fields)

- Placeholder: No implementation in provided code. Intended for replacing blanks with zeros in numeric fields if needed (not used here).

#### c. red_flt (Edit Numeric Fields)

- Converts `d_bkod` (char) to numeric (`w_bkod`) using `%dec`.
- This conversion is critical because the database key and field are numeric but input arrives as char.

#### d. nyrec (Insert Record)

- Checks if the record exists using `chain` on the key.
- If not found:
  - Populates fields (`rebfir`, `rebkod`, `rebtxt`, `rebdat`, `rebtim`, `rebusr`) from parameters and audit fields.
  - Writes a new record.
  - Sets `p_stat` to '1' (success).

#### e. oppdrec (Update Record)

- Locates record by key.
- If found:
  - Updates description, date, time, and user.
  - Issues an `update`.
  - Sets `p_stat` to '1'.

#### f. sletrec (Delete Record)

- Locates record by key.
- If found:
  - Deletes the record.
  - Sets `p_stat` to '1'.

#### g. *pssr (Error Handler)

- Sets status to blank.
- Ends program with LR on.

---

## Design Notes and Conventions

- **Parameterization:** All business data arrives via a single 2048-byte parameter, parsed into a DS. This encapsulates all input fields, allowing for easy extension.
- **Status Flag:** `p_stat` is used to communicate success ('1') or error (blank) back to the caller.
- **Audit:** All writes/updates capture current date/time and user for traceability.
- **File Keying:** All file operations are keyed by company and cost centre code, ensuring company-level data isolation.
- **Subroutine Layout:** Standardized subroutine blocks for each operation, error handling, and initialization.
- **Field Conversion:** Explicit conversion from char to numeric for cost centre code, accommodating external (NAV) data formats.

---

## External and Inter-Module Relationships

- **NAV Integration:** The program is designed to be called by an external process (possibly a NAV interface) that passes data in the agreed format.
- **RA28LU File:** Central cost centre master, likely used by other financial and reporting modules.
- **User ID:** Expects the calling process to provide a valid user identifier for audit.

---

## Potential Extension Points

- **red_num:** Currently not implemented, but can be used if future numeric fields require blank-to-zero conversion.
- **Parameter DS:** Can be expanded to accommodate more fields if NAV integration expands.
- **Error Handling:** Currently basic; can be enhanced with logging or more granular status codes.

---

## Summary Table

| Subroutine | Purpose                  | When Called         | Outcome                        |
|------------|--------------------------|---------------------|--------------------------------|
| *inzsr     | Initialization           | Program start       | Prepares keys, audit fields    |
| red_num    | Sanitize numeric fields  | Always              | (No-op, placeholder)           |
| red_flt    | Convert code to numeric  | Always              | Sets `w_bkod`                  |
| nyrec      | Insert record            | p_comd = 'INSERT'   | Writes new cost centre         |
| oppdrec    | Update record            | p_comd = 'UPDATE'   | Updates cost centre            |
| sletrec    | Delete record            | p_comd = 'DELETE'   | Deletes cost centre            |
| *pssr      | Error handling           | On error            | Sets status, ends program      |

---

## Key Takeaways for New Developers

- This program is a backend service for cost centre master data maintenance, tightly coupled to the NAV integration format.
- All data is passed in as parameters; no user interaction or display I/O.
- File access is always by company and cost centre code.
- Auditability is built-in via date, time, and user fields.
- Extension is straightforward via the parameter DS and subroutine structure.

If you need to adapt this program for new fields or commands, follow the established patterns for parameter parsing, field conversion, and file operations.