# RPG Program FO501R Overview

This program is an ILE RPG application (written in fixed-format RPG IV) designed for interactive inquiry ("spørring") in a register of "bonger" (receipts or tickets) within a business system named ASOFAK.

Below is an explanation of the key components and structure:

---

## Title and Documentation

- **/TITLE** gives the program name and a short description.
- The block of comments provides:
  - System name (`ASOFAK`)
  - Program name (`FO501R`)
  - Description (`Spørring på bongregister` - Inquiry on receipt register)
  - Version and change log
  - Special usage notes and indicator explanations

---

## Indicator Usage

The program makes extensive use of classic RPG indicators for controlling display, file access, and flow. For example:
- `LR` – Last record, ends the program
- `10` – Roll key
- `12` – Display subfile
- `13` – Display control
- `14` – Clear subfile
- `15` – Subfile end
- Ranges 31-59, 60-69 etc. serve specific user, file, and internal flow purposes

---

## File Declarations (`F-specs`)

Several logical files are defined, all `DISK` files with various record formats, all renamed for local use:

- `bohel3`, `bohel2`, `boheld`, `bohele`: Various versions of the "bong header" file for different sequence access.
- `rkunl1`: Customer master file
- `fo501d`: Display file, with subfile support (`SFILE(b1sfl:w_srrn)`)

---

## Local Data Area and Key Variables (`D-specs`)

- The User Data Structure (UDS) is used to extract user, firm, and name information from the local data area (LDA).
- Several standalone fields are defined for keys, working fields for subfile/page control, and constants.
- Examples:
  - `w_srrn`, `w_sfrn`, `w_ssrn`: Subfile record numbers
  - `w_seqe`: Sequence type for sorting/positioning (e.g., by order, date, customer)
  - `c_sfil`: Constant controlling the size of subfile pages
  - `nummer`: A string constant of all digits (used for validation)

---

## Subfile Concepts and Screens

- **Subfiles** allow pages of data to be displayed/processed for the user in an interactive session (scrollable “lists”).
- Screens:
  - `B1SFL` – Subfile record
  - `B2CTL` – Subfile control record
  - `B2CMD` – Command screen

---

## Mainline Logic

The mainline is structured with labeled tags and `GOTO` statements forming a main loop (common in older RPG).

### High-Level Flow

1. **b2taga:** Start by displaying the command screen (`write b2cmd`)
2. **b2tagb:** Main processing loop
   - Calls subroutines to display/refresh the subfile data (`exsr dsp_subfile`)
   - Processes function keys using `SELECT/WHEN` (e.g., Roll, Inquiry, Refresh, Positioning)
   - Handles positioning if user enters search keys (by bong, order, customer, etc.)
   - Goes back to command screen or main processing as required
3. **avslutt:** Program exit, with setting `*INLR = *ON`

---

## Subroutines

### `spørring`
Stub placeholder for inquiry logic.

### `forny`
Refreshes data by re-positioning and refreshing the subfile based on sequence key.

### `posisjoner`
Positions the cursor/records according to user entry (bong, order, date, or customer). Calls appropriate `SETLL` to sequence access, then refreshes subfile and clears positioning fields.

### `subfile`
Handles the interactive subfile. Reads changed records, processes user "options" (e.g., '5' for view, '6' for print), and updates the subfile accordingly.

### `clr_subfile`
Clears the subfile control record, resets subfile/page counters, and relevant indicators.

### `crt_subfile`
Populates the subfile. Reads records by current sequence, checks for overflow, filters by firm and year, looks up customer names, and writes to the display subfile.

### `dsp_subfile`
Displays the subfile if it contains records, else presents the command screen.

### `vise`
Calls program `BO310R` to display a given bong (passing `w_firm`, `b1aarr`, `b1wsid`, `b1bong`).

### `skriv`
Stub for "print" functionality.

### `*inzsr`
Initialization routine.
- Establishes key lists for various queries.
- Sets up firm and year, preloads first page of data into subfile.

---

## Key/Chain Lists

Multiple `KLIST` definitions create keys for SETLL/CHAIN operations for random access to the different files, by various fields (bong, order, date, customer).

---

## Important Notes

- **Subfile Paging:** The program supports loading a page of records at a time (size controlled by `c_sfil`), with navigation and refresh logic.
- **Function Keys:** Multiple function keys are supported for search, roll, refresh, etc.
- **Multisequence Logic:** The user can search/position by bong, order, date, or customer (changes access sequence).
- **Customer Name Lookup:** When loading the subfile, customer names are fetched from `rkunl1` using a `CHAIN`.

---

## Summary

This program is a traditional RPG interactive inquiry screen for a receipt register. It employs indexed file access, subfiles for scrolling result sets, and classic indicator-based control. The code structure is mainline + subroutines, with a significant amount of user interface logic, subfile control, and keyed file operations. 

Main developer tasks will involve:
- Understanding the subfile mechanics and RPG indicators
- Modifying/expanding key logic to add new search or display features
- Integrating with other programs (such as for detailed receipt display or printing)
- Maintaining and troubleshooting display and data refresh logic

---

**If you are new to this code, first familiarize yourself with subfile handling in RPG, classic indicator usage, and the structure of the "bong" and customer files.**