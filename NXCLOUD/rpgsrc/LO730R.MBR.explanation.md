# RPG Program LO730R - Code Explanation

## 1. Overview

This RPG program, named `LO730R` (see the header doc), is designed to **recalculate amounts on order lines and order headers** in an order-management system. It processes each order line, calculates updated prices, discounts, totals, and updates various database files accordingly.

- **Language:** RPG IV (ILE RPG) fixed-format
- **Primary logic:** File I/O (CHAIN, SETLL, READE, UPDATE), mathematical calculations (price, discounts), program calls (to pricing subroutines), and database updates.
- **Domain:** Order processing (with Norwegian field/variable naming).
- **Customization:** Multiple enhancements over time, as shown in the header comments.

---

## 2. Included Files

The program uses several database files, typically defined in the `F` specifications with appropriate record formats and renames for clarity.

| File      | Type | Usage | Description                                  |
|-----------|------|-------|----------------------------------------------|
| `vltyl1`  | IF   | Input | Line type definitions                        |
| `lohelu`  | UF   | Input/Update | Order header (for update)          |
| `lohel1`  | IF   | Input | Order header (read-only)                     |
| `lodtlu`  | UF   | Input/Update | Order line (for update)            |
| `lodtl1`  | IF   | Input | Order line (read-only)                       |
| `fodtl1`  | IF   | Input | Order line (from another source, e.g. sales) |
| `lstsl1`  | IF   | Input | Status information                           |
| `vvarlr`  | IF   | Input | Item master                                  |
| `vvlel1`  | IF   | Input | Item location/warehouse info                 |

---

## 3. Data Structures & Variables

### Parameters (Entry Variables)
- `p_enor` - Status code (1 char)
- `p_firm` - Company/firm code
- `p_numm` - Order number
- `p_suff` - Order suffix

### Keys for Database Access
For each file, keys are defined as simple variables (e.g., `lohel1_numm`/`lohel1_suff`) for key lists.

### Working Variables
- `w_ipny`, `w_kpny` - Purchase price, cost price
- `w_rab1`, `w_rab2` - Discount percentages
- `w_sumi`, `w_sumk`, `w_sumr` - Accumulators for line amount, cost, discount
- `w_toti`, `w_totk`, `w_totr` - Accumulators for totals at the order level
- `w_prgr`, `w_vtyp`, etc. - Product price group, product type, etc.
- Many others used in calculations and file operations.

---

## 4. Main Program Flow

### a. Initialization (`*INZSR`)
- Receives parameters from the calling program.
- Sets up key lists for database access.
- Initializes working variables.

---

### b. Read Order Header

- Uses `CHAIN` to fetch the order header record into the structure `lohel1r`.

---

### c. Loop Through Order Lines

- Uses `SETLL` and `READE` to position and iterate through all order lines for the order.

#### For Each Order Line:

1. **Skip Text Lines:**
   - Line type is checked; if it indicates a text line, skip to next.

2. **Setup Working Variables:**
   - Copies prices, discounts, etc. from the order line record.

3. **(Conditional) Price Retrieval:**
   - If not from an LVR source and status code is set, call the `hntpri` subroutine to fetch updated prices/discounts.

4. **Calculate Line Totals:**
   - Quantity is adjusted for return lines (negative).
   - Calculates initial amount, applies up to three successive discounts, and recalculates the net.
   - Calculates cost as `cost_price * quantity`.

5. **Update Line Record:**
   - Updates the order line with new prices, discounts, and totals.
   - Sets audit fields (date/time/user).
   - Writes updates back to the database.

6. **Accumulate Totals:**
   - Adds line amounts to order-level total accumulators.

---

### d. Update Order Header

- After processing lines, the `oppdat` subroutine updates the order header with the new order totals (amount, cost, discount).
- Updates audit fields (date/time/user).

---

### e. Program Exit

- Sets `*INLR = *ON` to signal end-of-job and releases all files.
- Returns to the caller.

---

## 5. Subroutines

### Subroutine: `hntpri`

- Calls external programs (`VP701R`, `VL710R`) to fetch pricing information and product type for the current item.
- If the product type is not "D", updates purchase and cost price.
- For customer orders, optionally overrides cost/purchase price from the original order line.
- Resets discounts.

---

### Subroutine: `hent_prisgr`

- Calls external program (`VL712R`) to fetch the price group for the product.

---

### Initialization Subroutine: `*INZSR`

- Initializes key lists for all files used in the program.
- Sets up variables with entry parameter values.

---

## 6. Business Logic Notes

- **Pricing Engine Integration:** Price and type lookups are outsourced to external programs, suggesting a modular pricing subsystem.
- **Discount Calculation:** Three discount levels are supported; each is taken as a percentage of the current net after the previous discount.
- **Negative Quantities:** Returns (e.g., credit lines) are handled by making the quantity negative.
- **Audit Trail:** Updates on both line and header add timestamp and user for traceability.

---

## 7. Conventions

- **Naming:** Norwegian field/variable names (e.g., `linje`=line, `bestilling`=order, `hode`=header).
- **Audit Fields:** Typical fields for date, time, user, updated during modification for audit purposes.
- **File Renaming:** Files are often renamed at open for clarity and to allow multiple logical views.

---

## 8. Maintenance & Change Log

The source documentation lists modifications by version and date, e.g.:
- Expansion of price group from 1 to 2 characters
- Enhanced support for additional item information
- Support for negative quantities and tracking of returns
- Extended audit fields

---

## 9. Conclusion

This program is a **central batch utility for recalculating line and header totals on orders, incorporating updated pricing and discount logic, and maintaining audit trails**. It demonstrates solid RPG best practices for database access, modular pricing logic, and robust auditability.

If onboarding, focus on:
- Understanding the database files and their key structures
- The interaction with external pricing logic via CALL/PARM statements
- Navigating and maintaining subroutine logic for future enhancements