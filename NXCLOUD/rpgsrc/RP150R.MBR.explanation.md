# RPG Source Code Explanation

This program is an **ILE RPG** application for IBM i (AS/400) systems, handling maintenance ("vedlikehold") of wage earners ("Lønnstaker"). The code implements a subfile-based interactive user interface for displaying, creating, updating, copying, and deleting wage earner records. Below is a structured explanation to help with onboarding:

---

## 1. **Header and Metadata**

- The source code begins with an `H` specification, setting program options controlling debugging and date formatting.
- The comments provides info about the system, program name (`RP150R`), and history of changes, as well as indicator usage conventions.

---

## 2. **File Declarations (F-specs)**

- **filonl1, filonl2, filonlu:** Input/output disk files representing different logical views for accessing wage earner records, with `RENAME` for record formats.
    - `filonl1` and `filonl2` for listing/searching.
    - `filonlu` for update/write.
- **RP150d:** Display file (`workstn`), handling subfiles (list-style GUI) and display feedback (INFDS).

---

## 3. **Data Structure and Variable Declarations**

### A. **Local Data Area**

- Uses special UDS (User Data Structure) to access fields like user, firm, and firm name from LDA, a system-wide storage object for session variables.

### B. **Feedback Data Structure (DSPFBK)**

- For getting current cursor position on screen (`d_fcrn`).

### C. **Variables for Key Fields**

- Used to hold record keys for chaining, setll, etc., e.g., `ilonl1_rlnr`, `ilonl2_rnav`.

### D. **Subfile Management Variables**

- Variables like `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc., are for subfile paging, scroll/paging functionality.

### E. **Flags and Status Variables**

- `b_oppr`, `b_forn`, `b_anul`, `b_feil`: flags for 'create', 'refresh', 'cancel', 'error'.

### F. **Constants**

- `c_sfil`: subfile page size.

---

## 4. **Indicator Usage**

- RPG indicators (`*INxx`) are used to handle display attributes, function keys, workflow control, and error states.
- Usage is documented in comments, e.g., 10=Rollup, 11=Rolldown, 12=Display subfile, 31-79=Error/alert, 80-99=Work.

---

## 5. **Main Program Flow**

### **Entry Points and Main Loop (Tags and GOTO)**

- **b2taga / b2tagb:** The main two entry points alternate between sending the function key panel (`b2cmd`) and the subfile display (`dsp_subfile` subroutine, via `exsr`).
- **Function keys** are checked with `select/when` and controlled by indicators.

- Common commands:
    - `F3/F12`: Exit program (set LR, go to `avslutt`).
    - `F5`: Refresh subfile.
    - `F6`: Create new row.
    - `Page Up/Page Down`: Subfile paging.
    - `F21`: Home key.

### **Positioning and Subfile Handling**

- If positioning fields are entered, the `posisjoner` subroutine is called to locate the requested record, blank subfile, and refill with relevant page.

### **Program Termination**

- `avslutt` tag: Sets last record indicator (`*INLR`) and returns.

---

## 6. **Key Subroutines**

### **forny** — Refresh subfile

- If not on the first page, positions the subfile.
- Sets the file pointer using either `setll` on `ilonl1` or `ilonl2` (depending on search type).
- Calls `clr_subfile` and `crt_subfile` to clear and recreate the subfile contents.

### **posisjoner** — Position subfile

- Handles record positioning according to search key (`rlnr`) or name (`rnav`).
- Sets file position and reloads the subfile with relevant content.

### **subfile** — Process subfile rows

- Loops through displayed subfile records (`readc`), checking for selection options (edit/copy/delete/view).
- Calls appropriate subroutines (`xc2bld` for edit/view, `xk1win` for copy, `xd1win` for delete).
- Updates subfile as appropriate after each action.

### **xc1bld** — Add new row

- Handles the panel for adding a new record.
- Checks for duplicate keys, warns with a message if already exists.
- Calls general edit subroutine (`xc2bld`).
- Refreshes subfile if new row created.

### **xc1msg** — Existing row message

- Shows a message if attempting to create a row that already exists. Allows cancel or retry.

### **xc2bld** — Edit/Display row

- Shows window for creating, editing or viewing a row.
- Loads current row data if it exists, or blank fields if new.
- Performs validation (cannot be blank).
- Updates or adds the record as needed.

### **xd1win** — Delete row

- Confirm before deleting the row.
- Deletes the record from the update file.

### **xk1win** — Copy row

- Copies a row by loading its key, displaying the copy panel, checking for valid/unique key, and then invoking the edit/maintenance routine.

### **clr_subfile / crt_subfile** — Subfile management

- `clr_subfile` clears out the work area and resets paging variables.
- `crt_subfile` reads records to fill up the subfile up to a page size.

### **bck_subfile** — Page up in subfile

- Navigates backwards in subfile pages using `readp` (read previous).

### **dsp_subfile** — Display subfile

- Handles the display logic for the subfile, manages screen indicators appropriately.

---

## 7. **Initialization Subroutine**

- The `*INZSR` runs at program load.
- Initializes file keys/lists (`KLIST/KFLD`).
- Sets initial values (e.g., company field).
- Positions the database cursor to the beginning and fills the subfile for the first page.

---

## 8. **Subfile Display Records**

- The comments document the subfile and control record usage:
    - `B1SFL` – subfile record
    - `B2CTL` – control record for subfile
    - `B2CMD`, `C1BLD`, `C1MSG`, `C2BLD`, `D1WIN`, `K1WIN` – for command panels, edit/copy/delete pop-ups, etc.

---

## 9. **General Notes**

- The program is structured in an old-school tag/goto and subroutine pattern, typical of pre-RPG IV code but still common in IBM i shops.
- User actions are tracked via panel input fields and function key indicators.
- The subfile logic allows for efficient paging through potentially large datasets.

---

## 10. **Summary of Workflow**

1. **Startup:** Initialize, position to first page, display subfile.
2. **User interacts:** Navigates, pages, adds, edits, deletes, copies, refreshes subfile.
3. **Business logic:** Record actions handled via subroutines and function key processing.
4. **Subfile maintained:** Cleared and reloaded as necessary.
5. **Exit:** On `F3` or equivalent.

---

# **Onboarding Takeaways**

- **Familiarize yourself with indicator-based logic** and how *INxx values steer the workflow.
- **Understand subfile processing**, as this is the backbone of data display and paging.
- **Check display file DDS** (`RP150d`) to see exact field/indicator mapping.
- The program is modularized by subroutines, so you can focus on one function at a time for maintenance or enhancement.

---

**Tip:** Test the program interactively to see how display, add, edit, copy, and delete are surfaced in GUI; correlate actions with indicators and subroutines for best understanding.