# RPG Program Explanation: RK677R

This RPG program (RK677R) is designed for the IBM i (AS/400) system. Its primary purpose is to print a report of customers who have exceeded their credit limit, including balances from a special "memo" account. Below is a structured explanation of its components and logic, aimed at onboarding new developers.

---

## 1. **Header & Program Metadata**

```rpg
 h option(*nodebugio) datedit(*dmy)
```

- **`option(*nodebugio)`**: Excludes input/output operations from debug.
- **`datedit(*dmy)`**: Sets the default date format for editing as day/month/year.

The comments detail program name (RK677R), system, description ("Printout of exceeded credit limit"), and change history.

---

## 2. **File Declarations**

```rpg
 frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
 frkmel1    if   e           k disk    rename(rkmepfr:rkmel1r)
 frk677p    o    e             printer oflind(*in30)
```

- **`frkunl1`**: Input file, customer master, renamed internally to `rkunl1r`.
- **`frkmel1`**: Input file, memo balance file, renamed internally to `rkmel1r`.
- **`frk677p`**: Output printer file. **`oflind(*in30)`** uses indicator 30 for overflow (write page header on new page).

---

## 3. **Data Declarations**

### a. User Data Section (UDS)

```rpg
 d                uds
 d  l_wsid               901    910
 d  l_user               911    920
 d  l_fgrp               931    933
 d  l_firm               944    946  0
 d  l_fnav               951    980
```

- User/session/firm variables mapped to indicator area.

### b. Variables for Keys

```rpg
 d rkmel1_kund     s                   like(rkkund)   // Customer number for memo file
 d w_firm          s              3  0                // Firm number
```

### c. Variables for VAT Calculation

```rpg
 d w_stat          s              1
 d w_mvak          s              1
 d w_mvtx          s             30
 d w_mvas          s              6  2
 d w_mvat          s              5  4
 d w_mvaf          s             10  9
 d w_bpro          s              5  2
 d w_date          s               d   datfmt(*iso)
```

- Used for interacting with a callable program (`RS205R`) for VAT percentage lookup.

---

## 4. **Main Logic**

### a. **Initialization: Read First Customer**

```rpg
 c     rkunl1_key    setll     rkunl1r
 c     rkunl1_key    reade     rkunl1r
```
- Positions and reads first customer record.

---

### b. **Main Processing Loop**

```rpg
 c                   dow       *in60 = *off
```
- Loop until EOF (`*in60`).

#### 1. **Read Memo Balance for Customer**

```rpg
 c                   eval      rkmel1_kund = rkkund
 c     rkmel1_key    chain     rkmel1
```
- Sets key to current customer in memo file, reads the record.

#### 2. **Skip if No Credit Limit**

```rpg
 c                   if        rkgrns <= *zero
 c                   goto      neste
 c                   endif
```
- If customer's credit limit (`rkgrns`) is zero or negative, skip.

#### 3. **Amount Calculations**

```rpg
 c                   eval(h)   wkgrns = rkgrns * 1000
 c                   eval(h)   wkmems = rkmems * w_mvat
 c                   eval(h)   wksald = rksald
 c                   eval      wsumsa = wkmems + wksald
```
- Converts credit limit to base currency (likely from '000s).
- Computes memo balance including VAT.
- Adds account and memo balances.

#### 4. **Check for Exceeded Credit Limit**

```rpg
 c                   if        wsumsa <= wkgrns
 c                   goto      neste
 c                   endif
```
- If the sum of balances (`wsumsa`) does not exceed credit limit, skip.

#### 5. **Handle Printer Overflow**

```rpg
 c                   if        *in30 = *on
 c                   write     a1hdr
 c                   eval      *in30 = *off
 c                   endif
```
- If a printer overflow occurred, print page header and reset overflow indicator.

#### 6. **Print Customer Details**

```rpg
 c                   write     d1det
```

#### 7. **Read Next Customer**

```rpg
 c     neste         tag
 c     rkunl1_key    reade     rkunl1r
 c                   enddo
```
---

### c. **Program End**

```rpg
 c     slutt         tag
 c                   eval      *inlr = *on
```
- Terminates program by setting last record indicator.

---

## 5. **Initialization Subroutine (`*inzsr`)**

```rpg
 c     *inzsr        begsr
```
- Runs automatically at program start.

#### **Builds Keylists for Files**

```rpg
 c     rkunl1_key    klist
 c                   kfld                    w_firm

 c     rkmel1_key    klist
 c                   kfld                    w_firm
 c                   kfld                    rkmel1_kund
```

#### **Move Firm Number**

```rpg
 c                   move      l_firm        w_firm
```
- Copies firm number from user data section.

#### **Call RS205R (Get VAT Rate)**

```rpg
 c                   eval      w_stat = *blank
 c                   eval      w_mvak = '3'
 c                   time                    w_date

 c                   call      'RS205R'
 c                   parm                    w_stat
 c                   parm                    w_mvak
 c                   parm                    w_mvtx
 c                   parm                    w_date
 c                   parm                    w_mvas
 c                   parm                    w_mvat
 c                   parm                    w_mvaf
 c                   parm                    w_bpro
```
- Initializes variables and calls an external program to get VAT details; stores VAT rate in `w_mvat`.

#### **Print Header**

```rpg
 c                   write     a1hdr
 c                   endsr
```

---

## 6. **Summary of Program Purpose & Flow**

1. **Setup:** Initializes keys, variables, and VAT rate.
2. **Main Loop:** For each customer:
   - Looks up memo balance.
   - Skips customers with no credit limit.
   - Sums up outstanding and memo balances including VAT.
   - If over credit limit, prints customer details.
3. **Output:** All customers exceeding their credit limit are reported.

---

## 7. **Business Context**

This program helps the company monitor customers whose total exposure (regular plus "memo" balances, including VAT) exceeds their allowed credit limit, supporting risk management and collections.

---

### **Key Terms**
- **Memo balance:** Possibly pre-invoice balances or pending charges not (yet) in the main account.
- **VAT:** Value Added Tax, added to memo balances for a more accurate debt picture.

---

### **Where to Extend or Change**
- Add more details to the report.
- Change credit limit logic.
- Integrate additional customer checks/logic.

---

**If you need details about a specific operation or field, ask for clarification on that part!**