# RPG Program Explanation: AP622R – Display of PDF Prints on Screen

## Overview

This program is written in ILE RPG (RPG IV) and is titled **"Skjermvisning av PDF utskrifter"**, which means "Screen display of PDF printouts" in Norwegian. Its purpose is to generate a URL/path for a PDF or scanned document in an archive, based on input parameters and data. The program is used to provide a link or search string (søkestreng) that other components, such as AP628R, will use to display or process documents like invoices, vouchers, or packing slips.

---

## Key Features

- **Input Parameters:** Receives information about document type, reference number, etc.
- **Dynamic Path Generation:** Builds a search string and replaces placeholders with real values.
- **Data Access:** Reads a path template from a database file.
- **Output:** Generates a link or path string that references the requested PDF/scanned document.
- **Separation of Concerns:** Only creates the link; further processing/display is handled elsewhere.

---

## Structure and Flow

### 1. Program Attributes

```rpg
H DECEDIT('0.') DATEDIT(*DMY.) option(*nodebugio)
H DftActgrp(*No)
```

- Sets decimal and date edit codes for display/print.
- Disables default activation group (for better resource management).
- `option(*nodebugio)` disables certain debugging features.

### 2. File Declaration

```rpg
fafpslr    if   e           k disk    rename(afpspfr:afpslrr)
```

- Declares a physical file `afpslr` (renamed record format) for reading keys and data (specifically, for retrieving archive paths).

### 3. Data Definitions

- **Parameters:** Strings for document type (`p_type`), year, number, reference, and the resulting search string (`p_soks`).
- **Working Variables:** For building up the search string and path (`w_bet1`, `w_brpt`, `prvpath`, etc.).
- **Key-related Variables:** These are used to access the properties file where the PDF path is stored (`afpslr_ufil`, `afpslr_uide`).
- **LDA Data:** Reads data from the *Local Data Area* such as firm ID, file name, etc.

### 4. Initialization (`*inzsr` Subroutine)

- **Parameter List:** Receives document type, reference, etc.
- **Key Construction:** Sets up key fields for file lookups.
- **Fetch Path:** Retrieves the preview path from an archive properties file using the key `ARCHPATH`.
- **Store Path:** The result is placed in `prvpath` for further use.

### 5. Mainline Processing

#### a. Blank Path Initialization

```rpg
eval w_brpt = *blanks
```

#### b. Generate Archive Search URL

```rpg
exsr gen_sokurl
```

- Calls `gen_sokurl` to build the URL/search string.

#### c. Document Type Handling (Legacy, now skipped)

```rpg
if 1 = 2
   select
      when p_type = 'FAKTURA   '...
      ...
   endsl
endif
```

- This code is *disabled* as `1 = 2` is always false.
- Previously handled different types with specific logic (example: invoice, voucher, dispatch note).

#### d. Set Result String

```rpg
if %trim(prvpath) <> *blanks
   eval p_soks = %trim(prvpath)
endif
```

- Only continue if the generated path isn't blank.
- Sets the output parameter to the built path.

#### e. End Program

```rpg
eval *inlr = *on
return
```

- Cleans up program resources and ends.

---

## Key Subroutines

### gen_sokurl (Generate Search URL)

- **Purpose:** Replaces placeholders in the template path (`prvpath`) with actual parameter values.
- Looks for markers like `{fi}`, `{ty}`, and `{ref}` and swaps them for firm ID, document type, and reference number, respectively.
- Uses `%scan` to find the position, `%subst` to build the replaced string, and `%char`/`%trim` for formatting.
- Stores the result in `prvpath`.

#### Example Replacement (in pseudocode):

- If `prvpath = "/pdf/{fi}/{ty}/{ref}.pdf"`
- Replaces `{fi}` with the firm number, `{ty}` with the document type, `{ref}` with the reference number.

### ex_faktura / ex_bilag / ex_pakkseddel

- **These subroutines build search strings for different document types** (invoice, voucher, packing slip).
- They are currently not used as the block that calls them is disabled.
- For each document type, builds a query string composed of type, number, firm, year, etc.

---

## Detailed Data Handling

### Reading from LDA (Local Data Area)

- Retrieves information such as firm number, user ID, workspace ID, etc., for use in path replacement.

### File Access

- Reads the archive path template from the `afpslr` file (for the key `'ARCHPATH'`).

---

## Historical Comments and Versioning

- The program has evolved (see the comments with `6.20`, `6.21`, `6.22`) to:
    - Change how placeholders in path templates are handled (now replaced with actual values).
    - Simplify: Now only generates the link, and the further steps are performed in another program (`AP628R`).

---

## Summary Table

| Component       | Purpose                                                        |
|-----------------|----------------------------------------------------------------|
| Parameters      | Receive type, reference, firm, date, etc.                      |
| File Access     | Retrieves path template from archive properties file           |
| Path Generation | Replaces placeholders with parameter values                    |
| Output          | Sets output parameter with the built search/path string        |
| Legacy Support  | Subroutines for old search string formats, now unused          |

---

## Typical Workflow

1. **Program called with parameters** (type, reference, etc.)
2. **Reads path template** for archive from properties table/file.
3. **Replaces placeholders** with real values.
4. **Returns** the resulting path/search string for use by another program.

---

## Key RPG Concepts

- **Parameters with `*ENTRY PLIST`**: Old-style subprocedure call with explicit parameter passing.
- **Local Data Area (LDA)**: Common area for passing data between programs.
- **Subroutines**: Logic modularization, e.g., `gen_sokurl`, `ex_faktura`, etc.
- **%BIFs**: Modern built-in functions like `%scan`, `%subst`, `%trim` for string manipulation.
- **File Access via CHAIN**: Random access into a keyed database file.

---

## Conclusion

**AP622R** is a utility RPG program for generating dynamic, parameterized links to archived PDF documents, primarily to support document viewing workflows in a broader IBM i system. It leverages flexible path templates, retrieves necessary data from files and the LDA, and outputs a ready-to-use search string for further processing.