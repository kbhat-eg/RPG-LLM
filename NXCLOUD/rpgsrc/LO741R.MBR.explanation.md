# RPG Program LO741R â€“ Explanation and Onboarding Guide

This RPG/400 program is designed for IBM i (AS/400, iSeries, Power Systems) and provides a subfile-based green-screen utility to list and analyze order numbers (`bestillingsnummer`) with incorrect references according to the NEB standard. It's typical for order and inventory management in a Norwegian business context.

---

## 1. **Header & Comments**
- The `h` spec sets options: disables debug I/O and specifies date format as DD/MM/YY.
- The comments outline the purpose: **lists order numbers with "feil ref NEB standard"** (incorrect reference per NEB standard).
- It lists changes/history and indicator usage.

---

## 2. **File Declarations**
Each `f` spec defines usage of physical/logical files or display files:
- **Database Files:**  
  - `lohel1`, `lodtlr`, `vvarl1`, `jvarl1`, `vvenl1`, `vvlel1`  
    Used for order headers, order details, product master, etc., with renaming for local naming clarity.
- **Display file:**  
  - `lo741d` (workstn) with subfile `b1sfl` indexed by `w_srrn`.

---

## 3. **Data Structures & Variables**
- **Local Data Area:**  
  - `l_user`, `l_firm`: Passed-in context information.
- **Parameters:**  
  - `p_numm`, `p_suff`: Order number and suffix, input to the program.
- **Key variables:**  
  Variables to construct composite keys for record access.
- **Working variables:**  
  Subfile paging (`w_stel`, `w_spge`, etc.), status/flags, error flags, etc.
- **Constants:**  
  - `c_sfil`: Subfile page size (10).

### **Subfile Variable Purpose**
- `w_stel`, `w_spge`, `w_srrn`, etc. manage the subfile pagination and cursor.

---

## 4. **Indicators**
- Range of indicators are mapped for subfile processing, screen controls, error handling, and working purposes (see comments).

---

## 5. **Main Program Logic**
### **Entry and Initialization**
- *inzsr initializes the main working variables, keys, and loads subfiles:
  - Reads parameters.
  - Prepares database keys.
  - Checks for order header existence in `lohel1`.
  - If found, sets up for reading order details (`lodtlr`) and fills the subfile.

### **Main Processing Loop**
- Handles display and command keys in a loop.  
  **Command key processing:**
  - `F3/F12` (*inkc/*inkl): Exit
  - `F5` (*inke): Refresh subfile
  - `ROLL` (*in10): Page
  - `HOME` (*in21): Cursor home
- Calls subroutines for subfile processing, error checking, etc.

### **Program End**
- Sets *INLR = *ON to end the program.

---

## 6. **Subroutines Explained**

### **forny**
- Refreshes the display/subfile, possibly after user input or function keys.

### **subfile**
- Reads all records on current subfile page.
- If user marks a line (e.g., with option 5), displays more info about the line (using `b1win` window), resets selection, and updates display.

### **clr_subfile**
- Clears the subfile and relevant state variables.

### **crt_subfile**
- Loads the subfile with detail lines from `lodtlr`.
- For each line, checks for errors by calling `sjk_line`, and only displays lines with an error status.
- Manages page size and subfile record numbers.

### **dsp_subfile**
- Controls the display/refresh of the subfile and main screen.

### **sjk_line**
- Runs a sequence of checks to detect error types:
  - Calls external program `VL710R` to check for diverse item types, and sets status code.
  - Calls `sjekk_ean` to check EAN/GTIN numbers.
  - Checks NOBB number existence.
  - Runs `sjekk_match` to check if the item exists in another register.
  - Additional checks (commented out or only for documentation) on units and overridden texts.

### **sjekk_ean**
- Calls external program `VE713R` to validate EAN (GTIN) numbers.
- Sets error flag if not found or invalid.

### **sjekk_match**
- Checks if the item is found in the `jvarl1` register. Sets error if not.

### **sjekk_enh** (not actively called)
- Checks for unit mismatches via the `vvenl1` register.

### **sjekk_tekst** (not actively called)
- Checks for overridden item descriptions.

---

## 7. **Key Lists**
Composite keys (`klist`) are defined for each major file access pattern, helping to precisely position or access records in multi-keyed physical/logical files.

---

## 8. **External Calls**
- The program calls external RPG programs (`VL710R`, `VE713R`) to do item type and EAN validations.

---

## 9. **Display & Subfile Handling**
- The application is built around a subfile display pattern:
  - Data is loaded into the subfile, paged, and user options may pop up additional detail windows.
  - Only lines with errors (as defined by NEB standard) are shown.

---

## 10. **Error Handling / Codes**
Status codes (`w_stat`, `b1stat`) are set to:
- 'G': Error in GTIN number
- 'N': Error in NOBB number
- 'D': Item is a diverse number
- 'V': Item not in VA register
- 'E': Error in purchase unit
- 'T': Overridden item text

These codes are used to populate columns/fields shown to the user and guide their review.

---

# **Summary for New Developers**
- **Purpose:** Show order details (that break certain standards) in a page-driven subfile, with error diagnostics.
- **How it works:**  
  1. Receives order number (and suffix) as input.
  2. Validates existence of order header.
  3. Reads order details and checks them against NEB standards via subroutines and external validation programs.
  4. Loads errors into a subfile for user review and paging.
  5. User can page, refresh, and view details for each error line on demand.

**Key learning areas for maintainers:**  
- Subfile paging logic.
- How and why external programs are called for validation.
- How error conditions are detected, flagged, and displayed.
- The usage of indicators for green screen display logic.

**Good starting points:**
- Read the subroutines: `crt_subfile`, `sjk_line`.
- Follow the subfile flow (paging, reading, and user action handling).
- Explore the external validation programs for deeper error-diagnostic logic if relevant.

---

**Note:** This code is primarily in Norwegian, with some business-specific naming; some domain adaptation will be required for deep changes.