# RPG Code Explanation (Program: FM500R)

This is a classic ILE RPG program for IBM i (AS/400), built primarily for interactive use with subfiles (screen lists) and keyed database access. It's focused on managing "card/invoice agreements" (Kort/fakt.avtaler) and includes a rich set of comments and legacy change tracking.

---

## 1. Program Overview

- **Header (`H`) Spec**
  - `option(*nodebugio)`: Disables debug I/O (for performance or security).
  - `datedit(*dmy)`: Sets default date format (day/month/year).

- **Comment section**: Contains system info, program version, description, and change log, mostly in Norwegian.

---

## 2. File Declarations

- **Physical/Logical Files (`F` Spec)**
  - `fmkalr`, `fmkal1`, `rkunl1`:
    - Database files, accessed by key (`K`), input only (`I`), externally described (`E`).
    - Renamed record formats for local use.
  - `fm500d`:
    - Display file (`CF`), using subfile `b1sfl` with relative record number `w_srrn`.
    - `infds(dspfbk)`: Associates display feedback data structure for cursor management, etc.

---

## 3. Data Structure & Variables

- **Parameters (`D` Spec)**
  - `p_firm`, `p_kund`, `p_kpro`, `p_kftp`, `p_ktsq`: Parameters, "like" database fields.

- **Display Feedback**
  - `dspfbk`: Data structure for display file feedback (e.g., current cursor record).

- **Key Variables**
  - Holds key field values for file access.
  
- **Working Variables**
  - Subfile positioning and counters: `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`
  - Other helpers: `w_seqe`, `b_valg_ok`, etc.

- **Constants**
  - `c_sfil`: Subfile page size (8).

- **Explanations**
  - Extended comments describe meaning of various work variables, especially those related to subfiles.

---

## 4. Program Flow (Main Loop)

- **Entry Point**
  - Sets up subfile, processes function keys, and manages returning to main display.

- **Screen Flow:**
  - **b2taga / b2tagb tags:**  
    - These are loop return points for displaying (and refreshing) the subfile.
  - **Function Key Handling (select/when):**
    - *F3*/*F12* (inkc/inkl): Exit (goto avslutt)
    - *F5* (inke): Refresh subfile
    - *F6* (inkf): Call maintenance program `FM100R`
    - *PageUp/PageDown* (in10/in11): Page subfile forwards (`crt_subfile`) or backwards (`bck_subfile`)
    - *Home* (in21): Set cursor positioning

- **Subfile Processing:**
  - Reads subfile for selection (via `readc`, check if user picked a record)
  - If a selection is made (`b_valg_ok`), program ends (goto avslutt)

- **Program End:**
  - Sets LR indicator and returns (ends the program).

---

## 5. Subroutines

### A. forny (Refresh Subfile)
- Repositions subfile, clears and recreates its content based on updated data.

### B. subfile (Process Subfile)
- Alternates cursor indicator (in22)
- Reads/display subfile records, checks for selection (if `b1valg=1`)
- If a record is selected, sets parameter fields and sets `b_valg_ok = *on`.

### C. clr_subfile (Clear Subfile)
- Sets subfile control indicators (`in14`, `in15`) to clear subfile and its status variables.

### D. crt_subfile (Create/Load Subfile Page)
- Fills the subfile with up to `c_sfil` (8) records for the current page.
- Reads records, checks keys, populates subfile fields.
- Calls `avt_type` to set descriptive "agreement type" text.

### E. avt_type (Set Agreement/Card Type Description)
- Maps internal `fmkftp` values to human-readable types (e.g., 'VISA Purchas.').
- Handles unknown types as 'Ukjent'.

### F. bck_subfile (Page Backwards)
- Reads back in the file to fill a previous page of the subfile.
- Moves the "window" of the subfile page backward.

### G. dsp_subfile (Display Subfile)
- If subfile has records, sets display indicators and shows the subfile page.
- Updates cursor position via display feedback.

### H. *inzsr (Program Initialization)
- Sets up parameter passing and keys.
- Initializes from entry parameters and positions the file for the customer.
- Fills the first subfile page.

---

## 6. Indicators

- In RPG, numbered indicators control display attributes and program logic:
  - `*INLR` (Last record): End of program
  - `*IN10`, `*IN11`, etc: Function keys (mapped to, e.g., Roll/Up/Down)
  - `*IN12`-`*IN15`, etc: Subfile control (display, clear, end, etc)
  - `*IN21`, `*IN22`: Home key and cursor placement
  - `*IN30`+: Protecting fields, error message flags
  - `*IN80`+: Work indicators

---

## 7. Subfile Details

- Subfiles are used to present lists for selection. RPG uses them heavily for interactive screens:
  - `b1sfl`: Subfile record
  - `b2ctl`: Subfile control record
  - `b2cmd`: Command screen

---

## 8. Summary

- **Main Purpose:** Display and allow selection of "card/invoice agreements" for a customer, with paging, refreshing, and detail viewing.
- **Interaction:** User browses paged subfile, can select agreements, refresh, page, or jump to maintenance program.
- **Legacy:** Heavy use of classic RPG fixed-form conventions, indicators, and subfile mechanisms, typical of IBM i green screen applications.

---

### Onboarding Notes

- Familiarize yourself with subfile programming in RPG.
- Understand indicator usage (often not documented outside the code itself).
- The data files (`fmkalr`, `fmkal1`, `rkunl1`) and display file (`fm500d`) definitions are crucial for field meanings and screen layouts.
- The code is well-commented for maintenance, especially regarding user interface flow and subfile logic.

If you are new to this style, reviewing a basic introduction to RPG subfiles and indicator handling will be invaluable. The core logic is consistent with many IBM i green screen inquiry programs.