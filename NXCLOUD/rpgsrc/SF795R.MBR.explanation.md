# Explanation of RPG Source Code: SF795R

This source code is written in IBM ILE RPG (RPG/400 style), and the comments and naming are primarily in Norwegian. The program concerns updating a customer parameters file and appears to manage various customer/parameter registers in a business system.

---

## Program Overview

- **Header Section**
  - `h option(*nodebugio) datedit(*dmy)`: Sets program options (no debug I/O, date edit is day/month/year).
  - The comments describe the program as "Endring av kunde-paramaterfil, Oppdateringen" (Changes to customer parameter file, update).
  - Change log with author and versioning is present.

---

## File Declarations (`F-spec`)

The program opens a number of physical (disk) files, some renamed for logical access:

- **Input/update/lookup files** for various registers:
  - `skpml1` (customer parameter main file) - input, keyed, disk, 25-byte key, with aid (display I/O) (likely the master).
  - `skpmlu` (update file for parameters) - update, external, keyed; renamed record format.
  - Many reference/lookup files for groups, categories, sales people, etc. Each is typically keyed and may be renamed.
    - Examples: `vahgl1` (alternative main group), `vaugl1` (alt. subgroup), `vogrl1` (overgroup), `vhgrl1` (main group), etc.

---

## Data and Key Definitions (`D-spec`)

- Variables to hold key fields for each lookup file (using `like()` for type alignment).
- General working variables, e.g.:
  - `w_firm`: Company code.
  - `w_slet`: Deletion flag/indicator.
  - `w_text`: Text to update in the description fields, typically 30 chars.

- **Data Structures:**
  - `skpml1_key`: 25-byte key split into company, type, code, choice.
  - **User space (`uds`)**: Extracts user, firm, etc., from positions in the *LDA (Local Data Area)*.

---

## Input Specifications (`I-spec`)

Classic RPG input mapping for `skpml1`. This section details how fields are mapped from record layouts depending on the value of some control fields. It's complex, supporting multiple subkeyings for the flexible customer parameter master.

Each block (with a comment, e.g., "Alt. Hovedgruppe", "Rabattgruppe", "Kundekategori", "Varenummer", etc.) defines how the input record layout should be interpreted for that context. Fields are mapped by positions inside the input record, with zero-filled or blank fields as appropriate.

---

## Mainline Logic (`C-spec`)

### 1. **Positioning**

```rpg
c                   exsr      posisjoner
```
- Runs the `posisjoner` subroutine to position to the correct starting point in the file.

### 2. **Processing Loop**

```rpg
c                   exsr      oppdat
```
- Calls the `oppdat` subroutine, which processes and updates the parameter records.

### 3. **Program End**

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets the last record indicator and returns, ending the program.

---

## Core Subroutines

### **oppdat**: Read and Update Parameter Register

- Reads `skpml1` records in a loop until EOF (`*in15 = *on`).
- For each record:
  - Checks for EOF and matching company code (`spfirm` = `w_firm`).
  - Based on `spkode` (code), calls one of many subroutines (e.g., `SP111R` for Hovedgruppe/Main Group) or takes action (skip/mark for deletion).
  - Subroutines typically look up descriptions for keys from the relevant register and set `w_text`.
  - If an update should occur, copies fields, finds/registers the key in `skpmlu`, and updates (or deletes) the appropriate record.

### **posisjoner**: Position File

- Sets blank/zeroed key values and positions (`SETLL`) to the start of the file.

---

## Lookup Subroutines (Examples)
For each group/category/etc., there is a dedicated subroutine, e.g.:

```rpg
c     sp111r        begsr
c                   eval      vahgl1_hgrp = spahgr
c     vahgl1_key    chain     vahgl1                             90
c                   eval      w_text = vfhtxt
c                   endsr
```
- For "alt. hovedgruppe" (alternative main group), sets the group code, chains (fetches) the record, and extracts the description text.

There are similar subroutines for undergroup, overgroup, customer category, sales person, etc., each using appropriate files/fields.

---

## Initialization Subroutine (`*inzsr`)

- Defines key lists (`KLIST/KFLD`) for all the file lookups used in the subroutines.
- Extracts the company code (`w_firm`) from the Local Data Area.

---

## Key Points for Onboarding

- **Purpose**: This program maintains/updates a complex customer parameter file, enriching it with descriptive text from several lookup files as needed.
- **File IO**: Extensive use of chained access (indexed lookups) and keyed updates/deletes.
- **Data Mapping**: Input records are variably interpreted depending on control fields (`spkode` etc.).
- **Subroutines**: Each type of parameter (main group, district, etc.) has its own fetch-from-lookup logic.
- **Control Fields**: Most decision logic is based on parameter code `spkode` and company code `spfirm`.
- **Local Data Area**: Used for extracting initializing context (company/user).

---

## Key Variables

- **spfirm, sptype, spkode, spvalg**: The core primary fields of each customer parameter record.
- **w_text**: The enriched description looked up (from relevant register) and copied to the update record if present.
- **w_slet**: Flag to mark if a record should be deleted.
- **w_firm**: Current company code from the Local Data Area.

---

## Recommended Steps for Understanding & Modifying

1. **Review Input Record Structures**: Know how various fields (group, code, selection, etc.) are mapped.
2. **Understand the Lookup Tables**: Each subroutine references a different register file.
3. **Modification**: To add new parameter types, add a new 'if spkode=' block and new subroutine.
4. **Testing**: Emulate record flows with company code and various spkode values for full coverage.
5. **Local Data Area (LDA)**: Be aware this is used to set the active firm (`w_firm`), so ensure any test/real environment has this set as needed.

---

## Summary Table

| Section         | Purpose/Content                                                      |
|-----------------|---------------------------------------------------------------------|
| File Decls      | Opens main parameter file, update file, and many reference files.    |
| D-specs         | Working vars, overlays, keys, local data area fields.               |
| Input Specs     | Maps input fields according to parameter code and context.           |
| Mainline        | Sequences startup, positioning, update processing, and shutdown.     |
| oppdat          | Reads each record, decides update logic using subroutines, updates.  |
| Subroutines     | Lookup description for each parameter type from the correct file.    |
| *inzsr          | Defines all necessary klist/kfld for keyed access on all files.      |


---

## Example Flow

1. **Startup**:
   - Loads company code from LDA.
   - Prepares key lists.
2. **Processing**:
   - For each parameter record (`skpml1`):
      - Identify the type (`spkode`).
      - Call subroutine to fetch description text if needed.
      - Update or delete associated record in the update file (`skpmlu`).
3. **End**:
   - Sets LR indicator and exits cleanly.

---

### Comments/Field Names

Many field names, comments, and labels are Norwegian. Here are some translations for clarity:

- **Hovedgruppe**: Main group
- **Undergruppe**: Subgroup
- **Kundekategori**: Customer category
- **Rabattkategori**: Discount category
- **Selger**: Salesperson
- **Lager**: Warehouse
- **Leverand√∏r**: Supplier

---

## TL;DR

This program processes a customer parameter file, updating each record by looking up and filling in description text from various reference files depending on the type of parameter (group, discount, category, etc.). It skips, updates, or deletes records depending on control codes and values, and is driven by a firm/company code initialized from the Local Data Area. The structure is extensible to new parameter types by adding further lookup subroutines and if-blocks.