# RPG Program Explanation

This IBM ILE RPG program (`RK601R`) is designed to print a report of duplicate customers in the customer register ("Utskrift av dubletter i kunderegisteret"). The code is written in "fixed format" RPG IV and is well commented, with Norwegian text for documentation and indicator usage.

Below, the main components and flow of the program are explained.

---

## 1. Header Specifications

```rpgle
h datedit(*dmy) option(*nodebugio)
```
- **h spec**: Sets edit code for dates (`*dmy` for day-month-year) and disables debug I/O.

---

## 2. File Definitions

```rpgle
frkunl2    if   e           k disk    rename(rkunpfr:rkunl2r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
f                                     prefix(x:1)
frk601p    o    e             printer oflind(*in30)
```
- **rkunl2**: Input file, keyed (`k disk`), renamed record format as `rkunl2r`.
- **rkunl1**: Input file, keyed, renamed record format as `rkunl1r`. Fields get prefix `x`.
- **rk601p**: Output file for printing. Overflow indicator: *IN30.

---

## 3. Data Definitions

### Customer Key
```rpgle
d rkunl1_kund     s                   like(rkkund)
```

### Local Data Area Fields (positions in the LDA)
```rpgle
T5.00d l_navn                300    300
T5.00d l_gate                301    301
...
d l_wsid                901    910
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Fields such as `l_navn`, `l_gate`, etc., are typically flags ("J" for "yes") indicating which fields to check for duplicates.

### Work variables
```rpgle
d ant             s              2  0
d w_ikke          s              1
d w_anta          s              5  0
d w_firm          s                   like(l_firm)
...
d w_kund          s                   like(rkkund)
...
```
- Various working storage variables for processing logic.

---

## 4. Main Loop - Reading Customer Register

```rpgle
c     rkunl2_key    setll     rkunl2                                 90
c     rkunl2_key    reade     rkunl2                                 90
c                   dow       *in90 = *off
   ... processing ...
c     rkunl2_key    reade     rkunl2                                 90
c                   enddo
```
- Sets lower limit (`setll`) and starts reading the file with a key list.
- Loops over all customer records for a selected firm until end-of-file (`*IN90`).

---

## 5. Duplicate Detection Logic

Within the main loop, the code checks if the current customer (`rkalfa`) matches the previous one (`w_alfa`).

```rpgle
c                   if        rkalfa = w_alfa
c                   exsr      xsrkont
```
- Calls subroutine `xsrkont` to check for actual duplicates, considering flags (name, address, etc.).

If a duplicate is found (`w_ikke = ' '`):
- **Increment** count (`ant`).
Otherwise:
- **Reset** count (`ant = 1`).

Further logic tracks and processes the number of duplicates:

```rpgle
c                   select
c                   when      ant = 1
... (store initial)
c                   when      ant = 2
... (output previous and current)
c                   when      ant > 2
... (output current)
c                   endsl
```
- When a second duplicate is found, both the first and second records are printed.
- For additional duplicates, only the new record is printed.

---

## 6. Subroutines

### a. **utskrift** (Printing Subroutine)
Handles the actual output of duplicate customer data to the printer file. It fetches detailed info from the input file for the given customer key.

Checks for overflow; if so, writes a header (`a1hdr`) before printing details (`d1det`).

### b. **xsrkont** (Duplicate Control Subroutine)
This subroutine checks the configured fields (name, address, post number, telephone, mobile) for equality according to the flags from the LDA.
- If any flagged field(s) differ between the current and previous record, `w_ikke` is set to `'J'` (not a true duplicate).

### c. **Initialization Subroutine (\*inzsr)**
Sets up the key lists and working variables, and writes the initial page header.

---

## 7. Indicators

- **Special Indicators**: e.g., *IN30 = Printer overflow, *IN90 = EOF for file operations.
- **Comment Table**: Documents how indicators 31-99 are used for errors, file operations, routines, etc.

---

## 8. General Flow

1. **Initialization** (\*inzsr): Key setup, clear work fields, write header.
2. **Input Loop**: Read customer records for a particular firm.
   - Check if current record matches previous based on the 'alfa' field.
   - Use subroutine to determine if it's a real duplicate, considering user flags.
   - Track and print duplicates according to the rules (first/second/more).
3. **Subroutines**: Manage printing and duplicate checking.
4. **End-of-Job**: Set last record indicator (*INLR) to end.

---

## 9. Business Rules

- Duplicates are determined by the 'alfa' field and further filtered by comparison of fields specified by the user (LDA flags).
- Handles multiple duplicates with special logic for the first and subsequent entries.
- Designed to work for one company at a time (`w_firm`).

---

## 10. Summary

**Purpose**:  
To print a list of customer register records that are duplicates, based on configurable criteria (name, address, etc.). Duplicates are checked and formatted, with details printed to a report file.

**Customization**:  
The fields checked for determining duplicates are controlled via flags, presumably set outside this program via LDA.

**Readability Tips**:  
- Most variables and comments are in Norwegian.
- Uses RPG fixed format; modern RPG IV ("free form") syntax would look different.
- Key lists and subroutines are central to the design.

**Onboarding**:  
A developer maintaining this program should understand RPG indicators, file/key handling, and the use of local data areas (LDA) for user-driven configuration.

---

**Note**:  
The code's formatting and fixed-form style are typical of legacy RPG IV programs and reflect real-world business processes in AS/400 (IBM i) environments.