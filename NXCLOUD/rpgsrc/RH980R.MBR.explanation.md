# RPG Source Code Explanation

This code is written in **IBM ILE RPG**, specifically in the fixed-format (RPG IV / RPGLE), and is used for parameter management in a general ledger ("hovedbok") extraction program.

Below is a structured walkthrough of the file with explanations targeting onboarding developers:

---

## **1. Header and Metadata**

```rpg
/TITLE  Utplukk av poster hovedbok - parameter
H datedit(*dmy) option(*nodebugio)
```
- `/TITLE` sets the source listing title.
- `H` specifies compiler options:
    - `datedit(*dmy)` - use DMY format for dates.
    - `option(*nodebugio)` - disables debug I/O.

### Program Documentation Block
The commented block below specifies:
- System: ASOKON
- Program: RH980R
- Description: Extraction of general ledger records (parameter selection screen)
- Change history, field indicator usage, etc., all in Norwegian.

---

## **2. File Specifications**

```rpg
fausrl1    if   e           k disk
frh980d    cf   e             workstn
```
- `ausrl1`: Input file (disk), keyed access.
- `rh980d`: Workstation file (for interactive display).

---

## **3. Data Structure and Field Definitions**

### Date Field Overlays

```rpg
d                 ds
d ldadat                         8  0
d  ldadag                        2  0 overlay(ldadat)
d  ldamnd                        2  0 overlay(ldadat:3)
d  lda�r1                        2  0 overlay(ldadat:5)
d  ldaaar                        2  0 overlay(ldadat:7)
```
- Defines a date packed into 8 digits, with overlays to access day, month, year portions.

### User Data Structure

```rpg
d                uds
d rhpkda                300    305  0
d rhpr�r                         4  0
d rhpper                         2  0
...
d rhpk40                         5  0
```
- Stretches of fields (likely for parameter or record data exchange between programs/screens).
- Many fields prefixed with `rhpk`, suggesting parameter keys.

### User, Company, and Name

```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Fields for user, company number, and company name; positioned for data structure mapping.

### Temporary/Working Fields

```rpg
d waar            s              4  0
d wmnd            s              2  0
d wpakod          s              2  0
d p_in03          s              1
d w_firm          s                   like(l_firm)
d w_user          s                   like(l_user)
```
- Scratch or intermediate fields for arithmetic, period, etc.

---

## **4. Mainline Logic**

### Initialization (INI Subroutine)

```rpg
c     *inzsr        begsr
  ...
c                   endsr
```
- Sets up default values for key fields, initializes period/year, and retrieves user record if available.

#### Key Steps:
- Zeros fields and sets default values.
- Loads user/company from passed parameters.
- Determines account period (usually previous month, adjusts year if needed).

---

### Main Processing

#### Screen Handling

```rpg
c                   exfmt     a2bld
```
- Displays/receives input for screen `a2bld`, which is a selection screen for report criteria.

#### Function Key Processing

```rpg
c                   if        *inkc = *on
c                   move      '1'           p_in03
c                   goto      xslutt
c                   endif
```
- If function key F3 (indicator `*INKC`) is pressed, sets a return variable and exits.

#### Date Validation

```rpg
c                   if        a2pkda = *zero
c                   move      udate         a2pkda
c                   endif

c     *dmy          test(d)                 a2pkda                 33
c                   if        *in33 = *on
c                   goto      a2taga
c                   endif
```
- If run date is not entered, it defaults to system date.
- Tests if the date is valid; if not, jumps to input screen with error indicator.

#### Year and Period Validation

```rpg
c                   if        a2pr�r > *year
c                   eval      *in34 = *on
c                   goto      a2taga
c                   endif

c                   if        a2ppef < 01
c                             and a2ppef > 13
c                   eval      *in35 = *on
c                   goto      a2taga
c                   endif
```
- Checks if accounting year is in the future.
- Validates that the period is between 1 and 13 (inclusive); if not, sets error indicators and returns to screen.

#### Save Parameters

```rpg
c                   move      a2pkda        rhpkda
c                   move      a2pr�r        rhpr�r
c                   move      a2ppef        rhppef
```
- Copies validated parameters to global/return fields.

---

### Program End

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Terminates the program, setting the LR (Last Record) indicator for program end.

---

## **5. Subroutine: Initialization**

```rpg
c     *inzsr        begsr
...
c                   endsr
```
- Prepares the program environment:
    - Sets initial values.
    - Calculates default accounting period (defaults to previous month; if January, rolls back year and uses December).
    - Loads the default or passed-in user/company values.
    - Optionally restricts output to department if specified in the user record.

---

## **6. Parameter List and Key List**

```rpg
c     *entry        plist
c                   parm                    p_in03

c     key03         klist
c                   kfld                    w_user
```
- Specifies the parameter interface for calling/receiving programs.
- Defines the key (user) for file access (e.g., `chain` for ausrl1).

---

## **7. Indicators and Screen Control**

- **Indicators** (e.g., `*INKC`, `*INLR`, *IN33, *IN34, *IN35, *IN30, etc.) are used for:
    - Function keys (F3 = Exit, F1 = Select company)
    - Error notification (invalid date, year, period)
    - Screen field protection, file operations, and program logic control.

---

## **Summary**
- This program provides a screen interface for extracting general ledger records.
- It validates user input for run-date, accounting year, and period.
- Supports function key exits and error prompts.
- Sets up parameters for further processing or report generation.
- Is structured for modularity and clear parameter passing between screens and programs.

It's a classic example of a parameter handling and validation "front-end" in a traditional IBM i RPG environment, with robust use of indicators, overlays, and fixed-format RPG conventions.