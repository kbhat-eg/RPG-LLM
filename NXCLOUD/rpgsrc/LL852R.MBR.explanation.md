# RPG Program Explanation: LL852R (Uttrekk salg- & kjøpsstat til Excel v.2)

This RPG/400 (ILE RPG, fixed-form) program is designed to extract sales and purchase statistics per item and output them in a format suitable for Excel (CSV/semicolon separated). It handles both number and amount statistics for each item, grouped by period (typically months), and builds dynamic headers and records accordingly. Here's a breakdown of the main components and logic:

---

## 1. **File Declarations**
These define the physical/logical files the program accesses.

- **vvarl1, vlagl1, sstal2**: Item master, inventory master, sales statistics files (input, keyed, external descriptions, renamed).
- **lwexpf**: Output file for Excel data (output, keyed, renamed).
- **vvlel1**: Additional file with item extensions, used in later versions.

---

## 2. **Key Data Structures and Variables**

- **Arrays**:  
  - `a_saar`, `a_smnt` (Year, month per column)
  - `a_smtx` (Month text, e.g., 'Jan-2024')
  - `a_psal`, `a_psalb` (Quantity and amount per period)
  - `a_prtx` (Period labels, e.g., 'Per-1')
- **Parameter Record (`p_prec` DS)**:
  - Contains selection limits (item number, warehouse, group, period, etc.)
  - Overlays individual parameters (e.g., `p_fvar` = from item, `p_tvar` = to item, `p_flag` = warehouse, etc.)
- **Work Variables**: For keys, text, calculations, temporary results, and output record (`d_orec`).

---

## 3. **Program Flow Overview**

### **Initialization (`*inzsr`)**

1. Builds key lists for item, statistics, and inventory files.
2. Receives parameter string (`w_parm`), sets up overlays.
3. Gets the company number from the LDA (Local Data Area).
4. Initializes system date and time.

---

### **Dynamic Header Generation (`lag_hdng` and `lag_mhtxt`)**

- Creates an appropriate header line for the CSV export, including item, group, periods, and other fields.
- Dynamically determines the number of months (periods) and labels columns with month names and years.
- Prepares arrays for period handling.

---

### **Main Record Loop**

- **READ loop over sales statistics (`sstal2`)**:
  - For each statistics record within selection, calls subroutine `behandling`:
    - Checks further selection criteria (`sjekk_param`).
    - If item changes, outputs accumulated previous item (`skriv_vlin`).
    - Accumulates quantity and amount into period arrays.

- After loop, if data for an item exists, outputs its line.

---

### **Subroutine: behandling (Process Each Statistics Row)**

- Filters out statistics not within the desired ranges.
- Retrieves mandatory item data (chain on item file). If not found, skips.
- Optionally, filters by item type (via external call to `VL710R`).
- Checks all relevant selection parameters (`sjekk_param`). If not matched, skips.
- If new item, outputs the previous one.
- Locates the correct period (via year/month arrays) and sums quantities and amounts.
- Loads descriptive fields for output.

---

### **Subroutine: skriv_vlin (Write Output Line)**

- Assembles `d_orec` (the output line) for the current item:
  - Item number, name, group, warehouse, department, etc.
  - Maximum, minimum, average statistics (by count or amount, as selected).
  - Gets cost price (call to `VP700R`) and inventory position.
  - Computes and writes grand totals and period totals.
  - Writes one value per period (i.e., per month).
  - Optionally, inserts a blank line after group break.

- Resets period accumulators for next item.

---

### **Subroutine: hent_kpris (Get Cost Price)**

- Calls external price calculation program `VP700R` to obtain cost price and related info for the item, unit, and warehouse/period.

---

### **Subroutine: skr_anblp**

- Decides whether to output "amount" or "quantity" columns, based on parameter.

---

### **Subroutine: lag_mhtxt**

- Sets up month/year labels for up to 36 periods backwards, used for dynamic column headings and period selection.

---

### **Subroutine: sjekk_param**

- Checks that the current statistics record matches all selection parameters (including item, inventory, group, department, etc.).
- Sets flag (`b_parm`) accordingly.

---

### **Subroutine: hent_prisgr**

- Calls external program `VL712R` to get the price group for a given item/warehouse.

---

### **Program Ending**

- After all records are processed, sets LR (*INLR) on and returns.

---

## 4. **Special Features**
- **Dynamic Period Handling**: The columns for periods (months) are generated dynamically based on user parameters.
- **External Program Calls**: Item type and pricing are determined by calling other RPG programs (`VL710R`, `VP700R`, `VL712R`).
- **Flexible Selection**: Multiple overlayed parameters allow users to select ranges for item, group, warehouse, department, and others.
- **Internationalization**: Uses European number/date formats.

---

## 5. **Intended Use**

- Batch extraction of item sales/purchase statistics to Excel for reporting/analysis.
- Can be adapted for different stats by changing parameters.
- Designed for flexibility and extensibility.

---

## 6. **Code Editing/Extension Tips**

- **Adding More Fields**: To export additional item or stat info, enhance the `d_orec` assembly in `skriv_vlin` and adjust header subroutines.
- **Changing Period Logic**: Modify the logic in `lag_mhtxt` to alter period calculation.
- **New Selection Parameters**: Add new fields to parameter DS and logic to `sjekk_param`.
- **Localization**: Headings and output text can be adapted for other languages.
- **Performance**: Ensure proper file keys and indexes for large datasets.

---

## 7. **Common RPG Patterns Used**

- Chain/Read operations with KLISTs (key lists) for indexed file access.
- Overlaying fields in a data structure for parameter passing.
- Use of subroutines for modular and reusable logic.
- *INLR and return to end the program.

---

## 8. **Potential Modernizations**

- Convert to free-form RPG for maintainability.
- Replace subroutines with procedures (for modularization and testing).
- Use SQL for more flexible selection and reporting.
- Refactor array processing with modern collections or data structures.

---

## 9. **Summary Table**

| Section           | Purpose                                        |
|-------------------|------------------------------------------------|
| File Declarations | Define input/output files                      |
| Arrays            | Hold period/year, text, quantities/amounts     |
| Parameter DS      | Overlay user selection parameters              |
| Main Loop         | Process each relevant statistic record         |
| Subroutines       | Header setup, processing, output, selections   |
| External Calls    | Get item type, cost price, price group         |
| Output            | Builds CSV rows for Excel                      |

---

This program is a robust, parameter-driven item statistics extractor, designed for IBM i (AS/400) shops that need flexible, period-based sales and purchase reporting in a spreadsheet-friendly format. With its modular structure, it’s relatively straightforward to adapt for future requirements, once familiar with RPG's legacy syntax and data access patterns.