# RPG Program Explanation

## Overview

This RPG program is named **LE622R** and is designed for **printing miscellaneous items and selecting item numbers** (*Utskrift av diversevarer, plukker varenummer*). It processes records from inventory counting and item master files within specified ranges and writes selected records to an output file.

---

## File Declarations

```rpg
ftell1    if   e   k disk   rename(ltelpfr:ltell1r)
fvvarl1   if   e   k disk   rename(vvarpfr:vvarl1r)
flsorlu   uf a e   k disk   rename(lsorpfr:lsorlur)
```
- **ltell1r**: Inventory counting register (input)
- **vvarl1r**: Item master file (input)
- **lsorlur**: Output register for picked items (output)

---

## Data Definitions

### Local Data Area
```rpg
d                uds
d l_wsid        901    910
d l_user                10
d l_firm        944    946  0
```
- Area for job/environment variables, including user and company number.

### Parameter Data Structure

```rpg
d                 ds
d d_prec              128
d  d_batc             10    overlay(d_prec)
d  d_fogr              2  0 overlay(d_prec:11)
... (similar overlays for filtering criteria)
```
- **d_prec** is a 128-byte parameter space.
- Overlays extract input parameters: batch, group ranges, item number ranges, warehouse, etc.

### Working Variables

```rpg
d ltell1_batc     s   like(lebatc)
d vvarl1_firm     s   like(vvfirm)
d w_prgr          s   2
...
```
- Used for holding key values, work fields for pricing, quantities, and group codes.

---

## Parameter & Initialization

### Program Entry (*ENTRY PLIST*)
```rpg
c     *entry        plist
c                   parm      w_parm
```
- Receives a 128-byte string of parameters from a calling program.

### Initialization Subroutine (*INZSR)

- Sets up key lists for file access.
- Assigns company number to key fields.

---

## Main Logic Flow

### Parameter Extraction

```rpg
c                   eval      d_prec = w_parm
c                   eval      ltell1_batc = d_batc
c                   eval      ltell1_numm = *zero
c                   eval      w_slbe = 999999
```
- Parses out parameters from input.
- Prepares initial values for file search.

### Record Selection Loop

```rpg
c     start         tag
...
c                   read      ltell1r   90
c                   if        *in90 = *on
c                   goto      slutt
...
```
- Begins a READ loop through the inventory counting file.
- If EOF, branches to program end.

### Record Filtering

- For each record read, applies a set of **range and value checks**:
    - Company/batch/list numbers
    - Group (Overgroup, Main group, Subgroup)
    - Item number, warehouse number
    - Only includes main lines (suffix = 0), not sublists
    - Miscellaneous items only (`ledlop = *zero`)
    - Only items with non-zero counted quantity (`leantt`)
- If a record fails a check, READS the next.

### Item Master File Lookup

```rpg
c                   eval      vvarl1_vare = levare
c     vvarl1_key    chain     vvarl1r   90
```
- Looks up the item in the item master file to retrieve supplementary fields.

### Assigning Group Codes from Master if Missing

```rpg
c                   if        leogrp = *zero
c                   eval      leogrp = vvogrp
...
```
- If group codes are zero in the counting file, fetches from the item master.

### Price Group Lookup (Subroutine)

```rpg
c                   exsr      hent_prisgr
```
- Calls `hent_prisgr` subroutine to fetch the price group.

### Price Calculation

```rpg
c                   call      'VP700R'
c                   parm      w_firm
c                   parm      levare
c                   parm      w_prgr
...
c                   parm      w_sapr
c                   parm      w_bupr
c                   parm      w_tipr
c                   parm      w_kopr
```
- Calls an external program to calculate various prices (sales & cost).

### Price Assignment

```rpg
c                   if        lespny = *zero
c                   eval      lespny = w_sapr
...
```
- Uses the calculated prices if the inventory file does not already have them.

### Output Preparation

- Copies the necessary fields to the output record.
- If certain fields (description/unit) are blank, fills from item master.
- **Writes** record to output file.

### Repeat

- Jumps back to `start` to process next record.

### End of Program

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- Sets LR on and exits.

---

## Subroutines

### hent_prisgr

- Calls program `VL712R` to fetch price group for the company and warehouse.

### *INZSR

- Initializes keys and company numbers at program start.

---

## Additional Notes

- **Comments are in Norwegian.**
- The program is modular; it relies on external programs for price calculation and group assignment.
- FIELD NAMES:
    - `le*` : fields from inventory count
    - `vv*` : fields from item master
    - `w_*` : working fields
    - `lw*` : output record fields
- The logic is entirely performed in a `read/filter/process/write/loop` style, typical for classic RPG batch programs.

---

## Summary

**LE622R** selects and processes items from the inventory counting file based on a detailed set of criteria, enriches their data from the master file, calculates or fetches prices, and outputs the result for further processing or printing. The program is parameter driven and designed for batch execution, tightly integrated with external programs for price logic and group mapping.