# RPG Program Explanation: AA522R – User Register, Inquiry

This RPG code is a traditional ILE RPG (RPG IV/400) program for IBM i (AS/400) used to display and inquire about user records ("Bruker-register, spørring" = "User register, inquiry"). The code makes heavy use of subfiles — a method of displaying lists in IBM i green-screen applications.

Below you will find an explanation of the main components, data structures, logic flow, and subroutines.

---

## 1. Header & Documentation

- The header specifies program options (no debug I/O, DMY date format).
- Comments describe the system, program name, and purpose.
- Indicator usage is explained:
  - **LR**: Last record, program end.
  - **10/11**: Page up/down.
  - **12–15, 21–22, 30–99**: Various display and program states.

---

## 2. File Declarations

```rpg
fausrl1    if   e           k disk    rename(ausrpfr:ausrl1r)
fausrl2    if   e           k disk    rename(ausrpfr:ausrl2r)
faa522d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **ausrl1/ausrl2**: Physical/Logical files for user master data (indexed differently).
- **aa522d**: Display file, using a subfile (`b1sfl`) for record display, with an information data structure (`dspfbk`) for feedback.

---

## 3. Data Definitions

- **Parameters:** `p_user` and `p_navn` (user ID and name).
- **Information DS:** `dspfbk` for reading cursor position from display feedback.
- **Variables:**
  - **Subfile/Display Control:** `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` (page control and navigation).
  - **Selection/Sequence:** `w_seqe`, `b_valg_ok` (indicator for valid selection).
- **Constants:** `c_sfil` (probably subfile page size).

---

## 4. Subfile Explanation

- **w_fcrn**: First record number on page.
- **w_stel**: Subfile counter.
- **w_srrn**: Current subfile record number.
- **w_spge**: Page size for the subfile.
- **w_sfrn/w_ssrn**: First/last record numbers on last page.
- **w_curn/w_virn**: For cursor/page positioning.

---

## 5. Main Control Logic

### Main Display Loop

- **b2taga (tag):**
  - Writes the function key command screen (`b2cmd`).
  - Goes to main subfile display routine.

- **b2tagb (tag):**
  - Calls `dsp_subfile` subroutine to format and show subfile records.

- **Function Key Handling (select/when):**
  - **F3/F12 (`*inkc`/`*inkl`)**: Exit to `avslutt`.
  - **F5 (`*inke`)**: Refresh subfile — rerun filters.
  - **F10/F11 (`*in10`/`*in11`)**: Page up/down.
  - **Home (`*in21`)**: Reposition to first record (`*in22`).

- If the user enters data in search fields (user or name), the code positions and fills the subfile accordingly.

---

## 6. Subroutines

### a) `forny` – Refresh Subfile

- Repositions/refreshes subfile if the current record is not the first.
- Decides which key to use for setll (position) based on search mode (`w_seqe`).
- Clears and recreates subfile.

### b) `posisjoner` – Position in Subfile

- If user or name search field entered:
  - Sets search mode (`w_seqe`) and positions file accordingly (`setll`).
- Clears and fills subfile from new position.
- Clears the search fields.

### c) `subfile` – Handle Subfile Processing

- Toggles cursor positioning indicator (`*in22`).
- Loops through all subfile records (readc).
- Handles record selection by the user (sets `b_valg_ok`, stores user and name).

### d) `clr_subfile` – Clear Subfile

- Sets indicators and variables to clear the current subfile page.

### e) `crt_subfile` – Create/Populate Subfile

- Loads records into the subfile, for the current page, from either index (by user or by name).
- Handles end-of-file conditions, sets subfile navigation variables.

### f) `bck_subfile` – Page Backwards in Subfile

- Uses `readp` (read previous) to fetch the previous page of results.
- Resets position and reloads the subfile.

### g) `dsp_subfile` – Display Subfile

- If subfile has data, sets indicators to display the appropriate screen.
- Uses `exfmt` to show and accept input from the control record.
- Updates positioning data from feedback.

### h) `*inzsr` – Initialization Subroutine

- Sets up parameter passing from calling program (user, name).
- Sets up keys for index/positioning.
- Initializes the display and positions to the start.
- Fills the first page in the subfile.

---

## 7. Program Flow Summary

1. **Initialization:** Receives parameters, initializes indicators and positioning, loads first subfile page.
2. **Main Loop:** Displays subfile, responds to function/search keys, allows user to select a record.
3. **Subfile Navigation:** Supports page up/down, home, and search by user or name.
4. **Selection and Exit:** When a selection is made or the user exits, returns control.

---

## 8. Key RPG/IBM i Patterns Used

- **Subfiles:** For paged display and selection.
- **Display Feedback Structures:** Read cursor and display state.
- **Indicators:** For controlling display logic and options.
- **File Positioning (`setll`):** For fast navigation by key.
- **Function Key Handling:** For user navigation and options.
- **Selection Logic:** Allows returning a specific user (and name) to the caller.

---

## 9. Real-World Use Case

Typically, this program is called from another application to select or inquire about users (for administration, security, etc.). The subfile allows fast navigation/searching, and returns a selected user record to the caller for further action.

---

## 10. Notes

- Comments and variable names are in Norwegian, but code is standard RPG III/IV.
- Subfile page size and fields (e.g., `b1sfl`, `b2ctl`, `b2cmd`) are display file record formats, defined elsewhere.
- This is old-style, column-oriented RPG, not fully free-format.

---

## Onboarding Tips

- Get familiar with subfile programming on IBM i.
- Understand the difference between positioning keys and reading modes (`read`, `readp`).
- Remember indicators are heavily used to control screen and logic flow.
- This code is modular, with much of the action in subroutines.
- See the display file (`AA522D`) for field details and record formats.

---

**In summary:**  
This program is a tried-and-tested IBM i pattern for subfile-based lookup and selection, tuned for a user master file. Its key strengths are search flexibility and snappy navigation, typical for green-screen administrative tools.