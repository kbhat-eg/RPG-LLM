# FP753R – Special Price Import from NIB Price Format

## Overview

This program, `FP753R`, is part of the ASOFAK system and is responsible for importing special pricing information from a file in the NIB price format. Its primary function is to read a selected input file, process each record, and create or update special prices for a given discount category, customer, or customer project. The program supports various business rules, including handling of alternative items, price groups, and delivery types.

## Business and Domain Context

- **NIB Price Format**: The input file is assumed to be in a fixed-format NIB price layout, where each record contains product (NOBB) numbers, pricing, units, and descriptive information.
- **Special Prices**: Special prices are maintained for combinations of items, customers/projects, discount categories, and delivery types.
- **Alternative Items**: If the main item is not found, the program attempts to process any alternative items linked to the NOBB number.
- **Price Groups**: Price group support has been extended over time (notably from 1 to 2 positions).
- **Tracking and Auditing**: The program maintains user and timestamp information for each update or creation of a special price.

## File/Table Relationships

- **flvwpfr**: Input work file, contains NIB-formatted price records to be processed.
- **vvarl1/vvarl3**: Item master files, used to identify items by item number or NOBB number.
- **vvaal1**: Alternative item file, used to find alternative items for a given NOBB number.
- **vvenl2**: Item unit file, provides sales units and conversion factors for items.
- **fpril3/fprilu/fprnlu**: Special price and note files, storing special price records and associated notes.

## Program Structure

### Initialization

- **Parameter Handling**: The program receives parameters such as company, price group, discount category, customer, project, delete flag, and up to four delivery type/premium pairs.
- **Key Lists**: Key lists for file access are defined for efficient lookups and updates in the various database files.

### Main Program Flow

1. **Optional Deletion of Existing Special Prices**  
   If the delete flag (`p_slet`) is set, the program removes all existing special prices for the specified discount category or customer/project before importing new ones. This ensures that the imported file replaces previous special prices.

2. **Processing the Input File**  
   Each record from the input work file (`flvwpfr`) is read and processed in turn. The core logic is encapsulated in the `behandling` subroutine.

3. **Post-processing**  
   After all records are processed, the program calls an external program (`FO719C`) to handle any items not imported into the special price register, likely for reporting or further processing.

4. **Program Termination**  
   The program sets the LR indicator and returns.

### Subroutine: behandling (Process Item with Special Price)

- **Parsing Input Record**: The NIB price record is parsed into individual fields via a data structure overlay.
- **Validation**: Skips records that lack a NOBB number, unit, or price.
- **Item Identification**:  
  - Tries to find the logistics item number (`vvlvnr`) via SQL from the NOBB number.  
  - If not found, attempts with up to three alternative NOBB numbers (`d_nob1`/`2`/`3`).  
  - If still not found, tries the item master directly.
- **Special Price Update**:  
  - If the item is found, invokes the `oppdater` subroutine to create or update special price records.
- **Alternative Items Handling**:  
  - For each alternative item found for the NOBB number, attempts to create/update special prices as above.
- **Cleanup**:  
  - If processing is successful, deletes the processed input record.

### Subroutine: oppdater (Create/Update Special Prices)

- **Sales Units Lookup**:  
  - Retrieves up to three sales units for the item from `vvenl2`, along with their conversion factors.
- **Unit Validation**:  
  - Ensures the unit from the input record matches one of the item’s sales units.
- **Price Calculation**:  
  - Calculates sales prices for each unit, converting as necessary using the conversion factors.
  - Handles both warehouse and direct delivery prices, as well as prices for custom delivery types as specified by parameters.
- **Special Price Record Update**:  
  - For each relevant unit, calls `oppd_levtype` to update or create the special price record.
- **Notes Handling**:  
  - If present, extracts notes from the input record and updates or creates the associated note record in `fprnlu`, splitting long notes across multiple fields.

### Subroutine: oppd_levtype (Update/Create Special Price by Delivery Type)

- **Premium Handling**:  
  - Applies a percentage premium to the calculated prices based on the delivery type and the corresponding parameter.
- **Record Update or Creation**:  
  - For each unit, attempts to update the existing special price record; if not found, creates a new one.
  - Maintains audit information (user, date, time) for both updates and creations.

### Initialization Subroutine (*inzsr)

- **Parameter Assignment**:  
  - Loads parameter values into working variables.
- **Key List Setup**:  
  - Defines key lists for all file operations used in the program.

## Notable Design and Implementation Details

- **SQL Integration**:  
  - Uses embedded SQL to retrieve logistics item numbers from the `vvlepf` table, allowing for flexible and efficient lookups.
- **Flexible Item Resolution**:  
  - The program attempts to resolve items using multiple strategies: logistics item lookup, direct item number, and alternative items, maximizing the chance of matching input data to master data.
- **Delivery Type and Premium Logic**:  
  - Supports up to four custom delivery types, each with its own premium percentage, allowing for granular control over price adjustments.
- **Audit Trail**:  
  - Updates both creation and modification timestamps and user IDs for each special price and note record.
- **Data Integrity**:  
  - Skips records with missing critical information and only deletes the input record upon successful processing.
- **Backward Compatibility and Evolution**:  
  - The codebase shows multiple versioned enhancements (e.g., price group extension, handling of both NOBB and item numbers, note field expansion), indicating a mature and evolving system.

## Interactions with Other Modules

- **External Program Call**:  
  - Calls `FO719C` after processing to handle items not imported—this could be for logging, error handling, or further business processing.
- **Shared Data Structures and Files**:  
  - Relies on common master files for items, units, and alternative items, as well as shared special price and note files.

## Conventions and Patterns

- **Overlay Data Structures**:  
  - Uses overlay techniques to parse fixed-format input records efficiently.
- **Key Lists for File Access**:  
  - Defines named key lists for reuse and clarity in all file operations.
- **Modular Subroutines**:  
  - Business logic is organized into subroutines for clarity, reuse, and separation of concerns.
- **Parameterization**:  
  - Extensive use of parameters allows the program to be reused for different companies, customers, categories, and delivery scenarios.

## Summary Table of Key Parameters

| Parameter   | Purpose                                                |
|-------------|--------------------------------------------------------|
| p_firm      | Company code                                           |
| p_prgr      | Price group                                            |
| p_rkat      | Discount category                                      |
| p_kund      | Customer number                                        |
| p_kpro      | Customer project number                                |
| p_slet      | Delete flag (1 = delete existing special prices first)  |
| p_let1-4    | Delivery type codes (up to four)                       |
| p_pas1-4    | Premium percentages for each delivery type             |

## Error Handling

- Input records are skipped if required fields are missing.
- Special price records are only created/updated if the item and unit are valid and found.
- Input records are only deleted upon successful processing to prevent data loss.

---

**In summary**, `FP753R` is a robust, parameter-driven batch import program for special pricing, designed to integrate with a complex item master and pricing system, with extensive support for business rules around item identification, delivery types, and auditing. Its modular design and careful file handling ensure both flexibility and data integrity.