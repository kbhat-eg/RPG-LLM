# High-Level Overview

This RPG program (`FV105R`) is designed as a subfile inquiry screen for external financial systems on IBM i/AS400. It utilizes display files (subfiles), interacts with physical files, and enables the user to page through records, position, select, and update financial system entries. The main flow includes:
- Initializing the display/subfile,
- Populating the subfile with data from files,
- Handling user interaction and function keys,
- Allowing selection and updating of data,
- Paging forward/backward through records.

# File Declarations

```rpg
frb00l1    uf a e           k disk    rename(rb00pfr:rb00l1r)
frb00l2    if   e           k disk    rename(rb00pfr:rb00l2r)
```
- Two files (`rb00l1` and `rb00l2`) are declared, both based on the physical file `rb00pfr` but renamed for use in this program. Both are keyed (`k`) and externally described (`e`). `rb00l1` is update-capable (`uf a`) while `rb00l2` is input only (`if`).

```rpg
ffv105d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- The display file (`fv105d`) is used as a workstation (`workstn`), supporting subfiles (with `b1sfl` as the subfile name, and `w_srrn` as the relative record number).

# Data/Variable Definitions

## User Info and Parameters

```rpg
d l_user                911    920
d l_filg                931    933
d l_firm                944    946  0
d l_fnav                951    980
...
d p_kode          s              2
d p_text          s             30
```
- Variables for user, company, and input parameters (presumably from calling program).

## Subfile Paging Variables

```rpg
d w_stel          s              4  0   // Subfile counter
d w_spge          s              4  0   // Page size
d w_srrn          s              4  0   // Current subfile record number
d w_sfrn          s                   like(w_srrn) // First record on page
d w_ssrn          s                   like(w_srrn) // Last record on page
...
d w_seqe          s              1   // Sequence code
d b_valg_ok       s              1    inz(*off) // Selection flag
```
- These variables manage subfile navigation, page size, current/first/last records, and selection.

## Constants

```rpg
d c_sfil          s              2  0 inz(8) // Subfile page size (8 records)
```

# Indicator Usage

- Extensive use of indicators (`*IN10`, `*IN11`, etc.) for subfile management and user actions.
- Comments explain indicator purposes (e.g., `10=Roll`, `11=Rolldown`, `12=Sfldsp`, `14=Sflclr` etc.).

# Main Logic Flow

### Tags and Initial Interaction

- `b2taga`/`b2tagb`: Primary labels for controlling the main interaction loop.
- First, writes the "command" screen `b2cmd`, then proceeds to process the subfile logic (`dsp_subfile`).

### Subfile Page Positioning

- If the current record `w_curn` is set, calculate the page start number (`w_sfrn`).
- Handles function keys with `select/when` (exit, refresh, forward/backward paging, home key).

### Subfile Processing

- Calls `subfile` subroutine for processing records within the subfile, including reading which records are selected.
- If a valid selection is made, sets `b_valg_ok` to `*on` and exits.

### Program Exit

- Sets last record indicator (`*INLR`) to end RPG cycle and returns.

# Subroutine Descriptions

## forny

- Refreshes the subfile starting from the currently displayed page.
- Repositions the file pointer (`setll`) depending on the sequence (`w_seqe`), then clears and recreates the subfile.

## posisjoner

- Handles positioning within the subfile based on key or text input (currently commented out).
- Clears and recreates subfile for updated positioning.

## subfile

- Reads displayed subfile records (`readc` in a loop).
- Detects any selection made by the user (`b1valg = 1`), copies selection to output params, and flags selection complete.

## clr_subfile

- Clears subfile indicators and counters, and writes the subfile control record (`b2ctl`) to clear the display.

## crt_subfile

- Fills up the subfile with the next chunk of data.
- Reads records from `rb00l1` or `rb00l2` depending on sequence, only including those for the selected company (`w_firm`) and with type='ØKSYST'.
- Updates subfile variables (record counts, page range, etc.).

## bck_subfile

- Implements "page back" for the subfile.
- Reads records backwards to load the prior page.
- Repositions as needed before recreating the subfile page.

## dsp_subfile

- Determines whether to show the subfile display or command screen.
- Sets indicators needed for controlling the display using `exfmt` on the control record.

## upd_rb00

- Updates or writes a record in `rb00l1` for type 'ØKSYST' (presumably for the selected company).
- Populates audit fields and user information.

## *inzsr (Initialization)

- Handles program initialization.
- Gets parameters, sets up keys for positioning, initializes variables, and loads the initial page of the subfile.

# Special Notes

- **Subfile Programming Model:** This is a classic IBM i subfile paging design, allowing forward/backward paging and record selection.
- **Indicator Usage:** Old-style indicator variables control both UI (display file) and logic flow.
- **File Access:** Heavily relies on keyed access and the ability to read both forward and backward (`read`/`readp`).
- **Code Comments:** Comments are in Norwegian and offer helpful context about the business logic and indicator use.

# Summary Table

| Section            | Purpose                                                              |
|--------------------|----------------------------------------------------------------------|
| File Declarations  | Assign RPG data & display files, define subfiles                     |
| Data Definitions   | Define program, paging, and UI variables                             |
| Initialization     | Receive parameters, set up keys, show initial subfile page           |
| Main Loop          | Display screen, process user input, page, select, update, exit       |
| Subroutines        | Modular logic for paging, clearing, creating, updating subfile/pages |

# Onboarding Notes

- **Understanding Subfiles:** Know subfile indicator logic (especially *IN12, *IN14, *IN15 for display/clear/end).
- **Paging Logic:** Key variables (`w_srrn`, `w_ssrn`, `w_sfrn`, `w_spge`) control which records are shown.
- **File Structure:** Familiarize with `rb00pfr` file (field names and keys, including `r00typ`, `r00fir`, `r00kod`).
- **Display File:** Must check the DSPF (`fv105d`) to match fields, layouts, indicators.
- **Program Expansion:** If adding search/positioning, look to currently-commented sections.
- **Indicator Management:** Be careful with overlapping/reused indicators in shared display logic.

# Conclusion

This program is a well-structured example of old-style RPG/400 subfile display management for an inquiry into financial systems, with Norwegian comments and consistent use of RPG fixed-format and indicator logic. The code is modular, with each subfile function in its own subroutine for easier maintenance. A new developer should focus on understanding the paging logic, indicator roles, and the display file to confidently work with or extend the program.