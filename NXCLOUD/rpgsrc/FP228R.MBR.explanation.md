```markdown
# FP228R: “Skriver talletiketter” – Label-Printing RPG Program

## 1. Program Header & H-Spec
- `/TITLE  ASOFAK: Skriver talletiketter`  
- `H datedit(*dmy) option(*nodebugio)`  
  • Date format = DMY, no debug I/O

## 2. File Specifications (F-Specs)
- `fvaw1pf`  
  • Disk file, record length 64, keyed  
- `fEtikett`  
  • Output file = printer, line-indefined, no overflow

## 3. Local Data Area (LDA) Layout
The program reads *Local Data Area* fields:
- `lcskty` (positions 110–110) → printer type
- `lcuser` (911–920)  
- `lcfirm` (944–946)  
- `l_fnav` (951–980)  

## 4. Working Variables
```rpg
d w_skty      s   like(lcskty)   // local copy of printer type
d w_anta_1    s              1 0 // quantity counters
d w_anta_2    s              2 0
d w_anta_3    s              3 0
```

## 5. Input Record Format (`ivaw1pf`)
```rpg
i   1    4    vaanta    // quantity
i   5    6    vatal1    // label text (short)
i   7   11    vatal2    // barcode text
```

## 6. Main Processing Loop
```rpg
read vaw1pf            // prime read
dow  *in61 = *off      // loop until EOF
  if *in60 = *off      // first pass per printer setup
    eval w_skty = lcskty

    // Initialize printer based on w_skty
    if w_skty = 0     except '␂clr0' ; except '␂pgm0' endif
    if w_skty = 1     except '␂clr1' ; except '␂pgm1' endif
    if w_skty = 2     except '␂pgm2' endif

    eval *in60 = *on   // mark initialization done
  endif

  // Per-record label output
  select w_skty
    when 0  except '␂data0'
    when 1  except '␂data1'
    when 2
      // reset counters/indicators
      eval *in81 = *off; *in82 = *off; *in83 = *off

      // choose which counter based on vaanta
      select
        when vaanta <= 9
          eval w_anta_1 = vaanta; eval *in81 = *on
        when vaanta <= 99
          eval w_anta_2 = vaanta; eval *in82 = *on
        when vaanta <= 500
          eval w_anta_3 = vaanta; eval *in83 = *on
        other
          eval w_anta_3 = 500;  eval *in83 = *on
      endsl

      except '␂data2'
  endsl

  read vaw1pf
enddo

goto avslutt
```

## 7. Shutdown (`Avslutt`)
```rpg
avslutt tag
  // For printer type 2, send its end-of-job sequence
  if w_skty = 2  except '␂end2' endif
  eval *inlr = *on      // last record indicator
  return
```

## 8. Output Specs (O-Specs): Printer Control Macros

### 8.1. Twinax Printer (skty = 0)
- **Initialization (`PGM0`):**  
  • Clear buffer 0: `␂02␂20␂03`  
  • Clear PGM-buffer 01: `␂02␂54 01␂03`  
  • Load program for layout: `␂02␂44 01022␂04`  
- **Label Data (`DATA0`):**  
  • Header: `␂43 00000101␂0D␂04`  
  • Print `vatal1`, then newline  
  • Print `vatal2` as barcode, then newline  
  • End record `␂0D␂03`  
  • Quantity: `␂66` + `vaanta` + `␂03`

### 8.2. Standard Printer (skty = 1)
- **Initialization (`PGM1`):**  
  • Clear & home: `{&}` `{&S000001}`  
  • Select template T01: `{&T01}`  
  • Load program: `{&D01022!}`  
- **Label Data (`DATA1`):**  
  • `{&C00000101\!}`  
  • `{vatal1\!}`  
  • `{vatal2\!}` (barcode)  
  • `{…}` end  
  • `{&f<vaanta>}` quantity  

### 8.3. Bandit-Style Printer (skty = 2)
- **Initialization (`PGM2`):** Series of `[ ... ]` commands to set up:
  • Character set, margins, paper, label size, speed, etc.  
  • `[D W "1" "8" "3" … "\N"]` – start label format  
- **Label Data (`DATA2`):**  
  • Repeat `[D W …]` blocks for:
    - Label format definition  
    - Print `vatal1` (text)  
    - Print `vatal2` (barcode)  
  • Final `[P b …]` specifying number of labels:
    - Uses indicators (`*in81`, `*in82`, `*in83`) and counters (`w_anta_1`, `_2`, `_3`)

## 9. Quantity Handling
- `vaanta` ≤ 9 → use `w_anta_1`  
- 10–99 → `w_anta_2`  
- 100–500 → `w_anta_3`  
- > 500 → force 500 labels  

This structure allows one RPG program to drive three different printer types via conditional EXCEPT statements and output macros.