# RPG Source Code Onboarding Guide

---

## Overview

This RPG IV (ILE RPG) program processes and splits order headers ("bestilling-hode") and lines ("bestilling-linje") in an inventory/order management context. The main purpose is to split or copy parts of an order (bestilling/IP) onto a new suffix (ny IP/suffix) within the order files. It handles updating various registers, subfiles for display, logging, and computes/creates new orders.

---

## Key Sections

### 1. **Header and Documentation Block**

- The `h` specification sets compiler options: `*nodebugio` omits I/O debug, `datedit(*dmy)` sets date format.
- The comment block outlines:
  - System, program, and description: "splitte ip til ip" (splitting order into new order).
  - Change history (versioning, developers, and notes on updates).

### 2. **File Specifications (F-Specs)**

Defines database and display files:

- Input (`I`), update (`U`), output (`O`), and combined (`CF`, `UF`) files.
- `rename(x:y)` is used to reference files with different record formats.
- `workstn` and `sfile` indicate a display file using subfiles (D1SFL with record Srrn01 for scrolling).

### 3. **Data/Variable Definitions (D-Specs)**

**Parameters**
- Variables like `p_firm`, `p_kode`, etc., for company/order parameters.

**Key Fields**
- Variables patterned with `_numm`, `_suff`, etc., for keying into each file.

**Working Storage**
- Program work variables (`w_on01`, `w_datf`, `w_enor`, etc.).
- Display file (subfile) variables.

**UDS (User Data Structure)**
- For job/user/system data (e.g., `l_user`, `l_firm`).

---

## Main Logic Flow

### 4. **Mainline (C-Specs)**

#### **A. Process Order Splitting**

1. **Load Original Order Header Information**
    - Use `chain` to load the order header by `hedkey`.

2. **Get Order Type Information**
    - Using `otykey`, link to order type register.

3. **Find New Suffix (`finn_nxtsuff` subroutine)**
    - Determines the next available suffix for splitting.

4. **Mark Order as "In Process"**
    - Calls program `LO709R` with order number and suffix.

5. **Update Status in Header**
    - Changes processing code to '3'; updates the order header.

#### **B. Process Order Lines**
- Calls `xd1bld` subroutine: builds and displays subfile for selecting which lines to split.

#### **C. Create New Order if Needed**
- If lines selected for new order, writes a new order header (using new suffix).
- Sets timestamps and user info.
- Writes to the **additional register (tilleggsregister)** if required.

#### **D. Calculate and Update Orders**
- Calls calculation programs to update totals on both new and old orders.
- Updates the log register for tracking (adds entry for the new suffix).
- Marks old order as processed.

---

### 5. **Display and Subfile Handling (`xd1bld`, `xlsp01`, `xclr01`, `xcrt01`, `xdsp01`)**

**Subfile Logic**
- `xd1bld`: Entry point for building/handling the subfile screen.
- Handles input keys (F3/F5, page up/down, etc.).
- Iterates/readc through subfile records to see if user made selections.
- If a line is selected (`d1kode = '1'` or `d1leve > 0`), calls `nyip` to split the line.

**Subfile Utilities**
- `xlsp01`: Reloads (refreshes) the subfile.
- `xclr01`: Clears the subfile and resets page/row counters.
- `xcrt01`: Loads (creates) subfile records for display.
- `xdsp01`: Formats and shows the subfile screen.

---

### 6. **Subroutines**

**Key Subroutines:**

- **`nyip`**  
  Handles the logic for actually splitting a line into the new suffix, writing new records, and updating quantities.

- **`finn_nxtsuff`**  
  Finds the next available suffix for the order by calling program `AS115R`. (Older logic commented out.) Ensures suffixes are NOT reused (see 8.02 change history).

- **`xlsp01`, `xcrt01`, `xclr01`, `xdsp01`**  
  Manipulate subfile data for display and selection logic.

- **`*inzsr`**  
  Program initialization section. Resets work variables, establishes key structures, and sets up parameter mappings.

---

### 7. **Key Lists (C-KLIST)**

Key lists group fields for file access (chains, sets, etc.).  
Examples: `otykey`, `hedkey`, `lodtl1_key`, `lohel1_key`, `ldell3_key`, etc.

---

### 8. **Entry Parameters**

Handled in `*entry` PLIST:
- Accepts order, company, order number, and suffix from the calling program.
- Sets appropriate fields for later use.

---

## Business Rules/Logic

- **Splitting Lines:** If a line is split, either all or part of the quantity is transferred to a new record under a new suffix.
- **Suffix Assignment:** Suffixes are sequential; logic ensures no reuse.
- **Order Header/Log Updates:** Both old and new orders are recalculated and updated.
- **Display Handling:** Uses subfiles to allow interactive user selection of which lines to split.
- **Referential Entries:** Additional records may be created in auxiliary registers if needed.

---

## Customizations and History

- The extensive header comment shows a history of bug fixes and adaptations, such as handling wide screens, not reusing suffixes, and adding integration for EDI module.

---

## Vocabulary/Terminology

- **IP**: Internal abbreviation for a type/order (in some Norwegian ERP systems).
- **Suffix**: A serial or split indicator for different versions/splits of the same order.
- **Subfile**: A screen section showing a scrollable list, central to IBM i UI.
- **Chain**: DB record fetch by key.

---

## Summary Table

| Area                   | Functionality                                                                 |
|------------------------|-------------------------------------------------------------------------------|
| Header                 | Documentation for versioning, changes, and program intent                     |
| File Specs             | Defines DB and display file access                                            |
| Data Declarations      | Program, key, and work variables                                              |
| Mainline               | Order splitting logic; header, lines, suffixes, logging, and calling programs |
| Subroutines            | Subfile handling, splitting logic, suffix finding, initialization             |
| Key Lists              | Logical key definition for DB file access                                     |
| Entry Parameters       | Receives calling program's data                                               |

---

## Typical Call Flow

1. User requests to split order.
2. Program loads order header and lines.
3. Subfile displayed for the user to select lines to split.
4. New order suffix determined.
5. Selected lines are moved/split onto the new order suffix.
6. Both orders (old/new) are recalculated and updated.
7. Logging and auxiliary records updated as needed.
8. Displays updated info, then exits.

---

## Additional Information

### For Maintenance

- When changing file structures or adding fields, update D-specs and KLISTs accordingly.
- When business rules change (e.g., suffix calculation), adapt the logic in `finn_nxtsuff` and related subroutines.

---

**Note:** Some variables and comments are in Norwegian. The program's core logic is not language-dependent and can be followed with basic RPG and business process understanding.

---

## Getting Started as a Developer

- Familiarize yourself with order header (`lohel*`), order line (`lodtl*`), and associated log/register files.
- Understand RPG subfile techniques for display.
- Pay attention to keylist usage for database operations.
- The comments describe both business intent and logic for each major step.
- Test any changes thoroughly in both display and DB logic due to the interactive and transactional nature of the program.

---