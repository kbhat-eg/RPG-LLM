      /TITLE ASOKON Summering av bilag
     h datedit(*dmy.) option(*nodebugio)
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RF109R                                              *
      * Beskrivelse . . : Summering av bilag                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                                     *
      * Tilpasset for . :                                                     *
      *                                                                       *
      * Referanse  Dato   Endringsbeskrivelse                            Sign *
      * --------- ------  ---------------------------------------------- ---- *
      * V5.40     270605  Programmet er skrevet om                       KOB  *
6.10  * R6.10     121009  Memberstyring                                  BSA  *
6.11  * R6.10     280909  Lagt inn sppringsonformasjon                   BSA  *
6.20  * R6.20     251110  Pros er nå alfa, legger underprosjekt og       NHO  *
      *                   arb.ordre ut til RJOUPF                             *
6.30  * R6.30     300816  Fjernet all summering av bilag vedr ny         sst  *
      *                   rapportering via ALTIN fom 01.01.2017          sst  *
      *                   Ingen endring vedr ny mva-oppgave              sst
6.31  * R6.30     220120  Fjernet bruk av bilagsteller                   sst  *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *
     frjoul3    up   e           k disk
     f                                     prefix(z:1)
     fra01l1    if   e           k disk    rename(ra01pfr:ra01l1r)
6.31 f*raa4l1    if   e           k disk    rename(raa4pfr:raa4l1r)
6.31 f*raa4lu    uf   e           k disk    rename(raa4pfr:raa4lur)
     frzuml1    if   e           k disk    rename(rzumpfr:rzuml1r)
     f                                     prefix(x:1)
     frzumlu    o    e           k disk    rename(rzumpfr:rzumlur)
     frjoulu    o    e           k disk    rename(rjoupfr:rjoulur)
      *
      * KEY-REKKEFØLGE PÅ RJOUPF (POSTER UT)
      *
     d
     d wssort          ds
     d  wsfirm                        3  0
     d  wsraar                        4  0
     d  wsrper                        2  0
     d  wstype                        1  0
     d  wsbunt                        5  0
     d  wslinj                        5  0
     d  wssequ                        1  0
6.NU d  wsbiln                        8  0
     d  wsbdat                         d   datfmt(*iso)
     d  wsdbkr                        1
     d  wslito                        4  0
      *
     d                uds
     d l_user                911    920
     d  lcwwus                        7    overlay(l_user)
      *
610  d wmem2           s             10
610  d wmem3           s             10
612  d xjmemb          s              7
     d wpuser          s              7
     d w_user          s              4
      *
     d w_neto          s             11  2
6.NU d w_biln          s              8  0
     d w_iavg          s              9  2
     d w_mngd          s              9  2
E5.30d w_mvab          s             11  2
     d w_mvag          s             11  2
     d w_valb          s             11  2
     d w_asum          s                   like(raasum)
      *
      * Definering av variable i nøkler
      *
6.31 d*raa4l1_4aar     s                   like(ra4aar)
6.31 d*raa4lu_4aar     s                   like(ra4aar)
     d ra01l1_akod     s                   like(raakod)
     d rzuml1_raar     s                   like(rzraar)
     d rzuml1_biln     s                   like(rzbiln)
     d rzuml1_bdat     s                   like(rzbdat)
     d rzuml1_tell     s                   like(rztell)
      *
     d w_firm          s                   like(rjfirm)
      *
      *  Hovedboksposteringer
      *
     irjoupfr
     i                                          zjmemb
     i                                          zjfirm        l8
     i                                          zjraar        l7
     i                                          zjrper        l6
     i                                          zjkont        l5
     i                                          zjspes        l5
     i                                          zjavde        l5
     i                                          zjpros        l5
     i                                          zjakti        l5
6.20 i                                          zjupro        l5
6.20 i                                          zjarbo        l5
6.30 i                                          zjbiln        l5
     i                                          zjbilk        l4
     i                                          zjvalk        l3
     i                                          zjmvak        l2
     i                                          zjbdat        l1
6.30 i*                                         zjbiln        l1
      *
     c/eject
      *
      *
612   * Tester member inn
612  c                   if        zjmemb <> wmem2
612  c                   eval      w_neto = 0
612  c                   goto      slutt
612  c                   endif
      *
     c                   if        zjkont = 3010
     c                   eval      zjkont = zjkont
     c                   eval      zjbilk = zjbilk
     c                   eval      zjreid = zjreid
     c                   eval      zjbdat = zjbdat
     c                   eval      zjbiln = zjbiln
     c                   endif
      *
      * Brudd på firma
      *
     c   l8              do
     c                   move      zjfirm        w_firm
     c                   enddo
      *
      * Sjekk om bilagskode skal summeres
      *
     c   l4              do
      *
     c                   eval      *in25 = *off
      *
     c                   move      zjbilk        ra01l1_akod
     c     ra01l1_key    chain     ra01l1
      *
     c                   if        %found
     c                   eval      w_asum = raasum
     c                   else
     c                   eval      w_asum = *blank
     c                   endif
      *
      * Poster fra scanning/Flow summeres ikke
      *
     c                   if        w_user = 'MULT' or
     c                             w_user = 'FLOW'
     c                   eval      *in25 = *off
      *
     c                   else
      *
      * Bare poster fra eksterne systemer summeres
      *
     c                   if        lcwwus <> wpuser and
     c                             w_asum = '1'
     c                   eval      *in25 = *on
     c                   endif
      *
     c                   endif
      *
     c                   enddo
      *
      *  vedr xml_rapp f.o.m. 01.01.2017 MÅ ingen posteringer summeres
      *
     c*  tatt ut igjen   eval      *in25 = *off
      *
      * Behandle brudd
      *
     c   l1              if        *in25
      *
      * Hent neste bilagsnummer
      *
6.31 c*                  move      zjraar        raa4l1_4aar
6.31 c*    raa4l1_key    chain     raa4l1                             31
6.31  *
6.31 c*                  if        ra4sgb + 1 > 99999998
6.31 c*                  eval      w_biln = *zeros
6.31 c*                  else
6.31 c*                  eval      w_biln = ra4sgb + 1
6.31 c*                  endif
      *
      * Nullstill summeringsfelt
      *
     c                   eval      w_neto = 0
     c                   eval      w_mvag = 0
     c                   eval      w_mvab = 0
     c                   eval      w_iavg = 0
     c                   eval      w_valb = 0
     c                   eval      w_mngd = 0
      *
     c                   eval      rztell = 0
6.30 c**                 move      w_biln        rzbiln
     c                   eval      w_biln = w_biln
6.30 c                   move      zjbiln        rzbiln
     c                   move      zjbdat        rzbdat
      *
     c                   endif
      *
     c                   exsr      flytt_poster
      *
      * Legg ut poster som ikke skal summeres
      *
     c                   if        *in25 = *off or
     c                             zjreid <> 'H'
610  c                   eval      rjnivo = *blank
610  c                   eval      rjmemb = wmem3
610  c                   time                    rjedat
610  c                   time                    rjetim
610  c                   eval      rjeusr = l_user
     c                   write     rjoulur
     c                   endif
      *
      * Legg ut poster som skal summeres i RZUMPF
      *
     c                   if        *in25 = *on and
     c                             zjreid = 'H'
     c                   exsr      skriv_summer
      *
      * Summer beløp og mengde
      *
     c                   eval      w_neto = w_neto + zjneto
     c                   eval      w_mvab = w_mvab + zjmvab
     c                   eval      w_mvag = w_mvag + zjmvag
     c                   eval      w_iavg = w_iavg + zjiavg
     c                   eval      w_valb = w_valb + zjvalb
     c                   eval      w_mngd = w_mngd + zjmngd
      *
     c                   endif
      *
610  c                   delete    rjoul3
     c     slutt         tag
      *
      /eject
      *
      * Legg ut sumrecord på posteringsfil
      *
     cl1 25              do
     cl1                 if        w_neto <> 0
      *
     cl1                 exsr      flytt_summer
      *
610  cl1                 eval      rjnivo = *blank
610  cl1                 eval      rjmemb = wmem3
610  cl1                 time                    rjedat
610  cl1                 time                    rjetim
610  cl1                 eval      rjeusr = l_user
     cl1                 write     rjoulur
      *
      * Oppdater sist brukte bilagsnr.
      *
6.31 c*l1                 move      zjraar        raa4lu_4aar
6.31 c*l1   raa4lu_key    chain     raa4lu
6.31 c*l1                 move      w_biln        ra4sgb
      *
6.31 c*l1                 if        %found and *inu4
6.31 c*l1                 update    raa4lur
6.31 c*l1                 endif
      *
     cl1                 endif
     cl1                 enddo
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for flytting av poster                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     flytt_poster  begsr
      *
     c                   move      zjreid        rjreid
     c                   move      zjfirm        rjfirm
     c                   move      zjkont        rjkont
     c                   move      zjspes        rjspes
     c                   move      zjavde        rjavde
     c                   move      zjmvap        rjmvap
     c                   move      zjmmrk        rjmmrk
     c                   move      zjbdat        rjbdat
     c                   move      zjbiln        rjbiln
     c                   move      zjbilk        rjbilk
     c                   move      zjtext        rjtext
     c                   move      zjneto        rjneto
     c                   move      zjmvag        rjmvag
     c                   move      zjamva        rjamva
     c                   move      zjpmva        rjpmva
     c                   move      zjmvab        rjmvab
     c                   move      zjiavg        rjiavg
     c                   move      zjpiva        rjpiva
     c                   move      zjstar        rjstar
     c                   move      zjmvak        rjmvak
     c                   move      zjfeik        rjfeik
     c                   move      zjatte        rjatte
     c                   move      zjtype        rjtype
     c                   move      zjrper        rjrper
     c                   move      zjraar        rjraar
     c                   move      zjbunt        rjbunt
     c                   move      zjlinj        rjlinj
     c                   move      zjrefn        rjrefn
     c                   move      zjfdat        rjfdat
     c                   move      zjopdt        rjopdt
     c                   move      zjpros        rjpros
     c                   move      zjvalk        rjvalk
     c                   move      zjvalb        rjvalb
     c                   move      zjmngd        rjmngd
     c                   move      zjmngk        rjmngk
     c                   move      zjresn        rjresn
     c                   move      zjress        rjress
     c                   move      zjresa        rjresa
     c                   move      zjresm        rjresm
     c                   move      zjvirk        rjvirk
     c                   move      zjmvag        rjmvag
     c                   move      zjkrys        rjkrys
     c                   move      zjrstb        rjrstb
     c                   move      zjrstv        rjrstv
     c                   move      zjakti        rjakti
6.20 c                   move      zjupro        rjupro
6.20 c                   move      zjarbo        rjarbo
     c                   move      zjbetb        rjbetb
     c                   move      zjbref        rjbref
     c                   move      zjlfak        rjlfak
     c                   move      zjkidi        rjkidi
     c                   move      zjdeck        rjdeck
     c                   move      zjjour        rjjour
     c                   move      zjblde        rjblde
T5.50c                   move      zjbong        rjbong
     c                   move      zjflgr        rjflgr
     c                   move      zjsort        rjsort
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for flytting av sumposter                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     flytt_summer  begsr
      *
     c                   move      zjsort        wssort
     c                   eval      wslinj = *zeros
     c                   move      '3'           wssequ
     c                   move      3333          wslito
6.30 c**                 move      w_biln        wsbiln
     c                   eval      w_biln = w_biln
6.30 c                   move      zjbiln        wsbiln
     c                   move      wssort        rjsort
      *
     c                   move      zjreid        rjreid
     c                   move      zjfirm        rjfirm
     c                   move      zjkont        rjkont
     c                   move      zjspes        rjspes
     c                   move      zjavde        rjavde
     c                   move      zjmvap        rjmvap
     c                   move      zjmmrk        rjmmrk
     c                   move      zjbdat        rjbdat
     c                   move      zjbilk        rjbilk
     c                   move      zjtext        rjtext
     c                   move      zjamva        rjamva
     c                   move      zjpmva        rjpmva
     c                   move      zjmvab        rjmvab
     c                   move      zjpiva        rjpiva
     c                   move      zjstar        rjstar
     c                   move      zjmvak        rjmvak
     c                   move      zjfeik        rjfeik
     c                   move      zjatte        rjatte
     c                   move      3             rjtype
     c                   move      zjrper        rjrper
     c                   move      zjraar        rjraar
     c                   move      zjbunt        rjbunt
     c                   move      zjlinj        rjlinj
     c                   move      zjrefn        rjrefn
     c                   move      zjfdat        rjfdat
     c                   move      zjopdt        rjopdt
     c                   move      zjpros        rjpros
     c                   move      zjvalk        rjvalk
     c                   move      zjmngk        rjmngk
     c                   move      zjresn        rjresn
     c                   move      zjress        rjress
     c                   move      zjresa        rjresa
     c                   move      zjresm        rjresm
     c                   move      zjvirk        rjvirk
     c                   move      zjkrys        rjkrys
     c                   move      zjrstb        rjrstb
     c                   move      zjrstv        rjrstv
     c                   move      zjakti        rjakti
6.20 c                   move      zjupro        rjupro
6.20 c                   move      zjarbo        rjarbo
     c                   move      zjbetb        rjbetb
     c                   move      zjbref        rjbref
     c                   move      zjlfak        rjlfak
     c                   move      zjkidi        rjkidi
     c                   move      zjdeck        rjdeck
     c                   move      zjjour        rjjour
     c                   move      zjblde        rjblde
T5.50c                   move      zjbong        rjbong
      *
     c                   move      raatxt        rjtext
6.30 c**                 move      w_biln        rjbiln
     c                   eval      w_biln = w_biln
6.30 c                   move      zjbiln        rjbiln
     c                   move      w_neto        rjneto
     c                   move      w_mvag        rjmvag
     c                   move      w_mvab        rjmvab
     c                   move      w_iavg        rjiavg
     c                   move      w_valb        rjvalb
     c                   move      w_mngd        rjmngd
      *
     c                   eval      rjvirk = *blanks
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for å skrive sumposter                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     skriv_summer  begsr
      *
     c                   move      zjfirm        rzfirm
     c                   move      zjraar        rzraar
     c                   movel     zjbdat        rzbdat
6.30 c*                  move      w_biln        rzbiln
6.30 c                   move      zjbiln        rzbiln
     c                   move      zjbiln        rzbilg
     c                   move      zjbill        rzbill
     c                   move      zjneto        rzbelØ
     c                   move      zjmvag        rzmvag
     c                   move      zjamva        rzamva
     c                   move      zjpmva        rzpmva
     c                   move      zjmvab        rzmvab
     c                   move      zjmvak        rzmvak
     c                   move      zjiavg        rzinvb
     c                   move      zjpiva        rzpiva
     c                   move      zjvalk        rzvalk
     c                   move      zjvalb        rzvalb
     c                   move      zjmngk        rzmngk
     c                   move      zjmngd        rzmngd
     c                   move      zjkont        rzkont
     c                   move      zjspes        rzspes
     c                   move      zjavde        rzavde
     c                   move      zjpros        rzpros
     c                   move      zjakti        rzakti
     c                   move      zjresn        rzresn
T5.50c                   move      zjbong        rzbong
      *
      * Gå om nødvendig i loop for finne ledig teller
      *
     c     rzopdt        tag
      *
     c                   eval      rztell = rztell + 1
     c                   eval      rzuml1_raar = rzraar
     c                   eval      rzuml1_biln = rzbiln
     c                   eval      rzuml1_bdat = rzbdat
     c                   eval      rzuml1_tell = rztell
     c     rzuml1_key    chain     rzuml1                             31
      *
     c                   if        *in31 = *off
     c                   goto      rzopdt
     c                   endif
      *
     c                   if        *inu4
6.11 c                   time                    rzodat
6.11 c                   time                    rzotim
6.11 c                   eval      rzousr = l_user
6.11 c                   time                    rzedat
6.11 c                   time                    rzetim
6.11 c                   eval      rzeusr = l_user
     c                   write     rzumlur
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
     c     *entry        plist
610  c                   parm                    wmem2
610  c                   parm                    wmem3
     c                   parm                    wpuser
      *
     c                   eval      w_user = wpuser
      *
      * Key for bilagskode
      *
     c     ra01l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra01l1_akod
      *
      * Key for sist brukte nr. - koderegister
      *
6.31 c*    raa4l1_key    klist
6.31 c*                  kfld                    w_firm
6.31 c*                  kfld                    raa4l1_4aar
      *
      * Key for sist brukte nr. - koderegister
      *
6.31 c*    raa4lu_key    klist
6.31 c*                  kfld                    w_firm
6.31 c*                  kfld                    raa4lu_4aar
      *
      * Key for summerte poster
      *
     c     rzuml1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rzuml1_raar
     c                   kfld                    rzuml1_biln
     c                   kfld                    rzuml1_bdat
     c                   kfld                    rzuml1_tell
      *
     c                   endsr
