# Documentation: BU990R – Store Sale Finalization

## Overview

**Program:** BU990R  
**System:** ASSHOP  
**Description:** Finalizes sales transactions from the POS (store cash register) system, transferring them to the central ERP for further processing (invoicing, order handling, statistics, etc.). It performs data migration, transformation, validation, and cleanup of store-side records, ensuring proper integration with downstream business systems.

This program is a key integration point between the store’s local transaction system and the central business system. It manages the end-to-end workflow for a sale: from reading raw sales records, through business rule enrichment, to writing finalized documents and cleaning up the originals.

---

## High-level Process Flow

1. **Initialization:**  
   - Receives firm and register (cash desk) as parameters.
   - Loads configuration and sets up validation rules.
   - Determines if certain modules (like ByggDok, Cobuilder, XL Club, etc.) are active.

2. **Validation of Store Setup:**  
   - Verifies the existence of the store code register (`bstsl1`) and order status register (`fstsl1`).
   - Aborts if required configuration is missing.

3. **Main Processing Loop:**  
   - Iterates through all sales headers (`bbhei2`) for the specified firm and register.
   - For each sale, invokes the main processing subroutine (`behandling`).

4. **Transaction Processing (`behandling`):**  
   - Validates the existence of associated sales lines.
   - Sums up sales line amounts, handling special cases (gift cards, deposits).
   - Determines order type based on business rules.
   - Fetches and enriches customer and project data.
   - Writes the finalized sale header and lines to the ERP system.
   - Handles special modules (ByggDok, Cobuilder, XL Club, etc.).
   - Cleans up processed records from store tables.

5. **Finalization:**  
   - Commits/rolls back transactions as needed.
   - Handles errors gracefully, with detailed logging and rollback on failure.

---

## Key Data Flows and File Relationships

- **Source Files (Store System):**
  - `bbhei2` – Sales header (ButikkHode)
  - `bbdti1` – Sales lines (ButikkLinje)
  - `bbhti1` – Sales header text (ButikkHodeTekst)
  - `bbbli1` – Payment transactions (Betalingstranser)
  - `bbkki1` – Card transactions

- **Target Files (ERP/Central System):**
  - `bohelur` – Finalized sales order header
  - `bodtlur` – Finalized sales order lines
  - `bobliur` – Finalized payment transactions
  - `bokklur` – Finalized card transactions
  - `bcdtstr`, `bchtstr`, `bchestr` – Historical/statistical records for new cash registers

- **Reference/Validation Files:**
  - `bstsl1` – Store code register
  - `fstsl1` – Order status register
  - `rkunl1`, `fkprl1` – Customer and customer project
  - `vvarl1`, `jvarl1` – Product master data
  - `fohel1`, `sdeplur` – Order/deposit registers
  - `rukrl4`, `rukrl5` – Card master data

- **Configuration/Feature Activation:**
  - `avall1` – Field validation rules (firm-specific)
  - `amodl1`, `afpslrr` – Module activation (ByggDok, Cobuilder, etc.)

---

## Business and Domain-Specific Logic

### 1. **Order Type Determination**

- Order type (`w_otyp`) is set based on the sale’s processing type (`bhbtyp`) and the net amount (`w_tnim`).
- There are multiple processing types (e.g., direct sale, invoice, packing slip, quick order), each mapped to specific order type codes.
- The program ensures that only valid combinations proceed; otherwise, the sale is skipped.

### 2. **Customer and Project Data Enrichment**

- If a customer is not specified, a default customer is used.
- Customer and customer project data (discounts, payment terms, project info) are fetched and used to populate the finalized order.
- If a project is linked, additional location and contact information may be pulled from the project or associated purchase order.

### 3. **Discount and Totals Calculation**

- The program recalculates sales totals, applying up to four different discount levels (two standard, two special).
- Handles historical “quirks” for backwards compatibility with legacy cash register logic, such as storing net price after discount and blanking the discount field.

### 4. **Card and Payment Handling**

- Card transactions are cross-referenced with card master data to enrich with card type, customer, etc.
- Only unique combinations of sale and card number are recorded.
- Special handling for certain card types (BM, Maxbo, GE) and payment methods (Santander, PayEx, Vipps), with data written to dedicated tables.

### 5. **Deposit Handling**

- If a sale involves a deposit, the corresponding order’s deposit balance is updated.
- If the order or deposit record is missing, a fallback record is created for error tracking.

### 6. **ByggDok and Cobuilder Integration**

- If activated, the program checks if the sale/project requires ByggDok or Cobuilder documentation.
- Contact and email addresses are determined based on customer, project, or contact person records.
- Records are written to the ByggDok file if all criteria are met.

### 7. **Validation Rules (Firmastyrt validering)**

- The program reads validation rules from `avall1` to determine if delivery address, delivery method, or customer name are required.
- If required fields are missing, default values (e.g., invoice address) are substituted.

### 8. **Cleanup and Data Integrity**

- After successful processing, all original store-side records (headers, lines, texts, payments, card transactions) are deleted for the processed sale.
- This ensures no double-processing and keeps the store system lean.

---

## Error Handling and Transaction Control

- **File Errors:**  
  All file operations use `infsr(FileErr)` to trap and log database errors. On file error, the program sets a status and error text for return to the caller.

- **General Errors:**  
  The main PSSR routine logs detailed error information (including job, line number, and exception data) and rolls back any open transactions if commitment control is active.

- **Commitment Control:**  
  The `COMFLAG` parameter controls whether commitment control is used. If enabled, each sale is committed after successful processing, ensuring atomicity.

---

## Notable Design Patterns and Conventions

- **Data Migration/Transformation:**  
  The program is structured as a migration pipeline: read, validate, enrich, write, cleanup.

- **Backward Compatibility:**  
  Numerous “drittlogikk” (workarounds) are present to ensure compatibility with legacy systems and historical business rules.

- **Feature Switches:**  
  Activation of optional modules (ByggDok, Cobuilder, XL Club) is controlled via configuration files and switches, allowing for flexible deployment across different stores/clients.

- **Extensive Use of Subroutines:**  
  Major steps (header writing, line writing, stock update, invoice handling, etc.) are encapsulated in subroutines for maintainability.

- **Error and Exception Logging:**  
  The program is defensive, with comprehensive error trapping and logging, ensuring that operational issues are traceable.

- **Key List Usage:**  
  All file access is via named key lists, which are initialized in the `*inzsr` subroutine, centralizing key management.

---

## External Program Calls

- **Order/Invoice Number Assignment:**  
  - `VA752R` – Determines number series type (overrides).
  - `AS100R` – Fetches next available number.

- **Order/Invoice Processing:**  
  - `BO700R`, `BO710R` – Writes orders/invoices to ERP.
  - `AP600R` – Sets values for printing.

- **Stock Update:**  
  - `VL001R` – Updates inventory.

- **Validation and Configuration:**  
  - `RS717R` – Fetches delivery method text.
  - `CO402R` – Checks feature switches (Cobuilder, XL Club).

- **Deposit and Payment Handling:**  
  - `FA924R` – Updates accumulated discounts.
  - `BU925R` – Deletes orders processed in the store.

---

## Special Considerations and Known Quirks

- **Legacy Data Handling:**  
  - Several business rules exist solely to maintain compatibility with old cash register systems, e.g., sign handling, discount field logic.

- **Order/Invoice Number Uniqueness:**  
  - When assigning numbers, the program checks that the newly assigned number is not already in use.

- **Field Normalization:**  
  - Many fields are uppercased for consistency if a certain flag (`baahoy`) is set.

- **Multiple Discount Levels:**  
  - The calculation logic for discounts is layered and must be maintained carefully to avoid double deduction.

- **ByggDok/Cobuilder:**  
  - These integrations are subject to configuration and may not be active in all environments.

---

## Summary Table: Key Subroutines

| Subroutine      | Purpose                                                         |
|-----------------|-----------------------------------------------------------------|
| behandling      | Main processing for each sale                                   |
| bong_hode       | Writes finalized sale header                                    |
| bong_linje      | Writes finalized sale lines and updates inventory               |
| lager           | Calls inventory update program                                  |
| faktura         | Handles invoice creation and printing                           |
| pakkseddel      | Handles packing slip creation and order number assignment       |
| hurtigordre     | Handles quick order creation                                    |
| sbform          | Fetches delivery method text                                    |
| hent_nummer     | Assigns next available order/invoice number                     |
| depo_inn        | Updates deposit on order                                        |
| slett_ordre     | Deletes orders processed in the store                           |
| byggdok         | Writes ByggDok/Cobuilder records if required                    |
| *pssr           | General error handling and rollback                             |
| FileErr         | Handles file/database errors                                    |

---

## Integration Points

- **Store System:**  
  Reads all transactional data from store-local tables.

- **ERP/Central System:**  
  Writes finalized documents (orders, invoices, payments, stock movements).

- **External Services/Modules:**  
  ByggDok, Cobuilder, XL Club, feature switches, and configuration are integrated via external program calls and configuration files.

---

## Onboarding Notes

- **Extensive Change History:**  
  The program has grown organically with many customer/feature-specific modifications. Always check for existing logic before introducing new business rules.

- **Configuration-driven Behavior:**  
  Many features are toggled via configuration files or database switches. Test thoroughly in your environment.

- **Data Integrity is Paramount:**  
  The program is designed to ensure that only fully-processed sales are removed from the store system. Pay careful attention to error handling and transaction control.

- **Legacy Compatibility:**  
  Be aware of “drittlogikk” sections—they exist for a reason, often to support legacy business processes or data structures.

---

## Conclusion

BU990R is a central, business-critical program responsible for the correct and complete migration of sales transactions from the store POS system to the central ERP. It is highly configurable, extensible, and defensive in its error handling. When working with or modifying this program, always consider the broader integration context, the need for backwards compatibility, and the importance of data integrity across disparate business systems.