# RPG Program VV530R - Explanation and Overview

---

## Purpose and Context

This RPG program, `VV530R`, is a legacy IBM i (AS/400) application. The program is used for product (goods) enquiry, especially focused on searching, querying, and printing "plakat" (sign/label) information related to items (varer).

The comments and structure suggest a flexible search and browse interface with subfile paging, group-based filtering, and integration with several supporting programs and files. Interfaces seem tailored for use in a retail or warehouse environment (e.g., NOBB numbers – Norwegian building products registry).

---

## Program Structure

### 1. **Header and Documentation**

- The `h` spec sets program options, including debugging restrictions and date editing format (*dmy*).
- A commented changelog details versions, changes, and authors.
- Detailed explanations of indicator usage (LR, function key indicators, error and work indicators).

### 2. **File and Display Declarations**

- **Physical/Logical Files (`f` specs):**
  - *vvsopf*, *vvarlr*, *vvarl1*... (various views on item master and related files)
  - *vplal1* (plakat records)
  - *rlevl1* (supplier info)
  - *vsdtl7*, *vshel1*, *fstsl1*, *vvlel1* (various auxiliary information for item status, assortment, etc.)
- **Display File:**
  - *vv530d* (main workstation file), with a subfile definition for paging (*sfile(b1sfl:w_srrn)*), and display feedback data structure (`infds`).

### 3. **Data Structures and Variables**

- Local Data Area fields (Company, Warehouse, User Name).
- Display feedback structure for cursor location.
- Key "work" fields for chaining and searching in files, using `like()` for type safety.
- Working variables for subfile paging, selections, quantities, search texts, etc.
- Constants for subfile size and null EAN pad.

### 4. **Subfile Field Explanations**

- Details on variables like *w_fcrn*, *w_srrn*, *w_ssrn* (paging), and subfile record formats.

### 5. **Indicator and Function Key Handling**

- Extensive use of indicators for program flow, subfile operations, error/warning messaging, protected fields, etc.
- Function keys (F6, F9, F13, F21, F22, F23...) trigger actions like create item, repeat search, scanning, toggle options.

### 6. **SQL Operations**

- Embedded SQL (`/Exec SQL ... /End-Exec`) to switch date format and fetch/search item records as part of subfile fill-up routines.

---

## Main Program Flow

### **Tag-Based Control Structure**

- `b2taga` and `b2tagb` are used as labels for flow control (GOTO pattern; typical in legacy RPG).
- After the initial display, a loop presents the main subfile (list of records), processes function keys, and offers options to search, page, view, print, or scan items.

### **Function Key Processing**

- The main SELECT block checks function key indicators and dispatches to subroutines or external programs for the requested function.
- E.g., F6=Create, F9=Repeat search, F13=Scan EAN, F21/F22/F23 for toggling filters/info.

### **Search & Positioning**

- User can search by group, main group, subgroup, or by various item number types (internal, NOBB, supplier).
- Search routines fill the subfile using keyed access or SQL depending on the search type.

### **Subfile Handling**

- Subfiles are managed with routines to clear (`clr_subfile`), fill (`crt_subfile`), display (`dsp_subfile`), and page backwards (`bck_subfile`).
- Handles both classic keyed reading and SQL cursor fetching.
- Supports search term "tokenization" to match on multiple "words" in a search string.

### **External Program Calls**

- Calls out for logic such as:
  - Showing/printing item detail (`VV510R`, `VR100R`)
  - Getting price group, VAT rates, assortment status, etc.
  - Lookups for suppliers, EAN validation, assortment validation.

### **Indicator-Driven Paging and Highlighting**

- Special attention to status (e.g., items that are centrally stocked, period controlled, or soon obsolete are annotated or color-coded).
- Information for display is composed and indicators are set for field protection, warnings, etc.

---

## Key Subroutines

### **forny**
- Repositions file cursors based on the current search criteria.
- Clears & refills the subfile accordingly.

### **søk**
- Handles group-based search validation and populates subfile according to group/keyword.

### **posisjoner**
- Handles positioning by item number, text, NOBB or supplier number.

### **subfile**
- Reads and processes user-selected records within the subfile.
- Supports viewing, printing, external queries per record.

### **crt_subfile**
- Fills subfile page with either SQL or keyed IO, depending on search mode.
- Calls pricing, VAT, and assortment routines.

### **bck_subfile**
- Allows paging backward through results.

### **dsp_subfile**
- Controls display of control and command records for the subfile.

### **spørring**
- Handles calls for pop-up selection windows for groups (overgruppe, hovedgruppe, undergruppe).

### **scanning**
- Handles barcode/EAN scanning input and validation.

### **sjekk_vsor**
- Checks if an item is in the relevant assortment (central/periodical) for special status display.

---

## Initialization (*INZSR)

- Sets up all file keys
- Loads company and warehouse info.
- Sets initial indicators and values (e.g., F22/F80 on for initial display).
- Fetches current date and VAT rates.
- Positions and fills the initial subfile view.

---

## **Best Practices, Design Patterns, and Legacy RPG Elements**

- **Subfile Paging**: Standard approach with counters, page and record numbers, and fill-up/clear routines.
- **Indicator-Driven Flow**: Heavy reliance on RPG's numbered indicator paradigm.
- **GOTO & Labels**: Use of `tag` and `goto` is old-fashioned but common in classic RPG.
- **Separation of Concerns**: Subroutines handle different UI and data logic chunks.
- **External Calls**: Reuse of business logic in other programs/files.

---

## **Onboarding Notes**

- **Business Knowledge**: Understanding item master structure, groupings, and NOBB usage is important.
- **Files and File Keys**: Know both RPG keyed and SQL access methods.
- **Indicators**: Familiarize with which indicators control which UI or logic aspect (see the comments at the top).
- **Paging Logic**: Study how `w_srrn`, `w_spge`, etc., interact to manage subfile paging.
- **Multi-Program Integration**: Recognize dependencies on other programs (e.g., price/VAT modules).
- **Error Handling**: Error/validation feedback via indicators and subfile warning lines.

---

## **Summary Table**

| Routine           | Purpose                                           |
|-------------------|--------------------------------------------------|
| forny             | Refreshes subfile after actions/search           |
| søk               | Handles search logic by group/keyword            |
| posisjoner        | Positions subfile to specific item/key           |
| subfile           | Processes user item selection in subfile         |
| crt_subfile       | Fills subfile using SQL/keyed I/O                |
| clr_subfile       | Clears subfile                                   |
| bck_subfile       | Steps back through paged subfile results         |
| dsp_subfile       | Displays subfile and screen                      |
| spørring          | Handles group/selection popup windows            |
| scanning          | EAN/barcode scanning and lookup                  |
| sjekk_vsor        | Assortment checking for special status display   |
| *INZSR            | Initialization, file keys, first page fill       |

---

## **Final Notes**

This program is a classic RPG application with a focus on subfile-based user interfaces for item search and maintenance. It integrates with a broader system, depending on external routines for business logic, making it robust but complex to maintain. Modernizing this would involve replacing extensive indicator usage and GOTO labels with structured logic and modularization.

**Familiarity with IBM i subfile handling, RPG indicator management, and the business domain (item master, NOBB, assortment, plakat) will help you work efficiently with this program.**