# RPG Program RL510R - Code Explanation

This RPG/400 (ILE RPG, fixed-format) program is a maintenance/inquiry utility for supplier postings ("Leverandørposteringer"), focusing on inquiry by voucher/document numbers and amounts for an accounting system. It's designed for display file (screen) interaction using subfiles and handles various search and display scenarios, including integration with document archives.

Below, you'll find a structured explanation highlighting key areas for onboarding new developers.

---

## 1. **Program Metadata and History**
- The heading comments describe the program’s purpose and record a detailed change log with versioning notes. Changes relate to:
  - New features (search fields, GUI changes, document type retrieval)
  - File structure adjustments
  - Archive/document interface logic

---

## 2. **File Definitions**
- **Physical and Logical Files**: The program accesses several database physical/logical files (e.g., `rltrlc`, `rltrl3`, `rltrle` etc.) using IF (input, full procedural), with explicit keying for record-level access.
- **Display File**:
  - `frl510d` is defined as a workstation file with subfile capabilities (`sfile(b1sfl:w_srrn)`).
  - Uses an information data structure (`infds(dspfbk)`) for feedback such as cursor position.

---

## 3. **Data Structures and Variables**
- **Local Data Area (LDA)**: Fields for user, company (firm), and user name.
- **Display Feedback Structure**: For screen state, such as first subfile row number.
- **Key Variables**: Used to compose keys for file access, e.g., `rltrlc_raar`, `rltrlc_biln`.
- **Working Variables**: For subfile paging, navigation, selected record details, search sequence, page control, etc.
- **Constants**: E.g., `c_sfil` for subfile page size.

---

## 4. **Indicator Usage**
- Standard RPG indicators (LR, 10–99) are used for control flow, subfile handling, screen formatting, error signaling, etc.

---

## 5. **Subfile and Display Handling**
- **Paging Variables**: Definitions and explanations for subfile row numbers, page sizes, and pointers for current, last, and next pages.
- **Screen Images**: Noted record formats for subfiles and control screens.

---

## 6. **Main Program Flow**
### *Main Loop (Tags: b2taga, b2tagb)*
1. **b2taga**: Displays function-key/cmd window (`write b2cmd`)
2. **b2tagb**: Displays/refreshes the subfile (list of postings) via `exsr dsp_subfile`
3. **Function Key Handling** (`select` block after tags):
   - Exit program (`goto avslutt`)
   - Refresh (`exsr forny`)
   - Page forward/back (`exsr crt_subfile/bck_subfile`)
   - Home key (`*in21`): set cursor placement
4. **Positioning Logic**: If any search fields are present, calls `posisjoner` to re-position the subfile.
5. **Subfile Processing**: Calls `subfile` subroutine for record-level interaction.

---

## 7. **Key Subroutines Explained**

### a. **forny** (Refresh Subfile)
- Repositions and refreshes the subfile according to the last used key (voucher number, supplier invoice number, amount, date, etc.), based on the search mode. 
- Calls `clr_subfile` to clear, and `crt_subfile` to refill.

---

### b. **posisjoner** (Position Subfile)
Handles user-initiated searches:
- If a company-year is entered, sets up for voucher number search.
- Handles search by:
  - Voucher number
  - Supplier invoice number
  - Amount
  - Posting date
- Sets up appropriate file keys and prepares subfile for new search results.
- Afterwards, blanks out the search fields.

---

### c. **subfile** (Process Subfile Rows)
- Toggles page indicator
- Reads and processes each subfile record with `readc` (change-driven read).
- Responds to selection codes (e.g., 5 for "View", 9 for "Archive View"):
  - For "View", calls `xc2win` subroutine (shows details for a posting)
  - For "Archive View", checks user access, fetches document type, and invokes archive view programs using CALL/PARM.
- Updates each subfile record after processing.

---

### d. **clr_subfile** (Clear Subfile)
- Turns on subfile clear indicator, writes control format (`b2ctl`), then resets indicators and paging variables.

---

### e. **crt_subfile** (Create/Fill Subfile)
- Calculates next subfile page boundaries, then:
- Reads from the appropriate logical file by sequence (`w_seqe`: B, N, M, L, etc.)
- Fills subfile fields for each row, including fetching supplier names when available
- Writes records to the subfile until the page is filled or data ends.

---

### f. **bck_subfile** (Page Backwards Subfile)
- For subfile paging backwards: repositions by setting key and reading previous records, skips until page boundary is reached, then refills the subfile.

---

### g. **dsp_subfile** (Display Subfile)
- Displays subfile control screen with current records/page.

---

### h. **xc2win** (View Posting Details)
- Retrieves and loads posting and supplier details for the selected subfile row into fields for the detail screen.
- Displays the detailed window format (`exfmt c2win`), handles user return.

---

### i. **Initial Subroutine (\*inzsr)**
- Sets up key lists for all file accesses.
- Initializes search and paging variables.
- Loads subfile for the current year.

---

## 8. **Search and Sequence Logic**
- The program supports lookups by different criteria (voucher number by year, by bilagnr regardless of year, supplier invoice number, amount, date).
- The logical file and key composition change depending on the search mode (`w_seqe`), supporting flexible, multi-field inquiry.

---

## 9. **Archive, Document Integration**
- There is support for looking up and displaying documents from external archive systems (via calls to `AP622C` or `AH720C`), including logic to establish the correct document type and reference.

---

## 10. **Notes on Extensibility**
- Most changes/additions are controlled with versioning tags in comments (e.g., `T5.60`, `6.25`) for easy identification of customization points.
- Integrations with parameters and call interfaces are isolated to specific search sequences.

---

## 11. **Special Field and Format Mapping**
- Comments and code clearly annotate fields that are used only for display, paging, and control versus those for main data access.
- Subfile and detail format fields are mapped in code for clarity.

---

## 12. **Error and Exception Handling**
- Uses standard RPG indicator handling for error situations, such as failed record fetches (e.g., `chain` with indicator 61 for supplier record not found).

---

## 13. **Code Organization**
- The code is highly modular within the constraints of RPG fixed format, with each subroutine handling a single aspect of program logic.

---

# Summary Table

| Subroutine     | Functionality                         |
|----------------|--------------------------------------|
| forny          | Refreshes the subfile                |
| posisjoner     | Positions the subfile by user search |
| subfile        | Processes subfile records            |
| clr_subfile    | Clears the subfile                   |
| crt_subfile    | Creates/fills the subfile            |
| bck_subfile    | Backs up a page in the subfile       |
| dsp_subfile    | Displays the subfile screen          |
| xc2win         | Shows detail for a posting           |
| *inzsr         | Program initialization logic         |

---

# **Use Cases (Scenarios)**

1. **User starts program**: Subfile is initialized and filled for current year.
2. **User performs search**: Inputs values for voucher #, invoice #, amount, or date; subfile is repositioned and refilled.
3. **User pages through list**: Subfile paging handled by next/back routines.
4. **User selects row**: Can view details, or request to see the attached document in archive (if available).
5. **User exits program**: Cleanup and end program.

---

# **Onboarding Tips**

- **Start**: Familiarize yourself with the display file (`FRL510D`), especially subfile format layouts and function keys.
- **Understand**: The search sequences and how they map to logical files.
- **Debug**: Use indicators and comments to follow the main navigation and error handling steps.
- **Extend**: When integrating with new archives or changing logic, locate version tags and related subroutine calls.

---

**In summary**: RL510R is a robust inquiry and display utility centered around supplier posting records, with dynamic search, rich display, subfile paging, and document integration, written following RPG best practices for modularity and clarity.