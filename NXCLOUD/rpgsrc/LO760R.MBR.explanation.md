# RPG Program Overview and Explanation

This RPG IV/ILE program (`LO760R`) generates purchase order files in EDIFACT EDI format. The output is a structured order message for external communication—e.g., with suppliers, logistics providers, or a centralized EDI gateway (like IBM FMS). The code is written following Norwegian business and logistics conventions (variable/field names, comments, and EDI layout).

## High-Level Flow

1. **Initialization**: Sets up database file pointers, declares data structures, and initializes variables.
2. **Parameter Intake**: Receives order number and suffix as input parameters.
3. **Master Data Lookup**: Retrieves company, order, supplier, inventory location, and other master records.
4. **Header EDI Segment Creation**: Builds and writes the header segments (ED00–ED09) for the order.
5. **Detail Line Processing**: Loops through all line items, processes each for item number, description, quantities, etc., and writes corresponding EDI detail segments (ED10–ED13).
6. **Special Logic**: Handles NEB-standard suppliers, logistics item numbers, and address overrides for external warehouses.
7. **Termination**: Cleans up and returns.

---

## Core Concepts in the Code

### 1. **File Definitions**

- `F`-specs define database/tables accessed (many are renamed for local usage).
- Multiple files are opened for reading key master and transaction info.
- Output files (`lwedpfr`, `lwelpfr`) are used to write the EDI message lines.

### 2. **Data Structures**

- **EDI Segments**: Each EDI segment (ED00-ED13, ED99) has an 80-character buffer, with overlay fields for individual segment elements.
- **Keys**: Keylists are defined for easy lookup into relevant tables (e.g., for order headers, line items, supplier, etc.).
- **Work Variables**: Used for assembling values, tracking flags, and temporary fields for processing.

### 3. **Program Sections**

#### a. **Initialization (`*inzsr`)**

- Sets up input parameters (`p_numm`, `p_suff`).
- Initializes various keys and variables, loads date/time.
- Calls external programs `CO402R` to determine whether to use GLNs from logistics points for Buyer or Sender (flags `u_s701`, `u_s702`).

#### b. **Master Data Fetching**

- Looks up company, order header, supplier, warehouse records.
- Loads addresses, GLNs (EANs), and other key master information.
- Handles fallbacks if direct records are not found, and assigns blanks/zeros as needed.

#### c. **Header Segment Writing**

- Assembles and writes EDI segments for the order header, including:
  - **ED99**: Communication line to IBM (if recipient/method matches).
  - **ED00-ED09**: Order meta-data (sender/receiver, date/time, references, addresses, delivery modes, etc.).
  - Handles NEB/Logistics number flags, buyer/seller address logic, and override logic for warehouse delivery points.

#### d. **Detail Line Loop**

- Iterates through order line items:
  - Skips internal line types and non-output lines via `sjekk_type`.
  - For item lines:
    - Calls `finn_varenr` to determine item numbers (EAN/GTIN, NOBB, logistics item number if flagged—uses VE723R, etc.).
    - Writes the corresponding EDI detail segments:
      - **ED10**: Item/reference numbers.
      - **ED11**: Line item descriptions.
      - **ED12**: Quantity and unit.
      - **ED13**: Any additional free text.

#### e. **Subroutines**

- **finn_varenr**: Fetches GTIN/EAN for an item line (calls external program), updates order line with found number, and determines alternative numbers.
- **sjekk_type**: Determines if a line is a text/freetext line, and whether it should be output.
- **finn_logpkt**: Finds logistics delivery point if needed, supports address override from external warehouse via SQL.
- **finn_logpkt2**: For 'Buyer' address override logic.
- **sjk_neb**: Checks if supplier is NEB standard, and sets the appropriate EDI format code.
- **sjk_logn**: Checks if supplier uses logistics item numbers.

---

## Notable Features

- **Overlays & Inz**: Data structures use overlays for efficient handling and composition of EDI lines, initialized with constants.
- **Conditional Addressing**: Delivery recipient address can be overridden from logistics point or external warehouse.
- **External Calls**: Calls external RPG and SQL for fetching keys/data not directly in working set.
- **Commented Change History**: Inline change logs provide traceability for business requirement changes over time.
- **Conditional Formatting**: Handles different output requirements (e.g., NEB01 vs. TBF10, buyer/seller logic, negative quantities).

---

## Important Business Rules Encoded

1. **NEB Standard Suppliers**: Use different EDI format code when supplier is flagged as NEB.
2. **Logistics Item Numbers**: For flagged suppliers, replaces normal supplier item number with logistics number.
3. **External Warehouse Delivery**: Uses address from external warehouse if flagged/setup in relevant tables.
4. **Faktura Supplier**: Supports invoice recipient being different from normal supplier (with fallback).
5. **Negative Quantities**: Supports order types with negative quantity lines, with appropriate sign handling.
6. **Field Length/Format Handling**: Handles number padding (e.g., postal codes), field overlays, and field type conversions carefully to match EDI specs.

---

## Typical Onboarding Advice

- **Understand the Data Model**: Identify what each file/table represents in the business (company, order, supplier, line item, customer, etc.).
- **EDI Segment Formats**: Get familiar with the EDIFACT segment structures (see how each field maps to a segment).
- **Trace the Document Flow**: Follow the mainline from initialization, through segment creation, to writing output files.
- **Business-Specific Flags**: Pay attention to fields like NEB, logistics item flag, buyer/seller distinctions—they control major logic paths.
- **External Dependencies**: Be aware of dependent programs (`VE723R`, `CO402R`) and SQL lookups for external data.
- **Localization**: Variable and field names are Norwegian and relate closely to business process terms.

---

## Example Process (Simplified)

1. Receive an order number and suffix.
2. Fetch all relevant header information (company, buyer, supplier, addresses, delivery requirements).
3. Compose and output EDI segments for the order's header.
4. For each order line:
   - Determine item identifiers (GTIN/EAN, NOBB, etc.).
   - Output EDI segments for item references, descriptions, and quantities.
   - Write any line-specific free text segments as needed.
5. End program and clean up.

---

## Key Takeaways

- This is a robust, mature RPG program for generating electronic purchase orders in a standard EDI format.
- It includes extensive master data lookups, flexible address and item number logic, and supports various special customer/supplier scenarios.
- The program is highly parameter-driven and dependent on correct data in master tables.
- Changes are well-documented, and the code is segmented into clear logical sections/subroutines, making maintenance and enhancements more manageable for experienced RPG/IBM i developers.

---

**If you need more detail on any specific routine, variable, or process, let me know!**