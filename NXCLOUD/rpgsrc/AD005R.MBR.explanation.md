```markdown
# RPG Program Overview: Kontroll av gyldig ordrenr

This RPG program, named `AD005R`, serves as an **access control check** for a user attempting to access a routine, option, or function in an application. The code uses traditional fixed-format RPG IV and references two files (`iadrl1` and `iadtl1`) to check access rights.

---

## Program Purpose

- **Main Function:**  
  Check if the user (identified by an access code) has permission to access a given routine, and possibly a specific option or function within that routine.  
- **Return Code:**  
  - `"Ok"` (access granted)  
  - `"Sperret"` (blocked)  
  - Can also return a code from the access definition (i.e., more specific reasons)
- **User Feedback:**  
  An error message is optionally displayed if access is denied.

---

## Sections Breakdown

### 1. File Declarations

```rpg
fiadrl1    if   e           k disk
fiadtl1    if   e           k disk
```
- Files `iadrl1` and `iadtl1` are used for access control lookups.
  - `iadrl1`: routines with access control
  - `iadtl1`: access rights per code and routine

---

### 2. Variable Definitions

- Key fields and parameter variables are defined based on file layouts (via `like`).
- Working variables for error messages and intermediate computations are also declared.

---

### 3. Main Logic

#### a. Is Routine Controlled?

```rpg
eval iadrl1_frm = *zero
eval iadrl1_rut = p_rutine
iadrl1_key chain iadrl1
if not %found(iadrl1)
    goto tilgok
endif
```
- If the routine isn't listed in `iadrl1`, **all users have access**. The program skips to the access granted section.

#### b. Access Code Checking

```rpg
if p_tilgko = *blank
    goto tilgav
endif
```
- If the user has **no access code**, access is denied.

#### c. Look Up Access in `iadtl1`

- Attempts to find a matching record in `iadtl1` based on the access code and routine.  
  - If not found, tries progressively more general codes (by replacing the last characters with `* `).
  - If still not found, tries with `*ALL` as the code.

- If **no access record is found**, default is grant (goto `tilgok`).
- If an access record is found, but marked as blocked (`'J'`, `'JA'`, `'Ja'`), access is denied.

#### d. Return Access Status

- If the access record contains a code (in `iadtsp`), it is returned in `p_status`.
- Otherwise, `p_status` is set to `"Ok"`.

---

### 4. Option/Function Key Checks

- If a specific option (valg) or function key (funksjonstast) is provided in `p_valgfu`, additional checks are performed:

  - For options/valg, the code parses the option number from the provided input and compares it against the block list for this access record.
  - For function keys, if the first character of `p_valgfu` is `'F'`, it checks if that specific function key is blocked.

  - If the option or function key is **blocked**, access is denied.

---

### 5. Access Granted or Denied

- **Label `tilgok`:**  
  Sets `p_status` to `"Ok"` if not already set.

- **Label `tilgav`:**  
  If error messages are enabled (`p_feilm = 'Ja '`), displays an error message with details about the denied access (using program `'AD009C'`).  
  Sets `p_status` to `"Sperret"`.

---

### 6. Program Ending

- Resets `p_valgfu` to blank, signals program end with `*inlr = *on`, and returns.

---

### 7. Initialization Subroutine

```rpg
*inzsr begsr
...
endsr
```
- Receives parameters (`*entry plist`):
  - `p_tilgko`: Access code
  - `p_rutine`: Target routine
  - `p_valgfu`: Option/function
  - `p_status`: Controls error message display
- Sets up some working variables and key lists for use in the file lookups.

---

## Key Concepts

- **Files as Access Control Lists:**  
  The program uses lookup files to define who (by access code) can use what (routines/options).
- **Progressive Code Matching:**  
  If a full access code isn't found, it tries more generic codes (using wildcards), ending with `*ALL`.
- **Options/Function Key Blocking:**  
  User may be allowed into the routine, but specific options or function keys can be blocked.
- **Externalized Error Messages:**  
  Error text is built and displayed by an external program (`AD009C`).

---

## Takeaway for Onboarding

- **To add or modify access:**  
  Update the `iadrl1` (routines) or `iadtl1` (access rights) files.
- **Return behavior:**  
  The program writes its result to the `p_status` parameter, which the caller must check.
- **Error messages** are only shown if `p_status` is not set to `'Uten '`.
- **Modify or extend logic:**  
  All core logic is in the mainline; the code uses old-style fixed-format RPG IV, so modern developers may want to refactor to free format as a future improvement.

---
```