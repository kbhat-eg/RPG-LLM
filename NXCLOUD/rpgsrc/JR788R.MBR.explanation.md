# RPG Program JR788R - Source Code Explanation

## Program Purpose

This program is designed to process an input file (Kraftixx record format), updating prices for existing items in a price file (`LVR`). If a new item matches an EAN number in `LVR`, the price is created for the supplier as the price-giving supplier on that item. Price updates are always based on EAN-number matching.

## High-Level Flow

1. **Loads reporter (rapport√∏r) and supplier information**
2. **Processes each input record:**
   - Checks if item number is numeric
   - Uses EAN and item number to determine if price exists
     - If exists: update price if changed
     - If not: create a new price for existing item in master by EAN
   - Calls another program to update search text when prices are created or changed

---

## File Definitions

- `jrvapf`: Input file, read sequentially (file of input records)
- `jrapl1`, `jvprl2`, `jvarld`, `jlevl1`, `jvprlu`: Logical/physical files for lookups and updates, renamed to RPG record format names (using `rename`)

---

## Main Data Structures / Variables

- **Input Parameters:**
    - `p_list`: Input parameter containing all incoming info (firm, reporter, date)
    - `d_list`, `d_firm`, `d_rapp`, `d_dato`: Data structure overlays to extract firm, reporter code, and date from input
- **Kraftixx Input Record Decomposition:**  
    - `d_inpu`: Raw input record (130 chars)
    - Overlays: `d_san`, `d_vare`, `d_eann`, `d_tek1`, `d_pe`, `d_enhe`, `d_be`, `d_pris`, `d_pris_kr`, `d_pris_ore`, `d_side`, `d_xx`
    - Used to split and access fields like item number, EAN, text, and price
- **Keys for Database Lookups:**  
    - Variables for keys to various files (item, supplier, EAN, etc.)

- **Constants:**  
    - Lowercase/uppercase letters for text translation (xlate)
    - Digits string for numeric check

---

## Mainline Logic

### Initialization

- Loads input parameters, sets up keys for file access, extracts firm number.

### Loads Reporter and Supplier Info

- Looks up reporter by code and exits if not found.
- Looks up supplier by code.

### Processes Input Records (Subroutine `behandling`)

- Reads each record from `jrvapf`:
    1. Maps input record fields.
    2. Verifies item number is numeric using `check` against the `digits` constant.
    3. Pads EAN and price with zeroes as needed (`xlate`).
    4. Trims item number.
    5. Sets up keys for price lookup (`jvprl2`).
    6. Looks up item/price record:
        - If it exists, calls `endr_vare` (update price).
        - Otherwise, calls `oppr_vare` (create price).
    7. If item was created/changed, calls `JV790R` to update search text for the item.

### Subroutine: `oppr_vare` (Create Price for Existing Item by EAN)

- If EAN is zero, exit.
- Looks up item in item master (`jvarld`) by EAN.
- If not found, exit.
- Deletes any existing price entries for the supplier/item.
- Prepares and writes new price entry.
- Sets entry/user/timestamp fields.

### Subroutine: `endr_vare` (Update Price)

- If the price hasn't changed, exit.
- Updates existing price record with the new price, date, user info.
- Sets updated/timestamp fields.

---

## Other Details

- **Text Translation:**  
    - Converts supplier name to uppercase using `xlate`
- **End of Processing:**  
    - Sets on LR indicator (`*inlr = *on`) to end program and close files
- **Subroutines:**  
    - Each major logic section is split into subroutines for clarity (`oppr_vare`, `endr_vare`, `behandling`, `*inzsr` for initializations)
- **Calling Other Programs:**  
    - Calls `JV790R` after changes to update the search text for the item

---

## Summary Table of Main Entities

| Name      | Type           | Purpose                                      |
|-----------|----------------|----------------------------------------------|
| jrvapf    | Input file     | Input records with Kraftixx format           |
| jrapl1    | Lookup file    | Reporter info                                |
| jvprl2    | Lookup file    | Existing prices (check for update)           |
| jvarld    | Lookup file    | Item master (match by EAN)                   |
| jlevl1    | Lookup file    | Supplier master                              |
| jvprlu    | Update file    | Price file to create/update entries          |

---

## Key Takeaways

- The program **updates or creates price entries for items** based on supplier input files, using **EAN (item barcode) as the key**.
- **If a price exists, it's updated;** if not, and the item exists (by EAN), a new price entry is created for the supplier.
- **Search text** is updated for items when changed.
- There is **validation** for numeric item numbers and presence of EAN/item master records.
- The code leverages **RPG's data structure overlays** for field parsing and uses **standard database operations** (`chain`, `read`, `write`, `update`, `delete`).

---

This structure and detailed commenting should make onboarding much smoother for developers new to this program!