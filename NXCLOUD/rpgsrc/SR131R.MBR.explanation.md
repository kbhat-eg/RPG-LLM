# Program SR131R – ASSTAT Selection for Parameter File (Item Number Range)

This RPG IV program displays an “item number from/to” selection screen, validates input, and updates a parameter file accordingly.

---

## 1. Program Metadata
- **System:** ASSTAT  
- **Program:** SR131R  
- **Description:** Builds selection ranges (from/to item numbers) into a parameter file.

---

## 2. File Declarations
```rpg
fSR131d    cf   e             workstn         // Display file (DSPF) for the screen
fslpml1    if   e           k disk    rename(slpmpfr:slpml1r)  
fslpmlu    uf a e           k disk    rename(slpmpfr:slpmlur)
```
- **SR131D:** Display file for interactive screen I/O.  
- **SLPML1:** Input file (physical) of previously stored ranges.  
- **SLPMLU:** Update file (physical) for writing new/changed ranges.

---

## 3. Data Definitions
### Simple Fields
```rpg
d wptype    s         like(srtype)    // Input product type
d wptext    s             30          // Input text label
d wpfirm    s         like(srfirm)    // Company code for search
d wpvare    s             15          // Item number returned from search
```

### Working-Work Fields (ww…)
```rpg
d wwfirm    s         like(srfirm)
d wwtype    s         like(srtype)
d wwkode    s         like(srkode)
d wwvalg    s         like(srvalg)

d wwrest    ds           330         // Miscellaneous status store
  wwtext            1    30
  wwfvar(10)               15        // From-values array
  wwtvar(10)               15        // To-values array

d wwvalg    ds                    // Single choice field placeholder
   wwfyll       1    15
```

### User Data Structure (for parameters passed in)
```rpg
d dsuser     uds
d dsfirm    944  946  0
d l_fnav    951  980
```

---

## 4. Initialization Subroutine (`*INZSR`)
- **Key list setup:** Defines key fields for file chains: `wwfirm`, `wwtype`, `wwkode`, `wwvalg`.
- **Parameters from caller:**  
  - `wptype` → `wwtype`  
  - `wptext` → text label  
- **Initial values:**  
  - `wwfirm` ← program parameter  
  - `wwkode` ← 31  
  - `wwvalg` ← blank  
  - Copies into display-record fields (`srfirm`, `srtype`, `srrest`, etc.)

---

## 5. Main Processing Tag (B2BLD)
```rpg
b2tagb:
  chain key01 slpml1             // Read existing record
  if %found(slpml1)
    movel srrest → wwrest       // Load stored ranges into working arrays
    movel wwfvar(i) → b2fva(i)
    movel wwtvar(i) → b2tva(i)
  else
    // Initialize all b2fva*/b2tva* to zero
  endif

  exfmt b2bld                   // Display screen
```
1. **`chain`** attempts to fetch an existing parameter record.
2. If found, **`movel`** loads up to 10 “from” and “to” values into screen fields.
3. If not found, sets default zeros.
4. **`exfmt`** writes and reads the display file, showing item‐number fields.

---

## 6. Input & Validation
After return from `exfmt b2bld`:
1. **Exit keys:** If function keys for exit (`*INKC` or `*INKL`) are pressed → go to `xslutt`.
2. **Search key processing:**  
   ```rpg
   if *inkd = *on
     exsr xspstr
     if *in80 = '1' 
       goto b2taga            // Redisplay if a search occurred
     endif
   endif
   ```
3. **Range check:** Ensures each `b2fva(i) <= b2tva(i)` for i=1..10; otherwise redisplay.

---

## 7. File Update Logic
```rpg
chain key01 slpmlu            // Check if update record exists
// Map screen fields back into working arrays
movel b2fva(i) → wwfvar(i)
movel b2tva(i) → wwtvar(i)
eval wwtext = 'Varenummer fra/til'
eval srrest = wwrest
eval srsyst = 'L'
```
- If existing record (`*IN60 = *OFF`):
  - If all “from” fields = 0 and “to” = 0 → **`delete slpmlur`**
  - Else **`update slpmlur`**
- If no existing record (`*IN60 = *ON`) and at least one “to” ≠ 0:
  - Populate `srfirm`, `srtype`, `srkode`, `srvalg`
  - **`write slpmlur`**

---

## 8. Program Exit (`xslutt`)
```rpg
xslutt:
  eval *inlr = *on
  return
```
Sets last record indicator on and returns to caller.

---

## 9. Search Subroutine (`xspstr`)
- Triggered when user presses designated search keys for any `b2fva#/b2tva#` field.
- **Logic:**
  - Reset `*IN80`
  - Determine which search field (`wactfe`)
  - **`CALL ‘VV500R’`** to perform item-number lookup
    - Input: `wpfirm`, `wpvare`, `wptek1`
    - On return, `wpvare` contains chosen item → move into corresponding `b2fva#` or `b2tva#`
    - Set `*IN80 = '1'` to indicate a search occurred.

---

### Pedagogical Notes
- **`chain`** reads by key; `key01` covers the combination of firm/type/code/choice.
- **`movel`** is used for moving arrays of numeric text fields.
- **`*IN60`** is the *not found* indicator after `chain`.
- Screen I/O uses **`exfmt`** to display and receive user input.
- **Subroutines** (`begsr`/`endsr`) modularize search logic and initialization.
- All splits of **“from/to”** values (10 pairs) are handled uniformly via arrays.

This structure supports selecting up to 10 item‐number ranges for reporting or other processes.