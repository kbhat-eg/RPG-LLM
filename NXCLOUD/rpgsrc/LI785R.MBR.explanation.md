## Program Overview

**Program Name:** LI785R  
**System:** ASLAGR  
**Purpose:**  
This program checks the number of unprocessed EDI order confirmations ("OBKR") associated with the currently active user. The result is returned via a parameter (`p_anta`), which holds the count.

**Business Context:**  
- "OBKR" (Ordrebekreftelse) refers to EDI order confirmations.
- The program is part of the sales/order processing domain.
- It is typically invoked as a subroutine or utility to provide the count of pending EDI order confirmations for a specific user (seller).

---

## File Usage and Relationships

- **ledil1**: EDI message file (renamed from `ledipfr`), accessed for reading EDI order confirmations.
- **lohelr**: Order header file (renamed from `lohepfr`), used to verify the seller number on the order.
- **fusrl1**: User file (renamed from `fusrpfr`), used to map the current user to a seller number.

All files are keyed and accessed via associated key lists.

---

## Data Areas and Variables

- **Local Data Area (LDA):**
  - `l_user`: Current user ID, positions 911–920 of LDA.
  - `l_firm`: Current firm/company number, positions 944–946 of LDA.

- **Parameter:**
  - `p_anta`: Output parameter, returns the count of relevant EDI order confirmations.

- **Key Variables:**
  - `ledil1_type`: Used to specify EDI message type ('OBKR').
  - `lohelr_numm`, `lohelr_suff`: Order number and suffix, for order header lookup.
  - `fusrl1_user`: User ID for lookup in the user file.

- **Other Variables:**
  - `w_firm`: Working variable for firm number, used in key lists.

---

## Program Logic

### Initialization (`*inzsr`)

- Receives `p_anta` as a parameter.
- Initializes key lists for all file lookups, using `w_firm` and other key fields.
- Loads `w_firm` from the LDA (`l_firm`).

### Main Routine

1. **User Validation:**
   - If `l_user` is blank, the program exits immediately.

2. **Initialize Output:**
   - Sets `p_anta` to zero.

3. **Seller Number Lookup:**
   - Sets up `fusrl1_user` from `l_user`.
   - Looks up the user in `fusrl1` using the key list.
   - If not found or seller number (`fbselg`) is zero, exits.

4. **Iterate EDI Order Confirmations:**
   - Sets `ledil1_type` to `'OBKR'`.
   - Uses the key list to set the file pointer to the first matching EDI order confirmation for the firm and type.
   - Reads through all matching EDI order confirmations:
     - Skips records with status codes `'7'`, `'8'`, or `'9'` (these likely represent processed or irrelevant statuses).
     - For each relevant confirmation:
       - Retrieves order number (`linumm`) and suffix (`lisuff`).
       - Looks up the corresponding order header in `lohelr`.
       - If found, and the order’s seller number (`loinnk`) matches the seller number from the user record (`fbselg`), increments `p_anta`.
   - Continues until EOF.

5. **Exit:**
   - Sets LR indicator on and returns.

---

## Design Decisions & Conventions

- **Use of LDA:**  
  The program relies on the Local Data Area to determine context (user and firm). This is a standard pattern in this codebase for passing session/user information.

- **Key Lists (`klist`):**  
  All file access is performed via key lists defined in the initialization subroutine. This centralizes key management and ensures consistency across file accesses.

- **Status Filtering:**  
  Only EDI confirmations with status codes other than '7', '8', or '9' are considered "unprocessed." This is a business rule specific to the EDI order confirmation process.

- **Seller Number Validation:**  
  The program ensures that only confirmations related to the current user's seller number are counted, enforcing per-user scoping.

- **Parameter Passing:**  
  The count is returned via a parameter (`p_anta`) rather than as a return value or data structure, supporting use as a subroutine or called program.

- **File Naming Conventions:**  
  Logical files are renamed for clarity within the program. This is standard in the codebase to avoid naming conflicts and clarify intent.

---

## Interactions with Other Modules

- **User Context:**  
  The program expects the LDA to be pre-populated with user and firm information, typically by the caller or a session manager.

- **Order Processing:**  
  Interacts with the order header file (`lohelr`) to validate orders against the seller.

- **EDI Processing:**  
  Reads EDI order confirmations from `ledil1`, which is likely maintained by separate EDI import processes.

---

## Notable Change History

- **2014-03-06:** Initial version.
- **2010-06-14:** Adjusted for number expansion.
- **2021-06-24:** Message number expanded from 6 to 8 digits.

---

## Summary

This program provides a count of unprocessed EDI order confirmations ("OBKR") for the current user, filtered by seller number and status, and scoped to the current firm. It is designed for integration into larger sales/order processing workflows, with clear separation of key management, business rules, and context handling via the LDA. The code follows established patterns in the codebase for file access, parameter passing, and business logic enforcement.