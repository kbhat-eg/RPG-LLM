     h datedit(*dmy) option(*nodebugio)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RE125R                                        *
      * Beskrivelse . . : Innlesing av semikolon-separert file          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                               *
      * Tilpasset for . :                                               *
      *                                                                 *
      * Referanse  Dato   Endringsbeskrivelse                      Sign.*
      * --------- ------  ----------------------------------------------*
      *                                                                 *
      *                                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      *  BRUK AV INDIKATORER                                            *
      *                                                                 *
      *       KA = F1  = Valg av firma                                  *
      *       KC = F3  = Exit                                           *
      *                                                                 *
      *       LR = Avslutt program                                      *
      *       30 = Protect av felter ved vise                           *
      *    31-59 = Varsle m/feilmeldinger/skjermindikatorer             *
      *    60-69 = Fileindikatorer chain etc.                           *
      *    70-79 = Arbeidsindikatorer i sub-rutiner                     *
      *    80-89 = Arbeidsindikatorer ordinære                          *
      *    90-99 = Benyttes ved std. sub-rutiner                        *
      *                                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     F*
     Frfw1pf    ip   f  700        disk
     frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
     Frfw2pf    o  a f  700        disk
      *
      * Definering av variabler i nøkler
      *
     D ar              S              3  0 DIM(20)
      *
     d wmsg            s             17
     d w_neg           s              3  0
     d w_kom           s              3  0
     d w_kom1          s              3  0
     d w_bla           s              3  0 dim(3)
     d len             s              2  0
     d hlen            s              2  0
     d st              s              3  0
     d st1             s              3  0
     d w_pos           s              2  0
     d w_bel           s              9
     d w_per           s              4
     d w_dat           s              8
     d w_pertxt        s             20
     d w_txt           s             30
     d w_bko           s              2
     d w_avd           s              4
     d w_kto           s              6
     d w_sps           s              2
     d w_mko           s              1
     d w_helbel        s             15
     d w_helta         s             12
     d w_belore        s              2
     d w_peru          s              4
     d w_datu          s              8
     d w_txtu          s             30
     d w_bkou          s              2
     d w_avdu          s              4
     d w_ktou          s              6
     d w_spsu          s              2
     d w_belu          s              9
     d w_oreu          s              2
     d w_sgnu          s              1
     d w_mkou          s              1
     d w_sign          s              1
      *
     d p_firmx         s              3
     d w_firm          s                   like(rhfirm)
      *
     d rhovl1_kont     s                   like(rhkont)
     d rhovl1_avde     s                   like(rhavde)
     d rhovl1_spes     s                   like(rhspes)
      *
     d w_belop         ds
     d w_forstb                       3
     d w_andreb                       3
     d w_sisteb                       3
      *
     D                UDS
     D  UFGR                 211    300
     D  UTKI                 301    510
      *
     Irfw1pf    NS  01
     I                                  1  700  record
      *
     c                   eval      w_per    = *blank
     c                   eval      w_dat    = *blank
     c                   eval      w_txt    = *blank
     c                   eval      w_pertxt = *blank
     c                   eval      w_bko    = *blank
     c                   eval      w_avd    = *blank
     c                   eval      w_kto    = *blank
     c                   eval      w_sps    = *blank
     c                   eval      w_mko    = *blank
     c                   eval      w_txtu   = *blank
     c                   eval      w_bkou   = *blank
     c                   eval      w_avdu   = *blank
     c                   eval      w_ktou   = *blank
     c                   eval      w_spsu   = *blank
     c                   eval      w_mkou   = *blank
     c                   eval      w_belu   = *blank
      *
     C     ';'           scan      record        ar                       90
      *
      * felt 1 - periode
      *
     c                   eval      len     = ar(1) - 1
      *
      * sjekker om det ligger noe i feltet
      *
     c                   if        len     > *zero
      *
      * sjekker om det er linje for periode
      *
     c     len           subst     record:1      w_pertxt
      *
     c                   if        w_pertxt = 'Periode:'
      *
     c                   eval      len     = 4
     c                   eval      st      = ar(1) + 1
     c     len           subst     record:st     w_per
     c                   eval      st = 5 - len
      *
     c                   if        len     > 0
     c                   eval      %subst(w_peru:st:len) = %subst(w_per:1:len)
     c                   else
     c                   eval      w_peru = *zero
     c                   endif
      *
     c                   goto      neste
      *
     c                   endif
     c                   endif
      *
      * felt 2 - dato
      *
     c                   eval      len     = ar(1) - 1
      *
      * sjekker om det ligger noe i feltet
      *
     c                   if        len     > *zero
      *
      * sjekker om det er linje for periode
      *
     c     len           subst     record:1      w_pertxt
     c                   if        w_pertxt = 'Dato:'
      *
     c                   eval      len     = 8
     c                   eval      st      = ar(1) + 1
     c     len           subst     record:st     w_dat
     c                   eval      st = 9 - len
      *
     c                   if        len     > 0
     c                   eval      %subst(w_datu:st:len) = %subst(w_dat:1:len)
     c                   else
     c                   eval      w_datu = *zero
     c                   endif
      *
     c                   goto      neste
      *
     c                   endif
     c                   endif
      *
      * felt 3 - Sjekker om det er tekstlinjen
      *
     c                   eval      len     = ar(1) - 1
      *
      * sjekker om det ligger noe i feltet
      *
     c                   if        len     > *zero
      *
      * sjekker om det er linje for tekst
      *
     c     len           subst     record:1      w_pertxt
      *
     c                   if        w_pertxt = 'Tekst'
     c                   goto      neste
     c                   endif
      *
      * felt 1 - tekst
      *
     c     len           subst     record:1      w_txt
      *
     c                   if        len     > 0
     c                   eval      %subst(w_txtu:1:30) = %subst(w_txt :1:30)
     c                   else
     c                   eval      w_txtu = *zero
     c                   endif
      *
      * felt 2 - bilagskode
      *
     c                   eval      len     = ar(2) - ar(1) - 1
     c                   eval      st      = ar(1) + 1
     c     len           subst     record:st     w_bko
      *
      * tester om det er numerisk bilagskode - hvis ikke så hoppes det over.
      *
     c                   move      w_bko         w_tstbko          1
     c                   if        w_tstbko >= '0' and
     c                             w_tstbko <= '9'
     c
     c                   if        len     > 0
     c                   eval      st = 3 - len
     c                   eval      %subst(w_bkou:st:len) = %subst(w_bko :1:len)
     c                   else
     c                   eval      w_bkou = *zero
     c                   endif
      *
      * felt 3 - avdeling
      *
     c                   eval      len     = ar(3) - ar(2) - 1
     c                   eval      st      = ar(2) + 1
      *
     c                   if        len     > 0
     c     len           subst     record:st     w_avd
     c                   eval      st = 5 - len
     c                   eval      %subst(w_avdu:st:len) = %subst(w_avd :1:len)
     c                   else
     c                   eval      w_avdu = *zero
     c                   endif
      *
      * felt 4 - konto
      *
     c                   eval      len     = ar(4) - ar(3) - 1
     c                   eval      st      = ar(3) + 1
      *
     c                   if        len     > 0
     c     len           subst     record:st     w_kto
     c                   eval      st = 7 - len
      *
     c                   eval      %subst(w_ktou:st:len) = %subst(w_kto:1:len)
     c                   else
     c                   eval      w_ktou = *zero
     c                   endif
      *
      * felt 5 - spes
      *
     c                   eval      len     = ar(5) - ar(4) - 1
     c                   eval      st      = ar(4) + 1
      *
     c                   if        len     > 0
     c     len           subst     record:st     w_sps
     c                   eval      st = 3 - len
     c                   eval      %subst(w_spsu:st:len) = %subst(w_sps:1:len)
     c                   else
     c                   eval      w_spsu = *zero
     c                   endif
      *
      * felt 6 - mvakode
      *
     c                   eval      len     = ar(6) - ar(5) - 1
     c                   eval      st      = ar(5) + 1
      *
     c                   if        len     > 0
     c     len           subst     record:st     w_mko
     c                   eval      st = 2 - len
     c                   eval      %subst(w_mkou:st:len) = %subst(w_mko:1:len)
     c                   else
     c                   exsr      hent_mvak
     c                   endif
      *
      * beløp
      *
     c                   eval      w_helbel = *blank
     c                   eval      w_forstb = *blank
     c                   eval      w_andreb = *blank
     c                   eval      w_sisteb = *blank
      *
     c                   eval      w_sign   = *blank
      *
     c                   eval      len     = ar(6)  + 15
     c                   eval      st      = ar(6) + 1
     c                   if        len     > 0
     c     len           subst     record:st     w_helbel
     c                   else
     c                   eval      w_helbel  = *blank
     c                   endif
      *
      * konverterer beløps-feltet
      *
     c                   if        w_helbel <> *blank
     c                   exsr      beh_tall
     c                   move      w_belop       w_belu
     c                   move      w_sign        w_sgnu
     c                   endif
      *
      * legger ut resultat
      *
     c                   except    updvar
      *
     c                   endif
      *
     c                   endif
      *
     C     neste         tag
      *
      * ----------------------------------------------------
      * behandler tall
      * ----------------------------------------------------
      *
     c     beh_tall      begsr
      *
      * sjekker de tre siste før komma.
      *
     c     ','           scan      w_helbel      w_kom                    90
     c                   eval      st       = w_kom - 3
      *
     c                   if        st > 0
      *
     c                   eval      w_sisteb = *blank
     c                   eval      w_forstb = *blank
     c                   eval      w_andreb = *blank
     c                   eval      w_bel   = *blank
     c     '-'           scan      w_helbel      w_neg                    90
     c                   if        *in90 = *off
      *
      *positivt beløp
      *
     c                   eval      w_sign   = *blank
      *
     c     ' '           scan      w_helbel      w_bla                    90
      *
     c                   if        w_bla(1) = 1
     c                   eval      hlen    = w_kom - 2
     c                   eval      w_helta = %subst(w_helbel:2:hlen)
     c                   else
     c                   eval      hlen    = w_kom - 1
     c                   eval      w_helta = %subst(w_helbel:1:hlen)
     c                   endif
     c     ' '           scan      w_helta       w_bla                    90
      *
     c                   exsr      beh_deler
      *
     c                   else
      * negativt beløp
     c                   eval      w_sign  = '1'
      *
      *
     c                   eval      hlen    = w_kom - 3
     c                   eval      st1     = w_neg + 1
     c                   eval      w_helta = %subst(w_helbel:st1:hlen)
     c     ' '           scan      w_helta       w_bla                    90
      *
     c                   exsr      beh_deler
      *
     c                   endif
     c                   endif
      *
     c                   endsr
      *
      *-------------------------------------------------------------------
      *
      *-------------------------------------------------------------------
      *
     c     beh_deler     begsr
      *
      * sjekker om det er noen i w_bla som skal nulles ut
      *
     c                   if        w_bla(1) = (hlen + 1)
      *
      * hvis den 1. blanke er siste posisjon
      *
     c                   eval      w_bla(2) = *zero
     c                   eval      w_bla(3) = *zero
     c                   endif
     c                   if        w_bla(2) = (hlen + 1)
      *
      * hvis den 2. blanke er siste posisjon
      *
     c                   eval      w_bla(3) = *zero
     c                   endif
      *
      * sjekker om tre blanke i beløpet
      *
     c                   if        w_bla(1) > *zero and
     c                             w_bla(2) > *zero and
     c                             w_bla(3) > *zero
      *
      * behandler forste del
      *
     c                   eval      len      = w_bla(1) - 1
     c                   eval      st       = 4 - len
     c                   eval      st1      = 1
     c                   if        len     > 0
     c                   eval      %subst(w_forstb:st:len)
     c                                      = %subst(w_helta:1:len)
     c                   else
     c                   eval      w_forstb = *blank
     c                   endif
      *
      * behandler andre  del
      *
     c                   eval      len      = 3
     c                   eval      st       = 4 - len
     c                   eval      st1  =    w_bla(1) + 1
      *
     c                   if        len     > 0
     c                   eval      %subst(w_andreb:st:len)
     c                                      = %subst(w_helta:st1:len)
     c                   else
     c                   eval      w_andreb = *blank
     c                   endif
      *
      * behandler tredje del
      *
     c                   eval      len      = 3
     c                   eval      st       = 4 - len
     c                   eval      st1  =    w_bla(2) + 1
      *
     c                   if        len     > 0
     c                   eval      %subst(w_sisteb:st:len)
     c                                      = %subst(w_helta:st1:len)
     c                   else
     c                   eval      w_sisteb = *blank
     c                   endif
      *
     c                   else
      *
      * sjekker om to blanke i beløpet
      *
     c                   if        w_bla(1) > *zero and
     c                             w_bla(2) > *zero
      *
      * behandler forste del
      *
     c                   eval      len      = w_bla(1) - 1
     c                   eval      st       = 4 - len
     c                   if        len     > 0
     c                   eval      %subst(w_andreb:st:len)
     c                                      = %subst(w_helta:1:len)
     c                   else
     c                   eval      w_andreb = *blank
     c                   endif
      *
      * behandler andre  del
      *
     c                   eval      len      = 3
     c                   eval      st       = 4 - len
     c                   eval      st1  =    w_bla(1) + 1
      *
     c                   if        len     > 0
     c                   eval      %subst(w_sisteb:st:len)
     c                                      = %subst(w_helta:st1:len)
     c                   else
     c                   eval      w_sisteb = *blank
     c                   endif
      *
     c                   else
      *
      * behandler forste del
      *
     c                   eval      len      = w_bla(1) - 1
     c                   eval      st       = 4 - len
      *
     c                   if        len     > 0
     c                   eval      %subst(w_sisteb:st:len)
     c                                      = %subst(w_helta:1:len)
     c                   else
     c                   eval      w_sisteb = *blank
     c                   endif
     c                   endif
     c                   endif
      *
      * behandler øre
      *
      *
     c                   if        w_kom > *zero
     c                   eval      st      = w_kom + 1
     c     2             subst     w_helbel:st   w_bel
     c                   eval      w_belore = %trimr(w_bel)
     c                   else
     c                   eval      w_belore = *zero
     c                   endif
      *
     c                   move      w_belore      tst_ore           1
      *
     c                   if        tst_ore = *Blank
     c                   move      '0'           w_belore
     c                   endif
      *
     c                   move      w_belore      w_oreu
      *
     c                   endsr
      *
      /EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å hente mva-kode
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_mvak     begsr
      *
     c                   move      w_ktou        rhovl1_kont
     c                   move      w_avdu        rhovl1_avde
     c                   move      w_spsu        rhovl1_spes
     c     rhovl1_key    chain     rhovl1r
      *
      * Konto-spes
      *
     c                   if        not %found(rhovl1)
     c                   eval      rhovl1_avde = *zeros
     c     rhovl1_key    chain     rhovl1r
     c                   endif
      *
      * Konto
      *
     c                   if        not %found(rhovl1)
     c                   eval      rhovl1_spes = *zeros
     c     rhovl1_key    chain     rhovl1r
     c                   endif
      *
     c                   if        not %found(rhovl1)
     c                   eval      w_mkou = *blank
     c                   else
     c                   eval      w_mkou = rhmvak
     c                   endif
     c                   endsr
      *
      /EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Key for kontoplan
      *
     c     rhovl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhovl1_kont
     c                   kfld                    rhovl1_spes
     c                   kfld                    rhovl1_avde
      *
     c     *entry        plist
     c                   parm                    p_firmx
      *
     c                   move      p_firmx       w_firm
      *
     c                   eval      w_peru   = *blank
     c                   eval      w_datu   = *blank
      *
     c                   endsr
      *
     Orfw2pf    eadd         updvar
     O                       w_peru               4
     O                       w_datu              12
     O                       w_txtu              42
     O                       w_bkou              44
     O                       w_avdu              48
     O                       w_ktou              54
     O                       w_spsu              56
     O                       w_mkou              57
     O                       w_belu              66
     O                       w_oreu              68
     O                       w_sgnu              69
