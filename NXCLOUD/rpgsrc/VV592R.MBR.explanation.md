# High-Level Overview

This RPG program, named `VV592R`, runs in an IBM i (AS/400) environment. It is used to display and handle item price label printing from a radio terminal. It works with sales items, retrieves product and pricing data, allows the user to switch between item units, calculates prices (including discounts and VAT), and optionally prints a label.

The code uses "cycle-free" RPG IV (ILE RPG) with externally described files and explicit subroutines. It is well-commented and version-controlled, with a number of custom enhancements over time. Variable and routine names are generally in Norwegian.

---

## File Declarations

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvenl2    if   e           k disk    rename(vvenpfr:vvenl2r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fvv592d    cf   e             workstn
```

- `vvarl1`, `vvenl2`, `rlevl1` are data files (probably item master, item unit, and vendor master) accessed by key (`if e k disk`).
- `vv592d` is a display (workstation) file for terminal interaction.

---

## Data Structures and Variables

### Parameters

```rpg
d p_firm          s                   like(vvfirm)
d p_kund          s              6  0
d p_vare          s                   like(vvvare)
d p_enhe          s                   like(veenhe)
```
- The program receives four parameters: company, customer, item, and unit.

### Data Structures for Pricing

- `hirec`: Parameter "in" buffer for calling an external price calculation program (`VP900R`).
- `horec`: Parameter "out" buffer from the call.
- Uses overlays to map fields inside the buffer, for convenience and legacy compatibility.

### Working Variables

- Many working variables relate to item/unit/price/discount, and are mostly self-explanatory given Norwegian names.

---

## Control Flow

### Initialization (`*inzsr`)

- Gets parameters (`p_firm`, `p_kund`, `p_vare`, `p_enhe`).
- Sets up file keys for item, item unit, and vendor lookups.
- Retrieves VAT rates by calling `FÃ¸705R`.
- Retrieves price group by calling `VL711R`.

---

### Main Processing Loop

#### 1. Fetch Item Data

- Uses `CHAIN` to fetch item info into `vvarl1`.
- If not found, exits.

#### 2. Prepare Display Data

- Extracts and trims product description.
- If the item has a vendor, looks up the vendor name.

#### 3. Fetch Sales Units

- Reads up to three sales units for the item, storing their codes and conversion information.
- Handles selection of "current" unit, using GTIN code if provided or defaulting to the first unit.

#### 4. Set Unit Selection Flags

- Maintains indicator flags (`*in80`, `*in81`, `*in82`) to show which unit is current.

#### 5. Price Calculation

- Calls subroutine `hent_pris`, which:
  - Prepares input buffer and calls `VP900R` to get base price, discount, etc.
  - Applies discounts and VAT.
  - Optionally calls another program (`FA909R`) for further price adjustments.
  - Updates display and working variables.

#### 6. Main Display/Interaction Loop

- Displays the item data (`exfmt b1bld`) and waits for user input.
- Handles function keys:
  - F1: Switch unit (`bytt_enhet` sr)
  - F2: Print label (calls `FP250C` and exits)
  - F5: Refresh (restarts from the beginning)

#### 7. Unit Switch Logic (`bytt_enhet`)

- Rotates between the available units.
- Re-calculates item quantities to match the new unit.
- Calls `hent_pris` after switching.

#### 8. Program Exit (`avslutt`)

- Sets `*INLR = *ON` and returns.

#### 9. Error Handling (`*pssr`)

- Activates error indicator and returns to main loop.

---

## Key Subroutines

### `hent_pris`

- Initializes pricing fields.
- Fills pricing input buffer.
- Calls external price routine (`VP900R`), retrieves results.
- Applies up to two discounts and VAT.
- Optionally adjusts calculated price with another routine (`FA909R`).
- Updates output fields (`b1saim`, etc.).

### `bytt_enhet`

- Rotates the selected unit flags.
- Adjusts quantity to new unit's conversion.
- Updates old unit marker and recalculates price.

---

## Other Notable Features

- Uses overlay fields for compatibility with packed buffer parameter conventions.
- Maintains Norwegian variable naming for business logic clarity.
- Logs and comments keep thorough version control and change tracking.
- Modular design, using external routines for price and VAT logic, allows easy integration into wider system.
- Transaction and display interaction is structured around a simple main loop.

---

# Summary Table

| Section         | Purpose                                                                           |
|-----------------|-----------------------------------------------------------------------------------|
| File Decls      | Reads item master, units, vendor master; displays/receives terminal input         |
| Parameters      | Receives company, customer, item, unit                                            |
| Init Subr.      | Prepares variables, retrieves VAT/pricing data                                    |
| Main Loop       | Fetches item & vendor, units, sets current unit, calculates price, displays screen|
| Pricing Subr.   | Calls external price calc, applies discounts/VAT, updates working variables       |
| Unit Switch Subr| Rotates units, adjusts quantities, recalculates price                             |
| Error Handler   | Sets error flag and restarts loop                                                 |
| Exit            | Closes program and files                                                          |

---

# Typical Flow

1. **User enters item for customer:**  
    - Program fetches item info, vendor, and available units.
2. **Program sets default/current sales unit:**  
    - Based on GTIN or first available unit.
3. **Gets and calculates price (with discounts/VAT) for current unit:**  
    - Calls external price and VAT routines.
4. **Displays info with price.**  
5. **User can:**  
    - Switch unit (F1) and recalculate
    - Print label (F2)
    - Refresh data (F5)

---

# Key Takeaways

- **Modular design:** Business logic, price calc, and VAT are in external routines.
- **Thorough Norwegian commenting and variable naming:** Make business logic understandable to local developers.
- **Extensible:** Easily enhanced with new fields or logic, as seen in version history.
- **Standard AS/400 terminal controls:** Use of indicator flags, subroutines, and external program calls.
- **User flow is centered around price lookup, unit switching, and label printing for an item/customer.**

---

If you have a specific section or routine you'd like a deeper walk-through of, just ask!