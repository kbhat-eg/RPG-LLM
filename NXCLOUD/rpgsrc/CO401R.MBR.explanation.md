```markdown
# RPG IV (ILE RPG) Program CO401R - Configuration Key Lookup

---

## Program Purpose

This RPG program (CO401R) is designed to determine if a specific configuration adjustment (a "tilpassning," or customization) is enabled for a given company (`firma`), department (`avd`), and key (`nokkel`). The output, `nokkel_verdi`, tells the caller if the adjustment is active (usually "0" or "1", but may have other values).

If the key is not found, `nokkel_verdi` is set to a blank string.

---

## Program Structure Overview

- **Prototypes**: Declares external programs used for job logging.
- **Main Procedure**: Handles parameter input/output, gets key value, and manages logging.
- **FindNokkelVerdi Procedure**: Executes the SQL to find the key's value.
- **Job Logging Procedures**: Handles start, error, and end logging.

---

## 1. Header Options

```rpg
H DFTACTGRP(*NO)
h option(*nodebugio : *srcstmt) datedit(*dmy)
H DECEDIT(',')
```
- Not using default activation group.
- Source statement and no debug IO options.
- Editing dates as day/month/year.
- Decimal edit with comma.

---

## 2. External Program Prototypes

```rpg
dcl-pr P_AB700R extpgm('AB700R'); ... end-pr;  // Start job logging
dcl-pr P_AB705R extpgm('AB705R'); ... end-pr;  // Log job error/message
dcl-pr P_AB710R extpgm('AB710R'); ... end-pr;  // End job logging
dcl-pr CO401R  extpgm('CO401R'); ... end-pr;   // Self as external program
```
- Prototypes for logging programs (start, message, end).
- Self-declaration for being called externally.

---

## 3. Variables

- **Logging parameters**: `p_jnav`, `p_jbid`, `p_jtxt`, `p_jsts`, `p_stat`, `p_jmld`.
- **SQL and diagnostics**: `messageId`, `messageId1`, `messageId2`, `messagetext`, `sqlquery`, `currentSqlState`.

---

## 4. Main Procedure Definition

```rpg
dcl-pi CO401R;
  firma         packed(3);
  systemnavn    char(50);
  avd           packed(4);
  nokkel        char(50) const;
  nokkel_verdi  char(256);
end-pi;
```
- Program is called with: company, system name, department, key, key value (out).

```rpg
nokkel_verdi = FindNokkelVerdi(firma : systemnavn : avd : nokkel);

if (p_jbid <> '');
  EndLogging();
endif;

*inlr = *on;
return;
```
- Looks up the key's value with `FindNokkelVerdi`.
- If a job logging ID is set (`p_jbid`), ends logging.
- Sets last record indicator and returns.

---

## 5. FindNokkelVerdi Procedure

### Interface

```rpg
dcl-pi *N char(256);
  firmaNr       packed(3);
  systemnavnet  char(50);
  avdNr         packed(4);
  nokkelen      char(50) const;
end-pi;
```
- Returns the key value as 256-char string.

### Logic

- If `systemnavnet` is blank, do not require matching on system name.
- If `avdNr` is negative, do not require matching on department.

**SQL Lookup**:
```sql
select verdi from inavst where firma = :firmaNr
  and (systemnavn = :systemnavnet or 1 = :uten_systemnavn )
  and (avdeling = :avdNr or 1 = :uten_avd)
  and nokkel = :nokkelen
  for read only;
```
- Returns the `verdi` (value) from table `inavst` where all parameters match, or the corresponding flag indicates to ignore that field.

- Handles SQL errors with detailed diagnostics and error logging.

- Returns the found value; if not found or an error, returns blank.

---

## 6. Job Logging Procedures

### StartLogging

- Sets up logging variables and calls `P_AB700R` to start.

### ErrorLogging

- Initiates logging if needed.
- Splits long error messages (over 200, 400, 600 chars) and logs them in parts using `P_AB705R`.

### EndLogging

- If `p_stat` is '1' (indicating an error state), logs the final message.
- Calls `P_AB710R` to close the logging entry.

---

## 7. Error Handling

- Comprehensive diagnostics assigned if SQL fails (using `Get Diagnostics`).
- Errors are logged with message text and IDs for traceability.

---

## 8. Calling Sequence

The program is typically called as:
```
CALL PGM(CO401R) PARM(firma avd konfig_nokkel retur_verdi)
```
- The program returns the configuration value `retur_verdi` for inputs `firma`, `avd`, and `konfig_nokkel`.

---

## 9. Notable Features

- SQL is used for flexible (optionally partial) key lookup.
- Job logging is modular and designed for robust error tracking.
- All business logic (parameter handling, error management, logging) is clearly separated in local procedures.
- Error messages are truncated and sent in chunks to avoid overflow.

---

## 10. Summary

**CO401R** is a utility program to fetch a configuration key value for a given company/system/department/key combination, with optional filtering, and supports full job logging with detailed error tracking. It is robust for both normal operation and error conditions, logging all significant events.
```
