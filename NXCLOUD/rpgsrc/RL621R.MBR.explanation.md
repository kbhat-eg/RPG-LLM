# RL621R – Supplier Register Printout

## Overview

This program, RL621R, is responsible for generating a printed report of the supplier (leverandør) register. It can produce both detailed and summary listings, and supports selection/filtering based on several business criteria such as supplier number, department, district, category, and last transaction date. The program supports two sorting orders: by supplier number or by an alphanumeric field, and can output either a simple or total listing depending on user parameters.

## File Definitions

- **rlevl1**: Supplier master file, keyed access, sorted by supplier number. Renamed record format `rlevpfr` to `rlevl1r`.
- **rlevl2**: Supplier master file, keyed access, sorted by alphanumeric field. Renamed record format `rlevpfr` to `rlevl2r`.
- **rl621p**: Printer file, with overflow indicator tied to *IN30.

## Indicators

The codebase uses a convention for indicators:
- 10: End of file/selection
- 11: Simple (enkelt) listing
- 12: Include balance
- 30: Printer overflow (protect fields on display)
- 31-59: Error/warning indicators
- 60-69: File indicators (CHAIN, etc.)
- 70-79: Subroutine work indicators
- 80-89: General work indicators
- 90-99: Standard subroutine indicators

## Data Structures and Variables

- **f**: 30-byte array, used for moving/overlaying alphanumeric keys.
- **w_tdat, w_taar, w_tmnd, w_tdag**: Date and its components, with overlays for year, month, and day.
- **w_xdat**: ISO date format, used for date manipulation.
- **Various accumulators**: Variables like `wantli`, `wakjli`, `wdebli`, `wdsali`, etc., are used to accumulate counts and totals for the selected and all suppliers, distinguished by suffixes `li` (selected) and `re` (all).

## Parameter Handling

Parameters are referenced as:
- **psort**: Determines sorting order (blank = by number, otherwise alphanumeric).
- **pknrf/pknrt**: Supplier number range from/to.
- **pavdf/pavdt**: Department range from/to.
- **pdisf/pdist**: District range from/to.
- **pkatf/pkatt**: Category range from/to.
- **pedat**: Last transaction date cutoff.
- **psald**: Include balance (J = yes).
- **ptype**: Listing type (E = simple).

## Main Processing Logic

### Initialization (`*INZSR`)

- Sets up initial values and file positions.
- Determines if the listing should include balances and/or be a simple listing.
- Writes report headings, including conditional sub-headings based on parameter values.
- Initializes key lists for both sorting methods.

### Main Loop

1. **Record Reading**: Based on `psort`, reads from either `rlevl1` or `rlevl2`.
2. **Firm Filtering**: Stops processing if the supplier's firm exceeds the current firm (`rlfirm > w_firm`).
3. **Range Filtering**: Applies all parameter-based filters in sequence (supplier number, department, district, category, last transaction date).
4. **Selected Supplier Accumulation**: If the record passes all filters:
    - Increments selected counts and totals for debit, credit, and purchase amounts.
    - Handles alphanumeric key movement for sorting by name.
    - Calls subroutines to print the supplier line, either in simple or total format.
5. **All Supplier Accumulation**: Regardless of filter, accumulates overall totals for all suppliers.
6. **Looping**: Repeats until end condition is met.

### End of Processing

- On completion (`slutt` tag), writes the total line and sets LR indicator to end the program.

## Subroutines

### `skrive`

Handles printing of a supplier in the simple listing format:
- Checks for page overflow and writes headings if needed.
- Writes the main supplier line, with an additional address line if present.

### `skrivt`

Handles printing of a supplier in the total listing format:
- Similar overflow handling as `skrive`.
- Writes the supplier line in the total format.

### `*INZSR`

Program initialization, as described above.

## Business/Domain-Specific Logic

- **Supplier Filtering**: The program allows for detailed filtering, supporting complex business requirements for reporting (e.g., by department, district, category, and transaction date).
- **Dual Accumulation**: Separate accumulators for "selected" (those that match filters) and "all" suppliers, supporting both filtered and total report sections.
- **Sorting**: Supports both numeric and alphanumeric sorting, reflecting different business needs for how suppliers may be grouped or presented.
- **External Definitions**: Uses `/COPY QCPYLESRC,RPARRKDS` for shared data structures, ensuring consistency with other modules.

## Integration/Dependencies

- **RPARRKDS**: Copied data structure, likely standard across related reporting programs.
- **Printer File (rl621p)**: Externally defined, enabling flexible changes to report format/layout.
- **Supplier Master Files**: Reads from two logical views of the supplier master, supporting multiple sorting orders.

## Notable Design Decisions

- **Indicator Usage**: The program relies heavily on indicators for flow control, following established conventions within the codebase.
- **Separation of Concerns**: Subroutines are used to encapsulate printing logic, making it easier to adapt or extend report formats.
- **Extensive Filtering**: The sequential application of filters provides both flexibility and clarity in business rule enforcement.
- **Overlayed Data Structures**: Overlays are used for efficient date handling and key manipulation, a common pattern in this codebase.

## Maintenance Notes

- **Record Format Changes**: The program must be recompiled if the supplier master record format changes (as noted in the change log).
- **Printer File**: Any changes to the printer file definition require corresponding updates to the output logic.
- **Parameter Validation**: Assumes parameters are validated before entry; invalid parameters may cause unexpected results.

## Change History Highlights

- **R3.30**: Parameter handling and date validation fixes.
- **R5.00**: Migration to externally defined printer file.
- **R6.20**: Recompiled due to changes in the shared data structure.

---

For further details on data structures or printer file layouts, refer to the external definitions in `RPARRKDS` and the printer file specification for `rl621p`. This program is representative of report-generation routines in the ASOKON system, and follows standard practices for indicator usage, subroutine structure, and parameter-driven filtering.