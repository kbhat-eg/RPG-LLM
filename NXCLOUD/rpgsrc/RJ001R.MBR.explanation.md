# RJ001R â€“ Jobb-register Status, Legger ut Jobb Post

## Overview

This program, part of the **ASOKON** system, is responsible for updating the status of job records in the job register (RJOBLU). Its main function is to either delete an existing job record or insert/update a job status record, depending on the input parameter. Additionally, it checks related tables (RTRIPF and RJOUPF) for the existence of associated records and updates the status accordingly.

The program is designed for batch or background processing, and is typically invoked by another program, passing in key parameters.

---

## File Dependencies

- **RJOBLU**: Main job register file (update/delete/write).
- **RTRIPF**: Related trip records (read-only, SQL).
- **RJOUPF**: Additional job output records (read-only, SQL).

All files are externally described and renamed locally for clarity and to avoid naming collisions.

---

## Parameters

- **w_memb** (10A): Member identifier (likely a job or user key).
- **w_info** (1A): Control flag for operation:
    - 'S': Signals a delete operation.
    - Other values: Signals an insert/update operation, with the possibility of status escalation based on related records.

---

## Key Variables

- **w_firm**: Firm/Company code, based on the job register file's key.
- **w_date / w_time**: Current date and time, used for stamping records.
- **l_wsid, l_user, l_firm**: Loaded from the program status data structure (UDS), likely set by the job controller or previous program.

---

## Program Flow

### Initialization (`*inzsr`)

- Receives two parameters: `w_memb` and `w_info`.
- Sets up the composite key (`rjoblu_key`) for the job register using `w_firm` and `w_memb`.
- Initializes `w_firm` from the program status data structure (`l_firm`).

### Main Logic

#### 1. **Delete Operation**
If `w_info = 'S'`:
- Attempts to chain (locate) the record in RJOBLU by key.
- If found, deletes the record.
- Program then exits immediately.

#### 2. **Insert/Update Operation**
If not a delete:

- **Fetches current date and time** into `w_date` and `w_time`.
- Attempts to chain to RJOBLU using the composite key.
    - **If not found**:
        - Populates the RJOBLU record fields with current context (firm, member, workstation, user, date, time).
        - Sets `w_info = '1'` to indicate a new record.
        - Writes the record to RJOBLU.
    - **If found**:
        - **Checks for related records in RTRIPF** (via embedded SQL):
            - If a record matching `w_memb` exists, sets `w_info = '2'` and exits.
        - **Checks for related records in RJOUPF** (via embedded SQL):
            - If a record matching `w_memb` exists, sets `w_info = '2'` and exits.
        - If neither related record exists, program proceeds to normal end.

#### 3. **Program End**
- Sets LR indicator to *on (end of program).
- Returns to caller.

---

## Business/Domain Logic

- **Job Status Tracking**: The program ensures that only one job record per firm/member exists at a time and that the status is accurately reflected.
- **Cascading Status**: If related trip or job output records exist, the status escalates (`w_info = '2'`), signaling to downstream processes or UI that additional action or state exists for this job.
- **Immediate Deletion**: Jobs can be removed on demand by passing `'S'` as the control flag.

---

## Notable Design Decisions & Conventions

- **Embedded SQL** is used for existence checks in related tables (RTRIPF, RJOUPF), rather than native RPG file I/O. This is likely for efficiency or to leverage SQL's expressive power for "exists" queries.
- **Parameter Passing**: The program expects its caller to manage context (firm, user, workstation) and supply member and operation flag as parameters.
- **Status Codes**: The program uses `'1'` for new/updated, `'2'` for related records found, and `'S'` for delete. These codes are not self-describing and are part of a broader convention in the ASOKON system.
- **Use of UDS**: The User Data Structure is used to pass session or job context (firm, user, workstation) between programs.
- **Goto for Early Exit**: The use of `goto xslutt` is a local convention for early exit upon completion of a logical branch.

---

## Interactions with Other Modules

- **Caller**: Must supply correct parameters and is responsible for session context.
- **Downstream Consumers**: Will interpret `w_info` on return to determine next actions.
- **Related Tables**: Existence of records in RTRIPF and RJOUPF influences status, likely affecting job workflow or reporting.

---

## Summary Table

| Operation | Input `w_info` | Action Taken                                     | Return `w_info` |
|-----------|----------------|--------------------------------------------------|-----------------|
| Delete    | 'S'            | Delete RJOBLU record if exists                   | (unchanged)     |
| Insert    | else           | Write new RJOBLU if not exists                   | '1'             |
| Status    | else           | If RTRIPF or RJOUPF has records for w_memb       | '2'             |

---

## Maintenance Notes

- **Key Definitions**: Any change to the RJOBLU, RTRIPF, or RJOUPF file layouts (especially key fields) will require updates here.
- **Status Codes**: If new business statuses are introduced, update the logic and documentation accordingly.
- **SQL Statements**: Embedded SQL assumes single-row fetches; if data volume grows, review performance.

---

## Conclusion

This program is a core part of job lifecycle management in ASOKON, acting as a gatekeeper for job status records and ensuring data consistency across related tables. Understanding its parameter-driven logic and file interactions is essential for effective maintenance and extension.