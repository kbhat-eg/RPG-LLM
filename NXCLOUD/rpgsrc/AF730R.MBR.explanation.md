# Overview of RPG Source Code for File Monitoring and Notification System

This RPG program, named *AF730R*, is designed to monitor specific FTP directories for files related to certain file groups, check their statuses, and send email notifications if files are outdated or issues are detected. Below is a detailed walkthrough of key components and their functionalities:

---

## 1. Header and Metadata

- **/define LoggingIsOn**: Conditional compilation directive to include logging features.
- **HDFTACTGRP(*NO)**, **h option(*nodebugio : *srcstmt)**: H-specs configuring program behavior.
- **Program Info Block**: Comments specify the system, program purpose (checking old files in FTP directories), version history, and author initials.

---

## 2. Variable Declarations

- **Email Addresses**:
  - *til_mail*: Recipient email (support@eg.no or other).
  - *fra_mail*: Sender email (noreply@egcloud.no).

- **File and Directory Settings**:
  - *dirlist_lib*: Library name where directory listing table resides.
  - *dirlist_pre*: Prefix for directory list table.
  - *dirlist_tabell*: Concatenation of library and table prefix, representing the actual table name.

- **Operational Parameters**:
  - *ant_dager*: Number of days to consider a file outdated (default 10).
  - *antall_dager*: Character version of *ant_dager*.
  - *sjekk_type*: Variable to specify type of check (BUSY, BYGGDOK, COBUILDER2).

- **Prototypes of External Programs**:
  - *P_AF732C*: Sends email notification.
  - *P_AF731C*: Checks directory contents.
  - *AF730R*: The main program entry point.

- **Working Variables**:
  - *finished*: Loop control indicator.
  - *RS_Filgrupper*: SQL result set locator for file groups.
  - *dsFilgrupper*: Data structure holding details of file groups (Miljo, Filgruppe, Lvr).

---

## 3. Program Initialization

- Sets the SQL date format to ISO.
- Constructs *dirlist_tabell* for linking to the directory listing table.
- Logs start message if logging is enabled.
- Calls *FinnFilGr()* to fetch all active file groups from the database.

---

## 4. Main Logic Flow

- Checks file groups, performs three types of checks sequentially:
  - **BUSY**: Checks for files marked as busy.
  - **BYGGDOK**: Checks for files related to construction documentation.
  - **COBUILDER2**: Checks files generated by the COBUILDER2 process.

- Each check invokes *SjekkFilGr()* with the specified *sjekk_type*.

- Logs program end if logging is enabled.

---

## 5. Subroutine: `SjekkFilGr`

### Purpose:
To iterate over each file group, execute SQL queries to identify outdated files or issues, and trigger email alerts.

### Key Steps:
- Loop over each file group retrieved from *FinnFilGr()*.
- Build SQL commands dynamically based on the check type:
  - **BYGGDOK**: Files with a maximum date or specific conditions.
  - **BUSY**: Files with status 'B' indicating busy.
  - **Others**: Files older than *ant_dager* days.
- Prepare and execute the SQL query to fetch file details.
- Iterate over each file record:
  - Compose email subject and content based on file status.
  - Use *P_AF732C* to send alert emails.
  - Check directory contents using *P_AF731C*.
  - If directory check fails, send an error email.
  - Check for specific filename patterns and count matching files via *SjekkKatalog*.
  - Send notifications based on file age and presence.

---

## 6. Subroutine: `SjekkKatalog`

### Purpose:
Count the number of files matching a pattern in the directory table, considering a minimum age.

### Logic:
- Generate SQL to count files with specific naming patterns, filtered by modification time.
- Use cursors to execute and fetch count.
- Return the count (*antall*).

---

## 7. Subroutine: `FinnFilGr`

### Purpose:
Retrieve all active file groups from the database.

### Process:
- Call stored procedure *SP_ALLE_AKTIVE_FILGRP*.
- Associate result set with *RS_Filgrupper*.
- Fetch the first 500 records into *dsFilgrupper*.
- Close cursor and set status to 1 to indicate successful retrieval.

---

## 8. Optional Logging: `JobLog`

If *LoggingIsOn* is defined, this subroutine outputs program and process messages to the job log, aiding debugging and monitoring.

---

## 9. Summary

This RPG program automates the process of monitoring file directories related to specific file groups, checking for outdated or problematic files, and alerting responsible personnel via email. It leverages embedded SQL, cursors, dynamic SQL construction, and stored procedures to perform its tasks efficiently. Conditional compilation allows enabling or disabling logging.

---

**Note:** This code assumes the existence of certain database procedures, directory list tables, and email-sending programs, which are integral to the system's operation.