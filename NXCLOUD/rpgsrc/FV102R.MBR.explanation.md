# RPG Program Explanation - FV102R

This RPG III/IV program is written for IBM i (AS/400) and is named `FV102R`. The main purpose of the program is **maintenance of status codes and special codes** related to (likely) order processing, integration, and company-specific registry values. The program retrieves, displays, allows editing, and updates code records while supporting multiple screens and options for enhanced functions, such as FTP scheduling and interfacing with external economic systems.

Below, the source code is explained in a structured, developer-friendly way.

---

## 1. **Header Section**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Program does not allow debugging of I/O operations.
- Date edit format is day-month-year (DMY).

---

## 2. **Program & Change Log Comments**

A big comment block describes:
- The system name, program name, and its description (Norwegian: "Vedlikehold av status-koder, Spesielle koder" = Maintenance of status codes, Special codes).
- Detailed historical change log; this helps you see what has been added per version.

---

## 3. **File Declarations (`F-Specs`)**

```rpg
ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
ffstslu    uf a e           k disk    rename(fstspfr:fstslur)
...
ffv102d    cf   e             workstn
```
- Main files are status code files (e.g., `fstsl1`, `fstslu`), special codes (`rscdl1`, `rscdlu`), advance/payment related (`fst2l1`, `fst2lu`, `amodl1`), economic systems (`rb00l1`, `rb00lu`), and an extension register (`xtill1`).
- Files are renamed at program level to avoid naming conflicts or for clarity in logic.
- `fv102d` is the display file for user interaction (workstation).

---

## 4. **Data Declarations (`D-Specs`)**

Many working storage variables and subfields, including fields for user, firm, formatted output, parameters for screen fields, etc. Some fields are only included on relevant versions/features.

---

## 5. **Main Processing Logic**

### a. **Start / Initial Screen**

```rpg
c     a1taga        tag
...
c     stskey        chain     fstsl1                             90
```

- The entry point sets a label/tag for the initial screen logic.
- Attempts to look up a status code record using the current key.
  - If found, moves fields from the record to the screen buffer fields.
  - If not found, blanks/zeroes out fields.
- If payment/advance-related records (`fst2l1`) exist, retrieves these too.
- Special logic handles reading an additional registry for economic system info (via `xtill1`).

### b. **Retrieving Economic System ("Ã˜konomisystem")**

```rpg
8.01 c                   eval      xtill1_firm = w_firm
...
8.01 c     xtill1_key    chain     xtill1
...
8.01       exec sql
8.01          select r00txt
8.01            into :a2ak03txt
8.01           from rbokpf
8.01            where r00kod = :a2ak03;
```
- Reads extra info from `xtill1` for the current company and status key, specifically "OKOSYS" (economic system).
- If found, fetches the system description via embedded SQL from table `rbokpf`; otherwise uses defaults.

### c. **Display and Process Main Screen(s)**

```rpg
c                   exfmt     a1bld
c     *inkc         cabeq     *on           xslutt
```
- Displays the main maintenance screen (`a1bld`).
- Function key F3 (detected by `*inkc`) will exit (`goto xslutt`).

### d. **Display Additional Panels / Screens**

Subsequent blocks show additional screens (`a2bld`, `a3bld`, `a4bld`) based on user action (function keys):
- **`a2bld`**: Special agreements/codes for order creation, with more related function key handling.
- **`a3bld`**: Special code register #2, including advanced logic for FTP and job scheduler.
- **`a4bld`**: Payment/deposit-related logic for special order types.

### e. **Update & Write-back Logic**

Handles updates and writes to the main file(s) and auxiliary/extension files, depending on screen flows and edits. For each status code record:
- If it exists, updates; if not, writes a new record.
- Audit fields like date, time, and user are updated accordingly.

### f. **Integration with FTP/Job Scheduler**

In the panel for code-register-2:
- You can call external programs to handle FTP jobs (e.g., `FV102C`) or to update batch job schedule (job scheduler).

---

## 6. **Exit and Cleanup**

```rpg
c     xslutt        tag
c                   seton                                        lr
c                   return
```
- Sets the last record indicator (`LR`), ending the program and freeing resources.

---

## 7. **Initialization Subroutine (`*INZSR`)**

```rpg
c     *inzsr        begsr
...
c     *like         define    faafir        stsfir
...
c                   move      l_firm        stsfir
c                   move      l_firm        w_firm
...
c                   eval      b_for  = *off
c                   eval      amodl1_modu = 'forskudd'
c     amodl1_key    chain     amodl1
c                   if        %found(amodl1)
c                   eval      b_for = *on
c                   endif
c                   endsr
```
- Defines file keys and copies company number into key fields.
- Detects if the current company uses "forskudd" (advance payment); sets a flag for enabling related features/panels.

---

## 8. **General Notes**

- Extensive use of Norwegian field/variable names and comments.
- **Version-specific code** is marked with comments like `7.03`, `8.01`, etc., to show when/why new logic was added.
- **Screen fields** are handled via move/eval between file fields and "screen buffer" variables.
- **Function keys** are used to branch into different panels and actions.
- There is a blending of classic RPG C/400 specs (fixed format) and some free-form style (embedded SQL).


---

## **Summary Table**

| Area            | Main Purpose                                 |
|-----------------|----------------------------------------------|
| File Handling   | Retrieve/update/add status and special codes |
| Screens         | Maintenance, additional options              |
| Integration     | FTP, external economic systems, job schedule |
| Audit Trail     | User/date/time for changes                   |
| Initialization  | Key setup, feature flags                     |
| Extensibility   | Multiple file versions/expansions supported  |

---

## **For New Developers**

- **Navigation:** User can pull up records, edit them, flip between panels with function keys; save, cancel, or trigger side actions (FTP/job scheduling).
- **Maintenance:** Update the logic for new codes, add file fields, or interface with new systems by expanding this template.
- **Customization:** Review the "Change Log" up top to ensure new work lines up with versioning and comments.
- **Testing:** Test all screens and paths, especially with new company numbers, as key setup is dynamic.

---

## **Key Takeaways**

- The program is a robust, extensible, "code register" maintenance utility with support for various side functions tied to order processing and integration.
- Main logic is straightforward: fetch, display, edit, update; with many hooks for special options.
- Heavy reliance on IBM i/OS file structure and field movement.
- Extensive use of version history and comments to guide further development.

---

**Tip:** For further onboarding, pair this read with layouts of the physical files (PFs/DB2 tables) and the display file DDS referenced as `fv102d`. Also, review the external programs called for scheduling and integration.