# RPG Source Code Explanation

## Overview

This RPG (Report Program Generator) ILE program, named **VV560R**, is designed to manage and maintain product assortments (`varesortiment`) within a business system. The program provides interactive subfile-based UI, supports adding new assortment modules, and interacts with several physical files for lookup, update, and creation of records.

### File Definitions

- **Physical Files:**
  - `vvarla`, `vugrl1`, `vsdtl1`, `vsdtlu`, `rlevl1` – all defined with `rename` to uniquely named record formats for use in the program.
- **Workstation File:**
  - `vv560d` – the display file, with subfile support via `sfile(b1sfl:w_srrn)` and display feedback via `infds(dspfbk)`.

### Program Metadata

- **System:** ASOFAK
- **Description:** Product assortment management (modules)
- **Change Log** documents updates and version tracking.

---

## Indicators – Usage

- **LR**: End of program
- **Subfile Control:** 10 (Roll), 11 (Rolldown), 12 (Sfldsp), 13 (Sfldspctl), 14 (Sflclr), 15 (Sflend)
- **Cursor/Field Control:** 21 (Home-key), 22 (Cursor placement), 30 (Field protect)
- **Warning/Errors:** 31–79
- **Work Indicators:** 80–99

---

## Data Definitions

### Parameters

- `p_firm`, `p_vsor`, `p_lage`, etc.: Parameters passed into the program, typically via `CALL` from another program. Used to identify company, assortment, storage location, department, and grouping.

### Local Data Area

- `l_user`: Holds the user profile or user-specific data from the system's local data area.

### Information Data Structure

- `dspfbk`: For capturing feedback from the display file, such as the current cursor row (`d_fcrn`).

### Key Field Variables

- Used for building keys for file input/output operations, e.g. `vvarla_ldor`, `vsdtl1_vsor`, etc.

### Subfile Control Variables

- `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Used for subfile paging, cursor tracking, and subfile buffer management.

---

## Subfiles and Display

- **Subfile records:** `B1SFL`
- **Subfile control:** `B2CTL`
- **Command screen:** `B2CMD`

**Special subfile variables are documented in the code comments.**

---

## Main Program Flow

### Initialization – `*inzsr`

- Accepts parameters, initializes indicator flags and key fields.
- Performs lookups for supplier (`rlevl1`) and group data (`vugrl1`).
- Initializes subfile control fields and fills the subfile by running `crt_subfile`.

---

### Main Loop

1. **b2taga/b2tagb tags:** Mark major control points.
2. **Display Subfile:** `exsr dsp_subfile` shows the subfile to the user.
3. **Function Key Handling (`select`):**
   - *F3/F12*: Exit (`avslutt`)
   - *F5*: Refresh; runs `forny` (clear+recreate subfile)
   - *Roll*: Page up; recreates additional subfile records
   - *Home*: Sets up cursor position and returns to main display

4. **Subfile Processing:** `exsr subfile`
   - Handles user actions in the subfile (row selection, branching into detail program/calls, etc.)

5. **Exit/Return:** Sets LR to on/returns when done.

---

## Key Subroutines

### forny

- **Purpose:** Refreshes subfile data.
- **Actions:** Clears subfile (`clr_subfile`), then recreates it (`crt_subfile`).

### subfile

- **Purpose:** Process rows in the subfile.
- **Main Logic:**
  - Toggles cursor placement indicator.
  - Loops through visible subfile records (`do w_ssrn`).
  - Handles two main actions:
    - **Option 1 (Add to assortment):** Calls `opprett` to add, sets marker and updates subfile row.
    - **Option 7 (View details):** Calls program `VV561R` with relevant parameters for that module, updates subfile row.

### clr_subfile

- **Purpose:** Clears (empties) the subfile display and resets counters.

### crt_subfile

- **Purpose:** Fills the subfile with product assortment modules.
- **Main Logic:**
  - Calculates next page size.
  - Reads new records from `vvarla` matching the search key.
  - Ignores duplicate module numbers within a single load.
  - Calls external program `FO714C` for each to retrieve module text.
  - Writes record to subfile.
  - Updates paging fields accordingly.

### dsp_subfile

- **Purpose:** Controls display of the subfile. Sets up indicators and formats the control record for input/output display.

### opprett

- **Purpose:** Adds a new module to the assortment if not already present.
- **Logic:**
  - Builds key for target module.
  - If not found, initializes and writes a new line.
  - Sets create/change audit fields (date/time/user from system).

---

## Keys and File Operations

- **setll/reade/chain:** Used to position and retrieve records efficiently by keyed access.
- **write/update:** Used for record creation and update (both physical and subfile files).

---

## External Program Calls

- **VV561R:** Called for option 7 (detail display for a module).
- **FO714C:** Called to retrieve text for a module, likely for display purposes.

---

## Comments and Documentation

The code is well-documented with **Norwegian comments**, describing business processes, indicator usage, and subfile management methodology.

---

## Subfile Processing Approach

- **Paging:** Uses variables and indicators to handle multi-page subfiles.
- **User Actions:** Processes user input for each record in the subfile.
- **Dynamic Updates:** Supports adding, selecting, and refreshing assortment modules on screen.

---

## Error Handling

- **Duplicate Checking:** Before adding a module, checks if it already exists in the assortment.
- **End-of-File Handling:** Sets end-indicators and manages buffer variables accordingly.

---

## Conclusion

This program is a classic example of RPG subfile programming for product assortment maintenance. It is modular (with clear subroutines), interactive (using subfiles and function keys), and integrates well with other business logic (via file I/O and external program calls).

**Key business logic:**  
- Add new modules to an assortment
- Display and maintain assortment details
- Interface with related records (groups, suppliers, etc.)
- Provide a robust user interface for interactive work on IBM i

**To onboard a developer:**  
- Understanding subfile patterns, indicator usage, and file/key management in RPG is critical.
- Review of external programs called and data file definitions (DDS) will enrich understanding.
- Familiarity with Norwegian terminology (e.g., “vare”, “sortiment”, “lagre”) is beneficial.

---

**Tip:**  
To expand or modify, focus on subfile behaviors, parameter passing, and file I/O structure. Consider converting to /FREE format or modularizing with service programs if you modernize.