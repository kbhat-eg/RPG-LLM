```markdown
# Overview  
This ILE RPG program (`NO122R`) reads “external” orders from pick‐register files, performs credit checks and memo‐balance calculations, then creates corresponding internal orders (headers + lines). It supports special handling for TBU (online store) orders, EDI/EHF messages, flexible memo‐balances, and optional deletion of existing offers with the same external reference.

---

## 1. File Declarations  
- **External order files**  
  - NOHEL1/NOHELU: external order header (full/unchanged)  
  - NODTL1: external order lines (full)  
  - EDDTLR/EDDTLU/EDHELR/EDHELU: pick‐register for external orders (header & lines)  
- **Internal order files**  
  - FOHELU/FOHELR: internal order header (unchanged/full)  
  - FODTL1: internal order lines  
  - FOTXLU: top/bottom text lines (for electronic orders)  
- **Support files**  
  - RKUNL1/RKMEL1: customer master + memo balances  
  - VOTYL1: order‐type definitions  
  - FUSRL1/AUSRL1: user master (to derive seller, department)  
  - FKPRL1: customer‐project information  
  - FSTSL1: order‐status defaults  

Keys (`KLIST`) are defined for fast `CHAIN`, `READP`, `SETLL`/`READE` on all files.

---

## 2. Parameter & Local Data Areas  
- **Input parameters** (Firm, System code (e.g. “TBU”, “EDI”), Terminal ID, Pick‐register date).  
- **Local variables** track:  
  - current user/WSID  
  - working order number/type/firm  
  - credit balances, limits, memo days/grace %  
  - loop counters and line numbers  

---

## 3. Initialization (`*ENTRY` / `inzsr`)  
1. Load input parameters into working fields.  
2. Look up order‐status defaults (FSTSL1) and user defaults (AUSRL1).  
3. Fetch current VAT % via `RS205R` for memo‐balance calculation.  
4. Read “extended memo balance” configuration from program `CO402R` (switch, days, % extension).  

---

## 4. Main Logic Flow  

### 4.1. Fetch External Header  
- `CHAIN` into NOHEL1 using (Firm, Sys, Tell).  
- If not found → exit.  
- Otherwise update NOHELU record with a temporary “high‐value” order number to lock it.  

### 4.2. Determine Order Type  
- Fetch `faaot8`; if blank use `faaot2`.  
- If `p_fsys = 'TBU'`, override to type ‘T’.  
- Store in `b1otyp`.

### 4.3. Credit & Memo‐Balance Checks  
1. Read customer record (RKUNL1) → get credit block flag (`rkkres`), credit limit (`rkgrns`), current memo balance (`rkmems`).  
2. If credit block (`rkkres=1`) → set *IN41 and stop.  
3. If limit set (`rkgrns≠0`) compute working balance (`w_sald`) including VAT, apply possible % extension (`w_utvgrns`), days (`w_memodagr`), then check against limit → set *IN42 if over.  
4. Check “general limit” (`rkgral`) via FO106R if not on customer record → set *IN43 if exceeded.  
5. Display a simple 1‐screen (`b1bld`) to allow operator to Continue/Exit/Spørring (F4).  
   - F3 → rollback and exit.  
   - F4 → call VA550R (inquiry screen) and return to same screen.

### 4.4. Validate Order Type  
- Re‐`CHAIN` VOTYL1 (`Firm`, `b1otyp`) → if not found or inactive → redisplay screen.

### 4.5. Loop over Pick‐Register Headers (EDHELR)  
```rpg
  SETLL edhelr;
  READE edhelr;
  DOW NOT %EOF(edhelr);
    IF rrnumm = 0 OR new pick‐header
      EXSR ordre_hode;        // Create internal order header
    ENDIF;

    EXSR ordre_linje;         // Create any header‐level text lines
    EXSR oppdat_ordre;        // Update header totals & memo balance

    // Call FO100R → post‐process the order
    EVAL w_valg = 2;  
    CALL 'FO100R' parm(w_valg : fonumm : fosuff);

    READE edhelr;
  ENDDO;
```

### 4.6. Update External Header  
- `CHAIN` EDHELU → update it with the created order number/date/user.  
- Exit program.

---

## 5. Subroutines  

### 5.1. ordre_hode  
1. **Get Next Order Number** via `hent_nummer` (calls AS100R + FO415R).  
2. Initialize FOHELU fields from NOHEL1/EDHELR:  
   - firm, num, suffix, type, customer, addresses, dates, references.  
3. Override defaults from customer master + optional “invoice‐to” customer.  
4. Derive seller & sales rep reference via FUSRL1 + RA09L1.  
5. Derive project info via FKPRL1.  
6. Write FOHELU record.  
7. **TBU special**: if external ref (parent ref) exists, use embedded SQL to find previous internal order → delete old offer lines via XL700R & FO410R (to avoid duplicates).

### 5.2. ordre_linje  
1. Pick up highest existing line number with `hent_linjenr`.  
2. If a header‐level message (`nomeld`) exists:  
   - split into 70‐char chunks, call FD111R to write text lines (or FOTXLU for electronic orders).  
3. Loop pick‐register lines (EDDTLR / EDDTLU):  
   - `CHAIN` NODTL1 by line → if found, get item code, quantity, price fields.  
   - If `parentRef` flag (`b_pref`), call FD116R (no price‐change) else FD106R (normal price calc).  
   - Update pick‐line (EDDTLU) with resulting internal order info (order#, suffix, line).

### 5.3. oppdat_ordre  
1. Read all FODTL1 lines for this order → compute:  
   - gross sum, returns, discounts (1 & 2), rebate tiers (BRR1/BRR2).  
2. Compute new memo balance (via FA922R).  
3. Update FOHELU with totals + new memo balance.

### 5.4. hent_nummer  
1. Prepare key values: `faaork` (order serial), WSID, type.  
2. Call VA752R to allow overriding numbering series.  
3. Call AS100R to get next number.  
4. Call FO415R to ensure no duplicates remain.

### 5.5. hent_linjenr  
1. `READP` FODTL1 with line=9999 → give highest existing line.  
2. Store in `w_line` to start new lines at next multiple of 10.

---

## 6. Key Enhancements & Version Notes  
- **7.01 / 7.02**: floating memo‐balance over N days, adjustable via properties or `CO402R`.  
- **7.03**: new logic to derive “our reference” from seller master (RA09).  
- **7.04**: invoice‐to customer support.  
- **8.01–8.08**: special TBU (online store) handling: delete prior offers, block price changes when `parentRef`, suggest `FOLBTX` from EDI, and fix numbering series.

---

**Pedagogical Tips:**  
- Follow the subroutine signatures (`ORDRE_HODE`, `ORDRE_LINJE`, `OPPDAT_ORDRE`, `HENT_NUMMER`, `HENT_LINJENR`) to see isolated responsibilities.  
- Trace the “credit → screen → validation → loop → create header → create lines → post‐process → update external” to understand the end‐to‐end flow.  
- Key lists at the bottom define how each `CHAIN`, `READE`, `READP`, `SETLL` works for each file.  
- Pay attention to the various `IF / %FOUND / %EOF` checks which guard whether external data exists, whether credit limits are exceeded, and branch accordingly.
```