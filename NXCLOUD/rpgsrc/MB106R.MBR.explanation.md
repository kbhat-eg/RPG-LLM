# Program MB106R: ABC Analysis - All by Quantity

## Purpose and Business Context

**MB106R** is part of the ASLOGI system and implements an interactive ABC analysis over all items, grouped and filtered by several business dimensions (warehouse, groupings, etc.). The program supports querying, updating, and displaying ABC/XYZ classifications for inventory items, with drill-down and update capabilities. It is designed for use by planners or inventory controllers to review and manage ABC/XYZ codes at both item and warehouse level.

ABC/XYZ analysis is a method for classifying inventory based on value (ABC) and demand variability (XYZ), used in supply chain management for prioritization.

## High-Level Structure

- **File Definitions:** Multiple logical file interfaces for inventory, warehouse, and item master files, using different record formats and keys.
- **Display Files:** Uses a workstation file (`MB106D`) with subfiles for displaying lists and handling user input.
- **Parameters and Data Areas:** Receives input parameters for filtering (warehouse, group, etc.) and uses the LDA for user/firm context.
- **Main Loop:** A main display-control loop handles user navigation, function keys, subfile paging, and updates.
- **Subroutines:** Modular subroutines for subfile management (create, clear, display, page), record positioning, data validation, and updates.
- **External Program Calls:** Calls out to other programs for price retrieval (`VP750R`), item info lookup (`VV500R`), warehouse price group (`VL712R`), and forecast update (`MM747R`).

## Key Business/Data Relationships

- **ABC/XYZ Codes:** Maintained for each item, possibly at warehouse level. Can be updated through the interface.
- **Grouping:** Items are filtered/grouped by warehouse, sorting order, group, subgroup, and higher groupings.
- **Subfile Paging:** Supports paging through large result sets with rollup/rolldown, positioning by item, quantity, or percentage.
- **Multi-level Update:** Updates propagate to both item master and warehouse-item records, depending on context.

## Detailed Component Overview

### 1. File Definitions

- **mabclr, mabdl1, mabdl6, mabdl8, mabdlr, mabdlu:** Logical files over the ABC detail and header tables, with various keys for different access patterns (by item, by percent, by quantity, etc.).
- **vvarl1, vvarlu:** Item master files, for read/update.
- **vlagl1, vlaglu:** Warehouse-item master files, for read/update.

### 2. Display File

- **MB106D:** Workstation file with subfile (B1SFL) and multiple screens for different operations (control, command, edit, confirm, etc.).
- **infds(dspfbk):** Used for feedback (e.g., cursor position).

### 3. Parameters and LDA

- **Input Parameters:** Warehouse, sorting order, groupings, ABC code, and a return value.
- **LDA:** Supplies user, firm, and other session context.

### 4. Main Control Flow

- **Main Loop:** Handles display, user input, and function key processing.
    - Writes the command screen, then enters a loop displaying and updating the subfile.
    - Handles function keys for navigation (rollup/rolldown), position (by item, quantity, percent), refresh, and update operations.
    - Branches to subroutines based on user actions (edit, update, explain, etc.).

### 5. Subfile Management

- **Subfile Paging:** Implements paging with support for rollup, rolldown, and positioning.
- **Subfile Creation (`crt_subfile`):** Reads records according to the current positioning mode and populates the subfile.
- **Subfile Clearing (`clr_subfile`):** Clears the subfile before repopulation.
- **Subfile Display (`dsp_subfile`):** Handles the display and user interaction with the subfile.

### 6. Positioning Logic

- **posisjoner:** Positions the file pointer for subfile creation based on user input (item, quantity, percent).
- **forny:** Refreshes the subfile based on the current position.

### 7. Edit/Update Operations

- **xc2bld:** Handles the edit/view screen for an item, loading details, validating input, and updating records.
    - Validates ABC/XYZ codes.
    - Updates both item and warehouse records as required.
    - Calls out to update forecast data if needed.
- **xc3bld:** Handles a similar screen for another editing context (possibly a different mode, e.g., price editing).

### 8. Business Rules and Validations

- **ABC/XYZ Code Validation:** Only allows specific code combinations.
- **Update Propagation:** Updates to ABC/XYZ codes are propagated to item master or warehouse-item records as appropriate.
- **Locking/Unlocking Logic:** Handles locking logic for ABC code at item or warehouse level, with indicators for locked status.

### 9. External Program Calls

- **VP750R:** Retrieves item price (possibly campaign price); called during edit/view to display price.
- **VL712R:** Retrieves price group for warehouse.
- **VV500R:** Looks up item info for query screens.
- **MM747R:** Updates forecast data with new ABC code.

### 10. Indicators & Screen Handling

- **Indicators 10-15, 21-22, 30-99:** Used for subfile navigation, field protection, error signaling, and working state.
- **Screen Images:** Multiple screens for subfile, edit, confirm, and explanation windows.

### 11. Key List Definitions

- Multiple `klist` blocks define composite keys for various logical files, matching the business logic for filtering/grouping.

### 12. Initial Program Setup

- **Initialization (`*inzsr`):** Loads parameters, LDA values, and initializes key fields and subfile for initial display.

## Notable Design Decisions and Patterns

- **Subfile Pattern:** Standard IBM i subfile paging and display pattern, with explicit subfile management for scalability.
- **Multi-Key Logical Files:** Extensive use of logical files with composite keys to support flexible access patterns and performance.
- **Screen-Driven Workflow:** The program is tightly coupled to the DDS display file, with logic driven by screen indicators and user input.
- **Business Logic Encapsulation:** Business rules (e.g., ABC/XYZ code validation, locking logic) are encapsulated in subroutines for maintainability.
- **Externalization of Business Logic:** Price and forecast logic are externalized in separate programs, supporting modularity and reuse.

## Interactions with Other Modules

- **Item Master (vvarpfr):** Reads and updates item records.
- **Warehouse Master (vlagpfr):** Reads and updates warehouse-item records.
- **Pricing Module (VP750R, VL712R):** Retrieves price and price group information.
- **Forecast Module (MM747R):** Updates forecast data with new ABC codes.
- **Item Lookup (VV500R):** Used for item information queries.

## Domain-Specific Notes

- **ABC/XYZ Classification:** Central to the program, these codes drive inventory management and are critical for downstream processes (forecasting, replenishment).
- **Warehouse/Item Granularity:** The program supports both item-level and warehouse-item-level classification, with logic to update the correct records.
- **Audit and Tracing:** Updates include user and timestamp fields, supporting auditability.
- **GUI/Screen Evolution:** Comments indicate adaptation for new GUI versions; some logic may be DDS-specific.

## Summary

MB106R is a robust, interactive program for managing ABC/XYZ codes across inventory, supporting efficient navigation, update, and validation of classification codes. It is designed for integration with broader inventory, pricing, and forecasting modules, and follows established IBM i subfile and modular programming patterns. The code demonstrates careful handling of business rules and user interaction, with a focus on data integrity and usability for business users.