# RPG Program Explanation

This is an ILE RPG (RPG IV, fixed-format) program named `RK695R` running on an IBM i (AS/400) system.

Its purpose is to print copies of "general notes" ("generalnota"), by letting the user specify parameters using a display file, validating them, and returning the result in parameter variables.

Below is a detailed breakdown of the code:

---

## 1. Header and Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
* System. . . . . : ASOKON
* Program . . . . : RK695R
* Beskrivelse . . : Utskrift kopi av generalnota - parameter
...
* Ref.   Dato  Sign Endringsbeskrivelse
* V5.50 080108 HFL  Nytt program
```

- **`option(*nodebugio)`**: Disables certain debug info; usually for production.
- **`datedit(*dmy)`**: Sets default date format to Day-Month-Year.

Comments describe program purpose, versioning, and indicator use.

---

## 2. File Declarations

```rpg
fausrl1    if   e           k disk
frk695d    cf   e             workstn
```

- **`ausrl1`**: Input file, keyed, containing user records (possibly user info or authority).
- **`rk695d`**: Display file, workstation type, used for user interaction.

---

## 3. Data Structures & Fields

### Message Array

```rpg
d mld             s             50    dim(10) ctdata perrcd(1)
```
- Stores messages of up to 50 chars, 10 entries, populated from compile-time data at end of source.

---

### Date Handling Data Structures

```rpg
d                 ds
d w6fdat                         6  0
d  w6fdag                        2  0 overlay(w6fdat)
d  w6fmnd                        2  0 overlay(w6fdat:3)
d  w6faar                        2  0 overlay(w6fdat:5)

d                 ds
d w_fdat                         8  0
d  w_faar                        4  0 overlay(w_fdat)
d  w_fmnd                        2  0 overlay(w_fdat:5)
d  w_fdag                        2  0 overlay(w_fdat:7)
```
- These are for parsing and reformatting dates: both 6-digit and 8-digit formats.
- Overlays allow extracting day, month, year from a packed field.

---

### Local Data and Parameters

```rpg
d                uds
d pgenf                 300    305  0
d pgent                          6  0
d praar                          4  0
d pudato                         8  0
```
- Parameter fields, mapped in a User Defined Structure (UDS), for passing values between the program and caller.

### Miscellaneous Work Fields

A variety of fields for local calculations, such as year, month, user ID, firm number, indicators, etc.

---

## 4. Main Program Flow

### Initialization (`*inzsr` subroutine)

- Resets some working fields.
- Extracts firm and user parameters.
- Proposes a default accounting year (last year if it's January, otherwise current).
- Reads the user record from `ausrl1` if possible.

```rpg
c     *inzsr        begsr
   ...
c     ausrl1_key    chain     ausrl1                             63
c     *entry        plist
c                   parm                    p_in03
   ...
c     ausrl1_key    klist
c                   kfld                    w_user
c                   endsr
```

---

### Display Screen Input and Validation (A2BLD Section)

- Presents the input screen (`exfmt a2bld`).
- Resets error indicators (`*in40`–`*in43`).

#### Exit Option
```rpg
c                   if        *inkc = *on
c                   move      '1'           p_in03
c                   goto      xslutt
```
- If function key (F3/Exit) pressed, set return code and exit.

#### Field Validations

Repeating structure:
- **If invalid field**: Set error indicator, display message, go back to input.
- Example: Generalnota number "from", "to", year, print date are all validated.

#### Date Handling

- Decompose the 6-digit date input into day, month, year (`w6fdat` fields).
- Recompose as 8-digit date (adds 1900/2000 based on two-digit year).
- Move validated/converted data into parameter fields.

---

### Interacting with the User

There is a subroutine for handling warning/confirmation popups (`xm1win`), used for user confirmation if the year is greater than the current year.

---

### Program End

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Sets LR indicator to signal end of program.

---

### Message Data (Compile-Time Table)

At the end, the `mld` array is populated with messages, such as:

```
Generalnota nr. fra må oppgis                      01
Generalnota nr. til må oppgis                      02
Generalnota nr. fra er større enn til              03
Regnskapsår er ugyldig                             04
Valgt periode er neste år.                         05
Bekreft dersom dette er riktig.                    06
Utskriftsdato er ugyldig                           07
```

These are used for field validation feedback.

---

## 5. Indicator Usage

*As described in comments:*
- `KA` (`*in01`) = F1 (Choose company)
- `KC` (`*in03`) = F3 (Exit)
- `LR` = End of program
- `30` = Protect fields during display
- `31-59` = Warnings/field error indicators
- `60-69` = File indicators (chain, etc.)
- `70-79` = Work indicators in subroutines
- `80-89` = Other work indicators
- `90-99` = Standard subroutine indicators

---

## 6. High-Level Flow Summary

1. **Initialize**: Set up work fields, propose default year, get user context.
2. **User Input**: Display parameter entry screen.
3. **Validate Input**: Check for valid numbers, date ranges, years, etc.
4. **Confirm with User**: Popup warning if year is next year.
5. **Parameter Assignment**: Prepare output parameter fields with validated info.
6. **Exit**: Return to caller with parameters or error.

---

## 7. Key Takeaways for Developers

- The code is a parameter entry and validation shell for a report program.
- It is heavily reliant on display file interaction and old-style RPG logic/indicators.
- Most logic is about user input/validation and parameter handling, not about actual report generation or business calculations.
- Pay attention to field overlays and data movement between structures—date handling, in particular, can be confusing.
- Error handling and user messaging use indicator bits and preloaded message arrays.

---

## 8. Modernization Tips

- If maintaining or modernizing, consider switching to free-format RPG and using subprocedures/modules.
- Replace indicator-based logic with named variables.
- Use date data types and system functions for date manipulation.

---

**In short, this program is a typical RPG parameter validation front-end for a reporting job, using classic display file interaction and fixed-format RPG IV code.**