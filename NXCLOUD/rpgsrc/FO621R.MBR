     h option(*nodebugio)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : FO621R
      * Beskrivelse . . : Gjennomgang av grunnlag for fakurering
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       170723 bsa  Nytt program
8.01  *K0000  080424 bsa  Behandle riktig fortegn
8.02  *K0000  080424 bsa  Bryr oss ikke om fakturagebyr her.
8.03  *K0000  270524 bsa  Hvis kunden ikke skal "samlefaktureres"
8.03  *K0000              lager vi ikke sumpost.
8.04  *K0000  170624 bsa  Må nullstille variabler melom fakturaer
8.05  *K0000  241024 bsa  Sjekk om det finnes ordrenummer før det
8.05  *K0000              legges ut post på FFAKST.
8.06  *K0000  271124 bsa  Vi summerer også "vanlige" ordre, slik at vi
8.06  *K0000              fanger opp de som "burde" bytte ordretype.
8.07  *K0000  200525 bsa  Problemer med å finne riktig ordretype
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     ffpsol1    ipe  e           k disk    rename(fpsopfr:fpsol1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
8.06 fvot1l1    if   e           k disk    rename(vot1pfr:vot1l1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     ffgebl1    if   e           k disk    rename(fgebpfr:fgebl1r)
     ffgebl2    if   e           k disk    rename(fgebpfr:fgebl2r)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
      *
     fsdepl1    if   e           k disk    rename(sdeppfr:sdepl1r)
     frukrl5    if   e           k disk    rename(rukrpfr:rukrl5r)
     ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
     fvmval1    if   e           k disk    rename(vmvapfr:vmval1r)
     fbstsl1    if   e           k disk    rename(bstspfr:bstsl1r)
     fffakiu    uf a e           k disk    rename(ffakst:ffakiur)
8.03 frku2l1    if   e           k disk    rename(rku2pfr:rku2l1r)
      *
      * Definering av parametere
      *
      * Definering av lda
      *
     d                uds
     d l_peri                561    566  0
     d l_fkda                        10d   datfmt(*iso)
     d l_user                911    920
      *
      * Definering av variabler i nøkler
      *
     d rkunl1_kund     s                   like(rkkund)
     d vvarl1_vare     s                   like(vvvare)
     d votyl1_otyp     s                   like(vaotyp)
     d vltyl1_ltyp     s                   like(valtyp)
     d fgebl1_otyp     s                   like(fgotyp)
     d fgebl1_kkat     s                   like(fgkkat)
     d fgebl1_ftyp     s                   like(fgftyp)
     d fgebl1_line     s                   like(fgline)
     d fgebl2_otyp     s                   like(fgotyp)
     d fgebl2_kkat     s                   like(fgkkat)
     d fgebl2_ftyp     s                   like(fgftyp)
     d fgebl2_type     s                   like(fgtype)
     d fohel1_numm     s                   like(fonumm)
     d fohel1_suff     s                   like(fosuff)
     d fodtl1_numm     s                   like(fdnumm)
     d fodtl1_suff     s                   like(fdsuff)
     d fodtl1_line     s                   like(fdline)
     d sdepl1_numm     s                   like(sknumm)
     d sdepl1_kund     s                   like(skkund)
     d sdepl1_tell     s                   like(sktell)
     d rukrl5_ktyp     s                   like(ruktyp)
     d rukrl5_kkun     s                   like(rukkun)
     d rukrl5_kpro     s                   like(rukpro)
     d fkprl1_kund     s                   like(flkund)
     d fkprl1_kpro     s                   like(flkpro)
     d vmval1_mkod     s                   like(vamkod)
     d ffakiu_ksrt     s                   like(faksrt)
     d ffakiu_knum     s                   like(faknum)
     d ffakiu_ksuf     s                   like(faksuf)
8.03 d rku2l1_2kun     s                   like(rk2kun)
      *
      * Definering av variable
      *
     d w_firm          s                   like(fksfir)
      *
     d w_vare          s             15
      *
     d w_stat          s              1
     d w_mvak          s              1
     d w_mvtx          s             30
     d w_bpro          s              5  2
     d w_dato          s               d   datfmt(*iso)
     d w_mvap          s              6  2
     d w_mvat          s              5  4
     d w_mvaf          s             10  9
     d w_doty          s              2
     d w_koty          s              2
      *
     d w_belb          s             11  2
     d w_beln          s             12  3
     d w_belo          s             11  2
     d w_oppr          s             15  2
     d w_belw          s             11  2
     d w_belx          s             11  2
     d w_bely          s             11  2
     d w_bels          s             11  2
     d w_belk          s             11  2
     d w_kost          s             11  2
     d w_rkro          s             11  2
     d w_rkr1          s             11  2
     d w_rkr2          s             11  2
     d w_brk1          s             11  2
     d w_brk2          s             11  2
     d w_mgrl          s             11  2
     d w_moms          s             11  2
     d w_mvag          s             11  2
     d w_dbkr          s              1
     d w_gebm          s             13  4
     d w_geby          s             11  2
     d w_geb0          s             11  2
     d w_geb1          s             11  2
     d w_geb2          s             11  2
     d w_geb3          s             11  2
     d w_mkod          s                   like(rkmkod)
      *
     d w_sumif         s             11  2
     d w_sumuf         s             11  2
     d w_sumim         s             11  2
     d w_sums          s             11  2
     d w_fosa          s             11  2
     d w_fosi          s             11  2
      *
     d t_belp          s             11  2
      *
      * Definering av brytere
      *
     d b_lvrva         s              1    inz(*off)
      *
      * Definering av variable for
      * akkumulering til brudd ordre (L2)
      *
     d w2kstp          s             11  2
     d w2rbgp          s             11  2
     d w2rkop          s             11  2
     d w2rk1p          s             11  2
     d w2rk2p          s             11  2
     d w2rb1p          s             11  2
     d w2rb2p          s             11  2
     d w2gr1p          s             11  2
     d w2gr2p          s             11  2
     d w2mvgp          s             11  2
     d w2salp          s             11  2
     d w2fsum          s                   like(fotots)
      *
      * Definering av variable for
      * akkumulering til brudd fakt. (L6)
      *
     d w6fsum          s                   like(fotots)
     d w6geby          s             11  2
     d w6pasl          s             11  2
     d w6rkop          s             11  2
     d w6rk1p          s             11  2
     d w6rk2p          s             11  2
     d w6rb1p          s             11  2
     d w6rb2p          s             11  2
     d w6mvgp          s             11  2
     d w6salp          s             11  2
     d w6moms          s             11  2
      *
      * Definering av hjelpevariabler
      *
     d vvspny          s              9  2 inz(0)
     d vvspga          s              9  2
      *
     ifpsol1r       01
     i                                          fkssrt        l6
     i                                          fksonr        l3
     i                                          fkssuf        l2
      *
      * Notater / tips til programmet
      * -------------------------------
      * Det er her notert ned en del tips, som dokumentasjon til
      * hvordan dette programmet fungerer.  Det er en del forut-
      * setninger som det er viktig å være klar over:
      *
      * 01) Alle beløp som oppdateres i fakturaregister er eks. mva.
      *     (Fakturaregister = SOHEPF og SODTPF)
      *
      * 02) En faktura kan bestå ev flere ordre, dersom det er åpnet
      *     for dette.
      *     L2 - brudd = Slutt på ordre
      *     L6 - brudd = Slutt på faktura
      *     Det genereres automatiske posteringer på L6 brudd. Dette
      *     kan være frakt / gebyr / påslag.  Ordrehode inneholder
      *     akkumulatorer for ordresummer.  Flere ordre kan derfor
      *     måtte summeres opp til fakturatotaler.
      *     Frakt / gebyr / påslag legges til ordrehode på siste
      *     ordre på faktura.
      *
      * 03) Alle beløp i ordreregister er lagret med positive fortegn
      *     Ordretyper og linjetyper styrer om det er negative ordre
      *     eller negative linjer.  Men i oppdatering av faktura-
      *     register, legges alle poster ut med ferdig fortegn. (+/-)
      *
      * 04) Det er foreløpig noe problemer med beregning av vare-
      *     linjen's andel av ordrerabatt i ordresystemet.  Det er
      *     derfor lagt inn beregning i dette programmet, for å få
      *     riktig oppdatering av fakturaregisteret.
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av valg
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     C/Exec SQL
     C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR,
     C+             commit=*none
     C/End-Exec
     c   01              if        *in99 = *off
     c                   exsr      x_fcycle
     c                   endif
      *
     c                   if        *inl6 = *on
     c                   exsr      x_l6det
     c                   endif
      *
     c                   if        *inl2 = *on
     c                   exsr      x_l2det
     c                   endif
      *
      * Hopp til rett behandling   (Hode, Linje)
      *
     c     fkskod        cabeq     'H'           tag_hode
     c     fkskod        cabeq     'V'           tag_linje
     c                   goto      x_slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ORDRE-HODE-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag_hode      tag
     c                   exsr      x_hode
     c                   goto      x_slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ORDRE-LINJE-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag_linje     tag
      *
      * Hent opplysninger fra ORDRE-LINJE-REGISTER
      *
     c                   eval      fodtl1_numm = fksonr
     c                   eval      fodtl1_suff = fkssuf
     c                   eval      fodtl1_line = fkslin
     c     fodtl1_key    chain     fodtl1r
      *
      * Henter opplysninger fra LINJE-TYPE-REGISTER
      *
     c                   eval      vltyl1_ltyp = fdltyp
     c     vltyl1_key    chain     vltyl1r
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * NB!  Utgangspunktet er at alle beløp i ordreregisteret er
      *      lagret med positive fortegn.  Derfor blir disse snudd
      *      her i henhold til koder på ordretype og linjetype. Det
      *      viser seg imidlertid at negative varelinjer på en ordre
      *      ligger med positivt antall, men negative beløp på
      *      sum salg og sum kost.  For ikke å skape problemer
      *      for resten av systemet, blir disse snudd her med det
      *      samme de hentes inn, for så å følge samme prinsipper
      *      videre i programmet.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   if        valkre = '-'
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   endif
      *
      * Skal denne linjetypen oppdatere Økonomi og/eller statistikk
      *
     c                   if        valoko = 0
     c                   if        valsta = 0
     c                   goto      x_slutt
     c                   endif
     c                   endif
      *
      * Behandling av linjer
      *
     c                   exsr      x_linje
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avslutt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     x_slutt       tag
      *
     cl2                 exsr      x_l2tot
     cl6                 exsr      x_l6tot
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine som eksekveres når første record leses
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     x_fcycle      begsr
      *
     c                   eval      *in99 = *on
      *
      * Legger inn firmanummer i nøkklene
      *
     c                   eval      w_firm = fksfir
      *
      * Hent opplysninger fra OFAK-STATUS-REGISTER
      *
     c     fstsl1_key    chain     fstsl1r
      *
     c     bstsl1_key    chain     bstsl1r
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ordrehode
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_hode        begsr
      *
      * Hent opplysninger fra ORDRE-HODE-REGISTER
      *
     c                   eval      fohel1_numm = fksonr
     c                   eval      fohel1_suff = fkssuf
     c     fohel1_key    chain     fohel1r
      *
      * Hent opplysninger fra KUNDE-REGISTER
      *
     c                   eval      rkunl1_kund = fokund
     c     rkunl1_key    chain     rkunl1r
     c                   eval      w_mkod = rkmkod
8.03  *
8.03 c                   if        rkfaku <> 0
8.03 c                   eval      rku2l1_2kun = rkfaku
8.03 c                   else
8.03 c                   eval      rku2l1_2kun = rkkund
8.03 c                   endif
8.03 c     rku2l1_key    chain     rku2l1r
8.03 c                   if        not %found
8.03 c                   eval      rk2fas = 0
8.03 c                   endif
      *
      * Hent opplysninger fra KUNDE-PROSJEKT
      *
     c                   if        fokpro > 0
     c                   eval      fkprl1_kund = fokund
     c                   eval      fkprl1_kpro = fokpro
     c     fkprl1_key    chain     fkprl1
     c                   if        %found(fkprl1)
     c                   eval      w_mkod = flmkod
     c                   endif
     c                   endif
      *
      * Hent opplysninger fra ORDRE-TYPE-REGISTER
      *
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1r
      *
      * Beregne fordeling forhåndsbetalt
     c                   exsr      finn_forh
      * Adderer inn sum for beregning av gebyr
      *
     c                   eval      w_geb0 = (w_geb0 + fotots) - fototr
      *
     c                   if        fokgfa = 0
     c                   eval      w_geb1 = (w_geb1 + fotots) - fototr
     c                   endif
      *
     c                   if        fokgfr = 0
     c                   eval      w_geb2 = (w_geb2 + fotots) - fototr
     c                   endif
      *
     c                   if        fokgek = 0
     c                   eval      w_geb3 = (w_geb3 + fotots) - fototr
     c                   endif
      *
      * Sjekker om dette er en negativ ordre
      *
     c                   if        vaokre = '-'
     c                   eval      w_dbkr = 'K'
8.01 c                   else
8.01 c                   eval      w_dbkr = 'D'
     c                   endif
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ordrelinje mot økonomi
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_linje       begsr
      *
      * Nullstiller totaler for utskrift
      *
     c                   eval      w_beln = 0
     c                   eval      w_belo = 0
     c                   eval      w_belb = 0
     c                   eval      w_belw = 0
     c                   eval      w_rkr1 = 0
     c                   eval      w_rkr2 = 0
     c                   eval      w_rkro = 0
     c                   eval      w_brk1 = 0
     c                   eval      w_brk2 = 0
     c                   eval      w_kost = 0
      *
      * Hent opplysninger fra VARE-REGISTER
      *
     c                   eval      b_lvrva = *off
     c                   eval      vvarl1_vare = fdvare
     c     vvarl1_key    chain     vvarl1r
     c                   if        not %found
     c                   exsr      x_bvare
     c                   endif
      *
      * Beregner beløp
      *
     c                   exsr      x_beregn
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L6 det. (Ny faktura)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l6det       begsr
      *
      * Nullstiller hjelpfelter   (for beregning av gebyr/påslag)
      *
     c                   eval      w_geb0 = 0
     c                   eval      w_geb1 = 0
     c                   eval      w_geb2 = 0
     c                   eval      w_geb3 = 0
     c                   eval      w6geby = 0
     c                   eval      w6pasl = 0
      *
     c                   eval      w6salp = 0
     c                   eval      w6rk1p = 0
     c                   eval      w6rk2p = 0
     c                   eval      w6rb1p = 0
     c                   eval      w6rb2p = 0
     c                   eval      w6mvgp = 0
     c                   eval      w6rkop = 0
     c                   eval      w6moms = 0
      *
     c                   eval      w_dbkr = 'D'
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L2 det. (Ny ordre)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l2det       begsr
      *
      * Nullstilling
      *
     c                   eval      w2fsum = 0
     c                   eval      w2salp = 0
     c                   eval      w2kstp = 0
     c                   eval      w2rk1p = 0
     c                   eval      w2rk2p = 0
     c                   eval      w2rb1p = 0
     c                   eval      w2rb2p = 0
     c                   eval      w2rbgp = 0
     c                   eval      w2rkop = 0
     c                   eval      w2gr1p = 0
     c                   eval      w2gr2p = 0
     c                   eval      w2mvgp = 0
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L2 tot  (Ordre slutt)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l2tot       begsr
      *
      *
      * NB !  Her er det viktig å være klar over følgende :
      *       Feltene for salg / rabatt / og kost blir ikke
      *       hentet fra ordrehode som tidligere, da det er
      *       behov for å splitte opp på avg fritt/pliktig
      *       både på salg, alle rabatter og på kost.
      *
      * Legger til mva på totalen
      *
     c                   eval      w2fsum = w2salp
     c                   eval      w2fsum = w2fsum - w2rk1p
     c                   eval      w2fsum = w2fsum - w2rk2p
     c                   eval      w2fsum = w2fsum - w2rkop
     c                   eval      w2fsum = w2fsum - w2rb1p
     c                   eval      w2fsum = w2fsum - w2rb2p
      *
      * Sum Faktura (L6)
      *
     c                   eval      w6salp = w6salp + w2salp
     c                   eval      w6rk1p = w6rk1p + w2rk1p
     c                   eval      w6rk2p = w6rk2p + w2rk2p
     c                   eval      w6rb1p = w6rb1p + w2rb1p
     c                   eval      w6rb2p = w6rb2p + w2rb2p
     c                   eval      w6mvgp = w6mvgp + w2mvgp
     c                   eval      w6rkop = w6rkop + w2rkop
      *
      *  Legg ut sum for denne ordren
      *
8.05 c                   if        fonumm > 0
      *
     c                   eval      ffakiu_ksrt = fkssrt
     c                   eval      ffakiu_knum = fonumm
     c                   eval      ffakiu_ksuf = fosuff
     c     ffakiu_key    chain     ffakiu
     c                   if        not %found
8.04 c                   clear                   ffakiur
     c                   eval      fakfir = w_firm
     c                   eval      faksrt = fkssrt
     c                   eval      faknum = fonumm
     c                   eval      faksuf = fosuff
     c                   if        w2fsum > 0
     c                   eval      fakdot = footyp
     c                   else
     c                   eval      fakkot = footyp
     c                   endif
     c                   eval      faksum = w2fsum
     c                   time                    fakeda
     c                   time                    faketi
     c                   eval      fakeus = l_user
     c                   time                    fakoda
     c                   time                    fakoti
     c                   eval      fakous = l_user
     c                   write     ffakiur
     c                   endif
      *
8.07  * Prøver finne riktig ordrtype uansett hva som ligger på ordretypen.
      *
8.07 c                   if        vaokre = ' ' and
8.07 c                             w2fsum > 0
8.07 c                   eval      w_doty = footyp
8.07 c                   else
8.07 c     votyl1_key    chain     vot1l1r
8.07 c                   if        %found
8.07 c                   if        vaokre = ' '
8.07 c                   eval      w_koty = va1mot
8.07 c                   else
8.07 c                   eval      w_doty = va1mot
8.07 c                   endif
8.07 c                   else
8.07 c                   eval      w_koty = footyp
8.07 c                   endif
8.07 c                   endif
      *
8.07 c*                  if        w2fsum > 0
8.07 c*                  eval      w_doty = footyp
8.07 c*                  else
8.07 c*                  eval      w_koty = footyp
8.07 c*                  endif
      *
8.05 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L6 tot  (Faktura slutt)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l6tot       begsr
      *
      * Henter opp subrutine for gebyr
      *
8.02 c                   if        1 = 2
     c                   exsr      x_gebyr
8.02 c                   endif
      *
      * Oppdater fakturatotal
      * med akkumulerte gebyrer
      *
     c                   eval      w6salp = w6salp + w6geby
      *
      * Oppdater fakturatotal
      * med akkumulerte påslag
      *
     c                   eval      w6salp = w6salp + w6pasl
      *
      * Legger til mva på totalen
      *
     c                   eval      w6fsum = w6salp
     c                   eval      w6fsum = w6fsum - w6rk1p
     c                   eval      w6fsum = w6fsum - w6rk2p
     c                   eval      w6fsum = w6fsum - w6rkop
     c                   eval      w6fsum = w6fsum - w6rb1p
     c                   eval      w6fsum = w6fsum - w6rb2p
      *
     c                   if        fomkod = 0
     c                   eval      w6mvgp = w6mvgp + w6geby
     c                   endif
      *
      * Legg på akkumulert moms
      *
8.01 c**                 eval      w6fsum = w6fsum + w6moms
      *
      *  Legg ut total for ordren
8.06  *  Legg også ut riktig ordretype på totalen.
      *
8.06 c                   if        w_doty = *blanks or
8.06 c                             w_koty = *blanks
8.06  * Vi tror vi har faktura
8.06 c                   if        %trim(w_doty) <> *blanks
8.06 c                   eval      votyl1_otyp = w_doty
8.06 c     votyl1_key    chain     votyl1r
8.06 c                   if        %found
8.06 c     votyl1_key    chain     vot1l1r
8.06 c                   if        %found
8.06 c                   if        vaokre = *blanks
8.06 c                   eval      w_koty = va1mot
8.06 c                   else
8.06 c                   eval      w_koty = w_doty
8.06 c                   eval      w_doty = va1mot
8.06 c                   endif
8.06 c                   endif
8.06 c                   endif
8.06 c                   else
8.06  * Vi tror vi har kreditnota
8.06 c                   eval      votyl1_otyp = w_koty
8.06 c     votyl1_key    chain     votyl1r
8.06 c                   if        %found
8.06 c     votyl1_key    chain     vot1l1r
8.06 c                   if        %found
8.06 c                   if        vaokre = '-'
8.06 c                   eval      w_doty = va1mot
8.06 c                   else
8.06 c                   eval      w_doty = w_koty
8.06 c                   eval      w_koty = va1mot
8.06 c                   endif
8.06 c                   endif
8.06 c                   endif
8.06 c                   endif
8.06 c                   endif
      *
8.06 c*                  if        rk2fas = 0
     c                   eval      ffakiu_ksrt = fkssrt
     c                   eval      ffakiu_knum = 0
     c                   eval      ffakiu_ksuf = 0
     c     ffakiu_key    chain     ffakiu
     c                   if        not %found
8.04 c                   clear                   ffakiur
     c                   eval      fakfir = w_firm
     c                   eval      faksrt = fkssrt
     c                   eval      faknum = 0
     c                   eval      faksuf = 0
8.04 c                   if        w6fsum < 0
     c                   eval      fakkot = w_koty
8.04 c                   eval      fakdot = *blanks
8.04 c                   else
     c                   eval      fakdot = w_doty
8.04 c                   eval      fakkot = *blanks
8.04 c                   endif
     c                   eval      faksum = w6fsum
     c                   time                    fakeda
     c                   time                    faketi
     c                   eval      fakeus = l_user
     c                   time                    fakoda
     c                   time                    fakoti
     c                   eval      fakous = l_user
     c                   write     ffakiur
     c                   endif
8.06 c*                  endif
      *
8.04 c                   eval      w_doty = *blanks
8.04 c                   eval      w_koty = *blanks
      *
      * Sjekk hva som skal trekkes på faktura
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for blanking felter i vareregister
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_bvare       begsr
      *
     c                   eval      b_lvrva = *on
     c                   clear                   vvarl1r
     c                   eval      vvspny = 0
     c                   eval      vvspga = 0
     c                   eval      vvkmva = 0
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Beregninging av beløp
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_beregn      begsr
      *
     c                   eval      w_bels = 0
      *
     c                   if        fdlvre = 1
      *
      * tar utg.punkt i nobb-pris, mult med innkjøpsfaktor
      * eller det er nettopris fra betingelse
      *
     c                   if        fdbifa = 1 and
     c                             fdbntp <> 0
     c                   eval      w_bels = fdbntp
     c                   else
     c                   eval      w_bels = fdnopr * fdbifa
     c                   endif
      * mult med kostprisfaktor eller kostprisbeløp
     c                   if        fdpkfa = 1
     c                   eval(h)   w_bels = (w_bels * fdpkfa) + fdpkbe
     c                   else
     c                   eval      w_bels = w_bels * fdpkfa
     c                   endif
      * kostpris
     c                   eval      w_belk = w_bels
      * mult med salgprisfaktor eller salgsprisbeløp
     c                   eval      w_bels = w_bels * fdpsfa
      *
     c                   if        w_bels <> 0
     c                   eval      w_belo = w_bels * fdanta
     c                   endif
      * slutt lvr
     c                   else
      *
      * Opprinnelig beløp fra vareregister
      *
     c                   eval      w_oppr = fdoppr * fdanta
     c                   if        w_oppr > 999999999
     c                   eval(h)   w_belo = 999999999
     c                   else
     c                   eval(h)   w_belo = fdoppr * fdanta
     c                   endif
      *
     c                   endif
      *
      * Bruttobeløp og kostpris
      *
     c                   eval(h)   w_belb = fdsapr * fdanta
     c                   eval      w_kost = fdkopr * fdanta
      *
      * Linjerabatter
      *
     c                   eval(h)   w_rkr1 = (w_belb * fdrab1) / 100
     c                   eval      w_belw =  w_belb - w_rkr1
     c                   eval(h)   w_rkr2 = (w_belw * fdrab2) / 100
      *
      * Trekker ut linje rabatter
      *
     c                   eval      w_beln = fdsums - w_rkr1 - w_rkr2
      *
      * Varelinjens andel av ordrerabatt
      *
     c                   eval      w_rkro = 0
     c                   if        vvkord = 0
     c                   eval(h)   w_rkro = (w_beln * forabp) / 100
     c                   endif
      *
      * Almenningsrabatter
      *
     c                   eval      w_belx =  w_belw - w_rkr2 - w_rkro
     c                   eval(h)   w_brk1 = (w_belx * fdbrr1) / 100
      *
     c                   eval      w_bely =  w_belx - w_brk1
     c                   eval(h)   w_brk2 = (w_bely * fdbrr2) / 100
      *
      * Beregner riktig MVA-grunlag
      *
     c                   eval      w_mvag = w_belx
      *
      * Henter inn prosentsats på mva kode
      *
     c                   eval      w_mvap = 0
     c                   eval      w_mvat = 0
     c                   eval      w_mvaf = 0
      *
     c                   if        fdomva <> *blank
     c                   eval      w_stat =  *blank
     c                   eval      w_mvak =  fdomva
     c                   eval      w_dato =  l_fkda
      *
     c                   call      'RS205R'
     c                   parm                    w_stat
     c                   parm                    w_mvak
     c                   parm                    w_mvtx
     c                   parm                    w_dato
     c                   parm                    w_mvap
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
     c                   parm                    w_bpro
     c                   endif
      *
      * Sjekker om dette er en negativ ordre
      *
     c                   if        w_dbkr = 'K'
     c                   eval      fdanta = fdanta * -1
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   eval      w_beln = w_beln * -1
     c                   eval      w_belb = w_belb * -1
     c                   eval      w_belo = w_belo * -1
     c                   eval      w_kost = w_kost * -1
     c                   eval      w_rkro = w_rkro * -1
     c                   eval      w_rkr1 = w_rkr1 * -1
     c                   eval      w_rkr2 = w_rkr2 * -1
     c                   eval      w_brk1 = w_brk1 * -1
     c                   eval      w_brk2 = w_brk2 * -1
     c                   eval      w_mvag = w_mvag * -1
     c                   endif
      *
      * Sjekker om dette er en negativ linje
      *
     c                   if        valkre = '-'
     c                   eval      fdanta = fdanta * -1
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   eval      w_beln = w_beln * -1
     c                   eval      w_belb = w_belb * -1
     c                   eval      w_belo = w_belo * -1
     c                   eval      w_kost = w_kost * -1
     c                   eval      w_rkro = w_rkro * -1
     c                   eval      w_rkr1 = w_rkr1 * -1
     c                   eval      w_rkr2 = w_rkr2 * -1
     c                   eval      w_brk1 = w_brk1 * -1
     c                   eval      w_brk2 = w_brk2 * -1
     c                   eval      w_mvag = w_mvag * -1
     c                   endif
      *
      * Summer opp til brudd ordre
      *
     c                   eval      w2salp = w2salp + fdsums
     c                   eval      w2kstp = w2kstp + fdsumk
     c                   eval      w2rk1p = w2rk1p + w_rkr1
     c                   eval      w2rk2p = w2rk2p + w_rkr2
     c                   eval      w2rkop = w2rkop + w_rkro
     c                   eval      w2rb1p = w2rb1p + w_brk1
     c                   eval      w2rb2p = w2rb2p + w_brk2
      *
     c                   if        fdbrr1 > 0
     c                   eval      w2gr1p = w2gr1p + w_belx
     c                   endif
     c                   if        fdbrr2 > 0
     c                   eval      w2gr2p = w2gr2p + w_bely
     c                   endif
     c                   eval      w2mvgp = w2mvgp + w_mvag
      *
     c                   if        forabp <> 0
     c                   if        vvkord = 0
     c                   eval      w2rbgp = w2rbgp + w_beln
     c                   endif
     c                   endif
      *
     c                   eval      t_belp = w_belb
      *
      *  Sjekk om ordre eller vare avgiftsfritt
      *
     c     fomkod        cabeq     1             xtag20
     c     vvkmva        cabeq     1             xtag20
     c     w_mvap        cabeq     0             xtag20
      *
      *  Beregning av mva
      *
     c                   eval(h)   t_belp = t_belp +
     c                                      ((w_mvag * w_mvap) / 100)
      *
     c     xtag20        tag
      *
      * Akkumuler opp momsen
      *
     c                   eval      w_mgrl = w_belb - w_rkr1 - w_rkr2
     c                   eval      w_mgrl = w_mgrl - w_rkro
     c                   eval      w_moms = (w_mgrl * w_mvap) / 100
     c                   eval      w6moms = w6moms + w_moms
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Generering av gebyrer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_gebyr       begsr
      *
      *   Hvis kunde/kundeprosjekt har korttype = 4 skal det ikke legges til fakturagebyr
      *
     c                   eval      rukrl5_kkun = fokund
     c                   eval      rukrl5_kpro = fokpro
     c                   eval      rukrl5_ktyp = 4
     c     rukrl5_key    chain     rukrl5
     c                   if        not %found(rukrl5)
     c                   eval      rukrl5_kpro = *zero
     c     rukrl5_key    chain     rukrl5
     c                   endif
     c                   if        %found(rukrl5)
     c                   goto      nofgeb
     c                   endif
      *
      * Sjekk om fakturagebyr
      *
     c                   eval      fgebl2_otyp = fksoty
     c                   eval      fgebl2_kkat = rkkatg
     c                   eval      fgebl2_ftyp = fofaty
     c                   eval      fgebl2_type = 1
      *    1.                                             OT  -  KK  -  FT
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   eval      fgebl2_kkat = 00
      *    2.                                             OT  -  00  -  FT
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   eval      fgebl2_ftyp = 00
     c                   eval      fgebl2_kkat = rkkatg
      *    3.                                             OT  -  KK  -  00
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   eval      fgebl2_kkat = 00
      *    4.                                             OT  -  00  -  00
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   eval      fgebl2_otyp = *blank
     c                   eval      fgebl2_kkat = rkkatg
     c                   eval      fgebl2_ftyp = fofaty
      *    5.                                             bl  -  kk  -  FT
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   eval      fgebl2_kkat = 00
      *    6.                                             bl  -  00  -  FT
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   eval      fgebl2_ftyp = 00
     c                   eval      fgebl2_kkat = rkkatg
      *    7.                                             bl  -  kk  -  00
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   eval      fgebl2_kkat = 00
      *    8.                                             bl  -  00  -  00
     c     fgebl2_key    chain     fgebl2
     c                   if        not %found(fgebl2)
     c                   goto      nofgeb
     c                   endif
     c                   endif
     c                   endif
     c                   endif
     c                   endif
     c                   endif
     c                   endif
     c                   endif
      *
      * Hent opplysninger fra VARE-REGISTER
      *
     c                   eval      b_lvrva = *off
     c                   eval      vvarl1_vare = fgvare
     c     vvarl1_key    chain     vvarl1r
     c                   if        not %found
     c                   exsr      x_bvare
     c                   endif
      *
      * Henter opplysninger fra LINJE-TYPE-REGISTER
      *
     c                   eval      vltyl1_ltyp = fgltyp
     c     vltyl1_key    chain     vltyl1r
      *
      *
     c     nofgeb        tag
      *
      * Setter inn verdier for les av gebyr-records
      *
     c                   eval      fgebl1_otyp = fksoty
     c                   eval      fgebl1_kkat = rkkatg
     c                   eval      fgebl1_line = 0
     c     fgebl1_key    setll     fgebl1
      *
      * Leser gebyrer
      *
     c     gebyr1        tag
     c                   read      fgebl1                                 90
     c     *in90         cabeq     *on           gebyr9
     c     fgfirm        cabne     w_firm        gebyr9
     c     fgotyp        cabne     fgebl1_otyp   gebyr9
     c     fgkkat        cabne     fgebl1_kkat   gebyr9
      *
      * Hent opplysninger fra VARE-REGISTER
      *
     c                   eval      b_lvrva = *off
     c                   eval      vvarl1_vare = fgvare
     c     vvarl1_key    chain     vvarl1r
     c                   if        not %found
     c                   exsr      x_bvare
     c                   endif
      *
      * Henter opplysninger fra LINJE-TYPE-REGISTER
      *
     c                   eval      vltyl1_ltyp = fgltyp
     c     vltyl1_key    chain     vltyl1r
      *
      * Behandle gebyr legg ut linjer
      *
     c                   goto      gebyr1
      *
      * Dersom gebyr er en prosentsats
      * regnes denne ut og legges inn
      * i feltet for gebyr som kroner
      *
     c                   if        fgsats <> 0
     c                   eval(h)   fgbelp = (w_geby * fgsats) / 100
     c                   endif
      *
      * Sjekker om dette er en negativ ordre
      *
     c                   if        w_dbkr = 'K'
     c                   eval      w6geby = w6geby - fgbelp
     c                   else
     c                   eval      w6geby = w6geby + fgbelp
     c                   endif
      *
     csr   gebyr9        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Beregner evt. endring av forhåndsbetalt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     finn_forh     begsr
      *
     c                   eval      w_fosa = 0
     c                   eval      w_fosi = 0
      * finner beløp forhåndsbetalt
     c                   eval      sdepl1_numm = fonumm
     c                   eval      sdepl1_kund = fokund
     c                   eval      sdepl1_tell = 0
     c     sdepl1_key    chain     sdepl1
     c                   if        not %found(sdepl1)
     c                   leavesr
     c                   endif
      *
      * Kan være post fra NGN
      *
     c                   if        skdepo = 0 and
     c                             skdepb = 0 and
     c                             skdepp = 0 and
     c                             skfosa = 0 and
     c                             skfosi = 0
     c                   leavesr
     c                   endif
      *
      * Beregn ordretotal
     c                   eval      w_sumif = 0
     c                   eval      w_sumuf = 0
     c                   eval      w_sumim = 0
     c                   call      'FO704R '
     c                   parm                    w_firm
     c                   parm                    fonumm
     c                   parm                    fosuff
     c                   parm                    w_sumif
     c                   parm                    w_sumuf
      *
     c                   if        w_sumuf <> sktotu
     c                   eval      w_fosa = w_sumuf - sktotu
     c                   eval      w_fosi = w_sumif - skdepb
      *
     c                   eval      w_sums = 0
     c                   eval      fodtl1_numm = fonumm
     c                   eval      fodtl1_suff = fosuff
     c     fodtl1_key2   setll     fodtl1
     c     fodtl1_key2   reade     fodtl1
     c                   dow       not %eof(fodtl1)
     c                   eval      w_sums = w_sums + fdsums
      * henter mvasats
     c                   if        fdomva <> *blank
     c                   eval      w_stat =  *blank
     c                   eval      w_mvak =  fdomva
     c                   eval      w_dato =  l_fkda
      *
     c                   call      'RS205R'
     c                   parm                    w_stat
     c                   parm                    w_mvak
     c                   parm                    w_mvtx
     c                   parm                    w_dato
     c                   parm                    w_mvap
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
     c                   parm                    w_bpro
     c                   eval(h)   w_sumim = w_sumim + (fdsums * w_mvat)
     c                   else
     c                   eval      w_sumim = w_sumim + fdsums
     c                   endif
     c     fodtl1_key2   reade     fodtl1
     c                   enddo
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   *inzsr        begsr
      *
      * Nullstilling av felter som ikke kan redefineres
      *
     c                   eval      t_belp = 0
      *
     c                   eval      w_gebm = 0
     c                   eval      w_geby = 0
     c                   eval      w_geb0 = 0
     c                   eval      w_geb1 = 0
     c                   eval      w_geb2 = 0
     c                   eval      w_geb3 = 0
      *
     c                   eval      w2salp = 0
     c                   eval      w2kstp = 0
     c                   eval      w2rk1p = 0
     c                   eval      w2rk2p = 0
     c                   eval      w2rb1p = 0
     c                   eval      w2rb2p = 0
     c                   eval      w2rbgp = 0
     c                   eval      w2rkop = 0
     c                   eval      w2gr1p = 0
     c                   eval      w2gr2p = 0
     c                   eval      w2mvgp = 0
      *
     c                   eval      w6geby = 0
     c                   eval      w6pasl = 0
     c                   eval      w6salp = 0
     c                   eval      w6rk1p = 0
     c                   eval      w6rk2p = 0
     c                   eval      w6rkop = 0
     c                   eval      w6moms = 0
      *
     c                   eval      w_vare = *blank
      *
      * Key for file : KUNDE-REGISTER
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Key for file : VARE-REGISTER
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for file : STATUS-KODER
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for file : ORDRE-TYPE-REGISTER
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for file : LINJE-TYPE-REGISTER
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for file : GEBYR-REGISTER
      *
     c     fgebl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fgebl1_otyp
     c                   kfld                    fgebl1_kkat
     c                   kfld                    fgebl1_ftyp
     c                   kfld                    fgebl1_line
      *
      * Key for file : GEBYR-REGISTER
      *
     c     fgebl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fgebl2_otyp
     c                   kfld                    fgebl2_kkat
     c                   kfld                    fgebl2_ftyp
     c                   kfld                    fgebl2_type
      *
      * Key for file : ORDRE-HODE-REGISTER
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohel1_numm
     c                   kfld                    fohel1_suff
      *
      * Key for file : ORDRE-LINJE-REGISTER
      *
     c     fodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fodtl1_numm
     c                   kfld                    fodtl1_suff
     c                   kfld                    fodtl1_line
      *
      * Key for file : ORDRE-LINJE-REGISTER
      *
     c     fodtl1_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    fodtl1_numm
     c                   kfld                    fodtl1_suff
      *
      * Key for oppslag på depositum-fil
      *
     c     sdepl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sdepl1_numm
     c                   kfld                    sdepl1_kund
     c                   kfld                    sdepl1_tell
      *
      * Key for oppslag på kortregister
      *
     c     rukrl5_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rukrl5_ktyp
     c                   kfld                    rukrl5_kkun
     c                   kfld                    rukrl5_kpro
      *
      * Key for oppslag på kundeprosjekt
      *
     c     fkprl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fkprl1_kund
     c                   kfld                    fkprl1_kpro
      *
      * Key for oppslag på mva.-kode
      *
     c     vmval1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vmval1_mkod
      *
      * Key for file : BUTIKK-KODE-REGISTER
      *
     c     bstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag på depositum-fil
      *
     c     ffakiu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ffakiu_ksrt
     c                   kfld                    ffakiu_knum
     c                   kfld                    ffakiu_ksuf
8.03  *
8.03  * Key for file : KUNDE-REGISTER
8.03  *
8.03 c     rku2l1_key    klist
8.03 c                   kfld                    w_firm
8.03 c                   kfld                    rku2l1_2kun
      *
     c                   endsr
      *
