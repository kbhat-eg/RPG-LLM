# Documentation: Program LO642R (Åre-differanse liste)

## Overview

**Program Name:** LO642R  
**System:** ASLAGR  
**Purpose:**  
Generates a report ("Åre-differanse liste") listing order header records with a difference between calculated invoice totals and registered invoice amounts, exceeding a configurable threshold. The report is filtered by order types if specified, and includes detailed calculation of VAT (MVA) per order line.

---

## Business Context

This program is designed for financial control, specifically to identify discrepancies between expected and actual invoice totals for orders. It supports complex VAT calculation logic and allows filtering by specific order types. The program is typically run as part of end-of-period or audit routines.

---

## File Dependencies

- **lstsl1**: Status register (used for company-level or process-level status information)
- **lohel1**: Order header file (primary driver for report rows)
- **lodtlr**: Order detail/line file (used to sum invoice amounts and calculate VAT)
- **lo670p**: Output printer file (report output)

All files are keyed by company code (`w_firm`), and order header/detail files are further keyed by order number and suffix.

---

## Key Data Areas

- **LDA (Local Data Area):** Used to retrieve user, company, and name information at program start.
- **Input Parameters:**
  - `w_grns`: Difference threshold (orders with differences above this value are reported)
  - `w_otyp`: String of order types to include (up to 6 types, each 2 chars, optional)

---

## Main Logic Flow

### 1. Initialization (`*inzsr`)

- Reads input parameters (`w_grns`, `w_otyp`).
- Parses `w_otyp` into up to six separate order type filters (`w_oty1`–`w_oty6`).
- Sets a flag (`b_type`) if any order type filters are active.
- Loads company and user information from LDA.
- Retrieves status information from the status register (`lstsl1`).

### 2. Report Heading

- Writes the report heading (`a1hdr`) with threshold and company information.

### 3. Main Processing Loop

- Iterates through all order headers (`lohel1`) for the selected company.
- If order type filtering is active, skips orders not matching the specified types.
- For each qualifying order header:
  - Copies key header fields into work variables for the report.
  - Calls subroutine `hent_total` to calculate invoice totals, VAT, and difference.
  - If the absolute difference exceeds the threshold, writes a detail line (`d1det`) to the report.
  - Handles page overflow by reprinting the heading as needed.

### 4. Totals and End

- After all orders are processed, writes a total line (`t1tot`) to the report.
- Program ends gracefully.

---

## Key Subroutines

### hent_total

Calculates totals for an order:

- Initializes totals and difference variables.
- Reads all order lines (`lodtlr`) for the current order header.
- Sums invoice amounts (`ldsumi`), credited amounts (`ldsumr`).
- For each line, calls `kalk_mva` to calculate line-specific VAT, accumulating the result.
- Calculates:
  - Net amount (`d1nett`): sum of invoice - sum of credited
  - Invoice total (`d1totf`): header value unless it's a "free order" (`lomkod ≠ 0`), then uses net amount
  - VAT (`d1mvab`): sum of VAT from all lines
  - Line sum (`d1lsum`): net amount + VAT
  - Difference (`d1diff`): line sum - invoice total
- Accumulates the difference into the report total (`t1diff`).

### kalk_mva

Calculates VAT for a single order line:

- Resets VAT calculation variables.
- If a VAT code (`ldomva`) is present:
  - Prepares parameters and calls external program `RS205R` to retrieve VAT rate and related info (likely a company-standard VAT lookup).
  - If the VAT percentage (`w_mvap`) is not set by the external call, defaults to 1% (fallback).
  - Calculates VAT as: (invoice amount - credited amount) × VAT rate / 100.
- Returns VAT amount for the line.

---

## Notable Design Decisions and Conventions

- **Order Type Filtering:**  
  The program supports up to six order types, passed as a single string parameter and split using `%subst`. This allows flexible filtering without changing the program interface.

- **VAT Calculation:**  
  VAT is not calculated as a flat percentage, but is determined per order line via an external call (`RS205R`). This allows for complex, dynamic VAT rules (e.g., based on product, date, customer).

- **Free Orders Handling:**  
  For "free orders" (`lomkod ≠ 0`), the report uses the net amount instead of the registered invoice total, as per business rule (see change log 6.10).

- **Overflow Handling:**  
  The program checks for page overflow (`*in30`) after each detail line and reprints the heading as needed, ensuring report readability.

- **Change Log:**  
  The source includes a detailed change log, documenting business rule changes (e.g., VAT calculation, order type filtering).

- **Parameter Passing:**  
  Uses classic RPG parameter lists (`plist`) for input, and company-wide conventions for key lists (`klist`).

- **Localization:**  
  Variable and comment names are in Norwegian, reflecting the business domain and user base.

---

## External Dependencies

- **RS205R:**  
  External program called to retrieve VAT information based on code and date. This is a critical integration point for VAT logic and must be kept in sync with company VAT master data.

---

## Summary Table of Key Variables

| Variable      | Purpose                                    |
|---------------|--------------------------------------------|
| w_grns        | Difference threshold for reporting         |
| w_otyp        | String of order types to include           |
| w_oty1-6      | Individual order type filters              |
| b_type        | Order type filter active flag              |
| w_toti        | Sum of invoice amounts (order lines)       |
| w_totr        | Sum of credited amounts (order lines)      |
| w_mvab        | VAT amount for current line                |
| w_mvbb        | Total VAT for current order                |
| d1nett        | Net amount for order (invoice - credit)    |
| d1totf        | Registered invoice total (or net for free) |
| d1mvab        | Total VAT for order                        |
| d1lsum        | Net + VAT for order                        |
| d1diff        | Difference (line sum - invoice total)      |
| t1diff        | Accumulated total difference (report)      |

---

## Interactions

- **Reads:**  
  - Order header (`lohel1`)
  - Order detail (`lodtlr`)
  - Status register (`lstsl1`)
- **Writes:**  
  - Printer file (`lo670p`)
- **Calls:**  
  - VAT lookup (`RS205R`)

---

## Maintenance Notes

- Ensure `RS205R` remains compatible and up-to-date with VAT rules.
- Any changes to order header/detail file structures may require corresponding updates to this program.
- The threshold and order type parameters allow for flexible use; confirm with users on required formats.
- The program is written in fixed-format RPG IV, with heavy use of company conventions and Norwegian identifiers.

---

## Change History Highlights

- **6.10:** Free orders use net instead of gross for comparison.
- **7.01:** Added filtering on selected order types.
- **7.02:** VAT must be calculated per line, not as a flat percentage.

---

## Conclusion

LO642R is a specialized reporting tool for financial reconciliation of order invoicing, supporting complex VAT logic and flexible filtering. It is tightly integrated with company data and external VAT logic, and is a critical tool for audit and control processes.