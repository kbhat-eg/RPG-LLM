# RA121R – Activities Maintenance Program

## Overview

This program, `RA121R`, is part of the ASOKON system and is responsible for the maintenance of activity codes and their descriptions. It provides a subfile-driven user interface for displaying, creating, updating, copying, and deleting activities. The program is designed for interactive use, leveraging display files (workstn) and multiple physical files for activity master data.

## Main Business Logic

The core business domain here is the management of "activities" (likely codes and descriptions used elsewhere in the system). The program allows users to:

- View a paginated list of activities (subfile).
- Search/position by activity code or description.
- Create new activities.
- Edit, copy, or delete existing activities.
- Display detailed information about activities.

## File Relationships

- **Physical Files (all renamed from `ra21pfr`):**
  - `ra21l1`: Activity code keyed access.
  - `ra21l2`: Activity description keyed access.
  - `ra21lr`: Activity code keyed access for read-only.
  - `ra21lu`: Activity code keyed access for update.
- **Display File:**
  - `ra121d`: Main workstation file, includes subfile `b1sfl` with relative record number `w_srrn`.

## Key Data Structures

### Local Data Area (LDA) Usage

- `l_user`, `l_firm`, `l_fnav`: User, firm, and navigation info loaded from LDA at program start.

### Subfile Control

- `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Various counters and pointers for subfile paging and navigation.
- `w_seqe`: Determines whether positioning is by code or description.

### Flags

- `b_oppr`, `b_forn`, `b_anul`, `b_feil`: Boolean flags for UI state and flow control.

## Display File Screens/Records

- **B1SFL**: Subfile record for listing activities.
- **B2CTL**: Subfile control record.
- **B2CMD**: Command keys screen.
- **C1BLD**: Screen for entering a new activity key.
- **C1MSG**: Message screen if duplicate key is entered.
- **C2BLD**: Create/Edit/View details screen.
- **D1WIN**: Delete confirmation window.
- **K1WIN**: Copy confirmation window.

## Indicators

The program uses standard indicator conventions, e.g., `LR` to end the program, `10`/`11` for RollUp/RollDown, `12`/`13` for subfile display, `14` for subfile clear, `15` for subfile end, etc. Indicators `31-79` are reserved for error/warning messaging.

## Main Control Flow

### Initialization (`*inzsr`)

- Loads firm from LDA into `w_firm`.
- Positions database to the first activity for the firm.
- Initializes subfile by calling `crt_subfile`.

### Main Loop

1. **Display Command Screen (`b2cmd`)**
2. **Display Subfile (`dsp_subfile`)**
3. **Function Key Handling:**
   - Exit: `*inkc` or `*inkl`
   - Refresh: `*inke` (`forny`)
   - Create: `*inkf` (`xc1bld`)
   - RollUp: `*in10` (`crt_subfile`)
   - RollDown: `*in11` (`bck_subfile`)
   - Home: `*in21` (set cursor placement)
4. **Positioning:** If search fields are filled, call `posisjoner`.
5. **Subfile Processing:** Calls `subfile` subroutine for row-level actions.

### Subfile Row Actions

Within the `subfile` subroutine, for each subfile row, the following actions are handled based on the value of `b1valg`:

- `2`: Edit (calls `xc2bld`)
- `3`: Copy (calls `xk1win`)
- `4`: Delete (calls `xd1win`)
- `5`: View (calls `xc2bld` in view mode)

After each action, the subfile row is updated, and the process iterates.

## Subroutines

### forny

- Refreshes subfile based on current position (either activity code or description).
- Calls `clr_subfile` and `crt_subfile` to redraw the subfile.

### posisjoner

- Positions the database cursor based on user input in the search fields (either code or description).
- Clears and fills the subfile from the new position.
- Clears search fields after use.

### subfile

- Toggles cursor indicator for display.
- Iterates through subfile rows and processes user actions (edit, copy, delete, view).

### xc1bld (Create New Activity)

- Displays entry screen for new activity code.
- If code exists, shows message (`xc1msg`).
- On valid input, calls `xc2bld` for detail entry.

### xc1msg (Duplicate Key Message)

- Displays a message if the user attempts to create an activity code that already exists.

### xc2bld (Edit/Create/View Activity)

- Loads existing activity details if found.
- Updates or creates activity record based on user input.
- Updates user and timestamp fields.
- Handles both edit and view modes.

### xd1win (Delete Activity)

- Confirms deletion with the user.
- Deletes the activity record if confirmed.

### xk1win (Copy Activity)

- Loads source activity.
- Prompts for new activity code.
- Validates that the new code does not already exist.
- Calls `xc2bld` to create the copy.

### clr_subfile

- Clears the subfile and resets subfile counters/indicators.

### crt_subfile

- Fills the subfile page with records from current position.
- Handles both code and description orderings.

### bck_subfile

- Moves the subfile window one page backward.
- Repositions and refills the subfile.

### dsp_subfile

- Handles display logic for the subfile, toggling necessary indicators.

## Design Patterns & Conventions

- **Subfile Paging:** The program implements its own subfile paging logic, with explicit counters and navigation for forward and backward paging.
- **Function Key Routing:** Uses a `select`/`when` structure for function key handling, a common convention for interactive RPG.
- **Modular Subroutines:** Each user action (edit, copy, delete, view) is encapsulated in its own subroutine.
- **Indicator Usage:** Adheres to a strict indicator convention for UI state and messaging.
- **Physical File Renaming:** All physical files are renamed from a common base (`ra21pfr`) for clarity and separation of read/update access.

## Integration Points

- The program expects certain layouts and conventions for the activity master files (RA21L1, RA21L2, RA21LR, RA21LU).
- The display file (`RA121D`) must support the subfile and all control/detail screens described.
- The program interacts with the LDA to obtain firm/user context.

## Non-Obvious Details

- **Dual Key Positioning:** The ability to position the subfile either by activity code or description is handled through the `w_seqe` variable and dual file access paths.
- **Copy Functionality:** Copying an activity is a two-step process—first, the source is loaded, then the user provides a new key, which is validated before creation.
- **Subfile Refresh Logic:** After create/copy/edit/delete, flags (`b_forn`) are used to determine whether the subfile should be refreshed.
- **Error Messaging:** Uses indicators 31+ for field-level error messaging, with message screens for duplicate keys and other validation errors.

## Summary

`RA121R` is a robust, interactive RPG program for maintaining activity codes and descriptions, featuring subfile navigation, search/positioning, and full CRUD operations. It is designed for maintainability and user efficiency, with clear separation of concerns and adherence to established UI and indicator conventions. Integration with the rest of the system is primarily via physical files and the display file, with user/firm context provided via LDA.