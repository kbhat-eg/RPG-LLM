# Explanation of RPG Source Code: `RP604R`

This program, written in RPG/400 (ILE RPG), is a maintenance and inquiry window for a report file (`rprrPF`). It is part of an AS/400 (IBM i) application (system: ASOKON), and supports subfile maintenance with inquiry, add, update, and select functionality from a list. The user interface uses a display file with subfiles (windowed lists) and function keys for user navigation and actions.

## Program Structure Overview

- **Display:** Uses a display file (`rp604d`) with subfiles for presenting/selecting records.
- **Files:** Reads and updates two variants of the same physical file (`rprrPF`), one with numeric key (rap), one with alpha key (txt), and one for update.
- **Indicators:** Uses RPG indicators for control flow and UI control (F-keys, subfile handling).
- **Subfiles:** Subfile logic is used to present a paginated/selectable list.
- **Function Keys:** F3 (Exit), F5 (Refresh), F12 (Cancel), F10 (Roll), plus function for adding/changing records.
- **Initialization and Subroutines:** Program initialization, main processing, and screen logic are structured as subroutines (BEGSR/ENDSR).

---

## File Declarations

```rpgle
Frprrl1    IF   E           K DISK
F                                     RENAME(rprrpfr:rprrl1r)
Frprrl2    IF   E           K DISK
F                                     RENAME(rprrpfr:rprrl2r)
Frprrlu    UF A E           K DISK
F                                     RENAME(rprrpfr:rprrlur)
Frp604d    CF   E             WORKSTN
F                                     SFILE(B1WSF:SRRN01)
```

- `rprrPF` is opened three times:
  - `rprrl1` for numeric key access and read.
  - `rprrl2` for alphabetic key access and read.
  - `rprrlu` for update access.
- `rp604d` is the display file, with a subfile named `B1WSF`, record number controlled by `SRRN01`.

---

## Data Definitions

- Constants, arrays, working variables, and local data area definitions.
- Example working fields:
  - `pafirm`: Company number (3 chars).
  - `wwrap`, `wwrapx`: Work copies of numeric and alpha keys.
  - `w_tilgko`, `w_rutine`, `w_adv`, `w_status`: Used for authorization checking.

---

## Indicator Usage

- **KC (F3):** Exit program
- **KE (F5):** Refresh (re-read)
- **KL (F12):** Cancel
- **10, 12, etc.:** UI navigation, subfile handling, and error messaging.
- Grouped indicators for file, subroutine, and working purposes.

---

## Main Logic Flow

- **Initialization (`*INZSR` Subroutine):**  
  - Sets variables and keys to zero/blank.
  - Loads parameters, initializes key fields, and sets file position for reading.
  - Builds the subfile (`EXSR XCRT01`).

- **Main Tag Loop (`B2TAGA` / `B2TAGB`):**
  - Positions window, sends command prompt.
  - Calls display routine for subfile.
  - Handles function keys and user actions.
  - Handles add/change/report logic including a security check via `AD005R`.

- **F5 (Refresh):**
  - Sets file position according to current page/record.
  - Clears and rebuilds the subfile.

- **Add/Change Report (F6 logic):**
  - Checks authorization via `AD005R` call.
  - If authorized, calls maintenance program `RP200R` and refreshes list.

- **Roll (F10):**
  - Pages through subfile.

- **Positioning:**
  - By numeric key or alpha key (depending on user input).
  - Rebuilds and repositions subfile.

- **Subfile Handling Loop**
  - Reads changed records in subfile.
  - If "1" (select) entered, sets up return variables and exits back to caller.

---

## Subroutines

- **XCLR01** (Clear Subfile):  
  - Writes a clear command to the subfile control record (`B2WCT`).
  - Resets subfile record number counters.
- **XCRT01** (Create/Load Subfile):  
  - Adds records to the subfile up to a page limit.
  - Handles numeric or alpha key-based reading.
  - Only selectable, non-blank records loaded.
- **XDSP01** (Display Subfile):  
  - Controls display indicators and executes the EXFMT operation (reads from display file, waits for user input).

---

## Parameter Handling

- Sets up `PLIST` for 3 parameters passed in:
  - `pafirm` (Company/firm).
  - `wwrap` (key value).
  - `parapx` (alpha key value).
- Loads/positions file accordingly.

---

## Key Data Structures

- **Subfile Record Numbers:**
  - `SRRNnn`, `SSRNnn`, `SFRNnn`, `SVRNnn`, `SPGEnn`: Used to track current, first, last, visible, and page size records in subfiles.
- **Window Position:**
  - `WACTLI`, `WACTPO`: Used to control the window position for the display file.

---

## Comments and Field Explanations

- Extensive in-source Norwegian comments explain each data field, window/subfile, and indicator purpose.
- Lists display file record names and their purposes for windows/subfiles.

---

## Summary

- The program creates a windowed inquiry/maintenance list over a report file, supporting selection, add, and update.
- Handles both numeric and alpha key searches.
- Uses subfiles for efficient list display and paging.
- Integrates security via a separate external call (`AD005R`).
- Well-commented to explain field, indicator, and file usage, making it relatively easy to maintain and extend.

---

### Onboarding Tips

- **Files to Know:** `rprrPF` (physical), `rp604d` (display).
- **Screen Flow:** Driven by tags and `GOTO` statements; flow control makes heavy use of subroutines.
- **Indicators:** Central to how screens and file operations are handled, check the indicator mapping in comments.
- **Key Logic:** Numeric vs. alpha access makes use of different keys and file accesses (`rprrl1`, `rprrl2`).
- **Adding Functionality:** Observe how user requests are processed through tags, indicators, and subroutines (`EXSR`).

---

### Example: Subfile Page Load

```rpgle
C     XCRT01        BEGSR
C                   move      *off          *in15
C                   ADD       7             SPGE01
C                   Z-ADD     SSRN01        SRRN01

C     SRRN01        DOUEQ     SPGE01
C     WSEQEN        IFEQ      ' '
C                   READ      rprrl1                                 15
C                   ELSE
C                   READ      rprrl2                                 15
C                   END
C                   // ... (add one page of records to subfile)
C                   ENDDO
C     XEND01        TAG
```

- Loads up to 7 new records to the subfile, depending on search mode (numeric/alphabetic).

---

## Final Note

This code is a good reference for classical subfile programming and windowed maintenance in RPG III/IV. If you are new to subfile programming or green-screen maintenance, reviewing IBM manuals or modern RPG books on subfiles and indicators will help clarify some of the legacy features used here.