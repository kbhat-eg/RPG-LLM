# RPG Source Code Explanation: RF413R (Kontoplan, kopiering)

This program is written in ILE RPG (RPG IV) and is used for copying a chart of accounts (“kontoplan”) from one company to another. The code is well-documented with comments (some in Norwegian), referencing its purpose, versioning, and indicator usage. Below is a breakdown of the important sections and logic.

---

## 1. Header and Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `option(*nodebugio)`: Disables *DEBUG I/O*, making debugging input/output fields easier.
- `datedit(*dmy)`: Dates are in Day-Month-Year format.

The comments in the header give:
- System, program, and description information.
- Change history (e.g., "V6.10 210909" adds tracking fields).

---

## 2. File Declarations

```rpg
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
frhovlu    uf a e           k disk    rename(rhovpfr:rhovlur)
frf413d    cf   e             workstn
```
- Declares files for input/output operations.
    - `fafirl1`, `frhovl1`: Input files (disk), keyed access, external format, renamed record formats.
    - `frhovlu`: Update file (UF), allows add/update/delete, external format, renamed.
    - `frf413d`: Workstation file for display (screen).

---

## 3. Data Declarations

```rpg
d                uds
d l_user                911    920
d l_sbib                934    943
d l_firm                         3  0
d l_navn                951    980

d w_ffir          s              3  0
d w_tfir          s              3  0
d w_in03          s              1  0
d w_user          s                   like(l_user)
```
- `l_*` variables: Loaded from a User Data Structure (UDS) for user, subsidiary, company number, and name.
- `w_*`: Work variables for source/target company (`ffir`, `tfir`), functions, user, etc.

---

## 4. Main Control Flow

### Program Start

```rpg
c     dummy         tag
```
A label for potential entry point or organizing code.

### Main Display & Exit Logic

```rpg
c     a1taga        tag
c     exfmt     a1bld         // Show main display
```
- Displays the main screen (`a1bld` format on display file).

**Exit Check**
```rpg
c                   if        *inkc = *on or *inkl = *on
c                   eval      w_in03 = 1
c                   goto      slutt
c                   endif
```
- If indicator KC (F3=Exit) or KL is on, set `w_in03` to 1, go to `slutt` (end).

**Copy Logic**
```rpg
c                   exsr      subhov
```
- Calls subroutine `subhov` to perform the account copy.

---

## 5. Program End

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- `slutt`: Program end label.
- `*inlr = *on`: Closes all files, end of program.

---

## 6. Subroutines

### subhov – Copy Chart of Accounts

```rpg
c     subhov        begsr

c     rhovl1_key    setll     rhovl1                                 60
c     rhovl1_key    reade     rhovl1                                 60
c                   dow       *in60 = *off
    // (Copy and timestamp fields, then write)
c                   write     rhovlur
c     rhovl1_key    reade     rhovl1                                 60
c                   enddo
c                   endsr
```
- Reads all chart of accounts (`rhovl1`) for the source company.
- For each record:
    - Sets company field to target.
    - Sets user/timestamp fields.
    - Writes to update file (`rhovlur`) for the target company.
- Loops until all records are copied (`*IN60`=off).

### *inzsr – Program Initialization

```rpg
c     *inzsr        begsr
c                   eval      w_user = l_user
c                   eval      w_ffir = l_firm
c                   eval      a1ffir = l_firm
c                   eval      a1fnav = l_navn
c                   eval      w_in03 = *zero
```
- Initializes work variables from user data fields (source company info, user).
- Clears `w_in03`.

**Parameter List**
```rpg
c     *entry        plist
c                   parm                    w_in03
c                   parm                    w_tfir
```
- The program receives `w_in03` (function code) and `w_tfir` (target company).

**Read Company Name**
```rpg
c     aaffir = w_tfir
c     afirl1_key    chain     afirl1
c     a1tfir = w_tfir
c     if        %found
c     move      aafnav        a1tnav
c     endif
```
- Loads company name for the target company if it exists.

**Set Up Keys**
```rpg
c     afirl1_key    klist
c                   kfld                    w_tfir
c     rhovl1_key    klist
c                   kfld                    w_ffir
```
- Defines key lists for use in file access (source and target company).

---

## 7. Indicators

The indicator usage is well documented, with indicator numbers assigned to actions like exit, field protection, file chains, routine work, etc.

---

## 8. Summary

**What does this program do?**
- It displays a screen for the user to select a company or exit.
- If the user selects copying, it copies the chart of accounts from a source company (`w_ffir`) to a target company (`w_tfir`), creating new records with updated company, user, and timestamp fields.
- Parameters and data are initialized at program start.
- Standard RPG indicators and file handling techniques are used.

**Key business purpose:**
- Clone a company’s chart of accounts structure into another company, with audit/tracking fields.

**Techniques Illustrated:**
- Workstation (display) programming
- Keyed file processing
- Data structure overlays
- RPG indicators
- Use of subroutines

This program is typical of IBM i (AS/400, iSeries) batch/accounting utilities, with clear organization and documentation for maintainability.