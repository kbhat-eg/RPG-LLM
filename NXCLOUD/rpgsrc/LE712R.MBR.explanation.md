# ASLAGR: Lagertelling (Inventory Counting) â€“ Program LE712R

## Overview

This program, `LE712R`, is responsible for updating the inventory register (`LAGER-REGISTER`) based on entries in the historical inventory journal (`HISTORISK LAGERBOK`). The process is commonly referred to as "lagertelling" (inventory counting) and is critical for maintaining accurate stock balances after inventory transactions, including stocktakes.

The program reads records from the historical inventory journal, applies relevant transactions to the current inventory register, and updates both files accordingly. It is typically executed as part of a batch process after a stocktake or when reconciling inventory.

---

## File Definitions

- **vhislu** (`vhislur`): Historical Inventory Journal  
  - Renamed from `vhispfr` to `vhislur` for local usage.
  - Holds all inventory movements, including stocktakes and adjustments.

- **vlaglu** (`vlaglur`): Inventory Register  
  - Renamed from `vlagpfr` to `vlaglur`.
  - Holds current inventory balances per item and warehouse.

Both files are accessed in update mode (`uf`), keyed, and externally described.

---

## Local Data Area

- `l_user` (positions 911-920): User ID for audit/sporingsinformasjon.
- `l_firm` (positions 944-946): Firm number.

---

## Key and Parameter Variables

- Key fields and parameters are defined for both files, using LIKE to ensure type consistency.
- `p_dato`, `p_time`, `p_vare`, `p_lage`: Input parameters (date, time, item, warehouse).
- `w_firm`: Working firm number, initialized from LDA.

---

## Program Flow

### Initialization (`*inzsr`)

- Builds key lists for both files.
- Accepts parameters from the calling program: date, time, item, warehouse.
- Initializes key fields and working firm number.

### Main Processing Loop

1. **Set File Position**  
   - Uses `setll` to position on the first relevant record in `vhislur` (historical journal) using the built key.

2. **Main Loop (`start` tag):**
   - Reads the next record from `vhislur`.
   - If EOF, program ends.

3. **Filtering Logic:**
   - **Firm number check:** Skips records not matching the current firm.
   - **Item number check:** Skips records not matching the current item.
   - **Warehouse check:** Skips records not matching the current warehouse.

   These checks ensure only relevant transactions are processed.

4. **Update Inventory Register (`vlaglur`):**
   - Sets up keys for `vlaglur` and retrieves the register record.
   - For non-stocktake transactions (`vhkode <> 'T'`), applies the quantity (`vhanta`) to the register fields:
     - If transaction type (`vhtype`) is 'U' (likely "outgoing"), subtracts quantity.
     - Else, adds quantity.
   - Updates audit fields (`vledat`, `vletim`, `vleusr`) with current date, time, and user.
   - Updates the record in `vlaglur`.

5. **Update Historical Journal (`vhislur`):**
   - Updates the on-hand quantity (`vhbehl`) in the journal to match the register.
   - Updates audit fields (`vhedat`, `vhetim`, `vheusr`).
   - Updates the record in `vhislur`.

6. **Loop Continuation:**
   - Returns to the top of the loop to process the next historical record.

### Program Termination (`end_pgm` tag)

- Sets LR indicator to `*on` and returns.

---

## Business and Domain-Specific Logic

- **Stocktake Handling:**  
  Transactions with `vhkode = 'T'` (likely representing stocktake/counting) are excluded from updating the register. Only transactions after the stocktake (i.e., adjustments, receipts, issues) are considered.

- **Transaction Type (`vhtype`):**  
  - 'U': Outgoing transaction (e.g., sales, consumption).
  - Others: Incoming transaction (e.g., purchase, production).
  The sign of the quantity update depends on this field.

- **Audit Trail:**  
  The program updates user and timestamp fields on both the inventory register and the historical journal for traceability, as per the update noted in version 6.10.

- **Parameterization:**  
  The program is designed to be called with parameters specifying the subset of records to process, making it suitable for batch or partial updates.

---

## Design Decisions and Conventions

- **Key Structure:**  
  Both files use compound keys including firm, warehouse, item, date, and time for precise record targeting.

- **Record Looping:**  
  Uses RPG's traditional cycle with tag/goto for looping, which is a legacy pattern but common in this codebase.

- **Error Handling:**  
  Minimal explicit error handling; records not matching criteria are skipped, and missing register records are not created (only updated if found).

- **Field Naming:**  
  - Prefixes: `vh` for historical journal, `vl` for inventory register.
  - Suffixes: `behl` (balance), `tell` (count), `anta` (quantity), `kode` (code), `type` (transaction type).

- **Versioning and Documentation:**  
  In-source version history and change logs are maintained at the top of the program.

---

## Interactions with Other Modules

- **Calling Program:**  
  Receives parameters from a previous program, typically a controlling batch job or inventory management module.

- **Data Dependencies:**  
  Relies on the integrity and availability of both the historical journal and inventory register files.

---

## Summary Table

| File         | Purpose                                | Key Fields                        |
|--------------|----------------------------------------|-----------------------------------|
| `vhislur`    | Historical Inventory Journal           | firm, warehouse, item, date, time |
| `vlaglur`    | Inventory Register                     | firm, item, warehouse             |

---

## Key Takeaways for New Developers

- This program is central to keeping the inventory register synchronized with historical movements, excluding stocktake transactions.
- Filtering is strict: only the specified firm, warehouse, and item are processed per run.
- All updates are audited with user and timestamp fields.
- The codebase uses legacy RPG patterns (cycle, tags, indicator-based I/O), and naming conventions are consistent across modules.
- If you need to extend or debug this program, ensure you understand the business rules around transaction types and the meaning of all key fields.

---

For further questions about transaction codes or integration points, consult the inventory management system's functional specifications or contact the business analyst responsible for warehouse operations.