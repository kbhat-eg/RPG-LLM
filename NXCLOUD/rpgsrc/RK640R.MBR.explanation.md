```markdown
# RPG Program Explanation: Customer Account Statement Parameters

This RPG/400 program is designed to collect and validate parameters from a user for generating customer account statements. It centers around a display file (workstation) screen where parameters are input, and performs comprehensive validation before proceeding.

---

## 1. **Program Overview & Purpose**

- **Title**: *Utskrift av kontoutdrag kunder - parameter* (Printout of customer account statement - parameters)
- **Main Functions**:
  - Prompt the user for various selection parameters needed for a customer statement report.
  - Validate user input (dates, ranges, codes, etc.).
  - Support both range and explicit single-customer selections.
  - Supply the validated parameters to the calling/report program.

---

## 2. **Header and File Declarations**

```rpg
h datedit(*dmy) option(*nodebugio)
fausrl1    if   e           k disk
frk640d    cf   e             workstn
frkunlr    if   e           k disk    rename(rkunpfr:rkunlrr)
```
- **`h datedit(*dmy)`**: Default date format is day/month/year.
- **Files**:
    - `AUSRL1` (disk; user information)
    - `RK640D` (workstation; display file for parameter input)
    - `RKUNLR` (disk; customer master; renamed for local reference)

---

## 3. **Data Structure and Field Declarations**

- **Working variables**:
    - Numeric (e.g., `n`, `s`, `waar`, `wkun`, `wmnd`, etc.)
    - Parameter fields for passing to other programs (e.g., `p_in03`, `p_stat`, etc.)
    - Fields like `w_firm`, `w_user` used for user/session context.
    - Arrays for explicit customer selection (`kun(01)` ... `kun(10)`).

---

## 4. **Parameter Inclusion**

```rpg
d/COPY QCPYLESRC,RPARRKDS
```
- Fields or data structures from an external source are brought in (likely parameter definitions for the report).

---

## 5. **Indicator Usage Convention**

- The code comments describe indicator usages:
    - `KA/F1`, `KC/F3`: Firm selection, Exit.
    - `LR`: Last record, program exit.
    - `30`: Protect fields (view-only).
    - `31-59`: Various warnings/errors/field highlights.
    - `60-69`: File processing flags.
    - `70-99`: Work flags and subroutine indicators.

---

## 6. **Initialization Routine (`*INZSR`)**

- **Purpose**: Set up program variables with default values and fetch user/firm context.
- Sets selection ranges to full by default (e.g., `a2pavf` = 0, `a2pavt` = 9999).
- Sets the default period as the previous month.
- Fetches the user's firm and department restrictions.
- Builds key lists for quick database access.

---

## 7. **Main Display/Processing Loop**

### a. **Screen Handling**
```rpg
exfmt a2bld
```
- Shows the parameter entry screen to the user.

### b. **Reset Field Indicators**
- All error/position indicators (`*IN31` ... `*IN48`) are reset to off.

### c. **Function Key Processing**
- **F3/Exit (`*INKC`)**: Sets return flag and jumps to program end.
- **F4/Prompt (`*INKD`)**: Invokes subroutine `spr_rut` for file-based prompts (code lookup), then returns to the input screen.

---

## 8. **Input Validation**

### a. **Date and Period Validation**
- Checks if the run date (`a2pkda`) is valid (if zero, uses the current date).
- Tests if entered dates are valid using built-in `test(d)`.

### b. **Accounting Year/Period Logic**
- Ensures from/to years and periods are in logical order and within valid ranges.
- Provides relevant screen error indications if validation fails.

### c. **Range and Code Validation**
- Departments: `a2pavf` <= `a2pavt`
- Customer category: `a2pkaf` <= `a2pkat`
- Salesperson: `a2psef` <= `a2pset`
- Customer numbers: `a2pknf` <= `a2pknt`
- Specific customer entries (up to 10 single customers): Each is checked for existence in the customer file.

### d. **Explicit Customer Selection**
- If individual customer numbers are entered, each is validated via a database lookup (`chain rkunlr`).
- On error (customer not found), sets error indicators and returns to screen.

### e. **Default Full Range**
- If no customer range or explicit customers are entered, the program selects all (`a2pknt=999999`).

### f. **Other Selection Checks**
- Validates options for currency, category, department, sorting order (alphabetic/numeric).
- Ensures only one of category/department/salesperson groupings are selected (sum levels).

---

## 9. **Parameter Assignment**

- After all validation, input values are copied into output parameter fields (e.g., `move a2pkda pdato`).

---

## 10. **Program Exit**

- When finished or on exit key, turns LR indicator on and exits.

---

## 11. **Subroutine: Prompt/Inquiry (`spr_rut`)**

- Handles F4 prompt logic.
- Based on the field (`w_afld`), calls various programs to lookup/validate codes:
    - Avdeling (department): `RA507R`
    - Kundekategori (customer category): `RA511R`
    - Selger (salesperson): `RA509R`
    - Kunde (customer): `RK500R`
- After each call, updates the input field with the selected/validated value and sets screen indicators for feedback.

---

## 12. **General Logic Flow**

1. **Initialize**: Set up variables and context.
2. **Display Input Screen**: Wait for user entry.
3. **Process Input**:
    - Function key handling (Exit, Prompt).
    - Validate all input fields (dates, codes, ranges).
    - On validation failure, show errors and return to input.
    - On success, copy fields to output parameters.
4. **Exit**: End program, return parameters.

---

## 13. **Key Takeaways for New Developers**

- **Interactive RPG**: This is traditional, display file-driven RPG, not free format. Input validation is mostly manual.
- **Indicator Usage**: Many fields on the display are controlled with numeric indicators (`*INxx`). Understand which indicators trigger which fields.
- **Database Integration**: File lookups (`chain`) are used to validate entries against master files.
- **Program Structure**: Uses tags and GOTOs for flow control (common in legacy RPG).
- **Subroutines**: Used for modularizing prompt/lookup logic and initialization.
- **Parameter Handling**: Final validated parameters are packed into variables, likely for use by a calling print/report program.

---

## 14. **Next Steps for Onboarding**

- **Check Display File (`RK640D`)**: Understand the fields and indicators on the screen.
- **Review Included Data Structure (`QCPYLESRC,RPARRKDS`)**: Know what parameters are being passed out.
- **Know the Lookup Programs**: Familiarize yourself with `RA507R`, `RA511R`, `RA509R`, and `RK500R` for how validation is done.
- **Error Handling**: Learn which indicators represent which errors for easier troubleshooting.

---

## 15. **References and Norwegian Info**

- Comments are in Norwegian, as are many of the variable/field names. You may need to coordinate with Norwegian-speaking staff or use translation for business rules.

---

**Summary:**  
This program is a classic RPG parameter validation screen for printing customer account statement reports, using full-screen I/O and rigorous field/range validation before handing control to the report generation logic.
```