# Program EM110R â€“ Bonus Details Maintenance

## Overview

This program, **EM110R**, is a maintenance application for managing "bonus details" within the ASOFAK system. It provides a subfile-driven user interface for viewing, creating, updating, copying, and deleting bonus detail records. The business logic is tailored to support hierarchical groupings (overgroup, main group, subgroup), various item and supplier attributes, and bonus types.

The program is structured as a classic display file RPG application, using subfiles for record presentation and interaction, and supports a range of function keys for navigation and CRUD operations. The code is annotated in Norwegian, with business and field names reflecting the domain.

---

## Key Functional Areas

### 1. **File Declarations and Record Formats**

- **Physical and Logical Files:**  
  Multiple files are declared, each with a specific purpose:
  - `embdi1`, `embdir`, `embdiu`: Variants of the bonus detail file for inquiry, reference, and update, respectively.
  - `vogrl1`, `vhgrl1`, `vugrl1`: Group hierarchy files (overgroup, main group, subgroup).
  - `rlevl1`: Supplier file.
  - `vvarl1`, `jvarl1`: Item master files.
  - `venhl1`: Unit of measure.
  - `vltpl1`: Delivery type.
  - `vbotl1`: Bonus type.

- **Display File:**  
  - `em110d` is the display file, with subfiles (`b1sfl`) and control records for screen management.

### 2. **Indicator Usage**

- The program uses classic RPG indicators for flow and UI control.  
  - 10: Rollup
  - 11: Rolldown
  - 12: Subfile display
  - 13: Subfile display control
  - 14: Subfile clear
  - 15: Subfile end
  - 21, 22: Cursor placement
  - 30: Field protection
  - 31-79: Error/warning indicators
  - 80-99: Work indicators

### 3. **Parameter Handling**

- The program receives a set of parameters (firm, groupings, item, unit, bonus type, date ranges, etc.) on entry, which drive data selection and screen initialization.
- These are mapped to local variables for subsequent processing.

### 4. **Main Control Flow**

- **Screen Loop:**  
  The main logic is a loop that alternates between:
  - Displaying the command screen (`b2cmd`)
  - Displaying the subfile contents (`dsp_subfile`)
  - Handling function key input for navigation, CRUD actions, and refreshing the subfile

- **Function Key Processing:**  
  Function keys trigger subroutines for:
  - Creating a new record (`xc1bld`)
  - Editing, copying, deleting, or viewing an existing record (via subfile row selection)
  - Rebuilding or refreshing the subfile (`forny`)
  - Exiting the program

### 5. **Subfile Management**

- **Subfile Population:**  
  - `crt_subfile` reads eligible records from the bonus detail file and populates the subfile, applying selection criteria based on the input parameters.
  - Pagination is managed using counters (`w_srrn`, `w_spge`, etc.).
  - The subfile records include selection fields for user actions (edit, copy, delete, view).

- **Subfile Clearing:**  
  - `clr_subfile` resets subfile indicators and counters.

- **Subfile Display:**  
  - `dsp_subfile` manages the display of the subfile or command screen, depending on whether records exist.

- **Subfile Processing:**  
  - `subfile` scans the subfile for user-selected actions and dispatches to the appropriate CRUD subroutines.

### 6. **CRUD Operations**

- **Create (`xc1bld`):**
  - Presents the user with a blank input screen.
  - Validates input and checks for duplicates.
  - Calls the maintenance subroutine (`xc2bld`) to actually create the record.

- **Edit/View (`xc2bld`):**
  - Loads the selected record (or blank for new).
  - Presents the detail screen for edit or view (fields protected in view mode).
  - Validates required fields.
  - Updates or inserts the record as appropriate using the update file (`embdiu`).

- **Copy (`xk1win`):**
  - Loads the source record.
  - Prompts for new key values.
  - Validates that the new key does not already exist.
  - Calls the maintenance subroutine to create the new record.

- **Delete (`xd1win`):**
  - Loads the selected record.
  - Confirms the delete action.
  - Deletes the record from the update file.

- **Messaging (`xc1msg`):**
  - Used to display messages, especially for duplicate key errors during creation.

### 7. **Business Logic and Domain-Specific Features**

- **Group Hierarchy Resolution:**
  - On initialization, the program resolves group names/descriptions for overgroup, main group, and subgroup based on the input parameters, using the respective files.
  - Similarly, it resolves supplier, module, item, unit, delivery type, and bonus type descriptions for screen display.

- **Record Key Structure:**
  - The bonus detail records are keyed on a composite of firm, bonus type, bonus number, groupings, item, unit, delivery type, and date range, plus the bonus-from/to fields.
  - Key lists (`klist`) are defined for each file access pattern.

- **Indicator and Status Management:**
  - Flags (`b_feil`, `b_forn`, `b_oppr`, `b_anul`, `b_subf`) are used to track error, refresh, create, cancel, and subfile action states.

- **Display Feedback:**
  - The information data structure (`dspfbk`) is used to track the current subfile record for cursor management.

- **Date/Time Handling:**
  - Date and time fields are populated using the RPG `time` operation.
  - Date validation and formatting are handled as needed for the business logic.

- **Field Protection:**  
  - When viewing records (not editing), fields are protected from input.

### 8. **Integration Points**

- **External Program Call:**
  - For module description lookup, the program calls `FO714C` with the firm and module number.

- **File Relationships:**
  - The program relies on a consistent structure and naming across the bonus detail and reference files, with renames used to distinguish between inquiry, reference, and update access.

---

## Design Patterns and Conventions

- **Subfile-Driven UI:**  
  The core interaction is via subfiles, a standard pattern for RPG maintenance programs but implemented with careful management of indicators, counters, and paging.

- **Modular Subroutines:**  
  Each major function (CRUD, display, subfile operations) is encapsulated in a subroutine, improving readability and maintainability.

- **Key List Abstraction:**  
  File access is abstracted via named key lists, supporting reuse and clarity in database operations.

- **Domain Naming:**  
  Field and variable names closely follow the business domain, which may require orientation for new developers.

- **Indicator Management:**  
  The program uses indicators both for UI control and business state, with explicit comments outlining their purpose.

---

## Noteworthy Aspects

- **Multi-Level Keying:**  
  The bonus detail records are highly normalized and keyed on a wide set of attributes, reflecting complex business rules for bonus eligibility and application.

- **Dynamic Screen Content:**  
  The display is dynamically populated with related data (group, item, supplier names) for user context.

- **Soft Error Handling:**  
  User errors (e.g., duplicate keys, invalid input) are handled via screen indicators and message subroutines, rather than program exceptions.

- **Legacy RPG Techniques:**  
  The program is written in fixed-format RPG IV, using classic operation codes and indicator-based logic, consistent with established IBM i application standards.

---

## Interactions with Other Modules

- **Data Files:**  
  The program interacts with a variety of master and reference files (group, item, supplier, etc.), reflecting tight integration with the core ERP data model.

- **External Program:**  
  The only explicit external call is to `FO714C` for module information.

---

## Summary

**EM110R** is a robust, subfile-based maintenance program for bonus details, with comprehensive support for hierarchical groupings, item and supplier attributes, and bonus types. Its design reflects both the complexity of the business domain and the conventions of legacy RPG applications on IBM i. New developers should pay particular attention to the use of indicators, key lists, and the mapping between screen actions and subroutines, as well as familiarize themselves with the underlying data model and file relationships.