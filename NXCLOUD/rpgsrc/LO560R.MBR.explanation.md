# RPG Program LO560R - Explanation

This RPG program is a classic ILE RPG/400 application designed to allow users to search for purchase orders via supplier. The program leverages subfiles for interactive display and navigation of order records.

Let's break down the core components:

---

## **Header & Metadata**

```rpg
     h option(*nodebugio) datedit(*dmy)
```

- `option(*nodebugio)` disables debugger for IO operations, optimizing performance.
- `datedit(*dmy)` sets the default date format to day-month-year.

### **Program Documentation**
*The comments at the beginning describe:*
- System (ASLAGR)
- Program name (LO560R)
- Purpose (Search order via supplier)
- Indicators usage (see details below for specific indicators' roles)
- Change history

---

## **Files**

```rpg
     flohelk    if   e           k disk    rename(lohepfr:lohelkr)
     flo560d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- **LOHELK**: Database file (disk), keyed, renamed for local usage.
- **LO560D**: Display file (workstn), with subfile `b1sfl` using relative record number `w_srrn`.

---

## **Data Definitions**

### **Parameter Variables**

```rpg
     d p_firm          s                   like(lofirm)
     d p_ldor          s                   like(loldor)
     d p_numm          s                   like(lonumm)
     d p_suff          s                   like(losuff)
```

- Parameters received by the program, matching fields from the database.

### **Key Variables**

```rpg
     d lohelk_ldor     s                   like(loldor)
```

- Used for building keys to access supplier records.

### **Work Variables**

```rpg
     d w_stel          s              4  0
     d w_spge          s              4  0
     d w_srrn          s              4  0
     d w_sfrn          s                   like(w_srrn)
     d w_ssrn          s                   like(w_srrn)
     d w_seqe          s              1
     d b_eof           s              1    inz(*off)
     d b_valg_ok       s              1    inz(*off)
     d w_firm          s                   like(lofirm)
     d c_sfil          s              2  0 inz(10)
```

- Variables for subfile control, status flags, and session state.

### **Subfile/Screen Field Explanations**

- **w_stel**: Subfile counter
- **w_spge**: Page size in subfile
- **w_srrn**: Relative record number in subfile
- **w_sfrn / w_ssrn**: First / last record numbers displayed on the page
- **w_curn**: Currently focused record
- **w_virn**: For tracking display position

### **Screen Layouts**

- **B1SFL**: Subfile record format
- **B2CTL**: Subfile control record format
- **B2CMD**: Command screen image

---

## **Mainline Logic (Control Flow)**

The program uses RPG's tag and goto for flow control (typical in this code style).

### **Initialization**

- The *INZSR subroutine runs at program start to:
  - Retrieve parameters
  - Initialize screen & state
  - Position database and fill subfile

### **Main Processing Loop**

- Tags (`b2taga`, `b2tagb`) mark phases:
  - Show command screen (`write b2cmd`)
  - Display subfile (`exsr dsp_subfile`)
- Processes function keys using `select/when`:
  - **Roll/rolldown (page navigation)**
  - **F12/ESC = Exit** (goto avslutt)
  - **F5 = Refresh** (calls `forny` to renew subfile)
  - **Page forward (F10)** (`crt_subfile`)
  - **Home-key (IN21)** (moves cursor, resets to top)
- After function key handling, calls `exsr subfile` to allow row selection or further navigation.

#### **Exiting**
- Tag `avslutt` sets LR on and returns, ending program cleanly.

---

## **Subroutines**

### `forny` (Renew Subfile)
- If not on first record, chains to current subfile entry.
- Resets key and database position.
- Clears and refills the subfile with relevant records.

### `subfile` (Process Subfile Entries)
- Toggles cursor indicator.
- If a "current record" is set, updates position.
- Reads all visible subfile records (`readc b1sfl` in a loop) and:
  - Checks for special selection (if user marked a row with certain values, e.g., 1 or 5).
    - `1`: Selects current record, marks `b_valg_ok` to signal selection
    - `5`: Calls another program (`LO505R`) for further processing, passing selected keys.

### `clr_subfile` (Clear Subfile)
- Triggers subfile clear, resets indicators and counters.

### `crt_subfile` (Create/Fill Subfile)
- Increases page size (`w_spge`)
- Reads next set of records from the database (`reade lohelk`)
- Populates subfile screen variables and writes them to the subfile
- Sets end page/record markers

### `dsp_subfile` (Display Subfile)
- If records exist, signals to display the subfile; otherwise, shows command screen.
- Uses indicators to control field protection, subfile and record display modes.

### `*INZSR` (Initialization Subroutine)
- Receives input parameters.
- Builds initial key.
- Fills subfile with first page of data for the supplier.

---

## **Indicators â€“ Usage Summary**

- **LR**: End of program
- **IN10, IN11, ...**: Function keys for navigation and actions
- **IN12, IN13, IN14, IN15**: Subfile display control
- **IN21, IN22**: Cursor and Home-key actions
- **IN30**: Protect fields on display
- **IN31-79**: Warnings and screen indicators
- **IN80-99**: Work indicators (general status)

---

## **High Level Operation**

1. **Initialization**: Receives firm/order info, positions to correct supplier.
2. **Display & Interaction**:
   - Fills/refreshes subfile (paged list of orders).
   - User can navigate, page, make selections or trigger other programs.
3. **Selection/Action**: Handles selections via screen field values (user input).
4. **Exit**: Ends gracefully on user request.

---

## **Summary**

This RPG program is a subfile-driven order inquiry screen, letting users quickly search, page, and select orders for a supplier. It manages a dynamic subfile (paginated list), processes function keys for navigation and actions, and allows integration with other programs on selection.

**Key learning points for onboarding:**
- Understand subfile management and indicators in classic RPG.
- Learn to follow flow via tag/goto and subroutines.
- Study how database keys and subfile page control variables interact.
- Note the role of work fields and parameter passing to/from display and called programs.