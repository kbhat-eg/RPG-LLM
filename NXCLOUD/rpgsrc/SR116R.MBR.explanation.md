# RPG Program Explanation: `sr116R` (ASSTAT System)
---

This program (`sr116R`) is written in OPM (Original Program Model) RPG/400 and is designed for managing a "subfile" interface for selecting and maintaining subgroups (`undergruppe`). It is typical in IBM i (AS/400) systems to build such interfaces for maintenance screens.

Below is a detailed walkthrough of the structure and functionality, focusing on key sections, files, variables, and subroutines.

---

## 1. **File Declarations**

```rpg
fsr116d    cf   e             workstn sfile(b1sfl:w_srrn)    // Workstation (Display file) with subfile "b1sfl"
fslpml1    if   e           k disk    rename(slpmpfr:slpml1r) // Physical file for subfile records
fslpmlr    if   e           k disk    rename(slpmpfr:slpmlrr)
fslpmlu    uf a e           k disk    rename(slpmpfr:slpmlur)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
```
- **Workstation File**: The main display screen, using subfile `b1sfl`.
- **Database Files**: Physical and logical files, possibly representing group data, subfile records, etc.

---

## 2. **Key & Working Variables**

### a. **Keys for Files**
```rpg
d slpml1_type     s                   like(srtype)
d slpml1_kode     s                   like(srkode)
...
d vugrl1_uogr     s                   like(vguogr)
d vugrl1_uhgr     s                   like(vguhgr)
d vugrl1_uugr     s                   like(vguugr)
```
- Variables for holding key fields when accessing or updating records in the files.

### b. **Counters and Flags**
```rpg
d w_spge          s              4  0    // Subfile page counter
d w_srrn          s              4  0    // Subfile relative record number
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
d w_seqe          s              1
d b_forn          s              1    inz(*off) // "Refresh" flag
d b_anul          s              1    inz(*off)
d b_feil          s              1    inz(*off) // Error flag
```
- Controls looping, subfile handling, and process flow.

### c. **Current Record Fields**
```rpg
d w_firm          s                   like(srfirm) // Firm/company number
d wptype          s                   like(srtype) // Type
d wpkode          s                   like(srkode) // Code
d wptext          s             30                 // Text (description)
...
```

### d. **Constants and Data Structures**
```rpg
d c_sfil          s              2  0 inz(12)              // Subfile page size

d wpvalg          ds
d  wpuogr                 1      2  0
d  wpuhgr                 3      4  0
d  wpuugr                 5      7  0
d  wpfyll                 8     15
```
- Used for record key construction and data movement.

---

## 3. **Local Data Area (LDA) Usage**

```rpg
d                uds
d dsuser                911    920
d dsfirm                944    946  0
d l_fnav                951    980
```
- Reads "firm/company number" and other information from the LDA.

---

## 4. **Main Program Logic**

### **A. Main Control Flow**

This code uses a basic loop with tags and GOTO statements (common in OPM RPG) to control application flow.

- **`b2taga` / `b2tagb`**: Tags representing various stages of the display logic.
- **Function Key Handling**: Tests for function key indicators (`*INKC`, `*INKL`, etc.) and performs actions: exit, refresh, create, etc.
- **Positioning**: If position fields are populated, calls `posisjoner` subroutine to position subfile to a requested value.
- **Subfile Control & Actions**: Handles requests to add/delete items via the `control` subroutine or via subfile processing.

Standard indicator usage:
- `*INKC` / `*INKL` : Exit keys (F3/F12)
- `*INKE`: Refresh (F5)
- `*INKF`: Create/Add entry (F6)
- `*IN10`: Add new entry
- `*IN21`: Some kind of toggle or action
- `*IN22`, `*IN12`, `*IN13`, `*IN14`, `*IN15`, etc.: Control various subfile and display mechanics

---

### **B. Subroutines (BEGSR / ENDSR)**

#### **1. `forny`: Refresh Subfile**
- Repositions file, clears and rebuilds subfile. Called after maintenance actions.

#### **2. `posisjoner`: Position to Key in Subfile**
- Moves entered subgroup values into subfile selection key, positions (`SETLL`) to that key in the database, clears and rebuilds the subfile.

#### **3. `control`: Handles Subfile Control Actions (Add, Delete, Validate)**
- Depending on the value entered (`b2valg`), determines if this is an add or delete request.
- Performs validation (e.g., checks for zero keys), and branches to appropriate subroutines, like `xc1bld` (add) or `xd1win` (delete).

#### **4. `subfile`: Handles Subfile I/O and Actions**
- Loops through subfile rows, handling actions (e.g. delete).
- If "4" (delete) is entered, calls delete logic.

#### **5. `xc1bld`: Add/Edit Subgroup Row**
- Presents "new row" screen, handles validation, checks if row exists using a keyed file read (`CHAIN`), and calls registration logic for new rows (`xc2bld`).

#### **6. `xc1msg`: Displays Message If Row Exists**
- If an attempt is made to add a row that already exists, presents an informational screen.

#### **7. `xc2bld`: Create/Update Logic**
- Handles the actual writing/updating of a subgroup row in the database.

#### **8. `xd1win`: Delete Row Logic**
- Presents delete confirmation, and deletes the row from the database if confirmed.

#### **9. `clr_subfile`: Clear the Subfile**
- Flags the subfile for clear/write (indicator *IN14), resets counters.

#### **10. `crt_subfile`: Fill the Subfile**
- Reads records from the database, populates the subfile buffer for display.

#### **11. `dsp_subfile`: Display Subfile**
- Handles drawing and refreshing the subfile window.

#### **12. `*INZSR`: Initialization**
- Builds all major keys, loads parameters, initializes program state, positions the file, populates initial subfile page.

---

## 5. **Key Notes and Patterns**

- **Subfile Handling**: Subfiles are a core IBM i user interface concept, allowing multiple rows to be displayed/edited in a table/grid form.
- **Database Updates**: This program processes add, edit, and delete operations by handling the database files directly.
- **Function Key Usage**: RPG function key logic is old-school, but very direct: indicators are set by the OS/400 runtime or display file.

---

## 6. **Typical Screen Flow**

1. Display list of subgroups in a subfile grid.
2. User can:
   - Exit (F3/F12)
   - Refresh (F5)
   - Add new (F6/F10)
   - Select a line for delete ("4") or update ("1").
3. Edits, Adds, Deletes trigger subroutines that read/update/write physical/logical files (`slpml1`, `slpmlu`, etc.)
4. After any changes, subfile is refreshed for the user.

---

## 7. **Variable Naming / Norwegian Terms**

- `utvalg` = selection
- `undergruppe` = subgroup
- `behandling` = processing/handling
- `slette` = delete
- `opprette` = create/add
- `bilde` = screen/picture

---

## 8. **Summary Table of Main Subroutines**

| Subroutine      | Purpose                                                   |
|-----------------|-----------------------------------------------------------|
| `forny`         | Refresh subfile                                           |
| `posisjoner`    | Position subfile to specific entry                        |
| `control`       | Main add/delete/validate routine                          |
| `subfile`       | Loop/process subfile rows (edits/deletes)                 |
| `xc1bld`        | Screen for add/edit subgroup                              |
| `xc1msg`        | Display "already exists" info message                     |
| `xc2bld`        | Add or update row in database                             |
| `xd1win`        | Delete logic (with confirmation)                          |
| `clr_subfile`   | Clear subfile                                             |
| `crt_subfile`   | Populate subfile                                          |
| `dsp_subfile`   | Display/refresh subfile                                   |
| `*INZSR`        | Initialization (run at program start)                     |

---

## 9. **General RPG/400 Programming Patterns Observed**

- **Tags and GOTOs**: Pre-RPG IV/ILE flow control style.
- **Indicators for Control**: Extensive use of numbered indicators (`*INxx`).
- **Manual Key Lists**: Used to access records in physical/logical files.
- **Subfile Paging**: Supports "paging" through subfiles using a page size constant (`c_sfil`).

---

## 10. **Onboarding Tips**

- **Understand the subfile mechanism**: How records are buffered, displayed, and updated.
- **Familiarize with the display file layouts**: (e.g. B1SFL, B2CTL) to relate fields to screen actions.
- **Know the function key indicators**: Critical for tracing logic paths.
- **Step through with a test user scenario**: Try add, delete, refresh, and positioning to see end-to-end data flow.
- **Map variables to database fields**: This will help debugging and future maintenance.

---

**In summary**: This program is a classic RPG/400 maintenance screen, handling a list of 'undergruppe' (subgroups) via a subfile, supporting add, edit, delete, and position functions. The logic is mainly handled in subroutines, using database file access and screen display logic typical of AS/400 applications. Understanding subfile mechanics, indicator usage, and database file access patterns is key for successful onboarding and maintenance.