# RPG Program Explanation: BU717R (ASSHOP System)

This RPG III/IV program (BU717R) is designed for the ASSHOP system and is responsible for exporting warehouse (lager) data from one file to another. The code is structured into logical blocks for file handling, parameter management, initialization, and main processing. Below, the code is broken down and explained step-by-step to ease onboarding for new developers.

---

## 1. Header and Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
* System. . . . . : ASSHOP
* Program . . . . : BU717R
* Beskrivelse . . : Butikk, eksport av lager
...
```

- **`h` specification**: Sets program options:
  - `*nodebugio` disables I/O debugging.
  - `datedit(*dmy)` sets date format to day-month-year.
- **Comments**: Describe the system, program name, and a brief functional description: "Shop, export of warehouse".
- **Change log**: Indicates the program was created (or last changed) on 2016-04-04 by "HKO".

---

## 2. File Definitions

```rpg
fra10l1    if   e           k disk    rename(ra10pfr:ra10l1r)
fbolgst    uf a e           k disk    rename(bolgst:bolgstr)
```

- **fra10l1**: Input file, keyed, external, referenced as `ra10l1r`.
- **bolgst**: Output file (update, add, external), referenced as `bolgstr`.

This setup means records are read from `ra10l1` and exported to `bolgstr`.

---

## 3. Parameter and Variable Definitions

```rpg
d p_firm          s                   like(rajfir)
d w_firm          s                   like(rajfir)
```

- **p_firm**: Program parameter for the company/firm value.
- **w_firm**: Working variable, same type as `rajfir` (probably the firm field from the record format).

---

## 4. Program Initialization

```rpg
* Initierer fil
c                   clear                   bolgstr
c                   eval      firm = w_firm
```

- **CLEAR bolgstr**: Initializes/clears the output buffer.
- **firm = w_firm**: Sets a field (firm) to the current firm value.

---

## 5. Main Processing Loop

### File Positioning and Record Processing

```rpg
c     ra10l1_key    setll     ra10l1
c     ra10l1_key    reade     ra10l1
c                   dow       %eof = *off
   ... process record ...
c                   write     bolgstr
c     ra10l1_key    reade     ra10l1
c                   enddo
```

- **SETLL/READE**: Position and read records from `ra10l1` using the composite key (`ra10l1_key`).
- **DOW loop**: Processes each record until end of file (`%eof`).

### Field Assignments

For each record:
```rpg
c                   eval      lage = rajkod
c                   eval      besk = rajtxt
c                   eval      adr1 = rajadr
c                   eval      adr2 = rajad2
c                   eval      ponr = *blank
c                   eval      sted = rajste
c                   eval      tlfn = rajtlf
c                   eval      tlfx = rajfax
c                   eval      avde = rajavd
c***                eval      eanl = rajean
c                   eval      odat = rajdat
c                   eval      edat = rajdat
c                   eval      etim = rajtim
c                   eval      eusr = rajusr
```

- **Moves values** from input record fields to corresponding output buffer fields.
- **ponr = *blank**: Clears the purchase order number field initially.
- **eanl = rajean**: (Commented out) Would assign EAN code if used.

#### Special: Purchase Order Number

```rpg
c                   if        rajpnr <> 0
c                   movel     rajpnr        ponr
c                   endif
```

- If `rajpnr` (purchase order number) is not zero, moves its value into `ponr`.

### Record Output

```rpg
c                   write     bolgstr
```

- Writes the prepared output buffer (`bolgstr`) to the output file.

---

## 6. Program Termination

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```

- **avslutt tag**: Marker for end logic.
- **`*inlr = *on`**: Closes files and ends program.
- **`return`**: Exits the program.

---

## 7. Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
* Parameter
c     *entry        plist
c                   parm                    p_firm
* Key for les p√• lager
c     ra10l1_key    klist
c                   kfld                    w_firm
* Henter firma fra parameter
c                   eval      w_firm = p_firm
c                   endsr
```

- **Parameter list**: Receives `p_firm` as the company/firm parameter from the caller.
- **Key list (`klist`)**: Sets up key structure for reading from `ra10l1` using `w_firm`.
- **Initialization**: Assigns the input parameter to the working variable (`w_firm`).

---

## 8. Summary

**What the program does:**

1. Receives a company/firm code as a parameter.
2. Sets up record keys and initializes variables.
3. Loops through input records in the `ra10l1` file for that firm.
4. For each record, populates the output record structure, with some data transformation (e.g., blanking or filling certain fields conditionally).
5. Writes the transformed record to the output file `bolgstr`.
6. Cleans up and exits.

**Key Concepts for New Developers:**

- Understand the record formats involved (`ra10l1` input, `bolgstr` output).
- The program is designed as a batch utility for exporting/transforming data per company.
- All processing is record-at-a-time due to RPG III/IV style.
- The initialization subroutine sets up all environment/context for the export.
- The program is modular and can be adapted/extended for additional fields or logic as needed.