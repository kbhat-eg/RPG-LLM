## Program Documentation: LI722R – Setter avsluttende statuser

### Overview

**Program Name:** LI722R  
**System:** ASLAGR  
**Description:**  
This program is responsible for setting final (avsluttende) statuses in the system, specifically for the “Mestergruppen” special version. Its main function is to update status and timestamp fields in control files at the end of a batch job or process.

---

### File Definitions

- **FJOBLU (fjoblur):**  
  Job register file, used to control and flag the status of ongoing EDI updates.  
  - Access: Update, keyed.
- **GEDGLU (gedglur):**  
  Automatic update control file, used to track the status and timestamp of automatic processes.  
  - Access: Update, keyed.

Both files are renamed on input for local naming conventions.

---

### Data Areas and Structures

- **LDA (Local Data Area):**  
  The program extracts the following from the LDA:
  - `l_user`: User identifier (positions 911–920)
  - `l_firm`: Firm number (positions 944–946)
  - `l_fnav`: Firm name (positions 951–980)

- **Parameter:**
  - `p_stat`: Input parameter (1 character), likely used to control or indicate the desired status.

- **Display Feedback Structure (`dspfbk`):**
  - `d_fcrn`: Display feedback field (positions 378–379), not actively used in the logic.

---

### Working Variables

- **b_forn:** Local flag, initialized to *off, not used in main logic.
- **w_firm:** Working variable for firm number, type matches `fajfir` (from FJOBLU).
- **w_stat:** Working variable for status.
- **w_date, w_time:** Date and time stamps, ISO formats.
- **w_year:** 4-digit year extracted from `w_date`.
- **w_jsta, w_onof:** Status and on/off flags, not actively used.
- **c_sfil:** Constant with value 10, not used in core logic.

---

### Main Processing Logic

#### 1. Update Automatic Update Status (`GEDGLU`)

- **Purpose:**  
  If an automatic update is in progress (status = 1), set the current date and time as the end timestamp and update the record.

- **Steps:**
  - Chain (keyed read) to `gedglur` using the firm number.
  - If found and `ggstat = 1`:
    - Set `ggsdat` (date) and `ggstid` (time) to current system values.
    - Write the changes back (update).
  - This marks the end of the automatic update for the given firm.

#### 2. Reset EDI Update Flag (`FJOBLU`)

- **Purpose:**  
  Turn off the “EDI update in progress” flag for the firm.

- **Steps:**
  - Chain to `fjoblur` using the firm number.
  - If found:
    - Set `fajb07` (EDI update flag) to 0 (off).
    - Write the changes back (update).
  - This ensures no process is marked as in progress after completion.

#### 3. Program Termination

- **Set LR Indicator:**  
  `*inlr = *on` signals program end and closes files.
- **Return:**  
  Exit the program.

---

### Initialization Subroutine (`*INZSR`)

- **Parameter Handling:**  
  - Entry parameter `p_stat` is received.
- **Key Lists:**  
  - `fjoblu_key` and `gedglu_key` are both set to use `w_firm` as the key field.
- **System Values:**  
  - Current date and time are captured into `w_date` and `w_time`.
  - Year is extracted from the date.
  - `w_firm` is set from `l_firm` in the LDA.

---

### Design Notes and Conventions

- **File Naming:**  
  Files are renamed on input to align with local naming conventions (`fjoblur`, `gedglur`).
- **LDA Usage:**  
  The program expects the firm number to be placed in the LDA prior to execution. This is a common pattern for programs run in a batch or controlled environment.
- **Key Handling:**  
  Both main files use the firm number as the key, ensuring all updates are scoped to the current firm.
- **Status Management:**  
  The program is designed to be idempotent and safe to run multiple times: it only updates records if relevant conditions are met (e.g., status = 1).
- **No Error Handling:**  
  There is no explicit error handling or logging; it is assumed that upstream processes ensure data integrity and program context.

---

### Interactions with Other Modules

- **Upstream:**  
  The LDA must be populated with the correct firm number before program execution. This is typically done by the job control or calling program.
- **Downstream:**  
  Other processes may check the `ggstat`, `ggsdat`, `ggstid` in `gedglur` and the `fajb07` in `fjoblur` to determine if an update is in progress or has completed.

---

### Business/Domain-Specific Logic

- **Automatic Update Completion:**  
  The program is part of the batch job closure process for the Mestergruppen customer. It marks the completion of automated data updates at the firm level.
- **EDI Update Control:**  
  Ensures that the EDI “in progress” flag is reset, allowing new EDI jobs to be safely started for the same firm.

---

### Summary

LI722R is a utility program that finalizes status and timestamp fields in key control files at the end of a batch process. It is tightly coupled to the batch job environment, relies on the LDA for context, and ensures data integrity for subsequent jobs by resetting status flags and recording completion times.