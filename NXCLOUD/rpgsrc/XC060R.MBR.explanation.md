# Program Overview

This RPG program (`XC060R`) is an interactive, display-based application designed for the ASCOMP system, specifically for "Compello Integrasjon, justering av feiltraner" (Compello integration, adjusting erroneous transactions). Its primary functions revolve around presenting, manipulating, and validating a set of records, likely accounting or invoice transactions, using subfiles for display and user interaction.

Most variable and comment text is in Norwegian, but the logic is general RPG/400 with subfile techniques, focusing on display and transaction file maintenance.

---

## File Definitions

- **Input/Update Files:**
  - `rcoml1` (COMPFR): Main transaction file, accessed with a key, renamed as `rcoml1r`.
  - `rcomlr` (COMPFR): Likely a secondary or log file, renamed as `rcomlrr`.
  - `rcomlu` (COMPFR): Update file for transactions, renamed as `rcomlur`.

- **Display File:**
  - `xc060d`: Display file with subfile support (`sfile(b1sfl:w_srrn)`), using data structure `dspfbk` for feedback.

---

## Data Definitions

- **User Data Area Fields:**  
  Variables like `l_user`, `l_asp`, `l_fgrp`, `l_firm`, `l_fnav` store data extracted from the Local Data Area (LDA) for user info, access group, company, etc.

- **Display Feedback (`dspfbk`):**  
  Structure to capture display responses from the workstation.

- **Key Fields:**  
  Variables holding key values for file access and positioning, such as `rcoml1_huid`, `rcomlr_huid`, `rcomlu_huid`.

- **Working Variables:**  
  `w_stel`, `w_spge`, `w_srrn`, etc. are used for subfile management (counters, pagination, etc.).  
  Many others (`w_kr`, `w_or`, `w_dmy`, etc.) are for data manipulation, formatting, and validation.

- **Constants:**  
  `c_sfil` is the page size for subfiles, set to 15.

---

## Indicator Usage

- **LR**: End of program.
- **Indicator numbers 10–99**: Various UI and process control flags.
  - 10: Page up
  - 11: Page down
  - 12–15: Subfile display/control
  - 21–22: Home/key, cursor placement
  - 30: Protect fields during display
  - 31–79: Error messages/field indicators
  - 80–99: Work indicators

---

## Screen Layouts (Screen Images)

- **B1SFL**: Subfile record
- **B2CTL**: Subfile control
- **B2CMD**: Command key screen
- **C1BLD**: New-key input for creation
- **C2BLD**: View/edit
- **D1WIN**: Delete window
- **K1WIN**: Copy window

---

## Main Logic Flow

### **Program Startup / Initialization (`*inzsr` subroutine):**
- Initializes key lists for DB file access.
- Retrieves values from LDA for context (firm, group, etc.).
- Positions DB pointer and prepares initial subfile contents by calling `crt_subfile`.

### **Main Processing Loop**
- **b2taga (tag):**  
  Writes command screen.
- **b2tagb (tag):**  
  Refreshes and displays the subfile (`exsr dsp_subfile`).
- **Function Key Handling (`select/when`)**:  
  - Exit/Cancel (`*inkc or *inkl`): Go to program end.
  - Renew (`*inke`): Refresh subfile.
  - Rollup/Rolldown (`*in10`, `*in11`): Page navigation.
  - Home (`*in21`): Set cursor placement.
  - If positioning criteria are entered, call the `posisjoner` subroutine.
- **End loop by returning to b2taga for next user interaction.**

### **Subfile Handling**
- **Display (`dsp_subfile`)**: Shows the subfile or command screen.
- **Page Forward (`crt_subfile`)**: Reads next set of records.
- **Page Back (`bck_subfile`)**: Reads previous set.
- **Row Processing (`subfile`)**:
  - Loops through subfile records for user-entered actions (edit, delete, view).
  - Calls corresponding subroutines for each action (edit: `xc2bld`, delete: `xd1win`).
  - Updates subfile as necessary.
  - Refreshes subfile if needed.

---

## Editing a Record (`xc2bld` subroutine)

- **Fetches the record** for display/update (using the key).
- **Populates display fields** with values from the record.
- **Highlights erroneous fields** if detected (using indicator lights).
- **Enters a display/update mode (`exfmt c2bld`)**:
  - If the mode is "view", certain fields are protected.
- **Validates input** (`exsr kontroll`). If errors occur, prepares error indicators.
- **Updates or writes the record** in the update file (`rcomlur`), reflecting input changes and corrections.

---

## Deleting a Record (`xd1win` subroutine)

- **Fetches the record** for confirmation.
- **Displays delete window** (`exfmt d1win`).
- **Deletes the record** from the update file upon confirmation.

---

## Supporting Subroutines

- **clr_subfile**: Clears all subfile entries and resets counters.
- **crt_subfile**: Reads records into the subfile up to the `c_sfil` page size, skipping non-relevant records as needed.
- **bck_subfile**: Handles paging backward in the subfile, then refills the subfile.
- **posisjoner**: Positions the database pointer according to search or filter criteria, then updates the subfile accordingly.
- **forny**: Refreshes subfile content, potentially after edits or deletes.

---

## Validation (`kontroll` subroutine)

For each input field:
- **Firm/company codes**: Ensures proper formatting, fills blanks with zeros as needed, and validates against a control program (`XC003C`).
- **Bilagsnr (Voucher number)**: Checks for numeric content and maximum length.
- **Bilagskode (Voucher code)**: Numeric check.
- **Period (Periode)**: Year and month ranges are validated.
- **Dates**: Strict checks on date format and valid ranges (supports both `dd.mm.yyyy` and simple numeric formats).
- **Amounts (`belo`, `valb`)**: Ensures correct decimal and thousand separators (`.` or `,`), length, and numeric content.
- **Account/Dept/Credit fields**: Numeric checks and maximum lengths.
- **Text fields**: Length checks.
- **Keys/IDs**: Check for presence and permissible characters.

If any field fails validation, a descriptive Norwegian error message is populated in `w_feil` and set for display/highlighting on the corresponding field.

---

## Indicators, Error Handling, and User Feedback

- Field-specific errors are indicated using various indicator bits (e.g., `*in41 = *on` for "Filgruppe" error).
- The display logic uses these indicators to highlight erroneous fields for the user and show appropriate error messages.

---

## Special Notes

- **Norwegian Language Comments and Fields**: Many messages and variables use Norwegian, so familiarity can be helpful.
- **Local Data Area (LDA) Usage**: The program uses the LDA for session/user context.
- **Subfile Pagination**: The subfile UI is built to handle standard paging (`rollup`, `rolldown`) and positioning.
- **File Locking & Data Integrity**: Operations are based on keyed access; there’s logic for chain/update/write/delete, ensuring data integrity in a multi-user setting.
- **Field Protection**: When displaying data in view-only mode, certain fields are protected from user input.

---

## Main Takeaways for New Developers

- **Subfile Technique**: The program is a classic example of subfile handling in RPG, including display, paging, and dynamic update of records.
- **Input Validation**: Extensive validation is performed on user input before allowing records to be saved.
- **Modularity**: Business logic is split into well-defined subroutines for clarity and reusability.
- **Error Highlighting**: Integrated field-wise error messaging makes it user-friendly and reduces input errors.
- **Norwegian Context**: Understand Norwegian vocabulary or use comments for translation as needed for field labels and messages.

---

## Orientation Advice

1. **Understand the Subfile Model**: Study the flow between `clr_subfile`, `crt_subfile`, `bck_subfile`, and `subfile`.
2. **Study Field Error Handling**: The program is meticulous about guiding users in correcting misguided entries.
3. **Review File Structure**: Know the structure/layout of the `rcoml1`, `rcomlr`, and `rcomlu` files, especially their key fields.
4. **Familiarize with LDA Usage**: How user context is passed and used throughout the program.
5. **Test with Display Files**: The `xc060d` display file and associated subfiles/screens are essential for understanding the user experience.

If you are new to IBM i RPG, focus first on understanding how subfiles work, how indicators control display and logic, and how the program branches between display, edit, and delete functions. This codebase is a robust, real-world example of interactive ILE RPG programming.