# ILE RPG Program AX100R â€“ Source Code Explanation

---

## Purpose and High-level Function

This program, `AX100R`, manages maintenance tasks on "modules" (likely master data for a system). It provides a display file-based maintenance UI with a subfile for navigation, and supports create, view, update, delete, copy, and search by both module and description.

---

## Key Concepts Used

- **Indicators:** Used heavily for flow and screen control (LR, 10-99; documented in the comments).
- **Subfiles:** For paged display and navigation/modification (B1 subfile).
- **Display File (Workstation):** User interaction using a DSPF with multiple record formats (screens).
- **Database Files:** Several logical views over the same base physical file (`amodpfr`) for various access paths.
- **Local Data Area (LDA):** Used for user/session context.
- **Subroutines:** Central program logic is organized into named subroutines (`begsr`/`endsr`).

---

## File Declarations

```rpg
famodl1    if   e           k disk    rename(amodpfr:amodl1r)
famodl2    if   e           k disk    rename(amodpfr:amodl2r)
famodlr    if   e           k disk    rename(amodpfr:amodlrr)
famodlu    uf a e           k disk    rename(amodpfr:amodlur)
faX100d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **amodl1/amodl2/amodlr/amodlu**: Multiple logicals (by module, by description, for read, update, etc.) on the same physical file for flexible access and operations.
- **faX100d**: Display file with subfile support (for lists/grid on the screen).

---

## Data Structures & Variables

- **LDA (Local Data Area):** Holds user/firm/session info loaded at start.
- **dspfbk:** Display feedback data structure (holds cursor record number).
- **Variables for keys and subfile tracking:** e.g. `amodl1_modu`, `amodl2_mtxt`, `w_fcrn`, `w_srrn`, etc.
- **Control/Status Variables & Flags:** e.g. `b_oppr`, `b_forn`, `b_anul`, `b_feil` to control operation flow.

---

## Main Program Loop (Flow)

1. **Initialization (`*inzsr`):**
    - Builds key lists for file access.
    - Reads user context from LDA.
    - Initializes indicators.
    - Sets up the subfile at program start.

2. **Display and Main Menu Loop:**
    - Starts at tag `b2taga` and `b2tagb`.
    - Writes the command/menu screen, shows the subfile.
    - Reacts to function keys via a `select/when` block:
        - PF3/PF12: Exit program
        - PF5: Refresh subfile
        - PF6: Create new module (show input screen)
        - PF10/PF11: Page up/down subfile.
        - PF21: Home key
    - Handles search/positioning if search fields entered.
    - Routes to subroutines based on action.

3. **Subfile Handling:**
    - **subfile**: Reads subfile records one by one (`readc`), detects user actions per row (Update, Copy, Delete, View) and invokes corresponding routines.
    - **crt_subfile**: Fills subfile with next "page" of records.
    - **bck_subfile**: Handles paging backwards in the subfile.
    - **clr_subfile**: Clears out the subfile before refilling.
    - **dsp_subfile**: Displays the subfile or command screen as required.

4. **Create/Edit/View/Delete/Copy Routines:**
    - **xc1bld**: Handles new row creation; prompts for new module, validates, calls update screen.
    - **xc1msg**: Shows message if attempting to create a record that already exists.
    - **xc2bld**: Core edit/view routine. Handles both new and existing records, updates/writes as needed.
    - **xd1win**: Handles deletion (after user confirmation).
    - **xk1win**: Handles copying a record to a new key (with validation for uniqueness).

5. **Positioning/Search:**
    - **posisjoner**: Position to first record matching module or description and refreshes subfile accordingly.

---

## Subfile/Paging Mechanism

- Uses variables like `w_srrn`, `w_ssrn`, `w_fcrn`, `w_spge` to track which records are on the screen, and which 'page' of the subfile is shown.
- Paging logic in `crt_subfile` increments the subfile window; `bck_subfile` decrements/page-ups, both use indicators to show/hide navigation keys.

---

## Key Indicators Used

- **LR (Last Record):** End of program.
- **10/PF10, 11/PF11:** Roll Up / Roll Down for subfile paging.
- **12, 13, 14, 15:** Subfile display, control, clear, end indicators.
- **21, 22:** Home/cursor positioning.
- **30-99:** Field protection, error/display control, temp flags.

---

## Screens (Record Formats)

- **B1SFL:** Subfile record (the grid/list of modules).
- **B2CTL:** Subfile control record (search, navigation, etc).
- **B2CMD:** Command screen for function keys.
- **C1BLD:** Entry screen for new module.
- **C1MSG:** Information message window for duplicates.
- **C2BLD:** Edit/view module.
- **D1WIN:** Delete confirmation window.
- **K1WIN:** Copy window.

---

## Comments and Documentation

- The code is heavily commented in Norwegian, describing both technical logic and business purpose for each block.
- The first block of comments indicates version and change tracking.

---

## Typical User Interactions

- User starts on a command/menu screen with a subfile list of current modules.
- Can search/position by module or description.
- Can page through the list using PF10/PF11.
- Can edit, delete, copy, or view an individual module row.
- Can add a new module.
- All operations are validated with appropriate status messages and checks (e.g., cannot duplicate keys).

---

## Summary Table of Main Subroutines

| Subroutine    | Purpose                                                        |
|---------------|----------------------------------------------------------------|
| forny         | Refreshes the subfile after changes                            |
| posisjoner    | Repositions subfile based on search                            |
| subfile       | Processes subfile rows (edit/copy/delete/view)                 |
| xc1bld        | Handles creation of new record                                 |
| xc1msg        | Displays duplicate key warning                                 |
| xc2bld        | Handles update/view of a record                                |
| xd1win        | Handles deletion confirmation and deletion                     |
| xk1win        | Handles copying a record                                       |
| clr_subfile   | Clears the subfile                                             |
| crt_subfile   | Fills the subfile with next page                               |
| bck_subfile   | Pages the subfile backward                                     |
| dsp_subfile   | Displays the subfile or command screen as appropriate          |
| *inzsr        | Initializes program (LDA, key lists, subfile setup)            |

---

## In Conclusion

This is a typical ILE RPG interactive maintenance program using subfiles, with careful separation of navigation and logic. It handles all major master file operations (CRUD + copy) with robust key and error checking, and provides a paged interface for end users on IBM i 5250 terminals. The implementation is modular, leveraging RPG's subroutine and indicator-based control flow patterns.