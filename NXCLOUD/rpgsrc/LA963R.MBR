     h datedit(*dmy) option(*nodebugio)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  System. . . . . : ASLAGR
      *  Program . . . . : LA963R
      *  Beskrivelse . . : Oppdatering av lager-register utfra lagerbok
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Spesialversjon. :
      *  Tilpasset for . :
      *
      *  Referanse  Dato   Endringsbeskrivelse                     Sign.
      *  --------- ------  -------------------------------------------------
7.01  *  7.00  090919 NHO   Nytt program som leser poster før inneværende år og oppdaterer
      *                     lagerbeh 01.01
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
6.30 fvhisl3    if   e           k disk    rename(vhispfr:vhisl3r)
6.30 f                                     prefix(xx:2)
     fvhisl5    if   e           k disk    rename(vhispfr:vhisl5r)
     fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
      *
      * Parameter-inn
      *
     d                 ds
     d d_prec                        64
     d  d_val1                        1  0 overlay(d_prec)
     d  d_val2                        1  0 overlay(d_prec:2)
     d  d_val3                        1  0 overlay(d_prec:3)
     d  d_val4                        1  0 overlay(d_prec:4)
     d  d_dato                       10d   datfmt(*iso)
     d                                     overlay(d_prec:5)
      *
      * Local Data Area
      *
     d                uds
6.10 d l_user                911    920
     d l_firm                944    946  0
      *
      * Definere variable i nøkler
     d vhisxx          s                   like(vhdato)
      *
     d vhisl5_dato     s                   like(vhdato)
     d vhisl5_lage     s                   like(vhlage)
     d vhisl5_time     s                   like(vhtime)
6.11 d vhisl5_sekv     s                   like(vhsekv)
     d vhisl5_vare     s                   like(vhvare)
6.30 d vhisl3_lage     s                   like(vhlage)
6.30 d vhisl3_vare     s                   like(vhvare)
6.30 d vhisl3_dato     s                   like(vhdato)
6.30 d vhisl3_time     s                   like(vhtime)
6.30 d vhisl3_sekv     s                   like(vhsekv)
     d vlaglu_lage     s                   like(vllage)
     d vlaglu_vare     s                   like(vlvare)
      *
      * Definere øvrige variable
      *
     d w_firm          s                   like(vhfirm)
     d w_parm          s             64
     d w_anta          s                   like(vhanta)
     d w_dato          s              6  0
     d w_time          s              6  0
6.30 d resdto          s              8  0
6.30 d resdt1          s              4  0
6.30 d resdt2          s              4  0
      *
6.30 d fØrste          s              1  0
6.30 d neste           s              1  0
     d hjlage          s                   like(vllage)
     d hjvare          s                   like(vlvare)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Leser poster fra register for utplukks-test
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     vhisl3_key    setll     vhisl3r
      * Leser fortløpende på varenr
     c     nyles         tag
     c                   read      vhisl3r
      *
     c                   if        %eof or
     c                             xxfirm <> w_firm
     c                   goto      slutt
     c                   endif
      *
      * Ta vare på vare/lager første gang
     c                   if        fØrste = 0
     c                   eval      hjvare = xxvare
     c                   eval      hjlage = xxlage
     c                   eval      fØRste = 1
     c                   eval      neste  = 1
     c                   endif
      *
     c                   if        neste = 0
     c                   if        hjvare = xxvare and
     c                             hjlage = xxlage
     c                   goto      nyles
     c                   else
     c                   eval      neste = 1
     c                   end
     c                   end
      *
     c                   eval      vhisl5_vare = xxvare
     c                   eval      vhisl5_lage = xxlage
     c                   eval      vhisl5_dato = *hival
     c                   eval      vhisl5_time = *hival
      *
     c     vhisl5_key    setll     vhisl5r
      * Leser fortløpende på varenr
     c                   read      vhisl5r
      * Bare en post
     c**                 if        vhvare <> xxvare
     c**                 readp     vhisl5r
     c**                 endif
      *
      *
     c                   move      vhdato        xxa10a           10
     c                   movel     xxa10a        hja2              4 0
     c                   move      vhisxx        xxa10b           10
     c                   movel     xxa10b        hjb2              4 0
      *
      * Skal ikke behandles her da post ligger i inneværende år
     c                   if        hja2 = hjb2
      * Vare/lager skal ikke behandles
     c                   eval      hjvare = vhvare
     c                   eval      hjlage = vhlage
     c                   eval      neste = 0
     c                   goto      nyles
     c                   else
      * Oppdat lager
     c                   exsr      oppdat
     c                   eval      hjvare = vhvare
     c                   eval      hjlage = vhlage
     c                   eval      neste = 0
     c                   goto      nyles
     c                   endif
      *
     c     slutt         tag
     c                   eval      *inlr = '1'
      *********************************************************************
      *
     c     oppdat        begsr
      *
      *
     c                   eval      vlaglu_vare = vhvare
     c                   eval      vlaglu_lage = vhlage
     c     vlaglu_key    chain     vlaglur
      *
     c                   if        %found
     c                   if        d_val3 = 1
     c                   eval      vlbeve = vlbeve + 1
6.31 c                   eval      vlb101 = vlbehl
6.10 c                   time                    vledat
6.10 c                   time                    vletim
6.10 c                   eval      vleusr = l_user
     c                   update    vlaglur
     c                   endif
     c                   endif
      *
     c     endoppdat     tag
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *  Key for les av HISTORISK-LAGERBOK-REGISTER
      *
6.30  *  Key for oppslag på historisk lagerbok
6.30  *
6.30 c     vhisl3_key    klist
6.30 c                   kfld                    w_firm
6.30 c                   kfld                    vhisl3_vare
6.30 c                   kfld                    vhisl3_lage
6.30 c                   kfld                    vhisl3_dato
6.30 c                   kfld                    vhisl3_time
6.30 c                   kfld                    vhisl3_sekv
      *
6.30  *
6.30 c     vhisl5_key    klist
6.30 c                   kfld                    w_firm
6.30 c                   kfld                    vhisl5_vare
6.30 c                   kfld                    vhisl5_lage
6.30 c                   kfld                    vhisl5_dato
6.30 c                   kfld                    vhisl5_time
6.30 c                   kfld                    vhisl5_sekv
      *
      *  Key for oppdatering av LAGER-REGISTER
      *
     c     vlaglu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vlaglu_vare
     c                   kfld                    vlaglu_lage
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    w_parm
     c                   eval      d_prec = w_parm
      *
     c                   eval      vhisxx = d_dato
      *  Legge inn startverdier
      *
     c                   eval      w_firm = l_firm
     c                   eval      vhisl3_dato = *loval
     c                   eval      vhisl3_time = *loval
6.11 c                   eval      vhisl3_sekv = *zero
     c                   eval      vhisl3_vare = *blank
      *
     c                   endsr
