      /TITLE  Utskrift av lagerverdiliste
pdf  h decedit('0.') datedit(*ymd-) option(*nodebugio)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Program . . . . : LL699R
      * Beskrivelse . . : Utskrift av lagerverdiliste - coolspool
      *                   Basert på LL609R
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Referanse  Dato   Endringsbeskrivelse                      Sign.
      * --------- ------  --------------------------------------------------
8.xx  * K0000     210922  Nytt program                             bsa
8.xx  * K0000             NB Utskriftsfila benyttes ikke. Kun for
8.xx  * K0000             definering av variabler, og logikken rundt
8.xx  * K0000             summeringer sov vil jeg ikke røre.
8.01  * K0000     300922  Skal vise resultatet i excel i browser.  bsa
8.02  * K0000     060224  Legger ut feil felt.                     bsa
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flwa1l1    if   e           k disk    rename(lwa1pfr:lwa1l1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
     fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
     fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
     fvkhvl1    if   e           k disk    rename(vkhvpfr:vkhvl1r)
     fsistlb    if   e           k disk    rename(sistpfr:sistlbr)
     flbchl1    if   e           k disk    rename(lbchpfr:lbchl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
     flwa4l1    if   e           k disk    rename(lwa4pfr:lwa4l1r)
     fra09l1    if   e           k disk    rename(ra09pfr:ra09l1r)
     frax9l1    if   e           k disk    rename(rax9pfr:rax9l1r)
     ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
     flxl1st    uf a e           k disk    rename(lxl1st:lxl1str)
      *
     fll699p    o    e             printer
     f                                     usropn
      *
      *  Parameter-rec
      *
     d                 ds
     d p_prec                       128
     d  p_fvar                        8  0 overlay(p_prec)
     d  p_tvar                        8  0 overlay(p_prec:9)
     d  p_flag                        2  0 overlay(p_prec:17)
     d  p_tlag                        2  0 overlay(p_prec:19)
     d  p_fogr                        2  0 overlay(p_prec:21)
     d  p_togr                        2  0 overlay(p_prec:23)
     d  p_fhgr                        2  0 overlay(p_prec:25)
     d  p_thgr                        2  0 overlay(p_prec:27)
     d  p_fugr                        3  0 overlay(p_prec:29)
     d  p_tugr                        3  0 overlay(p_prec:32)
     d  p_levn                        6  0 overlay(p_prec:35)
     d  p_sakb                        6  0 overlay(p_prec:41)
     d  p_sort                        1  0 overlay(p_prec:45)
     d  p_brud                        1  0 overlay(p_prec:46)
     d  p_vlin                        1  0 overlay(p_prec:47)
     d  p_batc                       10    overlay(p_prec:48)
     d  p_dath                        6  0 overlay(p_prec:58)
     d  p_gjko                        1  0 overlay(p_prec:64)
     d  p_dumm                       10    overlay(p_prec:65)
      *
      * Local Data Area
      *
     d                uds
     d l_poff                584    584
     d l_utqm                585    594
     d l_bach                595    635
     d l_arch                636    636  0
     d l_skje                637    637  0
     d l_land                638    638  0
     d l_exlp                639    639  0
     d l_mail                640    640  0
     d l_prfi                750    750  0
     d l_ruti                800    809
     d l_outq                810    819
     d l_copy                838    843  0
     d l_wsid                901    910
     d l_user                911    920
     d l_filg                931    933
     d l_firm                944    946  0
     d l_avde                947    950  0
     d l_fnav                951    980
      *
      * Definering av parametre
      *
     d p_lr            s              1
     d p_str_in        s            512
     d p_str_out       s            512
     d p_avsl          s            100
     d p_filn          s            256
     d p_fnav          s             50
     d p_mime          s            150
     d p_rec1          s             50
     d p_rec2          s             50
     d p_rec3          s             50
     d p_subj          s            100
     d p_bcc           s              1
     d p_pers          s             50
     d p_txt1          s            100
     d p_txt2          s            100
     d p_txt3          s            100
     d p_txt4          s            100
      *
      * Definering av variable i nøkler
      *
     d vvarl1_vare     s                   like(vvvare)
     d vogrl1_oogr     s                   like(vgoogr)
     d vhgrl1_hogr     s                   like(vghogr)
     d vhgrl1_hhgr     s                   like(vghhgr)
     d vugrl1_uogr     s                   like(vguogr)
     d vugrl1_uhgr     s                   like(vguhgr)
     d vugrl1_uugr     s                   like(vguugr)
     d vkhvl1_khev     s                   like(vvkhev)
     d vkhvl1_klty     s                   like(vaklty)
     d vkhvl1_koty     s                   like(vakoty)
     d sistlb_paar     s                   like(sipaar)
     d sistlb_vare     s                   like(sivare)
     d lbchl1_batc     s                   like(lcbatc)
     d lwa4l1_akey     s                   like(l4akey)
     d ra09l1_ikod     s                   like(raikod)
     d fusrl1_user     s                   like(fbuser)
      *
      * Definering av variable
      *
     d w_parm          s            128
     d w_firm          s                   like(vvfirm)
     d w_dato          s               d   datfmt(*iso)
     d w_time          s               t   timfmt(*iso)
     d w_ddmy          s              6  0
     d w_prfi          s              1  0
     d w_ffir          s              3  0
     d w_fnav          s             30
     d w_fad1          s             30
     d w_fad2          s             30
     d w_fste          s             30
     d w_fftx          s             30
     d w_tfax          s              8
     d w_ftlf          s             11
     d w_ffax          s             11
     d w_mail          s             50
     d w_weba          s             50
     d w_head          s             75
     d w_vare          s              8  0
     d w_adrs          s             30
     d w_ponr          s              4  0
     d w_pste          s             30
     d w_avde          s              4  0
     d w_tell          s              5  0
     d w_forste        s              1  0
     d w_snkp          s             10  2
     d w_snkt          s             13  2
     d w_kost          s             13  2
     d w_anta          s             15  3
     d t_behl          s             11  2
     d t_kost          s             11  2
     d t_omst          s             11  2
     d t_snko          s             11  2
     d t_text          s             75
     d w_aarr          s              6  0
     d w_nobb          s                   like(vvnobb)
     d w_lv_nobb       s                   like(vvnobb)
     d w_lv_modn       s                   like(vvnmod)
     d w_lv_lldo       s                   like(vvldor)
     d w_lv_llva       s                   like(vvlvar)
     d w_vtyp          s                   like(vvvtyp)
     d w_udat          s                   like(vvudat)
     d w_ldor          s                   like(vvldor)
     d w_gjko          s              9  2
     d w_datg          s              8  0
     d w_dath          s               d   datfmt(*iso)
     d w_varh          s                   like(vvvare)
     d w_kode          s              1
     d w_fell          s              6
     d w_type          s              2
     d w_fast          s             10
     d w_numm          s              8  0
     d w_sqlwhere      s           8000
     d w_excel_url     s            100
      *
     d g_vare          s                   like(mlvare)
     d g_ogrp          s                   like(vgoogr)
     d g_hgrp          s                   like(vghhgr)
     d g_ugrp          s                   like(vguugr)
     d g_khev          s                   like(vakkod)
     d g_lage          s                   like(mllage)
      *
     d b_feil          s              1    inz(*off)
     d b_init          s              1    inz(*on)
     d b_inlr          s              1    inz(*off)
     d b_pdfp          s              1    inz(*off)
     d b_sort          s              1    inz(*off)
     d b_tota          s              1    inz(*off)
     d b_deta          s              1    inz(*off)
     d b_grop          s              1    inz(*off)
     d b_exlp          s              1    inz(*off)
      *
     d x_numm          s             15
     d x_vref          s             25
     d x_betb          s             42
     d w_bdat          s               d   datfmt(*iso)
     d w_date          s               d   datfmt(*iso)
     d w_dato2         s             12  0
     d w_ruti          s             10
     d w_pdf           s              1  0
     d w_jnav          s             15
     d w_jkey          s             41
     d w_jtxt          s             35
     d w_pdf_ds        s            512
     d w_mtxt          s            300
     d w_jstat         s              2  0
     d w_jtext         s            200
     d w_text          s            200
     d w_ogtx          s             50
     d w_hgtx          s             50
     d w_ugtx          s             50
     d w_khtx          s             50
     d w_ltek          s             50
     d w_land          s              9
     d w_mark          s              5
     d w_spol          s              5
     d w_x             s              3  0
     d w_path          s            256
     d w_ema2          s             50
     d w_ttype         s              1
     d w_draw1         s             10
     d w_draw2         s             10
     d w_dspl          s            100
     d w_tek1          s            512
     d w_tek2          s            512
     d w_copy          s              3  0
     d w_faks          s             30
     d w_pemne         s             75
     d w_ptxt1         s             75
     d w_ptxt2         s             75
     d w_ptxt3         s             75
     d w_ptxt4         s             75
     d w_ppers         s             75
     d w_rekv          s             50
     d w_1fnav         s             50
     d w_1fad1         s             50
     d w_1fad2         s             50
     d w_1navn         s             50
     d w_1gate         s             50
     d w_1adr2         s             50
     d w_txt1          s             75
     d w_rtyp          s             50
     d w_txt2          s             50
     d w_exsql         s          10000
     d w_exmap         s             30    inz('excel')
     d w_exfil         s             50    inz('Lagverdi')
     d w_extyp         s              4    inz('XLS')
     d w_skille        s              1    inz('"')
      *
     d tmpdate         s               D
     d tmptime         s               T
      *
     d p_btyp          s            100
      *
      * Eksternt program
       dcl-s co402_verdi1  char(1);
       dcl-s co402_verdi2  char(2048);
       DCL-PR CO402R EXTPGM('CO402R');
         p_filgrp            char(3)     const;
         p_firm              packed(3:0) const;
         p_lager             packed(2:0) const;
         p_nokkel            char(50)    const;
         p_verdi1            char(1);
         p_verdi2            char(2048);
       END-PR;
      *u_711           s              1    inz(*off)
      *
      * - - - - - - - - - -
      * Benyttede formater
      * - - - - - - - - - -
      *
      * A1HDR  - Heading A1 på rapport
      * A2HDR  - Overgruppe heading
      * A3HDR  - Hovedgruppe heading
      * A4HDR  - Undergruppe heading
      * A5HDR  - Kontohenvisningsheading
      * A6HDR  - Lager heading
      * D1DET  - Detail pr vare/lager
      * T1SUM  - Sum pr vare
      * T2SUM  - Sum pr overgruppe
      * T3SUM  - Sum pr hovedgruppe
      * T4SUM  - Sum pr undergruppe
      * T5SUM  - Sum pr kontohenvisning
      * T6SUM  - Sum pr lager
      * T7SUM  - Sum pr firma
      *
     C/Exec SQL
     C+  Set Option DatFmt=*ISO
     C/End-Exec
      *
      * Hent mailadresse
      *
     c                   eval      w_mail = *blanks
     c                   eval      fusrl1_user = l_user
     c     fusrl1_key    chain     fusrl1
     c                   if        %found
     c                   eval      ra09l1_ikod = fbselg
     c     ra09l1_key    chain     ra09l1
     c                   if        %found
     c                   eval      w_mail = raiema
     c                   endif
     c                   endif
      *
      * Skriv første heading
     c                   if        p_sort <> 2 and
     c                             p_sort <> 3
     c                   if        1=2
     c                   write     a1hdr                                30
     c                   endif
     c                   endif
      *
      * Lese file
      *
     c                   eval      g_khev = *hival
     c                   eval      g_lage = *hival
     c                   eval      g_ogrp = *hival
     c                   eval      g_hgrp = *hival
     c                   eval      g_ugrp = *hival
      *
     c                   read      lwa1l1                                 90
      *
     c                   dow       *in90 = *off
      *
      * Ikke skriv summer på første
      *
     c                   if        w_forste = 1
      *
      * Sjekk om sortert på vare/lager
      *
     c                   if        p_sort = 1 or
     c                             p_sort = 2 or
     c                             p_sort = 3
     c                   if        mlvare <> w_vare
     c                   exsr      sum_t1
     c                   endif
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på varegruppe/Varenummer/Lager
      *
     c                   if        p_sort = 2
      *
      * Brudd på undergruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp or
     c                             mlugrp <> g_ugrp
     c                   exsr      sum_t2
     c                   endif
      *
      * Brudd på hovedgruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp
     c                   exsr      sum_t3
     c                   endif
      *
      * Brudd på overgruppe ?
      *
     c                   if        mlogrp <> g_ogrp
     c                   exsr      sum_t4
     c                   endif
      *
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på kontohenvisning/varenummer/lager
      *
     c                   if        p_sort = 3
     c                   if        mlkhev <> g_khev
     c                   exsr      sum_t5
     c                   endif
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på lager
      *
     c                   if        p_sort  = 4
     c                   if        mllage <> g_lage
     c                   exsr      sum_t6
     c                   endif
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på lager/varegruppe/varenummer
      *
     c                   if        p_sort = 5
      *
      * Brudd på lager ?
      *
     c                   if        mllage <> g_lage
      *
     c                   exsr      sum_t2
     c                   exsr      sum_t3
     c                   exsr      sum_t4
     c                   exsr      sum_t6
      *
     c                   else
      *
      * Brudd på undergruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp or
     c                             mlugrp <> g_ugrp
     c                   exsr      sum_t2
     c                   endif
      *
      * Brudd på hovedgruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp
     c                   exsr      sum_t3
     c                   endif
      *
      * Brudd på overgruppe ?
      *
     c                   if        mlogrp <> g_ogrp
     c                   exsr      sum_t4
     c                   endif
      *
     c                   endif
      *
     c                   endif
     c/space 3
      *
      * Sjekk om sortert på lager/kontohenvisning/varenummer
      *
     c                   if        p_sort = 6
      *
     c                   if        mllage <> g_lage
     c                   exsr      sum_t5
     c                   exsr      sum_t6
     c                   else
     c                   if        mlkhev <> g_khev
     c                   exsr      sum_t5
     c                   endif
     c                   endif
      *
     c                   endif
      *
     c                   endif
      *
     c                   eval      w_forste = 1
     c/eject
      *
      * Brudd på lager ?
      *
     c                   if        p_sort  = 4 or
     c                             p_sort  = 5 or
     c                             p_sort  = 6
     c                   if        mllage <> g_lage
     c                   exsr      hed_a6
     c                   endif
     c                   endif
      *
      * Sjekk om sortert på varegruppe
      *
     c                   if        p_sort = 2 or
     c                             p_sort = 5
      *
      * Brudd på overgruppe ?
      *
     c                   if        mlogrp <> g_ogrp
     c                   if        p_sort = 2
     c                   if        1=2
     c                   exsr      overflow
     c                   endif
     c                   endif
     c                   exsr      hed_a2
     c                   endif
      *
      * Brudd på hovedgruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp
     c                   exsr      hed_a3
     c                   endif
      *
      * Brudd på undergruppe ?
      *
     c                   if        mlogrp <> g_ogrp or
     c                             mlhgrp <> g_hgrp or
     c                             mlugrp <> g_ugrp
     c                   exsr      hed_a4
     c                   endif
      *
     c                   endif
      *
      * Sjekk om sortert på kontohenvisning
      *
     c                   if        p_sort = 3 or
     c                             p_sort = 6
     c                   if        mlkhev <> g_khev
     c                   if        p_sort = 3
     c                   if        1=2
     c                   exsr      overflow
     c                   endif
     c                   endif
     c                   exsr      hed_a5
     c                   endif
     c                   endif
      *
      * Utskrift av detaljer
      *
     c                   movel     mlvare        d1vare
     c                   movel     mlvare        vvarl1_vare
     c     vvarl1_key    chain     vvarl1                             91
     c**                 if        *in91 = *off
     c**                 eval      d1tek1 = vvtek1
     c**                 else
     c**                 eval      d1tek1 = 'Ukjent vare'
     c**                 endif
      *
      * Henter varetekst fra sidetabell
      *
     c                   eval      lwa4l1_akey = mlakey
     c     lwa4l1_key    chain     lwa4l1
     c                   if        %found
     c                   eval      d1tek1 = l4tek1
     c                   else
     c                   eval      d1tek1 = 'Ukjent vare'
     c                   endif
      * sjekker om logistikk-vare
     c                   call      'VL710R'
     c                   parm                    w_firm
     c                   parm                    mlvare
     c                   parm                    mllage
     c                   parm                    w_vtyp
     c                   parm                    w_udat
     c                   parm                    w_ldor
     c                   parm                    b_inlr
     c                   parm                    w_lv_nobb
     c                   parm                    w_lv_modn
     c                   parm                    w_lv_lldo
     c                   parm                    w_lv_llva
      *
     c                   eval      d1lage = mllage
     c                   eval      d1enhl = vvenhl
     c                   eval      d1spri = mlspri
     c                   eval      d1kpri = mlkpri
     c                   eval      d1behl = mlbehl
      *
      * Ikke skriv beholdning hvis = 0
      *
     c                   if        d1behl = 0
     c                   eval      *in61 = *on
     c                   else
     c                   eval      *in61 = *off
     c                   endif
      *
     c                   if        mltrda <> *loval
     c     *dmy          move      mltrda        d1dato
     c                   else
     c                   move      *zeros        d1dato
     c                   endif
      *
      * Henter gjennomsnitts kostpris
      *
     c                   if        p_gjko = 1
     c                   exsr      snit_kost
     c                   else
     c                   exsr      stat_kost
     c                   endif
     c                   eval      d1snkp = w_snkp
     c                   eval      d1snkt = w_snkp * mlbehl
      *
      * Negative beholdninger tas ut av beregning av verdier
      *
     c                   if        mlbehl < 0
     c                   eval      mlomst = 0
     c                   eval      mlkost = 0
     c                   eval      d1snkt = 0
     c                   endif
      *
     c                   eval      d1omst = mlomst
     c                   eval      d1kost = mlkost
      *
     c                   if        p_vlin = 0
     c                   if        1=2
     c                   write     d1det                                30
      * Skriver XML tagger for detaljer
     c                   endif
     c                   exsr      xml_deta
     c                   endif
      *
     c                   if        1=2
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      g_vare = mlvare
     c                   eval      g_lage = mllage
     c                   eval      g_khev = mlkhev
     c                   eval      g_ogrp = mlogrp
     c                   eval      g_hgrp = mlhgrp
     c                   eval      g_ugrp = mlugrp
      *
      * Summer innen varenummer
      *
     c                   if        p_sort = 1 or
     c                             p_sort = 2 or
     c                             p_sort = 3
     c                   eval      w_tell = w_tell + 1
     c                   eval      w_vare = mlvare
     c                   eval      t1behl = t1behl + mlbehl
     c                   eval      t1omst = t1omst + mlomst
     c                   eval      t1kost = t1kost + mlkost
     c                   eval      t1snko = t1snko + d1snkt
     c                   endif
      *
      * Summer innen varegruppe
      *
     c                   if        p_sort = 2 or
     c                             p_sort = 5
      *
     c                   eval      t2omst = t2omst + mlomst
     c                   eval      t2kost = t2kost + mlkost
     c                   eval      t2snko = t2snko + d1snkt
      *
     c                   eval      t3omst = t3omst + mlomst
     c                   eval      t3kost = t3kost + mlkost
     c                   eval      t3snko = t3snko + d1snkt
      *
     c                   eval      t4omst = t4omst + mlomst
     c                   eval      t4kost = t4kost + mlkost
     c                   eval      t4snko = t4snko + d1snkt
     c                   endif
      *
      * Summer innen kontohenvisning
      *
     c                   if        p_sort = 3 or
     c                             p_sort = 6
      *
     c                   eval      t5omst = t5omst + mlomst
     c                   eval      t5kost = t5kost + mlkost
     c                   eval      t5snko = t5snko + d1snkt
     c                   endif
      *
      * Summer innen lager
      *
     c                   if        p_sort = 4 or
     c                             p_sort = 5 or
     c                             p_sort = 6
     c                   eval      t6omst = t6omst + mlomst
     c                   eval      t6kost = t6kost + mlkost
     c                   eval      t6snko = t6snko + d1snkt
     c                   endif
      *
      * Summer innen firma
      *
     c                   eval      t7omst = t7omst + mlomst
     c                   eval      t7kost = t7kost + mlkost
     c                   eval      t7snko = t7snko + d1snkt
      *
     c                   read      lwa1l1                                 90
      *
     c                   enddo
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     end_pgm       tag
      *
      * Sjekk om sortert på varegruppe
      *
     c                   if        p_sort = 2 or
     c                             p_sort = 5
      *
     c                   exsr      sum_t2
      *
     c                   exsr      sum_t3
      *
     c                   exsr      sum_t4
      *
     c                   endif
      *
      * Sjekk om sortert på kontohenvisning
      *
     c                   if        p_sort = 3 or
     c                             p_sort = 6
     c                   exsr      sum_t5
      *
     c                   endif
      *
      * Sjekk om sortert på lager
      *
     c                   if        p_sort = 4 or
     c                             p_sort = 5 or
     c                             p_sort = 6
     c                   exsr      sum_t6
      *
     c                   endif
      *
      * Firmatotal
      *
     c                   exsr      sum_t7
      *
     c                   if        1=2
     c                   close     ll699p
     c                   endif
      *
      * Lag excel
      *
     c                   exsr      lag_excel
      *
      * Send mail
      *
8.01 c                   if        1=2
     c                   if        %trim(w_mail) <> *blanks
     c                   exsr      send_mail
     c                   endif
8.01 c                   endif
      *
      * Slett utvalget fra tabell
      *
     c                   exsr      rydd_xls
      *
      * Avslutt jobbid
      *
     c                   call      'AB710R'
     c                   parm                    l_bach
      *
     c     avslutt       tag
     c                   eval      *inlr = *on
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum varenummer (Flere lager)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t1        begsr
      *
     c                   if        w_tell > 1
     c                             and p_sort < 3
     c                   eval      t1vare = g_vare
     c                   if        p_vlin = 0
     c                   if        1=2
     c                   write     t1sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      t_text = 'Sum: ' + %trim(%char(t1vare))
     c                   eval      t_behl = t1behl
     c                   eval      t_omst = t1omst
     c                   eval      t_kost = t1kost
     c                   eval      t_snko = t1snko
     c                   endif
     c                   endif
      *
     c                   eval      t1behl = 0
     c                   eval      t1omst = 0
     c                   eval      t1kost = 0
     c                   eval      t1snko = 0
     c                   eval      w_tell = 0
      *
     c     end_t1        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum undergruppe
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t2        begsr
      *
     c                   eval      t4ogrp = g_ogrp
     c                   eval      t4hgrp = g_hgrp
     c                   eval      t4ugrp = g_ugrp
     c                   eval      t4ugtx = a4ugtx
     c                   if        1=2
     c                   write     t4sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      t_text = 'Sum: '+%trim(%char(t4ogrp))+' '+
     c                             %trim(%char(t4hgrp)) + ' ' +
     c                             %trim(%char(t4ugrp)) + ' ' +
     c                             %trim(t4ugtx)
     c                   eval      t_behl = 0
     c                   eval      t_omst = t4omst
     c                   eval      t_kost = t4kost
     c                   eval      t_snko = t4snko
      *
     c                   eval      t4omst = 0
     c                   eval      t4kost = 0
     c                   eval      t4snko = 0
      *
     c     end_t2        endsr
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum hovedgruppe
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t3        begsr
      *
     c                   eval      t3ogrp = g_ogrp
     c                   eval      t3hgrp = g_hgrp
     c                   eval      t3hgtx = a3hgtx
     c                   if        1=2
     c                   write     t3sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      t_text = 'Sum: '+%trim(%char(t3ogrp))+' '+
     c                             %trim(%char(t3hgrp)) + ' ' +
     c                             %trim(t3hgtx)
     c                   eval      t_behl = 0
     c                   eval      t_omst = t3omst
     c                   eval      t_kost = t3kost
     c                   eval      t_snko = t3snko
      *
     c                   eval      t3omst = 0
     c                   eval      t3kost = 0
     c                   eval      t3snko = 0
      *
     c     end_t3        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum overgruppe
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t4        begsr
      *
     c                   eval      t2ogrp = g_ogrp
     c                   eval      t2ogtx = a2ogtx
     c                   if        1=2
     c                   write     t2sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      t_text = 'Sum: '+%trim(%char(t2ogrp))+' '+
     c                             %trim(t2ogtx)
     c                   eval      t_behl = 0
     c                   eval      t_omst = t2omst
     c                   eval      t_kost = t2kost
     c                   eval      t_snko = t2snko
      *
     c                   eval      t2omst = 0
     c                   eval      t2kost = 0
     c                   eval      t2snko = 0
      *
     c     end_t4        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum kontohenvisning
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t5        begsr
      *
     c                   eval      t5khev = g_khev
     c                   eval      t5khtx = a5khtx
     c                   if        1=2
     c                   write     t5sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      t_text = 'Sum: ' + %trim(t5khev) + ' ' +
     c                             %trim(t5khtx)
     c                   eval      t_behl = 0
     c                   eval      t_omst = t5omst
     c                   eval      t_kost = t5kost
     c                   eval      t_snko = t5snko
      *
     c                   eval      t5omst = 0
     c                   eval      t5kost = 0
     c                   eval      t5snko = 0
      *
     c     end_t5        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum lager
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t6        begsr
      *
     c                   eval      t6lage = g_lage
     c                   eval      t6ltek = a6ltek
     c                   if        1=2
     c                   write     t6sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      t_text = 'Sum: '+%trim(%char(t6lage))+' '+
     c                             %trim(t6ltek)
     c                   eval      t_behl = 0
     c                   eval      t_omst = t6omst
     c                   eval      t_kost = t6kost
     c                   eval      t_snko = t6snko
      *
     c                   eval      t6omst = 0
     c                   eval      t6kost = 0
     c                   eval      t6snko = 0
      *
     c     end_t6        endsr
     c/space 3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Skriv sum firma
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_t7        begsr
      *
     c                   eval      t7firm = l_firm
     c                   if        1=2
     c                   write     t7sum                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      t_text = 'Sum firma: '+%char(t7firm)
     c                   eval      t_behl = 0
     c                   eval      t_omst = t7omst
     c                   eval      t_kost = t7kost
     c                   eval      t_snko = t7snko
      *
     c     end_t7        endsr
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på overgruppe ?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a2        begsr
      *
     c                   eval      vogrl1_oogr = mlogrp
     c     vogrl1_key    chain     vogrl1                             92
     c                   eval      a2ogrp = mlogrp
     c                   if        *in92 = *off
     c                   eval      a2ogtx = vgotxt
     c                   else
     c                   eval      a2ogtx = 'Ukjent overgruppe'
     c                   endif
      *
     c                   if        p_vlin = 0
     c                   if        1=2
     c                   write     a2hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      w_ogtx = *blanks
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     a2ogtx        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ogtx
      *
     c                   eval      w_text = 'Ogr: '+ %char(a2ogrp)+' ' +
     c                                      %trim(w_ogtx)
     c                   endif
      *
     c     end_a2        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på hovedgruppe ?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a3        begsr
      *
     c                   eval      vhgrl1_hogr = mlogrp
     c                   eval      vhgrl1_hhgr = mlhgrp
     c     vhgrl1_key    chain     vhgrl1                             93
     c                   eval      a3ogrp = mlogrp
     c                   eval      a3hgrp = mlhgrp
     c                   if        *in93 = *off
     c                   eval      a3hgtx = vghtxt
     c                   else
     c                   eval      a3hgtx = 'Ukjent hovedgruppe'
     c                   endif
      *
     c                   if        p_vlin = 0
     c                   if        1=2
     c                   write     a3hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      w_text = *blanks
     c                   eval      w_hgtx = *blanks
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     a3hgtx        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_hgtx
      *
     c                   eval      w_text = 'Hgr: '+%char(a3ogrp)+%char(a3hgrp)+
     c                                      ' ' + %trim(w_hgtx)
     c                   endif
      *
     c     end_a3        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på undergruppe ?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a4        begsr
      *
     c                   eval      vugrl1_uogr = mlogrp
     c                   eval      vugrl1_uhgr = mlhgrp
     c                   eval      vugrl1_uugr = mlugrp
     c     vugrl1_key    chain     vugrl1                             94
     c                   eval      a4ogrp = mlogrp
     c                   eval      a4hgrp = mlhgrp
     c                   eval      a4ugrp = mlugrp
     c                   if        *in94 = *off
     c                   eval      a4ugtx = vgutxt
     c                   else
     c                   eval      a4ugtx = 'Ukjent undergruppe'
     c                   endif
      *
     c                   if        p_vlin = 0
     c                   if        1=2
     c                   write     a4hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      w_text = *blanks
     c                   eval      w_ugtx = *blanks
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     a4ugtx        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ugtx
      *
     c                   eval      w_text = 'Ugr: '+%char(a4ogrp)+%char(a4hgrp)+
     c                                      %char(a4ugrp)+' '+%trim(w_ugtx)
     c                   endif
      *
     c     end_a4        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på kontohenvisning
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a5        begsr
      *
     c                   eval      vkhvl1_khev = mlkhev
     c                   eval      vkhvl1_klty = *zero
     c                   eval      vkhvl1_koty = *blank
     c     vkhvl1_key    chain     vkhvl1                             94
     c                   eval      a5khev = mlkhev
     c                   if        *in94 = *off
     c                   eval      a5khtx = vaktxt
     c                   else
     c                   eval      a5khtx = 'Ukjent kontohenvisning'
     c                   endif
      *
     c                   if        p_vlin = 0
     c                   if        1=2
     c                   write     a5hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      w_text = *blanks
     c                   eval      w_khtx = *blanks
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     a5khtx        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_khtx
      *
     c                   eval      w_text = 'Khv: '+%trim(a5khev)+' '+
     c                             %trim(w_khtx)
     c                   endif
      *
     c     end_a5        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Brudd på lager?
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hed_a6        begsr
      *
     c                   eval      a6lage = mllage
      *
     c                   call      'FÅ720R'
     c                   parm                    w_firm
     c                   parm                    mllage
     c                   parm                    a6ltek
     c                   parm                    w_adrs
     c                   parm                    w_ponr
     c                   parm                    w_pste
     c                   parm                    w_avde
     c                   parm                    b_feil
      *
     c                   if        b_feil = *on
     c                   eval      a6ltek = 'Ukjent lager'
     c                   endif
      *
     c                   if        b_init = *off
     c                   if        1=2
     c                   exsr      overflow
     c                   endif
     c                   else
     c                   eval      b_init = '0'
     c                   endif
      *
     c                   if        1=2
     c                   write     a6hdr                                30
     c                   if        *in30 = *on
     c                   exsr      overflow
     c                   endif
     c                   endif
      *
     c                   eval      w_text = *blanks
     c                   eval      w_ltek = *blanks
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     a6ltek        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ltek
      *
     c                   eval      w_text = 'Lager: '+%char(a6lage)+' '+
     c                             %trim(w_ltek)
      *
     c     end_a6        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  OVFLOW    Behandling av overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     overflow      begsr
      *
      *  Skriver heading
      *
     c                   write     a1hdr                                30
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  STAT_KOST Finner gjennomsnitskostpris fra statistikk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     stat_kost     begsr
      *
     c                   eval      w_anta = 0
     c                   eval      w_kost = 0
     c                   eval      w_snkp = 0
     c                   eval      sistlb_vare = vvarl1_vare
     c                   eval      sistlb_paar = *year
     c                   eval      sistlb_paar = sistlb_paar - 1
      *
     c     sistlb_key    setll     sistlb
     c     sistlb_key    reade     sistlb
      *
     c                   dow       not %eof
      *
     c                   eval      w_anta = w_anta + sianta
     c                   eval      w_kost = w_kost + sisumk
      *
     c     sistlb_key    reade     sistlb
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   eval      w_snkp = w_kost / w_anta
     c                   else
     c                   eval      w_snkp = mlkpri
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  SNIT_KOST Finner gjennomsnitskostpris fra glidende kostpris
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     snit_kost     begsr
      *
     c     *dmy          move      p_dath        w_dath
     c                   movel     mlvare        w_varh
     c                   eval      w_datg = %dec(w_dath:*iso)
     c                   call      'VG701R'
     c                   parm                    w_varh
     c                   parm                    mllage
     c                   parm                    w_datg
     c                   parm                    w_gjko
      *
     c                   if        w_gjko > 0
     c                   eval      w_snkp = w_gjko
     c                   else
     c                   eval      w_snkp = mlkpri
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  LES_BATCH Leser tellebatch for å finne telledato
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     les_batch     begsr
      *
     c                   eval      lbchl1_batc = p_batc
     c     lbchl1_key    chain     lbchl1
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Detaljer                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_deta      begsr
      *
     c                   if        w_lv_nobb <> 0
     c                   eval      w_nobb = w_lv_nobb
     c                   else
     c                   eval      w_nobb = vvnobb
     c                   endif
      *
     c                   eval      w_tek1 = *blank
     c                   eval      w_tek2 = *blank
      *
     c*                  eval      p_str_in = *blank
     c*                  eval      p_lr = '0'
     c*                  movel     d1tek1        p_str_in
     c*                  call      'AP613R'
     c*                  parm                    p_str_in
     c*                  parm                    p_str_out
     c*                  parm                    p_lr
     c*                  movel     p_str_out     w_tek1
     c                   eval      w_tek1 = d1tek1
      *
     c*                  eval      p_str_in = *blank
     c*                  eval      p_lr = '0'
     c*                  movel     vvtek2        p_str_in
     c*                  call      'AP613R'
     c*                  parm                    p_str_in
     c*                  parm                    p_str_out
     c*                  parm                    p_lr
     c*                  movel     p_str_out     w_tek2
     c                   eval      w_tek2 = vvtek2
      *
     c                   clear                   lxl1str
      * Member
     c                   eval      lxlide = w_numm
      * Overgruppe
     c                   eval      lxlogr = vvogrp
      * Hovedgruppe
     c                   eval      lxlhgr = vvhgrp
      * Undergruppe
     c                   eval      lxlugr = vvugrp
      * Lager
     c                   eval      lxllag = d1lage
      * Nobbnummer
     c                   eval      lxlnob = w_nobb
      * Varenummer
     c                   eval      lxlvar = d1vare
      * Varetekst 1
     c                   eval      lxltx1 = w_tek1
      * Varetekst 2
     c                   eval      lxltx2 = w_tek2
      * Enhet
     c                   eval      lxlenh = d1enhl
      * Salgspris
     c                   eval      lxlsap = d1spri
      * Kostpris
     c                   eval      lxlkos = d1kpri
      * Gjennomsnitlig kostpris
     c                   eval      lxlgkp = d1snkp
      * Kvantum
     c                   eval      lxlqty = d1behl
      * Salgsverdi
     c                   eval      lxlver = d1omst
      * Kostverdi
     c                   eval      lxlkve = d1kost
      * Gjennomsnitlig kostverdi
     c                   eval      lxlgkv = d1snkt
      * Transaksjonsdato
8.02 c**                 eval      lxlgkv = d1dato
8.02 c                   eval      lxltda = mltrda
      *
     c                   write     lxl1str
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Lag excel fil via coolspool
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     lag_excel     begsr
      *
8.01 c**                 eval      w_sqlwhere = *blanks
8.01 c**                 call      'LL699C_MAI'
8.01 c**                 parm                    w_sqlwhere
8.01 c**                 parm                    w_numm
      *
8.01 c**                 eval      w_exsql = %trim(w_sqlwhere)
8.01 c**                 eval      w_exfil = %trim(w_exfil) + %char(w_time)
      *
8.01 c**                 call      'ASPTOXLSX'
8.01 c**                 parm                    w_exsql
8.01 c**                 parm                    w_exmap
8.01 c**                 parm                    w_exfil
8.01 c**                 parm                    w_extyp
      *
      * NB Krever at det er satt opp server for visning.
      *
8.01 c                   call      'LL699C    '
8.01 c                   parm                    w_sqlwhere
8.01 c                   parm                    w_excel_url
8.01 c                   parm                    w_numm
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Send mail med vedlagt excel fil
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     send_mail     begsr
      *
      * finner mailadresser
      *
     c*    rax9l1_key    setll     rax9l1
     c*    rax9l1_key    reade     rax9l1
     c*                  dow       not %eof
      *
     c*                  if        raik01 = 1
     c*                  eval      ra09l1_ikod = raikod
     c*    ra09l1_key    chain     ra09l1
     c*                  if        %found(ra09l1) and
     c*                            raiema <> *Blank
      *
     c*                  if        p_rec1 = *blank
     c*                  eval      p_rec1 = raiema
     c*                  else
     c*                  if        p_rec2 = *blank
     c*                  eval      p_rec2 = raiema
     c*                  else
     c*                  if        p_rec3 = *blank
     c*                  eval      p_rec3 = raiema
     c*                  endif
     c*                  endif
     c*                  endif
     c*                  endif
     c*                  endif
      *
     c*    rax9l1_key    reade     rax9l1
     c*                  enddo
      *
     c                   eval      p_rec1 = %trim(w_mail)
     c**                 eval      p_rec1 = 'baasa@eg.no'
      *
     c                   eval      p_subj = 'Lagerverdiliste på excel'
     c                   eval      p_txt1 = 'Lagerverdi pr ' + %char(a1datp)
     c                   eval      p_txt2 = *blank
     c                   eval      p_txt3 = *blank
     c                   eval      p_txt4 = 'Med vennlig hilsen'
     c                   eval      p_pers = %trim(l_user)
     c                   eval      p_filn = '/asp/'+l_filg+'/excel/'+
     c                             %trim(w_exfil)
     c                   eval      p_fnav = 'Lagerverdi_' + %char(w_dato) +
     c                                      '_AA' + %char(w_numm)+ '.xlsx'
     c                   eval      p_mime = 'application/vnd.openxmlformats-'
     c                   eval      p_mime = %trim(p_mime)+'officedocument.'
     c                   eval      p_mime = %trim(p_mime)+'spreadsheetml.sheet'
     c                   eval      p_bcc  = *blank
     c                   call      'AF728R'
     c                   parm                    p_rec1
     c                   parm                    p_rec2
     c                   parm                    p_rec3
     c                   parm                    p_subj
     c                   parm                    p_txt1
     c                   parm                    p_txt2
     c                   parm                    p_txt3
     c                   parm                    p_txt4
     c                   parm                    p_avsl
     c                   parm                    p_filn
     c                   parm                    p_fnav
     c                   parm                    p_mime
     c                   parm                    p_bcc
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Rydd opp etter generering
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     rydd_xls      begsr
      *
     c/exec sql
     c+ DELETE FROM LXL1ST WHERE LXLIDE = :w_numm
     c/end-exec
       exec sql commit;
      *
     c* delete from lxl1st where lxlide = :w_numm
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Key for les av vare
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for av overgruppe
      *
     c     vogrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vogrl1_oogr
      *
      * Key for hovedgruppe
      *
     c     vhgrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vhgrl1_hogr
     c                   kfld                    vhgrl1_hhgr
      *
      * Key for undergruppe
      *
     c     vugrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vugrl1_uogr
     c                   kfld                    vugrl1_uhgr
     c                   kfld                    vugrl1_uugr
      *
      *  Key for kontohenvisning
      *
     c     vkhvl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vkhvl1_khev
     c                   kfld                    vkhvl1_klty
     c                   kfld                    vkhvl1_koty
      *
      * Key for les av innkjøpsstatistikk
      *
     c     sistlb_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sistlb_paar
     c                   kfld                    sistlb_vare
      *
      * Key for les av BATCH
      *
     c     lbchl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lbchl1_batc
      *
      * Key for les av sidetabell med varetekst
      *
     c     lwa4l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lwa4l1_akey
      *
      * Key for firmaregister
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for formular-register
      *
     c     aforl1_key    klist
     c                   kfld                    w_ruti
      *
      * Key for les av selgerkode
      *
     c     ra09l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra09l1_ikod
      *
      * Key for les av selgerkode - tillegg
      *
     c     rax9l1_key    klist
     c                   kfld                    w_firm
      *
      * Key for les av bruker
      *
     c     fusrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fusrl1_user
      *
      * Hente inn rutinenavn
      * og meldingstekst
      *
     c                   eval      w_ruti = l_ruti
     c                   eval      w_txt1 = *blank
      *
     c     aforl1_key    chain     aforl1r                            69
      *
      * Parameterliste
      *
     c     *entry        plist
     c                   parm                    w_parm
     c                   eval      p_prec = w_parm
      *
     c                   time                    w_dato
     c                   time                    w_time
     c                   eval      w_firm = l_firm
      *
      * Redigere heading
      *
     c     *dmy          move      w_dato        a1date
     c     *hms          move      w_time        a1time
     c                   eval      a1user = l_user
     c                   eval      a1wsid = l_wsid
     c                   eval      a1firm = l_firm
     c                   eval      a1fnav = l_fnav
      *
      * Lagerverdi pr. dato - finn riktig dato i hht. metode
      *
     c                   select
     c                   when      p_brud = 0
     c                   eval      a1datp = p_dath
     c                   when      p_brud = 1
     c                   eval      w_aarr = uyear
     c                   eval      w_aarr = w_aarr + 10100
     c                   eval      a1datp = w_aarr
     c                   when      p_brud = 2
     c                   exsr      les_batch
     c     *dmy          move      lcedat        a1datp
     c                   endsl
      *
     c                   eval      *in71  = p_sort = 1
     c                   eval      *in72  = p_sort = 2
     c                   eval      *in73  = p_sort = 3
     c                   eval      *in74  = p_sort = 4
     c                   eval      *in75  = p_sort = 5
     c                   eval      *in76  = p_sort = 6
      *
     c                   time                    w_date
      * Vi logger ar utskriftprogrammet har startet
     c                   eval      w_jstat = 10
     c                   eval      w_jtext = 'Utskrift av lagerverdiliste ha+
     c                                       r startet - coolspool'
     c                   call      'AB705R'
     c                   parm                    l_bach
     c                   parm                    w_jstat
     c                   parm                    w_jtext
      *
      *  Hent inn firma/avd. opplysninger dersom
      *  kode for det er satt i rutineregister
      *
     c                   if        l_prfi = 1 or
     c                             l_prfi = 2
     c                   eval      w_prfi = l_prfi
     c                   eval      w_ffir = w_firm
     c                   eval      w_avde = l_avde
      *
     c                   call      'FÅ707R'
     c                   parm                    w_prfi
     c                   parm                    w_ffir
     c                   parm                    w_avde
     c                   parm                    w_fnav
     c                   parm                    w_fad1
     c                   parm                    w_fad2
     c                   parm                    w_fste
     c                   parm                    w_fftx
     c                   parm                    w_tfax
     c                   parm                    w_ftlf
     c                   parm                    w_ffax
     c                   parm                    w_mail
     c                   parm                    w_weba
     c                   endif
      *
     c                   time                    w_dato2
     c                   movel     w_dato2       w_tids            6 0
     c                   move      w_dato2       w_ddmy
     c                   eval      b_sort = *off
     c                   eval      b_tota = *off
     c                   eval      b_deta = *off
      * Hardkoder inn tekst basert på sorteringsbegref
     c                   eval      w_txt1 = 'Sortert pr: '
     c                   if        *in71 = *on
     c                   eval      w_txt2 = 'Varenummer/lager'
     c                   elseif    *in72 = *on
     c                   eval      w_txt2 = 'Varegruppe/Varenummer/+
     c                             lager'
     c                   elseif    *in73 = *on
     c                   eval      w_txt2 = 'Kontohenv./Varenummer/+
     c                             lager'
     c                   elseif    *in74 = *on
     c                   eval      w_txt2 = 'Lager/Varenummer'
     c                   elseif    *in75 = *on
     c                   eval      w_txt2 = 'Lager/Varegruppe/+
     c                             varenummer'
     c                   elseif    *in76 = *on
     c                   eval      w_txt2 = 'Lager/Kontohenv./+
     c                             varenummer'
     c                   else
     c                   move      aftxt1        w_txt2
     c                   endif
     c                   eval      w_txt1 = 'Sortert pr: ' + %trim(w_txt2)
      *
      * Slår opp etter firmainformasjon
      *
     c     afirl1_key    chain     afirl1r
      *
     c                   if        1=2
     c                   open      ll699p
     c                   endif
      *
      * Henter inn løpenummer teller
      *
     c                   eval      w_numm = 0
     c                   eval      w_kode = '0'
     c                   eval      w_fell = 'NXTKLI'
     c                   eval      w_type = *blank
     c                   eval      w_fast = *blank
     c                   eval      w_numm = *zero
      *
     c                   call      'AS100R'
     c                   parm                    w_kode
     c                   parm                    w_firm
     c                   parm                    w_fell
     c                   parm                    w_type
     c                   parm                    w_fast
     c                   parm                    w_numm
      *
      * Endring 7.2d
      * OBS!!  Felles for alle filgrupper og firma
       CallP CO402R('   ':0:0:'NX_EXCEL_URL':
                        co402_verdi1:co402_verdi2);
       if co402_verdi1 = '1';
         w_excel_url = co402_verdi2;
       endif;
      *
     c                   endsr
