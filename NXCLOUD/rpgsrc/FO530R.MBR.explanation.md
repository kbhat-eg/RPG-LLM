# RPG Program FO530R - Invoice Balance Control and Card Blocking

This ILE RPG program is part of an order/invoice management system (ASOFAK) and focuses primarily on controlling invoice balances, handling credit card payments, blocking/unblocking orders, and interacting with subfiles for display and selection. Below is an explanation of the program’s key structure and logic, intended to help new developers get up to speed.

---

## 1. **Program Overview**

- **Purpose:** Manage invoice balance control, specifically for card payments and blocking/unblocking of orders.
- **Major Functions:**  
  - Display and filter invoices/orders in a subfile  
  - Initiate and process requests for card payments ("trekk"/"trekk alle")  
  - Check available balance (saldosjekk)  
  - Remove block codes (release orders)
  - Integrates with several external programs and database tables

---

## 2. **File Declarations / External Resources**

```rpg
ffodtlr     if   e           k disk    rename(fodtpfr:fodtlrr)
fvvarl1     if   e           k disk    rename(vvarpfr:vvarl1r)
...
ffo530d     cf   e             workstn sfile(b1sfl:w_srrn)
f                                      infds(dspfbk)
```
- **Physical/Logical Files:** The `f`-specs define access to various files for orders, invoices, customers, cards, transaction logs, and item master data, often with logical views and renames.
- **Display File:** `fo530d` is used for user interaction, supporting subfiles for invoice/order listings.
- **Feedback Data Structure:** `dspfbk` used for display feedback, such as function key pressed, cursor position, etc.

---

## 3. **Data Definitions**

### Parameters, Fields, and Data Structures
- Parameters for firm, order type, customer, order number, etc. (many `like()` declarations ensure consistent field size).
- Many working variables for subfile management (`w_fcrn`, `w_srrn`, etc.).
- Flags for controlling logic, e.g., `b_requ`, `b_trek`.
- Data structures for constructing request strings and list transmissions for external calls (used with `AP510C`, `AP511C` etc.).
- Indicator usage (`LR` for program end, 10/12/14/15 for subfile handling, 21/22 for cursor, etc.).

---

## 4. **Subfile Management**

### Subfile Display and Navigation

- **Subfiles are used to show a list of orders/invoices and allow the user to select actions.**
- Subroutines for:
  - Creating (`crt_subfile`)
  - Clearing (`clr_subfile`)
  - Paging (`bck_subfile`)
  - Displaying (`dsp_subfile`)
  - Refreshing (`forny`)
  - Positioning (`posisjoner`)

**Workflow Example:**  
1. Subfile gets filled on program start or after a filter.
2. User can navigate via paging or function keys.
3. Actions can be taken on orders in the subfile (see below).

---

## 5. **Main Processing Loop**

### Command/Function Key Handling
```rpg
select
  when *inka
    exsr xf1win   // show filter window
  when *inkm
    exsr xb13win  // show status code info
  when *inkc or *inkl
    goto avslutt  // end program
  when *inke
    exsr forny    // refresh
  when *in10
    exsr crt_subfile // next page
  when *in11
    exsr bck_subfile // previous page
  when *inkg
    exsr trk_alle // "draw all" (process all for payment)
    exsr forny
  when *in21
    *in22 = *on   // go home
endsl
...
exsr subfile      // Handle user-selected rows
```

---

## 6. **User Actions on Orders (within Subfile processing)**

The subfile interaction allows these order-specific choices:

- **2=Vedlikehold:** Maintenance - opens another program for order editing.
- **5=Vis statusinfo:** Show extended status info, e.g., from journal/log.
- **6=Saldosjekk:** Calls subroutine to check available balance on the card.
- **7=Trekk beløp:** Initiates a withdrawal request (calls external system).
- **8=Frigi ordre:** Releases order by clearing the block code.

Each action calls a corresponding subroutine:
- `sjk_saldo` (Check card balance)
- `opr_trekk` and `opr_request` (Setup and send payment request)
- `rel_ordre` (release/unblock order)

Order selection may trigger updates to the database and external system calls.

---

## 7. **Request Construction and External Integration**

### Request String
- A custom data structure is built for requests (`d_requ` etc.), mapping order, customer, amount, and card info into a single string.
- For payment or balance requests, the program calls `AP510C` (for payments) or `AP511C` (for balance checks), passing the constructed string.
- The program can optionally generate or fetch a unique KID (customer identification) for Santander integration.

---

## 8. **Card/Order/Status Checking**

### Validations & Filtering
- Orders are filtered for:
  - Belonging to the chosen firm (company)
  - Being card orders (with correct type and block codes)
  - Having positive amounts
  - Not being already blocked, negative, or unavailable.
  - Passing any user-set filters (customer, order type, department).
- Order status is updated or checked as necessary to ensure business rules are followed.

---

## 9. **MVA (VAT) Calculation**

- The `kalk_mva` subroutine reads each order line, computes item-level VAT (accounting for discounts, order rebates), and accumulates total VAT for the order/invoice.
- Calls external VAT code program (`RS205R`) to determine VAT rates.

---

## 10. **Integration Points**

- The program integrates with multiple external programs for:
  - Card transactions and batch number generation (`AP510C`, `AP511C`, `AS100R`)
  - Order maintenance (`FO500R`)
  - Journal and balance handling (`RS205R`, `FA925R`)
  - Filtered lookups (customers, order types, departments)
  - KID number generation (`FO535R`)
  - Recalculate order totals (`FO730R`)

---

## 11. **Initialization and Key Lists**

- In the `*inzsr` initialization routine, all key lists (`klist`) are defined for various file accesses, creating composite keys for chained reads.
- Also, retrieves configuration from the local data area and may set feature flags (e.g., for KID integration).

---

## 12. **Indicator Handling and Comments**

- The program makes heavy use of RPG classic indicators for flow control, subfile paging, screen fields, and feedback.
- The code is well commented in Norwegian, including revision history and details on field/subfile handling.

---

## 13. **Revision History**

- The top-of-source revision log gives excellent context for bug fixes and feature updates, such as enhancing subfile filters, correcting status handling, updating VAT logic, adding new program calls, etc.

---

## 14. **Summary Table of Key Subroutines**

| Subroutine      | Purpose                                           |
|-----------------|---------------------------------------------------|
| `dsp_subfile`   | Display the current subfile page                  |
| `subfile`       | Handle user actions on a subfile row              |
| `forny`         | Refresh the subfile content                       |
| `crt_subfile`   | Populate subfile based on current position/filter |
| `clr_subfile`   | Clear subfile                                     |
| `posisjoner`    | Position subfile based on filter fields           |
| `sjk_saldo`     | Check available balance on a card                 |
| `opr_trekk`     | Setup withdrawal for a single order               |
| `opr_request`   | Build & send a payment request                    |
| `trk_alle`      | Attempt withdrawal for all qualified orders       |
| `rel_ordre`     | Release an order, removing its block code         |
| `kalk_mva`      | Calculate VAT for an order                        |
| ...             | ...                                               |

---

## 15. **Typical User Flow**

1. **Start:** Subfile shows all valid card orders/invoices.
2. **Filter:** User can filter by customer, order type, or department.
3. **Selection:** For any listed order, the user can:
    - Check status info
    - Check card balance
    - Initiate payment/withdrawal
    - Release the order if blocked
4. **Batch Processing:** User can "draw all" to attempt withdrawal for all shown/discovered orders.
5. **Extensive Validations:** Only correct, eligible orders are processed at each step.

---

# **Takeaways for Developers**

- **Understand Subfile Handling:** Most workflow is subfile-driven, with careful indicator and paging management.
- **External Program Calls are Central:** Card handling, status, and configuration are delegated to other programs.
- **Heavy Use of KLIST/KFLD:** Chained access to files, and custom key structures, are core to performance and data integrity.
- **Business Rules Embedded in Filters:** Many layers of filtering ensure only valid orders/cards are processed (e.g., only credit card orders, positive amounts, matching control codes).
- **VAT Logic is Granular:** VAT is not just a percentage of order total; it's calculated per order line, accounting for multiple discounts and order rebates.
- **Code is Well-documented (in Norwegian):** Leverage comments and revision history to track why features exist or were updated.

---

> **This foundation should help IBM i developers quickly orient themselves with FO530R, its subfile-driven UI, business logic, and integration focus. For any specific sections, further detailed breakdowns can be provided.**