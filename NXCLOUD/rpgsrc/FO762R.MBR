     H/TITLE  ASOFAK: Oppdatering av memo-saldo i kunde-register
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : FO762R
      * Beskrivelse . . : Oppdatering av memo-saldo i kunde-register
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
5.60  * R5.60 091107 AMD  Lagt inn løsning for kontroll av grense for
      *                   almenningsrabatter
6.10  * V6.10 230909 BSA  Lagt inn sporingsfelter
6.11  * V6.10 070510 BSA  Endret i sporingsfelter
6.20  * V6.20 140611 BSA  Memosaldo er flyttet ut til egen fil
6.nu  * V6.30 240614 bof  Gjennomgått mtp. nummerutvidelse
7.01  * MGR   151216 sst  Ber flytende Memosaldo m/ordre pr ant. dager
7.01  *       170117 sst  Hente parameter meosaldo fra afpspf
8.01  * K000  231122 sst  Flyttet ant memo-dager og utv.kreditgrense til  UTVIDET_MEMOSALDO (nx)
8.02  * K000  100223 sst  Justert logikk for bergning av memosldo uten parameter/switch
8.03  *PRG2   220622 BOF  Utvidet prisgruppe fra 1 til 2 posisjoner - COMP
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
6.20 F*rkunlu    UF   E           K DISK    RENAME(RKUNPFR:rkunlur)
6.20 Frkmelu    UF   E           K DISK    RENAME(rkmepfr:rkmelur)
      *
     FFOHEL1    IF   E           K DISK    RENAME(FOHEPFR:FOHEL1R)
8.01 f*afpslr    if   e           k disk    rename(afpspfr:afpslrr)
      *
     D                UDS
      *
6.10 d l_user                911    920
7.01 d  l_filg               931    933
     D  DSSFIR               944    946  0
      *
7.01  * Definering av variabler i nøkler
7.01  *
8.01 d*afpslr_ufil     s                   like(afufil)
8.01 d*afpslr_uide     s                   like(afuide)
7.01  *
      * Definering av variable
      *
     d w_firm          s                   like(fofirm)
7.01  *
7.01 d w_date          s               d   datfmt(*iso)
7.01  *w_utvgrns = utvidelse av memosaldo(Mestergruppen)
7.01 d w_utvgrns       s              2  0
7.01  *w_memodagr = antall dager ordre skal med i memosaldo
7.01 d w_memodagr      s              3  0
7.01 d w_3x            s              3
7.01 d p_fir           s              3
7.01 d p_kun           s              6
      *
7.01 d u_s701          s              1    inz(*off)                            Utvidet memosaldo
7.01  *
7.01  * Definering av eksterne prg
7.01  *
7.01   dcl-s co402_verdi1  char(1);
7.01   dcl-s co402_verdi2  char(2048);
7.01   DCL-PR CO402R EXTPGM('CO402R');
7.01     p_filgrp            char(3)     const;
7.01     p_firm              packed(3:0) const;
7.01     p_lager             packed(2:0) const;
7.01     p_nokkel            char(50)    const;
7.01     p_verdi1            char(1);
7.01     p_verdi2            char(2048);
7.01   END-PR;
7.01  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Nullstiller "memo-saldo" i KUNDE-REGISTER                      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C                   MOVE      *ZERO         KUNNUM
6.20 C**   KUNKEY        SETLL     rkunlur
6.20 C     kunkey        setll     rkmelur
      *
     C     TAG01         TAG
      *
     C                   MOVE      *OFF          *IN90
6.20 C**                 READ      rkunlur                                90
6.20 C                   read      rkmelur                                90
     C     *IN90         CABEQ     *ON           TAG02
     C     RKFIRM        CABNE     KUNFIR        TAG02
      *
     C                   Z-ADD     0             RKMEMS
5.60 c                   z-add     0             rkmema
6.10 c*                  time                    rkedat
6.10 c*                  time                    rketim
6.10 c*                  eval      rkesig = l_user
6.20 c**                 time                    rk2dpt
6.20 c**                 eval      rkepgm = 'FO762R    '
6.20 C**                 UPDATE    rkunlur
6.20 C                   update    rkmelur
      *
     C                   GOTO      TAG01
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Oppdaterer KUNDE-REGISTER med ny "memo-saldo"                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     TAG02         TAG
      *
     C     HEDKEY        SETLL     FOHEL1R
      *
     C     TAG03         TAG
      *
     C                   SETOFF                                           90
     C                   READ      FOHEL1R                                90
     C     *IN90         CABEQ     *ON           XSLUTT
     C     FOFIRM        CABNE     HEDFIR        XSLUTT
      *
      *  Beregner justeringsbeløp
      *
8.02 c                   if        (   u_s701 = *on
8.02 c                             and foldat < w_date)
8.02 c                             or  u_s701 = *off
     C     FOTOTS        SUB       FOTOTR        WPSALD
5.60 c     fobrra        SUB       0             wpsal2
      *
      *  Kaller opp subrutine for oppdatering av memosaldo
      *
     C                   CALL      'FA922R'
     C                   PARM                    w_firm
     C                   PARM                    FOOTYP
     C                   PARM                    FOKUND
     C                   PARM                    WPSALD
5.60 C                   parm                    wpsal2
      *
8.02 c*                  endif
7.01 c                   endif
      *
     C                   GOTO      TAG03
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Avslutt program                                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     XSLUTT        TAG
      *
     C                   SETON                                        LR
     C                   RETURN
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Subrutine for initiering av program                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     CSR   *INZSR        BEGSR
      *
      *  Nullstilling av felter som ikke kan redefineres
      *
     C                   MOVE      *ZERO         WPSALD           11 2
5.60 c                   move      0             wpsal2           11 2
      *
      *  Redefinering av nøkler
      *
     C     *LIKE         DEFINE    RKFIRM        KUNFIR
     C     *LIKE         DEFINE    RKKUND        KUNNUM
      *
     C     *LIKE         DEFINE    FOFIRM        HEDFIR
     C     *LIKE         DEFINE    FONUMM        HEDNUM
     C     *LIKE         DEFINE    FOSUFF        HEDSUF
      *
      *  Key for file : KUNDE-REGISTER
      *
     C     KUNKEY        KLIST
     C                   KFLD                    KUNFIR
     C                   KFLD                    KUNNUM
      *
      *  Key for file : ORDRE-HODE-REGISTER
      *
     C     HEDKEY        KLIST
     C                   KFLD                    HEDFIR
     C                   KFLD                    HEDNUM
     C                   KFLD                    HEDSUF
7.01  *
7.01  * Key for propertiesfil
7.01  *
8.01 c*    afpslr_key    klist
8.01 c*                  kfld                    afpslr_ufil
8.01 c*                  kfld                    afpslr_uide
      *
      *  Legger inn firmanummer i nøkklene
      *
     C                   MOVE      DSSFIR        KUNFIR
     C                   MOVE      DSSFIR        HEDFIR
      *
     c                   eval      w_firm = dssfir
      *
7.01  *
7.01  *   Hent inn % utvidelse av kreditgrense
8.01 c*                  eval      afpslr_ufil = l_filg
8.01 c*                  eval      afpslr_uide = 'KRGRNSUTV'
8.01 c*    afpslr_key    chain     afpslrr
8.01 c*                  if        %found(afpslr)
8.01 c*                  movel     afudss        w_utvgrns
8.01 c*                  endif
7.01  *
7.01  *   Hent inn ant dager fram ordre skal med i memosaldo
8.01 c*                  eval      afpslr_uide = 'MEMODAGER'
8.01 c*    afpslr_key    chain     afpslrr
8.01 c*                  if        %found(afpslr)
8.01 c*                  movel     afudss        w_3x
8.01 c*                  move      w_3x          w_memodagr
8.01 c*                  endif
7.01  *
7.01  *
7.01  * Sjekker med uvtiodet memosaldo
8.01  *   Hent inn % utvidelse av kreditgrense
8.01  *   Hent inn ant dager fram ordre skal med i memosaldo
7.13  *
8.01 c                   eval      w_memodagr = 999
8.01 c                   eval      w_utvgrns  = 0
7.01  *
8.01   CallP CO402R(l_filg:w_firm:0:'UTVIDET_MEMOSALDO':
7.01   co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     u_s701 = *on;
8.01     if  %subst(co402_verdi2:1:3) <> *blank;
8.01       w_memodagr = %dec(%subst(co402_verdi2:1:3):3:0);
8.01     endif;
8.01     if  %subst(co402_verdi2:133:2) <> *blank;
8.01       w_utvgrns = %dec(%subst(co402_verdi2:133:2):2:0);
8.01     endif;
7.01   endif;
7.01  *
7.01 c                   move      udate         w_date
7.01 c                   adddur    w_memodagr:*d w_date
7.01  *
     CSR                 ENDSR
