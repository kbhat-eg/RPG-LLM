## Program Overview

This program, **FO780R**, is responsible for calculating the total weight (in kilograms) and volume (in cubic meters) for all items in a given sales order. It processes only stocked and special-order items. The program attempts to retrieve weight and volume data from the primary inventory file (EVR) and, if not found, falls back to alternative sources (VA). If weight or volume information is missing for any item, an exception flag is returned.

### Key Business Rules

- Handles only physical goods (not services or miscellaneous items).
- If item weight/volume is unavailable in the main file, checks alternative sources.
- Returns a flag if any item's weight or volume could not be determined.
- Supports extended decimal precision for volume calculations.
- Integrates with the price group subsystem via a call to program `VL710R`.

## File Relationships

- **fodtl1**: Order line details (primary driver for the calculation loop).
- **vvarl1**, **vvasl1**: Item master files (main and alternative).
- **vvenl1**: Item unit-of-measure details (for weight/volume on specific unit).
- **jvpkl2**: Packaging information (alternative source for weight/volume).
- **vvlel1**: Additional item info (used for extended business logic).

## Parameter Definitions

- `p_firm`, `p_numm`, `p_suff`: Identifiers for the company, order number, and order suffix.
- `p_vekt`, `p_volu`: Output parameters for total weight and volume.
- `p_avvi`: Output flag; set if any item is missing weight or volume data.
- `p_vtyp`: (Internal) Item type as determined by price group logic.

## Main Processing Flow

1. **Initialization:**  
   Output parameters for weight and volume are set to zero. The exception flag is cleared.

2. **Order Line Processing:**  
   - Loops through all lines in the specified order.
   - For each item, invokes the `kalkuler` subroutine to process weight and volume.

3. **Finalization:**  
   - If any item was missing weight or volume, sets the exception flag.
   - Program ends, returning calculated values and flag.

## Subroutine: `kalkuler`

This subroutine is the core of the calculation logic for each order line.

### Steps:

1. **Reset Local Variables:**  
   Clears temporary storage for weight, volume, and price group type.

2. **Item Lookup:**  
   - Attempts to find the item in the main (`vvarl1`) or alternative (`vvasl1`) item master file.
   - Calls `VL710R` to determine the price group/type and retrieve additional item data.

3. **Item Type Handling:**  
   - If the item is a service (`p_vtyp = 'T'`), the subroutine exits early.
   - If the item is a miscellaneous type (`p_vtyp = 'D'`), sets the exception flags and exits.

4. **Weight/Volume Retrieval:**  
   - Tries to retrieve weight/volume from the unit-of-measure table (`vvenl1`).
   - If not found or if values are zero, attempts to retrieve from packaging info (`jvpkl2`).
   - Weight is adjusted for unit conversions if necessary (see version history for changes).

5. **Result Handling:**  
   - If weight or volume is still missing after all lookups, sets the respective exception flags.
   - Sums the line's weight and volume (multiplied by quantity) into the running totals.

## Error Handling

- The program has a PSSR subroutine that resets output values to zero and terminates if an unhandled exception occurs.

## Initialization (`*inzsr`)

- Entry parameters are mapped to local variables.
- Key lists for all file access patterns are constructed for efficient indexed lookup.

## Notable Design Decisions & Conventions

- **Fallback Logic:** The program is robust against missing data, using multiple sources in a prioritized sequence.
- **Price Group Integration:** Calls to `VL710R` are used to classify items and enrich lookup criteria, which can affect whether an item is processed or skipped.
- **Exception Flagging:** Rather than failing on missing data, the program flags the condition and continues, ensuring a complete audit of the order.
- **Versioned Enhancements:** The code is annotated with version numbers and comments to clarify the rationale for changes (e.g., increased decimal precision, new key fields, business rule changes).
- **Domain-Specific Naming:** Many variables and files use Norwegian abbreviations and conventions consistent with the company's ERP system.

## External Interactions

- **VL710R:** Called for price group/type determination and to fetch additional item metadata. Its output directly influences the calculation logic.
- **Data Files:** All files are assumed to be part of the company's inventory and sales order subsystem, with consistent keying on company, item, and unit.

## Summary Table: Key Files and Their Roles

| File      | Role/Usage                                             |
|-----------|--------------------------------------------------------|
| fodtl1    | Order lines (primary driver for calculation)           |
| vvarl1    | Item master (main source for item data)                |
| vvasl1    | Item master (alternative source)                       |
| vvenl1    | Item/unit details (primary for weight/volume)          |
| jvpkl2    | Packaging info (secondary for weight/volume)           |
| vvlel1    | Supplementary item info (used in extended logic)       |

## Key Points for New Developers

- The program is central to logistics and fulfillment, ensuring accurate shipping calculations.
- Always check the version history in comments for recent business rule changes.
- When modifying logic, consider the multi-source fallback pattern for data reliability.
- Be aware of the price group/type logic, as it can affect which items are included in calculations.
- If integrating with new files or APIs, update the key lists and initialization routines accordingly.

---

**Note:** For more detailed field-level mappings or file layouts, refer to the data dictionary or the respective physical/logical file definitions in the ERP system.