      /TITLE  ASLAGR: Lagertelling
7.01 h option(*nodebugio) datedit(*dmy-) decedit('0.')
7.01 h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
7.01  /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASLAGR
      * Program . . . . : LE603R
      * Beskrivelse . . : Utskrift av telle-liste, Utskriften
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       120900 ASK  Programmet helt omskrevet etter ny standard.
      *       301007 bof  Hvis syklisk telling skrives abc-kode ut
5.70  * prgr  021208 bof  Utvidet med prisgruppe
      * 6.10  150609 BSA  Oppdatert med sporingsinformasjon
6.20  * 6.20  130511 ASK  Lagt inn ekstra sorteringsvalg, samt nye
      *                   sorteringsbeskrivelser i printfile.
6.21  * 6.20  190511 bof  Henter utg. fra lager - utvidet paramter
6.22  * 6.20  100112 bof  Hvis sykl tell og alt.lagplass så på lista
6.nu  * 6.30  170614 bof  endret ihht. nummerutvidelse
6.30  * 6.30  170918 bkv  Utvidet med trelast sortiment
7.01  * 6.30  211216 bsa  Innfører PDF og listevalg på excel
7.02  * 6.30  030117 bsa  Må takle også hvis det ikke finnes linjer
7.03  * 6.30  181017 bsa  Legger ut enhet på tellelista
7.04  * 6.30  171219 bkv  Økt variabel fra 50 til 200. Tekst ble kuttet i xml
8.01  *       230222 BOF  setter letims ut fra batch til dato /tid
8.02  *PRG2   150622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner

      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flpstl2    if   e           k disk    rename(lpstpfr:lpstl2r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
     flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
     flbchlu    uf   e           k disk    rename(lbchpfr:lbchlur)
     fltellu    uf a e           k disk    rename(ltelpfr:ltellur)
     fltell1    if   e           k disk    rename(ltelpfr:ltell1r)
     fltell2    if   e           k disk    rename(ltelpfr:ltell2r)
7.01 fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
7.02 frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
6.30 fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
      *
     fle603p    o    e             printer
7.01 f                                     usropn
      *
      * Datastruktur for parameterliste
      *
     d                 ds
     d d_prec                       128
     d  d_batc                       10    overlay(d_prec)
     d  d_fvar                       15    overlay(d_prec:11)
     d  d_tvar                       15    overlay(d_prec:26)
     d  d_fogr                        2  0 overlay(d_prec:41)
     d  d_togr                        2  0 overlay(d_prec:43)
     d  d_fhgr                        2  0 overlay(d_prec:45)
     d  d_thgr                        2  0 overlay(d_prec:47)
     d  d_fugr                        3  0 overlay(d_prec:49)
     d  d_tugr                        3  0 overlay(d_prec:52)
     d  d_fpla                        8    overlay(d_prec:55)
     d  d_tpla                        8    overlay(d_prec:63)
     d  d_flag                        2  0 overlay(d_prec:71)
     d  d_tlag                        2  0 overlay(d_prec:73)
     d  d_list                        1  0 overlay(d_prec:75)
     d  d_hovd                        1  0 overlay(d_prec:76)
     d  d_val1                        1  0 overlay(d_prec:77)
     d  d_val2                        1  0 overlay(d_prec:78)
     d  d_val3                        1  0 overlay(d_prec:79)
     d  d_opda                        6  0 overlay(d_prec:80)
     d  d_vtyp                        1    overlay(d_prec:86)
     d  d_pans                        4    overlay(d_prec:87)
     d  d_levr                        6  0 overlay(d_prec:92)
     d  d_sykl                        1  0 overlay(d_prec:98)
      *
      *  Local Data Area
      *
     d                uds
7.01 d l_poff                584    584
7.01 d l_utqm                585    594
7.01 d l_bach                595    635
7.01 d l_arch                636    636  0
7.01 d l_skje                637    637  0
7.01 d l_exlp                639    639  0
7.01 d l_mail                640    640  0
7.01 d l_prfi                750    750  0
     d l_ruti                800    809
7.01 d l_outq                810    819
7.01 d l_copy                838    843  0
     d l_wsid                901    910
     d l_user                911    920
7.01 d l_filg                931    933
     d l_firm                944    946  0
7.01 d l_avde                947    950  0
     d l_fnav                951    980
      *
      * Definering av variable i nøkler
      *
     d aforl1_ruti     s                   like(afruti)
     d vvarl1_vare     s                   like(vvvare)
     d vlagl1_lage     s                   like(vllage)
     d vlagl1_vare     s                   like(vlvare)
     d lbchlu_batc     s                   like(lcbatc)
     d ltellu_batc     s                   like(lebatc)
     d ltellu_line     s                   like(leline)
     d ltellu_numm     s                   like(lenumm)
     d ltellu_suff     s                   like(lesuff)
     d ltell2_batc     s                   like(lebatc)
     d ltell2_lage     s                   like(lelage)
     d ltell2_numm     s                   like(lenumm)
     d ltell2_suff     s                   like(lesuff)
     d ltell2_vare     s                   like(levare)
7.02 d rlevl1_levr     s                   like(rllevr)
      *
      * Definering av variable
      *
     d w_firm          s                   like(lefirm)
     d w_enhe          s                   like(leenh1)
     d w_lage          s                   like(lelage)
     d w_plas          s                   like(leplas)
     d w_ogrp          s                   like(leogrp)
     d w_dato          s               d   datfmt(*iso)
     d w_inlr          s              1
     d w_lety          s              1  0
     d w_sapr          s              9  2
     d w_bupr          s              9  2
     d w_inpr          s              9  2
     d w_kopr          s              9  2
     d w_fast          s             10
     d w_fell          s              6
     d w_kode          s              1
     d w_line          s              6  0
6.nu d w_numm          s              8  0
     d w_tell          s              6  0
     d w_type          s              2
     d w_parm          s            128
6.30 d w_lv_nobb       s                   like(vvlnob)
6.30 d w_lv_modn       s                   like(vvlmod)
6.30 d w_lv_lldo       s                   like(vvlnle)
6.30 d w_lv_llva       s                   like(vvllva)
7.01 d d_ldor          s              6  0
7.01 d d_ltxt          s             30
      *
5.70 d w_vtyp          s                   like(vvvtyp)
8.02 d w_prgr          s              2
5.70 d w_avde          s              4  0
6.21 d w_utda          s               d   datfmt(*iso)
6.21 d w_ldor          s                   like(vvldor)
7.01 d p_mail          s              1
7.01 d p_kund          s              6  0
7.01 d p_kpro          s              6  0
7.01 d p_numm          s              8  0
7.01 d p_suff          s              2  0
7.01 d p_selg          s              4  0
7.01 d p_serv          s             35
7.01 d p_stat          s              1
7.01 d p_kule          s              1
7.01 d p_navn          s             30
7.01 d p_emal          s             50
7.01 d p_ema2          s             50
7.01 d p_ema3          s             50
7.01 d p_kopi          s             50
7.01 d p_emne          s             50
7.01 d p_txt1          s             50
7.01 d p_txt2          s             50
7.01 d p_txt3          s             50
7.01 d p_txt4          s             50
7.01 d p_pers          s             50
7.01 d p_inif          s             40
7.01 d p_in03          s              1
7.01 d p_btyp          s            100
7.01 d p_ok            s              1
7.01 d p_lr            s              1
7.01 d p_str_in        s            512
7.01 d p_str_out       s            512
7.01 d p_filg          s             10
7.01 d p_xmlf          s            256
7.01 d w_tek1          s             75
7.01 d w_ltxt          s             75
7.01 d w_lnav          s             50
7.01 d w_mvak          s              3
7.01 d w_dspl          s            100
7.01 d w_jkey          s             41
7.01 d w_jstat         s              2  0
7.01 d w_jtext         s            200
7.01 d w_pdf           s              1  0
7.01 d w_pdf_ds        s            512
7.01 d w_rtyp          s             50
7.01 d w_dato2         s             12  0
7.01 d w_ddmy          s              6  0
7.01 d w_tids          s              6  0
7.01 d w_ruti          s             10
7.01 d w_txt1          s             75
7.01 d w_mime          s             40
7.01 d w_date          s               d   datfmt(*iso)
7.01 d w_1fnav         s             50
7.01 d w_1fad1         s             50
7.01 d w_1fad2         s             50
7.01 d w_prfi          s              1  0
7.01 d w_ffir          s              3  0
7.01 d w_fnav          s             30
7.01 d w_fad1          s             30
7.01 d w_fad2          s             30
7.01 d w_fste          s             30
7.01 d w_fftx          s             30
7.01 d w_tfax          s              8
7.01 d w_ftlf          s             11
7.01 d w_ffax          s             11
7.01 d w_mail          s             50
7.01 d w_weba          s             50
7.01 d w_pemne         s             75
7.01 d w_ptxt1         s             75
7.01 d w_ptxt2         s             75
7.01 d w_ptxt3         s             75
7.01 d w_ptxt4         s             75
7.01 d w_ppers         s             75
7.01 d w_pavd          s              4  0
7.01 d w_mtxt          s            300
7.01 d h_valu          s             15
7.04 d d_valu          s            200
7.01 d d_type          s             10
      *
8.01 d                 ds
8.01 d d_stmp                        26
8.01 d  d_dato                       10d   overlay(d_stmp)
8.01 d  d_ski1                        1    overlay(d_stmp:11) inz('-')
8.01 d  d_time                        8t   overlay(d_stmp:12)
8.01 d  d_ski2                        1    overlay(d_stmp:20) inz('.')
8.01 d  d_zero                        6    overlay(d_stmp:21) inz('000000')
      *
6.21 d b_inlr          s              1    inz(*off)
7.01 d b_excl          s              1    inz(*off)
7.02 d b_anta          s              1    inz(*off)
      *
7.01 d splfname2       s             10a
7.01 d jobname2        s             10a
7.01 d username2       s             10a
7.01 d jobnbr2         s              6a
7.01 d splfnbr2        s             10i 0
7.01 d splfname3       s             10a
7.01 d jobname3        s             10a
7.01 d username3       s             10a
7.01 d jobnbr3         s              6a
7.01 d splfnbr3        s             10i 0
7.01 d p_tagg0         s             20
7.01 d p_tagg0val      s             50
7.01 d p_tagg1         s             20
7.01 d p_tagg1val      s             50
7.01 d p_tagg2         s             20
7.01 d p_tagg2val      s             50
7.01 d p_tagg3         s             20
7.01 d p_tagg3val      s             50
7.01 d p_tagg4         s             20
7.01 d p_tagg4val      s             50
7.01 d p_tagg5         s             20
7.01 d p_tagg5val      s             50
7.01 d p_tagg6         s             20
7.01 d p_tagg6val      s             50
7.01 d p_tagg7         s             20
7.01 d p_tagg7val      s             50
7.01 d p_tagg8         s             20
7.01 d p_tagg8val      s             50
7.01 d p_tagg9         s             20
7.01 d p_tagg9val      s             50
7.01 d p_refn          s             50
7.01 d p_dspl          s            100
7.01  *
7.01 d qsprilsp        pr                  extpgm('QSPRILSP')
7.01 d rcvvar                     32767a   options(*varsize)
7.01 d rcvvarlen                     10i 0 const
7.01 d format                         8a   const
7.01 d errorcode                  32767a   options(*varsize)
7.01  *
7.01 d sprl0100        ds
7.01 d  bytesrtn                     10i 0
7.01 d  bytesavl                     10i 0
7.01 d  splfname                     10a
7.01 d  jobname                      10a
7.01 d  username                     10a
7.01 d  jobnbr                        6a
7.01 d  splfnbr                      10i 0
7.01 d  systemname                    8a
7.01 d  createdate                    7a
7.01 d                                1a
7.01 d  createtime                    6a
7.01  *
7.01 d errorcode       ds
7.01 d  bytesprov                    10i 0 inz(0)
7.01 d  byteavail                    10i 0 inz(0)
      *
7.01  *
7.01 d XML_Output      s            256a   Varying
7.01 d XML_path        s            256a   Varying
7.01 d                                     Inz('/home/asp/print/adb')
7.01 d jasper_mal      s            256a
7.01 d jasper_logo     s            256a   varying
7.01 d tmpdate         s               D
7.01 d tmptime         s               T
7.01 d crlf            c                   const(X'0d25')
7.01  *
7.01 d d_pdf_ds        ds
7.01 d  d_xmlm                       75
7.01 d  d_jasm                       75
7.01 d  d_logo                       75
7.01 d  d_path                      100
7.01 d  d_emal                       50
7.01 d  d_fifo                       75
7.01 d  d_fkop                        1
7.01 d  d_dtaq                        1
7.01 d  d_sign                        1
7.01  /copy prototypeb
7.01  /copy usec
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Utfør innledende behandling
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c                   exsr      inl_beh
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av uplukksfil
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     lpstl2_key    setll     lpstl2
     c     lpstl2_key    reade     lpstl2                                 91
5.70  *
5.70  * Kaller program for henting av prisgruppe
5.70  *
5.70 c                   eval      w_avde = 0
5.70 c                   call      'VL712R'
5.70 c                   parm                    w_firm
5.70 c                   parm                    lzlage
5.70 c                   parm                    w_avde
5.70 c                   parm                    w_prgr
      *
     c                   eval      w_lage = lzlage
     c                   eval      w_plas = lzplas
     c                   eval      w_ogrp = lzogrp
      *
     c                   dow       *in91 = *off
      *
      *  Sjekk, Finnes denne varen i telle-register fra før
      *
     c                   if        d_hovd = 1
     c                   eval      ltell2_vare = lzvare
     c                   eval      ltell2_lage = lzlage
     c     ltell2_key    setll     ltell2
     c     ltell2_key    reade     ltell2                                 90
     c                   if        *in90 = *off
     c                   goto      les_neste
     c                   endif
     c                   endif
      *
      *  Til neste linjenummer
      *
     c                   eval      w_line = w_line + 1
     c                   eval      ltellu_line = w_line
     c     ltellu_key    chain     ltellu                             94
      *
      *  Legger inn opplysninger
      *
     c                   eval      ledlop = 0
     c                   eval      leogrp = lzogrp
     c                   eval      lehgrp = lzhgrp
     c                   eval      leugrp = lzugrp
     c                   eval      levare = lzvare
     c                   eval      lelage = lzlage
     c                   eval      leplas = lzplas
     c                   eval      letek1 = lztek1
     c                   eval      leenh1 = lzenh1
     c                   eval      leantt = 0
     c                   eval      leantl = lzantl
     c                   eval      leantb = 0
8.01 c                   eval      d_dato = lcedat
8.01 c                   eval      d_time = lcetim
8.01 c                   eval      letims = %timestamp(d_stmp)
      *
      *  Henter inn priser
      *
     c                   exsr      hntpri
     c                   eval      lespny = w_sapr
     c                   eval      lekpny = w_kopr
5.70  *
5.70  * Kaller program for henting av varetype
5.70  *
5.70 c                   call      'VL710R'
5.70 c                   parm                    w_firm
5.70 c                   parm                    lzvare
5.70 c                   parm                    lzlage
5.70 c                   parm                    w_vtyp
6.21 c                   parm                    w_utda
6.21 c                   parm                    w_ldor
6.21 c                   parm                    b_inlr
6.30 c                   parm                    w_lv_nobb
6.30 c                   parm                    w_lv_modn
6.30 c                   parm                    w_lv_lldo
6.30 c                   parm                    w_lv_llva
      *
      *  Sjekker om diversevare - blir ike lagt ut på tellefil/liste.
      *  Skaffevarer med salgsprispris < 0,02 håndteres som diversevarer.
      *
5.70 c                   if        w_vtyp = 'D' or
5.70 c                             w_vtyp = 'S' and w_sapr < 0,02
     c                   goto      les_neste
     c                   endif
      *
      *  Oppdaterer register
      *
     c                   if        *in94 = *on
     c                   eval      lefirm = w_firm
     c                   eval      lebatc = ltellu_batc
     c                   eval      lenumm = ltellu_numm
     c                   eval      lesuff = ltellu_suff
     c                   eval      leline = ltellu_line
6.10 c                   time                    leodat
6.10 c                   time                    leotim
6.10 c                   eval      leousr = l_user
6.10 c                   time                    leedat
6.10 c                   time                    leetim
6.10 c                   eval      leeusr = l_user
     c                   write     ltellur
     c                   endif
7.01  *
7.01  * Nullstiller alle "gamle" verdier, så de ikke skal ligge igjen i regneark
7.01  *
7.01 c                   if        b_excl = *on
7.01 c                   exsr      exc_clear
7.01 c                   endif
      *
      *  Legger inn data i utskrifts-felter
      *
     c                   eval      d1line = leline
     c                   eval      d1lage = lelage
     c                   eval      d1plas = leplas
     c                   eval      d1vare = levare
     c                   eval      d1var1 = levare
     c                   if        d_sykl = 1
     c                   eval      d1kabc = vltabc
     c                   else
     c                   eval      d1kabc = *blank
     c                   endif
     c                   eval      d1tek1 = letek1
     c                   eval      d1enh1 = leenh1
     c                   eval      d1antl = leantl
      *
      *  Test på om antall skal ut på lista
      *
     c                   if        d_val1 <> 1
     c                   eval      d1antl = 0
     c                   endif
      *
      *  Sorteringsvalg 1,3 og 5 skal gi sideskift ved brudd
      *
     c                   if        d_val3 = 1 and
     c                             lzlage <> w_lage
     c                   exsr      ovflow
     c                   eval      w_lage = lzlage
     c                   eval      w_plas = lzplas
     c                   eval      w_ogrp = lzogrp
     c                   endif
      *
     c                   if        d_val3 = 1 and
     c                             lzogrp <> w_ogrp
     c                   exsr      ovflow
     c                   eval      w_ogrp = lzogrp
     c                   endif
      *
     c                   if        d_val3 = 3 and
     c                             lzlage <> w_lage
     c                   exsr      ovflow
     c                   eval      w_lage = lzlage
     c                   eval      w_plas = lzplas
     c                   endif
      *
     c                   if        d_val3 = 5 and
     c                             lzlage <> w_lage
     c                   exsr      ovflow
     c                   eval      w_lage = lzlage
     c                   eval      w_plas = lzplas
     c                   endif
      *
     c                   if        d_val3 = 5 and
     c                             lzplas <> w_plas
     c                   exsr      ovflow
     c                   eval      w_plas = lzplas
     c                   endif
      *
      *  Skriv ut deltaljer til lista
      *
7.01 c                   if        b_excl = *on
7.01 c                   exsr      xml_detal
7.01 c                   else
     c                   write     d1det                                30
     c                   if        *in30 = *on
     c                   exsr      ovflow
     c                   endif
7.01 c                   endif
6.22  *
6.22  *  Hvis syklisk telling og alt plass 1 og 2 er utfylt
6.22  *
6.22 c                   if        d_sykl = 1
6.22 c                   if        vlpla1 <> *blank or
6.22 c                             vlpla2 <> *blank
6.22 c                   eval      d2line = d1line
6.22 c                   eval      d2lage = d1lage
6.22 c                   eval      d2pla1 = vlpla1
6.22 c                   eval      d2pla2 = vlpla2
7.01 c                   if        b_excl = *off
6.22 c                   write     d2det                                30
6.22 c                   if        *in30 = *on
6.22 c                   exsr      ovflow
6.22 c                   endif
7.01 c                   endif
6.22 c                   endif
6.22 c                   endif
     c
      *
     c     les_neste     tag
     c     lpstl2_key    reade     lpstl2                                 91
     c                   enddo
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     end_pgm       tag
7.01  * Generer xml for videre utskrift
7.01 c                   if        l_poff = '1' and
7.01 c                             b_excl = *off
7.01 c                   exsr      spoolnbr
7.01 c                   exsr      xml_create
7.01 c                   close     le603p
7.01 c                   exsr      pdf_preview
7.01 c                   endif
7.01  * Excel rapport
7.01 c                   if        l_poff = '1' and
7.01 c                             b_excl = *on
7.02  * Sjekk om det er lagd linjer
7.02 c                   if        b_anta = *off
7.02 c                   exsr      xml_det_dum
7.02 c                   endif
7.01 c                   exsr      xml_end
7.01  * Hvis EXCEL må vi forhåndsvise linken, slik at vi får den opp i browser
7.01 c                   exsr      pdf_preview
7.01 c                   endif
7.01  * Avslutt jobbiden
7.01 c                   if        l_poff = '1'
7.01 c                   call      'AB710R'
7.01 c                   parm                    l_bach
7.01 c                   endif
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *    Utfør innledende behandling og sett startverdier
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     inl_beh       begsr
      *
     c                   eval      w_tell = 0
     c                   eval      w_line = 0
      *
      *  Behandling av BATCH-REGISTER
      *
     c                   eval      lbchlu_batc = d_batc
     c     lbchlu_key    chain     lbchlur                            93
     c                   eval      ltellu_numm = lcnumm
     c                   eval      ltellu_suff = 0
      *
      *  Dersom hovedliste, Hent neste listenummer
      *
     c                   if        ltellu_numm = 0
     c                   if        d_hovd = 1
     c                   eval      w_kode = '0'
     c                   eval      w_numm = 0
     c                   eval      w_fell = laatel
     c                   exsr      hntnum
     c                   eval      lcnumm = w_numm
     c                   eval      ltellu_numm = w_numm
     c                   endif
     c                   endif
      *
      *  Oppdaterer Batch-register
      *
     c                   if        *in93 = *off
6.10 c                   time                    lceeda
6.10 c                   time                    lceeti
6.10 c                   eval      lceusr = l_user
     c                   update    lbchlur
     c                   endif
      *
      *  Dersom subliste, beregn neste sublistenummer
      *
     c                   if        d_hovd = 0
     c                   exsr      hntsuf
     c                   eval      ltellu_suff = w_tell
     c                   endif
      *
      *  Dersom hoved-liste, hent siste linjenummer
      *
     c                   if        ltellu_suff = 0
     c                   exsr      hntlin
     c                   endif
      *
      *  Legger inn opplysninger
      *
     c                   eval      ltell2_numm = ltellu_numm
     c                   eval      ltell2_suff = ltellu_suff
      *
      *  Legger inn data i utskrifts-felter
      *
     c                   eval      a1numm = ltellu_numm
     c                   eval      a1suff = ltellu_suff
      *
     c                   exsr      pparam
      *
      *  Skriver heading
      *
7.01 c                   if        b_excl = *off
     c                   write     a1hdr                                30
7.01 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  OVFLOW    Behandling av overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     ovflow        begsr
      *
      *  Skriver heading
      *
7.01 c                   if        b_excl = *off
     c                   write     a1hdr                                30
7.01 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter opplysninger om varen
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hntpri        begsr
      *
      *  Henter fram data fra vare- og lager-registeret
      *
     c                   eval      vvarl1_vare = levare
     c     vvarl1_key    chain     vvarl1
     c                   eval      vlagl1_vare = levare
     c                   eval      vlagl1_lage = lelage
     c     vlagl1_key    chain     vlagl1
      *
      * Initiering av variable
      *
     c                   eval      w_sapr = 0
     c                   eval      w_bupr = 0
     c                   eval      w_kopr = 0
     c                   eval      w_inpr = 0
      *
     c                   eval      w_enhe = leenh1
      *
     c                   eval      w_lety = 0
     c                   eval      w_inlr = ' '
     c                   eval      w_dato = lcbdat
      *
      * Henter og beregner prisgrunnlag fra vareregisteret
      *
     c                   call      'VP701R'
     c                   parm                    w_firm
     c                   parm                    levare
5.70 c                   parm                    w_prgr
     c                   parm                    w_enhe
     c                   parm                    w_lety
     c                   parm                    w_dato
     c                   parm                    w_inlr
     c                   parm                    w_sapr
     c                   parm                    w_bupr
     c                   parm                    w_kopr
     c                   parm                    w_inpr
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter siste sublistenummer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hntsuf        begsr
      *
      *  Hent sist brukte sublistenr. og legg inn i teller
      *
     c                   eval      w_tell = 0
      *
     c                   eval      ltellu_suff = 999999
     c                   eval      ltellu_line = 999999
     c     ltellu_key    setll     ltell1r
     c                   eval      *in90 = *off
     c                   readp     ltell1r                                90
     c                   if        *in90 = *off and
     c                             lefirm = w_firm and
     c                             lebatc = ltellu_batc and
     c                             lenumm = ltellu_numm
     c                   eval      w_tell = lesuff
     c                   eval      w_tell = w_tell + 1
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter siste linjenummer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hntlin        begsr
      *
      *  Hent sist brukte linjenummer og legg inn i teller
      *
     c                   eval      w_line = 0
      *
     c                   eval      ltellu_line = 999999
     c     ltellu_key    setll     ltell1r
     c                   eval      *in90 = *off
     c                   readp     ltell1r                                90
     c                   if        *in90 = *off and
     c                             lefirm = w_firm and
     c                             lebatc = ltellu_batc and
     c                             lenumm = ltellu_numm and
     c                             lesuff = ltellu_suff
     c                   eval      w_line = leline
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter/Oppdatering av NUMMER-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hntnum        begsr
      *
     c                   eval      w_type = *blank
     c                   eval      w_fast = *blank
      *
      *  Kaller opp subprogram for henting av nummer fra NUMMER-REGISTER
      *
     c                   call      'AS100R'
     c                   parm                    w_kode
     c                   parm                    w_firm
     c                   parm                    w_fell
     c                   parm                    w_type
     c                   parm                    w_fast
     c                   parm                    w_numm
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  PPARAM    Utskrift av parameter-liste
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     pparam        begsr
      *
     c                   eval      z1numm = ltellu_numm
     c                   eval      z1suff = ltellu_suff
      *
     c                   eval      z1opda = d_opda
     c                   eval      z1vtyp = d_vtyp
     c                   eval      z1batc = d_batc
     c                   eval      z1fvar = d_fvar
     c                   eval      z1tvar = d_tvar
     c                   eval      z1fogr = d_fogr
     c                   eval      z1togr = d_togr
     c                   eval      z1fhgr = d_fhgr
     c                   eval      z1thgr = d_thgr
     c                   eval      z1fugr = d_fugr
     c                   eval      z1tugr = d_tugr
     c                   eval      z1fpla = d_fpla
     c                   eval      z1tpla = d_tpla
     c                   eval      z1flag = d_flag
     c                   eval      z1tlag = d_tlag
     c                   eval      z1pans = d_pans
     c                   eval      z1levr = d_levr
      *
     c                   eval      *in11 = d_list = 1
     c                   eval      *in12 = d_hovd = 1
     c                   eval      *in13 = ltellu_suff = 0
     c                   eval      *in14 = d_opda = 0
     c                   eval      *in15 = d_vtyp = *blank
     c                   eval      *in16 = d_val2 = 0
      *
     c                   eval      *in21 = d_val3 = 1
     c                   eval      *in22 = d_val3 = 2
     c                   eval      *in23 = d_val3 = 3
     c                   eval      *in24 = d_val3 = 4
     c                   eval      *in25 = d_val3 = 5
6.20 c                   eval      *in26 = d_val3 = 6
      *
      *  Skriver heading
      *
7.01 c                   if        b_excl= *off
     c                   write     z1hdr                                30
7.01 c                   endif
      *
     c                   endsr
      *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Nullst. alle var., så det ikke blir liggende "gamle" verdier    *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     exc_clear     begsr
7.01  *
7.01 c                   eval      d1line = 0
7.01 c                   eval      d1lage = 0
7.01 c                   eval      d1plas = *blanks
7.01 c                   eval      d1vare = *blanks
7.01 c                   eval      d1var1 = *blanks
7.01 c                   eval      d1tek1 = *blanks
7.01 c                   eval      d1kabc = *blanks
7.01 c                   eval      d2pla1 = *blanks
7.01 c                   eval      d2pla2 = *blanks
7.01 c                   eval      d1antl = 0
7.02 c                   eval      d_ldor = 0
7.02 c                   eval      d_ltxt = *blanks
7.01  *
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Finner spool som er generert av jobben
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     spoolnbr      begsr
7.01  /Free
7.01
7.01           QSPRILSP( SPRL0100
7.01                   : %size(SPRL0100)
7.01                   : 'SPRL0100'
7.01                   : errorcode );
7.01  /End-free
7.01 c*
7.01  *
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Kaller eget program for generering av xml fil. Eget pgm         *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_create    begsr
7.01  *
7.01 c                   eval      splfname2 = *blanks
7.01 c                   eval      splfname3 = *blanks
7.01 c                   eval      jobname2 = *blanks
7.01 c                   eval      jobname3 = *blanks
7.01 c                   eval      username2 = *blanks
7.01 c                   eval      username3 = *blanks
7.01 c                   eval      jobnbr2 = *blanks
7.01 c                   eval      jobnbr3 = *blanks
7.01 c                   eval      splfnbr2 = *zeros
7.01 c                   eval      splfnbr3 = *zeros
7.01 c                   eval      p_btyp = 'LAGTEL'
7.01 c                   eval      p_dspl = 'Lagertelling- batc ' + z1batc +
7.01 c                                       ' dato: '+ %char(udate)
7.01 c                   eval      p_refn = 'LAGT-' + %char(udate)
7.01 c                   eval      p_tagg0 = *blanks
7.01 c                   eval      p_tagg0val = *blanks
7.01 c                   eval      p_tagg1 = *blanks
7.01 c                   eval      p_tagg1val = *blanks
7.01 c                   eval      p_tagg2 = *blanks
7.01 c                   eval      p_tagg2val = *blanks
7.01 c                   eval      p_tagg3 = *blanks
7.01 c                   eval      p_tagg3val = *blanks
7.01 c                   eval      p_tagg4 = *blanks
7.01 c                   eval      p_tagg4val = *blanks
7.01 c                   eval      p_tagg5 = *blanks
7.01 c                   eval      p_tagg5val = *blanks
7.01 c                   eval      p_tagg6 = *blanks
7.01 c                   eval      p_tagg6val = *blanks
7.01 c                   eval      p_tagg7 = *blanks
7.01 c                   eval      p_tagg7val = *blanks
7.01 c                   eval      p_tagg8 = *blanks
7.01 c                   eval      p_tagg8val = *blanks
7.01 c                   eval      p_tagg9 = *blanks
7.01 c                   eval      p_tagg9val = *blanks
7.01  *
7.01 c                   call      'AP627R'
7.01 c                   PARM                    splfname
7.01 c                   PARM                    jobname
7.01 c                   PARM                    username
7.01 c                   PARM                    jobnbr
7.01 c                   PARM                    splfnbr
7.01 c                   PARM                    splfname2
7.01 c                   PARM                    jobname2
7.01 c                   PARM                    username2
7.01 c                   PARM                    jobnbr2
7.01 c                   PARM                    splfnbr2
7.01 c                   PARM                    splfname3
7.01 c                   PARM                    jobname3
7.01 c                   PARM                    username3
7.01 c                   PARM                    jobnbr3
7.01 c                   PARM                    splfnbr3
7.01 c                   parm                    p_tagg0
7.01 c                   parm                    p_tagg0val
7.01 c                   parm                    p_tagg1
7.01 c                   parm                    p_tagg1val
7.01 c                   parm                    p_tagg2
7.01 c                   parm                    p_tagg2val
7.01 c                   parm                    p_tagg3
7.01 c                   parm                    p_tagg3val
7.01 c                   parm                    p_tagg4
7.01 c                   parm                    p_tagg4val
7.01 c                   parm                    p_tagg5
7.01 c                   parm                    p_tagg5val
7.01 c                   parm                    p_tagg6
7.01 c                   parm                    p_tagg6val
7.01 c                   parm                    p_tagg7
7.01 c                   parm                    p_tagg7val
7.01 c                   parm                    p_tagg8
7.01 c                   parm                    p_tagg8val
7.01 c                   parm                    p_tagg9
7.01 c                   parm                    p_tagg9val
7.01 c                   PARM                    l_bach
7.01 c                   PARM                    p_btyp
7.01 c                   PARM                    p_refn
7.01 c                   PARM                    p_dspl
7.01  *
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     pdf_preview   begsr
7.01 c                   if        l_skje = 1 or
7.01 c                             b_excl = *on
7.01  * Vi kaller program for launch av PDF i browser
7.01 c                   call      'AP621R'
7.01 c                   parm                    l_bach
7.01  *
7.01 c                   endif
7.01  *
7.01 c                   endsr
7.01  *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_envm      begsr
7.01  *
7.01 c                   eval      w_rtyp = 'XsltCommand'
7.01 c                   eval      w_mime = 'application/vnd.ms-excel' +
7.01 c                                      '; charset=UTF-8'
7.01 c                   eval      d_jasm = *blank
7.01  *
7.01  /Free
7.01       // Finne nytt batch nummer
7.01           UpdHTMLVar('BatchNo':               w_jkey);
7.01           UpdHTMLVar('Batchtype':            'EXCEL');
7.01           UpdHTMLVar('Username':              l_user);
7.01           WrtSection('Topp');
7.01       // Finn report command variabler
7.01           UpdHTMLVar('User':                l_user);
7.01           UpdHTMLVar('PW':                     ' ');
7.01           UpdHTMLVar('IPAdr':                  ' ');
7.01           UpdHTMLVar('Schema':        'ADB'+l_filg);
7.01           UpdHTMLVar('Companyno':    %char(l_firm));
7.01           WrtSection('Credential');
7.01       // Finn report command variabler
7.01           UpdHTMLVar('Reportcommandtype':   w_rtyp);
7.01       //  UpdHTMLVar('Jaspertemplate':      d_jasm);
7.01           UpdHTMLVar('Logo':                   ' ');
7.01           UpdHTMLVar('Keepspool':           'true');
7.01           UpdHTMLVar('Xsltschemapath':         ' ');
7.01           UpdHTMLVar('Mimetype':            w_mime);
7.01           WrtSection('ReportCommand');
7.01  /End-free
7.01  *
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML integrasjon - Heading                        *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_head      begsr
7.01  *
7.01 c                   eval      aforl1_ruti = l_ruti
7.01 c     aforl1_key    chain     aforl1r
7.01  * Hvis mail skal skrives, må vi hente mail informasjon
7.01  *
7.01 c                   if        l_mail = 1
7.01 c                   eval      p_kule = *blanks
7.01 c                   eval      p_kund = *zeros
7.01 c                   eval      p_kpro = *zeros
7.01 c                   eval      p_numm = *zeros
7.01 c                   eval      p_suff = *zeros
7.01 c                   eval      p_selg = *zeros
7.01 c                   eval      p_in03 = *off
7.01  * Henter ut mailserver
7.01 c                   eval      p_serv = *blank
7.01 c                   eval      p_stat = *blank
7.01 c                   call      'AM705C'
7.01 c                   parm                    p_serv
7.01 c                   parm                    p_stat
7.01  *
7.01 c                   call      'FO798R'
7.01 c                   parm                    p_kule
7.01 c                   parm                    p_kund
7.01 c                   parm                    p_kpro
7.01 c                   parm                    p_numm
7.01 c                   parm                    p_suff
7.01 c                   parm                    p_selg
7.01 c                   parm                    p_navn
7.01 c                   parm                    p_emal
7.01 c                   parm                    p_ema2
7.01 c                   parm                    p_ema3
7.01 c                   parm                    p_emne
7.01 c                   parm                    p_txt1
7.01 c                   parm                    p_txt2
7.01 c                   parm                    p_txt3
7.01 c                   parm                    p_txt4
7.01 c                   parm                    p_pers
7.01 c                   parm                    p_kopi
7.01 c                   parm                    p_inif
7.01 c                   parm                    p_in03
7.01  * Scann av strenger
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     p_emne        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_pemne
7.01  * Scann av strenger
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     p_txt1        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_ptxt1
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     p_txt2        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_ptxt2
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     p_txt3        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_ptxt3
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     p_txt4        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_ptxt4
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     p_pers        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_ppers
7.01  *
7.01 c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
7.01 c                                      %trim(w_ptxt2) + crlf +
7.01 c                                      %trim(w_ptxt3) + crlf +
7.01 c                                      %trim(w_ptxt4) + crlf +
7.01 c                                      %trim(w_ppers)
7.01  *
7.01 c                   if        p_kopi = *blanks
7.01 c                   eval      p_kopi = d_emal
7.01 c                   endif
7.01  *
7.01 c                   if        p_in03 = *off
7.01  *
7.01  /Free
7.01       // Skriv mailinformasjon
7.01           WrtSection('MailCommandStart');
7.01      //   UpdHTMLVar('Receivers':           p_emal);
7.01           if %Trim(p_emal)<> *blanks;
7.01           UpdHTMLVar('Receivers':           p_emal);
7.01           WrtSection('MailReceiver');
7.01           endif;
7.01           if %Trim(p_ema2)<> *blanks;
7.01           UpdHTMLVar('Receivers':           p_ema2);
7.01           WrtSection('MailReceiver');
7.01           endif;
7.01           if %Trim(p_ema3)<> *blanks;
7.01           UpdHTMLVar('Receivers':           p_ema3);
7.01           WrtSection('MailReceiver');
7.01           endif;
7.01           UpdHTMLVar('CC':                     ' ');
7.01           UpdHTMLVar('BCC':                 p_kopi);
7.01           UpdHTMLVar('Sender':              p_kopi);
7.01           UpdHTMLVar('Subject':             w_pemne);
7.01           UpdHTMLVar('Message':             w_mtxt);
7.01           UpdHTMLVar('SMTPServer':          p_serv);
7.01           UPDHTMLVar('SMTPUser':               ' ');
7.01           UPDHTMLVar('SMTPPw':                 ' ');
7.01       //  WrtSection('MailCommand');
7.01           WrtSection('MailCommandEnd');
7.01  /End-free
7.01 c                   endif
7.01 c                   endif
7.01  * Scann av strenger
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     aftxt1        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_txt1
7.01  *
7.01  * Vi må oversette aktuelle tekster til "xml" tegn - Firma
7.01 c                   eval      w_1fnav = *blank
7.01 c                   eval      w_1fad1 = *blank
7.01 c                   eval      w_1fad2 = *blank
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     w_fnav        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_1fnav
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     w_fad1        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_1fad1
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     w_fad2        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_1fad2
7.01  *
7.01  /Free
7.01
7.01       // Skriv firmavariabler
7.01           UpdHTMLVar('Reporttext':            w_txt1);
7.01           UpdHTMLVar('Subheader':                ' ');
7.01           UpdHTMLVar('CompanyName':          w_1fnav);
7.01           UpdHTMLVar('Companyadress1':       w_1fad1);
7.01           UpdHTMLVar('Companyadress2':       w_1fad2);
7.01           UpdHTMLVar('Companypostalcode':        ' ');
7.01           UpdHTMLVar('Companypostoffice':     w_fste);
7.01           UpdHTMLVar('Companyphone':          w_ftlf);
7.01           UpdHTMLVar('Companyfax':            w_ffax);
7.01           UpdHTMLVar('Companyorgno':   %char(aafftn));
7.01           UpdHTMLVar('Companygiro':    %char(aafbgi));
7.01           UpdHTMLVar('Companyemail':          aamail);
7.01           UpdHTMLVar('Companywebpage': %trim(aaweba));
7.01
7.01           test(de) *dmy w_ddmy;
7.01           if %error;
7.01           tmpdate = *loval;
7.01           else;
7.01           tmpdate = %date(w_ddmy : *dmy);
7.01           endif;
7.01           UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
7.01
7.01           test(te) *hms w_tids;
7.01           if %error;
7.01           tmptime = *loval;
7.01           else;
7.01           tmptime = %time(w_tids : *hms);
7.01           endif;
7.01           UpdHTMLVar('Creationtime': %char(tmptime : *hms));
7.01           WrtSection('DocumentInformation');
7.01
7.01           WrtSection('FreedefHeader');
7.01
7.01  /End-free
7.01  *
7.01  *
7.01 c                   eval      h_valu='Linje'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='LG'
7.01 c                   exsr      xml_head_val
7.02 c                   eval      h_valu='Ogrp'
7.02 c                   exsr      xml_head_val
7.02 c                   eval      h_valu='Hgrp'
7.02 c                   exsr      xml_head_val
7.02 c                   eval      h_valu='Ugrp'
7.02 c                   exsr      xml_head_val
7.02 c                   eval      h_valu='Levnr'
7.02 c                   exsr      xml_head_val
7.02 c                   eval      h_valu='Navn'
7.02 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Lplass'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Varenr'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='ABC kode'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Tekst'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Antall'
7.01 c                   exsr      xml_head_val
7.03 c                   eval      h_valu='Enhet'
7.03 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Tellet'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Varenr'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Alt.LP 1'
7.01 c                   exsr      xml_head_val
7.01 c                   eval      h_valu='Alt.LP 2'
7.01 c                   exsr      xml_head_val
7.01  *
7.01  /Free
7.01
7.01       // Avslutt headervalues
7.01           WrtSection('HeaderLineEnd');
7.01
7.01  /End-free
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML integrasjon - Heading                        *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_head_val  begsr
7.01  *
7.01  /Free
7.01
7.01       // Skriv headervalue
7.01           UpdHTMLVar('Headervalue':  %trim(h_valu));
7.01           WrtSection('HeaderLineValue');
7.01
7.01  /End-free
7.01  *
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML integrasjon - detaljlinjer                   *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_detal     begsr
7.01  *
7.01  /Free
7.01
7.01       // Skriv detaljer
7.01           WrtSection('DetailLineStart');
7.01
7.01           WrtSection('FreedefLine');
7.01
7.01  /End-free
7.01  *
7.01 c                   eval      d2pla1 = vlpla1
7.01 c                   eval      d2pla2 = vlpla2
7.02 c                   eval      d_ldor = w_ldor
7.02 c                   eval      rlevl1_levr = w_ldor
7.02 c     rlevl1_key    chain     rlevl1
7.02 c                   if        %found
7.02 c                   eval      d_ltxt = rlnavn
7.02 c                   endif
7.01  *
7.01  * Varetekst
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     d1tek1        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_tek1
7.01  * Lagerplass
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     d1plas        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_plas
7.02  *
7.02  * Leverandørnavn
7.02  *
7.02 c                   eval      p_str_in = *blank
7.02 c                   eval      p_lr = '0'
7.02 c                   movel     d_ltxt        p_str_in
7.02 c                   call      'AP613R'
7.02 c                   parm                    p_str_in
7.02 c                   parm                    p_str_out
7.02 c                   parm                    p_lr
7.02 c                   movel     p_str_out     w_ltxt
7.01  *
7.01  * Så skriver vi de forskjellige linjene
7.01  *
7.01  * Linjer
7.01 c                   eval      d_type='Numeric'
7.01 c                   eval      d_valu=%char(d1line)
7.01 c                   exsr      xml_line_val
7.01  * Lager
7.01 c                   eval      d_type='Numeric'
7.01 c                   eval      d_valu=%char(d1lage)
7.01 c                   exsr      xml_line_val
7.02  * Overgruppe
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu=%char(leogrp)
7.02 c                   exsr      xml_line_val
7.02  * Hovedgruppe
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu=%char(lehgrp)
7.02 c                   exsr      xml_line_val
7.02  * Undergruppe
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu=%char(leugrp)
7.02 c                   exsr      xml_line_val
7.02  * Leverandørnummer
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu=%char(d_ldor)
7.02 c                   exsr      xml_line_val
7.02  * Leverandørtekst
7.02 c                   eval      d_type='Char'
7.02 c                   eval      d_valu=%trim(w_ltxt)
7.02 c                   exsr      xml_line_val
7.01  * Lagerplass
7.01 c                   eval      d_type='Char'
7.01 c                   eval      d_valu=%trim(w_plas)
7.01 c                   exsr      xml_line_val
7.01  * Varenummer
9.31 c                   eval      d_type='Char'
7.01 c                   eval      d_valu=%trim(d1vare)
7.01 c                   exsr      xml_line_val
7.01  * ABC kode
9.31 c                   eval      d_type='Char'
7.01 c                   eval      d_valu=%trim(d1kabc)
7.01 c                   exsr      xml_line_val
7.01  * Varetekst
7.01 c                   eval      d_type='Char'
7.01 c                   eval      d_valu=%trim(w_tek1)
7.01 c                   exsr      xml_line_val
7.01  * Antall
7.01 c                   eval      d_type='Numeric'
7.01 c                   eval      d_valu=%char(d1antl)
7.01 c                   exsr      xml_line_val
7.03  * Enhet
7.03 c                   eval      d_type='Char'
7.03 c                   eval      d_valu=%trim(d1enh1)
7.03 c                   exsr      xml_line_val
7.01  * Tellet
7.01 c                   eval      d_type='Numeric'
7.01 c                   eval      d_valu='0'
7.01 c                   exsr      xml_line_val
7.01  * Varenummer
7.01 c                   eval      d_type='Char'
7.01 c                   eval      d_valu=%trim(d1var1)
7.01 c                   exsr      xml_line_val
7.01  * Alternativ lagerplass 1
7.01 c                   eval      d_type='Char'
7.01 c                   eval      d_valu=%trim(d2pla1)
7.01 c                   exsr      xml_line_val
7.01  * Alternativ lagerplass 2
7.01 c                   eval      d_type='Char'
7.01 c                   eval      d_valu=%trim(d2pla2)
7.01 c                   exsr      xml_line_val
7.01  *
7.01  /Free
7.01
7.01       // Skriv avslutning
7.01
7.01           WrtSection('DetailLineEnd');
7.01
7.01  /End-free
7.01  *
7.02 c                   eval      b_anta = *on
7.02  *
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML integrasjon - Linjer                         *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_line_val  begsr
7.01  *
7.01  /Free
7.01
7.01       // Skriv linevalue
7.01           UpdHTMLVar('type':         %trim(d_type));
7.01           UpdHTMLVar('Linevalue':    %trim(d_valu));
7.01           WrtSection('DetailLineValue');
7.01
7.01  /End-free
7.01  *
7.01 c                   endsr
7.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.02  * Subrutiner for XML integrasjon - detaljlinjer - dummy           *
7.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.02 c     xml_det_dum   begsr
7.02  *
7.02  /Free
7.02
7.02       // Skriv detaljer
7.02           WrtSection('DetailLineStart');
7.02
7.02           WrtSection('FreedefLine');
7.02
7.02  /End-free
7.02  *
7.02 c                   eval      d2pla1 = *blanks
7.02 c                   eval      d2pla2 = *blanks
7.02  *
7.02  * Varetekst
7.02  *
7.02 c                   eval      w_tek1 = *blanks
7.02  * Lagerplass
7.02 c                   eval      w_plas = *blank
7.02  *
7.02  * Så skriver vi de forskjellige linjene
7.02  *
7.02  * Linjer
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu= '0'
7.02 c                   exsr      xml_line_val
7.02  * Lager
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu= '0'
7.02 c                   exsr      xml_line_val
7.02  * Overgruppe
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu= '0'
7.02 c                   exsr      xml_line_val
7.02  * Hovedgruppe
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu= '0'
7.02 c                   exsr      xml_line_val
7.02  * Undergruppe
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu= '0'
7.02 c                   exsr      xml_line_val
7.02  * Leverandørnr
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu= '0'
7.02 c                   exsr      xml_line_val
7.02  * Leverandørnavn
7.02 c                   eval      d_type='Char'
7.02 c                   eval      d_valu= ' '
7.02 c                   exsr      xml_line_val
7.02  * Lagerplass
7.02 c                   eval      d_type='Char'
7.02 c                   eval      d_valu=%trim(w_plas)
7.02 c                   exsr      xml_line_val
7.02  * Varenummer
9.32 c                   eval      d_type='Char'
7.02 c                   eval      d_valu= '00000000'
7.02 c                   exsr      xml_line_val
7.02  * ABC kode
9.32 c                   eval      d_type='Char'
7.02 c                   eval      d_valu= ' '
7.02 c                   exsr      xml_line_val
7.02  * Varetekst
7.02 c                   eval      d_type='Char'
7.02 c                   eval      d_valu=%trim(w_tek1)
7.02 c                   exsr      xml_line_val
7.02  * Antall
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu=%char(d1antl)
7.02 c                   exsr      xml_line_val
7.03  * Enhet
7.03 c                   eval      d_type='Char'
7.03 c                   eval      d_valu=%trim(d1enh1)
7.03 c                   exsr      xml_line_val
7.02  * Tellet
7.02 c                   eval      d_type='Numeric'
7.02 c                   eval      d_valu='0'
7.02 c                   exsr      xml_line_val
7.02  * Varenummer
7.02 c                   eval      d_type='Char'
7.02 c                   eval      d_valu= '00000000'
7.02 c                   exsr      xml_line_val
7.02  * Alternativ lagerplass 1
7.02 c                   eval      d_type='Char'
7.02 c                   eval      d_valu=%trim(d2pla1)
7.02 c                   exsr      xml_line_val
7.02  * Alternativ lagerplass 2
7.02 c                   eval      d_type='Char'
7.02 c                   eval      d_valu=%trim(d2pla2)
7.02 c                   exsr      xml_line_val
7.02  *
7.02  /Free
7.02
7.02       // Skriv avslutning
7.02
7.02           WrtSection('DetailLineEnd');
7.02
7.02  /End-free
7.02  *
7.02 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML integrasjon - Slutt                          *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_end       begsr
9.071 *
7.01  /Free
7.01           WrtSection('EndExcelLines');
7.01  /End-free
7.01  *
7.01  * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
7.01  *
7.01 c                   if        l_arch = 1
7.01  * Lag tag for vising i arkivklienten
7.01 c                   eval      w_dspl = *blank
7.01 c                   eval      w_dspl = 'Nye varer til EVR'
7.01  *
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     w_dspl        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_dspl
7.01  /Free
7.01       // Skriv metattags
7.01
7.01           UpdHTMLVar('Displaytag':     %trim(w_dspl));
7.01           WrtSection('ArchiveCommandStart');
7.01
7.01           UpdHTMLVar('Metavalue':                ' ');
7.01           UpdHTMLVar('Metakey':              'EXCEL');
7.01           WrtSection('MetaTag');
7.01
7.01           UpdHTMLVar('Metavalue':             l_user);
7.01           UpdHTMLVar('Metakey':             'BRUKER');
7.01           WrtSection('MetaTag');
7.01
7.01           UpdHTMLVar('Metavalue': %char(w_date:*iso));
7.01           UpdHTMLVar('Metakey':               'DATO');
7.01           WrtSection('MetaTag');
7.01
7.01           UpdHTMLVar('Metavalue':             w_txt1);
7.01           UpdHTMLVar('Metakey':         'RUTINETEKST');
7.01           WrtSection('MetaTag');
7.01
7.01           WrtSection('ArchiveCommandEnd');
7.01  /End-free
7.01  *
7.01 c                   endif
7.01  *
7.01  /Free
7.01           WrtSection('Footer');
7.01  /End-free
7.01  *
7.01 c                   eval      XML_Output = XML_path + l_filg +'/'+
7.01 c                             'LE603_'+ %trim(w_jkey) + '.xml'
7.01  *
7.01 c                   callp     WrtHtmlToStmf(XML_Output: 819)
7.01  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
7.01 c                   if        d_dtaq = '1'
7.01 c                   eval      p_xmlf = xml_output
7.01 c                   eval      p_filg = 'ADB'+l_filg
7.01 c                   call      'AP629C'
7.01 c                   parm                    p_filg
7.01 c                   parm                    p_xmlf
7.01 c                   endif
7.01  *
7.01 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *  Key for les av TELLING-HJELPE
      *
     c     lpstl2_key    klist
     c                   kfld                    w_firm
      *
      *  Key for les av FORMULAR
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      *  Key for les av VARE
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      *  Key for les av LAGER
      *
     c     vlagl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vlagl1_vare
     c                   kfld                    vlagl1_lage
      *
      *  Key for les av LAGER-KODE
      *
     c     lstsl1_key    klist
     c                   kfld                    w_firm
      *
      *  Key for les av BATCH
      *
     c     lbchlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lbchlu_batc
      *
      *  Key for oppdatering av TELLE fil
      *
     c     ltellu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ltellu_batc
     c                   kfld                    ltellu_numm
     c                   kfld                    ltellu_suff
     c                   kfld                    ltellu_line
      *
      *  Key for les av TELLE fil
      *
     c     ltell2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ltell2_batc
     c                   kfld                    ltell2_numm
     c                   kfld                    ltell2_suff
     c                   kfld                    ltell2_vare
     c                   kfld                    ltell2_lage
7.01  *
7.01  * Key for oppslag på firma
7.01  *
7.01 c     afirl1_key    klist
7.01 c                   kfld                    w_firm
7.02  *
7.02  *  Key for les av leverandør
7.02  *
7.02 c     rlevl1_key    klist
7.02 c                   kfld                    w_firm
7.02 c                   kfld                    rlevl1_levr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    w_parm
      *
      *  Behandling av parameter-felter
      *
     c                   eval      d_prec = w_parm
      *
      *  Legger inn firmanummer i nøklene
      *
     c                   eval      w_firm = l_firm
      *
     c                   eval      ltellu_batc = d_batc
     c                   eval      ltell2_batc = d_batc
      *
      *  Legger inn opplysninger i utfelter
      *
     c                   eval      a1wsid = l_wsid
     c                   eval      a1user = l_user
     c                   eval      a1firm = l_firm
     c                   eval      a1fnav = l_fnav
     c                   eval      z1firm = l_firm
     c                   eval      z1fnav = l_fnav
      *
     c                   eval      a1date = udate
     c                   time                    a1time
      *
      *  Hent opplysninger fra LAGER-KODE
      *
     c     lstsl1_key    chain     lstsl1r                            90
7.01  *
7.01  *  Hent opplysninger fra firmaregister
7.01  *
7.01 c     afirl1_key    chain     afirl1r                            90
      *
      *  Hent opplysninger fra RUTINE-REGISTER
      *
     c                   eval      aforl1_ruti = l_ruti
     c     aforl1_key    chain     aforl1r                            90
7.01  * NB KUN hvis EXCEL rapport. Hvis ikke skal det dannes PDF av spoolfile
7.01  *
7.01 c                   if        l_poff = '1' and
7.01 c                             l_exlp = 1
7.01 c                   eval      b_excl = *off
7.01 c                   eval      w_pdf = 0
7.01 c                   eval      w_pdf_ds = *blanks
7.01 c                   eval      w_ruti = l_ruti
7.01  *
7.01 c                   call      'AP609R'
7.01 c                   parm                    w_ruti
7.01 c                   parm                    w_pdf
7.01 c                   parm                    w_pdf_ds
7.01 c                   eval      d_pdf_ds = w_pdf_ds
7.01  * PROA er aktivert
7.01 c                   if        w_pdf = 1 and
7.01 c                             %trim(d_xmlm) <> *blanks
7.01 c                   eval      w_jkey = l_bach
7.01  *
7.01  * Hent inn xml templaten
7.01  *
7.01 c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
7.01  *
7.01  * Finn hvor xml'en skal legges
7.01  *
7.01 c                   eval      XML_path = *blanks
7.01 c                   eval      XML_path = %trim(d_path)
7.01  *
7.01  * Jobbnummer er allerede generert i AP600R. Overføres i *lda
7.01  *
7.01 c                   time                    w_date
7.01 c                   time                    w_dato2
7.01 c                   movel     w_dato2       w_tids
7.01 c                   move      w_dato2       w_ddmy
7.01  * Vi logger at utskriftprogrammet har startet
7.01 c                   eval      w_jstat = 10
7.01 c                   eval      w_jtext = 'Excel av nye varer til EVR +
7.01 c                                        har startet'
7.01 c                   call      'AB705R'
7.01 c                   parm                    l_bach
7.01 c                   parm                    w_jstat
7.01 c                   parm                    w_jtext
7.01  * Vi skriver xml for miljø formater
7.01 c                   exsr      xml_envm
7.01 c                   eval      b_excl = *on
7.02 c                   eval      b_anta = *off
7.01 c                   else
7.01  * Vi logger at noe er galt med parametrene
7.01 c                   eval      w_jstat = 20
7.01 c                   eval      w_jtext = 'Finner ikke path til xml !!! +
7.01 c                             Sjekk rutineregister !'
7.01 c                   call      'AB705R'
7.01 c                   parm                    l_bach
7.01 c                   parm                    w_jstat
7.01 c                   parm                    w_jtext
7.01 c                   endif
7.01  *
7.01  *  Hent inn firma/avd. opplysninger dersom
7.01  *  kode for det er satt i rutineregister
7.01  *
7.01 c                   if        l_prfi = 1 or
7.01 c                             l_prfi = 2
7.01 c                   eval      w_prfi = l_prfi
7.01 c                   eval      w_ffir = w_firm
7.01 c                   eval      w_pavd = l_avde
7.01  *
7.01 c                   call      'FÅ707R'
7.01 c                   parm                    w_prfi
7.01 c                   parm                    w_ffir
7.01 c                   parm                    w_pavd
7.01 c                   parm                    w_fnav
7.01 c                   parm                    w_fad1
7.01 c                   parm                    w_fad2
7.01 c                   parm                    w_fste
7.01 c                   parm                    w_fftx
7.01 c                   parm                    w_tfax
7.01 c                   parm                    w_ftlf
7.01 c                   parm                    w_ffax
7.01 c                   parm                    w_mail
7.01 c                   parm                    w_weba
7.01 c                   endif
7.01  *
7.01 c                   exsr      xml_head
7.01  *
7.01 c                   else
7.01 c                   eval      b_excl = *off
7.01 c                   endif
7.01  *
7.01 c                   if        b_excl = *off
7.01 c                   open      le603p
7.01 c                   endif
      *
     c                   endsr
