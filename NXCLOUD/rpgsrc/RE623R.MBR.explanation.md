# Program Overview

This RPG (Report Program Generator) IV code is for IBM i (AS/400, iSeries) and generates a financial report ("Resultatrapport til Akelius - utplukk") for the Akelius group. The report summarizes account balances for the current year, prior year, and budget, grouped by company and department (avdeling).

The program:
- Reads parameter input (company, year, period, department range, etc.).
- Selects and summarizes balances for a set of accounts and departments.
- Writes results to an output physical file.

Comments and variable names are a mix of Norwegian and English.

## Header and File Definitions

```rpg
h datedit(*dmy) option(*nodebugio)
```
- `datedit(*dmy)`: Date literals are in day/month/year format.
- `option(*nodebugio)`: Disables debug support for IO operations (performance).

### File Declarations

- `frrf0l1`, `frrf5l1`, `frrf9l1`, `fra07l1`: Input files, each renamed to record format references (`rrf0pfr:rrf0l1r`, etc.).
- `fre08pf`: Output file for report lines.

### Data Structures and Variables

Arrays and fields are defined for holding balances and layout text:
- `sal(14)`, `saø(14)`, `saf(14)`, `sab(14)`: Arrays to hold current, year, prior year, and budget balances for up to 14 periods/accounts.
- `ds`/`dsulda`: Data structure for output layout (account, separator, year indicator, balance).
- Parameters (company, year, user, dates, etc.) are mapped to variables like `pfirm`, `pnavn`, `puser`, `pdato`, etc.

### Work Fields

- `wa07ok`, `w_raar`, `w_firm`, etc.: Work fields for intermediate processing.
- `wrbpår`, `wrbtår`, `wrfpår`, etc.: Temporary accumulators for balances.

---

## Input/Output Specs

Input specifications and field mapping for account balances:
```rpg
irrf9l1r       01
i              rr9s01                      sal(01)
...
i              rr9s00                      sal(14)
```
- Reads different fields from the record into the `sal` array.

---

## Main Logic

### Initialization and Entry (`*inzsr`)

On program start:
- Work fields and accumulators are initialized to zero.
- The company and year to report (`w_firm`, `w_raar` = previous year) are set.
- Report headings and keys are loaded (via `chain` and definitions).

### Main Processing Loop

#### 1. **Start reading report lines (`les` tag):**
- Reads each report line (`read rrf5l1r`). Exits if EOF or data not matching.

#### 2. **Set up for department processing**
- If department input is zero (all), start at the lowest department.

#### 3. **Department Loop (`avdlop` tag):**
- Finds the first or next department, or exits if department out of range.
- Handles "summary/individual department" logic (`psumm` flag).

#### 4. **Get Balances for Line (`finsal` tag):**
- For each account line:
    - If not a 'T' total code, sets current department.
    - Retrieves (via `chain`):
        - Current year balance (`rr9typ=1`)
        - Budget for year (`rr9typ=3`)
        - Prior year balance (`rr9aar=w_raar`, `rr9typ=1`)
    - Adds these to the current account's accumulators (`saø`, `sab`, `saf`).

#### 5. **Write Details for Each Line (`skrlin` tag):**
- Constructs output record:
    - Copies account number, separators, year indicators, amounts.
    - If value non-zero, formats value (including sign and decimal).
    - Writes a line for current year, prior year if values exist.
- Clears arrays for next pass.

#### 6. **Branch Logic**
- Handles totals (`rr5kod='T'`), summaries (`psumm='J'`), or continues per department or report line as needed.

---

## Subroutines and Key Lists

- At the end, key-lists for each file are defined for use with RPG's `chain` and `setll` operations, ensuring proper keyed access to the physical files.

---

# Key Concepts and Flow

- **File Processing**: Reads from input physical files using indexed (keyed) access.
- **Accumulation**: Sums balances for accounts across periods or departments as needed.
- **Mapping and Layout**: Uses overlays and data structures to build output lines in the format required by Akelius.
- **Conditional Output**: Only writes lines with non-zero balances.
- **Flexibility**: Can process a single department or a range, and can summarize or detail depending on the control parameter.

---

# Onboarding Summary

- **Purpose:** Generates financial summary lines per company, department, and account for Akelius, by aggregating values from detailed files.
- **Input:** Parameter record (`uds`), input files with account, department, and period data.
- **Output:** Written report lines to `re08pfr` (probably a spool or print file).
- **Main operations:** Loop over report lines, then over departments, fetch balances, aggregate, and write formatted output.
- **Customization:** Controlled by input ranges and summary/individual flags.
- **Structure:** Legacy RPG, use of fixed-format, key-lists, and overlays for compact data handling.

---

# Some Norwegian Terms

- **Saldo**: Balance
- **År**: Year
- **Fjor**: Last year
- **Budsjett**: Budget
- **Avdeling**: Department
- **Rapport**: Report
- **Konto**: Account

---

# For New Developers

- Focus on understanding how each file (logical or physical) relates to the business entities (accounts, departments, years).
- The logic is driven by key lists for efficient record access.
- Use debug techniques for old RPG programs (`*INLR`, indicators) to follow the flow.
- The main loop is a nested structure: Report Line → Department → Account/Balance.
- Output is constructed via careful mapping of values into a DS with overlays, then writing to the output file.

---

If you need explanation for specific sections or logic, feel free to ask!