# RPG Program FO805R – Automatic Order Number Picking

---

## Overall Description

This RPG (Report Program Generator) program is designed for IBM iSeries/AS400 (ILE RPG IV), named `FO805R`. Its purpose is to "pick" (determine and prepare) an order number automatically for further processing—typically for warehouse or sales order procedures.

Most of the code revolves around reading and updating various database files (physical and logical), validating business rules (deposits, credit limit, order type, customer status), and invoking external programs for business logic.

The documentation comments and code are partly in Norwegian. Key variable, field, and file names, as well as comments, are explained below.

---

## High-level Workflow

1. **Setup/Initialization**
   - Sets date formats and program options.
   - Opens and renames several files to use record formats (logical/physical files).
   - Declares key variables and initializes them.
   - Defines fields, constants, and parameter lists for file access and subroutines.

2. **Parameter Intake**
   - Receives parameters from calling programs (order number, suffix, company/firma, etc.).
   - Prepares key fields for subsequent database operations.

3. **Main Logic**
   - Retrieves order header info from the "ORDRE-HODE-REGISTER".
   - Retrieves order type info, customer info, and memo balance.
   - Validates deposit status (especially if 100% deposit is needed).
   - Checks if the order already exists in the picking table—if so, uses its order type.
   - Checks if customer and order pass various business rule validations (deposit status, customer type, credit, info codes, etc.).
   - Updates database tables as needed to reflect the picking ("plukking") activity.
   - Handles line-level detail: populates picking lines based on order lines.
   - Calls output/print programs as needed.
   - Performs clean-up and exits.

4. **Subroutines**
    - **ord_line**: Handles writing/updating pick lines based on order lines.
    - **sjk_rt**: Checks if picking activity was performed via radio terminal and updates files accordingly.
    - **upd_logg**: Writes audit/log entries for picking.
    - **sjekk_depo, sjekk_d100**: Checks deposit requirements.

---

## File Declarations

Many files are declared, most as *indexed*, *external*, and using a *rename* (to shorten or clarify record-format names). These files include:
- **Order files** (header, detail), picking tables, customer register, credit/memo, status, etc.
- Each file gets a record format name, e.g., `fohelur` for `fohelu`.

---

## Variable/Field Declarations

Variables are declared for:
- Key fields for each file (mimic the structure of target file keys)
- Stand-alone business fields: Customer, order numbers, suffix, order type, various flags, amounts, and status codes.
- User and session data (user ID, workstation, etc.)
- A few data structures: overlays on buffer fields for audit logging.

---

## Parameter Sections

The `*entry plist` section describes the parameters received from the caller, typically:
- Picking indicator (mode), company, order number, and order suffix.

Many "klist" (key list) entries define sets of fields used as keys to access records in the files.

---

## Main Program Logic Breakdown

1. **Retrieve Order Header**
   - Moves provided order number/suffix into local variables.
   - Uses a *chain* operation to get the relevant order header.

2. **Retrieve Order Type (ORDRETYPE-REGISTER)**
   - Uses the order type from the header and chains to the order type register for details (rules, next order type, etc.).

3. **Customer Register**
   - Chains into the customer register and (if needed) calls `FO763R` to compute credit/memo balance.

4. **Store Order Type Details**
   - Caches order type fields from the order type register for local use.

5. **Deposit Check**
   - Calls subroutine `sjekk_depo` to check if deposit requirements are met. If not, exits to `xslutt` label.

6. **Order Type Override Handling (v8.02/8.03)**
   - If the order is found in the picking table, the program trusts the order type already there. Otherwise, it uses the 'next order type' from the order type register. Validates the order type.

7. **Deposit 100% Check**
   - If required, calls subroutine to check if a 100% deposit has been paid and within deviation tolerance.

8. **Business Rule Checks**
   - Exclude certain cash customers from this picking process.
   - Additional checks for credit restrictions, unpaid deposits, special statuses.

9. **Credit Limit Validation**
   - If activated, and for specific order types, calls calculation programs, fetches values from related files, and checks if the customer passes the extended credit rules.

10. **Order Info Code Checks**
    - Checks order info codes, especially for invoicing restrictions.

11. **User Authorization Check**
    - Verifies if the user is allowed to trigger invoicing for the order.

12. **Update Order Header Status**
    - If order passes all checks, updates the order header to set it to "in process" and records user and timestamp.

13. **Update/Write Picking Table**
    - Either updates or writes a new entry for the picking table (UTPLUKK-PARAM-REGISTER).

14. **Check Picking via Radio Terminal**
    - Calls `sjk_rt` subroutine, which reads picking transactions performed via radio terminal, updating/managing picking lines accordingly.

15. **Picking Line Creation**
    - Calls `ord_line` subroutine to create picking lines for the order, based on the order details.

16. **Call Output/Print Program**
    - Calls FO806R, which likely handles printing picking documents or labels.

17. **Exit/Cleanup**
    - Reaches `xslutt` label, sets LR indicator, and returns.

---

## Subroutines

### ord_line

- Reads order lines for the order in question.
- For each line, attempts to update picking lines. If not already present, creates new lines.
- Keeps fields consistent, copies quantities, blanks out flags as necessary.

### sjk_rt

- Checks if picking has happened using a radio terminal (status 7).
- If so, fetches picking lines from the radio picking file, updates or creates corresponding lines in the main picking register with those quantities.

### upd_logg

- Prepares and writes a log entry, including date, time, user, workstation, order info.
- Calls external program FU900R for logging.

### sjekk_depo

- Checks if the current order for the customer has a deposit that is fully paid (>= required amount). If so, sets a flag.

### sjekk_d100

- If a 100% deposit is required, checks that any deviation is within an acceptable range by calling FO705R.
- Sets appropriate flags if the order can or cannot proceed.

---

## Configuration via External Programs

The code uses a *property file/configuration* mechanism via program `CO402R` to activate/deactivate business rules and thresholds at runtime:

- Several features are toggled via configuration:
  - Exclude cash customer picking
  - Put orders of a certain type on hold
  - Use extended memo/credit logic
  - etc.

The code uses external calls to update control variables (e.g., `u_701`, `u_702`, ...) and reads parameters for credit extension and memo days, which can be maintained outside the program.

---

## Error Handling

- The main mode of error handling is to exit early (using `goto xslutt`) when business rule checks fail.
- File operations check `%found` or input indicators (e.g., `*in90`). If records are missing, the program will either exit, skip, or proceed accordingly.

---

## Coding Practices and Structure

- The program is written in a mix of fixed-format RPG IV (C-specs, D-specs, etc.) with some /FREE RPG used for newer logic.
- Comments are in Norwegian; critical business rules are annotated by version numbers (e.g., `8.02`, `8.03`) for tracing changes.
- Subroutines (`begsr`/`endsr`) organize modular logic.
- Uses *klist* for repetitive key structures, keeping file access consistent and less error-prone.

---

## Key Business Rules (English Summary)

- Only allows picking if all payment/deposit and credit checks pass.
- Different picking modes/types are handled according to order type and config.
- Handles special cases for cash customers, direct invoicing, and warehouse picking.
- Supports integration with radio terminals and external programs for line-level picking and logging.

---

## Key Takeaways for New Developers

- **Understand the Data Model**: You must be familiar with the file structures (ORDRE, PLUKK, KUNDE, etc.), their key fields, and business meaning.
- **Configuration-Driven Behavior**: Many business rules are activated/deactivated via configuration read at program start-up. Changes to customer behavior may not always require code changes.
- **Subroutine-Based Structure**: Critical business logic (credit check, deposit check, picking line synchronization) is modularized into subroutines and often triggered conditionally.
- **Error Handling**: Largely handled by early returns; ensure you understand the conditions under which the program will not process an order.
- **Integration with External Programs**: Many key calculations and updates are performed via external RPG programs, which must be understood to fully track business logic.

---

## Notable Norwegian to English Translations

- **Plukke**: Pick (as in warehouse picking)
- **Ordrenummer**: Order number
- **Kunde**: Customer
- **Ordretype**: Order type
- **Depostium**: Deposit/advance payment
- **Utplukk**: Picking (as in picking register or status)
- **Sum/memosaldo**: Memo/credit balance

---

## Conclusion

This program is a core part of the order fulfillment workflow, ensuring that only eligible orders—per configuration, business rules, and payment status—are released for picking, and maintaining synchronized records for all picking activities.

For onboarding:
- Review the business process for order picking and credit control.
- Understand which external programs are called and what they do.
- Study the database file layouts and how they map to keys and fields used here.
- Pay attention to configuration via CO402R—it controls much of the conditional logic in this program.