# RPG Program GL228R – Maintenance of Returned Payment Files

This program is a classic IBM ILE RPG (RPG/400) application, handling the maintenance and history of returned payment files (“returfiler”) in a batch-based financial processing system. Its primary purpose is to:

- Display a log/history of updated returned payments.
- Allow the user to restore (“legge tilbake”) batches to a previous state.
- Provide subfile-driven interfaces for selection, viewing, and processing of entries.
- Support for multi-level subfiles and data windows.

Below is a structured explanation, function by function and data area by data area.

---

## 1. **General Structure and Documentation**

The program starts with comprehensive Norwegian documentation, tracking changes, indicator usage, and subfile management conventions. The comments specify which indicators control which functions (F-keys, subfile actions, error messages, etc.).

---

## 2. **Files and Record Formats**

### Display File (`WORKSTN`)

- `gl228d`: Display file, with three subfiles: `b1sfl`, `c1sfl`, `d1wsf`.
    - Used for batch selection, details, and windowed operations.

### Database Files

- `gatrlu`, `gatrpf`, `gavtl2`, `gbtrpf`, `gbtrl1`, `gubfpf`, `gkbfpf`: Various physical/logical files, mostly batch and payment related.
    - `gatrlu`, `gatrpf`, `gbtrpf` are updated and renamed in the program for different record formats.
    - Example: `gatrlu` is used to delete/restore batch records.

---

## 3. **Main Working Tables and Fields**

Arrays (all dimensioned for max 999 elements):

- `giro`:   Account number (gironummer) for batches.
- `løpn`:   Sequential/batch number (løpenummer).
- `type`:   Batch type.
- `oppd`:   Operation code or associated number.
- `dato`:   Date.
- `klok`:   Time (hhmmss).
- `filg`:   File group.
- `firm`:   Firm/company number.

---

## 4. **Subfile Auxiliary Fields**

For each subfile (nn = 01, 02, 03):

- `SRRNnn`, `SPGEnn`, `SFRNnn`, `SSRNnn`, `SVRNnn`: Current record, page size, first record on page, last record, visible record, etc.
- Used to manage subfile paging and positioning.

Window positioning:

- `w_arow`, `w_acol`: Coordinates for pop-up windows.

---

## 5. **Important Data Structures**

- ***Date Structures:*** For easy manipulation of dates (unpacking/packing of yyyymmdd, ddmmyyyy, etc.).
- ***Record Format Buffers:*** For moving entire records quickly or overlaying specific fields within records.
- ***Proposal (Forslag) Related Structures:*** For “BETFOR” records, special overlays for restoring batch suggestions.

---

## 6. **Key Lists**

Defined `KLIST`s for key operations on files (e.g., by gironummer, løpenummer, file group, etc.).

---

## 7. **Indicator Usage and F-key Mapping**

Indicator ranges (as described in comments):

- **F3 (KC):** Exit/terminate program.
- **F5 (KE):** Renew/refresh main list.
- **F12 (KL):** Cancel.
- **Subfile indicators (10, 12, 13, 14, 15, 16, etc.):** Handle roll, display, clear, end, etc.

---

## 8. **Main Control Flow**

### **Entry/Initialization**

- Program initialization (`*inzsr`): Clears and sets up working fields, subfile positions, indicators.
- Looks up the main giro account number for the user’s firm/group.
- Initializes the first lpn (løpenummer) and displays the main subfile list.

---

### **Subfile 1: Batch Selection (`b1sfl`)**

- User sees a list of return batches. Main display/selection subfile.
- **F3:** Exit, **F5:** Refresh.
- **User actions:**  
    - **‘1’ = Restore batch:**  
        - Checks if not already selected or already updated (check `GBTELL = 0`).  
        - Adds batch info to array for processing.
        - Calls copy subroutine (see below).
    - **‘5’ = View batch:**  
        - Loads detail info for the batch into subfile 2.

---

### **Subfile 2: Batch Details (`c1sfl`)**

- Shows records/details for selected batch.
- **F3:** Exit details and return to main list.
- **ROLL:** Paginates through batch detail records.

---

### **Subfile 3: Confirm/Process Multiple Batches (`d1wsf`)**

- Used to process batches that have been selected (e.g., for batch operations such as restoring multiple batches).
- Shows all batches queued for restore.

---

## 9. **Key Subroutines and Operations**

### **`xcopy`: Restore batch from backup**

- Deletes old entries in primary batch file (`GATRPF`).
- Restores from backup (`GBTRPF`).
- Handles special logic for “TF2” batch types and “BETFOR23” proposals, copying proposal data from backup to proposal file.
- Deletes backup entries after copy to avoid duplicates.
- Displays "copy complete" window and ends the program.

### **`xcopy2`: Restore proposal data**

- Writes restored proposal data into the main proposal file (`GUBFPF`), copying the data element-by-element from the backup format.

---

### **Subfile Maintenance Subroutines**

- `xclr01`, `xcrt01`, `xdsp01`: Clear, fill, and display subfile 1.
- `xclr02`, `xcrt02`, `xdsp02`: Subfile 2 equivalents.
- `xclr03`, `xcrt03`, `xdsp03`: Subfile 3 equivalents.

---

### **Other Subroutines:**

- `xførst`: Finds first available løpenummer, typically for paging/reset.
- `xinke`: Reset arrays for a new/refresh cycle and re-populate subfile 1.
- `xsbf3`: Display batches queued for update (selected with '1').

---

## 10. **Batch and File Processing Logic**

- Subfiles are driven mostly by paging and selection indicators.
- The logic handles gaps in løpenummer and supports both bank and postal giro accounts as key fields.
- When processing a batch, it ensures only unprocessed (updated) batches are handled, indicated by the teller field.
- Special handling for proposal batches (those that go to accounting); certain types and counter values open up additional input fields.

---

## 11. **Indicator/Status Handling and Navigation**

- Clean handling of indicators for navigation between main menu, details, and batch restore, supporting roll, F-keys, and conditional displaying.

---

# **Summary:**

- **Purpose:** Maintain, review, and restore batches from returned payment files. Offer a secure and logical way to restore previously processed data.
- **Features:**
    - Multi-level subfiles for ease of navigation and detail display.
    - Direct manipulation of physical and logical RPG files for quick batch copying.
    - Support for error handling, paging, and robust navigation.
    - Handles special proposal/accounting flows for certain batch types.
- **User Flow:**
    1. Initialize and display available return batches.
    2. User picks a batch to restore or view in detail.
    3. Upon selection, batch is safely restored and backup cleaned up.

**Note:** The code is fully annotated in Norwegian, consistent with good RPG/400 practice, and makes extensive use of packed structures, overlays, and indicators for performance and clarity in the original IBM green-screen environment. It is a robust and well-documented example of batch file maintenance in a legacy finance application.