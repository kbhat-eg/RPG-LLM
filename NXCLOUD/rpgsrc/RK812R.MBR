     h/TITLE  Utskrift av autogiro - utplukk
     h option(*nodebugio) datedit(*dmy)
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RK812R                                              *
      * Beskrivelse . . : Utplukk til autogiro                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                                     *
      * Tilpasset for . :                                                     *
      *                                                                       *
      * Referanse  Dato   Endringsbeskrivelse                            Sign *
      * --------- ------  ---------------------------------------------- ---- *
      *                                                                       *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *                                                                 *
      *  BRUK AV INDIKATORER                                            *
      *       KA = F1  = Valg av firma                                  *
      *       KC = F3  = Exit                                           *
      *                                                                 *
      *       LR = Avslutt program                                      *
      *       30 = Protect av felter ved vise                           *
      *    31-59 = Varsle m/feilmeldinger/skjermindikatorer             *
      *    60-69 = Fileindikatorer chain etc.                           *
      *    70-79 = Arbeidsindikatorer i sub-rutiner                     *
      *    80-89 = Arbeidsindikatorer ordinære                          *
      *    90-99 = Benyttes ved std. sub-rutiner                        *
      *                                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     frktrl2    if   e           k disk    rename(rktrpfr:rktrl2r)
     frkunpf    if   e           k disk
     frkunlu    uf   e           k disk
     f                                     rename(rkunpfr:rkunlur)
     frkw4pf    o  a e           k disk
      *
     d                 ds
     d d_parm                       120
     d  pfirm                         3  0 overlay(d_parm)
     d  pnavn                        30    overlay(d_parm:4)
     d  puser                        10    overlay(d_parm:34)
     d  pkdat                         6  0 overlay(d_parm:44)
     d  praar                         4  0 overlay(d_parm:50)
     d  prper                         2  0 overlay(d_parm:54)
     d  pavdf                         4  0 overlay(d_parm:56)
     d  pavdt                         4  0 overlay(d_parm:60)
     d  pkatf                         4  0 overlay(d_parm:64)
     d  pkatt                         4  0 overlay(d_parm:68)
     d  pself                         4  0 overlay(d_parm:72)
     d  pselt                         4  0 overlay(d_parm:76)
     d  pknrf                         6  0 overlay(d_parm:80)
     d  pknrt                         6  0 overlay(d_parm:86)
6.NU d  pbilf                         8  0 overlay(d_parm:92)
6.NU d  pbilt                         8  0 overlay(d_parm:100)
     d  pfdat                         6  0 overlay(d_parm:108)
     d  palfa                         1    overlay(d_parm:114)
      *
     d                 ds
     d wkkey                         64
     d  rnfirm                        3  0 overlay(wkkey:2)
     d  rnkund                        6  0 overlay(wkkey:5)
     d  rnbdat                         d   overlay(wkkey:11)
     d  rntist                         z   overlay(wkkey:21)
     d                 ds
     d wkalfa                        64
     d  wnfirm                        3  0 overlay(wkalfa:2)
     d  rkalfa                       18    overlay(wkalfa:5)
     d  wnkund                        6  0 overlay(wkalfa:23)
     d  wnbdat                         d   overlay(wkalfa:29)
     d  wntist                         z   overlay(wkalfa:39)
     d                 ds
     d wwdato                         8  0
     d  wwaar                         4  0 overlay(wwdato)
     d  wwmnd                         2  0 overlay(wwdato:5)
     d  wwdag                         2  0 overlay(wwdato:7)
     d wnforf                         8  0
     d  wnforÅ                        4  0 overlay(wnforf)
     d  wnform                        2  0 overlay(wnforf:5)
     d  wnford                        2  0 overlay(wnforf:7)
      *
     d w_pdat                          d
      *
     d w_parm          s            120
     d wnrest          s                   like(rnrest)
     d wpakod          s              2  0
     d wpdat1          s              6  0
     d wpffir          s              3
     d wpfnav          s             30
     d wpokok          s              1
     d wpuser          s             10
     d wwwÅr           s                   like(wpakod)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Utplukk av kunder til autogiro                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c                   eval      rkfirm = pfirm
     c                   eval      rkkund = pknrf
     c     rkkey         setll     rkunpf
      *
     c     nykund        tag
      *
     c                   eval      *in61 = *off
     c                   read      rkunpf                                 61
      *
     c                   if        *in61 = *on
     c                   goto      xslutt                                       Avslutt
     c                   endif
      *
     c                   if        rkfirm <> pfirm                              Hele firma lest
     c                   goto      xslutt                                        avslutt
     c                   endif
      *
     c                   if        pknrf <> *zeros                              Fra kunde utfyllt
     c                   if        rkkund < pknrf                               F.o.m. kunde >
     c                   goto      nykund                                        les neste
     c                   endif
     c                   endif
      *
     c                   if        pknrt <> *zeros                              Til kunde utfyllt
     c                   if        rkkund > pknrt                               T.o.m. kunde <
     c                   goto      nykund                                        les neste
     c                   endif
     c                   endif
      *
     c                   if        rksent <> 1                                  Fullmakt ikke sendt
     c                   goto      nykund                                        les neste
     c                   endif
      *
     c*                  if        rkbetm <> 5                                  Betalingsmåte ikke a
     c*                  goto      nykund                                        les neste
     c*                  endif
      *
     c                   if        pavdf <> *zeros                              Fra avd. utfyllt
     c                   if        rkavde < pavdf                               F.o.m. avd. >
     c                   goto      nykund                                         les neste kunde
     c                   endif
     c                   endif
      *
     c                   if        pavdt <> *zeros                              Til avd. utfyllt
     c                   if        rkavde > pavdt                               T.o.m. avd. <
     c                   goto      nykund                                         les neste kunde
     c                   endif
     c                   endif
      *
     c                   if        pkatf <> *zeros                              Fra kat. utfyllt
     c                   if        rkkatg < pkatf                               F.o.m. kat. >
     c                   goto      nykund                                         les neste kunde
     c                   endif
     c                   endif
      *
     c                   if        pkatt <> *zeros                              Fra kat. utfyllt
     c                   if        rkkatg > pkatt                               T.o.m. kat. <
     c                   goto      nykund                                         les neste kunde
     c                   endif
     c                   endif
      *
     c*                  if        pself <> *zeros                              Fra selger utfyllt
     c*                  if        rkslgr < pself                               F.o.m. selger >
     c*                  goto      nykund                                         les neste kunde
     c*                  endif
     c*                  endif
      *
     c*                  if        pselt <> *zeros                              Fra selger utfyllt
     c*                  if        rkslgr > pselt                               T.o.m. selger <
     c*                  goto      nykund                                         les neste kunde
     c*                  endif
     c*                  endif
      *
     c     rkkey         chain     rkunlu                             10
      *
     c*                  move      *blank        rkf004                         KODE - Autogiro send
      *
     c                   if        *in10 = *off
     c*                  update    rkunlur
     c                   endif
      *
     c                   z-add     0             wnrest                         Nullstill sum til pu
      *
     c                   eval      wnfirm = *zeros
     c                   eval      wnkund = *zeros
     c                   eval      wnbdat = *loval
     c                   eval      wntist = *loval
     c                   eval      rnfirm = rkfirm
     c                   eval      rnkund = rkkund
     c*                  eval      rnbdat = *loval
     c*                  eval      rntist = *loval
      *
     c     xsetl         tag
      *
     c     rktrl2_key    setll     rktrl2
      *
     c     xloop         tag
      *
     c                   eval      *in51 = *off
      *
     c     rktrl2_key    reade     rktrl2
      *
     c*                  if        *in51 = *on
      *
     c*                  goto      endkun                                       AVSLUTT kunde
     c*                  endif
      *
     c*                  if        rnkund <> rkkund                             Hele KUNDE lest
     c*                  goto      endkun                                        avslutt KUNDE
     c*                  endif
      *
     c*                  if        rnfirm <> rkfirm                             Hele firma lest
     c*                  goto      endkun                                        avslutt KUNDE
     c*                  endif
      *
     c                   dow       not %eof(rktrl2)
     c                   if        rkafda <> *loval                             Fra dato utfyllt
     c                             and rnbdat < rkafda                          F.o.m. dato >
     c                   goto      les_ntr                                       les neste
     c                   endif
      *
     c                   if        rkatda <> *loval                             Til dato utfyllt
     c                             and rnbdat > rkatda                          T.o.m. dato <
     c                   goto      les_ntr                                       les neste
     c                   endif
      *
     c                   if        wwdato <> *zeros
     c     *ymd          move      wwdato        w_pdat
     c*                  move      rnforÅ        wnforÅ
     c*                  move      rnform        wnform
     c*                  move      rnford        wnford
     c*                  if        wnforf > wwdato
     c                   if        rnfdat > w_pdat
     c                   goto      les_ntr
     c                   endif
     c                   endif
      *
     c                   if        rnrekl = 'J'                                 Reklamasjon
     c                   goto      les_ntr                                       finnes, les
     c                   endif                                                    neste post
      *
     c                   if        rnrest <= 0                                  Restbeløp = 0
     c                   goto      les_ntr                                       les neste post
     c                   endif
      *
     c                   if        rnstat = 'A' or                              Autogiro sendt
     c                             rnauto = 'A'                                 Autogiro sendt
     c                   goto      les_ntr                                       les neste post
     c                   endif
      *
     c                   if        pbilf <> *zeros                              Fra kunde utfyllt
     c                   if        rnbiln < pbilf                               F.o.m. kunde >
     c                   goto      les_ntr                                       les neste
     c                   endif
     c                   endif
      *
     c                   if        pbilt <> *zeros                              Til kunde utfyllt
     c                   if        rnbiln > pbilt                               T.o.m. kunde <
     c                   goto      les_ntr                                       les neste
     c                   endif
     c                   endif
      *
     c                   if        rnvalb = *zeros
     c                   eval      rnvalb = rnbelØ
     c                   eval      rnvalr = rnrest
     c                   eval      rnvalk = 'NOK'
     c                   endif
      *
     c                   if        palfa = 'J'
     c                   eval      wnfirm = rnfirm
     c                   eval      wnkund = rnkund
     c                   eval      wnbdat = rnbdat
     c                   eval      wntist = rntist
     c                   eval      rwkkey = wkalfa                              Sortering
     c                   else
     c                   eval      rwkkey = wkkey                               Sortering
     c                   endif
      *
     c                   write     rkw4pfr                                      Skriv post
      *
     c                   add       rnrest        wnrest                         Summer beløp til pur
      *
     c     les_ntr       tag
     c     rktrl2_key    reade     rktrl2
     c                   enddo
      *
     c     endkun        tag
      *
     c*                  move      *blank        rkf004                         KODE - Purres
      *
     c                   if        wnrest <= 0
     c     rkkey         chain     rkunlu                             10
     c*                  move      'N '          rkf004                         KODE - Negativ/Null
      *c
     c                   if        *in10 = *off
     c*                  update    rkunlur
     c                   endif
      *
     c                   z-add     0             wnrest                         Nullstill sum til pu
     c                   endif
      *
     c                   goto      nykund                                       Les neste kunde
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Avslutt program                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xslutt        tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
      * Parameterliste
      *
     c     *entry        plist
     c                   parm                    w_parm
     c                   eval      d_parm = w_parm
      *
     c                   eval      wpakod = *zero
     c                   z-add     0             wpdat1
     c                   eval      wpokok = *blank
      *
     c                   move      *zero         wwdato
     c                   movel     pkdat         wwaar
     c                   move      wwaar         wwmnd
     c                   movel     wwaar         wwdag
     c                   move      pkdat         wwwÅr
     c                   eval      wwaar = wwwÅr
      *
     c                   if        wwwÅr < 81
     c                   movel     20            wwaar
     c                   else
     c                   movel     19            wwaar
     c                   endif
      *
      * Key for kunderegister
      *
     c     rkkey         klist
     c                   kfld                    rkfirm
     c                   kfld                    rkkund
      *
      * Key for kundeposteringer
      *
     c*    rnkey         klist
     c*                  kfld                    rnfirm
     c*                  kfld                    rnkund
     c*                  kfld                    rnbdat
     c*                  kfld                    rntist
     c     rktrl2_key    klist
     c                   kfld                    rnfirm
     c                   kfld                    rnkund
      *
     c                   endsr
