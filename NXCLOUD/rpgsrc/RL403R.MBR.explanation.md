```markdown
# Overview  
This RPG program (RL403R) processes supplier (“leverandør”) records and their postings, deletes old postings up to a given year, and inserts a single year-end balance entry for each supplier if there is any outstanding amount. It consists of:  
  1. **File definitions** – master supplier file and posting files  
  2. **Data definitions** – working fields, date/timestamp fields, parameter list  
  3. **Initialization subroutine** (`*INZSR`) – reads input parameters and sets up file keys  
  4. **Main logic** – loops through each supplier, invokes `POSTER` to delete/update postings, then writes one “31.12” balance record if needed  
  5. **POSTER subroutine** – reads and deletes individual postings prior to the year limit, accumulating totals  

---

## 1. File Definitions (`F` specs)  
- **frlevl1** (RL vendor master, alias `rlevl1r`)  
- **frltrl1** (RL vendor postings, alias `rltrl1r`)  
- **frltrlu** (update-capable view of RL vendor postings, alias `rltrlur`)  

These allow sequential reads (`reade`) on master and detail, and `chain`/`write`/`delete` on the update file.

---

## 2. Working-Storage Definitions (`D` specs)  
### Key fields  
- `rlevl1_firm` / `rltrl1_firm` / `rltrlu_firm` – company number key  
- `rltrl1_levr` / `rltrlu_levr` – supplier code  
- `rltrlu_bdat` / `rltrlu_tist` – posting date & timestamp  

### Totals and balances  
- `w_belø` – accumulated credit amount  
- `w_rest` – accumulated remainder amount  
- `w_aar` / `w_mnd` / `w_dag` via overlapped `w_dato` – used to build “31.12.(year−1)”  

### Counters & timestamps  
- `w_tell` / `w_tell_alf` – small numeric counter used to force unique timestamps  
- `rotist` / `robdat` – system time & date used for new records  

### Parameter list  
- Single 64-byte parameter `p_list`, overlaid by `d_raar` to extract the processing year  

### LDA fields (user-exit data area)  
- `l_user`, `l_firm`, `l_fnav` – logged-in user, company, program name for tracing  

---

## 3. Initialization (`*INZSR`)  
1. **Entry parameter**: `p_list` → copies into `d_list`, extracts `d_raar` (processing year).  
2. **Set working company**: `w_firm = l_firm` (LDA).  
3. **Define file key lists**:  
   - `rlevl1_key` keyed on `rlevl1_firm`  
   - `rltrl1_key` keyed on `(w_firm, rltrl1_levr)`  
   - `rltrlu_key` keyed on `(w_firm, rltrlu_levr, rltrlu_bdat, rltrlu_tist)`  

---

## 4. Main Processing Loop  
1. **Initialize totals**: `w_belø = 0`, `w_rest = 0`.  
2. **Read each supplier**  
   - `setll` and `reade` on `rlevl1r` (master file)  
   - Loop until end of file (`*in90 = *off`)  
3. **Call `POSTER` subroutine**  
   - Accumulates and deletes all postings for this supplier where `roraar < d_raar` and `rorest = 0`.  
   - Result: `w_belø` and `w_rest` contain totals for prior years.  
4. **If any balance exists** (`w_belø <> 0 or w_rest <> 0`):  
   a. Compute date = 31.12.(d_raar−1)  
   b. Initialize a unique timestamp loop:  
      - Set `w_tell = 1`  
      - LABEL `RLTRLU_TST`:  
        - Move `w_tell` → `w_tell_alf`, get current `time` → `rotist`  
        - Build composite timestamp `w_tmst_20 = rotist + w_tell_alf`, then move back → `rotist`  
        - Populate key fields for update file, `chain` on `rltrlur` to test existence  
        - If found (`*in91 = *off`), increment `w_tell` and repeat label  
   c. Once unique, fill all remaining posting fields:  
      - `robelø = w_belø`, `rorest = w_rest`, `roraar = w_aar`, `rorper = 12`, `rofdat = robdat`  
      - `robilk = 98`, `rotext = 'Saldo pr. 31.12.' // w_aar`  
      - Other numeric or character fields set to zero or blanks  
   d. For version 6.10 tracing: set `roodat`, `rootim`, `roousr`, `roedat`, `roetim`, `roeusr` from LDA & system time  
   e. `write rltrlur` – inserts the new balance record  
5. **Reset totals** and loop back to next supplier  
6. **End program** by setting `*inlr = *on` and `return`  

---

## 5. POSTER Subroutine  
Purpose: scan and delete qualifying old postings, accumulating their values.  
1. Initialize key fields to current supplier, `setll` / `reade` on `rltrl1r` (posting file)  
2. Loop until end of file  
3. If `roraar < d_raar` *and* `rorest = 0` (i.e. fully settled prior-year postings):  
   - Add `robelø` ➔ `w_belø`, `rorest` ➔ `w_rest`  
   - Populate key for update file and `chain rltrlur`  
   - `delete rltrlur` – remove the posting record  
4. Continue reading next detail record  
5. Return to the caller  

---

## Key Points & Patterns  
- **Year cutoff**: driven by parameter `d_raar`; old postings are removed up to December 31 of the previous year.  
- **Unique timestamp logic**: uses `time` + a small counter to guarantee no duplicate key when writing new balance lines.  
- **Use of `chain` + `delete`** vs. direct `reade` on update-capable file: ensures removal of detail records.  
- **Trace fields** (version 6.10): records who/when the balance record was created.  

This structure lets you purge detailed postings for past years and replace them with a single annual summary entry per supplier.