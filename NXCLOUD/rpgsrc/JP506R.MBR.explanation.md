# RPG Program JP506R: Onboarding and Code Walkthrough

This RPG/400 (ILE RPG) program is designed for AS/400 (IBM i) and is focused on "Betingelse", i.e. selecting and managing conditions (pricing, discounts, net prices, etc.) for order lines, possibly in a purchasing/order management context.

Below you'll find a breakdown of critical parts of the program, key concepts and subroutines, and guidance for onboarding new engineers.

---

## 1. **Overview and Intent**

- **Purpose:**  
  Enables users to view, select, and work with "betingelser" (conditions) for orders. The program allows navigation through various "nivåer" (levels) of purchasing or pricing conditions, updating, displaying info, and calculating net prices or discounts.
- **Interaction:**  
  Uses display files (workstn) with subfile handling, provides action screens, selection, and detail view for entries.

---

## 2. **File Declarations**

### Physical Files:
- Files like `jbetlb`, `jbetlc`, `jbetl1`, etc., are declared IF (input file), most likely containing condition records.
- Files are renamed for local logical names, e.g. `rename(jbetpfr:jbetlbr)`.

### Display Files:
- `jbp506d` is declared CF (combined file) for display with subfiles (`b1sfl`), control records, etc.
- `infds(dspfbk)` gets display feedback information.

---

## 3. **Data Structures and Variables**

- **Parameters:**  
  Variables starting with `p_` are input (and output) parameters to the program. E.g. `p_firm`, `p_ldor` (supplier), `p_vare` (item), etc.
- **Local Variables:**  
  Used for navigation, temporary storage, and control flags, e.g. `w_fcrn` (first record on page in subfile), `b_valg_ok` (selection successful), etc.
- **Keys:**  
  Many variables are key components for database access (used in `klist`/`chain`/`setll`).

---

## 4. **Indicator Usage**

- Standard RPG indicators control function:  
  - `LR` = End of program  
  - `*IN10`, `*IN12`, ... for function keys, subfile display, etc.  
  - `*IN14`, `*IN15` for clearing subfile and subfile end

---

## 5. **Main Control Flow**

The program is event-driven, looping around screen interactions and responding to user choices via function keys and subfile selections.

- **Alternate Entry (b2taga):**
  - Screen for command display (`b2cmd`)
- **Main Screen Logic (b2tagb):**
  - Calls `dsp_subfile` subroutine to display subfile
- **Function Key Handling:**  
  Special keys trigger actions (exit, refresh, page up/down, etc.)
- **Subfile Handling:**
  - Calls `subfile` subroutine to process user selection/action on subfile lines

---

## 6. **Subroutines and Their Roles**

Each subroutine (`begsr` / `endsr`) covers a specific functional block:

### **forny**
- Handles screen refresh (clear and recreate subfile).

### **subfile**
- Processes user input/selection from the subfile.
- Handles actions based on the value of `b1valg` (user's selection):
  - 1 = Selects a condition, updates output parameters.
  - 5 = Shows condition details (calls `xc2bld`).
  - 7 = View/handle rabattelement, may call external program `JP510R`.

### **xc2bld**
- Loads and displays detailed info about a selected condition including group texts, item description, dates, etc.

### **clr_subfile**
- Clears subfile and resets relevant counters/flags.

### **crt_subfile**
- Fills subfile with relevant data for current selection/context.
- For each entry, computes net price or discount (`finn_fant`).

### **dsp_subfile**
- Displays subfile, handles screen indicators, and remembers cursor position.

### **spørring**
- Placeholder for inquiry function (currently empty).

### **hent_nivå**
- **Core logic for hierarchical search of condition levels!**
- Looks up the most specific to most generic condition ("nivå").
- Searches through: item, module, group combinations (over-/hoved-/undergruppe), with/without item type and delivery type, with/without price group. Exits on first match.
- Ensures consistent fallback logic for finding applicable pricing condition.

### **finn_fant**
- **Calculates net price or discount factor** based on elements found for the relevant key.
- Reads through matching elements and applies percentage or net price logic depending on records.

---

## 7. **Initialization**

#### \*inzsr

- **Entry Parameter Mapping:**  
  Lists parameters expected by the program in input/output.
- **Key List Definitions:**  
  Keys (`klist`) for the various files used in database access.
- **Initial Data Load:**
  - Gets firm, supplier, and item info
  - Loads item text
  - Calls `hent_nivå` to get initial condition
  - Loads descriptions for matched level (supplier, group, module, etc.)
  - Positions and fills the subfile for display

---

## 8. **Key Technical Features**

- **Subfile Paging:**  
  Subfile logic supports paging, with counters for page, first, last record, etc.
- **Hierarchical Condition Matching:**  
  Sophisticated fallback search through condition levels, ensuring correct condition retrieval
- **Connection to External Programs:**  
  Calls to e.g. `JP510R` for additional info/actions

---

## 9. **Upgrade History / Comments**

- The source is annotated with change history and versioning, indicating evolution (e.g. price group handling, wider screen support).
- Extensive inline documentation aids in understanding indicator and field usage.

---

## 10. **Best Practices for New Developers**

- **Navigate the Subfile Model:**  
  Understand how paging, selection, and update are handled through indicators and variables.
- **Understand Key Fallback Logic:**  
  Focus on `hent_nivå` to see how the program determines which "betingelse" (condition) applies.
- **Trace Data Flow:**  
  Pay attention to how parameters are used, updated, and passed both internally and to external calls.
- **Extend with Care:**  
  When adapting, ensure you maintain the hierarchy of fallback and respect current indicator/flag usage.

---

## 11. **Diagrams**

### *Condition Search Path (`hent_nivå`):*

```text
Item+Type+Delivery+PriceGroup
  -> Item+Type+Delivery
  -> Item+Type
  -> Item
  -> Module+Type+Delivery
  ...
  -> Group/Module/Type combinations
  -> Most generic (on supplier)
```

### *Subfile Screen Cycle:*

```text
Entry -> Display Subfile -> Await User Action
   |       ^                    |
   v       |                    v
Detail/Selection <--- Process Action (Select / Show / External Call)
```

---

## 12. **Summary**

This program is a robust example of an RPG solution for managing hierarchical business rules (pricing/discounts). Its use of subfiles, fallback logic, and parameter-driven interactions make it flexible for various business scenarios. It is well-commented and structured for maintainability, but new team members should familiarize themselves with RPG's indicator-based logic and the specific file/field layout of the referenced physical/logical files. 

**When onboarding:**
- Start with understanding the subfile navigation (`crt_subfile`, `dsp_subfile`, `subfile`).
- Review how business keys are constructed and used in searches.
- Study the hierarchical search routine `hent_nivå` for business rule application.
- Recognize how data is displayed and selected through the interface.

Feel free to ask about specific subroutines or areas for a deeper technical dive!