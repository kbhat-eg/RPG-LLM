# RPG Program Overview and Explanation

This RPG program, named **RA534R**, is designed for IBM i (AS/400) systems using the ILE RPG programming language. It is primarily a display file program that handles subfile processing for "roller" (roles) queries. The source code includes several subroutines to manage subfile display, navigation, and database communication.

Below is a detailed explanation of the key components and logic within this program.

---

## 1. Header and Housekeeping

```rpg
h option(*nodebugio) datedit(*dmy)
```

- **option(*nodebugio)**: Disables debug IO; program can't be debugged at the IO operation level.
- **datedit(*dmy)**: Specifies date edit format (day-month-year).

The program includes a comment block describing the usage of indicators, customizations, and change references. This enhances maintainability and helps onboarding developers understand indicator usage.

---

## 2. File Definitions

```rpg
frukfl1    if   e           k disk    rename(rukfpfr:rukfl1r)
fra534d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- **frukfl1**: An input disk file, presumably containing roles, accessed by key. The record format `rukfpfr` is renamed as `rukfl1r`.
- **fra534d**: A display (workstation) file, with subfile support. Subfile control is managed with `b1sfl` as the subfile, with `w_srrn` as the relative record number.

---

## 3. Data Structure and Variable Declarations

### Parameters

```rpg
d p_firm          s                   like(ruffir)
d p_ftil          s                   like(ruftil)
d p_ftek          s                   like(ruftek)
```
- Parameters passed to the program, representing company (`firm`), role (`ftil`), and role description (`ftek`).

### Key Variables

```rpg
d rukfl1_ftil     s                   like(ruftil)
```
- Used to set a role key for positioning in the file.

### Working Variables

```rpg
d w_stel          s              4  0
d w_spge          s              4  0
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
d w_seqe          s              1
d b_valg_ok       s              1    inz(*off)
d w_firm          s                   like(ruffir)
d c_sfil          s              2  0 inz(8)
```
- Sequence counters, row/record tracking, page boundaries, and constants for subfile page size (`c_sfil = 8`).

---

## 4. Subfile and Indicator Conventions

**Commented Section:**  
Explains the use of indicators:
- 10, 11, 12, 13, 14, 15, 21, 22, 30, 31-99: Used for various subfile functions, error messages, cursor placement, and working storage.

---

## 5. Main Program Flow (Control Logic)

The core program structure uses tags and `goto` for flow control. The main display and event loop can be summarized as:

### Initial Display

```rpg
c     b2taga        tag
c                   write     b2cmd
```
- Sends the command key screen (`b2cmd`).

### Data Display Cycle

```rpg
c     b2tagb        tag
c                   exsr      dsp_subfile
```
- Calls subroutine to display subfile.

```rpg
c                   if        w_curn > 0
c                   eval      w_sfrn = w_curn / c_sfil
c                   eval      w_sfrn = w_sfrn * c_sfil + 1
c                   endif
```
- If there's a current record, calculates the first record number of the current page.

### Function Key Handling

```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inke
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   when      *in11
c                   exsr      bck_subfile
c                   goto      b2tagb
c                   when      *in21
c                   eval      *in22 = *on
c                   goto      b2taga
c                   endsl
```
- Checks which function key was pressed:
    - *inkc/*inkl: Exit program.
    - *inke: Refresh subfile.
    - *in10: Page forward.
    - *in11: Page backward.
    - *in21: Home key, set cursor handling.

### Subfile Processing

```rpg
c                   exsr      subfile
c                   if        b_valg_ok = *on
c                   goto      avslutt
c                   endif
c                   goto      b2taga
```
- Handles selection from subfile. If a selection is made (`b_valg_ok`), exits; otherwise, loops.

### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Ends the program (activates LR indicator).

---

## 6. Subroutines

Several subroutines encapsulate logic for various subfile and navigation operations.

### 6.1 forny - Refresh Subfile

```rpg
c     forny         begsr
c                   if        w_sfrn <> 0
c     w_sfrn        chain     b1sfl
c                   endif
c                   eval      rukfl1_ftil = *blank
c     rukfl1_key    setll     rukfl1
c                   exsr      clr_subfile
c                   exsr      crt_subfile
c     end_forny     endsr
```
- If not at the first record, repositions in the subfile.
- Resets key, clears, and rebuilds subfile.

### 6.2 posisjoner - Position Within Subfile

```rpg
c     posisjoner    begsr
c                   eval      w_seqe = *blank
c                   eval      rukfl1_ftil = b2ktil
c     rukfl1_key    setll     rukfl1
c                   eval      *in22 = *off
c                   exsr      clr_subfile
c                   exsr      crt_subfile
c                   eval      b1ktil = *blank
c                   eval      b2ktil = *blank
c                   eval      b2rtek = *blank
c                   endsr
```
- Positions to a specific role and rebuilds the subfile from there.
- Clears input fields (for new searches/positions).

### 6.3 subfile - Handle Subfile Input

```rpg
c     subfile       begsr
c                   if        *in22 = *off
c                   eval      *in22 = *on
c                   else
c                   eval      *in22 = *off
c                   endif
c                   eval      w_virn = w_sfrn
c                   do        w_ssrn
c                   readc     b1sfl
c                   if        %eof
c                   leave
c                   endif
c                   eval      *in22 = *off
c                   eval      w_virn = w_srrn
c                   if        b1valg = 1
c                   eval      p_ftil = b1ktil
c                   eval      p_ftek = b1rtek
c                   eval      b_valg_ok = *on
c                   leave
c                   endif
c                   enddo
c     end_subfile   endsr
```
- Toggles indicator, processes user selection in subfile.
- If a record is selected (b1valg=1), captures data and flags to exit.

### 6.4 clr_subfile - Clear Subfile

```rpg
c     clr_subfile   begsr
c                   eval      *in14 = *on
c                   write     b2ctl
c                   eval      *in14 = *off
c                   eval      *in15 = *off
c                   eval      w_srrn = 0
c                   eval      w_sfrn = 0
c                   eval      w_ssrn = 0
c                   eval      w_spge = 0
c                   endsr
```
- Clears subfile and control area. Resets related counters.

### 6.5 crt_subfile - Create/Populate Subfile

```rpg
c     crt_subfile   begsr
c                   eval      w_spge = w_spge + c_sfil
c                   eval      w_srrn = w_ssrn
c                   dou       w_srrn = w_spge
c                   read      rukfl1
c                   if        %eof or ruffir <> w_firm
c                   eval      *in15 = *on
c                   leave
c                   endif
c                   eval      w_srrn = w_srrn + 1
c                   eval      rukfl1_ftil = ruftil
c                   eval      b1valg = 0
c                   eval      b1ktil = ruftil
c                   eval      b1rtek = ruftek
c                   write     b1sfl
c                   enddo
c                   if        w_srrn > w_ssrn
c                   eval      w_sfrn = w_ssrn + 1
c                   endif
c                   eval      w_ssrn = w_srrn
c                   eval      w_virn = w_sfrn
c                   endsr
```
- Reads up to `c_sfil` records from the database, populates the subfile with role data.

### 6.6 bck_subfile - Page Backwards in Subfile

```rpg
c     bck_subfile   begsr
c                   if        *in15
c     rukfl1_key    setgt     rukfl1
c                   readp     rukfl1
c                   endif
c                   eval      w_stel = 0
c                   dou       w_stel = w_ssrn + c_sfil
c                   readp     rukfl1
c                   if        %eof or ruffir <> w_firm
c                   leave
c                   endif
c                   eval      w_stel = w_stel + 1
c                   eval      rukfl1_ftil = ruftil
c                   enddo
c                   if        %eof
c     rukfl1_key    setll     rukfl1
c                   endif
c                   exsr      clr_subfile
c                   exsr      crt_subfile
c                   endsr
```
- Reads backwards in the file to fill the subfile with the previous page of records.

### 6.7 dsp_subfile - Display Subfile

```rpg
c     dsp_subfile   begsr
c                   if        w_srrn <> 0
c                   eval      *in12 = *on
c                   else
c                   write     b2cmd
c                   endif
c                   eval      *in13 = *on
c                   exfmt     b2ctl
c                   eval      *in12 = *off
c                   eval      *in13 = *off
c                   endsr
```
- Sets indicators for displaying the subfile, or shows command screen if no rows.

### 6.8 *inzsr - Initialization Subroutine

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_ftil
c                   parm                    p_ftek
c     rukfl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rukfl1_ftil
c                   eval      w_firm = p_firm
c                   eval      *in22 = *on
c                   eval      rukfl1_ftil = *blank
c     rukfl1_key    setll     rukfl1
c                   exsr      crt_subfile
c                   endsr
```
- Sets program parameters, initializes work variables, positions in database, and loads the first subfile page.

---

## 7. Subfile Concepts Used

- **Subfile**: A type of on-screen list; allows for paging, scrolling, and record selection.
- **Subfile Control Record** (`b2ctl`): Controls the subfile display, navigation, and command key processing.
- **Indicators**: Used to control subfile operations (clear, display, add, etc).

---

## 8. Summary of Program Flow

1. **Initialize** using parameters and load the initial subfile page.
2. **Display** the screen and wait for function key or user selection.
3. **On navigation keys**: move forward/back in the list, reload the subfile.
4. **On selection**: save the selection and exit.
5. **On exit keys**: End the program.

---

## 9. Commentary

- **Structure**: Uses tags and subroutines to manage classic green-screen navigation.
- **Business logic**: Handles selection and display of "roles" or similar records from a physical file.
- **Extensibility**: Program is modularized with subroutines, making it easier to maintain.

---

## 10. Common Use Cases

- Finding and selecting a role record for further processing in an application.
- Browsing through records with page forward and backward functionality.
- Allowing fast positioning via search criteria.

---

## 11. Onboarding Notes

- Understanding subfile programming and IBM i indicators will be essential.
- RPG III/400 style coding is used (tag/goto, non-prototyped calls).
- The code uses Norwegian variable/comment naming conventions; some Norwegian reading skill is helpful.
- Key variables for subfile row control: `w_srrn`, `w_ssrn`, `w_sfrn`, `c_sfil`.

---

## 12. References

- [IBM RPG IV Reference](https://www.ibm.com/docs/en/i/7.4?topic=language-rpg-iv)
- Subfile processing in RPG: [IBM Knowledge Center](https://www.ibm.com/docs/en/i/7.4?topic=files-subfile-examples)

---

This program provides a robust foundation for green-screen subfile processing, supporting selection, navigation, and search on IBM i.