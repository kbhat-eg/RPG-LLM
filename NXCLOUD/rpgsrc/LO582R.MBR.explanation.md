# Documentation: Program LO582R

## Overview

**Program:** LO582R  
**System:** ASLAGR  
**Description:**  
This program generates a report listing "holes" (gaps) in the order number series within the SOHEPF file. It is primarily used to identify missing numbers in the order header register for a given year and number range, supporting audit and data integrity purposes.

**Revision History:**
- 210611 NHO: New program.
- 230614 bof: Updated for number range extension.

---

## Purpose

LO582R scans the SOHEPF (order header) file for a specified company and year, within a user-defined order number range. It identifies and prints any missing order numbers (i.e., numbers that are not present in the file but should exist according to the sequence). The report is output to a printer file.

---

## Structure and Flow

### File Declarations

- **sohel3**  
  - Type: Input, keyed, external  
  - File: SOHEPF  
  - Renamed record format: sohepfr → sohel3r  
  - Role: Source of order header data.

- **lo582p**  
  - Type: Output, printer  
  - User open (`usropn`): File is explicitly opened in code.  
  - Role: Report output.

### Parameters

The program receives the following parameters at entry (via *ENTRY PLIST):

| Name    | Length | Description                               |
|---------|--------|-------------------------------------------|
| p_aarr  | 4,0    | Year to process (År)                      |
| p_a1fr  | 8,0    | Start order number (Fra)                  |
| p_a1ti  | 8,0    | End order number (Til)                    |
| p_a2fr  | 8,0    | (Unused in this code segment)             |
| p_a2ti  | 8,0    | (Unused in this code segment)             |
| p_a3fr  | 8,0    | (Unused in this code segment)             |
| p_a3ti  | 8,0    | (Unused in this code segment)             |
| p_pf03  | 1,0    | (Purpose unclear, possibly a control flag)|

*Note: Only the first three parameters are actively used in the logic shown.*

### Local Data Area (LDA) Usage

- **l_user**: User ID (positions 911–920)
- **l_firm**: Company code (positions 944–946)
- **l_fnav**: (Purpose not detailed; positions 951–980)

The LDA is used to extract the current company code (`l_firm`), which is used as part of the key for file access.

### Key Field Variables

The program uses variables to build the composite key for accessing SOHEPF:
- **sohel3_firm**: Company code
- **sohel3_aarr**: Year
- **sohel3_numm**: Order number
- **sohel3_suff**: (Suffix, not used in this logic)

---

## Main Logic

### 1. Program Initialization

- The program begins by calling the `les` subroutine, which performs the main processing.
- After processing, the program sets *INLR = *ON to close files and return control.

### 2. Subroutine: les (Main Processing Loop)

#### a. Report Setup

- Opens the printer file (`lo582p`).
- Prints the report heading (`a1hdr`).

#### b. Key Initialization

- Sets up the key fields for the initial read:
  - `sohel3_aarr` = input year (`p_aarr`)
  - `sohel3_firm` = current company from LDA (`l_firm`)
  - `sohel3_numm` = input start order number (`p_a1fr`)

- Positions the file at the key (`setll sohel3`).

#### c. Main Read Loop

- Reads the next record (`read sohel3`).

- **End-of-file/Range Checks:**
  - If EOF, or if the year or order number exceeds the specified range, the program exits.

- **Order Number Tracking:**
  - A flag (`første`) is used to distinguish the first iteration.
  - For the first record, increments `sohel3_numm` by 1 (to begin searching for holes after the first found order number).
  - On subsequent reads, increments `første` by 1.

#### d. Gap Detection Loop (`neste` tag)

- Compares the current order number (`sonumm`) with the expected (`sohel3_numm`):
  - **If `sonumm` > `sohel3_numm`**:  
    - A gap is detected.  
    - The missing order number (`sohel3_numm`) is printed in the report (`d1det`).  
    - Handles page overflow by reprinting the heading if needed (`a1hdr`).  
    - Increments `sohel3_numm` and repeats the check (continues to print all missing numbers up to the current record).
  - **If `sonumm` = `sohel3_numm`**:  
    - No gap; proceeds to read the next record.

#### e. Loop Exit

- The process repeats until all records in the specified range are processed, or until the end of the range is reached.

---

## Key Design Decisions & Conventions

- **Composite Keying**: The program uses a composite key (firm, year, order number) for precise file positioning and to support multi-company environments.
- **LDA Integration**: Company context is dynamically retrieved from the LDA, supporting multi-tenant operation without hardcoding or parameterizing the company code.
- **Missing Number Reporting**: The logic is designed to detect and print every missing order number within the specified range, not just the first gap.
- **Printer File Handling**: The report file is explicitly opened and headings are managed to handle page overflows, ensuring report readability.
- **Unused Parameters**: The parameter list supports up to three number ranges, but only the first is used in this code. This likely supports future extensibility or compatibility with other programs.

---

## External Dependencies & Interactions

- **SOHEPF (sohel3)**: The order header file; must be defined in the environment and keyed as expected.
- **Local Data Area (LDA)**: Assumed to be populated with user and company context before program execution.
- **Printer File (lo582p)**: The output device for the report; must be defined and available.

---

## Business/Domain Logic

- The program is tailored for order management/audit in a multi-company, multi-year environment.
- It is used to ensure the integrity of order numbering, which is critical for regulatory compliance and operational accuracy.
- The ability to identify missing order numbers helps in detecting potential data corruption, manual deletions, or system errors.

---

## Summary

LO582R is a utility/reporting program to audit order number sequences in the SOHEPF file for a given company and year. It identifies and prints any missing order numbers within a specified range, supporting data integrity checks. The code is structured for maintainability, extensibility, and integration into a larger multi-company system.