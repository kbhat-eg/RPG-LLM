# RPG Program Explanation: ASOFAK (QO600R)
## Overview

This RPG/400 (ILE RPG) program is designed to manage the input and processing of parameters for order-related printouts, such as offers, confirmations, packing slips, and invoices. The program acts as a parameter-entry and control panel for printing different order documents, with built-in checks for user permissions, handling of reprints, and support for email integration.

**Key Features:**
- Selection of print type based on order type.
- User input via display file (`WORKSTN`) and various validation checks.
- Integration with multiple database files (order header, order type, print queue, user registry, etc).
- Built-in logic to call dedicated print programs with relevant parameters.
- User permission checks for critical functions (e.g., invoicing, reprinting).
- Support for email as a print destination under certain conditions.
- Adaptation to changes in business logic (seen in detailed version comments).

---

## Main File Declarations

**Files Used:**
- `qo600d`: Display file, communication with the workstation (`WORKSTN` terminal).
- Multiple physical files containing order headers (`fohelu`), order type (`votyl1`), order print parameters (`fplolu`), and user registry (`fusrl1`). Many are renamed to facilitate record format referencing.

---

## Data Definitions

### Data Area Fields
- Various fields mapped to a Local Data Area (LDA), such as workstation id, user, firm number, etc.

### Parameters
- `p_firm`, `p_numm`, `p_suff`, `p_ipor`, etc: parameters received from the calling program or passed between routines.
- `p_acti`: an action code for downstream logic.

### Key Variables and Work Fields
- Work fields for keys (`w_firm`, `fohel1_numm`, etc.), temporary usage, options, and flags for different logical decisions in the code.

---

## Program Flow

### 1. **Select Screen by Order Type**
The program determines which "screen" (logical option selection for printout) to present based on the order type code (`vaoakk`), which is fetched from the order header, order pick parameter, or order type register (in that order).

- Offers (`vaoakk = 0`)
- Order confirmations/pick lists (`vaoakk = 1`)
- Packing slips (`vaoakk = 2`)
- Invoice/credit note (`vaoakk = 3`)

This logic uses a `CABEQ` (compare-and-branch) to jump to the relevant label (`E2TAG`, `E3TAG`, etc).

---

### 2. **Handling Each Document Type**

#### **E2TAG: Offers**
- Set routine marker, check for email integration (PROA).
- Reset answer/result fields relevant to the screen.
- Option to skip showing the screen.
- Validate print queue device.
- If email as output is selected and PROA is active, error is raised.
- Prepares fields for printout.

#### **E3TAG: Order Confirmation / Pick List**
- Similar steps: routine marker set, check PROA, initialize fields.
- Pulls alternative text (if configured) from the alternatives file.
- Validates print queue and checks if email output is allowed.

#### **E4TAG: Packing Slip**
- Similar initialization as above.
- Additional check: verifies if user is allowed to reprint packing slip (e.g., not already printed except for authorized users).
- Validates print queue device.

#### **E5TAG: Invoice / Credit Note**
- Similar process.
- Checks if the user is permitted to initiate invoicing.
- Validates print queue device.

---

### 3. **Update Order Header and Pluck Header Files**

#### **START Label**
- When printing is confirmed, updates the order header to status "in progress" (`fokode = 2`), records the user and timestamp.
- Updates or creates a corresponding "pluck header" (order print parameter record), writing or updating the output queue, print type, etc.
- Calls the print program (`QO604R`) if direct print is selected.

---

### 4. **Subroutines**

#### **SJK_PROA**
- Calls an external program (`AP608R`) to check if the PROA (email integration for printouts) is enabled for the current routine.
- Sets an indicator based on the result for later logic (e.g., disables email if not allowed).

#### ***INZSR (Initialization Subroutine)**
- Clears work fields and indicators.
- Sets up key lists for file access.
- Receives parameter list from the calling program, populates local variables accordingly.
- Loads the user registry record for the current user from LDA.

---

## **Other Notable Logic**

### **Device Validation**
- For any selected output queue, the program validates whether it is a valid device by calling another program (`FQPRTC`). If invalid, error indicators are set, and the user is prompted to re-enter.

### **Special Error Checking and Permissions**
- Several checks and error indicators prevent unauthorized actions:
    - Only certain users can start invoicing or reprint packing slips.
    - If email is chosen as output and PROA is not active, an error is raised.
- Many such checks set an indicator (e.g., `*IN33`, `*IN35`, etc.) and loop the user back to the prompt.

### **Handling of Multiple Alternatives**
- For certain document types, the user can select between alternatives (e.g., order confirmation vs. pick list), with dynamic text retrieved from the alternatives file if configured.

### **Version Control and Comments**
- The code is extensively commented with a changelog, version numbers, and remarks at each section, reflecting ongoing adaptations to business rules and system integrations.

---

## **Summary Table: Main Document Types and Program Flow**

| Document Type      | Jump Label | Key Steps (after selection)                                                                                                                                                                                                                 | Special Checks                          |
|--------------------|------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|
| Offer              | E2TAG      | Set routine, clear screen fields, skip screen if automated, validate device, set up email output if needed, prepare print parameters.                                                                                                      | PROA email checks                       |
| Confirmation/Pick  | E3TAG      | As above, plus dynamic loading of alternative texts for choice, similar email and device checks.                                                                                                                                            | Email/PROA, alternative validation      |
| Packing Slip       | E4TAG      | As above, but with extra logic preventing unauthorized reprints, user-level checks.                                                                                                                                                        | Reprint permission, email/PROA          |
| Invoice/CreditNote | E5TAG      | As above, with user-level permission check before proceeding to invoicing; otherwise, device and PROA checks.                                                                                                                               | Invoicing permission, email/PROA        |

---

## **Best Practices/Takeaways for Developers**
- **Error checking** is thorough; always look for indicator variables (`*INxx`) for error management.
- **Business rules** (like email printout, automated print, and user permission) are mostly handled via flags/fields and checked right before committing/printing.
- **Key lists** (`KLIST`) are used for file access, well-defined in the initialization routine.
- **Parameter passing** between programs and subroutines is common; always keep track of which parameters are entry vs. exit.
- **Extensible and versioned code**: Comments and block numbers provide traceability for changesâ€”useful for future maintenance.

---

## **Common Entry/Exit Points**
- **Entry:** The program always expects to be called with a parameter list (`*ENTRY PLIST`).
- **Exit:** `*INLR = *ON` signals program completion and cleanup.

---

## **References**
- Main files: `FOHELU`, `VOTYL1`, `VBLOL1`, `FPLOLU`, `FUSRL1`
- External program calls for device checking and PROA logic: `FQPRTC`, `AP608R`
- Print program called: `QO604R`

---

## **Summary**
This program is a central piece in the order-to-print process of an IBM i-based ERP system. It is responsible for orchestrating the user's intent when printing order-related documents, enforcing business constraints, managing necessary database updates, and integrating with both legacy print queues and email-based printout routines. 

If you are onboarding to maintain or enhance this code, pay special attention to the versioned comments for historical context, the structure of error/validation routines, and the way parameter and record keys are managed throughout the program. Always test changes to business logic in coordination with integrated modules (`QO604R`, `AP608R`, etc.) and validate against all document types.