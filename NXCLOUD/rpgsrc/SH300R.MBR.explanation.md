# Program SH300R – Reversal of Incoming Invoice to Purchase Order

## Overview

This program (`SH300R`) is part of the ASLAGR system and is responsible for reversing an incoming invoice (faktura) back to a purchase order (bestilling). The process involves:

- Reading invoice headers and details.
- Generating corresponding purchase order headers and lines.
- Updating inventory (lager) based on the reversed lines.
- Handling auxiliary registers for EDI (electronic data interchange) integration.
- Managing number generation and tracking.

This program is particularly relevant in scenarios where an incoming supplier invoice needs to be "rolled back" or re-established as a purchase order in the system for further processing or correction.

## File Usage and Relationships

The program interacts with several physical files (tables), each representing key business entities:

| File        | Alias      | Purpose                                   |
|-------------|------------|-------------------------------------------|
| SIHEPFR     | SIHEL1R    | Incoming invoice header                   |
| SIDTPFR     | SIDTL1R    | Incoming invoice details                  |
| LOHEPFR     | LOHELUR    | Purchase order header                     |
| LODTPFR     | LODTLUR    | Purchase order line                       |
| LSTSPFR     | LSTSL1R    | Status codes                              |
| LOTIST      | LOTII2R    | Supplementary register (EDI, etc.)        |
| FOHEPFR     | FOHEL1R    | Order header (for EDI-related logic)      |

- Files with `if` (input full procedural) are read/updated.
- Files with `uf` (update full procedural) are written to.
- Files are often renamed to a local alias for clarity and to support multiple logical views.

## Key Business Logic and Flow

### 1. Parameter Intake and Initialization

- The program expects parameters for company, year, invoice number, suffix, and order type.
- These are mapped into local variables and used to build keys for file access.
- Local Data Area (LDA) fields are used to track workstation ID, user, and file name for auditing.

### 2. Invoice Header Processing

- **Reads the invoice header** (`SIHEL1R`) using the provided key.
- If not found, the program exits.
- Calls subroutine `HNTNUM` to fetch/generate a new order number from a number register (via program `AS100R`).
- Checks if a purchase order header (`LOHELUR`) already exists for this number. If so, exits.
- **Creates a new purchase order header** by copying relevant fields from the invoice header.
    - Includes logistics, project, and financial fields.
    - Sets user and timestamp fields.
- **Writes the new purchase order header**.

### 3. EDI Supplementary Register (LOTII2R)

- If enabled (version 8.01+), the program checks and writes a post in the supplementary register for EDI integration.
- Determines a type code (`B` or `L`) based on the existence and type of the related order header (`FOHEL1R`).
- Populates audit fields (user, date, time).

### 4. Invoice Line Processing

- **Loops through all invoice detail lines** (`SIDTL1R`).
- For each line:
    - Deletes any existing purchase order line (`LODTLUR`) for this order/line combination (to prevent duplicates).
    - **Creates a new purchase order line** by copying fields from the invoice detail.
        - Includes item, quantity, pricing, project, and reference fields.
    - Writes the new purchase order line.
    - **Updates totals** (e.g., total item cost) for later update of the header.
    - **Calls `OPPD_LAGER` subroutine** to update inventory based on this line.

### 5. Update Purchase Order Header Totals

- After all lines are processed, updates the order header (`LOHELUR`) with accumulated totals.

### 6. Inventory Update (`OPPD_LAGER` Subroutine)

- Prepares a 128-byte record with all relevant inventory update fields.
- Calls external program `VL001R` to perform the actual inventory update.
- Constructs a reference string for traceability (e.g., "B:xxxxxx L:yyyy").

### 7. Number Register Handling (`HNTNUM` Subroutine)

- Calls external program `AS100R` to obtain/generate a new order number.
- Passes key fields and receives the new number for use in the order header and lines.

### 8. Program Termination

- Sets LR indicator to end the program cleanly.

## Notable Design Decisions and Conventions

- **Indicator Usage**: Standardized use of indicators (`60-69` for file I/O, `70-79` for subroutines, etc.), which is an established convention in this codebase.
- **Field Copying**: Extensive field-by-field copying from invoice to order structures, ensuring all relevant business data is preserved and mapped correctly.
- **Subroutine Structure**: Use of subroutines for number handling and inventory updates encapsulates external dependencies and keeps mainline logic cleaner.
- **Audit/Trace Fields**: Consistent updating of user, workstation, and timestamp fields for traceability.
- **Versioned Comments**: Comments with version numbers (e.g., `6.10`, `8.01`) document incremental changes and business requirements, especially for EDI and number field size extensions.
- **Supplementary Register for EDI**: From version 8.01, the program integrates with the new EDI module by writing to the `LOTII2R` file, supporting automated order transmissions.

## Integration Points

- **External Programs**:
    - `AS100R`: Number register handler (order number generation).
    - `VL001R`: Inventory update handler.

- **EDI Module**:
    - Writes to supplementary register (`LOTII2R`) for outgoing EDI orders.

- **Status Register**:
    - Reads status codes from `LSTSL1R` as part of initialization.

## Domain-Specific Notes

- The program is tailored for the Norwegian market (see field names and comments in Norwegian).
- The process of reversing an invoice to a purchase order is likely driven by business rules requiring traceability and correction in procurement and inventory systems.
- The design accommodates changes in numbering (e.g., order number length increases) and VAT code handling as per evolving requirements.

## Maintenance and Extensibility

- **Adding Fields**: When new fields are needed in order headers or lines, ensure both the copy logic and file definitions are updated.
- **EDI Integration**: Changes to EDI logic should be reflected in the supplementary register section.
- **Numbering Logic**: Any changes to order number generation should be coordinated with the `AS100R` program.

## Summary

SH300R is a core utility for reversing supplier invoices into purchase orders, ensuring that all related data (including inventory and EDI) is updated consistently. It is designed with modularity, traceability, and extensibility in mind, and integrates tightly with the broader ASLAGR system’s external programs and data structures.