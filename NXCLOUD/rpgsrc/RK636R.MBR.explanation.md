# Explanation of the RPG Source Code for "Utskrift av åpne poster - kunder"

This RPG III/IV program is used to print or export the open customer items (accounts receivable) for a company, with capabilities for generating both printed reports and XML output (for mail/PDF). Below is a structured explanation for onboarding developers, with focus on the main logic, key files, data structures, and important routines.

---

## 1. Header and Documentation

- **/TITLE** sets the program title.
- **Program Identification (RK636R):** Prints open customer items.
- **Change Log:** Documents program history, versioning, and enhancements (e.g., PDF output, mail support).

---

## 2. File Declarations

The `F`-specs define the files used:
- **rkunl1**: Customer master file (renamed as `rkunl1r`)
- **rktrl9**: Customer transaction file (renamed as `rktrl9r`)
- **aforl1**: Form routine register (renamed as `aforl1r`)
- **rk636p**: Printer file for report output, with user open (`usropn`) and overflow handling (`oflind(*in30)`)

---

## 3. Data Structures and Working Variables

### *Data Structures (D-specs)*

- **Company, customer, period & address info**: Variables like `w_firm`, `w_prfi`, `w_avde`, `w_fnav` etc.
- **Spool file info**: For outputting to PDF/XML, e.g., `splfname2`, `jobname2`, etc.
- **QSPRILSP API formats**: For querying spool files created by the job.
- **Local Data (UDS)**: Variables for various data fields related to the session.

---

## 4. Mainline Code Flow

### a) Initialization
- **Reads customer parameter**
- **Chains to the customer master**
- **Initializes transaction totals**
- **Writes report header**

### b) Processing
- **Calls subroutine (`exsr`) to read customer transaction entries**
- **Writes totals**

### c) End of Job
- **Sets last record indicator (`*INLR`)**
- **If PDF/XML output requested**: Closes files, generates XML, triggers PDF preview, calls external job finalization program

---

## 5. Subroutines

### A. `les_kuntr` (Read Customer Transactions)

- Loops through customer transactions.
- For each, checks against reporting period.
- Updates the running balance (`t1sald`).
- Writes a report detail line (`linje`).
- On page overflow, rewrites the header.
- Exits when transactions are exhausted.

### B. `spoolnbr` (Locate Spool File Created by Job)

- Uses the QSPRILSP API to retrieve info about the last spool file created.

### C. `xml_create` (Generate XML for Output)

- Clears/initializes variables for XML data.
- Prepares description and references for XML.
- Calls external program 'AP627R' to actually create the XML ("AP620R" commented out).
- Passes all job and tagging variables as parameters for XML generation.

### D. `pdf_preview` (Launch PDF in Browser)

- If user requested screen view, calls 'AP621R' to launch PDF in a browser (using `l_bach` as parameter).

### E. `*INZSR` (Initialization Subroutine)

- Reads job parameters.
- Prepares keys for master/trans files and form routine register.
- Reads form routine for PDF/XML setup.
- If company info needs to be pulled in, calls 'RØ707R' to populate address, phone, etc.
- Clears company info fields if not needed for output.

---

## 6. Key Points and Concepts

- **Customer Master/Transaction Handling**: Typical pattern in IBM i RPG for reading and correlating customer data with their open items.
- **Page overflow**: Handled via indicator `*IN30`.
- **Period Filtering**: Only processes transactions in or before the current period.
- **Flexible Output**: Allows printing, XML generation, and PDF preview/mail.
- **API/Program Calls**: Uses IBM i APIs (QSPRILSP) and site-specific programs for advanced output features.
- **Conditional Processing**: Many operations depend on external flags and subroutine control logic.
- **Integration with External Systems**: XML and PDF routines bridge reporting with external document management or mail systems.

---

## 7. For New Developers

- **File Layouts**: Understand the structure of customer, transaction, and form files.
- **Indicators and Subroutines**: Note how classic indicators (`*IN62`, `*IN30`, etc.) and subroutines are used for logic flow.
- **Parameters**: Entry parameters and local data area (LDA/UDS) are used for session control.
- **External Programs**: The program depends on several external routines (`AP621R`, `AP627R`, etc.) for advanced output—source for these will be needed for end-to-end understanding.

---

## 8. Summary

This program is a typical example of IBM i (AS/400) RPG legacy code for reporting, modernized to support XML/PDF integration and mail automation. It demonstrates both old-style RPG coding practices (indicators, subroutines, LDA/UDS) and more modern enhancements for output flexibility. New developers should familiarize themselves with the file layouts, data flow, and how the program integrates with both RPG and external system components.