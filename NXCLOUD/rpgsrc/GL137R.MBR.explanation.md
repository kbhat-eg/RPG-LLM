# Program Documentation: GL137R – Bank Transfer Inquiry

## Overview

**System:** ASBANK  
**Program:** GL137R  
**Purpose:**  
This program provides an inquiry (spørring) into transfers made to the bank, presenting summary statistics per month for a given company and group. It is a display file (workstn) program using subfiles to present monthly aggregated data, and it supports user-driven refresh and navigation.

The program is part of the ASBANK system and is tailored for financial or payroll departments tracking transfer activity to banks, likely for reconciliation or audit purposes.

---

## Functional Summary

- **Display monthly transfer statistics** for a selected company and group.
- **Aggregate counts** of two types of records:  
  - Transfers (from file GKBFL1, "BETFOR23")
  - First-time returns (from file GBTRL2, type 'TL1', "BETFOR22")
- **Interactive subfile**: Allows users to page, roll, and refresh data.
- **User controls**: F3 (Exit), F5 (Refresh), F12 (Cancel), rolling and paging through subfiles.
- **Retrieves and displays company name** via external call to `GL136C`.

---

## File and Display Relationships

- **Display File:** `GL137D` (workstn, subfile B1SFL, control record B2CTL, command keys B2CMD)
- **Physical Files:**
  - `GKBFL1` (Transfer records, keyed)
  - `GBTRL2` (Return records, keyed)

---

## Key Data Structures

### Subfile Control

- **srrn01, sfrn01, ssrn01, spge01:**  
  Used for tracking subfile relative record numbers, first/last record per page, and page size (12 lines per page).
- **w_arow, w_acol:**  
  Used for window positioning (not actively used in this program, but part of display conventions).

### Date Handling

- **wpdato, wpdat2:**  
  8-digit packed dates, with overlays for year, month, day extraction.
- **wp�md, wpdat�, wpda2�, etc.:**  
  Overlays for extracting year, month, day from date fields.

### Company/Group Info

- **dsuser, dsfgrp, dsfirm, dsfnav:**  
  Slices of a user data structure, containing group, firm, and firm name.
- **wpfgrp, wpfirm, wpfnav:**  
  Working copies for group, firm, and firm name.

### Monthly Aggregation

- **s(12):**  
  Array of counts per month (Jan–Dec).
- **sum(12):**  
  Placeholder for summing amounts (not actively used in this code).
- **mnd(12):**  
  Array holding month names, loaded from compile-time data at end of source.

---

## Program Flow

### Initialization (`*INZSR`)

- Sets up working fields and keys.
- Initializes the year (`a1aar`) from system variable `uyear` (assumed current year), adding 2000.
- Prepares key lists for file access.

### Main Loop

1. **Subfile Load (`xcrt01`):**
   - Clears monthly counters.
   - Fetches company name via external program `GL136C`.
   - Reads and aggregates transfer counts from `GKBFL1` (all months, current year).
   - Reads and aggregates first-time return counts from `GBTRL2` (type 'TL1', "BETFOR22" only).
   - Populates subfile B1SFL with 12 rows (one per month), including group, firm, year, counts, and month name.

2. **Display and User Interaction:**
   - Presents subfile via control record.
   - Handles user commands:
     - **F3:** Exit program
     - **F5:** Refresh data (re-read files and reload subfile)
     - **Roll:** Reload next/previous page (though only 12 lines, so paging is limited)
   - Handles subfile selection (not used in this context, but code structure supports it).

3. **Refresh (`xforny`):**
   - Resets group and firm from user data.
   - Clears and reloads subfile.

4. **Subfile Clear (`xclr01`):**
   - Sets indicators to clear subfile display.
   - Resets subfile counters.

5. **Display Subfile (`xdsp01`):**
   - Sets indicators for subfile display and control.
   - Displays control record (B2CTL) with subfile.

---

## File Processing Details

### Reading `GKBFL1` (Transfers)

- Reads all records for the selected firm and year.
- For each record, increments the counter for the corresponding month.
- Uses key lists `key01` and `key02` for positioning and reading.

### Reading `GBTRL2` (Returns)

- Reads all records for the selected group, firm, type 'TL1', and year.
- Only counts records where the transfer type in the record is 'BETFOR22'.
- Increments monthly counters as appropriate.

---

## External Program Calls

- **GL136C**:  
  Called to retrieve the company name (`wpfnav`) for display, using group and firm as parameters.

---

## Indicators and Conventions

- **Indicators**:
  - *KC (F3) = Exit
  - *KE (F5) = Refresh
  - *KL (F12) = Cancel
  - *IN10 = Roll
  - *IN12/13/14/15/16 = Subfile display/control/clear/end/no more records
  - *IN60 = File EOF
- **Subfile Paging**:  
  Subfile is sized for 12 records (one per month). Paging logic is present but not strictly necessary unless the design is extended for more records.

---

## Business/Domain Logic

- **Monthly Aggregation**:  
  Transfers and returns are counted per month for the selected year, group, and firm.
- **BETFOR23 and BETFOR22**:  
  These are business codes indicating types of transactions:
  - "BETFOR23" (from GKBFL1): Standard transfer
  - "BETFOR22" (from GBTRL2): First-time return, type 'TL1'
- **Company/Group Context**:  
  All queries and aggregations are scoped to the selected group and firm, which are populated from user context.

---

## Design Notes

- **Subfile-based UI**:  
  The program uses a single subfile page for summary display. The structure supports extensions for more pages or additional subfiles.
- **Legacy RPG/400 style**:  
  The code uses fixed-format C-specs, data structures, and overlays, which is typical for legacy IBM i RPG codebases.
- **Indicator Usage**:  
  Follows a consistent indicator convention for subfile and function key handling, as documented in program comments.
- **Modularization**:  
  File reading and subfile loading are encapsulated in subroutines for clarity and reuse.

---

## Interactions with Other Modules

- **GL136C**:  
  External program call to retrieve company name.
- **Display files**:  
  Uses multiple display records for subfile, control, and command key handling (B1SFL, B2CTL, B2CMD).

---

## Key Points for New Developers

- **Monthly data is always shown for 12 months** (Jan–Dec), even if some months have zero transactions.
- **All file reads are scoped by year, group, and firm**; ensure these fields are set correctly in the context of the session.
- **Adding new transaction types or extending the subfile** would require changes to the aggregation logic and possibly the display file.
- **Indicator management is critical** for correct subfile and function key behavior.
- **Company name retrieval** is delegated to a separate program, which must be maintained in sync with company master data.

---

## Compile-Time Data

At the end of the source, the month names are loaded into the `mnd(12)` array for display purposes.

---

## Summary

GL137R is a monthly inquiry program for bank transfers, providing a summary view per month for a selected company and group. It aggregates two transaction types, supports subfile-based UI interaction, and is designed for extensibility within the ASBANK system. The codebase follows established RPG/400 conventions and is modularized for clarity and maintainability.