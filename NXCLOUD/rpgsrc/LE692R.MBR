     h option(*nodebugio) datedit(*dmy-) decedit('0.')
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Program . . . . : LE692R
      *  Beskrivelse . . : Utskrift av avvik-liste, - coolspool
      *                    Basert på LE612
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Spesialversjon. :
      *  Tilpasset for . :
      *
      *  Referanse  Dato   Endringsbeskrivelse                     Sign.
      *  --------- ------  -------------------------------------------------
8.xx  *  K0000     260922  Nytt program                            bsa
      *
      *
      *
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flsorl2    if   e           k disk    rename(lsorpfr:lsorl2r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
     flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
     flbchl1    if   e           k disk    rename(lbchpfr:lbchl1r)
     fvhisl1    uf   e           k disk    rename(vhispfr:vhisl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
     flxl2st    uf a e           k disk    rename(lxl2st:lxl2str)
      *
     fle692p    o    e             printer
     f                                     usropn
      *
      * Parameter-inn
      *
     d                 ds
     d d_prec                        64
     d  d_batc                       10    overlay(d_prec)
     d  d_fogr                        2  0 overlay(d_prec:11)
     d  d_togr                        2  0 overlay(d_prec:13)
     d  d_fhgr                        2  0 overlay(d_prec:15)
     d  d_thgr                        2  0 overlay(d_prec:17)
     d  d_fugr                        3  0 overlay(d_prec:19)
     d  d_tugr                        3  0 overlay(d_prec:22)
     d  d_fvar                       15    overlay(d_prec:25)
     d  d_tvar                       15    overlay(d_prec:40)
     d  d_flag                        2  0 overlay(d_prec:55)
     d  d_tlag                        2  0 overlay(d_prec:57)
     d  d_val1                        1  0 overlay(d_prec:59)
     d  d_val2                        1  0 overlay(d_prec:60)
      *
      * Definering av LDA
      *
     d                uds
     d l_poff                584    584
     d l_utqm                585    594
     d l_bach                595    635
     d l_arch                636    636  0
     d l_skje                637    637  0
     d l_land                638    638  0
     d l_exlp                639    639  0
     d l_mail                640    640  0
     d l_prfi                750    750  0
     d l_outq                810    819
     d l_copy                838    843  0
     d l_ruti                800    809
     d l_wsid                901    910
     d l_user                        10
     d l_filg                931    933
     d l_firm                944    946  0
     d l_avde                947    950  0
     d l_fnav                951    980
      *
      * Definering av parametre
      *
     d b_pdfp          s              1    inz(*off)
     d b_deta          s              1    inz(*off)
     d b_tota          s              1    inz(*off)
     d b_line          s              1    inz(*off)
     d b_inlr          s              1    inz(*off)
      *
      * Definering av variable i parametre
      *
     d p_vare          s             15
     d p_lety          s              1  0
     d p_dato          s                   like(lcedat)
     d p_enhe          s              3
     d p_sapr          s              9  2
     d p_gmpr          s              9  2
     d p_kopr          s              9  2
     d p_inpr          s              9  2
     d p_str_in        s            512
     d p_str_out       s            512
     d p_avsl          s            100
     d p_filn          s            256
     d p_fnav          s             50
     d p_mime          s            150
     d p_rec1          s             50
     d p_rec2          s             50
     d p_rec3          s             50
     d p_subj          s            100
     d p_bcc           s              1
     d p_pers          s             50
     d p_txt1          s            100
     d p_txt2          s            100
     d p_txt3          s            100
     d p_txt4          s            100
     d p_lage          s              2  0
      *
      * Definering av variable i nøkler
      *
     d aforl1_ruti     s                   like(afruti)
     d lstsl1_firm     s                   like(laafir)
     d lbchl1_batc     s                   like(lcbatc)
     d vhisl1_lage     s                   like(vhlage)
     d vhisl1_vare     s                   like(vhvare)
     d vhisl1_dato     s                   like(vhdato)
     d vhisl1_time     s                   like(vhtime)
     d vvarl1_vare     s                   like(vvvare)
     d vlagl1_vare     s                   like(vlvare)
     d vlagl1_lage     s                   like(vllage)
      *
      * Definering av variable
      *
     d w_parm          s             64
     d w_firm          s                   like(lwfirm)
     d w_antl          s                   like(lwantl)
     d w_slag          s                   like(lwlage)
     d w_avde          s              4  0
     d w_prgr          s              1
     d w_vtyp          s              1
     d w_nobb          s                   like(vvnobb)
     d w_ldor          s              6  0
     d w_utda          s                   like(lcedat)
     d w_lv_nobb       s                   like(vvnobb)
     d w_lv_modn       s                   like(vvnmod)
     d w_lv_lldo       s                   like(vvldor)
     d w_lv_llva       s                   like(vvlvar)
     d w_plas          s             50
     d w_pla1          s             50
     d w_pla2          s             50
     d w_kode          s              1
     d w_fell          s              6
     d w_type          s              2
     d w_fast          s             10
     d w_numm          s              8  0
     d w_exsql         s          10000
     d w_sqlwhere      s           8000
     d w_excel_url     s            100
     d w_exmap         s             30    inz('excel')
     d w_exfil         s             50    inz('Lageravvik')
     d w_extyp         s              4    inz('XLS')
      *
     d b_sykl          s              1    inz(*off)
      *
     d w_ddmy          s              6  0
     d w_prfi          s              1  0
     d w_ffir          s              3  0
     d w_fnav          s             30
     d w_fad1          s             30
     d w_fad2          s             30
     d w_fste          s             30
     d w_fftx          s             30
     d w_tfax          s              8
     d w_ftlf          s             11
     d w_ffax          s             11
     d w_mail          s             50
     d w_weba          s             50
     d w_head          s             75
      *
     d w_bdat          s               d   datfmt(*iso)
     d w_date          s               d   datfmt(*iso)
     d w_time          s               t   timfmt(*iso)
     d w_dato2         s             12  0
     d w_ruti          s             10
     d w_pdf           s              1  0
     d w_jnav          s             15
     d w_jkey          s             41
     d w_jtxt          s             35
     d w_pdf_ds        s            512
     d w_mtxt          s            300
     d w_jstat         s              2  0
     d w_jtext         s            200
     d w_text          s            200
     d w_ogtx          s             50
     d w_hgtx          s             50
     d w_ugtx          s             50
     d w_khtx          s             50
     d w_ltek          s             50
     d w_land          s              9
     d w_mark          s              5
     d w_spol          s              5
     d w_x             s              3  0
     d w_path          s            256
     d w_ema2          s             50
     d w_ttype         s              1
     d w_draw1         s             10
     d w_draw2         s             10
     d w_dspl          s            100
     d w_tek1          s            512
     d w_tek2          s            512
     d w_copy          s              3  0
     d w_faks          s             30
     d w_pemne         s             75
     d w_ptxt1         s             75
     d w_ptxt2         s             75
     d w_ptxt3         s             75
     d w_ptxt4         s             75
     d w_ppers         s             75
     d w_rekv          s             50
     d w_1fnav         s             50
     d w_1fad1         s             50
     d w_1fad2         s             50
     d w_1navn         s             50
     d w_1gate         s             50
     d w_1adr2         s             50
     d w_txt1          s             75
     d w_rtyp          s             50
     d w_txt2          s             50
     d w_mime          s             24
     d t_spsu          s             11  2
     d t_kpsu          s             11  2
     d t_topp          s             11  2
     d t_totl          s             11  2
     d t_totd          s             11  2
     d t_todp          s             11  4
     d t_text          s             75
      *
     d p_btyp          s            100
      * Eksternt program
       dcl-s co402_verdi1  char(1);
       dcl-s co402_verdi2  char(2048);
       DCL-PR CO402R EXTPGM('CO402R');
         p_filgrp            char(3)     const;
         p_firm              packed(3:0) const;
         p_lager             packed(2:0) const;
         p_nokkel            char(50)    const;
         p_verdi1            char(1);
         p_verdi2            char(2048);
       END-PR;
      *u_711           s              1    inz(*off)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av LAGER-RECORD-Opplysninger
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     les_neste     tag
     c                   read      lsorl2
     c                   if        %eof
     c                   goto      slutt
     c                   endif
      *
      * Brudd på lager?
      *
     c                   if        w_slag <> 0 and
     c                             w_slag <> lwlage
     c                   exsr      lagut
     c                   endif
     c                   eval      w_slag = lwlage
      *
      *  Legger inn data i utskrifts-felter
      *
     c                   exsr      hent_lage
     c                   exsr      hent_pris
     c                   exsr      hent_vare
     c                   exsr      hent_lagvare
      *
     c                   if        lwantt > 99999,999
     c                   eval      lwantt = 99999,999
     c                   endif
     c                   if        lwantt < -99999,999
     c                   eval      lwantt = -99999,999
     c                   endif
      *
     c                   if        w_antl > 99999,999
     c                   eval      w_antl = 99999,999
     c                   endif
     c                   if        w_antl < -99999,999
     c                   eval      w_antl = -99999,999
     c                   endif
      *
     c                   eval      d1lage = lwlage
     c                   eval      d1vare = lwvare
     c                   eval      d1tek1 = lwtek1
     c                   eval      d1antt = lwantt
     c                   eval      d1enh1 = lwenh1
     c                   eval      d1antl = w_antl
     c                   if        (lwantt - w_antl) > 99999
     c                   eval      d1diff = 99999,999
     c                   else
     c                   eval      d1diff = lwantt - w_antl
     c                   endif
     c                   eval      d1spny = p_sapr
     c                   eval      d1kpny = p_kopr
     c                   eval(h)   d1spsu = d1spny * d1diff
     c                   eval(h)   d1kpsu = d1kpny * d1diff
     c                   eval(h)   d1topp = d1kpny * lwantt
     c                   eval(h)   d1totl = d1kpny * w_antl
     c                   eval(h)   d1totd = d1kpny * d1diff
     c                   if        d1totd < 0
     c                   eval      d1totd = d1totd * -1
     c                   endif
      *
      *  Sjekk, Skal det bare skrives ut varer med differanse
      *
     c                   if        d_val2 = 1
     c                   if        d1diff = *zero
     c                   goto      les_neste
     c                   endif
     c                   endif
      *
      *  Sjekk, Skal det bare skrives ut varer med 0 i antall tellet
      *
     c                   if        d_val2 = 2
     c                   if        d1antt > *zero
     c                   goto      les_neste
     c                   endif
     c                   endif
      *
      *  Sjekk, Skal det bare skrives ut negativ differanse
      *
     c                   if        d_val2 = 3
     c                   if        d1diff >= *zero
     c                   goto      les_neste
     c                   endif
     c                   endif
      *
      *  Sjekk, Skal det bare skrives ut positiv differanse
      *
     c                   if        d_val2 = 4
     c                   if        d1diff <= *zero
     c                   goto      les_neste
     c                   endif
     c                   endif
      *
      *  Sjekk, Skal det bare skrives uten differanse
      *
     c                   if        d_val2 = 5
     c                   if        d1diff <> *zero
     c                   goto      les_neste
     c                   endif
     c                   endif
      *
      *  Akkumulerer til totalfelter
      *
     c                   eval      l1spsu = l1spsu + d1spsu
     c                   eval      l2spsu = l2spsu + d1spsu
     c                   eval      l1kpsu = l1kpsu + d1kpsu
     c                   eval      l2kpsu = l2kpsu + d1kpsu
     c                   eval      l1topp = l1topp + d1topp
     c                   eval      l2topp = l2topp + d1topp
     c                   eval      l1totl = l1totl + d1totl
     c                   eval      l2totl = l2totl + d1totl
     c                   eval      l1totd = l1totd + d1totd
     c                   eval      l2totd = l2totd + d1totd
      *
      *  Skriver ut vanlige varer
      *
     c   70              if        lwnumm = *zero
     c                   if        1=2
     c                   write     d1det                                30
     c                   exsr      ovflow
     c                   endif
      * Skriver XML tagger for detaljer
     c                   exsr      xml_deta
     c                   endif
      *
     c                   goto      les_neste
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     slutt         tag
      *
     c                   exsr      lagut
     c                   exsr      firut
      *
     c                   if        1=2
     c                   close     le692p
     c                   endif
      *
      * Lag excel
      *
     c                   exsr      lag_excel
      *
      * Send mail
      *
     c**                 if        %trim(w_mail) <> *blanks
     c**                 exsr      send_mail
     c**                 endif
      *
      * Slett utvalget fra tabell
      *
     c                   exsr      rydd_xls
      *
      * Avslutt jobbid
      *
     c                   call      'AB710R'
     c                   parm                    l_bach
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
      *
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  LAGUT     Behandling av brudd på lager
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     lagut         begsr
      *
     c                   eval      l1todp = 0
     c                   if        l1totl <> 0
     c                   eval      l1todp = (l1totd/l1totl)*100
     c                   endif
      *
     c                   if        1=2
     c                   write     l1tot                                30
     c                   exsr      ovflow
     c                   endif
      * Skriver XML tagger for detaljer
     c                   eval      t_text = 'Totalt lager:     '
     c                   eval      t_spsu = l1spsu
     c                   eval      t_kpsu = l1kpsu
     c                   eval      t_topp = l1topp
     c                   eval      t_totl = l1totl
     c                   eval      t_totd = l1totd
     c                   eval      t_todp = 0
     c                   if        t_totl <> 0 and
     c                             t_totd <> 0
     c                   eval      t_todp = (t_totd/t_totl)*100
     c                   endif
     c                   eval      l1spsu = 0
     c                   eval      l1kpsu = 0
     c                   eval      l1topp = 0
     c                   eval      l1totl = 0
     c                   eval      l1totd = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  FIRUT     Behandling av brudd på firma
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     firut         begsr
      *
     c                   eval      l2todp = 0
     c                   if        l2totl <> 0
     c                   eval      l2todp = (l2totd/l2totl)*100
     c                   endif
      *
     c                   if        1=2
     c                   write     l2tot                                30
     c                   endif
      * Skriver XML tagger for detaljer
     c                   eval      t_text = 'Totalt firma:     '
     c                   eval      t_spsu = l2spsu
     c                   eval      t_kpsu = l2kpsu
     c                   eval      t_topp = l2topp
     c                   eval      t_totl = l2totl
     c                   eval      t_totd = l2totd
     c                   eval      t_todp = 0
     c                   if        t_totl <> 0 and
     c                             t_totd <> 0
     c                   eval      t_todp = (t_totd/t_totl)*100
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  OVFLOW    Behandling av overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     ovflow        begsr
      *
      *  Skriver heading
      *
     c                   write     a1hdr                                30
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for å hente vareinformasjon
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     hent_vare     begsr
      *
      * Finn vareinformasjon
      *
     c                   eval      vvarl1_vare = lwvare
     c     vvarl1_key    chain     vvarl1
      * henter info om logistikk-vare
     c                   call      'VL710R'
     c                   parm                    w_firm
     c                   parm                    lwvare
     c                   parm                    lwlage
     c                   parm                    w_vtyp
     c                   parm                    w_utda
     c                   parm                    w_ldor
     c                   parm                    b_inlr
     c                   parm                    w_lv_nobb
     c                   parm                    w_lv_modn
     c                   parm                    w_lv_lldo
     c                   parm                    w_lv_llva
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for å hente lagerinformasjon
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     hent_lagvare  begsr
      *
     c                   eval      d1abck = *blanks
     c                   eval      w_plas = *blank
     c                   eval      w_pla1 = *blank
     c                   eval      w_pla2 = *blank
      *
     c                   eval      vlagl1_vare = lwvare
     c                   eval      vlagl1_lage = lwlage
     c     vlagl1_key    chain     vlagl1
      *
     c                   if        not %eof
     c                   eval      d1abck = vltabc
     c                   endif
      *
     c                   if        %found
     c                   eval      w_plas = vlplas
     c                   eval      w_pla1 = vlpla1
     c                   eval      w_pla2 = vlpla2
     c                   endif
      *
     c                   if        vlvtyp = 'S'
     c                   eval      d1skaf = '(S)'
     c                   eval      *in55  = '1'
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for å hente lagersaldo
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_lage     begsr
      *
     c                   eval      w_antl = 0
      * Hent i utgangspunktet beholdning fra telleliste
     c                   eval      w_antl = lwantl
      *
      * Finn riktig startpunkt og beholdning
      *
     c                   if        b_sykl = *on
     c                   eval      vhisl1_vare = lwvare
     c                   eval      vhisl1_lage = lwlage
     c                   move      lwtims        vhisl1_dato
     c                   move      lwtims        vhisl1_time
     c     vhisl1_key1   setll     vhisl1
     c     vhisl1_key1   reade     vhisl1
     c                   if        %eof
     c     vhisl1_key1   setll     vhisl1
     c     vhisl1_key2   readpe    vhisl1
     c                   endif
      *
     c                   if        not %eof
     c                   eval      w_antl = vhbehl
     c                   endif
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for å hente priser på lagerenhet ved telleslutt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_pris     begsr
      *
     c                   exsr      hent_prisgr
     c                   eval      p_lety = 0
     c                   eval      p_vare = lwvare
     c                   eval      p_enhe = lwenh1
     c                   eval      p_lage = lwlage
      *
     c                   call      'VP730R'
     c                   parm                    w_firm
     c                   parm                    p_vare
     c                   parm                    w_prgr
     c                   parm                    p_lety
     c                   parm                    p_dato
     c                   parm                    p_enhe
     c                   parm                    p_sapr
     c                   parm                    p_gmpr
     c                   parm                    p_kopr
     c                   parm                    p_inpr
     c                   parm                    p_lage
      *
     c     pris_end      endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å hente prisgruppe
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_prisgr   begsr
      *
     c                   eval      w_avde = 0
     c                   call      'VL712R'
     c                   parm                    w_firm
     c                   parm                    lwlage
     c                   parm                    w_avde
     c                   parm                    w_prgr
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Detaljer                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_deta      begsr
      * sjekk logistikk-vare
     c                   eval      w_nobb = 0
     c                   if        w_lv_nobb <> 0
     c                   eval      w_nobb = w_lv_nobb
     c                   else
     c                   eval      w_nobb = vvnobb
     c                   endif
      *
     c                   clear                   lxl2str
      * Member
     c                   eval      lx2ide = w_numm
      * Overgruppe
     c                   eval      lx2ogr = vvogrp
      * Hovedgruppe
     c                   eval      lx2hgr = vvhgrp
      * Undergruppe
     c                   eval      lx2ugr = vvugrp
      * Lager
     c                   eval      lx2lag = d1lage
      * Nobbnummer
     c                   eval      lx2nob = w_nobb
      * Varenummer
     c                   eval      lx2var = d1vare
      * Varetekst 1
     c                   eval      lx2tx1 = %trim(d1tek1)
      * Varetekst 2
     c                   eval      lx2tx2 = %trim(vvtek2)
      * Enhet
     c                   eval      lx2enh = d1enh1
      * Opptelt kvantum
     c                   eval      lx2tqt = d1antt
      * Lagerbeholdning
     c                   eval      lx2lbe = d1antl
      * Telledifferanse
     c                   eval      lx2dif = d1diff
      * Salgspris
     c                   eval      lx2sap = d1spny
      * Salgsverdi
     c                   eval      lx2sve = d1spsu
      * Kostpris
     c                   eval      lx2kos = d1kpny
      * Kostverdi
     c                   eval      lx2kve = d1kpsu
      * Tellet verdi
     c                   eval      lx2tve = d1topp
      * Lagerverdi
     c                   eval      lx2lve = d1totl
      * Avviksverdi
     c                   eval      lx2dve = d1totd
      * Tellekode
     c                   eval      lx2abc = d1abck
      * Lagerplass
     c                   eval      lx2loc = %trim(w_plas)
      * Lagerplass 1
     c                   eval      lx2lo1 = %trim(w_pla1)
      * Lagerplass 2
     c                   eval      lx2lo2 = %trim(w_pla2)
      *
     c                   write     lxl2str
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Lag excel fil via coolspool
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     lag_excel     begsr
      *
     c**                 eval      w_sqlwhere = *blanks
     c**                 call      'LE692C   '
     c**                 parm                    w_sqlwhere
     c**                 parm                    w_numm
      *
     c                   eval      w_exsql = %trim(w_sqlwhere)
     c                   eval      w_exfil = %trim(w_exfil) + %char(w_time)
      *
     c**                 call      'ASPTOXLSX'
     c**                 parm                    w_exsql
     c**                 parm                    w_exmap
     c**                 parm                    w_exfil
     c**                 parm                    w_extyp
      *
      * NB Krever at det er satt opp server for visning i browser
      *
     c                   call      'LE692C   '
     c                   parm                    w_sqlwhere
     c                   parm                    w_excel_url
     c                   parm                    w_numm
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Send mail med vedlagt excel fil
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     send_mail     begsr
      *
      * finner mailadresser
      *
     c*    rax9l1_key    setll     rax9l1
     c*    rax9l1_key    reade     rax9l1
     c*                  dow       not %eof
      *
     c*                  if        raik01 = 1
     c*                  eval      ra09l1_ikod = raikod
     c*    ra09l1_key    chain     ra09l1
     c*                  if        %found(ra09l1) and
     c*                            raiema <> *Blank
      *
     c*                  if        p_rec1 = *blank
     c*                  eval      p_rec1 = raiema
     c*                  else
     c*                  if        p_rec2 = *blank
     c*                  eval      p_rec2 = raiema
     c*                  else
     c*                  if        p_rec3 = *blank
     c*                  eval      p_rec3 = raiema
     c*                  endif
     c*                  endif
     c*                  endif
     c*                  endif
     c*                  endif
      *
     c*    rax9l1_key    reade     rax9l1
     c*                  enddo
      *
     c**                 eval      p_rec1 = %trim(w_mail)
     c                   eval      p_rec1 = 'baasa@eg.no'
      *
     c                   eval      p_subj = 'Telleavviksliste på excel'
     c                   eval      p_txt1 = 'Avvik pr ' + %char(a1date)
     c                   eval      p_txt2 = *blank
     c                   eval      p_txt3 = *blank
     c                   eval      p_txt4 = 'Med vennlig hilsen'
     c                   eval      p_pers = %trim(l_user)
     c                   eval      p_filn = '/asp/'+l_filg+'/excel/'+
     c                             %trim(w_exfil)
     c                   eval      p_fnav = 'Avvik_' + %char(w_date) +
     c                                      '_AA' + %char(w_numm)+ '.xlsx'
     c                   eval      p_mime = 'application/vnd.openxmlformats-'
     c                   eval      p_mime = %trim(p_mime)+'officedocument.'
     c                   eval      p_mime = %trim(p_mime)+'spreadsheetml.sheet'
     c                   eval      p_bcc  = *blank
     c                   call      'AF728R'
     c                   parm                    p_rec1
     c                   parm                    p_rec2
     c                   parm                    p_rec3
     c                   parm                    p_subj
     c                   parm                    p_txt1
     c                   parm                    p_txt2
     c                   parm                    p_txt3
     c                   parm                    p_txt4
     c                   parm                    p_avsl
     c                   parm                    p_filn
     c                   parm                    p_fnav
     c                   parm                    p_mime
     c                   parm                    p_bcc
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Rydd opp etter generering
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     rydd_xls      begsr
      *
     c/exec sql
     c+ DELETE FROM LXL2ST WHERE LX2IDE = :w_numm
     c/end-exec
       exec sql commit;
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *  Key for les av FORMULAR
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      *  Key for les av LAGER-KODE
      *
     c     lstsl1_key    klist
     c                   kfld                    lstsl1_firm
      *
      * Key for les av BATCH
      *
     c     lbchl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lbchl1_batc
      *
      *  Key for les av HISTORISK-LAGERBOK
      *
     c     vhisl1_key1   klist
     c                   kfld                    w_firm
     c                   kfld                    vhisl1_lage
     c                   kfld                    vhisl1_vare
     c                   kfld                    vhisl1_dato
     c                   kfld                    vhisl1_time
      *
     c     vhisl1_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    vhisl1_lage
     c                   kfld                    vhisl1_vare
      *
      *  Key for les av vareregsiter
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for firmaregister
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      *  Key for les av lagerregister
      *
     c     vlagl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vlagl1_vare
     c                   kfld                    vlagl1_lage
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    w_parm
      *
      *  Legger inn firmanummer i nøklene
      *
     c                   eval      lstsl1_firm = l_firm
     c                   eval      w_firm = l_firm
      *
      *  Behandling av parameter-felter
      *
     c                   eval      d_prec = w_parm
     c                   eval      a1batc = d_batc
      *
      *  Legger inn opplysninger i utfelter
      *
     c                   eval      a1wsid = l_wsid
     c                   eval      a1user = l_user
     c                   eval      a1firm = l_firm
     c                   eval      a1fnav = l_fnav
      *
     c                   eval      a1date = udate
     c                   time                    a1time
      *
      *  Sjekk, hva skal vises i utskriften
      *
     c                   eval      *in71 = *off
     c                   eval      *in70 = *on
     c                   eval      *in73 = *on
     c                   eval      *in74 = *on
     c                   eval      *in76 = *on
      *
     c                   if        d_val1 = 3
     c                   eval      *in73 = *off
     c                   eval      *in74 = *off
     c                   endif
      *
      *  Hent opplysninger fra LAGER-KODE-REGISTER
      *
     c     lstsl1_key    chain     lstsl1r
      *
      *  Hent opplysninger fra RUTINE-REGISTER
      *
     c                   eval      w_ruti = l_ruti
     c                   eval      w_txt1 = *blank
      *
     c                   eval      aforl1_ruti = l_ruti
     c     aforl1_key    chain     aforl1r
     c                   move      aftxt1        w_txt1
      *
      *  Hent opplysninger fra BATCH-REGISTER
      *
     c                   eval      lbchl1_batc = d_batc
     c     lbchl1_key    chain     lbchl1r
     c                   if        lcstel = 1
     c                   eval      b_sykl = *on
     c                   endif
     c                   eval      vhisl1_dato = lcbdat
     c                   eval      vhisl1_time = lcbtim
     c                   eval      p_dato = lcbdat
      *
      * Jobbnummer er allerede generert i AP600R. Overføres i *lda
      *
     c                   time                    w_date
      *
      * Vi logger ar utskriftprogrammet har startet
      *
     c                   eval      w_jstat = 10
     c                   eval      w_jtext = 'Utskrift av telleavviksliste ha+
     c                                       r startet - coolspool variant'
     c                   call      'AB705R'
     c                   parm                    l_bach
     c                   parm                    w_jstat
     c                   parm                    w_jtext
      *
      *  Hent inn firma/avd. opplysninger dersom
      *  kode for det er satt i rutineregister
      *
     c                   if        l_prfi = 1 or
     c                             l_prfi = 2
     c                   eval      w_prfi = l_prfi
     c                   eval      w_ffir = w_firm
     c                   eval      w_avde = l_avde
      *
     c                   call      'FÅ707R'
     c                   parm                    w_prfi
     c                   parm                    w_ffir
     c                   parm                    w_avde
     c                   parm                    w_fnav
     c                   parm                    w_fad1
     c                   parm                    w_fad2
     c                   parm                    w_fste
     c                   parm                    w_fftx
     c                   parm                    w_tfax
     c                   parm                    w_ftlf
     c                   parm                    w_ffax
     c                   parm                    w_mail
     c                   parm                    w_weba
     c                   endif
      *
     c                   time                    w_time
     c                   time                    w_dato2
     c                   movel     w_dato2       w_tids            6 0
     c                   move      w_dato2       w_ddmy
     c                   eval      b_deta = *off
     c                   eval      b_tota = *off
     c                   eval      b_line = *off
      *
      * Slår opp etter firmainformasjon
      *
     c     afirl1_key    chain     afirl1r
      *
     c                   if        1=2
     c                   open      le692p
     c                   endif
      *
      * Henter inn løpenummer teller
      *
     c                   eval      w_numm = 0
     c                   eval      w_kode = '0'
     c                   eval      w_fell = 'NXTKLI'
     c                   eval      w_type = *blank
     c                   eval      w_fast = *blank
     c                   eval      w_numm = *zero
      *
     c                   call      'AS100R'
     c                   parm                    w_kode
     c                   parm                    w_firm
     c                   parm                    w_fell
     c                   parm                    w_type
     c                   parm                    w_fast
     c                   parm                    w_numm
      *
      * OBS!!  Felles for alle filgrupper og firma
       CallP CO402R('   ':0:0:'NX_EXCEL_URL':
                        co402_verdi1:co402_verdi2);
       if co402_verdi1 = '1';
         w_excel_url = co402_verdi2;
       endif;
      *
     c                   endsr
