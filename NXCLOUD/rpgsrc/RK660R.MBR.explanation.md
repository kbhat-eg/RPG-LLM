# Overview

This program is an ILE RPG (RPG/400, RPG IV) source code, named `RK660R`. It is written in Norwegian and appears to be used for printing/generating "rentenota" (interest notes/statements) based on parameters entered by the user. The program interacts with display screens, multiple database files, and contains business logic for validation and parameter processing.

The code uses traditional fixed-format RPG, workstn (display) files, and disk files. It includes both mainline logic and subroutines.

---

## 1. **Header & Documentation**

- `h option(*nodebugio) datedit(*dmy)`: 
  - `*nodebugio`: No debug input/output information.
  - `datedit(*dmy)`: Default date format is day-month-year.
- Extensive comments at the top explain the purpose, history, and special usage information in Norwegian.

---

## 2. **File Declarations**

- Several physical files are declared for input (`I`), update (`U`), or display (`C` for workstn):
    - `AUSRL1`: User file (with key, renamed record format).
    - `RKUNL1`: Customer file (renamed).
    - `RAA6L1`: Parameter file (renamed).
    - `RKWAPF`: Parameter output file (update).
    - `RK660D`: Display file (workstn = workstation).

---

## 3. **Data Declarations**

### **Indicators**
- Indicators (like `*in30`, `*in31`, ...), with a documented scheme:
  - F1, F3 function keys
  - `LR` for program end
  - 30s for screen field protection
  - 31-59 for warnings/errors
  - 60-69 for file access
  - 70-99 for work, subroutine, or standard routines

### **Parameter Structure (Extremely Dense)**
- User data structure (`uds`), spanning contiguous fields in memory, with overlays for firm, user, date, period, customer numbers, etc.
- Array `kun(10)` overlays individual customer numbers (`pknr1`-`pknr0`), allowing for both array and individual element access.

### **Work Variables**
- Many work fields:
    - Numeric counters, month/year, status
    - Variables for calling external programs

---

## 4. **Mainline Logic**

### **Initialization**
- `*inzsr` subroutine:
    - Sets up firm number and default "from"/"to" ranges for departments, categories, sellers, and customer numbers.
    - Sets default processing flags and dates (current date, current month/year).
    - Reads parameter files to determine default interest note due date and rate.
    - Reads the user record; if department limiting is active, restricts input fields.
    - Builds keys for files.

### **Screen Handling**
- The display screen `a2bld` (A2 Bilde for valg av parametre) is shown using `exfmt`.
- All error/warning indicators (`*in31`~`*in41`) are cleared before processing.

### **Main Input Processing Loop**
- Checks for function key exits (F3, F12, etc.).
- Supports user queries (`spørring`) via subroutine `spr_rut`.
- Validates all parameter fields:
    - Checks date fields for valid dates (`test(d)`).
    - Validates period and year input (must be plausible).
    - Checks "from"/"to" range logic for department, category, seller, customer numbers.
    - Verifies each entered customer exists in the customer file.
    - Sorting parameter checking.
- All validation errors jump back to screen input (`goto a2taga`), with indicators set for error display.

### **Parameter Collection and Save**
- If input is valid, moves all fields from the screen to the output parameter area.
- Prepares the key and writes/updates the RKWAPF file with the parameter data.
    - Uses `chain`, `write`, or `update` as appropriate.

### **Program Exit**
- Sets LR indicator (`*inlr`) and returns.

---

## 5. **Subroutines**

### **spr_rut**
Handles "spørring"/lookup for various fields from the screen.
- Depending on the field in focus (e.g. which "from"/"to" field, which individual customer), different programs are called:
    - Department: `RA507R`
    - Customer category: `RA511R`
    - Seller: `RA509R`
    - Customer: `RK500R`
- Parameters (firm, code, description) are passed as needed and results updated on the screen.

---

## 6. **Validation Logic**

- Date Validations: Ensures both processing and due dates are valid and not zero; sets field to current date if empty.
- Range Checks: Ensures "from" is not greater than "to" on departments, categories, sellers, customer numbers.
- Customer Checks: For each manually entered customer number, ensures it exists in the customer file (CHAIN operation).
- Error Handling: Each check sets the proper indicator for error messages and returns to the screen loop.

---

## 7. **Interesting Techniques**

- **Parameter Overlay**: The `uds` structure uses positional overlays to map contiguous input fields, a common technique in fixed-format RPG for parameter blocks.
- **Indicators**: RPG's classic use of *INxx indicators for both field control and error handling; this is explained in the comments for new developers.
- **External Program Calls for Lookups**: The `call 'RA507R'`, etc. lines show that the program delegates to other programs for lookup/window functionality.
- **File Key Lists**: Key lists (`klist`) are defined for all physical files, to support keyed CHAIN operations.

---

## 8. **Summary of Workflow**

1. **Initialize** variables and fields.
2. **Display** parameter entry screen.
3. **Allow lookups** using subroutine calls for specific fields (departments, categories, sellers, customers).
4. **Validate** all entered parameters, using both in-program check logic and file lookups.
5. **Show errors** and allow re-entry if anything is incorrect.
6. **Write/update** parameter records once everything is correct.
7. **Exit** the program cleanly.

---

## 9. **Key Points for Onboarding**

- The program expects the user to enter (or inquire) all necessary parameters for producing an "interest note" report.
- The validation logic is comprehensive, intended to prevent nonsensical or incomplete reports.
- The program is tightly coupled with multiple master files – parameter, user, customer, and uses external routines for lookups.
- Error handling and user feedback is managed via indicators and repeated display of the entry screen.
- Understanding the meaning of each field is essential: firm, department, category, seller, customer number, etc. — refer to the screen layout (DDM) and business documentation.

---

## 10. **References in Comments**

- The code is well-annotated in Norwegian. If you don’t understand the domain terms or abbreviations (e.g., "rentenota", "avdeling", "kundekategori"), consult a Norwegian speaker or the business process documentation.
- Versioning comments at the top give clues about changes and known issues (e.g., "kode for oppdatering i regnskap ikke lagt ut" — code for updating accounting is not included).

---

## 11. **Modernization/Refactoring Opportunities**
- This program could benefit from conversion to fully free-format RPG.
- Business rules should ideally move out of the screen logic for testability.
- Heavy indicator use and overlays can be replaced with meaningful variable names and data structures in modern RPG.
- Consider modularizing file access and validation into procedures or service programs for maintainability.

---

## 12. **In Short**
- This is a classic business parameter entry/validation module, pre-processing data for generating "rentenota" (interest statements).
- It is a great example of how legacy RPG programs handle user input, validation, and database interaction in a highly structured, screen-driven manner.

---

If you're onboarding to this program:
- Study the user screens and how parameters are input/validated.
- Trace the flow through the main loop and observe how errors are handled.
- Consult related files (AUSRL1, RKUNL1, RAA6L1, RKWAPF) to understand the data sources and outputs.
- Experiment with stepping through the code interactively, if possible, to see the indicator logic and file access in action.