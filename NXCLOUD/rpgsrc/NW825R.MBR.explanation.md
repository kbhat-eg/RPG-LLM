```markdown
## High-Level Overview

This RPG (Report Program Generator) IV program is an IBM i (AS/400) batch or server program, labeled `NW825R`. It retrieves item information for a list of items using input from a data queue (datakø), processes a search, fetches item details, and returns the information via an output data queue. The code is modular, calling several external programs and using SQL for database access.

---

## File and Table Definitions

```rpg
fvvsopf    if   e           k disk
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
```
- **`vvsopf`**: Input file, keyed, likely a search index.
- **`vvarl1`**: Input file, keyed, renamed record format—contains the main item master data.

---

## Parameters

This program receives parameters via a *parameter list* (`*entry plist`):

- **p_firm**: Company number (3,0)
- **p_avde**: Division (4,0)
- **p_uniq**: Unique key/id for the job (15)
- **p_dtqi / p_dtqo**: Names of input/output data queues (10)
- **p_bibl**: Library name (10)
- **p_feil**: Error flag (1)
- **p_inpl / p_outl**: Input/output data lengths (5p,0)
- **p_wait**: Wait time for queue read (5p,0)
- **p_keyo / p_keyl**: Key data for queue operations
- **p_sndl / p_sndi**: Sender data for data queue

---

## Data Structures

### Input Data Queue Structure

A data structure maps the input data from the queue:

- **d_inpu**: Whole record (92)
  - **d_kund**: Customer number (9,0)
  - **d_kpro**: Project number (12)
  - **d_stek**: Search text (50)
  - **d_vari**: Item number (16)
  - **d_antv**: Number of items to fetch (5,0)

### Output Data Queue Structure

A data structure maps the output data for the queue:

- **d_outp**: Whole record (281)
  - **d_vare**: Item number (16)
  - **d_nobb**: NOBB number (8,0)
  - **d_tek1**, **d_tek2**: Text lines (35)
  - Further fields for prices, units, SAP numbers, discounts, net prices, warehouse, area, unit, quantity, etc.

---

## Main Program Logic

### 1. Initialization (`*inzsr`)

- Receives parameters.
- Sets up key lists for item lookup.
- Fetches company number.
- Sets up current date (`w_ddat`).

### 2. Main Loop

The main processing logic is a loop that waits for input on the input data queue. Each message is processed as follows:

```rpg
dou d_inpu = *blank
  - Clear input structure.
  - Call QRCVDTAQ to receive data from input queue.
  - If input received (not blank), process (`exsr behandling`).
enddo
```
- Exits when no more input.

### 3. Search and Processing (`behandling` subroutine)

Inside the "behandling" subroutine, for each input record:

1. **Validation**: Checks if the number of items is 0 or search text is blank. If so, sets error.

2. **Extracts and Trims the Search Text**.

3. **Calls AS700R**: Likely splits or prepares multiple search tokens (`w_ste1` ... `w_ste5`) for search.

4. **SQL Cursor Declaration**:
    - Declares an SQL cursor (`sok`) on `vvsopf`.
    - Selects records by company and first search token.
    - Orders by company and search text.

5. **Iterative Fetch**:
    - Loops fetching records from the cursor until the requested number of items is reached (`w_tell = d_antv`).
    - For each record:
      - **Secondary text checks**: If additional tokens (`w_ste2` ... `w_ste5`) are specified, ensures these are present in the search text (via `%scan`).
      - **Item lookup**: Chains into the item master (`vvarl1`) using the found item number.
      - **Status check**: Calls external program `VL720R` to get expiry date for the item (per warehouse). If the item is expired, it's skipped.
      - **Start-from-variant logic**: If a specific item is requested (`w_vari`), skips until this item is found, then includes all subsequent items.
      - **Fetches detailed data**: Fills output structure by calling `VV990R` (fetches all necessary item info).
      - **Writes to Output Queue**: Sends result via `QSNDDTAQ` to output queue.

### 4. Error Handling

A PSSR (`*pssr`) subroutine is used for error handling. If an unhandled error occurs, the error flag is set, and the program exits.

---

## Supported External Programs

- **AS700R**: Parses and prepares search tokens from search text.
- **VL720R**: Retrieves expiry date for item/warehouse.
- **VV990R**: Fills the output data structure with detailed information about an item.
- **QRCVDTAQ** / **QSNDDTAQ**: Standard IBM APIs for receiving and sending data queue messages.

---

## Additional Notes

- The program uses `*noddebugio` to avoid extra debug info in the object and sets date/decimal edit formats.
- The SQL `set option datfmt=*ISO` ensures ISO date format.
- The code is robust for text searching, supports partial and multi-token searching, and handles skipping expired or already-processed items.
- The code is modular, offloading business logic to external programs, which likely encapsulate complex rules.

---

## Onboarding Tips

- **Understand the Data Flow**: Input and output are via data queues; batch or server-processing context.
- **External Programs**: Key logic is split out—look up AS700R, VL720R, and VV990R for full business rules.
- **Data Structures**: Both input and output use overlays for subfields; understand these for tracing values.
- **SQL Usage**: The initial search is via SQL with parameter markers.
- **Error Handling**: Centralized PSSR, propagating error via parameter.

---
```