# RP100R – Project Activity Maintenance (ASOKON)

## 1. Purpose & Scope  
RP100R provides screen-driven maintenance of project activities (`FRP3AL*` files) within the ASOKON system. It supports:  
- **Listing** activities in a subfile (`B1SFL`)  
- **Filtering** by active/all, project, sub-project, activity code or description  
- **Creating** new activities  
- **Viewing/Updating** existing records  
- **Copying** and **Deleting** activities  
- **On-the-fly reporting** based on activity postings  

Version history highlights integration of “project leader” lookup from either the `ILoNL1` (project-leader) or `RA09L1` (seller) files, and phase-2 project accounting (Aug 2019).

---

## 2. Data Sources & Relationships  
| File/Alias  | Purpose                                  | Lookup & Relationships                  |
|-------------|------------------------------------------|-----------------------------------------|
| FRP1PL1     | Projects                                 | initial validation via `rp1pl1_key`     |
| FRP2UL1     | Sub-projects                             | validated via `rp2ul1_key`              |
| FRP3AL1 /   | Activity definitions (by code sort key)  | <ul><li>`rp3al1_key` / `rp3al2_key` for listing</li><li>`rp3alr_key` for read–chain</li><li>`rp3alu_key` for update</li></ul> |
| FRTRL C     | Project postings (transactions)          | used by `FINN_SUM` to accumulate sums   |
| RPRRL1      | Report layout definitions                | drives `C3BLD` report invocation        |
| RKUNL1      | Customer lookup                          | for customer field in `C2BLD`           |
| ILoNL1      | Project-leader lookup                    | for leader field in `C2BLD` (mode ‘P’)  |
| RA07L1      | Department lookup                        | for department in `C2BLD`               |
| RA09L1      | Seller lookup (alt. leader source)       | for leader in `C2BLD` (mode ‘S’)        |
| Utility    | RP500R, RP510R, RP550R, RP603R, RA507R…   | pop-up lookups & drill-downs            |

---

## 3. Screen Flow & Subfile Control  

### 3.1 Entry & Initialization  
- **Entry parameters**:   
  - `p_pros` (Project)  
  - `p_upro` (Sub-project)  
  - `p_valg` (operation type)  
  - *(Phase-2)* `p_fdat`, `p_tdat`, `p_selg`, `p_kunf`, `p_knav`  
- **Chain** into `FRP1PL1`/`FRP2UL1` to validate project/sub-project.  
- **Initialize**:  
  - Screen filters (`b2pros`, `b2upro`, `b2aktiv`)  
  - Sequence mode `w_seqe` = blank (sort by activity)  
  - Column headings (`b2hea1`–`b2hea4`) based on `w_a51` toggle  
- **Build initial subfile** by calling `CRT_SUBFILE`.

### 3.2 Main Control – B2CTL  
Handles PF-keys and screen indicators:  
- **PF3/Exit**: `*INLR = *ON`, return  
- **PF10 (Roll-up)** & **PF11 (Roll-down)**: cycles `w_a51` (0–3) and updates column headings for:  
  - Date info / Amounts / Income % / Dept & Leader  
- **PF12**: refresh subfile (**CLR_SUBFILE** + **CRT_SUBFILE**)  
- **Home** (`*IN21`): sets cursor indicator `*IN22` to reposition  
- **Filter inputs** (`b2aktiv`, `b2pros`, `b2upro`, `b2akti`, `b2besk`) detect changes, call `FORNY` to re-generate subfile  
- **Standard activities** (`*INKB`) invokes `HENTAKT` to preload defaults from `RA21L1`  

### 3.3 Subfile Processing  
- **CLR_SUBFILE**: clear control record (`B2CTL`), reset counters  
- **CRT_SUBFILE**:  
  1. Increment page/window counters (`w_spge`, `w_srrn`)  
  2. `READ(RP3AL1 or RP3AL2)` according to `w_seqe` (‘B’=text sort)  
  3. Filter on: firm, selected project/sub-project, status, activity filter  
  4. Populate `B1SFL` record fields: code (`b1akti`), desc (`b1besk`), dates, dept, leader, amounts if needed  
  5. Compute summaries via `FINN_SUM` when `w_a51` = 1–3  

- **DSP_SUBFILE**: display control screen (`B2CTL`), subfile window (`B1SFL`) and position cursor based on `w_fcrn`.

---

## 4. CRUD & Drill‐down Screens  

### 4.1 Create Activity (C1BLD)  
- Triggered by PF4.  
- Prompts for new activity code (`C1AKTI`).  
- **Uniqueness check**: `CHAIN(RP3ALR)` → if found, show `C1MSG`.  
- On commit (`*IN23`), branch to `XC2BLD` (modify/view routine) for full data entry.

### 4.2 Modify/View (C2BLD)  
- Populates fields from `RP3ALR` record:  
  - Description, start/end dates, department (`RA07L1`), customer (if type=K via `RKUNL1`), project-leader (via `ILoNL1` or `RA09L1`), status, etc.  
- **Validations**:  
  - Non‐blank description, valid dates (`REDDATO`), department, existing leader/customer, allowed status codes (‘A’, ‘O’, blank).  
- **Drill-downs**:  
  - PF4-date lookup via `RP500R` (project), PFxx department, customer, leader depending on mode.  
  - PF8/PF9 calls `RP510R` (view postings) / `RP550R` (view orders).  
- **On commit**:  
  - `CHAIN(RP3ALU)` → update or write new record; set audit fields (`rp3eda`, `rp3eav`).  
  - Reflect changes back into subfile record.

### 4.3 Copy (K1WIN)  
- From subfile PF5: preload code into `K1AKTI`, read into `K1WIN` screen, validate non‐existence, then call `XC2BLD` to complete copy.

### 4.4 Delete (D1WIN)  
- From subfile PF6: chain to `RP3ALR`, then scan `RHTRLC` for any transactions on that activity; if found, error message and exit. Otherwise `DELETE RP3ALU`.

### 4.5 Report Selection (C3BLD)  
- Triggered by PF7.  
- Prompts: project‐from/to, leader, department, report layout (`RPRRL1`).  
- Uses utility lookups (`RP500R`, `RA507R`, `RP604R`).  
- On commit, calls either `RP801C` or `RP802C` via parameters: period, project range, layout, status, and flags.

---

## 5. Supporting Routines  

### 5.1 REDDATO  
Parses a free‐format date (e.g. ‘1.2.2020’) into numeric `YYYYMMDD` (`w_datn`), sets indicators on invalid.

### 5.2 FINN_SUM  
Aggregates posting sums per activity/project:  
1. Reads `RPRRL1` lines for report 9700 in blocks (10–19 = income, 20–29 = COGS, 30–39 = wages, etc.)  
2. For each line, `SETLL/READE` in `RHTRLC` and sum `RBNETO` for matching `p_pros`/`p_upro`/`rp3akt` within code range (`RPHKTF–RPHKTT`).  
3. Produces `w_sumi`, `w_sumk` for display or percentage.

### 5.3 HENTAKT  
Fetches standard activity codes from `RA21L1` (via `RA521R`), writes them as default `RP3ALU` records if absent. Used on “load default activities” operation.

---

## 6. Design Conventions & Patterns  

- **Prefixes**  
  - `b1*` – subfile record (`B1SFL`) fields  
  - `b2*` – control‐record / filter fields (`B2CTL`)  
  - `c1*, c2*, c3*` – C1/C2/C3 screen‐build  
  - `rp3*` – fields in `FRP3AL*` database  
  - `w_*` – work/temporary variables  
  - `p_*` – program‐entry parameters / pop‐up lookups  

- **Indicator usage**  
  - 12–15 – subfile‐control (display, clear, end)  
  - 21 – Home key / reposition  
  - 22 – cursor positioning  
  - 30+ – field protection and error flags (e.g. `*IN23` commit)  

- **Modularization** via `EXSR` / `BEGSR` for each logical block (subfile build, validation, lookups, date parse, sum).

- **Key Lists** defined at end of initialization for `SETLL`/`CHAIN` across all data files – centralizing key definitions.

- **Dynamic column display** driven by `w_a51`, allowing four different data views within the same subfile layout.

- **Screen-based lookups** rely on external programs (`RP500R`, `RA507R`, `RP604R`, etc.) ensuring consistent cross-module behavior.

---

## 7. Business Logic Highlights  

- **Project vs. Sub-project**  
  - Projects (`FRP1PL1`) contain sub-projects (`FRP2UL1`) which in turn contain multiple activities (`FRP3AL*`).  
  - Filtering allows drill-down by each level.  

- **Activity Lifecycle**  
  - Activities have code, description, start/end dates, assigned department, project leader (either from standard “leaders” file or “sellers”), customer (if required by project type), and status.  

- **Financial Tracking**  
  - Each activity’s financials are aggregated by `FINN_SUM` from transaction file `RHTRLC`.  
  - Multiple reports supported (standard layout definitions drive logic).  

- **Stand-alone vs. Integrated Mode**  
  - `w_prlslg` toggle controls whether “project leader” is fetched from `ILoNL1` or `RA09L1`.  

- **Safeguards**  
  - Deletion is prevented if any postings exist for an activity.  
  - Duplicate creation is blocked with a confirmation message.  
  - Date input is validated and formatted uniformly.

---

This structure and modular approach ensures maintainability and consistency across ASOKON’s project management screens, while providing flexible views and robust data integrity checks.