# Explanation of the RPG Program

This ILE RPG program (SX520R) is a typical IBM i (AS/400) green-screen application component. Its main purpose is to present a screen for "deleting records" (sletting av poster) with parameters and provide a workflow for validation and calling other programs to perform the deletion.

Let's break down the core parts:

---

## 1. File Definitions

```rpg
fsx520d    cf   e             workstn
```
- This defines a WORKSTN (workstation) file, named `sx520d`, for user interaction (display file).

---

## 2. Data Definitions

### LDA (Local Data Area) Fields

```rpg
d                uds
d l_firm                944    946  0
d l_navn                951    980
```
- These define fields in the LDA (user data structure, typically for session or job context):
    - `l_firm`: Company code
    - `l_navn`: Company name

### Parameter Data Structure

```rpg
d                 ds
d d_list                        64
d  d_firm                        3  0 overlay(d_list:1)
d  d_raar                        4  0 overlay(d_list:4)
```
- `d_list` is a 64-byte structure, with overlays for:
    - `d_firm`: 3-digit company code (at offset 1)
    - `d_raar`: 4-digit accounting year (at offset 4)
- This structure is used as a parameter block for a called program.

### Variables

```rpg
d b_feil          s              1    inz(*off)
d w_stop          s              1    inz(*off)
d w_firm          s              3  0
d w_mld1          c                   'Vennligst vent .........     '
d w_mld2          c                   'Sletting p�g�r .........     '
d wactli          s              2  0
d wactpo          s              3  0
d wmld01          s             30
d wmld02          s             30
```
- `b_feil`: Flag for input error
- `w_stop`: Flag indicating if the process should stop (e.g., security check fail)
- `w_firm`: Work variable for company code
- `w_mld1`/`w_mld2`: Constants: "Please wait ..." and "Deleting in progress ..."
- `wactli`/`wactpo`: Used for window position/layout info
- `wmld01`/`wmld02`: Message text variables for display

---

## 3. Main Workflow

#### Program Entry Point

```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- `b1taga` is a label (TAG).
- `exfmt b1bld` displays and gets input from a screen record format `b1bld`.

#### Exit Handling

```rpg
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
```
- If function key F3 (Exit) or F12 (Cancel) is pressed, jump to `avslutt` to end.

#### Security Check

```rpg
c                   call      'SX501C'
c                   parm                    w_stop
c                   if        w_stop = *on
c                   goto      avslutt
c                   endif
```
- Calls program `SX501C` (likely a security check).
- If `w_stop` is set to *ON (user lacks access), ends the program.

#### Input Validation

```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   goto      b1taga
c                   endif
```
- Runs subroutine `sjekk_input` (see below).
- If error (`b_feil`) is *ON, re-displays the input screen.

#### Prepare Parameters

```rpg
c                   exsr      flytt_par
```
- Calls `flytt_par` to transfer screen variables into the parameter structure.

#### Show Progress Message

```rpg
c                   eval      wactli = 4
c                   eval      wactpo = 44
c                   eval      wmld01 = w_mld1
c                   eval      wmld02 = w_mld2
c                   call      'AA006C'
c                   parm                    wactli
c                   parm                    wactpo
c                   parm                    wmld01
c                   parm                    wmld02
```
- Sets up message window position/layout and text.
- Calls program `AA006C` to show the message ("Please wait ... Deleting in progress ...").

#### Call Deletion Program

```rpg
c                   call      'SX530R'
c                   parm                    d_list
```
- Calls external program `SX530R` to perform the actual deletion, passing the assembled parameters.

#### Program Exit

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Label `avslutt`: sets *INLR (last record, signals program end/close files), returns from program.

---

## 4. Subroutines

### sjekk_input: Validate Input Fields

```rpg
c     sjekk_input   begsr
c                   eval      b_feil = *off
c                   if        b1raar <> 0 and
c                             b1raar > *year
c                   eval      *in31 = *on
c                   eval      b_feil = *on
c                   goto      end_sjekk
c                   endif
c     end_sjekk     tag
c                   endsr
```
- Sets error flag off.
- Checks if entered accounting year (`b1raar`) is not zero and is greater than current year.
    - If so, sets error indicator 31 (*IN31), sets error flag.
- End of subroutine.

### flytt_par: Fill Parameter Structure

```rpg
c     flytt_par     begsr
c                   eval      d_firm = w_firm
c                   eval      d_raar = b1raar
c                   endsr
```
- Transfers company code and year from screen/work variables into the parameter structure for program call.

### *inzsr: Initialization

```rpg
c     *inzsr        begsr
c                   eval      w_firm = l_firm
c                   eval      b1firm = l_firm
c                   eval      b1navn = l_navn
c                   eval      wactli = 3
c                   eval      wactpo = 2
c                   endsr
```
- Program initialization routine (runs automatically):
    - Initializes company code and name from LDA.
    - Sets initial display window positions.

---

## 5. Other Notes

- **Norwegian**: Comments and texts are in Norwegian.
- **External Programs**:
    - `SX501C`: Security/access check
    - `AA006C`: Display message window to user
    - `SX530R`: Does the actual deletion of records

- **Error Handling**: When input fails validation, indicator *IN31 is set (likely marks a screen field in error), and the error flag causes the screen to be refreshed for correction.

---

## 6. Overall Flow

1. **Initialize** variables from LDA.
2. **Display** entry screen.
3. **Handle exit** if user presses F3/F12.
4. **Check security** (only authorized users proceed).
5. **Validate input**, redisplay on error.
6. **Prepare and show "in progress" message**.
7. **Call delete program** with parameters.
8. **Exit** program.

---

## 7. Common RPG Conventions and Modernization Notes

- This is written in fixed-format RPG IV (pre-free form).
- Uses a lot of classic AS/400 RPG idioms: overlays, LDA, indicators.
- Could be modernized using free-form syntax, service programs, and better parameter passing.

---

## 8. Summary

**SX520R** is a panel driver for deleting records in the system. 
- It provides validation, authorization, user feedback, and parameterized calling of processing programs. 
- Its structure (mainline + subroutines + external calls) is classic in batch/interactive RPG applications, with clear separation of concerns.