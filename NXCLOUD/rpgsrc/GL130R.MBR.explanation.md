# Explanation of the RPG Source Code for "Vedlikehold av betalingsforslag" (GL130R)

This RPG program is designed for IBM i (AS/400) systems and is used for maintaining and displaying payment proposals per day (“utbetalinger pr. dag”) as a subfile-driven display program.

## High-Level Overview

- **Purpose:**  
  Query and maintain daily payment proposals.
- **Main Features:**  
  - Presents a list (subfile) of payments proposals, summed per date.
  - Supports paging, F3-exit, F5-renew, F12-cancel, and other navigation/action keys.
  - Handles multiple status types for payments.
  - Performs calculations to sum amounts for different statuses.
- **Files Involved:**  
  - `GUBFL7` – Disk file containing payment proposals.
  - `GL130D` – Workstation file (the display file), with subfile support.

---

## Program Structure

### 1. **Header, Versioning, and Indicators**

The initial block provides:

- Program and system names, description, author, and change log.
- An extensive indicator usage map (e.g., which function keys map to which indicators).
- Explanation of subfile field naming conventions.

### 2. **File Declarations**

```rpg
fgubfl7    if   e           k disk      // Payment proposal file
fgl130d    cf   e             workstn   // Display file (workstation)
f                                     sfile(b1sfl:srrn01)  // Subfile record format
```

### 3. **Data Structure and Field Declarations**

- **Firm and User Info:**  
  Loaded from the *LDA (Local Data Area).
- **Date Formats:**  
  Two data structures (`dsforf` and `dsfo2f`) for handling different date representations.
- **Subfile Counters:**  
  Variables for current row, current page, start/end row, etc.
- **Window Positions:**  
  Used for displaying pop-up windows (not further shown in this code).

### 4. **Program Flow**

#### **Initialization**

- **Subfile is cleared:**  
  `exsr xclr01`
- **Counters reset:**  
  `eval w_dato = 0` and others (`exsr xnull`)
- **File positioned to correct key:**
  `setll gubfl7_key gubfl7`
- **Subfile filled with data:**  
  `exsr xcrt01`
- **Main Display Loop:**  
  Starts display logic using tags and writes, enabling the user to interact with the display.

#### **Main Loop and Event Handling**

- **F3/Exit:**  
  If indicator KC is on (`*inkc`), the program exits.
- **Paging/Roll:**  
  If roll key (indicator 10) is on, and no file error (`*in60`), the subfile is rebuilt for the next page.
- **Return to input loop:**  
  Controlled via tags and GOTO statements (common in older RPG).

#### **End of Program**

- **Set LR (Last Record) Indicator:**  
  Ends program (`*inlr = *on`), standard for RPG to release resources.
- **Return**

---

## Major Subroutines

### **xclr01** – Clear Subfile

- Empties the subfile (`*in14` triggers SFLCLR).
- Resets counters to 0.

### **xcrt01** – Build/Filling Subfile

- Calculates next paging block (`spge01 = spge01 + 15`)
- For each payment record:
  1. Sums up the amounts for the given date (`exsr xsum`).
  2. Writes a subfile record (`write b1sfl`) if amount is not zero.
  3. Resets accumulators (`exsr xnull`).
  4. Loops until the page limit is hit.

### **xdsp01** – Display Subfile

- If records exist, indicator 12 is set to enable SFLDSP.
- SFLDSPCTL (indicator 13) controls whether subfile control record is shown.

### **xnull** – Reset Totals

- Clears all sum fields relating to payments (`b1tota`, `b1more`, `b1mare`, etc.)

### **xsum** – Summing Amounts for a Date

For each payment read from `gubfl7`:

- If currency is not NOK, flag with `*`.
- If the date changes, the prior payment is "put back" and the subroutine exits so the caller can process the break.
- Accumulates total amount, amounts by status (received, sent, not sent).
- Reads the next payment and continues until end of file or date break.

### **Initialization (*INZSR)**

- Initializes counters, positions, and retrieves firm number from LDA.
- Key list (`gubfl7_key`) is constructed for file access based on firm.

---

## Subfile and Display File Logic

- The subfile record format (`b1sfl`) is used for list display.
- Paging is handled by keeping track of SFL record numbers and page sizes.
- Display screen control is managed by indicators (e.g., SFLDSP, SFLDSPCTL, SFLCLR).

---

## Special Notes

- The code uses a lot of indicators, a hallmark of classic RPG. Consult the top-of-file indicator comments for specific meaning.
- Date handling is "old style" — using packed/zoned structures and overlays, necessary for older RPG and display file compatibility.
- The code makes extensive use of tags and GOTO for main loop and event flow; this is common for classic RPG (pre-RPG IV/free-form).

---

## Summary Table

| Subroutine | Purpose                                              |
|------------|------------------------------------------------------|
| xclr01     | Clear the subfile                                    |
| xcrt01     | Fill subfile with totals per day                     |
| xdsp01     | Display the subfile and control record to the user   |
| xnull      | Reset/clear all payment summary fields               |
| xsum       | Sum payment amounts for a single payment date        |
| *inzsr     | Initial program setup, loads LDA, initializes fields |

---

## Onboarding Hints

- **Business Logic:**  
  The program is about displaying (and possibly managing) batch payments to be processed, per day.
- **Screen Handling:**  
  The display file uses a subfile for paging through daily totals, with UI driven by function key indicators.
- **File Access:**  
  Records are read from `gubfl7`, selected by firm number, and grouped by payment date.
- **Totals/Status:**  
  Amounts are summed and categorized by payment status, supporting business reporting/monitoring needs.

---

If you are new to classic RPG:

- Study how indicators control display, file I/O, and logic flow.
- Observe subfile handling, which is central to this UI pattern.
- The program is highly driven by user actions on the display (via function keys).

For modern RPG onboarding, compare this with patterns in fully free-form RPG. Be aware of structural differences (data declarations, subroutines, control flow).