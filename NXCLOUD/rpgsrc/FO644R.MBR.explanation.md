# RPG Program Explanation: ASOFAK - Utskrift av kontroll-liste, plukker ordres

This RPG program is designed to handle printing of a control list for order picking, processing multiple database records, and managing order details. It involves reading order headers, order lines, and text lines, applying filters, and preparing data for output.

---

## Program Metadata

- **Title**: "ASOFAK: Utskrift av kontroll-liste, plukker ordres"  
- **System**: ASOFAK  
- **Program Name**: FO644R  
- **Description**: Prints control lists for order picking, filtering orders based on various criteria.

---

## File Definitions

The program defines several file-related variables with renaming:

- **fohel1, ffhel1**: Order header data, renamed to fohel1r.  
- **fodtl1, ffodtl1**: Order line data, renamed to fodtpfr.  
- **fotxl1, ffotxl1**: Text line data, renamed to fotxpfr.  
- **fplol1, f*plol1**: Sorting records, renamed to fplopfr.  
- **fpsolu, ffpsolu**: Order summary info for sorting, renamed to fpsopfr.

These files are accessed via key fields, which are defined later as key lists, enabling efficient record retrieval.

---

## Data Structures

### Sorting Parameters

Overlayed on a structure named `sorter`, multiple overlays manage sorting criteria, allowing sorting by fields such as name, address, or custom sort keys (`sor001` to `sor006`).

### Input Parameters

- **ldprec**: a 64-byte data structure that holds parameters passed to the program.
- **ldotyp, ldfdat, ldtdat, ldfavd, ldtavd, ldfkjo, ldtkjo, ldvari**: overlayed fields on `ldprec` for parameters like order type, date range, department, route, variation, etc.

### Other Variables

- **W_DATO_ALF**: a string for date handling, 8 characters.
- **User and session info**: various character variables like `dsuser`, `dsfir`, `hednum`, and others, for maintaining session state and record keys.
- **Status & control variables**: such as `wstatg`, `tstbyt`, `wwtst`, for status and testing.

---

## Main Logic

### Initialization

- ***inzsr** subroutine initializes variables, resets status fields, and sets key lists for database files.
- Key fields for header, lines, and text records are defined via `klist` with specific key fields for ordered access.

### Reading and Filtering Orders

- The program uses a `start` label to initiate reading from the order header file (`fohel1r`) using the `setll` operation.
- Conditions are applied to filter orders:
  - **Order type**: skips if not matched.
  - **Date Range**: skips if outside specified `ldfdat` to `ldtdat`.
  - **Department & Route**: skips if outside specified values.

### Processing and Output Preparation

- **Order Header Processing**:
  - Moves order number and suffix into the sorting key.
  - Sets up sorting criteria with fixed route, order number, and name placeholders.
- **Retrieve Header Data**:
  - Uses `chain` to locate the header record in the file `fohel1r`.
- **Order Lines & Texts**:
  - Reads order detail lines (`fodtl1r`) in a loop.
  - Checks if lines are relevant based on various criteria, including whether they are text lines, using overlays and checks against special values (`ldval7`, `ldpros`).
  - Calls subroutines (`exsr`) to process lines (`linje`) and associated header/text lines (`ohead`, `foran`, `etter`) for detailed processing and adding to the sort register.

### Sorting and Output

- **Sorting Criteria Setup**:
  - Sets various sorting fields (`fkskod`, `fksoty`, `fkssrt`, etc.) based on order and text details.
- **Fetching Lines & Texts**:
  - Loops through order lines and text lines, setting sort keys, and updating the order summary record (`fpsolur`) before writing it.
- **Subroutine Calls**:
  - Calls subroutines like `linje`, `ohead`, `foran`, `etter` to process respective parts of order data.

---

## Subroutines

### `*inzsr` (Initialization)

- Clears status, test variables.
- Sets key lists for header, order line, and text files.
- Prepares for order processing.

### `ohead` (Order Header)

- Retrieves header record.
- Sets sorting keys based on header data like type, number, suffix, and name.
- Updates or writes the header record into the sort register.

### `linje` (Order Line)

- Reads order detail lines sequentially.
- Filters relevant lines based on order number, suffix, and item number.
- Checks if the line is a text line or a regular line.
- Calls subroutines to process text or detail accordingly (`sjekk`, `foran`, `etter`).

### `foran`, `etter` (Text Blocks Before & After)

- Reads associated text lines (text before and after the main line).
- Filters based on line number and other criteria.
- Sets sorting keys for these text segments.
- Writes these to the sorting register.

---

## Finalization

- The program ends by setting `*inlr = *on` to indicate the last record and return control.
- Key fields are cleaned up, and all resources are released.

---

## Summary

This program systematically reads order headers, filters by user-specified criteria, and navigates through their lines and associated text. It constructs comprehensive sorting keys to prepare a sorted control list for printing or further processing. The modular use of subroutines for handling header, lines, and text segments enhances clarity and maintainability.

---

**Note**: This code is highly integrated with database files, overlays, and key lists, making it efficient for large data processing tasks typical in order management systems.