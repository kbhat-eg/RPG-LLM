# RPG Program Onboarding Explanation

## Purpose and Overview

This is an ILE RPG III-style program designed to retrieve and return purchase prices (cost price and buying price) for an item/unit based on firm, item, price group, unit, supplier type, date, warehouse, and optionally a campaign. It is intended for Norwegian business systems and handles several special cases when looking up prices, including:
- Using warehouse-specific suppliers,
- Fallbacks to main supplier and generic,
- Handling campaign-based prices,
- Trying with and without price group/ delivery type,
- Avoiding use of unit conversion (prices must be for the specified unit directly).

If a buying price cannot be found, it defaults to the cost price.

---

## File Declarations

```rpg
fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
6.20 fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
6.21 fvtill9    if   e           k disk    rename(vtilpfr:vtill9r)
```
- **vvprl1**: Item price file (main price register)
- **vvarl1**: Item master file (for item-supplier relations)
- **vtill9**: Campaign/offer price register (used if a campaign is provided)

---

## Key Parameters and Variables

#### Input Parameters (from *entry plist)
- **p_firm**: Company code
- **p_vare**: Item code
- **p_prgr**: Price group (1-2 characters)
- **p_enhe**: Unit code
- **p_lety**: Delivery type
- **p_dato**: Date for the price (if *LOVAL, current date used)
- **p_kamp**: Campaign number/ID (optional)
- **p_lage**: Warehouse (added in later version)

#### Output Parameters
- **p_kopr**: Cost price (out)
- **p_inpr**: Buying price (out)

#### Internal Working Variables
- **w_firm, w_lage, w_ldor, w_dato**: Company, warehouse, supplier, date (working)
- **b_pris**: "Found price?" flag (1 byte, off by default)
- **b_inlr**: Internal flag, set from supplier routine

#### Key Variables
Variables used for building keys to files for CHAIN, SETLL, READE.

---

## Main Logic Flow

### 1. Initialization (*inzsr)

- Entry parameters assigned to variables.
- Date initialized (from parameter or current system time if missing).
- Output prices (`p_kopr`, `p_inpr`) are reset to zero.

### 2. Main Program

1. **Set warehouse from parameter**  
   ```
   eval w_lage = p_lage
   ```

2. **Find supplier for item/warehouse**  
   Calls program `'VL721R  '` to retrieve the supplier for the item/warehouse, result in **w_ldor**.

3. **Try to fetch price information**  
   The logic tries to find a price as follows, using the subroutine `hent_pris`:
   
   a. **For the actual warehouse-supplier**  
      ```
      vvprl1_ldor = w_ldor
      exsr hent_pris
      ```
   b. **If not found and w_ldor ≠ main supplier:**  
      Use main supplier (**vvldor**)  
   c. **If still not found:**  
      Use supplier 0 (generic pricing, not supplier-specific)

4. **If no buying price found, use cost price**
   ```
   if p_inpr = 0
     eval p_inpr = p_kopr
   endif
   ```

5. **Set LR (last record) indicator and return**

---

## Subroutine: `hent_pris` (Fetch Price Information for Sale Unit)

This subroutine performs the actual lookup in the price registers, with multiple fallback strategies:

1. **Check campaign price if `p_kamp` present:**
    - Looks for campaign price in `vtill9` register matching item, price group, supplier type, and unit, for the given campaign. Looks for up to three possible units (vtenh1-3).
    - Only uses prices if they are for the exact unit and within the date range.
    - If not found with price group, looks again with price group blank.

2. **Standard price search in `vvprl1`:**  
   - Searches for a match on item, price group, supplier, unit, and delivery type.
   - If not found, tries with delivery type 0 (generic).
   - If still not found and price group is not blank, tries again with price group blank (with both given and generic delivery type).

Whenever a valid price is found for the right unit and date, updates `p_kopr` and `p_inpr` and sets `b_pris = *on` to indicate a successful fetch.

---

## Notes on Price Search Order

1. **Campaign price with price group**
2. **Campaign price with price group = blank**
3. **Ordinary price with all parameters**
4. **Ordinary price with delivery type 0**
5. **Ordinary price with price group = blank**
6. **Ordinary price with price group = blank, delivery type 0**

Campaign prices are only accepted if they match the exact unit and are valid for the given date.

---

## Other Noteworthy Details

- The program is heavily commented (in Norwegian), with change logs and explanations.
- It avoids using unit conversion factors, requiring prices to be explicitly for the queried unit.
- If a price can't be found at all, `p_inpr` is set equal to `p_kopr` (cost = buy).
- Uses labels, keylists (klist/kfld), and subroutines in old RPG III/400 style.

---

## When Onboarding:

- **Understand the relationships between files:** Items, suppliers, prices, campaign prices.
- **Review how keys are constructed:** The key lists at the bottom show how indexes for each file are assembled.
- **Pay attention to fallbacks:** If the most specific price isn't found, the code tries increasingly generic alternatives.
- **Campaign handling is distinct:** Separate search for campaign/offer prices, before regular prices.
- **Date handling:** If the input date is the special low value (`*LOVAL`), current date is used.

---

## Summary Table

| Step        | Source      | Fallbacks Triggered When...               |
|-------------|-------------|-------------------------------------------|
| 1. Campaign | vtill9      | For each unit, then with price group blank|
| 2. Standard | vvprl1      | Tries full key, then Del.typ 0, then PG blank, then both |
| If not found| —           | p_inpr set = p_kopr                       |

---

## Practical Example

If you call the program with:
- Company: 010
- Item: 123456
- Price group: 'AB'
- Unit: 'KG'
- Delivery type: 2
- Date: 2024-06-10
- Campaign: 'SUM24'
- Warehouse: 05

The program will:
1. Try to find a campaign price for 'SUM24', 'AB', 'KG', delivery type 2, warehouse 05 supplier.
2. If not found, try campaign price with price group blank.
3. Then, try standard price in vvprl1 for all those keys.
4. Then with delivery type 0, and/or price group blank.
5. If still nothing, set buy price = cost price (which might be 0).

---

**In short:**  
This program is a central utility for fetching item buying prices, giving priority to most specific (campaign, exact match) and falling back as needed, always working in a supplier/warehouse/item/unit context, and ensuring a price is always returned (defaulting to cost if not found).