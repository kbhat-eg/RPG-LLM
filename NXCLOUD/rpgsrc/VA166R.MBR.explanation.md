# Explanation of RPG Program VA166R

## Overview

This RPG/400 (ILE RPG, traditional fixed-format) program manages **bonus types**, **template linking**, and **customer categories**. The application uses subfiles and display files for user interaction, supporting operations such as view, copy, update, and delete on bonus type connections to customer categories. It’s typical for backoffice/batch or green-screen applications on IBM i (AS/400).

The code is well-commented, including a change log and explanations for indicator usage, variable naming conventions, and subfile mechanisms.

---

## 1. File Definitions

```rpg
fvbotl1    if   e           k disk    rename(vbotpfr:vbotl1r)
fembhi1    if   e           k disk    rename(embhst:embhi1r)
fra11l1    if   e           k disk    rename(ra11pfr:ra11l1r)
fembkir    if   e           k disk    rename(embkst:embkirr)
fembkiu    uf   e           k disk    rename(embkst:embkiur)
fekbti3    if   e           k disk    rename(ekbtst:ekbti3r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
fva166d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Several database files, each renamed to a local record format.
- `va166d` is a display file using a subfile (`b1sfl`) and has a display feedback data structure.

---

## 2. Indicators

- *Used extensively*, e.g., indicators 10–15 for function keys/subfile operations, 21/22 for cursor/home, 30+ for field protection, 31-79 for messages, 80-99 for work.

---

## 3. Key Variables & Data Structures

- **Local Data Area (LDA) fields:** For user, company, and name.
- **Display feedback data structure (`dspfbk`):** Used for screen positioning, e.g., `d_fcrn`.
- **Key variables:** Used for chaining/setting logical positions in files.
- **Subfile variables:** For subfile control—record number, page, selection, etc.

---

## 4. Subfile Processing

**Subfiles:** Used for displaying lists of records and interacting with them.

Key variables:
- `w_fcrn` - First record number on the page (for scrolling)
- `w_srrn` - Subfile relative record number (current)
- `w_ssrn` - Last record on subfile page
- `w_spge` - Page size (number of entries per subfile page)
- etc.

---

## 5. Main Program Loop

The program:
- Initializes (positions in files, fills subfile).
- Enters a main tag/loop:
  1. **Writes a command screen or processes events**.
  2. **Handles function keys:**  
     - Roll up/down, refresh, or home/cursor movement.
     - Calls subfile creation, back, refresh, etc.
  3. **Handles positioning if requested**
  4. **Processes subfile events:**  
     Processes selections (view, copy, update, delete) on the subfile.
  5. **Returns to the main loop or exits on LR (last record).**

---

## 6. Subroutines and Operations

### a. **forny (Renew)**
- Used to refresh the subfile (on user request or after changes)
- Repositions if needed, clears and recreates the subfile.

### b. **posisjoner (Position)**
- Used for subfile positioning (e.g., find a specific record to start display at).
- Clears and recreates the subfile starting at a specified key.

### c. **subfile**
- Reads the subfile, processes selections made (view, copy, delete, update, etc.).
- Sets internal indicators as needed.

### d. **xc1msg / xc2bld**
- Handles message display or display/edit for new/change/view operations.

### e. **xm1win / xr1win**
- Windows for copying or removing a bonus agreement on a customer category.
- Processes logic to apply/remove a bonus to all customers in a category.

### f. **kopier/rmv_bonus**
- Copies templates to all customers in a category (`kopier`).
- Removes bonus agreements from all customers in a category (`rmv_bonus`).
- These call external programs (`EM114R`, `EM111R`, `EM400R`).

### g. **clr_subfile**
- Clears the subfile by setting indicators, writing control records, and resetting counters.

### h. **crt_subfile**
- Populates the subfile with up to `c_sfil` records.

### i. **bck_subfile**
- Scrolls back one subfile "page" (for roll-down).

### j. **dsp_subfile**
- Handles display of the subfile, sets indicators, and writes control record(s).

### k. **hnt_txt**
- Auxiliary routine that fetches description texts for a bonus/mal and customer category using related files.

---

## 7. Keylists

At the bottom, all the key lists (KLIST) for file access are defined, matching their usage in the program:
- File positioning and record identification is always by company + business key(s).

---

## 8. Initialization (*inzsr)

- Loads company from the LDA.
- Sets initial internal indicators.
- Positions the primary file.
- Fills the subfile with initial data.

---

## 9. Program Flow Summary

1. **Start:** Initialize state, load company, fill subfile.
2. **Main Loop:** Display subfile, wait for user input.
3. **Process Input:** Depending on function key or selection:
    - Roll up/down, position, refresh, view, copy, delete, etc.
    - Update subfile as needed (clear, recreate), call external programs for business logic.
4. **Subroutines:** Handle subfile population, clearing, positioning, updates, and text lookups.
5. **Exit:** On exit function key, set LR and return.

---

## 10. Comments/Scandinavian Business Context

- Comments are in Norwegian, reflecting a Scandinavian business environment.
- Terms:
    - **Kunde** = Customer
    - **Bonus** = Bonus/Incentive
    - **Mal** = Template
    - **Kategori** = Category

---

## 11. External Programs

Several business logic steps are outsourced to external calls (e.g., `EM114R`, `EM111R`, `EM400R`). These might implement more complex bonus copying/removal.

---

## Summary Table (Major Functions)

| Function/Subroutine | Purpose                                                    |
|---------------------|------------------------------------------------------------|
| main loop           | Handles display/interaction, responds to user keys         |
| forny               | Refresh subfile display                                    |
| posisjoner          | Position to a specific key in subfile                      |
| subfile             | Handle subfile row actions (view, copy, update, delete)    |
| clr_subfile         | Clear subfile and counters                                 |
| crt_subfile         | Populate subfile page with next N records                  |
| bck_subfile         | Scroll backward in subfile                                 |
| dsp_subfile         | Display subfile control/command screens                    |
| hnt_txt             | Fetch description texts for templates/customer categories  |
| kopier/rmv_bonus    | Copy/remove bonus templates for (all) customers in a category |

---

## Learnings for New Developers

- **Subfiles** are central for user interaction and paging.
- **Indicators** are the backbone of display/file handling and must be tracked carefully.
- **Keyed file access** is crucial for performance and correct data.
- **External program calls** are typical for business logic encapsulation.
- **Initialization** steps (from LDA, etc.) are important for proper context.

Understanding IBM i subfile logic and how indicators and KLISTs are used is key for onboarding to this program. The business rules are embedded in file structures and external programs; this RPG code is the glue for user-facing maintenance and interaction.