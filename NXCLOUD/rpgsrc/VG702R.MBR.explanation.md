# RPG Program `VG702R` – Detailed Explanation

This program is written for IBM i (AS/400) in ILE RPG and is meant for **recalculation of the rolling average cost price** ("glidende gjennomsnittlig kostpris") for inventory/materials. It is heavily commented in Norwegian, and much of the business logic is based on inventory, warehouse, item master, and purchasing files. Let's break it down component by component, so you can onboard yourself or others quickly.

---

## **1. Program Metadata and Conventions**

- **Header:**  
  Describes the program (`VG702R`), which calculates new rolling average cost prices.
- **Change log:**  
  Lists program changes and enhancements.
- **Indicator usage:**  
  *LR* = End program  
  80-99 = Work indicators (used internally)
- **Compile Options:**  
  `option(*nodebugio)` – disables I/O debugging  
  `datedit(*dmy)` – date format is day/month/year

---

## **2. File Declarations**

Several physical/logical files are declared with `F` specs and renamed for local use. For example:
- Purchase header (`lohelr`, from `lohepfr`)
- Purchase lines (`lodtlr`, from `lodtpfr`)
- Cost price update/history files (`vgkpiu`, `vgkpi1`)
- Item master, warehouse, vendor, and cost price parameter tables

---

## **3. Data Structure and Variable Declarations**

- **Parameters:**  
  Variables such as `p_numm` (order number), `p_suff` (suffix), etc., used to drive the recalculation process.
- **Local Data Area:**  
  Used for the company (`firm`) and user.
- **Cost price factor structure (`d_frec`):**  
  Holds up to five factors for cost price adjustments, e.g., surcharges, discounts, etc.
- **Key variables:**  
  For looking up records in files using *CHAIN* or *SQL*.

---

## **4. External Procedures**

- **VG707R**:  
  A separate program called to fetch deviation percentages for checking cost price deviations.

---

## **5. Mainline Logic**

### **a. Entry and Initialization**

- **Initialization Subroutine (`*inzsr`):**  
  - Reads parameters.
  - Sets up keys for various lookups.
  - Initializes the company number from the LDA.

---

### **b. Main Processing Routine**

#### **Step 1: Read Purchase Header**

- Use the provided purchase/order number and suffix to find the purchase header.  
- If not found, exit the program.

#### **Step 2: Setup SQL Cursor for Purchase Lines**

- Defines a cursor to read all order lines for the given order, sorted by item number.

#### **Step 3: Loop Through Purchase Lines**

- For each unique item on the order:
  - Skip lines already processed for this item.
  - Chain to the purchase line record:
    - Skip if it is a direct delivery.
    - Skip if the quantity is zero or negative.
    - Skip if the line type is not a valid inventory type.
    - Skip if item or warehouse lookups fail.
  - **Summing and Calculation:**
    - Sum quantities, cost, and purchase price for this item/order/suffix (`sum_best`).
    - Calculate per-unit purchase price and cost price.
    - Sum historical inventory ledger for the item/warehouse/date (`sum_hist`).
    - If variance between purchase and ledger is too high, log an error and continue.
    - Recalculate prices to warehouse base units if needed (`beregn_pris`).
    - Check if purchase price is too deviant vs. calculated cost price (`kost_kontroll`).
      - If so, log an error and continue.
  - **Calculate Rolling Average Cost Price:**
    - Fetch previous average cost price (via call to `VG701R`).
    - Get previous on-hand balance.
    - Calculate new average cost price, combining old and new purchase cost.
    - Skip updates if the new price is zero/negative.
  - **Update Cost Price File:**
    - If an existing record, move to history and write new record.

---

### **c. Error Handling and Logging**

- For various error conditions (e.g., negative/zero quantities, missing data, large variances), a subroutine logs error details to a separate file.
- PSSR error subroutine handles any program issues and logs a hardcoded message.

---

## **6. Subroutines**

### **A. `les_vare`, `les_lager` – Item/Warehouse Lookup**

- Validates that the item and warehouse exist and are of correct types.

### **B. `sum_best` – Sum Purchase Lines**

- Uses SQL `SELECT` to sum quantities and amounts for all lines matching the current item/order/suffix.

### **C. `sum_hist` – Sum Inventory Ledger Lines**

- Sums historic on-hand quantities for warehouse/item on the relevant date.

### **D. `finn_behl` – Find Previous Balance**

- Looks up last inventory balance before the purchase.

### **E. `kost_kontroll` – Cost Price Deviation Control**

- Calls `VG707R` to fetch allowed deviation percentage.
- Fetches calculated and purchase prices from the price file.
- Flags deviations and sets adjustment factors for later price calculations.

### **F. `finn_kost` – Find Calculated Cost Price**

- Pulls calculated cost and purchase price for the selected vendor and item.

### **G. `finn_kostt` – Calculate Supplements/Deductions**

- Loops through up to five cost price factors, adjusts the cost price according to sign (+/-) and percentage.

### **H. `beregn_pris` – Convert Prices to Warehouse/Inventory Unit**

- Converts incoming prices and quantities to warehouse unit, taking conversion factors into account.

### **I. `pris_hist` – Historical Cost Price Entry**

- Deletes the original cost price record.
- Adds a history record.
- Writes the new cost price.

### **J. `logg_feil` – Error Logging**

- Inserts an error row into `vgkest` with details about the transaction and reason for the error.

---

## **7. Keys and Indexes for File Access**

- Several *KLISTs* are defined for efficient key lookups in various files, always including company number and then the specific key fields for the entity.

---

## **8. Notable Business Rules and Features**

- Only processes inventory lines (not direct deliveries or non-stocked items).
- Handles conversions between various units (purchase unit, warehouse unit, base unit).
- Includes robust error handling and business checks (e.g., big variances, negative or zero values).
- Maintains an audit/history trail for updates to cost price.

---

## **Summary Table**

| Functionality              | Where                       | Description                                 |
|----------------------------|-----------------------------|---------------------------------------------|
| Read purchase header       | Mainline                    | Finds the order by number/suffix            |
| Read purchase lines        | Mainline + SQL cursor       | Loops through all items on the order        |
| Summing lines              | `sum_best`                  | Sums up all relevant lines per item         |
| Inventory ledger sum       | `sum_hist`                  | Gets on-hand qty from the ledger            |
| Previous balance           | `finn_behl`                 | Gets existing balance pre-purchase          |
| Cost price deviation check | `kost_kontroll`             | Ensures price isn't wildly off              |
| Price/unit conversions     | `beregn_pris`               | Handles unit conversions for costing        |
| Error logging              | `logg_feil`                 | Logs any failures for audit/review          |
| Cost price update          | Mainline/`pris_hist`        | Moves previous record to history, writes new|

---

## **In Short**

- This program is a **batch recalculation tool** for rolling (weighted) average cost, integrating:
  - Inventory, item master, and order data,
  - Cost factor supplements,
  - Robust business rule checks,
  - Extensive error handling and logging,
  - Automatic handling of unit conversions,
  - History preservation for cost prices.

If you need to extend, test, or maintain this program, pay close attention to the SQL queries, file structures, and the effect of each subroutine on the workflow. The code is modular, and each "EXSR" (subroutine call) encapsulates specific business logic relevant to Norwegian inventory and costing processes in ERP systems.