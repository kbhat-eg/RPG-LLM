# RPG Program LH102R - Code Explanation

This program is written in ILE RPG, targeted for IBM i (AS/400) systems, for the maintenance of purchase proposal detail lines (“Bestillingsforslag, vedlikehold detaljlinjer”).

---

## **General Description**

- **Purpose:** Maintenance of purchase order suggestions (proposals) for items per warehouse/location, allowing for viewing, editing, adding, and deleting suggestion lines.
- **Main Interactions:** 
  - Uses a subfile to display and manipulate suggestion lines.
  - Calls various external programs to display additional information and update related data.
- **Primary Data:** Proposal headers and lines, item and warehouse master data, suppliers, and status codes.

---

## **Key Sections**

### 1. **Header and Change Log**
- The comments at the top describe program history, versioning, and a detailed revision log. 
- Lists maintenance events, functional and technical changes across versions.
- The “Bruk av indikatorer” section explains the usage of indicator variables (LR, 10-99) used for logic, field protection, and error messaging.

---

### 2. **File Definitions** (`F-Specs`)
- **Physical and Logical Files:** 
  - Many physical and logical files (`lfhelr`, `lfdtlr`, `vvarl1`, `vlagl1`, etc.) are declared for reading/writing headers, details, items, warehouses, suppliers, etc.
- **Display File:**
  - `lh102d` is the display file, using a subfile for managing lists on the screen, with a data structure (`infds`) for display feedback.

---

### 3. **Data Definitions** (`D-Specs`)
- **User Space & Variables:** 
  - Local Data Area fields for user, company/firm code, and other context information.
- **Working Variables:** 
  - Line numbers, item numbers, quantities, statuses, text fields, weights, error flags, etc.
- **Indicator Variables:** 
  - Boolean flags controlling different logic branches, e.g., for status handling, error detection, module access, etc.

---

### 4. **Procedures and Subroutines**
The core logic is built around subroutines called via `EXSR`, with key workflows shown below:

#### **Main Loop and Function Key Handling**
- Handles user interactions on the display, responding to function keys to:
  - Refresh the subfile
  - Edit, delete, or change status on a line
  - View item or warehouse information
  - Handle position or navigation within the subfile

#### **Subfile Management**
- **Creating and Clearing Subfiles (`crt_subfile`, `clr_subfile`):**
  - Populates or clears the subfile screen with proposal lines, manages page and line counters.
- **Positioning (`posisjoner`):**
  - Allows positioning to a specific item or line.
- **Subfile Processing (`subfile`):**
  - Reads subfile records, processes user-selected actions (edit, delete, view info, status changes).
  - Handles update and iteration logic for subfile rows.

#### **Edit/Add/Delete Workflows**
- **Edit Line (`xb3win`):**
  - Populates edit window with line data for editing, performs validations (e.g., replacement item check), updates record.
- **Delete Line (`xb4win`):**
  - Prompts confirmation and deletes a detail line.
- **Add Line (`xb6win`):**
  - Shows registration window for new line, checks if item is valid warehouse item, initializes values, and adds new detail line.

#### **Status and Validation Logic**
- **Status Management (`sjk_stat`, `xb10win`):**
  - Determines and updates status codes for lines, based on quantities, minimum/maximum, and other business rules.
- **Replacement Item Check (`sjk_erst`):**
  - Checks if the item is a replacement product, updates information display accordingly.
- **Bestilling Check (`sjk_best`):**
  - Checks if the item is already on order, may update status accordingly.
- **Text Line Edit (`xb11win`):**
  - Allows editing of description text lines attached to proposals.

#### **Support Routines**
- **Item/Warehouse Lookup (`finn_varelag`, `les_vare_enh`, `hent_inkenh`):**
  - Fetches details for items and warehouses, checks unit validity, retrieves minimum, maximum, reorder levels, etc.
- **Pricing and Campaigns (`sjekk_kamp`, `finn_lbel`):**
  - Checks for special campaign prices, computes value per line based on price or campaign.
- **Weight/Volume Calculations (`cal_line`):**
  - Calculates line totals for weight and volume, considering item and package master data.
- **Omregningsfaktor (`hent_omr`):**
  - Computes conversion rates between units.

#### **Program Initialization (`*INZSR`)**
- Sets initial values, retrieves parameters from the calling program, reads proposal header, determines subfile setup and configuration (e.g., max/min vs. reorder/batch, price groups, access permissions).
- Calls subfile fill routines for initial display.

---

### 5. **External Calls**
Throughout, external programs are called (e.g., `VV500R`, `VV510R`, `VL710R`, `VP750R`, `JM592R`, etc.) for:
- Item lookup and display
- Warehouse info
- Price retrieval
- Campaign lookups
- Supplier info
- Parameter fetching

These encapsulate complex business rules and centralize logic outside this program.

---

### 6. **Indicators and UI Notes**
- **Indicators:** Set/reset for UI display, function key triggers, error notifications, field protection, and other GUI controls. Explained at start for reference.
- **Subfile Variables:** Variables like page number, first/last line on page, current cursor row/column are carefully managed for user navigation and screen refreshes.

---

## **Key Business Rules and Notes**
- **Status calculations** are based on order quantities, availability, and configuration switches.
- **Access control**: Checks user module access (e.g., BM_MODUL).
- **Flexible logic**: Many routines use switches (~flags) and parameters read from system configuration files/tables.
- **Text handling**: Supports editing and storing of custom text lines (e.g., for line comments/descriptions).
- **Error handling**: Uses indicators for feedback and to prevent invalid actions.

---

## **Extensibility**
- **Versioning:** The program is versioned and modular, supporting ongoing enhancement (as seen in the extensive change log and use of switches for optional feature toggling).
- **Subfile Driven:** The UI logic is designed around subfiles, which is a standard IBM i technique for managing lists and records interactively.

---

## **Summary of Main Data Flows**

1. **On Entry:** 
    - Reads input parameter (proposal number), company info, and initializes context data.
    - Reads header and prepares subfile for display.

2. **User Interacts:**
    - Via subfile, selects actions (edit, delete, view, status change).
    - Program responds with subroutines, updates display, refreshes data as needed.

3. **On Exit:**
    - Totals (amount, weight) recalculated and updated in the proposal header.
    - Updates status and audit fields (date, time, user).

---

## **Onboarding Tips**

- Understand the indicator system and how subfiles operate on IBM i.
- Get comfortable tracing subroutines (`EXSR`) and how they form the backbone of logic flow.
- Review external programs; their interfaces and return data are central to business logic.
- Familiarize yourself with the key data files and their significant fields.
- When making changes, always refer to the change log and business rules for possible side effects.

---

## **Conclusion**

This RPG program is a feature-rich, robust, and extensible tool for handling purchase proposals and their detail lines in a warehouse system, exemplifying best practices in modular RPG with extensive use of subfiles, indicators, and external program calls to encapsulate business logic.