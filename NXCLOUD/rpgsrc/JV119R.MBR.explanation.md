# JV119R Program Overview

## Purpose  
This IBM i ILE RPG program (`JV119R`) displays blocked supplier-item price updates. It shows a subfile of item–supplier records, allowing users to page up/down, refresh, and drill into details.

---

## File Declarations (F-specs)  
- **fjvarl1**, **fjlevl1**, **fjvlel1**: External keyed files renamed for access to item (`jvarpfr`), supplier (`jlevpfr`), and item-supplier (`jvlepfr`) master data.  
- **fJV119d**: Display device file with a subfile record format (`B1SFL`) and a control format (`B1SFL` on `W_SRRN`), plus feedback via `DSPFBK`.

---

## Data Definitions (D-specs)  

### Indicators Usage  
- `*INLR`: Program end  
- `10`/`11`: Subfile page down/up  
- `12`–`15`, `21`–`22`, `30`–`99`: Screen control, cursor positioning, error flags

### Working Variables & Constants  
- **Paging controls**  
  - `W_FCRN`: First record number on page  
  - `W_STEL`: Subfile loop counter  
  - `W_SPGE`: Page size (`C_SFIL = 14`)  
  - `W_SRRN`: Current record number in subfile  
  - `W_SFRN` / `W_SSRN`: First/last record numbers on last page  
- **Parameters**  
  - `P_LVNR`, `P_LLDO`: Entry parameters (item code, supplier code)  
- **Keys & Buffers**  
  - `JVARL1_VARE`, `JLEVL1_LDOR`, `JVLEL1_LLDO`: Current key values  
  - `W_LVNR`, `W_LLDO`: Working keys  
- **Flags**:  
  - `B_OPPR`, `B_FORN`, `B_ANUL`, `B_FEIL`: Update, refresh, cancel, error flags  
- **Info DS** (`DSPFBK`):  
  - `D_FCRN`: Received first record number from display feedback

---

## Screen Files & Subfiles  
- **B2CTL**: Control record for subfile (initial display)  
- **B2CMD**: Command frame for function keys  
- **B1SFL**: Subfile record format  

---

## Main Processing Flow  

1. **Display Command Frame** (`B2CMD`)  
2. **Loop** (`B2TAGB`):  
   - Call `DSP_SUBFILE` to show/refresh the control.  
   - **Function key handling** (`SELECT` on indicators):  
     - **Exit** on F3/F12  
     - **Refresh** on Help  
     - **Page down/up** on PF10/PF11 → `CRT_SUBFILE` / `BCK_SUBFILE`  
     - **Home** (PF21) / cursor reposition (PF22)  
3. **Positioning**  
   - If an initial supplier code exists, call `POSISJONER` to position before building.  
4. **Build Subfile**  
   - Call `SUBFILE` to read and display records.  
5. **Exit** (`AVSLUTT`):  
   - Set `*INLR = *ON`, `RETURN`

---

## Subroutines  

### 1. FORNY (Refresh)  
- Chains to subfile at `W_FCRN`, clears and re-creates the subfile.

### 2. POSISJONER (Positioning)  
- If `B2LLDO` (desired supplier) is set:  
  - Set `Jvlel1` key and position to it.  
  - Clear & rebuild subfile.  
  - Reset `B2LLDO`.

### 3. SUBFILE (Process Subfile Records)  
- Toggles display flag (`*IN22`)  
- Loops through subfile records (`DO W_SSRN`) with `READC` on `B1SFL`.  
- On selection (`B1VALG = 5`), captures the supplier code and calls `XC2BLD` to show detail, then updates record.

### 4. XC2BLD (Detail Display – C2BLD)  
- Reads the selected `JVLEL1` record (item-supplier).  
- Moves database fields into display fields (`C2LVEI`, `C2LLVA`, dates, amounts).  
- Presents the C2 screen (`EXFMT C2BLD`) and loops on errors or cancellations.

### 5. CLR_SUBFILE (Clear Subfile)  
- Sets `*IN14` to blank the control format, resets paging counters (`W_SRRN`, `W_SFRN`, `W_SSRN`, `W_SPGE`).

### 6. CRT_SUBFILE (Create/Filling Subfile)  
- Increases page end (`W_SPGE += 14`), initializes start (`W_SRRN = W_SSRN`).  
- Loops (`DO UTO W_SPGE`):  
  - Reads next `JVLEL1` record with the same item & supplier range.  
  - For each record:  
    - Retrieve item text from `JVARL1`.  
    - Read supplier from `JLEVL1`.  
    - Populate subfile buffer (`B1SFL`) fields.  
    - `WRITE B1SFL` to add to screen.  
- Sets `W_SFRN` if new page start > last, updates end record and `W_VIRN` (cursor).

### 7. BCK_SUBFILE (Back-Page)  
- If end-of-file, position just after last page.  
- Loop backwards page-size records via `READP` to find page start, then clear & rebuild.

### 8. DSP_SUBFILE (Display Control)  
- If any records loaded, turn on subfile indicator (`*IN12`) else write control format.  
- Present control with `EXFMT B2CTL`, capture `D_FCRN` for next start.

### 9. *INZSR (Initialization)  
- Entry routine (`*ENTRY`) receives `P_LVNR`, `P_LLDO`.  
- Chains to get item master text, sets up screen-level variables.  
- Positions `JVLEL1` to first record (`SETLL`), calls `CRT_SUBFILE` to load initial page.

---

This modular structure—**control frame → key handling → positioning → subfile build/display → detail drill**—ensures a responsive, paged listing of blocked item-supplier price records with drill-down capability.