# ILE RPG Program Explanation: `LA963R`

This RPG program, named `LA963R`, is a batch routine for updating inventory register records (`vlaglur`) based on historical inventory transactions before the current year, as found in the historical inventory ledger (`vhisl3r`, `vhisl5r`). The code is written in fixed-format RPG IV (ILE RPG), and much of the documentation is in Norwegian.

## **File Declarations**

- **vhisl3**: Input file, keyed, historical ledger, renamed as `vhisl3r`, field prefix `xx:`.
- **vhisl5**: Input file, keyed, another ledger file, renamed as `vhisl5r`.
- **vlaglu**: Update file (write access), the inventory register, renamed as `vlaglur`.

## **Data Structures and Work Fields**

- **Parameter Structure** (`ds`): Used to handle the incoming parameter (`w_parm`), which is a 64-character string overlaid into individual fields including 4 single-character values and a date.
- **User Space (`uds`)**: Used to load user and firm code from the program's user area.
- **Key Fields**: Work variables for building primary keys for file access (e.g., `vhisl3_vare`, `vhisl3_lage`, etc.).
- **General Work Fields**: Used for intermediary values and processing logic.

## **Initialization (`*inzsr`)**

- **Key Lists**: Build key lists for file accesses (vhisl3, vhisl5, vlaglu).
- **Parameter Read**: Accept and unpack the parameter into fields (`d_prec`, etc.).
- **Startup Field Initialization**: Set company (`w_firm`) and clear some key fields.

## **Main Processing Loop**

### **Step-by-step Flow**

1. **Set Start Position**:
   - Use SETLL with `vhisl3_key` to position the cursor in the `vhisl3r` file.

2. **Read Records**:
   - Read records sequentially (`READ vhisl3r`).
   - If end-of-file or company changes, the job ends (`goto slutt`).

3. **First Row Handling**:
   - On the first pass, store `vare` (item) and `lage` (warehouse/location).

4. **Skip Duplicate Item/Warehouse**:
   - If not the first record and still the same item/warehouse, continue to next record.

5. **Prepare Key for vhisl5**:
   - Set key fields to *hival (highest value—meaning not found).
   - Use SETLL followed by READ to try to find the corresponding record in `vhisl5r`.

6. **Date Comparison**:
   - Extract and compare year portion of dates from `vhisl3` and the historical date (`vhisxx`).
   - If the record is for the current year, skip updating, but update work fields.

7. **Update Inventory Register**:
   - If record is for a previous year, run subroutine (`exsr oppdat`) to update inventory status.

8. **Repeat Loop**:
   - Continue processing with the next record.

## **Subroutines**

### **oppdat** (Update Routine)

- **Chain to warehouse register (`vlaglur`) with the current item/warehouse key**.
- **If the record exists and `d_val3` = 1 (criteria met from parameter)**:
  - Increment transaction counter (`vlbeve`).
  - Set starting balance for Jan 1 (`vlb101`).
  - Update date, time, and user fields.
  - Update the record.

### **Main End**

- **slutt**: Set the last record indicator to end the program (`*inlr`).

## **Key Technical Points**

- **Key Handling**: Uses KLIST/KFLD structures to manage multi-part keys for each file.
- **Parameter Passing**: Accepts a packed structure and decodes it into fields, including a date in ISO format.
- **Year Comparison**: Compares only the year portions of two dates by moving/overlaying the strings.
- **File Update**: Only updates the inventory register if certain conditions are met (older than current year, parameter flag set).
- **Norwegian Comments/Identifiers**:
  - "Oppdatering av lager-register utfra lagerbok" = "Update inventory register from inventory ledger"
  - "Vare" = Item/Product
  - "Lager" = Warehouse

## **Typical Usage Scenario**

- This program is likely run during the beginning-of-year process to initialize inventory balances, using posted transactions from previous years.
- It ensures that only items/warehouses not affected by transactions in the current year are updated based on historical data.

---

### **Summary Table**

| File     | Mode    | Function                                     |
|----------|---------|----------------------------------------------|
| vhisl3   | Input   | Historical inventory ledger                  |
| vhisl5   | Input   | Another (secondary) historical inventory file|
| vlaglu   | Update  | Inventory register (target of update)        |

---

## **Key Logic (Pseudocode Summary)**

```
For each unique item/warehouse in historical ledger:
    If transaction exists only in previous years,
        and meets parameter criteria,
        update starting balance and transaction counter for that item/warehouse.
```

---

## **Onboarding Advice**

- **Familiarity with Norwegian terms** will help understand field names and comments.
- **Pay attention to the year comparison logic**—it avoids updating items with activity in the current year.
- **Parameter handling** is critical; understand how this program is called and how those values affect update logic.
- **File structures** and field definitions (not visible in this snippet) should be referenced for a deeper understanding of keys and update fields.

---

This program is a robust example of a legacy ILE RPG batch update program, focused on accurately rolling over inventory balances based on historical activity.