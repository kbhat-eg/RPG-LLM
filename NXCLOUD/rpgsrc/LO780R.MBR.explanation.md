## Program Overview

**Program Name:** LO780R  
**System:** ASLAGR  
**Description:**  
This program generates a supplier order file in the Løvenskiold format. It reads order header and line information from the internal database, formats the output records according to Løvenskiold's requirements, and writes them to an output file. The program includes logic for extracting and formatting item numbers (EAN, supplier item number, NOBB), handling date/time, and constructing the output file name.

---

## Business/Domain Context

- **Løvenskiold** is a major Norwegian retailer. This program prepares purchase orders for suppliers in a proprietary, fixed-length record format required by Løvenskiold.
- The program is a variant of LO770R, with enhancements for item number handling, GLN number retrieval, and record formatting per evolving Løvenskiold specifications.
- The code handles various item number formats (EAN, supplier item number, NOBB), including support for 6- and 7-digit supplier numbers and 14-digit EANs.

---

## File Interactions

**Input Files (all DISK, keyed, externally described, renamed):**
- `afirl1` (afirpfr → afirl1r): Company information
- `lstsl1` (lstspfr → lstsl1r): Warehouse codes
- `lohel1` (lohepfr → lohel1r): Order header
- `lodtl1` (lodtpfr → lodtl1r): Order lines
- `lldilr` (lldipfr → lldilrr): Supplier distribution
- `vvarl1` (vvarpfr → vvarl1r): Item master

**Output File:**
- `lwlopf`: Order output in Løvenskiold format

**External Program Call:**
- `VE711R`: Retrieves EAN number for an item (called in subroutine `finn_vnr`).

---

## Record Layouts and Data Structures

The program constructs output records as 80-character fixed-length strings, overlaid in RPG data structures:

- **Start Record (`d_srec`):** Identifies file start, includes record type, order number, customer, date, time, and a fixed literal 'BTM'.
- **Order Record (`d_orec`):** Order header, with type, order reference, and literal 'ORDRE'.
- **Item Records:**
    - **EAN (`d_vrc1`):** For 13/14-digit EANs.
    - **Supplier Item Number (`d_vrc2`):** For 6/7-digit supplier numbers.
    - **NOBB (`d_vrc3`):** For Norwegian building industry item numbers.
- **End Record (`d_slrc`):** Identifies file end, includes summary fields.

All records are written to the output file in the order: start, order header, item lines, and end.

---

## Key Variables and Business Logic

- **Order Identification:**  
  Order number (`p_numm`) and suffix (`p_suff`) are input parameters, passed from the calling program.
- **Date/Time Handling:**  
  Multiple date/time fields are extracted, reformatted, and placed in the output records as required by Løvenskiold.
- **Item Number Extraction:**  
  Subroutine `finn_vnr` determines the correct item number to use (EAN, supplier number, or NOBB) for each line.
- **File Naming:**  
  Output filename is dynamically constructed using the day of week and time, with conventions for test files (e.g., including 'TT').
- **Indicators:**  
  - `LR`: End of program
  - `80-89`: Work indicators
  - `90-99`: File indicators (e.g., found/not found on CHAIN)

---

## Main Processing Flow

1. **Initialization (`*inzsr`):**
    - Reads company number from LDA.
    - Sets up key fields for file access.
    - Reads company and warehouse info.

2. **Parameter Handling (`*entry`):**
    - Retrieves order number, suffix, and output filename from the calling program.
    - Sets up keys for subsequent file access.

3. **Date/Time Calculations:**
    - Current date/time are retrieved and formatted.
    - Day of week is calculated for filename generation.

4. **Order Header Retrieval:**
    - Reads order header (`lohel1`).
    - Fetches supplier distribution info (`lldilr`), with fallback logic if not found.

5. **Start Record Construction:**
    - Constructs and writes the start record (`d_srec`) to the output file.

6. **Order Lines Processing:**
    - Reads all order lines (`lodtl1`) for the given order.
    - For each line:
        - Skips lines with specific type (`laatty`).
        - Calls subroutine `finn_vnr` to determine item number.
        - On first valid line, writes the order header record (`d_orec`).
        - Formats quantity and item number, choosing among EAN, supplier number, or NOBB based on availability.
        - Writes the appropriate item record (`d_vrc1`, `d_vrc2`, or `d_vrc3`).

7. **End Record Construction:**
    - After all lines, writes the end record (`d_slrc`).

8. **Output Filename Handling:**
    - Constructs the output filename using conventions (e.g., prefix, weekday, time).
    - Returns the filename to the caller via parameter.

9. **Program End:**
    - Sets LR indicator and returns.

---

## Subroutine: `finn_vnr` (Find Item Number)

- **Purpose:**  
  Determines the correct item number to use for an order line, in priority order: EAN, supplier item number, NOBB.
- **Logic:**
    - Calls external program `VE711R` to attempt to retrieve a valid EAN.
    - If EAN is returned and valid, uses it.
    - If supplier item number (`ldlvar`) is present:
        - If 7 digits and numeric, uses as supplier number (`d_prn7`).
        - If 6 digits and numeric, uses as supplier number (`d_prnr`).
    - If NOBB number (`ldnobb`) is present, uses it.
- **Error Handling:**  
  If none of the above is found, sets error indicator (`b_feil`).

---

## Notable Design/Implementation Details

- **Overlaying Data Structures:**  
  All output records are built as overlays of 80-character strings, allowing for fixed-format output required by Løvenskiold.
- **Flexible Item Number Handling:**  
  The code is designed to handle multiple item number formats, with logic for both 6- and 7-digit supplier numbers and validation for numeric content.
- **External Program Call for EAN:**  
  Instead of direct database access, EAN numbers are retrieved via a dedicated program (`VE711R`), supporting central logic for EAN assignment.
- **Conventions for File Naming:**  
  Filename includes weekday and time, supporting both production and test file conventions.
- **Error Handling:**  
  Several points in the code set the `b_feil` indicator and skip further processing if errors are detected (e.g., missing supplier distribution, invalid item numbers).

---

## Relationships with Other Modules

- **VE711R:**  
  External program for EAN retrieval. The interface expects company number, item number, unit, and returns EAN and a status flag.
- **Order Management System:**  
  Reads from order header and line files, company, warehouse, and supplier distribution files. The output is likely consumed by an external supplier integration process or sent directly to Løvenskiold.

---

## Version History Highlights

- **6.10 – 6.30:**  
  Progressive enhancements for item number handling, including support for 14-digit EANs, 7-digit supplier numbers, and improved logic for extracting the real part of item numbers.
- **6.11:**  
  Introduction of external program for EAN retrieval.
- **6.12:**  
  Enhanced supplier item number handling, supporting both 6- and 7-digit formats.

---

## Key Conventions and Patterns

- **Indicator Usage:**  
  - 80-89: Work indicators
  - 90-99: File indicators (CHAIN, etc.)
- **Record Type Codes:**  
  - '200': Start record
  - '201': Order record
  - '202': Item record
  - '299': End record
- **Field Overlays:**  
  All output fields are overlaid on top of a base 80-character string for each record type.

---

## Summary

This program is a specialized order export utility for the Løvenskiold business partner, designed to meet strict formatting and data requirements. It integrates with internal order management files, supports complex item number logic, and leverages external routines for EAN retrieval. The codebase prioritizes flexibility for evolving supplier requirements and robust error handling during the export process.