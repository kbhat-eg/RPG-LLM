# Explanation of the RPG Source Code `FW102R`

---

## Overview

This RPG (Report Program Generator) code is for the ASOFAK system, specifically for a program named `FW102R`. Its purpose is to handle the reading/import of products/items and prices from suppliers into the system's "supplier item registry." It acts as a controller or steering program ("styreprogram"). The code provides mechanisms for copying supplier files, clearing out old records, invoking specialized sub-programs for different formats, and updating the registry.

---

## File Declarations

```rpg
fflvalu    uf   e           k disk    rename(flvapfr:flvalur)
```
- Defines file `flvalu` (with a user-opened, externally described, keyed disk file), using an alternate record format name (`flvalur`).  
- This file is the supplier items registry.

---

## Data Definitions

**Parameters**
```rpg
d p_firm          s                   like(fwfirm)
d p_ldor          s                   like(fwldor)
d p_file          s             12
d p_fldr          s             20
d p_prog          s             10
d p_feil          s              1
d p_valg          s              2  0
```
- `p_firm` : Company number (like `fwfirm`)
- `p_ldor` : Supplier code/id (like `fwldor`)
- `p_file` : File name (12 chars)
- `p_fldr` : Folder name (20 chars)
- `p_prog` : Program name to call (10 chars)
- `p_feil` : Error flag (1 char)
- `p_valg` : Option code for processing (2-digit integer)

**Other Variables**
```rpg
d flvalu_ldor     s                   like(fwldor)
d w_firm          s                   like(fwfirm)
```
- `flvalu_ldor` : Local variable for supplier code
- `w_firm` : Working variable for company number

---

## Main Program Logic

### 1. **Copy Supplier File to Work File**
Depending on the received option (`p_valg`), a different copy method is chosen:
```rpg
if         p_valg = 27 or p_valg = 29
    call      'FW103C'
    parm                    p_file
    parm                    p_fldr
    parm                    p_feil
else
    call      'FW102C'
    parm                    p_file
    parm                    p_fldr
    parm                    p_feil
endif
```
- If `p_valg` is 27 or 29: Calls `FW103C` (uses IFS instead of QDLS).
- Otherwise: Calls `FW102C`.
- Both programs are passed the file name, folder, and an error flag.

### 2. **Abort On Error**
```rpg
if        p_feil = *on
    goto      avslutt
endif
```
- If an error occurred during file copy, skip to the program end (tag `avslutt`).

### 3. **Clear Out Old Supplier Records**
```rpg
eval      flvalu_ldor = p_ldor
flvalu_key    setll     flvalu
flvalu_key    reade     flvalur                                90
dow       *in90 = *off
    delete    flvalur
    flvalu_key    reade     flvalur                                90
enddo
```
- Sets the key to the supplier (`flvalu_key`â€”see *inzsr for definition).
- Loops through all records for that supplier and deletes them to remove old items/prices.

### 4. **Handle Special Formats**
- **General SDV Format:**
  ```rpg
  if        p_prog = 'FW725R   '
      call      p_prog
      goto      avslutt
  endif
  ```
  - If the program to be called is `FW725R` (general SDV format), call it and exit.

- **General Integ.dat Format:**
  ```rpg
  if        p_prog = 'FW727R   '
      call      'FW727C '
      parm                    p_ldor
      goto      avslutt
  endif
  ```
  - If `FW727R` (general Integ.dat format), calls `FW727C` with the supplier code, then exits.

- **Control List (IFS) Format:**
  ```rpg
  if        p_prog = 'FW729R   '
      call      'FW729C '
      goto      avslutt
  endif
  ```
  - If the control program is `FW729R`, calls `FW729C` and exits.

### 5. **Import New Data**
```rpg
call      p_prog
parm                    p_firm
parm                    p_ldor
```
- For all other cases, calls the import program indicated in `p_prog` with company and supplier code.

### 6. **End of Program**
```rpg
avslutt       tag
eval      *inlr = *on
return
```
- Marks the end, sets the last record indicator (`*inlr`) to on to close files, then returns.

---

## Subroutine: *inzsr (Initialization Routine)

**Handles:**
- Entry point parameter passing
- Key list definition for file operations
- Initial setup

```rpg
*inzsr        begsr

*entry        plist
parm                    p_firm
parm                    p_file
parm                    p_fldr
parm                    p_prog
parm                    p_ldor
parm                    p_valg
parm                    p_feil

flvalu_key    klist
kfld                    w_firm
kfld                    flvalu_ldor

eval      w_firm = p_firm

endsr
```
- Moves initial `p_firm` value into `w_firm` (used in key list).
- Defines key list `flvalu_key` for accessing supplier records (company + supplier).
- Sets up local variables with incoming parameters.

---

## Comments and Change History

- In the header, you find a change log, credits for contributors, and information about special versions and customer adaptations.
- Comments in Norwegian explain the main sections and logic.

---

## Key Takeaways

- **Purpose:** Automates the loading of supplier item/price data, clearing old records, and invoking the correct specialized handler for different data formats.
- **Flexible:** Can adapt to new file formats by easily adding new conditions and sub-programs.
- **Robustness:** Checks for copy/import errors before proceeding.
- **Modular:** Uses subroutine for initialization and well-structured main logic.

---

### For New Developers:

- **Parameter Passing:** All critical variables are passed in and set during initialization.
- **Extendibility:** If new formats or processes are needed, follow the pattern for the special cases (like FW725R, FW727R).
- **Supplier Data Registry:** Main file operated on is `flvalu` (supplier's item registry).
- **Error Handling:** Always check `p_feil` after calling file copy programs.

---

**In summary:**  
This program is a template/controller for importing supplier item and price files, utilizing key-based file access, selective program calls based on format, and robust error and resource handling.