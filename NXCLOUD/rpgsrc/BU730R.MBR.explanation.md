# Overview of the RPG Source Code

This RPG program is designed for exporting customer information from a system called **ASSHOP**, specifically focusing on non-restricted and active customers. It consolidates customer data, processes customer projects, handles memosaldo (memo balances), and writes the data into output files.

---

# Header Definitions and Metadata

- **`h option(*nodebugio) datedit(*dmy)`**: Configures the program's runtime options. It disables debug I/O and uses date formats in *day/month/year*.

- **Comments Block**: Contains descriptive information such as system name, program name, program description, and a change history with version notes and dates.

- **File Renames and Definitions**: Files are opened with logical *rename* for easier referencing.

---

# Parameter Definitions

- **`p_firm` (logic)**: The company identifier, used to select data relevant to a specific company.

- **`p_dato` (date)**: The date parameter (ISO format) used to filter customers based on activity/date.

- **`p_time` (time)**: Time parameter for filtering or timestamp purposes.

---

# Internal Variables and Data Structures

- **Customer Data Variables**: Structures like `rkkund`, `rknavn`, etc., to hold customer info fields fetched from database files.

- **Customer Project Variables**: For project-specific info, e.g., `flkund`, `flkpro`, etc.

- **Memo and Credit Variables**: For handling memo balances (`mems`), credit limit info (`u_kmem`), and other customer-specific data.

- **Constants and Helper Data Types**: Definitions such as `co402_verdi1`, `co402_verdi2`, and external program prototypes (`CO402R`) for retrieving configuration parameters.

---

# Main Program Logic

## Initialization

- **File Clearing**: Clears output files (`bokustr`, `bokpstr`) to ensure fresh data.

- **Set Company Code**: Loads the company code into `w_firm` from parameter `p_firm`.

- **Read Configuration**: Calls external program `CO402R` to load system-wide values such as `utvidet_memosaldo` (extended memosaldo) and credit limit extensions, storing them in variables like `w_memodagr` and `w_utvgrns`.

## Customer Loop

- **Open Customer Files**: Uses `setll` and `reade` to iterate over customer master records (`rkunl1`).

- **Customer Filtering**: Checks if the customer is valid (`baakun` not zero or matches `rkkund`), not blocked, and within date range (`p_dato` compared to customer activity dates).

- **Customer Data Fetch**: If conditions are satisfied, loads detailed customer info fields into variables like `kund`, `navn`, `adr1`, etc., from the database record.

- **Additional Data Lookup**: Chains to code tables for discount category (`ra06l1`), customer category (`ra11l1`), special agreements (`rksal1`), and property links (`rmknl2`). These enrich the customer data stored for export.

## Memo Balance Calculation

- **Memo Balance (`mems`)**: If the customer credit flag (`u_kmem`) is on, and configuration allows, calls an external program `FO763R` to calculate current memo balance as of the specified date (`p_dato`). The calculation depends on parameters like `w_memodagr` (number of days to include).

- **Memo Data Fetch**: If memo data exists in the database, loads current balance into `mems`, otherwise defaults to zero.

## Output Data

- **Writing Customer Record**: Calls `write` to output the customer info into `bokustr`.

- **Customer Projects**: Calls a subroutine `kundeprosj` to process and output related customer project data.

- **Loop Control**: Repeats for the next customer record until end-of-file.

## Completion

- **Set `*inlr` to `*on`**: Releases resources and ends the program gracefully.

---

# Subroutine: `kundeprosj`

This subroutine processes each customer project linked to the current customer:

- Uses `setll` and `reade` to fetch project records (`fkprl1`).

- Loads project details (`flkund`, `flkpro`, etc.) into variables.

- Searches for related texts (`rksol1`, `fkpsl1`) and sets description fields like `stek`.

- Writes the project info into the output file `bokpstr`.

- Repeats until all projects are processed.

---

# Subroutine: Initialization `*inzsr`

This subroutine prepares the environment, setting up key fields for lookups in various data files (e.g., customer, project, memo, status files). It:

- Sets key fields for customer lookup (`rkunl1_key`).

- Sets key fields for customer search text (`rksol1_key`).

- Sets keys for project, address, discount, customer category, special agreements, property links, memosaldo, and status files.

- Loads configuration values utilizing external programs and database calls.

---

# External Program Calls and Configuration

- **`CO402R`**: External program to retrieve system configuration values like extended memosaldo and credit limit extension.

- **`FO763R`**: External program used to calculate memo balance as of date (`mems`). Called conditionally if credit memo processing is enabled.

---

# Summary

This RPG program systematically extracts customer data, enriches it through lookups, calculates memo balances, and writes the compiled customer and project information to output files. It is highly configurable, leveraging external programs for system parameters, and carefully filters customers based on activity and status. The program structure emphasizes clarity with subroutines and logical flow control, making it easier for developers to understand and maintain.

