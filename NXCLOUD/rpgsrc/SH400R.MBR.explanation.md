# RPG Program SH400R - Inquiry on Invoice Register (with Parameters)

This RPG (Report Program Generator) program is designed for the IBM i platform (AS/400, iSeries, IBM i), for interactive workstation usage. The purpose is to inquire (search/view) invoices in the invoice register, based on user-entered parameters like year, order type, and supplier (leverandør). It also supports lookups ("spørring") for these keys.

Below is a thorough walkthrough, describing the program's main parts and logic for someone onboarding:

---

## 1. **Header and Meta Information**

- **/TITLE:** Describes the program. It is an inquiry over the invoice register, using parameters.
- **h spec:** Sets program-level options.
  - `datedit(*dmy)` – Dates used/displayed as day/month/year.
  - `option(*nodebugio)` – Disables debug for I/O operations.

- **Comment Block:** Documents version history, system info, and changes.

---

## 2. **File Declarations**

```rpg
fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fsh400d    cf   e             workstn
```

- **votyl1**: Logical file for order types, keyed. Renamed record format.
- **rlevl1**: Logical file for suppliers, keyed. Renamed record format.
- **sh400d**: Display file for the interactive workstation.

---

## 3. **Data Area and Variable Definitions**

- **l_firm**: Company code from the Local Data Area (LDA).
- **votyl1_otyp**: Variable for order type lookup key.
- **rlevl1_levr**: Variable for supplier lookup key.
- **b_feil**: Boolean; indicates when input validation fails.
- **w_dato**: Current date (ISO format date type).
- **w_dato_alf**: Date as 10-char string for display.
- **w_firm**: Company code for lookups, matches structure of `rlfirm`.

---

## 4. **Main Program Logic**

### **Initialization and Display**

```rpg
c                   time                    w_dato
c                   move      w_dato        w_dato_alf
c                   movel     w_dato_alf    b1aarr
```

- **Fetches current date** → stores in `w_dato`.
- **Converts date to alphanumeric** → `w_dato_alf`.
- **Moves part of `w_dato_alf` to display/input field `b1aarr`** (likely the year).

---

### **Main Input/Output Loop (Screen Handling)**

**Labelled Loop: b1taga**

1. **Display the main screen**:
    ```rpg
    c     b1taga        tag
    c                   exfmt     b1bld
    ```
   - `exfmt` – Write and read the display format `b1bld` (form input).

2. **Function Key Handling:**
    ```rpg
    c                   select
    c                   when      *inkc or *inkl  // Cancel/Exit
    c                   goto      avslutt
    c                   when      *inkd           // F4-Inquiry
    c                   exsr      spørring
    c                   goto      b1taga
    c                   endsl
    ```

   - **Exit**: If user presses keys (likely F3/F12), program exits.
   - **Inquiry**: If F4 is pressed, calls the *spørring* subroutine, then redisplays.

3. **Input Validation:**
    ```rpg
    c                   exsr      sjekk_input
    c                   if        b_feil = *on
    c                   goto      b1taga
    c                   endif
    ```

   - Calls subroutine to check input fields; if error, redisplays screen.

4. **Call to Child Inquiry Program:**

    ```rpg
    c                   call      'SH401R'
    c                   parm                    w_firm
    c                   parm                    b1aarr
    c                   parm                    b1otyp
    c                   parm                    b1ldor
    ```

   - If no error, call another program (`SH401R`) with firm, year, order type, and supplier code.

5. **Loop Back:**

    ```rpg
    c                   goto      b1taga
    ```

   - Returns to user input for next operation.

---

### **Exit Routine**

Label: `avslutt`

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```

- Sets LR ("last record", end job), and exits the program.

---

## 5. **Subroutines**

### a) **Spørring** (Inquiry Subroutine):

Handles F4 inquiries/lookups for order type or supplier.

```rpg
c     Spørring      begsr
   // Order type lookup
c                   if        wactfe = 'B1OTYP'
c                   call      'VA550R'
c                   parm                    w_firm
c                   parm                    b1otyp
c                   goto      end_spørr
c                   endif
   // Supplier lookup
c                   if        wactfe = 'B1LDOR'
c                   call      'RL500R'
c                   parm                    w_firm
c                   parm                    b1ldor
c                   parm                    b1navn
c                   goto      end_spørr
c                   endif
c     end_spørr     endsr
```

- `wactfe` is the name of the input field the user had focus on.
- If the field is order type, calls `VA550R` (order type lookup).
- If the field is supplier, calls `RL500R` (supplier lookup, also passing back name).

---

### b) **sjekk_input** (Input Validation Subroutine):

Performs field-level checks before processing.

1. **Year Validation (`b1aarr`):**
    ```rpg
    c                   if        b1aarr = 0
    c                   eval      *in31  = *on
    c                   eval      b_feil = *on
    c                   goto      end_sjekk
    c                   endif
    ```
    - If the year is zero, sets error indicator and skips further checks.

2. **Order Type Validation:**
    ```rpg
    c                   if        b1otyp <> *blank
    c                   eval      votyl1_otyp = b1otyp
    c     votyl1_key    chain     votyl1                             90
    c                   if        *in90
    c                   eval      *in32  = *on
    c                   eval      b_feil = *on
    c                   goto      end_sjekk
    c                   endif
    c                   endif
    ```
    - If order type is filled, does a keyed lookup (`chain`) in `votyl1` file. If not found (`*in90`), sets error.

3. **Supplier Validation:**
    ```rpg
    c                   if        b1ldor <> 0
    c                   eval      rlevl1_levr = b1ldor
    c     rlevl1_key    chain     rlevl1                             90
    c                   if        *in90
    c                   eval      *in33  = *on
    c                   eval      b_feil = *on
    c                   goto      end_sjekk
    c                   endif
    c                   eval      b1navn = rlnavn
    c                   endif
    ```
    - If supplier code is filled, keyed lookup in `rlevl1`. If not found, sets error. If found, sets supplier name.

---

### c) **Initialization Subroutine (\*INZSR):**

```rpg
c     *inzsr        begsr
   // Key lists for lookups
c     votyl1_key    klist
c                   kfld                    w_firm
c                   kfld                    votyl1_otyp
c     rlevl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rlevl1_levr
   // Set company code from LDA
c                   eval      w_firm = l_firm
c                   endsr
```

- Builds key lists for order type and supplier.
- Loads company code from LDA to variable.

---

## 6. **Summary of Control Flow**

1. On program start, current date and firm are initialized, and the user sees the inquiry screen.
2. User enters/selects year, order type, and supplier. F4 can be used for list/inquiry for valid values.
3. On submit, fields are validated, with errors flagged as needed.
4. If all inputs are valid, `SH401R` (further inquiry/listing program) is called.
5. After, user can start another inquiry or exit.

---

## 7. **Glossary & Notes**

- **b1aarr, b1otyp, b1ldor, b1navn:** Fields likely on the display file for year, order type, supplier code, and supplier name, respectively.
- **\*inkc, \*inkl, \*inkd:** Indicator variables for function keys.
- **chain:** RPG operation for keyed file access; sets indicator (e.g., 90) if not found.
- **parm:** Call parameter.
- **klist/kfld:** Key lists for chain/read operations.
- **LDA:** Local Data Area, a system data storage used for context like company code.

---

## 8. **Use Case**

This program is typically used by a clerk or accountant who needs to look up invoices based on parameters, ensuring values are valid and allowing convenient lookups for codes.

---

**In summary:**  
SH400R is a classic interactive RPG program facilitating validated, parameter-driven inquiries into an invoice register, with logic for input field validation, code lookups, and navigation to further inquiry programs. It is structured with clear separation of display, validation, lookup, and exit logic, following common IBM i application programming practices.