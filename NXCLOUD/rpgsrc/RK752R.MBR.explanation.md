# Program Overview

This RPG (Report Program Generator) source code implements a batch program for updating the "search text" (`soketekst`) for all customers (`kunder`) and companies (`firma`) in a system. The program collects and constructs a single searchable string from various customer and company attributes, writing this to a separate search text file.

The language in comments is Norwegian, and the code is written in traditional (fixed-format) RPG IV.

---

## Data Definitions and File Declarations

- **Physical Files:**
  - `rkunl1` (customer file, renamed from `rkunpfr`)
  - `rksolu` (search text file, renamed from `rksopfr`)
  - Both files are declared as external and keyed.

- **Variables:**
  - Key variables for both files.
  - Work variables for string operations (`w_l`, `w_leng`, `w_kund_alf`, `w_ftnr_alf`, `w_tlfn`, `w_mobn`).
  - Constants to aid in character translation for case normalization.

---

## Main Program Logic

### Processing Loop

```rpg
eval rkunl1_firm = 0
rkunl1_key setll rkunl1          // Set lower limit on the customer master file
read rkunl1                     // Read the first record
dow *in90 = *off                // Loop while not EOF
  exsr oppdater                 // Update search text for current customer
  read rkunl1                   // Read next customer
enddo
```

- Loop through all customer records.
- For each customer, call the `oppdater` subroutine to update the search text.
- Continues until end-of-file.

---

### Program End

```rpg
eval *inlr = *on  // End-of-job indicator: releases locks and closes files
return
```

---

## Subroutines

### `oppdater` – Update Search Text

**Purpose:** For the current customer, delete any existing search text and build a new search text string from name, address, phone, etc., and save it.

#### Steps:

1. **Delete Existing Search Text**
   - Build the search text key from company and customer number.
   - Chain (search) the search text file for an existing record.
   - If found, delete it.

2. **Build New Search Text**
   - Set company and customer numbers in the search text file.
   - Start with the "alfa" field (an alphabetic sort code).
   - Add trimmed and case-normalized (translated from lower to upper case) customer name, and, if present, address lines, post code location.
   - Phone and mobile numbers:
     - Remove all spaces for consistency.
     - Append these numbers to the search text.
   - Add the customer number (converted to an alphanumeric field).
   - If present, add the company registration number.
   - Write the newly built search text record.

#### Relevant Code Example for Phone Formatting:

```rpg
eval w_tlfn = %trim(rktlfn)
eval w_leng = %len(%trim(rktlfn))
' ' scan w_tlfn w_l
dow w_l <> 0 and w_l < w_leng
  eval w_tlfn = %subst(w_tlfn:1:w_l-1) + %subst(w_tlfn:w_l+1:11-w_l)
  eval w_tlfn = %trim(w_tlfn)
  eval w_leng = %len(%trim(w_tlfn))
  ' ' scan w_tlfn w_l
enddo
eval rkstek = %trimr(rkstek) + ' ' + %trim(w_tlfn)
```

---

### `*inzsr` – Initialization Subroutine

- Defines the key lists for use in keyed file operations.

---

## Notable Implementation Details

- **Translation Table (`xlate`):**
  - Converts from lower to upper case for search normalization.
- **String Concatenation and Trimming:**
  - Data fields are trimmed and concatenated with single spaces.
- **Handling Numeric Fields:**
  - Customer number and company registration number are converted to alphanumeric strings for inclusion in the search text.
- **Deletion and Insertion:**
  - The program deletes any existing search text before writing the new one to keep only the latest, synchronized version.

---

## Summary of Operation

For each customer record:
- Any existing search text is deleted.
- A new concatenated search text string is composed from various key attributes:
  - Alphabetic code
  - Name, address, and location (all normalized)
  - Phone numbers (with spaces removed)
  - Customer number and company registration number
- This new string is written to the search text file for fast, unified search capabilities.

---

## Change History (from comments)

- **R5.10**: Alphabetic field moved first in search text.
- **R5.20**: Added company registration number to search text.

---

## Onboarding Tips

- The program is designed to be run as a batch update.
- If new fields need to be added to the search text, they should be inserted in the `oppdater` subroutine.
- Be aware that string handling and translation are performed manually for normalization.
- Character set includes some Norwegian letters (“æøå”).
- Ensure all field definitions match the external files (`rkunl1`, `rksolu`).

---

**In summary:**  
This program updates the "search text" for every customer by collecting and normalizing key customer data fields, removing outdated entries, and saving concise, searchable records for quick lookup and retrieval in the system.