# RPG Program Explanation: SI611R – Purchase Statistics Report

This RPG (Report Program Generator) program is a classic ILE RPG application designed to generate a report of purchase statistics ("innkjøpsstatistikk"). The code handles selection criteria, reads multiple files, groups and sums data, and prints totals at various break points. Below, you will find a detailed explanation by section.

---

## 1. Overview and Purpose

- **Title**: The program is named "Utskrift av innkjøpsstatistikk" ("Printout of purchase statistics").
- **System/Program**: ASSTAT / SI611R.
- **Change Log**: The header comments document version changes and customizations, indicating maintenance and adaptation over multiple years.

---

## 2. File Declarations

The `F` specs declare the files used by the program:

- `slwwpf`, `slpml1` – Input files for selection and parameter control, keyed, disk files.
- Product, vendor, group, and category master files (`vvarl1`, `vvasl1`, `rlevl1`, `vahgl1`, etc.), most with `keyed` access and some with field renaming to match internal structures.
- Several other reference tables (`ra06pf`, `ra07pf`, etc.) for lookups.
- `si611p` – Output printer file, with overflow indication via *IN30.

**Note:** All files are classic fixed-format RPG declarations, structured for batch processing.

---

## 3. Data Structures and Working Variables

### Data Structures (`D` specs)

- **Tables/Arrays**
  - `rt` – A DIM(60) array for report texts (labels/descriptions), loaded from compile-time data.
- **Single Variables**
  - `w_uhgrp` – A 5-character field, e.g., for undergroup codes.
- **Data Structures**
  - `slpml1_key` – 15 chars, overlaid with:
    - `w1firm` (3), `w_type` (10), `w_kode` (2)
  - Similar overlays exist for grouping keys and for composite codes.
- **Group Totals**
  - Variables like `ant4`, `bru4`, `ra14`, etc., for keeping running totals at various group levels (4-7), along with percentage and ratio calculations (e.g., `pde4`).

---

## 4. Input Definitions (`I` specs)

- Read fields from control and parameter files (`slwwpfr`, `slpml1`), mapping input fields for selection, sorting keys, descriptions, and period/range specifications.

---

## 5. Main Program Logic (Calculation Specs, `C`)

### Initialization and Control

- `*inzsr` subroutine initializes variables, fetches parameter records based on type, sets up criteria flags, and prepares report headings.
- The `*entry` parameter controls which purchase statistics type is processed.

### Group Control and Summing

- Loops (`do`) for levels l6 (sort 1), l5 (sort 2), l4 (sort 3):
  - Resets accumulation variables.
  - Looks up and stores sort text headers via subroutine `raprut`.
- After looping, individual record values are summed into group accumulators.

### Group Breaks (Brudd)

- **CL4, CL5, CL6, CL7**: At group breaks, corresponding subroutines (`brdl4` etc.) are called to compute totals, print group summaries, and handle overflow/page breaks.

### Subroutines

#### `raprut` – Resolve Report Texts per Group

- Switches on the current `rap` (report type) and looks up texts/descriptions for the current group's value:
  - E.g., if `rap=11` (alt. hovedgruppe), uses keys to look up main group description.
  - For product (`rap=31`), looks up both product description and unit, falling back to alternate/special register or the statistics file if not found.

#### Group Break Subroutines (`brdl4`, `brdl5`, ...)

- Compute and store result values for each group break:
  - Net, gross, and cost values (`bru`, `ra`, `kst`),
  - Calculated ratios/percentages (`pde`, `pra`),
  - Transmission/discount amounts.
- Roll up the lower-level totals into the next higher level to be summed at the next break.

#### Overflow Handling

- Prints report headings when a page overflow is detected by writing `HD1A`.

---

## 6. Key Lists

Defined for keyed file access in the subroutines using the `chain` operation, ensuring the correct record is fetched based on the current context (e.g., by company, product, or group code).

---

## 7. Compile-time Array

- The last section contains the `RAPPORT TEKSTER` array, which holds the textual labels for sorting/grouping levels and for report columns (e.g., "Alt. hovedgruppe", "Leverandør", "Selger", "Periode").

---

## 8. Notable Algorithms & Controls

- **Grouping and Breaks**: Uses multi-level accumulators and explicit `do` loops for each grouping level (l4 through l7). At each group break, the code computes subtotals, percentages, and writes out group subtotals before clearing accumulators for the next group.
- **Dynamic Text Lookups**: The `raprut` subroutine abstracts the extraction of group/column names, enabling the report to adapt to different sorting or grouping configurations based on parameters in the control file.
- **Error and Not-Found Handling**: If a lookup returns not found (`*in50 = *on`), the code often proceeds silently, or uses fallback texts; this makes the program robust to missing master data.

---

## 9. Design and Typical Use

- **Usage**: Run in batch, likely called from a menu or scheduler, with selection criteria passed in, generates a formatted report by group/subgroup, with totals and calculated ratios at every level.
- **Customization**: Highly parameterized via the control records, making the reporting logic flexible for different aggregation views (product, vendor, group/category, etc.)

---

## 10. Key Points for Onboarding

- **Grouping & Sorting**: The program supports three major sorting/group levels, reflecting up to three levels of aggregation plus company (l4-l7).
- **Totals and Ratios**: After processing each record, values are aggregated into levels. At each break, subroutines do math for subtotals and percentages.
- **Dynamic Texts**: Column/row headings are looked up based on sort keys, making the report adaptive.
- **Data File Access**: Many master/data files are accessed for lookup, mostly in read-only fashion except the output printer file.

---

## 11. Typical Flow

1. Entry/initialization: parameters set, report headings written.
2. For each selected record, loop through l6 → l5 → l4 to do summing and setup.
3. At group breaks, call corresponding subroutine to compute/print totals.
4. At page overflow, write new headings.
5. Continue until all data processed, then end program.

---

## 12. Maintenance Considerations

- **Extending Grouping**: New group levels can be added by extending the `do`/brudd structure following the current pattern.
- **Adding Fields**: If new master fields needed, update `raprut`/lookup routines accordingly.
- **Internationalization**: The text labels array and parameter-driven text lookups make localization feasible.
- **Program Flow**: The code uses old-style fixed-format RPG (C/I specs), so modernization could involve refactoring to free-format RPGLE.

---

**Summary**:  
This program generates highly customizable, multi-level, subtotaled reports for purchase statistics by leveraging control files for selection, grouping and headings. Understanding its grouping, lookup, and subtotal mechanics is key to onboarding and modifying for additional requirements.