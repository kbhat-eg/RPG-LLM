# RPG Program Explanation: Customer Register Printout (`RK621R`)

This RPG program is built for IBM i (AS/400) and generates a printout of customer register information. It handles selection, filtering, and reporting of customers from a master file, based on a set of parameters and filters.

Below, you'll find a breakdown of the program's structure, logic, and important features. Comments in the source are preserved in Norwegian, but the explanation is in English.

---

## 1. **Program Overview & Header**

- **Title, System, and Description:**  
  The program title, description, and change history are provided at the top.
- **Indicators:**  
  Documentation for indicator usage is included—explaining which indicators are used for file I/O, subroutine work, error messages, etc.

---

## 2. **File Declarations**

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frkunl2    if   e           k disk    rename(rkunpfr:rkunl2r)
frk621p    o    e             printer oflind(*in30)
```
- **frkunl1 / frkunl2:** Input files over the same physical file but with different record formats based on how you want to read/sort (probably by customer number or name).
- **frk621p:** Output printer file, with overflow indicator linked to `*IN30`.

---

## 3. **Tables and Data Structures**

- **Array `f(30)`:**  
  A simple one-character array, purpose not visible in the snippet.

- **Date Data Structure (`w_tdat`):**  
  Overlaid fields to break apart a date value into year, month, and day.

  ```rpg
  d                 ds
  d w_tdat                         8  0
  d  w_taar                        4  0 overlay(w_tdat)
  d  w_tmnd                        2  0 overlay(w_tdat:5)
  d  w_tdag                        2  0 overlay(w_tdat:7)
  ```

- **ISO Date Variable:**  
  ```rpg
  d w_xdat          s             10d   datfmt(*iso)
  ```

- **/COPY QCPYLESRC,RPARRKDS:**  
  Pulls in external data definitions, likely of fields/parameters.

- **Working Fields:**  
  Various counters and totals for reporting (`wakjli`, `wdebli`, `wdsali`, etc.).

---

## 4. **Main Processing Loop**

### a) **Initialization**

- Control goes to the `*INZSR` subroutine for program setup (see further below).

### b) **Read Customer Register**

```rpg
c     lesk          tag
c                   if        psort = ' '                                           
c                   read      rkunl1                                 10                 
c                   else                                                                
c                   read      rkunl2                                 10                 
c                   endif                                                           
```
- Depending on sort parameter (`psort`), reads customer records by number (rkunl1) or alphabetically (rkunl2).
- EOF sets indicator `*IN10`; if set, exit loop (`goto slutt`).

### c) **Filtering Customers**

Multiple filters are applied to skip records not fitting the selected ranges:

- **Customer Number:**  
  `if rkkund < pknrf or rkkund > pknrt`
- **Department:**  
  `if rkavde < pavdf or rkavde > pavdt`
- **Category:**  
  `if rkkatg < pkatf or rkkatg > pkatt`
- **Sales Rep:**  
  `if rkslgr < pself or rkslgr > pselt`
- **District:**  
  `if rkdist < pdisf or rkdist > pdist`
- **Last Transaction Date:**  
  `if rktdat > pedat`

If any filter fails, flow jumps to `alle`.

### d) **Selected Customers Processing**

- **Counters and Sums:**  
  Totals for positive balances, negative balances, and purchases are accumulated.
- **Array Movement:**  
  Customer name (alphanumeric field) is moved into an array and back, possibly for sort or formatting.
- **Printing the Record:**  
  Depending on output type (`ptype`), calls subroutine `skrive` (single list) or `skrivt` (totals list), after prepping date fields.

### e) **All Customers Processing** (`alle` label)

- Accumulates "all customers" totals (regardless of earlier filters).
- Returns to read loop with `goto lesk`.

### f) **End of File (`slutt` label):**

- Sets LR (last record) indicator to end the program.
- Writes out final totals.

---

## 5. **Subroutines**

### a) **`skrive` (Write Customer Heading - Simple List)**

- Handles page overflow (check *IN30); writes page headers if needed.
- Writes the main customer line; writes address line if present.

### b) **`skrivt` (Write Customer Heading - Totals List)**

- Similar to `skrive`, but for totals formatting.
- Writes a different record layout for totals listings.

### c) **`*INZSR` (Initialization Subroutine)**

- Sets indicators based on input parameters (e.g., whether to show balance, account receivable, purchase statistics, etc.).
- Sets start values for keys and variables.
- Sets file position (using SETLL) based on sort order.
- Writes the report heading (with extra lines for additional filters, if used).
- Key-lists are defined for accessing/positioning the register (by customer number or alpha field).

---

## 6. **Indicators' Role**

The program uses RPG indicators for controlling print overflow, EOF, conditionals, and report logic. Example mappings:

- `*IN10`: End of file detected on read.
- `*IN30`: Print page overflow, triggers new page/headings.
- `*INLR`: Last record, ends the program.

---

## 7. **Parameter Handling**

Parameters like `psort`, `pknrf`, `pknrt`, etc., control which records are read and printed, as well as output format. These parameters are likely defined in the copybook (RPARRKDS) and populated before program execution.

---

## 8. **General Flow**

1. **Initialization:** Set up environment and print the heading.
2. **Main Loop:** Read customer records, filter them, accumulate statistics, print lines.
3. **Overflow Handling:** Check for page overflow, reprint headings as necessary.
4. **Totals Calculation:** Maintain separate totals for selected and all customers.
5. **Program End:** Write final total and exit.

---

## 9. **Printing/Formatting**

All output is to a printer file, with headings and data details structured for reports.

---

## 10. **External References**

- **/COPY QCPYLESRC,RPARRKDS**: Data structure or parameter field includes; critical for field definitions.

---

## 11. **Key Takeaways for New Developers**

- **The code is structured classically for RPG on IBM i.**
- **Main logic is in a read/filter/print loop, with totals and subtotals.**
- **Modifiers like ptype and psort drive both data selection and report formatting.**
- **Indicators are essential for controlling flow, record processing, and output handling.**
- **Parameters (from the copybook) need to be understood/controlled for proper operation.**
- **Subroutines manage both the output formatting and the initialization of the program and parameters.**

---

### For Onboarding

**Familiarity needed with:**
- Traditional ILE RPG structure and indicator usage.
- File declaration and record-level access (READ, SETLL, etc.).
- Data structures and overlays for date manipulation.
- The organization's naming conventions and parameter sources (/COPY).

**Step-in points:**
- Adjusting or adding new filters (see the filter checks).
- Modifying output formats (change subroutines or printer file layouts).
- Adding new parameters—ensure to update the copybook and all referencing code.

---

**In summary**, this is a robust, classic RPG report program that reads and filters a customer master file to produce detailed, parameter-driven printouts for accounting or sales purposes.