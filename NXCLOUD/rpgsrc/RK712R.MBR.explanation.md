# Program Overview

This RPG program, named `RK712R`, is written for IBM i (AS/400) in the ILE RPG (RPG IV/ILE RPG) language. It is designed to transfer accounting or invoice data (faktura, kunde, etc.) into a specific "Entra" format, by reading, transforming, and writing records between various files. The code is mostly written in fixed-format RPG IV, and contains both the mainline logic and subroutines for updating/inserting invoice and customer records.

---

## High-Level Structure

- **File Definitions:** Several physical files/tables are defined, both for reading input and writing output.
- **Data Structure Definitions:** Local data areas and various data structures overlaying buffers for formatting output records.
- **Variables:** Used as working variables for keys and temporary storage.
- **Main Program:** Loops to read input "transactions" and "customers", calling subroutines to format and write output records.
- **Subroutines:** For processing and formatting invoice lines (`xopd_fakt`) and customer table lines (`xopd_kund`), as well as for program initialization (`*inzsr`).
- **Program End:** Sets on *INLR indicator, ending the program.

---

## Detailed Breakdown

### Header Section

```rpg
h option(*nodebugio)
```
- Compiles with the `*NODEBUGIO` option for performance.

---

### File Declarations

```rpg
fraa9l1  if   e           k disk    rename(raa9pfr:raa9l1r)
frefal1  if   e           k disk    rename(refapfr:refal1r)
frekul1  if   e           k disk    rename(rekupfr:rekul1r)
fref2pf  uf a e             disk
frek2pf  uf a e             disk
```
- Defines input (`I`) and output (`U`) files. Some are renamed logical or physical files.
- Files for:
  - Company/Client master (`raa9l1`)
  - Customer transactions (`refal1`)
  - Customer register (`rekul1`)
  - Output files for invoice lines (`ref2pf`) and customer lines (`rek2pf`)

---

### Local Data Area (LDA) and Variables

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- Declares user and firm number from the User Data Structure (LDA).

```rpg
d w_sted          s             25
d w_klie          s              3  0
d w_firm          s                   like(rnfirm)
```
- Working variables for place name, client number, and firm number.

---

### Data Structures

#### Invoice/Transaction Line Structure

```rpg
d                 ds
d d_frec_1                     256
d  d_klie_1                      3  0 overlay(d_frec_1:1)
d  d_kund_1                     11  0 overlay(d_frec_1:4)
...
```
- Buffer for output invoice line record, overlays individual fields at specific offsets.

#### Customer Line Structure

```rpg
d                 ds
d d_krec_2                     256
d  d_kund_2                     11  0 overlay(d_krec_2:1)
...
```
- Buffer for output customer line record.

---

### Main Program Logic

#### Process Customer Transactions

```rpg
c                   read      refal1
c                   dow       not %eof
c                   exsr      xopd_fakt
c                   read      refal1
c                   enddo
```
- Reads all records from the `refal1` customer transactions file.
- For each, calls `xopd_fakt` subroutine to process/format and write an invoice line.

#### Process Customer Register

```rpg
c                   read      rekul1
c                   dow       not %eof
c                   exsr      xopd_kund
c                   read      rekul1
c                   enddo
```
- Reads all records from the `rekul1` customer file.
- For each, calls `xopd_kund` subroutine to process/format and write a customer line.

---

### End Program

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets LR (last record) indicator to end program execution and return to caller.

---

### Subroutine: xopd_fakt (Process Invoice Line)

```rpg
c     xopd_fakt     begsr
...
c                   endsr
```
- Maps transaction fields to output invoice record buffer.
- Sets currency (`d_valk_1 = 'NOK'`), resets reference (`d_fref_1 = 0`).
- If amount is negative, multiplies by -1 and sets code for negative amount (`d_bilk_1`).
- Formats date fields into yyyyMMdd numeric.
- Writes formatted record to `ref2pfr` file.

---

### Subroutine: xopd_kund (Process Customer Line)

```rpg
c     xopd_kund     begsr
...
c                   endsr
```
- Maps customer master fields to output customer record buffer.
- Sets various defaults (e.g., country is 'N  ' for Norway).
- Writes formatted customer record to `rek2pf`.

---

### Subroutine: *inzsr (Initialization)

```rpg
c     *inzsr        begsr
...
c                   endsr
```
- Builds keys for reading input files based on firm number.
- Fetches client number (`w_klie`) from company master (`raa9l1r`) via CHAIN.

---

## Key Points for New Developers

- **Overlay Structures:** Output records are built using buffer overlays; fields must be correctly aligned by offset/length.
- **File Handling:** Input files are read sequentially; output files are always written.
- **Initialization:** Keys and parameters are initialized from LDA and master files.
- **Business Logic:** Straightforward mapping and minimal transformation. Negative amounts are handled specially.
- **Indicators:** Traditional RPG indicators like EOF and *INLR are used for flow control.

---

## Summary

This program is an ETL (Extract, Transform, Load)-style process for invoice and customer data in an IBM i environment. It reads customer and transaction data, transforms these into a required flat-file format, and writes out the result. Subroutines are used for output line assembly, keeping the main logic clear. The code is typical for legacy RPG environments but is systematic and maintainable with clear mappings and subroutine usage.