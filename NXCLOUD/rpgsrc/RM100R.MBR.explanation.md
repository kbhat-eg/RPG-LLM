# Explanation of RPG Program `RM100R`

This RPG/400 (ILE RPG) program is for maintaining ('vedlikehold') records of "almenning" (commons/communal properties) and related master data. It's designed to be run on IBM i (AS/400) systems and operates primarily through subfile-based display screens, allowing CRUD (Create, Read, Update, Delete) operations via green-screen interfaces.

Below is a structured onboarding explanation for this code.

---

## 1. **Control and File Specifications**

### Header
```rpg
h option(*nodebugio) datedit(*dmy)
```
- No debug I/O, dates as day-month-year.

### Files
- **Database files** (all renamed from physical files for record format separation):
    - `ralml1`, `ralml2`, `ralmlr`, `ralmlu` (communal property master data)
    - `apospf` (postal codes/places)
- **Display file:**
    - `rm100d` (workstation device, contains subfile `b1sfl` and control records)
    - `infds(dspfbk)`: Feedback structure for display

---

## 2. **Variable & Data Structure Declarations**

- **LDA (Local Data Area):**
    - `l_user`: User ID
    - `l_firm`: Company number
    - `l_fnav`: Firm name
- **Display Feedback (INDS):**
    - `d_fcrn`: First cursor record number
- **Key variables** (for file positioning)
- **Subfile variables** (counters, page, SFL control)
- **Boolean flags** (operation in progress, changes needed, error state)
- **Constants:** e.g. `c_sfil`: subfile page size

---

## 3. **Indicator Usage**

The program makes extensive use of indicator variables (`*inxx`) for screen control, navigation, error signaling, and function keys.

Main indicators:
- `*inLR`: End of program
- `*in10`–`*in15`: Rollup/Rolldown, Subfile display
- `*in21`–`*in22`: Cursor home and placement
- `*in30`: Field protection/view only
- `*in31`–`*in79`: Error and state messages
- `*in80`–`*in99`: Working state

---

## 4. **Program Flow Overview**

The program uses a main tag-loop and select-case structure to handle screen navigation, function key processing, and subfile actions.

**Main Flow:**
1. **Initialization (`*inzsr`):**
    - Set up file keys, fetch LDA values, position DB, load first page of subfile.
2. **B2CTL Loop:**
    - Main screen with subfile displayed.
    - Processes function keys (F3=Exit, F5=Refresh, F6=Create, Page Up/Down, etc.).
3. **Subfile Handling:**
    - Reading, updating, creating, copying, deleting, and viewing records in subfile rows based on user selection.

---

## 5. **Key Subroutines**

### `forny` (Refresh Subfile)
- Refreshes the subfile, optionally repositions based on which part user is in ('Navn' = by name, default = by 'alme').
- Clears and repopulates the subfile.

### `posisjoner` (Position in subfile)
- Repositions the file cursor to a specific record based on supplied key (number or name).
- Resets selection fields and fills subfile.

### `subfile`
- Loops over rows in the subfile (based on user's selection), handling:
    - Change (2)
    - Copy (3)
    - Delete (4)
    - View (5)
    - Related property screens (6-9) via program calls.
- Calls display programs or performs actions as required.

### `xc1bld` (Create New Record Screen)
- Handles the create-add-record screen with validations.
- Prevents duplicate keys.

### `xc2bld` (Edit/View Record Screen)
- Handles viewing/editing screen (input and validation).
- Updates or inserts records as necessary.

### `xk1win` (Copy-Record Window)
- Handles the copy-record screen: input new key, validate, duplicate the record.

### `xd1win` (Delete-Record Window)
- Prompts and, if confirmed, deletes the specified record.

### `clr_subfile`, `crt_subfile`
- Clear and fill the display subfile with records from DB (according to current position).

### `bck_subfile`
- Page backward in the subfile (Page Up).

### `dsp_subfile`
- Handles direct display of subfile (with or without command screen).

---

## 6. **Key Data Flow / User Experience**

1. **Startup:**
    - LDA fetch ⇒ determines current company.
    - Database position ⇒ load first subfile page.
2. **Main Screen:**
    - Subfile shows entries. User can scroll, select, or position.
    - Function keys: Add, Change, Delete, Copy, View, Related info.
3. **Processing:**
    - Each user selection (via SFL select field) invokes appropriate subroutine.
    - Record actions are validated, and feedback is given via indicator-driven messages/screens.
4. **Exit:**
    - F3 or similar function key sets *INLR and returns control; end of program.

---

## 7. **Error Handling and Messages**

- Field-level validation: Blank/invalid data sets indicators for error message lines.
- Attempt to add duplicate record triggers info popup.
- All add/change screens have logic for repeated input as needed.

---

## 8. **Integration Points**

- Calls to other programs for expanded data maintenance:
    - `RM105R`, `RM110R`, `VB100R`, `RM103R`, and postal code lookup in `AP500R`.
- Data is keyed primarily on company (`firm`) and either `alme` (communal property number) or `navn` (name).

---

## 9. **Summary Table: Screens/Sections Handled**

| Subfile/Screen/Popup | Purpose                         | Subroutine         |
|----------------------|---------------------------------|--------------------|
| B1SFL + B2CTL        | Main multi-record subfile       | subfile, dsp_subfile|
| B2CMD                | Command keys popup              | N/A (Write only)   |
| C1BLD                | Add new record                  | xc1bld             |
| C2BLD                | Change/View record              | xc2bld             |
| C1MSG                | Duplicate key message           | xc1msg             |
| D1WIN                | Delete confirmation             | xd1win             |
| K1WIN                | Copy record                     | xk1win             |

---

## 10. **Getting Productive Fast**

- **Study the indicator usage** for subfile field control, error signaling, and navigation.
- **Refer to the display file (`rm100d`)** for the exact field and record layouts—these names (`b1sfl`, `b2ctl`, etc.) map directly to screens and screen fields.
- **Understand the DB file layouts**, especially the key fields and which fields are used for "position to" features.
- **Follow the tags and subroutine calls:** The program uses named tags (`tag`, `goto`) to manage flow instead of subprocedures/functions.
- **Debug by tracking subfile variables** (record numbers, page pointers), as subfile navigation is a frequent source of confusion.

---

## 11. **Comments and Documentation**

- The code is well-commented in Norwegian, especially for field/indicator usage and screen logic.
- Function key actions and their meanings are clearly annotated within the code.

---

## 12. **In Short**

This is a classic AS/400 subfile maintenance program using green-screen UI patterns for master data. Mastering its navigation and indicator interplay, plus the link between RPG source and display/screen layouts, will get new developers productive. The actual business logic is relatively standard for CRUD subfile programs but does assume knowledge of Norwegian business terminology and IBM i green-screen UI conventions.