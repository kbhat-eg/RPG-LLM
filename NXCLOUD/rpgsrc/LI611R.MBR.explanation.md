# Explanation of the RPG Program (LI611R) – EDI Packing Slip Output

This RPG program is for generating packing slips (Pakkseddel) for EDI (Electronic Data Interchange) orders. It supports both traditional spool file printing and a more modern XML/Jasper approach for generating PDFs and emailing.

Below, the core structure and logic are explained, split into the main components:

---

## 1. **Header Spec and File Declarations**

- **Header Specification (`H-specs`):**
  - `decedit('0.') datedit(*ymd-) option(*nodebugio)` – sets number and date formatting; disables debug I/O.
  - `DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')` – disables default activation group and binds to the CGIDEV2 binding directory.

- **/COPY Directives:**
  - `/copy hspecsbnd`, `/copy prototypeb`, `/copy usec` – includes additional specifications, prototypes, and utility code.

- **File Definitions (`F-specs`):**
  - Input files are defined (e.g., `afirl1`, `aforl1`, `lphoi1`, etc.) and renamed to local format names.
  - Output file: `li611p` is a printer file.

---

## 2. **Data Structures and Variables**

- **Parameter Data Structure (`d_prec`):**
  - Holds incoming parameters, such as company number, document type, message number, etc.
  - Uses overlays to map subfields onto a single 45-character area.

- **Local Data Area (LDA):**
  - Accesses global job data such as output queues, batch numbers, user, copy count, etc.

- **Key Variables:**
  - Used to build composite keys for database access (for header, package, package lines, partner info, etc.).

- **Work Variables:**
  - Used for temporary work storage, string handling, conversions, mail fields, XML file paths, etc.

- **Flags:**
  - `b_pdfp`: indicates PDF/XML (Jasper) processing is active.
  - `b_koli`: controls package processing within XML generation.

---

## 3. **Main Algorithm (C-Specs/Logic)**

### **A. Initial Data Retrieval**

- **Read EDI Message Header (`lphoi1`):**
  - Uses a composite key to locate the correct message.
  - If not found, jumps to program end.

- **Fetch and Assign Header Data:**
  - Dates, times, partner information (buyer, delivery, supplier) are fetched and assigned.

- **Write Report Heading:**
  - If not using PDF/XML (`b_pdfp = *off`), write heading directly to the report.
  - Otherwise, call subroutine to output XML tags for header fields.

### **B. Process Packages (Kolli)**

- **Loop Through Packages (`lpkoir`) for the Packing Slip:**
  - For each unique SSCC (Serial Shipping Container Code), set fields for k1hdr output (package header).
  - Output the package record to the report or XML, depending on mode.

- **Process Package Lines (`lpklir`):**
  - For each package, loop through individual items/lines.
  - Write item details to report or create corresponding XML.

---

### **C. Program Completion**

- **If in PDF/XML mode:**
  - Write out ending XML tags.
  - If previewing (screen view), trigger PDF viewing in a browser.
  - If archiving is selected, append extra tags for metadata and log to archive queue.

- **Set LR Indicator On** (`*INLR = *ON`): End job and release resources.

---

## 4. **Subroutines Overview**

### **A. `*inzsr` – Initialization**
- Parses entry parameters and sets up keys for file access.
- Reads routine/form data (`aforl1r`) for custom texts.
- Reads company data (`afirl1r`) for address info.
- Checks if Jasper/XML output is to be used (controlled by `l_poff` in LDA). If Jasper is required:
  - Sets up XML path, logo, and template locations.
  - Starts up CGI buffer for XML output.
  - Logs start of output.
  - Calls `xml_envm` to output initial environment section.

### **B. `xml_envm` – Environment Section for Jasper/XML**
- Writes header and printing configuration information to XML:
  - Batch number, user, credential info, report templates, print quality, and printer-related settings.
  - If not previewing or emailing, also sets up and verifies printer and queue, retrieves print drawer info, etc.

### **C. `xml_head` – Header Section for Jasper/XML**
- Retrieves and prepares mail information if emailing.
- Calls external programs to fetch and scan mail contents, build messages, and subject lines.
- Outputs mail sections and company/partner info to XML.
- Converts and outputs address fields, contact info, and meta information.

### **D. `xml_kol_head` – Package (Kolli) Section**
- For each package, writes package specifics to XML.

### **E. `xml_deta` – Package Line Details**
- For each package line, writes line-item (product) details to XML—including quantities and product codes.

### **F. `xml_end` – Finalize XML/Archiving**
- Writes closing tags to XML, archive information if required, and meta-data tags.
- Writes XML output file to the IFS.
- Optionally places the filename on a data queue for downstream processing.

### **G. `pdf_preview` – Launch PDF Browser Preview**
- Calls an external program to open the generated PDF in a browser window.

---

## 5. **External Calls and Dependencies**

- **Multiple External Programs are Called** for:
  - Logging (`AB705R`)
  - Retrieving mail/server info (`AM705C`, `FO798R`)
  - Printer settings/drawers (`AP611R`, `AP614R`)
  - Archive/queue handling (`AP629C`)
  - String scanning/conversion to XML-friendly/HTML (`AP613R`)
  - CGI (Jasper/XML) buffer management (`GetHTMLIFS`, `ClrHtmlBuffer`, `UpdHTMLVar`, `WrtSection`).

---

## 6. **Printing Modes: Classic Spool vs. Jasper/XML (PDF/Email)**

- **Classic (SCS) Spool Printing:**
  - Writes directly to a printer file using RPG output specs.

- **Jasper/XML Printing:**
  - Uses JasperReports with XML data:
    - Collects data, builds a structured XML file using HTMLVar and WrtSection subroutines.
    - Can generate PDF reports, archive them, and email them if needed.

  - The mode is determined at runtime, controlled via job variables and parameters.

---

## 7. **Important RPG/AS400 Features Used**

- **LDA (Local Data Area):** Used for job-wide parameter passing.
- **External Program Calls:** For modular business logic (printing, mail, logging, etc.).
- **Data Structure Overlays:** For parsing parameter strings.
- **File Renaming:** For separating input/output record formats.
- **Dynamic Output (CGIDEV2):** For generating dynamic XML or HTML content.

---

## 8. **Key Data Flow**

1. **Program Called – Parameters Received**
2. **Initialization:**
   - Interpret parameters, setup environment, load company/routine data.
3. **Main Processing:**
   - Retrieve message header.
   - Process each package and its lines.
   - Output data to either spool file or Jasper/XML buffer.
4. **Completion:**
   - Write footers, finalize output, trigger optional preview or queueing.
5. **Subroutines:**
   - Modularize environment setup, XML writing, mailing, etc.

---

## 9. **Comments and Documentation**

- **Change Log:** Maintained at the top, tracks changes and versioning.
- **Inline Comments:** Explain program intent, especially around newer features and business logic.

---

## 10. **Summary Table**

| Area         | Classic Output                  | Jasper/XML Output           |
|--------------|--------------------------------|-----------------------------|
| Document     | Printer file (spool)           | XML/HTML buffer             |
| Format       | Output spec (WRITE)            | HTMLVar + WrtSection calls  |
| Email        | N/A                            | Extract mail info, send     |
| Archiving    | N/A                            | Archive meta tags           |
| Preview      | Spoolfile only                 | PDF, launch in browser      |

---

## 11. **Onboarding Notes**

- **Familiarize with CGIDEV2 Functions:** (e.g., UpdHTMLVar, WrtSection)
- **Understand LDA and Parameter Handling:** Many switches are controlled this way.
- **External Calls:** Know what each external program does (documentation required).
- **Business Rules:** Custom logic per customer, order, print, or XML output.
- **Debugging:** The program disables direct debug I/O; log info can be found via joblogs or the archive log.

---

**In summary:**  
This is a robust, business-critical ILE RPG program for generating and distributing EDI packing slips, supporting both legacy output and modern integration patterns (XML/Jasper/PDF/Email/Archive), with extensive use of modular subroutines and external calls for flexibility and maintainability.