# RPG Program RA114R – Supplier Category Maintenance

This program (RA114R) provides an interactive maintenance facility for supplier categories, typically part of an IBM i (AS/400) application suite. The code is written in ILE RPG and uses display files (subfiles/screens) to provide users with options to list, create, view, change, copy, and delete supplier categories, with various controls and validations. Below, we break down the structure, logic, and key elements for developer onboarding.

---

## 1. **File and Data Structure**

### **Physical & Logical Files**
- `fra14l1`, `fra14l2`, `fra14lr`, `fra14lu`: Database files (or logical views) holding supplier category data with different access paths (by category code, description, etc.).
- These files are renamed in the program to provide different record formats for read/update.
- `fra114d`: Workstation display file, using a subfile (`B1SFL`). Handles screen interaction.

### **Indicators**
The program uses classic RPG indicators:
- LR: Last record, end program
- 10-15, 21, 22, 30, 31-99: Rollup/down, subfile display indicators, error indicators, working indicators, etc.

### **Key Data Area & Variables**
- **Local Data Area (LDA):** Receives user context such as user ID (`l_user`), company (`l_firm`), security/group info.
- Various variables are used for keys, fields, status flags, and working screens.

### **Constants**
- `c_sfil`: Number of rows per subfile page.

### **External Calls**
- The program calls several external programs for security checks, account selection (F4 lists), department picking, etc.

---

## 2. **Main Program Flow**

The program is structured around a main processing loop driven by user actions on a subfile (list) screen:

### **Initial Program Setup:**
- *Initialization routine* (`*inzsr`) sets keys, fills working variables from LDA, performs security checks, then populates the subfile (list screen) with supplier categories.

### **Screen Display and User Input Handling:**
#### **Main loop flow:**
1. **Display Subfile List (`b2cmd`, `b2ctl`, `b1sfl`)**
   - Display supplier category records using a subfile.
   - F-key actions are enabled: Create, View, Copy, Delete, Roll up/down, Position to, etc.

2. **Read and Handle Function Keys:**
   - F3/F12 (Exit/Cancel): End program
   - F5 (Refresh): Rebuild subfile
   - F6 (Create): Enter creation screen
   - Page Up/Down: Scroll the list (subfile)
   - Positioning fields: Jump to a specific code/description

3. **Subfile Row Handling:**
   - For each row, check if a function (edit/copy/delete/view) is selected.
   - Check user authorization before proceeding.
   - For each action:
     - **Edit:** Opens detail maintenance screen.
     - **Copy:** Prompts for a new key, validates uniqueness, then runs maintenance for new code.
     - **Delete:** Prompts for confirmation, then deletes the row.
     - **View:** Opens detail screen with fields protected (read-only).

4. **Positioning & Search:**
   - Handles direct positioning to a code or description using keys and resets/reloads the subfile.

---

## 3. **Subroutines (SRs)**

These are the main subroutines and their functions:

- **forny**: Refreshes the subfile, optionally repositioning.
- **posisjoner**: Positions the database cursor based on input (code/description), clears and builds subfile.
- **subfile**: Main handler for processing user selection/commands on the subfile records.
- **xc1bld**: Handles the "new category" entry screen (C1BLD), including validation and error messaging.
- **xc1msg**: Displays an info/warning screen if attempting to create a category that already exists.
- **xc2bld**: Handles the category maintenance/detail (add/change/view) screen (C2BLD), including validation, account/department lookups, and updates/inserts.
- **xd1win**: Handles the delete confirmation window and row deletion.
- **xk1win**: Handles the copy function, including validation to prevent overwrites of existing codes.
- **clr_subfile**: Clears subfile (removes all rows), resets pointers.
- **crt_subfile**: Fills the subfile (list) with supplier categories, using current positioning criteria.
- **bck_subfile**: Scrolls subfile back one page.
- **dsp_subfile**: Displays the subfile (could set SFLDSP/SFLDSPCTL as needed).

---

## 4. **Security and Authorization**

Security checks are performed at several levels:
- **Startup:** Check if the user is authorized for this routine (via external program `AD005R` and config from `CO402R`).
- **Function key and row selection:** For each sensitive action (change/copy/delete), check if the user has access before proceeding. Unauthorized users are blocked and shown an error or denied the action.

---

## 5. **Integration/Dependencies**

- **Account/Department/Kostnadsbærer (cost bearer) Validation:**  
  - Uses external programs (`RH500R`, `RA507R`, `RS740R`, `RA528R`) for F4 prompt and validation.
- **LDA (Local Data Area):** Used for passing context like user, company, etc., into the program.

---

## 6. **Error and Validation Handling**

- Uses screen indicators (31-37) to display specific error messages based on:
  - Blank required fields
  - Invalid or missing account/department/cost bearer
  - Account states (blocked, missing, required with department, etc.)
- Prevents duplicate creation with validation.

---

## 7. **Screen Structure (Display File)**

The display file (`fra114d`) has multiple record formats:
- `B1SFL`: Main subfile record (list of categories)
- `B2CTL`: Control record (subfile "header")
- `C1BLD`: Create new category screen
- `C2BLD`: Change/View category screen
- `D1WIN`: Delete confirmation window
- `K1WIN`: Copy category window

---

## 8. **Notable Source Comments & Change History**

- The file is well-annotated, including:
  - Change log at the top with versioning and features
  - Documentation of special indicators and usage
  - Field/variable explanations for subfile processing and screen states
  - Notes on customizations for external integration (GUI, security, etc.)

---

## 9. **Summary Table – Key Variables**

| Variable     | Purpose                                                             |
|--------------|---------------------------------------------------------------------|
| `w_srrn`     | Current relative record number in subfile                           |
| `w_spge`     | Subfile page size                                                   |
| `w_seqe`     | If blank, sort by code; if 'B', sort by description                 |
| `b1valg`     | Row action code: 2=edit, 3=copy, 4=delete, 5=view                   |
| `b_forn`     | Flag: refresh required                                              |
| `b_oppr`     | Flag: creating new entry                                            |
| `b_anul`     | Flag: cancel new entry                                              |
| `u_s701`     | Flag: Using version 7.01 security model                             |
| `l_user`     | User identifier from LDA                                            |
| `w_firm`     | Company                                                             |
| `ra14l1_nkod`| Key field for lookup by category code                               |
| `ra14l2_ntxt`| Key field for lookup by description                                 |

---

## 10. **Typical User Actions and Program Responses**

- **List:** See all supplier categories in a scrollable list (subfile).
- **Create (F6):** Enter a new category code, validate for duplicates, fill in details.
- **Edit:** Select a row (2), update fields, validates input, saves changes.
- **Copy:** Select a row (3), enter new code, validates uniqueness, copies details.
- **Delete:** Select a row (4), confirm delete, removes the record.
- **View:** Select a row (5), opens detail in protected (read-only) mode.
- **F4 Keys:** On relevant fields, brings up selection lists for account, department, cost bearer.
- **Refresh (F5):** Reloads subfile.
- **Position:** Jump to a code or description directly.

---

## 11. **Program Extensibility**

- **Adding new fields:** Update DB files and screens (DDS), map fields in RPG.
- **Business rules:** Add logic in screen-handling subroutines (`xc2bld`, etc.).
- **Security model:** Modify or extend security check calls.
- **Screen changes:** Edit display file (`fra114d`) and handle formats in code.

---

## 12. **Summary**

**RA114R** is a well-structured, function-key-driven, subfile-based RPG program for supplier category maintenance with robust validation, interactive UI, and layered security. The code uses classic RPG IV constructs with modern touches (free-form subroutines, external calls), making it maintainable yet compatible with legacy standards.

For onboarding:
- Understand the flow of subfile handling and function key processing.
- Review the display file to see how screens map to program logic.
- Familiarize yourself with indicator usage and the value of the LDA.
- Check dependencies (external programs) if making significant changes.
- Test changes with a range of user profiles to verify security/integration. 

**This design and code style is common for IBM i applications, and mastering this pattern will make you effective on this and similar programs.**