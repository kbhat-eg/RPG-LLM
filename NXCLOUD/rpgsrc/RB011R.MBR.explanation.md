# Explanation of the ILE RPG Program

This RPG (Report Program Generator) source code is a classic (fixed-format) ILE RPG (RPG IV) program designed to process and transform rows from an input file to a CSV-like output, with specific business logic regarding customer and invoice information.

Below is an explanation of the structure and flow of the program. This will help you onboard quickly and understand the logic:

---

## 1. Program Purpose

- **System:** ASOFAK  
- **Program:** RB011R  
- **Description:**  
  Reads records (lines) from file `FOVF` and formats them as comma-separated values (CSV-like), extracting and transforming customer information.  
- **History:**  
  There are multiple version comments describing functional changes (e.g., handling of company keys, suppressing addresses, formatting certain fields conditionally).

---

## 2. File Declarations

```rpg
ffovfl1    if   e           k disk
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frv01pf    o    e           k disk
```
- **fovfl1:** Input file (FOVF), keyed, external, disk file.
- **rkunl1:** Input file (RKUNPFR), renamed to `rkunl1r`, keyed. Holds customer master data.
- **rv01pf:** Output file, disk, creates output records.

---

## 3. Data Definitions

```rpg
d                uds
d l_firm                944    946  0
d w_kund          s                   like(rkkund)
d w_biln          s                   like(ffbiln)
d w_firm          s                   like(fffirm)
d rkunl1_kund     s                   like(rkkund)
d tell            s              1  0
d w_rkfaku        s              8
d w_rkfacn        s              8
```
- **l_firm:** Company number from the user data area (UDA), positions 944-946.
- **w_kund:** Work variable for customer number.
- **w_biln:** Work variable for voucher number.
- **w_firm:** Work variable for company number.
- **rkunl1_kund:** Work variable for customer number, used in lookups.
- **tell:** Counter to track first/heading row.
- **w_rkfaku / w_rkfacn:** Work variables for invoice and factoring numbers.

---

## 4. Main Processing Loop

### Initialization

- Sets `w_firm` to the value in `l_firm`.
- Sets up a key list (`klist`) for customer lookup (`rkunl1`).

### Main Loop (`nyles` tag)

1. **Read Next Record from fovfl1**  
   Skips to `slutt` if end of file (`*in60` is *ON).

2. **Company Filtering:**  
   If `l_firm` (user/company context) does not match `fffirm` (company on record), skip record.

3. **First Record:**  
   - On first record (`tell = 0`), prints header lines to output.
   - Output includes header, method, and field definition for the CSV.

4. **Find Address on First Entry:**  
   - If first record (`tell = 1`) and `ffbill = 0`, calls subroutine `finnadr` to build the address line for this voucher.
   - If not line 0 on first entry (not header row), skip.

5. **Check for Voucher Change:**  
   - If `ffbiln` (voucher) changes, update `w_biln`.

6. **If new voucher and line number is 0, call `finnadr`**  
   - Collects customer/address information for the voucher.

7. **Reads next record (loop).**

---

## 5. End of File Processing

At `slutt`:

- Writes a blank record.
- Writes an end marker (`@FIRM_END(279159)`).
- Sets `*INLR = *ON` (return control, close files).

---

## 6. Subroutine: `finnadr`

Purpose: Finds and writes customer/address information for a record.

1. **Determine Customer Number:**  
   If credit customer (`ffckto`) is not zero use it, else use direct customer (`ffdkto`).

2. **Lookup Customer:**  
   Reads (`chain`) appropriate customer record in `rkunl1`.

3. **Formats Output Row:**  
   Builds a quoted, space-separated list of fields:
   - Customer number, name, nickname, address, post number, post address, phone, private phone, fax
   - Invoice customer and factoring number (blank if zero)
   - Values are `trim`med or converted to character as appropriate.

4. **Writes Output Record.**

---

## 7. Special Business Logic

- For fields `rkfaku` and `rkfacn` (invoice customer, factoring number), if value is 0, blank is written instead of '0'.
- Only records with line number 0 are used to determine the customer/address info for each new voucher.
- Filtering by company number (`l_firm`), so output is for the active company only.
- CSV fields are quoted and space-separated (not strictly comma-separated).

---

## 8. Notable Techniques

- Uses data area to retrieve context (company, `l_firm`).
- RPG's classic control flow using labels (`tag`, `goto`).
- Output is constructed as space-separated, quoted string (not standard CSV).
- Uses `*inxx` indicators for file status and error handling.

---

## 9. What is Output?

- The output file (`rv01pf`) will contain:
    - Header/definition lines (`@IMPORT_METHOD`, `@ActoR(...)`).
    - Rows of customer/address information for each voucher (voucher = `ffbiln`) where line number is 0.
    - Trailer lines including `@FIRM_END(...)`.

---

## 10. Summary

This program extracts customer-related information for each voucher from a transactions file, looks up customer master data, and writes out a structured, quoted result for downstream (possibly Visma Business) processing. It demonstrates classic RPG record processing (with subroutines, indicator handling, and file lookups) and some data cleansing (setting blanks for invoice/factoring numbers if zero).

---

### To extend or maintain:

- **Add more fields?** Update the output construction in `finnadr`.
- **Change CSV delimiter?** Alter how `rvdata` is built.
- **Modify filtering?** Update or add more conditions in the main loop.
- **Migrate to /free?** Convert C-specs to free-format for improved readability.

---

**If you have specific questions or want a breakdown of a certain block, let me know!**