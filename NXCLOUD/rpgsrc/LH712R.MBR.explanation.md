# RPG Program LH712R - Code Explanation

## Purpose and Overview

This program, named *LH712R*, is designed to transfer purchase order proposals (bestillingsforslag) to orders (bestilling) in an IBM i/AS400 environment. It reads proposals, processes their lines, calculates purchase prices, manages inventory, updates related files (orders, inventory, suggestions), and integrates with related systems (campaigns, VAT, currencies, etc.).

The program is large and contains decades of historical enhancements, many listed in the modification log at the top.

---

## Key Data Structures & Files

### File Specifications (`F-Specs`)

- **lfdtl2, lfdtl1, lfhel1, lfhelu, ...**: Proposal detail/header and user files.
- **lohelu, lodtlu, ...**: Actual order header and detail files.
- **rlevl1, vvenlr, vvarl1, ...**: Suppliers, items, item variants.
- **fohel1, fodtl1, ...**: Sales order files (headers/lines).
- Other files for customer, VAT, etc.

All files are keyed (`k`) and most are externally described (`e`). Some are updated (`uf`).

---
### Input Parameters

The main input parameter is a 17-byte data structure split into:
- **d_fbes**: from-order/proposal number (8,0)
- **d_tbes**: to-order/proposal number (8,0)
- **d_sort**: sort indicator (1,0)

---

## Program Initialization (*INZSR Subroutine)

- Sets file keys for all major files.
- Assigns the input parameter to working fields.
- Stores current date and time.
- Checks if the user has access to the BM (Building Materials) module using program AX700R.
- Calls CO402R to check if campaign purchase prices should override standard.
- Initializes reading variables.

---

## Main Processing Loop

### 1. Check if order proposal is customer-based

- Reads proposal header (`lfhel1`) using the from-number.
- Sets `b_kord` if the proposal is from a customer order (header field `lhornr > 0`).

### 2. Gather Supplier and Pricing Information

- Runs `hent_ldor`: loads supplier details for VAT code (MVA).
- Runs `hent_prisgr`: fetches price group from supplier/item.

### 3. Assign New Order Number

- Runs `hent_ordrenr`, which calls external `AS100R` to fetch next available order number.

### 4. Read Proposal Details

- Reads lines from either `lfdtl1` or `lfdtl2` based on proposal type.
- For each line, checks:
  - Is it in the right company and within the proposal range?
  - If valid, and if a supplier or quantity is listed, or the line is a text line (`lfltyp='TX'`), processes it via `ordre_linje`.

### 5. Process Each Proposal Line (`ordre_linje`)

- Fetches item information, considering both regular and substitute (LVR) items.
- Calls external `VL710R` to enrich item logistics info.
- Prepares the order detail record:
  - Assigns type, item number, unit, groupings, campaign, GTIN, etc.
  - Calls `hent_inpri` to retrieve purchase price (potentially via campaign logic).
  - Converts price if supplier uses foreign currency (`valuta_pris`).
  - Sets quantity, discounts, sums, VAT code, etc.
- Writes the detail line to the order detail file (`lodtlu`).
- Optionally updates inventory (`oppd_lager`), order line with order numbers, and flags substitute items.

---

### 6. Write Order Header (`ordre_hode`)

- Gathers and updates header info:
  - Warehouse details, department, sales agent.
  - Address and project info, potentially pulled from sales order.
- Writes header to `lohelu`.
- If the origin is 'B' (Blueridge), inserts a record in `LOTIST`.
- Updates proposal with the generated order number.
- Calls `LO730R` to recalculate order values.
- If required, updates the related sales order head (with new purchase order number).

---

## Subroutines Overview

### - hent_ordrenr
  Assigns next free order number (calls *AS100R*).

### - hent_gtin
  Gets GTIN barcode for the item (calls *VE713R*).

### - hent_inpri
  Retrieves purchase unit and price, with detailed campaign and supplier logic (calls *VP751R* or *VP754R*).

### - hent_prisgr, sjek_kamp
  Fetch or check price group/campaigns for the item.

### - hent_lager, hent_logp
  Fetches warehouse/address info and logistics points (calls *FÃ˜720R*, *MJ500R*).

### - hent_levr, hent_ldor
  Gets supplier details.

### - hent_bruker
  Fetches user-specific references (from `fusrl1` or fallback).

### - hent_ordre, hntfad
  Retrieves order header or customer address for orders.

### - hent_orli, upd_orli
  Reads/updates order line with quantities and references.

### - oppd_lager
  Calls `VL001R` to update inventory movements.

### - hent_omr
  Calculates item conversion factors for units.

### - valuta_pris
  Converts price to supplier's currency using locked or daily exchange rates (uses SQL).

---

## Error Handling and Special Logic

- Handles missing files/records via RPG status indicators.
- Has many feature flags and conditional logic for campaign pricing, currencies, substitute items, etc.
- Implements backwards compatibility and historical fixes via extensive versioned comments.

---

## Extending and Maintaining

- The program is modularized into subroutines for ease of maintenance.
- Many enhancements are controlled by branching based on version markers.
- Easily extensible by adding new subroutines or expanding key file structures.

---

## Noteworthy Aspects

- **Heavy Reliance on External Programs:** Many business rules are pushed to subprograms.
- **Parameter Passing by Data Structures:** Consistent use of overlays and shared variable definitions for safety.
- **Audit and Traceability:** Timestamps and user IDs are set for all updates.
- **Internationalization:** Copes with different currencies, pricing rules, and language settings.
- **Backward Compatibility:** Preserves older logic with clear version annotations and conditional subroutine calls.
- **Robust Key Structure:** Well-organized key lists for each file, aiding both updates and reads.

---

## Summary of Flow

1. **Read proposal header (bestillingsforslag)**
2. **Assign order number**
3. **Loop through each proposal detail**
    - Prepare item info, calculate purchase price
    - Handle campaigns, supplier-specific logic
    - Write to order detail
    - Update inventory/order as needed
4. **After all lines, write order header**
5. **Update references in proposal and order**
6. **End program**

---

## For New Developers

- **Start** by tracing the main flow from *INZSR* through the proposal detail loop.
- **Focus** on understanding key subroutines (hent_inpri, ordre_linje, ordre_hode).
- **Note:** External programs (`CALL`) encapsulate core business logic.
- **Pay attention to version markers**. Features may be conditionally applied.
- **Use the file key lists** to understand how data is referenced and joined.

This program is central to the procurement/order process and needs careful change management, but is logically structured and well-annotated for onboarding.