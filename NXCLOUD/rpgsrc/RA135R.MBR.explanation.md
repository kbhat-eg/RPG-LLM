# RPG Program RA135R - Explanation

This RPG program, named RA135R, is designed for "Personroller, vedlikehold" (person roles, maintenance) in an IBM i (AS/400) environment. The program primarily manages CRUD operations (Create, Read, Update, Delete) of person roles through a subfile-driven workstation interface.

---

## 1. **File Declarations**

```rpg
frroliu    uf a e           k disk    rename(rrolst:rroliur)
frroli1    if   e           k disk    rename(rrolst:rroli1r)
frrolir    if   e           k disk    rename(rrolst:rrolirr)
fra135d    cf   e             workstn sfile(b1sfl:w_srrn)
                                        infds(dspfbk)
```
- **rroliu, rroli1, rrolir**: Logical file declarations, each with their own record format via the `rename` keyword, for different keyed access to the same or similar data (person roles).
- **ra135d**: Workstation file for the display, associated with a subfile (B1SFL) and a display feedback data structure (`dspfbk`).

---

## 2. **Key Data Structures and Variables**

**Local Data Area (LDA) Aliases:**
```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- These fields are mapped to specific byte positions in the LDA for retrieving current user, firm, and user name. Used for audit fields and filtering.

**Information Data Structure:**
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Used to get feedback from display operations (e.g., first record number displayed).

**Subfile Variables:**
Wide range of variables like `w_fcrn` (first record), `w_srrn` (relative record), `w_spge` (page size), etc., for managing subfile paging, cursor, and data.

---

## 3. **Indicator Usage**

```rpg
* LR = Avslutt program
* 10 = Roll
* 11 = Rolldown
* 12 = Sfldsp
* ...
```
- Standard RPG indicators control flow (e.g., end-program, roll up/down, subfile display, error messages, field protections).

---

## 4. **Main Control Logic**

The main logic is a "tag/goto" driven loop intertwined with subroutines for maintainability.

### **Entry Point and Command Display**

```rpg
c     b2taga        tag
c                   write     b2cmd
c     b2tagb        tag
c                   exsr      dsp_subfile
```
- Start by displaying the command screen and then the subfile.

### **Function Key Handling Loop**

```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inke
c                   exsr      forny
c                   goto      b2tagb
c                   ...
c                   when      *in10
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   ...
```
- Uses `select` to process function key presses:
  - `F3/F12` (exit/cancel) → end program.
  - `F5` (refresh) → refresh subfile.
  - `F6` (add new) → call new-entry routine.
  - Page up/down, home, etc., control subfile navigation.
- Control returns to the main tag as needed to refresh the display or repeat.

---

## 5. **Subroutines (EXSR)**

### **forny** (Renew Subfile)

- Refetches and redisplays subfile data. Handles repositioning based on the current record, clears and refills the subfile.

### **posisjoner** (Positioning)

- Sets the starting point for the subfile display, either by key or description. Prepares paging and clears input fields after repositioning.

### **subfile** (Process Subfile Changes)

- Processes the subfile records for editing, copying, deleting, or viewing. Uses subfile selection codes (2=Edit, 3=Copy, 4=Delete, 5=Display).
- Calls corresponding subroutines for each action.

### **xc1bld** (Create New Record Screen)

- Displays the entry screen for creating a new role.
- Validates if the role already exists and, if so, displays a message.
- If valid, proceeds to editing screen for entry.

### **xc2bld** (Edit/View Screen)

- Handles both editing and viewing of a single record.
- On submit, validates input, updates or creates records, and updates subfile data as needed.

### **xd1win** (Delete Window)

- Loads data for the deletion candidate, confirms user action, and deletes the record if confirmed.

### **xk1win** (Copy Window)

- Loads data from the source role, asks for new key, validates non-existence, and calls the edit routine to finalize the copy.

### **clr_subfile / crt_subfile / bck_subfile / dsp_subfile**

- `clr_subfile`: Clears the subfile for a fresh load.
- `crt_subfile`: Loads subfile records up to a page size.
- `bck_subfile`: Handles paging back in the subfile.
- `dsp_subfile`: Controls subfile display formatting and cursor management.

---

## 6. **Initialization**

```rpg
c     *inzsr        begsr
...
c                   eval      w_firm = l_firm
...
c                   exsr      crt_subfile
c                   endsr
```
- At program start:
  - Initializes file keys for positioning (KLISTs).
  - Loads firm from LDA for record filtering.
  - Sets up indicators and calls subfile build routine.

---

## 7. **Subfile Paging Variables & Conventions**

- Subfile operations rely on several variables to control which records are loaded/disputed/viewed.
- `w_fcrn`, `w_srrn`, `w_spge` are used for subfile paging.
- Constants like `c_sfil` define page size (e.g., 14 records per page).

---

## 8. **Screen Formats**

Describes multiple display formats used (subfile record, subfile control, command display, create/edit, copy, delete windows), each mapped to a specific part of the UI.

---

## 9. **Summary of Flow**

- Display the command/interface screen with a subfile list of roles.
- The user can add, edit, copy, delete, or view records via function keys or selection values.
- All UI operations are routed through tags and subroutines, with indicator bytes controlling UI conditions and errors.
- Paging, searching, and positioning are supported for efficient user navigation.

---

## 10. **Notes for New Developers**

- The code follows traditional fixed-format RPG with heavy use of subroutines instead of procedures.
- Subfile management is central; understanding how subfiles work on IBM i is key.
- The code is heavily indicator-driven by design, which is typical for this kind of RPG/400 program.
- Audit fields (user, firm, created/changed timestamps) are handled automatically on updates.
- Tags and gotos are used instead of structured loops—this is legacy RPG style.

---

**In summary**:  
This program is a classic "subfile maintenance" application, providing a list-based interface for user-defined roles with full CRUD operations and paging, built in traditional ILE RPG style for IBM i.