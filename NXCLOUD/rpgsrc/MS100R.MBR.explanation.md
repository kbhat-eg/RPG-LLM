# Overview

This RPG (Report Program Generator) ILE program is for the IBM i (AS/400) platform. It manages "cyclic counting" parameters, typically used in warehouse/inventory management to organize regular stock counts by ABC code and location ("lager"). The program uses both native record-level access and embedded SQL to retrieve and update counters and statistics.

Below is a breakdown to help developers understand the architecture, variables, and logic.

---

## **1. Header and Metadata**

- `h option(*nodebugio) datedit(*dmy)`: Sets program options. No debug I/O and date edit in DMY (day/month/year) format.
- The header comments provide:
    - System: ASLAGR
    - Program name: MS100R
    - Description: Cyclic counting parameter management
    - Change log and version information.

---

## **2. Files and Workstation Definitions**

**Physical and Logical Files:**

```rpg
fmstpl1    if   e           k disk    rename(mstppfr:mstpl1r)
fmstplr    if   e           k disk    rename(mstppfr:mstplrr)
fmstplu    uf a e           k disk    rename(mstppfr:mstplur)
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
flusrl1    if   e           k disk    rename(lusrpfr:lusrl1r)
```
- Defines files for reading and updating ABC parameters, item stock, and user info.

**Workstation:**
```rpg
fms100d    cf   e             workstn
```
- Defines a display file for interactive screens.

---

## **3. Data Areas and Data Structures**

**LDA (Local Data Area):**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Retrieves user info, firm, and navigation (likely from the user profile area).

**Display Feedback DS:**
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Holds feedback (e.g., cursor location) from the display.

---

## **4. Key Variables and Working Storage**

- Many variables are declared, generally suffixed by `af`, `ag`, etc., which seems to indicate amounts, groups, ABC classes, etc.
- `w_*` variables: working variables for counts by ABC code and group/subgroup.
- `s_*` variables: used for storing "snapshot" or "previous" values of critical fields, for comparison purposes (to detect changes).
- `c1*` variables: correspond to fields/controls on the "C1" screenâ€”main cyclic counting parameter screen.

---

## **5. Indicator Usage**

Comment block lists indicator usage, important in Classic RPG:
- *INLR*: End of program
- *IN10-IN15*: SFL (subfile) and page controls
- *IN21-IN22*: Home key, cursor placement
- *IN30*: Protect fields
- *IN31-IN79*: Warnings/errors
- *IN80-IN99*: Work indicators

---

## **6. Initialization (INZSR Subroutine)**

- Initializes various keys for chained access to files.
- Sets work variables based on LDA values.
- Initializes the screen, sets indicators.

---

## **7. Authorization (A1 Section)**

- Checks if user (from LDA) is authorized to manage cyclic counts for this warehouse (`lbtans < 2`).
- If not, shows warning (`a1win` window), and exits program.

---

## **8. Main Processing Block (B2CTL Section)**

- Displays the main cyclic counting administration screen (`c1bld`).
- Checks for function keys (exit, cancel, etc.).
- Calls subroutine to initialize fields (`init_felter`).
- Calls the subroutine to handle the main screen logic (`xc1bld`).

---

## **9. Screen Update Subroutine (XC1BLD)**

### Fetching Data
- Tries to fetch parameters for the given year/location.
- If found:
    - Populates display fields with file data.
    - Copies data into snapshot (`s_*`) variables for later change detection.
- If not found:
    - Initializes fields for new entry.

### Handling User Actions
- Display the main screen (`c1bld`).
- Handles function keys:
    - *KC/KL/30*: Exit or back.
    - *KD*: Calls `tel_stat` (statistic function) and reinitializes fields.
    - *KG* or *KI*: Calls other programs (likely display or edit details).
- On data changes, updates computed fields via `finn_ant_v_dd`.

### Data Update
- If any fields changed, updates or writes to file `mstplur`.
- Sets timestamps and user info.

---

## **10. Subroutines**

### `init_felter`
- Resets various counter fields by executing SQL SELECT COUNT statements to count records in the `vlagpf` file for each ABC code/group (AX, AY, AZ, etc.).
- Populates working variables of type `w_*` (e.g., `w_axaf`, `w_czaf`).
- Fetches sum of a specific field (`vlatel`) for statistics.
- Updates the respective `c1*` display fields with these counts.

### `finn_ant_v_dd`
- Calculates:
    - `w_tott`: Total number of items to be counted per year (sum of all product of counts and group counts).
    - Derives either number of counts per year (`c1antt`) or number of items per count (`c1antv`) depending on user input.
    - For each ABC code group, calculates items to count per session, ensuring at least 1 item if there are items/groups defined.
- Handles rounding and adjustment logic for uneven distributions.

### `tel_stat`
- Reads current active field (`w_afld`) to determine which ABC code is active.
- Performs a `CALL` to another program (`MS102R`) with location, ABC code, and group count as parameters, presumably to display or print more detailed statistics.

---

## **11. KLIST (Key List) Usage**

Defines key lists for chained access to the files. This pattern ensures the correct record is accessed for reading/updating.

---

## **12. Screen Handling**

- Uses SFL and window indicators for screen logic.
- Handles cursor management, field protection, error display, and subfile page management.

---

## **13. Embedded SQL**

- Used extensively in `init_felter` to retrieve live counts from the item file. SQL cursors are declared, opened, fetched, and closed for each category.
- SQL is used instead of native record-level access for aggregation operations (COUNT, SUM).

---

## **14. Flow Summary**

1. **Program start:** Initialize keys, read LDA, prepare the screen.
2. **Authorization check:** Make sure user can access the management function.
3. **Main Screen loop:** Show main counting admin screen, process user input, refresh counts from database.
4. **Updates:** On user changes, update parameter files.
5. **Calculate statistics:** When user requests, or when field data changes, compute new values using helper subroutines.
6. **Subprogram calls:** For detailed statistics, divert to other RPG programs as needed.
7. **Exit:** Gracefully exit.

---

# **Key Concepts to Understand**

- **Cyclic Counting:** Inventory control strategy dividing items into classes (A/B/C) and counting them at different intervals.
- **ABC Codes:** Categories for inventory items (e.g., AX, BX, etc.), each with their own cycle/group count logic.
- **KLIST/CHAIN Pattern:** Used for efficient, keyed record-level access in RPG.
- **Subfiles (SFL):** RPG pattern for displaying lists/pages on screens.
- **Embedded SQL in RPG:** Used for aggregate data fetching.
- **Snapshot Variables (`s_*`, `w_*`):** Used to detect changes, avoid unnecessary updates, and recalculate only when needed.

---

# **Get Started as a New Developer**

1. **Study the file layouts:** Understand the structures in `mstppfr`, `vlagpfr`, and `lusrpfr`.
2. **Understand the display file (`ms100d`):** See what fields map to the `c1*` RPG variables.
3. **Learn about subfile/screen handling in RPG.**
4. **Get familiar with the embedded SQL usage in RPG.**
5. **Trace the main loop:** From initialization, through authorization, to the main screen and user-driven updates.
6. **Note the use of subroutines for calculations and data refresh.**

---

# **References**

- IBM documentation on [ILE RPG](https://www.ibm.com/docs/en/i/7.4?topic=ile-rpg)
- [IBM i Database programming with RPG and SQL](https://www.ibm.com/docs/en/i/7.4?topic=sql-embedded-in-rpg)

---

*This summary should provide a solid foundation for onboarding any new developer to maintain and enhance this RPG program.*