# Program Overview

This RPG program, named `VG705R`, is a batch program for processing purchase order statistics and calculating the average cost price for items. It is intended to read transactions from the purchase statistics file, check various conditions on each transaction (such as valid item, warehouse, quantity, etc.), perform necessary calculations (including unit conversions, additional cost calculations, and validations), and update or insert records that reflect the new rolling average cost price for items in a specific warehouse.

The program also includes robust error handling and logging for transactions that do not meet the conditions for update, as well as subroutines for special functions like cost register reset and adjustment of received dates.

---

# Structure and Main Logic

## File Definitions

- Several logical files are defined for reading and updating various data sources (purchase stat temp, cost price update, item, warehouse, etc.).
- The `workstn` device is used for display file interaction (user input/output).

## Data Definitions

- **Local Data Area**: Used to fetch job/user parameters (such as user and company/firm number).
- **Cost Price Factors Data Structure (`d_frec`)**: Holds up to 5 cost add-on/deduction types, signs, factors, accounts, and targets.
- **Work Variables**: Many work variables are declared for quantities, amounts, dates, calculated values, and control switches.

## External Program Definitions

- **VG707R**: An external program is called for specific calculations/validations (like deviation control).

---

# Main Program Flow

1. **Initialization**
    - Some SQL options are set for date format and language.
    - The program enters the main input screen loop.

2. **Parameter Validation**
    - On screen input, the program checks for required values like start date and price code; if missing, error messages are shown and input is repeated.

3. **Special Function Handling**
    - If the "reset cost price register" or "adjust received date in statistics" flags are set through parameters, the corresponding subroutines are called.

4. **Processing Transactions**
    - The program walks through the records in the purchase statistics file from a given starting date.
    - It applies various filters:
        - Warehouse (include/exclude logic)
        - Order type (include/exclude logic)
        - Only non-direct deliveries
        - Only valid and warehouse items
        - Skips duplicates (already processed) by comparing keys.

5. **Sum/Calculate Quantities and Prices**
    - Uses subroutines (`sum_best`, `sum_hist`) with embedded SQL to sum ordered quantities and corresponding costs.
    - Converts prices to warehouse units as needed.

6. **Deviation Checks**
    - If there is a large deviation between purchase and warehouse quantities, a reason is logged, and the transaction is not updated.

7. **Average Cost Calculation**
    - Calculates new rolling average cost price for the item using current and previous inventory values.
    - Applies any cost add-ons/deductions.
    - Calls the external program for deviation validation.
    - If passes, updates/inserts the new cost price record and history.

8. **Error Logging**
    - Any transaction that encounters an error (e.g., zero or negative quantity, deviation too high, etc.) is logged to a separate table for further review.

9. **Looping**
    - Continues processing until all records are handled, then returns for new input or exits.

---

# Key Subroutines

## `oppd_kostpris` (Update Average Cost Price)

- Calculates the new average cost price using ordered and inventory quantities/costs.
- Applies cost factors (using subroutine `finn_kostt`).
- Performs deviation control via external program `VG707R` and internal logic.
- If everything is valid, updates the cost record (`vgkpiu`) and logs to history (`pris_hist` subroutine).

## `beregn_pris` (Calculate Price in Warehouse Unit)

- Converts prices and quantities from purchasing to warehouse units using conversion factors from a conversion table (`vvenlr`).

## `kost_kontroll` (Deviation Control)

- Calls external program `VG707R` to get permitted deviation percent.
- Attempts to find a calculated cost price from different sources (item/warehouse/supplier).
- Compares new cost price to calculated prices and checks if deviation exceeds allowed limits.

## `sum_best` and `sum_hist`

- SQL-based summing of order quantities and costs (`sum_best` for purchase, `sum_hist` for inventory history).

## `logg_feil` (Log Error)

- Logs failed transactions with detailed information to the error log table (`vgkest`), with different variable resets based on error code.

## `null_regi` and `oppd_stat`

- Special functions to reset cost price register or update missing info in purchase statistics.

## `finn_kostt` (Calculate Cost Add-ons/Deductions)

- For each possible cost price add-on, checks if present and adds or deducts the percentage value from the base cost price.

## `pris_hist` (Price History Management)

- Deletes previous current price record, then creates a history record unless one already exists for the given key/date/time.

---

# Technical Highlights

- **SQL Integration**: Many calculations and queries use embedded SQL (`/free EXEC SQL`, etc.) to fetch and update sums, cost prices, and perform inserts/delete.
- **Display File Handling**: The display file (`vg705d`) controls user input and messages.
- **Key Lists**: Several `klist` declarations manage multi-field keys for file operations.
- **Flexible Filters**: Inclusion/exclusion logic for warehouses and order types is managed by combing several flags and parameters.

---

# Error Handling and Logging

- Transactions that fail for business or data reasons (e.g., negative quantities, excessive deviation) are not updated but instead logged with detailed contextual info for analysis.
- Error codes guide which values are reset and what is logged.

---

# Customization and Special Cases

- The program is extensively customizable via its parameter screen, including which warehouses or order types to process, and options for register reset or date adjustment.
- There are also commented-out test blocks for debugging/filtering on specific items.

---

# Onboarding Notes

- The program is a core batch financial/statistics tool in the procurement and inventory domain.
- Understanding the business meaning of each file (e.g., `sisttmp`, `vgkpiu`, etc.) and the naming convention is crucial.
- The code uses both traditional fixed-format RPG (C specs, D specs) and free-form RPG (mainly in subroutines), so familiarity with both styles is recommended.
- Error and deviation control is robust: expect to review error logs to understand why some transactions were not processed.
- For changes, ensure you understand the key calculations in cost price update, unit conversion, and error/deviation logic.

---

# Summary of Program Purpose

**VG705R** processes purchase order transactions to update rolling average item cost prices, applying business rules for inclusion, deviation checking, cost add-ons, and handling errors with detailed logging. It is central to maintaining up-to-date and accurate cost price data for items in the inventory system.