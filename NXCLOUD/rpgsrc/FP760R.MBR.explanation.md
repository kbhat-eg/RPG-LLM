# RPG Program Explanation: `FP760R` (Special Price Import)

## Overview

This RPG program is designed for the IBM i (AS/400) platform, written in the classic ILE RPG (fixed format) style. Its main purpose is to import special prices for customers from a spreadsheet (likely in a semi-colon delimited format). The program:

- Deletes existing special prices for a customer before importing new ones (though the deletion logic was later commented out).
- Reads price records from a work file (`flvwpfr`).
- Validates and parses each record, extracting fields such as customer number, product number (NOBB), price, cost, date, etc.
- Checks the validity of various fields (customer, product, unit, delivery type).
- Updates or creates entries for special prices in the target price files (`fprilur` and related).
- Removes processed records from the work file.

The program is called via another program (`FP760C`).  
The file and field names, as well as much of the commentary, are in Norwegian.

---

## File Definitions (`F-Specs`)

- **flvwpfr**: Work file with price records to be imported (`uf`, user-opened, keyed, disk file).
- **rkunl1**: Customer master file.
- **vvarl1, vvarl3**: Product (item) master files. Only one (`vvarl1`) is actively used.
- **vvenl2**: Product sales unit file.
- **vltpl1**: Delivery type file.
- **fpril3, fprilur, fprnlur**: Special price files (header, lines, and notes).
- Several files are renamed to avoid naming conflicts.

---

## Data Definitions (`D-Specs`)

### Key Variables

- **l_user, l_firm**: User ID and firm number from *LDA (Local Data Area).
- **d_list / d_kund, d_nobb, ...**: Data structure (DS) representing a line from the input file, with overlays for each field (customer, NOBB, unit, price, etc.).
- **w_***: Work variables for various fields (price, cost, delivery type, etc.).
- **s_kund**: Stores the last processed customer, used in the (now commented) logic for deleting old prices.

---

## Main Logic

### Initialization

- The program starts by initializing `s_kund` to 0.

### Main Loop

1. **Read a record** from the work file (`flvwpfr`).
2. **Process Each Record**:
    - **Subroutine `utled_sdv`**: Parses the line into structured fields, validating formats and converting types.
    - **If no error is found (`b_feil` is off):**
      - **Subroutine `oppdater`**: Attempts to update/create special price entries using the parsed data.
    - Read the next record, repeat until EOF.

### Program End

- Sets the LR indicator (`*inlr = *on`) and returns.

---

## Subroutines

### 1. `utled_sdv` — Parse and Validate Input Record

- **Purpose**: Parses a line from the imported file (`fwirad`) into structured fields.
- **Parsing Logic**:
    - Uses `%scan` and `%subst` to split fields by semicolon (`;`).
    - Extracts and left-pads numeric fields (e.g., customer, project, NOBB) with zeros as needed.
    - Handles decimal values in prices (salgspris, kostpris) by separating whole and fractional parts, constructing a fixed-length numeric field.
    - Validates fields for numeric content using `check` and sets error flag (`b_feil`) if invalid.
    - Converts dates from DDMMYYYY to YYMMDD (or related formats).
    - Some fields (rabatt, ordrenr) are commented out in the latest version.
- **Result**: Populates `d_list` structure; if a critical error is found, sets `b_feil = *on`.

### 2. `oppdater` — Update or Add Special Price Entries

- **Purpose**: Updates or creates new entries in the special price files if input data is valid.
- **Major Steps**:
    - **Checks**:
        - Skips if customer or product (NOBB) number is missing.
        - Skips if both price and discount are zero.
        - Verifies customer exists (`rkunl1`).
        - Verifies product exists (`vvarl1`).
        - Verifies the unit from the record matches the product's base unit.
    - **(Now Commented Out)**: Deletes existing special prices for a new customer.
    - **Fetches Sales Units** for the product (up to three).
    - **Checks if Unit is Valid** for the product.
    - **Verifies Delivery Type** exists.
    - **Converts Prices** to all available units using conversion factors.
    - **Updates/Inserts 1-3 Special Price Records** (`fprilur`):
        - For each unit, attempts to `chain` (find) an existing record.
        - If found, updates the record.
        - If not found, creates a new one.
    - **Deletes the processed record** from the work file.

### 3. `konv_dato` — Date Conversion

- Converts date from character (probably `DDMMYYYY`) to numeric (`YYMMDD`) format used in files.
- Used by `utled_sdv` for `fra dato` (from date) and `til dato` (to date).

### 4. `*inzsr` — Initialization

- Builds key lists for file lookups (key fields for `klist`).
- Reads firm number from *LDA into `w_firm`.

---

## Special Notes

- **Error Handling**: The program aborts processing of lines with invalid or missing critical fields (customer, product, unit, price).
- **Deletion of Old Prices**: The logic to delete prices for a customer before importing new ones was removed (commented out) in version 9.05.
- **Extensibility**: There are several `*`-commented lines and versioning comments, reflecting the program's evolving requirements.
- **Field Parsing**: This is done manually via `%scan`, `%subst`, and string manipulation—typical for RPG programs dealing with delimited text.

---

## Summary of Flow

1. **Initialization** (`*inzsr`): Sets up keys and firm info.
2. **Loop through work file**:
    - Parse each line.
    - Validate and extract fields.
    - If valid, attempt to update/add special price records for up to three units for that product/customer.
    - Delete the processed line from the work file.
3. **End program**.

---

## Takeaways for Developers

- **Understand the Data Layout**: See how input lines are parsed into structured data; overlays are used for efficient field access.
- **File Interactions**: The program is heavily oriented around file I/O—both for reading existing customer/product info and for updating special prices.
- **Manual Text Parsing**: Due to RPG's age and the typical use of fixed-format files, parsing CSV/semicolon-separated data is verbose and careful.
- **Be Mindful of Version Comments**: Many changes over time are noted by version numbers in comments.
- **Error-Driven Processing**: The program skips lines with invalid data to keep the import robust.

---

## File Key Translations (Common Norwegian Field Names)

- **Kunde** = Customer
- **Vare** (NOBB) = Product (NOBB is a Norwegian product code)
- **Enhet** = Unit (of measure)
- **Salgspris** = Sales price
- **Kostpris** = Cost price
- **Leveringstype** = Delivery type
- **Kundeprosjekt** = Customer project
- **Rabatt** = Discount
- **Fra dato** = From date, **Til dato** = To date

---

## Onboarding Recommendations

- **Get familiar with the physical files / DB2 tables**: Many of the file definitions are crucial for understanding how data is validated, found, and stored.
- **Study the parsing logic**: Extending for new fields or formats would require updates in the `utled_sdv` subroutine.
- **Know the sequence of processing**: Always validate first, then update/create, then delete work file entry.
- **Changes to business rules (e.g., deletion of old prices)**: Check comments and logic for current requirements.

---

**If you need to adjust for new formats, fields, or validation rules, focus on the parsing (`utled_sdv`) and update (`oppdater`) subroutines. Most other structures (keys, calculations) are straightforward once you understand the files and their relationships.**