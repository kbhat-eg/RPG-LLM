# RF220R â€“ Card Register Maintenance Program

## Overview

**RF220R** is a maintenance program for the card register ("kortregister") in the ASOFAK system. It provides a subfile-driven, interactive interface for users to view, add, edit, and delete card records associated with customers and projects. The program is heavily integrated with the business logic for managing different card types, synchronizing with related modules (notably OFAK), and ensuring data integrity across related tables.

This documentation is targeted at experienced RPG developers onboarding to this codebase and aims to clarify the program's structure, business logic, and its conventions.

---

## Business Context

- **Card Register**: Stores cards issued to customers, linked to projects and card types.
- **Card Types**: Multiple types are supported (e.g., VISA Purchasing, Santander, BM Kort). Each type can have different handling rules.
- **Integration**: Card maintenance is synchronized with the OFAK module and, for certain operations, with the customer table for replication to POS (kassa).
- **GUI**: The program supports a subfile-based UI (DDS), with special handling for new GUI versions.

---

## File and Data Structure Usage

### Database Files

- **RUKRLx**: Main card register tables (different logical views: RUKRL1, RUKRLU, etc.).
- **RKUNLx / RKUNLU**: Customer master files (for lookup and update).
- **FKPRL1**: Customer project master (for project name lookup).
- **RUKSL1**: Card type master (for validity checks).

### Workstation File

- **RF220D**: DDS-based display file with subfiles for listing and editing cards.

### Data Areas & Structures

- **Local Data Area**: Used to get current user, firm, and other session data.
- **Display Feedback**: Used to track cursor position and other display attributes.

---

## Code Structure and Flow

### Main Loop

The program operates in a main loop, displaying a subfile of cards for a customer/project, and responding to user function keys for actions such as add, edit, delete, page up/down, etc.

#### Indicators

- **LR**: End of program.
- **10, 11**: Page up/down (Roll/Rolldown).
- **12-15**: Subfile display, clear, end.
- **21, 22**: Home/cursor positioning.
- **30, 36, 41**: Protect fields in various contexts.
- **31-79**: Error and warning indicators.
- **80-99**: Work indicators.

#### Subfile Handling

- **Subfile (B1SFL)**: Used for displaying and selecting cards.
- **Control Records (B2CTL, B2CMD)**: For subfile control and command entry.
- **Maintenance Screen (C2BLD)**: For add/edit/view of a single card.
- **Delete Confirmation (D1WIN)**: For confirming deletion.

---

## Key Business Logic

### Card Maintenance

- **Add/Edit/View**: 
  - Users can add, edit, or view cards via the C2BLD screen.
  - Fields are protected depending on context (view, edit, add).
  - Card type selection is assisted by a lookup window or a call to program `RA532R` for dynamic selection.
  - When adding, the next available sequence number (`ktsq`) is determined to avoid duplicates.

- **Delete**:
  - Deletion is confirmed with a separate screen.
  - Deletion also triggers a corresponding update in OFAK if the card type is among those that require it.

- **Validation**:
  - Mandatory fields (card type, card number, expiry, holder) are validated.
  - Card types must be valid (cross-checked in `RUKSL1`).
  - For some card types (e.g., Santander), certain fields (expiry, barcode) are hidden or set to zero.
  - Default expiry is set far in the future (e.g., 1229) if not provided.

- **Synchronization**:
  - Updates to the card register may trigger updates in the customer register (`RKUNLU`) to ensure the card is available in POS systems.
  - For certain card types, a call to `RK112C` is made to synchronize card data with OFAK.

### Subfile Paging

- **Page Up/Down**: 
  - Handled via indicators and subroutines (`crt_subfile`, `bck_subfile`).
  - Subfile is cleared and refilled as the user pages through records.

### Special Field Handling

- **Card/Agreement Type Text**: 
  - Subroutines `avt_tp_sh` and `avt_tp_fu` set the display text for card types in subfile and detail screens.
- **Key Lists**: 
  - Defined for efficient access and chaining to the various logical files, always including the firm as the leading key.

---

## Integration Points

- **OFAK Synchronization** (`RK112C`): 
  - Called on add, update, or delete for certain card types. Parameters include firm, customer, project, card type, sequence, and operation type (W/U/D).
- **Customer/Project Lookup**:
  - Calls to `FL501R` and direct access to `FKPRL1` and `RKUNL1/U` for name and address resolution.
- **Module Installation Check** (`AX700R`): 
  - At startup, checks if the card module is installed and disables the program if not.

---

## Notable Design Decisions and Conventions

- **Indicator Usage**: 
  - Strict, consistent usage of indicators for screen control, field protection, and error signaling.
- **Subfile Paging**: 
  - Manual management of subfile page boundaries and record numbers, including logic to handle partial pages and cursor positioning.
- **Hardcoded Card Types**: 
  - Card types and their display names are hardcoded in subroutines, but dynamic selection is also supported via external program calls.
- **Default Values**: 
  - Business-driven defaults (e.g., expiry date far in the future, hiding fields for certain card types).
- **Synchronized Audit Fields**: 
  - User and timestamp fields are maintained on both insert and update for auditing.
- **Backward Compatibility**: 
  - The code includes comments and logic for handling both legacy and new GUI versions.

---

## Relationships with Other Modules

- **OFAK**: Critical for synchronizing card information for certain card types.
- **Customer Table**: Updates ensure card availability in the POS system.
- **Project Table**: Used for resolving project names when displaying card details.

---

## Maintenance and Extensibility

- **Adding New Card Types**: 
  - Update hardcoded lists and ensure new types are handled in all relevant subroutines.
- **Changing Validation Rules**: 
  - Adjust business logic in the validation section of the `xc2bld` subroutine.
- **Integrating with New Modules**: 
  - Use the established pattern of parameter lists and indicator-controlled logic.

---

## Summary of Key Subroutines

- **forny**: Refreshes subfile display.
- **subfile**: Main subfile interaction handler (edit, delete, update).
- **clr_subfile**: Clears subfile records.
- **crt_subfile**: Fills subfile with the next page of records.
- **xc2bld**: Handles add/edit/view of a card, including validation and updating related tables.
- **bc2bld**: Initializes add/edit/view screen with default values.
- **bck_subfile**: Handles paging back in subfile.
- **dsp_subfile**: Handles display of the subfile control screen.
- **xf1win1/xf1nul**: Handles hardcoded card type selection window.
- **avt_tp_sh/avt_tp_fu**: Sets card/agreement type text for display.
- **finn_ktsq**: Finds the next available sequence number for a card.
- **xd1win**: Handles delete confirmation and processing.

---

## Special Notes

- **Field Names**: Many fields have Norwegian abbreviations; refer to the DDS or database documentation for exact meanings.
- **Error Handling**: Relies on indicators and specific subfile fields for user feedback.
- **Audit Trail**: User and timestamp fields are updated on each change for traceability.

---

## Conclusion

RF220R is a robust, business-critical maintenance program for card management, with complex validation, synchronization, and user interface logic. Understanding its subfile-driven workflow, integration points, and indicator conventions is essential for effective maintenance and extension of this codebase. For any changes, ensure that business rules, especially those relating to card type handling and synchronization with OFAK and POS systems, are thoroughly reviewed.