# RPG Program Xc070R - Explanation

This is an ILE RPG III (RPG/400) program with notes and logic related to subfile handling on IBM i (AS/400) systems. The program is likely used for maintenance and correction of transaction records within the Compello integration (a finance document management solution).

Below, you'll find a high-level onboarding guide and details of key sections.

---

## 1. General Structure and Purpose

- **System**: ASCOMP
- **Program**: Xc070R
- **Purpose**: Compello Integration â€” Adjustment of faulty transactions ("justering av feiltraner").
- **Main UI Paradigm**: Subfile-based display and editing of records.
- **Main Files**: `rcoml2` (ledger/transaction file), `rcomlr` (related detail file).
- **Screens/Displays**: Several, with B2CTL/B1SFL being the main subfile/control records.

---

## 2. File Declarations

```rpg
6.30 frcoml2    if   e           k disk    rename(rcompfr:rcoml2r)
   frcomlr    if   e           k disk    rename(rcompfr:rcomlrr)

fxc070d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **frcoml2/frcomlr**: Input files (likely physical files), renamed for local use.
- **fxc070d**: Display file, using the subfile `b1sfl` (using `w_srrn` as the relative record number). Also uses the `dspfbk` data structure to track display feedback (e.g., cursor position, error codes).

---

## 3. Data Structures

### Local Data Area (LDA) Fields

```rpg
d                uds
d l_user                911    920
d l_asp                 911    913
d l_fgrp                931    933
d l_firm                944    946
d l_fnav                951    980
```
- These fields retrieve values from the IBM i Local Data Area (LDA), such as current user, firm, group, and navigation strings.

### Display Feedback

```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- For extracting the first record number shown on the page from the display feedback (INFDS).

---

## 4. Key Variables

Many work variables:
- Subfile control: `w_stel, w_spge, w_srrn, w_sfrn, w_ssrn, w_last_biln`, etc.
- State flags: `b_oppr, b_forn, b_anul, b_feil` (all indicators for logic flow).
- Positioning, group, and firm logic: `w_fgrp, w_firm, s_fgrp, w_f10`, etc.

---

## 5. Indicator Usage

Comments explain indicator usage (classic RPG approach):
- **LR**: End program
- **10/11**: Rollup/Rolldown (next/previous page in subfile)
- **14/15**: SFLCLR/SFLEND (clear subfile, end of subfile)
- **21/22**: HOME key/cursor positioning
- **30**: Protect fields
- **31-79**: Messages
- **80-99**: Work/logic indicators

---

## 6. Main Program Flow

### Entry Point (Main Logic)

- Start with tag `b2taga` - send initial command screen (`b2cmd`).
- Tag `b2tagb` - calls subfile display.
- **Function key handling**: `select/when` logic block listens for various keys:
    - **F3/F12 (Exit/Cancel)**: `goto avslutt` (end)
    - **F5 (Refresh)**: `exsr forny`
    - **F10 (Next page)**: `exsr crt_subfile`
    - **F11 (Previous page)**: `exsr bck_subfile`
    - **Home**: Position cursor, redraw screen.

- **Positioning**: If a firm is entered, call `posisjoner` to position the subfile by firm.
- **Subfile processing**: Loop reads and acts on subfile records via subroutines.

### Program End

- Tag `avslutt` sets LR (`*inlr = *on`) and returns.

---

## 7. Core Subroutines

### forny (Refresh subfile)

- If a starting record is set, chains to that subfile entry.
- Calls logic to re-fill the subfile (`crt_subfile`) after clearing (`clr_subfile`).

### posisjoner (Position subfile by key)

- If a firm is entered in filter, sets keys for the recordset and positions at the correct entry.
- Clears and rebuilds subfile, resets filter fields.

### subfile (Process subfile records)

- Toggles indicator 22 (subfile position).
- Loops over each subfile record, checking for actions (`b1valg`) such as viewing detail.
- Calls `xc2bld` for extended detail display/edit if required.
- If a refresh is triggered, calls `forny`.

### xc2bld (Show detail for a record)

- Loads the selected record from `rcomlr`.
- Populates detail screen fields.
- Waits for user input; no update logic, but could be expanded.

### clr_subfile/crt_subfile (Clear/Create subfile)

- `clr_subfile`: Sets SFLCLR, writes empty control, resets subfile counters.
- `crt_subfile`: Advances page counters, reads records (via `read rcoml2`), and fills the subfile screen with records (with paging, filtering, and formatting).
- Handles field formatting, certain business rules, and sets indicators for alternating views or record identification.

### bck_subfile (Go back one subfile page)

- Handles page-back logic, sets the file position backward by one page.
- Clears and repopulates the subfile as appropriate.

### dsp_subfile (Display subfile)

- Based on whether subfile has records, displays appropriate format/control.
- Manages SFLDSP, SFLDSPCTL indicators.

---

## 8. Initialization (*inzsr)

- Declares key lists for chained access.
- Loads context (firm, year) from LDA.
- Sets sequencing mode (usually by key `'K'`).
- Disables error messages if ASP.
- Sets up initial key position.
- Creates the initial page in the subfile.

---

## 9. Special Notes & Business Logic

- **ASP Usage**: If the user is in ASP (Application Service Provider) mode, special visibility rules apply.
- **Key lists (`klist/kfld`)**: Used for positioning and reading by composite keys (firm, bilag/transaction number, etc.).
- **Field manipulation**: There are custom rules for displaying values, e.g., certain balances (`belo`) are formatted differently if certain conditions are met.

---

## 10. Subfile/Paging Concepts

- Subfile variables (`w_stel`, `w_srrn`, `w_spge`, etc.) are used to manage record position, paging, and display logic, in standard IBM i subfile style.

---

## 11. Comments and Labels

- The code is well-commented (in Norwegian) with explanations of indicator usage, screen images, field meanings, program changes, etc.
- Version changes (e.g. 6.30, T5.30) are marked for clarity.

---

## 12. Summary

**In essence:**  
The program is an interactive IBM i (AS/400) RPG application for handling and correcting financial transaction records, with subfile display, detail-view/edit, and navigation/paging features. It demonstrates many classic idioms for RPG subfile programming and interactive display file handling, as well as business-specific logic for filtering, positioning, and showing records.

---

**If onboarding a new developer:**  
Focus on the subfile logic (how records are read, displayed, and paged), how business keys and LDA drive positioning/visibility, and the interplay between function keys, indicators, and subroutines. The logic is modularized in subroutines, making it easier to trace each functional step. 

**Classic ILE-RPG knowledge, subfile programming, and display file (DSPF) familiarity are essential.**