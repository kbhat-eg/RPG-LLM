# Program Overview

This RPG program (VV501R) is an interactive inquiry program for handling inventory items (Norwegian: "Vare, spørring"), providing flexible search and selection capabilities for items by various keys (item number, supplier item number, NOBB number, text, groups, etc.). This version is specialized to not allow F8 (search in procurement register) as a parameter, as it's copied from another program (VV500R).

## Key Features

- Multiple search and positioning options for articles (items), groups, and text.
- Utilizes subfiles for displaying search results.
- Handles function keys for navigation, search, and selection.
- Integrates with several related programs via calls (e.g., for fetching item group, text, supplier info).
- SQL queries used for advanced search/filtering.
- Tracks group hierarchy: Overgroup (overgruppe), Main group (hovedgruppe), Sub-group (undergruppe).

---

# Detailed Explanation

## Header and Documentation

- The `H` spec sets up the program options: no debug I/O and DMY date editing.
- Extensive comments show change history, indicator usage, and screen field explanations.

---

## File Definitions

- The program uses multiple logical files (`F` specs) for reading item information, groupings, and status.
- The primary display file is `VV501D` configured as a workstation file with a subfile (`B1SFL`).

---

## Data Structure and Variable Definitions

- **Parameters**: `p_firm`, `p_vare`, `p_tek1` are passed in and represent the company, item, and description/text.
- **Display Feedback**: `dspfbk` holds information from the display station (like current record number).
- **Key Fields**: Separate variables for different keys (item, text, NOBB, supplier item, and various groupings).
- **Working Variables**: Many variables to keep track of screen state, current/first/last record, subfile page state, search terms, SQL cursor status, etc.

---

## Key Concepts and Data Flow

### Subfile Handling

- The program uses subfiles for viewing/searching items. Fields track which part of the subfile is being shown, how many records per page, etc.
- Shows, clears, fills, and navigates the subfile based on user actions and search/positioning logic.

### Group Search/Navigation

- Users can search by group hierarchy (overgruppe, hovedgruppe, undergruppe) and keyword (tekst).
- Dedicated keys and subroutines for:
  - Validating group combinations
  - Positioning within results (by item number, supplier item, NOBB, etc.)
  - Iterative group browsing using function keys.

### Function Key Handling

Indicators (`*INKC`, `*INKL`, etc.) and subroutines handle:

- F3/F12 to exit
- F5/F9/F23 and others for search repeat, group switches, and display updates
- F8 for special procurement register search (which is limited in this version)
- F10/F11 for page forward/backwards in the subfile

---

## High-level Main Loop

1. **Show Command Panel**: Show control record, get function key.
2. **If Data Entry**: Show subfile data.
3. **Handle Function Keys**: Branches depending on which function key is pressed:
   - Exit, Inquiry, Refresh, Roll Up/Down, Home, Positioning
   - Repeat Search (F9)
   - Specialized Group Position Switch (F23)
   - Navigation/Selection in subfile
4. **Subfile Row Selection**: If user selects a row, set output parameters and finish.

---

## Key Subroutines

### forny (Refresh Subfile)

- Repositions the database file pointer based on current sort/sequence.
- Clears and refills the subfile.

### s�k (Search)

- Validates group search fields.
- Calls external program to parse search text into up to 5 search tokens.
- Issues the appropriate SQL SELECT and populates the subfile.
- Clears search fields after processing.

### posisjoner (Positioning)

- Positions to a specific record in the subfile based on item number, text, NOBB number, or supplier item number.
- Clears/refreshes the subfile based on the chosen positioning.

### subfile (Handle Subfile Input)

- Reads subfile records using `readc`, checks for selection.
- Sets output parameters when the user has chosen a record.

### clr_subfile

- Clears the subfile, resets subfile-related variables.

### crt_subfile (Create/Fill Subfile)

- Determines which mode is active (group, search, item number, etc.).
- If a search is active, opens and processes the right SQL cursor.
- Reads records and fills subfile; for each, fetches additional info (e.g., type, group status via subprogram calls), and writes to the subfile.

### bck_subfile (Page Backwards)

- Handles "page up" by reading previous records and shifting the display accordingly.

### dsp_subfile (Display Subfile to User)

- Formats and displays the control record, sets subfile indicators for display.

### spørring (Group/Field Inquiry)

- Calls out to other inquiry programs for lookup of group information, sets group fields accordingly.

### sjekk_vsor (Check Assortment for Central/Period items)

- Checks if the current item is a central warehouse item or period-controlled by scanning related files.

### finn_logivar (Find Logistic Item for Correct Price Provider)

- Finds logistics information and flags indicators, based on `jvklpf` table.

---

## Initialization Routine (*inzsr)

- Receives initial parameters.
- Sets up keys for all (item, supplier, group, etc.) file access.
- Reads configuration/status tables.
- Gets today's date.
- Positions and fills the initial subfile for user display.

---

# User Interactions

- The user can search articles/items by different criteria and then select an item. The choice is returned in the program parameters.
- The subfile supports paging, search repeating, and jumping to specific item numbers/texts/groups.

---

# Special Notes

- Error/warning messages and screen indicators are managed by *INnn indicators as documented.
- The program is heavily modularized and interacts with multiple external subprograms for fetching additional info and validation.

---

# Summary

**VV501R** is an interactive inquiry program for selecting and searching inventory items with a flexible subfile interface and rich search and navigation options. It supports multiple search keys, uses SQL for some searches, interacts with many related programs/files, and is well-structured around IBM i subfile best practices and Norwegian retail/wholesale concepts. 

If you are onboarding: Focus on understanding the subfile design, the indicator controls, the group/item key structure, and the flow of function key handling and subroutine dispatch. Most business logic is encapsulated in external subprograms, so you may need to review those for details on group, assortment, and logistic item handling.