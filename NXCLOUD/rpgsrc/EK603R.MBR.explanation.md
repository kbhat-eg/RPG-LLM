# RPG Program EK603R – Explanation

This RPG program (EK603R) is a report generator for “Betalingsbonus - kvitteringsliste” (Payment Bonus – Receipt List). It reads data from several database files, processes bonuses per customer, and generates a printer report.

---

## **Header Specifications**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: No debug for database or display I/O.
- `datedit(*dmy)`: Date fields use day/month/year format.

---

## **File Declarations**

```rpg
fekbti2    if   e           k disk    rename(ekbtst:ekbti2r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
fvbotl1    if   e           k disk    rename(vbotpfr:vbotl1r)
fek603p    o    e             printer oflind(*in30)
```
- **Input physical files:**
  - `ekbti2` (EKBTST): Bonus calculation file (renamed for use in this program).
  - `rkunl1` (RKUNPFR): Customer master file.
  - `vbotl1` (VBOTPFR): Bonus type description file.

- **Output printer file:**
  - `ek603p`: Printer output, signals overflow in indicator `*IN30`.

---

## **Data Structure and Variable Definitions**

### **Parameters**

Used for controlling program flow and data selection.
```rpg
d p_pfir          s              3       // Company code (firm)
d p_paar          s              4       // Year (år)
d p_tbot          s              2       // Bonus type
d w_tbot          s              2
d b_bonu          s              1    inz(*off) // Bonus switch
```

### **Key Fields for Lookups**

```rpg
d ekbti2_tbot     s                   like(ektbot)
d rkunl1_kund     s                   like(rkkund)
d vbotl1_tbot     s                   like(vatbot)
```

### **Other Working Variables**

```rpg
d w_firm          s                   like(ektfir)
d w_kund          s              6  0
d w_bgrl          s             11  2
d w_aar           s              4  0
```

### **Parameter Passing Fields**

```rpg
d                uds
```
*(UDS: Unnamed Data Structure, sometimes used for parameter lists.)*

### **Fields for Report Output**

```rpg
d pabon                 330    330   // List option (J/N)
d l_wsid                901    910   // User ID
d l_user                911    920
d l_firm                944    946  0// Firm (company code)
d l_fnav                951    980   // Name
```

---

## **Main Logic**

### **Beginning of Mainline**

```rpg
c                   eval      b_bonu = *off
c                   eval      a1aarr = p_paar
c                   write     a1hdr
```
- Resets bonus flag, sets the year to print, writes the report heading.

```rpg
c                   eval      t1subg = 0
c***                eval      t1subn = 0
c                   exsr      kal_kund
```
- Initializes subtotal.
- Calls `kal_kund` subroutine (process all relevant customers).

```rpg
c                   if        b_bonu = *on
c                   write     t1tot
c                   endif
```
- If any bonus was processed, prints total line.

```rpg
c                   eval      *inlr = *on
c                   return
```
- Ends the program and releases resources.

---

## **Subroutines**

### **kal_kund – Process Customers with Bonus Type**

- Resets local fields.
- Fetches bonus type text.
- Loops through bonus entries for the selected bonus type and company/year.
- For each entry, if the customer changes, fetches the customer text (`finn_ktext`).
- Writes detail lines.
- Updates subtotal and triggers page overflow handling if necessary.

### **finn_ktext – Fetch Customer Information**

- Gets customer number from record.
- Chains to the customer master file to retrieve and move the customer name into output fields.

### **finn_btext – Fetch Bonus Type Description**

- Gets bonus type from parameter.
- Chains to the bonus type file and retrieves description to be printed.

### **xovrfl – Page Overflow Handler**

- If overflow indicator is set, writes report header and resets overflow.

---

## **Initialization Subroutine (`*inzsr`)**

- Entry point for parameters: Firm, Year, Bonus Type.
- Sets up key lists for file lookups.
- Assigns firm code from the input area.

---

## **Key Lists**

Used for CHAIN or SETLL/READE statements:

- `rkunl1_key`: Company + Customer
- `vbotl1_key`: Company + Bonus Type
- `ekbti2_key`: Company + Bonus Type

---

## **Report Generation Flow**

1. **Init**: Receives firm, year, and bonus type parameters.
2. **Header**: Prints report heading.
3. **Process**: Loops through all bonuses of the selected type (`kal_kund`).
4. **Details**: For each bonus:
    - Finds customer name and bonus description.
    - Writes detail line to output.
    - Handles page overflow.
5. **Totals**: If any bonuses were found, prints totals.
6. **End**: Cleans up and finishes.

---

## **General Notes & Conventions**

- **Indicator *IN30**: Used for page overflow.
- * Scandinavian variable/field names (Kund=Customer, Bgrl=Bonusgrunnlag, Btyp=Bonustype, etc).
- * Many fields are referenced from externally described database files.

---

## **Summary**

- This program is designed to print a report of all bonuses of a certain type for a particular company and year, grouped by customer.
- It reads records from a summary bonus file (`ekbti2`), looks up customer and bonus descriptions, and produces a nicely formatted printer report.
- Modularization is implemented via subroutines for customer lookup, bonus description, and page overflow handling.

---
This high-level overview should help you quickly understand the program’s purpose and structure, and where to dig deeper for modification or troubleshooting.