# Documentation for Program VV606R (ASOFAK)

## Overview

**VV606R** is a report program for printing warehouse (lager) information about items (varer). It is part of the ASOFAK system. The program reads item master and inventory records, applies selection and sorting criteria, retrieves supplementary data (such as item type and pricing), and generates a formatted report via a printer file.

The programâ€™s design is modular, with clear separation between initialization, header printing, data processing, and detail line output. It interacts with several external programs and files for master data and pricing logic.

---

## Business/Domain Context

- **Primary Function:** Print detailed inventory information for items, including grouping, supplier, stock levels, and pricing.
- **Intended Users:** Warehouse management, inventory control, and business analysts.
- **Selection and Sorting:** The report can be filtered and sorted by item group, supplier, item description, or item number, based on parameters.

---

## File Usage

- **vvawpf**: Item master file (primary input, keyed read).
- **afirl1**: Company master file (for company name, etc.), renamed from `afirpfr`.
- **vvlel1**: (From v6.30) Lumber assortment master, renamed from `vvlepfr` (used for extended item information).
- **vv606p**: Printer file for report output.

---

## Parameters and Data Structures

### Parameter List (`p_list`)

- 80-byte parameter passed at program start, mapped to `d_list` data structure.
- Contains company, group, supplier, level, item number ranges, decimal precision, print/sort options, etc.
- Overlaid subfields (`d_firm`, `d_fogr`, etc.) provide named access to individual parameters.

### Local Data Area

- `l_wsid`, `l_user`: Workstation and user ID, used for audit/report header.
- `l_lagr`: Warehouse number.

### Working Variables

- `w_firm`: Company code.
- `w_lage`: Warehouse code (from local data area).
- `w_vtyp`: Item type (S = procurement, D = miscellaneous, T = service, etc.).
- `w_udat`, `w_pdat`: Date fields for current and pricing dates.
- Other fields for price group, extended item info, and temporary calculation.

---

## Program Structure

### Initialization (`*inzsr`)

- Receives parameter list and maps it into the `d_list` data structure.
- Extracts company code and warehouse from parameters.
- Sets up company key for later lookups.
- Retrieves current date.

### Mainline

1. **Print Header (`hode` subroutine):**
   - Populates header fields with company, user, workstation, and timestamp.
   - Retrieves company name from `afirl1`.
   - Copies filter/sort parameters to report fields.
   - Decodes sorting options into a human-readable string.
   - Writes header lines to the printer file.

2. **Process Items (`behandling` subroutine):**
   - Reads through `vvawpf` (item master) sequentially.
   - For each item:
     - Calls external program `VL710R` to fetch item type and extended information.
     - Skips items of type S, D, or T (procurement, miscellaneous, services).
     - Calls `detalj` subroutine for output.

3. **Print Detail Line (`detalj` subroutine):**
   - Maps item master fields to print fields.
   - Calls external program `VP702R` to fetch pricing information.
   - Sets price date if available.
   - Writes detail line to printer file.
   - Calls `overflow` to handle page breaks.

4. **Overflow Handling (`overflow` subroutine):**
   - On overflow indicator, reprints headers.

5. **Program End:**
   - Sets LR indicator and returns.

---

## External Program Calls

- **VL710R**: Retrieves item type and extended item information.
  - Parameters: company, item number, warehouse, returns item type, update date, last order date, and extended fields (NOBB, model number, etc.).
  - Used to enrich the item data and apply business logic (skipping certain item types).

- **VP702R**: Retrieves pricing information for an item.
  - Parameters: company, item number, unit, price group, date, and returns sales/purchase prices, cost/invoice prices, price date, and conversion rate.
  - Used to fill pricing fields in the report.

---

## Notable Design Patterns and Conventions

- **Parameter Overlay:** The use of an 80-byte parameter area overlaid with subfields allows flexible passing of complex selection criteria.
- **Modular Subroutines:** The program is organized into well-defined subroutines for header, processing, detail, overflow, and initialization.
- **Externalization of Business Logic:** Key business logic (item type determination, pricing) is delegated to external programs (`VL710R`, `VP702R`), promoting reuse and separation of concerns.
- **Selection/Sorting Decoding:** Sorting options are decoded from numeric parameters to descriptive strings for report clarity.
- **Skip Logic:** Items of certain types are explicitly skipped, reflecting business rules about which items are relevant for this report.

---

## Interactions with Other Modules

- **Item Master (`vvawpf`)**: Central to report, provides base item data.
- **Company Master (`afirl1`)**: For company name in header.
- **Lumber Assortment (`vvlel1`)**: (v6.30+) For extended item info (not detailed in this snippet, but prepared for).
- **Printer File (`vv606p`)**: Output destination, with multiple record formats for headers and details.
- **External Programs**: As above, for item and pricing logic.

---

## Business/Domain-Specific Logic

- **Item Filtering:** Only standard items are included; procurement, miscellaneous, and service items are skipped based on type returned from `VL710R`.
- **Flexible Sorting:** Up to four sorting levels can be specified via parameters, affecting report grouping and presentation.
- **Dynamic Pricing:** Pricing is dynamically retrieved per item and may be based on current or specific dates.
- **Localization:** Date formatting (`*dmy`), field names, and comments indicate Norwegian localization and business terms.

---

## Maintenance Notes

- **Version History:** Comments document significant changes, especially regarding price group expansion (from 1 to 2 positions), inclusion of lumber assortment, and extended item information.
- **Parameter Changes:** All references to price group are externally defined, so changes in field length/types are managed outside this program.
- **Data Structure Expansion:** The program is prepared to handle new fields and logic as business requirements evolve (e.g., new item types, more granular pricing).

---

## Summary Table: Key Relationships

| Component      | Purpose/Role                        | Notes/Interactions                   |
|----------------|-------------------------------------|--------------------------------------|
| vvawpf         | Item master (input)                 | Read sequentially                    |
| afirl1         | Company master (input)              | Used for header/company name         |
| vvlel1         | Lumber assortment (input)           | Extended item info (v6.30+)          |
| vv606p         | Printer file (output)               | Multi-format: headers, details       |
| VL710R         | Item type logic (external program)  | Skips items by type                  |
| VP702R         | Pricing logic (external program)    | Populates pricing fields             |
| Parameter list | Selection/sort/filter configuration | Overlaid structure for flexibility   |

---

## Key Business Rules

- Only items of standard type are included in the report.
- Sorting/grouping is highly configurable via parameters.
- Pricing and extended item info are always current, retrieved via external programs.
- Report header and detail lines are dynamically constructed based on input and retrieved data.

---

## Recommendations for New Developers

- Familiarize yourself with the parameter overlay technique and how selection/sorting parameters are passed and decoded.
- Understand the external programs (`VL710R`, `VP702R`) as they encapsulate core business logic.
- When modifying or extending this program, ensure that new fields or logic are compatible with the existing modular subroutine structure.
- Coordinate with data owners if expanding parameter lists or adding new selection/sorting options.

---

## Change Log (Extract)

- **5.70:** Price group/item type from warehouse introduced.
- **6.21:** Extended with more info from `VL710R`.
- **6.30:** Lumber assortment added.
- **8.01:** Price group extended from 1 to 2 positions.

---

This documentation should provide experienced RPG developers with a clear understanding of the program's structure, business logic, and integration points within the ASOFAK system.