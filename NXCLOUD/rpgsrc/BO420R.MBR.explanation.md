# RPG Program BO420R – Explanation

This source code is an ILE RPG (RPG III/400) program for IBM i (AS/400) titled **"ASSHOP Vedlikehold av butikk budsjett-register"**, which translates from Norwegian as **"ASSHOP Maintenance of Store Budget Register"**. The program manages budget records and provides routines for displaying, adding, changing, copying, and deleting subfile entries on workstation screens.

---

## 1. **File Description Specifications (`F-specs`)**

```rpg
FBBUDL2    IF   E           K DISK
F                                     RENAME(BBUDPFR:BBUDL2R)
FBBUDL1    IF   E           K DISK
F                                     RENAME(BBUDPFR:BBUDL1R)
FBBUDLU    UF A E           K DISK
F                                     RENAME(BBUDPFR:BBUDLUR)
FBO420D    CF   E             WORKSTN
F                                     SFILE(B1SFL:SRRN01)
```

- **BBUDL2, BBUDL1, BBUDLU:** Disk files with external descriptions, all using the same record format (`BBUDPFR`), but renamed internally for logical file views.
- **BO420D**: Workstation file (i.e., display), using a subfile (`B1SFL`) controlled by relative record number (`SRRN01`).

---

## 2. **Data Structure Specifications (`D-specs`)**

```rpg
D MLD             S             11    DIM(4) CTDATA PERRCD(1)      // Messages
D VIR             S              2  0 DIM(12)                      // Workdays per month
D KRO             S             11  2 DIM(12)                      // Amounts per month (currency)
D                UDS                                             // User data structure
D  DSFIRM               944    946  0                             // Company code from user space
```

- **MLD**: Array for storing messages (probably for screen prompts).
- **VIR**: Workdays per month.
- **KRO**: Amounts per month, two decimals.
- **DSFIRM**: Company code (from a user data structure).

---

## 3. **Indicator Usage (Norwegian Comments)**

Describes what various indicators mean. For example:
- `KC` = F3 (Exit), `KE` = F5 (Refresh), `KL` = F12 (Cancel)
- `LR` = End job, 10 = Roll, 14 = Subfile clear, 15 = Subfile end, etc.

Developers should refer to this section to understand indicator triggers and their purposes.

---

## 4. **Key Control Flow – High-Level Description**

### **Main Program Loop**

- The program uses tags (`TAG`), conditionals (`IFEQ`, `CABEQ`, etc.), and subroutine calls (`EXSR`, `BEGSR`, `ENDSR`) to control flow.
- It works primarily in a loop showing subfile records, waiting for actions (add, change, copy, delete, view) from the user.

---

## 5. **Key Program Functions**

### **Display/Update Logic**

#### **Opening the Main Screen (B2CTL) and Handling Actions**
- **B2TAGA**: Displays the command key screen (`WRITE B2CMD`).
- **B2TAGB**: Calls `XDSP01` to display the subfile.

#### **Function Key Handling**
- **F3 (Exit)**: Jumps to `XSLUTT` to set on LR (Last Record) and return.
- **F5 (Forny / Refresh)**: Chains to (positions to) the selected record if possible, clears and (re)creates subfile.
- **ROLL**: Calls XCRT01 to fill the subfile and redisplays.
- **Other Key Combinations (Position, Validation, etc.)**: Handles lookup, validation, and navigation.

#### **Subfile Selections (Subfile Processing Loop)**
- Reads user selections within the subfile:
    - **Edit**: Calls update screen for selected record
    - **Copy**: Calls copy screen for selected record
    - **Delete**: Calls delete confirmation for selected record
    - **View**: Calls display-only version of the update screen

### **Screens (Windows/Dialogs)**
Screens are modularized by function, such as add/edit, display, delete, copy, etc.

- **C1BLD, C2BLD**: Add/Edit/View budget entry screens.
- **D1WIN**: Delete confirmation window.
- **K1WIN**: Copy confirmation window.
- **S1WIN**: Standard window for formatting.

---

## 6. **Subroutines**

### **XC2BLD (Edit/Add/View Processing)**
- Loads monthly data for workdays and amounts (VIR / KRO) for a given budget item.
- Populates screen fields from arrays.
- Handles writes/updates based on user activity.
- Updates subfile entries as needed.

### **XD1WIN (Delete Processing)**
- Displays a delete window using S1WIN and D1WIN.
- Loops through all months to delete entries for the selected account/month.
- Updates subfile to show deletion.

### **XK1WIN (Copy Processing)**
- Displays a copy window using S1WIN and K1WIN.
- Checks if the target already exists; if so, displays warning.
- If not, copies records for all months from the "from" account to "to" account.

### **XCLR01 (Clear Subfile)**
- Uses indicator 14 to clear subfile and initializes subfile pagination fields (`SRRN01`, `SFRN01`, etc.).

### **XCRT01 (Fill Subfile)**
- Populates the subfile with records from `BBUDL2` up to a page size (`SPGE01`).
- Updates subfile pagination control fields.

### **XDSP01 (Display Subfile)**
- Handles display of the subfile control, managing indicators for roll and screen control.

### **Initialization (`*INZSR`)**
- Sets initial values for fields.
- Loads company code into key field.
- Prepares key list for file access.
- Builds the subfile with initial data.

---

## 7. **Key Field and Subfile Paging Variables**

- **SRRN01**: Current relative record number in subfile.
- **SPGE01**: Subfile page size.
- **SFRN01/SSRN01/SVRN01**: First/Last/Show record numbers for subfile paging.

---

## 8. **Field Movement & Key List Usage**

- **MOVE** as assignment (old-style RPG), copies fields between arrays, screen fields, and files.
- **KLIST/KEY01**: Key list for consistent access to budget files, made up of company, account, and month.

---

## 9. **Comments on Design and Structure**

- **Subfile-driven, modular:** All main actions (add, edit, copy, delete, view) operate via workstation subfiles and separate screen layouts.
- **Explicit file I/O:** Manual `CHAIN`, `READ`, `UPDATE`, `WRITE`, and `DELETE` operations—developer must manage record existence and errors.
- **Extensive use of indicators:** Program state, screen status, and workflow are controlled by classic RPG indicators; comments define their purposes.

---

## 10. **Summary for Developers**

- Learn the **indicator meanings** from the comments block up front—they drive both logic and UI.
- **Subfile records** are the main working set; all interaction stems from user selection/keypress or input on subfile screens.
- **Main program loop** is controlled via `TAG` and `GOTO`, with subroutine calls for each action type.
- Program expects to be called in a display session and is designed to be modular and extensible for future maintenance.
- The program is highly **procedural**, with explicit jumps and manual data structure management.

---

## **Resource Pointers**

- Learn more about **subfiles** and **workstation file handling** on IBM i.
- Familiarize yourself with **indicator-driven logic** and the use of **key lists** in classic RPG.

---

## **Code Sections Cheat-Sheet**

| Tag / Subroutine | Purpose                          |
|------------------|----------------------------------|
| B2TAGA/B         | Main command/subfile display loop|
| XC2BLD           | Edit/Add/View record processing  |
| XD1WIN           | Delete processing                |
| XK1WIN           | Copy processing                  |
| XCLR01           | Clear subfile                    |
| XCRT01           | Fill subfile/paging              |
| XDSP01           | Display subfile control record   |
| *INZSR           | Program initialization           |
| XSLUTT           | Exit program                     |

---

## **Conclusion**

This program is a **maintainer for a store budget file** using subfiles with add/edit/copy/delete/view functionality, intended for a classic terminal GUI, and written with old-school RPG constructs. To be productive, work through the sample flows for editing and paging subfile entries, and get comfortable reading indicator-driven control flow.