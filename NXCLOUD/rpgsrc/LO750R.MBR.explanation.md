# RPG Source Code Explanation: LO750R (Leverandørbestilling i WEBTRADE-format)

This program prepares a supplier order in a special format for the WEBTRADE system. It primarily reads from various database files, constructs records for the WEBTRADE format, and outputs them sequentially to an output file. Below, the structure, disciplines, and major logic of the code are explained for onboarding developers.

---

## 1. Overview

- **Purpose:**  
  Generate a supplier order in the proprietary "WEBTRADE" interface format.  
- **Main Inputs:**  
  - Order head (header) and detail (line) files: customer, item, and order information.
  - Various master tables: Firm details, Stock information, etc.
- **Output:**  
  - Sequential records for "WEBTRADE," written to `lwjepfr` file, conforming to the expected structure.

---

## 2. File Definitions

Each file definition connects an external file (database/table) to a short internal name using `RENAME` where appropriate. Access is keyed (`k`) and external (`e`).

- **afirl1**: Firm information (renamed from `afirpfr` to `afirl1r`)
- **lstsl1**: Stock/location information (from `lstspfr`)
- **lohel1**: Order header (from `lohepfr`)
- **lodtl1**: Order detail (from `lodtpfr`)
- **lldilr**: Supplier distribution (from `lldipfr`)
- **vvarl1**: Item/master data (from `vvarpfr`)
- **lwjepf**: Output file (for WEBTRADE format)

---

## 3. Data Structures

### a. File Interface Record (`d_frec`)
- 950 bytes, with overlays for fields to construct file-level information in the output record.
- Fields such as `FILE`, `WT31`, version, type, etc.

### b. Heading Record (`d_hrec`)
- 950 bytes, overlays for customer name, address, city, post, country, contact info, etc.
- Used for outputting header information.

### c. Detail Record (`d_drec`)
- 950 bytes, overlays for item number, quantity, unit, EAN, description, date, etc.
- Used for writing each detail/line record.

### d. LDA (Local Data Area)
- Subfields for accessing part of the LDA (e.g., firm number code).

### e. Various Standalone Variables
- For copying key fields, holding intermediate values, and storing input parameters.

---

## 4. Key Lists

Key lists (`klist`/`kfild`) are defined for various files to use keyed access in CHAIN/READE operations.  
Example:  
- `afirl1_key` has key field `w_firm`
- `lohel1_key` uses `w_firm`, `lohel1_numm`, `lohel1_suff`
- ... and so on for other files

---

## 5. Main Logic Flow

### **A. Program Initialization (`*inzsr`)**
- Set up key lists.
- Receive parameters from previous program via `*entry` PLIST:
  - `p_numm`, `p_suff`: Order number/suffix
  - `p_otyp`, `p_akod`, `p_aktk`, `p_luke`: Additional codes for WEBTRADE format
- Set working variables from LDA and parameters.
- Initialize certain data structure fields to zero.
- Read stock and firm data into working storage for later use.

---

### **B. Output File Interface Record**
- Set `webrec` to the prepared file interface record (`d_frec`).
- Write this as the first record in the output file.

---

### **C. Read and Output Order Header**
- Use `CHAIN` with keys to read the order header (`lohel1r`). Exit if not found.
- Read supplier distribution info (`lldilr`) for delivery address—try variants if not found.
- Blank out relevant header fields.
- Copy and format date, order and supplier references, etc.
- Prepare for possible direct delivery address substitution.
- Set various WEBSHOP-specific fields.
- If special code `p_akod` specified, use for a header field; else use warehouse code (`lolage`).

---

### **D. Process Order Details**
- Loop over order detail lines (using `READE`/`DOW` loop).
- Skip lines if they are purely text (`ldltyp = laatty`).
- On the first eligible line, call subroutines to fill in and trim the header record, then write it to the output file.
- Lookup item in `vvarl1`; if not found, use fallback.
- Call external program `VE711R` to fetch EAN number for the item.
- Choose the appropriate item code (from detail or item master).
- Set detail fields: quantity, units, EAN, description, delivery date, etc.
- If the EAN is suspiciously large (> 13 digits), set to 0 (special handling for GTIN issues).
- Trim the detail record and write it to the output file.
- Move to the next detail record.

---

### **E. Program End**
- Set LR (last record indicator) and RETURN.

---

## 6. Subroutines

### **dir_lev**
Populate header address fields (`d_hnam`, `d_had1`, etc.) from direct delivery data in `lohel1r`.

### **trim_hrec**
Build a single output string (w_wrec) by concatenating/packing and trimming all relevant heading fields, in order, into the output structure.

### **trim_drec**
Same as `trim_hrec`, but for detail fields.

---

## 7. Special Notes & Comments

- **Indicators used:**  
  - `LR` for program end  
  - 80-89: Work indicators  
  - 90-99: File operation status

- **Overlaying for Packing:**  
  Fields are tightly packed into fixed-length 950-byte records with overlays and field delimiters (usually '&&') for output.
- **Language/International:**  
  Field and comment names are in Norwegian. "Leverandørbestilling" = "Supplier order".
- **External Calls:**  
  Program `VE711R` is called to obtain EAN (European Article Number) codes for items.
- **Error Handling:**  
  If a necessary header or cross-reference cannot be found, the program jumps to `end_pgm` and exits early.

---

## 8. Summary of Typical Program Run

1. **Input parameters**: Order number, suffix, type, codes, etc. come from a calling program.
2. **Initialization**: Populate working storage and key structures.
3. **Output header records**: File/interface record and, if appropriate, actual order header data.
4. **Loop**: Process each non-text detail line, get supporting data, build and write formatted records.
5. **Cleanup & exit**: Set LR and return.

---

## 9. Onboarding Guidance

- Focus on the structure of the output: each record is composed by concatenating trimmed fields with delimiters.
- Data for output is drawn from a combination of input files (order, item, firm, warehouse) and manipulated as needed.
- Subroutines handle specialized formatting (mainly for output record packing).
- If adding fields to the WEBTRADE format, you’ll need to update both the data structures and the subroutines responsible for packing records.

---

### For new developers
- **Familiarize yourself with the data model**: Key files (header, details, item, supplier) are central.
- **Understand record overlays**: The output format is "hand-packed" for a legacy interface.
- **External dependencies**: The EAN/GTIN number resolution depends on an external program.
- **Parameter Passing**: The workflow depends on being called with specific parameters (it does not prompt the user).

---

This RPG program is a typical example of a data extraction and transformation utility in IBM i environments, tailored for a specific (legacy) web integration scenario.