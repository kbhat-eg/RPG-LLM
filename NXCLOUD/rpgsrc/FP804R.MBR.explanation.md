# RPG Program Explanation: FP804R (ASOFAK)

## Overview

This RPG (Report Program Generator) program, `FP804R`, is designed for ASOFAK's order entry system. It retrieves orders from a historical voucher register ("bongregister"), supporting various selection and filtering criteria. The system appears to be Norwegian, based on the comments and field names.

The program reads from historical order records, applies user-specified selection criteria (such as company, seller, date range, order type, department, etc.), and writes the filtered output.

---

## Source Structure

### 1. Program Options and Metadata

- `H datedit(*dmy) option(*nodebugio)`
  - Numeric dates are edited as day/month/year.
  - Debug I/O is disabled.
- `/TITLE ...`
  - Title and documentation describing the system, program, and change log.
- Comments (`* ...`) detail the program's history and changes over various releases.

---

### 2. File Definitions (`F-Specs`)

```rpg
fbohel9    if   e           k disk    rename(bohepfr:bohel9r)
f                                     prefix(fo:2)
ffdell3    if   e           k disk
fwohepf    o  a e           k disk
```

- **bohel9**: Input file (historical order header), read with keys, renamed and with fields prefixed `fo`.
- **fdell3**: Input file (possibly order details or references), also keyed.
- **wohepf**: Output file (writes selected orders).

---

### 3. Data Area & Data Structure Definitions

#### Local Data Area (LDA)
- Defines various fields (e.g., `l_user`), referencing data stored in the LDA.

#### Key/Parameter Data Structures
- **d_list:** 128-byte parameter structure, used for passing selection filters.
- Various overlays (`overlay()`) map parts of d_list to named fields, such as:
  - `d_firm`: Company
  - `d_hist`, `d_bong`: selection flags for historical/active registers
  - `d_selg`: seller
  - Date fields: `d_fdat`, `d_tdat` (from/to)
  - Multiple order type and info-code fields
  - `d_sort`, `d_ityp`: sorting and type flags

#### Variables for File Keys & Processing
- Variables such as `bohel9_firm`, `bohel9_bdat` are defined to handle keys for file access.
- `gml_selg`, `w_firm`, `w_timestamp`: temporary variables used during processing.

---

### 4. Mainline Logic

#### High-Level Flow

```rpg
c     if        d_bong = '1'
c                exsr      detalje_bohe
c     endif

c                eval      *inlr = *on
c                return
```

- If the **Bong/Voucher flag** (`d_bong`) is set, process historical "bong" records via a subroutine.
- Then set LR (`*inlr`) to end the program.

---

### 5. Subroutines

#### `detalje_bohe` – Process Historical Vouchers

This subroutine loops through the historical order file, applying user filters, and writes out selected records.

##### Logic Steps:

1. **Read** first record from `bohel9`.
2. **For each record**:
   - Set temporary mark (`fobolo = 'B'`).
   - Filter by:
     - **Company** (`fofirm = d_firm`)
     - **Date** (single or range: `d_fdat` ... `d_tdat`)
     - **Seller** (`d_selg`)
     - **Department** (`d_avde`)
     - **Order Type** (via several `d_bot*`, `d_bvlg`)
   - If the Bong was **copied from an order** (`foornr != 0`), call subroutine to fetch original order date/details.
   - **Write** selected record to output (`wohepfr`).
   - Continue to next record.
3. Loop ends at EOF or when a non-matching firm is found.

#### `hent_ord` – Fetch Original Order Data

If a Bong was copied from an order, this subroutine retrieves the original order date and seller from the `fdell3` file, updating the local fields.

#### `*inzsr` – Initialization

- Receives parameter list (`w_list`), maps it to the data structure.
- Sets up file keys for initial positioning.

---

## Selection Criteria (Filter Logic)

- **Company**: Must match `d_firm`.
- **Date / Date Range**: If `d_tdat` (to-date) is blank, select only orders matching `d_fdat`; if not, select those within range.
- **Seller / Department**: Can filter for a specific seller/department or all.
- **Order Type**: Supports multiple types (`d_bot1`...`d_bot6`) and grouping via `d_bvlg`.
- **Info Code**: Can filter by up to 6 info code fields.
- **Uses subroutines** to fetch related info and to write selected records to the output file.

---

## Summary Table

| File     | Purpose                               | Direction | Keyed?  | Notes                      |
|----------|---------------------------------------|-----------|---------|----------------------------|
| bohel9   | Historical order header               | Input     | Yes     | Prefixed `fo`              |
| fdell3   | Historical order detail/reference     | Input     | Yes     | Used for original order    |
| wohepf   | Selected order output                 | Output    | Yes     | Record written on match    |

---

## Key Takeaways for Developers

- **Modular**: Mainline just kicks off subroutines based on parameters.
- **Highly parametric**: Uses a single parameter data structure (d_list) to provide all selection/filter values.
- **Selection logic is handled by a single read loop** with nested filters.
- **Well-documented** with a thorough change log, field usage, and rationale in Norwegian.
- **Legacy-style RPG**: Uses fixed-format, direct file I/O, and classic subroutine (`begsr/endsr`) structure.

---

## Onboarding Hints

- **Understand the data structure overlays**: Most parameters come in as a byte array and are overlayed for fielded access.
- **Know the files**: You’ll need to be familiar with the layouts of `bohel9` (order header/history), `fdell3` (order detail/history), and `wohepf` (output).
- **Selection logic is coded in-line**: All filters are applied inside the read loop with classic RPG tags and `goto`s.
- **For enhancements**: Focus changes on the parameter structure, the filtering logic in `detalje_bohe`, or subroutine additions.

---

## Visual Flowchart (simplified)

```text
Start
 │
 │ [if d_bong = '1']
 │
 └─> detalje_bohe
       ├─ read bohel9
       │
       ├─ for each record
       │   ├─ check firm
       │   ├─ check date (or range)
       │   ├─ check seller, dept
       │   ├─ check order type
       │   ├─ if copied, call hent_ord
       │   ├─ write output if all match
       │   └─ read next record
       │
       └─ end [LR=*ON]
```

---

**In summary:**  
This program reads historical order records, applies user-selected filters passed in a parameter structure, and outputs the filtered records. The logic is linear and classic RPG, with all selection logic inside a single read loop. Understanding the parameter data structure and the file layouts is key to working with or extending this program.