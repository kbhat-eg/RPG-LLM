# RPG Program Explanation: JV400R

## Purpose
This RPG program (JV400R) is designed to **delete a product ("vare") and all of its related data/records** across a range of physical files (database tables) on the IBM i platform. It ensures data integrity by cleaning up all dependencies for a given product.

---

## High-Level Structure

- **Header Section:**  
  Contains program documentation, history, and change log.

- **File Declarations:**  
  Defines the files (tables) to be accessed by the program. Each file is renamed for internal use.

- **Data Definitions:**  
  Defines parameters (inputs), working fields, and keys used throughout the program.

- **Main Logic:**  
  Steps through each file and deletes all records related to the specified product and company.

- **Program End & *INZSR Subroutine:**  
  Handles final logic and parameter initialization.

---

## Details

### 1. **File Declarations**
```rpg
fjvarlu  uf e k disk  rename(jvarpfr:jvarlur)
fjvdtlu  uf e k disk  rename(jvdtpfr:jvdtlur)
...
```
- Multiple files are declared as input/output (U), keyed (K), and externally described (E), with internal names for easier coding (e.g., `jvarlur`).
- These files represent different aspects of the product, such as main data, details, prices, packaging, descriptions, and more.

### 2. **Parameter and Variable Definitions**
```rpg
d p_firm   s 3 0      // Company ID parameter
d p_vare   s like(jvvare)   // Product code parameter
d w_firm   s 3 0      // Working field for company
d w_vare   s like(jvvare) // Working field for product
...
```
- Inputs to the program (via parameters) are the company ID (`p_firm`), product code (`p_vare`), and a flag (`p_inlr`) to control the last record indicator.
- Working variables (`w_firm`, `w_vare`, `w_nobb`) are used as local copies.

### 3. **Key Lists**
Defined in the *INZSR subroutine for use in chained file access/deletes:
```rpg
key01 klist
  kfld w_vare          // Key for product only

key02 klist
  kfld w_firm
  kfld w_vare          // Key for company + product

key03 klist
  kfld w_nobb          // Key for "nobb" related deletes (if present)
```

### 4. **Main Program Logic**

#### **Initialization**
```rpg
eval w_firm = p_firm
eval w_vare = p_vare
```
- Initializes local working variables from incoming parameters.

#### **Deleting the Main Product Record**
```rpg
key01 chain jvarlur 90
eval w_nobb = jvnobb
delete jvarlur
```
- Uses `key01` (product) to find the product in the main file and deletes it.
- `w_nobb` is set from the record, used for further deletes.

#### **Deleting Related Records**
- **Details, search text, temporary prices, packaging, prices, conditions, discount elements, and more** are deleted from their respective files, typically using `key01` or `key02` as the record key.

- **Looped Deletion Pattern:**
  For files where multiple related records may exist (e.g., packaging, descriptions), the program uses a pattern:
  ```rpg
  keyXX setll File
  keyXX reade FileRecord 90
  dow *in90 = *off
    delete FileRecord
    keyXX reade FileRecord 90
  enddo
  ```
  - Reads all matching records and deletes them one by one until no more matches are found.

- **Special Cases:**
  - For certain files, fields in the record are cleared/blanked and updated instead of deleted (e.g., `jmatl7r`).
  - Some deletes use a key including `w_nobb` (the "nobb" number, possibly a secondary product ID).

#### **Version 6.31 Adjustments**
- Additional files and delete operations were added in version 6.31 to further clean up related data (e.g., price givers, alternative numbers, descriptions, NRF data, upsells, and more).

#### **Program Termination**
```rpg
if p_inlr <> *on
  eval *inlr = *on
endif
return
```
- If the input flag `p_inlr` is not *on, the special RPG indicator `*INLR` is set, marking the program for closure.
- The program then returns.

### 5. ***INZSR Subroutine**
- Called once at program start, it initializes parameters and keys for the main program's use.

---

## Summary Table: **Files and Their Roles**

| Internal Name | Original File | Purpose / Data Type                |
|---------------|--------------|-------------------------------------|
| `jvarlur`     | `jvarpfr`    | Product master record               |
| `jvdtlur`     | `jvdtpfr`    | Product details                     |
| `jwprlur`     | `jwprpfr`    | Temporary pricing                   |
| `jsoklur`     | `jsokpfr`    | Product search keywords             |
| `jvprlur`     | `jvprpfr`    | Product pricing                     |
| `jvpklur`     | `jvpkpfr`    | Product packaging                   |
| `jbetl9r`     | `jbetpfr`    | Product conditions                  |
| ...           | ...          | ...                                 |

(And similarly for the other files.)

---

## Key RPG Concepts Used

- **File Operations:** `chain`, `setll`, `reade`, `delete`, `update`
- **Key Lists:** for specifying keys for file access
- **Indicators:** `*in90` used to track EOF/record not found
- **Parameters:** passed via `*ENTRY` PLIST
- **Subroutine:** `*INZSR` for startup/init logic

---

## **Typical usage**

This program would be invoked, passing company and product codes as parameters, to fully purge a product and all of its linked data from the system.

---

## **Onboarding Points:**

- **Dependencies:** Know the file structure and field names (`jvarlur`, `jvvare`, etc.).
- **Expanding:** To delete more related data, add file definitions and replicate the deletion pattern.
- **Error Handling:** Minimal in this code; consider enhancing with logging or more robust handling of file exceptions.

---

## **Summary**

**JV400R** acts as a centralized "delete product and all relations" utility for a product master, ensuring no orphaned records remain. Study the file relationships, key fields, and the repeated deletion pattern to adapt or extend this program to future needs.