# RPG Program VV770R – Explanation

This RPG (Report Program Generator) program is designed for IBM i (AS/400) systems. The source code is classic (non-free format) ILE RPG and is annotated in Norwegian.

Here's a structured onboarding explanation of the code:

---

## **Header and File Declarations**

- **H Specifications**
  - `option(*nodebugio) datedit(*dmy)` – No debug input/output, date format is day-month-year.
  - `dftactgrp(*no)` – Uses its own activation group, needed for programs that need to call other ILE objects.

- **File Specifications**
  - `ltell2` and `lusrl1` are physical files opened for input (`if`), externally described (`e`), keyed (`k`), renamed to `ltell2r`, `lusrl1r`.
  - `vv770d` is a display file used for user interaction (`workstn`).

---

## **Data Definitions**

- **Local Data Area (LDA)**: RPG uses LDA for program/session variables.
    ```rpg
    d                uds
    d l_user         911    920
    d l_firm         944    946  0
    ```
    - `l_user` – User profile name from LDA.
    - `l_firm` – Company code from LDA.

- **Variables for Keys and General Use**
    - `ltell2_batc`, `ltell2_numm`, `lusrl1_user` are work variables for keys into the files.
    - `b_feil` – Flag (1 char) for error in user input.
    - `w_firm`, `w_stel`, `w_batc`, `w_antl` – Working variables for company, type, batch, and amount of warehouses.
    - `w_meld` – Message string (50 chars), used for user notifications.

---

## **Program Flow**

### **1. Preventing Execution (Patch 8.01)**
```rpg
eval w_meld = 'Denne rutinen kan ikke  ' + 'kj�res '
call 'AA005R'
parm w_meld
goto avslutt
```
- The program, as patched (see comments NXS-20613), will immediately display a message ("This routine cannot be run") and then exit. None of the original logic will execute. The patch disables the business logic, often for safety or deprecation reasons.

---

### **2. User Authorization (Now unreachable due to patch)**
```rpg
eval lusrl1_user = l_user
lusrl1_key chain lusrl1
if not %found or lbtans < 2
    exsr b12msg0
    goto avslutt
endif
```
- Checks if the current user (from LDA) exists in the `lusrl1` file and has authority (`lbtans < 2` means not enough access).
- If not authorized, displays a message and exits.

---

### **3. Main Screen Handling (Unreachable)**
- `exfmt b1bld` – Displays and gets input for main screen.
- Function keys and inputs are processed:
    - If `*inkd` pressed, calls another program (`LC501R`).
    - If new batch, runs `les_batch` subroutine to fetch batch info.
    - Handles exit function keys (`*inkc`, `*inkl`).

---

### **4. Input Validation**
- Calls `sjekk_input` subroutine to validate user inputs (batch number, etc).
- If error (`b_feil = *on`), redisplays input screen.

---

### **5. Batch and Warehouse Processing**
- Calls `sjekk_lager` to check the number of warehouses.
- Calls external program `VV771C` to perform the update, passing relevant parameters (firm, batch number, item number, warehouse, update flag, count).

---

### **6. Subroutines**

#### **6.1. sjekk_input**
- Validates input fields, sets `b_feil` flag and input indicators if errors are found.
- Checks for:
    - Syklistisk telling (`w_stel = 1`), not allowed.
    - Blank batch or item number = 0, both not allowed.
    - Looks up batch/item in `ltell2` file, sets error if not found.

#### **6.2. les_batch**
- Runs two embedded SQL queries:
    1. Gets item number and type (`lcnumm, lcstel`) from `lbchpf` based on firm and batch.
    2. Gets warehouse (`lelage`) from `ltelpf`.
- Stores the info in screen fields.

#### **6.3. sjekk_lager**
- Counts number of warehouses for the company in `ra10pf` table using SQL.

#### **6.4. b12msg0/b12msg1**
- Displays appropriate error messages to user (no access, cyclic batch chosen).

#### **6.5. *inzsr (Initialization)**
- Builds RPG key lists for use in subsequent keyed lookups.
- Reads firm number from LDA.

---

## **Key Takeaways for Onboarding**

- **Program Status**: As of Patch 8.01, the business logic is effectively disabled. The program only displays a message and exits.
- **Intended Function** (before Patch 8.01): To update item types in a warehouse system after a stock count process, with user authorization, input validation, and batched processing.
- **Database Use**: Integrates both classic file access (CHAIN) and embedded SQL for record retrieval and counts.
- **Security**: User access is checked at program startup.
- **Screen Management**: Uses display file for user interaction, prompting for batch and item information.

---

## **Development/Testing Notes**

- **To re-enable logic**, remove or comment out the "patch" block at the start.
- **Key Variables**:
    - `w_firm` – Company/firm identifier
    - `b1batc`, `b1numm` – Batch and item numbers (screen fields)
    - `w_antl` – Number of warehouses
- **SQL Tables Used**: `lbchpf`, `ltelpf`, `ra10pf`.
- **Program Calls**: `AA005R` (show message), `LC501R`, `VV771C` (update process).

---

## **Summary**

This RPG program, now disabled by a patch, was designed to update item types based on stock count results with strict user authorization and robust validation, integrating both classic and SQL file processing, and relying heavily on IBM i-specific workflows and file structures.