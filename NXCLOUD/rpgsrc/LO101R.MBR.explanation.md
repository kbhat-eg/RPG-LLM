# IBM ILE RPG Source Code (LO101R) Explanation

## Overview

This RPG program, **LO101R**, is designed for maintaining and updating information related to purchase orders ("Best./Innkj√∏p") in a Scandinavian (Norwegian) business application. It handles both the *header* and *details* of purchase orders, with validation against several master data tables (departments, buyers, warehouses, payment terms, etc.), performs updates, and provides a screen interface for users to review and edit this data.

The code is quite complex, including enhancements and bug fixes over many years, with extensive comments and version tags.

---

## 1. **Header Information and File Definitions**

- **H-spec** sets options:
  - `*nodebugio`: disables debug for IO operations.
  - `datedit(*dmy)`: sets date format as day/month/year.

- **File Definitions (F-specs)**:
  - Multiple files are defined for reading/writing various registers:
    - Purchase order header, detail, status, supplier, etc.
  - Some files are renamed when referenced to facilitate program logic.
  - Workstation file `flo101d` is used for display screens.

---

## 2. **Data Structure and Variables**

- **Data Structures (DS):**
  - Used for overlaying fields, e.g., breaking a 75-char delivery condition text into 3x25-char lines.
  - Another DS overlays a 25-char "KID" (customer identification) for validation purposes.

- **User Data Area (UDS):**
  - Used for storing session/user information (user, firm, warehouse, etc.).

- **Standalone Variables:**
  - Many variables are declared for keys, temp fields, and business logic.
  - Variables often reference fields from the imported files for consistent typing.

---

## 3. **Parameter Handling**

- The program can be called as a subprogram, receiving parameters such as status, company number, order number, and others for controlling the processing.

---

## 4. **Main Logic Structure**

### a. **Screen C2: Purchase Order Header**

- **Initialization:**
  - Fetch data from the purchase order header file.
  - Populate screen fields with values from DB.
- **Text Lookup:**
  - Lookup/display department, purchaser, warehouse, payment terms, currency, freight forwarder, and delivery method using subroutines (`exsr`).
- **Screen Input:**
  - Display the screen and process user actions:
    - **F3**: Exit/subprogram return.
    - **F4**: Field inquiry (show valid values, etc.).
- **Validation Logic:**
  - Checks if entered codes (department, buyer, warehouse, etc.) exist in corresponding code tables.
  - Error indicators are set and control returned to the screen if validation fails.
  - If any lookup field is changed, update corresponding fields in the DB and re-display the screen.
  - VAT/moms code change triggers update of VAT codes at line level.
- **DB Update:**
  - If data passes validation, the header file is updated with the new values.
  - If the warehouse is changed, a related program (`LO732R`) is called to handle any required updates.

---

### b. **Screen C3: Additional Order Details**

- **Data fetch:**
  - Fetch additional fields (voucher number, project, activity, etc.) from the purchase order header.
- **Inquiry/Validation:**
  - Several subroutines (sometimes commented, sometimes active) for looking up descriptions for project, account, cost carrier, activity, etc.
- **Screen Input:**
  - Presents a second screen for extended details.
  - Handles F3 (go back) and F4 (inquiry).
- **Validation:**
  - Checks if voucher number is within allowed range.
  - Ensures voucher number is unique.
  - Checks if vendor invoice number has been used before (to prevent duplicate supplier invoices).
  - "KID" number validation using modulus check and external program (`AK720R`), with user override prompt.
  - Checks for valid invoice and due dates.
  - Warns if invoice date is after due date.
  - Checks if the supplying vendor exists in the supplier register.
  - Checks if the project exists in the project register, with user override.
  - (Commented out: checks for activity, account, and cost carrier validity.)
- **DB Update:**
  - Updates order header with all changes.

---

## 5. **Field Inquiry Functionality**

- **Purpose:**
  - When user asks ("F4") for help on a field, program displays valid values/descriptions by calling external programs (e.g., `RA507R` for departments, `RA510R` for warehouses, etc.).

---

## 6. **VAT/Moms Code Update (Subroutine)**
- **If the order VAT code changes,** all detail lines for the order are checked/updated:
  - Line VAT code is updated according to item and line type registers, with fallback logic if not found.
  - Modification timestamps are set.

---

## 7. **Code-lookup Subroutines**

- **For each master data field** (department, warehouse, payer, currency, etc.), a subroutine calls an external program to fetch the description. If the lookup is successful, text is copied to the relevant screen field.

---

## 8. **Program Initialization (`*INZSR`)**

- **Function:**
  - Initializes variables.
  - Sets up keys for file operations.
  - Reads validity range for voucher numbers.
  - Sets up warehouse/department behavior if new order is created and warehouse differs from user default.

---

## 9. **Program Entry and Key Lists**

- The `*ENTRY` PLIST defines parameters received from calling program.
- Key lists (`KLIST`) are defined for fast, composite record access in the various files.

---

## 10. **Versioning and Enhancements**

- The code is heavily versioned with comments, indicating which enhancements, bug fixes, or business changes were implemented, and when (e.g., handling of KID number validation, supplier invoice number uniqueness, new GUI version, etc.).
- Many features are conditionally compiled or commented, which suggests that this code is often customized for specific installations or versions.

---

## 11. **Noteworthy Features**

- **Strong Field Validation**: The program validates almost every critical code (project, account, supplier, KID number, etc.).
- **User Override Prompts**: On some validation failures (e.g., unknown supplier invoice number, invalid KID, etc.), prompts allow user override.
- **Parameterization**: The code is designed to be reused in different contexts with parameter-driven behavior.
- **Modularization via Subroutines**: Key logic is split into subroutines for maintenance and reuse.
- **External Calls**: The program relies on several external programs (via `CALL`) for code lookups, validation, and business rules.
- **Line-level VAT Management**: When the VAT code in the header changes, all lines are updated accordingly.

---

## 12. **Summary Table: Files and Their Purposes**

| File Name   | Purpose                                            |
|-------------|----------------------------------------------------|
| `anuml1`    | Number master (possible for voucher number ranges) |
| `lstsl1`    | Status codes master                                |
| `lohel1`    | Order header (read)                                |
| `lohelu`    | Order header (update)                              |
| `sihel1`    | Historical invoices                                |
| `rltrl7`    | Supplier invoice postings                          |
| `vmval1`    | VAT code register                                  |
| `vvarl1`    | Item register                                      |
| `vltyl1`    | Line type register                                 |
| `lodtlu`    | Order detail lines                                 |
| `rlevl1`    | Supplier register                                  |
| `rp1pl1`    | Project register                                   |
| `sihela`    | Supplier invoice history                           |
| `flo101d`   | Workstation (display) file                         |

---

## 13. **Typical Workflow**

1. **Load purchase order header** and relevant codes/descriptions.
2. **Display Screen 1 (C2)** for editing core header data.
    - Validate input fields against code registers.
    - Allow F4 field inquiry for code selection.
    - On changes, update the DB and refresh the screen.
3. **Proceed to Screen 2 (C3)** for additional fields.
    - Validate voucher number, KID, supplier invoice number, etc.
    - If any errors or warnings, inform user, allow override when appropriate.
    - Upon successful validation, update the DB with entered values.
4. **Return or exit** as instructed by the user.

---

## 14. **Best Practices and Modernization Notes**

- The program exhibits classic RPG/400 and RPG IV code patterns.
- Modern best practices suggest modularizing further, leveraging service programs (ILE), and perhaps using RPGLE free format throughout.
- Recent enhancements (e.g., use of `dcl-s`, `%check`, `%found`, `%len`, `%subst`, etc.) show a migration toward more modern RPG IV idioms.
- Many business rules here are business-specific (Norwegian KID validation, project register checks, etc.).

---

### **In Summary**

This program is a robust, business-rule intensive module for editing purchase orders, ensuring correctness via master data validation, prompting users when strict compliance isn't met, and updating records in a multi-step, screen-driven workflow. It is designed for maintainability, extensibility, and supports a range of real-world scenarios encountered in procurement and finance modules. 

New developers should focus on understanding the screen-to-database flow, the importance of subroutines for validation, and the use of external programs for data lookup and rule enforcement. Most changes will likely involve business logic updates, new code lookups, and adapting validation rules as business requirements evolve.