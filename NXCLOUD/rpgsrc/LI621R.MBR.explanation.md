# Explanation of RPG Program "LI621R" (ASOFAK: Utskrift av EDI Faktura)

## Overview

This RPG/ILE program, named **LI621R**, is responsible for the output/archiving/printing of EDI invoices (faktura), with the ability to generate printouts (spool/PDF) and XML/Jasper archivable outputs. It handles data from EDI invoice headers, lines, references, extra charges, and more, with support for multiple output formats, email notification, and archive tagging. Comments and changelogs (in Norwegian) detail its evolution.

---

## 1. **Header Section**

- **h-specs** set program behavior for debugging, date/decimal editing, activation group, and the use of CGIDEV2 binding directory for CGI and HTML integration.
- Changelog details revisions: e.g. PDF support, XML archiving, customer fields, reference bugs, etc.
- Program renamed from LI616 due to naming conflicts.

---

## 2. **File Declarations**

Defines logical files (with RENAME for record formats) for reading EDI invoice headers, detail lines, parts, variables, company info, and more:

- `lohel1`, `lodtl1`, `ledilr`, `ledil1`, `vvarl3`, `afirl1`, `aforl1`, `rkunl5`: input files (if - input, e - externally described, k - keyed)
- `li621p`: printer file for output.

---

## 3. **Data Structure and Variable Declarations**

### **Parameter Layout and Structures**

- Data structures to receive program parameters upon entry, such as `d_prec`, which overlays firm, type, message numbers, etc.
- Data structures for different logical groupings of invoice data: header (`d_fakh1`), extra lines (`d_fakh2`), free text (`d_fakh3`), references (`d_fakh4`), party info (`d_fakh5`), transport info (`d_fakh6`), invoice lines (`d_fakl`), and totals (`d_fakt`).

### **LDA (Local Data Area) Variables**

- Used for passing job-level context (output queue, firm, user, department, archive flags, etc.).

### **Key Variables**

- Used to build composite keys for CHAIN/SETLL/READ on logical files.

### **Processing Parameters**

- Variables for mail settings, customer/procurement info, emails, personal names, message bodies, etc.

### **XML/Jasper/CGIDEV2 Integration Variables**

- Strings for XML output, template file paths, variables for Jasper Reports integration.
- Data structure for XML output meta (template, logo, path, email, FIFO, etc.).

---

## 4. **Main Program Flow**

### **Read and Prepare EDI Invoice**

- **Retrieve header:** Loads type, message, and line into working variables; reads EDI header (CHAIN ledil1).
- **Set report title:** Sets text for credit note/faktura depending on document type.
- **Populate output fields:** Extracts and massages address/party data, invoice references.
- **Date Conversion:** Various date fields are moved or initialized, adjusting date formatting as needed.
- **Read reference information:** Looks up message references (CHAIN ledilr, mlin=300001).

### **Write Output Header**

- If not generating PDF/XML, write RPG printer file header (A1HDR format).
- Else, call XML/Jasper subroutine to write XML header.

---

## 5. **Process and Output Free-Text Lines**

- **Reads lines with mlin=650000:** Loops over free-text lines for the invoice, writes to printer or XML depending on output type.

---

## 6. **Process and Output Invoice Lines**

- **Reads lines with mlin=500000:** For each invoice line:
  - Loads line data
  - Calculates amounts, handles discounts (including multi-level discounts, with logic for percent or value)
  - Prepares output variables
  - Writes invoice line (D1DET format) to printer or XML section as appropriate
  - Handles page overflow by re-writing header if needed
- After lines, calls subroutine `fakt_avsl` (invoice finalization).

---

## 7. **Subroutines**

### **fakt_avsl:** Invoice Finalization

- Writes totals and extra charges (e.g. shipment, surcharge lines labeled with `mlins` in 600000 – 650000 range), both for print and XML.
- Writes various lines: underlines, blank lines, total lines (net, VAT), and meta-archive tags.
- Handles page overflow.
- Writes archive meta (ref no, display tag, archived tags) if archiving.
- Calls archive subroutines when using XML/Jasper/PDF.

---

### **part_info:** Party Information

- Loops over parts (recipient, delivery, sender) and loads their address/contact info into output variables.
- Adjusts for missing address lines and tries to use next available fields.
- Special logic for fetching real customer number by EAN if available.

---

### **sr_6text:** Supplement Text For Extra Charges

- Looks up standard labels for charge codes (e.g. transport, packaging, fee, etc.) if missing in the input to ensure output has a meaningful label for the extra/charge.

---

### **xml_envm, xml_head, xml_deta, xml_netto, xml_charges, xml_vat, xml_totaler, xml_end:**

- **xml_envm:** Environment setup for XML/CGIDEV2, printing credential, report, print info, checking outq validity, updating Jasper variables.
- **xml_head:** Writes invoice header data (company, sender, recipient, supplier) to XML output, including email handling if mail is to be sent. Cleanses text for XML safety by calling a special program ('AP613R') to sanitize/convert special characters.
- **xml_deta:** Writes invoice line data to XML.
- **xml_netto, xml_charges, xml_vat, xml_totaler:** Write out each corresponding section (net, extra charges, VAT, total) to the XML with relevant values and labels.
- **xml_end:** Finalizes the XML document, writes meta-tags for archiving, produces the output XML file in the right location, optionally writes to a data queue for integration with downstream processes.

---

### **pdf_preview:**

- Calls an external program to launch the generated PDF in a browser (for preview).

---

### **Initialization Subroutine (*inzsr):**

- Sets up the program on entry:
  - Decomposes parameter structure from caller.
  - Sets up keys for file access.
  - Looks up routine and firm info for display/archival.
  - Checks if Jasper/XML output is to be used, and sets integration flags/variables accordingly.
  - Retrieves Jasper/XML template and logo paths as required.
  - Logs program start and checks output/archiving eligibility.
  - Handles error logging in case of missing/incomplete parameters.

---

## 8. **Key Handling**

- Key lists (`klist`) are declared (for CHAIN, SETLL, READ) for each logical file.
- Keys usually consist of the firm, type, number, and line, enabling robust access to multi-level EDI data structures.

---

## 9. **Special Notes**

- **Supporting Programs:** This program relies heavily on calls to external programs (`AP609R`, `AP610R`, `AP611R`, `FO798R`, `AP613R`, `AP621R`, etc.) for actions like text cleansing, fetching mail data, updating Jasper environments, writing to archive, etc.
- **CGIDEV2 Integration:** Used for HTML/XML output and communication with Jasper Reports.
- **Multi-Version Support:** The code is annotated with version flags (e.g. 6.20, 7.10) to flag lines for conditional compilation.
- **Language:** Comments and some strings are in Norwegian.

---

## 10. **Main Processing Summary**

1. **Setup:** Decompose input parameters, initialize variables, decide on output type (print or XML).
2. **Read EDI Header Data:** Load the main invoice information.
3. **Print/Write Header:** Output the invoice “head” (A1HDR or XML).
4. **Print/Write Free-text:** Output any invoice free-text lines.
5. **Print/Write Lines:** Output invoice item lines (details).
6. **Finalize:** Output summary lines (totals, VAT, etc.), archive meta tags.
7. **Write XML (if applicable):** Save XML to disk, archive as needed.
8. **Preview PDF (if applicable):** Optionally launch PDF for preview.
9. **End Job:** Set LR on, return.

---

## 11. **Onboarding Tips**

- Familiarize yourself with the logical data structure of EDI invoices/lines as implemented on the system (file layouts, key structures).
- Note the use of external routines for specialized tasks (text conversion, mail, Jasper/CGIDEV2, meta-tagging).
- Most data manipulation involves moving fields between structures, cleansing text for output, and translating to output format (print or XML).
- Pay attention to the version annotations, as the codebase appears shared and branched for multiple customers/processes.
- Changelog in the comments provides valuable context for why certain quirks/fields/exceptions are present.
- For printing vs XML/Jasper output, logic is usually guarded by `b_pdfp` flag.

---

## 12. **Troubleshooting & Maintenance**

- If output is missing or incorrect, first verify which output mode is active (printing vs XML).
- Check external programs for failures or parameter changes.
- Using CGIDEV2 for XML/HTML generation means updates to templates or field mappings may affect output.
- If new fields are added in EDI/message definitions, you must update DS definitions and output logic accordingly.
- Most address/party logic accounts for missing fields by “falling through” to alternatives; understand these rules for support.

---

## 13. **References**

### **Key Data Structures**

- **d_fakh1:** Main header
- **d_fakl:** Invoice lines
- **d_fakt:** Totals
- **d_fakh2/3/4/5/6:** Charges, free text, refs, party/transport info

### **Key Files**

- **ledil1, ledilr:** EDI invoice and reference details
- **lohel1:** Purchase order header
- **lodtl1:** Purchase order lines
- **afirl1, aforl1:** Company and routine info
- **li621p:** Output printer file (report)

---

This program is a robust, highly-integrated solution for EDI invoice output/archiving, handling complex real-world scenarios and multiple output requirements.