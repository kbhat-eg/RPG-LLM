      /TITLE  ASOKON Vedlikehold av betalingsforslag.
     h datedit(*dmy) option(*nodebugio)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      * System  . . . . : ASOKON                                        *
      * Program . . . . : GL104R                                        *
      * Beskrivelse . . : Vedlikehold av betalingsforslag.              *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      * Spesialversjon. :                                               *
      * Tilpasset for . :                                               *
      *                                                                 *
      * Referanse  Dato   Endringsbeskrivelse                      Sign *
      * --------- ------  ----------------------------------------------*
      *           260694  Nytt program september-1994              RH   *
      *                                                                 *
      * E21118    211198  Tar med forslagnummer "ut" av programmet RH   *
      *                   som parameter.                           RH   *
      *                                                                 *
      * 28049     280499  Feil i parameterlista.                   RH   *
      *                                                                 *
      * 28049     280499  Det ble bruk valuta på faktura i steden  RH   *
      *                   for valuta på betaling.                  RH   *
      *                                                                 *
      * 22060     220600  Tester på om overføring er aktivt, før   RH   *
      *                   forslag blir overført til banken.        RH   *
      *                                                                 *
      * 27060     270600  Tatt bort feil som oppstod ved sletting  RH   *
      *                   av linjer i forslaget ved bruk av B2VALG RH   *
      *                   feltet.                                  RH   *
      *                                                                 *
      * 25070     250700  KEY02 innehold feil verdier ved bruk av  RH   *
      *                   B2VALG feltet.                           RH   *
      *                                                                 *
      * 25071     250701  Legger inn mulighet for å åpne "låst"    RH   *
      *                   forslag, p.g.a. at det er overført       RH   *
      *                                                                 *
T400  * V4.00     170402  Endret bibl. for copymember.             HFL  *
T5.00 * V5.00     151002  Endring i datofelt og key-felt.          HFL  *
T5.00 * V5.00     171002  Ikke lenger key i GUBFPF, bruker L8      HFL  *
T5.00 * V5.00     121102  Kaller RL101R istedet for RL011R.        HFL  *
      *                                                                 *
      *           230603  Lagt inn direkte les av RA16L1(valuta)   KOB  *
      *           060903  Endret datohandtering gjennomgående      KOB  *
      *           060903  Fjernet kontroller mot postgiro          KOB  *
      *           060903  Lagt om kontroll av mod10 - RÅ910R       KOB  *
      *           161003  Korrigert feil i forbindelse med slettingKOB  *
      *           161003  Endret antall siffer i srrnxx fra 4 til 5KOB  *
      *           161003  Endret antall siffer i spgexx fra 3 til 4KOB  *
      *                                                                 *
      * 07123     071203  Det skal IKKE renummereres automatisk    RH   *
      *                   når en post endres med "2".              RH   *
      *                   Renummerering skal kjøres ved bruk av    RH   *
      *                   "F"-taster (unntatt F3).                 RH   *
      *                                                                 *
      * 22123     221203  Legger ut en blinkende "F" når           RH   *
      *                   forslaget inneholder Feilretur.          RH   *
      *                                                                 *
      * 17024     171203  Tar vekk mod.kontroll.                   RH   *
      *                                                                 *
      * 18054     180504  Tester på om det finnes linjer med       RH   *
      *                   feilreturkode (GAREKO=F) i forslaget.    RH   *
      *                                                                 *
      * V5.40     030405  Nullstiller dato, tid og bruker på trans.KOB  *
      *                   dersom posten fjernes fra forslaget      KOB  *
      *                                                                 *
5.51  *  5.51     260106  Legger ut leverandørnavn i bildet.       RHO  *
      *                                                                 *
5.52  *  5.52     260106  Sender opp søkebildet over de ulike      RHO  *
5.52  *                   utbetalingsforslag når forslagsnummer    RHO  *
5.52  *                   IKKE er utfylt, OG det trykkes ENTER.    RHO  *
5.52  *                   Tidligere MÅTTE det trykkes "F4=Søk".    RHO  *
      *                                                                 *
22106 * 22106     221006  Legger ut "S" i KID-kode dersom det er   RHO  *
      *                   strukturert informasjon i posten. Dette  RHO  *
      *                   betinger selfølgelig at posten IKKE har  RHO  *
      *                   KID.                                     RHO  *
      *                                                                 *
10116 * 10116     101106  Tatt vekk "*Ukjent".                     RHO  *
      *                                                                 *
15037 * 15037     150307  Leverandørens fakturanummer ligger nå    RHO  *
      *                   i et eget felt-GALFAK i filen GUBFPF.    RHO  *
      *                   Gjør derfor om testen fra "22106".       RHO  *
      *                                                                 *
20028 * 20028     200208  Legger ut "*" i KID-feltet dersom Lev.-  RHO  *
      *                   fakturanumemr er utfylt, dvs på samme    RHO  *
      *                   måte som KID.                            RHO  *
      *                                                                 *
6.10  *           170809  Utregning endret med hensyn til          NHO  *
6.10  *                   omregning til norske kroner, ikke dele   NHO  *
6.10  *                   med 100                                       *
      *
6.10  *           041109  Det legges ut '*' ut i GAKIDS uansett.   NHO  *
6.10  *                   endret slik at dersom ikke kid og lev.   NHO  *
6.10  *                   faktnr er utfylt så legges det ut 'S'    NHO  *
6.20  *           171213  Fjernet all call til renummerering       NHO  *
6.30  *           171014  Ednret i skjermbilde pga jacada          bsa  *
6.31  *           260815  Endret teller ant linjer pga jacada      NHO  *
7.xx  * 7.00      251116  Endringer reltart til ny GUI. NB Kan kun BSA  *
7.xx  *                   gjelde DDS.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      *  BRUK AV INDIKATORER                                            *
      *                                                                 *
      *       KC = F3  = Exit                                           *
      *       KE = F5  = Forny                                          *
      *       KL = F12 = Annuller                                       *
      *                                                                 *
      *       LR = Avslutt program                                      *
      *       10 = Roll                                                 *
      *       12 = Sfldsp                                               *
      *       13 = Sfldspctl                                            *
      *       14 = Sflclr                                               *
      *       15 = Sflend                                               *
      *       16 = Readc 16 on, no more records                         *
      *       30 = Protect av felter ved vise                           *
      *    31-59 = Varsle m/feilmeldinger/skjermindikatorer             *
      *       38 = Varsler at forslaget ikke kan vedlikeholdes          *
      *            Det er allerede overført til samlefile/remittering   *
      *    60-62 = Fileindikatorer chain etc.                           *
      *    63-69 = Varsle v/feilmeldinger.                              *
      *    70-79 = Arbeidsindikatorer i sub-rutiner                     *
      *    80-89 = Arbeidsindikatorer ordinære                          *
      *    90-99 = Benyttes ved std. sub-rutiner                        *
      *                                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     frlbapf    if   e           k disk    rename(rlbapfr:rlbapfr)
22060fgfaspf    if   e           k disk    rename(gfaspfr:gfaspfr)
     fgubfl8    if   e           k disk    rename(gabfpfr:gabfpff)
     fgubflu    uf   e           k disk    rename(gabfpfr:gabfpfu)
E5.00fra16l1    if   e           k disk    rename(ra16pfr:ra16l1r)
E5.00frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
     fgudkpf    if   e           k disk    rename(gudkpfr:gudkpfr)
     frltrlu    uf   e           k disk    rename(rltrpfr:rltrlur)
     fgl104d    cf   e             workstn
     f                                     sfile(b1sfl:srrn01)
     f                                     sfile(c1sfl:srrn02)
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Definering av felter                                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      * Forklaring på spesielle felter
      * som benyttes ved sub-files.
      * - - - - - - - - - - - - - - - - -
      *     nn - er 01 for subfile 01,
      *             02 for subfile 02,
      *             03 for subfile 03, o.s.v.
      * SRRNnn - Relativt recordnummer i subfile
      * SPGEnn - Sidestørrelse i subfile (page)
      * SFRNnn - Første recordnummer på siden
      * SSRNnn - Siste  recordnummer på siden
      * SVRNnn - Vis den side som inneholder denne record.
      *
      * Forklaring på spesielle felter
      * som benyttes ved windows.
      * - - - - - - - - - - - - - - - - -
      *
      * w_arow - Actual line, angir startlinje for vindu.
      * w_acol - Actual posision, angir startposisjon for vindu
      *
      * Benyttede skjermbilder.
      * - - - - - - - - - - - - - - - - -
      *
      * B1SFL  - B1 Subfile - record
      * B2CTL  - B2 Subfile - control record
      * B2CMD  - B2 Eget skjermbilde for CMD-taster
      * C1SFL  - C1 Subfile - record
      * C2CTL  - C2 Subfile - control record - Viser RECORD
      * C2CMD  - C2 Eget skjermbilde for CMD-taster
      * C1BLD  - C1 Skjermbilde for Bet.forslagsnr.
      * C2BLD  - C2 Skjermbilde for Endre- / Vise post.
      * D1WIN  - D1 Vindu for slette (Delete)
      * E1WIN  - E1 Vindu for slette hele forslaget.
      * S1WIN  - S1 Standardvindu som inneholder definisjon av
      *             størrelse og utseende.  Bildene D1WIN og K1WIN
      *             er referert til dette.
      *
     d kid             s              1    dim(25)
     d nyki            s              1    dim(25)
     d tall            s              1    dim(24)
     d txt             s             71    dim(15) ctdata perrcd(1)
     d tx              s             15    dim(2) ctdata perrcd(1)
      /space 3
      *
      * Henter firmanavn.
      *
     d lda            uds
     d l_chgv                844    844
     d l_user                911    920
     d l_firm                944    946  0
     d l_fnav                951    980
      *
      /eject
      *
      * Datastruktur for subfileheader:
      *
     d                 ds
     d dssubh                        78
     d  dsdela                       34    overlay(dssubh)
     d  dsdelb                       44    overlay(dssubh:35)
      *
      * Datastruktur for parameterliste v/call av RL101R og
      * RL102C:
      *
     d                 ds
     d dslist                         6
     d  wpfirm                        3  0 overlay(dslist)
     d  wpbfnr                        3  0 overlay(dslist:4)
      *
      * Datastruktur for parameterliste v/call av GL140R
      *
     d                 ds
18054d d_lis2                        18
18054d  d_firm                        3  0 overlay(d_lis2)
18054d  d_bfnr                        3  0 overlay(d_lis2:4)
18054d  d_bfli                        5  0 overlay(d_lis2:7)
18054d  d_koin                        1    overlay(d_lis2:12)
18054d  d_kout                        1    overlay(d_lis2:13)
18054d  d_anfe                        5  0 overlay(d_lis2:14)
      *
     d b1kidi          s              1
     d c2beva          s                   like(gabeva)
     d c2kids          s                   like(gakids)
     d c3rbn1          s                   like(robelØ)
     d c3rbn2          s                   like(robelØ)
     d c3rbn3          s                   like(robelØ)
     d c3rbv1          s                   like(robelØ)
     d c3rbv2          s                   like(robelØ)
     d c3rbv3          s                   like(robelØ)
     d difktr          s              2  0
     d divtal          s              2  0
     d en              s              1  0
     d faktor          s              1  0
     d ktr             s              1
     d plevnr          s              6
     d prod            s              2  0
     d prod1           s              1  0
     d prod2           s              1  0
     d psum            s              3  0
     d rest            s              2  0
     d sfrn01          s                   like(srrn01)
     d sfrn02          s                   like(srrn02)
     d siffs           s              3  0
     d*spge01          s              3  0
     d*spge02          s              3  0
     d spge01          s              4  0
     d spge02          s              4  0
     d*srrn01          s              4  0
     d*srrn02          s              4  0
     d srrn01          s              5  0
     d srrn02          s              5  0
     d ssrn01          s                   like(srrn01)
     d ssrn02          s                   like(srrn02)
     d tell            s              1  0
     d v               s              2  0
     d vekt            s              1  0
     d w               s              2  0
     d w_arow          s              2  0
     d w_acol          s              3  0
     d wpakti          s              1
     d wpavik          s             15  2
     d wpavin          s             15  2
     d wpavip          s             15  2
     d wpbfli          s                   like(gabfli)
     d wpblan          s              2
     d wpbl24          s             24
     d wpendr          s              1
     d wpfinr          s              3  0
     d wpin03          s              1  0
     d wpin12          s              1  0
     d wpklan          s             11  2
     d wpklav          s             11  2
     d wplevr          s                   like(galevr)
     d wplinj          s              5  0
     d wpload          s              1
     d wpluft          s              2
     d wpmtyp          s             20
     d wpnume          s              2
     d wpparm          s              1
     d wprabb          s              3
     d wpsist          s              1
     d wpvalg          s              1  0
     d wwbfnr          s              3  0
     d x               s              2  0
T5.00d w_bdat          s                   like(gabdat)
T5.00d w_fdat          s                   like(gafdat)
     d ra16l1_pkod     s                   like(rapkod)
      *
7.xx d c_sepw          c                   const(X'22')
7.xx d c_sepg          c                   const(X'20')
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * B2CTL Behandle åpningsbildet med subfile                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      * Send Alt
      *
     c     b2taga        tag
      *
      * Avslutt program ved F03.
      *
     c                   write     b2cmd
      *
      * Bare data
      *
     c     b2tagb        tag
      *
      * Avslutt program ved F12.
      *
     c                   exsr      xdsp01
      *
      * F2=Registrering av bet.forslagnummer.
      *
     c                   if        *inkb = *on
      *
      * Tester om renummerering først skal kjøres.
      * Renummerering kjøres ikke dersom utplukket er overført
      * til banken, eller når forslaget er en lønnskjøring:
      *
     c                   if        wpendr <> *blanks
     c                             and wpparm <> 'L'
     c                             and *in38 <> *on
6.20 c***                call      'GL101R'
6.20 c***                parm                    dslist
      *
     c                   eval      wpendr = *blanks
     c                   endif
      *
     c     b2tagc        tag
     c                   exfmt     c1bld
      *
      * F3=Avslutt program:
      *
     c     *inkc         cabeq     *on           xslutt
      *
      * Søk:
      *
     c                   if        *inkd = *on
5.52 c                             or  c1bfnr = 0
     c                   exsr      xsØke
     c                   endif
      *
     c                   eval      wpbfnr = c1bfnr
     c                   eval      b2bfnr = c1bfnr
     c                   eval      wpbfli = 0
     c                   move      *off          *in38
      *
      * Tester på om forslag inneholder feilretur:
      *
18054c                   eval      d_bfli = b2bfli
18054c                   exsr      xfeil
      *
      * Tester på om forslag finnes:
      *
E5.00c     gubfl8_key    chain     gubfl8
      *
     c                   if        not%found
     c                   goto      b2tagc
     c                   endif
      *
      * Når forslag er overført, blir GASTAT merket med "G"
      * Når det mottas returer blir feltet GAREKO merket med
      * "F" dersom feilretur og "1" ved 1.gangsretur.  Forslaget
      * skal ikke kunne vedlikeholdes før det er mottatt en ev
      * feilretur.  Da skal kun aktuelle linjer kunne endres:
      *
E5.00c     gubfl8_key    setll     gubfl8
E5.00c     gubfl8_key    reade     gubfl8                                 60
     c                   dow       *in60 = *off
     c                   if        gastat = 'G'
     c                   move      *on           *in38
     c                   move      *on           *in60
     c                   else
E5.00c     gubfl8_key    reade     gubfl8                                 60
     c                   endif
     c                   enddo
      *
E5.00c     gubfl8_keya   setll     gubfl8
     c                   exsr      xclr01
     c                   exsr      xcrt01
     c                   goto      b2taga
     c                   endif
      *
      * F3=Avslutt program i fra subfile program.
      *
     c     *inkc         cabeq     *on           xslutt
      *
      * Forny
      *
     c                   if        *inke = *on
     c                   exsr      xinke
     c                   if        sfrn01 <> *zero
     c                   goto      b2tagb
     c                   else
     c                   goto      b2taga
     c                   endif
      *
     c                   endif
      *
      * F6=Slette betalingsforslaget.
      *
     c                   if        *inkf = *on
      *
      * *IN38 er på dersom forslaget allerede er overført til
      * samlefile/remittering.  Feilmelding sendes dersom det
      * velges "F6=Slette forslag".
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 30
     c                   exfmt     e1win
      *
      * Avslutt sletteprosess ved F3.
      * Avslutt program ved F12.
      *
     c     *inkc         cabeq     *on           b2taga
      *
      * Sender ny advarsel dersom forslaget er sperret:
      *
     c                   if        *in38 = *on
     c                   eval      w_arow = 6
     c                   eval      w_acol = 20
     c                   exfmt     y1win
     c     *inkc         cabeq     *on           b2taga
     c                   endif
      *
     c                   exsr      xe1win
     c                   goto      b2taga
     c                   endif
      *
      * F8=Endre dato for belastning av lønnsutbetaling:
      *
     c                   if        *inkh = *on and
     c                             wpparm = 'L'
      *
     c                   if        *in38 = *on
     c                   move      *on           *in67
     c                   goto      b2tagb
     c                   endif
      *
      * Legger ut i vindu gjeldende dato:
      *
     c     *dmy          move      gafdat        f1dato
      *
      * Sender opp window for å legge inn ny dato:
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 39
     c     f1tag         tag
      *
     c                   exfmt     f1win
      *
     c     *inkc         cabeq     *on           b2tagb
      *
      * Tester om ny lønnsutbetalingsdato er gyldig:
      *
     c     *dmy          test(d)                 f1dato                 44
      *
     c                   if        *in44
     c                   goto      f1tag
     c                   endif
      *
      * Ny dato for lønnsutbetaling er OK, og dato kan nå
      * endres på alle transaksjoner i forslaget:
      *
     c     gubflu_key    setll     gubflu
     c     gubflu_key    reade     gubflu                                 60
      *
     c                   dow       *in60 = *off
      *
T5.00c     *dmy          move      f1dato        gafdat
      *
     c                   update    gabfpfu
      *
     c     gubflu_key    reade     gubflu                                 60
     c                   enddo
      *
      * Fyller opp subfile, og sender opp vindu på nytt:
      *
     c                   eval      wpbfli = 0
E5.00c     gubfl8_keya   setll     gubfl8
     c                   exsr      xclr01
     c                   exsr      xcrt01
     c                   goto      b2tagb
      *
     c                   endif
      *
      * F7 Hent linje for feilretur:
      *
18054c                   if        *inkg = *on
18054c                   eval      d_koin = '7'
      *
      *  Innnholdet i B2BFLI vil alltid være startposisjon for søk:
      *
18054c                   eval      d_bfli = b2bfli
      *
18054c                   exsr      xfeil
18054c                   eval      b2bfli = d_bfli
18054c                   goto      b2taga
18054c                   endif
      *
      * F8 kan kun brukes v/Lønnstransaksjoner:
      *
     c                   if        *inkh = *on and
     c                             wpparm <> 'L'
     c                   move      *on           *in45
     c                   goto      b2tagb
     c                   endif
      *
      * F10=Utskrift av utbetalingsforslag.
      *
     c                   if        *inkj = *on
      *
      * Tester om renummerering først skal kjøres.
      * Renummerering kjøres ikke dersom utplukket er overført
      * til banken, eller når forslaget er en lønnskjøring:
      *
     c                   if        wpendr <> *blanks and
     c                             wpparm <> 'L' and
     c                             *in38 <> *on
6.20 c***                call      'GL101R'
6.20 c***                parm                    dslist
      *
     c                   eval      wpendr = *blanks
     c                   endif
      * l_chgv="1" forteller at formularparametre skal
      * kunne endres på skjermen før utskrift starter.
     c                   movel     '1'           l_chgv
     c                   out       *dtaara
      *
     c                   call      'GL102C'
     c                   parm                    dslist
     c                   parm                    wpin12
     c                   parm                    wpparm
      *
     c                   goto      b2tagb
     c                   endif
      *
      * F11=Overføring av betalingsforslag til bank:
      *
     c                   if        *inkk = *on
      *
      * Tester på om kommunikasjon til banken er aktiv.  Den kan
      * ikke være aktiv av andre rutiner:
      *
22060c                   eval      wpakti = *blanks
      *
22060c     l_firm        chain     gfaspf
      *
22060c                   if        %found and
22060c                             gefkom <> 'PC  ' and
22060c                             gefsam <> 'J'
22060c                   call      'GL156C'
22060c                   parm                    wpakti
      *
22060c     wpakti        cabeq     '1'           xny
22060c                   endif
      *
      * Tester om renummerering først skal kjøres.
      * Renummerering kjøres ikke dersom utplukket er overført
      * til banken, eller når forslaget er en lønnskjøring:
      *
     c                   if        wpendr <> *blanks and
     c                             wpparm <> 'L' and
     c                             *in38 <> *on
      * Renummerere:
6.20 c***                call      'GL101R'
6.20 c***                parm                    dslist
     c                   eval      wpendr = *blanks
     c                   endif
      * Overføre:
     c                   if        wpbfnr <> 0
     c                   call      'GL105C'
     c                   parm                    wpbfnr
     c                   endif
      *
      * Kontroll på om forslaget ble overført:
      *
E5.00c     gubfl8_key    setll     gubfl8
E5.00c     gubfl8_key    reade     gubfl8                                 60
      *
     c                   dow       *in60 = *off
     c                   if        gastat = 'G'
     c                   move      *on           *in38
     c                   move      *on           *in60
     c                   else
E5.00c     gubfl8_key    reade     gubfl8                                 60
     c                   endif
     c                   enddo
      *
      * Forny:
22060c     xny           tag
     c                   exsr      xinke
     c                   goto      b2taga
     c                   endif
      *
      * F14=Åpne låst forslag:
      *
25071c                   if        *inkn = *on and
25071c                             *in38 = *on
      * Sende "Advarsel":
25071c                   eval      w_arow = 4
25071c                   eval      w_acol = 30
25071c                   exfmt     i1win
      *
      * Avslutt sletteprosess dersom det trykkes noe annet
      * enn F6 for bekreftelse:
      *
25071c     *inkf         cabeq     *off          b2taga
      *
      * Blanke koden GASTAT:
      *
25071c                   exsr      xinkn
      * Forny av bildet:
25071c                   exsr      xinke
25071c                   goto      b2taga
      *
25071c                   endif
      *
      * Roll
      *
     c                   if        *in10 = *on
E5.00c     gubfl8_keyb   setll     gubfl8
E5.00c     gubfl8_keyb   reade     gubfl8                                 15
     c                   exsr      xcrt01
     c                   goto      b2tagb
     c                   endif
      *
      * Tester på at kun "5" er tillatt i B2VALG dersom det
      * er lønnstransaksjoner som behandles:
      *
     c                   if        wpparm = 'L' and
     c                             b2valg <> *blank and
     c                             b2valg <> '5'
     c                   eval      b2valg = *blanks
     c                   eval      b2bfli = 0
     c                   move      *on           *in43
     c                   goto      b2tagb
     c                   endif
      *
      * Posisjoner
      * startverdi
      *
     c                   if        b2valg = *blank and
     c                             b2bfli <> *zero
     c                   eval      wpbfli = b2bfli
E5.00c     gubfl8_keya   setll     gubfl8
     c                   exsr      xclr01
     c                   exsr      xcrt01
     c                   eval      b2bfli = 0
     c                   goto      b2tagb
     c                   endif
      *
      * Tester på om linjvalg. er valgt uten å angi linjenummer:
      *
     c                   if        b2valg <> ' ' and
     c                             b2bfli = *zero
     c                   move      *on           *in31
     c                   goto      b2tagb
     c                   endif
      *
      * Slå opp
      * i filen
      *
T5.20c                   if        b2bfli <> 0
     c                   eval      wpbfli = b2bfli
E5.00c     gubfl8_keya   chain     gubfl8
      *
      * Post finnes ikke
      *
     c                   if        not%found and
     c                             b2valg = '2' or
     c                             b2valg = '4' or
     c                             b2valg = '5' or
     c                             b2valg = 'L' or
     c                             b2valg = 'F' or
     c                             b2valg = 'A' or
     c                             b2valg = 'T'
     c                   move      *on           *in32
     c                   goto      b2tagb
     c                   endif
T5.20c                   endif
      *
      * Ikke tillatt å endre når post er overført bank OG retur
      * ikke er mottatt, ELLER at 1. gangsretur ER mottatt:
      *
     c                   if        gastat = 'G' and
     c                             gareko = *blank or
     c                             gareko = '1'
      *
     c                   if        b2valg = '2' or
     c                             b2valg = '4' or
     c                             b2valg = 'A' or
     c                             b2valg = 'T'
     c                   move      *on           *in42
     c                   goto      b2tagb
     c                   endif
      *
     c                   endif
      *
      * Endre
      *
     c                   if        b2valg = '2'
     c                   eval      c2bfli = b2bfli
     c                   exsr      xc2bld
     c                   if        wpendr = 'J'
     c                   exsr      xinke
     c                   if        sfrn01 <> *zero
     c                   goto      b2tagb
     c                   endif
     c                   endif
     c                   goto      b2taga
     c                   endif
      *
      * Slette
      *
     c                   if        b2valg = '4'
27060c                   eval      wpbfli = b2bfli
     c                   exsr      xd1win
     c                   endif
      *
      * Vise
      *
     c                   if        b2valg = '5'
     c                   move      *on           *in30
     c                   eval      c2bfli = b2bfli
     c                   exsr      xc2bld
     c                   goto      b2taga
     c                   endif
      *
      * Avtalt kurs:
      *
     c                   if        b2valg = 'A'
     c                   eval      wpbfli = b2bfli
     c                   exsr      xg1win
      *
      * WPLOAD blir satt til "1" dersom det er lagt inn
      * avtalt kurs på fler enn 1 faktura i subrutinen
      * XG1WIN.  Dette medfører at subfile må oppdateres
      * på nytt med innhold i fra betalingsforslagsfile:
      *
     c                   if        wpload = '1'
     c                   eval      wpload = *blank
     c                   exsr      xinke
     c                   endif
      *
     c                   goto      b2tagb
     c                   endif
      *
      * Terminkontrakt:
      *
     c                   if        b2valg = 'T'
     c                   eval      wpbfli = b2bfli
     c                   exsr      xh1win
      *
      * WPLOAD blir satt til "1" dersom det er lagt inn
      * terminkontrakt på FLERE ENN 1 faktura i subrutinen
      * XH1WIN.  Dette medfører at subfile må oppdateres
      * på nytt med innhold i fra betalingsforslagsfile:
      *
     c                   if        wpload = '1'
     c                   eval      wpload = *blank
     c                   exsr      xinke
     c                   endif
      *
     c                   goto      b2tagb
     c                   endif
      *
      * Valutakonto:
      *
     c                   if        b2valg = 'V'
     c                   eval      wpbfli = b2bfli
     c                   exsr      xv1win
      *
      * WPLOAD blir satt til "1" dersom det er lagt inn
      * terminkontrakt på FLERE ENN 1 faktura i subrutinen
      * XH1WIN.  Dette medfører at subfile må oppdateres
      * på nytt med innhold i fra betalingsforslagsfile:
      *
     c                   if        wpload = '1'
     c                   eval      wpload = *blank
     c                   exsr      xinke
     c                   endif
      *
     c                   goto      b2tagb
     c                   endif
      *
      * Leverandør
      *
     c                   if        b2valg = 'L'
     c                   eval      wpbfli = b2bfli
E5.00c     gubfl8_keya   chain     gubfl8
      *
     c                   if        %found
N5.00c                   call      'RL101R'
     c                   parm                    b1levr
     c                   parm                    wpvalg
     c                   endif
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
      *
     c                   goto      b2taga
     c                   endif
      *
      * Factoringinformasjon:
      *
     c                   if        b2valg = 'F'
     c                   eval      wpbfli = b2bfli
E5.00c     gubfl8_keya   chain     gubfl8
      *
     c                   if        %found
E5.00c     rlevl1_key    chain     rlevl1
      *
     c                   if        %found and
     c                             rlfact <> 0
N5.00c                   call      'RL101R'
     c                   parm                    rlfact
     c                   parm                    wpvalg
     c                   endif
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
      *
     c                   if        rlfact = 0
     c                   move      *on           *in41
     c                   goto      b2tagb
     c                   endif
      *
     c                   endif
      *
     c                   goto      b2taga
     c                   endif
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Behandling av subfile                                           *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      * Sjekk om valg
      * er foretatt i
      * subfile
      *
     c                   do        ssrn01
     c                   readc     b1sfl                                  16
      *
     c                   if        *in16 = *on
      *
      * Tester på om forslagsfile skal leses inn i subfile
      * på nytt:
      *
     c                   if        wpload = '1'
     c                   eval      wpload = *blank
     c                   exsr      xinke
     c                   endif
      *
     c                   leave
     c                   endif
      *
      * Post kan ikke endres eller slettes dersom forslaget er
      * overført remittering, d.v.s. *IN38 er *ON, og returkode
      * er blank eller 1 (1.gangsretur):
      *
     c                   if        b1valg = '2' or
     c                             b1valg = '4' or
     c                             b1valg = 'A' or
     c                             b1valg = 'T' or
     c                             b1valg = 'V'
      *
      * Ikke tillatt å endre når post er overført bank OG retur
      * ikke er mottatt, ELLER at 1. gangsretur ER mottatt:
      *
     c                   if        b1stat = 'G' and
     c                             b1reko = *blank or
     c                             b1reko = '1'
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   move      *on           *in42
     c                   goto      b2tagb
     c                   endif
      *
     c                   endif
      *
      * Post er kun tillatt å vise dersom lønnstransakjon:
      *
     c                   if        wpparm = 'L' and
     c                             b1valg <> ' ' and
     c                             b1valg <> '5'
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   move      *on           *in43
     c                   goto      b2tagb
     c                   endif
      *
      * Endre post
      *
     c                   if        b1valg = '2'
      * Post kan ikke endres når 1.g. retur er mottatt:
     c                   if        b1reko <> '1'
     c                   eval      c2bfli = b1bfli
     c                   eval      wpbfli = b1bfli
     c                   exsr      xc2bld
     c                   else
     c                   move      *on           *in66
     c                   endif
     c                   iter
      *
     c                   endif
      *
      * Slette post
      *
     c                   if        b1valg = '4'
     c                   eval      wpbfli = b1bfli
     c                   exsr      xd1win
     c                   iter
     c                   endif
      *
      * Vise post
      *
     c                   if        b1valg = '5'
     c                   move      *on           *in30
     c                   eval      c2bfli = b1bfli
     c                   eval      wpbfli = b1bfli
     c                   exsr      xc2bld
     c                   iter
     c                   endif
      *
      * Avtalt kurs:
      *
     c                   if        b1valg = 'A'
     c                   eval      wpbfli = b1bfli
     c                   exsr      xg1win
      *
      * Tester på om feilmelding skal sendes opp:
      *
     c                   if        *in47 = *on or
     c                             *in48 = *on  or
     c                             *in56 = *on  or
     c                             *in66 = *on
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   goto      b2tagb
     c                   endif
      *
     c                   endif
      *
      * Terminforretning:
      *
     c                   if        b1valg = 'T'
     c                   eval      wpbfli = b1bfli
     c                   exsr      xh1win
      *
      * Tester på om feilmelding skal sendes opp:
      *
     c                   if        *in46 = *on or
     c                             *in49 = *on or
     c                             *in56 = *on
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   goto      b2tagb
     c                   endif
      *
     c                   endif
      *
      * Valutakonto:
      *
     c                   if        b1valg = 'V'
     c                   eval      wpbfli = b1bfli
     c                   exsr      xv1win
      *
      * Tester på om feilmelding skal sendes opp:
      *
     c                   if        *in48 = *on or
     c                             *in49 = *on or
     c                             *in52 = *on or
     c                             *in53 = *on or
     c                             *in54 = *on or
     c                             *in55 = *on
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   goto      b2tagb
     c                   endif
      *
     c                   endif
      *
      * Hente leverandør- eller factoringinformasjon:
      *
     c                   if        b1valg = 'L' or
     c                             b1valg = 'F'
      *
      * Leverandør
      *
     c                   if        b1valg = 'L'
     c                   move      *on           *in30
     c                   eval      wplevr = b1levr
      *
E5.00c                   call      'RL101R'
     c                   parm                    b1levr
     c                   parm                    wpvalg
      *
     c                   endif
      *
      * Factoringinformasjon:
      *
     c                   if        b1valg = 'F'
     c                   eval      galevr = b1levr
      *
E5.00c     rlevl1_key    chain     rlevl1
      *
     c                   if        %found and
     c                             rlfact <> 0
N5.00c                   call      'RL101R'
     c                   parm                    rlfact
     c                   parm                    wpvalg
     c                   endif
      *
     c                   if        rlfact = 0
     c                   move      *on           *in41
     c                   goto      b2tagb
     c                   endif
      *
     c                   endif
      *
     c                   if        b1valg = 'L' or
     c                             b1valg = 'F'
     c                   move      srrn01        w_virn
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
      *
     c                   iter
      *
     c                   endif
      *
      *
     c                   enddo
      *
     c                   goto      b2taga
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Avslutt program                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xslutt        tag
      *
      * Tester om renummerering skal kjøres.
      * Renummerering kjøres ikke dersom utplukket er overført
      * til banken, eller når forslaget er en lønnskjøring:
      *
     c                   if        wpendr <> *blanks and
     c                             wpparm <> 'L' and
     c                             *in38 <> *on
6.20 c***                call      'GL101R'
6.20 c***                parm                    dslist
      *
     c                   eval      wpendr = *blanks
     c                   endif
      *
     c                   eval      *inlr = *on
     c                   return
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * C2BLD Behandle bilde for Endring / Vise                         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xc2bld        begsr
      *
E5.00c     gubfl8_keya   chain     gubfl8
      *
     c                   if        %found
     c                   movel     txt(2)        c2nyen
     c                   movel     gastat        c2stat
     c                   eval      c2levr = galevr
     c     *dmy          move      gabdat        c2bdat
E5.00c                   eval      c2tist = gatist
     c                   movel     gavalk        c2valk
     c                   movel     gafval        c2fval
     c                   movel     gaatts        c2atts
     c                   eval      c2bilk = gabilk
     c                   eval      c2belØ = gabelØ
     c                   eval      c2rest = garest
     c                   eval      c2biln = gabiln
     c                   eval      c2valb = gavalb
     c                   eval      c2valr = gavalr
     c                   movel     gabetk        c2betk
     c                   eval      c2raar = garaar
     c                   eval      c2rper = garper
     c                   eval      c2jour = gajour
     c                   eval      c2samb = gasamb
     c                   eval      c2refn = garefn
     c                   movel     gatext        c2text
     c                   movel     gavirk        c2virk
      *
     c     *dmy          move      gafdat        c2fdat
      *
     c                   movel     gadeck        c2deck
     c                   eval      c1rtx1 = *blanks
     c                   eval      c1rtx2 = *blanks
      *
      * Finner deklarasjonstekst dersom koden er utfylt:
      *
     c                   if        gadeck <> *blanks
     c     gadeck        chain     gudkpf
      *
     c                   if        %found
     c                   movel     gdrtx1        c1rtx1
     c                   movel     gdrtx2        c1rtx2
     c                   else
     c                   eval      c1rtx1 = *blanks
     c                   movel     '*UKJENT'     c1rtx1
     c                   eval      c1rtx2 = *blanks
     c                   endif
     c                   endif
      *
     c                   eval      c2bfnr = gabfnr
     c                   eval      c2bfli = gabfli
     c                   movel     gakidi        c2kidi
15037c                   movel     galfak        c3lfak
     c                   eval      c2avde = gaavde
     c                   movel     garekl        c2rekl
     c                   eval      c2delb = gadelb
     c                   eval      c2betb = gabetb
     c                   movel     garemk        c2remk
      *
     c     *dmy          move      gaopfd        c3opfo
      *
     c                   eval      c3rbn1 = garbn1
     c                   eval      c3rbv1 = garbv1
     c                   eval      c3rbn2 = garbn2
     c                   eval      c3rbv2 = garbv2
     c                   eval      c3rbn3 = garbn3
     c                   eval      c3rbv3 = garbv3
     c                   eval      c3opbn = gaopbn
     c                   eval      c3opbv = gaopbv
      *
     c                   if        garda1 = *loval
     c                   eval      c3rda1 = 0
     c                   else
     c     *dmy          move      garda1        c3rda1
     c                   endif
      *
     c                   if        garda2 = *loval
     c                   eval      c3rda2 = 0
     c                   else
     c     *dmy          move      garda2        c3rda2
     c                   endif
      *
     c                   if        garda3 = *loval
     c                   eval      c3rda3 = 0
     c                   else
     c     *dmy          move      garda3        c3rda3
     c                   endif
      *
      * Beregner Til utbetaling leverandør, fratrukket ev. rabatt
      * (Nullstiller førts feltene, før det videre blir testet på
      *  om det finnes rabatta):
      *
     c                   eval      c3run1 = 0
     c                   eval      c3ruv1 = 0
     c                   eval      c3run2 = 0
     c                   eval      c3ruv2 = 0
     c                   eval      c3run3 = 0
     c                   eval      c3ruv3 = 0
      *
     c                   if        garbn1 <> 0
     c                   eval      c3run1 = gaopbn + garbn1
     c                   eval      c3ruv1 = gaopbv + garbv1
     c                   endif
      *
     c                   if        garbn2 <> 0
     c                   eval      c3run2 = gaopbn + garbn2
     c                   eval      c3ruv2 = gaopbv + garbv2
     c                   endif
      *
     c                   if        garbn3 <> 0
     c                   eval      c3run3 = gaopbn + garbn3
     c                   eval      c3ruv3 = gaopbv + garbv3
     c                   endif
      *
      * POST FINNES IKKE:
      *
     c                   else
     c                   goto      c2tag1
     c                   endif
      *
     c                   if        *in30 = *on
     c                   movel     txt(3)        c2nyen
     c                   endif
      *
     c     c2taga        tag
      *
      * Send opp bilde nr. 1 av 2.
      *
     c                   exfmt     c2bld
      *
      * Avbryte:
      *
     c     *inkc         cabeq     *on           c2tag1
      *
      * Vedlikehold av valutakurser:
      *
     c                   if        *inkh = *on
     c                   eval      wpfinr = l_firm
     c                   call      'RA116R'
     c                   goto      c2taga
     c                   endif
      *
      * Legge inn rabatt.  Kun tillatt dersom det ikke er i VIS-modus:
      *
     c                   if        *inki = *on
     c                             and *in30 = *off
     c                   eval      w_arow = 4
     c                   eval      w_acol = 2
     c                   exfmt     x1win
      *
      * Legger inn valgt rabatt:
      *
     c                   if        x1valg = '1'
     c                   eval      c2belØ = gaopbn + c3rbn1
     c                   eval      c2valb = gaopbv + c3rbv1
     c                   else
     c                   if        x2valg = '2'
     c                   eval      c2belØ = gaopbn + c3rbn2
     c                   eval      c2valb = gaopbv + c3rbv2
     c                   else
     c                   if        x3valg = '3'
     c                   eval      c2belØ = gaopbn + c3rbn3
     c                   eval      c2valb = gaopbv + c3rbv3
     c                   endif
     c                   endif
     c                   endif
      *
     c                   eval      x1valg = *blanks
     c                   eval      x2valg = *blanks
     c                   eval      x3valg = *blanks
      *
      * Sender opp bildet på nytt, nå med nye verdier:
      *
     c                   goto      c2taga
      *
     c                   endif
      *
      * Skrur av indikatorer som brukes i testene:
      *
     c                   move      *off          *in65
      *
      * Tester om forfallsdato er gyldig + ev. gyldig trukket rabatt
      *
     c                   exsr      xc2tst
      *
      * Sender feilmelding:
      *
     c     *in33         cabeq     *on           c2taga
     c     *in34         cabeq     *on           c2taga
     c     *in36         cabeq     *on           c2taga
     c     *in37         cabeq     *on           c2taga
     c     *in57         cabeq     *on           c2taga
     c     *in58         cabeq     *on           c2taga
     c     *in59         cabeq     *on           c2taga
     c     *in63         cabeq     *on           c2taga
     c     *in65         cabeq     *on           c2taga
      *
      * Tester om KID-felt er gyldig.  *IN30=*ON -> er i vis-modus
      *
     c                   if        *in30 = *off
     c                   if        c2kidi = *blanks
     c                   eval      c2kids = *blanks
     c                   else
     c                   exsr      xkidts
     c                   endif
     c                   endif
      *
     c     *in35         cabeq     *on           c2taga
      *
      * Send opp bilde nr. 2 av 2.
      *
     c                   exfmt     c3bld
      *
     c     *inkc         cabeq     *on           c2tag1
      *
      * Gå videre dersom "vis".
      *
     c     *in30         cabeq     *on           c2tag1
      *
     c     gubflu_keya   chain     gubflu
      *
     c                   if        %found
      *
      * Ved endring av BELØP, BETALINGSDATO eller VALUTAKODE,
      * så må renummerering kjøres:
      *
     c     *dmy          move      c2fdat        w_fdat
      *
     c                   if        c2belØ <> gabelØ or
     c                             w_fdat <> gafdat or
     c                             c2beva <> gabeva
     c                   movel     'J'           wpendr
     c                   endif
      *
      * Overfører felter:
      *
     c                   movel     c2stat        gastat
     c                   eval      galevr = c2levr
E5.00c                   eval      gatist = c2tist
     c                   movel     c2valk        gavalk
     c                   movel     c2atts        gaatts
     c                   eval      gabilk = c2bilk
     c                   eval      gabelØ = c2belØ
     c                   eval      garest = c2belØ
     c                   eval      gabiln = c2biln
     c                   eval      gavalb = c2valb
     c                   eval      gavalr = c2valb
     c                   movel     c2valk        gavalk
     c                   movel     c2beva        gabeva
     c                   movel     c2betk        gabetk
     c                   eval      garaar = c2raar
     c                   eval      garper = c2rper
     c                   eval      gajour = c2jour
     c                   eval      gasamb = c2samb
     c                   eval      garefn = c2refn
     c                   movel     c2text        gatext
     c                   movel     c2virk        gavirk
     c                   eval      garrf1 = c2rrf1
     c                   eval      garrf2 = c2rrf2
     c                   movel     c2deck        gadeck
     c                   eval      gabfnr = c2bfnr
     c                   eval      gabfli = c2bfli
      *
     c                   eval      gaavde = c2avde
     c                   movel     c2rekl        garekl
     c                   eval      gadelb = c2delb
     c                   eval      gabetb = c2betb
     c     *dmy          move      c2bdat        gabdat
     c                   eval      garabb = *blanks
     c                   movel     c2kidi        gakidi
     c                   movel     c2kids        gakids
15037c                   movel     c3lfak        galfak
      *
      * Venstrejusterer innhold av KID-feltet:
      *
     c                   if        gakids = '*'
     c                   exsr      xvenst
     c                   endif
22106 *
22106 * Legger ut "S" (for STRUKTURERT) dersom det IKKE er KID, MEN
22106 * at leverandørs fakturanummer er utfylt:
22106 *
22106c                   if        gakids <> '*'
      *
15037c                   if        galfak <> *blanks
6.10 c                   movel     'S'           gakids
15037c                   endif
      *
22106c                   endif
      *
      * Dersom fakturabeløp C2BELØ er mindre enn opprinnelig
      * beløp GAOPBN, så er det trukket rabatt.
      *
     c                   if        gabelØ > 0 and
     c                             gaopbn > c2belØ
     c                   movel     'R'           garabb
     c                   endif
      *
T5.00c     *dmy          move      c2fdat        gafdat
      *
     c                   update    gabfpfu
     c                   endif
      *
      * Oppdater subfile
      *
     c                   if        b1valg = '2'
     c                   eval      b1bfli = c2bfli
     c                   eval      b1belØ = c2belØ
     c                   movel     c2text        b1text
     c                   eval      b1fdat = c2fdat
     c                   eval      b1fdat = c2fdat
E5.00c                   eval      b1bdat = gabdat
     c                   eval      b1biln = c2biln
     c                   eval      b1levr = c2levr
     c                   movel     garabb        b1rabb
     c                   movel     gakids        b1kidi
     c                   movel     gavalk        b1valk
      *
      * Valutakonto skal brukes dersom forskjell mellom
      * valutatype på faktura og betaling:
      *
     c                   if        gafval <> gavalk
     c                   movel     'V'           b1avte
     c                   endif
      *
      * Oppdater hele forslaget med valutakonto, hvor det er
      * lik leverandør, betalingsdato og betalingsvaluta:
      *
     c     gubflu_key    setll     gubflu
     c     gubflu_key    reade     gubflu                                 60
      *
     c                   dow       *in60 = *off
      *
     c                   if        c2valk <> c2fval and
     c                             gavalk = c2valk and
     c                             galevr = c2levr and
     c                             gafdat = w_fdat and
     c                             gavalk <> *blanks
      *
     c                   move      'J'           gabeva
     c                   eval      gaavtm = *blanks
     c                   eval      gaavtk = 0
     c                   eval      gatenr = *blanks
     c                   eval      gateku = 0
      *
     c                   update    gabfpfu
      * Post finnes ikke:
     c                   else
     c                   unlock    gubflu
     c                   endif
      *
     c     gubflu_key    reade     gubflu                                 60
      *
      * Setter flagg for reload av subfile:
      *
     c                   if        *in60 = *on
07123c***                move      '1'           wpload
     c                   endif
      *
     c                   enddo
      *
     c                   endif
      *
     c     c2tag1        tag
      *
     c                   if        b1valg = '2' or
     c                             b1valg = '5'
     c                   move      srrn01        w_virn
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
     c                   move      *off          *in30
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * V1WIN - Valutakonto:                                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xv1win        begsr
      *
      * Henter opp informasjon i fra file:
      *
E5.00c     gubfl8_keya   chain     gubfl8
      *
      * Tester på at Terminkontrakt er null dersom Valutakonto
      * skal brukes:
      *
     c                   if        %found and
     c                             b2valg = 'V' and
     c                             gateku <> 0
     c                   move      *on           *in48
     c                   goto      v1tag3
     c                   endif
      *
     c                   if        %found and
     c                             b2valg = 'V' and
     c                             gaavtk <> 0
     c                   move      *on           *in49
     c                   goto      v1tag3
     c                   endif
      *
     c                   if        b1valg = 'V' and
     c                             b1teku <> 0
     c                   move      *on           *in48
     c                   goto      v1tag3
     c                   endif
      *
     c                   if        b1valg = 'V' and
     c                             b1avtk <> 0
     c                   move      *on           *in49
     c                   goto      v1tag3
     c                   endif
      *
      * Tester på at valutakode er ulik NOK/blank dersom det
      * ønskes å legge inn Valutakonto:
      *
     c                   if        %found and
     c                             b2valg = 'V'
     c                   if        gavalk = *blanks or
     c                             gavalk = 'NOK'
     c                   move      *on           *in52
     c                   goto      v1tag3
     c                   endif
     c                   endif
      *
     c                   if        b1valg = 'V' and
     c                             b1valk = *blanks
     c                             or b1valk = 'NOK'
     c                   move      *on           *in52
     c                   goto      v1tag3
     c                   endif
      *
      * Verdier må legges inn i KEY ved valg via subfile:
      *
     c                   if        b1valg = 'V'
     c                   eval      gafirm = l_firm
     c                   eval      galevr = b1levr
     c                   endif
      *
      * Henter bankinfo. på leverandør for å kontrollerer om
      * valutakonto skal benyttes:
      *
     c     rlbapf_key    chain     rlbapf
      *
     c                   if        not%found
     c                   move      *on           *in53
     c                   goto      v1tag3
     c                   endif
      *
      * Lev.skal IKKE ha valutakonto:
      *
     c                   if        rvhbvk = 'N'
     c                   move      *on           *in54
     c                   goto      v1tag3
     c                   endif
      *
      * Tester på om valutakonto er utfylt:
      *
     c                   move      gavalk        ra16l1_pkod
      *
     c     ra16l1_key    chain     ra16l1
      *
     c                   if        %found and
     c                             rapbkt = 0
     c                   move      *on           *in55
     c                   goto      v1tag3
     c                   endif
      *
      * Overfører felter:
      *
     c                   move      gavalk        v1valk
     c                   eval      v1levr = galevr
     c                   movel     ganavn        v1navn
     c                   eval      v1vkto = rapbkt
     c                   movel     'V'           v1valg
     c                   movel     gafval        v1fval
      *
      * Sender opp bilde for å bekrefte at endring skal gjøres:
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 39
      *
     c     v1tag1        tag
      *
     c                   exfmt     v1win
      *
     c     *inkc         cabeq     *on           v1tag2
      *
      * Sender feilmelding dersom det prøver å oppheve Valutakonto,
      * og samtidig at valutatype bet. er forskjellig fra inngående:
      * DA SKAL VALUTAKONTO BENYTTES!
      *
     c                   if        v1valg = *blanks and
     c                             gavalk <> gafval
     c                   move      *on           *in64
     c                   goto      v1tag1
     c                   endif
      *
      * Legger forfallsdato over hjelpefeltet V1FDAT:
      *
     c                   eval      v1fdat = gafdat
      *
      * Oppdater hele forslaget med valutakonto, hvor det er lik
      * leverandør, betalingsdato og betalingsvaluta:
      *
     c     gubflu_key    setll     gubflu
     c     gubflu_key    reade     gubflu                                 60
      *
     c                   dow       *in60 = *off
      *
     c                   if        gavalk = v1valk and
     c                             galevr = v1levr and
     c                             gafdat = v1fdat and
     c                             gavalk <> *blanks
      *
     c                   move      'N'           gabeva
      *
     c                   if        v1valg = 'V'
     c                   move      'J'           gabeva
     c                   endif
      *
     c                   eval      gaavtm = *blanks
     c                   eval      gaavtk = 0
     c                   eval      gatenr = *blanks
     c                   eval      gateku = 0
      *
     c                   update    gabfpfu
      * Post finnes ikke:
     c                   else
     c                   unlock    gubflu
     c                   endif
      *
     c     gubflu_key    reade     gubflu                                 60
      *
      * Setter flagg for reload av subfile:
      *
     c                   if        *in60 = *on
     c                   move      '1'           wpload
     c                   eval      b1avte = *blanks
     c                   eval      b1valg = *blank
     c                   if        v1valg = 'V'
     c                   move      'V'           b1avte
     c                   endif
     c                   update    b1sfl
     c                   goto      v1tag3
     c                   endif
      *
     c                   enddo
      *
     c     v1tag2        tag
      *
      * Oppdater subfile:
      *
     c                   if        b1valg = 'V'
      *
     c                   if        *inkc = *off
     c                   if        v1valg = 'V'
     c                   move      'V'           b1avte
     c                   else
     c                   eval      b1avte = *blanks
     c                   endif
     c                   endif
      *
     c                   move      srrn01        w_virn
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
      *
     c     v1tag3        tag
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
     c                   move      *off          *in30
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * G1WIN - Registrering av avtalt kurs:                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xg1win        begsr
      *
      * Henter opp informasjon i fra file:
      *
E5.00c     gubfl8_keya   chain     gubfl8
      *
      * Tester på at Terminkontrakt er null dersom Avtalt kurs
      * ønskes utfylt:
      *
     c                   if        %found and
     c                             b2valg = 'A' and
     c                             gateku <> 0
     c                   move      *on           *in48
     c                   goto      g1tag3
     c                   endif
      *
     c                   if        b1valg = 'A' and
     c                             b1teku <> 0
     c                   move      *on           *in48
     c                   goto      g1tag3
     c                   endif
      *
      * Tester på at valutakonto ikke brukes dersom avtalt kurs
      * ønskes utfylt:
      *
     c                   if        %found and
     c                             b2valg = 'A' and
     c                             gabeva <> 'N'
     c                   move      *on           *in56
     c                   goto      g1tag3
     c                   endif
      *
     c                   if        b1valg = 'A' and
     c                             b1avte = 'V'
     c                   move      *on           *in56
     c                   goto      g1tag3
     c                   endif
      *
      * Tester på at valutakode er ulik NOK/blank dersom det
      * ønskes å legge inn Avtalt kurs:
      *
     c                   if        %found and
     c                             b2valg = 'A'
     c                   if        gavalk = *blanks or
     c                             gavalk = 'NOK'
     c                   move      *on           *in47
     c                   goto      g1tag3
     c                   endif
     c                   endif
      *
     c                   if        b1valg = 'A'
     c                   if        b1valk = *blanks or
     c                             b1valk = 'NOK'
     c                   move      *on           *in47
     c                   goto      g1tag3
     c                   endif
     c                   endif
      *
      * Overfører data fra file til felter i bildet.  Dersom
      * det ikke finnes verdi i felter fra file, så brukes de
      * verdiene som finnes fra tidligere i feltene:
      *
     c                   if        %found
      *
      * Blank i felter på file OG første gjennomgang, d.v.s
      * feltet G1VALK er blank:
      *
     c                   if        g1valk = *blanks and
     c                             gaavtk = 0
     c                   move      gavalk        g1valk
     c                   else
      *
      * Blank i felter på file, OG i annen valuta:
      *
     c                   if        g1valk <> gavalk and
     c                             gaavtk = 0
     c                   move      gavalk        g1valk
     c                   eval      g1avtm = *blanks
     c                   eval      g1avtk = 0
     c                   endif
     c                   endif
      *
      * Felter på file er utfylt:
      *
     c                   if        gaavtk <> 0
     c                   move      gavalk        g1valk
     c                   move      gaavtm        g1avtm
     c                   eval      g1avtk = gaavtk
     c                   endif
      *
      * Post finnes ikke i forslagsfile:
      *
     c                   else
     c                   eval      g1valk = *blanks
     c                   eval      g1avtm = *blanks
     c                   eval      g1avtk = 0
     c                   endif
      *
      * Valutakode på faktura:
      *
     c                   movel     gafval        g1fval
      *
      * Sender opp bilde for registrering av Avtalt kurs:
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 39
      *
     c     g1tag1        tag
      *
     c                   exfmt     g1win
      *
     c     *inkc         cabeq     *on           g1tag2
      *
      * Kontroll på at begge felter er utfylt dersom det ene er utfylt:
      *
     c                   if        g1avtm = *blanks and
     c                             g1avtk <> 0
     c                   move      *on           *in51
     c                   goto      g1tag1
     c                   endif
      *
     c                   if        g1avtm <> *blanks and
     c                             g1avtk = 0
     c                   move      *on           *in51
     c                   goto      g1tag1
     c                   endif
      *
      * Oppdater den enkelte forslagslinje ELLER hele forslaget,
      * avhengig av om det er valgt F10 (for alle) eller ikke:
      *
      * En post:
      *
     c                   if        *inkj <> *on
     c     gubflu_keya   chain     gubflu
      *
     c                   if        %found
     c                   move      g1avtm        gaavtm
     c                   eval      gaavtk = g1avtk
     c                   update    gabfpfu
     c                   endif
      * Alle poster:
     c                   else
      *
     c     gubflu_key    setll     gubflu
     c     gubflu_key    reade     gubflu                                 60
      *
     c                   dow       *in60 = *off
      *
     c                   if        gavalk = g1valk
     c                   move      g1avtm        gaavtm
     c                   eval      gaavtk = g1avtk
     c                   eval      gatenr = *blanks
     c                   eval      gateku = 0
     c                   eval      gabeva = *blanks
     c                   update    gabfpfu
     c                   else
     c                   unlock    gubflu
     c                   endif
      *
     c     gubflu_key    reade     gubflu                                 60
      *
      * Setter flagg for reload av subfile:
      *
     c                   if        *in60 = *on
     c                   move      '1'           wpload
     c                   if        b1valg = 'A'
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
     c                   goto      g1tag3
     c                   endif
      *
     c                   enddo
      *
     c                   endif
      *
     c     g1tag2        tag
      *
      * Oppdater subfile:
      *
     c                   if        b1valg = 'A'
     c                   move      g1avtm        b1avtm
     c                   eval      b1avtk = g1avtk
      *
     c                   if        g1avtk <> 0
     c                   move      'A'           b1avte
     c                   else
     c                   eval      b1avte = *blank
     c                   endif
      *
     c                   move      srrn01        w_virn
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
      *
     c     g1tag3        tag
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
     c                   move      *off          *in30
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * H1WIN - Registrering av terminkontrakt:                         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xh1win        begsr
      *
      * Henter opp informasjon i fra file:
      *
E5.00c     gubfl8_keya   chain     gubfl8
      *
      * Tester på at Avtalt kurs er null dersom Terminkontrakt
      * ønskes utfylt:
      *
     c                   if        %found and
     c                             b2valg = 'T' and
     c                             gaavtk <> 0
     c                   move      *on           *in49
     c                   goto      h1tag3
     c                   endif
      *
     c                   if        b1valg = 'T' and
     c                             b1avtk <> 0
     c                   move      *on           *in49
     c                   goto      h1tag3
     c                   endif
      *
      * Tester på at valutakonto ikke brukes dersom termin kurs
      * ønskes utfylt:
      *
     c                   if        %found and
     c                             b2valg = 'T' and
     c                             gabeva <> 'N'
     c                   move      *on           *in56
     c                   goto      h1tag3
     c                   endif
      *
     c                   if        b1valg = 'T' and
     c                             b1avte = 'V'
     c                   move      *on           *in56
     c                   goto      h1tag3
     c                   endif
      *
      *
      * Tester på at valutakode er ulik NOK/blank dersom det
      * ønskes å legge inn terminforretning:
      *
     c                   if        %found and
     c                             b2valg = 'T'
     c                   if        gavalk = *blanks or
     c                             gavalk = 'NOK'
     c                   move      *on           *in46
     c                   goto      h1tag3
     c                   endif
     c                   endif
      *
     c                   if        b1valg = 'T'
     c                   if        b1valk = *blanks or
     c                             b1valk = 'NOK'
     c                   move      *on           *in46
     c                   goto      h1tag3
     c                   endif
     c                   endif
      *
      * Overfører data fra file til felter i bildet.  Dersom
      * det ikke finnes verdi i felter fra file, så brukes de
      * verdiene som finnes fra tidligere i feltene:
      *
     c                   if        %found
      *
      * Blank i felter på file OG første gjennomgang, d.v.s
      * feltet H1VALK er blank:
      *
     c                   if        h1valk = *blanks
     c                             and gateku = 0
     c                   move      gavalk        h1valk
     c                   else
      *
      * Blank i felter på file, OG i annen valuta:
      *
     c                   if        h1valk <> gavalk
     c                             and gateku = 0
     c                   move      gavalk        h1valk
     c                   eval      h1tenr = *blanks
     c                   eval      h1teku = 0
     c                   endif
     c                   endif
      *
      * Felter for terminforretning er utfylt:
      *
     c                   if        gateku <> 0
     c                   move      gavalk        h1valk
     c                   move      gatenr        h1tenr
     c                   eval      h1teku = gateku
     c                   endif
      *
      * Post finnes ikke i forslagsfile:
      *
     c                   else
     c                   eval      h1valk = *blanks
     c                   eval      h1tenr = *blanks
     c                   eval      h1teku = 0
     c                   endif
      *
      * Valutakode på faktura:
      *
     c                   movel     gafval        h1fval
      *
      * Sender opp bilde for registrering av terminkontrakt:
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 39
      *
     c     h1tag1        tag
      *
     c                   exfmt     h1win
      *
     c     *inkc         cabeq     *on           h1tag2
      *
      * Kontroll på at begge felter er utfylt dersom det ene er utfylt:
      *
     c                   if        h1tenr = *blanks and
     c                             h1teku <> 0
     c                   move      *on           *in50
     c                   goto      h1tag1
     c                   endif
      *
     c                   if        h1tenr <> *blanks and
     c                             h1teku = 0
     c                   move      *on           *in50
     c                   goto      h1tag1
     c                   endif
      *
      * Oppdater den enkelte forslagslinje ELLER hele forslaget,
      * avhengig av om det er valgt F10 (for alle) eller ikke:
      *
      * En post:
     c                   if        *inkj <> *on
     c     gubflu_keya   chain     gubflu
      *
     c                   if        %found
     c                   move      h1tenr        gatenr
     c                   eval      gateku = h1teku
     c                   update    gabfpfu
     c                   endif
      * Alle poster:
     c                   else
      *
     c     gubflu_key    setll     gubflu
     c     gubflu_key    reade     gubflu                                 60
      *
     c                   dow       *in60 = *off
      *
     c                   if        gavalk = h1valk
     c                   move      h1tenr        gatenr
     c                   eval      gateku = h1teku
     c                   eval      gaavtm = *blanks
     c                   eval      gaavtk = 0
     c                   eval      gabeva = *blanks
     c                   update    gabfpfu
     c                   else
     c                   unlock    gubflu
     c                   endif
      *
     c     gubflu_key    reade     gubflu                                 60
      *
      * Setter flagg for reload av subfile:
      *
     c                   if        *in60 = *on
     c                   move      '1'           wpload
     c                   if        b1valg = 'T'
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
     c                   goto      h1tag3
     c                   endif
      *
     c                   enddo
      *
     c                   endif
      *
     c     h1tag2        tag
      *
      * Oppdater subfile:
      *
     c                   if        b1valg = 'T'
     c                   move      h1tenr        b1tenr
     c                   eval      b1teku = h1teku
      *
     c                   if        h1teku <> 0
     c                   move      'T'           b1avte
     c                   else
     c                   eval      b1avte = *blank
     c                   endif
      *
     c                   move      srrn01        w_virn
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
      *
     c     h1tag3        tag
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
     c                   move      *off          *in30
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Tester på verdier i skjermbilde A1.                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xc2tst        begsr
      *
      * Tester om forfallsdato er gyldig.
      *
     c     *dmy          test(d)                 c2fdat                 33
      *
     c                   if        *in33
     c                   goto      xuttst
     c                   endif
      *
      * Dersom det velges å betale med annen valuta enn det fakturaen
      * lyder på, så må det utføres en del tester.
      *
      * Legger over kode som forteller om valutakonto skal brukes:
      *
     c                   movel     gabeva        c2beva
      *
      * Hopper over valutatestene dersom d.s. valutatypen mellom
      * inngående og betaling:
      *
     c     c2valk        cabeq     c2fval        xover
      *
      * START VALUTATEST.
      *
      * Tester på om valutatype det skal betales med er gyldig,
      * d.v.s. den må være opprettet på valutaregisteret:
      *
     c                   if        c2valk <> *blanks
     c                   move      c2valk        ra16l1_pkod
     c     ra16l1_key    chain     ra16l1
      *
     c                   if        not%found
     c                   move      *on           *in57
     c                   goto      xuttst
     c                   else
     c                   move      *off          *in57
     c                   endif
     c                   endif
      *
      * Tester på om valutakonto er lagt inn på valutatypen:
      *
     c                   if        rapbkt = 0
     c                   move      *on           *in58
     c                   goto      xuttst
     c                   endif
      *
      * Henter utenl.bankinfo. på leverandør.  Det må der være
      * avmerket at valutakonto kan benyttes:
      *
     c     rlbapf_key    chain     rlbapf
      *
     c                   if        not%found
     c                   goto      xuttst
     c                   endif
      *
      * Lev.skal IKKE ha valutakonto:
      *
     c                   if        rvhbvk = 'N'
     c                   move      *on           *in59
     c                   goto      xuttst
     c                   endif
      *
      * Terminforretning eller Avtalt kurs kan ikke allerede
      * være lagt inn på betalingen:
      *
     c                   if        gatenr <> *blanks or
     c                             gateku <> 0 or
     c                             gaavtk <> 0 or
     c                             gaavtm <> *blanks
     c                   move      *on           *in63
     c                   goto      xuttst
     c                   endif
      *
      * Ny valutakode er gyldig.  Feltet (GABEVA) for at valuta-
      * konto skal brukes blir oppdatert med "J".
      *
     c                   movel     'J'           c2beva
      *
      * SLUTT VALUTATEST.
      *
     c     xover         tag
      *
      * Oppdaterer ev. endringer i feltet betalingsvaluta:
      *
     c                   movel     c2valk        gavalk
      *
      * Tester om forfallsdato er endret, og samtidig mindre enn
      * bilagsdato.  Dette er ikke gyldig dersom fakturapost
      *
     c     *dmy          move      c2fdat        w_fdat
      *
     c                   if        w_fdat <> gafdat and
     c                             w_fdat <  gabdat  and
     c                             c2belØ > 0
     c                   move      *on           *in34
     c                   endif
      *
     c     *in34         cabeq     *on           xuttst
      *
      * Beløpskontroll utelates ved neg.beløp, d.v.s. Kr.nota:
      *
     c     gaopbn        cablt     0             xuttst
      *
      * Tester på at rabatt som trekkes er lik enten R1, R2 eller R3
      * D.v.s. opprinnelig fakturabeløp (i NOK og Valuta) minus
      * rabatt (R1, R2 ELLER R3) må være lik beløpet som finnes som
      * fakturabeløp både i NOK og Valuta.  Det testes kun dersom
      * fakturabeløp i bildet er mindre enn opprinnelig fakturabeløp:
      *
      * Testen her utføres dersom det er LIK valutasort mellom
      * inngående faktura og det utbetalingen lyder på:
      *
     c                   if        c2valk = c2fval
      *
     c                   if        c2belØ < gaopbn or
     c                             c2valb < gaopbv
     c                   move      *on           *in37
      * R1
     c                   eval      wpklan = gaopbn + garbn1
     c                   eval      wpklav = gaopbv + garbv1
     c                   if        wpklan = c2belØ and
     c                             wpklav = c2valb
     c                   move      *off          *in37
     c                   if        w_fdat > garda1
     c                   move      *on           *in36
     c                   endif
     c                   endif
      * R2
     c                   eval      wpklan = gaopbn + garbn2
     c                   eval      wpklav = gaopbv + garbv2
     c                   if        wpklan = c2belØ and
     c                             wpklav = c2valb
     c                   move      *off          *in37
     c                   if        w_fdat > garda2
     c                   move      *on           *in36
     c                   endif
     c                   endif
      * R3
     c                   eval      wpklan = gaopbn + garbn3
     c                   eval      wpklav = gaopbv + garbv3
     c                   if        wpklan = c2belØ and
     c                             wpklav = c2valb
     c                   move      *off          *in37
     c                   if        w_fdat > garda3
     c                   move      *on           *in36
     c                   endif
     c                   endif
     c                   endif
      *
     c                   endif
      *
      * Testen her utføres dersom det er ULIK valutasort mellom
      * inngående faktura og det utbetalingen lyder på:
      *
     c                   if        c2valk <> c2fval
      *
      * Blanker hjelpefelt som forteller hvilken rabatt som er valgt:
      *
     c                   eval      wprabb = *blanks
      *
     c                   if        c2belØ < gaopbn
     c                   move      *on           *in37
      * R1
     c                   eval      wpklan = gaopbn + garbn1
     c                   if        wpklan = c2belØ
     c                   move      *off          *in37
     c                   move      'R1'          wprabb
     c                   if        w_fdat > garda1
     c                   move      *on           *in36
     c                   endif
     c                   endif
      * R2
     c                   eval      wpklan = gaopbn + garbn2
     c                   if        wpklan = c2belØ
     c                   move      *off          *in37
     c                   move      'R2'          wprabb
     c                   if        w_fdat > garda2
     c                   move      *on           *in36
     c                   endif
     c                   endif
      * R3
     c                   eval      wpklan = gaopbn + garbn3
     c                   if        wpklan = c2belØ
     c                   move      *off          *in37
     c                   move      'R3'          wprabb
     c                   if        w_fdat > garda3
     c                   move      *on           *in36
     c                   endif
     c                   endif
     c                   endif
      *
     c                   endif
      *
      * Dersom *IN37 er "PÅ", så skal det sendes feilmelding:
      *
     c     *in37         cabeq     *on           xuttst
      *
      * Dersom det betales i annen valuta enn valutatype på inngående
      * faktura, så må det foretas en gyldighetskontroll på valuta-
      * beløpet.  Omregnet med dagens kurs må NOK-beløpet være innenfor
      * et avvik på 2 % før det sendes VARSLING:
      *
     c                   if        c2valk <> c2fval
      *
      * Legger opprinnelig fakturabeløp i NOK over i hjelpefelt:
      *
     c                   eval      w1belØ = gaopbn
      *
      * Regner om til NOK med dagens kurs:
      *
6.10 c                   eval(h)   w1n112 = c2valb * rapmku
6.10  *
      *
      * Tar hensyn til ev. trukket rabatt:
      *
     c                   if        wprabb = 'R1'
     c                   eval      w1belØ = gaopbn + garbn1
     c                   endif
      *
     c                   if        wprabb = 'R2'
     c                   eval      w1belØ = gaopbn + garbn2
     c                   endif
      *
     c                   if        wprabb = 'R3'
     c                   eval      w1belØ = gaopbn + garbn3
     c                   endif
      *
      * Regner ut 2% (+/-) av NOK-beløpet (inngående):
      *
     c                   eval(h)   wpavik = w1belØ * 2 / 100
      *
     c                   eval      wpavip = w1belØ + wpavik
     c                   eval      wpavin = w1belØ - wpavik
      *
      * Generere VARSLING dersom registrert valutabeløp omregnet
      * til NOK overskrider +/- 2% av opprinnelig NOK-beløp:
      *
     c                   if        w1n112 > wpavip or
     c                             w1n112 < wpavin
     c                   eval      w_arow = 4
     c                   eval      w_acol = 2
     c                   exfmt     w1win
     c                   if        *inkc = *on
     c                   move      *on           *in65
     c                   endif
     c                   endif
      *
     c                   endif
      *
     c     xuttst        tag
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * D1WIN Behandle bilde for slette                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xd1win        begsr
      *
E5.00c     gubfl8_keya   chain     gubfl8
      *
     c                   if        %found
     c                   eval      d1bfli = gabfli
     c                   eval      d1belØ = gabelØ
     c                   movel     gatext        d1text
     c     *dmy          move      gafdat        d1fdat
     c                   eval      d1biln = gabiln
     c                   eval      d1levr = galevr
     c                   endif
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 39
     c                   exfmt     d1win
      *
     c     *inkc         cabeq     *on           d1tag1
      *
     c     gubflu_keya   chain     gubflu
      *
     c                   if        %found
      *
      * Bygger RLTRLU_KEY
      *
25070c                   eval      b1levr = galevr
E5.00c                   eval      w_bdat = gabdat
E5.00c                   eval      b1tist = gatist
      *
      * Ved sletting av post må renummerering kjøres.
      *
     c                   movel     'J'           wpendr
     c                   delete    gabfpfu
      *
      * Oppdaterer transaksjonsfile; RLTRLU (RLTRPF)
      *
     c     rltrlu_key    chain     rltrlu
      *
     c                   if        %found
     c                   eval      robfnr = 0
     c                   eval      robfli = 0
V5.30c                   eval      rofoda = *loval
V5.30c                   eval      roftim = *loval
V5.30c                   eval      rofsig = *blank
     c                   update    rltrlur
     c                   endif
     c                   endif
      *
      * Oppdater subfile
      *
     c                   if        b1valg = '4'
     c                   eval      b1text = *blank
     c                   movel     txt(4)        b1text
     c                   endif
      *
     c     d1tag1        tag
      *
     c                   if        b1valg = '4'
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   endif
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * E1WIN Behandle bilde for slette forslaget.                      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xe1win        begsr
      *
     c     gubflu_key    setll     gubflu
     c     gubflu_key    reade     gubflu                                 60
      *
     c                   dow       *in60 = *off
      *
      * Initierer nøkkel for fjerning av forslagsnummer og
      * forslagslinjenummer på leverandørtransaksjonsfile RLTRPF
      *
     c                   eval      b1levr = galevr
E5.00c                   eval      w_bdat = gabdat
E5.00c                   eval      b1tist = gatist
      *
      *  Sletter forslags- og linjenummer på RLTRPF, dersom det
      *  IKKE allerede er overført til banken (*IN38=*OFF), eller
      *  at det er valgt F6 i "ANGRE"-bildet.
      *
      *  Forslaget vil nå bli tatt med i et nytt utplukk.
      *
     c                   if        *inkf = *on or
     c                             *in38 = *off
      *
     c     rltrlu_key    chain     rltrlu
      *
     c                   if        %found
     c                   eval      robfnr = 0
     c                   eval      robfli = 0
V5.30c                   eval      rofoda = *loval
V5.30c                   eval      roftim = *loval
V5.30c                   eval      rofsig = *blank
     c                   update    rltrlur
     c                   else
     c                   unlock    rltrlu
     c                   endif
      *
     c                   endif
      *
      * Sletter post fra forslagsfilen.
      *
     c                   delete    gabfpfu
      *
     c     gubflu_key    reade     gubflu                                 60
     c                   enddo
      *
     c                   eval      b2valg = *blank
     c                   eval      b2bfli = 0
      *
      * Initierer bildet.
      *
E5.00c     gubfl8_keya   setll     gubfl8
      *
     c                   exsr      xclr01
     c                   exsr      xcrt01
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Tøm subfile                                                     *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xclr01        begsr
      *
     c                   move      *on           *in14
     c                   write     b2ctl
     c                   move      *off          *in14
      *
     c                   move      *off          *in15
     c                   eval      srrn01 = 0
     c                   eval      sfrn01 = 0
     c                   eval      ssrn01 = 0
     c                   eval      spge01 = 0
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Fyll opp subfile                                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xcrt01        begsr
     c** 6.31            eval      spge01 = spge01 + 12
7.xx c**                 eval      spge01 = spge01 + 11
7.xx c                   eval      spge01 = spge01 + 10
     c                   eval      srrn01 = ssrn01
      *
     c                   dou       srrn01 = spge01
E5.00c     gubfl8_key    reade     gubfl8                                 15
      *
     c     *in15         cabeq     *on           xend01
      *
      * Tester på om lest på tilhører valgt forslagnummer.
      *
     c     c1bfnr        cabne     gabfnr        xend01
      *
      * Display-felter
      *
     c                   eval      srrn01 = srrn01 + 1
     c                   eval      b1bfli = gabfli
     c                   eval      b1belØ = gabelØ
     c                   movel     garabb        b1rabb
     c                   movel     gatext        b1text
     c                   eval      b1biln = gabiln
     c                   eval      b1levr = galevr
      *
      *  Finner leverandørnavn:
      *
5.51 c     rlevl1_key2   chain     rlevl1
      *
5.51 c                   if        %found
5.51 c                   eval      b1navn = rlnavn
5.51 c                   else
5.51 c                   eval      b1navn = *blanks
10116c*****              eval      b1navn = '*ukjent'
5.51 c                   endif
      *
     c     *dmy          move      gafdat        b1fdat
6.10  *
6.10  * Legger ut "S" (for STRUKTURERT) dersom det IKKE er KID, MEN
6.10  * at leverandørs fakturanummer er utfylt:
6.10  *
6.10 c                   movel     gakids        b1kidi
6.10  *
6.10 c                   if        gakids <> '*'
6.10  *
6.10 c                   if        galfak <> *blanks
6.10 c                   movel     'S'           b1kidi
6.10 c                   endif
      *
6.10 c                   endif
      *
6.10 c******             movel     gakids        b1kidi
     c                   movel     gareko        b1reko
      *
      *Aktiverer "blinkende F":
22123c                   if        b1reko =  'F'
22123c                   move      *on           *in77
22123c                   endif
      *
     c                   movel     gastat        b1stat
     c                   movel     gavalk        b1valk
      *
      * Skjulte-felter
      *
E5.00c                   eval      b1bdat = gabdat
E5.00c                   eval      b1tist = gatist
      *
     c                   move      gatenr        b1tenr
     c                   eval      b1teku = gateku
     c                   move      gaavtm        b1avtm
     c                   eval      b1avtk = gaavtk
     c                   eval      b1avte = *blank
     c                   eval      b1valg = *blank
      *
      * Avtalt kurs?
      *
     c                   if        b1avtk <> 0
     c                   move      'A'           b1avte
     c                   endif
      *
      * Terminforretning?
      *
     c                   if        b1teku <> 0
     c                   move      'T'           b1avte
     c                   endif
      *
      * Valutakonto:?
      *
     c                   if        gabeva = 'J'
     c                   move      'V'           b1avte
     c                   endif
      *
      * Lagrer linjenummer for sist leste posten.  Denne
      * blir brukt i for å posisjonere ved neste ROLL
      * fremover.
      *
     c                   eval      wplinj = gabfli
      *
      * Bygger opp subfileheader avhengig av om det er vanlig
      * betalingsforslag, ELLER lønnsutbetalingsforslag.  Det
      * er vanlig forslag dersom bilagsdato er utfylt:
      *
T5.00c                   if        gabdat <> *loval
7.xx c**                 movel     txt(6)        dsdelb
7.xx c                   eval      dsdelb = 'Val' + c_sepw + 'V' + c_sepw +
7.xx c                                      'F' + c_sepw + 'Bilagstek'+
7.xx c                                      c_sepw + '  Bnr   ' + c_sepw +
7.xx c                                      'Levnr.' + c_sepw + 'Levnavn' +
7.xx c                                      c_sepw + 'K' + c_sepw
     c                   movel     txt(8)        b2head
     c                   movel     txt(10)       b2subv
     c                   move      tx(1)         b2subv
     c                   movel     tx(2)         b2vkto
     c                   eval      wpparm = *blanks
     c                   else
     c                   movel     txt(7)        dsdelb
     c                   movel     txt(9)        b2head
     c                   movel     txt(11)       b2subv
     c                   eval      b2vkto = *blanks
     c                   movel     'L'           wpparm
     c                   endif
      *
7.xx c**                 movel     dssubh        b2subh
7.xx c                   movel     dsdelb        b2subh
      *
FEIL c                   write     b1sfl
      *
     c                   enddo
      *
     c     xend01        tag
      *
     c                   if        srrn01 > ssrn01
     c                   eval      sfrn01 = ssrn01 + 1
     c                   endif
      *
     c                   eval      ssrn01 = srrn01
     c                   eval      w_virn = sfrn01
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Display subfile                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xdsp01        begsr
      *
     c                   write     b2cmd
      *
     c                   if        srrn01 <> 0
     c                   move      *on           *in12
     c                   endif
      *
     c                   move      *on           *in13
     c                   exfmt     b2ctl
     c                   move      *off          *in12
     c                   move      *off          *in13
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Tester om det er KID eller melding i KID-feltet.                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xkidts        begsr
      *
      * Initierer hjelpefelt.
      *
     c                   eval      v = 25
     c                   eval      w = 25
     c                   eval      wpblan = *blanks
     c                   eval      wpluft = *blanks
     c                   eval      wpnume = *blanks
     c                   eval      nyki = *blanks
     c                   movea     c2kidi        kid
     c                   move      '*'           c2kids
      *
     c                   dow       v >= 1
      *
      * Tester om blank etter at det har vært tall.
      *
     c                   if        wpnume = 'JA' and
     c                             kid(v) = *blank
     c                   move      'JA'          wpluft
     c                   endif
      *
      * Tester på om det er kun tall i KID-feltet som er adskilt
      * med blankt.  I såfall er det IKKE et KID-felt.
      * Hjelpefeltet WPLUFT indikerer at det har forekommet tall
      * og deretter blankt, lest i fra venstre mot høyre.
      * Testen må utføres f.o.m. 2. les, for å ha verdier å teste
      * i mot.
      *
      * Testen fanger opp flg: '1234 6 8 0 23 5 78901 345'
      *
     c                   if        v <> 25 and
     c                             wpluft = 'JA' and
     c                             wpnume = 'JA' and
     c                             kid(v) >= '0' and
     c                             kid(v) <= '9'
     c                   eval      c2kids = *blank
     c                   leave
     c                   endif
      *
      * Tester om blank.
      *
     c                   if        kid(v) = *blank
     c                   move      'JA'          wpblan
     c                   endif
      *
      * Tester om numerisk.
      *
     c                   if        kid(v) >= '0' and
     c                             kid(v) <= '9'
     c                   move      'JA'          wpnume
     c                   endif
      *
      * Tester om alfa, d.v.s. IKKE numerisk og IKKE blank.
      *        Eks: 'A1342872342389B891H998235'
      *
     c                   if        kid(v) <> *blank
     c                   if        kid(v) <> '-'
     c                   if        kid(v) < '0' or
     c                             kid(v) > '9'
     c                   eval      c2kids = *blank
     c                   leave
     c                   endif
     c                   endif
     c                   endif
      *
      * Overfører verdi til hjelpefelt, dersom tall.  Feltet vil
      * senere bli overført tilbake til KID-feltet for å høyre-
      * justere dersom det er en reell KID-verdi.
      *
     c                   if        kid(v) >= '0' and
     c                             kid(v) <= '9' or
     c                             kid(v) = '-'
     c                   move      kid(v)        nyki(w)
     c                   eval      w = w - 1
     c                   endif
      *
     c                   eval      v = v - 1
     c                   enddo
      *
      * Dersom KID-feltet er utfylt med KID, så blir det først
      * høyrejustert, og deretter modulustestet.
      *
     c                   if        c2kids = '*'
     c                   movea     nyki          c2kidi
      *
      * Legger KID-felt over i hjelpefelt.
      *
     c                   move      c2kidi        wpsist
     c                   movel     c2kidi        wpbl24
     c                   movea     wpbl24        tall
      *
17024c                   goto      xno1
     c                   exsr      xmod10
17024c     xno1          tag
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for modulus 10 kontrol                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xmod10        begsr
      *
     c                   call      'RÅ910R'
     c                   parm                    tall
     c                   parm                    ktr
      *
      * Mod 11 kalles opp dersom feil ved mod 10.
      *
     c                   if        ktr <> wpsist
      *
17024c                   goto      xno2
     c                   exsr      xmod11
17024c     xno2          tag
      *
      * Sender melding dersom feil i moduluskontroll.
      *
     c                   if        ktr <> wpsist
     c                   move      *on           *in35
     c                   endif
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for modulus 11 kontrol                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xmod11        begsr
      *
      * Legger KID-felt over i hjelpefelt.
      *
     c                   movel     c2kidi        wpbl24
     c                   movea     wpbl24        tall
      *
     c                   eval      tell = 0
     c                   eval      psum = 0
     c                   eval      vekt = 1
     c                   eval      v = 25
      *
     c                   dow       v > 1
     c                   eval      v = v - 1
     c                   if        tell = 6
     c                   eval      tell = 0
     c                   eval      vekt = 1
     c                   endif
     c                   eval      vekt = vekt + 1
     c                   move      tall(v)       faktor
     c                   eval      prod = faktor * vekt
     c                   eval      psum = psum + prod
     c                   eval      tell = tell + 1
     c                   enddo
      *
     c     psum          div       11            divtal
     c                   mvr                     rest
      *
     c                   if        rest = 1
     c                   move      '-'           ktr
     c                   else
     c                   eval      difktr = 11 - rest
     c                   move      difktr        ktr
     c                   if        rest = 0
     c                   move      0             ktr
     c                   endif
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for å lese inn verdier i subfile på nytt:             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xinke         begsr
      *
      * Nullstiller felt:
      *
      * (Blinkende "Feilretur"):
22123c                   move      *off          *in77
      *
     c                   eval      wpload = *blank
     c                   eval      b1valg = *blanks
     c                   eval      b2valg = *blanks
     c                   eval      b2bfli = 0
      *
      * Tester om renummerering først skal kjøres.
      * Renummerering kjøres ikke dersom utplukket er overført
      * til banken, eller når forslaget er en lønnskjøring:
      *
     c                   if        wpendr <> *blanks and
     c                             wpparm <> 'L' and
     c                             *in38 <> *on
6.20 c***                call      'GL101R'
6.20 c***                parm                    dslist
      *
     c                   eval      wpendr = *blanks
     c                   endif
      *
     c                   if        sfrn01 <> *zero
     c     sfrn01        chain     b1sfl                              60
     c                   endif
      *
     c                   eval      wpbfli = b1bfli
E5.00c     gubfl8_keya   setll     gubfl8
     c                   exsr      xclr01
     c                   exsr      xcrt01
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for å blanke verdi i feltet GASTAT på file GUBFPF:    *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
25071c     xinkn         begsr
      *
25071c     gubflu_key    setll     gubflu
25071c     gubflu_key    reade     gubflu                                 60
25071c                   dow       *in60 = *off
25071c                   eval      gastat = *blank
25071c                   eval      gareko = *blank
25071c                   update    gabfpfu
25071c     gubflu_key    reade     gubflu                                 60
25071c                   enddo
      *
25071c                   move      *off          *in38
      *
25071c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for å søke på forslagsnummer:                         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xsØke         begsr
      *
      * Startposisjoner for vindu:
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 44
      *
      * Initierer nøkkelverdi:
      *
     c                   eval      wpbfnr = 0
E5.00c     gubfl8_key    setll     gubfl8
     c                   exsr      xclr02
     c                   exsr      xcrt02
      *
     c     c1taga        tag
      *
     c                   write     c1cmd
      *
     c     c1tagb        tag
      *
     c                   exsr      xdsp02
      *
      * Behandling av subfile
      *
     c                   do        ssrn02
     c                   readc     c1sfl                                  26
      *
     c                   if        *in26 = *on
     c                   leave
     c                   endif
      *
      * Velge for oppdatering:
      *
     c                   if        y1valg = '1'
     c                   eval      c1bfnr = y1bfnr
     c                   eval      y1valg = *blank
     c                   update    c1sfl
     c                   iter
     c                   endif
      *
     c                   enddo
      *
      * Roll
      *
     c                   if        *in20 = *on
     c                   exsr      xcrt02
     c                   goto      c1tagb
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Tøm subfile  - SØK                                              *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xclr02        begsr
     c                   move      *on           *in24
     c                   write     c1ctl
     c                   move      *off          *in24
      *
     c                   move      *off          *in25
     c                   eval      srrn02 = 0
     c                   eval      sfrn02 = 0
     c                   eval      ssrn02 = 0
     c                   eval      spge02 = 0
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Fyll opp subfile - SØK                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xcrt02        begsr
     c                   eval      spge02 = spge02 + 6
     c                   eval      srrn02 = ssrn02
      *
     c                   dou       srrn02 = spge02
     c                   eval      wpbfnr = wpbfnr + 1
      *
E5.00c     gubfl8_key    setll     gubfl8
E5.00c     l_firm        reade     gubfl8                                 25
      *
     c     *in25         cabeq     *on           xend02
      *
     c                   eval      wpbfnr = gabfnr
     c                   eval      srrn02 = srrn02 + 1
     c                   eval      y1bfnr = gabfnr
      *
     c                   if        gaopda = *loval
     c                   eval      y1opda = 0
     c                   else
T5.00c     *dmy          move      gaopda        y1opda
     c                   endif
      *
     c                   movel     gaopav        y1opav
      *
     c                   eval      y1valg = *blank
      *
     c                   write     c1sfl
      *
     c                   enddo
      *
     c     xend02        tag
      *
     c                   if        srrn02 > ssrn02
     c                   eval      sfrn02 = ssrn02 + 1
     c                   endif
      *
     c                   eval      ssrn02 = srrn02
     c                   eval      svrn02 = sfrn02
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Display subfile - SØK                                           *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xdsp02        begsr
      *
     c                   if        srrn02 <> 0
     c                   move      *on           *in22
     c                   endif
      *
     c                   move      *on           *in23
     c                   exfmt     c1ctl
     c                   move      *off          *in22
     c                   move      *off          *in23
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Venstrejusterer innnhold av KID-feltet dersom KID:              *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xvenst        begsr
      *
      * Initierer hjelpefelt.
      *
     c                   movea     gakidi        kid
      *
     c                   do        24
      *
      * Tester om KID,V er blank, i såfall flyttes "alt"
      * en posisjon til venstre i feltet:
      *
     c                   if        kid(1) = *blank
     c                   eval      w = 1
      *
     c                   dow       w <= 24
     c                   eval      x = w + 1
     c                   move      kid(x)        kid(w)
     c                   if        x = 25
     c                   eval      kid(x) = *blank
     c                   endif
     c                   eval      w = w + 1
     c                   enddo
      *
     c                   else
     c                   leave
     c                   endif
      *
     c                   enddo
      *
      * Legger tilbake venstrejustert KID:
      *
     c                   movea     kid           gakidi
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Tester på om forslag inneholder feilretur:                      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
18054c     xfeil         begsr
      *
18054c                   eval      d_firm = wpfirm
18054c                   eval      d_bfnr = wpbfnr
18054c                   eval      d_kout = *blank
18054c                   move      *off          *in77
18054c                   call      'GL140R'
18054c                   parm                    d_lis2
      *  Finnes det feilretur i forslaget?
18054c                   if        d_kout = 'F'
18054c                   move      *on           *in77
18054c                   eval      b2anfe = d_anfe
18054c                   endif
      *
18054c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
     c     *entry        plist
21118c                   parm                    wwbfnr
      *
      * Initierer hjelpefelt som brukes i subrutine XKIDTS for å
      * teste på om innholdet i KID-feltet er KID eller alfa
      *
     c                   eval      wpnume = *blanks
     c                   eval      wpblan = *blanks
     c                   eval      wpluft = *blanks
     c                   eval      v = 0
     c                   eval      w = 0
     c                   eval      x = 0
      *
22060c                   eval      wpakti = *blanks
      *
      * Hjelpefelt som forteller om subfile skal "loades" på
      * nytt:
      *
     c                   eval      wpload = *blanks
      *
      * Hjelpefelt til overføring av lev.nr. i parameterliste:
      *
     c                   eval      plevnr = *blanks
      *
      * Indikerer om det er lønnsforslag eller vanlig utbetalings-
      * forslag som skal skrives ut:
      *
     c                   eval      wpparm = *blanks
      *
      * Initierer hjelpefelt som brukes i moduluskontroll.
      *
     c                   eval      prod = 0
     c                   eval      prod1 = 0
     c                   eval      prod2 = 0
     c                   eval      siffs = 0
     c                   eval      en = 0
     c                   eval      tell = 0
     c                   eval      psum = 0
     c                   eval      vekt = 0
     c                   eval      faktor = 0
     c                   eval      divtal = 0
     c                   eval      rest = 0
     c                   eval      difktr = 0
     c                   eval      ktr = *blanks
     c                   eval      wpmtyp = *blanks
     c                   eval      wpbl24 = *blanks
     c                   eval      wpsist = *blanks
      *
      * Variable til bruk i gyldighetstest v/endring av av val beløp:
      *
     c                   eval      wpavik = 0
     c                   eval      wpavin = 0
     c                   eval      wpavip = 0
     c                   eval      wprabb = *blanks
      *
      * Variabel for om formularparametre skal kunne endres
      *
     c                   eval      wpvalg = 2
      *
     c                   eval      wpendr = *blanks
      *
     c                   eval      wpklan = 0
     c                   eval      wpklav = 0
      *
     c                   eval      spge01 = 0
     c                   eval      srrn01 = 0
      *
     c                   eval      spge02 = 0
     c                   eval      srrn02 = 0
      *
     c                   eval      w_arow = 4
     c                   eval      w_acol = 26
     c                   eval      wpin03 = 0
     c                   eval      wpin12 = 0
     c                   eval      b1kidi = *blanks
      *
      * Hjelpefelt som inneholder bergnede rabatter:
      *
     c                   eval      wpfirm = l_firm
      *
E5.00 * Key for file utbet.forslag; GUBFL8
      *
     c     gubfl8_key    klist
     c                   kfld                    l_firm
     c                   kfld                    wpbfnr
      *
E5.00 * Key for file utbet.forslag; GUBFL8
      *
     c     gubfl8_keya   klist
     c                   kfld                    l_firm
     c                   kfld                    wpbfnr
     c                   kfld                    wpbfli
      *
E5.00 * Key for file transaksjoner; RLTRLU
      *
     c     rltrlu_key    klist
     c                   kfld                    l_firm
     c                   kfld                    b1levr
E5.00c                   kfld                    w_bdat
E5.00c                   kfld                    b1tist
      *
      * Key for å lese forslagsfilen ved sletting av hele forslaget
      *
     c     gubflu_key    klist
     c                   kfld                    l_firm
     c                   kfld                    wpbfnr
      *
      * Key for å lese forslagsfilen
      *
     c     gubflu_keya   klist
     c                   kfld                    l_firm
     c                   kfld                    wpbfnr
     c                   kfld                    wpbfli
      *
E5.00 * Key for RLEVL1
      *
     c     rlevl1_key    klist
     c                   kfld                    gafirm
     c                   kfld                    galevr
      *
5.51  * Key for RLEVL1
5.51  *
5.51 c     rlevl1_key2   klist
5.51 c                   kfld                    l_firm
5.51 c                   kfld                    b1levr
      *
E5.00 * Key for RLBAPF
      *
     c     rlbapf_key    klist
     c                   kfld                    gafirm
     c                   kfld                    galevr
      *
E5.00 * Key for å initierer posisjonering mot file GUBFL8 v/ROLL:
      *
     c     gubfl8_keyb   klist
     c                   kfld                    l_firm
     c                   kfld                    wpbfnr
     c                   kfld                    wplinj
      *
      * Sender opp vedlikeholdsbildet dersom forslaget er utfylt:
      *
21118c                   if        wwbfnr <> 000
21118c                   eval      wpbfnr = wwbfnr
21118c                   eval      b2bfnr = wwbfnr
21118c                   eval      c1bfnr = wwbfnr
21118c                   goto      xnosØk
     c                   endif
      *
      * Key for valutakoder
      *
     c     ra16l1_key    klist
     c                   kfld                    l_firm
     c                   kfld                    ra16l1_pkod
      *
      * Oppstartsbilde for registrering av bet.forslagsnr.
      *
     c     inztag        tag
      *
     c                   exfmt     c1bld
      *
      * Søk:
      *
     c                   if        *inkd = *on
5.52 c                             or  c1bfnr = 0
     c                   exsr      xsØke
     c                   endif
      *
     c     xnosØk        tag
      *
     c                   eval      wpbfnr = c1bfnr
     c                   eval      b2bfnr = c1bfnr
      *
      * Tester på om forslag inneholder feilretur:
      *
18054c                   eval      d_bfli = b2bfli
18054c                   exsr      xfeil
      *
      * Avslutt
      *
     c                   if        *inkc = *on
     c                   eval      *inlr = *on
     c                   return
     c                   endif
      *
      * Tester på om forslag finnes:
      *
E5.00c     gubfl8_key    chain     gubfl8
      *
     c                   if        not%found
     c                   goto      inztag
     c                   endif
      *
      * Bygger opp subfileheader og kommandolinje, avhengig av
      * om det er vanlig utbetalingsforslag ELLER lønnsutbetalings-
      * forslag.  Det  er VANLIG utbetalingsforslag dersom bilagsdato
      * er utfylt på transaksjonen i fra GUBFPF:
      *
     c                   movel     txt(5)        dsdela
     c                   movel     txt(6)        dsdelb
     c                   movel     dssubh        b2subh
     c                   movel     txt(8)        b2head
     c                   movel     txt(10)       b2subv
     c                   move      tx(1)         b2subv
     c                   movel     tx(2)         b2vkto
      *
      * Tester på om forslaget tillates vedlikeholdt
      *
E5.00c     gubfl8_key    setll     gubfl8
E5.00c     gubfl8_key    reade     gubfl8                                 60
      *
     c                   dow       *in60 = *off
     c                   if        gastat = 'G'
     c                   move      *on           *in38
     c                   move      *on           *in60
     c                   else
E500 c     gubfl8_key    reade     gubfl8                                 60
     c                   endif
     c                   enddo
      *
      * Posisjonerer på firma og forslagnummer før subfile fylles opp
      *
E5.00c     gubfl8_keya   setll     gubfl8
      *
     c                   exsr      xcrt01
      *
     c     *dtaara       define    *lda          lda
      *
     c                   endsr
      *
**
  Ny post                  001
  Endring                  002
  Vise                     003
* Slettet *                004
V  Linje BetDato           Beløp R
Val V F Bilagstekst  Bnr   Levnr. Levnavn K
   Mottaker                  Lønnsnr.
Vedlikehold av utbetalingsforslag
       Lønnstransaksjoner
2=Endre  4=Slette  5=Vise  L=Levr.  F=Factoring  A=Avt. kurs
5=Vise
 F5=Forny  F6=Slette forslag  F10=Utskrift
 F6=Slette  F8=Endre dato  F10=Utskrift


**
T=Terminkontr.
V=Valutakonto
