# RPG Program RK694R - Explanation and Onboarding Guide

This ILE RPG program is primarily responsible for printing and managing "general notes" (likely invoices or billing statements) for customers. It interacts with several database files, builds print lines, manages customer and company info, and handles "bank giro" payment fields (including KID numbers, widely used in Scandinavian banking).

This explainer is divided into the following sections:
1. **File Declarations**
2. **Data Structures and Working Variables**
3. **Main Processing Logic**
4. **Subroutines: Details**
5. **Initialization Logic**
6. **Indicator Usage**

---

## 1. File Declarations

- Files are declared with various access modes (input, output, update, keyed).
- Files typically represent:
    - Customers
    - General note transactions
    - Company/form information
    - Bank giro/payment info
    - Output: print (frk694p) and bank giro file (frgirpf)

```rpg
frkw2pf   ip   e           k disk           // Main transaction file
frkunl1   if   e           k disk rename(rkunpfr:rkunl1r) // Customer file
frktrlu   uf   e           k disk rename(rktrpfr:rktrlur) // Customer postings update
fafirl1   if   e           k disk rename(afirpfr:afirl1r) // Company master
faforl1   if   e           k disk rename(aforpfr:aforl1r) // Form routine register
fraa4l1   if   e           k disk rename(raa4pfr:raa4l1r) // Serial numbers file
fraa4lu   uf   e           k disk rename(raa4pfr:raa4lur) // Update serial numbers
frgirpf   o  a e           k disk           // Bank giro output
frk694p   o    e             printer infds(d_infds) // Main print output
```

---

## 2. Data Structures and Working Variables

### a) Customer/Company Key and Info Storage

A number of data structures overlay the same storage areas, allowing access to substrings for splitting firm, customer no, etc.

```rpg
d wkwrec         2    192
d  wkfirm          3  0 overlay(wkwrec)
d  wkkund          6  0 overlay(wkwrec:4)
d  wknavn         30    overlay(wkwrec:10)
```

Similar overlays are used for sorting info (`wksort`) and giro keys (`wgkkey`).

### b) Other Variables and Data Structures

- **Date and period:**  
  Handles year, period, and dates for note and payment due.
- **Company and address fields:**  
  Used when formatting output and fetching company data.
- **KID field structure:**  
  A Norwegian banking reference with checksum.
- **Bank giro fields:**  
  Used both for 'from' and 'to' account numbers.

---

## 3. Main Processing Logic  

The program uses the RPG cycle (or loops through a transaction file), and for each relevant transaction does:

1. **Read and validate transactions**
    - Loads customer and transaction details
    - Skips if the "S" code (possibly a reversal)
1. **Fetch company/form info if needed**
    - If a flag (`afprfi`) in the form register is set, a call is made to an external program (`RÅ707R`) to retrieve company information
    - Handles logic for whether the company name should be shown or suppressed, based on parameters
1. **Prepare customer data for print**
    - Moves transaction fields to print fields
1. **Calculate payment due date**
    - Calls another program to calculate due dates for payment (`RS203R`)
1. **Print general note header**
    - Writes a print header line (`a1hdr`)
1. **Print detail lines**
    - Writes transaction line (`linje`)
    - Handles page overflow by incrementing page and printing a new header if needed
1. **Accumulate totals**
    - Maintains running totals for the customer/note
1. **Update customer postings**
    - On each transaction, updates the posting file with payment date, running total, etc.

---

## 4. Subroutines: Details

### a) **Break on Customer (`brd_kunde`)**

- When the customer changes, this "break" routine:
    - Prepares the KID number (`xkidd`)
    - Writes bank giro output (`skr_giro`)
    - Writes summary/total lines for the customer
    - Handles name/address formatting, and modulus calculation for KID/check digit (`AK720R`)
    - Splits values for printing (e.g., separating kroner and øre)
    - Removes leading zeros in value fields for cleaner printout
    - Calls output print subroutine (`xprint`)

### b) **Output to Bank Giro File (`skr_giro`)**

- Copies relevant fields to the giro file structure and writes a record (including new KID)

### c) **KID Preparation (`xkidd`)**

- Builds a long KID field, sets up all its substrings, and calls a routine to calculate the check digit.
- Handles various logic for whether and how the KID should be written (parameters for short/long, dummy, etc.)

### d) **Output Print Routine (`xprint`)**

- Writes various lines to the print depending on the context—amounts, fees, discounts, company, giro H-lines, and more.

---

## 5. Initialization Logic

- At program start (`*inzsr`):
    - Builds keyed lists for file access
    - Reads form register to set up how to process and print (company, layout, etc.)
    - Calls external routine for company info as needed
    - Sets up blank forms as required
    - Retrieves the last used serial or note number
    - Initializes company info fields

---

## 6. Indicator Usage

The code uses RPG indicators for various states:
- **KA, KC:** Function keys (firm selection, exit)
- **LR:** Last Record (end-program)
- **30:** Protect screen fields
- **31-59:** Error/warning lamps
- **60-69:** File operations (chain, etc.)
- **70-79, 80-89:** Work indicators
- **90-99:** For standard subroutines

---

## 7. External Calls

- **RÅ707R:** Fetches company info (address, fax, bank, etc.)
- **RS203R:** Date calculation (payment due)
- **AK720R:** KID check digit calculation
- **AK700R:** For updating KID in some cases

---

## 8. Special Features

- Handles both short and long KID numbers (with check digit)
- Selectively omits company info from print/giro based on form register and parameter
- Handles both print (physical or electronic), and giro file output (for bank/payment processing)
- Writes to serial/number file to update the last used serial for notes

---

## 9. Maintenance Notes

- **Norwegian comments:** Many comments are in Norwegian. Be sure to use translation for onboarding if not fluent.
- **Customization:** Check the form register (faforl1) for how the program should be tailored for different companies or print routines.
- **Indicator and File Usage:** Classic RPG style with heavy use of indicators and overlays—modern RPG would likely use service programs and procedures.

---

# Onboarding Checklist

- **Understand customer and company master data layout**: Know how fields map in the files.
- **Familiarize with KID logic**: These are central to payment reconciliation.
- **Learn external call interfaces**: Especially for company, date and KID routines.
- **Know the print formats**: How headers, lines, and summaries are constructed.
- **Indicators and Error Handling**: Note old-style use of indicators for error and control flow.

---

# Summary

This program embodies a classic, flexible "general invoice" generator for Scandinavian companies, supporting bank KID logic and advanced print customization via external routines and form setup. It is highly dependent on master data, indicator values, and external program calls for its operation. 

For maintainers or new developers:
- Start by mapping the files and their fields to business concepts.
- Trace a single run for one customer to follow all the moving pieces.
- Study the subroutine structure for how and when company, print, and payment info is handled.

This is a robust legacy RPG solution, and onboarding will be much easier after becoming familiar with traditional RPG flows and Scandinavian invoicing concepts!