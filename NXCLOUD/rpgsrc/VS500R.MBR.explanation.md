# Documentation for Program VS500R

## Overview

This program, **VS500R**, is a display file-driven RPG application running on the ASOFAK system. Its primary function is to present and manage search text records (`s�ketekst`) in a subfile interface, supporting paging and user navigation. The code is written in RPG/400 (traditional fixed-format RPG IV), designed for interactive use with workstation files and subfiles.

The main business logic revolves around displaying, refreshing, and navigating through records from the `VSOKL1` file (search text register), filtered by company (`firm`) and item (`vare`). The UI is managed through various display file records and subfiles.

---

## File Definitions

- **VSOKL1**: Physical file, keyed access, renamed record format (`vsokpfr` → `vsokl1r`). This is the data source for the subfile, representing the search text register.
- **VS500D**: Workstation display file, with subfile support (`sfile(b1sfl:w_srrn)`), and an INFDS (`dspfbk`) for feedback from the display.

---

## Key Data Structures & Variables

- **Parameters**: `p_firm`, `p_vare` (company and item, passed in at program entry).
- **Display Feedback Data Structure (`dspfbk`)**: Used to retrieve the first record number displayed on the current page (`d_fcrn`).
- **Paging and Subfile Control Variables**:
    - `w_fcrn`: First record number on the current page.
    - `w_spge`: Subfile page size (number of records per page).
    - `w_srrn`: Current relative record number in the subfile.
    - `w_sfrn`: First record number on the last page.
    - `w_ssrn`: Last record number on the last page.
- **Constants**:
    - `c_sfil`: Subfile page size increment (default 9).

---

## Display File Record Formats

- **B1SFL**: Subfile record for displaying individual search text entries.
- **B2CTL**: Subfile control record (header, footer, and page controls).
- **B2CMD**: Command key prompt screen.

---

## Indicator Usage

- **LR**: End program.
- **10**: Roll (page down).
- **12**: Subfile display.
- **13**: Subfile display control.
- **14**: Subfile clear.
- **15**: Subfile end (no more records).
- **16**: Readc (no more records in subfile).
- **21**: Home key pressed.
- **22**: Cursor placement.
- **30**: Field protection on display.
- **31–79**: Error and status indicators.
- **80–89**: Work indicators.
- **90–99**: File indicators (chain, etc.).

---

## Main Program Flow

### 1. **Initialization (`*INZSR`)**
- Receives parameters for company and item.
- Sets up the key list for file access.
- Initializes local variables from parameters.
- Positions to the correct key in `VSOKL1` (using `SETLL`).
- Calls `crt_subfile` to populate the subfile with the initial page of data.

### 2. **Main Display Loop**
- Uses two tags: `b2taga` (send command keys screen) and `b2tagb` (main subfile processing).
- `b2taga`: Writes the command key prompt (B2CMD), then jumps to `b2tagb`.
- `b2tagb`: Calls `dsp_subfile` to display the subfile and process user input.

### 3. **Function Key Handling**
- **Exit (F3, F12)**: End program.
- **Refresh (F5)**: Calls `forny` to refresh the subfile from the current position.
- **Roll (F10)**: Calls `crt_subfile` to page forward.
- **Page Back (F11)**: Calls `bck_subfile` (not implemented in this snippet).
- **Home (F21)**: Sets cursor placement indicator and returns to command key prompt.

---

## Subroutines

### `forny` (Refresh Subfile)
- If a current first record exists, attempts to chain to it in the subfile.
- Repositions the database file to the current key (`SETLL`).
- Clears and repopulates the subfile.

### `clr_subfile` (Clear Subfile)
- Sets indicator 14 to clear the subfile and writes the control record.
- Resets subfile-related counters and indicators.

### `crt_subfile` (Create/Populate Subfile)
- Increments the page size and sets the current record number.
- Reads records from `VSOKL1` using `READE` (by key).
- For each record, populates the subfile record and writes it to the display.
- Sets end-of-file indicator (15) when no more records are found.
- Updates subfile paging variables.

### `bck_subfile` (Page Back)
- Placeholder for logic to page backward in the subfile (not implemented in this code).

### `dsp_subfile` (Display Subfile)
- If there are subfile records, sets indicator 12 (display subfile).
- Otherwise, displays the command key prompt.
- Sets indicator 13 (display control), then executes `EXFMT` on the control record.
- Updates the current first record number from the display feedback data structure.

---

## Design Patterns and Conventions

- **Subfile Paging**: Uses manual counters and indicators to manage subfile paging, rather than relying on built-in subfile paging support.
- **Display Feedback**: Utilizes the INFDS data structure to track cursor and paging position, enabling "return to last position" after refresh.
- **Indicator Management**: Follows a strict indicator convention for both UI and logic, as documented in the header.
- **Modular Subroutines**: Key UI and data operations are encapsulated in named subroutines (`forny`, `clr_subfile`, `crt_subfile`, `dsp_subfile`), supporting maintainability and reuse.
- **Key List (`klist`)**: Used to define composite keys for file access, ensuring correct filtering by company and item.

---

## External Interfaces

- **Files**: Interacts with `VSOKL1` (database) and `VS500D` (display file).
- **Parameters**: Receives company and item as parameters, typically from another program or menu.
- **No APIs or external modules** are directly called in this code; all logic is self-contained except for the display and data files.

---

## Business/Domain-Specific Notes

- The program is designed for Norwegian business users (as indicated by comments and field names).
- The primary business function is to search for and display "search texts" (likely item or product descriptions) filtered by company and item.
- Subfile navigation is central: users can page forward, refresh, and (potentially) page backward through results.

---

## Notable Omissions and Extensions

- **Backwards Paging (`bck_subfile`)**: The code for paging back in the subfile is only stubbed out; actual logic should be implemented as needed.
- **Error Handling**: The code assumes successful file operations; production code should handle errors (e.g., missing records, file status).
- **Field Protection and Additional UI Logic**: Indicator 30 and others are reserved for field protection and more advanced UI handling, but are not detailed here.

---

## Summary

This program provides a subfile-based UI for searching and displaying records from a search text register, supporting basic paging and refresh. It is modular, indicator-driven, and expects integration with external menu or calling programs via parameters. The design is typical for interactive RPG/400 applications, but follows local conventions for indicator usage and subfile management.