# Explanation of RPG Program (VP601R): Price Book Report

This program is an IBM ILE RPG application designed to generate a price book (prisbok) report, with flexible options for filtering, grouping, and printing product pricing information. It is typical in wholesale or distribution environments, and has evolved over decades (see the detailed change log at top).

Below is a walkthrough of the key structures, controls, and logic for onboarding developers new to this code.

---

## 1. **Header and Documentation**

The header includes:

- Compilation options
- “datedit(*dmy)” - Date fields use day/month/year order.
- A comprehensive change log for traceability.

---

## 2. **File Definitions (`F-Specs`)**

Input/output files, mostly physical files mapped to logical views for selection. Some are renamed to local names for clarity.

- Files like `vvarl9`, `vshel1`, `vogrl1`, `vhgrl1`, etc., contain product, product groupings, assortment, supplier, price, unit, etc.
- `vp601p` is the printer output file with an information data structure (`infds`).
- Arrays: One large array (`a_index`) for table of contents/index.

---

## 3. **Data Structures (`D-Specs`)**

- **Local Data Area Mapping** for shared memory passage (`uds`).
- **Parameter DS:** Incoming processing parameters (product group, supplier, flags, dates, etc.)
- **Printer File Info (`d_infds`)**: To track page numbers.
- **Index Structure:** Used to build a table of contents with page references.
- Variables correspond to database keys and working fields for calculations.

---

## 4. **Main Program Logic**

### Initialization

- Subroutine `HODE` writes the report header, including parameters and selection criteria.
- `b_frst` flag marks if this is the first processed item in a group.

### Main Selection

- Depending on user selection (via input parameter structure), one of these is called:
  - `behandl_vsor` (by assortment)
  - `behandl_vgrp` (by product group)
  - `behandl_ldor` (by supplier)
  - `behandl_tot` (all products)

### Table of Contents

- After data processing, `index` writes a table of contents for the report.

### Program End

- `*inlr = *on` and `return` to end the program.

---

## 5. **Subroutines**

### 5.1. **Header (`hode`)**

- Gets timestamp and company name.
- Fetches relevant group/supplier descriptions for all filters.
- Sets textual fields for printing in headers.
- Writes report title pages.

### 5.2. **Assortment Processing (`behandl_vsor`)**

- Calls an external program (`VD700R`) to build selection file for assortment.
- Reads from a work file (`vvawpf`) with the selected assortment products.
- For each unique product, calls the core processing routine.

### 5.3. **Group Processing (`behandl_vgrp`)**

- Reads products from the main file based on group parameters.
- Handles sub-groups (overgruppe/hovedgruppe/undergruppe) via different key lists.
- Calls to process each product.

### 5.4. **Supplier Processing (`behandl_ldor`)**

- Iterates the main file, filtering on supplier number.
- Sends matching products to core processing.

### 5.5. **Total Processing (`behandl_tot`)**

- Simply iterates all products for processing.

---

## 6. **Core Product Processing (`behandling`)**

This is the main logic for each selected product.

- **Filters products:**
  - Excludes diverse, "skaffevarer" (on-demand), discontinued, or price-excluded products.
  - Uses various flags and product types to enforce selection logic.
- **Handles Group/Page Breaks:**
  - Prints group headers when group changes.
  - Maintains old group values for comparison.
- Fetches prices (subroutine `priser`).
- Prints detail lines for main unit and, if present, extra units (2 and 3).
- Optionally prints extra lines for better readability if user chose so.
- Updates “old” group values for next iteration.

---

## 7. **Price Calculation (`priser`)**

This is a non-trivial routine; it tries to fetch up to three prices for a product.

- **Step 1:** Tries on "prisbokenheter" from the product-unit file.
    - For each, attempts to fetch a price from the price file.
    - If price not found for a product group, retries with blank group.
- **Step 2:** If not enough prices found, tries on “sales units”.
- **Step 3:** Looks for special offer prices if user requested it. If not available for the requested delivery type, also tries with delivery type zero.
- **Step 4:** Tries to fetch offers based on group/supplier combinations (via `tilb_sjekk`).
- **Step 5:** Updates working fields for units and the corresponding prices.

---

## 8. **Offer Price Group Checking (`tilb_sjekk`) & Offer Fetching (`hent_tilb`)** (6.22, 6.24+)

- Tries for group/supplier-level special offers by cascading specificity (from all group fields filled, down to just supplier).
- Applies percentage discounts from offer records to base prices.

---

## 9. **Price Fetching (`hent_pris`)**

- Searches for product price records by combination of keys.
- If not found for specific delivery type, tries with delivery type zero.

---

## 10. **Subroutines for Group/Break Handling** (`hode_ogrp`, `hode_hgrp`, `hode_ugrp`, `hode_ldor`)

- Each writes the appropriate group header (with names and codes).
- Logs each page number and header text in the index array for the table of contents.

---

## 11. **Detail Printing (`detalj`, `detalj_enh2`, `detalj_enh3`)**

- Composes details for each product and unit (main, unit2, unit3).
- Calculates special offer or base price, gross/net if needed.
- Looks up and includes price code and its description.
- Calls a function to add VAT if required.
- Writes lines to the report.

---

## 12. **Overflow Handling (`overflow`)**

- Each section writes a new header if an overflow indicator is set.

---

## 13. **Table of Contents Generation (`index`)**

- Writes a contents section at the end, listing major group breaks and the page number on which they appear.

---

## 14. **Initialization Subroutine (`*inzsr`)**

- Handles all the key list definitions (for indexed reads/chains).
- Maps input parameter area into working variables.
- Calls utility programs to fetch VAT rates and company info.
- Calls a program to fetch the correct price group for the warehouse (lagernr).

---

## 15. **External Program Calls**

- **'VD700R'** — Selects assortment/groupings.
- **'VL710R'** — Fetches product type and info for screening.
- **'VL712R'** — Looks up price group.
- **'FØ705R'** — Fetches VAT factors.
- **'FA909R'** — Calculates price with VAT.

These are assumed to be standard utility programs in this system.

---

## 16. **Key Observations and Takeaways**

- **Highly parameterized:** Selection and grouping logic adapts based on flags and parameters, allowing flexible reporting.
- **Modular structure:** Each aspect (selection, group breaks, pricing, printing) is encapsulated in a subroutine, making the flow easier to follow.
- **Legacy RPG:** Uses fixed-format RPG IV, with newer features sometimes marked by version numbers in comments.
- **Extensive use of external programs:** For data selection, price-group resolution, VAT, etc.
- **Index/Table of Contents Logic:** Useful for large reports.

---

## 17. **Onboarding Recommendations**

- Study the key files’ formats (pricelist, units, groups, assortment).
- Understand the parameter data structure and what the incoming flags mean.
- Familiarize yourself with external program interfaces, as these are critical to the selection and calculation logic.
- Run the report with different parameters/groups to see output variations.
- The main loop and filtering logic are in `behandling` and `priser` routines—read these carefully.

---

## 18. **Potential Modernizations**

- Move to free-format RPGLE for clarity/maintainability.
- Modularize further, possibly using service programs.
- Replace hard-coded keys and magic numbers with named constants or metadata.
- Consider dynamic SQL or embedded SQL for complex file access.

---

**Summary:**  
This program is a robust, highly parameterizable, and well-structured RPG legacy price book generator with intricate group, selection, and offer logic. The code is organized into clear subroutines for maintainability and extensibility, with a heavy reliance on external utility programs and classic RPG database/file handling patterns.