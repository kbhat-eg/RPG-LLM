# FO684R â€“ Invoice Journal Short Printout (Purchasing)

## Overview

**Program Name:** FO684R  
**Description:** Printout of invoice journal (short format) for purchasing  
**Original Author:** GRO  
**Major Updates:**  
- 25.06.09 (BSA): Added tracking information  
- 03.06.14 (BSA): Revised for number field extensions (nummerutvidelser)

This program generates a short-form invoice journal report for purchasing transactions. It reads invoice headers, retrieves customer and transaction data, and produces a formatted printout. It also updates historical invoice records to mark which invoices have been journaled.

---

## File Definitions and Relationships

- **sohel1**: Invoice header file (main input, short journal)
- **sohelu**: Invoice header update file (used for marking journaled invoices)
- **rkunl1**: Customer master file (for retrieving customer names)
- **aforl1**: Form register (for printout formatting)
- **fntrl1**: Transaction/number register (for number-related logic)
- **fo684p**: Printer file (output)

All files are keyed and renamed locally for clarity and to avoid naming conflicts.

---

## Data Structures

- **dsparm (33A)**: Parameter block for incoming program parameters, overlayed for individual fields:
  - `dsaarr` (4,0): Year
  - `dsotyp` (2A): Order type
  - `dsffnr` (8,0): From number
  - `dstfnr` (8,0): To number
  - `dsprog` (10A): Program name

- **LDA-related fields**: Various fields (user, firm, workstation, etc.) are extracted from the user data space (LDA) for use in headings, audit, and printout.

- **Working variables**: Used for passing keys, temporary values, and formatting output.

---

## Key Business Logic

### 1. **Initialization (`*inzsr` and `xstrsr`)**

- Program parameters are parsed and mapped to local variables.
- LDA fields are loaded for use in audit trails and report headings.
- Sets up keys for file access and initializes working variables.
- If no "from" or "to" numbers are specified, fetches the next available journal number from the number register (via subprogram `AS100R`).

### 2. **Main Processing Loop**

- Begins by writing the report heading.
- Iterates through the invoice header file (`sohel1`), processing each record unless a new firm or year is encountered.
- For each invoice:
  - Checks if it is within the specified range (firm, year, from/to numbers).
  - Skips invoices already journaled unless the selection criteria dictate otherwise.
  - Chains to the transaction/number register (`fntrl1`) for additional validation.

### 3. **Invoice Handling**

- **xajour**: Prepares data for printout.
  - Converts and formats invoice and due dates.
  - Retrieves customer name from the customer master file.
  - Populates all print line variables.
  - Adds the invoice amount to the running total.
  - If the invoice has not been journaled before and no from/to numbers are specified, marks it as journaled, updates audit fields (user, date, time), and updates the historical file (`sohelu`).

- **xprint**: Handles the actual printout of the invoice line.
  - Writes the detail line.
  - Checks for overflow and, if needed, writes a new heading (via `xovrfl`).

### 4. **Totals and Completion**

- When a new firm/year is encountered or the loop ends, writes the totals line.
- Sets LR indicator to *ON for program end.

---

## Special Subroutines

### **hntnum**
- Calls subprogram `AS100R` to retrieve the next available journal number.
- Used when the selection is for all unjournaled invoices (i.e., no specific range).

### **xajour**
- Prepares and formats data for each invoice line.
- Handles historical update logic, ensuring invoices are only marked as journaled if they weren't already and only when appropriate.

### **xprint**
- Writes invoice detail line to the report.
- Handles page overflow by triggering a new heading.

### **xovrfl**
- Writes a new heading on page overflow.

### **xstrsr**
- Handles one-time initialization (firm, year, keys).
- Fetches the next available journal number if needed.
- Reads the first invoice and writes the first heading.

---

## Design Decisions and Conventions

- **Parameter Handling:** Uses a 33-character parameter block for flexible passing of multiple parameters between programs. Overlays are used for efficient field extraction.
- **File Keying:** Key lists (`klist`) are defined for all files to ensure correct record retrieval and maintainability.
- **Audit Trail:** Updates to the historical invoice file include user, date, and time fields for traceability.
- **Journal Marking:** The program only marks invoices as journaled when not running a specific range, ensuring that reruns or partial selections do not incorrectly update records.
- **Number Extension:** The code has been revised to handle expanded number fields (8 digits), reflecting changes in business requirements for larger invoice numbers.
- **Internationalization:** Date and decimal edit codes are set to support DMY format and comma as decimal separator, matching local conventions.

---

## External Dependencies

- **AS100R**: Subprogram for fetching the next available journal number from the number register.
- **LDA (Local Data Area):** Used for passing user/session-specific context (user, firm, workstation).

---

## Report Formats

- **a1hdr**: Report heading
- **a1det**: Invoice detail line
- **t1tot**: Totals line

---

## Summary

This program is a specialized report generator for purchasing invoice journals, designed for auditability and efficient bulk processing. It is tightly integrated with the firm's numbering and historical tracking systems. The logic ensures accurate reporting, prevents duplicate journalization, and supports both full and partial selections (by number range). The codebase follows local conventions for data formatting and is structured for maintainability and future enhancements, especially regarding number field expansions.