# Program MJ500R — Kontroll av gyldig logistikkpunkt

## Overview

**MJ500R** is a business logic program responsible for validating the existence of a "logistics point" (logistikkpunkt) within the system. The program checks the presence of a specific logistics point in the `MJLOPFR` physical file (accessed as `MJLOL1` record format), using various key fields. If a valid entry is found, the program returns associated address and contact information. Otherwise, it returns a status indicating non-existence.

This program is typically called from other modules to validate logistics points and retrieve their attributes. It is not a standalone application but a service routine in the logistics domain.

---

## Main Data Sources and Relationships

- **MJLOPFR**: The primary database file, renamed locally to `MJLOL1R`. It stores logistics point records.
- **LDA (Local Data Area)**: Used to retrieve context such as the user's firm number (`l_firm`).

---

## Parameters (Entry List)

The program is called with the following parameters (all passed by reference):

| Parameter | Purpose                                                      |
|-----------|--------------------------------------------------------------|
| p_stat    | Return code: blank = found, 'N' = not found                  |
| p_lage    | Warehouse/location code                                      |
| p_avde    | Department code                                              |
| p_skaf    | Procurement code (skaffekode); identifies "skaffeordre"      |
| p_eann    | Output: EAN number (from logistics point)                    |
| p_sted    | Output: Place/location name                                  |
| p_adr1    | Output: Address line 1                                       |
| p_adr2    | Output: Address line 2                                       |
| p_pste    | Output: Postal code                                          |

---

## Program Flow and Logic

### 1. Initialization

- The program begins with the `*INZSR` subroutine, which loads the current firm number from the LDA into `w_firm`.
- Parameters are defined in the entry parameter list.

### 2. Key Building

- The key to the `MJLOL1` file is composed of:
    - `w_firm` (from LDA)
    - `mjlol1_lage` (from `p_lage`)
    - `mjlol1_avde` (from `p_avde`)
    - `mjlol1_skaf` (from `p_skaf`)

### 3. Lookup Logic

The core logic is a series of conditional lookups, with fallback strategies:

#### A. If `p_skaf` (procurement code) is specified (i.e., not blank):

1. **Full Key Lookup:**  
   - Chain to `MJLOL1` using firm, location, department, and procurement code.
   - If found:
     - Set `p_stat` to blank (found).
     - Populate output parameters from the found record.
     - Exit program.

2. **Fallback: Ignore Department**  
   - Set department (`mjlol1_avde`) to 0.
   - Chain again with firm, location, zero department, and procurement code.
   - If found:
     - Populate outputs as above.
     - Exit program.

3. **Fallback: Ignore Procurement Code**  
   - Reset department to original value.
   - Set procurement code (`mjlol1_skaf`) to blank.
   - Continue (drops to next check).

#### B. If `p_skaf` is blank (or after above fallbacks):

1. **Full Key Lookup:**  
   - Chain to `MJLOL1` using firm, location, department, and blank procurement code.
   - If found:
     - Populate outputs.
     - Exit program.

2. **Fallback: Ignore Department**  
   - Set department to 0.
   - Chain again.
   - If found:
     - Populate outputs.
     - Exit program.

#### C. Not Found

- If none of the above lookups succeed, set `p_stat` to `'N'` (not found).

### 4. Program Termination

- The program sets on LR (`*INLR = *ON`) and returns.

---

## Business/Domain-Specific Logic

- **"Skaffeordre" Handling:**  
  The logic distinguishes between logistics points that are specifically tied to a procurement code (`skaffekode`). If a procurement code is specified, the program prioritizes finding a match with it, but will attempt to find a more general match if not found.

- **Department Fallback:**  
  If no match is found for the provided department, the program attempts a lookup with department set to zero, which represents a generic or default department.

- **Procurement Code Fallback:**  
  If a procurement-specific record is not found, the program tries to find a record without a procurement code, allowing for a more general logistics point definition.

- **Return Codes:**  
  - `p_stat = *blank` means a valid logistics point was found.
  - `p_stat = 'N'` means no matching logistics point exists.

---

## Design Patterns and Conventions

- **Indicator Usage:**  
  Standard indicator conventions are followed (see comments for ranges).
- **Key List (`KLIST`) Usage:**  
  The program uses a named key list for chaining to the file, improving maintainability.
- **Parameter Passing:**  
  All data is passed by reference, allowing the caller to receive updated values directly.
- **Structured Fallbacks:**  
  The layered fallback logic (full key → generic department → generic procurement code) is a recurring pattern in our logistics validation routines.

---

## External Dependencies

- **MJLOPFR** file must be accessible and properly keyed.
- **LDA** must be populated with firm/user context by the caller or environment.

---

## Notes for New Developers

- The program expects the caller to provide valid input parameters and to interpret the output parameters and status appropriately.
- The fallback logic is critical for supporting both specific and generic logistics point definitions.
- If extending this logic, ensure that the key-building and fallback order is preserved to maintain business rules.
- The program does not handle error reporting beyond the status code; any additional diagnostics must be implemented in calling programs.

---

## Summary Table: Lookup Attempts

| Attempt | Department | Procurement Code | Purpose             |
|---------|------------|------------------|---------------------|
| 1       | Provided   | Provided         | Most specific match |
| 2       | 0          | Provided         | Dept-agnostic       |
| 3       | Provided   | Blank            | No procurement code |
| 4       | 0          | Blank            | Generic/default     |

---

## Contact

For questions about logistics point validation logic or integration, contact the logistics application architect or refer to the logistics subsystem documentation.