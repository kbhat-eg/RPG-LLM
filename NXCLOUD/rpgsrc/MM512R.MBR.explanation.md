# MM512R - Documentation

## Overview

**Program:** MM512R  
**System:** ASLOGI  
**Description:**  
This program manages the "Innkjøpsparameter Arbeidsregister (simulert)"—a simulated working register for purchase parameters. It provides a subfile-based interactive display (workstn) for browsing, filtering, and inquiring about purchase parameters for items, warehouses, and related groupings. The program is central to the purchasing and inventory planning process, enabling users to view and position on various keys (item, warehouse, ABC code, reorder point, order quantity, min stock, etc.) and to drill down to related information.

## Key Concepts and Domain Logic

- **Subfile Browsing:**  
  The main user interface is a subfile (B1SFL) where users can browse and filter purchase parameter records.
- **Positioning:**  
  Users can position the subfile view using several keys (item, warehouse, ABC code, reorder point, order quantity, min stock).
- **Inquiry and Drilldown:**  
  The program allows users to view forecasts, warehouse maintenance, and inventory inquiries by calling external programs.
- **Purchase Parameters:**  
  The data shown and manipulated relates to purchase parameters per item/warehouse, such as reorder points, quantities, minimum stock, and grouping codes.

## Structure and Flow

### File Declarations

- **mprolr, mprwl3-8:**  
  Logical files over the purchase parameter file, each with a different key sequence for efficient access based on user positioning.
- **vvarl1, vlagl1:**  
  Item and warehouse master files for supplementary information.
- **mm512d:**  
  Display file containing subfile and control formats.
- **infds(dspfbk):**  
  Display feedback data structure for cursor positioning, etc.

### Data Structures and Variables

- **Local Data Area (LDA):**  
  Used to pass user, company, and navigation info.
- **Display Feedback (dspfbk):**  
  Used for screen cursor handling.
- **Key Variables:**  
  Variables like `mprwl3_vare`, `mprwl4_lage`, etc., are used for building keys for file access.
- **Subfile Control Variables:**  
  Variables like `w_fcrn`, `w_srrn`, `w_ssrn`, etc., track subfile paging and record numbers.

### Main Processing Flow

#### Entry and Initialization

- **Parameter List:**  
  Receives group and item keys for initial positioning.
- **LDA Initialization:**  
  Loads company and user context.
- **Key Lists:**  
  Key lists (`klist`) are defined for each logical file to allow flexible positioning.
- **Subfile Initialization:**  
  The subfile is filled (`crt_subfile`) starting from the appropriate position.

#### Main Loop

- **Control Screen (b2ctl):**  
  The main control screen displays the subfile and handles function key input.
- **Function Key Handling:**  
  - F3/F12: Exit
  - F4: Inquiry
  - F5: Refresh
  - F10/F11: Page up/down in subfile
  - F21: Home/position
  - F22: Cursor placement
  - Other custom keys for toggling display modes

#### Positioning Logic

- Users can enter values for item, warehouse, ABC code, reorder point, order quantity, or minimum stock to position the subfile.
- The `posisjoner` subroutine sets the appropriate key and repositions the file pointer.

#### Subfile Management

- **Subfile Read/Write:**  
  Records are read from the correct logical file (mprwl3-8) based on the current positioning key.
- **Filtering:**  
  Additional filters are applied in `crt_subfile` to only show relevant records (matching groupings, warehouse, item, etc.).
- **Paging:**  
  Paging variables (`w_srrn`, `w_spge`, etc.) manage which records are shown per screen.

#### Drilldown and External Calls

- **Forecast Inquiry (AX711R, MM502R):**  
  Shows item forecast by week.
- **Warehouse Maintenance (LL101R):**  
  Opens warehouse maintenance for the selected item/warehouse.
- **Inventory Inquiry (LL502R):**  
  Shows inventory details for the selected item.
- **Item Inquiry (VV500R):**  
  Shows item details in a separate program.
- **Price Group Retrieval (VL712R):**  
  Used to determine the correct price group for the item/warehouse.
- **Price Calculation (VP750R):**  
  Retrieves cost and input prices for the item.

### Subroutines

- **forny:**  
  Refreshes the subfile based on the current position.
- **posisjoner:**  
  Handles user requests to position the subfile on a specific key.
- **subfile:**  
  Handles main subfile processing and drilldown actions.
- **xh1win:**  
  Handles display and processing of the "bla-alternativer" (paging/filter options).
- **clr_subfile:**  
  Clears the subfile (sets *in14, writes b2ctl).
- **crt_subfile:**  
  Fills the subfile with the next page of records, applying all necessary filters.
- **bck_subfile:**  
  Handles paging backward in the subfile.
- **dsp_subfile:**  
  Handles display of the subfile and control format.
- **spørring:**  
  Handles item inquiry.
- **finn_pris:**  
  Retrieves cost and input price for the current item/warehouse.
- **hent_prisgr:**  
  Retrieves the price group for the item/warehouse.

## Design Patterns and Conventions

- **Logical File Layering:**  
  Multiple logical files over the same physical file to support efficient key-based positioning.
- **Subfile Paging:**  
  Standard IBM i subfile paging pattern, using relative record numbers and control variables.
- **External Program Calls:**  
  Business logic is modularized; related inquiries and calculations are delegated to dedicated programs.
- **Indicator Usage:**  
  Classic RPG indicator usage for screen and program flow control.
- **Extensive Filtering:**  
  Filtering is done both at the file level (via logical files and keys) and at the subfile fill stage, to ensure only relevant records are shown.
- **Display Modes:**  
  The user can toggle between summary and detailed display modes (`b_vise`).

## Module and Data Relationships

- **mprolr / mprwl3-8:**  
  Purchase parameter records, central to the module.
- **vvarl1:**  
  Item master, used for descriptive information.
- **vlagl1:**  
  Warehouse master, for warehouse-specific info.
- **External Programs:**  
  - `AX711R`, `MM502R`: Forecasting
  - `LL101R`, `LL502R`: Warehouse/inventory
  - `VV500R`: Item inquiry
  - `VP750R`: Price calculation
  - `VL712R`: Price group lookup

## Notable Business/Domain-Specific Logic

- **Purchase Parameter Filtering:**  
  The program supports filtering and positioning on a variety of keys relevant to purchasing and inventory management: item, warehouse, ABC code, reorder point, order quantity, min stock, and multiple grouping levels.
- **Dynamic Display:**  
  The user can toggle between summary and detail modes for the subfile.
- **Cost/Price Calculation:**  
  Cost and input price data are dynamically retrieved based on current item, warehouse, and date context.
- **Paging and Positioning:**  
  The program provides robust support for paging and positioning within the subfile, essential for managing large datasets.

## Non-Obvious Design Decisions

- **Use of Multiple Logical Files:**  
  Instead of using a single logical file and filtering in code, the program uses several logical files with different key orders to optimize positioning and reading.
- **Subfile Fill/Filtering:**  
  Even after positioning via key, additional filtering is performed in code to ensure that only records matching all user-selected criteria are displayed.
- **Indicator-Driven UI:**  
  The user interface and flow control are heavily indicator-driven, consistent with traditional IBM i/RPG patterns but requiring careful tracking, especially for new developers.
- **Externalization of Calculations/Inquiries:**  
  The program delegates complex business logic (e.g., price calculation, forecast retrieval) to external programs, simplifying this program's responsibilities and supporting modularity.

## Conventions

- **Field Naming:**  
  Prefixes such as `w_`, `b_`, `p_`, etc., are used to distinguish working, boolean, and parameter variables.
- **Subfile Record Numbering:**  
  Variables like `w_srrn`, `w_ssrn`, etc., manage the subfile's current, start, and end record numbers for paging.
- **Key List Names:**  
  Key lists are named according to the logical file and positioning field.

---

## Summary Table: Subfile Positioning Keys

| Key      | Logical File | Purpose                | Variable           |
|----------|--------------|------------------------|--------------------|
| vare     | mprwl3       | Item                   | mprwl3_vare        |
| lage     | mprwl4       | Warehouse              | mprwl4_lage        |
| kabc     | mprwl5       | ABC code               | mprwl5_kabc        |
| bpun     | mprwl6       | Reorder point          | mprwl6_bpun        |
| bmen     | mprwl7       | Order quantity         | mprwl7_bmen        |
| mini     | mprwl8       | Minimum stock          | mprwl8_mini        |

---

## Key Takeaways for New Developers

- The program is a subfile-based browser for purchase parameter records, supporting advanced positioning and filtering.
- Efficient positioning is achieved by using multiple logical files with different key orders.
- The user can interactively filter, page, and drill down to related information via external programs.
- The codebase uses classic RPG indicator-driven UI and modularizes business logic via external calls.
- Understanding the relationships between the various logical files, key lists, and subfile control variables is essential for effective maintenance and extension of this program.