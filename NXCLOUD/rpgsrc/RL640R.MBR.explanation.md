# RL640R – Vendor Account Statement Parameter Entry

## Overview

This program (`RL640R`) is the parameter entry and validation module for generating vendor account statements ("kontoutdrag leverandører"). It handles user input of selection criteria, validates those criteria, and prepares the parameters for the actual statement generation. The program interacts with several data files, calls auxiliary programs for lookups, and enforces business rules regarding vendor, period, and category selection.

This module is primarily a display file driven interactive program, typically invoked as the first step in the account statement process. It is tightly coupled to the display file `RL640D` (workstn), and to the vendor master (`RLEVLR`), user parameters (`AUSRL1`), and several lookup programs (`RA507R`, `RA514R`, `RL500R`).

---

## Structure

### File Declarations

- **AUSRL1**: User parameter file. Used to determine user-specific restrictions (e.g., limited to a specific department).
- **RL640D**: Display file, provides the interactive screens for parameter entry.
- **RLEVLR**: Vendor master file, renamed as `RLEVLrr` in this program. Used for vendor number validation.

### Data Definitions

- **Working variables**: Used for year, period, vendor number, etc.
- **Parameter fields**: Mirror the fields on the parameter entry screen (`A2BLD`).
- **Control variables**: Used for internal state and indicator management.

### Indicators

The program uses RPG indicators extensively, following a documented convention:

- **KA/KC**: Function key indicators (F1 for company selection, F3 for exit).
- **LR**: End of program.
- **30**: Field protection.
- **31-59**: Error/warning indicators for screen messages.
- **60-69**: File operation indicators.
- **70-79/80-89/90-99**: Working indicators for subroutines and standard routines.

---

## Main Program Logic

### 1. Initialization (`*INZSR`)

- Loads user and company information.
- Sets default values for all selection fields.
- Calculates default accounting period (previous month).
- If the user is restricted to a department (`abbavd = 'J'`), auto-fills and protects the department fields.
- Prepares key lists for file access.

### 2. Main Loop

- **Display parameter entry screen** (`exfmt a2bld`).
- **Function key handling**:
    - **F3 (KC)**: Exit program.
    - **F4 (KD)**: Triggers lookup subroutine (`spr_rut`) for fields that require selection from auxiliary programs (e.g., department, category, vendor).
- **Validation**:
    - **Date and period checks**: Ensures all date/period fields are valid and within logical ranges.
    - **Range checks**: Validates that "from" values are not greater than "to" values for years, periods, departments, categories, and vendors.
    - **Vendor existence checks**: For each individually specified vendor (up to 10), verifies existence in the vendor master.
    - **Selection consistency**: Ensures that only one of category or department summary levels is selected.
    - **Sum level checks**: Only one sum level (category/department) can be selected.
    - **Defaulting**: If no vendor range or individual vendors are specified, defaults the vendor range to all vendors (`1` to `999999`).

- **Error Handling**: If validation fails, sets the appropriate indicator(s) for the screen to display error messages and returns to parameter entry.

- **Parameter Transfer**: On successful validation, moves all parameters to the export fields for use by downstream processes.

### 3. Lookup Subroutine (`spr_rut`)

Handles field lookups via program calls:

- **Department (`RA507R`)**
    - For both "from" (`A2PAVF`) and "to" (`A2PAVT`) fields.
- **Vendor Category (`RA514R`)**
    - For both "from" (`A2PKAF`) and "to" (`A2PKAT`) fields.
- **Vendor (`RL500R`)**
    - For "from" (`A2PLNF`), "to" (`A2PLNT`), and up to 10 individual vendor fields (`A2PLN1` to `A2PLN0`).

The subroutine determines which field triggered the lookup based on `w_afld`, calls the appropriate program, and updates the field with the selected value.

### 4. Program Termination

- Sets LR indicator and returns.

---

## Notable Business and Domain Logic

- **Vendor Selection**: Users can select a range of vendors or up to 10 individual vendors. If individual vendors are specified, each is validated for existence.
- **Period Logic**: The default period is set to the previous month. If the current month is January, the year is decremented and the period set to December.
- **Department Restriction**: Some users may be restricted to a specific department, which is enforced at initialization.
- **Summary Level**: Only one of category or department summary can be selected (not both).
- **Field Protection**: If restricted, department fields are protected from editing.
- **Error Messaging**: Uses indicators to set specific error or warning messages on the screen.

---

## Interactions with Other Modules

- **RA507R**: Department lookup.
- **RA514R**: Vendor category lookup.
- **RL500R**: Vendor lookup.
- **AUSRL1**: User parameter file (for restrictions).
- **RLEVLR**: Vendor master file (for validation).

All lookups are performed via program calls, passing the company number, the current value, and a text field for description.

---

## Design Conventions and Patterns

- **Indicator-based Control**: The program relies heavily on RPG indicators for flow control, error handling, and screen field management. This is consistent with legacy RPG/400 style.
- **Subroutine-based Structure**: Lookup logic is encapsulated in a single subroutine, called with field context.
- **Field Naming**: Field names reflect their function and screen mapping (e.g., `A2PLNF` for "vendor number from").
- **Parameter Copybook**: The `/COPY QCPYLESRC,RPARRKDS` brings in a standard parameter data structure used across related modules.
- **Error Handling**: Validation logic is structured as a series of `IF ... GOTO` statements, jumping back to the parameter entry tag when errors are detected.

---

## Summary Table

| Section           | Purpose                                                      |
|-------------------|-------------------------------------------------------------|
| Initialization    | Load defaults, user/company info, set up fields             |
| Main Loop         | Display entry, validate input, handle F-keys                |
| Validation        | Enforce business rules, set error indicators                 |
| Lookup Subroutine | Program calls for department, category, vendor lookups      |
| Termination       | Set LR, return                                              |

---

## Key Points for New Developers

- **This program is the gatekeeper for vendor account statement generation.** All business rules regarding parameter selection are enforced here.
- **All selection criteria are validated, and user restrictions are respected.** If you need to add new selection logic or validation, this is the central place.
- **Lookups are handled via external program calls.** If you need to change lookup logic (e.g., add more descriptive data), you will need to modify both this program and the called program.
- **Screen field-to-variable mapping is critical.** Changes to the display file must be reflected here.
- **Error handling is indicator-driven.** Ensure you understand which indicators control which messages and screen elements.

---

## References

- **Display File**: RL640D
- **Vendor Master**: RLEVLR
- **User Parameter File**: AUSRL1
- **Lookup Programs**: RA507R (department), RA514R (category), RL500R (vendor)
- **Parameter Copybook**: QCPYLESRC,RPARRKDS

---

For further details on field mappings, indicator usage, or business rules, consult the functional specification or the associated display file DDS.