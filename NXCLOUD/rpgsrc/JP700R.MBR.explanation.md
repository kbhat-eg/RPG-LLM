# RPG Program JP700R â€“ Explanation

---

## Overview

This program (`JP700R`) runs on IBM i (AS/400) using ILE RPG. It is designed to process file groups (filgrupper) associated with NOBB (Norwegian building industry database) contracts. The program handles parameters, screen display, and conditional flow, possibly adapting to different file group configurations, with added support for new processes based on provided parameters.

---

## Header and Documentation

- **h option(*nodebugio) datedit(*dmy)**  
  - Compiles without debug data for I/O operations.
  - Date editing defaults to day/month/year.

The header block contains a change log and comments providing the history and evolution of the program. This is useful for auditing and understanding recent modifications.

---

## File Declarations

- **acphl1**: Input file with keyed access (likely a master file for file groups), renamed for internal use.
- **jp700d**: Workstation file for screen I/O.

---

## Variable Definitions

- **b_feil**: Indicator (1 char), initialized to *off. Used to track error state.
- **acphl1_hfgr** and **acphl1_hfir**: Variables with the same type as fields `achfgr` and `achfir` (likely keys for file access).
- **w_firm**: Holds the current firm value (same type as `achfir`).
- **u_701**: 1-char switch, controls processing mode (changed in version 7.01).
- **User Data Structure (uds)**:
  - **l_wsid**: Workstation ID (positions 901-910).
  - **l_user**: User ID (911-920).
  - **l_fgrp**: File group (931-933).
  - **l_firm**: Firm (944-946).
  - **l_fnav**: Unclear, likely a filename or navigation string (951-980).

---

## External Program Definitions

**Version 7.01+ adds:**
- Call interface for external program `CO402R`, accepting file group/firm/lager/nokkel (key), and two return values (`co402_verdi1`, `co402_verdi2`).

---

## Main Logic

### Early Exit for Special Condition

```rpg
if u_701 = *on
  call 'JP705R'
  goto avslutt
endif
```
If `u_701` is enabled (set by CO402R, see below), processing is redirected to `JP705R` and then exits.

---

### Main Screen Loop (`b1taga`)

1. **Display Main Screen**  
   Waits for user interaction (`exfmt b1bld`).

2. **Function Key Handling**
   - If `*INKC` or `*INKL` pressed (usually F3=Exit/F12=Cancel), exits.

3. **File Group Validation**
   - If a file group is entered:
     - Load to `acphl1_hfgr`.
     - Set `acphl1_hfir` to current firm.
     - Tries to find matching record in `acphl1` file (`chain`).
     - If not found, signals error and redisplays the screen.

4. **Folder Name Defaulting**
   - If no folder is entered (`b1fldr`):
     - Defaults to current file group + '/NOBB'.

5. **Data Import Routine**
   - Calls program `JP700C` with folder and error indicator.
   - If error (`b_feil = *on`), displays a message and loops back.

6. **Control Program Calls**
   - If just one file group:
     - Calls `JP701R`, then `JP702C` with folder, group, and error indicator.
   - Else (multiple file groups from master group):
     - Calls `JP702R` with firm, file group, and folder.

---

### Program Exit (Label: `avslutt`)

- Standard RPG ending: sets LR indicator (`*INLR = *ON`) and returns.

---

### *INZSR Subroutine (Initialization)

- Defines a KLIST (`acphl1_key`) using `acphl1_hfgr` and `acphl1_hfir`.
- Default folder is set to current file group + '/NOBB'.
- `w_firm` initialized from user data.
- **Version 7.01+ Only:**
  - Calls external program `CO402R`, passing in parameters.
  - If `co402_verdi1` returns '1', sets `u_701 = *on` (controls early exit and alternative flow).

---

## Notable Modernizations

- **Use of DCL-S, DCL-PR/END-PR:**  
  In version 7.01+, free-format RPG is used for new definitions, indicating modernization and compatibility with newer standards.
- **Dynamic Switch for Alternate Flow:**  
  The response from CO402R allows for flexible handling of different data import methods (ex: XML-based) without changing user process.

---

## Summary

- **Main job:** Process NOBB contract data based on file groups, support both single and multiple group processing, and update records accordingly.
- **User sees:** A main screen, can enter parameters, and errors are handled gracefully.
- **Flexible for future extensions:** Use of external programs (like CO402R) and switches for alternate modes.
- **Well-documented:** Change history and clear subsections aid maintainability.

---

## What to Remember

- **Entry point:** Main is an event loop around screen `b1bld`.
- **Validation:** Checks file group/folder, enforces business rules.
- **Extensible logic:** External calls and version-specific switches for new features.
- **Error handling:** Via indicators and display messages to user.

This program is a good example of how classic RPG and modern free-format RPG coexist for incremental modernization, while maintaining robust business logic for transactional data entry and processing.