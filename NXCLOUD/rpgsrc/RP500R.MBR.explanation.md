# RPG Program `RP500R` – Explanation

This ILE RPG program (`RP500R`) is a classic, display file-driven inquiry program for working with "prosjekt" (projects). It’s a menu/subfile based interactive program, typical for IBM i midrange systems (“AS/400” style). Below is a detailed breakdown by sections, constructs, and key subroutines.

---

## 1. Control Specifications

```rpg
     h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: Disables debug input/output.
- `datedit(*dmy)`: Specifies day/month/year format for dates.

---

## 2. File Declarations

```rpg
     frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
     frp1pl2    if   e           k disk    rename(rp1ppfr:rp1pl2r)
     frp500d    cf   e             workstn sfile(b1sfl:w_srrn)
     f                                     infds(dspfbk)
```
- **rp1pl1, rp1pl2:** Input files (indexed sequential, externally described), both referencing the physical file `rp1ppfr` but using different record formats.
- **frp500d:** Display file (workstn) with a subfile (`b1sfl`). The subfile record number is controlled by variable `w_srrn`.
- `infds(dspfbk)`: Associates a display feedback data structure.

---

## 3. Data / Variable Definitions

### a. Parameters

```rpg
     d p_1frm          s                   like(rp1frm)
     d p_1pro          s                   like(rp1pro)
     d p_1alf          s                   like(rp1alf)
```
These are program parameters passed at startup, representing form, project, and description.

### b. Display Feedback Data Structure & Keys

```rpg
     d dspfbk          ds
     d  d_fcrn               378    379I 0
```
- Data structure for display file feedback (e.g., for cursor position).

### c. Variables for Subfile and Positioning

Variables such as `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc., are counters and pointers controlling the subfile and user’s position within it.

### d. State and Control

- `w_seqe`: Sequence indicator--controls whether you're working by project or by description.
- `b_valg_ok`: Flag indicating whether a selection (valg) has been made.

### e. Constants

- `c_sfil`: Number of entries per subfile page (default 8).

---

## 4. Intended Indicators

Comments specify which indicators are used for what (e.g., roll up, roll down, page control, error/warning, etc.), which is a common critical aspect in RPG and DSPF programs.

---

## 5. Main Program Loop

The structure is a "loop with exit on selection":

- **b2taga**: Initial tag, writes the command key screen.
- **b2tagb**: Main processing logic.
  - Calls session routines for subfile management, responds to function keys, and processes selection and navigation.
- **avslutt**: Terminates the program (sets LR indicator).

The main user interaction occurs by reading subfile records, and processing input according to indicators.

---

## 6. Subroutines

### a. `forny` — Refresh Subfile

- If there’s a current record, positions to it.
- Sets key for positioning (by project or description).
- Clears and re-creates the subfile at the new position.

### b. `posisjoner` — Position in Subfile

- If a project or description is entered, prepares for subfile population starting at that key.
- Clears positioning fields after operation.

### c. `subfile` — Subfile Handling

- Toggles indicator 22 for alternating display.
- Loops through the subfile, checking for user actions (such as selection).
- If a record is selected (via `b1valg`), sets the output parameters and signals to exit.

### d. `clr_subfile` — Clear Subfile

- Turns on indicator 14 to clear subfile.
- Resets subfile-related counters.

### e. `crt_subfile` — Create Subfile

- Populates the subfile with up to `c_sfil` entries.
- Reads the data file (by project or description), writes records to the subfile for display.
- Ends when page is full or EOF is reached.

### f. `bck_subfile` — Back One Page

- Reads backward in the data file by one page.
- Clears and repopulates the subfile to show the previous set of records.

### g. `dsp_subfile` — Display Subfile

- If subfile not empty, prepares for display (indicators for selection and display control).
- Executes `exfmt` to display/control the subfile control screen.
- Stores the first record number for the page.

### h. `*inzsr` — Initialization Subroutine

- Sets up entry parameters.
- Positions the database to the first record.
- Populates the first page of the subfile.

---

## 7. Key Lists

- **rp1pl1_key**: Used for positioning by project.
- **rp1pl2_key**: Used for positioning by description.

---

## 8. User Interface

- The program uses a subfile approach for listing selectable records (projects).
- The user can page up/down, position by project or description, and select an entry.

---

## 9. Flow Summary

1. **Initialization:**
   - Receives parameters.
   - Displays first subfile page.

2. **Main Loop:**
   - Displays subfiles, handles function keys.
   - Allows page up/down, position by key, selection.

3. **Exiting:**
   - When selection is made or exit requested, sets parameters, ends.

---

## 10. Commonly Used Indicators

- `*in10`: Roll Up
- `*in11`: Roll Down
- `*in12`, `*in13`: Subfile display controls
- `*in14`: Subfile clear
- `*in15`: End of subfile/page
- `*in22`: Cursor placement

---

## 11. Naming Conventions and Special Notes

- **B1SFL**: The subfile record format in display file.
- **B2CTL**, **B2CMD**: Subfile control formats for handling screen commands etc.
- **b1valg**: Selection indicator in the subfile (set by user).
- **b11pro/b11alf**: Project/Description from the subfile record.

---

## 12. Usage Context

This program would be used where you need to allow a user to select a project from a list, possibly positioning to a certain project or searching by description. It is interactive, paged, and handles function keys for navigation.

---

## 13. Program Entry/Exit

- **Entry:** Called with project parameters (`p_1frm`, `p_1pro`, `p_1alf`).
- **Exit:** Updates parameters (if selection is made) and sets LR for program end.

---

## 14. Error Handling

- Minimal, mostly controlled via indicators and user interface. No explicit error messages; subfile and end-of-records indicators are used for flow control.

---

## 15. Highlights

- Very structured, robust subfile logic—classic AS/400 design.
- Modular code (subroutines for every operation).
- Heavy use of indicators, key lists, and RPG specificity.

---

**In summary:**  
This is a traditional, indicator-driven RPG inquiry/selection program using subfiles, well-organized into clearly described subroutines for initialization, navigation, subfile maintenance, selection, and display. It's a good onboarding example for RPG/400 subfile and inquiry programming.