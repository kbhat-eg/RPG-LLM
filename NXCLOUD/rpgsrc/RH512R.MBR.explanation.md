# Overview

This RPG program (`RH512R`) is a classic ILE RPG program for IBM i (AS/400). It is designed to provide inquiry functionality on the general ledger ("Hovedbok - poster, spørring" translates to "General ledger - postings, inquiry"). The code manages subfile displays (paged lists), enables search and navigation, displays details, and allows access to archive and note information for different postings/accounts.

The program is heavily commented in Norwegian, and uses classic fixed-format RPG IV with some conditional/alternate source lines (T5.50, 6.23, etc.) for different versions. It is a big, feature-rich inquiry program familiar in financial/accounting systems on IBM i.

Below, I'll walk through its main sections and logic to help a developer quickly onboard.

---

## 1. **File and User Interface Definitions**

- **Physical files (`frhtrl1`, `frhtrl2`, `frhtrl3`, `frhtrl4`, etc.):**  
  These are database files holding ledger/posting data, each with different key structures for various types of inquiry (by account, department, cost carrier, voucher).
  - `rename(…)` is used to reference record formats.

- **Display file (`frh512d`):**  
  - `workstn` means a workstation display file.
  - Uses a subfile (`sfile(b1sfl:w_srrn)`) for listing postings.

---

## 2. **Data Area and Variables**

- **Local Data Area (LDA):**  
  - Variables `l_user`, `l_firm`, `l_fnav` are extracted from the LDA, which is a standard method to access session/user information in IBM i.

- **Key variables for file access:**  
  - Variables like `rhtrl1_kont`, `rhtrl2_avde`, etc., correspond to key fields for positioned reading/searching.

- **Main working variables:**  
  - `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Subfile/paging control variables.
  - `w_raar`, `w_rper`, etc.: Used for year and period handling.
  - `b_oppr`, `b_forn`, etc.: Flags indicating operation states.

---

## 3. **Constants and Parameter Blocks**

- Various constants (example: `c_sfil` = 12) define subfile paging size.

- There are parameter definitions (example: for program `RF020R`) and use of `/COPY QCPYLESRC,RF020PAR` to import a parameter layout.

---

## 4. **Screen and Indicator Usage**

- The comment blocks explain display fields and indicators. Examples:
  - Indicators like `*inlr` control program end; `*in10`/`*in11` handle roll-up/down.
  - Special screen fields (e.g., `B1SFL`, `B2CTL`, etc.) represent subfile and control record formats in the display file.

---

## 5. **Main Control Flow and Loop**

- **Tags and main program loop:**  
  - Uses named tags (`b2taga`, `b2tagb`, etc.) and `goto`/`select` style logic to control the interaction loop.
  - Presents menus, handles function keys (e.g., F5=refresh, F7=details, F8=summary, F9=archive), and processes subfile navigation.

---

## 6. **Searching and Inquiry Logic**

- **Searches by various keys:**  
  - You can inquire by account, department, cost carrier, or voucher.
  - Function keys invoke other programs for lookups (`RH500R`, `RA528R`, `RA507R` for different search popups).
  - The program supports positioning, reloading, and filtering the subfile display.

---

## 7. **Subfile Control and Paging**

- **Subroutines for subfile handling:**
  - `subfile`: Main subfile processing (reads and processes user actions on the subfile).
  - `clr_subfile`: Clears subfile data.
  - `crt_subfile`: Loads new data into the subfile, respecting positioning and filters.
  - `bck_subfile`: Handles page-back (roll-back) in the subfile.
  - `dsp_subfile`: Refreshes display.

- **Paging variables manage which records are shown on each page.**

---

## 8. **Detail Display and Drill-Down**

- **`xc2bld` subroutine:**  
  - Builds and displays the detail screen for an individual posting (bilag).
  - Shows account texts and detailed posting info.

- **The program allows the user to drill down into:**
  - The posting details
  - The voucher (bilag) itself
  - Summed postings
  - Archive documents (using external programs like `AP622C` or `AH720C`)

---

## 9. **Archive and Note Functions**

- **Note block (Notatark):**
  - The program can check if there are notes attached at account or posting level (see `rklal2` and `rklal3` at T5.50 version).
  - The `notat` subroutine calls another program (`RF020R`) to handle notes.

- **Archive lookup:**
  - With F9, the program checks access and document type, then calls external archive systems to display archived vouchers.

---

## 10. **Data Integrity and State Control**

- The program carefully tracks which fields and keys are currently active, manages user input and cursor position, and updates display accordingly.
- Many indicators and variables ensure that only relevant information is calculated and shown as the user navigates.

---

## 11. **Initialization and Key Lists**

- **`*inzsr` (initialization subroutine):**
  - Extracts initial values from parameters, LDA, etc.
  - Sets up key lists for efficient database access.

- **Key lists:**  
  - Definitions like `rhtrl1_key`, `rhtrl1_keyh`, etc., allow the program to quickly manage different access paths for inquiries.

---

## 12. **Balance Calculation**

- **`beregn_ib_ub` subroutine:**
  - Calculates opening (`ib`) and closing (`ub`) balances for the displayed data.
  - Uses the current period and adds up the relevant amounts.

---

## 13. **Supporting Subroutines**

- **`hent_text`:**
  - Calls external routines to retrieve account, department, and cost carrier names/texts for display.

---

# High-Level Summary

- **Purpose:**  
  An interactive general ledger posting inquiry program, allowing users to list, search, page through, and drill down into account postings, see details, and access notes and archives.

- **User Experience:**  
  - User can filter by account, department, cost center, or voucher.
  - Paging and navigation in the subfile listing is supported.
  - Drill-down to detail, summary, notes, and archive documents.
  - Integrated with other modules (account, department, cost center lookups).

- **Design:**  
  - Modular, using subroutines and external program calls for reusable logic.
  - Uses classic IBM i/AS400 programming paradigms: LDA, subfiles, indicator variables, and fixed-format RPG IV.

---

# Developer Onboarding Tips

- **Understand the subfile/paging mechanism** – how `w_srrn`, `w_sfrn`, `w_ssrn` work together.
- **Get familiar with the key lists and how they map to different inquiry paths.**
- **Look at indicator usage** (`*inxx`), especially for screen state and function keys.
- **Note which external programs are called for lookups and drilldowns.**
- **Pay attention to versioned source lines (for example, T5.50).**  
  Some functions are only active in certain versions.
- **Test with the display file (`frh512d`) and related database files** to see the UI in action.
- **Leverage comments:**  
  The original developers have provided very descriptive Norwegian comments; use translate tools if needed.

---

# Conclusion

The program is a full-featured, robust inquiry utility typical for AS/400 financial apps, making heavy use of subfiles and classic interactive programming techniques. Its modular structure and clear separation of concerns make it maintainable once you become comfortable with classic RPG idioms and the code's overall structure.