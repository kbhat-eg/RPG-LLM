# RPGLE Program Explanation: VE718R

---

## Overview

This RPGLE (ILE RPG) program, **VE718R**, is designed to check for duplicate GTIN (Global Trade Item Number) values in master files, with extended logic for handling different units. The program is tailored for the IBM i (AS/400) system and works by scanning two physical files: **VVEP** (vvepl2) and **VEAN** (veanlr).

The main functionality is controlled via input parameters, and the result is communicated through a status parameter.

---

## File Declarations

```rpg
fvvepl2    if   e           k disk    rename(vveppfr:vvepl2r)
fveanlr    if   e           k disk    rename(veanpfr:veanlrr)
```
- **vvepl2** and **veanlr** are files being accessed with keyed I/O.
- Both are renamed internally for this program.

---

## Data Definitions

### Input/Output Parameters

```rpg
d p_gtin          s                   like(vepgti)   // Input: GTIN number to check
d p_vare          s                   like(vepvar)   // Input: Product/item identifier
d p_stat          s              1                   // Output: Status flag
```

### Working Variables

```rpg
d b_enhe          s              1    inz(*off)  // Boolean: first pass for unit comparison
d p_anta          s              6  0           // (Unused here)
d w_pgti          s                   like(vepgti)
d w_pvar          s                   like(vepvar)
```

### Local Data Area (LDA)

```rpg
d                uds
d l_user                911    920                // User from LDA
d l_firm                944    946  0             // Firm code from LDA
```

### Key Variables

```rpg
d vvepl2_pgti     s                   like(vepgti)
d veanlr_eann     s                   like(vxeann)
```

### Miscellaneous

```rpg
d w_firm          s                   like(vepfir)
d w_dato          s               d   datfmt(*iso)
d w_enhe          s              3
```

---

## Main Program Logic

### Program Initialization

```rpg
c                   eval      p_stat = *blank
c                   eval      b_enhe = *off
c                   eval      w_enhe = *blank
```
- Initialize output parameter and internal flags.

---

### Check for GTIN Duplicates in VVEP (Master Table)

1. Set the key value to the input GTIN (`p_gtin`).
2. Use the key to read matching records in `vvepl2`.
3. On the first record, capture the unit (`vepenh`). On subsequent records, compare the current unit to the stored one.

- If a different unit is found for the same GTIN, set `p_stat = '3'`.
- If a different product (`vepvar`) is found with the same GTIN, set `p_stat = '1'`.

```rpg
c                   eval      vvepl2_pgti = p_gtin
c     vvepl2_key    setll     vvepl2
c     vvepl2_key    reade     vvepl2
c                   dow       not %eof
   // Unit check
   if b_enhe = *off
      eval w_enhe = vepenh
      eval b_enhe = *on
   else
      if w_enhe <> vepenh and p_stat = *blank
         eval p_stat = '3'
      endif
   endif

   // Product check
   if p_vare <> vepvar
      eval p_stat = '1'
   endif

   // Read next
   vvepl2_key reade vvepl2
c                   enddo
```

---

### Check for GTIN Duplicates in VEAN (Alternative Table)

1. Set the key value to the input GTIN.
2. Read matching records in `veanlr`.
3. If a different product (`vxvare`) is found with the same GTIN, set `p_stat = '2'`.

```rpg
c                   eval      vvepl2_pgti = p_gtin
c     vvepl2_key    setll     veanlr
c     vvepl2_key    reade     veanlr
c                   dow       not %eof
   if p_vare <> vxvare
      eval p_stat = '2'
   endif
   vvepl2_key reade veanlr
c                   enddo
```

---

### Termination

```rpg
c                   eval      *inlr = *on // Close files, reclaim resources
c                   return
```

---

## Key Subroutine: *INZSR (Initialization)

- The *INZSR routine initializes key values and loads the firm code (`l_firm`) from LDA for use as part of composite keys.

```rpg
c     *entry        plist
c                   parm                    p_gtin
c                   parm                    p_vare
c                   parm                    p_stat

// Key for read
c     vvepl2_key    klist
c                   kfld                    w_firm
c                   kfld                    vvepl2_pgti

// Get firm from LDA
c                   eval      w_firm = l_firm
```

---

## Status Output (`p_stat`)

- **' '** (blank): No duplicate found.
- **'1'**: Duplicate GTIN found in `vvepl2` with different product.
- **'2'**: Duplicate GTIN found in `veanlr` with different product.
- **'3'**: Duplicate GTIN found in `vvepl2` with different unit.

---

## Summary Table

| Status | Meaning                                              |
|--------|------------------------------------------------------|
| ' '    | No duplicate                                        |
| '1'    | GTIN found with a different product in master table  |
| '2'    | GTIN found with a different product in alternative   |
| '3'    | GTIN found with a different unit in master table     |

---

## Practical Usage

- This program would typically be called from another application or batch process, passing in a GTIN and product code. It will scan for duplicates and set the status accordingly.
- The check covers both the main item master (`VVEP`) and an alternative numbering/reference table (`VEAN`), and distinguishes between differences in product and unit.

---

## Notable Features

- Use of Local Data Area (LDA) to obtain firm code, allowing this program to operate in a multi-firm environment.
- Logic to identify not just duplicate GTINs, but also to distinguish between different units and product numbers associated with a GTIN.
- Modular parameter handling and clear output status.

---

This program is a typical example of legacy RPG business logic, encapsulating validation for data integrity in a centralized reusable component.