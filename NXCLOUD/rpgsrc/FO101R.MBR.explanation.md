# RPG Program FO101R - Explanation

This RPG/400 (ILE RPG) program is focused on the registration and maintenance of sales offers and orders, specifically for order header information ("ordre-hode-register"). Below is an explanation of the main concepts, code structure, and how the program works.

---

## 1. **Purpose and Structure**

### Purpose
- **Handles the registration and update of sales offers/orders (tilbud/ordre)**
- Interactive program for maintaining order header data (customer, warehouse, payment, etc.)
- Includes various validation routines and lookup procedures.
- Allows user interaction via screen formats and Option keys (Function keys/F4 inquiry/etc).

### Structure
- **Header:** Compilation options, version log.
- **File Declarations:** Physical and logical files, workstn (display file), code registers, master files, and various related files (order details, code files, etc).
- **Data Definitions:** Parameters, work fields, data structures, key fields for file access.
- **Main Logic:**
    - Start-up (*INZSR).
    - Handling of main screens (C2/C3 screens).
    - Reads and updates from/to master and related files.
    - Calls to external programs to assist with data entry and validation.
    - Various subroutines for lookups and validation.

---

## 2. **Major Sections**

### 2.1 File Definitions (`F-specs`)
- Declares display file (`fo101d`), order header master (`fohel1`), various code files (departments, sellers, warehouse, etc.), order lines, card register, and so on.
- Some files are defined conditionally, depending on version.

### 2.2 Data Definitions (`D-specs`)
- **LDA (Local Data Area):** Used for user/environment info (workstation, user, firm, etc).
- **Structures for text:** Handling text overlays in order header.
- **Program parameters:** For passing order and customer info.
- **Key fields:** For file access (order number, suffix, department, etc).
- **Work fields:** Various character and numeric fields to hold intermediates, texts, flags, etc.

### 2.3 Mainline Logic (`C-specs`)
#### a) **Initialization:**
- *INZSR subroutine* sets up key fields and loads configuration (e.g., firm-controlled validation).

#### b) **Screen C2 (Order Header Maintenance I):**
- Loads order header via `CHAIN`.
- Populates working variables from file fields.
- Optionally disables deposit amount field if this is an offer (not a sales order).
- Loads any existing deposit information, considering year transition for potential year-end correction.
- Calls subroutines to fetch text descriptions for various header fields (department, seller, warehouse, etc).
- Shows the screen format (EXFMT) and reacts to function keys (F3=Exit, F4=Inquiry, etc).
- Allows calling out to helper programs for code/text selection.
- Validation: Checks if entered values for department, seller, warehouse, payment terms, invoice type, currency, expediter, delivery method, delivery terms, and driver route are valid (exists in code register/master).
- Special logic for updating lines if warehouse or department changes, including calling relevant subprograms.
- If changes, updates file and associated deposit file.
- If VAT code altered, calls subroutine to update lines accordingly.

#### c) **Screen C3 (Order Header Maintenance II):**
- Similar to C2, but for project, underproject, and account-related fields.
- Logic includes fetching projects, underprojects, activities, and account data through helper programs and subroutines.
- Handles card (kontokort) details.
- Validation of project, underproject, activity, account, and so on.
- If valid, updates file.

#### d) **Subroutines:**
- **sbavde, sbselg, sblagr, sbbetb, sbvalk, sbform, sblevb, sbsped, sbkjor:** Each reads code files and moves description to appropriate variable.
- **endr_mva:** When the VAT code on the order header changes, updates all detail lines to match.
- **kort_txt/sjk_kort:** For card handling (types, validation).
- **hent_toti:** Fetches the total order sum including VAT.
- **sjk_lines:** Updates all order lines to match new department, if changed in header.

---

## 3. **Key Points and Business Logic**

### a) **Versioned Enhancements**
- The program maintains compatibility with various releases (indicated by e.g. `6.30`, `8.03`). Code blocks tagged with version numbers show when enhancements or fixes were introduced.

### b) **File and Field Validation**
- Extensive use of code register files for validation of all master data fields (department, seller, warehouse, terms, etc) via subroutines and external program calls.

### c) **Dynamic Field Lookup**
- Rather than hard-coding texts, the program dynamically looks up and populates descriptions for fields based on user selections.

### d) **Deposit Handling**
- Special logic for reading/updating the deposit file, with consideration for year-end edge cases.

### e) **Extensibility**
- Many areas of the code are built to allow for new business logic or validations, controlled by configuration files (like `AVALPF`).

---

## 4. **Program Flow (Simplified)**

1. **Initialization**
   - Setup keys, load configuration, clear work fields.

2. **Main Screen (C2)**
   - Read order header.
   - Load and display field values and related descriptions.
   - React to user inquiry keys/call-outs for lookups.
   - Validate codes.
   - Allow user to change header fields.
   - If major fields change (like warehouse), update appropriate lines and possibly call out to user for choices.
   - Update order header and deposit file as necessary.
   - If changed, re-loop to redisplay screen.
   - Go to screen C3 if requested.

3. **Project/Account Info (C3)**
   - Similar cycle for project/account-related data.
   - Validates codes via helper programs and updates file.

4. **Exit Logic**
   - Sets on LR (last record), returns.

---

## 5. **Subroutine Usage**

- **sbXXXX** subroutines for retrieving description texts for code fields — each calls an external program, gets text, and populates the UI variable.
- **endr_mva:** When the VAT code is changed at the order header, updates all order lines accordingly.
- **sjk_lines:** Updates department on each order line if the department was changed in the header.

---

## 6. **External Program Calls**

The program relies on many external helper programs for code lookup (e.g., RS707R for department, RS709R for seller, etc.). These typically return a code description, which is then displayed to the user.

---

## 7. **Screen Formats (Display File Interaction)**

- Display file `fo101d` defines the screen layout; program uses EXFMT to show the screen, read inputs, and redisplay as needed.

---

## 8. **Special Handling and Edge Cases**

- **Deposit field is disabled for offers** (not orders).
- Handles transition of deposit records over year boundary.
- When warehouse/department is changed, presents logic to update lines either for all or based on choice.
- Firm-controlled field validation: Some fields may be required/enforced depending on configuration.

---

## 9. **Logging and Change History**

- Extensive change log at the top documents what features/patches were added in each version and the rationale.

---

## 10. **Onboarding Notes**

- **Modular:** If adding new code fields or lookup logic, follow the pattern of sbXXXX subroutines.
- **Version Handling:** Be mindful of the versioned code blocks. Conditional logic (e.g., `5.40`, `6.30`) means certain features are only active in specific program releases.
- **External Calls:** To troubleshoot or extend, be aware of the dependency on external programs for code/description lookup.
- **UI Interaction:** Most user interaction is handled via the display file and driven by RPG `EXFMT`, function-key indicators, and subprogram calls.
- **Data Integrity:** Updates to the order header automatically flow down to order lines/deposit as appropriate per business rules.

---

## 11. **Summary Table of Important Subroutines**

| Subroutine | Purpose                                                      |
|------------|--------------------------------------------------------------|
| sbavde     | Get department name/description                              |
| sbselg     | Get seller name/description                                  |
| sblagr     | Get warehouse name/description                               |
| sbbetb     | Get payment terms (text)                                     |
| sbvalk     | Get currency text                                            |
| sbform     | Get delivery method description                              |
| sblevb     | Get delivery terms text (multi-line)                         |
| sbsped     | Get expeditor (freight forwarder) name                       |
| sbkjor     | Get driver route (kjørerute) text                            |
| endr_mva   | Update VAT code across order lines if changed on header      |
| kort_txt   | Fill out correct card name based on type                     |
| sjk_kort   | Validates card type                                          |
| hent_toti  | Get order total including VAT                                |
| sjk_lines  | Updates department on lines if changed on header             |

---

## 12. **Common Abbreviations in Fields**
- `fo...` — Order header (FOrdrE)
- `fd...` — Order line (FOrdrDEtails)
- `c2...`, `c3...` — Work variables for screen 2 and 3
- `sk...` — Deposit-related fields
- `w_...` — Work variable
- `*inKC`, `*inKD`, etc. — Indicator for key press, e.g., F3, F4

---

## 13. **Conclusion**

This program is a robust, well-maintained RPG application for handling sales order header information in a dynamic, interactive manner. It leverages a modular structure, external validation programs, and careful update logic to ensure data integrity and a user-friendly interface for managing complex master data.

If you are onboarding to this code:
- Get familiar with the code register files and their structure.
- Understand how external program calls interface with the UI and data entry.
- Pay attention to the change log to see what has been modified for your release/version.
- Review subroutine patterns for extensions or bugfixes.
- Use the display file (`fo101d`) as your reference for what the end-user actually sees and interacts with.