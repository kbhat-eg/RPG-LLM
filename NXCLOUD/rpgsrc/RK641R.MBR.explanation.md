# Overview

This RPG III (ILE RPG) program is designed for IBM i (AS/400) systems. Its purpose is to build (populate) a helper or index file for account statement printouts ("kontoutdrag"). The code reads the customer master file, applies various selection criteria, and writes out qualifying customers to an output file for later processing.

Below is an annotated explanation of the main program sections.

---

## 1. Header and Documentation

```rpg
/TITLE  Hjelperegister for kontoutdrag
h datedit(*dmy) option(*nodebugio)
```

- `/TITLE` indicates the program's purpose: Helper register for account statements.
- `h` spec: Sets program options: date format DMY, and disables debug I/O.

The comment block documents changes, purpose, and version history.

---

## 2. File Declarations

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frkw1pf    o  a e           k disk
```
- `frkunl1`: Input file (customer master), externally described, keyed, renamed to avoid naming conflicts.
- `frkw1pf`: Output file, externally described, keyed. This is where selected customers are written.

---

## 3. Data Structure and Variables

```rpg
d                 ds
d wkwrec                  2    192
d  wkfirm                        3  0 overlay(wkwrec)
d  wkkund                        6  0 overlay(wkwrec:4)
d  wknavn                       30    overlay(wkwrec:10)
```
- `ds`: Data structure used to prepare a customer record to write out.
- `wkwrec`: Byte array for the output record.
- `wkfirm`, `wkkund`, `wknavn`: Overlays to access specific fields inside `wkwrec`.

```rpg
d bruddx          s              1
d w_alfa          s                   like(rkalfa)
d n               s              2  0
d tstkt           s              7  0
d w_firm          s                   like(rkfirm)
```
- `bruddx`: Indicates if subtotals (breaks) should occur.
- `w_alfa`: Temporary work field, same type as `rkalfa`.
- `n`: Counter for single-customer selection loop.
- `tstkt`: Counter/sum variable.
- `w_firm`: Working value for the company/firm id.

```rpg
d/COPY QCPYLESRC,RPARRKDS
```
- Copies in a data definition source file (likely defining fields used below).

---

## 4. Main Loop: Reading and Filtering Customers

### Initialization

```rpg
c                   move      l_firm        w_firm
c     rkunl1_key    setll     rkunl1
c     rkunl1_key    reade     rkunl1                                 60
```
- Set work value for firm.
- Set logical file position to key (`rkunl1_key`), then read first record.

### Processing Loop

```rpg
c                   dow       *in60 = *off
```
- Loop until end of file (`*in60` is on if EOF).

#### Filtering/Selection Logic

For each record, the following selection criteria are applied in order. If any fails, the loop skips to the next record via `goto neste`.

##### 1. Department Selection

```rpg
c                   if        rkavde < pavdf or
c                             rkavde > pavdt and
c                             pavdt > 0
c                   goto      neste
c                   endif
```
- Skip if department is not in the desired interval.

##### 2. Category Selection

```rpg
c                   if        rkkatg < pkatf or
c                             rkkatg > pkatt and
c                             pkatt > 0
c                   goto      neste
c                   endif
```
- Skip if category is not in the desired interval.

##### 3. Seller Selection

```rpg
c                   if        rkslgr < pself or
c                             rkslgr > pselt and
c                             pselt > 0
c                   goto      neste
c                   endif
```
- Skip if seller is not in the desired interval.

##### 4. Customer Number Range

```rpg
c                   if        rkkund >= pknrf and
c                             rkkund <= pknrt
c                   goto      skriv_kund
c                   endif
```
- If customer number is in interval, jump to write customer.

##### 5. Individual Customer Table Check

```rpg
c                   if        tstkt = *zeros
c                   goto      neste
c                   endif
...
c                   eval      n = 1
c                   dou       n > 10
    ...
c                   if        rkkund = kun(n)
c                   goto      skriv_kund
c                   endif
    ...
c                   eval      n = n + 1
c                   enddo
```
- If not in range, check if the customer is on a specific list `kun(1:10)`.

If all criteria fail, go to `neste` (next record).

---

## 5. Writing Selected Customer ("skriv_kund")

```rpg
c     skriv_kund    tag
c                   eval      w_alfa = rkalfa
c                   if        psort = ' '
c                   eval      w_alfa = *blank
c                   endif
```
- Prepare sorting field, blank if no sort requested.

#### Subtotals/Breaks Logic

```rpg
c                   if        bruddx <> *blank
c                   eval      rwkniv = *zeros
    ...
c                   if        pavds = 'J'
c                   eval      rwkniv = rkavde
c                   endif
    ...
c                   if        pkats = 'J'
c                   eval      rwkniv = rkkatg
c                   endif
    ...
c                   if        psels = 'J'
c                   eval      rwkniv = rkslgr
c                   endif
c                   endif
```
- If breaks/subtotals are enabled, prepare break field (`rwkniv`) according to which subtotal is selected (department/category/seller).

#### Transferring Values to Output Record

```rpg
c                   eval      rwkfir = w_firm
c                   eval      wknavn = rknavn
c                   eval      wkkund = rkkund
c                   move      wkwrec        rwkrec
```
- Move relevant data into the output record structure.

#### Sorting and Output

```rpg
c                   eval      rwksal = *zeros
c                   eval      rwkalf = w_alfa
c                   eval      rwkknr = rkkund
c                   write     rkw1pfr
```
- Set sorting fields, then write the record to the output file.

---

## 6. Reading Next Record

```rpg
c     neste         tag
c     rkunl1_key    reade     rkunl1                                 60
c                   enddo
```
- Read next record, repeat loop.

---

## 7. Program End and Subroutine

```rpg
c     slutt         tag
c                   eval      *inlr = *on
```
- Mark last record and end program.

### Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
c                   eval      wkwrec = *zeros
c                   eval      w_firm = l_firm
    ...
c                   if        pavds <> *blank
c                   movel     'X'           bruddx
c                   endif
    ...
c                   xfoot     kun           tstkt
c     rkunl1_key    klist
c                   kfld                    w_firm
c                   endsr
```
- Runs at program start.
- Initializes work fields.
- Determines whether subtotaling is needed.
- Calculates the sum (population) of the chosen customer list.
- Prepares the key list for file reading.

---

# **In Summary**

- **Purpose:** Selects and writes customer records for account statements based on several filter criteria (department, category, seller, number, or selection table), optionally preparing for subtotals.
- **Inputs:** Customer master file, selection parameters, customer number list.
- **Outputs:** Helper/index file with qualifying customer records.

**Key areas for onboarding:**
- Understand the customer master and output file layouts.
- Know where selection parameters (`pavdf`, `pavdt`, `pkatf`, etc.) are populated (likely externally or from a calling program).
- Familiarize yourself with the copied DDS/fields (`/COPY QCPYLESRC,RPARRKDS`).
- Get comfortable with RPGâ€™s column-based syntax and file handling.

Let me know if you want drilldowns for particular sections or field definitions!