# Explanation of the RPG Program: RS002R

## Purpose

This program, identified as **RS002R**, is used to retrieve and update the last-used supplier ("leverandør") number within a system. It checks the current last used number, ensures it is within valid boundaries, verifies that the number is not already in use, and updates the registry as needed. The program is designed to be called from another program, accepting parameters and returning status and data.

---

## High-Level Overview

- **Inputs**: Status (p_retk), Company/Firm (w_firm), Last-used supplier number (p_4lnr)
- **Files Used**:
    - `raa4l1r, raa4lur, raa1l1r`: Various internal status/kode-register files, opened with specific record formats.
    - `rlevlrr`: Supplier register file
- **Output**: Updates the last-used supplier number as needed, and sets a return code in p_retk.

---

## Key Data Declarations

- `p_retk`: Return code (1 character; 'N' means not found/error, ' ' for OK, 'S', 'K' for possible command/status codes).
- `p_4lnr`: Last-used supplier number (like ra4lnr).
- `w_firm`: Company identifier (like ra4fir).
- `w_test, w_4lnr, w_levr`: Working fields for logic and calculations.
- Various fields to hold key values and other intermediate data.

---

## Main Logic Flow

### 1. Initialization

- The program receives parameters via the entry parameter list (PLIST).
    - `p_retk`, `w_firm`, `p_4lnr`
- Keys for file access are constructed, using the received firm (company) and relevant numbers/years.

### 2. Fetch Current Last-Used Supplier Number

- The relevant kode-register record is read (via `chain raa4l1r`). If not found, `p_retk` is set to `'N'` and program exits.

### 3. Determine Next or Correct Supplier Number

- If no special status code is provided (`w_test = *blank`): Set `w_4lnr` to (current last number + 1).
- If `w_test = 'S'` (possibly "step back"): Set `w_4lnr` to (current last number - 1), but only if `p_4lnr` equals the current last number.
- If `w_test = 'K'` (possibly "keep"): Set `w_4lnr` to the value of `p_4lnr` (passed-in parameter).

### 4. Check for Boundary Conditions

- If the new number is below a minimal allowed value (`ra1hrs`), return `'N'` and exit.

### 5. Ensure Number is Not Already in Use

- The program checks if `w_4lnr` is in the supplier registry (`rlevlrr`). If so, increments `w_4lnr` until a free number is found (`goto finnes` loop).

### 6. Update the Last-Used Supplier Number

- The last-used number record is read (`raa4lur`).
- If a higher number has been found, update the file's number.
- In some conditions (if `w_test = 'S'` and `p_4lnr` matches the new number), forcibly set to the calculated number.
- The file is updated with the new last-used supplier number.

### 7. Set Output Parameters

- Set `p_4lnr` to the new last-used supplier number.
- Set `p_retk` to blank, indicating success.

### 8. Program Exit

- The program ensures all resources are released (`*inlr = *on`) and returns.

---

## Key Points for Developers

- **File Operations**: Most file access is done via `CHAIN` by key lists. The existence/non-existence is checked via indicator `*IN90`.
- **Parameter Handling**: Via explicit PLIST on entry.
- **Control Flow**: Uses RPG cycle, conventional tags, and occasionally `goto`, which is common in traditional RPG but less favored in modern RPG.
- **Logic Customization**: The behavior can be controlled via the `p_retk` input (possibly a status code or command).
- **Safety**: Checks against upper/lower boundaries, existence, and prevents double-use of supplier numbers.

---

## Special Considerations

- **Language**: Comments and some field names are in Norwegian (`leverandør` = supplier, `sist brukte` = last used, `ikke funnet` = not found, etc.).
- **Expandability**: The routines are tightly coupled to the specific data files and business logic; adapt with care.
- **Indicative Return Values**:
    - `'N'`: Not found/error/invalid
    - Blank: OK
    - Other values: Special handling (such as `'S'`, `'K'`)

---

## Subroutine: *INZSR (Initialization)

- Sets up parameter linkage.
- Builds the various key-lists for file access.
- Fetches boundary/limit information from the relevant control record.

---

## Summary

This program is a utility routine for managing supplier numbers, ensuring that only unused and in-range numbers are allocated. It is robust against error conditions and is prepared for controlled updates based on calling program's intentions. 

**Developers new to this code should pay careful attention to the meaning and flow of the status parameters, the file layouts, and the business rules around supplier number assignment.**