# RPG Program Explanation: JO711R - Matching, Automated by Supplier/Item Number

This RPG (Report Program Generator) source code is an ILE RPG program intended to process and update matching records between suppliers and their item numbers, based on specific lookup and validation logic. Below, you will find an explanation of the structure and key program logic to assist developers in understanding and maintaining the code.

---

## 1. Control Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **option(*nodebugio)**: Disables certain debug I/O features for performance.
- **datedit(*dmy)**: Sets the default date edit format to 'day/month/year'.

---

## 2. File Declarations

```rpg
fjmatl3    if   e           k disk    rename(jmatpfr:jmatl3r)
fjmatlu    uf   e           k disk    rename(jmatpfr:jmatlur)
fjlevl3    if   e           k disk    rename(jlevpfr:jlevl3r)
fjvarl8    if   e           k disk    rename(jvarpfr:jvarl8r)
```
- Four physical (disk) files are declared, each renamed for local record format usage.
- `I` = Input, `U` = Update, `F` = Full procedural control, `E` = Externally described, `K` = Keyed access.

---

## 3. Data Definitions

### Parameters & Working Variables

```rpg
d p_firm          s                   like(jofirm)
...
d w_firm          s                   like(jofirm)
...
```
- `p_firm` is the company/firm number passed in as a parameter.
- `w_firm` is the working storage/copy of the firm number.

### Key Variables for Lookup

```rpg
d jmatl3_vkod     s                   like(jovkod)
d jmatlu_var1     s                   like(jovar1)
d jlevl3_enum     s                   like(jlenum)
d jvarl8_ldor     s                   like(jvldor)
d jvarl8_lvar     s                   like(jvlvar)
```
- These variables are used to build composite keys for various file accesses.

### Other Variables

```rpg
d b_ldor_ok       s              1    inz(*off)
d s_ldor          s                   like(joldor)
```
- `b_ldor_ok` is a Boolean indicator (initialized OFF) to manage supplier existence validation.
- `s_ldor` holds the "last supplier number processed" for efficient checking.

---

## 4. Main Program Logic

The main processing loop reads through all records in the `jmatl3` file (match register), applying business validation and performing chain (direct access) lookups and updates as required.

### Initialization

```rpg
c                   eval      jmatl3_vkod = 0
c     jmatl3_key    setll     jmatl3
c     jmatl3_key    reade     jmatl3                                 90
```
- Initializes key variable.
- Positions to the first relevant record in `jmatl3`.

### Main Loop

```rpg
c                   dow       *in90 = *off            
```
- Loop continues until the end of all matching records.

#### 1. Basic Validations

```rpg
c                   if        joldor = 0 or
c                             jolvar = *blank
c                   goto      les_neste
c                   endif
```
- Skips records with a zero supplier number or blank item number.

#### 2. Supplier Lookup Optimization

```rpg
c                   if        joldor <> s_ldor
c                   eval      jlevl3_enum = joldor
c     jlevl1_key    chain     jlevl3                             91
c                   if        *in91 = *off
c                   eval      b_ldor_ok = *on
c                   else
c                   eval      b_ldor_ok = *off
c                   endif
c                   eval      s_ldor = joldor
c                   endif
```
- If the supplier number changed from the last loop, perform a lookup on the supplier master file to check if the supplier exists.
- Set a Boolean to reflect if the supplier was found.

#### 3. Supplier Existence Check

```rpg
c                   if        b_ldor_ok = *off
c                   goto      les_neste
c                   endif
```
- Skips record if supplier not found.

#### 4. Status Code Check

```rpg
c                   if        jokode <> 0
c                   goto      les_neste
c                   endif
```
- Skips if record already has an error or match code assigned.

#### 5. Item Number Lookup

```rpg
c                   eval      jvarl8_ldor = jlldor
c                   eval      jvarl8_lvar = jolvar
c     jvarl8_key    chain     jvarl8                             92
c                   if        *in92 = *on
c                   goto      les_neste
c                   endif
```
- Checks if the supplier’s item exists in the items file. Skips if not found.

#### 6. File Update if Match Found

```rpg
c                   eval      jmatlu_var1 = jovar1
c     jmatlu_key    chain     jmatlur                            93
c                   if        *in93 = *off
c                   eval      jovar2 = jvvare
c                   eval      joldo2 = jvldor
c                   eval      jokode = 2
c                   update    jmatlur
c                   endif
```
- Finds the match record in the update file.
- If found, updates it with new data from the `jvarl8` record, specifically updating item-related fields and setting "match code" to 2 (meaning matched).

#### 7. Loop Continuation

```rpg
c     les_neste     tag
c     jmatl3_key    reade     jmatl3                                 90
c                   enddo
```
- Reads the next record for the primary loop.

---

## 5. Program Termination

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks the program as ready for end-of-job cleanup and returns.

---

## 6. Initialization Subroutine

```rpg
c     *inzsr        begsr
```
- Standard RPG special subroutine that runs once at program start.

### Parameter & Keylist Definitions

- Sets up program parameter list (for incoming `p_firm`).
- Defines all key lists used in the main logic (for efficient direct file access).
- Copies the incoming firm parameter to the work variable `w_firm`.

---

## **Summary of File Relationships**

- **jmatl3**: Input match register (main driving file).
- **jmatlur**: Update file for matches.
- **jlevl3**: Supplier master (to check if the supplier exists).
- **jvarl8**: Item master (to check if the supplier’s item exists).

---

## **Business Function**

- For each candidate in the match register:
    - Skip if no supplier or no item.
    - Ensure supplier exists and not previously processed.
    - Check that the record hasn’t already been matched.
    - Confirm the item exists for the supplier.
    - Update the match register to mark the match and populate item/supplier fields.

---

## **Key Points for Maintenance**

- If files or field names change, update D specs and key lists accordingly.
- Ensure all files are available and keyed correctly before running the program.
- Matching logic can be expanded by adding more validation or different update rules.
- Program relies on explicit disposition of file pointers and indicators (`*in90`, `*in91`, etc.)

---

This annotated walk-through should help you quickly get up to speed with the logic, structure, and business purpose of JO711R.