# Program Overview

This RPG (Report Program Generator) program, **AP608R**, is designed to query (look up) PDF-related parameters and statuses from various registers/tables. It determines, based on several control files and parameters, whether PDF processing is active for a given routine and organization unit (firm/department). The "PDF" flag can be enabled/disabled at several levels.

---

## Main Files Defined

- **afopl1**: Routine register (primary routines list)
- **afapl1**: Routine exceptions register (e.g., for division/department-specific overrides)
- **afpslr**: Properties/status register (e.g., general system/PDF status)

Each file uses `RENAME` to give a custom record format for easier field access within this program.

---

## Key Data Structures and Variables

### Parameters and Local Variables

- **p_ruti**: Input parameter (routine code to check)
- **p_pdf**: Output parameter (flag indicating if PDF is enabled, `'1'` or `'0'`)

### Key Fields (used for chain operations)

- **afopl1_ruti**: Key to afopl1 (routine register)
- **afapl1_arut, afapl1_afir, afapl1_aavd**: Keys to afapl1 (routine, firm, department)
- **afpslr_ufil, afpslr_uide**: Keys to afpslr (file ID, user ID)

---

## Main Logic Breakdown

### 1. Initialize PDF Flag

```rpg
c     eval      p_pdf = '0'
```
Set initial output to `'0'`: PDF disabled by default.

---

### 2. Check System-wide PDF Activation (afpslr)

- Set lookup keys (`afpslr_ufil` = `l_filg`, `afpslr_uide` = 'STATUS    ')
- Perform a `CHAIN` (random access) on the status record in the `afpslr` file.

```rpg
c     afpslr_key    chain     afpslrr
c     if        not %found
c         eval p_pdf = '0'
c     else
c         movel afudss p_pdf
c     endif
```
If not found: still `'0'`. If found, `afudss` field (PDF system status) sets the flag.

---

### 3. If Activated, Check Routine-level PDF Activation (afopl1)

```rpg
c     if        p_pdf = '1'
    ...
c         afopl1_key    chain     afopl1r
c         if        %found
            if        afppdf = 1
                p_pdf = '1'
            elseif   afppdf = 2
                p_pdf = '1'
            elseif   afppdf = 0
                p_pdf = '0'
            endif
c         else
            p_pdf = '0'
c         endif
c     endif
```
- Only if overall PDF is '1' (active), check if the specific routine (`p_ruti`) is enabled in `afopl1`.
- If not found, or if `afppdf = 0`, PDF is disabled.
- If `afppdf = 1` or `2`, PDF remains enabled for this routine.

---

### 4. If Routine Enabled, Check for Department-level Overrides (afapl1)

```rpg
c     if        p_pdf = '1' and afppdf = 2
        ...
    chain afapl1r using afapl1_key
    if    %found
        if    afapdf = 0
            p_pdf = '0'
        endif
    else
        p_pdf = '0'
    endif
c     endif
```

- If routine PDF flag is '2' (department-dependent), check for a more specific exception in `afapl1` (using routine, firm, department as key).
- If an override record is found and `afapdf = 0`, PDF is turned off.

---

### 5. End Program

```rpg
c     eval      *inlr = *on
c     return
```
- Set LR (last record/program end) and exit.

---

## Subroutine: *INZSR (Initialization/Entry & Key Lists)

Defines parameter list and key lists used throughout the program. This is where the input/output parameters and record access keys are defined.

```rpg
c     *entry        plist
c                   parm  p_ruti
c                   parm  p_pdf
```

Key lists for efficient CHAINs:
- `afopl1_key`: by routine
- `afapl1_key`: by routine, firm, department
- `afpslr_key`: by file ID, user ID

---

# Key Business Logic

The program implements **multi-level enable/disable logic** for PDF features:
1. **Global**: Check system-wide status.
2. **Routine level**: Check if the specific process/routine allows PDF.
3. **Department override**: If configured, check if the firm/avdeling (department) has an exception that disables it.

---

# Summary

- **Input**: Routine code (`p_ruti`)
- **Output**: PDF enabled flag (`p_pdf`)
- The flag is enabled (`'1'`) only if all hierarchy levels permit it.
- This type of logic is common in systems needing flexible configuration per company, department, and process/routine.

This RPG program is modular, controlled via parameters and key-lists, and is organized for maintainability in environments with complex parameterization needs (e.g., ERP systems).