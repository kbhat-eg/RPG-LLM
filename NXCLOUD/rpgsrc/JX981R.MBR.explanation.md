# Program Documentation: jv981R

## Overview

**Program Name:** jv981R  
**System:** ASVADM  
**Purpose:**  
This utility program scans all records in the `jvprPF` file, identifies entries where the supplier item number (`lev.varenr`) is blank, and attempts to restore the correct value from related master data. It also checks and corrects blank supplier item numbers in the EVR (likely "vareeier" or item owner) file.

The program is a data repair tool, typically run as a one-off or batch process to correct data inconsistencies introduced by previous processing errors or system issues.

---

## Business Logic and Process Flow

### 1. Main Loop

- **Reads every record in `jvprlu`** (logical file over `jvprPF`).
- For each record:
    - If the supplier item number (`jxlvar`) is blank:
        - Looks up the item in the item master (`jvarl1`).
        - If found, and the supplier code matches, and the item master has a non-blank supplier item number (`jvlvar`):
            - Updates the current `jvprlu` record with the value from the item master.
        - Independently, checks the corresponding record in the EVR file (`vvarl1`):
            - If the EVR record exists and its supplier item number is blank:
                - Looks up the supplier master (`jlevl1`) using the supplier code.
                - If found and the supplier numbers match:
                    - Updates the EVR record with the supplier item number from the item master.

### 2. File Relationships

- **jvprlu / jvprl1**: Logical files over `jvprPF`.  
  - Contains item records, possibly with supplier-specific data.
- **jvarl1**: Logical file over `jvarPF`.  
  - Item master data, including correct supplier item numbers.
- **vvarl1 / vvarlu**: Logical files over `vvarPF`.  
  - EVR (item owner) files, possibly reflecting item data per owner.
- **jlevl1**: Logical file over `jlevPF`.
  - Supplier master data.

### 3. Subroutines

- **upd_jvpr**:  
  Updates the current `jvprlu` record with the correct supplier item number, sets audit fields (date, time, user).

- **upd_vvar**:  
  Updates the current `vvarlu` (EVR) record with the correct supplier item number, sets audit fields.

- **\*inzsr**:  
  Initializes key lists for file access.

---

## Notable Design/Implementation Details

### File Handling

- Uses multiple logical files and renames record formats for clarity and to avoid conflicts.
- All file access is keyed, ensuring updates are made only to the intended records.

### Key Construction

- Key lists (`klist`) are defined in the initialization subroutine for each file access pattern.
- Keys are constructed from relevant fields (e.g., item number, supplier code, company/firm).

### Data Update Logic

- Only updates records when necessary (i.e., when a blank is detected and a valid value is available).
- Audit fields (date, time, user) are systematically maintained on updates for traceability.

### Error Handling

- Uses RPGâ€™s standard EOF indicator (`*in90`) for file reading.
- No explicit error logging; assumes that data integrity is maintained by the conditional update logic.

### Naming and Domain Conventions

- Field and file names follow Norwegian abbreviations:
    - `lev` = supplier
    - `vare` = item
    - `ldor` = supplier code/number
    - `lvar` = supplier item number
    - `eusr`, `edat`, `etim` = last updated by/date/time
    - `EVR` = likely "vareeier" (item owner)
- The program is designed to be run by technical staff, not end-users.

---

## External Dependencies & Integration

- **No external APIs**: The program operates solely on DB2/400 physical and logical files.
- **Interaction with other modules**: The files updated here may be used by other programs or batch jobs. This program must be run in a controlled environment to avoid concurrent updates.

---

## Summary Table: Key Operations

| Operation                  | Source File | Target File | Condition                                  | Action                                      |
|----------------------------|-------------|-------------|---------------------------------------------|---------------------------------------------|
| Fix blank supplier item #  | jvprlu      | jvprlu      | jxlvar = blank, lookup in jvarl1 succeeds  | Copy jvlvar to jxlvar, update audit fields  |
| Fix blank supplier item #  | vvarl1      | vvarlu      | vvlvar = blank, lookup in jlevl1 succeeds  | Copy jvlvar to vvlvar, update audit fields  |

---

## Usage Notes

- **Run this program in batch/offline mode** to avoid conflicts.
- Ensure backups are taken before running, as the program performs direct updates.
- Review audit fields after execution to confirm which records were changed.

---

## Conclusion

This program is a targeted data repair utility for supplier item numbers, ensuring consistency between transactional and master data for items and their owners. It reflects a pragmatic approach to maintaining data integrity in a legacy AS400/RPG environment, with careful use of keyed updates and audit trails.