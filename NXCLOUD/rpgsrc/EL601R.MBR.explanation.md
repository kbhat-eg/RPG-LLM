# Explanation of RPG Program EL601R

This RPG program ("EL601R") is designed for IBM i systems and is used to process supplier ("leverandør") bonus data, write summarised or detailed bonus reports to an output file, and potentially invoke an Excel export function.

Below is a detailed explanation of the code, structure, and logic.

---

## 1. **Header and Source Information**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **`*nodebugio`**: Disables certain debugging information for I/O operations.
- **`datedit(*dmy)`**: Dates are edited/displayed in day/month/year format.

Comment headers document the program name, its description (Supplier bonus, print basis), and a change log.

---

## 2. **File Declarations**

```rpg
felboir    if   e           k disk    rename(elbost:elboirr)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fvbotl1    if   e           k disk    rename(vbotpfr:vbotl1r)
flxl5st    uf a e           k disk    rename(lxl5st:lxl5str)
```
- **elboirr, rlevl1r, vbotl1r, lxl5str**: Files used in the program, renamed from their physical file names.
    - `elboir`: Probably bonus base data per supplier.
    - `rlevl1`: Supplier master data (names etc).
    - `vbotl1`: Bonus type descriptions.
    - `lxl5st`: Output file for report rows.

---

## 3. **Parameter and Working Data Definitions**

Numerous data structure and stand-alone field definitions for:
- **Input parameters** (such as firm, year, bonus types)
- **Working variables** (such as supplier number, bonus amounts, descriptions, control variables)
- **Key fields for file access**
- **Flags and control variables** (e.g., `b_bonu`, `u_excl`)

Example:
```rpg
d p_firm          s              3
d p_paar          s              4
...
d w_bgrl          s             11  2
d w_numm          s              8  0
...
d u_excl          s              1    inz(*off)
```

## 4. **External Program Prototype**

Definition for calling external program **CO402R** (for Excel URL lookup):

```rpg
DCL-PR CO402R EXTPGM('CO402R');
  ...
END-PR;
```

---

## 5. **Main Program Logic**

### a. **Initialization and Start**

```rpg
c                   eval      b_bonu = *off
c                   eval      w_bgrl = 0
c                   eval      w_subn = 0
c                   eval      s_tbot = *blank
c                   eval      s_levr = 0
...
c                   eval      elboir_blev  =  plnrf
```
- Initializes control variables and sets up for reading the bonus base file.

### b. **Reading Bonus Records (Main Loop)**

```rpg
c     elboir_key    setll     elboir
c     elboir_keyl   reade     elboir

c                   dow       not  %eof(elboir)
...
c     elboir_keyl   reade     elboir
c                   enddo
```
- Reads through all relevant bonus base records (`elboir`) for the supplier range (`plnrf` to `plnrt`).

- **Checks:**
    - **Supplier number** (`elblev`) within the specified range.
    - **Bonus type**: skip if filter is set and does not match.
    - **New bonus type**: fetches and caches description.
    - **New supplier**: fetches and caches supplier name, and (in summary mode) writes a summary row for the previous supplier.

### c. **Writing Output**

- **Summary vs. Detailed:**
    - If **summary mode** (`palt1 = 0`): writes one output record per supplier.
    - If **detail mode** (`palt1 = 1`): writes one output record per bonus base record.

- **Output Record** (`lxl5str`) is populated with the relevant fields and values.

### d. **After Loop: Write Final Summary Record (if needed)**

- After finishing the loop, if in summary mode and there's data for the last supplier, writes the final summary record.

### e. **Excel Export**

- If Excel export is enabled (`u_excl = *on`), calls program **EL601C** to perform the export, passing the output file name and unique number.

### f. **Cleanup: SQL Delete and Commit**
```rpg
c/exec sql
c+ DELETE FROM LXL5ST WHERE LX5IDE = :w_numm
c/end-exec
exec sql commit;
```
- Deletes any previously existing output records with the current unique identifier before writing new ones.

---

## 6. **Subroutines**

### a. **Find Supplier Name (`finn_ltext`)**
```rpg
c     finn_ltext    begsr
c                   eval      w_lnvn = *blank
c                   eval      rlevl1_levr = elblev
c     rlevl1_key    chain     rlevl1
c                   if        %found
c                   eval      w_lnvn = rlnavn
c                   endif
c                   endsr
```
- Looks up the supplier name (`rlnavn`) for the current supplier number (`elblev`) and stores it in `w_lnvn`.

### b. **Find Bonus Type Description (`finn_btext`)**
```rpg
c     finn_btext    begsr
c                   eval      w_btxt = *blank
c                   eval      vbotl1_tbot = elboty
c     vbotl1_key    chain     vbotl1
c                   if        %found
c                   eval      w_btxt = vatbes
c                   endif
c                   endsr
```
- Looks up and caches the description for the current bonus type.

### c. **Initialization Subroutine (`*inzsr`)**
```rpg
c     *inzsr        begsr
...
c                   call      'AS100R'
...
CallP CO402R('   ':0:0:'NX_EXCEL_URL':
                        co402_verdi1:co402_verdi2);
if co402_verdi1 = '1';
  u_excl = *on;
  w_excel_url = co402_verdi2;
endif;
c                   endsr
```
- Initializes keys, control values, fetches unique sequence number (from `AS100R`), gets export URL via `CO402R` external program.

---

## 7. **Summary**

**Key flow**:
- The program receives parameters for year, supplier range, bonus type, detail/summary mode, etc.
- Reads bonus base data, aggregates or writes detail rows based on the mode.
- Looks up and writes supplier and bonus type descriptions to the output.
- Optionally invokes an Excel export step.
- Cleans up any prior output with the same unique ID before writing.

**Main interactions:**
- Physical files: supplier, bonus type, bonus base, output file.
- External programs: `AS100R` (unique number), `CO402R` (Excel export URL), `EL601C` (Excel export).

---

## 8. **Common Business Logic**

- Used in back-office or analytics/reporting context.
- Highly parameterized—can output all, one, or a range of suppliers, detailed or summarized.
- Output is ready for further processing (e.g., Excel export via external programs).

---

## 9. **Special Notes**

- **Norwegian language comments** - original contributors likely Norwegian.
- **Legacy RPG style** - utilizes fixed-format C-specs, older variable definitions.
- **Transition code** - mixture of old RPG data declarations and some RPG IV-style constructs (`DCL-S`, `DCL-PR`).

---

**In summary**, this program processes a supplier bonus file, writing out either detailed or summarized reports to an output file, including fetching descriptions for suppliers and bonus types, and may call an Excel export process if configured. The code is oriented for batch reporting and is typical of financial/ERP systems.