# RPG Program Explanation: Kontroll av gyldig rabattkategori (`RS706R`)

This RPG program is designed for the IBM i (AS/400) platform. Its main purpose is to verify ("kontroll") whether a given "rabattkategori" (discount category code) is valid or not.

Below is a breakdown of the program, its structure, and function:

---

## Header and Metadata
- **`/TITLE`**: Sets the title for documentation.
- **H-Spec**:  
  - `datedit(*dmy)` sets the date format to day-month-year.
  - `option(*nodebugio)` disables certain debug features for input/output.

### Documentation Block
This section describes:
- The system (`ASOKON`)
- The program name (`RS706R`)
- Purpose: Validation of discount categories
- Indicator usage (Input/Output indicators 60-61 are reserved for file operations like CHAIN.)
- Return code usage: If `p_stat = 'N'`, the searched code does **not** exist.

---

## File and Data Declarations

### File Declarations
```rpg
fra06l1 if e k disk rename(ra06pfr:ra06l1r)
```
- **`fra06l1`**: File name, defined as input (`i`), full procedural (`f`), externally described (`e`), keyed access (`k`), and disk-based.
- **`rename(ra06pfr:ra06l1r)`**: Renames the record format for internal use.

### Standalone Fields
```rpg
d w_firm        s           like(raffir)
d p_stat        s        1
d p_fkod        s           like(rafkod)
d p_ftxt        s           like(raftxt)
d ra06l1_fkod   s           like(rafkod)
```
- `w_firm`: Local variable for the company/firm number.
- `p_stat`: One-character return status code.
- `p_fkod`, `p_ftxt`: Parameter variables for the code to check and its text.
- `ra06l1_fkod`: Used when building the key for file access.

### User Space/Work Fields (Unused in logic, possibly legacy)
```rpg
d                uds
d l_user      911  920
d l_firm      944  946 0
d l_fnav      951  980
```
- These are likely from a user space or externally described data structure.

---

## Main Logic

### Check Code Section
```rpg
c                   eval      ra06l1_fkod = p_fkod
c     ra06l1_key    chain     ra06l1r                            60
```
- Assign the parameter code to the key field.
- Attempt to `CHAIN` (random-access lookup) the record in `ra06l1r` using the key.
- Indicator **60** is set if the record is **not** found.

#### Handling Result of the Lookup
```rpg
c                   if        *in60 = *on
c                   eval      p_stat = 'N'
c                   eval      p_ftxt = 'Koden er ugyldig  '
c                   else
c                   eval      p_stat = *blank
c                   eval      p_ftxt = raftxt
c                   endif
```
- If indicator 60 is *on* (no record found):
  - Set return code `p_stat` to `'N'` for Not found.
  - Set `p_ftxt` to `'Koden er ugyldig  '` ("The code is invalid").
- Else (record found):
  - Set `p_stat` to blanks (meaning "OK").
  - Set `p_ftxt` to the text (`raftxt`) from the database record.

---

## Program End Routine
```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- Marks the end of the main logic.
- Sets the LR (Last Record) indicator `*inlr` to `*on` to signal program end and close files.
- `return` exits the program.

---

## *INZSR (Initialization Subroutine)
```rpg
c     *inzsr        begsr
c                   eval      w_firm = l_firm
```
- Standard initialization routine, runs when the program loads.
- Moves the firm number from `l_firm` (user space) to working variable `w_firm`.

### Parameter List Definition
```rpg
c     *entry        plist
c                   parm                    p_stat
c                   parm                    p_fkod
c                   parm                    p_ftxt
```
- Defines the program's parameter list (passed in and out by calling programs).
  - `p_stat`: Return status (one character)
  - `p_fkod`: Input category code to check
  - `p_ftxt`: Return text (either the category text or "invalid" message)

### Key Definition for File Access
```rpg
c     ra06l1_key    klist
c                   kfld                    w_firm
c                   kfld                    ra06l1_fkod
```
- Defines the key structure for file lookup: company number + discount category code.

---

# **Program Flow Summary**

1. **Initialization**
   - Sets up variables.
   - Receives parameters (`p_stat`, `p_fkod`, `p_ftxt`).

2. **Validation**
   - Builds a key with firm number and input code.
   - Looks up the category in the file.
   - If found, returns the associated text.
   - If not found, returns a status flag and error text.

3. **Termination**
   - Ends and returns to the caller.

---

# **How to Use**

- **Inputs:** Provide a company/firm code and a discount category code.
- **Outputs:**  
  - `p_stat`: Blank if found, `'N'` if not found.
  - `p_ftxt`: The category description if found, else "Koden er ugyldig" (The code is invalid).

---

## **Common Use Case**
This program is typically called from other RPG or CL programs that need to validate discount category codes in a master file and retrieve their associated text descriptions. Its design ensures centralized, consistent validation logic.

---

## **Notes**
- Norwegian text/comments are used (e.g., "Koden er ugyldig").
- Indicators are used in a traditional RPG way to signal I/O status.
- The program structure is typical for "lookup and validate" modules in legacy IBM i environments.