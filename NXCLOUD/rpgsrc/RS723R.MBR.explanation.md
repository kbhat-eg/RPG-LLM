# RS723R â€“ Kontroll av gyldig virksomhet

## Purpose

This program, `RS723R`, is a validation routine used to check whether a given business code (`virksomhetskode`) is valid for a specified company/firm (`virksomhet`). It is a utility typically called from other programs or interfaces to verify that a code exists in the relevant master file and to return a status and description accordingly.

The program is part of the ASOKON system and is written in traditional (fixed-format) RPG.

---

## Structure Overview

- **File Declaration**
  - Uses logical file `fra23l1` (renamed from physical file `ra23pfr` to record format `ra23l1r`).
  - File is keyed and externally described.

- **Key Variables and Parameters**
  - `w_firm`: Current firm/company code (from user data).
  - `p_stat`: Return status (1 char).
  - `p_wkod`: The code to check (input).
  - `p_wtxt`: The code description (output).
  - `ra23l1_wkod`: Work variable for the code being validated.

- **Indicators**
  - 60: Set if the CHAIN operation fails (i.e., code not found).

- **Parameter List**
  - Expects three parameters: status, code, and description.

- **Main Logic**
  - Copies input code to work variable.
  - Constructs a composite key using firm and code.
  - Attempts to CHAIN (lookup) the record.
  - If not found, sets status to 'N' and description to "Koden er ugyldig" ("The code is invalid").
  - If found, clears status and returns the description from the master file.

- **Initialization Routine**
  - Sets up the firm value from the user data area.

---

## Detailed Explanation

### File Handling

- **fra23l1**: 
  - Keyed disk file, likely a code master file (`ra23pfr`), providing valid business codes per firm.
  - Renamed to `ra23l1r` for internal reference.

### Working Variables

- `w_firm` is set to the firm number from the user data area (`l_firm`), which is a standard convention in this codebase for multi-company support.
- `p_stat`, `p_wkod`, `p_wtxt`: Parameters for status, code to be checked, and description text.

### Parameter Passing

- The program is designed to be called with a parameter list:
    1. `p_stat` (output): Status, set to 'N' if code not found, blank if found.
    2. `p_wkod` (input): The code to validate.
    3. `p_wtxt` (output): The description if code is valid, or an error message.

### Key Construction

- Key list `ra23l1_key` combines:
    - `w_firm`: The current firm.
    - `ra23l1_wkod`: The code to validate.

### Main Logic

- The program copies the input code to the work variable.
- Executes a CHAIN to the code master file using the composite key.
- If the indicator 60 is set (record not found):
    - Sets `p_stat` to 'N' (invalid).
    - Sets `p_wtxt` to "Koden er ugyldig  ".
- If the record is found:
    - Clears `p_stat`.
    - Returns the description from the file (`rawtxt`).

### Initialization

- The `*inzsr` routine sets up the firm value from the user data area.
- The parameter list is defined here (common in legacy RPG).

### End of Program

- Sets LR (last record) to *ON and returns.

---

## Domain/Business Logic

- **Multi-firm Support**: The validation is firm-specific; the code must be valid for the current firm.
- **Code Master File**: The RA23P file is the authoritative source for valid codes and their descriptions.
- **Status Convention**: A status of 'N' means not found/invalid; blank means valid.
- **Error Messaging**: Returns a fixed error message when invalid.

---

## Design Considerations & Conventions

- **User Data Area**: Firm and user information are pulled from the user data area, a convention throughout the system for context.
- **Indicator Usage**: Indicators 60 and 61 are reserved for file operations (CHAIN, etc.) in this codebase.
- **Parameter List**: Entry parameters are always defined in the initialization subroutine.
- **Separation of Initialization**: All setup is handled in `*inzsr`, not in mainline logic.

---

## External Interactions

- **RA23P Master File**: The program depends on this file for code validation.
- **Calling Programs**: Typically called from other programs/modules needing to validate codes before processing transactions or updates.

---

## Summary Table

| Variable      | In/Out | Description                                 |
|---------------|--------|---------------------------------------------|
| p_stat        | Out    | Status: 'N' = not found, blank = valid      |
| p_wkod        | In     | Code to validate                            |
| p_wtxt        | Out    | Description (from master file or fixed msg) |

---

## Typical Usage

A calling program supplies a code and receives back a status and description, using this routine as a central point for code validation logic, ensuring consistency across the system.

---

## Points of Attention

- The program expects the user data area to be properly initialized with firm and user information.
- All calling programs should interpret 'N' in `p_stat` as "code not found/invalid".
- The error message is fixed and not customizable per call.
- No logging or auditing is performed in this routine; it is purely a validator.

---

## Related Modules

- Any modules or programs that manage or reference business codes (`virksomhetskoder`) will likely interact with this program.
- Changes in the RA23P master file's structure or key fields will require corresponding changes here.

---