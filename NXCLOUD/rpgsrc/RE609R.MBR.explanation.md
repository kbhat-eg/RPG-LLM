# RPG Program Explanation: RE607R

This program is written in IBM ILE RPG (RPG IV) and is used to extract a balance matrix (saldobalanse) for final accounts, likely for exporting to Excel. The program processes two primary files: an account master (kontoplan, `rhovl1`) and a saldo matrix (balance per account for various periods, `rhsal1`), summarizes values per account (and optionally per department or special code), and outputs the result to an output file (`re05pf`).

Below is a breakdown and explanation of the main components, variables, data structures, and logic.

---

## **Header and File Definitions**

```rpg
h datedit(*dmy) option(*nodebugio)
h decedit('0,')
```
- Sets date and decimal editing options.
- `*nodebugio` disables debug input/output.

#### **File Declarations**
```rpg
frhovl1 if   e     k disk    rename(rhovpfr:rhovl1r)
frhsal1 if   e     k disk    rename(rhsapfr:rhsal1r)
fre05pf o  a e     disk
```
- `rhovl1` (account master), `rhsal1` (saldo matrix), and `re05pf` (output file).
- Files are renamed for internal record format references.

---

## **Data Structure Definitions**

### **Work Arrays**
```rpg
d sal      s    15  2  dim(14)   // Saldo
d sa�      s    15  2  dim(14)   // Saldo i år (current year)
d saf      s    15  2  dim(14)   // Saldo i fjor (last year)
d sab      s    15  2  dim(14)   // Saldo budsjett (budget)
d bel      s     1     dim(13)   // Amount table used for output
```
- Arrays to store balances for months and total.
- `sal`, `sa�`, `saf`, `sab` are for various years' balances and budgets.


### **DS: Output Layout (for writing to file)**
```rpg
d dsulda        91                 // Full record layout
d dskont         6  0 overlay(dsulda)      // Account number
d dssem1         1    overlay(dsulda:7)    // Separator
d dstext        30    overlay(dsulda:8)    // Account text
d dstxt2        20    overlay(dsulda:38)   // Extra account text
d dssem2         1    overlay(dsulda:58)   // Separator
d dskr�r        16    overlay(dsulda:59)   // Amount (current year)
...
d dskrfj        16    overlay(dsulda:76)   // Amount (last year)
```
- Overlays are used for fixed format output with fields at specific byte offsets.


### **Parameter Data Structure**
```rpg
d                uds
d pfirm  300  302  0    // Company number
d pnavn         30      // Company name
d puser         10      // User
d pdato   6  0         // Date
d praar   4  0         // Year
d pperf   2  0         // Period (from)
d ppert   2  0         // Period (to)
d pavdf   4  0         // Dept. from
d pavdt   4  0         // Dept. to
d prapp 471  472  0    // Report number
d psumm         1      // Department summary (J/N)
d psums         1      // Special code summary (J/N)
```
- Used for input parameters, possibly from a selection screen.

---

## **Misc Work Variables**

- Examples: `wbel�p` (work amount), `wfavde` (work department), `w_firm`, `w_raar` (last year), etc.
- Used to store current processing state.

---

## **Input File Layout (Indicator Area & KLIST for keys)**

- Input fields from `rhsal1r` used to map saldo (balance) arrays.

---

## **Main Logic Flow**

### **Initialization**
- Performed in the `*inzsr` subroutine:
    - Sets up variables, initializes year/firm, zeroes work variables, and sets the output separators.

### **Main Processing Loop**

#### **Step 1: Read Account Master**
```rpg
c     rhovl1_key    setll     rhovl1r
c     rhovl1_key    reade     rhovl1r
c     dow       *in60 = *off
```
- Loops through all account master records for the selected firm.

#### **Step 2: Account Filtering**
```rpg
c     if        rhkont = wfkont
c     goto      neste_kto
c     endif
c     eval      wfkont = rhkont
```
- Ensures each account (`rhkont`) is processed only once (prevents duplicates).

#### **Step 3: Zero Out Arrays**
```rpg
c     eval      sa� = 0
c     eval      saf = 0
c     eval      sab = 0
c     eval      w_funn = ' '
```
- Prepares for saldo accumulation.

#### **Step 4: Read Saldo Details**
```rpg
c     rhsal1_key    setll     rhsal1r
c     rhsal1_key    reade     rhsal1r
c     dow       *in61 = *off
...
c     rhsal1_key    reade     rhsal1r
c     enddo
```
- Scans the saldo matrix for the current account.

##### **Filters & Summing Logic Inside Loop**
- Skips records not in department range.
- Sums saldo for current year, last year, budget by period, depending on record type and year.


#### **Step 5: End of Account Block**
```rpg
c     if        *in61 and w_funn = '1'
c     exsr      summer
c     endif
```
- After saldo for the account is read, and if any nonzero saldo was found, calls subroutine to summarize and output the result.


---

## **Subroutines**

### **SUMMER: Summing and Output Preparation**
Handles:
- Totaling saldo for the periods requested (current year, last year, budget).
- Formatting numbers for output (handling minus signs, leading zeros, etc.).
- Fills the output data structure (`dsulda`) with account number, description, values.
- Only writes a record if any value is nonzero.
- Handles per-special-code and per-department summary (controlled by `psums`/`psumm`).

### **SJEKK_MINUS: Format Negative Amounts**
- Scans the generated amount string for a minus sign.
- Moves minus sign to the front for leading negative style (e.g., `-1234` instead of `1234-`).

---

## **Key Points and Features**

- **Summary by Account, Department, or Special Code:** Controlled by parameters, the program can output totals by these groupings.
- **Handles Multiple Years and Budget:** Accumulates for current, previous, and budget years.
- **Excel-friendly Output:** Output `dsulda` layout is probably designed for import into Excel; certain special separators are set in output for field splitting.
- **Efficient File Handling:** Uses `SETLL`/`READE` for efficient keyed access to files.
- **Data Cleansing:** Only writes a record if at least one relevant amount is nonzero, thus ignoring zero lines.

---

## **Data Flow Summary**

1. **Initialization:** Set year, firm, output layout.
2. **Loop Over Accounts:** For each account,
    - Zero work arrays.
    - Scan saldo records for that account.
    - Accumulate values for periods and years as appropriate.
    - At end of account or when a grouping changes, output a record using the predefined layout.
3. **Program End:** Set last record indicator (`LR`) and finish.

---

## **Customizations/Version Notes**
- Comments and version notes indicate periodic enhancements: test for only writing each account once, semicolon separation, changes for Excel output, and various formatting changes.

---

## **Key Takeaways for Onboarding**

- **Understanding Input Files:** Know your company’s account (kontoplan) and saldo (balance per period) file layouts.
- **Program Flexibility:** Options for summarizing by department or special code allow for varied reporting.
- **Output File Structure:** Critical if you update this logic, as external consumers (such as Excel) expect a specific format.
- **Subroutine Use:** The main work is modularized for clarity and (limited) reusability within the program.
- **Negative Number Formatting:** Special subroutine moves minus signs to the front, to comply with Excel or Scandinavian/European conventions.

---

### If you are to maintain or expand this code:
- Most business logic is in the saldo scanning loop and the `summer` subroutine.
- Be cautious with overlays in the output data structure (`dsulda`), as byte offsets are critical.
- Changes in period/year/account handling will impact both balance accumulation and output logic; test thoroughly.

---

#### **Summary Table of Important Variables**

| Variable        | Purpose                                 |
|-----------------|-----------------------------------------|
| `wfkont`        | Current account being processed         |
| `sa�`, `saf`, `sab` | Accumulators for current, last, budget  |
| `psumm`, `psums`| Summarize by department/special code J/N|
| `dsulda`        | Output record layout                    |
| `w_funn`        | Marker for whether any saldo was found  |

---

**In sum:**  
This program processes multi-period account balances for export, with several filters/grouping options and detailed formatting for external tools (like Excel). The code uses classic RPG techniques for file handling, data overlay, and output construction.