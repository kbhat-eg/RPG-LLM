# Explanation of RPG Program: LL644R – "Utskrift av hyllevarmere" (Print Shelf Warmers)

---

## Overview

This RPG/400 (ILE RPG, fixed-format) program, named **LL644R**, is designed to print a report, commonly referred to as "utskrift av hyllevarmere" (Norwegian: Print shelf warmers). Shelf warmers are typically inventory items that have little movement. The program handles input from several files (work, master, and group registers), calculates percentages, accumulates totals, and prints detailed lines to a printer file.

---

## File Declarations

```rpg
flwa2l3    if   e           k disk    rename(lwa2pfr:lwa2l3r)
flwa2l1    if   e           k disk    rename(lwa2pfr:lwa2l1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
fll644p    o    e             printer
```

- **lwa2l3/lwa2l1**: Working files (possibly temporary files with inventory data).
- **vvarl1, vogrl1, vhgrl1, vugrl1**: Master data files for item, over-group, main-group, and sub-group information, respectively.
- **ll644p**: Printer output file.

---

## Data Structures & Variables

### Local Data Area

```rpg
d                uds
d l_wsid                901    910
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```

- **l_wsid, l_user, l_firm, l_fnav**: Common LDA fields for workstation, user, firm number, and firm name.

### Key Variables for File Access

```rpg
d vvarl1_vare     s                   like(vvvare)
d vogrl1_oogr     s                   like(vgoogr)
d vhgrl1_hogr     s                   like(vghogr)
d vhgrl1_hhgr     s                   like(vghhgr)
d vugrl1_uogr     s                   like(vguogr)
d vugrl1_uhgr     s                   like(vguhgr)
d vugrl1_uugr     s                   like(vguugr)
d lwa2l1_ogrp     s                   like(mwogrp)
d lwa2l1_hgrp     s                   like(mwhgrp)
d lwa2l1_ugrp     s                   like(mwugrp)
d lwa2l1_vare     s                   like(mwvare)
```
- Used as keys for random access (CHAIN) to related files.

### Parameter Record

```rpg
d                 ds
d p_prec                       128
d  p_fvar                        8  0 overlay(p_prec)
d  ... (various overlays)
d  p_hori                        1  0 overlay(p_prec:47)
```

- **p_prec**: The parameter list passed to the program.
- Overlays define named slices of the parameter area for values like from/to item, group, customer, etc.

### Totals and Print Variables

```rpg
d totlve          s             13  2
d totoms          s             13  2
d w_lave          s             15  2
d w_omse          s             15  2
```

- Used for accumulating and handling totals (inventory and sales amounts, etc.)

---

## Main Logic

### Initialization – *INZSR

- **Parameter Parsing**: Receives parameters via *ENTRY, populates local variables.
- **Firm Info**: Loads firm number, etc., from LDA.
- **Flag Setting**: Sets indicators based on parameters for report selection.
- **Reset Totals and Accumulators.**
- **Position to Start**: Positions LWA2L1 (total file).
- **Reads First Record For Totals**: Reads total sales (`mwomst`) and total inventory value (`mwlagv`) for later percentage calculations.
- **Sets up Key Lists**: Defines key lists for random access to various files.
- **Prepares Heading Data**: Sets report heading fields (date, time, user, etc.) for printing.
- **Writes Heading**: Outputs the initial heading to the report.

### Main Loop

```rpg
c     les           tag
c                   read      lwa2l3r                                80
c                   if        *in80 = *on
c                   goto      slutt
c                   endif
c                   if        mwvare = *zeros
c                   goto      les
c                   endif
```
- Loops over the records in LWA2L3 (the detail file).
- Skips records with missing/zero item number.
- Stops when end-of-file (`*in80`) is reached.

#### Finding Item Text

```rpg
c                   movel     mwvare        vvarl1_vare
c     vvarl1_key    chain     vvarl1                             80
c                   eval      w_tek1 = *blank
c                   if        *in80 = *off
c                   movel     vvtek1        w_tek1
c                   endif
```
- Looks up item text (`vvtek1`) from the VVARL1 master file.
- Sets text to blank if not found.

#### Printing Detail Line

```rpg
c                   eval      d1vare = mwvare
c                   eval      d1tek1 = w_tek1
c                   eval      d1enhl = mwenhl
c                   eval      d1omst = mwomst
c                   eval      d1lagv = mwlagv
```
- Prepares variables for the detail line (item, text, unit, sales, inventory value).

#### Calculating Percentages

```rpg
c                   eval      w_omse = mwomst * 100

c                   if        totoms <> *zero
c                   if        w_omse / totoms > 999
c                   eval      d1pro1 = 999
c                   else
c                   eval(h)   d1pro1 = w_omse / totoms
c                   endif
c                   endif
```
- Calculates the percentage for sales per item versus total sales, similarly for inventory value.

#### Accumulators

```rpg
c                   eval      d1akk1 = d1akk1 + mwomst
c                   eval      d1akk2 = d1akk2 + mwlagv
```
- Accumulates totals for subtotals/totals per group or report.

#### Write Output

```rpg
c                   if        *in30 = *on
c                   write     a1hdr
c                   endif

c                   write     d1det                                30
c                   goto      les
```
- If heading flag (`*in30`) is on (e.g., page overflow), writes header line.
- Writes the detail line.
- Loops to process next record.

### Program End

```rpg
c     slutt         tag
c                   eval      *inlr = *on
```
- Set last record indicator to end program and release file resources.

---

## Subroutines and Keylists

- Keylists are set up for random access to the various group and item files.
- These are used in the main logic for CHAIN operations to retrieve descriptive data.

---

## Indicators

- The program makes heavy use of numbered indicators (`*inXX`), which are used for controlling read loop (e.g., EOF), heading output, and conditional logic.
- Example: `*in80` for EOF, `*in30` for page overflow, `*in71`/`*in91` for parameter-driven selection.

---

## Output

- Output is sent to **ll644p** (printer file), with both headings and detail lines.
- Accumulated % values and totals are printed per item, and possibly for groupings (not all group logic shown in this excerpt).

---

## Notable Features

- **Very Classic RPG Structure**: Fixed-format C-specs, indicator-based logic.
- **Norwegian Comments & Naming**: Comments and some field names are in Norwegian.
- **Overlayed Parameters**: Uses classic RPG technique for reading program parameters.
- **Intensive File I/O**: Uses CHAIN for master lookups, READ for sequential, and keyed setll for positioning.
- **Totals and Subtotals**: Totals are kept for calculating percentages.

---

## Typical Use Case

1. Called by another program, passing in selection parameters.
2. Looks up total sales and stock values.
3. Reads detailed inventory lines from a work file.
4. For each line, prints item info, sales, stock, calculated percentages.
5. Outputs a formatted report, suitable for identifying slow movers (shelf warmers).

---

## Summary Table

| Area             | Purpose                          | Key Fields/Files         |
|------------------|----------------------------------|--------------------------|
| Input files      | Detail, master, group registers  | lwa2l3, vvarl1, vogrl1, etc. |
| Output file      | Formatted report (printer)       | ll644p                   |
| Totals           | For percentage calculations      | totoms, totlve           |
| Parameters       | Controls selection and layout    | p_fvar, p_tvar, p_flag...|
| Indicators       | Logic control                    | *in80, *in30, *in71, etc.|
| Keylists         | Efficient file access            | vvarl1_key, vogrl1_key...|

---

## Onboarding Notes

- If you are new to RPG, familiarize yourself with fixed-format syntax, indicators, and file handling.
- Check DDS for logical and physical files (fields like mwomst, mwlagv, etc., are vital).
- The program is well-structured for its style, with ample comments and logical grouping.
- Most business logic is tied to inventory management and reporting for slow-moving items. 

If you need to extend or debug it, focus first on the main processing loop and the parameter logic in *INZSR.