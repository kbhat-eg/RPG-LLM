# Program Documentation: JV120R

## Overview

**Program Name:** JV120R  
**System:** ASVADM  
**Purpose:**  
This program is a parameter-driven interface for transferring new items (varer) to the EVR system. It presents a screen for user input, validates the input, and calls a transfer program (JV121R) with the entered parameters. The program supports querying and validating various item attributes, such as supplier, groupings, price group, assortment code, and delivery type.

This program is used in the context of item master data management, particularly for onboarding new items and associating them with the correct supplier, grouping, price, and other relevant metadata.

## Key Features and Business Logic

- **User Interaction:** Presents a workstation screen for data entry (`workstn` file `jv120d`).
- **Field Validation:** Validates user input for mandatory fields and logical correctness (e.g., valid supplier, group codes, date format).
- **Lookup and Query:** Supports field-specific lookups using sub-programs for supplier, groupings, price group, etc.
- **Parameter Passing:** Calls the transfer program (`JV121R`) with all validated parameters.
- **Extensibility:** The program has been extended across versions to support additional fields such as price group, assortment code, price change date, and logic for handling supplier status.

## File Relationships

- **Physical/Logical Files:**  
  - `jlevl1` (Supplier master, renamed from `jlevpfr`)  
  - `vogrl1` (Overgroup, renamed from `vogrpfr`)  
  - `vhgrl1` (Main group, renamed from `vhgrpfr`)  
  - `vugrl1` (Subgroup, renamed from `vugrpfr`)  
  - `vltpl1` (Delivery type, renamed from `vltppfr`)  
  - `ra30l1` (Price group, renamed from `ra30pfr`)  
  - `jsorl1` (Assortment code, renamed from `jsorpfr`)  

- **Workstation File:**  
  - `jv120d` (Screen definition)

## Main Program Flow

### Initialization (`*inzsr`)

- Receives optional supplier parameter (`p_ldor_alf`).
- Initializes key lists for all referenced files.
- Loads company number from LDA (`l_firm`).
- If supplier parameter is passed, pre-fills price-giving supplier and its name.
- If delivery type is present, pre-fills its description.
- Initializes the screen and other fields.

### Main Loop

- Displays the input screen (`exfmt b1bld`).
- Handles function keys:
  - Exit (`*inkc`, `*inkl`)
  - Inquiry (`*inkd`) triggers the `spørring` subroutine for field-specific lookup.
- Calls `sjekk_input` to validate user input.
- If input is valid, prepares date fields and calls the transfer program `JV121R` with all relevant parameters.
- Returns to the input screen for further entries.

### Subroutines

#### `spørring` (Inquiry)

Handles field-specific lookups based on which field the user is requesting help for. Calls the appropriate sub-program and updates the relevant field(s):

- Supplier (`JL500R`)
- Overgroup (`VG510R`)
- Main group (`VG511R`)
- Subgroup (`VG512R`)
- Price-giving supplier (`JL500R`)
- Delivery type (`VY500R`)
- Price group (`RA530R`)
- Assortment code (`JS510R`)

#### `sjekk_input` (Input Validation)

Performs comprehensive field validation:

- Ensures at least one of supplier or price-giving supplier is entered.
- Validates existence of supplier, groupings, delivery type, price group, and assortment code via keyed lookups.
- For supplier and price-giving supplier, calls `RS760R` to check for blocked or passive status (returns error if so).
- Validates date format for price change date.
- Sets error indicators and messages for any invalid input.

## Notable Design Decisions and Conventions

- **File Renaming:** Logical files are renamed for clarity and to avoid conflicts.
- **Key Lists (`klist`):** Used extensively for keyed lookups across multiple files, ensuring consistent access patterns.
- **Error Handling:** Uses indicators (`*in31`, `*in32`, etc.) and a general error flag (`b_feil`) to manage error states and control flow.
- **Sub-program Calls:** Business logic for validation and lookups is delegated to specific sub-programs (e.g., `JL500R`, `RS760R`). These encapsulate business rules and centralize validation logic.
- **Screen Handling:** The program is screen-driven, with a main loop that allows repeated data entry and correction.
- **Extensibility:** The program includes version comments and conditional logic to support new business requirements (e.g., price group, assortment code, price change date) without disrupting existing functionality.

## External Program and Data Source Interactions

- **`JV121R`:** Main transfer program, receives all validated parameters for item creation/update in EVR.
- **`JL500R`:** Supplier inquiry.
- **`VG510R` / `VG511R` / `VG512R`:** Grouping inquiries (overgroup, main group, subgroup).
- **`VY500R`:** Delivery type inquiry.
- **`RA530R`:** Price group inquiry.
- **`JS510R`:** Assortment code inquiry.
- **`RS760R`:** Supplier status check (blocked or passive suppliers).

## Field and Parameter Overview

- **Supplier (`b1ldor`):** Main supplier for the item.
- **Overgroup (`b1ogrp`), Main group (`b1hgrp`), Subgroup (`b1ugrp`):** Hierarchical grouping for categorizing the item.
- **Price-giving supplier (`b1pgiv`):** Supplier providing price information.
- **Delivery type (`b1lety`):** Specifies the type of delivery for the item.
- **Price group (`b1prgr`):** Used for pricing logic (extended to two positions in later versions).
- **Assortment code (`b1osor`):** Used for assortment management.
- **Price change date (`b1dato`):** Optional; triggers additional validation.
- **Show discontinued (`b1utgp`):** Parameter to include/exclude discontinued items.

## Error and Status Indicators

- **`b_feil`:** Master error flag, set to `*on` if any validation fails.
- **Screen indicators (`*in31`, `*in32`, etc.):** Used to signal specific error conditions to the display file.

## Version History and Extensions

The program has evolved through multiple versions, as detailed in the comments. Key enhancements include:

- Addition of price group and assortment code.
- Enhanced logic for supplier and price-giving supplier status.
- Support for price change date and handling of discontinued items.
- GUI-related adjustments (e.g., for Jacada and new GUI requirements).

## Summary

`JV120R` is a central program for item onboarding and parameter management in the EVR system. It orchestrates user input, validation, and integration with master data tables and sub-programs. The design emphasizes modularity, maintainability, and extensibility to accommodate evolving business requirements in item management. 

Understanding the relationships between the main data files, the validation sub-programs, and the transfer logic is critical for effective maintenance and further development. The program is a key entry point for ensuring data integrity and business rule compliance in the item master domain.