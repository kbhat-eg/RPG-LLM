# Program VD751R â€“ Documentation

## Purpose

This program is responsible for (re)creating the "totalsortiment" (complete assortment) for a given assortment (sortiment) in the ASOFAK system. It reads the master item register, deletes any existing assortment lines for the specified assortment, and generates new assortment lines based on the current item master. If an item has been replaced (i.e., its item number has changed), the program ensures the new item number is used in the assortment.

## High-Level Flow

1. **Initialization:** Receives parameters, sets up keys, and initializes working variables.
2. **Assortment Header (vshelur):** Updates or creates the assortment header record.
3. **Delete Existing Lines (vsdtlur):** Deletes all current line records for the assortment.
4. **Build New Lines (vsdtlur):** Reads the item master (vvarl9), processes each item, and writes new assortment lines.
5. **Exit:** Ends the program.

---

## File Usage and Relationships

- **vvarl9 (Item Master):** Source of all items to be included in the assortment. Renamed as `vvarl9r`.
- **vshelur (Assortment Header):** Header record for the assortment. Renamed as `vshelur`.
- **vsdtlur (Assortment Line):** Line records for items in the assortment. Renamed as `vsdtlur`.

The program also interacts with an external program, **FO711C**, to resolve item number changes ("matching" to a new item number if applicable).

---

## Key Data Structures and Variables

- **Parameter List (p_list):** 48-character input parameter, split into:
    - `d_firm` (Company, 3 digits)
    - `d_vsor` (Assortment ID, 10 chars)
    - `d_besk` (Description, 35 chars)
- **Local Data Area (LDA):** Used to fetch the current user (`l_user`).
- **w_firm, w_gvar, w_vare:** Working variables for company and item numbers, used for keying and item number resolution.
- **vshelu_vsor, vsdtlu_vsor:** Temporary variables for assortment ID, used in key lists.

---

## Detailed Logic

### 1. Assortment Header Handling

- **CLEAR** the header record structure.
- **CHAIN** attempts to read an existing header for the given assortment.
    - If found, **UPDATE** fields (description, user, timestamps).
    - If not found, **WRITE** a new header (initializes warehouse/lager to 0 as of version 6.20).
- **User and timestamp fields** are consistently set for both creation and update for traceability (added in version 6.10).

### 2. Deleting Existing Assortment Lines

- **SETLL/READE**: Position to the first line for the assortment.
- **DOW** loop: Delete all lines (`DELETE vsdtlur`) for the current assortment until EOF.

### 3. Rebuilding Assortment Lines

- **SETLL/READE**: Position to the first item in the item master.
- **DOW** loop: For each item:
    - If the item number is below '10000000', call **FO711C** to check if the item has been replaced. If so, update to the new item number.
    - Populate the assortment line record with fields from the item master and parameter (assortment ID).
    - Set warehouse/lager to 0 (as of version 6.20).
    - Set all user and timestamp fields.
    - **WRITE** the new line to `vsdtlur`.
- Repeat until all items have been processed.

### 4. Program Termination

- **Set LR indicator** to signal program end and return.

---

## Notable Design Decisions and Conventions

- **Versioning and Change Log:** The program header comment includes a detailed change log, with version numbers and descriptions of changes.
- **Use of External Program (FO711C):** Encapsulates the logic for resolving item number changes, centralizing the business rule for item replacements.
- **Consistent Key Handling:** Key lists (`klist`) are defined in the *INZSR subroutine for all files, ensuring keys are set up before any database operation.
- **Traceability:** All updates and inserts include user and timestamp fields for auditing, with enhancements in later versions.
- **Parameter Passing:** Uses a packed parameter list and overlays for efficient parameter handling, a common pattern in this codebase.

---

## Business/Domain-Specific Logic

- **Assortment ("sortiment"):** Represents a collection of items (for a customer, campaign, etc.). The program ensures the assortment is always up to date with the latest items and item numbers.
- **Item Number Matching:** The system supports item number changes ("matching"), and this program ensures the assortment always refers to the current item number.
- **Warehouse/Lager:** As of version 6.20, assortment lines include a warehouse field, initialized to zero.

---

## External Dependencies

- **FO711C:** Must be maintained to ensure correct item number resolution.
- **File Definitions:** The structure and fields of `vvarl9`, `vshelur`, and `vsdtlur` must match those assumed here, especially regarding keys and audit fields.

---

## Summary Table

| File      | Purpose                          | Key Fields                  |
|-----------|----------------------------------|-----------------------------|
| vvarl9    | Item master (source of items)    | w_firm, vvvare              |
| vshelur   | Assortment header                | w_firm, vshelu_vsor         |
| vsdtlur   | Assortment line (items in set)   | w_firm, vsdtlu_vsor         |

---

## Maintenance Notes

- **Adding new fields:** Ensure all relevant logic (write/update, FO711C call, etc.) is updated accordingly.
- **Assortment extensions:** If assortment logic changes (e.g., filtering, new matching rules), centralize changes in FO711C or in the main item processing loop.
- **Audit fields:** Always update user and timestamp fields on any change.

---

## Contact

For further questions about the business rules or integration points, contact the ASOFAK application owner or the team responsible for assortment management.