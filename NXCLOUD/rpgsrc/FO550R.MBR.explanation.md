# RPG Source Explanation: FO550R – Multi Inquiry Program for Orders

## Overview

This RPG program, **FO550R**, is a core transactional inquiry utility for orders and their relationships in an IBM i (AS/400) ERP environment. It is designed for power users (typically customer service, logistics, or finance) who need to look up orders, invoices, deliveries, shop orders/bongs, and their connections—using a variety of possible references (order number, invoice number, bong number, purchase order, vendor invoice, etc).

It is _highly modular_, supporting multiple types of transactions, time intervals (back in history), and interrelated document types (such as deleted orders, EDI, and archive queries). It is Norwegian in origin, as seen in comments and terms (e.g., "ordre" for order, "bestilling" for purchase order).

---

## 1. File Declarations (`F-Specs`)
A large number of disk files are declared, typically as keyed (K) externally described (E) files, each renamed for this program, representing different document types, e.g.:
- **fohel1, fdell8, sohel2, sohel3, bohel1, bodtl3, lohel1, ldell2, etc**: Representing headers/lines for orders, deleted orders, invoices, bongs, purchase orders, etc.
- **fo550d**: A display file with a subfile (B1SFL) for presenting search results.

---

## 2. Data Structures & Variables (`D-Specs`)
### 2.1 Transaction Array
- **tr_info (DIM(500))**: Main working area holding up to 500 found documents, overlaid into fields like tr_numm (order number), tr_refn (reference), tr_stat (status), tr_user (user), tr_dato (date), tr_time (time), tr_btyp (type), tr_kund (customer), etc.

### 2.2 Key Variables
- A set of variables (e.g., fohel1_numm, sohel3_numm, etc.) hold key values for file operations.

### 2.3 Working Variables
- E.g., **w_numm**, **w_best**, **w_bong**, etc. represent the current search values and supporting logic for search routines.

### 2.4 Flags and Indicators
- Flags like **b_forn, b_anul, b_feil, b_best, b_bes2, b_bes3** control subroutine logic.
- RPG indicators (*in##) are used for function key processing, e.g., 10=Roll, 12=Sfldsp, 13=Sfldspctl, etc.

---

## 3. Mainline Logic

### 3.1 Program Start and Initialization
- The program initializes variables, clears the subfile, and sets the starting search criteria (based on parameters).
- Entry points and program initialization are handled in **\*inzsr**.

### 3.2 Main Loop
- The user is presented with a subfile-based display for search results.
- The user can press function keys to trigger different behaviors (refresh, jump to EDI, incoming invoice history, etc).
- If the search criteria (order, invoice, bong, etc.) change, a new search is triggered via `nytt_sok`.

---

## 4. Subfile Management Subroutines

### 4.1 `clr_subfile`
- Clears the subfile and resets subfile variables.

### 4.2 `crt_subfile`
- Calls a series of routines to populate the transaction array:
  1. `null_tab` clears the array.
  2. Various routines (`finn_aktive`, `finn_ordslett`, etc.) each pull a particular type of related transaction (active orders, deleted orders, invoices, bongs, bestilling/purchase orders, deleted purchase orders, incoming invoices, EDI).
  3. Results are sorted (`sort_tab`) and written into the display subfile.

### 4.3 `dsp_subfile`
- Prepares and displays the subfile to the user.

---

## 5. Search and Inquiry Subroutines

The program supports searching from a variety of starting points and can follow connections to related documents:

### 5.1 `nytt_sok`
- Central hub determining which of the "via" search routines to use:
  - **via_ordr**: From order number, find bestilling, associated docs.
  - **via_fakt**: From invoice, find order(s).
  - **via_bong**: From shop order/bong, find order(s).
  - **via_best**: From purchase order, find order(s).
  - **via_levonr**: From vendor order reference.
  - **via_levfak**: From vendor invoice reference.
- The subfile is cleared and filled based on results.

### 5.2 Document Collection Routines
Each `finn_*` and `lagr_*` subroutine handles a specific document type:
- **finn_aktive**: Active orders
- **finn_ordslett**: Deleted orders
- **finn_faktura**: Outgoing invoices
- **finn_bong**: Shop/retail transactions
- **finn_bestill**: Related purchase orders
- **finn_beslett**: Deleted purchase orders
- **finn_innfakt**: Incoming invoices
- **finn_EDI**: EDI messages/transactions

### 5.3 "via" Subroutines
Each handles a search path from a starting document reference to an order number.

- **via_ordr**: Direct order number search; looks for related bestilling.
- **via_fakt**: Given an invoice, look up the order(s).
- **via_bong**: Given a bong, find its order(s).
- **via_best**: From a bestilling, look up associated order (or via incoming invoice, deleted, etc).
- **via_levonr / via_levfak**: From vendor order or invoice numbers.

If multiple possible results are found, a selection program (e.g., FO551R, FO552R, FO553R, FO554R) is called.

### 5.4 "lagr_*" Subroutines
- Used to add additional records to the transaction array if they haven’t already been included via another search path (to prevent duplicates).

---

## 6. Display/Drill-down

Inside the subfile handler, if the user requests to "Show details" (`b1valg=5`), a call is made to the correct program for that document type:
- **Customer order:** FO505R
- **Deleted order:** FY510R
- **Outgoing invoice:** SO510R
- **Bong/shop transaction:** BO310R
- **Purchase order:** LO505R
- **Deleted purchase order:** LY510R
- **Incoming invoice:** SH410R
- **EDI orders:** LI102R, LI106R
- **Archive lookup:** AP622C (with various types)

---

## 7. Key Lists (`KLIST`)
At the end of the program, all file key lists are defined, binding key values to the appropriate variables for file operations.

---

## 8. Special Features

### 8.1 EDI and Archive Integration
- Special logic for EDI messages (with support for new numbering schemes and EDI-specific programs).
- Archive lookups utilize a flexible category/type system (e.g., TILBUD, ORDREBEKREFTELSE, FAKTURA, etc.), calling external archive programs.

### 8.2 Year Handling
- Designed for multi-year lookups (e.g., looks back up to 6 years for documents, supports year transitions).

### 8.3 Multi-Path Logic
- Handles cases where a given reference (order/bong/etc) may map to multiple possible transactions; has logic to call selection subprograms when ambiguity exists.

---

## 9. Comments/Documentation

- In-line comments in Norwegian describe the history and purpose of changes, plus explanations for indicators and fields.
- The change log (at the top) is extensive, showing a long life and iterative improvements of the program.

---

## 10. Typical Program Flow

1. **Initialization:** Parameters received (order number / type), initial screen and subfile cleared.
2. **User Input:** User can enter or change their search reference (order, invoice, etc.) and press a function key to search.
3. **Search Processing:** Appropriate path is selected (order, invoice, bong, etc.), all related documents are retrieved and stored in the transaction array.
4. **Display:** Subfile is presented; user can drill into details.
5. **Drill-down:** Depending on transaction type, the respective detail program is called.
6. **Function Keys:** Special routines allow jumping to EDI, incoming invoice history, or archive searches.
7. **Exit:** Program can be exited via function key or indicator.

---

## 11. Getting Onboarded: Key Tips

- **Transaction Array (`tr_info`):** Main structure for presenting data. Understand its mapping and overlays!
- **Subfile Logic:** Study how subfiles are cleared, filled, and displayed—you'll be modifying this for new document types or behaviors.
- **Search Paths:** Each "via_" subroutine represents a user entry (order, invoice, etc). To extend search logic, augment these or add new ones.
- **Drill-down Handlers:** To add new detail display programs, modify the subfile selection handler.
- **File Definitions:** Know which file/table holds which document type.
- **Year Ranges:** Be aware of how year cut-offs are handled due to multi-year archiving.
- **Indicators:** RPG classic indicator usage is central—especially for function keys and subfile management.

---

## 12. High-Level Diagram

```
[User Input]
     |
     v
[Identify Reference Type]
     |
     v
[nytt_sok]
     |     (one or more)
     +-----[via_ordr/via_fakt/via_best/etc.]
                 |
                 v
      [Find all related transactions: finn_*]
                 |
                 v
     [Fill tr_info array, sort]
                 |
                 v
      [Display Subfile]
                 |
         [Drill-down on choice]
                 |
         [Call respective detail program]
```

---

## 13. Further Reading/References

- IBM ILE RPG reference (for classic Fixed-format code with subfiles)
- Internal documentation for each referenced detail program (e.g., FO505R, SO510R, LO505R, AP622C, etc.)
- File layouts and relationships—especially for multi-year and archive tables

---

**Summary:**  
FO550R is a powerful, central inquiry tool for navigating the web of orders, invoices, bongs, and related documents in a legacy IBM i ERP system. It is heavily parameterized, modular, and designed to support complex, multi-year search and drill-down scenarios for both operational and historical documents. If you’re tasked with maintaining or extending this program, first get familiar with the transaction array structure, the subfile mechanism, and the various "via" search paths. The code structure is logical and well-commented, albeit in classic (pre-free) RPG style.