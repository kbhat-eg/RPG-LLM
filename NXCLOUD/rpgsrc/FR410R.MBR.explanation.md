## Program Overview

**Program Name:** FR410R  
**System:** ASOFAK  
**Description:**  
This program deletes discount agreements (rabattavtale) for a given discount category (`rabattkategori`) or customer (`kunde`). It operates on two files: `frabld` (discount by category) and `frabl3` (discount by customer), deleting records based on provided input parameters.

---

## Business Context

- **Discount Matrix (Rabattmatrise):**  
  The system maintains discount agreements both by discount category and by customer. This program is used to remove such agreements, either for an entire category or for a specific customer, depending on the parameters received.

- **Files Involved:**  
  - `frabld` (renamed as `frabldr`): Holds discount agreements by discount category.
  - `frabl3` (renamed as `frabl3r`): Holds discount agreements by customer (and, as of version 5.70, also by price group).

---

## Parameters

The program receives three parameters:

- `p_firm`: Company identifier.
- `p_rkat`: Discount category.
- `p_kund`: Customer number.

---

## File Declarations

```rpg
ffrabld    uf   e           k disk    rename(frabpfr:frabldr)
ffrabl3    uf   e           k disk    rename(frabpfr:frabl3r)
```
- Both files are externally described, keyed, and renamed for local use.  
- `frabld` and `frabl3` are accessed for deletion operations.

---

## Key Variables

- `w_firm`: Company identifier, set from the parameter.
- `frabld_rkat`: Discount category key for `frabld`.
- `frabl3_kund`: Customer key for `frabl3`.

Key lists are constructed for both files to support keyed access.

---

## Main Logic

### 1. Delete by Discount Category

```rpg
if p_rkat <> 0
    frabld_rkat = p_rkat
    setll frabld_key frabld
    reade frabldr frabld_key
    dow not %eof
        delete frabldr
        reade frabldr frabld_key
    enddo
endif
```
- If a discount category is specified (`p_rkat <> 0`), all records in `frabld` matching the company and category are deleted.
- Uses a key list (`frabld_key`) for efficient access.
- Loops through all matching records and deletes them.

### 2. Delete by Customer

```rpg
if p_kund <> 0
    frabl3_kund = p_kund
    setll frabl3_key frabl3
    reade frabl3r frabl3_key
    dow not %eof
        if frkpro = 0
            delete frabl3r
        endif
        reade frabl3r frabl3_key
    enddo
endif
```
- If a customer is specified (`p_kund <> 0`), all records in `frabl3` matching the company and customer are considered for deletion.
- Only records where `frkpro = 0` (i.e., no price group assigned) are deleted. This is a business rule added in version 5.70 to avoid deleting customer-specific discounts that are tied to a price group.

---

## Initialization (`*inzsr`)

- The program entry list (`*entry plist`) maps the three input parameters.
- Key lists (`klist`) for both files are built using `w_firm` and the relevant key variable.
- `w_firm` is initialized from the parameter.

---

## Program Termination

- Sets the last record indicator (`*inlr = *on`) and returns.

---

## Design Considerations and Conventions

- **Zero as "not specified":**  
  Both category and customer parameters use `0` to indicate "not specified." Only non-zero values trigger deletions.
- **Keyed Access:**  
  Efficiently processes only relevant records using key lists.
- **Price Group Logic:**  
  The check for `frkpro = 0` when deleting customer-specific discounts in `frabl3` ensures that only records not associated with a price group are deleted. This protects more granular discount agreements.
- **No Debug I/O:**  
  The `option(*nodebugio)` is specified, as is standard in production code for performance and security.
- **Date Format:**  
  Dates are edited as DMY (`datedit(*dmy)`), which may be relevant for interpreting date fields (not directly used in this program).

---

## Interactions

- **No External APIs:**  
  The program acts directly on the `frabld` and `frabl3` files. There are no calls to other programs or APIs.
- **Downstream Effects:**  
  Deleting discount agreements may impact other modules that depend on these records for pricing or sales logic.

---

## Version Notes

- **5.70 Enhancements:**  
  - Extended to handle price group logic in `frabl3` (added the `frkpro = 0` check).
  - Additional comments and key field handling for the new logic.

---

## Summary Table

| Parameter   | Affects File | Business Logic                                     |
|-------------|-------------|----------------------------------------------------|
| p_rkat ≠ 0  | frabld      | Delete all for company/category                    |
| p_kund ≠ 0  | frabl3      | Delete all for company/customer, if frkpro = 0     |

---

## Key Takeaways

- This program is a batch utility for cleaning up discount matrices by category or customer.
- It is safe-guarded to avoid deleting discounts tied to price groups (as of v5.70).
- Only operates on the records matching the provided parameters and company.
- Designed for efficient, keyed file access and safe batch operation.