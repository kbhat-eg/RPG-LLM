# RPG Program SF852R: Export Sales Statistics to File — Explanation

This RPG IV program is used for exporting sales statistics data to a file, usually for reporting or integration with other systems. It's a comprehensive program, with history, file definitions, parameter/data structures, and a main processing loop, plus a number of subroutines for handling business logic. Below is a detailed explanation of the structure and main functional components.

---

## 1. **Header and Change Log**

- The program header contains metadata (system, program name, description).
- The large comment block lists a detailed change history, indicating frequent maintenance, enhancements, and bug fixes. This codebase has many contributors and is actively maintained.

---

## 2. **File Specifications (`F-specs`)**

Each `F` line defines an external file this program will access. Most are keyed (`k disk`), and some use `rename()` to use local record formats.

Sample:
```rpg
fsstalh    uf   e           k disk    rename(sstapfr:sstalhr)
fjlevl3    if   e           k disk    rename(jlevpfr:jlevl3r)
...
fsonopf    o  a e           k disk
```
- **Files used for input:** Sales statistics, supplier, customer, project, campaign, order header/line, etc.
- **Output file:** `sonopf` — this is where the export records are written. 

---

## 3. **Data Definitions (`D-specs`)**

### Parameters & Data Areas

- `p_list`: Local parameter (40 chars)
- A user data structure (`uds`) for sharing values across the program (here, `l_fnav` is mapped within it).

### Parameter Data Structure (`d_list`)

A 40-character parameter list, with overlays for:
- `d_firm`: Company number
- `d_avde`: Department
- `d_fdat`, `d_tdat`: Date range (*ISO format)
- `d_tidl`: "Time ID", likely for selection logic

### Statistics Export Record Structure (`d_stat`)

A 1000-byte data structure, heavily overlayed for individual fields (from product, customer, amounts, dates, campaign, etc.). This is meticulously mapped to suit the export format, and includes:
- Identifiers: product, EAN, customer, order numbers
- Texts: names, addresses, project info
- Amounts: gross/net/rabatt/cost/quantity
- Additional fields: email, bonus, campaign, delivery info

**This structure is the buffer for each output record.**

### Work Variables

General-purpose variables for intermediate values (`w_dato`, `w_vgrp`, etc.), flags, counters, and field buffers.

---

## 4. **Main Program Logic**

### Initialization

- Grabs current time with `time w_ddat`.
- Loads exported data based on whether `d_tidl` (Time ID) is zero or not, dictating which key to use for record positioning.

### Main Processing Loop

- Loop through sales statistics (`sstalh`), using either normal or alternative key, based on parameter.
- For each record:
    - Call subroutine `OPPDATER` to process and write the data.
    - Fetch the next record using appropriate key.
- When done, process packing slips (`pakkseddel` subroutine).
- Program ends by setting LR indicator (`*INLR = *ON`) for cleanup.

---

## 5. **Subroutines**

### `OPPDATER` — Core Record Processing

- **Filters:** Skips records not matching department (`d_avde`) or outside date range (`d_fdat`, `d_tdat`).
- **Populates the export structure (`d_stat`)** with a combination of:
    - Data from the sales statistics file.
    - Related info fetched from customer, supplier, category, etc. files through keyed access (`chain`).
    - Text cleaning: Replaces problem hex characters (`x'05'`, `x'0D'`, etc.) to avoid data issues in output.
- **Works out amounts:** gross, net, discount, cost, and quantity—with proper formatting for output (including sign handling).
- **Sets flags:** e.g., 'Skaffevare' (special order), delivery method.
- **Looks up campaign offers (`finn_kamp`):** If applicable, populates campaign start/end dates.
- **Writes the record** to the output file (`sonopfr`).
- **Marks source record as reported** and updates for next run.

### `PAKKSEDDEL` — Export Packing Slips

- Scans recent orders (last month, adjustable).
- For each eligible order and each item line, calls `DANN_PAKK` to create an export record, marking it as a packing slip.

### `DANN_PAKK` — Process Packing Slip Line

- Similar to `OPPDATER`, but for packing slip lines rather than direct sales statistics.
- Gathers and assembles all relevant info into the export structure.
- Performs the same data cleaning, formatting, and writes to the output file.

### `FINN_KAMP` — Find Campaign Details

- For a given campaign/product/group/date, retrieves the relevant campaign period (start/end dates).

### `*INZSR` — Initialization Subroutine

- Handles program entry parameter(s).
- Initializes all keyed access lists (`klist`) for files (customers, suppliers, categories, projects, etc.).
- Sets up data structures for further processing.

---

## 6. **Key Techniques and Business Rules**

- **Keyed file access:** Heavy use of `setll/reade` and `chain` by composite keys.
- **Data cleaning:** Proactive replacement of unwanted characters to avoid export issues.
- **History preservation:** All changes are carefully documented, and some code is commented (historical or alternate logic).
- **Business logic integration:** The program enforces rules for sign handling, campaign period assignment, special-order flagging, delivery methods, etc.
- **Multi-file joins:** For export, data from multiple DB files is combined into the flat structure needed for transfer.
- **Packing slips treated as sales:** Packing slip records are exported in the same format as sales, but flagged accordingly.

---

## 7. **Useful Onboarding Notes**

- **Record format definitions** and field overlays must match the underlying physical/logical files.
- **Parameter structure**: The program expects a 40-char input parameter (`p_list`) formatted as per the overlay
- **Extendability:** New fields can be added by extending the `d_stat` overlay and adjusting the writing logic.
- **Business logic:** Check customer-specific logic for discounts, campaigns, signs, and special products before modifying.
- **Testing:** Critical to test changes with real data due to extensive data cleaning/formatting and cross-file joins.

---

## 8. **Summary Workflow**

1. **Initialization**: Read parameters, prepare keyed access.
2. **Read sales statistics**: For each record within parameter criteria:
    - Gather and synthesize all relevant details into the export buffer.
    - Clean and format the data.
    - Write to the output export file.
    - Mark as reported in the original file.
3. **Repeat for packing slips** (`pakkseddel`).
4. **Program end**.

---

## 9. **Special Comments**

- The program deals with Norwegian business terms (e.g., 'pakkseddel', 'vare', 'kunde', 'leverandør', etc.).
- There's a strong focus on data integrity for exports (character/hex cleaning, formatting).
- The code contains some commented SQL blocks and conditional logic for future or alternative implementations.

---

## 10. **Conclusion**

This program is an excellent example of a batch RPG process, combining data from several business domains into an export file, according to strict formatting and business rules. Onboarding developers should be aware of the intricate field mappings, the importance of parameter-driven filtering, and the need for careful data formatting/cleaning throughout. All logic for any given output field can be traced through the main `OPPDATER` and `DANN_PAKK` routines, with cross-file lookups governed by keyed access defined in the initialization section. 

**Always cross-check the field overlays and file layouts when extending or maintaining this code.**