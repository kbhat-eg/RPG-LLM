# High-Level Overview

This RPG/400 (ILE RPG) program, named `JV505R`, is an interactive inquiry (spørring) over product data for users working with orders. It allows flexible searching and positioning in the product file, supporting various product groupings (overgroup, main group, subgroup), free text searches, and direct product number, NOBB number (a Norwegian product classification), and supplier product number lookups. Data is presented in a subfile, supporting paging, selection, and drill-down to further item details.

# Key Components

## File Declarations

- **Logical Files (`f...`)**: Several logical files represent different ways of accessing product and search data (e.g., `jvsost`, `jvarla`, `jvarlb`, `jvarlc`, etc.). They are renamed within the program for clarity.
- **Workstation File**: `fjv505d` is used for display file/subfile handling.
- **Input Data Structure**: `dspfbk` is used for display feedback, notably to track the record number for subfile paging.

## Data Structures & Variables

- **Parameters**: Received at program start (firm, groupings, search text, product number, etc.).
- **Key Variables**: For constructing keys for various logical files.
- **Work Variables**: For subfile control (current record, page size, from/to record numbers, etc.), search criteria, user toggles, display status, etc.
- **Constants**: Such as `c_sfil`, the subfile page size.

## Indicators

A long-standing RPG concept for controlling logic and screen attributes. Comments explain indicator usage (e.g., *IN10=rollup, *IN11=rolldown, *IN12=show subfile, *IN14=clear subfile, etc.)

## Comments & Documentation

Inline documentation describes fields, indicator usage, screen layouts, and the general process.

# Program Flow

## **Initialization (`*inzsr`)**
- Loads parameters from entry plist.
- Prepares key lists for all needed access paths.
- Sets up display indicators.
- Initializes current date (* for date-sensitive queries).
- If called with group or search parameters, triggers a search; else, builds an empty subfile.

---

## **Main Loop (Display, Search, Paging)**

### **Display & Command Loop**
- Sends the main command selection screen (`write b2cmd`).
- Calls subfile display routine to present current page.
- Waits for user action (function key, selection, etc.).
- Handles paging (rollup, rolldown), selection, and search keystrokes via subroutines.

### **Function Key Handling**
- *F3/F12*: Exit the program.
- *F4 (Inquiry)*: Calls subroutines to assist user in selecting groupings.
- *F5 (Refresh)*: Calls `forny` to refresh the subfile page.
- *F10/F11*: Forward/backward page through the subfile.

### **Modes for Displaying Alternatives**
- *F23*: Toggles display field (Product Number, NOBB, Supplier Number).

---

## **Subroutines**

### **forny (Refresh Subfile)**
- Repositions in the logical files based on last used key.
- Clears and recreates the subfile to reflect any changes or new search.

### **søk (Search in Subfile)**
- Validates that groupings make sense in hierarchy.
- Stores search parameters for later repetition.
- Handles both structured and free text search, calling external programs to aid in search construction if needed.
- Decides which SQL cursor/subfile loading algorithm to use based on search parameters.
- Resets search fields after search.

### **posisjoner (Position in Subfile)**
- Allows direct positioning by text, product number, NOBB number, or supplier number.
- Sets up the key for the appropriate logical and positions there.

### **subfile (Subfile Processing)**
- Handles subfile selection logic by reading displayed subfile records.
- If a row is selected (`b1valg=1`), captures the product data for return.
- Allows "details" drill-down with another selection code (`b1valg=5`).

### **clr_subfile (Clear Subfile)**
- Activates the subfile 'clear' indicator, writes the control record to clear contents, resets page counters, etc.

### **crt_subfile (Create/Fill Subfile)**
- Based on search/positioning mode, loads the subfile:
  - Direct reade/readp/read calls for non-SQL search, or
  - Opens and uses declared SQL cursors for more complex searches.
- Populates the subfile page-by-page, skipping excluded/deleted items and checking for presence in other files, as required.
- Avoids duplicates and fills indicator-controlled fields.
- Fetches supplier name (`b1navn`) as needed for display.

### **bck_subfile (Back Page in Subfile)**
- Moves backwards one page through the subfile (using `readp` RPG opcodes).

### **dsp_subfile (Display Subfile)**
- Controls screen presentation, sets needed indicators, writes or formats control record, and updates feedback data structure.
- Captures which record and field had the cursor for supporting subsequent search/inquiry.

### **spørring (Inquiry Assistance)**
- Based on which field the cursor is in, calls further support programs to assist user in selecting overgroup, main group, or subgroup, and fills in text fields appropriately.

# Data Access & Search

### **SQL Integration**
- For flexible/complex searches, dynamic SQL cursors are declared/opened, fetching data with joins and filtering.
- Parameters are passed from RPG variables using host variables (e.g., `:b2ogrp`, `:w_udat`, etc.).
- This pattern allows the code to be future-proof and more maintainable (since some direct record access is less flexible).

### **Logical File Access**
- For direct positionings (by product number, NOBB, or supplier number), classic RPG 'chain', 'reade', and 'readp' operations against logical files are used.

### **Subfile Population**
- Multiple fields and indicators are filled for each subfile record: product number, NOBB number, supplier number, product name, page controls, and any auxiliary information (e.g., supplier name).

### **Item Filtering**
- Items are excluded if marked as deleted or not valid anymore (`jvstat = 4`, `jvudat`).
- Filter also removes products found in another file (EVR) or already processed (via subselects in SQL and additional logic).

# User Interaction

- **Search by Product Number, Name, NOBB, Supplier Number, or Grouping**: Flexible search interface.
- **Page Forward/Back**: Rollup/rolldown to move through the result set.
- **Select or View Details**: Option to select a product or view further details.
- **Toggle Display**: Switch between showing product number, NOBB, or supplier number in listings with F23.
- **Assistance for Codes**: Inquiry keys (F4) for group selection, with external program calls to help users pick from lists.

# Error and Status Handling

- Uses indicators to communicate errors (invalid group hierarchies, etc.), to signal end-of-data, to control display attributes, and to manage paging logic.

# Summary Table

| Functionality              | Implementation                                              |
|----------------------------|------------------------------------------------------------|
| Search Products            | Subroutine `søk`, SQL cursors, direct key access           |
| Flexible Search Criteria   | Product, text, grouping, NOBB, supplier number             |
| Subfile Control & Paging   | Custom counters, indicators, `readc`, `write`, `clr` logic |
| Selection & Details        | Subfile field `b1valg`, selection logic in `subfile`       |
| User Assistance            | F4/F23 keys, inquiry subroutines, external program calls   |
| Data Filtering             | Excludes deleted, expired, or previously processed         |
| Auxiliary Display Info     | Loads supplier names dynamically                           |
| Robust Error Handling      | Indicators, field validations, controlled loops            |

# Onboarding Guidance

- **Understand Indicators**: This program uses classic RPG indicators; reviewing their usage will clarify flow control and screen management.
- **Review Subfile Logic**: Mastery of subfile clearing, populating, and paging is essential here.
- **SQL & Native Record Access**: The program is a mix—optimizing between old-style reade/readp and embedded SQL for different searches.
- **Modular Approach**: If new searches or fields are needed, new SQL cursors or logical files must be added, and corresponding subfile field logic updated.
- **External Calls**: Search helpers (`AS702R`, `AS701R`), and group pickers (`VG510R`, etc.) are external programs you may need to reference.

---

**In summary:**  
This is a highly flexible, feature-rich RPG inquiry program for product data, with extensive subfile handling, support for multiple search strategies (both structured and free text), robust paging and positioning, and a strong focus on user experience via function keys and inquiry aids. Understanding the interplay between indicators, subfile fields, and embedded SQL/native file access is key to maintaining and extending this program.