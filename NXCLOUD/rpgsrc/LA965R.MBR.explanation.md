# Program Documentation: LA965R â€“ Calculation of Inventory Movements from Inventory Ledger

## Overview

**Program Name:** LA965R  
**System:** ASLAGR  
**Description:**  
This program calculates inventory movements by reading and processing records from the historical inventory ledger (`VHISLR`). The results are returned via a parameter structure, providing summarized movement figures (sales, withdrawals, adjustments, receipts, and stock on hand) for a specific item and warehouse over a defined date interval.

**Business Domain:**  
The program is part of the warehouse management/accounting system. It is typically invoked by other programs that require summarized movement data for reporting, reconciliation, or further processing.

---

## Structure

### File Definitions

- **VHISLR**:  
  - Type: Disk file (database table)  
  - Purpose: Historical inventory ledger, renamed in this program to `VHISLRR` for local reference.
  - Access: Keyed access for efficient retrieval by warehouse, item, date, time, and sequence.

### Data Structures

#### Parameter Structure (`d_prec`)

A 128-byte data structure overlays the input/output parameter. It contains:

| Field      | Type       | Offset | Description                           |
|------------|------------|--------|---------------------------------------|
| d_lage     | 2, 0       | 1      | Warehouse code                        |
| d_vare     | 15A        | 3      | Item number                           |
| d_fdat     | 10D (ISO)  | 18     | From-date (start of interval)         |
| d_tdat     | 10D (ISO)  | 28     | To-date (end of interval, exclusive)  |
| d_beve     | 11, 3      | 39     | Number of movements                   |
| d_salg     | 11, 3      | 50     | Sales quantity                        |
| d_utta     | 11, 3      | 61     | Withdrawals quantity                  |
| d_just     | 11, 3      | 72     | Adjustments quantity                  |
| d_inng     | 11, 3      | 83     | Receipts quantity                     |
| d_behl     | 11, 3      | 94     | Stock on hand (running balance)       |

#### Local Data Area (LDA)

- Used to fetch the current firm/company code (`l_firm`) and user.

#### Key Variables

- Used for keyed access to `VHISLR`:
  - `vhislr_lage` (warehouse)
  - `vhislr_vare` (item)
  - `vhislr_dato` (date)
  - `vhislr_time` (time)
  - `vhislr_sekv` (sequence)

#### Working Variables

- `w_firm`, `w_parm`, and a set of accumulators for each movement type.

---

## Processing Logic

### Initialization (`*INZSR`)

- **Key Lists:**  
  - Defines two key lists for file access:
    - `vhislr_key`: For full key access (firm, warehouse, item, date, time, sequence)
    - `vhislr_key2`: For partial key access (firm, warehouse, item)
- **Parameter Handling:**  
  - Receives the parameter block from the caller, overlays it as `d_prec`.
  - Extracts warehouse, item, and date interval from the parameter.
- **Firm Code:**  
  - Sets the working firm code from the LDA.

### Main Processing

1. **Accumulator Initialization:**  
   - All movement accumulators are zeroed at the start.

2. **Read Loop:**  
   - File positioned using `SETLL` and `READE` to the first relevant record for the given firm, warehouse, and item.
   - Loop continues until EOF or transaction date (`vhdato`) reaches the end date (`d_tdat`).

3. **Filtering and Movement Classification:**  
   - **Counting Movements:**  
     - Every record processed increments the movement counter (`w_beve`).
   - **Sales (Salg):**  
     - Identified by `vhsyst = 'F'` (possibly sales system), further classified by `vhtype = 'U'` (unknown, possibly "outgoing").
     - Quantities are added/subtracted from accumulators based on the type.
   - **Withdrawals (Uttak):**  
     - Identified by `vhsyst = 'L'` and `vhkode = 'U '`.
     - Similar logic to sales for updating accumulators.
   - **Adjustments (Justering):**  
     - Code block is disabled (`if 1=2`), indicating that adjustments are currently not processed.
   - **Receipts (Inngang):**  
     - Default for `vhsyst = 'L'` (logistics/warehouse system).
     - Quantities are added/subtracted from accumulators based on the type.
   - **Inventory Count Transactions:**  
     - Records with `vhsyst = 'L'` and `vhkode = 'T '` are skipped (not included in movement calculations).

4. **Loop Control:**  
   - After processing each record, the program branches to the label `les_lagbok` to read the next record.

### Finalization

- At the end of processing:
  - The accumulators are written back to the parameter structure.
  - The entire parameter block (`w_parm`) is updated for the caller.
  - The program ends with LR indicator set.

---

## Notable Design Decisions & Conventions

- **Parameter Passing:**  
  - Uses a single overlayed data structure for input and output, allowing flexible and extensible parameter passing between programs.
- **File Access:**  
  - Uses keyed access with partial and full keys for efficient record selection.
- **Movement Logic:**  
  - Movement types and their classification are domain-specific:
    - `vhsyst` differentiates between sales and warehouse transactions.
    - `vhkode` and `vhtype` further classify the movement (sales, withdrawals, adjustments, receipts).
- **Disabled Code:**  
  - The adjustment logic is currently disabled, possibly pending future implementation or business decision.
- **Skipping Inventory Counts:**  
  - Inventory count transactions are deliberately excluded from the movement calculation.

---

## External Interactions

- **Caller Program:**  
  - This program is designed to be called by another program, which provides the parameter block and expects the results in the same structure.
- **VHISLR File:**  
  - Central data source for historical inventory movements.
- **Local Data Area (LDA):**  
  - Used for firm and user context.

---

## Key Points for New Developers

- **Movement Calculations:**  
  - Ensure you understand the business rules for each movement type and their impact on accumulators.
- **Parameter Structure:**  
  - When modifying or extending, update both the data structure and any related overlays in other programs.
- **Data Integrity:**  
  - The program assumes that input parameters (especially dates and keys) are valid and consistent.
- **Error Handling:**  
  - There is minimal error handling; validation is expected to be performed by the caller.

---

## Potential Enhancements

- **Enable Adjustments:**  
  - Review and enable the adjustment logic if/when business rules are clarified.
- **Error Handling:**  
  - Add validation for input parameters and handle unexpected file conditions.
- **Refactoring:**  
  - Consider refactoring to free-format RPG for improved readability and maintainability.

---

## Summary

The LA965R program is a core utility for summarizing inventory movements. It is tightly coupled to the business logic of the warehouse ledger and is designed for performance and interoperability with other system modules. Understanding the domain-specific movement codes and the parameter structure is essential for effective maintenance and enhancement of this component.