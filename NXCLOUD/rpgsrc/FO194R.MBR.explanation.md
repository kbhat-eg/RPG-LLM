# Overview

This RPG program, **FO194R**, is designed for invoice processing ("fakturabehandling"), specifically to generate a converted ClearPark invoice format for Europay/VISA payment card common format. It is written in traditional fixed-format ILE RPG, and contains routines for reading transaction data, generating invoice headers and lines, VAT calculations, updating records, and managing output.

## Sections of the Program

### 1. Header and Documentation
- `h option(*nodebugio) datedit(*ymd)`
  - Compiler option: disables debugging for I/O, uses YMD date format.
- Program metadata (name, description, version history, change log).

### 2. File Declarations (`F-specs`)
- Input files (`I`): Transaction, agreement, customer, order header/lines, etc.
- Output file (`O`): `ffncppf`, for writing final invoice records.
- Update file (`U`): For updating transaction records.

All files are keyed and external, and many use the `rename` keyword to map physical file names to program-level record formats.

### 3. Data and Working Variables (`D-specs`)
- **Data structure overlays**: Used for parameter passing, e.g. `d_parm` and its overlays for specific parameter fields.
- **Work fields**: For accumulating values, holding formatted strings, amounts, etc.
- **Record buffers**: To hold output record data.
- **Keys for file access**: Variables defined with `like()` based on file fields for constructing keys.
- Constants for output formatting (`c_fsep`, `c_fquo`, etc.).

### 4. Mainline Logic (`C-specs`)
#### 4.1. Initialization
- Reads issuer data (company info) from the `afirl1` file.
- Parses program parameters, determining if it's running in "batch" (`b_omkj` indicator).
- Calls `sett_binr` subroutine if not batch.

#### 4.2. Processing Loop (Main Work)
- Sets up read loop over transaction records (`fntrl3` file).
- For each transaction, filters:
  - Only "VISA" or "Europay" transactions (`fnkftp=1 or 2`).
  - Skips already processed (`fnjour` and `fnkdat` checks).
  - Requires attached invoice number (`fnbinr`).
- For each valid transaction, finds the customer agreement (`fmkal1r`), then the order (`sohel1r`), and processes:
  - Generates invoice header (`fakt_hode` subroutine).
  - Generates all invoice lines (`fakt_vlin` subroutine).
  - Updates transaction as processed (`oppd_trans` subroutine).

#### 4.3. Finish
- On completion, turns on LR (`*inlr`) and returns.

### 5. Subroutines
#### 5.1. fakt_hode
- Builds up the invoice header as a CSV-style line, quoting and separating fields.
- Fields include record type, empty reserved fields, invoice/card numbers, expiration date, invoice sum, VAT, customer reference, address fields, dates, and so on.
- Calls `finn_tbel` to sum VAT, line count, etc. for the invoice.
- Calls `sjekk_minus` to ensure consistent minus sign formatting on amounts.
- Calls `write_outp` to write the record to the output file.

#### 5.2. fakt_vlin
- For each invoice line (read from `sodtl1`), builds the detail line for the invoice:
  - Product code, description, quantity, price, unit, VAT, discounts, cost centers, line totals, etc.
- Makes a program call (`CALL 'RS755R'`) to calculate VAT via an external system.
- Skips lines of certain types (if `valktx=1`).
- Calls `sjekk_minus` for amount formatting and `write_outp` per line.

#### 5.3. sjekk_minus
- Ensures numbers have the minus sign in the leading position if negative; removes any minus sign otherwise (some edit masks put minus at the end).
- Called before output of any amount fields.

#### 5.4. write_outp
- Writes the built output line to `ffncppf`.
- Also replaces Nordic letters (`ÆØÅ` etc.) with specified hex code points, likely for downstream system compatibility.

#### 5.5. finn_tbel
- Scans all order lines for the current invoice.
- Totals VAT and discounts, counts number of lines.
- Uses same VAT calculation program call as in `fakt_vlin`.

#### 5.6. oppd_trans
- Updates the transaction record (processed) with date/time stamps and marks as handled.

#### 5.7. sett_binr
- For all transaction records, ensures that the invoice number is populated from matching order header records, if not already present.

#### 5.8. *inzsr (Initialization) and *entry Parameter List
- Maps incoming parameters into data structures and sets up keys for file access.

### 6. Key Lists (`klist`)
- Several klist blocks define keys for file access used with CHAIN, SETLL, READE, etc., matching company, customer, invoice, etc.

## Key Details: "How does it work?"

1. **Parameter Input**: Receives parameters describing what range of transactions to process, etc.
2. **Preparatory Step**: Optionally ensures all relevant transactions have attached invoice numbers.
3. **Main Loop**: For each transaction, validates and locates the customer's invoice header.
4. **Header Generation**: Assembles the required conversion format for the invoice header (CSV-like, with specific fields).
5. **Line Generation**: For each order line, assembles a line record with full commercial/VAT breakdown.
6. **Output**: Each record (header or line) is written to the output file, with proper formatting and character translation.
7. **Transaction Update**: Marks processed transactions to prevent reprocessing.
8. **Completion**: Ends cleanly.

## Special Features & Considerations

- **International Character Handling**: The program translates Norwegian characters to specific code points for output.
- **Flexible Parameterization**: Through parameter overlays and batch/online options.
- **External VAT Calculation**: Calls an external program to get correct VAT for each order line/header.
- **Invoice Line Range Selection**: Able to process a selected range or all transactions, depending on parameters.
- **CSV-like Output Layout**: Uses constants for comma and quote, builds up output records field by field.
- **Error and Special Case Handling**: Skips previously processed or ineligible transactions.

## Typical Use Case

This program is typically called from a controlling program (possibly by a job scheduler or user interface), passing in the selection parameters. It reads through the relevant transactions, produces output for the payment card system, and marks processed records, ensuring each transaction is only handled once per run.

---

### Summary Table

| Section             | Purpose                                                              |
|---------------------|----------------------------------------------------------------------|
| Program header      | Metadata, version, documentation                                     |
| F-specs             | File definitions, I/O setup                                          |
| D-specs             | Data structures, work fields, output records, keys                  |
| Main logic          | Orchestration: read, process, generate output, update transactions   |
| fakt_hode           | Generate invoice header output                                       |
| fakt_vlin           | Generate invoice line(s) output                                      |
| sjekk_minus         | Clean up formatting of amounts                                       |
| write_outp          | Write converted, formatted output and handle character translation   |
| finn_tbel           | Summing VAT, discounts, line count                                   |
| oppd_trans          | Mark transaction as processed                                        |
| sett_binr           | Ensure invoice numbers attached to transactions                      |
| *inzsr / *entry     | Initialize, map input parameters, set up keys                       |
| klist blocks        | Define file access keys                                              |

---

## Onboarding Tips

- **Understand the data model**: Each file (physical or logical) represents part of the invoicing process (transactions, agreements, orders, etc.). The logic ties these together with keyed access.
- **Trace a transaction**: Step through how a single transaction is read, validated, matched to an invoice, output, and updated.
- **Learn the subroutine structure**: Main processing is orchestrated with subroutines (`begsr`/`endsr`), each with a clear, single responsibility.
- **Be aware of parameter mapping**: The program overlays parameters onto a structure, so parameter positions in the input are important.
- **Watch for external program calls**: VAT calculations are delegated out, so ensure "RS755R" is available and well understood.

---

**In summary:**  
This program takes payment card transaction data, generates converted invoice records in a specific format for downstream systems, handles VAT and discount breakdowns, marks data as processed, and ensures character set compatibility. It is a good example of batch RPG processing focused on financial document generation.