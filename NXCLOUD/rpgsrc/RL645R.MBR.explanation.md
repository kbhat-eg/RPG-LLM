# RPG Program RL645R – Overview and Explanation

This program is for **printing a supplier ledger report** ("utskrift av reskontroliste leverandør") with parameter selection and validation. It is classic ILE RPG (RPG IV in fixed-form), running interactive (uses WORKSTN display file), and is based on Norwegian terminology.

---

## 1. **Header Section**

* **Purpose**: Print list of accounts payable (supplier ledger) report, with parameters.
* **Version history**: Contains change log (with Norwegian comments).
* **Indikator usage**: Documents usage of RPG indicators. For example: `KA = F1`, `KC = F3`, `LR = End program`, etc.

---

## 2. **File Declarations**

```rpg
fausrl1    if   e           k disk
frl645d    cf   e             workstn
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
```
* `ausrl1` and `rlevl1` are physical files for user and supplier master data.
* `rl645d` is a display (*WORKSTN*) file for interactive UI.
* `rename()` is used for record format mapping.

---

## 3. **Data Declarations**

* Various variables for fields, status, parameters.
* Variables such as `n`, `s`, `waar` (year), `wlev` (supplier), `wmnd` (month).
* Parameter fields: `p_in03`, `p_stat`, etc.
* Working user/company variables: `w_firm`, `w_user`, etc.
* `rlevl1_levr`: used for supplier key.

---

## 4. **Copybook Include**

```rpg
d/COPY QCPYLESRC,RPARRKDS
```
* Imports parameter data structures, field definitions.

---

## 5. **Main Processing Flow**

### **Initialization (`*INZSR` subroutine)**
* Loads initial values into parameter fields using system and user profile data:
  - Sets company, user, field limits.
  - Sets default values for period/year (current month/year). 
  - If user is restricted to a department, sets that into selection (`a2pavf`, `a2pavt`).
  - Initializes parameter field list, user key, supplier key.

---

### **Main Parameter Screen Loop (`A2BLD`/`a2taga` tag)**

* **Displays parameter selection screen** (`exfmt a2bld`).
* **Clears message/indicator flags** (*in31–*in48).
* **Exit handling**: If F3 (`*inkc`) pressed, set status and return.
* **Inquiry handling**: If F4 (`*inkd`) pressed, call subroutine `spr_rut` for lookup/inquiry.
* **Field Validation**:
  - **Date validity**: Checks if run date is valid, uses system date if not.
  - **Period/Year Checks**: 
    - Checks for valid year, period ranges (from/to), not zero, not in future, etc.
    - Ensures "from" <= "to" for periods, supplier numbers, categories, departments, etc.
    - Sets message and position indicators if errors (e.g., `*in37`, `*in38`, `*in39`).
* **Supplier Validation**:
  - Gathers up to 10 specific supplier numbers; for each, validates existence in master file (`chain`).
* **Option Validations**:
  - Validates flags/selection fields: currency (`a2pval`), category (`a2pktg`), department (`a2pavd`), sorting (`a2palf`).
  - Only 'J' (yes) or blank is allowed for these fields.
  - Only one summing option can be set at a time (category or department) – checked by summing an `s` counter.

---

### **Parameter Assignment**

* If all checks pass, moves all screen fields to parameter fields (`move a2pkda pdato`, etc.).

---

### **End Program (`xslutt` tag)**

* Sets `*INLR` (last record indicator) to end the job and `return`.

---

## 6. **Subroutines**

### **spr_rut (Inquiry Subroutine)**

* Handles lookup for department/category/supplier fields via F4.
* For each field (distinguished by `w_afld`), sets up codes/parameters and makes a `CALL` to the relevant inquiry program:
  - `RA507R`: department
  - `RA514R`: supplier category
  - `RL500R`: supplier number
* Calls use company, field, and return variable for description.
* Updates the parameter field with result and sets indicators to show the field was updated.

---

### **Initialization Subroutine (`*INZSR`)**

* Loads current user/firm into working variables.
* Sets all field ranges to defaults.
* Sets current period and year based on the system date.
* Looks up user record in `ausrl1` to see if there are any restrictions.
* Sets up entry parameter list for external calls.

---

## 7. **Other Notable Details**

* **Use of Indicators**: Heavily uses RPG indicators (*inXX) for screen field highlighting, error position, error messages.
* **Screen Flow**: The code returns to the screen (`goto a2taga`) after any failed validation so the user can correct mistakes.
* **Support for Extensive Field Lookups**: Provides F4 lookup for all key value fields, with dedicated indicator management for field highlighting.

---

## 8. **Typical User Flow**

1. User runs the program.
2. Program initializes period/year and field defaults.
3. User is presented with a parameter entry screen.
4. User can:
   - Enter parameter values.
   - Hit F4 to inquire for valid values (department/category/supplier).
   - Hit F3 to exit.
5. Program validates all entries, highlights errors, and returns to screen for correction if needed.
6. If all fields are valid, fields are saved to parameter variables.
7. Program ends (or passes parameters to next stage/report).

---

## 9. **Key Norwegian Terms**

- **Leverandør**: Supplier
- **Periode**: Period (month)
- **År**: Year
- **Avdeling**: Department
- **Kategori**: Category
- **Fra/Til**: From/To
- **Summenivå**: Summing level (summarization by category/department)
- **Utskrift**: Print/output
- **Reskontro**: Supplier ledger

---

## 10. **Summary Table**

| Area                | Description                                                        |
|---------------------|--------------------------------------------------------------------|
| Main Function       | Collect/validate user parameters for supplier ledger printout       |
| User Interface      | Interactive (D-Spec WORKSTN screen)                                |
| Field Validation    | Many checks on year, period, department, category, suppliers       |
| Lookup Support      | F4 calls to 'helper' programs for value validation                 |
| Error Handling      | Field-specific indicator flags and message highlights              |
| Initialization      | Defaults current period/year, user/firm, ranges                   |
| Supplier Handling   | Individual and range-based supplier selection, up to 10 suppliers  |
| Exit/Cancel         | F3 exits, *INLR set at end                                         |

---

## 11. **Key Points for New Developers**

- **Understand RPG indicators**: These control field display, validation feedback, and screen behavior.
- **Screen-driven**: Program logic is structured around a parameter screen loop, very common in legacy RPG.
- **Validation** is performed before "accepting" data, and feedback is immediate (error indicators).
- **Many routines and calls** are for value lookups, which may reference other RPG programs (RA507R, etc).
- **Code relies on external data structures**, especially from the included copybook.

---

This program is a template for how classical RPG does interactive data entry/validation for producing parameter-driven reports, especially in financial modules (AP/GL). Understanding this structure will help developers maintain similar RPG applications.