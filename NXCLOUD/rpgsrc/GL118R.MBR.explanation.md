# Comprehensive Documentation: Program GL118R (ASOKON)

## Overview

**Program:** GL118R  
**System:** ASOKON  
**Description:**  
This program is responsible for the processing and management of return files (returfiler), specifically handling Telegiro, OCR, and Inkasso returns. It provides the user with the ability to select, update, delete, and view batches of returns, as well as manage their status for further accounting processing.

The program is highly interactive, utilizing subfiles and windows for user interaction, and supports both legacy and SEPA (Single Euro Payments Area) formats. It coordinates with several database files and external programs for data retrieval, validation, and updates.

---

## Business Context

- **Return Files (Returfiler):** In the Norwegian banking/payment context, return files contain records of transactions that have been rejected or require special handling (e.g., failed direct debits, OCR payments, collection/Inkasso cases).
- **Telegiro/OCR/Inkasso:** These are different types of payment/return transactions:
  - **Telegiro:** Bank-based batch payment system.
  - **OCR:** Optical Character Recognition, used for automated payment reconciliation.
  - **Inkasso:** Debt collection returns.

---

## Key Functionalities

### 1. Subfile Management

The program uses three subfiles:
- **Subfile 1 (B1SFL):** Main batch selection and update screen.
- **Subfile 2 (C1SFL):** Detailed view of a selected batch ("raw dump").
- **Subfile 3 (D1WSF):** Window for updating selected batches.

Each subfile has associated control records and window overlays for additional actions and confirmations.

### 2. Batch Selection and Processing

- **Selection:** Users can select batches for update, deletion, or detailed view. Selections are tracked in arrays for further processing.
- **Update:** Selected batches are processed according to their type (Telegiro, OCR, Inkasso, SEPA). Processing may involve moving records to other files, updating status fields, or calling external programs for further accounting actions.
- **Deletion:** Users can delete batches, with confirmation dialogs to prevent accidental deletions.

### 3. Accounting Integration

- **Regnskap (Accounting):** Batches that require further accounting updates are flagged and processed accordingly. The system ensures that no double updates occur (e.g., for OCR returns).

### 4. SEPA and Legacy Format Handling

- **SEPA:** The program detects if all selected batches are SEPA and adjusts validation and processing logic accordingly.
- **Legacy:** For non-SEPA (legacy) formats, stricter validation and additional processing steps are enforced.

### 5. Data Integrity and Control

- **Unique Member Naming:** Member names for accounting files are generated uniquely to prevent conflicts.
- **Locking/Sperrefil:** The system checks for concurrent processing to avoid data corruption.
- **History:** Old history records are periodically purged.

---

## File and Program Interactions

### Database Files

- **GATRPF/GATRL1/GATRLU:** Agreement register and return transaction files (primary source of return data).
- **GAVTL2:** Agreement master, used to resolve account numbers for a given file group and company.
- **GBTRPF:** Copy file for batch archiving and history.
- **GTRTPF/GORTPF/RCNRPF:** Target files for updated Telegiro, OCR, and Inkasso returns, respectively.
- **GUBFLU/GUBFL8:** Payment proposal files, used for SEPA processing.
- **RLEVL1/RLTRLU:** Vendor and vendor transaction files, used for updating return status in SEPA context.
- **GUR2PF:** Used for 2nd round SEPA returns.

### External Programs

- **GL110C, GL115C, GL126C, GL127C, GL208R, GL210R, GL228R, GL229R, GL888C, RF120C, RF1JOURN, RF1VALJO, RF1VALKO, RC120C, AA031R, RJ001R:**  
  These are called for various specialized tasks such as:
  - Printing receipts and control lists.
  - Accounting updates.
  - Return validation and history management.
  - Locking and concurrent job control.
  - User notification and display.

---

## Notable Design Decisions and Patterns

### Indicator Usage

- The program uses RPG indicators extensively for user interface state, file I/O, and internal logic.
- Indicators are carefully mapped and documented for each subfile and window, supporting roll, display, clear, end, readc, and error states.

### Data Structure Overlays

- Overlays are used to reinterpret raw record buffers for different record types (BETFOR01, BETFOR04, etc.), enabling flexible field access and updates without redundant code.

### Subfile Paging and Navigation

- Each subfile uses its own set of page, record, and navigation variables (e.g., `srrn01`, `spge01`), supporting efficient paging and user experience.

### Modular Subroutines

- Key logic is encapsulated in subroutines for clarity and reuse:
  - `xclrNN` (clear subfile)
  - `xcrtNN` (create/fill subfile)
  - `xdspNN` (display subfile)
  - `xoppd` (update processing)
  - `xslett` (delete batch)
  - `xcopy` (copy batch for history)
  - `xoverf` (overlay record for update)
  - `skriv_gur2` (write to GUR2PF for SEPA 2nd returns)

### SEPA and Legacy Format Branching

- The code distinguishes between SEPA and legacy formats, skipping or enforcing certain validations and processing steps as appropriate.

### User Interaction Flow

- The program is highly interactive, using tags and labels for stateful navigation between actions, subfile views, and confirmation dialogs.
- Function keys (F3, F5, F12, F9, etc.) are mapped to specific actions and are consistently handled.

---

## Domain-Specific Logic

### Account Number Selection

- The system prefers bankgiro number (`GCBGIR`) if present, otherwise falls back to postgiro (`GCPGIR`).
- As of change 19011, the "sonekontonummer" (`GCSKTO`) from master data is now used instead of bankgiro for certain operations.

### Batch Copy and History

- Before updating or deleting batches, a copy is made to GBTRPF for traceability and possible rollback.
- Batches older than three months in GBTRPF are purged to maintain performance and storage constraints.

### Double Update Prevention

- The system ensures that no batch is updated twice, especially for OCR returns, by checking the teller field (`GBTELL`).

### SEPA Return Parsing

- For SEPA returns, the code parses XML-like structures to extract payment references, statuses, line numbers, and due dates.
- Processing logic updates both payment proposals and vendor transactions as needed.

---

## Error Handling and User Feedback

- The program provides specific windows and messages for warnings, errors, and confirmations.
- It checks for already processed returns, concurrent jobs, and invalid accounting periods, providing feedback and preventing incorrect actions.

---

## Versioning and Change History

- Extensive in-code change history documents all significant changes, including business rule adjustments, data structure changes, new format support, and user interface improvements.
- Each change is tagged with a date, description, and author initials.

---

## Summary of Key Flows

### Batch Update Flow
1. User selects batches for update in Subfile 1.
2. Selected batches are validated (type, double update, etc.).
3. For each batch:
   - Copied to history (GBTRPF).
   - Moved to the appropriate target file (GTRTPF, GORTPF, RCNRPF) based on type.
   - Source records in GATRPF are deleted.
   - For SEPA, payment proposals and vendor transactions are updated.
4. If accounting is required, external programs are called for further processing.

### Batch Deletion Flow
1. User selects batch for deletion (`b1valg = '4'`).
2. Confirmation window is displayed.
3. If confirmed, all records for the batch are deleted from GATRPF.

### Viewing and Navigation
- Users can page through subfiles, view details, and toggle between updated and non-updated returns using function keys.

---

## Conventions and Best Practices

- **Indicator Mapping:** Consistent use and documentation of indicators for UI and file operations.
- **Data Structure Overlays:** Efficient use of overlays for flexible record handling.
- **Subroutine Encapsulation:** Modular, reusable subroutines for key logic.
- **Comprehensive Inline Documentation:** All business rules, file layouts, and user interactions are documented in the code.
- **Change Management:** All changes are logged with context, rationale, and impact.

---

## Onboarding Notes

- **Business Logic:** Familiarize yourself with Norwegian payment/return processing, especially Telegiro, OCR, and SEPA flows.
- **File Layouts:** Study the physical and logical file layouts, as overlays and field positions are critical.
- **External Program APIs:** Understand the contract and expected parameters for all called programs.
- **User Interaction:** Review the screen layouts and subfile navigation patterns, as user experience is central to this program.
- **SEPA Support:** Pay special attention to the SEPA-specific branches, as these involve string parsing and XML-like data extraction.

---

## References

- **GL109R:** Generates data for GATRPF.
- **GL126C/GL127C:** Handles accounting member checks and deletions.
- **GL210R:** Checks for previously processed TF2 returns.
- **GL888C:** Ensures unique member naming.
- **RF120C, RC120C:** Handles accounting updates for OCR and Inkasso.
- **GAVTL2:** Master file for account number resolution.
- **GBTRPF:** Batch copy/history file.

---

## Final Notes

This program is a central part of the ASOKON systemâ€™s return file management. It is critical for maintaining data integrity, ensuring correct accounting, and providing a robust user experience for handling complex payment return scenarios. The codebase reflects decades of business logic evolution and must be approached with an understanding of both the technical and business domains.