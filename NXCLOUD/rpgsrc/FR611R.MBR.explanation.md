# RPG Program Documentation: FR611R (Rabattmatrise, kundebrev - utplukk)

## Purpose and Business Context

This program (`FR611R`) is part of a pricing and discount system, specifically handling the extraction and processing of customer-specific price and discount data for the generation of customer letters. The main business purpose is to collect all relevant price agreements and discount matrix information for customers (and customer projects), enrich this data with additional attributes (such as product group, supplier, module, etc.), and prepare it for further processing—typically, the generation of personalized customer letters (`kundebrev`).

The program is heavily parameter-driven and supports various extraction criteria, such as by discount category (`rabattkategori`), customer, or customer project. It also supports filtering by product assortment and price group, and handles both direct customer agreements and project-based agreements.

## High-Level Structure

1. **Initialization**: Receives parameters, initializes keys and working variables.
2. **Data Extraction**: 
   - Extracts special prices and discount matrix entries, copying them to working files with additional information.
3. **Selection Logic**: 
   - Determines extraction strategy based on input parameters (discount category, customer, etc.).
4. **Customer Letter Generation**: 
   - Calls a separate program (`FR612R`) to generate customer letters based on the extracted data.
5. **Subroutines**: 
   - For data enrichment, filtering, and key management.

## File Relationships

- **Input Files**: 
  - `fpril1`, `frabl1`, `frkunl1`, `fkprl1`, `vvarl1`, `vsdtl1`, `vsdtl6`, `vvlel1`
    - Price lists, discount matrix, customer master, customer project master, product master, assortment lines.
- **Work Files**: 
  - `fprwlu`, `ffrawlu`
    - Temporary/working files for further processing.
- **External Programs**:
  - `FR612R`: Generates customer letters.
  - `VL710R`: Retrieves product type and related master data.
  - `VL712R`: Retrieves price group from customer warehouse.

## Parameter and Data Structures

- **Parameter List (`d_list`)**: 
  - Contains firm, discount category, customer, project, assortment, date, text fields, selection value, and price group.
- **Working Variables**: 
  - Used for key construction, filtering, and data enrichment.

## Main Processing Flow

### 1. Initialization (`*inzsr`)

- Reads incoming parameter structure into local variables.
- Sets up key lists for all file access patterns.

### 2. Extraction of Special Prices (`priser` Subroutine)

- Reads all special price entries from `fpril1`.
- Applies filters:
  - **Price Group**: If specified, only matching entries are processed.
  - **Assortment**: If specified, checks if the agreement is part of the selected assortment using the `sortiment` subroutine.
  - **Product Type**: Only warehouse-managed items (`'L'`) are included.
- Enriches each entry with:
  - Discount category and customer category (from customer or customer project records).
  - Product description (from product master).
- Writes enriched records to the working file (`fprwlu`).

### 3. Extraction of Discount Matrix (`rabatter` Subroutine)

- Reads all discount matrix entries from `frabl1`.
- Applies similar filters as in `priser`.
- For each entry:
  - Retrieves and enriches with discount/customer category, product group, supplier, module, and product description.
  - Handles both customer and project-specific agreements.
  - Writes to the working file (`ffrawlu`).

### 4. Selection and Output Logic

- Based on the parameters:
  - **Discount Category (`d_rkat`)**: Calls `utpl_rkat` to process all customers/projects in the category.
  - **Customer Only (`d_kund`)**: Calls `utpl_kund` to process all agreements for the customer and its projects.
  - **Customer and Project (`d_kund` and `d_kpro`)**: Calls `kundebrev` for the specific customer/project.
- Each path eventually leads to the generation of customer letters via `FR612R`.

### 5. Assortment Filtering (`sortiment` Subroutine)

- Determines whether a product (or agreement) is part of the selected assortment.
- Looks up the product in the assortment line files, considering warehouse and product hierarchy.
- Uses a "most specific to least specific" fallback search pattern (by module, group, etc.).
- Only allows processing if the product is found in the assortment.

### 6. Data Enrichment

- **Product Information**: 
  - Uses `VL710R` to retrieve product type and extended product information.
- **Price Group**: 
  - Uses `VL712R` to retrieve the price group for the customer warehouse if applicable.

### 7. Customer Letter Generation (`kundebrev` Subroutine)

- Calls external program `FR612R` with all relevant parameters for letter generation.

## Notable Design Decisions and Conventions

- **Parameter Overlaying**: 
  - Uses a single 256-byte parameter structure with overlays for individual fields, allowing flexible and extensible parameter passing.
- **Key Management**: 
  - All file access is done via well-defined key lists, initialized in the `*inzsr` subroutine.
- **Fallback Logic**: 
  - Assortment and other lookups use fallback strategies (e.g., searching with/without warehouse, with reduced specificity).
- **Data Enrichment**: 
  - Rather than just copying data, the program enriches records with additional attributes for downstream processing.
- **Selective Processing**: 
  - Extensive use of filtering (by price group, assortment, product type) ensures only relevant data is processed and output.
- **Versioning and Change Log**: 
  - The program header contains a detailed change log, reflecting ongoing business requirements and technical enhancements.

## Interactions with Other Modules

- **FR612R**: 
  - Handles the actual generation of customer letters, using the data prepared by this program.
- **VL710R**: 
  - Provides detailed product information, including type and extended attributes.
- **VL712R**: 
  - Retrieves price group information for a customer’s warehouse, supporting price group filtering.

## Business/Domain-Specific Logic

- **Price Group Filtering**: 
  - Many business rules depend on the price group, which can be derived from customer, project, or warehouse context.
- **Assortment Membership**: 
  - Only agreements relevant to the selected assortment are processed, supporting business needs for targeted communication.
- **Customer/Project Hierarchy**: 
  - Both direct customer agreements and project-based agreements are handled, reflecting complex customer relationships.
- **Warehouse-Only Items**: 
  - Only items managed in the warehouse (`'L'`) are included, aligning with business rules for eligible products.

## Summary Table: Key Subroutines

| Subroutine     | Purpose                                                      |
|----------------|-------------------------------------------------------------|
| priser         | Extract/enrich/write special prices to work file            |
| rabatter       | Extract/enrich/write discount matrix to work file           |
| utpl_rkat      | Process all customers/projects in a discount category       |
| utpl_kund      | Process all agreements for a customer and its projects      |
| sortiment      | Check if a product/agreement is in the selected assortment  |
| kundebrev      | Call FR612R to generate a customer letter                   |
| hent_vtyp      | Retrieve product type and info via VL710R                   |
| hent_prisgr    | Retrieve price group via VL712R                             |

## Key Points for New Developers

- **This program is central to the extraction and enrichment of pricing/discount data for customer communication.**
- **It is tightly integrated with other modules for product and customer data enrichment.**
- **Most business rules are implemented via filtering and data enrichment subroutines.**
- **The codebase uses overlays, key lists, and subroutine modularization as standard conventions.**
- **Understanding the relationships between files and the parameter-driven logic is essential for effective maintenance or extension of this program.**

---

**If you need more details on any specific section or subroutine, please ask for a focused explanation.**