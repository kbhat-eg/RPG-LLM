# Explanation of the RPGLE Program for “Prisfil til kunder” (Price File to Customers)

## Overview

This program is designed for IBM i (AS/400) systems, written in ILE RPG (sometimes called RPG IV). Its main purpose is to generate a “price file” for customers in a format ready for EDIFACT PRICAT (Price/Sales Catalogue) conversion. The file aggregates product, customer, and price information from multiple files/tables and outputs it in a flat-file structure according to PRICAT specifications.

The code is heavily commented in Norwegian and includes support for various business logic adaptations over many years, as can be seen from the change log in the header.

---

## High-Level Structure

1. **Declarations**
    - Control options, file specs, data structures, and working variables.
2. **Subroutines**
    - Processing is broken into subroutines (“subrutine”) for modular handling of item, group, and supplier selections, EDIFACT record generation, etc.
3. **Main Program**
    - Initialization and key data retrieval.
    - Selection logic to determine how items should be picked (by group, supplier, assortment, or all).
    - Calls the appropriate processing subroutine based on parameters.
    - Handles end-of-file and updates distribution lists.
    - Writes trailing EDIFACT records and terminates.

---

## Sections in Detail

### 1. File Specifications (`F-Specs`)

- Many logical and physical files are opened for reading (`IF`) and, for the price file, writing (`UF`).
- Files are renamed using the `RENAME` keyword so the program’s view of the file matches what’s expected in the source code.
- Example:
  ```rpg
  ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
  ```
  This line opens the file `fstspfr` and renames its record format as `fstsl1r`.

---

### 2. Data Structures (`D-Specs`)

- **Parameter Structures for Subprogram Calls**
    - `hirec`: Parameters sent *to* the price calculation program (`VP900R`).
    - `horec`: Parameters returned *from* `VP900R`.
- **EDIFACT Record Structures**
    - Several data structures such as `d_pfms`, `d_p00F`, `d_p020`, etc., each corresponding to a specific “posttype” (record type in the EDIFACT PRICAT export).
    - Fields are overlaid at byte positions, reflecting the precise flat file layout required for EDIFACT.
- **Working Variables**
    - For temporary data, looping counters, record keys, and various buffer fields.
- **Key Variables**
    - Used to build record keys for database lookups with `CHAIN`, `SETLL`, or `READE` operations.

---

### 3. Main Program Flow

#### a. Initialization

- Reads firm, OFAK (system status), and customer information.
- Converts special Norwegian characters (æ, ø, å) to ANSI codes for file output.
- Retrieves parameter values from the entry point and splits/sets up the initial working variables.
- Calls external programs to get additional info (e.g., price group via `VL711R`).

#### b. Selection Logic

- Decides how to select products based on input parameters:
    - If a product group is specified, process by group.
    - If a supplier is specified, process by supplier.
    - If a product assortment code is given, process by assortment.
    - Otherwise, process the entire product master.
- Calls the corresponding subroutine: `behandl_vgrp`, `behandl_ldor`, `behandl_vsor`, or `behandl_tot`.

#### c. EDIFACT File Output Generation

- After processing, writes the EDIFACT posttypes 900 (file tail) and 999 (transmission end).
- The variable `pr_rad` is set to the data structure for each record, then written to the output file `fiprpfr`.

#### d. Distribution List Update

- Updates the distribution list with the latest sent date for the customer and project.

#### e. Program Termination

- Sets the LR (last record indicator) and returns.

---

### 4. Item Selection Subroutines

- **`behandl_vgrp`**: Loops through items by group/subgroup/supplier, calls the main processing routine for each.
- **`behandl_ldor`**: Processes items by supplier.
- **`behandl_vsor`**: Calls another RPG program (`VD700R`) to generate a selection file, then processes all items in the assortment.
- **`behandl_tot`**: Processes all items in the item master.

Each of these subroutines reads the appropriate records and passes them to `behandling` (item processing/output) subroutine.

---

### 5. The `behandling` Subroutine

This subroutine is the heart of the EDIFACT file output logic. For each product, it:

1. **Screening (Business Rules)**
    - Excludes miscellaneous items, special order items (unless requested), and items marked as “not for price distribution”.

2. **Data Collection**
    - Calls external programs to get additional info (product type, NOBB code, etc.).
    - Retrieves text descriptions, undergroup info, unit conversion factors, etc.
    - Prepares input parameters for the price program and calls it.

3. **Writes EDIFACT Posttypes for Item**
    - For each “item”, writes multiple “posttype” records, each representing part of the required EDIFACT PRICAT structure:
        - 040: Item header
        - 045: Additional info
        - 050, 052, 055, 060, 062, 065, 070, 080, 090: Various details about the item, pricing, packaging, discounts, VAT.
    - Each record is built by filling its corresponding data structure, then copying to the output field and writing.

4. **Unit and VAT Lookups**
    - Handles unit lookup logic using subroutine `enheter`.
    - VAT information is retrieved by calling `RS755R`.

5. **Handles Repeats and Optional Sections**
    - Some sections are currently not active (commented out).
    - Loops for repeating records (e.g., multiple descriptions) are handled with counters but may have max=1 in practice.

---

### 6. The `enheter` Subroutine

- Looks up up to 3 units for the product:
    - First tries "prisbok" units.
    - If not found, tries "sales units".
- Populates working variables with unit codes and conversion factors.

---

### 7. The `skriv_init` Subroutine

- Writes initial posttypes to the EDIFACT file:
    - FMS: Start of transmission.
    - 00F: Start of message.
    - 020: Catalogue header part 1.
    - 036: Group header.
    - 038: Supplier info, etc.
- Sets initialization flags and counters.

---

### 8. Keylists

- RPG keylists are defined for read/setll/reade/chain operations on all major files.
- Support different key orders depending on the subroutine.
- Keeps database access tightly controlled and explicit for performance and logic control.

---

### 9. Parameter Handling

- The program receives a large number of parameters (customer, project, assortment selection, date, flags for filtering, etc.) via its *ENTRY PLIST.

---

## Notable Business Logic

- **Special Character Translation**: Special Norwegian letters are translated to specific code points for EDIFACT compatibility.
- **EDIFACT PRICAT Structure**: The flat file output is meticulously structured, with each record type reflecting part of the PRICAT standard. Complex overlays in data structures match the precise file layout required.
- **Price Calculation**: Dedicated subprograms (like `VP900R`) handle complex price calculation, including group discounts and VAT using external logic, keeping the main program focused on orchestration and data assembly.

---

## General Best Practices

- **External Program Calls**: Business calculations and selection logic are often offloaded to other dedicated programs, allowing for separation of concerns and easier maintenance.
- **Extensive Comments**: The code includes detailed comments (in Norwegian) for every major operation, making maintenance and onboarding easier.
- **Modularization**: Extensive use of subroutines allows for clear separation and reuse of logic.

---

## Conclusion

This program is a central component for generating customer price catalogues in EDIFACT format, integrating data from many sources, with configurable selection/filtering and output logic. It demonstrates classic, robust, mainframe-style RPG programming: business rules are strictly enforced, data is processed and assembled stepwise, and output is formatted with exacting attention to downstream (EDI/EDIFACT) requirements.

---

**Onboarding Guidance:**  
When onboarding to this program:

- Familiarize yourself with the PRICAT/EDIFACT format, as the record structures (posttyper) are the blueprint for the output.
- Understand the external programs called for business logic (e.g., VP900R, RS755R, VL710R).
- Recognize the file structure and key use throughout the code—it’s central to understanding how items are selected and processed.
- Refer to the comments for business rules and logic references.
- When modifying, be mindful of the tight coupling between the file structure and the output format, especially overlays in data structures.

**If you need more clarification about a specific subroutine or section, ask about it directly!**