# Program SR132R – Vendor Range Selection for Parameter File

## Overview

This RPG program (SR132R) is part of the "ASSTAT" system and is designed to manage selection criteria for vendor ranges in a parameter file. It allows users to define, store, and update "from/to" vendor number ranges, typically for use in subsequent reporting or processing modules. The program interacts with workstation display files and two database files, and provides integration to a vendor inquiry program for assisted selection.

---

## Key Business Logic

- **Purpose:**  
  Users define up to 10 "from" and "to" vendor number pairs. These ranges are stored in and retrieved from a parameter file, enabling other processes to use these criteria for data selection or filtering.

- **Files Involved:**  
  - `SR132d` (Workstation display file): Handles screen interactions.
  - `slpml1` (Input, keyed): Holds the main parameter file records.
  - `slpmlu` (Update, keyed): Used for updating or deleting parameter file records.

- **External Program Call:**  
  - `RL500R`: Invoked for vendor lookups, allowing the user to search and select a vendor number.

---

## File Definitions and Data Structures

- **File Renaming:**  
  Both `slpml1` and `slpmlu` are referenced via a renamed record format (`slpmpfr` as `slpml1r` and `slpmlur`), reflecting a convention in this codebase to avoid naming collisions and clarify usage context.

- **Work Fields:**  
  - `b2fle1` ... `b2fle10`: "From" vendor numbers (screen fields).
  - `b2tle1` ... `b2tle10`: "To" vendor numbers (screen fields).
  - `wwflen`, `wwtlen`: Arrays (10 elements each) for "from" and "to" values in working storage.
  - `wwrest`: Data structure for storing the entire parameter record (330 bytes).
  - `wwvalg`: Filler structure (purpose: key composition).
  - `ww_sjekk_array`, `ww_sjekk_flen`, `ww_sjekk_tlen`: Used for comparing and checking if the arrays are empty.

- **User/firm Info:**  
  - `dsuser`, `dsfirm`, `l_fnav`: User and firm info, possibly passed from a prior program.

---

## Main Program Flow

### 1. Initialization (`*inzsr`)

- **Parameter Intake:**  
  Receives `wptype` (type) and `wptext` (description) via the parameter list.
- **Key Setup:**  
  Sets up the key fields (`wwfirm`, `wwtype`, `wwkode`, `wwvalg`) for file access.
- **Firm/Type Assignment:**  
  Initializes working and screen fields with firm and type information.

### 2. Main Loop

#### a. Load Existing Selection

- **CHAIN to `slpml1`** using the composed key.  
  - If found, loads saved vendor ranges into screen fields.
  - If not found, clears all range fields.

#### b. Display and User Interaction

- **EXFMT to workstation display.**  
  - Waits for user input (entry, function keys).

- **Exit Keys:**  
  - If F3 (Exit) or F12 (Cancel) pressed, branch to program end.

- **Inquiry Key (F4):**  
  - Calls subroutine `xspstr` for vendor lookup.
  - If successful, reloads screen.

#### c. Validation

- **Range Consistency:**  
  - For each pair, ensures "from" is not greater than "to".
  - If invalid, redisplays screen for correction.

#### d. Save/Update Parameter File

- **CHAIN to `slpmlu`** with the same key to check for existing record.
- **Copy screen fields to working arrays.**
- **Update or Write Record:**
  - If found and both first "from" and "to" are zero, deletes the record.
  - If found and not empty, updates the record.
  - If not found and at least one "to" value is non-zero, writes a new record.

---

## Subroutines

### Vendor Inquiry (`xspstr`)

- **Purpose:**  
  Handles F4 (inquiry) key. Uses the value of `wactfe` (active field) to determine which field is being inquired.
- **Process:**  
  - Calls `RL500R` (vendor inquiry program) with firm and current vendor number.
  - If a vendor is selected, updates the corresponding "from" or "to" field on the screen.
  - Supports all 10 "from" and 10 "to" fields.

### Initialization (`*inzsr`)

- **Purpose:**  
  Initializes key fields and copies parameter values from the calling program.
- **Key List:**  
  Sets up the composite key for accessing the parameter file.

---

## Data Relationships and Integration

- **Parameter File Records:**  
  Each record in `slpml1`/`slpmlu` is keyed by firm, type, code (fixed as 32), and a filler value. This allows multiple distinct sets of selection criteria to be maintained per firm/type.

- **Vendor Inquiry Integration:**  
  The program calls `RL500R` for vendor selection, supporting interactive lookup and selection from a vendor master file.

---

## Notable Design Decisions and Conventions

- **Key Management:**  
  The use of composite keys (`firm`, `type`, `code`, `valg`) is a standard pattern in this codebase to support multi-tenancy and flexible parameterization.

- **Array Handling:**  
  Vendor ranges are managed as arrays, but mapped to individual screen fields for user interaction. This balances user-friendliness with efficient storage and processing.

- **Zero as "Empty":**  
  A range with both "from" and "to" as zero is treated as empty, and triggers deletion of the parameter record.

- **No Marking of Changed Lines:**  
  Per the header comments, changes for version R5.20 are not marked at line level, but parameter lists have been adjusted for correctness.

---

## Error Handling and User Feedback

- **Range Validation:**  
  The program enforces that "from" is not greater than "to" for each range, prompting the user to correct errors.

- **Vendor Lookup Feedback:**  
  If a vendor is selected via inquiry, the field is updated and the screen is refreshed.

---

## Interactions with Other Modules

- **Upstream:**  
  The program receives firm and type parameters (likely from a menu or controlling program).
- **Downstream:**  
  The saved parameter file records are used by other processes (not shown here), which use these vendor ranges for filtering or reporting.
- **External:**  
  Integration with `RL500R` for vendor inquiry.

---

## Summary Table

| Functionality                | Mechanism/Field                | Notes                                        |
|------------------------------|--------------------------------|----------------------------------------------|
| Load existing selection      | CHAIN to `slpml1`              | Composite key: firm, type, code, valg        |
| Save/update selection        | CHAIN/UPDATE/WRITE to `slpmlu` | Same key as above                            |
| Delete selection             | DELETE from `slpmlu`           | If both first "from" and "to" are zero       |
| Vendor lookup                | CALL to `RL500R`               | For each "from"/"to" field, via F4           |
| Range validation             | IF checks per pair             | Ensures "from" ≤ "to"                        |
| User interaction             | EXFMT to display file          | Handles screen display and input             |

---

## Key Points for New Developers

- The program is a parameter maintenance utility for vendor selection ranges, not a transaction or master file processor.
- All file accesses are keyed and records are uniquely identified per firm/type.
- The design pattern of mapping array elements to individual fields is widely used in this codebase.
- Vendor lookup is delegated to a specialized program, promoting reuse and consistency.
- Error handling and validation are primarily user-facing, with immediate feedback on invalid input.
- Changes in version R5.20 corrected program references and parameter lists, but are not line-marked; consult header comments for context.

---

For further understanding, review the display file (`SR132d`) and the vendor inquiry program (`RL500R`), as these are essential to the user experience and integration.