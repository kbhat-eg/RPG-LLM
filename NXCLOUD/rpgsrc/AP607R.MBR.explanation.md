# Documentation: Program AA609R – Lookup in Routine Register

## Overview

**Program Name:** AA609R  
**Description:** This program performs lookups against PDF parameters, retrieving configuration and property values from a set of register files. These values are used in document processing, such as determining output destinations, email addresses, logo paths, and specific behavioral flags related to document generation (e.g., invoices, packing slips).

The program is built to support business rules that allow for overrides at company and department level, as well as global defaults. It is modular and extensible, with parameters and property lookups driven by data in configuration files.

## Business/Domain Context

- This program is part of a document output subsystem, likely used for generating PDFs for invoices, packing slips, and similar documents.
- It supports customization by company (firm) and department (avdeling).
- Several options (such as email, archiving, XML/JAS paths, logo, and more) are parameterized and can be fetched or overridden via configuration files.
- The program is called with a routine code (`p_ruti`) and a file group (`p_filg`), returning a PDF parameter (`p_pdf`) and a large data structure with output options (`p_pdf_ds`).

## File Relationships

The program interacts with three main physical files:

- **afoppfr (renamed afopl1r):** Routine register, holds default PDF parameter settings per routine.
- **afappfr (renamed afapl1r):** Exception register, holds overrides for PDF parameters at company/department level.
- **afpspfr (renamed afpslrr):** Properties file, holds various property values (paths, flags, etc.) by file group and property key.

## Key Data Structures

- **Input Parameters:**
  - `p_filg` (File Group): Used as a key for property lookups (added in version 7.01).
  - `p_ruti` (Routine Code): The main identifier for the type of document or process.
  - `p_pdf` (PDF Parameter): Output parameter with the PDF type/flag.
  - `p_pdf_ds` (PDF Data Structure): Output parameter, a packed structure with all property values.

- **Work Data Structures:**
  - `d_pdf`: Holds individual PDF property fields (mail, Excel, archive, etc.).
  - `w_pdf_ds`: Holds the final property values to be returned.

## Processing Logic

### 1. Initialization

- The program is parameter-driven and expects its parameters to be passed in a specific order.
- Key lists (`klist`) are defined for record access in the three files.

### 2. PDF Parameter Lookup

**Override Check (Company/Department Level):**
- Attempts to find an override in `afapl1r` using the combination of routine code, firm, and department.
- If found and the PDF flag is set, the program populates the PDF properties from this record.

**Default Lookup (Routine Level):**
- If no override is found, the program looks up the routine in `afopl1r`.
- If found and the PDF flag is set, the program populates the PDF properties from this record.

### 3. Property Lookups

The program then looks up various properties in `afpslrr` using the file group and property key. The keys for these lookups are:

- `XMLPATH`: Path for storing XML files.
- `FIFOFOLDER`: Path for FIFO folder (used for queueing/output).
- `FAKTKOPI`: Flag for whether to print paper copies of invoices.
- `LOGO`: Default logo path (only if not already set by earlier lookups).
- `DFTEMAIL`: Default email address for document recipients.
- `DATAQ`: Flag for whether to use a data queue for output.
- `SIGNPAKK`: Flag for whether to include a signature on packing slips.

All these lookups are performed in a similar pattern:
- The property is initialized to a default value (usually blank or '0').
- The key is set and a chain operation is performed.
- If found, the value from the property file is moved into the corresponding field in the output data structure.

### 4. Output Construction

- The collected properties (`d_xmlm`, `d_jasm`, `d_logo`, `d_emal`, etc.) are assembled into the output data structure (`w_pdf_ds`).
- This structure is returned to the caller via the `p_pdf_ds` parameter.

### 5. Program Termination

- The program sets on the LR indicator (`*inlr`) and returns.

## Notable Design Decisions and Conventions

- **Override Hierarchy:** The system first checks for company/department-level overrides before falling back to global defaults. This supports flexible business requirements.
- **Property File Driven:** Many behavioral flags and paths are not hardcoded but are fetched from a property file, allowing for runtime configurability.
- **Extensibility:** The use of property keys and file groups allows for easy extension of new features or options without changing program logic.
- **Backward Compatibility:** Versioning comments and incremental enhancements are clearly tracked in the source, indicating a stable and evolving codebase.

## Integration Points

- **Interacts with Configuration Files:** The program is tightly coupled to the configuration data in the three mentioned files. Any changes to the structure or content of these files may impact the program’s behavior.
- **Called by Other Programs:** This program is likely called as a service or utility by other programs in the document processing workflow, providing them with the necessary configuration for document output.

## Version History Highlights

- **6.10:** Added support for FIFO folder.
- **6.11:** Added flag for invoice copy printing.
- **6.20:** Added parameter for using Dataq.
- **6.21:** Added parameter for signature on packing slips.
- **7.01:** Fetches file group from parameter, indicating a move towards more granular configuration.

## Summary Table: Key Properties and Their Usage

| Property Key   | Purpose/Usage                                      | Field           | Notes                                   |
|----------------|----------------------------------------------------|-----------------|-----------------------------------------|
| XMLPATH        | Path for storing XML files                         | w_path          | Used for outputting XML documents       |
| FIFOFOLDER     | Path for FIFO folder                               | w_fifo          | Used for queuing/output                 |
| FAKTKOPI       | Print paper invoice copies flag                    | w_kopi          | '0' or value from property file         |
| LOGO           | Default logo path                                  | d_logo          | Only set if not already determined      |
| DFTEMAIL       | Default email address for recipient                | d_emal          |                                         |
| DATAQ          | Use data queue for output flag                     | w_dtaq          | '0' or value from property file         |
| SIGNPAKK       | Signature on packing slips flag                    | w_sign          | '0' or value from property file         |

## Special Notes

- The program uses Norwegian variable and comment naming conventions, reflecting the business domain and likely the user base.
- All lookups are performed via keyed access (`chain`) to indexed files, ensuring efficient retrieval.
- The program is not responsible for actual document generation, only for supplying configuration and property values to downstream processes.

---

**In summary:**  
AA609R is a configuration lookup utility for document output processes, supporting hierarchical overrides and property-driven customization. It is designed for maintainability, extensibility, and integration within a larger document management or ERP system.