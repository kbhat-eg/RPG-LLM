# FP250R – Label Printing from Radio Terminal

## Overview

This program (FP250R) is part of the ASOFAK system and is responsible for facilitating the printing of various types of labels (etiketter) via radio terminals. It primarily handles user input for label type and price code, validates these choices, and determines which print program to call based on the selections. The program interacts with display files, database files, and parameter files, and is designed to be invoked from a menu or another program with parameters.

---

## File Declarations

- **fp250d (WORKSTN)**: Display file for user interaction, likely containing the screens for label and price code selection.
- **vfaspf (DISK, keyed)**: File containing label type and configuration data, used to fetch default values or validate input.
- **param (DISK, output, 128 bytes)**: Parameter file for output, used to pass data to the actual print routines.

---

## Local Data Area

The program uses a User Data Space (UDS) for passing and storing control data:

| Field     | Position | Description                           |
|-----------|----------|---------------------------------------|
| l_etyp    | 111      | Label type (etikettype)               |
| l_etpr    | 112      | Price code (priskode)                 |
| l_ken1    | 113      | Key or flag 1                         |
| l_ken2    | 114      | Key or flag 2                         |
| l_dato    | 115-120  | Date                                  |
| l_sort    | 121      | Sort order                            |
| l_ruti    | 800-809  | Print routine name (program to call)  |
| l_user    | 911-920  | User identifier                       |
| l_firm    | 944-946  | Company code                          |
| l_fnav    | 951-980  | Filename or other name                |

---

## Working Variables

- **wpin03**: 1-char status/return code.
- **w_firm**: 3-digit company code, used for keying into vfaspf.
- **w_dato**: Date variable, system format.
- **w_anta**: Quantity, initialized to 1.
- **p_vare**: 15-char product/item number.

---

## Main Processing Flow

### Initialization (`*INZSR`)

- Sets the current date (`w_dato`).
- Moves the company code from the UDS area to `w_firm`.
- Reads parameters from the entry parameter list (`wpin03`, `p_vare`).
- Initializes `wpin03` to 0 (reset).
- Attempts to fetch label configuration from `vfaspf` using the company code (`w_firm`):
    - If not found, defaults label type (`b1etyp`) to 1.
    - Otherwise, uses the `vnetyp` field from `vfaspf`.
- Sets default price code (`b1etpr`) to 2.

### User Interaction and Validation

- **Screen Display**: The user is presented with a screen (`b1bld`) to select label type and price code.
- **Exit Handling**: If the user presses the cancel key (`*INKC`), `wpin03` is set to '1' and the program ends.
- **Label Type Validation**: Only label types 0–8 are valid. Any other input returns the user to the selection screen.
- **Price Code Validation**: Only price codes 1, 2, or 3 are allowed. Any other input returns the user to the selection screen.

### Data Preparation

- Stores selected values in the UDS area for use by downstream processes.
- Sets keys/flags (`l_ken1`, `l_ken2`) to 1 and 2, respectively.
- Formats the date in the UDS area.

### Print Routine Selection

Maps the selected label type to the corresponding print program:

| Label Type | Print Program | Label Description                |
|------------|--------------|----------------------------------|
| 1          | FP213        | Price label                      |
| 2          | FP214        | Shelf label 75x28 mm             |
| 3          | FP215        | Shelf label 100x28 mm            |
| 4          | FP216        | Reol (rack) label 202x60 mm      |
| 5          | FP217        | Shelf label 76x39 mm             |
| 6          | FP218        | Shelf label 48x38 mm             |
| 7          | FP219        | Shelf label 100x38 mm            |
| 8          | FP220        | Reol (rack) label 210x60 mm      |
| 9          | FP221        | Shelf label 76x39 mm (Laser/Interform) |

The routine name is stored in `l_ruti` for use by the print subsystem.

---

## Special Design Notes

- **UDS/Parameter Passing**: The program makes extensive use of the user data space and parameter files to pass control and data to subsequent print routines. This allows for a decoupled design where the actual printing is handled by separate programs based on the selected type.
- **Validation Loops**: User input is tightly validated, and the user is forced to correct any invalid label type or price code before proceeding.
- **Extensibility**: The mapping of label types to print programs is explicit, making it straightforward to add new label types or change print routines as business needs evolve.
- **Localization**: Field and comment names are in Norwegian, reflecting the domain and user base.

---

## Output

The output specification at the end (`Oparam`) defines the format of the parameter record written for the print program. It includes:

- Status code ('A')
- Company code
- Product/item number
- Quantity

---

## Interactions with Other Modules

- **Print Programs (FP213–FP221)**: The selected print routine is invoked downstream, using the data prepared by this program.
- **vfaspf File**: Used for fetching default label configuration based on the company code.
- **param File**: Used to pass parameters to the print program.

---

## Business/Domain Logic

- **Label Printing**: The program is designed for a retail or warehouse environment where labels for shelves, racks, and products must be printed on demand.
- **Price Codes**: The price code selection allows for flexibility in pricing strategies (e.g., campaign, offer, standard).
- **Configurable by Company**: The logic supports multiple companies/firms, with configuration fetched per company.

---

## Conventions and Patterns

- **Tag/Label Structure**: The program uses labeled sections (e.g., `a1tag`, `b1tag`, `slutt`) for control flow, a common pattern in legacy RPG code.
- **Exception Output**: Uses `EXCEPT` for outputting specific records, a pattern for writing to parameter/output files.
- **Parameter List (`PLIST`)**: Entry parameters are handled via a parameter list, supporting modular invocation.

---

## Summary

FP250R serves as a controlled entry point for label printing requests from radio terminals, ensuring valid input, mapping selections to appropriate print routines, and passing all necessary information downstream. Its design supports multi-company environments, is extensible for new label types, and enforces business rules for label and price code selection. The program relies on established RPG conventions for modularity, validation, and integration with the rest of the ASOFAK system.