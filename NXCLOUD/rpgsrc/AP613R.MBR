      /TITLE  Oppslag mot rutine-register
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Program . . . . : AP613R
      * Beskrivelse . . : Scanner input streng og returnerer med xml gyldug kode
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- - - - - - - - - - - - - - - - - - - - - - - - - -
      *       201010 BSA  Nytt program
6.10  * 6.10  260911 bsa  Scanner etter generell feiltegn
6.11  * 6.10  050612 bsa  Lagt til ytligere tegn for scan
6.12  * 6.10  180912 bsa  Hvis '~' i tekst, skal ikke den oversettes
6.13  * 6.10  301112 bsa  Feil i fiks 6.11
6.14  * 6.10  061212 bsa  Ikke bestandig alt fungerte med konv verdier.
6.14  *                   (Kan bli nødvendig å bytte ut flere verdier)
6.15  * 6.10  110113 bsa  ..... fortsetter endringer rundt 6.14
6.31  * 6.30  240516 bof  Utvidet med ÆØÅ æøå
      *
7.01a * 6.30  170220 bsa  Fjerner verdier som får xml til å "tryne"
7.01  *       170620 bof  Feilretting vedr. lite å.
7.02  *       190620 bof  Utivdet med ê
7.02  *       190620 bof  Utivdet med ê
7.03  *       190620 bof  Utivdet med ô
7.04  *       010720 bof  Feilretting vedr. lite æ.
7.05  *       190122 bof  Feilretting vedr. lite ê.
      *
8.01  *K0000  171122 bsa  Legger inn scan i SQL for å søke etter
8.01  *K0000              ugyldige tegn, og erstatte disse med " "
8.01  *K0000              (space)
8.02  *K0000  161123 bsa  Flytter scan etter ugyldige tegn
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     d                uds
     d l_firm                944    946  0
     d l_avde                947    950  0
      *
      * Definering av parametre
      *
     d p_lr            s              1
     d p_input         s            512
     d p_outpt         s            512
      *
      * Definering av variabler i nøkler
      *
     d w_str_in        s            512
     d w_str_out       s            512
     d w_x             s              5  0
      *
      * Definering av variable
      *
      *
8.01 C/Exec SQL
8.01 C+  Set Option DatFmt=*ISO, commit=*none, DlyPrp=*YES
8.01 C+  , SRTSEQ=*LANGIDSHR, LANGID=NOR
8.01 C/End-Exec
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Vi scanner innkommet streng                                     *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c                   eval      w_str_in = *blank
     c                   eval      p_outpt = *blank
8.01   //Free
8.01   //Wash text
8.02   //exec SQL SET :p_input = REGEXP_REPLACE(:p_input,
8.02   //   '[^A-Za-z0-9æøåÆØÅ.,_/?+!* :;%@\-&ÀÄÈËÜ]' , ' ');
8.01
8.01   //End-free
      *
6.10 c     x'3F':'A'     xlate     p_input       p_input
7.01ac     x'1C':' '     xlate     p_input       p_input
7.01ac     x'25':' '     xlate     p_input       p_input
     c                   eval      w_str_in = p_input
      *
     c                   exsr      xml_konv
      *
8.02   //Free
8.02   //Wash text
8.02   exec SQL SET :p_input = REGEXP_REPLACE(:w_str_out,
8.02      '[^A-Za-z0-9æøåÆØÅ.,_/?+!* :;%@\-&ÀÄÈËÜ]' , ' ');
8.02
8.02   //End-free
      *
     c                   eval      p_outpt = w_str_out
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Avslutt program                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c                   if        p_lr = '1'
     c                   eval      *inlr = *on
     c                   endif
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Konverter til gyldige xml tegn                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_konv      begsr
      *
     c                   eval      w_str_out = *blanks
      *
      /Free

6.12       // '~':']' NB Må erstatte ~ med annet tegn temporært
6.12       w_x = %scan('~':w_str_in);
6.12       dow w_x > 0;
6.12       w_str_in = %subst(w_str_in:1:w_x-1)
6.12                 + ']'
6.12                 + %subst(w_str_in:w_x+1);
6.12       w_x = %scan('&':w_str_in);
6.12       enddo;

           // '&':'&amp;' NB Må erstatte & med annet tegn temporært
           w_x = %scan('&':w_str_in);
           dow w_x > 0;
           w_str_in = %subst(w_str_in:1:w_x-1)
                     + '~amp;'
                     + %subst(w_str_in:w_x+1);
           w_x = %scan('&':w_str_in);
           enddo;
           w_str_in = %xlate('~':'&':w_str_in);

6.12       w_str_in = %xlate(']':'~':w_str_in);

           // '''':'&apos;'
           w_x = %scan('''':w_str_in);
           dow w_x > 0;
           w_str_in = %subst(w_str_in:1:w_x-1)
                     + '&apos;'
                     + %subst(w_str_in:w_x+1);
           w_x = %scan('''':w_str_in);
           enddo;

           // '"':'&quot;'
           w_x = %scan('"':w_str_in);
           dow w_x > 0;
           w_str_in = %subst(w_str_in:1:w_x-1)
                     + '&quot;'
                     + %subst(w_str_in:w_x+1);
           w_x = %scan('"':w_str_in);
           enddo;

           // '<':'&lt;'
           w_x = %scan('<':w_str_in);
           dow w_x > 0;
           w_str_in = %subst(w_str_in:1:w_x-1)
                     + '&lt;'
                     + %subst(w_str_in:w_x+1);
           w_x = %scan('<':w_str_in);
           enddo;

           // '>':'&gt;'
           w_x = %scan('>':w_str_in);
           dow w_x > 0;
           w_str_in = %subst(w_str_in:1:w_x-1)
                     + '&gt;'
                     + %subst(w_str_in:w_x+1);
           w_x = %scan('>':w_str_in);
           enddo;

6.15       // 'À':'&Agrave;''&#192;'
6.13       w_x = %scan('À':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#192;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('À':w_str_in);
6.11       enddo;

6.15       // 'Á':'&Aacute;''&#193;'
6.13       w_x = %scan('Á':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#193;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('Á':w_str_in);
6.11       enddo;

6.15       // 'Ä':'ÄAuml;''&#196;'
6.13       w_x = %scan('Ä':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#196;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('Ä':w_str_in);
6.11       enddo;

6.14       // 'È':'&Egrave;''&#200;'
6.13       w_x = %scan('È':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.14                 + '&#200;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('È':w_str_in);
6.11       enddo;

6.15       // 'É':'&Eacute;''&#201;'
6.13       w_x = %scan('É':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#201;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('É':w_str_in);
6.11       enddo;

6.15       // 'Ë':'&Euml;''&#203;'
6.13       w_x = %scan('Ë':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#203;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('Ë':w_str_in);
6.11       enddo;

6.15       // 'à':'&agrave;''&#224;'
6.13       w_x = %scan('à':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#224;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('à':w_str_in);
6.11       enddo;

6.15       // 'á':'&aacute;''&#225;'
6.13       w_x = %scan('á':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#225;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('á':w_str_in);
6.11       enddo;

6.15       // 'ä':'&auml;''&#228;'
6.13       w_x = %scan('ä':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#228;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('ä':w_str_in);
6.11       enddo;

6.14       // 'è':'&egrave;''&#232;'
6.13       w_x = %scan('è':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.14                 + '&#232;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('è':w_str_in);
6.11       enddo;

6.15       // 'é':'&eacute;''&#233;'
6.13       w_x = %scan('é':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#233;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('é':w_str_in);
6.11       enddo;

7.02       // 'ê':'&euml;''&#234;'
7.02       w_x = %scan('ê':w_str_in);
7.02       dow w_x > 0;
7.02       w_str_in = %subst(w_str_in:1:w_x-1)
7.02                 + '&#234;'
7.02                 + %subst(w_str_in:w_x+1);
7.05       w_x = %scan('ê':w_str_in);
7.02       enddo;

6.15       // 'ë':'&euml;''&#235;'
6.13       w_x = %scan('ë':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#235;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('ë':w_str_in);
6.11       enddo;

6.15       // 'Ö':'&Ouml;''&#214;'
6.13       w_x = %scan('Ö':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#214;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('Ö':w_str_in);
6.11       enddo;

6.15       // 'ö':'&ouml;''&#246;'
6.13       w_x = %scan('ö':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#246;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('ö':w_str_in);
6.11       enddo;

7.04       // 'ô':'&ouml;''&#244;'
7.04       w_x = %scan('ô':w_str_in);
7.04       dow w_x > 0;
7.04       w_str_in = %subst(w_str_in:1:w_x-1)
7.04                 + '&#244;'
7.04                 + %subst(w_str_in:w_x+1);
7.04       w_x = %scan('ö':w_str_in);
7.04       enddo;

6.15       // 'Ü':'&Uuml;''&#220;'
6.13       w_x = %scan('Ü':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#220;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('Ü':w_str_in);
6.11       enddo;

6.15       // 'ü':'&uuml;''&#252;'
6.13       w_x = %scan('ü':w_str_in);
6.11       dow w_x > 0;
6.11       w_str_in = %subst(w_str_in:1:w_x-1)
6.15                 + '&#252;'
6.11                 + %subst(w_str_in:w_x+1);
6.11       w_x = %scan('ü':w_str_in);
6.11       enddo;
6.31
6.31       // 'æ':'&#230;'
6.31       w_x = %scan('æ':w_str_in);
6.31       dow w_x > 0;
6.31       w_str_in = %subst(w_str_in:1:w_x-1)
6.31                 + '&#230;'
6.31                 + %subst(w_str_in:w_x+1);
7.04       w_x = %scan('æ':w_str_in);
6.31       enddo;
6.31
6.31       // 'Æ'':'&#198;'
6.31       w_x = %scan('Æ':w_str_in);
6.31       dow w_x > 0;
6.31       w_str_in = %subst(w_str_in:1:w_x-1)
6.31                 + '&#198;'
6.31                 + %subst(w_str_in:w_x+1);
6.31       w_x = %scan('Æ':w_str_in);
6.31       enddo;
6.31
6.31       // 'Ø':'&#216;'
6.31       w_x = %scan('Ø':w_str_in);
6.31       dow w_x > 0;
6.31       w_str_in = %subst(w_str_in:1:w_x-1)
6.31                 + '&#216;'
6.31                 + %subst(w_str_in:w_x+1);
6.31       w_x = %scan('Ø':w_str_in);
6.31       enddo;
6.31
6.31       // 'Å':'&#197;'
6.31       w_x = %scan('Å':w_str_in);
6.31       dow w_x > 0;
6.31       w_str_in = %subst(w_str_in:1:w_x-1)
6.31                 + '&#197;'
6.31                 + %subst(w_str_in:w_x+1);
6.31       w_x = %scan('Å':w_str_in);
6.31       enddo;
6.31
6.31       // 'æ':'&#230;'
6.31       w_x = %scan('æ':w_str_in);
6.31       dow w_x > 0;
6.31       w_str_in = %subst(w_str_in:1:w_x-1)
6.31                 + '&#230;'
6.31                 + %subst(w_str_in:w_x+1);
7.04       w_x = %scan('æ':w_str_in);
6.31       enddo;
6.31
6.31       // 'ø':'&#248;'
6.31       w_x = %scan('ø':w_str_in);
6.31       dow w_x > 0;
6.31       w_str_in = %subst(w_str_in:1:w_x-1)
6.31                 + '&#248;'
6.31                 + %subst(w_str_in:w_x+1);
6.31       w_x = %scan('ø':w_str_in);
6.31       enddo;
6.31
6.31       // 'å':'&#229;'
7.01       w_x = %scan('å':w_str_in);
6.31       dow w_x > 0;
6.31       w_str_in = %subst(w_str_in:1:w_x-1)
6.31                 + '&#229;'
6.31                 + %subst(w_str_in:w_x+1);
6.31       w_x = %scan('å':w_str_in);
6.31       enddo;

      /End-Free
      *
     c                   eval      w_str_out = w_str_in
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
      * Parameterliste
      *
     c     *entry        plist
     c                   parm                    p_input
     c                   parm                    p_outpt
     c                   parm                    p_lr
      *
     c                   endsr
      *
