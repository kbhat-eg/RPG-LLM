## Program Documentation: FX800R (ASOFAK)

### Overview

**Purpose:**  
This program (FX800R) is part of the ASOFAK system. Its main function is to clean up the deleted items register (`VVASPF`) by removing any items that also exist in the active items register (`VVARPF`). In other words, if a product is present both in the deleted items file and the current items file, it will be removed from the deleted items file.

**Business Context:**  
This is a data maintenance utility to ensure that the deleted items register (`VVASPF`) only contains items that are truly deleted (i.e., not present in the active items register `VVARPF`). This is important for data integrity, especially for processes that rely on an accurate view of deleted items (e.g., reporting, audits, or reactivation workflows).

---

### Data Sources and Files

- **VVARPF** (`vvarl1`): Active items register.
  - Accessed for reading using key lists.
  - Renamed as `vvarl1r` in the program for record format.
- **VVASPF** (`vvaslu`): Deleted items register.
  - Accessed for update (delete operations).
  - Renamed as `vvaslur` in the program for record format.

---

### Key Data Elements

- **Firm Number (`w_firm`, `l_firm`)**:  
  Used as part of the key for both files to ensure operations are company-specific.

- **Item Number (`vvaslu_vare`, `vvvare`)**:  
  Used to identify individual items within a firm.

---

### Program Structure

#### 1. Initialization (`*INZSR` Subroutine)

- **Key Lists Setup:**  
  - Defines key lists for both files:
    - `vvarl1_key` for reading the active items file (by firm).
    - `vvaslu_key` for updating the deleted items file (by firm and item).
- **Firm Number Assignment:**  
  - `w_firm` is set from `l_firm` (firm number from the Local Data Area).

#### 2. Main Processing Loop

- **Iteration over Active Items:**  
  - The program reads through all items in the active items file (`VVARPF`) for the current firm.
  - For each item, it attempts to find a corresponding record in the deleted items file (`VVASPF`).

- **Conditional Deletion:**  
  - If a matching record is found in the deleted items file, it is deleted.
  - This ensures that only items not present in the active file remain in the deleted register.

#### 3. Program Termination

- **Graceful Exit:**  
  - The program sets the last record indicator (`*INLR`) to ensure proper closure of files and resources.
  - Returns control to the system.

---

### Detailed Flow

1. **Set Key List for Active Items File:**
   - Use the firm number as the key.

2. **Read First Record:**
   - Use `SETLL` and `READE` to position and fetch the first record for the firm.

3. **Loop Through Active Items:**
   - For each item:
     - Copy item number to `vvaslu_vare`.
     - Use `CHAIN` to check if the item exists in the deleted items file for the same firm.
     - If found (`*IN91 = *OFF`), delete the record from the deleted items file.

4. **Continue Until End of File:**
   - Repeat until all items for the firm have been processed.

---

### Notable Design Decisions & Conventions

- **File Renaming:**  
  - Both logical files are renamed in the program for clarity and to avoid naming conflicts.

- **Use of Local Data Area (LDA):**  
  - The firm number is retrieved from the LDA, making the program adaptable to different execution contexts (multi-company support).

- **Key List Usage:**  
  - Key lists (`KLIST`) are used for both reading and updating, ensuring consistent and maintainable key management.

- **Selective Deletion:**  
  - The program only deletes from the deleted items file if the item still exists in the active file, preventing accidental loss of deletion history for truly deleted items.

---

### External Dependencies and Interactions

- **Data Area:**  
  - Relies on the presence of a properly populated Local Data Area for the firm number.

- **Database Files:**  
  - Assumes both `VVARPF` and `VVASPF` are available and accessible with the expected structure.

---

### Error Handling and Logging

- **Indicators:**  
  - Uses RPG indicators (`*IN90`, `*IN91`) for file I/O status.
- **No Explicit Error Logging:**  
  - The program does not contain explicit error handling or logging; failures would need to be monitored via system logs or job logs.

---

### Summary Table

| File      | Purpose            | Access | Key(s)         | Action         |
|-----------|--------------------|--------|----------------|---------------|
| VVARPF    | Active items       | Read   | Firm           | Iterate items |
| VVASPF    | Deleted items      | Update | Firm, Item     | Delete items  |

---

### Integration Points

- **Can be run as a batch utility** for regular data maintenance.
- **Should be scheduled or triggered** after item updates to ensure the deleted items register remains clean and accurate.

---

### Maintenance Notes

- **Adding new keys or changing file structures** will require updates to the key lists and possibly the logic.
- **Multi-firm support** is built-in via the firm number.

---

### Summary

This program is a utility for cleaning up the deleted items register, ensuring it only contains items not present in the active items register, scoped by firm. It is a simple yet crucial housekeeping tool for maintaining data integrity in the item master files.