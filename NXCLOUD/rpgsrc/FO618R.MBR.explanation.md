# Program Overview

This RPG (Report Program Generator) program, named `FO618R`, is part of the ASOFAK system. Its purpose is to "blank" (clear) certain codes in the order register after an order has been printed/invoiced. The comments and modification log in Norwegian explain that when an order is invoiced, it is logged in a deletion register with the delete type `FAKT`, and the program also handles clearing of certain summary records.

The code also maintains tracking information and, as of recent versions, removes order summary lines after billing runs.

---

## File Declarations

- **FFPSOLU** (Order line register)
  - Input Primary file, keyed access, dataset renamed for internal usage.
- **FVOTYL1** (Order type register)
  - Input file, keyed access, renamed.
- **FFOHELU** (Order header register)
  - Update file, keyed access, renamed.
- **ffakiu** (Order summation)
  - Update file, keyed access, renamed.

---

## Data Declarations

- Various stand-alone fields and work variables for keys and data manipulation.
- `l_user`, `DSSFIR`: for user/tracking and possibly used for logging/auditing.
- Temporary variables (`ffakiu_ksrt`, `ffakiu_knum`, `ffakiu_ksuf`) for summation record key handling.
- `w_opdt`, `w_firm`: operation flags and current firm number.

---

## Main Logic

### 1. **Skip Non-Header Lines**

```rpg
C     FKSKOD        CABNE     'H'           XSLUTT
```
- If the order line is not a "HEAD" line, branch to end of program.

---

### 2. **Set Up Key Values**

- Move firm, order number, and suffix from current line to key variables for later use.

---

### 3. **Read Order Type Register**

- Use firm and order type as key; `CHAIN` reads order type information (if exists).

---

### 4. **Delete Order After Billing/Credit Note**

```rpg
C     VAOAKK        IFEQ      3
    ...
```

- If the order is of a certain type (e.g., billed or credited), proceed to delete:
  - Set delete type as `'FAKT'`
  - Set operation type `'R'`
  - Call program `FO410R` with key fields and operation info to log the deletion.

#### __Order Summation Deletion__ (from v8.01):

- After invoicing, delete summary records from `ffakiu` based on keys:
  - First, try with summation number/suffix = 0.
  - Then try with current order's number/suffix.
- `CHAIN` and `DELETE` ensure both scenarios are cleaned up.

---

### 5. **Clear Order Register Codes**

- Lookup order header (`FOHELUR`) using keys.
- If found, clear various codes:
  - `FOKODE`, `FOKODA`, `FOKOTI`, `FOKOUS`, `FOKOWS` are reset.
  - Update header record with the current date, time, and user.

---

### 6. **Program End**

- End of processing (`XSLUTT:` label).
- Returns control.

---

### 7. **Initialization Subroutine**

- Clears temporary working fields.
- Defines key lists for chain operations (for better readability/maintenance).

---

## Key/Field Definitions

- Key lists (`KLIST`) are set up for each file to allow keyed operations:
  - Order type register: firm, order type.
  - Order header register: firm, order number, suffix.
  - Order summation: firm, summation type, number, suffix.

---

## **Summary of Business Rules**

- **ONLY header lines** are processed.
- When an order is invoiced/credited:
  - It is logged for deletion (`FO410R` with `FAKT`).
  - Summary records related to billing are also deleted to ensure data consistency.
- The corresponding header record has certain fields reset, making the order available for further processing if needed.

---

## **Useful Notes for Onboarding**

- The code uses fixed-format RPG IV. 
- Most fieldnames are abbreviations; refer to the database or copybook for definitions.
- All file accesses are done with explicit key lists for reliability and maintainability.
- The program is careful to only process header lines (`FKSKOD = 'H'`).
- Modifications and business rules are well documented in comments (though in Norwegian).
- The external program `FO410R` performs loggingâ€”changes here might affect integration.

---

## **Typical Use Case**

Run this program after printing/invoicing a batch of orders. It will:
1. Check each order header.
2. If the order is billed/credited, log its deletion and remove summary lines.
3. Blank/reset the relevant fields in the order header to "release" the order for possible re-processing.

---