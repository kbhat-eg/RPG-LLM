# Overview  
This RPG IV (ILE) program `RA509R` runs on the ASOKON system and implements a subfile‐based screen to let a user select a salesperson (selger) by code or description. It supports paging (roll up/down), repositioning on keys, and returns the chosen code/text as output parameters.

---

## 1. Metadata & Indicators  
- **Header comments** document system, program name, versions, dates and authors.  
- **Indicators used:**  
  • LR = *ON → end program  
  • IN10/IN11 → page forward/backward  
  • IN21 → Home key (reset to top)  
  • IN22 → screen cursor positioning  
  • IN12/IN13 → control when to display subfile  
  • IN14 → clear subfile before writing  
  • IN15 → end‐of‐file flag for subfile build  
  • Fields 31–79 for error messages, 80–99 for work indicators  

---

## 2. File Declarations  
```
fra09l1  IF   E           K DISK  RENAME(ra09pfr:ra09l1r)
fra09l2  IF   E           K DISK  RENAME(ra09pfr:ra09l2r)
fra509d  CF   E           WORKSTN SFL(b1sfl:w_srrn) INFDS(dspfbk)
```  
- **fra09l1 / fra09l2**  
  • External files (likely salespeople: code file and description file)  
  • Keys defined later (`ra09l1_key`, `ra09l2_key`)  
- **fra509d**  
  • Display file with subfile record format `B1SFL` keyed by internal counter `w_srrn`  
  • Uses an INFDS (`dspfbk`) to get function‐key feedback  

---

## 3. Data & Parameter Definitions  
- **Parameters**  
  • `p_firm` – company number (like `RAIFIR`)  
  • `p_ikod` – pre‐position code input  
  • `p_itxt` – pre‐position text input  

- **INFDS (dspfbk)**  
  • `d_fcrn` – first record number on page (FCRN returned by display)  

- **Work fields for subfile control**  
  • `w_stel` – subfile counter for paging backward  
  • `w_spge` – page size counter (page end record number)  
  • `w_srrn` – current relative record number in subfile  
  • `w_sfrn` – first record number on the last displayed page  
  • `w_ssrn` – last record number on the last displayed page  
  • `w_seqe` – indicator whether sorting by Code (blank) or Description (‘B’)  
  • `b_valg_ok` – selection‐made flag  

- **Constants**  
  • `c_sfil = 8` – number of records per page  

---

## 4. Main Processing Logic  
1. **Opening Screen (B2CTL)**  
   - `B2TAGA`: write subfile‐control record (`B2CMD`) to display function keys.  
   - `B2TAGB`: call the subroutine `dsp_subfile` to display the list.  

2. **Function Key Handling**  
   ```  
   F3/F12 (Cancel) → goto avslutt  
   F5 (Refresh)   → call SUBROUTINE FORNY, redisplay  
   F10 (Page Fwd) → call crt_subfile, redisplay  
   F11 (Page Back)→ call bck_subfile, redisplay  
   F21 (Home)     → reset IN22, redisplay  
   ```  

3. **Repositioning (if code/text supplied)**  
   If the user entered a code (`b2ikod`) or text (`b2itxt`), call the `posisjoner` subroutine to set record pointers, then redisplay.

4. **Selection Processing**  
   Call `subfile` subroutine which:  
   - Reads the displayed subfile records  
   - Detects if user has marked a record (`b1valg = 1`)  
   - Sets output parameters `p_ikod`/`p_itxt`, sets `b_valg_ok` and leaves.  
   If a selection was made → exit program (`avslutt`), else loop back.

5. **Program End**  
   Tag `avslutt` sets `*INLR = *ON` and returns to caller.

---

## 5. Key Subroutines  

### 5.1 *INZSR / Initialization  
- Called automatically on entry.  
- Receives `p_firm`, `p_ikod`, `p_itxt`.  
- Sets up key lists for `ra09l1` (by firm + code) and `ra09l2` (by firm + text).  
- Initializes `w_firm` with `p_firm`.  
- Flags `*IN22` to force subfile redisplay.  
- Calls `crt_subfile` to build the first page.

### 5.2 clr_subfile  
- Clears the subfile: sets indicator 14 on, writes control record `B2CTL`.  
- Resets flags/ counters `w_srrn`, `w_sfrn`, `w_ssrn`, `w_spge`.

### 5.3 crt_subfile  (Create Subfile Page Forward)  
- Advances `w_spge` by page size `c_sfil`.  
- Sets `w_srrn` to previous page’s last record `w_ssrn`.  
- Loops reading either from `ra09l1` or `ra09l2` based on `w_seqe`.  
- Stops on EOF or firm mismatch → sets end‐of‐file flag `*IN15`.  
- Writes each record into the display record format `B1SFL`.  
- Updates first/last record pointers `w_sfrn`, `w_ssrn`, and `w_virn` for cursor.

### 5.4 bck_subfile (Page Back)  
- If at end‐of‐file, position just beyond last full page with a `SETGT` + `READP`.  
- Then loops back one page by reading with position backward (`READP`) until enough records collected.  
- Finally clears & re‐creates subfile via `clr_subfile` + `crt_subfile`.

### 5.5 posisjoner  
- If user typed a code (`b2ikod`) → switch to sort by code, set key, reposition file pointer.  
- Else if they typed a text (`b2itxt`) → switch to description mode, set key.  
- Clears & re‐creates subfile, blanks out search input fields.

### 5.6 forny  (Refresh)  
- Chains to record at current FCRN if nonzero.  
- Depending on `w_seqe`, positions on description or code via key lists.  
- Clears & re‐creates subfile.

### 5.7 dsp_subfile  
- If `w_srrn`>0: turn on indicator 12 to display only the subfile page.  
- Else print blank list command screen.  
- Turn on indicator 13, do `EXFMT B2CTL` to show subfile.

---

# Key Takeaways  
- The program uses a DDS‐based subfile mechanism on IBM i: control record + record format (`B2CTL`, `B1SFL`).  
- Flexible sort order: either by salesperson code or description.  
- Supports Refresh, Page Up/Down, Home, and direct positioning via code/text entry.  
- Clean separation of logic into small subroutines: clear, build, display, position, page back/forward, refresh.