# Documentation for Program RV002R (ASOFAK System)

## Overview

This program, **RV002R**, is a batch RPG program designed to read accounting transaction lines from the `BOVF` files and export them as comma-separated (CSV) records. The output includes both transaction and master data (customer and invoice header information), with several business rules and data enrichments applied during processing.

The program is part of the **Visma Global** integration and supports various customizations and extensions, as indicated by its version history and comments in Norwegian.

---

## High-Level Process

1. **Read accounting line records** from the `BOVF` logical files (`bovfl2`, `bovfl3`).
2. **Aggregate and group** records by document number, text, and account (line-level grouping).
3. **Enrich data** by looking up related information in customer, invoice header, and code conversion tables.
4. **Build a CSV line** with all relevant fields, including calculated and looked-up data.
5. **Write the CSV line** to the output file (`rv02pf`).
6. **Repeat** until all records are processed.

---

## File Definitions and Relationships

- **bovfl2 / bovfl3**: Logical files over BOVF (accounting transaction lines), main input.
- **sohel1**: Invoice header file, provides invoice-level data (renamed to `sohel1r`).
- **rkunl1**: Customer master file (renamed to `rkunl1r`).
- **rktrl8**: Customer transaction file, used for reference/match checks (renamed to `rktrl8r`).
- **votyl1, aforl1**: Order type and routine master, used for business logic (e.g., KID handling).
- **rb10l1, rb00l1**: Code conversion tables for document type and VAT code, respectively.
- **rv02pf**: Output file, receives one record per grouped transaction (CSV format).

---

## Key Data Structures

- **Date Structures**: Several data structures for handling and converting date formats.
- **Aggregation Variables**: Variables such as `w_sumbel`, `w_summngd` for summing amounts and quantities per group.
- **"x_" Variables**: Hold the current group key fields for break detection.
- **Customer/Invoice Fields**: Local variables for storing looked-up or calculated customer and invoice information.

---

## Main Business Logic

### 1. **Grouping and Aggregation**

- The program groups transaction lines by a set of key fields (`bfbiln`, `bftext`, `bfdkto`, `bfckto`).
- When a group break is detected (change in any key field), the aggregation is written to the output, and the accumulators are reset.

### 2. **Data Enrichment**

- **Customer Info**: Looked up via `rkunl1` based on account numbers; if accounts are customer accounts (`> 9999`), the program fetches customer details, including name, address, phone, etc.
- **Invoice Info**: Fetched from `sohel1` using invoice number and year.
- **Document and VAT Code Conversion**: Uses `rb10l1` and `rb00l1` to convert codes to external values if required.
- **Order Type and Routine**: Used to determine if KID (customer identification) should be processed, via `votyl1` and `aforl1`.

### 3. **Reference Matching (Motpost/Reference Logic)**

- If a matching transaction exists in `rktrl8` with the same amount, the reference is retained; otherwise, it is cleared.

### 4. **Field Formatting and CSV Construction**

- All relevant fields (transaction, customer, invoice, and calculated) are formatted and concatenated into a single CSV line.
- Special handling for fields with commas, to avoid breaking the CSV format (e.g., names and alpha fields).
- Numeric fields are converted to character as needed.

---

## Notable Patterns and Conventions

- **Version Control in Comments**: Each code change is annotated with a version and author, providing a historical audit trail.
- **"x_" Prefix**: Used for variables holding the current group key for break detection.
- **Break Subroutine (`brudd`)**: Handles group breaks, writing accumulated data and resetting accumulators.
- **Data Lookup via CHAIN/READE**: Standard pattern for fetching related master data.
- **Field Resetting**: After each write, all relevant fields (including accumulators and local variables) are cleared to avoid data leakage between groups.
- **Conditional Logic for KID Handling**: Business logic uses order type and routine masters to determine if KID processing is needed, including an external program call (`AK710R`).

---

## Program Flow

### Initialization

- The `*inzsr` subroutine initializes key variables and key lists for file access.

### Main Loop

1. **Read Next Record**: From `bovfl3` (or `bovfl2` in earlier versions).
2. **End-of-File Check**: If EOF, write any remaining aggregated data and exit.
3. **First Record Handling**: Initialize aggregation variables with the first record's values.
4. **Break Detection**:
    - If the current record's key fields differ from the previous, invoke the `brudd` subroutine to write the current group and reset accumulators.
    - Otherwise, continue summing amounts and quantities.
5. **Data Enrichment**:
    - Lookup and populate customer and invoice data as needed.
    - Convert codes via lookup tables.
    - Reference matching logic (motpost) via `rktrl8`.
6. **CSV Construction and Output**: Concatenate all required fields into a CSV line and write to `rv02pf`.
7. **Repeat**: Continue until all records are processed.

### Subroutines

- **brudd**: Handles group breaks, performs all lookups and formatting, writes the CSV line, and resets working fields.
- **control_init**: Fetches and prepares invoice and customer data for the current group.
- **w_flytt**: Copies customer master data into local working variables, including handling of names with commas.
- **Key Lists**: Defined for all file lookups for clarity and maintainability.

---

## Domain-Specific Logic

- **KID Handling**: KID (customer identification) numbers are processed only for certain order types and routines, determined dynamically via lookups.
- **Motpost/Reference Matching**: Ensures that references are only included if a matching transaction with the same amount exists.
- **Name Field Parsing**: If a name or alpha field contains a comma, it is split and reformatted to maintain CSV integrity.
- **MVA/VAT Code Conversion**: Internal codes are mapped to external codes as required by integration needs.

---

## Special Notes

- **Legacy RPG III/IV Syntax**: The code uses fixed-format RPG, including operation codes like `eval`, `move`, `chain`, etc.
- **Extensive Use of Indicators**: For file I/O status and conditional logic.
- **Commented-Out Sections**: Some logic is retained as comments for historical or reference purposes.
- **Data Area Usage**: The program reads the company number (`l_firm`) from the user data area.

---

## File Interactions Summary

| File      | Role                       | Access | Notes                                              |
|-----------|----------------------------|--------|----------------------------------------------------|
| bovfl2/3  | Transaction lines (input)  | Read   | Main input, grouped and aggregated                 |
| sohel1    | Invoice header             | Read   | Lookup for invoice-level data                      |
| rkunl1    | Customer master            | Read   | Lookup for customer data (both customer and vendor)|
| rktrl8    | Customer transactions      | Read   | Used for reference matching                        |
| votyl1    | Order type                 | Read   | Used to determine routine for KID processing       |
| aforl1    | Routine master             | Read   | Used for KID logic                                 |
| rb10l1    | Document type conversion   | Read   | Converts internal to external document types       |
| rb00l1    | VAT code conversion        | Read   | Converts internal to external VAT codes            |
| rv02pf    | Output file (CSV)          | Write  | Receives one record per group                      |

---

## Key Business Rules

- **Only records for the current company (`l_firm`) are processed**.
- **Group by document number, text, and account**; output one CSV line per group.
- **Reference (motpost) is only included if matching transaction found**.
- **KID numbers are recalculated for certain order/routine types**.
- **Names and alpha fields containing commas are split for CSV safety**.
- **Document and VAT codes may be converted before output**.

---

## Extensibility and Maintenance

- **Versioning**: All changes are logged inline, aiding traceability.
- **Subroutines**: Encapsulate repeated/complex logic for maintainability.
- **Key List Usage**: Centralizes file access logic, simplifying future changes.
- **Field Resetting**: Ensures data integrity across groups.

---

## Summary

**RV002R** is a robust and extensible batch program for exporting accounting transactions with rich business logic. It demonstrates careful data handling, aggregation, and enrichment, with a focus on integration and data quality for external systems. The design supports easy adaptation to future business rules and changes in file layouts or integration requirements.