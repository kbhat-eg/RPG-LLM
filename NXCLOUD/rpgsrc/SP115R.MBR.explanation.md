# Documentation: Program SP115R (ASSTAT â€“ Utvalg hovedgruppe)

## Overview

**Program:** SP115R  
**System:** ASSTAT  
**Purpose:**  
This program manages the selection, display, creation, update, and deletion of "hovedgruppe" (main group) records within the ASSTAT system. It is designed for interactive use with a subfile-based workstation display, supporting navigation, filtering, and CRUD operations on group records. The program is tailored for integration with a GUI front-end (notably, some comments indicate adjustments for a new GUI).

## Core Concepts & Business Domain

- **Hovedgruppe:** Refers to a main group or category used in the ASSTAT system. Each record is identified by a type, code, and selection value, and is associated with a company (firm).
- **Subfile Interface:** The program uses a subfile (b1sfl) to display and interact with multiple hovedgruppe records in a paginated, scrollable list.
- **Workstation File (DSPF):** The user interface is managed via a display file (`sp115d`), with dedicated control and entry screens for adding/editing/deleting records.
- **Key Files:**  
  - `skpml1`, `skpmlr`, `skpmlu`: Variants of the main group master file, used for reading, updating, and deleting records.
  - `vhgrl1`: Used for validation and lookup of group descriptions.

## File Relationships

- **skpml1:** Main group master file, used for reading (browsing) records.
- **skpmlr:** Used for record existence checking (read).
- **skpmlu:** Used for updating or deleting records.
- **vhgrl1:** Lookup file for group descriptions.

All files are keyed by company, type, code, and selection value (or group IDs for `vhgrl1`).

## Key Data Structures

- **Key Variables:** For each file, key fields are defined as standalone variables for ease of use in keyed operations.
- **Local Data Area (LDA):** Used to retrieve company number and user information at program start.
- **Subfile Paging Variables:** Variables such as `w_srrn`, `w_ssrn`, `w_spge` manage the subfile's current record, total records, and paging.

## Program Flow

### Initialization (`*inzsr`)

- Sets up key lists for file access.
- Receives parameters from the calling program (type and text).
- Initializes subfile and paging variables.
- Reads company number from LDA.
- Positions to the first relevant record and populates the subfile.

### Main Control Loop

- The program alternates between subfile control screen and subfile display, depending on user actions.
- Handles function keys for exit, refresh, create, and other actions.
- Supports position-to functionality based on group IDs.

### Subfile Operations

- **Display (`dsp_subfile`):** Handles the display of the subfile and related control screens.
- **Clear (`clr_subfile`):** Empties the subfile and resets paging variables.
- **Create/Fill (`crt_subfile`):** Reads records from `skpml1` and populates the subfile up to the page limit.
- **Processing (`subfile`):** Handles per-record actions in the subfile, such as delete requests.

### CRUD Operations

- **Create/Edit (`xc1bld`/`xc2bld`):**  
  - Presents an entry screen for new records.
  - Checks if the record already exists (`skpmlr`).
  - If not, validates against `vhgrl1` (group master).
  - Updates or writes the record in `skpmlu`.
- **Delete (`xd1win`):**  
  - Presents a confirmation screen.
  - Deletes the record from `skpmlu` if confirmed.

### Validation & Positioning

- **Positioning (`posisjoner`):**  
  - Allows the user to jump to a specific group in the subfile based on group IDs.
- **Key Validation:**  
  - Ensures necessary fields (e.g., group IDs) are specified before operations.
  - Displays error messages for missing/invalid keys or duplicates.

### Messaging

- **Duplicate Record Message (`xc1msg`):**  
  - Displays a message if the user attempts to create a record that already exists.
  - Allows the user to cancel the operation.

## Notable Design Patterns & Conventions

- **Separation of Concerns:**  
  - Each CRUD operation is encapsulated in its own subroutine for clarity and maintainability.
- **Consistent Key Handling:**  
  - Key lists (`klist`) are defined in the initialization section and reused throughout the code for all file operations.
- **Paging Logic:**  
  - Subfile paging is managed via a set of variables and constants, allowing for easy adjustment of page size.
- **GUI Adaptation:**  
  - The code includes comments and some logic to accommodate GUI-specific requirements, particularly in how DDS (display file) is handled.
- **Error Handling:**  
  - Error and status flags (`b_feil`, `b_forn`, `b_anul`) are used to control flow and user feedback.

## Integration Points

- **Calling Program:**  
  - Receives `type` and `text` parameters, likely from a menu or higher-level selection screen.
- **VG511R:**  
  - An external program called for group selection/validation when certain function keys are pressed in the entry screen.
- **Local Data Area (LDA):**  
  - Used for company and user identification at startup.

## Summary Table: Key Subroutines

| Subroutine      | Purpose                                                                 |
|-----------------|------------------------------------------------------------------------|
| `forny`         | Refreshes the subfile contents                                         |
| `posisjoner`    | Positions subfile to a specified group                                 |
| `control`       | Handles subfile control actions (create, delete, validation)           |
| `subfile`       | Processes user actions on subfile records (e.g., delete)               |
| `xc1bld`        | Manages the entry/edit screen for a new group                          |
| `xc1msg`        | Displays a message if a duplicate record is detected                   |
| `xc2bld`        | Handles update/write of group records                                  |
| `xd1win`        | Manages the delete confirmation and deletion of a record               |
| `clr_subfile`   | Clears the subfile and resets related variables                        |
| `crt_subfile`   | Populates the subfile with records from the master file                |
| `dsp_subfile`   | Manages display of the subfile and control screen                      |

## Business Rules & Special Considerations

- **A record is uniquely identified by company, type, code, and selection value.**
- **Creation is blocked if a record already exists; an informational message is shown.**
- **Deletion requires user confirmation via a dedicated screen.**
- **Position-to functionality allows users to jump to a specific group using group IDs.**
- **The program is sensitive to the GUI/display file version and may behave differently depending on the front-end.**

## Conventions

- **Variable Naming:**  
  - Prefixes like `b1`, `b2` refer to subfile/control fields.
  - `w_` for working variables; `c_` for constants; `d_` for delete operations.
  - `skpml1`, `skpmlr`, `skpmlu` are used for different access modes to the same logical file.

- **Error/Status Flags:**  
  - `b_forn`: Subfile needs to be refreshed.
  - `b_feil`: An error has occurred.
  - `b_anul`: Operation was cancelled.

## Summary

This program is a robust, interactive maintenance tool for main group (hovedgruppe) records in the ASSTAT system. It follows established RPG patterns for subfile processing, encapsulates business rules for record uniqueness and validation, and is structured for maintainability and adaptation to new GUI requirements. The codebase emphasizes clear separation of logic, consistent key management, and user feedback, making it a solid foundation for onboarding new RPG developers into this business domain.