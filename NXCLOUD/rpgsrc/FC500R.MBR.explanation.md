# FC500R – Price Record Format Inquiry (Pris recordformat, spørring)

## Overview and Purpose

FC500R is a display file-based RPG program used for inquiry and selection of price record formats within the ASOFAK system. It is designed to present the user with a subfile of price records, allowing them to search, position, page, and select a record format (RFMT) or description (BESK). The program supports both record format-based and description-based navigation, and is tailored for use within a GUI-enabled environment (as of version 7.00).

This module is tightly integrated with two physical files, FPRCL1 and FPRCL2, representing two different access paths (likely by record format and by description, respectively) to the underlying price records.

## File and Display Definitions

- **FPRCL1**: Keyed disk file, renamed to FPRCL1R, used for access by record format.
- **FPRCL2**: Keyed disk file, renamed to FPRCL2R, used for access by description.
- **FC500D**: Display file containing:
    - Subfile (B1SFL, controlled by W_SRRN)
    - Subfile control record (B2CTL)
    - Command key window (B2CMD)
    - INFDS (DSPFBK) used for feedback, e.g., cursor position.

## Key Data Structures and Variables

- **Parameters:**  
  - `p_firm`: Company/firm identifier.
  - `p_rfmt`: Record format (input/output).
  - `p_besk`: Description (input/output).

- **Display Feedback Data Structure (DSPFBK):**  
  - Used to retrieve the current record number for cursor positioning.

- **Key Variables for Navigation:**  
  - `fprcl1_rfmt`, `fprcl2_besk`: Used for keying into FPRCL1 and FPRCL2.
  - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`, etc.: Subfile navigation and paging controls.
  - `w_seqe`: Determines if navigation is by record format (blank) or description ('B').
  - `b_valg_ok`: Flag indicating a selection has been made.

- **Constants:**  
  - `c_sfil`: Page size for subfile paging (default 8).

## Indicator Usage

The program uses indicators extensively for controlling display logic, subfile state, and error messaging. Key indicators include:
- *INLR: Program end.
- *IN10–*IN15, *IN21–*IN22, *IN30, *IN31–*IN99: Subfile, paging, cursor, and error state controls.
- *IN12, *IN13, *IN14, *IN15: Subfile display, clear, and end-of-file handling.

## Main Program Flow

1. **Initialization (`*INZSR`)**
    - Receives parameters for firm, record format, and description.
    - Sets up key lists for both access paths.
    - Initializes subfile by positioning and loading initial page.

2. **Main Loop**
    - Alternates between displaying the subfile and handling function keys.
    - Supports:
        - Paging forward/backward.
        - Cursor positioning.
        - Re-query/refresh (`forny`).
        - Positioning by record format or description (`posisjoner`).
        - Selection of a record (sets `b_valg_ok` and returns selection).
        - Exit.

3. **Subfile Management**
    - **Display (`dsp_subfile`)**: Shows subfile, manages indicators, retrieves current cursor position.
    - **Clear (`clr_subfile`)**: Empties subfile, resets counters and indicators.
    - **Create (`crt_subfile`)**: Fills subfile with records for current page, handles end-of-file and page boundaries.
    - **Back (`bck_subfile`)**: Pages backward by appropriate number of records, repositions file pointer, reloads subfile.
    - **Subfile Processing (`subfile`)**: Handles selection from subfile, updates selection parameters.

4. **Positioning**
    - Allows the user to position the subfile either by entering a record format or description, which sets the key and reloads the subfile accordingly.

## Business/Domain-Specific Logic

- **Dual Access Paths:**  
  The application supports both record format-based and description-based navigation of price records. This is reflected in the use of two physical files and the `w_seqe` variable, which controls which path is active for navigation and subfile building.

- **Subfile Paging:**  
  The subfile displays a fixed number of records per page (default 8). Paging forward and backward is supported, with logic to handle end-of-file conditions and proper positioning after each operation.

- **Selection:**  
  The user can select a record from the subfile. The selected record's format and description are returned via parameters, and the program sets a flag to indicate a valid selection.

- **GUI Adaptation:**  
  As of version 7.00, the program includes changes related to new GUI requirements, particularly in how display files (DDS) are handled.

## Design Patterns and Conventions

- **Subfile Pattern:**  
  The program follows the classic RPG subfile pattern with clear, create, display, and process routines. It uses a combination of indicators and working variables to manage subfile state.

- **Key Lists for Positioning:**  
  Key lists (`fprcl1_key`, `fprcl2_key`) are used for efficient positioning within the physical files, supporting both access methods.

- **Indicator-Driven Display Logic:**  
  Display file and subfile control are heavily indicator-driven, consistent with traditional RPG/DDS design.

- **Feedback Data Structure:**  
  Usage of INFDS (DSPFBK) allows the program to retrieve display-related feedback, such as the current cursor position.

## Integration Points

- **Physical Files:**  
  - `FPRCL1` and `FPRCL2` are central to the program. Any changes to their structure or access paths will directly affect this module.

- **Display File (`FC500D`):**  
  - The subfile and control screens are defined here. The layout and field names must match between the RPG program and DDS.

- **Parameter Passing:**  
  - The program is likely called by other modules, passing in firm, record format, and description, and returning the user’s selection.

## Noteworthy Implementation Details

- **Paging Logic:**  
  The program carefully manages subfile page boundaries and record numbers, ensuring correct behavior when paging forward and backward, even at file boundaries.

- **Flexible Positioning:**  
  Users can jump to a specific record format or description, not just page sequentially.

- **Indicator Management:**  
  The program resets and manages indicators meticulously to control the display file and subfile states.

- **Backward Paging (`bck_subfile`):**  
  This routine uses `SETGT` and `READP` to position and read records in reverse order, reconstructing the previous page for the subfile.

## Related Modules and Dependencies

- **Other Inquiry or Maintenance Programs:**  
  This program is likely one of several that allow browsing or maintaining pricing data. It may be invoked from menu systems or other maintenance screens.

- **DDS (Display File):**  
  Any changes to the DDS (FC500D) must be coordinated with this program to maintain field and indicator consistency.

## Maintenance and Extension Considerations

- **Adding New Navigation Methods:**  
  If new access paths or search options are added to the price file, corresponding routines should be added, following the established dual-path pattern.

- **Changing Subfile Size:**  
  Adjusting `c_sfil` changes the number of records per page. Ensure all routines respect this constant.

- **Error Handling:**  
  Currently, error and warning indicators (31-79) are reserved for future use or expansion.

- **GUI Enhancements:**  
  If further GUI adaptation is needed, especially for web or modern UIs, consider abstracting subfile and display logic for easier integration.

---

## Summary Table: Key Routines

| Routine         | Purpose                                                        |
|-----------------|----------------------------------------------------------------|
| *INZSR          | Initialization, parameter handling, initial subfile load       |
| forny           | Refreshes/rebuilds the subfile based on current position       |
| posisjoner      | Positions subfile by record format or description              |
| subfile         | Handles user selection from the subfile                        |
| clr_subfile     | Clears the subfile and resets counters                         |
| crt_subfile     | Loads the subfile for the current page                         |
| bck_subfile     | Pages backward in the subfile                                  |
| dsp_subfile     | Displays the subfile and handles display indicators            |

---

## Conclusion

This module is a robust, indicator-driven subfile inquiry program, supporting flexible navigation and selection of price record formats. Its dual-access-path design and careful subfile management make it adaptable to both traditional green-screen and GUI environments. When extending or maintaining this code, ensure consistency in indicator usage, key list logic, and synchronization between DDS and RPG definitions. 

For further integration or enhancements, consult related modules that interact with price records and coordinate changes to shared files and display definitions.