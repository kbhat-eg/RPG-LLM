# CR701R â€“ Readiness Item Update from Relex

## Purpose

This program (`CR701R`) is responsible for synchronizing minimum and maximum stock levels for items based on data imported from the Relex system. Specifically, it reads records from the Relex input file and updates the warehouse register with new minimum and maximum values, as well as the ABC code (classification code), for each item in the company's inventory. The program contains special handling for certain business rules, including a "Skattum special" for date-based resets.

## Key Business Logic

- **Source of Truth:** The program reads from the `nrlxpfr` file (Relex import), and updates the warehouse stock records in `vlaglur`.
- **ABC Code Update:** As of version 7.01, the program also updates the ABC code (`vlkabc`) in the warehouse register.
- **Special Date Handling:** If the imported update date is missing, but the warehouse record has a date, it uses the warehouse date. If the update date is in the past, it resets the min/max values to zero.
- **Selective Updates:** The program only updates warehouse records that meet specific criteria, avoiding unnecessary writes.

## File Relationships

- **nrlxpfr:** Input file with item records from Relex (imported min/max/ABC values).
- **vvarl1r:** Item master file, used to verify the existence of the item.
- **vlagl1r:** Warehouse master file, used to check current warehouse stock data and business rules.
- **vlaglur:** Warehouse master file (update), the actual target for updates.

## Program Flow

1. **Initialization:**
   - Sets the current date.
   - Reads the first record from the Relex import file.

2. **Main Loop:**
   - Iterates through each record in the Relex import file (`nrlxpfr`).
   - On the first record, stores the company and warehouse codes for later use.

3. **Item Verification:**
   - Chains to `vvarl1r` (item master) to ensure the item exists.
   - If not found, skips to the next item.

4. **Business Rules & Pre-Update Checks:**
   - Chains to `vlagl1r` (warehouse master) to check if the warehouse record:
     - Exists
     - Is of type 'L' (likely a standard warehouse location)
     - Has a start date before today
     - Either min/max/ABC values differ from the imported values, or `vlbmin` is zero (i.e., "uninitialized")
   - If any check fails, skips the update for this item.

5. **Special Skattum Handling:**
   - If the imported update date is missing but the warehouse has a date, use the warehouse date.
   - If the (possibly substituted) update date is before today, reset min/max to zero.

6. **Warehouse Record Update:**
   - Chains to `vlaglur` (warehouse master, update mode).
   - If found, updates:
     - Minimum (`vlmini`)
     - Maximum (`vlmaks`)
     - ABC code (`vlkabc`)
     - If `vlbmin` is zero, sets it to 1 (marks as initialized)
     - Edit date/time/user
   - Writes the updated record.

7. **Next Record:**
   - Repeats the process for the next Relex import record.

8. **Program End:**
   - Sets LR indicator and returns.

## Special/Non-Obvious Design Decisions

- **Key Management:** The program uses separate key lists (`klist`) for each file access, constructed in the `*inzsr` subroutine. This is a codebase convention to ensure keys are consistently set before each file operation.
- **Single-Run Context:** The program assumes all records in the Relex file refer to the same company/warehouse, as it only saves these values from the first record.
- **ABC Code Handling:** The update of the `vlkabc` field is a specific business requirement added in release 7.01.
- **Zero-Minimum Initialization:** The check for `vlbmin = 0` ensures that uninitialized warehouse records are properly set up.

## Field/Variable Mapping

- **nrlxpfr**: Relex import (fields: `nrfirm`, `nrlage`, `nrvare`, `nrnmin`, `nrnmax`, `nrkabc`)
- **vvarl1r**: Item master (fields: `vvvare`, `vvudat`)
- **vlagl1r/vlaglur**: Warehouse master (fields: `vlvare`, `vllage`, `vlvtyp`, `vlstda`, `vlmini`, `vlmaks`, `vlkabc`, `vlbmin`, `vludat`, `vledat`, `vletim`, `vleusr`)

## Interaction with Other Modules

- This program is intended to be run after importing data from Relex.
- It is expected that other processes populate `nrlxpfr` and that downstream processes rely on the updated warehouse records in `vlaglur`.

## Error Handling & Skips

- If the item or warehouse record is not found, or if the record does not meet update criteria, the program skips to the next item without logging or error reporting. This is a convention in this codebase for batch update programs.

## Version History

- **Initial Version:** 2003-07-11 (HKO)
- **Adaptation for v6.20:** 2009-04-12
- **Special Handling Implemented:** 2021-01-19 (BSA, 7.01)

## Summary

This program is a batch updater for synchronizing min/max/ABC codes in the warehouse register based on Relex input, with careful business rule checks to avoid unnecessary or incorrect updates. It uses a rigid keying and file access convention, and implements special business logic for date and initialization scenarios.