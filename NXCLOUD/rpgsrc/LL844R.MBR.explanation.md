```markdown
# RPG Program Explanation: ASLAGR / LL844R

## Overview

This RPG program (`LL844R`) is designed to delete inventory records ("lagerposter") from an inventory register. It provides flexibility to delete all records, or records matching specific criteria, relating to which items (`vare`) and warehouses (`lager`) to target, based on parameters passed in.

All comments and variable names are in Norwegian, but the logic is fairly straightforward for RPG developers.

---

## File Declarations

```rpg
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
```

- **vlagl1r**: Main inventory register file, keyed access.
- **vvarl1r**: Item master file, keyed access.
- **vlaglur**: Used for updating/deleting inventory records.

---

## Data Structures

### Parameters

```rpg
d                 ds
d d_prec                        64
d  d_val1                        1  0 overlay(d_prec)
d  d_val2                        1  0 overlay(d_prec:2)
d  d_val3                        1  0 overlay(d_prec:3)
d  d_val4                        1  0 overlay(d_prec:4)
d  d_lage                        2  0 overlay(d_prec:5)
```

- Input parameters are passed as a 64-byte string (`d_prec`) then overlaid as:
  - `d_val1`, `d_val2`, `d_val3`, `d_val4`: Control flags (presumably 1 = on).
  - `d_lage`: Warehouse number (2 digits).

### Local Data Area

```rpg
d                uds
d l_firm                944    946  0
```
- The firm/company number is loaded from the user data space (positions 944-946).

### Key Variables and Work Fields

Variables are defined for use as keys and for working storage. For example:
- `vlagl1_lage`, `vlagl1_vare`, etc., are used to build keys for file access.

---

## Program Flow

### Entry and Initialization

- The `*entry` parameter list receives one parameter (`w_parm`), the 64-byte control string.
- The program overlays this into its parameter data structure.
- Local variable `w_firm` is set from the user data area `l_firm` (the current firm number).
- Key lists are defined for each file.

---

### Main Deletion Logic

The main logic involves iterating over inventory records and, depending on the parameter flags, deleting certain records.

#### Precondition Check

```rpg
c if d_val1 <> 1 and d_val2 <> 1 and d_val3 <> 1
c    goto end_pgm
c endif
```
- If _none_ of the delete options are set (`d_val1`, `d_val2`, `d_val3`), the program ends immediately.

#### Initial Key Setup

```rpg
c eval vlagl1_vare = *blank
c eval vlagl1_lage = d_lage
c vlagl1_key setll vlagl1r
```
- Build key for inventory (`vlagl1r`) and set the file pointer.

#### Read Inventory Loop

```rpg
c read vlagl1r 90
c dow *in90 = *off
  ...
c enddo
```
- Loop through all records in the inventory file for the given warehouse.

#### Inside the Loop

For each record:

1. **Check Firm**  
   If the record does not belong to the current firm, exit the program.

2. **Check Warehouse**  
   If the record's warehouse (`vllage`) does not match the parameter (`vlagl1_lage`), skip to the next.

3. **Delete All**  
   If `d_val3 = 1`, delete the record (unconditional delete).

4. **Delete if not Type 'L'**  
   If `d_val1 = 1`, check if the item type in the item master is NOT 'L'. If so, delete.

5. **Delete if No Item Master Record**  
   If `d_val2 = 1`, check if there is _no_ corresponding item in the item master. If so, delete.

6. **Next Record**  
   If none of the above, move to the next record.

#### Delete Operation

```rpg
c slett_post tag
c eval vlaglu_vare = vlvare
c eval vlaglu_lage = vllage
c vlaglu_key chain vlaglu 94
c if *in94 = *off
c   delete vlaglur
c endif
```
- Deletes the inventory record from the update file. Only deletes if the key is found (to avoid errors).

#### Program Exit

```rpg
c end_pgm tag
c eval *inlr = *on
c return
```
- Standard RPG exit. *INLR ensures program cleanup.

---

## Subroutines

### *INZSR (Initialization)

- Define key lists for item master and inventory files.
- Entry parameters are loaded and parsed.
- Sets up the firm number for use in keying.

---

## Flags/Parameters Recap

- **d_val1**: Delete records for items that are _not_ of type 'L'.
- **d_val2**: Delete records for items _not_ in the item master.
- **d_val3**: Delete _all_ records in the specified warehouse.
- **d_lage**: Warehouse number to process.

---

## Summary

This program processes inventory records for a given company/firm and warehouse, and deletes records according to flags set by parameters:

- Delete all, or;
- Delete only items not of type 'L', or;
- Delete records for items not in the item master.

It uses typical RPG file access patterns and key lists. Deletion is careful to check keys before removing records.

---

### Typical Use Case

- Another program prepares a parameter block, specifying the desired deletion mode and warehouse.
- This program is called, deletes the appropriate inventory records, and exits.

---

## Notes

- All data access is keyed by `firm` and either `item` or `warehouse`.
- Error handling is minimalâ€”assumes valid keys and existence of records.
- Comments are in Norwegian, but the logic is expressed clearly with variable naming aligning with business entities.
```
