# GL114R â€“ Maintenance of Agreement Register (Avtaleregister)

## Overview

This program is part of the ASOKON system and is responsible for maintaining the "avtaleregister" (agreement register) for companies, including operations such as viewing, creating, updating, and deleting agreements. It supports multiple bank accounts per company, handling of zones, general ledger accounts, location descriptions, and more.

The code is written in RPG III/IV and makes extensive use of subfiles and indicators for interactive display file processing. It interacts with several physical files, primarily for storing and retrieving agreement data.

---

## Key Functional Areas

### 1. **Interactive Workstation and Subfiles**

- **Display File**: `GL114D` is defined as a `WORKSTN` device with subfile support (`sfile(d1wsf:srrn01)`).
- **Subfile Handling**: The main subfile is used to present and select agreements for maintenance. Paging, roll, and record selection are handled via standard subfile patterns.

### 2. **Physical Files**

- **GAVTL1**: Main agreement file (UF, keyed, renamed to `gavtpf1`).
- **GAVTL2**: Agreement file for subfile listing (IF, keyed, renamed to `gavtpf2`).
- **GAVTL3**: Additional agreement file, likely for alternate account types (IF, keyed, renamed to `gavtpf3`).

### 3. **Domain Model and Data Structures**

- **Company and Agreement Keys**: Agreements are keyed by file group (`filg`), company number (`firm`), and bank account numbers (`bgir`, `pgir`).
- **Date Handling**: Dates are managed via data structures for easy conversion between formats (YYYYMMDD and DDMMYYYY overlays).
- **Zone and Account Info**: Support for zone codes (`skod`), zone accounts (`skto`), locations (`slok`), and general ledger accounts (`hkon`, `avde`, `spes`).

### 4. **Screen Layouts and Windows**

- Multiple windows/screens are referenced:
    - `A1WIN`: Agreement details
    - `A2WIN`: Bank type selection
    - `D1WSF`: Subfile record
    - `D2WCT`: Subfile control record
    - `D2CMD`: Command key window

### 5. **Indicator Usage**

- The program relies heavily on indicators for flow control and UI state, following internal conventions:
    - F3 (KC): Exit
    - F5 (KE): Refresh
    - F12 (KL): Cancel
    - 10-16: Subfile events (roll, display, clear, end, readc)
    - 40-42: Agreement maintenance modes (view, delete, edit)
    - 60-69: File operation status
    - 70-99: Work/utility indicators for subroutines and error states

---

## Main Processing Flow

### **Initialization (`*INZSR`)**

- Sets up working fields and subfile state.
- Prepares key lists for primary file access.
- Loads the subfile with existing agreements for the current file group and company.

### **Main Loop (`B2CTL` Section)**

- Handles user actions via function keys and subfile selection:
    - **F3**: Exit program.
    - **F5**: Refresh subfile and clear selection fields.
    - **Roll (10)**: Page through subfile.
    - **Selection**: If a subfile row is selected for edit/view/delete, launches the appropriate maintenance window.
    - **Create New**: If the user initiates a new agreement, launches the create window with blank/default values.

### **Agreement Maintenance**

- **Create (`xb2bld`)**:
    - Presents the create window.
    - Validates required fields (file group, bank, giro number, zone info, etc.).
    - Checks for duplicate bank/postgiro numbers.
    - Writes new agreement or updates an existing one.
    - Sets a flag to refresh the subfile on return.

- **Edit/View/Delete (`xb1bld`)**:
    - Loads selected agreement details.
    - Sets mode indicators (edit/view/delete).
    - Presents the maintenance window.
    - For delete, removes the record and clears related fields.
    - For edit, validates and updates the record as in create.
    - Sets a flag to refresh the subfile on return.

### **Subfile Management**

- **Clear (`xclr01`)**: Empties the subfile and resets control fields.
- **Fill (`xcrt01`)**: Reads agreement records from `gavtl2` and populates the subfile.
- **Display (`xdsp01`)**: Handles subfile display and control record formatting.

---

## Business Rules and Validations

- **Multiple Bank Accounts**: Each company can have several agreements with different bank accounts.
- **Zone Logic**: If zone-related fields are populated, corresponding codes and accounts must be present and consistent.
- **Bank Validation**: Only specific bank codes are accepted (e.g., DNB, FOK, KBA, etc.).
- **Uniqueness**: Bank and postgiro numbers must be unique within the file group/company context.
- **Field Requirements**: Key fields (file group, bank, giro number, zone info) are mandatory for creating/updating agreements.

---

## Notable Design and Coding Conventions

- **Indicator-Driven UI**: The program uses a strict indicator mapping for all UI and file operations, which is a local convention. This mapping is documented in the code comments and should be followed for consistency.
- **Subfile Paging**: The subfile supports paging and selective refresh, controlled via the `spge01`, `srrn01`, `ssrn01` fields.
- **Data Overlays**: Dates are handled via overlays to facilitate format conversion for both storage and display.
- **Versioning and Change Management**: The code is annotated with version and change history, and business changes are clearly marked (e.g., 20120, 08110, 17123).
- **Field Naming**: Field suffixes (`nn`) correspond to subfile or window contexts, and field names are often abbreviated to save space.

---

## Integration Points

- **Files**:
    - `GAVTL1`/`GAVTL2`/`GAVTL3`: Central agreement data, accessed for all CRUD operations.
- **Display Files**:
    - `GL114D`: Must be kept in sync with code regarding field names and record formats.
- **Other Modules**:
    - This program is standalone for agreement maintenance but may be called from higher-level menu systems or integrated into workflows for company/account management.

---

## Special Considerations

- **GUI Adaptation**: Some code is commented out or marked for special handling in GUI contexts (see `7.xx` comments). The DDS must match these expectations.
- **Field Hiding**: Certain fields (general ledger, department, special account) are hidden or disabled in some versions, as per change 17123.
- **Error Handling**: Error states are indicated via specific indicators and are shown on the UI, following the documented mapping.

---

## Summary

GL114R is a robust, indicator-driven RPG program for interactive maintenance of company agreement records, supporting complex business rules around bank accounts, zones, and account structures. Its design is modular, with clear separation between subfile management, data validation, and CRUD operations, and it adheres to local conventions for indicator and field usage. Any enhancements or maintenance should respect these patterns to ensure consistency and maintainability.