# Explanation of the IBM ILE RPG Program `LO940R`  
## Purpose

This program is for **printing incoming invoices ("Utskrift av Inngående faktura")**. It supports both classic spool file output *and* XML/PDF generation (via JasperReports). There’s also functionality for archiving, emailing, and integration with other systems.

---

## 1. **Header Specifications**

- **Control Options (`H`/`6.30 h`):**
  - `option(*nodebugio)` — No debug for I/O operations.
  - `datedit(*dmy.)` — Default date edit code is day/month/year.
  - `decedit('0.')` — Decimal edit.
  - `DftActgrp(*No)` — Do not use default activation group (necessary for binding directories).
  - `BndDir('CGIDEV2/CGIDEV2')` — Uses the CGIDEV2 binding directory (for web/IFS functions).
- **Copy Directives**: `/copy hspecsbnd` — Includes external definitions (likely prototypes/structures).
- **Comments/History**: Extensive change log with versioning.

---

## 2. **File Definitions**

- **Physical Files**
  - **Example:** `FLSTSL1    IF   E           K DISK    RENAME(LSTSPFR:LSTSL1R)`
  - All files are input (`I`), keyed (`K`), external (`E`), and some are renamed at compile time.
- **Printer File**
  - `FLO940P    O    E             PRINTER`
- Files include master data, transaction data, details, and cross-reference files.

---

## 3. **Data Structures**

- **Various Data Structures (`D DS`) define field groupings for:**
  - *KID-feltet*: Customer reference for payments.
  - *Parameter input*: Program input parameters.
  - *Foretaksnummer*: Company registration fields.
  - *LDA*: Data area fields (local data area imports *session/job context* like user, print queue, batch number, etc).

---

## 4. **Variables**

- **Working variables** (`d w_*`) for temporary calculations, control, and storing intermediate values.
- **PDF/Archive/Email flags** (`b_pdfp, b_samf, b_orde, b_topt, b_bott, l_arch`, etc.)
- **XML/Jasper variables** for integration with external reporting engine.

---

## 5. **Prototypes and APIs**

- `/copy prototypeb`, `/copy usec` — Bring in API prototypes (like HTML/XML generation, possibly CGIDEV2 routines).

---

## 6. **Mainline Logic**

### Initialization

- **Initial setup with SQL** for date format.
- **Initial subroutine call:** `XSTRSR` — Sets up keys, reads starting records, initializes variables.

---

### Main Processing Loop

- **Nested Control Flow** over the invoice headers and details:
  - **HTAG01**: Process order head.
    - Checks for end-of-file, data validity.
    - Calls subroutines to handle headers (`XHODE1` or `XHODE2`), based on changes between records.
    - Locates related detail records.
  - **VTAG01**: Process invoice lines (detail).
    - Loops through all detail lines for current invoice/order.
    - Calls subroutine `XVARE1` for each line.

---

### Subroutines

#### XHODE1/XHODE2

- **Handles writing header information:**
  - For new invoices, closes out the previous PDF/Batch if enabled.
  - Retrieves and prints/writes company, customer, and delivery info.
  - Integrates with PDF/Jasper/XML output if enabled.

#### XVARE1

- **Handles writing detail lines:**
  - Resets variables for a line.
  - Looks up line/product types, product info, and checks if printed on this order type.
  - Calculates amount, price, discount, and other values.
  - Writes to the output (print or XML), including accumulators for totals.

#### XORRAB / XTOTAL

- **Subtotal and total calculations** (order discount, tax base, VAT, net amount).
- Writes "total" records/sections in the output, and handles differences for special invoice types.

#### XOVRFL

- **Handles page overflow logic** for print layouts.

#### XSTRSR

- **Setup routine**:
  - Initializes keys, reads first records, loads company info, sets up for possible PDF/XML output, and logs actions.

#### XML/Jasper Integration
- Numerous subroutines for building/updating XML sections (company info, department, partner, project, order lines, totals, etc.) using routines like `UpdHTMLVar`, `WrtSection`.
- Handles character translation for XML compliance via AP613R.

#### proa_nummer

- **Gets the next batch number** (used for file naming/PDF identification).

#### *INZSR

- **Program initialization routine**
  - Defines field mappings, clears fields, and sets initial state.

---

### Parameter Passing

- **Parameters from the calling program** are received using a 34-byte parameter block and unpacked into specific working fields.

---

## 7. **XML/PDF Handling**

- **If PDF/XML output is enabled:**
  - Multiple routines manage opening, populating, and closing XML sections for JasperReports integration.
  - After all records processed, writes the XML file to IFS (integrated file system).
  - For archive situations, writes meta-tags, display tags, and reference keys for archive system integration.
  - Optionally, sends a notification to a data queue to trigger further processes (Java sniffer, etc).
  - Optionally launches a browser for PDF preview (`pdf_preview` subroutine calls AP621R).

---

## 8. **Email Handling**

- **If invoice is to be emailed:**
  - Calls FO798R to gather/calculate email data for the customer/order.
  - Sanitizes text fields for XML compliance.
  - Generates MailCommand sections in the XML file.

---

## 9. **Error Handling and Logging**

- **Throughout:** Calls AB705R for logging major steps or errors (start/stop, invalid output queue, etc).

---

## 10. **Special Notes**

- **Lots of logic toggles**: *IN indicators used for flow (e.g. *IN61, *IN62, *IN30 for overflow, etc).  
- Handles variable formats and versions (with many version-specific comments, e.g. 6.30, 6.31, etc).  
- **Support for both single and batch (samlefaktura) invoices**.
- **Multi-language handling**: Converts special characters for XML.
- **Extensive comments and explanations in Norwegian.**

---

## 11. **Key Points for Onboarding**

- **Output Target:** Either classic spool reports or modern PDF/XML via Jasper; which path depends on LDA/user settings.
- **Data Flow:** Master record (header) → Detail records → Totals → Output (repeat for each invoice/order).
- **Extension Points:** Integration with external programs (for email, numbering, batch processing, archiving).
- **Customization:** Multiple spots for company/customer-specific logic.
- **Error logging and job auditing** are built-in.

---

## 12. **Main Program Flow (Simplified)**

1. **Initialize:** Setup data, read parameters, prepare logging.
2. **For each invoice head:**
    - [If new] Close out previous XML/PDF if needed.
    - Prepare output header (print and/or XML).
    - For each invoice line:
        - Gather line info.
        - Print/write detail.
    - At break/new invoice:
        - Print/write totals.
3. **On completion:** Finalize logs, close output, archive if requested.

---

## 13. **External Dependencies**

- **CGIDEV2**: For writing files to IFS, generating XML/HTML, and web integration.
- **Various programs** for archiving, email, numbering, etc.
- **External database tables** (company/customer/items/orders/etc).

---

## 14. **What to Look For When Modifying**

- **Adding Fields**: You'll need to update not only the RPG, but also XML templates, field mappings, and possibly the Jasper report itself.
- **Output Format**: Check logic toggles (`b_pdfp`) to ensure new outputs are handled in both print & XML paths.
- **Integration Points**: Email, archiving, batch numbering are all handled by external programs. See API call sections.

---

# **Summary Table of Main Files & Variables**

| Object          | Type    | Purpose                                 |
|-----------------|---------|-----------------------------------------|
| SIHEL1          | File    | Invoice header                          |
| SIDTL1          | File    | Invoice details (lines)                 |
| RLEVL1          | File    | Supplier/customer register              |
| AFIRL1, AFORL1  | File    | Company/firm register                   |
| VVARL1, VOTYL1  | File    | Item/product & order type register      |
| FLO940P         | Printer | Print output                            |
| LDA-Fields      | DS      | Job/session context (user, print, ... ) |
| b_pdfp, b_samf  | Flag    | PDF/XML output flags                    |
| w_jkey, w_bach  | Key     | Batch/job identification                |

---

# **In Conclusion**

- **LO940R** is a complex, mainframe-style program that bridges old (spool) and new (PDF/XML/Jasper) output paradigms.
- It is **highly parameterized**, and **modularized** via subroutines and calls to many external programs.
- Mastery requires:
  - Understanding the *data model* (headers, details, company, customers, products, etc).
  - Familiarity with *CGIDEV2* and basic IFS/Jasper output concepts on IBM i.
  - Awareness of the dual-output path (spool vs. PDF/XML).
  - Attention to cross-platform details (`MOVE`/`MOVEL`/`EVAL` for variable translations, XML character compliance, etc).

---

**If you're onboarding:**  
- Start by tracing a single invoice through the process.
- Experiment with both output modes (spool file vs. PDF/XML).
- Use the comments (including those in Norwegian) as a guide to business logic.
- Pay attention to version-specific code if working with customizations or upgrades.

---

**For further details, you should consult:**  
- The referenced subprogram/prototype sources (`prototypeb`, `usec`).
- The JasperReports (XML) templates.
- Database file layouts (DDS).
- Any related CGIDEV2 custom subroutines.