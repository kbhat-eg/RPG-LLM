# RPG Program Overview and Walkthrough

## General Purpose

This program (`FP252R`) is designed for printing product labels based on selection and scanning from a radio terminal. Each scan triggers the handling and formatting of one item, pulling pricing, location, and EAN (barcode) info as needed, and writing results to an output file for label production.

## Main Structure

- **File Definitions**: Input (various master and transaction files) and Output (`etikett`).
- **Work Variables**: Extensive use of working storage (`w_`) variables to hold item, price, date, and barcode data.
- **Initialization**: Loads configuration and parameter values from the local data area and parameter file.
- **Main Routine (`beh_vare`)**: For each item/scan, finds the product info, retrieves price, prepares all fields, and writes the label.

---

## Core Steps Explained

### 1. Input Handling

- Input comes via an external parameter file with key fields: company code, item number, number of labels, etc.
- Item numbers from specific terminals may strip leading zeros; logic is present (see step 6.18) to normalize item numbers to 8 digits.

**Example:**  
```rpg
c                   eval      w_posi = %scan(' ':wpvare)
...
c                   if        w_posi = 8
c                   eval      d_vnri7 = %trim(%subst(wpvare:1:7))
c                   move      d_vnri7       w_vnru
c                   eval      wpvare =  w_vnru
...
```
This block pads item numbers with leading zeros if needed.

---

### 2. Product Retrieval & Validation

- `chain` into the product master (`vvarl1r`) using the normalized item.
- If not found, jumps to exit.
- Some legacy logic to skip non-label items is commented out.

---

### 3. Price Lookup (`hent_pris` subroutine)

- Calls program `VP716R` to fetch price info for up to three units/enh (main, alt. unit, etc.), as well as effective dates, campaign info, and comparison prices.
- The `l_etpr` determines price source: none, normal, comparison, or campaign.
- Handles label date logic, eg. choosing price valid at a certain time.
- Sets flags to indicate which prices to print.

**Example snippet:**  
```rpg
c                   call      'VP716R'
c                   parm                    w_firm
c                   parm                    w_vare
c                   parm                    w_prgr
...
c                   if        w_dato >= w_fdat and
c                             w_dato <= w_tdat
...
```

---

### 4. Price Preparation (`klar_pris` subroutine)

- Determines which price(s) and unit(s) to show on the label.
- Handles specialty: campaign pricing, standard price, comparison price.
- Applies VAT to selected prices, using other programs for VAT rates (`FÃ˜705R` for normal, `FÃ˜706R` for reduced).
- Rounds prices as needed (via call to `FA910R`).
- Handles cases where the price is zero (flags to skip printing).

---

### 5. Label Field Preparation (`klar_rest` subroutine)

- Gets EAN/GTIN (barcode) from registry (`VE716R`), or reconstructs if missing (if enabled).
- Gets warehouse-specific data (location, outdate, supplier data) via `VL710R`.
- Fetches price code text for display purposes.
- Normalizes text fields, swaps special chars.
- Loads ordering quantities from warehouse records, with bounds checking.
- Applies sort logic for output.
- Updates last-printed info in label registry (`VETIPF`), setting dates and GTIN, or writes a new record if not present.

---

### 6. EAN Check Digit Calculation (`eansjk` subroutine)

- Implements Mod10 (EAN/UPC) check digit calculation if needed, for barcodes constructed manually.

---

### 7. Initialization (`*inzsr` subroutine)

- Initializes all keys, loads company code and other config from parameter/local data area.
- Loads label/price display flags.
- Calls to set up group codes, default price units, etc.

---

### 8. Output

- The `except skriv` operation writes all collected and formatted data to the output file `etikett`.
- Output fields are positioned for downstream printing systems, and include all required label data: product number, barcodes, text, price(s), units, location, and so forth.

---

## Important Highlights

- **Versioned/Commented**: This program is well-maintained, with extensive version history in comments.
- **External Dependencies**: Calls out to several other RPG programs for price, VAT, and registry retrieval.
- **Label-Type Flexibility**: Handles different label types and pricing schemes, including campaign/comparison pricing.
- **Warehouse-Specific Info**: Fetches warehouse-specific product info, eg. outdate, location, and supplier info.
- **Robust Data Normalization**: Handles leading zeroes, text translation, bounds checking of numerics, and defaulting if values are missing.
- **Update/Insert Logic**: Updates or writes last-printed details for traceability.

---

## Onboarding Notes

- **Key Fields**: Company code (`firm`), item number (`vare`), and warehouse (`lage`) are critical throughout logic and key for all file access.
- **Main Entry Point**: Execution starts with label parameter input, then processes one item at a time via `exsr beh_vare`.
- **Debugging**: Test with different label types and item numbers, especially those with campaign prices or missing EANs, to see all code paths.
- **Maintenance**: Review all called programs (`VP716R`, `VL710R`, `VE716R`, etc.) when changing label or pricing logic.
- **Files**: Familiarize yourself with the file formats, especially `vetil1`/`vetilu` (label registry), `vvarl1` (product master), `vlagl1` (warehouse info), etc.

---

## Summary Flow

1. **Read/normalize item from input**
2. **Chain to product file for details**
3. **Retrieve price(s), date-range, campaign as needed**
4. **Prepare prices: VAT, rounding, units, flags**
5. **Gather barcode, warehouse, supplier, and other details**
6. **Write formatted record to output label file**
7. **Update label registry with print details**

---

**This program is a well-structured, mature RPG solution for legacy IBM i-series label printing with a strong focus on correctness, traceability, and configurability for different product and pricing situations.**