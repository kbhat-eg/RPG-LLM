# ILE RPG Program FM110R Explanation

This RPG program, **FM110R**, is a maintenance program for invoice types (fakturatype), with functionality primarily focused on viewing, creating, updating, copying, and deleting invoice type records. The program is written using traditional (fixed-format) RPG IV and runs on IBM i (AS/400). Below, the code structure and the key elements are explained.

---

## 1. **Header & Documentation Section**
- **Options:** `option(*nodebugio)` disables debug I/O; `datedit(*dmy)` sets the date editing format to day/month/year.
- **Change Log:** Contains history of changes with references, dates, and brief descriptions (in Norwegian).
- **Indicator Usage:** Shows how numbered indicators (e.g., *IN10, *IN14, etc.) are used for controlling program flow, subfile display, errors, etc.
- **Screen Layouts:** Names special display records (subfiles, window overlays for copying/deleting, control records, etc.)

---

## 2. **File Declarations**

```rpg
ffmftl1    if   e           k disk    rename(fmftpfr:fmftl1r)
ffmftlr    if   e           k disk    rename(fmftpfr:fmftlrr)
ffmftlu    uf a e           k disk    rename(fmftpfr:fmftlur)
ffm110d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **fmftl1/fmftlr/fmftlu:** Three database files for invoice type master, read access (for subfile population), record-level access, update/delete.
- **fm110d:** Display file containing several screens and a subfile (b1sfl).

---

## 3. **Data Areas & Data Structures**

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```

- Area for user (l_user), firm number (l_firm), and possibly user's name (l_fnav), mapped from the user data area (UDS).
- **dspfbk:** Display feedback data structure, e.g., for current cursor position.

---

## 4. **Working Variables / Key Fields**

Used for:
- **Subfile handling:** Counting lines, tracking first/last record numbers per page, current record, etc.
- **Control flags:** e.g., b_forn (refresh), b_oppr (create), b_anul (cancel), b_feil (error), b_subf (subfile update).
- **Keys:** Variables for invoice type keys in various file accesses.
- **Constants:** E.g., c_sfil (subfile page size).

---

## 5. **Program Flow Outline (Main Logic)**

The main logic demonstrates a typical subfile maintenance program structure:

### A. **Main Program Loop**
- Display opening screen or subfile (`write b2cmd`, `exsr dsp_subfile`)
- **Function Key Handling:** Using a SELECT group for operations like:
    - F3/F12 (exit)
    - F5 (refresh)
    - F6 (create new)
    - Page up/down
    - Home key, cursor relocation
- **Positioning:** If positioning entered, call subroutine to move to the correct record.
- **Subfile Processing:** Processes user actions on subfile rows (update, copy, delete, view).

### B. **Subroutine Breakdown**

#### a) **forny** – Refreshes the subfile
- Sets file pointer
- Clears and recreates the subfile

#### b) **posisjoner** – Handles positioning in the subfile to a specific invoice type
- Sets file pointer to key (if requested)
- Clears and refills subfile based on position

#### c) **subfile** – Handles processing of subfile rows
- Iterates through visible subfile entries using `readc`
- Based on a chosen operation on the row (b1valg): 
    - 2: Update
    - 3: Copy
    - 4: Delete
    - 5: View only

#### d) **xc1bld / xc1msg** – Handles entry of a new key (invoice type), and if already exists, prompts a message.

#### e) **xc2bld** – Handles the entry/edit/view of main invoice type data.

#### f) **xd1win / xk1win** – Handles delete and copy popup overlays respectively.

#### g) **clr_subfile / crt_subfile / dsp_subfile**
- **clr_subfile:** Clears subfile (records and indicators)
- **crt_subfile:** Refills subfile with next 'page' of records from the database (with company filtering)
- **dsp_subfile:** Controls the display of the subfile on the screen

#### h) **Initialization – *inzsr**
- Defines keys for SETLL/CHAIN/UPDATE
- Retrieves current company from LDA
- Fills initial subfile page

---

## 6. **Subfile Control**

- **w_srrn, w_stel, w_spge, w_ssrn, w_sfrn:** Variables to manage pagination and record numbers in the subfile.
- **c_sfil:** Number of records per subfile page.
- **b1sfl:** Subfile record format; user can select row via b1valg (which operation to perform).

---

## 7. **File Handling Examples**

- **SETLL**: Positions the DB cursor to the start of a company’s invoice types.
- **READ**: Sequentially reads records to populate the subfile.
- **CHAIN**: Random access (for update/delete/view).
- **UPDATE/WRITE/DELETE**: Update, create, remove records as required.

---

## 8. **Function Keys and Indicators**

- Function keys are mapped to indicator numbers (e.g., F3 = *INKC, F12 = *INKL, etc.).
- Indicators 30–99 are used for controlling display, field protection, and error messages, as well as working flags.

---

## 9. **Error Handling & Messages**

- Attempts to add a duplicate key launch an informational message screen (xc1msg).
- Input validation ensures required fields are entered before processing.
- Special indicators are set ON to trigger error messages or field protection on the screen.

---

## 10. **Screens and Windows Used**

- **B1SFL:** Main subfile for listing invoice types.
- **B2CTL/B2CMD:** Control screens for subfile and command keys.
- **C1BLD/C1MSG:** Entry/validation screens for key values.
- **C2BLD:** Main screen for entry/maintenance of details.
- **D1WIN/K1WIN:** Windows for delete/copy confirmations.

---

# Conclusion

**FM110R** is a typical IBM i legacy green-screen maintenance program for invoice types that leverages subfiles for display and manipulation of record sets, with robust support for CRUD operations, record locking, and error handling, all tightly integrated with the display file (DSPF) and the database (physical files). The code utilizes RPG's indicator-based UI logic and subroutines for modularity, making it easier to follow each step of the workflow.

**This program is a good example of 'classic' maintenance patterns on IBM i, using subfiles, user data area integration, and comprehensive error handling and validation.**