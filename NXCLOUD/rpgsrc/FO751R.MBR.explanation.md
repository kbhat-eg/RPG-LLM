# RPG Program FO751R – Explanation

## Overview

This RPG/ILE program, named **FO751R**, is designed for the IBM i (AS/400) platform. Its main function is to display prices from offers that are less than 6 months old and have not been converted to special prices. Offers that have expired are not shown unless filtered specifically.

The program uses a subfile (multi-record display in 5250 terminals) to list and manage such offers. The interface supports various navigation, filtering, and selection operations.

## Structure and Main Elements

### 1. Control Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debug I/O for performance.
- Sets default date edit to day/month/year.

### 2. File Declarations

```rpg
fvvarlr    if   e           k disk    rename(vvarpfr:vvarlrr)
ffodtlr    if   e           k disk    rename(fodtpfr:fodtlrr)
ffohelr    if   e           k disk    rename(fohepfr:fohelrr)
frkunlr    if   e           k disk    rename(rkunpfr:rkunlrr)
fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
fFO751d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Declares logical files (physical files with alternate access paths) for products (vvarlr), offer lines (fodtlr), offer headers (fohelr), customers (rkunlr), and an extra assortment file (vvlel1).
- Main display file (**FO751d**) is a workstation file with subfile support. `infds` is used for display feedback.

### 3. Parameter and Data Structure Definitions

```rpg
d p_firm          s                   like(fofirm)
d p_numm          s                   like(fonumm)
...
d dspfbk          ds
d  d_fcrn               378    379I 0
...
d w_firm          s                   like(fofirm)
d w_kund          s                   like(fokund)
d w_vare          s                   like(fdvare)
...
```
- Defines program parameters (company, offer number, customer, item, prices, discounts, unit).
- Various working variables for navigation, subfile handling, key lists for file lookups, and constants.
- **dspfbk** data structure is for display feedback (cursor location etc.).

### 4. Indicator Usage

Commented block lists indicator usages:
- *LR*: End program
- 10–15, 21–22, 30–99: Used for roll keys, function keys, subfile controls, cursor placement, error messages, etc.

### 5. Mainline Logic

#### Initialization Subroutine (`*inzsr`)
- Receives program parameters.
- Prepares keys for file lookups and loads product and customer information into screen fields.
- Sets default values/flags and loads the subfile with matching offers by calling `crt_subfile`.

#### Display/Function Loop

The mainline uses a loop structure with tags (e.g., `b2taga`, `b2tagb`) to:
- Display available function keys and handle user input.
- Exits program on specific keys (*inkc, *inkl = F3/F12).
- Supports filter/window popups (*inka = F10), refresh (F5/*inke), pagination (F10/*in10), and navigation (F11, etc.).

#### Subroutines

- **forny**: Refreshes the subfile based on current context.
- **subfile**: Reads the current subfile records, processes user action per row (select, view details), and updates flags.
- **clr_subfile**: Clears the subfile's current contents and resets counters.
- **crt_subfile**: Fills up the subfile with matching offers using embedded SQL, applying all business/filter rules. It handles:
    - 6 month window.
    - Only offers not converted to special prices.
    - Excludes item types T or D.
    - Pagination and record counting.
- **bck_subfile**: Handles paging back in the subfile.
- **dsp_subfile**: Handles displaying the control record (subfile header/footer).
- **xh1win**: Filter window for advanced filtering.

#### Embedded SQL

- Used for efficient selection and filtering of offer lines.
- The cursor `sok` is declared and opened when a subfile search is needed.
- Offer lines and headers are joined and filtered by company, item, customer, status codes, and absence from the special price table.
- Results are ordered by booking date, descending (most recent first).

### 6. Business Rules

- Only offers less than 6 months old, not converted to special prices, and not expired (unless filtered) are shown.
- Offers for item types "T" (presumably "Timber") or "D" are excluded.
- Navigation and selection handled via subfile interaction, with selection updating global variables to be used by the calling program.

### 7. Comments and Versioning

The top of the program includes detailed comments in Norwegian, indicating program purpose, changes (including date and author), and indicator usage.

### 8. Programming Style

- The code uses **tag/goto** structures for workflow, which is typical in older RPG code.
- Subroutines (`begsr`/`endsr`) are heavily used for logical grouping.
- There is a blend of native RPG file I/O (CHAIN, SETLL, etc.) and embedded SQL for data selection.

---

## Summary Table

| Section         | Purpose                                                          |
|-----------------|------------------------------------------------------------------|
| File Decls      | Maps physical/logical files for offer data, customer, items, etc.|
| Parameters      | Receives company/item/price/etc. info from caller                |
| Data Areas      | Defines variables for subfile control, screen, and SQL results   |
| Mainline        | Initializes, enters main function loop, processes input/actions  |
| Subroutines     | Handles subfile operations, clearing, filling, navigation        |
| Embedded SQL    | Efficiently selects the offers to display in subfile             |
| Comments        | Thoroughly explains field usage, business logic, and history     |

---

## Key Takeaways for Onboarding

- The program’s primary interface is a **subfile listing of offers**, with robust navigation/filtering.
- **Embedded SQL** is used for offer selection, which helps performance and business rule application.
- Main data comes from "offer header" and "offer detail" tables, joined and filtered.
- Navigation, selection, and paging through the subfile is controlled by indicators and variables.
- Business logic: only active, recent, and valid (per many rules) offers are shown.
- The program is called with parameters, and returns selection(s) via updated variables.

---

If you are onboarding to maintain or enhance this program:
- **Start with the initialization logic** to understand parameters and initial data flow.
- **Study the subfile creation subroutine** (`crt_subfile`) and embedded SQL to understand offer filtering logic.
- **Review the subfile navigation logic** for paging and selection.
- **Use the comments extensively**—they document indicator usage, business rules, and version history in detail.
- If you need to change what offers appear, **focus on the embedded SQL and subfile filling logic**.

---

Let me know if you need deeper dives into specific sections, RPG syntax, or business logic!