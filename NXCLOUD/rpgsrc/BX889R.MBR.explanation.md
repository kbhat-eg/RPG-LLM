# RPG Program BX889R â€“ Explanation

This RPG (ILE RPG/400) program is designed to update an invoice type field (`bofaty`) on "bonghode" (receipt header) records based on information from a customer master file. The logic also adds audit-trail info (date, time, user). Below, each section and its purpose are explained in detail.

---

## Header and Comments

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **option(*nodebugio)**: Disables some debugging capabilities, likely for performance.
- **datedit(*dmy)**: Sets default date handling to day/month/year.

The comments in Norwegian give metadata: program name, description, author, changes, etc.

---

## File Declarations

```rpg
fbohelu    uf   e           k disk    rename(bohepfr:bohelur)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
```
- **bohelu**: Update-capable physical file, used to read/update receipt header records. Renamed in program as `bohelur`.
- **rkunl1**: Input file for customer master data, renamed as `rkunl1r`.

---

## Standalone Fields

```rpg
d rkunl1_firm     s                   like(rkfirm)
d rkunl1_kund     s                   like(rkkund)
```
- Local fields to store keys for the customer master file (likely company and customer number).
- Types are matched to those in the record format.

---

## User Info from Local Data Area

```rpg
6.10 d                uds
6.10 d l_user                911    920
```
- `uds` specifies a User Data Structure mapped to the local data area (LDA), which is a fixed area for passing data to jobs.
- `l_user` references bytes 911-920 of the LDA, presumably where the user ID is stored.

---

## Main Processing Loop

### Read Receipts

```rpg
c                   read      bohelur
c                   dow       not %eof
```
- Reads the first receipt header record, loops until end of file.

### Prepare Customer Key

```rpg
c                   eval      rkunl1_firm = bofirm
c                   eval      rkunl1_kund = bokund
c     rkunl1_key    chain     rkunl1                             60
```
- Transfer company/customer info from the receipt record into local fields.
- Use the composite key `rkunl1_key` to search (`chain`) for the customer record. Indicator 60 signals if not found.

### If Customer Found and Type Exists

```rpg
c                   if        %found(rkunl1) and
c                             rkfaty <> 0
c                   eval      bofaty = rkfaty
```
- If the correct customer is found and the customer's invoice type (`rkfaty`) is not zero, set the receipt's invoice type (`bofaty`) to this value.

### Set Audit Info and Update

```rpg
6.10 c                   time                    boedat
6.10 c                   time                    boetim
6.10 c                   eval      boeusr = l_user
c                   update    bohelur
c                   endif
```
- Updates `boedat`, `boetim`, `boeusr` with current time/date and the user from the LDA.
- Updates the current receipt header in the file.

### Read Next Record

```rpg
c                   read      bohelur
c                   enddo
```
- Reads the next receipt header and repeats the process.

---

## Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- `avslutt` is a tag (for potential goto/branching, though not used here).
- Sets last record indicator to on, so program cleans up file buffers, then returns (ends program).

---

## Subroutine: *INZSR (Initialization)

```rpg
c     *inzsr        begsr
c     rkunl1_key    klist
c                   kfld                    rkunl1_firm
c                   kfld                    rkunl1_kund
c                   endsr
```
- Defines a key list (`klist`) for use in keyed file access to `rkunl1`.
- The keys are `rkunl1_firm` and `rkunl1_kund` (company and customer).
- *INZSR runs automatically at program start, so the key structure is ready for use in `chain` operations.

---

## Summary of Logic Flow

1. **Initialization**: Set up key lists.
2. **Main Loop**: For each receipt header:
    - Find the associated customer record.
    - If the customer exists and has an invoice type, transfer that to the receipt header.
    - Add audit info: date, time, and user.
    - Update the receipt header.
3. **Exit**: End program, release resources.

---

## Key Fields and Terms

- **bofaty**: Invoice type on receipt header.
- **rkfaty**: Invoice type from customer master.
- **boedat, boetim, boeusr**: Fields for date, time, and user of last change.
- **bofirm, bokund**: Firm and customer number on receipt.
- **rkunl1_firm, rkunl1_kund**: Same fields, used for building the lookup key to the customer master.

---

## Use Case

This program ensures that all receipt headers have the correct invoice type according to the customer's current master data, and it maintains a record of who and when did the update for traceability (audit purposes).

---

### Change History

- **240108 (Jan 8, 2024) bof**: New program created.
- **6.10 110909 (Sep 9, 2011) BSA**: Audit logging added (date, time, user info).

---

This code is a classic example of simple batch-processing on IBM i (AS/400) systems, aligning transaction data with master data and recording actions for traceability.