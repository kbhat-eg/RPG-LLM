# RPG Program LL761R Explanation

This RPG (ILE RPG/400, "Fixed Format") program is for managing inventory records in an IBM i environment. Specifically, it handles the creation of a new item in inventory for a given warehouse, ensuring all relevant files are updated, and obsolete records are deleted. The comments and code are in Norwegian, so some field names are Norwegian abbreviations; explanations are given in English.

---

## **1. File Declarations**

Each line starting with `f` declares a file for disk access, with optional RENAME clauses specifying record format names used in logic. These are usually logical or physical files relating to inventory and item master data.

Example:
```rpg
fvhislu    uf a e           k disk    rename(vhispfr:vhislur)
```
- `vhislur`: Historical inventory log (lagerbok).
- `vlagl1`, `vlaglu`: Inventory files (probably logical/physical).
- `fstsl1`: Status register file.
- `vvarl1`: Item master file.
- `ra10l1`: Possibly warehouse/stock codes (added in version 5.70).

---

## **2. Data Definitions**

**Local Data Area**
```rpg
d l_user                911    920
```
- `l_user`: Pulls user info from user data space.

**Parameters (passed from caller or command line to program)**
```rpg
d p_firm          s                   like(vhfirm)   // Company/firm code
d p_vare          s                   like(vhvare)   // Item number
d p_lage          s                   like(vhlage)   // Warehouse code (since version 5.70)
```

**Other Working Variables**
- Variables mirroring key fields for each access path.
- `w_firm`: Local copy of company code.
- `b_skaf`: Boolean, signals whether this is a "special order" (skaffevare) rather than regular stock.

---

## **3. Main Logic**

### **a. Initialization Phase**
Within `*inzsr` subroutine:
- Parameters are loaded into local variables.
- Key lists are defined for each access path.
- The date and time are captured for audit/history stamping.
- The main warehouse is fetched from the status register.
- It determines whether the item is a "skaffe" (special order) or "lager" (stock) item.

### **b. Main Program Flow**
1. **Historical Inventory Book Update:**  
   If the item is not a "skaffe"/special order, call `lagerbok` subroutine to log item creation to the historical inventory file.

2. **Delete Old Inventory Records:**  
   `slett_lager` subroutine loops over all inventory records for the item and warehouse, deleting them.

3. **Create New Inventory Record:**  
   `nytt_lager` subroutine writes a new (empty) inventory record for the item in the warehouse(s).

4. **Update Accumulators:**  
   Calls two external programs to update order and outstanding order accumulators:
   - `FO761R`: Order accumulators
   - `LA921R`: Outstanding order accumulators

5. **Exit:**  
   Sets last record indicator (`*INLR = *ON`) and returns control to the system.

---

## **4. Subroutines**

### **a. lagerbok**  
Logs the creation of a new item in the historical inventory log for the main warehouse.
- Populates various fields with user, date, time, and action description ("Opprettet" / Created).
- Writes a record to `vhislur`.

### **b. slett_lager**  
Deletes all inventory records for the item in the specified warehouse.
- Uses a loop to read all relevant records and delete them via the `vlaglur` file.

### **c. nytt_lager**  
Creates a new (empty) inventory record for the item in all applicable warehouses:
- Gets item master data (unit-of-measure, type).
- Loops over all warehouse codes (`ra10l1`).
- For each, if a record doesn't exist, it creates one with base data for the item.

---

## **5. Key Lists and Access Paths**

Key lists (`klist`) define the sort keys for accessing each file:
- For history, inventory, item master, status, etc.
- Use the local variable copies set during initialization.

---

## **6. Notes/Versioning**

- Comments throughout refer to version 5.70, indicating added support for item type on stock and handling of "skaffe" items.
- Extensive use of Norwegian field names: `vare` = item, `lager` = warehouse, `bruker` = user, etc.

---

## **7. High-level Workflow**

1. **Initialize**: Load parameters, set up keys, determine main warehouse, item type.
2. **If regular stock item, log creation in history.**
3. **Delete any old inventory records for this item/warehouse.**
4. **Create a new blank inventory record in all relevant warehouses.**
5. **Call external programs to update accumulators (orders, outstanding orders).**
6. **Finish.**

---

## **8. Typical Use Case**

- When a new item is to be stocked in a warehouse, run this program with the company, item, and warehouse code.
- The program ensures old records are removed, new ones are created, and all logs and accumulators are kept up-to-date for reporting and transaction integrity.

---

## **Additional Notes**

- This program assumes strict file/key layouts as is common in IBM i environments.
- All date, time, and user auditing is handled programmatically.
- File and record format renaming is used to maintain code clarity and flexibility when accessing multiple files with similar layouts.
- The code is fixed-format RPG IV, indicative of legacy AS/400 environments.

---

**Summary:**  
The program is a robust utility for onboarding a new inventory item into a warehouse, ensuring data integrity by removing obsolete records, accurately logging creation events, and synchronizing all relevant order-tracking data. Its modularity via subroutines allows for easy maintenance and future extension.