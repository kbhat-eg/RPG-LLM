# RPGLE Program Explanation: FR160R

---

## Purpose of Program

This program, named `FR160R`, is used to **remove product-level or group-level discounts from a discount matrix if the same discount** is already available for the same customer and product group at a higher (less specific) level. The intention is to avoid having redundant discounts defined at multiple levels.

The comments (in Norwegian) explain that it checks for and removes lower-level discounts if the same discount exists higher up in the hierarchy.

---

## Structure Overview

1. **File Declarations:**
   - `frablu`, `frablr`: Discount matrix physical and logical files.
   - `vvarl1`: Item master file.
   - `fr160d`: Display file (workstation for screen input/output).

2. **Data Definitions:**
   - Variables for records, keys, and discount terms.

3. **Main Processing Loop:**
   - Displays an opening screen.
   - Reads all discount records.
   - If the discount is at item level, checks if the same discount exists at a group level, and deletes the item-level discount if redundant.
   - If the discount is at the group level, checks similarly at a higher group level.

4. **Subroutines:**
   - `behandl_vare`: Item-level discount processing.
   - `behandl_vgrp`: Group-level discount processing.
   - `*inzsr`: Initialization, including LDA load and keylist setup.

---

## Detailed Step-by-Step Explanation

### 1. File Declarations

```rpg
ffrablu    uf   e           k disk    rename(frabpfr:frablur)
ffrablr    if   e           k disk    rename(frabpfr:frablrr)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
```

- Connects and renames database files:
  - `frablu` (discount matrix)
  - `frablr` (logical view for searching)
  - `vvarl1` (item master)

### 2. Data Definitions

- Variables are created to hold:
  - Keys for file access (`frablr_xxx`, `vvarl1_vare`)
  - Discount fields (`s_rab1`, `s_rab2`, ..., `s_ratt`)
  - Miscellaneous (`w_firm` for firm number, from LDA)

### 3. Mainline (Program Logic)

#### 3.1. Show Opening Screen

```rpg
exfmt     b1bld
```

- Displays screen and waits for user input.

#### 3.2. Handle Function Keys

```rpg
select
   when      *inkc or *inkl
   goto      avslutt
endsl
```
- Exits if certain function keys are pressed.

#### 3.3. Read Discount Matrix

```rpg
frablu_key    setll     frablu
frablu_key    reade     frablur
dow       not %eof
    // ... logic ...
    frablu_key    reade     frablur
enddo
```
- Iterates over all entries in the discount matrix.

#### 3.4. Save Discount Condition

- Assigns all discount values to working variables so they can be compared later.

#### 3.5. Branch Based on Discount Level

```rpg
select
   when      frvare <> *blank
      exsr      behandl_vare
   when      frhgrp <> 0
      exsr      behandl_vgrp
endsl
```
- If there is an item number, goes to item-level subroutine.
- If there is a group code, goes to group-level subroutine.

---

### 4. Subroutines

#### 4.1. `behandl_vare` - Handle Item (Product) Level

- Fetches item's group from `vvarl1`.
- If group info is missing, exits.
- Tries to find a higher-level (group or sub-group) discount for the same customer/product combination by building appropriate keys.
- Multiple key searches are performed to look for the discount at various group levels.
- If a match is found and all discount conditions are the same, deletes the item-level discount.

#### 4.2. `behandl_vgrp` - Handle Group/Subgroup Level

- Similar logic as above, but for group/subgroup levels.
- Checks for discounts at even higher group levels (zeroing subgroup IDs).
- Deletes the group-level discount if an identical one exists at a higher level.

#### 4.3. `*inzsr` - Initialization

- Sets up all key lists for file access.
- Loads the firm's number from LDA.

---

### 5. Discount Condition Comparison

In all comparisons (before deletion), the program checks that **all the discount terms** are equal between the current record and the higher-level record, ensuring that only truly redundant discounts are deleted.

---

## Key IBM i Concepts

- **SETLL / READE / CHAIN**: File I/O built-ins for keyed access.
- **Keylists**: Group key fields for multiple-field key operations.
- **Work Fields**: Store comparison values to move efficiently between record types.
- **Subroutines**: Used to organize logic for item/group handling.

---

## Summary Table

| Subroutine        | Purpose                                                      |
|-------------------|-------------------------------------------------------------|
| behandl_vare      | Removes item-level discounts if redundant on group level     |
| behandl_vgrp      | Removes group-level discounts if redundant on higher level   |
| *inzsr            | Initializes keys and firm context from LDA                  |

---

## Business Summary

- Prevents "over-definition" of the same discount at several levels for the same customer/product group.
- Helps keep the discount matrix clean and efficient.
- Ensures maintenance and reporting are easier by avoiding unnecessary duplicate definitions.

---

## Onboarding Notes

New developers should familiarize themselves with:
- RPG fixed-format coding style (including `C`, `F`, `D` specs, subroutines)
- Discount matrix data model and hierarchy:
  - Item
  - Subgroup
  - Group, etc.
- Norwegian variable names (e.g. `rabatt` = discount, `vare` = item/product, `gruppe` = group).
- IBM i file handling keywords and patterns.

---

**Tip:** This logic is central for customers that may have multiple overlapping discount agreements, ensuring only the most appropriate discount is stored at the lowest needed level.