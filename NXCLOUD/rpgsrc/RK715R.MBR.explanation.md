# RPG Program Explanation

This program is written in RPG IV (ILE RPG) for IBM i (AS/400). Its primary purpose is to extract and convert customer transaction and customer master records into a specific export format (FactoNor format, later Glitnir), distributing data between different output files. Below is a thorough breakdown of the source code, suitable for onboarding a developer.

---

## 1. Header & Documentation

- **Headers (`h option(*nodebugio)`)**
  - Disables debug I/O.

- **Comments/Summary:**
  - Documents the development history, program name, and describes its function: "Transfer to FactoNor-format."
  - Tracks program revisions and enhancements.
  - Comments are in Norwegian; keep this in mind when interpreting field names.

---

## 2. File Declarations

```rpg
fraa9l1 if e k disk rename(raa9pfr:raa9l1r)
frefal1 if e k disk rename(refapfr:refal1r)
frekul1 if e k disk rename(rekupfr:rekul1r)
fref2pf uf a e disk
frek2pf uf a e disk
```

- **Input Files:**
  - `raa9l1`, `refal1`, `rekul1`: Read with keys (`k`), external, renamed formats.
- **Output Files:**
  - `ref2pf`, `rek2pf`: Sequential, output files for writing.

---

## 3. Data Definitions

### a) Local Data Area

```rpg
d uds
d l_user 911 920
d l_firm 944 946 0
```

- **LDA extraction**—user ID and firm number.

### b) Working Variables

```rpg
d w_klie s 3 0
d w_kkus s 24
d w_ksif s 1 0
```
- Working storage for client number, KID string, and check digit.

### c) Variables for Keys

```rpg
d w_firm s like(rnfirm)
```

### d) Data Structures

#### i. Factura Line Output (for `ref2pf`)
```rpg
d ds
d d_frec_1 256
d d_klie_1 3 0 overlay(d_frec_1:1)
...
```
- Flat structure for a single output record (`d_frec_1`), with overlays at explicit positions.
- Fields include client, customer, invoice, date, amount, KID, and others.

#### ii. Customer Table Output (for `rek2pf`)
```rpg
d ds
d d_krec_2 512
d d_post_2 1 overlay(d_krec_2:1)
...
```
- Output record fields for customer master, including names, address, contact info, national registry, and more.

#### iii. KID Field Structure

```rpg
d ds
d d_kkid 16
d d_kkus 15 overlay(d_kkid)
d d_kkli 3 0 overlay(d_kkus:1)
d d_kkun 6 0 overlay(d_kkus:4)
d d_kbil 6 0 overlay(d_kkus:10)
d d_kmod 1 0 overlay(d_kkid:16)
```
- The KID (customer identification number) is broken down into its constituent parts.

---

## 4. Main Program Logic

### a) Reading & Exporting Customer Transactions

```rpg
c read refal1
c dow not %eof
  c exsr xopd_fakt
  c read refal1
c enddo
```

- Reads each customer transaction (`refal1`), calls subroutine to format/export it.

### b) Reading & Exporting Customer Masterfile

```rpg
c read rekul1
c dow not %eof
  c exsr xopd_kund
  c read rekul1
c enddo
```

- Reads each customer master record (`rekul1`), calls subroutine to format/export it.

### c) Program End

```rpg
c avslutt tag
c eval *inlr = *on
c return
```

- Sets last record indicator, returns (ends program).

---

## 5. Subroutines

### a) xopd_fakt: Export Invoice Items

Handles formatting and writing of one invoice record to the output file.

**Key Steps:**
- Assigns values to output data structure.
- Inverts sign of amounts if negative (and sets type code accordingly).
- Formats dates.
- Composes the KID number:
  - `d_kkli`, `d_kkun`, `d_kbil` are assembled from the client, customer, invoice numbers.
  - Calls external program `'AK720R'` to calculate the KID check digit.
- Writes the output record.

---

### b) xopd_kund: Export Customer Master

Handles formatting and writing of one customer master record to output.

**Key Steps:**
- Moves fields from the input to output structure (name, address, etc).
- Additional logic for certain fields (e.g., sets account or personal number fields and flags as needed).
- Writes the output customer record.

---

### c) *inzsr: Initialization

Sets up program variables and keys before main logic runs.

- Sets the firm number from LDA.
- Chains into the `raa9l1` file using the firm number to retrieve the client number.

---

## 6. Noteworthy Points

- **Overlay usage:** To handle export file format with tight layouts, overlays (similar to C structs with explicit offsets) are used.
- **FactoNor/Glitnir export:** The output files are probably exchanged with an external system.
- **KID calculation:** Norwegian payment KID numbers—special logic applies, check digit is calculated via an external program.
- **Date formatting (`*ymd move`)**: Dates are reformatted for output.
- **Multi-file processing:** Both invoice and customer master tables are exported sequentially.
- **Fields defaulted to blanks/zeroes**: Many fields are set to 0 or blank as part of formatting requirements.

---

## 7. Summary

**Purpose**: Export data from internal invoice and customer databases into fixed-format sequential files compatible with an external (FactoNor/Glitnir) system.

**Workflow**:
1. Initialize client and firm numbers.
2. Loop through all invoice transactions, exporting each to the output.
3. Loop through customer master records, exporting each.
4. End program.

**Structure**: Modularized using subroutines, with clear separation between exporting invoices and customers.

---

### For New Developers:

- Focus on understanding the data overlays and mapping to output files.
- Pay special attention to the KID number calculation and formatting logic.
- Any changes in export file formats will require updating the overlays and field assignments in the relevant subroutines.
- The business rules (e.g., how to fill KID, sign handling, customer identifiers) are encoded in the subroutines.
- The program is batch-oriented, not interactive.

---

**Tip:** Refer to the database layout for input/output files and the required layout for FactoNor/Glitnir import for further clarification as needed.