# Explanation of RPG Program VA560R

This program is written in RPG IV (ILE RPG, "fixed format") for IBM i (AS/400) and is designed to handle price code inquiries with subfile processing (displaying lists in pages for user selection). Below is a section-by-section walkthrough to help you understand the code and its purpose.

---

## 1. **Header and Comments**

- **`h` spec**:
  - `option(*nodebugio)`: Disables debug I/O.
  - `datedit(*dmy)`: Date edit format (day/month/year).

- **Description**:
  - The program is named `VA560R`.
  - Purpose: Price code inquiry (`Priskode, sp√∏ring`).
  - The comments also document changes, responsibilities, and the use of indicators.

---

## 2. **Files Definitions (`f` Specs)**

- **Physical File (Input)**
  - `vpkol1`: Indexed, externally described, and renamed as `vpkol1r`.
- **Workstation File (Display)**
  - `va560d`: Controls display, using the subfile `b1sfl` (relative record number: `w_srrn`).
  - Uses information data structure `dspfbk`.

---

## 3. **Data Definitions (`d` Specs)**

- **Parameters**:
  - `p_firm`, `p_pkod`, `p_ptxt`: Used for company, price code, and text, matching file field types.

- **Display Feedback Data Structure** (for cursor location, etc.):
  - `dspfbk`: For retrieving cursor positions from the display. `d_fcrn` is the cursor row.

- **Variables for keys/fields**:
  - `vpkol1_pkod`: To hold the current price code key.
  - Several variables for subfile processing: counters and record numbers (`w_fcrn`, `w_stel`, `w_spge`, etc.).

- **Single-character flags and constants**:
  - `b_valg_ok`: Boolean (set when a selection is made).
  - `c_sfil`: Constant for subfile page size (8).

- **Comments clarify how subfile navigation works and name the display records involved (`B1SFL`, `B2CTL`, `B2CMD`).**

---

## 4. **Main Logic ("Calculation" `c` Specs)**

### **Main Loop and Tag Structure**

- **`b2taga` / `b2tagb`**: Tags for "top of loop" and "after display".
- **Workflow**:
  1. `b2taga`: Writes the command key screen (`b2cmd`), then moves to `b2tagb`.
  2. `b2tagb`: Calls the subroutine to display the subfile (`dsp_subfile`).

### **Function Key Handling**

- Uses `select/when` to process IBM i function key indicators (e.g., F3, PageUp, PageDown, Home).
- **Key actions**:
  - F3/F12 = Exit (goto `avslutt`).
  - F5 = Refresh (`forny`).
  - F10 = Next page (`crt_subfile`).
  - F11 = Previous page (`bck_subfile`).
  - F21 = Home key (cursor positioning).
- If a positioning field (`b2pkod`) is filled, calls `posisjoner` to locate the wanted row.

- After processing, returns to `b2taga` unless exiting.

### **Exit Processing**

- At `avslutt`, sets LR indicator (last record: program end) and returns.

---

## 5. **Subroutines**

### **forny**: Refreshes the subfile from the current cursor position.

1. If `w_fcrn` (first record on the page) not zero, chains to the corresponding subfile record.
2. Positions the main file (`vpkol1`) using a key list.
3. Clears and recreates the subfile.

---

### **posisjoner**: Positions the subfile to a given key.

1. If a price code is given, sets up a key and positions the file with `setll`.
2. Clears and recreates the subfile to display from the new position.
3. Clears the positioning field.

---

### **subfile**: Handles processing of subfile records for selection.

1. Toggles `*in22` (cursor placement indicator).
2. Sets the current visible record.
3. Loops through subfile records, reading changed records (`readc b1sfl`).
4. If the "select" field (`b1valg`) is set, copies the selected data to the parameters, sets `b_valg_ok`, and leaves.

---

### **clr_subfile**: Clears the subfile.

- Sets the clear subfile indicator (`*in14`), writes the subfile control record, and resets counters.

---

### **crt_subfile**: Populates the subfile with data.

1. Increases the current "page" number.
2. Loops to fill a "page" (up to `c_sfil` records).
3. Reads from the database, writes to the subfile, and checks for end-of-file or firm change.
4. Updates first/last record variables for paging.

---

### **bck_subfile**: Handles scrolling "back" one page in the subfile.

1. If at end, backs up the main file pointer (`setgt`, `readp`).
2. Loops backwards for one page's worth of records.
3. Repositions and recreates the subfile display.

---

### **dsp_subfile**: Displays the subfile and control record.

1. If there are records, enables subfile display indicator, then presents the control record (`exfmt b2ctl`), otherwise only writes the command line screen.

2. Updates `w_fcrn` with the cursor position.

---

### **Initialization (`*inzsr`)**

- Sets up initial state:
  - Retrieves parameters.
  - Prepares the key list.
  - Sets up the subfile at the start of the file.

---

### **Parameter Handling**

- At program entry, receives firm, price code, and text as parameters (for initializing search context).

---

### **Key List Definition**

- `vpkol1_key` is a 2-field key: firm and price code, used for positioning/chain operations.

---

## 6. **Subfile Navigation and Indicators**

- **Indicators** (per comments):
  - Control paging, cursor, subfile actions, and error status.
- **Subfile Navigation**:
  - Next/previous page logic handled via `crt_subfile` and `bck_subfile` subroutines.

---

## 7. **Summary of Operation**

- User invokes the program with firm, price code, and text.
- A subfile (paged list) is displayed, allowing navigation (PageUp/PageDown).
- User may position the list via key or select a row.
- Selected data is returned via parameters; exit indicator triggers program completion.

---

## 8. **Areas to Focus If New to IBM i/RPG**

- **Subfile processing**: Critical for interactive programs; this code is a typical example.
- **Indicator handling**: IBM i panel logic is heavily indicator-driven.
- **Keyed file positioning**: Understanding RPG's `setll`, `chain`, and `read`/`readp` operations is vital.
- **Parameter passing**: RPG programs commonly receive parameters from CL or other RPG callers.

---

**Feel free to ask for explanations of specific subroutines, file layouts, or IBM i concepts!**