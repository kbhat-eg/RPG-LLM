# RPG Program FD106R – Explanation

This program, `FD106R`, is a classic IBM i ILE RPG program for **quick creation of sales order lines**. It is designed for batch or interactive use and is heavily customized for a specific business’ sales order/warehouse system. The program is modular, using calls to various external routines for price, discount, stock, and item management.

Below is a structured walkthrough for developers.

---

## 1. **Header and Documentation**

- **Header (`h`) Specification**:  
  - `option(*nodebugio)`: Debugger cannot change I/O.  
  - `datedit(*dmy)`: Date format is day-month-year.
- **Program History**:  
  Extensive change log documents all significant changes, by version and developer. This helps track business logic evolution for new developers.

---

## 2. **File Definitions (`f` Specs)**

- **Physical and Logical Files**:
    - Examples: `fstsl1`, `vvarl1`, `vvenl1`, `fohel1`, `fodtl1`, `fodtlu`, etc.
    - Files are frequently renamed for use in the program (e.g., `fstspfr:fstsl1r`).
- **Usage**:  
  These files represent item master, item/unit, order header, and order detail tables.

---

## 3. **Variables & Data Structures (`d` Specs)**

- **Parameters**:  
  Parameters such as item code, firm, number, suffix, line number, etc. are defined. They match fields in the file layouts (using `like()`).

- **Data Structures**:  
    - For parameter passing to/from external price routines, warehouse routines, etc.
    - Almost all DS fields use `overlay()` to map to larger storage areas for parameter passing.

---

## 4. **Key Variables and Constants**

- **Keys for File Access**
    - Defined via `klist` later in the code, with fields for composite keys.

- **Variable Names**
    - Variables prefixed with `w_` are work variables.
    - `p_` prefix: parameters from the caller.

- **Constants**
    - For upper/lowercase conversion for text fields.

---

## 5. **External Procedure/Program Declarations**

- **CO402R**:  
  External program call (7.00) for certain configuration flags (e.g., allowing unknown item codes).

---

## 6. **Main Program Logic (`c` Specs)**

### a. **Validation**

1. **Check for Required Fields**:  
   If item code or quantity is blank/zero, goto `avslutt` (exit).

2. **Validate Existence of Item/Unit**:  
   Chain (lookup) the item/unit in `vvenl1`. If not found (and unknown items not allowed), exit.

3. **Prevent Duplicate Order Lines**:  
   Check in `fodtl1` for existing order line. If found, exit.

4. **Fetch Item Master Record**:  
   Chain on `vvarl1` using item code. If not found, handle as unknown item (optional, see config).

### b. **Supplementary Lookups and Processing**

- **Fetch and Set Item Type from Warehouse/Department**:  
  Calls program `VL710R` to get item type info (with a large set of parameters reflecting the business’ warehouse structure).

- **Offer/Promotion Price Lookup**:  
  Calls `FO751R` for possible offer/promotion prices.

- **Fetch Price Group from Warehouse/Department**:  
  Calls `VL712R` for price group assignment.

### c. **Order Line Initialization**

- **Clear Work Area for Order Line**
- **Set fields for new order line in `fodtlur` DS**:  
   Many fields set from incoming parameters, lookups, or work variables.

- **GTIN Handling**:  
   Calls a subroutine for GTIN (barcode) number lookup and sets it.

### d. **Price and Discount Calculation**

- **Setup for Price Fetch**:  
  Prepare and call external pricing routine (`VP900R`) through the `hent_pris` subroutine.

- **Net and Cost Pricing**:  
  Set values using the pricing return structure. Handles both standard and offer pricing.

- **Price Group Handling**:  
  Sets price group information.

- **Discount Logic**:  
  Calculations for up to four levels of discounts (`fdrab1`, `fdrab2`, `fdbrr1`, `fdbrr2`) in sequence (cascading).

- **Cost Price Calculation**:  
  If cost price is not returned, calculates it as a factor of net price and margin.

- **Totals Calculation**:  
  Calculates and sets totals for sum, discounts, and cost.

### e. **Additional Field Population**

- **Pulls fields from related tables**:  
   Warehouse group, department group, text fields, etc.

- **Optional**: Translates item text to uppercase if configured.

### f. **Record Write & Update**

- **Sets date/time stamps and user fields**.
- **Writes new order line (`fodtlur`)**.
- **Calls warehouse update subroutine (`oppdat_lager`)**.

### g. **Set Return Code and Exit**

- **Set flag to indicate successful line registration**.
- **Tag `avslutt`** marks program end. LR flag set (`*inlr = *on`) and returns.

---

## 7. **Subroutines**

### a. **`hent_pris`**

- **Composes and fills parameter fields for price determination**.
- **Calls `VP900R` for pricing (parameters include customer, item, date, price group, etc.)**.

### b. **`oppdat_lager`**

- **Checks if warehouse update is needed (`faalag = 1` and item type = 'L')**.
- **Prepares parameters, including references for traceability**.
- **Calls `VL001R` for warehouse stock adjustment**.

### c. **`hent_inpr`** (Introduced in 7.02)

- **Fetches purchase price for internal orders by calling `VP753R`**.
- **If returned value 0, uses cost price as fallback**.

### d. **`hent_GTIN`** (Introduced in 8.03)

- **Fetches GTIN (barcode) number for item/unit from `VE713R`**.

### e. **`*inzsr` (Initialization Subroutine)**

- **Reads the entry parameters (via `plist`/`parm`) and assigns to work variables**.
- **Checks configuration for "unknown item allowed" via `CO402R`**.
- **Reads static configuration and order header from disk files**.
- **Optionally checks for cash customer setting and order type side-register**.

- **Key lists (`klist`)** for file access are also defined here.

---

## 8. **Special/Notable Aspects**

- **Release-specific code**:  
  Parts of the code are gated by version for maintainability (e.g., `6.30`, `7.00`).

- **Extensive Use of External Routines**:  
  Much of the pricing and logistics logic relies on external standardized programs.

- **Field Naming Conventions**:  
  Names like `fd...` for order line, `fo...` for order header, `vv...` for item master, etc., follow corporate data dictionary conventions.

- **Business Rules Embedded**:  
  The code incorporates complicated business rules: promotions, internal pricing, offer pricing, multi-level discounts, warehouse logic, etc.

- **Text handling**:  
  Includes facilities for forced-case text, which may be required for labeling/printing.

---

## 9. **Key Takeaways for New Developers**

- **Understand the Data Model**:  
  Know how item, order, unit, and discount data is structured in the files and external routines.

- **Trace the Call Chain**:  
  For pricing, warehouse, and GTIN/labeling, see which programs are called, and what parameters are passed.

- **Error Handling is GOTO-Based**:  
  Exits on most validation errors by jumping to `avslutt`.

- **Customization is Common**:  
  There are numerous version- or business-specific features, often marked in the code by version comments.

- **File Usage is Central**:  
  Be comfortable with file-based lookups and updates (`chain`, `write`).

- **Discounts and Totals Logic is Layered**:  
  Discounts are cumulative and calculations are staged, refer to discount variables closely.

---

## 10. **Summary Flow**

1. **Validate inputs**
2. **Find/Create related records**
3. **Fetch all necessary data**
4. **Calculate prices and discounts**
5. **Write order line**
6. **Update warehouse if required**
7. **Return success code**

---

**This program is foundational in the sales order process, integrating almost all commercial and logistics logic for line-level order processing. Onboarding will require a full grasp of file layouts, external program interfaces, and the business rules embedded in the version history.**