# RPG Source Code Explanation

This RPG program is used for printing a copy of an invoice ("Utskrift av fakturakopi" in Norwegian). Below is a breakdown of the program's structure, main logic, and key constructs for easy onboarding.

---

## **1. Header Information**

The initial section contains a title, system, program name, description, and a change log:

```rpg
/TITLE  ASOFAK Utskrift av fakturakopi
* System  . . . . : ASOFAK
* Program . . . . : FO681R
* Beskrivelse . . : Utskrift av fakturakopi
* Ref.   Dato  Sign Endringsbeskrivelse
* ----- ------ ---- -------------------------------------------------
*       110698 HKO  Nytt program
6.nu  * R6.30 210814 bsa  Programmet gjennomg√•tt mtp nummerutvidelser.
```

---

## **2. File Definition**

```rpg
fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
```
- **fvotyl1**: This is an externally described file used for disk I/O (likely a database table). It is renamed to **votyl1r** in this program.
- **if e k disk**: Input, externally described, keyed access.

---

## **3. Data Structure Definitions**

### **Parameter Structure**

```rpg
d                 ds
6.nu d d_list                        34
d  d_aarr                        4  0 overlay(d_list)
d  d_otyp                        2    overlay(d_list:5)
6.nu d  d_fbin                        8  0 overlay(d_list:7)
6.nu d  d_tbin                        8  0 overlay(d_list:15)
6.nu d  d_prog                       10    overlay(d_list:23)
6.nu d  d_kopi                        1    overlay(d_list:33)
```
- **d_list**: A 34-character data structure for passing parameters to another program.
- Each field (d_aarr, d_otyp, d_fbin, etc.) overlays part of d_list (subfields) and are used as parameters for the called print program.

---

## **4. Standalone Variables**

```rpg
d p_firm          s              3  0
d p_aarr          s              4  0
6.nu d p_binr          s              8  0
d p_otyp          s              2

d w_firm          s              3  0

d votyl1_otyp     s                   like(vaotyp)
```
- **p_\***: Parameters received by the program (company, year, invoice number, order type, etc.).
- **w_firm**: Local variable for company code.
- **votyl1_otyp**: Local variable for order type, type-matched to field vaotyp.

---

## **5. Main Program Logic**

### **5.1 Reading Routine Name**

```rpg
c                   eval      votyl1_otyp = p_otyp
c     votyl1_key    chain     votyl1                             60
c                   if        *in60 = *on or
c                             vaoakk <> 3
c                   goto      avslutt
c                   endif
```

- Sets up order type for file access.
- Performs a **CHAIN** (keyed read) on the votyl1 file using the generated key (see subroutine).
- If the record is not found (*IN60 = *ON) or a certain field (vaoakk) is not 3, the program jumps to the end ("avslutt").

### **5.2 Filling Parameter Structure and Calling Print Program**

```rpg
c                   eval      d_aarr = p_aarr
c                   eval      d_otyp = p_otyp
c                   eval      d_fbin = p_binr
c                   eval      d_tbin = p_binr
c                   eval      d_kopi = 'K'
```
- Fills the data structure with current parameters.

```rpg
c                   call      'LO681C'
c                   parm                    d_list
c                   parm                    vaorut
```
- Calls external program **LO681C**, passing the parameter structure (**d_list**) and **vaorut** (routine name from the file record).

### **5.3 Program Exit**

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Tag for program exit.
- Sets the last record indicator (*INLR) to ON for proper program end/closure.
- Returns from the program.

---

## **6. Initialization Subroutine (\*INZSR)**

```rpg
c     *inzsr        begsr

c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_aarr
c                   parm                    p_binr
c                   parm                    p_otyp

c     votyl1_key    klist
c                   kfld                    w_firm
c                   kfld                    votyl1_otyp

c                   eval      w_firm = p_firm

c                   endsr
```

- **\*INZSR**: Initialization subroutine; runs automatically on program start.
- **Parameter List (\*ENTRY PLIST)**: Receives input parameters into local variables.
- **Key List (KLIST)**: Defines the key fields for database access (**w_firm** and **votyl1_otyp**).
- **w_firm set from p_firm**: Synchronizes the company code for key use.

---

## **7. Summary / Program Flow**

1. **Start**: Receives parameters via entry plist.
2. **Initialize keys**: Prepares the keys for file access.
3. **Attempt to read** the votyl1 file for matching order type and company.
4. **If record is absent or not valid**, exit.
5. **If valid**, populate a parameter structure for the print program, and **call** LO681C to perform the print/output.
6. **Exit cleanly**.

---

## **8. Key Points for Developers**

- **Data Structure Overlay**: Used to pack multiple parameters into a single structure for program calls.
- **CHAIN operation**: Used for keyed access to files (databases/tables).
- **Subroutines (\*INZSR)**: Used for program setup and parameter handling.
- **Dynamic routine (program) calling**: Uses information from the file to decide which print routine to run.

---

This program follows typical ILE RPG patterns for modular business logic, database integration, and program communication. It's focused on safe parameter passing, record validation, and controlled invocation of external processes for output/print.