# Documentation for Program XK500R (Nexstep System)

## Overview

**Program:** XK500R  
**Description:** Query and selection of competitor codes ("Konkurrentkoder, spørring")  
**System:** Nexstep

This program provides an interactive subfile-based inquiry interface for competitor codes. It allows users to browse, position, and select codes from a list (subfile) displayed on a workstation device. The program supports paging, positioning, and selection operations, and interacts primarily with the `xtkkl1` physical file (competitor codes master).

---

## File Definitions

- **xtkkl1**  
  - Physical file, keyed access, renamed record format (`xtkkpfr:xtkkl1r`).
  - Holds competitor code records.

- **xk500d**  
  - Display file, workstation device.
  - Uses subfile `b1sfl` (with relative record number `w_srrn`).

---

## Parameters

On entry, the program receives three parameters:

- **p_firm**: Company/firm identifier (like `xkfirm`)
- **p_kkod**: Competitor code (like `xkkkod`)
- **p_teks**: Text/description (like `xkteks`)

---

## Key Variables and Subfile Control

- **w_stel**: Subfile counter (records processed)
- **w_spge**: Subfile page size
- **w_srrn**: Relative record number in subfile
- **w_sfrn**: First record number on current page
- **w_ssrn**: Last record number on current page
- **b_valg_ok**: Selection flag (set to *on when a code is selected)
- **w_firm**: Local copy of firm ID

**Constants:**
- **c_sfil**: Subfile page size (default 8)

---

## Screen Layouts

- **B1SFL**: Subfile record format (list of competitor codes)
- **B2CTL**: Subfile control record (header, navigation)
- **B2CMD**: Command key display (function key help)

---

## Indicator Usage

- **LR**: End program
- **10**: Roll (page down)
- **11**: Rolldown (page up)
- **12**: Subfile display (SFLDSP)
- **13**: Subfile display control (SFLDSPCTL)
- **14**: Clear subfile (SFLCLR)
- **15**: Subfile end (SFLEND)
- **21**: Home key
- **22**: Cursor placement
- **30**: Field protection (view mode)
- **31-79**: Error/warning indicators
- **80-99**: Work indicators

---

## Main Program Flow

### Initialization (`*inzsr`)
- Receives parameters.
- Sets up key lists for file access.
- Initializes display and positions the database at the start for the specified firm.
- Loads the initial subfile page.

### Main Loop

The program operates in a loop, alternating between displaying the subfile and processing user input:

1. **Display Command Screen (`b2cmd`)**
   - Shows available function keys.

2. **Display Subfile (`dsp_subfile`)**
   - If subfile contains records, displays them (`b2ctl`), otherwise shows command screen.

3. **User Navigation/Selection**
   - Handles function keys:
     - **Exit Keys**: (*INKC, *INKL) — End program.
     - **Refresh**: (*INKE) — Refresh subfile from current position.
     - **Page Down**: (*IN10) — Load next page of subfile.
     - **Page Up**: (*IN11) — Load previous page.
     - **Home**: (*IN21) — Set cursor to home position.
   - If a code is entered for positioning (`b2kkod`), positions the subfile accordingly.
   - Processes subfile selection: if a row is selected (`b1valg = 1`), sets output parameters and ends.

---

## Subroutines

### `forny`
- Refreshes the subfile starting from the current position.
- Clears and rebuilds the subfile from the current key.

### `posisjoner`
- Positions the subfile to a specific competitor code (`b2kkod`).
- Clears and fills the subfile from the positioned record.
- Resets positioning field.

### `subfile`
- Toggles cursor placement indicator.
- Iterates through displayed subfile records, checking for selection.
- If a row is selected, sets output parameters and marks selection as complete.

### `clr_subfile`
- Clears the subfile and resets subfile control variables and indicators.

### `crt_subfile`
- Fills the subfile with up to `c_sfil` records from the current database position.
- Handles end-of-file and firm boundary conditions.
- Updates subfile control variables.

### `bck_subfile`
- Handles page-up (backward paging) in the subfile.
- Reads backward up to one page, then rebuilds the subfile display.

### `dsp_subfile`
- Manages display of the subfile or command screen, depending on whether subfile has records.

---

## Business/Domain-Specific Logic

- **Competitor Codes Inquiry:**  
  The program's main purpose is to let users browse and select competitor codes for a specific firm. It supports positioning by code, paging, and direct selection.
- **Firm-Scoped Data:**  
  All subfile operations are scoped to the firm (`w_firm`). When paging or positioning, if a record from another firm is encountered, paging stops.

---

## Design Patterns & Conventions

- **Subfile Paging:**  
  Uses a fixed subfile page size (`c_sfil`). Paging logic is handled by `crt_subfile` and `bck_subfile`.
- **Indicator-Driven UI:**  
  Follows standard S/36-style indicator conventions for subfile control and function key handling.
- **Explicit Cursor Management:**  
  Uses indicator 22 for cursor placement, supporting user-friendly navigation.
- **Parameter Passing:**  
  Output parameters are set when a selection is made, allowing the calling program to receive the selected code and description.

---

## Interactions

- **Database:**  
  Reads from the `xtkkl1` file using keyed access, always filtered by firm.
- **Display File:**  
  Interacts with `xk500d` for all UI operations, including subfile and command key screens.

---

## Notable Implementation Details

- **Wide Screen Handling:**  
  Commented as "Takler brede skjermbilder" — the program is designed to support wide display screens.
- **Subfile Positioning:**  
  Positioning logic is robust, allowing users to jump directly to a specific code.
- **Selection Logic:**  
  Only one row can be selected at a time (`b1valg = 1`), and selection immediately ends the program with output parameters set.

---

## Maintenance Notes

- **Error Handling:**  
  Error and warning indicators are reserved (31-79) but not explicitly used in the provided code.
- **Extensibility:**  
  The code is structured for easy modification, with clear separation of subfile operations and UI logic.
- **Localization:**  
  Comments and some variable names are in Norwegian; ensure new developers are aware of this for maintenance and enhancement.

---

## Summary

XK500R is a subfile-based interactive selection program for competitor codes, supporting paging, positioning, and selection within the context of a specific firm. It is tightly coupled to standard IBM i subfile and indicator conventions and is designed for maintainability and clarity within the Nexstep system.