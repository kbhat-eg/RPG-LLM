# ASOFAK FA912R: Price Rounding Subprogram (Format 9:2)

## 1. Purpose  
This subprogram calculates and applies rounding rules for a sales price (including VAT) based on specific hierarchy keys (company, groups, supplier, module, item). It:  
- Receives one unit and one price as parameters  
- Looks up the most specific rounding rule  
- Computes a rounded price according to that rule  

## 2. Data Definitions  

- **File Indicators**  
  - `jav1l1` (rules table)  
  - `jav3l1` (rounding parameters table)  
  - `jlevl3` (supplier lookup)  

- **Key Fields for `jav1l1`**  
  - firm (`jav1l1_firm`)  
  - overgroup (`jav1l1_ogrp`)  
  - main group (`jav1l1_hgrp`)  
  - subgroup (`jav1l1_ugrp`)  
  - supplier (`jav1l1_levr`)  
  - module (`jav1l1_modu`)  
  - item number (`jav1l1_vare`)  

- **Key Fields for `jav3l1`**  
  - firm (`jav3l1_firm`)  
  - rule number (`jav3l1_regl`)  
  - from-price (`jav3l1_frpr`)  

- **Work Variables**  
  - `w_frpr`: input price (9,2)  
  - `w_fraa`: price difference divisor result  
  - `w_utgp`: unrounded target price  
  - `w_utgpd`: duplicate of `w_utgp` for versioning  
  - `w_gren`: price threshold boundary  
  - `w_pris`: final rounded price  
  - `b_pris`: flag indicating if rounding applied  

## 3. Parameters Passed In  
 1. `p_firm` (3,0)  
 2. `p_ogrp` (2,0)  
 3. `p_hgrp` (2,0)  
 4. `p_ugrp` (3,0)  
 5. `p_enum` (6,0) – supplier enumeration  
 6. `p_modu` (8,0)  
 7. `p_vare` (15) – item number  
 8. `p_frpr` (9,2) – original price  
 9. `p_s1im` (9,2) – NOBB price for unit 1  
10. `p_enh1` (3) – NOBB unit code  
11. `p_type` (1,0) – indicator  

## 4. Main Logic Flow

1. **(Optional) Supplier Lookup**  
   - Read supplier record by `p_enum`.  
   - If not found, exit (no rounding).

2. **Find Most Specific Rounding Rule**  
   The code attempts a sequence of lookups in `jav1l1`, from most to least specific:
   1. Supplier + item  
   2. Item only  
   3. Supplier + module  
   4. Module only  
   5. OGR,HGR,UGR + supplier  
   6. OGR,HGR + supplier  
   7. OGR + supplier  
   8. Supplier only  
   9. OGR,HGR,UGR only  
  10. OGR,HGR only  
  11. OGR only  
   - After each `CHAIN jav1l1` attempt, if found, stop.  
   - If no rule found or the retrieved `ja1rgl` (rule number) is zero, exit without rounding.

3. **Determine Applicable Input Price**  
   - If “calculate from NOBB” and NOBB disabled, exit.  
   - If unit matches NOBB unit (`p_enh1`), override `w_frpr` to NOBB price `p_s1im` and set `p_type = 1`.

4. **Lookup Rounding Parameters**  
   - Move found rule number (`ja1rgl`) plus firm code into `jav3l1` key fields.  
   - Perform a positional read (`READP`) on `jav3l1` to retrieve the smallest `frpr` greater than input.  
   - If record found and matches rule/firm, proceed to compute.

5. **Compute Rounded Price**  
   Let:
     - `jaokni` = rounding increment  
     - `jaavrp` = over-round percentage  
     - `jafrpr` = original input price  
   Steps:
   a. `w_fraa = (jav3l1_frpr – jafrpr) / jaokni – 0.5`  
   b. `w_utgp = jafrpr + jaokni * w_fraa`  
   c. `w_gren = w_utgp + jaokni * ((100 – jaavrp) / 100)`  
   d. If `jav3l1_frpr < w_gren`  
       • `w_pris = w_utgpd` (no extra increment)  
     Else  
       • `w_pris = w_utgpd + jaokni` (increment once)  
   e. Set `b_pris = *ON` to indicate rounding applied.

6. **Apply Rounded Price**  
   - If `b_pris = *ON`, assign `w_pris` back to return parameter (`p_s1im`).

7. **Return**  
   - `RETURN` to calling program; result in `p_s1im` and `p_type`.

## 5. Key Takeaways  

- **Hierarchical Key Lookup**: Tries increasingly general keys until a rounding rule is found.  
- **Parameterized Rounding**: Uses a dynamic increment (`jaokni`) and tolerance (`jaavrp`) from the rounding parameters file.  
- **NOBB Integration**: Allows override by external price source for certain unit types.  
- **Clean Exit**: If at any point no valid rule or price applies, the subprogram returns without modifying the input price.