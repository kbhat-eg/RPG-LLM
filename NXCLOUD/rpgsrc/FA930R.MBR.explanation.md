## FA930R - Customer Creation via F6 — Detailed RPG Codebase Overview

### Purpose and Business Role

This program is the **new customer registration module** in an ERP/financial system, responsible for creating new customer master records based on user input via a display file. The module supports extensive business rules, inline validations, and maintains referential integrity with several related files (addresses, categories, agreements, etc.). It’s digitally mature, supporting augmentations for mobile, email, external validation (phones, company numbers), and third-party lookups (such as Bisnode and 1881).

### Core Structure & Data Flow

**Entry Point / Parameters**  
The program is called with a parameter list containing return status, company, name, address lines, location, and (in newer versions) mobile number:

```rpg
parm p_retu
parm p_firm
parm p_navn
parm p_adr1
parm p_adr2
parm p_sted
parm p_lkun
[parm p_mobn]
```

These are used to initialize working fields.

**Main Program Loop**  
- Grabs the next available customer number via `RS001R`.
- Attempts to pre-fill from a "copy customer" if a reference is supplied.
- Optionally fetches supplementary info from agreements or customer category standard values (“standardverdier”).
- Presents the data entry window (`c2win`), handling user input and function key events in a loop until either:
    - Creation is confirmed and record written,
    - The operation is cancelled (`p_retu = '1'`), or
    - User navigates to subsidiary programs (contact, agreements, cards).

**Interactive Subsystems and Navigation**
- **Function keys:** Many function keys invoke related modules (`RF210R` for contacts, `RF222R` for cards, etc.), or launch search and maintenance dialogs.
- **Address maintenance:** Uses a separate “besøksadresse” window and allows address search by post code.
- **External lookups:** Conditional logic supports searching/auto-filling from 1881 (phone directory, Norway) or Bisnode (credit/reference data).
- **Validation:** On each [ENTER], the input is validated; errors are highlighted and user is cycled back into the entry window. Error flags are linked to indicator fields (e.g., `*in31 = *on` for “missing name”).

### File Layout and Inter-module Communication

#### Data Files

- **Customer master** — Primary file (`rkunl1`/`rkunlur`)
- **Customer alternative lookups** — Alpha index, org number, bank giro, phone, email, mobile as separate logical/access paths.
- **Agreement registers** (`rksal1`, `rksalur`)
- **Addresses, postcodes, user tables, status-code tables, memosaldo (balance), code registers, etc.**
- External “call” programs handle address (`AF010R`, `RA508R`), district, category, and credit “lookups”.

**File Usage Conventions**
- All file specifications are standardized with `rename()` syntax for record format clarity.
- Prefixed logical files (`prefix(x:1)`) are used for lookup tables, making for flexible and readable code.
- Use of alternate record formats allows key-based access across multiple unique indices (e.g., by alpha, org number, phone).

#### External Service Callouts

- **RS001R**: Next available customer number.
- **RK644C**: Outputs customer info/email.
- **RÅ950R**: Formats phone numbers.
- **RA511R/RA508R/RA507R/RS711R/RS708R/RS707R**: Various reference and lookup programs.
- **FA931R/FA932R/FA933R**: Bisnode and 1881 external searches.

### Key Business Rules and Domain-Specifics

#### Standardization and Compliance

- **Address/Name uppercasing** (except if status code 1 — e.g., existing customer — disables it).
- **Enforcement of mandatory fields**: e.g., name, address, post number, category, with variations depending on the controlling “status code 3” (`ra3*` values, see `w_3mfe`).
- **Validations against external references:** Ensures post number, district, department, category, org number, phone, email, and mobile are unique, valid, and (where required) present.
- **Category-Driven Requirements**: Some requirements (e.g., requiring an org number, email, or phone) are parameterized by the selected customer category and maintained centrally.
- **Special customer operations:** If the new record was a copy from an existing customer (“kopieringskunde”), some fields retain their original values unless overridden via code.

#### Data Integrity

- Before creation, checks all “key” fields for uniqueness (org number, alpha index, bank giro, phone, email, mobile).
- Related agreement and memory balance records are automatically created in sync with the main customer.
- Credit type (and limits) are dynamically set based on user security/group and, if integrated, Bisnode ratings.

#### UX Behavior

- Dynamic error flags connect display fields with indicators — user will not be able to proceed until all required and valid entries are made.
- Function navigation is context-aware; function keys for contacts, cards, and agreements only become available at appropriate states in data entry.
- “Copy customer” logic allows rapid creation of similar customers.

#### Localization and Internationalization

- The display language is Norwegian (e.g., “Beskrivelse”, “Kundekategori”, etc.), with special Norwegian characters supported.
- SQL statements (in newer code) use the proper collation (`LANGID=NOR`) for local sorting/sequencing.

### Noteworthy Design Decisions

#### Modularity

- Heavy use of subordinate “lookup programs” for validation/reference data minimizes code duplication and centralizes maintenance (the customer program itself is kept focused on orchestration and key business rules).
- Expanding support for integration with third-party services (1881, Bisnode) is managed by feature flags read from a central configuration (“koderegister”) and checked securely during initialization.
- The subroutine architecture supports clean separation: input validation, conversion logic, “besøksadresse,” and agreement maintenance are each isolated.

#### Multi-version and Backward Compatibility

- Extensive use of version markers (`T5.40`, `6.22`, `7.03`, etc.) within comments and code structure to denote phase-in of new features/functionality and to preserve backward compatibility.
- Certain features are enabled/disabled depending on client’s “status codes” representing business line, user profile, and organizational context.

#### Data Integrity and Auditability

- Systematic setting of tracking fields (creator, updater, timestamps, program names) on all created/updated records.
- Special integrity checks around record deletion (e.g., agreement records are deleted if all fields are blank).

### Screen Handling and RPG/400 Patterns

- **Display files**: Uses traditional `exfmt` cycles, indicator-driven navigation, embedded help and error highlighting.
- **Indicator pools**: Error and navigation conditions are communicated via indicator fields (`*in31`, `*inkc`, etc.), a typical but mature pattern in traditional greenscreen 5250 RPG.

### Key Relationships and Integration Points

- **Customer creation is not stand-alone**. It is tightly integrated with agreements, category definitions, department and district hierarchies, contact and payment info, and validates all these against master data in the system.
- **Integration with third-party referential data** is seamless: user may perform guided lookups via 1881 and Bisnode either before or during registration.

---
#### Summary

This module is a thoroughly business-driven customer registration component. It heavily leverages IBM i/AS400 traditions, but with strong flexibility, validation, and modernization, including API integrations and dynamic, category-controlled validation logic. Anyone working in the code should carefully study the interface contracts with auxiliary “lookup” and “utility” programs, as most field-level logic is subject to company, department, and product category rules that may evolve independently of the core RPG itself.

For onboarding, focus should be directed at:

- The logic for chaining and updating various logical files (many indices for lookup, uniqueness, and validation);
- Business rules controlled via “status codes” and how these impact required fields, default values, and function key navigation;
- How third-party data (Bisnode, 1881) is conditionally allowed and imported;
- Where to look in the code for enforcing special validations as dictated by configuration (postnumber, gironummer, org number, credit, etc.).

Close collaboration with key users and SME's (subject matter experts) is essential, as many validation rules and business requirements are governed outside the RPG itself, via reference data or auxiliary programs. This ensures robust, future-proof onboarding for new developers coming into the domain.