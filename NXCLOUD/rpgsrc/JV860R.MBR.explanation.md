# RPGLE Program JV860R - Main Program for XML Handling from NOBB

This RPGLE program is the main control for handling XML files from NOBB in an IBM i environment. The program is responsible for reading, sorting, processing, archiving, and cleaning up XML files that arrive in a specific directory structure. It is heavily integrated with the IFS (Integrated File System) and uses APIs for file/directory operations. The code is well-commented (often in Norwegian), and has seen several revisions, mostly to tune file cleanup logic and error handling.

---

## High-Level Flow

1. **Initialization**: 
   - Setup variables and keys, start job logging, and retrieve configuration such as base directories.
2. **File Processing**: 
   - Scan an "INN" (input) directory for XML files, sort them, and process each file according to its type (VARE, MODU, PRIS, etc.).
   - After processing, move XML file to an "archived" directory, write a receipt/acknowledgment file, or in case of error, move it to an error directory.
3. **Cleanup**:
   - Remove old files from the "lest" (read/archived) and "kvit" (acknowledgment) directories based on file age.
4. **Status Update/Logging**:
   - Update status files and call out to logging programs.
   - Error handling and message logging is consistently applied.
5. **End of Program**:
   - Finalize job status, cleanup, and return.

---

## Key Data Structures and Variables

- **Directory Names/Paths**:  
    - `dirBaseNavn`, `dirFInnNavn`, `dirFLestNavn`, `dirFKvitNavn`: Varying length strings holding full paths.
    - Short names, e.g., `dirInnNavn`, `dirLestNavn`, `dirKvitNavn` for subdirectories.

- **File Types**:  
    - 4-character codes like `VARE`, `MODU`, `PRIS`, etc., used to identify and branch logic based on XML file purpose.

- **Arrays and Structs**:  
    - `katV`: Array (max 2000) of structures holding file name, directory, path, length, etc. Used to gather the file list for batch processing.

- **API Prototypes**:  
    - Prototypes for IFS functions (`open`, `close`, `write`, `opendir`, `readdir`, `unlink`, `chdir`, etc.).
    - Prototypes for external processing programs for each file type.

---

## Main Sections

### 1. Initialization (`*inzsr`)

- Sets up file keys for property lookup and status updates.
- Reads company/firm (firma) information.
- Initiates job logging by calling `AB700R`.

### 2. Main Processing Loop

**Key Steps:**
- **Setup Deletion Date**: Sets a date variable to "today minus 1 day" to use as a cutoff for deleting archived files.
- **Check Status Files**: Verifies the status file is accessible (`jstsl1` table), logs errors and aborts if not found.
- **Retrieve Directories**: Reads the XML input directory path from a config file or property file.
- **Scan/Input Loop**: Iterates batch-wise over XML files in the "INN" directory, processes, and logs each batch.
    - Calls subroutine `beh_xmlf` for the actual processing of XML files.
- **Logging**: Status updates and logging for processed files.
- **Cleanup**: Calls to subroutines `beh_lest` and `beh_kvit` to clean up old files in archive/ack directories, respectively.
- **Final Status Update**: Update the status file with the date of last import.

### 3. Subroutines

#### **beh_xmlf**: Process Input XML Files

- Opens the input directory, loops through directory entries.
- For each file with a recognized type (VARE, MODU, etc.):
    - Adds details to the array.
- Sorts the array of filenames (by filename = sequence).
- For each file:
    - Calls the corresponding processing program.
    - If successful: creates a "kvitteringsfil" (acknowledgment/receipt file), moves the XML file to the archive dir ("lest"), increases the counter.
    - If unsuccessful: moves the file to "feil" (error) directory.
    - Always logs the file name being processed.

#### **log_xmlf**: Log File Counts

- Writes to job log: how many XML files have been processed and how many receipts created.

#### **log_xmlnavn**: Log Current Filename

- Logs the name of the file currently being processed.

#### **beh_lest** / **beh_kvit**: Clean Up Archive or Acknowledgment Files

- Opens the appropriate directory (`lest` or `kvit`).
- Loops over files, checks file mtime (last modified time).
- If file is older than the cutoff date (`w_slett_d`), deletes (unlinks) the file.

#### **slett_fil**: Delete File If Old Enough

- Converts file mtime to date, compares to cutoff date, deletes it if older.

#### **FileErr**: File Error Handler

- If an error occurs during file I/O, logs detailed error and jumps to exit.

---

## Error Handling

- Any file error or missing config/status file will trigger logging (via `AB705R`) and a jump to the `avslutt` (exit) section.
- On normal exit, job status is updated via `AB710R`.

---

## External Program Calls

- **AB700R**: Initiate job logging.
- **AB705R**: Write log/error messages.
- **AB710R**: Update final job status.
- For each XML file type, calls to specialized sub-programs:
    - `JV860R_XML`, `JV863R_XML`, `JV865R_XML`, `JV867R_XML`, `JV868R_XML`, `JV869R_XML`

---

## Directory & File Naming Conventions

- Input XML files are expected in `/home/asp/bmp/nobb80/inn/` (or as configured).
- Archive/read files are placed in `/home/asp/bmp/nobb80/lest/`.
- Receipt/acknowledgment files go to `/home/asp/bmp/nobb80/kvit/`.
- Failed files are moved to `/home/asp/bmp/nobb80/feil/`.
- All file handling uses IFS APIs, allowing for UNIX-like file path management.

---

## Code Customizations (Revision Comments)

The code has evolved:
- Adding and tuning file deletion logic for already-read/acknowledged files.
- Logging of last import in status file.
- Improved error handling (stop if critical status file can't be read).
- Dummy handling for ENHE-files (to allow their deletion though not processed).
- Some parameter (function call) changes and bug fixes.
- Improved logic for length checks and file deletion.

---

## Key Points for Onboarding

- **Batch Processing**: The design assumes there may be many files per run, so files are loaded into an array, sorted, and processed in batches.
- **Filename Parsing**: Important business logic is in parsing the file name to deduce type and order.
- **IFS API Usage**: Directory and file management is through IFS APIs, not native IBM i database files.
- **Error Handling**: Comprehensive logging and abort on errors, to ensure that upstream systems and operators can diagnose faults.
- **Status and Logging**: Tight integration with job status/logging, so operators or automated monitors can know the process state and errors.
- **Extensibility**: Each XML type is handled by an external program, allowing for modular, specialized processing.

---

## Miscellaneous

- **Language**: Many comments, variables, and file names are in Norwegian, reflecting the systemâ€™s organizational usage.
- **Constants**: Many IFS flags/constants are defined for use with the open/close/write APIs.
- **Data Structure Definitions**: For handling directory listings and file stat information as returned from IFS APIs.

---

## Output/Logging Examples

At the end, the program logs:
- Number of XML files found/processed.
- Number of acknowledgment files created.
- Each file name being processed.

---

This program is a robust, production-quality controller for the batch ingestion, processing, archiving, and management of XML files supplied by NOBB, with strong error handling and extensive logging. Understanding IFS operations and the external XML processing programs is key for effective maintenance and extension of this code.