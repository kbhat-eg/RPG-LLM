# RPG Program LL618R: Summing Records for ABC Analysis

This ILE RPG program is designed to aggregate individual records into subtotal groups for an ABC analysis â€“ a common business analysis to classify items according to their importance (e.g., in inventory management). The program processes records from an input file, groups and sums them according to break criteria, and writes the results to an output file.

The code is annotated for Norwegian-speaking developers, but all logic is presented in English below.

---

## 1. File Declarations

```rpg
flwa1l1    if   e           k disk    rename(lwa1pfr:lwa1l1r)
flwa2l2    o    e             disk    rename(lwa2pfr:lwa2l2r)
```
- **lwa1l1**: Input file, keyed access, external, named record format `lwa1l1r`.
- **lwa2l2**: Output file, external, named record format `lwa2l2r`.

---

## 2. Data Structures (DS)

### Break Key Structures

```rpg
d n_brd  ds           15
d  n_ogrp    2  0 overlay(n_brd)
d  n_hgrp    2  0 overlay(n_brd:3)
d  n_ugrp    3  0 overlay(n_brd:5)
d  n_vare    8  0 overlay(n_brd:8)
```
- **n_brd**: Current break key (15 characters).
- Overlays allow `n_ogrp`, `n_hgrp`, `n_ugrp`, `n_vare` to access parts of `n_brd`.

```rpg
d g_brd  ds           15
...
```
- **g_brd**: Group (previous) break key. Similar overlays.

### Parameter Record

```rpg
d p_prec ds         128
...
d  p_sort  1  0 overlay(p_prec:45)
```
- **p_prec**: Flat area holding run parameters (e.g., lower and upper range for fields, groupings, sort/break criteria, etc.).
- **p_sort**: Determines grouping level (1-item, 2-group, etc.).

### Local Data Area and Work Fields

```rpg
d                uds
d l_prog   ...
d l_user   ...
...
```
- User, firm, and other session-specific information.

```rpg
d w_ogrp  s   like(mlogrp)
...
d w_omst  s   like(mlomst)
d w_enhl  s   like(mlenhl)
```
- Work fields to store the current item's groupings, amounts, etc.

---

## 3. Main Processing Loop

### Initialization

```rpg
c     *inzsr        begsr
    ...
    eval n_brd = *zeros
    eval g_brd = *zeros
    ...
c                   endsr
```
- **INZSR**: Sets initial values for break fields and loads parameter area from the program entry parameter.

### Read and Process Records

```rpg
c     les           tag
c                   read      lwa1l1r                                60
c                   if        *in60 = *on
    move *on *inlr
    exsr brkto
    goto slutt
c                   endif
```
- Main loop begins with `les` (read). If end of file (`*IN60`), process last break, write totals and end.

#### Build Break Key (Bruddbegrep)
Break key (`n_brd`) is built based on grouping/sort parameter `p_sort`:

- **1: By Item** (`n_vare = mlvare`)
- **2: By Group** (`n_ogrp = mlogrp`)
- **3: By Group + Subgroup** (`n_ogrp`, `n_hgrp`)
- **4: By Group + Subgroup + Unit** (`n_ogrp`, `n_hgrp`, `n_ugrp`)

#### Save Current Fields

```rpg
eval w_ogrp = mlogrp
eval w_hgrp = mlhgrp
eval w_ugrp = mlugrp
eval w_vare = mlvare
eval w_enhl = mlenhl
```
- Save fields from the current input record for later use.

#### Test for First Record or Break

```rpg
if g_brd = *zeros
    goto neste
endif

if n_brd <> g_brd
    exsr brkto
endif
```
- On first record, skip break logic.
- If break key changes, execute break processing (`brkto`).

#### Accumulate Values

```rpg
c     neste         tag
eval w_omst = w_omst + mlsalg
eval w_lagv = w_lagv + mllagv
move n_brd         g_brd
move w_enhl        g_enhl
goto les
```
- Add current record's value (`mlsalg`, `mllagv`) to subtotal.
- Update previous break key for next iteration.

---

## 4. End of Job

```rpg
c     slutt         tag
...
eval mwomst = wtooms
eval mwlagv = wtolve
write lwa2l2r
```
- After all records, write grand totals to the output.

---

## 5. Subroutine: Break Handling (`brkto`)

This subroutine is called when a break in grouping occurs.

- Moves the firm number, set output grouping fields appropriately (depending on grouping), copies subtotaled values (`w_omst`, `w_lagv`).
- Writes the subtotal record to the output file.

```rpg
c     brkto         begsr
move l_firm mwfirm
move g_enhl mwenhl
select
    when p_sort = 1
        eval mwvare = g_vare
        eval mwogrp = g_ogrp
        eval mwhgrp = g_hgrp
        eval mwugrp = g_ugrp
    when p_sort = 2
        eval mwvare = *zeros
        eval mwogrp = g_ogrp
        eval mwhgrp = *zeros
    when p_sort = 3
        ...
    when p_sort = 4
        ...
endsl
eval mwomst = w_omst
eval mwlagv = w_lagv
write lwa2l2r
eval wtooms = wtooms + w_omst
eval wtolve = wtolve + w_lagv
eval w_omst = *zeros
eval w_lagv = *zeros
endsr
```
- After writing, resets the subtotal fields for the next group.

---

## 6. Parameter Handling

- Parameters are set at program start (`*inzsr` subroutine),
- The input string (`w_parm`) is mapped to `p_prec` DS, which overlays fields like `p_sort` that drive processing.

---

## 7. Key Working Variables 

- **n_brd / g_brd**: Current and previous break keys for detecting group changes.
- **w_omst / w_lagv**: Accumulators for the subtotaled fields.
- **wtooms / wtolve**: Accumulators for overall totals.

---

## 8. General Workflow

1. Initialize fields and parameters.
2. Read an input record.
3. Build the break key based on the specified grouping (item, group, etc.).
4. If the break key changes, write out the previous subtotal and reset accumulators.
5. Add current record's amounts to accumulators.
6. At end of file, write final subtotal and the grand total.

---

## 9. Typical Use Case

This program is typically run as a batch process, consuming a workfile and producing subtotals appropriate for an ABC class analysis. The degree of grouping is controlled by the `p_sort` parameter, allowing flexibility in summary level.

---

## 10. Summary

- **Purpose:** Aggregate (sum) records for ABC analysis by one of several groupings.
- **Input:** Work file with item/group/unit details.
- **Logic:** Subtotals by break fields, driven by a parameter.
- **Output:** Summary file with subtotaled results, then grand totals.

---

**Keywords:** break logic, subtotal, RPG, ABC analysis, group by, overlay, Norwegian comments, batch processing.