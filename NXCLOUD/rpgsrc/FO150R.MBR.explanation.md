# RPG IV Program Explanation: Order Header Maintenance (FO150R)

## Overview

This RPG IV/ILE program (`FO150R`) is used for maintenance of order header information in an order management system. The comments are predominantly in Norwegian, and the program handles:

- Display and editing of order data.
- Data retrieval and validation from various files (master data, status, user, customer, etc.).
- Screen field population and upper/lower-case conversion.
- Date and status validation.
- Integration with an external transportation/flow control system.
- Transaction logging.

Below is a detailed breakdown of each section and its purpose.

---

## 1. Header and Change Log

- `h option(*nodebugio) datedit(*dmy)`  
  Header specifies debug information and date format as day-month-year.

- **Change documentation** is maintained in comments, with references to amendments (e.g., "Nytt program", "Oppdatert med sporingsinformasjon").

---

## 2. File Declarations (`F-specs`)

- Files are declared for various purposes:
  - **Order status:** `fstsl1`
  - **User info:** `fusrl1`
  - **Order header (read/update):** `fohel1` (read), `fohelu` (update)
  - **Customer project:** `fkprl1`
  - **Customer master:** `rkunl1`
  - **Order info type:** `vinfl1`
  - **Sales code:** `ra09l1`
  - **Transport log:** `floglr` (added in later versions for integration)
- `fo150d` is a display file (`workstn`), used for the green-screen interface.

---

## 3. Data Definitions

### 3.1. User Space and Local Data Area

- Fields for user id, file group, file name, etc., extracted from local data area.

### 3.2. Parameters

- Input parameters such as company (`p_firm`), order number (`p_numm`), and suffix (`p_suff`).

### 3.3. Key Variables

- Variables to store keys for file lookups.

### 3.4. Working Variables

- Working variables for editing and temporary storage.
- Constants for converting to upper/lower case (`lo`, `up`).
- Boolean flags for transport integration, such as `b_trpl` and `u_802`.

### 3.5. Prototypes

- **CO402R**: External program for checking if external flow control is enabled.

---

## 4. Mainline Logic

### 4.1. Retrieve Order Information

- **`chain` on `fohel1`** (order header): Loads order data for editing.
- If not found, program ends.

### 4.2. Additional Data Fetching

- **Order status**: `chain` on `fstsl1`.
- **User details**: Set user variable then `chain` on `fusrl1`.

### 4.3. Screen Initialization

- Populates work fields (`b1numm`, `b1suff`, etc.) for the display screen from the database records.

### 4.4. Customer Info

- Retrieves and displays customer and customer project data as needed.
- Special logic (8.01) to ensure the right customer is shown if order, invoice, and project customers differ.

### 4.5. Order Info Type

- Fetches order type text for display if a type is filled in.

---

### 4.6. Display and Input Loop

- **Main loop (`exfmt b1win`)**:
  - Shows the input screen and processes user function keys.
  - F3 (exit), F4 (inquiry fields for item type or seller).

#### 4.6.1. Validation

- **Order type**: Must be valid and user-authorized.
- **Delivery date**: Must be a valid date after order and current date.
- **Seller code**: Must exist in the sales code table.
- Signals errors to screen indicators if invalid.

#### 4.6.2. Field Uppercase Conversion

- If the system is parameterized for uppercase entry, fields are converted using `xlate`.

---

### 4.7. Update Database

- Locks (`chain fohelu_key`) for update.
- Stores trimmed input fields back to the database record.
- Sets date, time, and user for audit.
- Updates the record.

---

### 4.8. Transport Integration (8.02+)

- If external flow control is enabled, and the order meets requirements, prepares logging and calls program `AP058R` to update the transport system.

---

## 5. Program End

- Sets `*inlr = *on` and returns to exit the program.

---

## 6. Initialization Subroutine (`*inzsr`)

- Maps input parameters to working variables.
- Constructs key lists for all file operations.
- Retrieves system date/time for later use.
- Calls `CO402R` to check if external flow control is enabled and sets flag (`u_802`) accordingly.

---

## 7. Key Points for Onboarding

- **File Driven**: The program is heavily based on record-level operations (`chain`, `reade`, `setll`).
- **Screen Handling**: Uses green-screen (`exfmt`) for I/O.
- **Data Integrity**: Multiple validation steps before writing changes.
- **Extensibility**: Modern extensions (8.xx) add transport flow integration, external program calls.
- **Indicators**: Uses classic indicator variables (`*in31` etc.) for error handling and screen messages.
- **Uppercase Handling**: Locale-sensitive (needed for Norwegian/Scandinavian letters).
- **Multi-Company & Multi-Order**: Most logic is parameterized over company (`firm`), order number, and suffix.

---

## 8. Typical Workflow

1. **Order selection:** Program is called with company, order number, suffix.
2. **Data retrieval:** Loads all relevant order and customer info.
3. **Screen display:** Shows user order header screen for editing.
4. **Input handling:** User edits data; function keys allow further lookups.
5. **Validation:** Checks all required data before saving.
6. **Update:** If OK, updates the database and logs where required.
7. **Transport integration:** If configured, notifies external transport system of changes.
8. **Exit:** Ends with cleanup.

---

## 9. External Dependencies

- **AP058R:** Logging/notification to transport system.
- **CO402R:** Checks if external flow/transport management should be invoked.
- **DDS Files:** All physical/logical files (order, customer, status, etc.).
- **Display File (`FO150D`):** Green-screen interface for this program.

---

## 10. Notable Code Patterns

- **Key lists** (`klist`/`kfld`) are used for efficient compound key access.
- **Error handling** uses screen indicators (`*in31`, `*in32`, etc.) for user feedback.
- **Use of `xlate`** for locale-aware uppercase/lowercase conversion.

---

## 11. Versioned Code

- New features and bugfixes are included as versioned blocks (e.g., changes marked `8.01`, `8.02`).

---

## Summary Table: Major Data Files

| File      | Purpose                                  |
|-----------|------------------------------------------|
| `fohel1`  | Order header (main order data)           |
| `fusrl1`  | User information                         |
| `fstsl1`  | Order status / code table                |
| `rkunl1`  | Customer master                          |
| `fkprl1`  | Customer project                         |
| `vinfl1`  | Order info type                          |
| `ra09l1`  | Sales code                               |
| `floglr`  | Transport log (integration)              |

---

## Developer Tips

- **Understand RPG indicators and screen handling** if coming from modern languages.
- **Test scenarios**: Validate all input paths, especially for date and status fields.
- **Transport integration logic** only activates if feature flag is set by `CO402R`.
- **Changes to customer/project logic** (8.01 section) are critical for proper display.
- **Error codes and indicator logic** drive the user experienceâ€”ensure you map these to the display file (`FO150D`).

---

This program is a classic, transaction-based, green-screen RPG application for order management, extended for modern integration scenarios.