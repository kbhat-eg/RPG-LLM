# Program Overview

This IBM ILE RPG program updates inventory records to ensure that all inventory items have their corresponding unit field populated. It specifically targets inventory records where the unit field is blank and copies the unit from the item master record if present.

Comments/documentation at the top explain:
- Program name: FX802R
- System: ASOFAK
- Description: Updates inventory (lager) records so that items missing their unit are updated from the item master.
- Change history is also included.

---

## File Specifications

```rpg
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
```
- **vlagl1**: Inventory master file (read) (renamed from `vlagpfr` to `vlagl1r`)
- **vvarl1**: Item master file (read) (renamed from `vvarpfr` to `vvarl1r`)
- **vlaglu**: Inventory detail file (update) (renamed from `vlagpfr` to `vlaglur`)

---

## Data Definitions

### Local Data Area (LDA) Fields

```rpg
d                uds
6.10 d l_user                911    920
d l_firm                944    946  0
```
- **l_user**: User ID from LDA (positions 911–920)
- **l_firm**: Firm/Company number from LDA (positions 944–946, 0 decimals)

### Key Variable Definitions

```rpg
d vvarl1_vare     s                   like(vvvare)
d vlaglu_vare     s                   like(vlvare)
```
- **vvarl1_vare**: A variable for item key (structure matches `vvvare`)
- **vlaglu_vare**: For inventory key (structure matches `vlvare`)

### Company/Firm Variable

```rpg
d w_firm          s                   like(vvfirm)
```
- **w_firm**: Holds the company/firm number for use in keys

---

## Main Program Logic

### Inventory Master Loop

```rpg
c     vlagl1_key    setll     vlagl1
c     vlagl1_key    reade     vlagl1                                 90
c                   dow       *in90 = *off
```
- Sets up and reads the inventory master file (`vlagl1`) by key, and loops through all records.

### Process Blank Unit Fields

```rpg
c                   if        vlenhl = *blank
```
- For each inventory record, checks if the unit field (`vlenhl`) is blank.

#### Look Up Item in Item Master

```rpg
c                   eval      vvarl1_vare = vlvare
c     vvarl1_key    chain     vvarl1                             91
c                   if        *in91 = *off and
c                             vvenhl <> *blank
```
- Copies the item number (`vlvare`) to the search variable.
- Looks up the item in the item master file (`vvarl1`).
- Continues if found (`*in91 = *off`) and the item's unit field (`vvenhl`) is not blank.

#### Update Inventory Detail Records

```rpg
c                   eval      vlaglu_vare = vlvare
c     vlaglu_key    setll     vlaglu
c     vlaglu_key    reade     vlaglur                                92
c                   dow       *in92 = *off
c                   eval      vlenhl = vvenhl
6.10 c                   time                    vledat
6.10 c                   time                    vletim
6.10 c                   eval      vleusr = l_user
c                   update    vlaglur
c     vlaglu_key    reade     vlaglur                                92
c                   enddo
```
- For each matching inventory detail record (`vlaglur`):
  - Sets the inventory unit field (`vlenhl`) to the item master unit (`vvenhl`)
  - Updates audit fields: date (`vledat`), time (`vletim`), user (`vleusr`)
  - Updates the record

---

### End Processing

```rpg
c     vlagl1_key    reade     vlagl1                                 90
c                   enddo
```
- Advances to the next inventory record in the main loop.

### Program Termination

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Tags the end of the program, sets `*INLR` to end the program, and returns.

---

## *INZSR Initialization Subroutine

- Sets up key lists for file operations.
- Retrieves the company/firm number from the LDA for use in file operations.

---

### Key Lists Setup

```rpg
c     vlagl1_key    klist
c                   kfld                    w_firm

c     vvarl1_key    klist
c                   kfld                    w_firm
c                   kfld                    vvarl1_vare

c     vlaglu_key    klist
c                   kfld                    w_firm
c                   kfld                    vlaglu_vare
```
- Defines how keys are built for each file (by firm and possibly also by item).

### Initialize Variables from LDA

```rpg
c                   eval      w_firm = l_firm
```
- Loads the firm number for key usage.

---

## Summary of Program Function

- Iterates through all inventory records for a company.
- For any inventory record with a blank unit field:
  - Finds the corresponding item master record.
  - If that record has a non-blank unit, updates all inventory detail records for that item with the unit from the item master, and populates audit fields (date, time, user).
- The process ensures inventory data integrity by filling in missing unit information for all relevant items.

---

## Key Fields and Terminology

- **vlenhl**: Unit in inventory record
- **vvenhl**: Unit in item master record
- **vlvare**: Item number in inventory record
- **vvvare**: Item number in item master record
- **vledat, vletim, vleusr**: Audit fields (date, time, user)
- **LDA**: Local Data Area (used for passing values such as firm and user)
- ***INLR**: Last record indicator, ends the RPG program

---

## Practical Notes

- The program is designed for batch correction of inventory data, not for real-time/transactional use.
- It uses RPG cycle-controlled file handling, common in legacy RPG programs.
- Change logs and comments are in Norwegian, but variable names and logic follow typical RPG patterns.

---