# RPG Program RA105R – Explanation

## Overview

This RPG III/IV (ILE) program is designed for maintenance of VAT (MVA) codes in a Norwegian financial/ERP system. It manages CRUD (Create, Read, Update, Delete) operations for VAT codes, utilizing subfiles for display and data entry screens for detailed editing. The code style is traditional, with heavy usage of subroutines, indicators, and level breaks for screen handling.

---

## High-Level Structure

- **Header Section:**  
  Sets debugging and date options, plus comments with history and indicator usage.

- **File Declarations:**  
  Several physical and logical file definitions, mainly variant logical views (with `rename`) of what seems to be VAT code and related registers.

- **Screen (Workstn) Definition:**  
  The program interacts via workstation (5250-style) screens, making heavy use of subfiles.

- **Data Definitions:**  
  Local Data Area (LDA) overlays for user and company info; variables for keys, subfile management, and business fields (e.g., MVA codes, rates, active dates).

- **Constants:**  
  Subfile page size, indicator explanations, and field usage documentation.

---

## Flow and Major Functionalities

### 1. **Main Loop – Subfile Display/Navigation**

- **Entry Tags:**  
  - `b2taga`, `b2tagb`: Entry points for main subfile display/processing.
- **Subfile Handling:**  
  - Calls `dsp_subfile` to display the subfile.
  - Processes function keys using `select/when` blocks for:
    - Exit (F3, F12)
    - Refresh (F5)
    - Create (F6)
    - Page up/down (RollUp/RollDown)
    - Home position and cursor management

---

### 2. **Positioning and Searching**

- **Subroutines:**
  - `forny`: Refreshes subfile based on current position/key.
  - `posisjoner`: Positions subfile on entered code or description and triggers a refresh.

---

### 3. **Subfile Processing (`subfile` Subroutine)**

Iterates through the displayed subfile records and processes row-level actions based on a "valg" (choice) field:
  - **2**: Edit (calls `xc2bld`)
  - **3**: Copy (calls `xk1win`)
  - **4**: Delete (calls `xd1win`)
  - **5**: Display/Show details (`xc2bld` in display mode)

After actions, the subfile row is updated and loop continues.

---

### 4. **Row Actions & Screens**

#### Create (C1BLD screen/logic)
- Handled in `xc1bld`, which manages create screen display, validation, and calls the edit screen (`xc2bld`) for details.

#### Edit/Display (C2BLD screen)
- Handled in `xc2bld`, which loads data for a specific code, allows editing, validates input, and updates relevant records (including change log and add-ons).
- It also checks for rate/date consistency and logs changes (from v8.01).

#### Copy (K1WIN screen)
- Handled in `xk1win`: pre-fills the screen with data from the source code, and after validation, performs a copy by calling the edit screen for the new code.

#### Delete (D1WIN screen)
- Handled in `xd1win`: displays delete confirmation and deletes the corresponding file record if confirmed.

---

### 5. **History Functionality (v8.01+)**

- **Subroutine `HistMva`:**  
  Gathers up to 7 historical rows from the change log for the selected MVA code and displays them in a window.

---

### 6. **Subfile Management**

- **Clear (`clr_subfile`):**  
  Blanks out subfile control and resets counters.
- **Fill (`crt_subfile`):**  
  Reads through the appropriate logical file(s), filling the subfile page with records. Handles both standard and addon (rat5pf) tables.
- **Page Up (`bck_subfile`):**  
  Repositions and fills the subfile with the previous page of records.

---

### 7. **Initialization (`*inzsr`)**

- Defines all Keylists for DB access (for code, description, updates, etc.).
- Preps variables and fills the initial subfile for display.

---

## Notable Practices and Style

- **Indicators Usage:**  
  Heavily uses indicators for screen and logic control (legacy RPG style).
- **Subfile Model:**  
  Uses classic subfile "window" techniques: page size, relative record numbers, first/last/visible row tracking.
- **DB I/O:**  
  Relies on chains, reads, writes, and updates with logical/physical file overlays.
- **Error/Validation Handling:**  
  Uses screen indicators and message windows for user feedback.
- **Change Logging:**  
  Maintains a history log for VAT rate/rule changes.

---

## Key Variables

- `w_srrn`, `w_sfrn`, `w_ssrn`, `w_spge`: Subfile paging and positional tracking.
- `b1valg`: Row action choice (edit/copy/delete/display).
- `c1ekod`, `k1ekod`, `b1ekod`: MVA code held in various contexts (header, copy, subfile).
- `ra05l1`, `ra05l2`, `ra05lr`, `ra05lu`, `rat5pf`, `ral5pf`: Logical files for main, description, read, update, addon, and change log tables.

---

## Business Rules Embedded

- Prevents creation of duplicate VAT codes.
- Validates dates and required fields before allowing update.
- Tracks and enforces consistency for changes in rates/dates.
- Allows paging, searching, filtering, and history view for VAT code maintenance.

---

## Extensibility

The code shows maintenance history comments with references to new GUI adaptations, SAF-T compliance, logbook integration, and further requirements as Norwegian VAT rules evolve.

---

## Conclusions

**This RPG program is a robust, screen-driven maintenance tool for VAT codes, supporting paging, search, edit, copy, delete, and historical auditing. It implements good data integrity checks and offers user-friendly error and information feedback via dedicated screens and indicators.**

---

### Onboarding Tips

- **Familiarize yourself** with the involved files (physical/logical) and their relationships.
- **Understand indicator handling** for display and input fields.
- **Learn the subfile paging model,** as it is central to user interaction.
- **Review business rules** for VAT code dates and percent changes, as these are carefully protected and audited.
- **Note:**
  - New requirements are often integrated as new subroutines or in the form of file extensions (e.g., rat5pf, ral5pf).
  - Knowledge of 5250 screen programming and legacy RPG is beneficial.
  - The code is modular with clear separation of subroutines for each task.

---