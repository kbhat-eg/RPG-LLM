# Documentation for RPG Program VT601R

## Overview

**Program:** VT601R  
**System:** ASOFAK  
**Description:** Offer Prices, Printout (`Tilbudspriser, utskrift`)  
**Purpose:**  
This program generates a printed report of offer prices (special promotional prices) for items, filtered and grouped by various product groupings and suppliers. The report structure includes hierarchical grouping (overgroup, main group, subgroup, supplier), and prints detailed lines for each applicable offer price. It is used to provide an overview of currently valid offer prices within specified selection criteria.

**Domain Context:**  
The program is tailored for a business dealing with inventory (potentially building materials, as indicated by "trelast sortiment") and supports reporting on time-limited promotional prices, grouped by company, product group, supplier, and campaign.

---

## Key Concepts and Data Flow

1. **Selection Criteria:**  
   The program receives a parameter list containing selection criteria such as company, date, campaign, group ranges, and optionally warehouse/department.

2. **Data Sources:**  
   The program reads from several physical files (tables), each representing master or transaction data:
   - **vvarl9:** Item master (with product group hierarchy)
   - **vtill1:** Offer price records
   - **vogrl1, vhgrl1, vugrl1:** Group description tables (overgroup, main group, subgroup)
   - **rlevl1:** Supplier master
   - **afirl1:** Company master
   - **vvlel1:** Additional item info (e.g., NOBB code, model, etc.)

3. **Grouping/Break Logic:**  
   The report is structured hierarchically, with headers printed when the group or supplier changes. This is managed via "break variables" (e.g., `w_ogrp_gml`, `w_hgrp_gml`).

4. **Offer Price Filtering:**  
   For each item, the program checks if there are valid offer prices matching the selection criteria (date, campaign, period). If none are found, the item is skipped.

5. **Detail Lines:**  
   For each valid offer price, detail lines are printed. Each item can have up to three price units (e.g., per piece, per box, per pallet).

6. **External Program Calls:**  
   - **VL710R:** Fetches additional item info (NOBB code, model, etc.).
   - **VL712R:** Used to determine the price group for a given warehouse/department.
   - **FA909R:** Calculates sales price including VAT.
   - **FØ705R:** Retrieves VAT factors for the company and date.

---

## Structure and Subroutines

### Initialization (`*inzsr`)

- **Parameter Handling:**  
  The program receives a 64-byte parameter structure (`p_list`), which is unpacked into named fields (company, date, campaign, etc.).
- **Key Lists:**  
  Key lists for file access are established for efficient indexed reads.
- **VAT Factors:**  
  VAT factors are retrieved using the FØ705R program.
- **Price Group Determination:**  
  If a warehouse is specified, the price group is determined via VL712R; otherwise, it is taken from the user area.

### Main Flow

1. **Header Initialization (`hode_init`):**  
   - Sets up report header information (user, date, company name, selection criteria).
   - Sets flags for which selection criteria are active.

2. **Processing/Printing (`behandling`):**  
   - Iterates through items in the specified group range.
   - Applies selection filters (company, group range, etc.).
   - For each item, checks for valid offer prices in `vtill1`.
   - On group/supplier breaks, prints appropriate headers.
   - For each valid offer price, prints detail lines (up to three units per item).

3. **Break Subroutines:**
   - **hode_ogrp:** Overgroup header.
   - **hode_hgrp:** Main group header.
   - **hode_ugrp:** Subgroup header (prints concatenated group descriptions and codes).
   - **hode_ldor:** Supplier header.

4. **Detail Line Printing (`detalj`):**  
   - Prints one or more lines per item, one for each price unit (up to three).
   - For each, calculates sales price including VAT via FA909R.
   - Handles NOBB code/model info if available.

5. **Overflow Handling (`overflow`):**  
   - Ensures headers are reprinted on page overflow.

---

## Special Design/Business Logic

- **Hierarchical Grouping:**  
  Items are grouped hierarchically (overgroup → main group → subgroup → supplier), and headers are only printed when a "break" occurs in the hierarchy.

- **Offer Price Matching:**  
  The offer price must match one of the following:
  - Be valid for the specified date (`d_dato` within `vtfdat` and `vttdat`).
  - Match the specified campaign.
  - Match the specified period (from and to dates).

- **Dynamic Key Construction:**  
  Keys for file access are dynamically set up based on the current company and group variables.

- **External Program Integration:**  
  Business logic for VAT and price group determination is encapsulated in external programs, allowing for centralized business rule management.

- **Multi-Unit Pricing:**  
  Items may have up to three units (e.g., piece, box, pallet), each with its own offer price and VAT calculation.

- **Backward Compatibility and Evolution:**  
  The code includes version comments indicating the evolution of business requirements (e.g., extension of price group to 2 digits, addition of new item info fields).

---

## File Relationships

- **vvarl9** (Item Master): Main driver for item iteration, filters by group and company.
- **vtill1** (Offer Price): Holds offer prices; filtered by item, price group, and selection criteria.
- **vogrl1, vhgrl1, vugrl1** (Group Descriptions): Provide human-readable names for groupings.
- **rlevl1** (Supplier Master): Provides supplier names for headers.
- **afirl1** (Company Master): Used for company name in headers.
- **vvlel1** (Additional Item Info): Used for NOBB code, model, etc. (building materials context).

---

## Notable Conventions & Patterns

- **Break Logic via "gml" Variables:**  
  Group/supplier break detection is handled by comparing current group fields to previous ("gml") values.

- **Use of Indicator Variables (`*inxx`):**  
  Standard RPG indicators are used for EOF, page overflow, etc.

- **Parameter Overlaying:**  
  The entry parameter is a flat structure, with fields overlayed at specific offsets for unpacking.

- **Externalized Business Rules:**  
  VAT and price group logic are external, promoting reuse and consistency.

- **Comments and Versioning:**  
  Extensive inline comments (in Norwegian) and version history facilitate maintainability and traceability.

---

## Key Variables and Their Roles

| Variable         | Purpose                                                      |
|------------------|-------------------------------------------------------------|
| `d_list`         | Parameter list (selection criteria)                         |
| `w_firm`         | Company number                                              |
| `w_lage`         | Warehouse/department                                        |
| `w_prgr`         | Price group (now 2 positions)                               |
| `w_mvat`         | VAT factor                                                  |
| `w_otxt`, `w_htxt`, `w_utxt` | Group descriptions for headers                  |
| `w_lnav`         | Supplier name                                               |
| `vvvare`         | Item number (from item master)                              |
| `vtprgr`         | Price group (from offer price)                              |
| `vvnobb`, `w_lv_nobb` | NOBB code (building materials reference)               |
| `b_tilb`         | Flag: is there a valid offer price for this item?           |
| `b_frst`         | Flag: is this the first header to be printed?               |

---

## External Programs

- **VL710R:** Retrieves additional item info (NOBB, model, etc.).
- **VL712R:** Determines price group for warehouse/department.
- **FA909R:** Calculates price including VAT.
- **FØ705R:** Retrieves VAT factors for company/date.

---

## Inter-module Relationships

- This program is tightly coupled to the master data structure of the company's ERP system, especially the item, group, supplier, and offer price files.
- It relies on external programs for business logic that is likely shared with other modules (e.g., VAT calculation, warehouse price group logic).

---

## Summary

VT601R is a report generator for offer prices, supporting complex selection and grouping logic, tightly integrated with master data and external business rule programs. Its design is modular, with clear separation of concerns (header, detail, break logic), and is built to accommodate evolving business requirements (as seen in version history and extension points). Understanding the group hierarchy, offer price matching, and external program interactions is key to maintaining and extending this program.