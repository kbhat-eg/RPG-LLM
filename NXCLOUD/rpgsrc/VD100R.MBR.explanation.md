# VD100R – Varesortiment-linje, vedlikehold

## Overview

This program, `VD100R`, is the central maintenance module for "Varesortiment-linje" (product assortment lines) in the ASOFAK system. It provides a subfile-based user interface for browsing, adding, editing, copying, and deleting assortment lines, supporting advanced positioning, validation, and context-sensitive lookups. The code is written in traditional (fixed-form) RPG IV and interacts with several physical and logical files, as well as external programs for lookups and additional logic.

This documentation is aimed at experienced RPG programmers who are new to our system or this domain.

---

## Business Domain Background

**Varesortiment** refers to assortments of items/products, often grouped by supplier (leverandør), various groupings (overgruppe, hovedgruppe, undergruppe), module (modul), and item number (varenummer). The assortment lines (linje) represent the detailed breakdown of these groupings for a given assortment.

The maintenance application supports:
- Browsing and positioning within the assortment lines (with subfile paging and positioning).
- Full CRUD operations (Create, Read, Update, Delete).
- Contextual lookups for all key fields (supplier, groups, items, modules).
- Business rules for required fields based on assortment type.
- Integration with tracking/audit information.

---

## File Usage and Relationships

The program interacts with several files, each serving a specific purpose in the assortment domain:

- **vsdtlr / vsdtlur / vsdtl1..6:** Logical and physical files for assortment lines, supporting various access paths (by supplier, group, module, item number, etc.).
- **vogrl1, vhgrl1, vugrl1:** Group hierarchy files for overgruppe, hovedgruppe, undergruppe.
- **rlevl1:** Supplier master.
- **vvarl1:** Item master.
- **vshel1:** Assortment header (for assortment-level metadata).
- **vd100d:** Display file, containing subfile and various maintenance screens.

**Naming conventions:**  
- Suffixes like `l1`, `l2`, etc., in file names and variables correspond to different key access paths or logical views.
- `b1*`, `b2*`, `c1*`, `c2*`, `d1*`, `k1*` prefixes indicate fields/screens for subfile, subfile control, create, edit, delete, and copy operations, respectively.

---

## Key Data Structures and Variables

- **Key fields:**  
  - `ldor` (leverandør/supplier), `ogrp` (overgruppe), `hgrp` (hovedgruppe), `ugrp` (undergruppe), `modn` (modul), `vare` (varenummer/item number)
- **Paging/subfile control:**  
  - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` – manage subfile pagination and record numbers.
- **Work variables:**  
  - `w_seqe` – indicates current positioning mode (O/H/U/M/V/blank for overgruppe, hovedgruppe, undergruppe, modul, varenummer, or default).
  - `b_oppr`, `b_feil`, `b_forn`, `b_anul` – flags for operation state, error, refresh, and cancellation.
- **User/session info:**  
  - `l_user`, `l_fnav` – user and function name from the user data area.

---

## Program Flow Summary

### 1. Initialization (`*inzsr`)
- Receives parameters: firm, assortment, and warehouse (from v6.20).
- Sets up all key lists for file access and positioning.
- Reads assortment header (`vshel1`) for context.
- Initializes the subfile for display.

### 2. Main Loop

- Uses a subfile-based UI for navigation and selection.
- Handles function keys for navigation (roll, rolldown), positioning, and special lookups (F13/F14 for supplier/item selection).
- Supports direct positioning by key fields (supplier, group, module, item).
- Invokes subroutines for:
  - Displaying the subfile (`dsp_subfile`)
  - Creating/refreshing subfile contents (`crt_subfile`, `clr_subfile`)
  - Paging (forward/backward)
  - Edit, copy, delete, and view operations via dedicated screens.

### 3. Subfile Handling

- **Subfile (`subfile` subroutine):**  
  Iterates through displayed lines, handling user actions (edit, copy, delete, view) based on selection. For each, loads the appropriate maintenance screen and updates the record as needed.
- **Paging:**  
  Implements both forward (`crt_subfile`) and backward (`bck_subfile`) paging with proper key handling for each logical access path.
- **Positioning:**  
  Supports positioning by any key field, using dedicated logical files for efficient access.

### 4. Maintenance Screens

- **Create (`xc1bld`) and Edit/View (`xc2bld`):**
  - Handles user input, field validation, and displays context-sensitive field descriptions.
  - On create, checks if the record already exists and prompts accordingly.
  - On save, updates or writes the record, including audit fields (user, date, time).
- **Delete (`xd1win`):**
  - Prompts for confirmation before deleting the selected assortment line.
- **Copy (`xk1win`):**
  - Allows copying an existing line to a new key; validates new key and checks for duplicates before proceeding.

### 5. Field Validation and Lookups

- **Validation (`sjekk_input`):**
  - Ensures at least one key field (supplier, group, or item) is entered.
  - Validates existence and relationships for supplier, group, and item fields.
  - Enforces business rules: e.g., if assortment type is 'C', item number is required; if 'P', supplier is required.
- **Lookups (`spørring`):**
  - Context-sensitive lookups for supplier, group, item, and module fields.
  - Calls external programs (`RL500R`, `VG510R`, `VG511R`, `VG512R`, `VV500R`, `JU500R`) for selection and description retrieval.

### 6. Auxiliary Functions

- **Description Retrieval (`hent_info`):**
  - Populates description fields for all key fields by chaining to the relevant master files.
- **Audit/Tracking:**
  - On update/write, tracks user, date, and time for both creation and modification.

---

## Design Patterns and Conventions

- **Subfile Pattern:**  
  The code uses a classic subfile pattern for interactive list maintenance, with support for paging, positioning, and selection-based actions.
- **Key List Usage:**  
  All file accesses use explicit key lists for clarity and maintainability.
- **Screen/Field Naming:**  
  Consistent use of prefixes (`b1`, `b2`, `c1`, `c2`, `d1`, `k1`) to distinguish between subfile, control, create, edit, delete, and copy contexts.
- **Indicator Usage:**  
  Program indicators are grouped and documented for specific purposes (function keys, subfile control, error/warning messages, work flags).
- **Modularization:**  
  Business logic is separated into subroutines for clarity and reuse.

---

## Integration Points

- **External Programs:**
  - `RL500R` – Supplier lookup
  - `VG510R`, `VG511R`, `VG512R` – Group hierarchy lookups
  - `VV500R`, `VV565R` – Item lookup/pick
  - `JU500R` – Module lookup
  - `FO714C` – Module description retrieval
  - `VD110R` – Supplier pick for assortment

- **Data Dependencies:**
  - Assortment header (`vshel1`) must exist for context.
  - All lookups and validations depend on the integrity of master files (supplier, group, item).

---

## Special Business Rules

- **Assortment Type Logic (vctype):**
  - If type is 'C', item number is mandatory.
  - If type is 'P', supplier is mandatory.
- **Hierarchical Group Validation:**
  - When specifying a group, must ensure the next level in the hierarchy is either specified or blank as appropriate.
  - All group lookups ensure the chain of overgruppe → hovedgruppe → undergruppe is maintained.

---

## Notable Implementation Details

- **Paging Logic:**  
  Subfile paging is managed via a combination of counters (`w_srrn`, `w_ssrn`, `w_spge`) and indicators to track the current, first, and last records on each page.
- **Positioning:**  
  Uses multiple logical files (`vsdtl1`..`vsdtl6`) for efficient direct access to any key level, supporting fast positioning and flexible navigation.
- **Error Handling:**  
  Uses indicators (31–79) to signal errors and warnings, which are surfaced via the display file.
- **Audit Trail:**  
  All updates capture user and timestamp information for both creation and modification, supporting traceability.
- **Extensibility:**  
  The design supports future extension with additional key fields or business rules by following the established patterns.

---

## Summary Table: Screen/Field Prefixes

| Prefix | Context                | Example field |
|--------|------------------------|--------------|
| b1     | Subfile record         | b1ldor       |
| b2     | Subfile control        | b2ldor       |
| c1     | Create screen          | c1ldor       |
| c2     | Edit/View screen       | c2ldor       |
| d1     | Delete window          | d1ldor       |
| k1     | Copy window            | k1ldor       |

---

## Key Takeaways for New Developers

- The program maintains a complex, hierarchical assortment structure, with strict validation and navigation requirements.
- Subfile navigation and action handling are central, with much logic dedicated to efficient paging and positioning.
- All key fields have context-sensitive lookups, and business rules are enforced both at the UI and data level.
- The codebase is modular and extensible, with clear separation between UI handling, validation, and data access.
- Integration with external lookup programs and master data is pervasive; understanding these dependencies is crucial for troubleshooting and enhancement.

---

## References

- **Physical/Logical Files:**  
  - Assortment lines: `vsdtlr`, `vsdtlur`, `vsdtl1`..`vsdtl6`
  - Group hierarchy: `vogrl1`, `vhgrl1`, `vugrl1`
  - Supplier: `rlevl1`
  - Item: `vvarl1`
  - Assortment header: `vshel1`

- **External Programs:**  
  - Supplier lookup: `RL500R`
  - Group lookups: `VG510R`, `VG511R`, `VG512R`
  - Item lookup: `VV500R`, `VV565R`
  - Module lookup: `JU500R`
  - Module description: `FO714C`

---

## For Further Exploration

- Review the display file (`vd100d`) for details on subfile and screen layouts.
- Examine the master files' DDS to understand field relationships and constraints.
- Explore the called programs for lookup logic and how they interact with the maintenance screens.

---

If you have questions about specific subroutines, business rules, or integration points, please reach out to the application architect or consult the referenced master files and external program documentation.