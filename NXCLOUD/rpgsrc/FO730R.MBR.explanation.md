```markdown
# RPG Program Explanation: FO730R

This RPG program, `FO730R`, is part of an application running on IBM i (AS/400) using the ILE RPG language. It is responsible for updating transaction/order lines — recalculating prices, discounts, and totals, then updating both order lines and headers in the database.

Below, we walk through the structure, data definitions, and the major logic of the program, highlighting its components and important enhancements over time.

---

## 1. Control Specification

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Sets program options: No debug I/O, date editing in day-month-year format.

---

## 2. File Declarations

```rpg
ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
... (others)
```
- Declares all necessary physical and logical files for orders (`fohel1`), order lines (`fodtl1`), item types (`vltyl1`), items (`vvarl1`), and additional line files (`fod2l1`).
- Files are opened for read or update as needed, and records are renamed for clarity.

---

## 3. Data Definitions

### Parameters (from *ENTRY PLIST*)

```rpg
d p_enor          s              1
d p_firm          s                   like(fofirm)
d p_numm          s                   like(fonumm)
d p_suff          s                   like(fosuff)
```
- Passed values indicate environment, company, order number, and suffix.

### Data Structures for Price Handling

#### For price-in

```rpg
d                 ds
d hirec                        120
d  hifirm                        3  0 overlay(hirec)
... (others)
```
- Packed structure to communicate with pricing routines/programs. Uses overlays to treat a buffer as individual fields.

#### For price-out

Similar structure as above (`horec`, `holety`, etc.)

### Working and Temporary Variables

- A host of variables for calculation and storage (sums, discounts, quantities, etc.)
- Special flags: 
    - `u_rgeb`: Is the return fee active?
    - `b_evar`: Is the item found in the item table?

---

## 4. Major Routines and Logic

### *INZSR - Initialization Routine

- Sets up key lists for all files.
- Extracts initial parameter values.
- Calls external program `CO402R` to determine if return fee logic should be active (`u_rgeb = *on` if so).

### Mainline - Processing Orders

#### 1. Fetch Order Header

```rpg
c     fohel1_key    chain     fohel1r
if not %found: goto avslutt
```
- If order header not found, terminates.

#### 2. Process Each Order Line

- Sets positioning and loops through all lines for the specified order.

##### a. Skip Text Lines

- Checks item type (via `vltyl1`). If it's a text line, skips processing.

##### b. Item Lookup

- Attempts to find the item in `vvarl1`. If not found, sets `b_evar = *off`.

##### c. Local Variable Setup

- Copies key amounts and discount values from the file buffer into working variables.

##### d. Price Calculation

- If `p_enor` (environment param) is provided:
    - If item was found and is type 'D', skips recalculation; these are manually priced items.
    - Otherwise, performs price lookup via `hent_pris` subroutine.

##### e. Quantity Adjustments

- If the value code is '-', invert the quantity (for returns or corrections).

##### f. Sum and Discount Calculations

- Calculates line value: net value after discounts (multiple discount fields supported).
- Handles both principal and two additional discounts, plus special discounts if applicable.

##### g. Return Fee Calculation

- If `u_rgeb` is *on, checks for an applicable return fee percentage and applies it to the line.

##### h. Update Order Line

- Reads update-capable record; if found, writes back new calculated totals and prices.

##### i. Totals Accumulation

- Accumulates the sums, discounts, and cost totals for updating the order header.

#### 3. Update Order Header

- After all lines are processed, updates the order totals in the header table.
- Calls an external program (`FA922R`) to update memo balances.

---

## 5. Subroutines

### `oppdat_hode` — Update Order Header

- Calculates adjustment amount based on current and new totals.
- Calls subroutine for adjusting related balances.
- Updates the order header file with new totals and tracking information.

### `hent_pris` — Fetch Price

- Prepares input structure for price lookup routines.
- If customer/project discount category overridden, zeroes those fields for correct price fetching.
- If the item is a "special order" (VA-item), sets relevant flags.
- Calls external pricing program (`VP900R`).
- If a valid price is returned, updates local price/discount fields.

### `hent_prisgr` — Fetch Price Group

- Calls an external program (`VL712R`) to determine which price group should be used for the item.

---

## 6. Noteworthy Enhancements & Logic

- **Return Fee Logic** (`u_rgeb`): Dynamically checks whether to apply a return fee to lines, based on a configuration program.
- **Special Item Handling** ('D' type items): Skips price recalculation for these, as they're to be priced manually.
- **Multiple Discounts & Campaigns**: Handles up to two standard discounts, up to two campaign discounts, and a special field for public/common discounts.
- **Date/Time/User Stamping**: Updates transaction records with edit date, time, and user for audit/tracking.

---

## 7. External Program Calls

- **CO402R**: Reads application configuration for whether return fees are active.
- **VP900R**: Central price/dicount calculation engine.
- **FA922R**: Memo balance adjustment.
- **VL712R**: Retrieves price group information.
- **FL710R**: Checks if discount category is overridden.

---

## 8. Key Patterns & Conventions

- Extensive use of KLISTs for keyed file I/O (CHAIN, SETLL, READE).
- Buffer overlays for communicating with external pricing routines.
- Heavy I/O error checking and branch-on-condition.
- Subroutine-based logic for modularity.
- Use of in-line calculation (`eval(h)`) to set high-precision results.

---

## 9. Maintenance Comments

- Inline change logs throughout the comments show the history of enhancements.
- Logic is often conditioned for backward compatibility.

---

## 10. What a New Developer Should Know

- The program's job is to recalculate line prices/totals and update both line and header records of an order.
- Pricing is complex and involves several external programs and data areas.
- Many fields and features (campaigns, returns, price groups) are toggled/configured via external controls.
- File access is fundamentally important — understanding the structure and indices of FOHEL*, FODTL*, VLTY*, VVAR* files is key.
- Changes in logic are tracked with comments and code branches, so study both the comments and the enhancement markers.

---
```