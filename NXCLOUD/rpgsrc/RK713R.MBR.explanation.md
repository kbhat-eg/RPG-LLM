```markdown
# RPG Program Explanation: RK713R (Overføring til Nordea-format)

This RPG program is designed to transfer financial data into the Nordea format. Below is a breakdown of its components and logic, aimed to help developers understand its structure and purpose.

---

## 1. **Header and File Declarations**

### **Header**
- `h option(*nodebugio)`: Turns off debug IO for performance.

### **File Definitions**
- Declares logical and physical files used (input and output) with possible record format renaming:
  - `raa9l1`, `refal1`, `rekul1`: Input files, record format renamed for internal use.
  - `ref2pf`, `rek2pf`: Output files for Nordea format.

---

## 2. **Data Definitions**

### **Local Data Area (LDA)**
- Retrieves user-specific or session-specific info.
    - `l_user`, `l_firm`: Used to identify the user/firm.

### **Work Variables**
- For processing and calculations, e.g.:
  - `w_sted`: Place or site (character 25).
  - `w_klie`: Client number (packed 4 digits, no decimal).
  - `w_bsum`: Sum of invoices (packed 13 digits, 2 decimals).
  - `w_btyp`: Batch type.
  - `w_date`, `w_dato`: Current date in different formats.

### **Key Variables**
- Used for chaining and record selection by key:
  - `w_firm`: Company number, type matches the file’s field.

### **Data Structures**
#### **Invoice Line Structure**
- Defines a 256-char record, overlays individual fields using `overlay`, such as:
  - `d_aart_1`: Record type (1 digit)
  - `d_bunt_1`: Batch number, etc.

#### **Customer Table Structure**
- For customer data to Nordea, overlays various pieces of information (name, address, telephone, etc.) onto a 256-character block.

#### **Batch Header Structure**
- For batch information records, overlays fields onto an 80-character record.

---

## 3. **Mainline Logic**

### **Initialization**
- Calls `*inzsr` subroutine to set up working keys, variables, and values.

### **Call to Summing Program**
- `call 'RK714R'`: Calls an external program, passing variables to sum invoice amounts and return the sum and batch type.

### **Batch Header Output**
- Calls subroutine `xopd_bunt` to write a batch header record to Nordea file.

### **Process Invoice Transactions**
- Reads each customer transaction from `refal1`:
  - For each, calls `xopd_fakt` to write invoice record to output.
  - Continues until end of file.

### **Process Customer Register**
- Reads each customer from `rekul1`:
  - For each, calls `xopd_kund` to write customer info to output.
  - Continues until end of file.

### **End Program**
- Tags `avslutt` (`end` in Norwegian), sets last record indicator, and returns.

---

## 4. **Subroutines**

### **xopd_bunt: Batch Header Output**
- Adjusts sign of sum if needed (makes value positive).
- Sets batch number based on batch type.
- Sets various fixed header fields.
- Writes batch header to Nordea file (`ref2pfr`).

### **xopd_fakt: Invoice Line Output**
- Sets batch number per type.
- Fills structure using values from input file.
- Ensures amount is positive (changes sign if needed).
- Sets invoice and due dates.
- Writes the invoice record to Nordea file.

### **xopd_kund: Customer Table Output**
- Moves and formats customer data into the output structure.
- Fills in both literal and field-derived values.
- Writes customer record to Nordea file (`rek2pfr`).

### **\*inzsr: Program Initialization**
- Prepares key lists for each file.
- Loads firm number from LDA.
- Gets the current date.
- Reads client number from status table.

---

## 5. **Special Notes**

- **Overlaying** fields onto a data structure is used for efficient record formatting for output.
- **External Calls:** External program `RK714R` is used for summing invoice amounts, separated from this program logic.
- **Output Formatting:** All output records are carefully structured for Nordea import.
- Comments are in Norwegian; field and variable names are typically abbreviations of Norwegian terms.
- **Error Handling:** Minimal; assumes all reads are valid, only uses `%found` after chaining for client number.

---

## 6. **Key Points for New Developers**

- **File mapping** is crucial; know what each file (input/output) contains.
- **Subroutines** encapsulate output format logic for batch header, invoice, customer.
- **Data structures** are overlaid for efficient block writing.
- **Program flow**: initialize → sum invoices → write batch header → process and write invoice lines → process and write customer data → end.
- **Modularity:** Some logic is delegated to other programs (e.g. summing invoices).
- **Assumptions**: Amounts always positive in target format; date handling is simplified.

---

If you are onboarding to this code, focus on:
- Understanding input and output file layouts.
- How data from input is transformed/formatted for Nordea.
- The relationship between batch summary, invoice detail, and customer master records.
- The business logic behind batch typing and record formation.
```