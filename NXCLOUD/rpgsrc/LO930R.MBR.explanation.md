# RPG Program LO930R – "Utskrift av Pakkseddel" (Packing Slip Printout)

This is a comprehensive, production-grade ILE RPG (RPG IV) program responsible for generating a packing slip ("Pakkseddel") for orders in an ERP system. The program handles both traditional print output and, in "PDF mode," exports the document as XML for downstream processing (e.g., archiving, JasperReports, or emailing). The program is highly parameterized, version-controlled, and richly commented.

Below is a detailed walkthrough, broken up into logical blocks so an RPG developer can get a solid understanding and quickly onboard.

---

## 1. **Header / Metadata / Version Control**
- **Title & Description**  
  The `H` specs and comment blocks describe the program name (`LO930R`), function (packing slip printout with prices and line totals), and version history.
- **Options**  
  - `option(*nodebugio)`: disables debug I/O.
  - `datedit(*dmy.) decedit('0.')`: default date/decimal edit.
  - Bound to the `CGIDEV2` service program for dynamic web/XML functionality if PDF/Jasper output.
- **Change Log**
  Extensive versioning for all code modifications, showing a mature and evolving piece of software.

---

## 2. **File Declarations (`F` specs)**
- **Input Files**  
  Declares a set of physical and logical files, many with `RENAME` to local record formats. Examples:
  - `LPSOL1` → Orders
  - `LSTSL1`, `VOTYL1`, `VLTYL1`, `FOHEL1`, `LOHEL1`, `LODTL1`, `LOTXL1`, `VVARL1`, etc.: Related to orders, customers, suppliers, and products.
- **Output File**  
  - `LO930P`: Printer file for the packing slip if traditional print is used.

---

## 3. **Data Structure and Variable Definitions (`D` specs)**
- **Special Purpose Data Structures**
  - `DS`: For "Foretaksnummer" (national company/organization number), composite of fields for formatting.
  - `UDS`: For accessing the Local Data Area (LDA) to pick up job parameters, user info, etc.
- **Work Variables & Parameters**
  - Many working fields (`w_*`), parameters (`p_*`), and XML/Jasper-specific fields.
  - Control flags for output mode (`b_pdfp`, etc.).
  - Mail and recipient fields when in email/PDF mode.
  - Separate storage for text fields, addresses, line items, batch numbers, etc.

---

## 4. **Input Record Format Declaration (`I` specs)**
- Example: `ILPSOL1R` is defined for LPSOL1 file, field `LKSSRT` (possibly sorting sequence).

---

## 5. **Main Logic – Core `C` Specs and Structure**

### a. **Main Record Routing**
- The program works as a "cycle" program, processing records sequentially (`01FCYCLE`).
- Records are routed by type:
  - Header (`LKSKOD = 'H'`) → TAG01 (calls header subroutine)
  - Detail/line (`LKSKOD = 'V'`) → TAG02 (calls detail subroutine)
  - Text/comment (`LKSKOD = 'K'`) → TAG03 (calls text subroutine)
  - Program ends after processing (`GOTO XSLUTT`).

### b. **Header Processing (TAG01, TAG01A)**
- **Order Lookup:** Loads order header info using keys (firm, order number, suffix).
- **Dates Handling:** Copies date fields and checks for valid values.
- **Supplier Lookup:** Loads supplier data, copies to header fields, checks for 'one-time supplier'.
- **VAT Calculation:** Calls external program (`F0705R`) to get VAT rates.
- **Delivery Address Handling:** Populates delivery name/address either from the order, from the customer if linked, or from one-off addresses.
- **Handles other reference fields:** delivery date, supplier ref, delivery method, requisition number, order number.
- **Seller/Department Info:** Looks up seller and department details for the header.
- **Output:** Writes report headers (`A1HDR` or `A4HDR`) or writes XML/Jasper tags if in PDF mode by calling the relevant subroutine.

### c. **Detail Line Processing (TAG02)**
- **Order Line Lookup:** Using key info, gets the detail line.
- **Line Type Handling:** Checks for specific line types (skip certain types).
- **Item Lookup:** Gets product info.
- **Quantity with Variable Decimals:** Sets up the quantity in 0-3 decimal places based on configuration.
- **Pricing and Calculation:** Copies price fields, calculates discounts, determines if VAT applies, computes line total and adds to running total.
- **Length Specification:** If specified, special length details are output.
- **Output:** Writes the detail line to print or XML tag depending on output mode.

### d. **Text Line Processing (TAG03)**
- **Text Line Lookup:** Retrieves associated text/comment lines.
- **Special Handling:** Handles whether to print at the end or immediately based on line number and "oppsamling" (accumulation).
- **Output:** Writes text line or, in PDF/XML mode, manages XML text sections.

### e. **Total Processing (T1TOT)**
- **Footer and Totals:** Checks if enough space remains on the page, writes totals (`T1TOT`), handles additional text lines at the end.
- **Triggers End of XML Sections:** In PDF mode, writes trailing XML tags and, if enabled, archive and meta tags.

---

## 6. **Supporting Subroutines**

### a. **Overflow Handling (XOVRFL)**
- Manages page overflow by writing headers and resetting line counters.

### b. **Length Specification Details (len_spec)**
- Looks up and writes (or XML-exports) length-specific information for special sales lines.

### c. **Initialization (XSTRSR)**
- Sets up initial program variables, loads firm info, initializes working fields, looks up order type, etc.

---

## 7. **PDF/XML Export & Jasper Integration ("pdf" marked code)**
- **Environment Setup (`xml_envm`):** Sets up batch, user, company, jasper template, logos, etc., and writes them into the XML buffer.
- **Mail Handling:** If emailing is needed, it configures the appropriate email commands in the XML and scans/cleans all strings for invalid characters.
- **Header, Details, Text, and Totals (`xml_head`, `xml_deta`, `xml_spec`, etc.):** For each report section, writes relevant XML tags and data, carefully handling special characters.
- **Meta Tags (`xml_end`):** Adds searchable/archive metadata (e.g., order number, supplier, date, user).
- **Print Handling:** Gathers printer details (like drawer, copies), and validates output queue.
- **End Processing (`xml_endpackl`, `xml_end`):** Finalizes XML file, writes to stream file in IFS, and, if needed, notifies a data queue for a downstream "sniffer" process.

---

## 8. **Subroutines for Text Conversion and Clean-up**
- Calls to `'AP613R'` are used to scan and sanitize all text that will be output to XML, to ensure special characters are handled correctly.

---

## 9. **Department and Seller Info Lookup**
- Subroutine `hnt_avde`: Looks up and fills department (avdeling) information for inclusion in output. Handles special cases where info must come from department (e.g., email, web).

---

## 10. **Key Lists for File Access (`KLIST/KFLD`)**
- Key lists are defined for all major file access patterns, for header, detail, supplier, customer, etc. Used with `CHAIN`, `SETLL`, and `READE` operations.

---

## 11. **Initialization Routine (`*INZSR`)**
- Sets up all major like-named work fields, zeroes out accumulators, and chains to files for company, order type, and, if using PDF, prepares XML/Jasper environment.

---

## 12. **Comments and Naming**
- **Extensive comments** (much in Norwegian) explain purpose, business logic, and *why* things are done.
- **Naming** is consistent: `A1` = header, `D1` = detail, `E1` = extra/text, `T1` = total.
- **Flags** like `*IN31`, `*IN36`, etc., are used to mark data presence/absence for conditional logic.

---

## 13. **External Calls**
- Calls many external routines for VAT, mail, scanning/conversion, order type, etc. Most calls are parameterized and support easy extension.

---

## **Summary of Core Functionality**
- Reads and processes order, detail, and text lines from a database.
- Outputs formatted packing slip to printer or creates an XML document (for JasperReports, archiving, or email).
- Handles internationalization, company/supplier/customer data, item details, pricing, and delivery details.
- Robust error handling, versioning, and a clean separation of business logic.
- Can trigger downstream processes (like Java sniffers) via data queues.

---

## **Key Takeaways for the Developer**
- **Main flow**: Record routing by type → subroutine call → process database → write to print or XML.
- **Output mode**: Controlled by flags from LDA; branching logic for print vs. PDF/XML/Jasper.
- **Expansive configuration**: Many variables and key lists—familiarize yourself with each file and how keys are constructed.
- **Subroutines**: Most core logic is in subroutines; understand the calling patterns.
- **Extensible**: Strong scaffolding for adding fields, files, or output destinations.
- **Debugging**: If troubleshooting, check file accesses, flags, and all external program calls.

---

## **Onboarding Advice**
- **Start by tracing a single order** through the program for both print and PDF/XML modes.
- Examine how each major data structure (header, line, text) is filled from the database.
- Study the XML subroutines if working on integrations/exports.
- Review key lists and their relationship to the file structure.
- For changes, follow the versioning/comment style established in the code.

---

**This is a flagship RPG report program: it’s elaborate, robust, and central to the business process of order fulfillment and documentation.**

If you need a technical deep-dive into any specific block or subroutine, just ask!