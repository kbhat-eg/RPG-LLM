```markdown
# RPG Program `VI100R` Explanation

This RPG program, written for IBM i (AS/400) using the ILE RPG language, manages a maintenance screen for "p�slag-hode" (surcharge header) and associated details. The program appears to support operations like viewing, adding, copying, editing, and deleting surcharge headers, with navigation and search features through subfile lists. Much of the code relates to handling user interaction via display files (screens), data validation, and data file access.

---

## 1. **Header and Metadata**

- **Directives:**
  - `h option(*nodebugio) datedit(*dmy)`: Sets compiler options, disables debug for IO, and specifies date format day/month/year.

- **Comments:** (Starting with `*`)
  - System, program, author info, changelog, and clarification of which indicators are used for what (e.g., function keys, error handling, etc.).

---

## 2. **File Declarations (`F-Specs`)**

- **Database Files:**
  - `vphel1`, `vphel2`, `vphelr`, `vphelu` — Various access paths over the surcharge header file.
  - `vpdtlr`, `vpdtlu` — Access paths for surcharge detail lines.
  - All use `rename` to alias the record format as used in this program.

- **Display File:**
  - `vi100d` — The screen definition (workstation), with subfile support (`sfile(b1sfl:w_srrn)`), and `infds(dspfbk)` to capture display feedback.

---

## 3. **Data Area and Data Structures**

- **User Data Structure (`uds`):**
  - Extracts user, firm, and other data (positional fields) from the LDA (Local Data Area).

- **Display Feedback Data Structure (`dspfbk`):**
  - For capturing current record number of the subfile, among other feedback data.

---

## 4. **Variables**

- **Key variables** for file access are defined with `like()` attributes for field compatibility.
- **Subfile and navigation variables:** `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc., supporting subfile paging and cursor tracking.
- **Flags/booleans:** (one-byte) such as `b_oppr`, `b_forn`, `b_anul`, `b_feil` for process flow.
- **Constants:** e.g., `c_sfil` for a subfile page size.

---

## 5. **Special Field and Screen Descriptions**

Explains the purpose of subfile variables and lists the included screen formats (e.g., B1SFL, B2CTL, K1WIN, C1BLD, etc.), each serving different functions like listing entries, providing control footers, inputting new keys, message windows, and so forth.

---

## 6. **Main Program Flow (Control Spec and Subroutines)**

The code is largely structured with subroutines (`begsr ... endsr`) and labels (`tag`). Key points in the logic:

### **A. Main Loop and Navigation**

- **Entry Point (`b2taga`, `b2tagb`):**
  - Sends initial screen (`write b2cmd`).
  - Calls `dsp_subfile` to display subfile list and waits for user input.

- **Function Key Handling:**
  - Uses RPG indicators (`*inkc`, `*inkl`, etc.) to determine which action the user requested.
    - F3/F12: Exit program.
    - F5: Refresh list.
    - F6: Add new entry.
    - Roll/rolldown: Paging.
    - Home: Position cursor.
    - Otherwise, processes subfile records.

- **Exit (`avslutt`):**
  - Sets LR indicator (`*inlr = *on`) to signal program end.

### **B. Subroutines**

#### 1. **forny (Refresh Subfile)**
   - Positions the database file to the current subfile record.
   - Sets the appropriate access path depending on sorting (by "beskrivelse" [description] or key).
   - Clears and rebuilds the subfile.

#### 2. **posisjoner (Position Subfile)**
   - Positions the list based on user search (by key or description).
   - Clears and rebuilds the subfile at the new position.

#### 3. **subfile (Process Subfile Rows)**
   - Loops over records in the subfile.
   - Processes user actions (edit, copy, delete, view, maintain lines), calling the corresponding subroutines.

#### 4. **xc1bld (New Entry Screen)**
   - Handles the dialog for creating a new surcharge key.
   - Validates uniqueness, shows notification if duplicate, then jumps to the maintenance screen for actual entry data.

#### 5. **xc1msg (Duplicate Entry Message)**
   - Displays a message if the user tries to create a duplicate key.

#### 6. **xc2bld (Maintain/Edit/View Screen)**
   - Manages the main data entry/edit/view panel for a surcharge header.
   - Handles both updates and inserts depending on whether the record exists.
   - Updates subfile and marks for a refresh if needed.

#### 7. **xd1win (Delete Window)**
   - Handles deletion of a surcharge header and associated detail lines.

#### 8. **xk1win (Copy Window)**
   - Handles copying an existing surcharge header to a new key, including detail lines.

#### 9. **clr_subfile (Clear Subfile)**
   - Flags to clear and resets subfile navigation variables.

#### 10. **crt_subfile (Build Subfile)**
   - Pages through the header database to fill the subfile with the appropriate page-size of entries, either in key or description order.

#### 11. **bck_subfile (Page Back in Subfile)**
   - Moves to the prior page in the list, using read previous logic.

#### 12. **dsp_subfile (Display Subfile)**
   - Handles display and updating indicators for subfile control.

#### 13. **\*inzsr (Initialization Subroutine)**
   - Defines key lists for all relevant file access.
   - Fetches firm number from the LDA.
   - Initializes subfile for first display.

---

## 7. **Other Key Points**

- **Indicators:** The program utilizes many indicators (`*inXX`) for RPG-style state/flow management, particularly for subfile and screen interactions.
- **Data File Access:** All files are keyed for fast access/positioning.
- **Subfiles:** This RPG pattern is common for "work with" screens: essentially a paged, scrollable list with edit, copy, delete, and add actions per row.
- **Function Key Management:** The program supports standard IBM i function keys for user navigation and control (F3, F5, F6, etc.).
- **Data Validation:** Entry fields are checked for blank input, duplicate keys, etc.

---

## 8. **Summary Table of Key Screens/Functions**

| Screen/Record Format | Purpose                                    |
|----------------------|--------------------------------------------|
| B1SFL                | Subfile record – main list                 |
| B2CTL                | Subfile control record – headings, footer  |
| B2CMD                | Command key prompt                         |
| C1BLD                | New key input                              |
| C1MSG                | Duplicate key message window               |
| C2BLD                | Data entry/edit/view                       |
| D1WIN                | Delete confirmation window                 |
| K1WIN                | Copy confirmation window                   |

---

## 9. **Typical Usage Flow**

1. **Start:** User sees a list of surcharge headers in a subfile.
2. **Navigation:** User pages through or searches for a specific key or description.
3. **Edit/View:** User selects a row to edit/view (or F6 to add new).
4. **Copy/Delete:** User chooses to copy or delete using row actions.
5. **Update:** After changes, subfile is refreshed.
6. **Exit:** F3/F12 ends the program.

---

## 10. **Conclusion**

This program is a typical AS/400 (IBM i) subfile maintenance application, supporting standard list management features for a "surcharge header" file, including add, edit, delete, copy, search, and navigation, with robust validation and multi-user safety via keyed access.

The use of indicators, subfiles, and modular subroutine blocks makes it maintainable and extensible.
```