```markdown
# RPG Program: JR805R

## Overview

This RPG III/IV program is used for reading a file with the record format `OPTI_OST` and updating product prices based on data from an input file (in "LALUND" format, or SDV-format in later revisions). The update is performed by matching products using one of several possible keys: NOBB number, EAN number, or supplier item number. The program is designed to maintain price information in the LVR (presumably a product/price database).

The program contains several subroutines for extracting fields from a delimited input line, looking up products in master files, updating or inserting price records, and handling program initialization.

Some comments and variable names are in Norwegian. Here is a structured, English-language explanation for onboarding developers.

---

## Main Sections of the Program

### 1. File Declarations

- **Input, Update, Output Files**: Multiple files are declared for reading and updating master/product/price tables, with use of `RENAME` for record formats to allow reuse of file names and data structure overlays.
    - Examples: `jrvapf`, `jrapl1`, `jvarl8`, `jvarl3`, `jvarld`, `jvpkl3`, `fenkl1`, `jvarlu`, `jvdtlu`, `jstslu`, `jvpklu`, `jvprlu`.
- **File Processing Types**: Files are opened for input (`I`), update (`U`), or output (`O`). Some are keyed access (`K`).

### 2. Data Structures

#### Parameter Data Structures

- `p_list` (parameter from *entry): 32 character parameter for incoming values.
- `d_list`: DS (Data Structure) overlay of `p_list`, breaks down into:
    - `d_firm` (3,0): Company number.
    - `d_rapp` (2,0): Reporter code.
    - `d_dato` (date): Date field, ISO date format.

#### Local Data Area

- Contains user info (`l_user`, etc.).

#### LALUND/OPTI_OST Record Format (Input Line Structure)

- `d_inpu` (237): String buffer for the input line.
- Overlays for all input fields, e.g., product group, EAN, supplier's item number, descriptive text, prices, NOBB, supplier code, etc.
- Each field is pulled from a semicolon-delimited input line.

#### Key Variables

- Variables for the keys used in file lookups, such as NOBB number, EAN number, supplier/item number, etc.

#### Miscellaneous Variables

- Work variables for company, quantities, EANs, price status, etc.
- Constants for digit validation and zero filling.

---

## Main Logic Flow

### *INZSR (Initialization Subroutine)

- Entry parameter (`p_list`) is parsed into `d_list`.
- Company number is set in `w_firm`.
- Key lists are defined for various file lookups.
- Other run-time initialization done here.

### Mainline Flow

1. **Get Reporter Information**
    - Uses `d_rapp` from entry parameters to `CHAIN` (lookup) reporter details from the `jrapl1` file.
    - If not found, program exits.

2. **Process Each Input Record**
    - Reads `jrvapf` (input, likely the pricing update file).
    - For each record, calls subroutine `OPPDATER` (update logic).
    - Loops until EOF.

3. **Program End**
    - Sets *INLR (last record indicator) to *ON to close files and exit.

---

## Subroutines

### OPPDATER (Product/Price Update)

- **utled_ds**: Extracts individual fields from semicolon-delimited input line into data structure overlays.
- Skips record if required subfields (group) are blank.
- Starts lookup/update logic:
    - **Match by NOBB Number**: If present and not blank/zero, tries to find product in `jvarl3`. Goes to next phase if found.
    - **Match by EAN**: If EAN exists, look up in `jvarld` and (version 6.30) also in `jvpkl3` for packaging EAN.
    - **Match by Supplier Item Number**: If still no match, tries to find using supplier and item number in `jvarl8`.

- If no match by any key, skips record.
- If found, calls `OPPD_PRIS` to update price.

---

### OPPD_PRIS (Create/Update Product Price)

- Deletes any existing price records for the supplier on the product (loops through any matches in `jvprlu`).
- Fills in fields for new price record:
    - Product and supplier keys.
    - Price fields constructed from parsed input.
    - Sets timestamps (write and edit times).
    - Writes the new price record to the file.

---

### UTLED_DS (Parse/Extract Input Line)

- Parses the input string (`jrvrad`) using `%scan` for semicolon delimiters and `%subst`/`%trim` for field extraction.
- Fields are extracted in the order listed in the DS, e.g., product group, EAN, item number, descriptive texts, prices, NOBB, supplier, etc.
- Handles cases where the last field may not have a delimiter.
- There is commented-out code for price formatting to ensure length and decimals.

---

## Keylists (KLIST)

Keylists (`KLIST`/`KFLD`) are defined for all major logical lookups (reporter, product via various keys, unit conversion, price update, etc.).

---

## Noteworthy Features

- **Flexible Matching**: Multiple ways to match a record (NOBB, EAN, supplier/item).
- **Full Record Overlay**: Uses record overlays to parse input quickly into usable fields.
- **Field Extraction Logic**: Handles delimited input with careful substringing.
- **Price Deletion/Insertion**: Avoids duplicates by always deleting the old price before adding a new one.
- **Date/Time Handling**: Sets correct edit and creation times for each update.
- **Company Support**: Supports updating for different companies via parameter.

---

## Common Use-case

This program is typically used as a batch utility to update your product master file with new prices from external files (from supplier, etc.), ensuring that only the price for the relevant supplier is updated, based on a best-effort match to internal item numbers, NOBB, or EAN.

---

## Error Handling

- Uses indicator variables: *IN90, *IN91, *IN92 for error/EOF checks on CHAIN/READs.
- Skips records if required keys/fields are missing or no product match is found.

---

## Summary Table

| Functionality                | Mechanism                                                             |
|------------------------------|----------------------------------------------------------------------|
| Input parsing                | Semicolon-delimited, parsed in subroutine `UTLED_DS`                 |
| Product lookup order         | NOBB → EAN → Supplier/Item Number (stop at first match)              |
| Existing price handling      | Deletes prior price records for supplier before insert               |
| Timestamping                 | Updates date/time fields using `TIME` operation                     |
| Parameterization             | Handles company/reporter/date via entry parameters                   |
| File/record overlays         | Maximizes code reuse and flexible parsing using overlays             |
| Error/skip logic             | Uses indicator variables and GOTO/IF logic for EOF/missing data      |

---

## Comments on Maintenance

- This program is written in traditional fixed-format RPG, with later enhancements (6.30, etc.).
- For better maintainability and modernization, consider converting overlays and field extraction logic to free-format RPG IV.
- Pay special attention to possible changes in input file format or field order, as much of the code relies on strict positional parsing.

---

## Key Takeaway

This program is a robust utility for updating supplier prices for products in an AS/400 (IBM i) environment, designed to flexibly match products and safely update pricing while handling multiple input structures and company contexts.
```