# RPG Program RL110R – Explanation and Walkthrough

This is a classic IBM ILE RPG (Report Program Generator) application, primarily used for maintaining (viewing, updating) voucher/posting records for suppliers (vendors). The code manages display files (subfiles for lists) and various physical and logical files for underlying data storage.

## 1. Program Overview

- **System**: ASOKON
- **Program**: RL110R
- **Description**: Supplier postings – voucher/supplier entry and maintenance.
- **Main Features**:
  - Subfile-based screen for displaying and editing entries
  - Navigation and positioning logic
  - Data validation and update
  - Use of several files: `RLTRLC`, `RLTRL2`, `RLEVL1` (postings and supplier master)
  - Calls to other programs for code lookups and descriptions

---

## 2. File Declarations

```rpg
frltrlc    if   e           k disk    rename(rltrpfr:rltrlcr)
frltrl2    if   e           k disk    rename(rltrpfr:rltrl2r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
frltrlu    uf   e           k disk    rename(rltrpfr:rltrlur)
frl110d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

**Key points**:
- `frltrlc`, `frltrl2`, and `frltrlu` are logical files over posting records, accessed by different keys (voucher number, supplier, etc.).
- `frlevl1` is the supplier master.
- `frl110d` is the display file with subfile `b1sfl` and an information data structure `dspfbk`.

---

## 3. Data Areas and Data Structures

Local Data Area (LDA) is mapped into variables for user, company, and name, used for defaults and tracking.

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```

Information Data Structure for device feedback (e.g., cursor position):

```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```

---

## 4. Key Variables

Variables used for key fields and navigation are defined, such as `rltrlc_raar`, `rltrlc_biln`, `rltrl2_levr`, etc. They match the structure of the database files.

Control and bookkeeping variables like `w_stel`, `w_spge`, `w_srrn` (for subfile row numbers), and flags like `b_valg_ok`, `b_forn`, `b_feil` for option handling and error status.

---

## 5. Indicators

Commented section gives indicator assignments:
- *LR*: End program
- *10-13, 14, 15*: Subfile display controls (Roll, Rolldown, Clear, End)
- *21-22, 30*: Cursor controls, field protection
- *31-79*: Error/warning indicators
- *80-99*: Work indicators

---

## 6. Main Program Logic

### Startup and Main Loop 

**Initialization**: The `*inzsr` subroutine sets up positioning keys, fetches default company/year, and fills the subfile.

**Main Loop**: Structured around two tags, `b2taga` (command screen), `b2tagb` (main screen), managing display and response to function keys:

- Write command screen or subfile.
- Function key handling via a `SELECT`:
    - *inkc/inkl*: Exit program
    - *inke*: Refresh subfile
    - *in10/in11*: Next/Previous page
    - *in21*: Home key, moves cursor
- Positioning logic: If search fields are changed, call `posisjoner` subroutine.
- Otherwise, manages subfile by calling `subfile` subroutine.

### Exiting

Sets *INLR ON (Last Record indicator): RPG's way to end a program.

---

## 7. Core Subroutines

### `forny`
- Refreshes the subfile based on position/cursor in subfile.
- Runs a `CHAIN` to set new position, clears subfile, and recreates content.

### `posisjoner`
- Handles user requests to reposition on voucher number, supplier, or fiscal year.
- Sets necessary keys for files, calls corresponding `SETLL` (position to key), and repopulates subfile.
- Resets search fields after use.

### `subfile`
- Handles subfile processing (display/processing of subfile rows).
- Loops over entries, allowing update or view based on user selection.
- Calls `xc2win` for edit/view screens and updates subfile entries after changes.

### `clr_subfile` / `crt_subfile`
- Clear (`clr_subfile`): Writes control record with *IN14 set (clear indicator), resets counters.
- Create/fill (`crt_subfile`): Reads entries from file (forward for next page), writes subfile records, resolves supplier name, handles currency/amount limits.

### `bck_subfile`
- Reads previous page from file (using `READP`), fills subfile backwards (used for PageUp).

### `dsp_subfile`
- Manages displaying the subfile or command screen depending on content.

---

## 8. Edit/Update Screen Handling: `xc2win`

- Loads a detailed record into a working screen structure.
- Retrieves related texts (e.g., payment terms, departments) by calling associated programs (`RS703R`, `RS707R`, etc.).
- Handles navigation to selection screens for codes (voucher, department, payment condition).
- Validates screen input (`sjekk_input`), and if valid, updates the underlying posting record.
- Updates tracking fields for change date/time and user.

---

## 9. Input Validation: `sjekk_input`

- Checks date fields for validity.
- Calls validation programs for voucher codes and departments.
- Sets error indicators if validation fails.

---

## 10. Key Lists

At the end, sets up named KLISTs for frequently-used file access patterns:
- By firm + voucher/year/number
- By firm + supplier
- By firm + supplier + date/time (for update)

---

## 11. General Notes

- **Subfiles**: Used for display, search, and navigation of multiple records in a 5250-style green screen interface
- **Indicators**: Pervasive use of classic RPG indicators for function key handling, error, and display control.
- **External Calls**: Relies on other RPG programs for code lookup and descriptions.
- **Commenting**: Uses Norwegian naming and comments, but logic is standard for RPG applications.
- **Error Handling**: Uses flags and indicators to highlight errors, loop back to the user for correction.

---

## 12. Flow Summary

1. **Startup**: Get runtime environment from LDA, set initial database position, fill first subfile page.
2. **User interacts**: Key presses trigger loop logic – next/prev page, select/update entry, reposition by search fields.
3. **Viewing/Editing**: Shows full details for a selected voucher, allows updates if needed.
4. **Validation**: Checks key fields/codes via subroutines and external programs.
5. **Update**: Changes written back to database, tracking fields updated.
6. **Exit**: Program terminates when user requests.

---

## 13. Best Practices Highlighted

- **Modular subroutine-based structure**: Each logical function in its own subroutine.
- **Clear decoupling of display, edit, and file handling logic**.
- **Use of information data structure for advanced display file handling (cursor, subfile row numbers)**
- **Separation between display data (subfile records) and database records.**

---

# For New Developers

- **Understand subfile handling**: Key for UI navigation in legacy RPG.
- **Watch indicators**: Many display and error flags rely on traditional RPG indicators.
- **Note file usage**: RLTRLC (by voucher), RLTRL2 (by supplier), RLTRLU (update), RLEVL1 (supplier master).
- **External programs**: Know which validation and text retrieval routines you must maintain/extend.
- **Screen mapping**: Display file (`RL110D`) design drives much of the subfile and detail display.

---

**In summary**, this program is a classic RPG example for subfile-based data maintenance, with good separation of duties and strong use of IBM i features for interactive green screen applications.