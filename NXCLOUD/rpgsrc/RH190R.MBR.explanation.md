# Explanation of the RPG Source Code

This RPG program (RH190R) is designed to handle distribution based on a balance (“Fordeling utfra saldobalanse”) and manage parameters related to accounting periods and accounts. The code reads and validates user input, performs initializations, checks for business rules, and prepares parameters for downstream processing.

Below is a breakdown of its main components and logic for easy onboarding.

---

## 1. Header and Documentation

- `/TITLE` and commented block at the top document:
  - The system and program name (`ASOKON`, `RH190R`).
  - A description of the purpose.
  - Version history and field usage.
  - Indicator conventions (what each range of indicators means).

---

## 2. File Declarations

```rpg
fausrl1    if   e           k disk
frh190d    cf   e             workstn
```
- **ausrl1**: Input, keyed, external record format (probably user master file).
- **rh190d**: Workstation file (for screen display/input).

---

## 3. Data Definitions

### Parameter/Field Definitions

```rpg
d                uds
d rhpkda                300    305
d rhpr�r                         4
d rhpper                         2
d rhppef                         2
d rhppet                         2
d rhpavf                         4
d rhpavt                         4
d rhpktf                         5
d rhpktt                         5
d rhpsrt                         1
d rhpsml                         1
d rhpavv                         1
d rhpkgs                         1
d rhpkks                         1
```
- These are parameter fields, likely for dates, years, periods, account ranges, etc.
- Field names suggest:
  - Dates (`rhpkda`)
  - Years (`rhpr�r`)
  - Periods (`rhpper`, `rhppef`, `rhppet`)
  - From/To department (`rhpavf`, `rhpavt`)
  - From/To account (`rhpktf`, `rhpktt`)
  - Various flags (`rhpsrt`, etc.)

### Local Variables

```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
d waar            s              4  0
d wmnd            s              2  0
d wpakod          s              2  0
d wpdat1          s              6  0
d p_in03          s              1
d wwaar           s              2  0
d w_firm          s                   like(l_firm)
d w_user          s                   like(l_user)
```
- Variables for user, firm, working year/month, etc.

---

## 4. Mainline Logic

### 4.1. Initialization (`*inzsr` subroutine)

- Sets up the environment:
  - Initializes working variables.
  - Moves firm/user values from input to locals.
  - Sets default ranges for department and account selection.
  - Sets current date as default.
  - Calculates previous period/month, handles turn-of-year logic.
  - Attempts to read the user record (with a `chain` to `ausrl1`).
  - Checks if user is restricted to a department; if so, sets appropriate values and indicator 30.

- Parameter list (`plist`) is defined here, accepting `p_in03`.

### 4.2. Main Screen Presentation (`exfmt`)

```rpg
c     a2tagb        tag
c                   exfmt     a2bld
```
- Formats (displays) and receives input from the screen image `a2bld`.

### 4.3. Exit Handling

```rpg
c                   if        *inkc = *on
c                   eval      p_in03 = '1'
c                   goto      xslutt
c                   endif
```
- If function key F3 (`KC`) is pressed, set exit flag, and branch to program end.

### 4.4. Input Validation

- Several checks are performed:
  - If "from" department > "to" department, set error indicator 31.
  - If "from" account > "to" account, set error indicator 32.
  - If date field is zero, defaults to current date.
  - Checks if entered date is valid (date test). If not, indicator 33 is set.
  - If year > current year, set indicator 34.
  - If "from" period > "to" period, set indicator 35.

  If any validation fails, returns to screen to prompt correction.

### 4.5. Setting Parameters

- If all validations pass, moves screen input values (`a2...` fields) into parameter fields (`rh...` fields) for use elsewhere.

### 4.6. Program End

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Ends the program by setting the last record indicator (`*INLR`), causing program termination and resource cleanup.

---

## 5. Subroutine for Initialization (`*inzsr`)

- Sets up default values for the session (see 4.1 above).
- Reads user file to determine if user is restricted to a department.

---

## 6. Indicator Usage

- Function key indicators:
  - `KA` (F1): Company selection
  - `KC` (F3): Exit
- Other indicators:
  - 30: Protect fields upon display
  - 31-35: Used for validation error messages
  - 60-69: File I/O
  - 70-99: Other working and subroutine indicators

---

## 7. Special Notes

- The code uses classic (= old style) RPG IV/C spec and indicators.
- The main logic is a simple loop: screen → validate → (OK? store → exit : error? back to screen)
- All logic is contained in a single cycle, suitable for an interactive data entry parameter screen.
- Fields like `a2bld`, `a2pavf`, etc., are assumed to be from the workstation display file record format.

---

## 8. High-Level Flow

1. **Initialize** program and fields.
2. **Display** parameter selection screen.
3. **Wait for input** (user may exit via F3 or continue).
4. **Validate** all entries (department range, account range, date, periods, etc.).
5. If valid:
    - **Store parameters** for calling program.
    - **Exit**.
6. If not valid:
    - **Show error** (set indicators).
    - **Return to screen** for correction.

---

This structure is common in IBM i (AS/400) interactive programs for parameter entry and validation before running a main process or report. The comments and indicator conventions help team members quickly understand how the program behaves and what each indicator or field is for.