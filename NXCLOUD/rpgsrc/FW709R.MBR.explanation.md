# Explanation of RPG Program FW709R (ASOFAK)

This RPG III/400 (ILE RPG) program is designed to extract supplier item master records for "Farvemiljø Nord", performing various calculations and data conversions as it populates an output file. Below is an onboarding-friendly walkthrough of its structure and logic.

---

## 1. **General Overview**

- **Purpose:**  
  To process an input file with product records, convert and enrich the data, and write records to a supplier item master register (`flvapf`), including various derived and reformatted fields.
- **History:**  
  The comments at the top ("* Ref. Dato Sign Endringsbeskrivelse") list change history and versioning, indicating ongoing maintenance and feature additions (parameter changes, data field expansions, conversion routines, etc.).

---

## 2. **File Declarations**

- **flvwpf**: Input file (keyed, external, disk file).
- **fenkl1**: Lookup file for unit conversions (keyed, renamed record format).
- **flvapf**: Output file for supplier item register (add/update, external, disk file).

---

## 3. **Data Structures**

### a. **User Data Area**
- `l_user` - Extracts user info from positions 911-920 of the user data structure (`uds`).

### b. **Input Record Layout (`d_inpu`)**
- Defined as a 256-byte structure with multiple **overlay** fields for extraction of logical columns such as:
  - Product number (`d_vare`)
  - EAN number (`d_eann`)
  - Description (`d_tek1`)
  - Quantity (`d_anta`)
  - Unit (`d_enhe`)
  - Price fields (`d_inpr`/`d_sapr`)
  - Various other item attributes

#### **Subfields** (`d_inpr_kr`, `d_inpr_øre`, etc.)
- Overlays are used to extract currency parts from full price fields, assuming specific lengths/formats.

---

## 4. **Variables and Parameters**

- `p_firm`, `p_ldor`: Program call parameters (firm number, possibly ledger/order)
- `fenkl1_enhf`: Used for unit conversion lookups
- Various work fields for date, tax factors, calculation intermediates

---

## 5. **Main Processing Loop**

1. **Read and Loop through Input**
   - Read a record from `flvwpf`
   - Loop until end-of-file (`*IN90` off)

2. **Populate Data Structure from File Record**
   - `d_inpu = fwirad` populates the overlay fields for the current record

3. **Text/Character Data Conversion**
   - A series of `XLATE` operations replace various hex codes with the 'Ø' character in the description field, handling Norwegian character encoding anomalies.

4. **Fill Output Record Template**
   - Set various fields (`fwfirm`, `fwldor`, etc.) in the output record from the input and parameters

5. **Field Enrichment**
   - If `d_anta` is not blank, append it to the item description (`fwtek1`)
   - If `d_nobb` is not blank, move it to the `fwnobb` field
   - For units, attempt to find a converted unit in `fenkl1` via `CHAIN`. If found, use the converted unit.

6. **Price Calculations**
   - Compute item cost and sales price (`fwinpr`, `fwsapr`) using the extracted kroner and øre fields (currency subunits), then multiply sales price by VAT factor (`w_mvaf`).

7. **Set Timestamps**
   - Capture system time for various audit/log/use fields.

8. **Additional Data Formatting**
   - If `d_antp` (another number field) is valid, build a formatted string (`w_bmen`) and use it in the output record.

9. **Write Output Record**
   - Write populated/converted record to `flvapf`.

10. **Continue to Next Record**

---

## 6. **Program End / Housekeeping**

- When processing is complete, set the last record indicator (`*INLR`) and return, ending the program gracefully.

---

## 7. **Initialization Subroutine (`*INZSR`)**

- **Parameter List:**  
  Loads program call parameters (`p_firm`, `p_ldor`).
- **Key List:**  
  Prepares the key list for unit lookup (`fenkl1`).
- **Firm Handling:**  
  Reads the firm code from parameters.
- **Date Initialization:**  
  Grabs the current date.
- **Tax factor fetching:**  
  Calls another program (`FØ705R`) to obtain VAT multipliers and factors used in price calculations.

---

## 8. **Comments and Code Standards**

- Code is well-documented with change logs and explanations in Norwegian.
- Field overlays and packed/zone decimal handling require careful mapping to ensure correct field extractions.

---

## 9. **Notable Business Logic Points**

- Handles Norwegian-specific characters in description fields.
- Enforces proper price, unit, and numeric formatting for the supplier file.
- Incorporates audit/tracking fields (who, when, etc.).
- Relies on external unit conversion and VAT calculation logic.

---

## 10. **Error Handling**

- Uses indicators for record not found/lookup failures in standard RPG style (e.g., `*IN91`).
- Processes only valid records (skipping blanks for optional fields).

---

## 11. **Takeaways for New Developers**

- **Maintenance:**  
  If field sizes or file definitions change, update the overlay data structure and all dependent code.
- **Character Translation:**  
  Adding support for additional codepages or characters may require extending the `XLATE` logic.
- **External Calls:**  
  Ensure any dependencies, like the VAT routine (`FØ705R`), are available and documented.
- **Audit:**  
  The code captures audit info—be mindful when changing user or timestamping logic.

---

**Summary:**  
This program transforms and enriches product data for integration into a supplier register, with careful handling of Norwegian data formats and business rules. Overlay data structures, field conversions, and external lookups/VAT calculations are central themes. When enhancing or debugging, pay particular attention to data structure overlays and how external parameter/call results are used.