# RPG Program Explanation – JV145R

This program, `JV145R`, is an ILE RPG application that retrieves and calculates product cost information based on various product, date, and supplier parameters. It's common in manufacturing/distribution environments on IBM i (AS/400) platforms. Below is a pedagogical walkthrough of its structure and key aspects.

---

## General Structure and Purpose

- **Purpose**: To display or calculate information about a product, such as its cost price, units, and associated supplier data, possibly for logistics and pricing systems.
- **Authoring Notes**: The comment block at the top contains version history, improvements, and bug fixes, which is a good reference for the module's maturity and key changes.
- **Options/Directives**:
  - `option(*nodebugio)`: Disables debug for IO operations for performance/security.
  - `datedit(*dmy)`: Date fields default to day-month-year format.

---

## File Declarations

- **Display and Physical Files**:
  - `fjv145d` – Display file (workstation), for user interface.
  - `fjvarl1, fjlevl3, fjvdtl1, fjvprl1` – Database files for product (vare), supplier (leverandør), detailed records, and price records respectively. Most are renamed to local record formats.

---

## Parameter Definitions

- *Parameters are supplied to the program (i.e., called as a subprocedure):*
  - `p_firm`: Company/factory identifier.
  - `p_vare`: Product (item) number or ID.
  - `p_prgr`: Price group (length updated over time).
  - `p_lety`: Product type (single character).
  - `p_dato`: Relevant date (e.g., for pricing/date-sensitive logic).
  - `p_ldor`: Supplier number.

---

## User Space / Work Fields

Many working fields are defined, categorized mostly as follows:

- **Keys and Buffers**: For reading database files (e.g., `jlevl3_enum`, `jvprl1_vare`).
- **Units and Prices**: `w_enhe`, `w_ofp1`, `w_nopr`, `w_inpr`, etc.
- **Status and Code Fields**: `w_pkod`, `w_skod`, various codes for product and supplier groupings.
- **Date/Time**: System and processing dates (`w_udat`, `w_gdat`, etc.).
- **Logistics**: Information specific to logistics-managed products (logistikkvare).
- **Flags**: Boolean "on/off" style fields, e.g., `b_logv`.

---

## Main Processing Section

### Program Start

- Sets up SQL environment (ISO date format, etc. for any embedded SQL use).

```rpg
C/Exec SQL
C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
C/End-Exec
```

- Initializes working copies of company and item fields from input parameters.

### Product Lookup

- Uses a keyed `CHAIN` read of the main product file (`jvarl1`). If not found, the program branches to the end.
- If supplier info (`p_ldor`) is provided, it looks up details about the supplier in `jlevl3`. The fields like `c2navn` and `c2ldor` are set accordingly.

### Find Logistics Product (Logistikk-vare)

- Calls the `finn_logivar` subroutine if supplier information is available. This subroutine uses embedded SQL to join several product and logistics-related tables and extract any logistics item number or related data.

### Collect Product Information

- Sets output / temporary fields from the found product record, accounting for logistics-based overrides when necessary.

### Find Price Date for Supplier

- Reads through the product price file (`jvprl1`) to find the most appropriate price based on effective dates and input date.

### Retrieve Price Code and Sales Price

- Reads additional details (e.g., price code) from the detail file (`jvdtl1`).
- Calls the subroutine `hent_pris` to invoke a common price calculation module (`JV750R`), passing it a large parameter list of product, supplier, and intermediate calculation fields. The results are placed in the corresponding working fields.

### Display/Output

- Formats and displays the main screen (`exfmt c2bld`).
- Listens for an exit action (F3) to jump to program end label.

---

## Subroutines

### hent_pris (Get Price)

- Sets up parameters and invokes an external program (`JV750R`) to calculate price and unit figures.
- Processes results to populate display/output fields for various units and prices, considering unit conversion factors.

### finn_logivar (Find Logistics Product)

- Uses embedded SQL to select logistics information for the current product/supplier combination. If found, sets flags and working fields for use elsewhere.

### *inzsr (Initialization Subroutine)

- Handles input parameter population.
- Sets up key lists for database access.
- Initializes date fields with current time.

---

## Key Technical Patterns

1. **DB File Access**: Uses `CHAIN`, `READE`, and key lists (`klist`) for efficient random access to indexed DB2/400 tables/files.
2. **External Program Calls**: Delegates pricing logic to a central pricing module, passing and receiving extensive data by parameter.
3. **Embedded SQL**: Used for complex retrievals not easily handled by native record-level access.
4. **Field Mapping and Output**: After all calculations, result fields are set for user display.

---

## Notable Comments

- Several code blocks are commented out with `*` (e.g., a redundant or legacy call to `VP716R`).
- Change history tracks both bug fixes and business logic updates (e.g., handling of "logistics product", expanded field sizes).

---

## Summary Table

| Section                | Purpose                                                             |
|------------------------|---------------------------------------------------------------------|
| File Definitions       | Declare files for UI and DB access                                  |
| Parameters             | Define inputs required for main calculations                        |
| Work Fields            | Store intermediate and display values                               |
| Mainline               | Orchestrates logic: lookup, calculation, display, and exit          |
| Subroutines            | Encapsulate key logic: price calculation, logistics lookup, init    |
| External Calls         | Reuse existing pricing logic via program call                       |
| DB Access              | Keyed and sequential access to item, supplier, price, and details   |

---

## Onboarding Tips

- **Entry Points**: Main program logic begins after the `*inzsr` subroutine processes parameters.
- **Adding New Fields**: Define them in the D-specs; add to DB processing and parameter lists as needed.
- **Adding Business Logic**: Put new calculations in subroutines for modularity.
- **Debugging**: Refer to change history and comments for context on logic changes or bug fixes.
- **Extending Supplier/Item Info**: Review the logic in `finn_logivar` for examples on joining and combining data from multiple sources for logistics purposes.

---

This program is a good example of a legacy/highly parameterized RPG application, balancing DB2 file access and embedded SQL, and leveraging common modules for consistency across a larger application suite.