## Program Overview

This program is part of the ASOKON system, named RL933R. Its primary function is to "settle" (salderer) supplier (leverandør) records that have a zero balance ("saldo" = 0). In practice, this means updating all open transactions for such suppliers and marking them as settled/closed in the database.

## High-Level Purpose and Business Logic

- **Domain Context:** In ASOKON, suppliers (leverandører) have financial records in the `RLEVPFR` file (renamed as `rlevl1r` in this program). Each supplier may have multiple transaction entries in the related transactions file `RLTRPFR` (`rltrlur`). Suppliers with zero balances should have all their open transactions explicitly marked as cleared (restsaldo = 0), with audit data (date, time, user) tracked for this operation.
- **User Tracking:** Starting with version 6.10, tracking fields (`roedat`, `roetim`, `roeusr`) were added to store date, time, and user information of when a transaction was settled.

## Program Structure and Data Flows

### File Definitions

- `rlevl1` (RLEVPFR): Main supplier master file. Used to read all supplier records.
- `rltrlur` (RLTRPFR): Supplier transaction file. Used to update each supplier's transaction records.

Both files are externally described and referenced via the `rename()` keyword to ensure unique record formats.

### Field and Constant Definitions

- Message constants and working variables are defined for user feedback during processing (mostly related to UI/dialog message handling).
- The Local Data Area (LDA) segment from position 911–920 (`l_user`) is used to get the current user for audit purposes. This is a site convention for audit trailing.

### Processing Flow

#### 1. Display Progress Message

A standard call to program 'AA006C' is used to show the operator a message ("Please wait... Settling in progress...") during the batch update. The message position and content are controlled via parameters `wactli`, `wactpo`, `wmld01`, `wmld02`.

#### 2. Read & Process Supplier Records

- The program reads through all records in the supplier file (`RLEVPFR`). For each supplier where the balance field (`rlsald`) is zero, it triggers the settlement subroutine (`poster`).

#### 3. Settlement Subroutine (`poster`)

- For each qualifying supplier, the subroutine identifies all related transaction records in `RLTRPFR` by:
    - Setting the relevant keys (`rlfirm`, `rllevr`).
    - Using keyed access (`setll/reade`) to loop through their transaction records.
- For each transaction record found:
    - Sets the open balance field (`rorest`) to zero.
    - Logs the current date (`roedat`), time (`roetim`), and user (`roeusr`) into corresponding fields for audit trail. The date/time values are fetched using the RPG `TIME` operation code at the time of update.
    - Updates the transaction record in the file.

#### 4. Exit

- After processing all suppliers, the program sets LR on (`*inlr = *on`) and returns.

### Key Lists and Subroutines

- The *INZSR (initialization subroutine) defines the key list (`rltrlu_key`) for accessing `RLTRPFR` using both firm and supplier number, as is standard in this codebase. This ensures all transaction updates are done efficiently and only for the relevant supplier's records.

## Design Decisions and Conventions

- **File Naming/Override:** Externally described files are always renamed locally to avoid record format name collisions—a standard ASOKON convention.
- **Audit Fields:** Any update to financial transaction records mandates stamping date, time, and user in designated fields—added in system version 6.10 (see comments and change log).
- **Message Handling:** User dialog and updates are externalized to a shared program ('AA006C'), following ASOKON UI conventions.
- **Error Handling:** Early exits (indicator 90) are used for EOF on file operations, matching older RPG style and standard in legacy modules (signal for no more records or failed keyed access).
- **Use of LDA:** The user value is fetched from the Local Data Area for consistent audit logging. Ensure any batch process invokes this program with the LDA appropriately set.

## Dependencies and Interactions

- Calls external program 'AA006C' to display feedback to users/operators.
- Updates are made directly to the physical transaction file (`RLTRPFR`). No other modules/APIs are invoked for transaction updates, ensuring isolated, atomic operation per supplier.
- Relies on externally described files and key structures as defined in the database layer of ASOKON.

## Summary

This is a batch utility program designed to mark all open transactions as settled for each supplier with zero overall balance, ensuring all changes are auditable by date, time, and user. It is tightly coupled to ASOKON's master files and follows established conventions for message handling, data access, and audit stamping. Understanding the specific fields (such as `rlsald`, `rorest`) and key structures is essential for modification or extension of this program, as is maintaining the integrity of audit information.