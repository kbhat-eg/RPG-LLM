# Overview  
This RPG program (`VG806R`) reads inventory‐count records for a given batch, computes the value adjustment (difference between counted quantity and system quantity), and—if enabled—writes corresponding accounting transactions to the `LOVFPF` file.

---

## 1. Program Header & Control Switch  
- Title: “Legger ut regnskapstrans fra lagertellingsbatch”  
- Version history notes a switch `VG806_801` (variable `u_s801`)—when off, the program skips processing.

```rpg
// At the top of *INZSR:
CallP CO402R(l_filg : w_firm : 0 : 'VG806_801' : co402_verdi1 : co402_verdi2);
if co402_verdi1 = '1';
  u_s801 = *on;      // Only run if switch = '1'
endif;
```

---

## 2. File Declarations  
- **Input Files** (all keyed, externally described):  
  - `TELL1` (tally records)  
  - `LSTSL1` (inventory status codes)  
  - `VVARL1` (item master)  
  - `VGKKIR` (cost‐price code table)  
- **Output File**:  
  - `LOVFPF` (accounting transactions)

---

## 3. Data Definitions  

1. **Parameters**  
   - `p_firm`  : company  
   - `p_batc`  : batch number  

2. **Working Vars**  
   - `w_firm`  : same as `p_firm`  
   - `w_datn`  : numeric date (YYYYMMDD)  
   - `w_avik`  : quantity difference  
   - `w_belp`  : value for one line  
   - `w_btot`  : total adjustment value  
   - `w_numm`  : next voucher number  

3. **Account Info Data‐Structure**  
   - `d_hele`  : 128-char container  
   - Fields `d_kko1`..`d_kko7`, `d_ksp1`..`d_ksp7`, etc. filled by account‐lookup subroutine.

---

## 4. Main Processing Logic  

1. **Skip if Switch Off**  
   ```rpg
   if u_s801 = *off; return; endif;
   ```

2. **Loop Through Inventory‐Count Records**  
   ```rpg
   setll ltell1; 
   reade ltell1;
   dow not %eof(ltell1);

     // Compute difference:
     w_avik = leantt – leantl;

     // Fetch cost price via subprogram VG701R:
     parm p_vare = levare;
     parm p_lage = lelage;
     call 'VG701R'  // returns p_cost, w_datn

     // Accumulate adjustment value:
     if w_avik <> 0;
       w_belp = w_avik * p_cost;
       w_btot += w_belp;
     endif;

     reade ltell1;
   enddo;
   ```

3. **Prepare Accounting Transaction**  
   - **Get Next Voucher Number**  
     `exsr hntnum` → calls `AS100R`, sets `w_numm`, moves to `lgbiln`.  
   - **Get Account References**  
     `exsr hntkon` → calls `VA720R`, fills `d_kko*`, `d_ksp*`.  
   - **Build Common LOVFPF Fields**  
     `exsr bygg_trans` → sets company, date, period, batch text/code, etc.  
   - **Write Cost Posting**  
     ```rpg
     if w_btot > 0;
       lgdkto = d_kko3; lgdsps = d_ksp3; lgbelp = w_btot;
     else;
       lgckto = d_kko3; lgcsps = d_ksp3; lgbelp = -w_btot;
     endif;
     write lovfpfr;
     ```
   - **Write Balancing Posting**  
     ```rpg
     if w_btot > 0;
       lgckto = d_kko5; lgcsps = d_ksp5; lgbelp = w_btot;
     else;
       lgdkto = d_kko5; lgdsps = d_ksp5; lgbelp = -w_btot;
     endif;
     write lovfpfr;
     ```

4. **End of Program**  
   ```rpg
   *inlr = *on;
   return;
   ```

---

## 5. Subroutines  

### 5.1 hntnum – Get Next Voucher Number  
- Clears working fields (`w_fast`, `w_fell`, `w_type`, `w_kode`)  
- Calls `AS100R(w_kode : w_firm : w_fell : w_type : w_fast : w_numm)`  
- Moves `w_numm` → `lgbiln`

### 5.2 hntkon – Fetch Account Codes  
- Prepares lookup keys (`w_ogrp`, `w_hgrp`, `w_ugrp`, `w_vare`)  
- Calls `VA720R` passing status, hierarchy groups, item  
- Receives back a 128-char composite in `w_hele`  
- Moves `w_hele` → data-structure `d_hele`, which splits into `d_kko*` & `d_ksp*`

### 5.3 bygg_trans – Populate LOVFPF Record  
- Sets `lgfirm`, `lgbdat`, `lgperi`, `lgbunt` (batch number), `lgtext` (“Batc: …”), `lgbilk` (bilagskode)  
- Clears unused LOVFPF fields (`lgproj`, `lgkref`, `lgkund`, etc.)  

---

## 6. Initialization (*INZSR*)  

- **Parameter Entry**: `p_firm`, `p_batc`  
- **Define Key Lists** for files (`ltell1_key`, `lstsl1_key`, `vvarl1_key`, `vgkkir_key`)  
- **Assign Work Variables**  
  ```rpg
  w_firm = p_firm; ltell1_batc = p_batc;
  time w_dato; w_datn = %dec(w_dato);
  ```  
- **Chain Initial Records**  
  - `LSTSL1` → inventory‐status settings  
  - `VGKKIR` → cost variables  
  - `VVARL1` → item master  

- **Check Switch** via `CO402R` (see Section 1)

---

### Flow Chart Summary  
1. **Init** (*INZSR*)  
2. **Switch Check**  
3. **Read & Process Counts** → accumulate `w_btot`  
4. **Get Voucher#**  
5. **Get Account Codes**  
6. **Write Transactions** (cost & balancing)  
7. **End** (`*INLR = *ON`)