# RPG Program RA113R - Budget Key Maintenance

This program is written in the RPG/400 (ILE RPG) language for IBM i (AS/400) systems. The purpose of the program is to allow users to maintain budget keys (budsjett­nøkler) via display file (workstn) screens with subfile support.

Below is a detailed explanation of the source structure and logic.

---

## Header & Documentation

- `h option(*nodebugio) datedit(*dmy)`: Program options, disables debug I/O and uses day-month-year for date editing.
- Extensive comments explain:
  - The purpose (`Beskrivelse`): Budget key maintenance.
  - The indicator assignments (e.g., 10=Rollup, 11=Rolldown, 12=Subfile display, etc.).
  - Change history and program context.

---

## File Declarations

- **Physical Files:** 
  - `fra13l1`, `fra13l2`, `fra13lr`, `fra13lu` - Budget key files (different views/levels):
    - Declared as keyed (`k`), externally described (`e`), input/output as needed, with record format renames (e.g., `rename(ra13pfr:ra13l1r)`).
- **Display File:** 
  - `fra113d`: The workstation file (display), using a subfile (`sfile(b1sfl:w_srrn)`).

---

## Data Structures

### Local Data Area (LDA) Fields

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Reads user and company info from the LDA for context.

### Key Variables

- `ra13l1_mkod`, `ra13l2_mtxt`, etc. are work variables for holding keys/texts during file access.

### Main Work Variables

- **Subfile Paging:** `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`, etc. for tracking subfile record numbers, current page, etc.
- **Flags:** `b_oppr`, `b_forn`, `b_anul`, `b_feil` for controlling logic and process states.
- `w_firm`, `s_mkod`, `w_pro` for current company, temp key storage, and percent calculations, respectively.

### Constants

- `c_sfil`: Subfile page size (default 14).

---

## Screen and Subfile References

Detailed comments explain the intended use of each screen: 
- Subfile records (B1SFL), control record (B2CTL), command keys screen (B2CMD), create/update screens, and confirmation windows (delete/copy).

---

## Main Logic - Control Flow

### Initial Subfile Display Loop

Uses control tags (`b2taga`, `b2tagb`) to:
- Display command screen (`b2cmd`)
- Call subfile display logic (`exsr dsp_subfile`)
- Handle function keys via `select`:
  - Exit (`goto avslutt`) on Cancel/Exit
  - Refresh, Create, Rollup, Rolldown, Home key, etc.
- Do subfile positioning as needed
- Otherwise, process subfile (`exsr subfile`).

### Program Exit

- Sets `*inlr = *on` and returns.

---

## Subroutines

### forny (Refresh subfile)
- Chains to the current subfile record.
- Repositions file pointer on correct index (by description vs. code).
- Calls subfile clear and re-create routines.

### posisjoner (Position in subfile)
- Repositions subfile based on key or description fields.
- Rebuilds subfile for new position.
- Clears positioning fields on screen.

### subfile (Main subfile processing)
- Processes user actions on subfile rows (edit, copy, delete, view).
- For each row, handles the user selection (`b1valg`):
    - 2 = Edit
    - 3 = Copy
    - 4 = Delete
    - 5 = View
- Updates the subfile and screen as actions are taken.

### xc1bld (Add new record screen)
- Handles user interaction for adding new keys.
- Validates if key already exists (if so, shows message).
- Calls maintenance screen (`xc2bld`) for actual entry.

### xc1msg (Show "record exists" message)
- Displays a message if the user tries to add a duplicate key.

### xc2bld (Maintain record - new, edit, view)
- Loads existing data if available, or clears fields for new entry.
- Supports edit and view modes via function keys.
- Validates required fields (description, percent sum = 100).
- Updates or writes the record as appropriate.
- If invoked from subfile (edit/copy), updates subfile as necessary.

### xd1win (Delete confirmation screen)
- Handles delete window interaction.
- Deletes the selected record upon confirmation.

### xk1win (Copy record screen)
- Handles logic for copying a record.
- Validates new key does not already exist.
- Calls the maintenance screen (`xc2bld`) with data from the copied record.

### clr_subfile (Clear subfile)
- Prepares to clear subfile area before filling with new data.

### crt_subfile (Create/fill subfile page)
- Fills the subfile with up to `c_sfil` (default: 14) records, paging as needed.

### bck_subfile (Page back in subfile)
- Rewinds one page in subfile listing, then repopulates.

### dsp_subfile (Display subfile)
- Controls the display of subfile control and data screens.

### *inzsr (Initialization)
- Builds keys for file positioning.
- Retrieves initial values from LDA and positions database.
- Populates the initial subfile view.

---

## Indicators

Indicators are heavily used for:
- Subfile operations (clear, end, display, control)
- Screen options and workflow control
- Error and informational messages

---

## Summary

**High-Level User Flow:**
1. Subfile screen is shown, listing budget keys with page navigation.
2. User can add, edit, copy, delete, or view individual keys.
3. Data validation is enforced (e.g., total percent must equal 100).
4. Subfile view can be repositioned by key or description.
5. All database writes/updates/deletes are managed via record-level file I/O.

**Maintaining this code:**
- Study the indicator diagram and subfile variables; this is crucial to understanding user interactions.
- The main control loop is based on tags and `goto` instructions, with most logic in subroutines.
- Each operation (add, edit, delete, copy) is isolated in its own subroutine for clarity.
- Any database structure changes will require changes in the record format and possibly in the subfile logic.

**Onboarding Takeaway:**  
This is a classic AS/400 "green screen" maintenance program using subfiles to efficiently manage list-based data, with strong structure for user interaction and data integrity. Understanding the indicator mapping and subfile mechanics is key to making effective changes or enhancements.

---

> If you want a breakdown of a specific subroutine or logic path, just ask!