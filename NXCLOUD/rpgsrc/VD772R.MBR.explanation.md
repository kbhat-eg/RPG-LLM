# RPG Program VD772R â€“ Explanation

## Overview

This program (`VD772R`) is designed to **check if an item exists in a particular assortment of type 'P' (period-controlled assortment)** and to determine whether it is within the active period for that assortment.

- **p_stat** is set to '1' if the item is found in an active assortment but out of the valid period.
- Program avoids setting the *INLR (last record indicator) unless specifically required, so it stays active between calls.

---

## File Declarations

```rpg
fvsdtl6    if   e           k disk    rename(vsdtpfr:vsdtl6r)
fvsdtl1    if   e           k disk    rename(vsdtpfr:vsdtl1r)
fvshel3    if   e           k disk    rename(vshepfr:vshel3r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
```
- Four physical files are declared:
  - **vsdtl6/vsdtpfr**, **vsdtl1/vsdtpfr**, **vshel3/vshepfr** and **vvarl1/vvarpfr**
  - Each file is renamed for local naming consistency.

---

## Data Area and Field Definitions

- The *LDA is referenced for user/group info (`l_fgrp`, `l_user`).
- Key and working fields are defined, mostly using `LIKE()` to ensure they match the data structure layouts. E.g., `vshel3_type` is LIKE `vctype`.

---

## Input Parameters

- **p_firm**: Company/Firm code
- **p_lage**: Warehouse/location
- **p_vare**: Item/Article number
- **p_stat**: Status indicator to be returned (flag)
- **p_inlr**: Last record indicator (flag for ending the program)

---

## Main Program Flow

### 1. Item Lookup in `vvarl1`
```rpg
eval vvarl1_vare = p_vare
... chain vvarl1
```
- Looks up the item in the item file.

### 2. Preparation
```rpg
eval p_stat = *blank
eval b_sess = *off
eval b_funn = *off
```
- Clears status and flags.

---

### 3. Scan Assortment (with warehouse)
- Sets `vshel3_type` = 'P' (period-controlled)
- Loops through all type 'P' assortments associated with the warehouse (`vclage = p_lage`).
- Calls:
  - `sjekk_dato`: Determines the valid period (start/end dates) for the assortment, often using week numbers.
  - `sjekk_vsor`: Checks if the item is in the current assortment and whether it's active or out of period.
- If `b_sess = *on`, the item is in the assortment but out of period, and `p_stat` is set to '1'.
- If `b_funn = *on`, the item is in an active assortment.
- Uses early `goto avslutt` to exit on a match.

---

### 4. Scan Assortment (without warehouse)
- Loops through type 'P' assortments where `vclage = 0`.
- Similar logic to above, but skips the warehouse match.

---

### 5. Program Exit (`avslutt`)

- If `p_inlr <> *on`, calls VC701R to ensure dates are up to date and then sets `*INLR = *ON` to allow program to end if necessary.

---

## Subroutines

### 1. `sjekk_vsor`
Checks if the item is in the provided assortment and warehouse:

- Sets up the key for `vsdtl6` (detail lines for the assortment).
- Reads all items for that assortment/warehouse combination.
- For each:
  - Sets `b_funn = *on` if found.
  - If `w_udat` (today's date) is OUTSIDE the valid period (`w_fdat` ... `w_tdat`), sets `b_sess = *on` (in assortment but out-of-period), then exits subroutine.
- If detail lines are not found, searches the more general `vsdtl1` file by trying first with item number, then with group codes set to 0 (progressive fallback).
- If found and `w_udat` is out of period, sets `b_sess = *on`.

### 2. `sjekk_dato`
Calls program `VC701R` to translate week numbers (`vcfuke`, `vctuke`) into start (`w_fdat`) and end (`w_tdat`) dates for the period.

### 3. *INZSR (Initialization Subroutine)
- Handles parameter entry.
- Establishes the key fields for all files.
- Sets firm code and current date (`w_udat`).

---

## Typical Call/Usage

1. The program is called with firm, warehouse, item, by reference, and returns status.
2. Checks if the item is in any 'P' assortment, considering the input warehouse.
3. Sets `p_stat` to '1' if the item is in an assortment but out of period.

---

## Business Rules Encoded

- **Assortment Type:** Only considers type 'P' ("periodestyrte", or period-controlled).
- **Warehouse Logic:** First checks with warehouse, then without (i.e., global assortments).
- **Validity Period:** Uses week numbers converted to dates to define a valid period.
- **Hierarchical Lookup:** If not found for the specific item, tries groupings (organization, hierarchy, user, model), by zeroing out less-specific fields in succession.
- **Efficient Exit:** Uses flags and direct jumps to exit early upon a definite outcome.

---

## Key Takeaways for Onboarding

- The program is strictly for *assortment checking* with period control.
- Pay attention to the use of subroutines, especially for period translation and assortment hierarchy lookup.
- The flags `b_sess` and `b_funn` are critical for flow control and status reporting.
- When modifying or extending, consider the progressive fallback logic in `sjekk_vsor`, and the external date calculation logic.

---

### File Structure Hints

- **vshel3**: Assortment headers (contains type, warehouse)
- **vsdtl6**: Assortment details for items
- **vsdtl1**: More generic/group-based assortment details
- **vvarl1**: Item master

---

## Final Advice

- This is a typical RPG program for business logic using file I/O and keylists.
- Flags, key fields, and `*INLR` handling are essential for correct operation in call-driven batch environments.
- The code is well-structured and commented, but knowledge of the underlying data model (file layouts) will greatly help understanding and troubleshooting.

---

**If you need details on a specific part or variable, feel free to ask!**