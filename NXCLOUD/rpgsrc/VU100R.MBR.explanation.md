# RPG ILE Program (VU100R) – Explanation

This RPG/400 (ILE RPG III) program is a legacy IBM i application for maintaining “structure items” (most likely bill-of-materials, product structures, or similar hierarchical relationships in an ERP system). It features rich subfile management for listing, adding, copying, deleting, and editing structure items, with various display and data validation routines.

Below is an explanation of the code for developers onboarding to this application.

---

## 1. **Header and Documentation Block**

- `h option(*nodebugio) datedit(*dmy)`
  - Compiler options: No file I/O debug, date edit for DMY format.
- The commented section documents system, program, description, change history, indicators usage, and screen/image files used.

### **Special Indicator Usage**
- LR: End program
- 10-11: Paging (scroll up/down)
- 12-15: Subfile control/status
- 21-22: Home key/cursor
- 30: Field protection
- 31-99: Screen messages, work indicators

---

## 2. **File Definitions**

- Several physical files (vstrl1, vstrl2, vstrl3, vstrlr, vstrlu, vvarl1) are defined as input or update files, renamed for internal use.
- Display file `vu100d` is defined with subfile `b1sfl` and information DS `dspfbk`.

---

## 3. **Data Areas, Structures, and Fields**

- **LDA** (Local Data Area) fields: user, firm number, full name
- **Display Feedback Structure**: cursor position, etc.
- **Keys and Working Variables**: Various `like()` fields based on reference files (e.g., vuvare = item number, vuvars = component/item variant, etc.)
- **Control Variables**: Subfile record numbers, page sizes, flags for operation state, and constants.

---

## 4. **Subfile-Specific Fields and Screen Layout**

- Several working fields (`w_fcrn`, `w_stel`, `w_spge`, etc.) manage subfile pagination and selection.
- "Screen images" represent different display records for various maintenance tasks (adding, editing, copying, deleting, etc.).

---

## 5. **Program Logic Structure**

### High-Level Flow

- Entry point manages the main subfile screen logic
- Handles function keys for add/copy/edit/delete/position operations
- Contains subroutines for each core action

#### Main Loop Tags

- **b2taga / b2tagb**: Tags for main subfile processing.
- **avslutt**: Tag for program end.
- **Case statements** handle different function keys and direct flow accordingly.

---

### 6. **Subroutines Overview**

#### **struktur**
- Calls another program `VU101R` for advanced structure processing (passing main item number and description).

#### **spørring**
- Handles F4-prompt/lookups, by calling `VV500R` for information about a primary item or (commented out) structure item.

#### **forny**
- Used to refresh/rebuild the subfile from the current position.
- Sets appropriate file position, clears, and re-fills the subfile.

#### **posisjoner**
- Used to position the subfile based on search fields (main item, description, etc.).
- Sets the search key, positions the relevant logical file, clears, and fills the subfile.

#### **subfile**
- Processes updates based on user actions in subfile rows.
- Handles edit, copy, delete, view, and "structure" actions for a selected row.
- Calls subroutines as needed; updates subfile and database.

#### **xc1bld**
- Handles the add-new-item display (C1BLD).
- Interacts with user, validates input, checks for duplicates, and launches edit screen if valid.

#### **xc1msg**
- Shows a message if user tries to add a duplicate row (C1MSG).

#### **xc2bld**
- Handles edit/view screen (C2BLD).
- Loads and displays details for the item, validates data, writes changes to DB, and refreshes the subfile if required.

#### **xd1win**
- Handles delete-window (D1WIN).
- Deletes an item from the structure after confirmation.

#### **xk1win**
- Handles copy-window (K1WIN).
- Prepares data for copying, checks for duplication, triggers edit of new row.

#### **clr_subfile / crt_subfile**
- Clear and populate the subfile based on current position and key state.
- Handles the paging of records.

#### **bck_subfile**
- Handles paging back in the subfile.

#### **dsp_subfile**
- Handles subfile display/refresh.

#### ***inzsr**
- Program initialization:
  - Defines file keys.
  - Reads LDA and initializes subfile (positions to top).

---

## 7. **Key Implementation Details**

### **Subfile Paging**
- Uses working fields `w_fcrn`, `w_srrn`, `w_spge`, etc. to handle relative record numbers for paging through the subfile.
- `clr_subfile` blanks the subfile, `crt_subfile` fills it based on the key.
- `bck_subfile` enables back-paging.

### **Search/Positioning Logic**
- User can search/position on main item, (commented) structure item, or description.
- Program jumps to appropriate record and refreshes the display accordingly.

### **Add/Edit/Delete/Copy Operations**
- All routed through subroutines, each with input validations and database integrity checks for existing keys, valid items, etc.

### **Indicator Handling**
- Extensive use of RPG indicators to manage field protection, message display, screen navigation, and data validation feedback to the user.

### **External Calls**
- Calls to other programs:
  - `VU101R`: For structure processing.
  - `VV500R`: For item information lookups.

---

## 8. **Special Notes**

- Some code related to "structure item variant" (`vars`) is commented out or marked with `6.10` – this suggests adaptation or partial disabling for a specific version.
- Most current logic only maintains "main item", not variant/sub-item. Adaptations might be needed if that support is reactivated.

---

## 9. **Onboarding Tips**

- **Understand Legacy RPG**: This code is fixed-format, not the modern free-format RPG. You may want to get comfortable with column-sensitive syntax.
- **Subfile Mastery Required**: Subfile processing, paging, and screen-image records are central to this program.
- **Indicator-Driven Logic**: Screen and process flow is managed almost entirely by RPG indicators (`*inxx`) - understand their allocation.
- **External Program Design**: Look up external programs/files (`VV500R`, `VU101R`, `vstrpfr`, `vvarpfr`, ...) for full context.
- **Data Integrity**: Keys are crucial; there are validation checks for duplicate prevention and referential checks to master item records.
- **Error/Message Handling**: Indicator ranges 31-79 provide error and screen message feedback.
- **Version Comments**: Lines tagged with `6.10` or commented out with `c**` relate to version-specific features (possibly disabled at present).

---

## 10. **Glossary**

| Field      | Meaning                              |
|------------|--------------------------------------|
| `vare`     | Main item number                     |
| `vars`     | Structure/component item/variant     |
| `besk`     | Description                          |
| `anta`     | Quantity/count                       |
| `kstr`     | Construction code                    |
| `eusr`     | Last updated by user                 |
| `odat`     | Created date                         |
| `edat`     | Updated date                         |

---

### **Summary**

This program is a classic RPG subfile-driven item structure maintenance tool: it displays a paged list of items, lets users search, add, copy, delete, and edit them, calls out to other programs for detailed item info, and strictly controls data with validation and indicator-driven workflows. Understanding subfile mechanics, indicator usage, and legacy RPG syntax is crucial for further development or maintenance.