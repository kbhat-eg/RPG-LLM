# Explanation of RPG Program SP151R — "Utvalg Ordretype" (Select Ordertype)

This program is an ILE RPG application for IBM i (AS/400) systems, designed to allow users to view, add, and delete "Order Types" via a subfile-driven display, supporting GUI extensions. Below is a detailed walkthrough of its structure and main functions:

---

## 1. **File Declarations**

```rpg
fsp151d    cf   e             workstn sfile(b1sfl:w_srrn)   // Display file with subfile
fskpml1    if   e           k disk    rename(skpmpfr:skpml1r)
fskpmlr    if   e           k disk    rename(skpmpfr:skpmlrr)
fskpmlu    uf a e           k disk    rename(skpmpfr:skpmlur)
fvotyl1    if   e           k disk    rename(votypfr:votyp1r)
```
- **sp151d**: Workstation (display) file with subfile `b1sfl`.
- **skpml1/r/u**: Three logicals over the same physical file (`skpmpfr`), with different record formats for lookup, reading, update, etc.
- **votyl1**: Lookup/reference file for validation.

---

## 2. **Data Definitions**

### 2.1. **Key Variables**
These are variables used as file keys, all defined `like` corresponding fields in the database.

### 2.2. **Work Variables**
Some key work variables:
- `w_spge, w_srrn, w_sfrn, w_ssrn`: Subfile row and page counters
- `b_forn, b_anul, b_feil`: Logic flags (initialize as off)
- `w_firm`: Current firm number (from LDA)
- `wptype, wpkode, wptext, wprtxt, wpaork`: Order type info

### 2.3. **Constants**
- `c_sfil = 12`: Subfile page size

### 2.4. **Local Data Area**
- `dsfirm`: Firm number (positions 944–946)
- Other fields for user and navigation support

---

## 3. **Main Program Flow**

### 3.1. **Initial Display (Main Tag `b2taga`, `b2tagb`)**
- Write the main command screen or display the subfile (list of order types).
- Enter a loop where the user can:
    - Exit (function keys)
    - Refresh/rebuild subfile (`forny`)
    - Add a new record (`xc1bld`)
    - Page forward (`crt_subfile`)
    - Position (`posisjoner`)
    - Handle subfile actions (`control`)
    - Process subfile rows (`subfile`)

### 3.2. **Function Key Handling**
- Various `when` blocks check for IBM i function key indicators (`*inkc`, `*inke`, etc.), branching to appropriate handling subroutines or exiting.

---

## 4. **Subroutines (Subrutiner)**

### 4.1. **forny**
- Rebuilds subfile by clearing and re-creating it.

### 4.2. **posisjoner**
- Positions the file cursor to a certain value (`b2aork`), then rebuilds the subfile from that position.

### 4.3. **control**
- Handles "Add" (`b2valg='1'`) and "Delete" (`b2valg='4'`) actions from the main subfile control area.
- Validates inputs; sets error flags if fields are blank or invalid.

### 4.4. **subfile**
- Reads through all subfile rows.
- If a row is marked for deletion (`b1valg='4'`), delete the corresponding record from the database.

### 4.5. **xc1bld**
- Process for adding a new order type row. Displays a window for input, validates, and then proceeds to register.

### 4.6. **xc1msg**
- Displays a duplicate warning if a record already exists during creation.

### 4.7. **xc2bld**
- Handles both new and update for records ("registering").
- Writes new record if not found; updates if found.

### 4.8. **xd1win**
- Handles the delete confirmation window and record deletion.

### 4.9. **clr_subfile & crt_subfile**
- `clr_subfile`: Clears all lines in the subfile and resets counters.
- `crt_subfile`: Reads next page's worth of records from the file and writes them to the subfile.

### 4.10. **dsp_subfile**
- Controls display and navigation of the subfile, setting screen indicators accordingly.

### 4.11. ***inzsr (Initialization)**
- Setup of file keys.
- Entry parameters (wptype, wptext) are initialized.
- Sets Firm number from LDA.
- Positions to start of file and preloads first subfile page.

---

## 5. **Key RPG Techniques Used**

- **Subfiles:** For displaying and maintaining lists in a panel/dialog, allowing selection, insertion, and deletion.
- **Function Key Indicators (`*INKx`):** Standard way to handle user input and commands.
- **Chain/Setll/Read:** Used to position and read logical files for index/key-based access.
- **LDA (Local Data Area):** Pulls session/user/context data such as the firm number.
- **Control/Indicator Variables:** Used pervasively for flags and state tracking.
- **Windows/Dialogs:** For confirm-delete and data entry overlays (e.g., `d1win`, `c1bld`, `c2bld`).

---

## 6. **Business Logic**

- The user can scroll through, position, add, or delete order types.
- Add and delete requests bring up dialogs for input or confirmation.
- The subfile is dynamically loaded (paged).
- All changes are immediately reflected in the subfile list; error handling (e.g., duplicate, blank input) provides user feedback.

---

## 7. **Commonly Used Indicator Codes**

- `*in12`, `*in13`, etc.: Panel/screen state indicators (e.g., subfile full, screen ready, errors).
- `*in14`, `*in15`: Subfile clear or end flags.
- `*in31`, `*in32`: Specific error conditions, like blank keys or not found.

---

## 8. **Conclusion**

This is a modular, standard RPG program for subfile maintenance of order type data, supporting CRUD operations and user navigation, with robust error handling. The subroutine structure is clear and aligns well with typical IBM i panel programs, making it approachable for RPG developers familiar with subfiles and legacy coding conventions. Understanding this template will help new developers onboard for further enhancements or debugging in similar RPG applications.