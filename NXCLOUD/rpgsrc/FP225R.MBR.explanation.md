# RPG / IBM i Explanation of Program FP220R

---

## Program Overview

This program, titled **FP220R**, is part of an application system (system ASOFAK from title comments) for handling parameters related to advertising labels ("reklame-etiketter"). The code is written in ILE RPG (also known as RPG IV) and follows traditional fixed-format style, with a specific focus on IBM i (AS/400) platforms.

The program interacts with:

- A workstation display (`fp225d`) for user input/output
- A database file (`vfaspf`) for reading firm/printer information
- An output file (`param`) for storing processed parameters

The code includes Norwegian language comments and field names.

---

## File Declarations

```rpg
Ffp225d    cf   e             workstn    // Workstation display file (input/output)
Fvfaspf    if   e           k disk       // Printer/firma information file (input, keyed)
Fparam     o  a f  128        disk       // Output parameters (output, record length 128)
```

- `workstn`: This is a display file, allowing program interaction with users.
- `vfaspf`: A keyed input file (likely containing printer/firm data).
- `param`: An output file for storing parameters.

---

## Data Structure and Variables

### User Messages

```rpg
D mld             s             70    dim(5) ctdata perrcd(1)
```
- Holds up to 5 messages, each up to 70 characters.

### Local Data Area
Defined as a User Defined Data Structure (UDS) using the `D ... uds` block. This is an old method of defining the RPG "Local Data Area" in memory, mapping specific offsets within the LDA.

```rpg
D                uds
D lcskty                110    110  0
D lcvalg                111    111  0
D lcetpr                112    112  0
D lckenh                113    113  0
D lcken2                114    114  0
D lcdato                115    122  0
D lcsort                123    123  0
...
D lcruti                800    809
D lcuser                911    920
D l_firm                944    946  0
D l_fnav                951    980
```
- Various fields mapped to absolute positions in the User Data Space. For example,
  - `l_firm` (firm number) at position 944-946
  - `lcruti` (routine name) at position 800-809

### Working Variables

```rpg
D faskey          s              3  0   // Firm key for lookups
D wmeld           s                   like(mld) // Message holder
D wpin03          s              1  0  // Input parameter (from *ENTRY)
```

---

## Main Logic

### 1. Main Input/Processing Section

```rpg
C     a1tag         tag
C                   exfmt     a1bld
```
- Begins at tag `a1tag`.
- `exfmt a1bld` displays and receives input using the format `a1bld` from the display file.

#### Exit on Cancel

```rpg
C                   if        *inkc = *on
C                   move      1             wpin03
C                   goto      slutt
C                   endif
```
- If function key 'C' (usually F3/Exit or Cancel) is pressed, set `wpin03` to 1 (flag for program exit) and go to the end (`slutt`).

#### Populate Output Record

```rpg
C                   movel     'FP226 '      lcruti
C                   move      a1skty        lcskty
C                   except    addrec
```
- Set the routine name `lcruti` to 'FP226 ' (possibly for tracking/logging purposes).
- Move the value from `a1skty` (input/skty field from the display) to `lcskty` (LDA).
- Write a record to the output file (`param`), using the `addrec` output specification.

---

### 2. Program End

```rpg
C     slutt         tag
C                   eval      *inlr = *on
```
- Marks end of the program, sets `*INLR` (last record indicator) to on to close files/end the job.

---

### 3. Initialization (*INZSR Subroutine)

```rpg
C     *inzsr        begsr
C     *entry        plist
C                   parm                    wpin03
C                   move      0             wpin03
```
- RPG automatically calls *INZSR at program start.
- Receives the only parameter `wpin03` (likely an exit flag), initializes it to 0.

#### Printer Information Lookup

```rpg
C                   eval      faskey = *zero
C                   move      l_firm        faskey
C     faskey        chain     vfaspf                             60
```
- Sets up faskey using `l_firm` (firm number from LDA).
- Looks up this key in the `vfaspf` file, sets indicator 60 if not found.

#### If Not Found

```rpg
C                   if        *in60 = *on
C                   eval      a1skty = *zero
C                   eval      a1fas1 = *blank
C                   eval      a1fas2 = *blank
C                   eval      a1fas3 = *blank
C                   eval      a1fas4 = *blank
C                   else
C                   move      vnskty        a1skty
C                   move      vnfas1        a1fas1
C                   move      vnfas2        a1fas2
C                   move      vnfas3        a1fas3
C                   move      vnfas4        a1fas4
C                   endif
```
- If not found, zero out parameters for screen fields.
- If found, load relevant fields (such as `vnskty`, `vnfas1`, etc.) from the `vfaspf` record into the program’s variables for screen display.

---

## Output File Specification (`O-specs`)

```rpg
Oparam     eadd         addrec
O                       a1anta               4
O                       a1fas1              19
O                       a1fas2              34
O                       a1fas3              49
O                       a1fas4              64
```
- When `except addrec` is issued, a record is added to `param` with fields from the user's input.

---

## Other Notes

- There are placeholders for user messages, typically loaded from the program’s source.
- All code is in "fixed-form" RPG, which is rigidly column-based and older than modern free-form RPG.
- Error/indicator handling is done through classic RPG methods.
- Parameter passing is done with a parameter list (`plist`), here with a single parameter.

---

## Summary of Flow

1. **Initialization**: Loads parameters, gets printer information from the database file.
2. **User Input**: Shows input screen, waits for user entry.
3. **Processing**: If the user cancels, sets exit and ends. Otherwise, processes input and writes output records.
4. **Termination**: Sets completion flag and ends program.

---

## Onboarding Tips

- **Display File (`fp225d`)**: You'll need to review this file for details on screen layouts, field names like `a1skty`, `a1fas1`, etc.
- **Printer Info File (`vfaspf`)**: Contains mapping of firms/printers. Review DDS or SQL definitions for field mapping.
- **Output File (`param`)**: Structure is important for integration with downstream processes.
- **LDA Usage**: The use of UDS for the LDA is an old RPG idiom; modern code may use DS/fields directly or use parameter passing.

---

## Key Terms

- **LDA (Local Data Area)**: Area of memory mapped for temporary storage between calls/batches.
- **EXFMT**: Display/format a screen and wait for user input.
- **CHAIN**: Look up a record by key in a file.
- **EXCEPT**: Write output based on O-specification.
- ***INLR**: Indicator for program end (Last record).

---

This is a classic program for managing parameters related to label printing, with foundational patterns for data processing and user interaction in RPG.