# Overview

This program (RP120R) manages parameters for posting data originating from external systems. It validates user inputs—particularly dates, fiscal years (regnskapsår), and accounting periods (regnskapsperiode)—before passing these parameters to subsequent processes. The display file RE120D is used for input, and the relevant values are moved into parameter fields for further use.  

The overall flow includes:  
1. Presenting a screen to gather input (EXFMT A2BLD).  
2. Validating date, fiscal year, and period.  
3. If the user chooses to exit, or if validation fails, the program branches accordingly.  
4. On successful validation, key fields are moved into parameter variables.  
5. The program concludes by returning control to the caller.

---

## Key Data Items

• pfirm, pnavn, puser, pdato, praar, pperf, ppert, pavdf, pavdt  
  - These are the main parameter variables (Firma, Navn, Bruker, Dato, Regnskapsår, Perioder, Avdeling). They store the values read from the display or computed.

• l_firm, l_fnav, l_user  
  - Local copies (likely loaded or inherited from elsewhere) that eventually populate pfirm, pnavn, and puser.

• w_aar, w_mnd  
  - Working variables to calculate default period/year values based on the system date.

• a2pkda, a2prår, a2pper, a2psys  
  - Input fields shown on the screen (data from the externally defined file RE120D). They hold user-entered or system-derived date, year, period, and system code.

---

## Program Flow

### 1. Main Logic

1. The program begins at label **A2TAGA** after displaying the screen (EXFMT A2BLD).  
2. It initializes various indicators (*IN31 through *IN36) to off, clear for further validations.  
3. It checks if the exit indicator (*INKC) is on. If so, it sets a return code (w_in03 = '1') and jumps to **SLUTT**.  

### 2. Validations
- **Check for zero date**:  
  If the user-supplied date (`a2pkda`) is zero, it defaults to the current system date (`UDATE`).

- **Validate date format**:  
  Using `TEST(D)` on `a2pkda` sets *IN33 if the date is invalid. If invalid, control jumps back to **A2TAGA** to prompt correction.

- **Validate fiscal year**:  
  Compares the input year (`a2prår`) to the current system year. If the input year exceeds the system year, *IN32 is set on, and the screen re-displays (branch back to **A2TAGA**).

- **Validate accounting period**:  
  Ensures `a2pper` is between 1 and 13. If out of range, *IN35 is set on, and control shifts back to **A2TAGA**.

If all validations pass, the program moves the relevant data into parameter fields (`pfirm`, `pnavn`, and so on).

### 3. Finalizing the Parameters
After successful validation, the code populates the parameter variables:  
• `pfirm`, `pnavn`, `puser`, `pdato`, `praar`, `pperf`, `ppert`, `psyst`  
These will be used by subsequent processes, presumably to post from external systems.

### 4. Ending
At label **SLUTT**, the program sets *INLR on, returning to the caller and ending execution.

---

## Initialization Subroutine (*INZSR)

When the program starts, it performs this subroutine to set up default values:

1. Moves the system date into `a2pkda`.  
2. Derives the current year (`w_aar`) from *YEAR, then subtracts one from `UMONTH` to determine the default posting period (ensuring that if the month is zero, it sets the month to 12 and the year to the previous year).  
3. Stores these computed values back into `a2prår` (year) and `a2pper` (period).  
4. Sets `a2psys` to "01" (indicating a system or module code).  

Finally, the subroutine receives a parameter list that includes `w_in03` which is used to signal how the program ends (e.g., normal completion or exit).

---

## Notable Points

- The program uses “tag” labels (e.g., A2TAGA, SLUTT) as structural control points, a style common in older RPG programs.  
- Multiple indicators (*IN31, *IN32, etc.) control error states for specific validations, channeling logic back to the display file for user correction.  
- *INLR is set at the end, indicating the typical RPG “last record” approach—ending program execution once logic completes.  
- This particular code appears to be a parameter setup routine for a larger financial or accounting integration process, which relies on the validated date, year, and period before proceeding with external posting.