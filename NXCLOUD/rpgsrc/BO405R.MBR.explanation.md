# Program Documentation: BO405R (ASSHOP)

## Overview

**Program Name:** BO405R  
**System:** ASSHOP  
**Description:** Kopier firma (Copy company)  
**Purpose:**  
This program copies all master and transactional data for a specified company ("firma") from a set of source files to corresponding update/output files, effectively creating a duplicate set of records for a new or existing company code. It is typically used for initializing or cloning company data within the retail/point-of-sale (POS) solution.

## Key Features

- **Bulk Data Copy:** Iterates through a set of tables/files, reading all records for a company and writing them to matching update files, changing the company identifier to the new target company.
- **Tracking Information:** For certain tables, audit fields such as user, date, and time are updated during the copy process.
- **Modular Table Handling:** Each logical data group (e.g., budget, store headers, transaction lines, gift cards) is processed in a dedicated loop.
- **Parameterization:** The target company code is passed as a program parameter.

## File/Table Relationships

The program operates on a set of files, each with a read (input) and write (output) version, often with different record formats. The naming convention is as follows:

- **Input Files:** e.g., `bbudl1`, `bmdtl1`, `bmhel1`, etc.
- **Output Files:** e.g., `bbudlu`, `bmdtlu`, `bmhelu`, etc.
- **File Renaming:** Each file is renamed to a record format that matches the logical table (e.g., `bbudpfr:bbudl1r`), supporting modularity and code clarity.

### Main File Groups

- **Budget (Budsjett):** `bbudl1` → `bbudlu`
- **Store Line (Butikk-linje):** `bmdtl1` → `bmdtlu`
- **Store Header (Butikk-hode):** `bmhel1` → `bmhelu`
- **Receipt Line (Bong-linje):** `bodtl1` → `bodtlu`
- **Receipt Header (Bong-hode):** `bohel1` → `bohelu`
- **Pick S-Line (Plukk S-linje):** `bpsol1` → `bpsolu`
- **Store Code (Butikk-kode):** `bstsl1` → `bstslu`
- **Cash Register (Kasseregister):** `bwsdl1` → `bwsdlu`
- **Store Cash (ButikkKasse):** `bkasi1` → `bkasiu`
- **Store Header (ButikkHode):** `bbhei1` → `bbheiu`
- **Store Line (ButikkLinje):** `bbdti1` → `bbdtiu`
- **Store Line Deleted (ButikkLinjeSlettet):** `bbsli2` → `bbslst`
- **Gift Card (ButikkGavekort):** `bgavi1` → `bgaviu`
- **Gift Card Purchase (ButikkGavekortKjøp):** `bgaki1` → `bgakiu`
- **Receipt Text (BongTekst):** `bbtxi1` → `bbtxiu`
- **Store User (ButikkBruker):** `busri1` → `busriu`

## Program Flow

### Initialization

- **Parameter Handling:**  
  The program receives the target company code (`p_firm`) as a parameter.
- **Local Data Area (LDA):**  
  Retrieves the current company (`l_firm`) and user (`l_user`) from the LDA. `w_firm` is set to the source company from LDA.
- **Key List:**  
  A generic key list (`key01`) is defined using `w_firm`, used as the selection key for all file reads.

### Data Copy Process

For each table:

1. **Set Position:**  
   `SETLL` to the first record for the source company using `key01`.
2. **Read Loop:**  
   `READE` to read records for the company.
3. **Process Each Record:**  
   - Update the company field to the target (`p_firm`).
   - For certain tables, update audit fields (user, date, time).
   - Write the record to the output/update file.
4. **Repeat:**  
   Continue until all records for the source company are processed.

#### Example: Budsjett (Budget)

```rpg
c     key01         setll     bbudl1
c     key01         reade     bbudl1
c                   dow       not %eof
c                   eval      bufirm = p_firm
c                   write     bbudlur
c     key01         reade     bbudl1
c                   enddo
```
- Reads all budget records for the source company, sets the company field to the target, and writes to the output file.

#### Example: Receipt Line (with audit fields)

```rpg
c     key01         setll     bodtl1
c     key01         reade     bodtl1
c                   dow       not %eof
c                   eval      bdfirm = p_firm
c                   time                    bdodat
c                   time                    bdotim
c                   eval      bdousr = l_user
c                   time                    bdedat
c                   time                    bdetim
c                   eval      bdeusr = l_user
c                   write     bodtlur
c     key01         reade     bodtl1
c                   enddo
```
- In addition to copying, sets creation and update timestamps and user fields.

### Program Termination

- Sets LR (`*INLR`) to *ON, ensuring proper program closure and file commitment.
- Returns to caller.

## Special Considerations

- **Audit Fields:**  
  For transactional tables (e.g., receipts, store codes, cash register), creation and modification timestamps and user fields are set to the current user and system time during the copy.
- **File Naming Pattern:**  
  Each logical table has an input and output file, allowing for clear separation between source and target data sets.
- **Company Key:**  
  The company identifier is always the primary key for selection and is overwritten on copy to the new company code.
- **LDA Usage:**  
  The program relies on the LDA to fetch the current user and source company, ensuring the context is consistent and auditable.

## Business/Domain Logic

- **Company Cloning:**  
  This program is central to onboarding new companies or branches in the POS system, allowing all relevant master and transaction data to be cloned efficiently.
- **Data Integrity:**  
  By updating all relevant company fields and audit information, the program ensures that the copied data is logically consistent and attributable to the responsible user.
- **Extensibility:**  
  New tables can be added to the copy process by following the established read/write pattern and updating the file specifications.

## Design Patterns and Conventions

- **Consistent Loop Structure:**  
  Every table uses the same `SETLL`/`READE`/`DOW`/`WRITE` pattern for clarity and maintainability.
- **Explicit Audit Updates:**  
  Audit fields are updated in-line for relevant tables to ensure traceability.
- **Centralized Key Handling:**  
  The use of a generic key list (`key01`) simplifies key management and supports reuse across tables.
- **Separation of Input/Output Files:**  
  Distinct input and output files prevent accidental overwrites and maintain data integrity.

## External Dependencies

- **Local Data Area (LDA):**  
  The LDA must be populated with the current user and company before program execution.
- **File Definitions:**  
  All files referenced must exist with the expected record formats and keys.

## Maintenance Notes

- **Adding New Tables:**  
  To support new tables, define the input and output files, update the copy loop, and ensure company and audit fields are handled as needed.
- **Audit Field Consistency:**  
  Ensure any new transactional tables include audit field updates in the copy process.
- **Error Handling:**  
  The program assumes all reads/writes succeed; consider adding error handling if used in environments where data integrity is critical.

---

**Summary:**  
BO405R is a batch utility for cloning all relevant company data in the ASSHOP POS system, ensuring a new company code is initialized with a consistent data set and up-to-date audit information. Its modular design and consistent patterns make it straightforward to maintain and extend for new data requirements.