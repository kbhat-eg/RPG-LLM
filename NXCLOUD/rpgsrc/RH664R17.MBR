     h datedit(*dmy) option(*nodebugio)
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RH661R                                              *
      * Beskrivelse . . : Hovedbok - mva-oppgjør, utskrift                    *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                                     *
      * Tilpasset for . :                                                     *
      *                                                                       *
      * Referanse  Dato   Endringsbeskrivelse                            Sign *
      * --------- ------  ---------------------------------------------- ---- *
6.10  * NHO       170811  Nytt program                                        *
6.20  * bsa       061212  Tillegg for å berike metataggger                    *
6.21  * sst       220513  Rettet brudd logikk vedr Fordelingsskjema           *
6.22  * bof       270913  * bort kall til DEBUGCL                             *
6.23  * nho       080414  MVA-kode 0 i dette programmet være med på           *
6.23  *                   utskriften, 'Utskrift av poster med
6.23  *                   mva-kode = 0 hører til enkeltposter
6.24  * bsa       260216  Endret kategorisering for arkivering.
6.30  * R6.30 180816 bsa  Rokkert på rekkefølge av close printerfile
6.31  * R6.30 210916 sst  Ny mvaoppgave fra 01.01.2017
sst   *
sst2  *       051216 sst  justert postering
sst3  *       051216 sst  Åpnet igje 42 for og få med detaljer på rappr
sst4  *       170216 sst  Korrigering vedr riktig summer på RF0002
6.32  * R6.30 040719 bsa  Utvidet saldofelter
      *
8.01  * R8.00 250821 bsa  Utvidet felter for summering
8.02  * R8.00 081221 sst  Legger ut Saft's momskode
8.03  * R8.00 171221 sst  Sortere totaler på Saft_Mk og Std_Mk
8.04  * R8.00 100122 sst  Legger ut sum Saft's momskode = 01
8.04s * R8.00 220222 sst  Justert vedr utg. mva
8.05  * R8.00 100122 sst  Legger ut sum spes av uttak på mva-oppgave
8.06  * R8.00 120122 sst  Legger ut RMVXPF for utskrft av mva-oppg til XML-fil
8.07  * R8.00 240222 sst  Behanlder momskode blank = 0
8.08  * R8.00 020322 sst  Legger ut sum Saft's momskode = alle
8.09  * R8.00 160322 sst  Justert logikk vedr uttak
8.10  * R8.00 280322 sst  Justert logikk vedr momskode = blank
8.10  * R8.00 271022 sst  Lagt til moms-sats som nivå på mva-xml-rapport
      *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *                                                                       *
      *  BRUK AV INDIKATORER                                                  *
      *                                                                       *
      *       KA = F1  = Valg av firma                                        *
      *       KC = F3  = Exit                                                 *
      *                                                                       *
      *       LR = Avslutt program                                            *
      *       30 = Protect av felter ved vise                                 *
      *    31-59 = Varsle m/feilmeldinger/skjermindikatorer                   *
      *    60-69 = Fileindikatorer chain etc.                                 *
      *    70-79 = Arbeidsindikatorer i sub-rutiner                           *
      *    80-89 = Arbeidsindikatorer ordinære                                *
      *    90-99 = Benyttes ved std. sub-rutiner                              *
      *                                                                       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     frhtrlb    if   e           k disk    rename(rhtrpfr:rhtrlbr)
     frhsal1    if   e           k disk    rename(rhsapfr:rhsal1r)
     frhtrlu    uf   e           k disk    rename(rhtrpfr:rhtrlur)
     frhovlr    if   e           k disk    rename(rhovpfr:rhovlrr)
     fra04l1    if   e           k disk    rename(ra04pfr:ra04l1r)
     fra05lr    if   e           k disk    rename(ra05pfr:ra05lrr)
     fraa4l1    uf   e           k disk    rename(raa4pfr:raa4l1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
8.02 frat5pf    if   e           k disk    rename(rat5pfr:rat5pfr)
8.05 fvkhvl1    if   e           k disk    rename(vkhvpfr:vkhvl1r)
     frjoupf    o  a e           k disk    rename(rjoupfr:rjoupfr)
8.06 frmvxlu    uf a e           k disk    rename(rmvxpfr:rmvxlur)
     frh664s    o    e             printer oflind(*in30)
pdf  f                                     usropn
      *
     d mk              s              1    dim(99)
     d bto             s             13  2 dim(99)
     d nto             s             13  2 dim(99)
     d knto            s             13  2 dim(99)
     d grl             s             13  2 dim(99)
     d imv             s             11  2 dim(99)
V5.40d imu             s             11  2 dim(99)
     d umv             s             11  2 dim(99)
6.32 d sal             s             15  2 dim(14)
8.03 d mks             s              2    dim(99)
      *
     d rhtrlu_raar     s                   like(rbraar)
     d rhtrlu_kont     s                   like(rbkont)
     d rhtrlu_spes     s                   like(rbspes)
     d rhtrlu_avde     s                   like(rbavde)
     d rhtrlu_rper     s                   like(rbrper)
     d rhtrlu_bdat     s                   like(rbbdat)
     d rhtrlu_tist     s                   like(rbtist)
      *
     d rhsal1_kont     s                   like(rikont)
     d rhsal1_spes     s                   like(rispes)
     d rhsal1_avde     s                   like(riavde)
     d rhsal1_raar     s                   like(riraar)
     d rhsal1_type     s                   like(ritype)
      *
     d rhovlr_kont     s                   like(rhkont)
     d rhovlr_spes     s                   like(rhspes)
     d rhovlr_avde     s                   like(rhavde)
      *
     d raa4l1_4aar     s                   like(ra4aar)
     d ra05lr_ekod     s                   like(raekod)
8.02 d rat5pf_kode     s                   like(rtekod)
     d rhtrlb_raar     s                   like(rbraar)
      *
8.05 d vkhvl1_firm     s                   like(vakfir)
8.05 d vkhvl1_kode     s                   like(vakkod)
8.05 d vkhvl1_lety     s                   like(vaklty)
8.05 d vkhvl1_otyp     s                   like(vakoty)
      *
8.06 d rmvxlu_firm     s                   like(rxfirm)
8.06 d rmvxlu_smvk     s                   like(rxsmvk)
8.10 d rmvxlu_mvap     s                   like(rxmvap)
      *
     d w_edat          s               d   datfmt(*iso)
610  d w_memb          s                   like(rjmemb)
     d w_kont          s                   like(rbkont)
      *
     d                 ds
     d w_dato                         6  0
     d  w_dag                         2  0 overlay(w_dato)
     d  w_mnd                         2  0 overlay(w_dato:3)
     d  w_aar                         2  0 overlay(w_dato:5)
      *
     d w_udat          s              6  0
     d w_msg           s             50
      *
      * Local data area
      *
     d                uds
     d rhpkda                300    305  0
     d rhprÅr                         4  0
     d rhpper                         2  0
     d rhpmva                         1  0
     d rhpmv0                         1
     d rhptst                         1
     d rhpost                         1
     d rhpsps                         1
      *
pdf  d l_poff                584    584
pdf  d l_bach                595    635
pdf  d l_skje                637    637  0
     d l_wsid                901    910
     d l_user                911    920
     d l_firm                944    946  0
     d l_fnav                951    980
      *
     d g_mvak          s                   like(rbmvak)
     d w_mvak          s                   like(rbmvak)
     d wpavde          s                   like(rbavde)
     d wpfirm          s                   like(rbfirm)
     d wpkont          s                   like(rbkont)
     d wpspes          s                   like(rbspes)
     d w_firm          s                   like(l_firm)
     d w_stat          s              1
     d w_akod          s              2  0
     d w_atxt          s             20
      *
     d amva            s              1
     d a01txt          s             20
     d brto            s             13  2
     d mvag            s             13  2
     d iavg            s             11  2
     d imva            s             11  2
      *
     d recnr1          s              5  0
     d tsal            s             13  2
     d umva            s             11  2
      *
     d oms01g          s             11  0
     d oms02g          s             11  0
     d oms03g          s             11  0
6.31 d oms03a          s             11  0
     d oms04g          s             11  0
     d oms04a          s             11  0
     d oms05g          s             11  0
     d oms05a          s             11  0
     d oms06g          s             11  0
     d oms07g          s             11  0
6.31 d oms08g          s             11  0
6.31 d oms09g          s             11  0
6.31 d oms09a          s             11  0
6.31 d oms10g          s             11  0
6.31 d oms10a          s             11  0
6.31 d oms11g          s             11  0
6.31 d oms12g          s             11  0
6.31 d oms12a          s             11  0
6.31 d oms13g          s             11  0
6.31 d oms13a          s             11  0
6.31 d oms14a          s             11  0
6.31 d oms15a          s             11  0
6.31 d oms16a          s             11  0
6.31 d oms17a          s             11  0
6.31 d oms18a          s             11  0
6.31 d oms19a          s             11  0
      *
8.01 d wmva01g         s             13  2
8.01 d wmva02g         s             13  2
8.01 d wmva03g         s             13  2
8.01 d wmva03a         s             13  2
     d wmva04g         s             11  2
     d wmva04a         s             11  2
     d wmva05g         s             11  2
     d wmva05a         s             11  2
     d wmva06g         s             11  2
     d wmva07g         s             11  2
6.31 d wmva08g         s             11  2
6.31 d wmva09g         s             11  2
     d wmva09a         s             11  2
6.31 d wmva10g         s             11  2
     d wmva10a         s             11  2
6.31 d wmva11g         s             11  2
6.31 d wmva12g         s             11  2
6.31 d wmva12a         s             11  2
6.31 d wmva13g         s             11  2
6.31 d wmva13a         s             11  2
6.31 d wmva14a         s             11  2
6.31 d wmva15a         s             11  2
6.31 d wmva16a         s             11  2
6.31 d wmva17a         s             11  2
6.31 d wmva18a         s             11  2
6.31 d wmva19a         s             11  2
8.04  *
8.04 d s1bto           s             11  2
8.04 d s1grl           s             11  2
8.04 d s1imv           s             11  2
8.04 d s1umv           s             11  2
8.04 d s1nto           s             11  2
8.05  *
8.05 d u1bto           s             11  2
8.05 d u1grl           s             11  2
8.05 d u1imv           s             11  2
8.05 d u1imu           s             11  2
8.05 d u1umv           s             11  2
8.05 d u1umu           s             11  2
8.05 d u1nto           s             11  2
8.05 d u1mva           s             11  2
      *
8.05 d utkkon          s                   like(rbkont)
      *
     d wptex1          s             30
     d wptex2          s             30
     d wsbel           s             13  2
     d wsfylk          s             11  2
     d wsimva          s             11  2
V5.40d wsimvu          s             11  2
     d wsksal          s             13  2
     d wsnett          s             13  2
     d wsumva          s             11  2
6.NU d ww4sgb          s              8  0
     d x               s              2  0
8.03 d i               s              3  0
8.03 d j               s              3  0
8.03 d t               s              3  0
8.08 d s               s              3  0
     d xmva            s                   like(raebmk)
6.12 d p_btyp          s            100
      *
pdf  d splfname2       s             10a
pdf  d jobname2        s             10a
pdf  d username2       s             10a
pdf  d jobnbr2         s              6a
pdf  d splfnbr2        s             10i 0
pdf  d splfname3       s             10a
pdf  d jobname3        s             10a
pdf  d username3       s             10a
pdf  d jobnbr3         s              6a
pdf  d splfnbr3        s             10i 0
6.20 d p_tagg0         s             20
6.20 d p_tagg0val      s             50
6.20 d p_tagg1         s             20
6.20 d p_tagg1val      s             50
6.20 d p_tagg2         s             20
6.20 d p_tagg2val      s             50
6.20 d p_tagg3         s             20
6.20 d p_tagg3val      s             50
6.20 d p_tagg4         s             20
6.20 d p_tagg4val      s             50
6.20 d p_tagg5         s             20
6.20 d p_tagg5val      s             50
6.20 d p_tagg6         s             20
6.20 d p_tagg6val      s             50
6.20 d p_tagg7         s             20
6.20 d p_tagg7val      s             50
6.20 d p_tagg8         s             20
6.20 d p_tagg8val      s             50
6.20 d p_tagg9         s             20
6.20 d p_tagg9val      s             50
6.20 d p_refn          s             50
6.20 d p_dspl          s            100
pdf   *
pdf  d qsprilsp        pr                  extpgm('QSPRILSP')
pdf  d rcvvar                     32767a   options(*varsize)
pdf  d rcvvarlen                     10i 0 const
pdf  d format                         8a   const
pdf  d errorcode                  32767a   options(*varsize)
pdf   *
pdf  d sprl0100        ds
pdf  d  bytesrtn                     10i 0
pdf  d  bytesavl                     10i 0
pdf  d  splfname                     10a
pdf  d  jobname                      10a
pdf  d  username                     10a
pdf  d  jobnbr                        6a
pdf  d  splfnbr                      10i 0
pdf  d  systemname                    8a
pdf  d  createdate                    7a
pdf  d                                1a
pdf  d  createtime                    6a
pdf   *
pdf  d errorcode       ds
pdf  d  bytesprov                    10i 0 inz(0)
pdf  d  byteavail                    10i 0 inz(0)
pdf   *
      /eject
      *
     irhsal1r
      * Saldobalanse
      *
     i              risa01                      sal(01)
     i              risa02                      sal(02)
     i              risa03                      sal(03)
     i              risa04                      sal(04)
     i              risa05                      sal(05)
     i              risa06                      sal(06)
     i              risa07                      sal(07)
     i              risa08                      sal(08)
     i              risa09                      sal(09)
     i              risa10                      sal(10)
     i              risa11                      sal(11)
     i              risa12                      sal(12)
     i              risa13                      sal(13)
     i              risa00                      sal(14)
      *
      /eject
     c     dummy         tag
      *
      * Sett starverdi
      *
     c                   eval      rhtrlb_raar = rhprÅr
     c     rhtrlb_key    setll     rhtrlb
     c     rhtrlb_key    reade     rhtrlb                                 60
      *
     c                   eval      *in88 = *off
     c                   dow       *in60 = *off
      *
     c                   eval      rhpsps = 'N'
      *
     c                   if        rbmvak = ' '
     c                   eval      rbmvak = '0'
8.10 c*                  eval      g_mvak = '0'
     c                   endif
      *
      * Brudd på MVA-kode
      *
     c                   if        rbmvak <> g_mvak
     c                   exsr      brudd
     c                   move      rbmvak        g_mvak
     c                   endif
      *
      * Kun posteringer med riktig
      * periode som ikke har vært
      * behandlet før blir behandlet videre
      *
     c                   if        rbrper <= rhpper and
     c                             rbmmrk <> '1'
     c                   if        rbmvak = 'L'
     c                   eval      rbmvak = rbmvak
     c                   endif
     c                   exsr      beh_post
     c                   endif
      *
     c     nyles         tag
     c     rhtrlb_key    reade     rhtrlb                                 60
     c                   enddo
      *
      /space 3
      *
     c     slutt         tag
      *
     c                   write     t0det
     c                   add       t0nto         t0tot
     c                   add       t0grl         t0to1
     c                   add       t0imv         t0to2
     c                   add       t0umv         t0to3
     c                   add       t0bto         t0to4
     c                   write     t2det
8.06  *sven
8.06  *  Akkumulere totaler til XML-utgave av MVA-Rapport
8.06  *                  debyg4
8.06 c*                  eval      rat5pf_kode = w_mvak
8.06 c*    rat5pf_key    chain     rat5pf
8.06 c*                  if        %found(rat5pf)
8.06 c*                  eval      rmvxlu_smvk = %editc(rtesmk:'X')
8.06 c*                  else
8.06 c*                  eval      rmvxlu_smvk = *blank
8.06 c*                  endif
8.06 c*                  eval      rmvxlu_firm = w_firm
8.06 c**                 eval      rmvxlu_smvk = t1mks
8.06 c*    rmvxlu_key    chain     rmvxlu
8.06 c*                  if        not %found(rmvxlu)
8.06 c*                  clear                   rmvxlur
8.06 c*                  endif
8.06 c*                  eval      rxneto = rxneto + t0tot
8.06 c*                  eval      rxgrla = rxgrla + t0to1
8.06 c*                  eval      rximva = rximva + t0to2
8.06 c*                  eval      rxumva = rxumva + t0to3
8.06 c*                  eval      rxeusr = l_user
8.06 c*                  time                    rxedat
8.06 c*                  time                    rxetim
8.06  *
8.06 c*                  if        not %found(rmvxlu)
8.06 c*                  eval      rxfirm = w_firm
8.06 c*                  eval      rxsmvk = rmvxlu_smvk
8.06 c*                  write     rmvxlur
8.06 c*                  else
8.06 c*                  update    rmvxlur
8.06 c*                  endif
     c                   exsr      mvatot
pdf   * Generer xml for videre utskrift
pdf  c                   if        l_poff = '1'
pdf  c                   exsr      spoolnbr
6.30 c                   close     rh664s
6.30 c                   exsr      xml_create
pdf  c                   exsr      pdf_preview
pdf   * Avslutt jobbiden
pdf  c                   call      'AB710R'
pdf  c                   parm                    l_bach
pdf  c                   endif
      *
     c                   seton                                        lr
      *
      * Subrutine for brudd på konto
      *
      * Subrutine for brudd på konto
      *
     c     bruddk        begsr
      *
      *
      *
     c                   if        rbkont <> w_kont
     c                   write     t0det
     c                   eval      t0nto = *zeros
     c                   eval      t0grl = *zeros
     c                   eval      t0imv = *zeros
     c                   eval      t0umv = *zeros
     c                   eval      t0bto = *zeros
     c                   eval      w_kont = rbkont
     c                   endif
      *
     c                   endsr
      /eject
      *
      *
      /eject
      *
      * Subrutine for behandling av posteringer
      *
     c     beh_post      begsr
      *
      * Bilagsdato
      *
     c     *dmy          move      rbbdat        w_udat
      *
      * Nullstill beløpsfelt
      *
     c                   eval      brto = *zeros
     c                   eval      mvag = *zeros
     c                   eval      imva = *zeros
     c                   eval      umva = *zeros
      *
      * Beregn brutto-beløp
      *
     c                   eval      brto = rbmvag + rbmvab + rbinvb
      *  ------------------------------------------------------------
      *  X er en løpende teller fra 1 pr momskode
      *  mk(x) innehodler selve momskoden
      *
      *
T5.30 * Koder uten grunnlag, f.eks. 0 og 4
      *
T5.30c                   if        brto = *zero
T5.30c                   eval      brto = rbneto
T5.30c                   endif
      *
     c                   eval      bto(x) = bto(x) + brto
T5.30c                   eval      nto(x) = nto(x) + rbneto
     c                   eval      knto(x) = knto(x) + rbneto
8.09  * Finner ev. SAFT-momskode
8.09 c                   eval      rat5pf_kode = rbmvak
8.09 c     rat5pf_key    chain     rat5pf
8.09 c                   if        not %found(rat5pf)
8.09 c                   eval      rtspss = *blank
8.09 c                   eval      rtprut = *blank
8.09 c                   endif
8.05  *
8.09 c                   if        rtspss = 'J'
8.09 c                             and rbhpro = rtprut
8.05 c                   eval      u1bto = u1bto + brto
8.05 c                   eval      u1nto = u1nto + rbneto
8.05 c                   eval      u1mva = u1mva + rbmvab
8.05 c                   endif
      *
      /eject
      *
      * Beregn mva-grunnlag
      *
     c                   eval      mvag = mvag + rbmvag
     c                   eval      grl(x) = grl(x) + rbmvag
8.05  *
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1grl = u1grl + rbmvag
8.05 c                   endif
      *
      *  DEBUG
      *
     c                   if        xmva = 19 or
     c                             xmva = 11 or
     c                             xmva = 13
     c                   eval      xmva = xmva
     c                   endif
      *
      * Inngående MVA (Høy sats)
      *
     c                   if        xmva = 1 or
     c                             xmva = 12 or
     c                             xmva = 34 or
     c*                            xmva = 36 or
     c                             xmva = 41 or
     c                             xmva = 42 or
     c                             xmva = 46
     c                   eval      imva = imva + rbmvab
     c                   eval      imv(x) = imv(x) + rbmvab
8.04  *
8.04 c                   if        rbkont = utkkon
8.04 c                   eval      u1imv = u1imv + rbmvab
8.04 c                   endif
     c                   endif
      *
      * Inngående MVA (Middels sats)
      *
     c                   if        xmva = 11 or
     c                             xmva = 35 or
     c*                            xmva = 37 or
     c                             xmva = 43 or
     c                             xmva = 44
     c                   eval      imva = imva + rbmvab
     c                   eval      imv(x) = imv(x) + rbmvab
8.05  *
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1imv = u1imv + rbmvab
8.05 c                   endif
      *
     c                   endif
      *
      * Inngående MVA (Lav sats)
      *
     c                   if        xmva = 21 or
     c                             xmva = 47 or
     c                             xmva = 48
     c                   eval      imva = imva + rbmvab
     c                   eval      imv(x) = imv(x) + rbmvab
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1imv = u1imv + rbmvab
8.05 c                   endif
     c                   endif
      *
      * Inngående avgift på tjenester kjøpt fra utlandet
      *
     c                   if        xmva = 12 or
sst3 c                             xmva = 41 or
sst  c                             xmva = 43 or
sst2 c                             xmva = 47
sst3 c                   eval      umva = umva + rbmvab
     c                   eval      imu(x) = imu(x) + rbmvab
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1imu = u1imu + rbmvab
8.05 c                   endif
     c                   endif
      *
      * Utgående MVA (Høy sats)
      *
     c                   if        xmva = 3
     c                   eval      umva = umva + rbmvab
     c                   eval      umv(x) = umv(x) + rbmvab
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1imu = u1imu + rbmvab
8.05 c                   endif
     c                   endif
      *
      * Utgående MVA (Middels sats)
      *
     c                   if        xmva = 13
     c                   eval      umva = umva + rbmvab
     c                   eval      umv(x) = umv(x) + rbmvab
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1umv = u1umv + rbmvab
8.05 c                   endif
     c                   endif
      *
      * Utgående MVA (Lav sats)
      *
     c                   if        xmva = 23
     c                   eval      umva = umva + rbmvab
     c                   eval      umv(x) = umv(x) + rbmvab
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1umv = u1umv + rbmvab
8.05 c                   endif
     c                   endif
      *
      * Direkte postering - høy sats
      *
     c                   if        xmva = 9
      *
      * Inngående MVA
      *
     c                   if        rbkont = radk02
     c                   eval      imva = imva + rbneto
     c                   eval      imv(x) = imv(x) + rbneto
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1imv = u1imv + rbneto
8.05 c                   endif
     c                   endif
      *
      * Utgående MVA
      *
     c                   if        rbkont = radk01
     c                   eval      umva = umva + rbneto
     c                   eval      umv(x) = umv(x) + rbneto
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1umv = u1umv + rbneto
8.05 c                   endif
     c                   endif
      *
     c                   endif
      *
      * Direkte postering - middels sats
      *
     c                   if        xmva = 19
      *
      * Inngående MVA
      *
     c                   if        rbkont = radk02
     c                   eval      imva = imva + rbneto
     c                   eval      imv(x) = imv(x) + rbneto
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1imv = u1imv + rbneto
8.05 c                   endif
     c                   endif
      *
      * Utgående MVA
      *
     c                   if        rbkont = radk01
     c                   eval      umva = umva + rbneto
     c                   eval      umv(x) = umv(x) + rbneto
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1umv = u1umv + rbneto
8.05 c                   endif
     c                   endif
      *
     c                   endif
      *
      * Direkte postering - lav sats
      *
     c                   if        xmva = 29
      *
      * Inngående MVA
      *
     c                   if        rbkont = radk02
     c                   eval      imva = imva + rbneto
     c                   eval      imv(x) = imv(x) + rbneto
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1imv = u1imv + rbneto
8.05 c                   endif
     c                   endif
      *
      * Utgående MVA
      *
     c                   if        rbkont = radk01
     c                   eval      umva = umva + rbneto
     c                   eval      umv(x) = umv(x) + rbneto
8.05 c                   if        rbkont = utkkon
8.05 c                   eval      u1umv = u1umv + rbneto
8.05 c                   endif
     c                   endif
      *
     c                   endif
      *  ____________________________________________________________
      *         SUMMERING PR POST
      *
      * Beh.kode 00
      *
     c                   select
     c*                  when      xmva = 00  and
     c*                            rbkont <> radk01 and
     c*                            rbkont <> radk02 and
     c*                            rbkont <> radk03 and
     c*                            rbkont <> radk04 and
     c*                            rbkont <> radk05 and
     c*                            rbkont <> radk06 and
     c*                            rbkont <> radk07 and
     c*                            rbkont <> radk08
     c*                  eval      wmva01g = wmva01g - rbneto
      *
      * Beh.kode 01
      *
     c                   when      xmva = 01
6.31 c**s                eval      wmva02g = wmva02g - rbmvag
6.31 c**s                eval      wmva03g = wmva03g - rbmvag
6.31 c**s                eval      wmva03a = wmva03a - rbmvab
     c                   eval      wmva14a = wmva14a - rbmvab
      *
      * Beh.kode 02
      *
     c                   when      xmva = 02
     c                   eval      wmva01g = wmva01g - rbmvab
      *
      * Beh.kode 03
      *
     c                   when      xmva = 03
     c                   eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva03g = wmva03g - rbmvag
     c                   eval      wmva03a = wmva03a - rbmvab
      *
      * Beh.kode 04
      *
     c                   when      xmva = 04
     c                   eval      wmva02g = wmva02g - rbneto
     c                   eval      wmva06g = wmva06g - rbneto
      *
      * Beh.kode 05
      *
     c                   when      xmva = 05
      *                  ???????????????????
      *
      * Beh.kode 06
      *
     c                   when      xmva = 06
      *                  ???????????????????
      *
      * Beh.kode 07
      *
     c                   when      xmva = 07
      *                  ???????????????????
      *
      * Beh.kode 08
      *
     c                   when      xmva = 08
      *                  ???????????????????
      *
      * Beh.kode 09      Direkte postering - høy sats
      *
     c                   when      xmva = 09
      *
      * Inngående MVA
      *
     c                   if        rbkont = radk02
     c                   eval      wmva14a = wmva14a - rbneto
     c                   endif
      *
      * Utgående MVA
      *
     c                   if        rbkont = radk01
     c                   eval      wmva03a = wmva03a - rbneto
     c                   endif
      *
      *
      * Direkte postering - middels sats
      *
     c                   when      xmva = 19
      *
      * Inngående MVA
      *
     c                   if        rbkont = radk02
     c                   eval      wmva15a = wmva15a - rbneto
     c                   endif
      *
      * Utgående MVA
      *
     c                   if        rbkont = radk01
     c                   eval      wmva04a = wmva04a - rbneto
     c                   endif
      *
      *
      * Direkte postering - lav sats
      *
     c                   when      xmva = 29
      *
      * Inngående MVA
      *
     c                   if        rbkont = radk02
     c                   eval      wmva16a = wmva16a - rbneto
     c                   endif
      *
      * Utgående MVA
      *
     c                   if        rbkont = radk01
     c                   eval      wmva05a = wmva05a - rbneto
     c                   endif
      *
      *
      * Beh.kode 10
      *
     c                   when      xmva = 10
     c                   eval      wmva01g = wmva01g - rbneto
      *
      * Beh.kode 11
      *
     c                   when      xmva = 11
6.31 c**s                eval      wmva02g = wmva02g - rbmvag
     c**s                eval      wmva04g = wmva04g - rbmvag
     c**s                eval      wmva04a = wmva04a - rbmvab
     c                   eval      wmva15a = wmva15a - rbmvab
      *
      * Beh.kode 12
      *
     c                   when      xmva = 12
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva12g = wmva12g - rbmvag
     c                   eval      wmva12a = wmva12a - rbmvab
     c                   eval      wmva17a = wmva17a - rbmvab
      *
      * Beh.kode 13
      *
     c                   when      xmva = 13
     c                   eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva04g = wmva04g - rbmvag
     c                   eval      wmva04a = wmva04a - rbmvab
      *
      * Beh.kode 14 - 20  Ikke i bruk
      *
     c*                  when      xmva = 14-20
      *                  ????????????????????
      *
      * Beh.kode 21
      *
     c                   when      xmva = 21
6.31 c**s                eval      wmva02g = wmva02g - rbmvag
     c**s                eval      wmva05g = wmva05g - rbmvag
     c**s                eval      wmva05a = wmva05a - rbmvab
     c                   eval      wmva16a = wmva16a - rbmvab
      *
      * Beh.kode 22
      *
     c                   when      xmva = 22
      *                  ????????????????????
      *
      * Beh.kode 23
      *
     c                   when      xmva = 23
     c                   eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva05g = wmva05g - rbmvag
     c                   eval      wmva05a = wmva05a - rbmvab
      *
      * Beh.kode 24 - 33  Ikke i bruk
      *
     c*                  when      xmva = 24-33
      *                  ????????????????????
      *
      * Beh.kode 34
      *
     c                   when      xmva = 34
6.31 c**s                eval      wmva02g = wmva02g - rbmvag
     c*                  eval      wmva09g = wmva09g - rbmvag
     c*                  eval      wmva09a = wmva09a - rbmvab
     c                   eval      wmva17a = wmva17a - rbmvab
      *
      * Beh.kode 35
      *
     c                   when      xmva = 35
6.31 c**s                eval      wmva02g = wmva02g - rbmvag
     c**s                eval      wmva10g = wmva10g - rbmvag
     c**s                eval      wmva10a = wmva10a - rbmvab
     c                   eval      wmva18a = wmva18a - rbmvab
      *
      * Beh.kode 36 - 38
      *
     c*                  when      xmva = 36-38
      *                  ???????????????????
      * Beh.kode 39
      *
     c                   when      xmva = 39
     c                   eval      wmva02g = wmva02g - rbneto
     c                   eval      wmva08g = wmva08g - rbneto
      * Beh.kode 40
      *
     c                   when      xmva = 40
      * Beh.kode 41
      *
     c                   when      xmva = 41
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva09g = wmva09g - rbmvag
     c                   eval      wmva09a = wmva09a - rbmvab
     c                   eval      wmva17a = wmva17a - rbmvab
      * Beh.kode 42
      *
     c                   when      xmva = 42
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva09g = wmva09g - rbmvag
     c                   eval      wmva09a = wmva09a - rbmvab
      * Beh.kode 43
      *
     c                   when      xmva = 43
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva10g = wmva10g - rbmvag
     c                   eval      wmva10a = wmva10a - rbmvab
     c                   eval      wmva18a = wmva18a - rbmvab
      * Beh.kode 44
      *
     c                   when      xmva = 44
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva10g = wmva10g - rbmvag
     c                   eval      wmva10a = wmva10a - rbmvab
      * Beh.kode 45
      *
     c                   when      xmva = 45
sst4 c                   eval      wmva02g = wmva02g + rbneto
sst4 c*                  eval      wmva02g = wmva02g - rbneto
     c                   eval      wmva11g = wmva11g - rbneto
      * Beh.kode 46
      *
     c                   when      xmva = 46
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva12g = wmva12g - rbmvag
     c                   eval      wmva12a = wmva12a - rbmvab
      * Beh.kode 47
      *
     c                   when      xmva = 47
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva12g = wmva12g - rbmvag
     c                   eval      wmva12a = wmva12a - rbmvab
     c                   eval      wmva17a = wmva17a - rbmvab
      * Beh.kode 48
      *
     c                   when      xmva = 48
sst4 c                   eval      wmva02g = wmva02g + rbmvag
sst4 c*                  eval      wmva02g = wmva02g - rbmvag
     c                   eval      wmva12g = wmva12g - rbmvag
     c                   eval      wmva12a = wmva12a - rbmvab
      *
     c                   endsl
      *
      * Skriv heading
      *
     c                   if        *in30 = *on
     c                   write     t1hdr
     c                   eval      *in30 = *off
     c                   endif
8.10  *
8.10  *  Hent standard SAFT mvakode
8.10  *
8.10  *
8.10 c                   eval      rmvxlu_firm = w_firm
8.10 c                   eval      rmvxlu_smvk = %editc(rtesmk:'X')
8.10 c                   eval      rmvxlu_mvap = rbpmva
8.10 c     rmvxlu_key    chain     rmvxlu
8.10 c                   if        not %found(rmvxlu)
8.10 c                   clear                   rmvxlur
8.10 c                   endif
8.10 c                   eval      rxneto = rxneto + rbneto
8.10 c                   eval      rxgrla = rxgrla + rbmvag
8.10 c                   if           xmva  = 01
8.10 c                             or xmva  = 11
8.10 c                             or xmva  = 12
8.10 c                             or xmva  = 21
8.10 c                             or xmva  = 34
8.10 c                             or xmva  = 35
8.10 c                             or xmva  = 37
8.10 c                             or xmva  = 41
8.10 c                             or xmva  = 42
8.10 c                             or xmva  = 43
8.10 c                             or xmva  = 44
8.10 c                             or xmva  = 46
8.10 c                             or xmva  = 47
8.10 c                             or xmva  = 48
8.10 c                             or (rbkont = radk02
8.10 c                             and (xmva  = 09
8.10 c                               or xmva  = 19
8.10 c                               or xmva  = 29))
8.10 c                   eval      rximva = rximva + rbmvab
8.10 c                   endif
8.10 c                   if           xmva  = 03
8.10 c                             or xmva  = 13
8.10 c                             or xmva  = 23
8.10 c                             or (rbkont = radk01
8.10 c                             and (xmva  = 09
8.10 c                               or xmva  = 19
8.10 c                               or xmva  = 29))
8.10 c                   eval      rxumva = rxumva + rbmvab
8.10 c                   endif
8.10 c                   eval      rxeusr = l_user
8.10 c                   time                    rxedat
8.10 c                   time                    rxetim
8.10  *
8.10 c                   if        rxgrla <> 0
8.10 c                   if        not %found(rmvxlu)
8.10 c                   eval      rxfirm = w_firm
8.10 c                   eval      rxsmvk = rmvxlu_smvk
8.10 c                   eval      rxmvap = rmvxlu_mvap
8.10 c                   write     rmvxlur
8.10 c                   else
8.10 c                   update    rmvxlur
8.10 c                   endif
8.10 c                   endif
      *
      * Skriv postering
      *
     c                   if        rhpsps = 'N'
     c*                            xmva > *zero
      * Skriver heading første gang
     c                   if        fØrste = 0
     c                   add       1             fØrste            1 0
     c                   eval      w_mvak = rbmvak
     c                   eval      w_kont = rbkont
     c                   write     t1deh
     c                   endif
      *
      *
6.21 c                   if        rbkont = w_kont and
6.21 c                             rbmvak = w_mvak
     c                   add       rbneto        t0nto
     c                   add       rbmvag        t0grl
     c                   add       imva          t0imv
     c                   add       umva          t0umv
     c                   add       brto          t0bto
     c                   else
     c                   write     t0det
     c                   add       t0nto         t0tot
     c                   add       t0grl         t0to1
     c                   add       t0imv         t0to2
     c                   add       t0umv         t0to3
     c                   add       t0bto         t0to4
     c                   eval      t0nto = *zeros
     c                   eval      t0grl = *zeros
     c                   eval      t0imv = *zeros
     c                   eval      t0umv = *zeros
     c                   eval      t0bto = *zeros
     c                   eval      w_kont = rbkont
     c                   add       rbneto        t0nto
     c                   add       rbmvag        t0grl
     c                   add       imva          t0imv
     c                   add       umva          t0umv
     c                   add       brto          t0bto
     c                   endif
      *
      *
      * Skriver heading
     c                   if        fØrste = 1 and
     c                             rbmvak <> w_mvak
     c                   eval      w_mvak = rbmvak
     c                   write     t2det
     c                   eval      t0tot = *zeros
     c                   eval      t0tot = *zeros
     c                   eval      t0to1 = *zeros
     c                   eval      t0to2 = *zeros
     c                   eval      t0to3 = *zeros
     c                   eval      t0to4 = *zeros
     c                   write     t1deh
     c                   endif
      *
     c   88              write     d1det
     c                   endif
     c***                endif
      /SPACE 3
      *
      * Oppdater postering
      *
     c                   if        rhptst = 'N'
     c                   eval      rhtrlu_raar = rbraar
     c                   eval      rhtrlu_kont = rbkont
     c                   eval      rhtrlu_spes = rbspes
     c                   eval      rhtrlu_avde = rbavde
     c                   eval      rhtrlu_rper = rbrper
     c                   eval      rhtrlu_bdat = rbbdat
     c                   eval      rhtrlu_tist = rbtist
     c     rhtrlu_key    chain     rhtrlu                             62
      *
     c                   if        *in62 = *off
     c                   move      '1'           rbmmrk
     c                   move      rhpmva        rbmvap
6.11 c                   time                    rbedat
6.11 c                   time                    rbetim
6.11 c                   eval      rbeusr = l_user
     c                   update    rhtrlur
     c                   endif
      *
     c                   endif
      *
     c                   endsr
      *
      /eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for behandling av brudd på mva-kode                   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     brudd         begsr
      *
     c                   if        rbmvak = ' '
     c                   move      '0'           amva
     c                   else
     c                   move      rbmvak        amva
     c                   endif
      *
     c                   eval      x = x + 1
      *
     c                   move      amva          mk(x)
      *
      * Hent behandlingskode fra MVA-kode i koderegister
      *
     c                   move      amva          ra05lr_ekod
     c     ra05lr_key    chain     ra05lr                             61
      *
     c                   move      raebmk        xmva
     c                   eval      w_edat = raemda
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for utskrift av fordelingsskjema og mva-oppgave       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     mvatot        begsr
      *
     c                   write     t1hdr
      *
     c     1             do        98            x
      *
     c                   eval      wsbel = wsbel + bto(x)
     c                   eval      wsmvag = wsmvag + grl(x)
     c                   eval      wsimva = wsimva + imv(x)
     c                   eval      wsimvu = wsimvu + imu(x)
     c                   eval      wsumva = wsumva + umv(x)
     c                   eval      wsnett = wsnett + nto(x)
      *
     c                   if        nto(x) <> *zero or
     c                             grl(x) <> *zero or
     c                             bto(x) <> *zero or
     c                             imv(x) <> *zero or
V5.40c                             imu(x) <> *zero or
     c                             umv(x) <> *zero
     c                   eval      t1mk  = mk(x)
8.03 c                   eval      t     = x
8.03  * Finner ev. SAFT-momskode
8.03 c                   eval      rat5pf_kode = t1mk
8.03 c     rat5pf_key    chain     rat5pf
8.03 c                   if        %found(rat5pf)
8.03 c                   eval      mks(x) = %editc(rtesmk:'X')
8.03 c                   else
8.03 c                   eval      mks(x) = *blank
8.03 c                   endif
8.03  *
debugc                   if        mks(x) = '01'
debugc                   endif
8.04sc**                 if        t1mks = '01'
8.04sc                   if        mks(x) = '01'
8.04 c                   eval      S1bto = S1bto + bto(x)
8.04 c                   eval      S1grl = S1grl + grl(x)
8.04 c                   eval      S1imv = S1imv + imv(x)
8.04sc**                 eval      S1umv = S1umv + umv(x) + imu(x)
8.04sc                   eval      S1umv = S1umv + umv(x)
8.04 c                   eval      S1nto = S1nto + nto(x)
8.04 c                   endif
     c*                  eval      t1bto = bto(x)
     c*                  eval      t1grl = grl(x)
     c*                  eval      t1imv = imv(x)
     c*                  eval      t1umv = umv(x) + imu(x)
     c*                  eval      t1nto = nto(x)
      *
8.03 c**                 write     t1det
8.03 c                   endif
8.03 c                   enddo
8.03  *
8.03  *  Sorterer sumlinje pr momskode på Saft_mk og Mk
8.03 c                   for       i = 1 to t
8.03 c                   if        mk(i+1) = ' '
8.03 c                             and mks(i+1) = ' '
8.03 c                             and nto(i+1) = 0
8.03 c                             and grl(i+1) = 0
8.03 c                             and bto(i+1) = 0
8.03 c                             and imv(i+1) = 0
8.03 c                             and imu(i+1) = 0
8.03 c                             and umv(i+1) = 0
8.03 c                   goto      sort_ok
8.03 c                   endif
8.03 c                   for       j = 1 to t
8.03 c                   if        mks(j) > mks(j+1)
8.03 c                             or  mks(j) = mks(j+1)
8.03 c                             and mk(j)  > mk(j+1)
8.03 c                   eval      mk(99)  = mk(j)
8.03 c                   eval      mks(99) = mks(j)
8.03 c                   eval      nto(99) = nto(j)
8.03 c                   eval      grl(99) = grl(j)
8.03 c                   eval      bto(99) = bto(j)
8.03 c                   eval      imv(99) = imv(j)
8.03 c                   eval      imu(99) = imu(j)
8.03 c                   eval      umv(99) = umv(j)
8.03 c                   eval      mk(j)   = mk(j+1)
8.03 c                   eval      mks(j)  = mks(j+1)
8.03 c                   eval      nto(j)  = nto(j+1)
8.03 c                   eval      grl(j)  = grl(j+1)
8.03 c                   eval      bto(j)  = bto(j+1)
8.03 c                   eval      imv(j)  = imv(j+1)
8.03 c                   eval      imu(j)  = imu(j+1)
8.03 c                   eval      umv(j)  = umv(j+1)
8.03 c                   eval      mk(j+1)  = mk(99)
8.03 c                   eval      mks(j+1) = mks(99)
8.03 c                   eval      nto(j+1) = nto(99)
8.03 c                   eval      grl(j+1) = grl(99)
8.03 c                   eval      bto(j+1) = bto(99)
8.03 c                   eval      imv(j+1) = imv(99)
8.03 c                   eval      imu(j+1) = imu(99)
8.03 c                   eval      umv(j+1) = umv(99)
8.03 c                   endif
8.03 c                   if        mk(j+1) = ' '
8.03 c                             and mks(j+1) = ' '
8.03 c                             and nto(j+1) = 0
8.03 c                             and grl(j+1) = 0
8.03 c                             and bto(j+1) = 0
8.03 c                             and imv(j+1) = 0
8.03 c                             and imu(j+1) = 0
8.03 c                             and umv(j+1) = 0
8.03 c                   eval      t = j
8.03 c                   goto      loop_ok
8.03 c                   endif
8.03 c                   endfor
8.03 c     loop_ok       tag
8.03 c                   endfor
8.03 c     sort_ok       tag
8.03  *
8.03 c
8.03  *    Så skal tabellen skrives ut.    debug2
8.03 c                   for       i = 1 to t + 1
8.03 c                   eval      t1mk  = mk(i)
8.03 c                   eval      t1mks = mks(i)
8.03 c                   eval      t1bto = bto(i)
8.03 c                   eval      t1grl = grl(i)
8.03 c                   eval      t1imv = imv(i)
8.03 c                   eval      t1umv = umv(i) + imu(i)
8.03 c                   eval      t1nto = nto(i)
8.06  *
8.03 c                   write     t1det
      *
      *  Her skal summene skrives til XML-fil
8.06  *  Akkumulere totaler til XML-utgave av MVA-Rapport
8.06  *                  debyg4
8.06 c                   if           t1nto <> 0
8.06 c                             or t1grl <> 0
8.06 c                             or t1imv <> 0
8.06 c                             or t1umv <> 0
8.06 c                   eval      rat5pf_kode = w_mvak
8.06 c     rat5pf_key    chain     rat5pf
8.06 c                   if        %found(rat5pf)
8.06 c                   eval      rmvxlu_smvk = %editc(rtesmk:'X')
8.06 c                   else
8.06 c                   eval      rmvxlu_smvk = *blank
8.06 c                   endif
8.06 c                   eval      rmvxlu_firm = w_firm
8.06 c                   eval      rmvxlu_smvk = t1mks
8.06 c     rmvxlu_key    chain     rmvxlu
8.06 c                   if        not %found(rmvxlu)
8.06 c                   clear                   rmvxlur
8.06 c                   endif
8.06 c                   eval      rxneto = rxneto + t1nto
8.06 c                   eval      rxgrla = rxgrla + t1grl
8.06 c                   eval      rximva = rximva + t1imv
8.06 c                   eval      rxumva = rxumva + t1umv
8.06 c                   eval      rxeusr = l_user
8.06 c                   time                    rxedat
8.06 c                   time                    rxetim
8.06  *
8.06 c                   if        not %found(rmvxlu)
8.06 c                   eval      rxfirm = w_firm
8.06 c                   eval      rxsmvk = rmvxlu_smvk
8.06 c***                write     rmvxlur
8.06 c                   else
8.06 c****               update    rmvxlur
8.06 c                   endif
8.06 c                   endif
      *  XML_Slutt
8.03 c                   endfor
8.03  * ____________________________________________________________________
      *
     c***???Debug        enddo
      *
      /eject
      *
     c                   if        wsnett = *zero
     c                             or wsmvag = *zero
     c                             or wsimva = *zero
     c                             or wsumva = *zero
     c                             or wsbel  = *zero
     c                   eval      wsbel = wsbel
     c                   else
     c                   eval      wsbel = wsbel
     c                   endif
      *
     c                   write     t1tot
      *
     c                   write     t1strek
8.04  *
8.04  *  Skriv ut sum pr SAFT-momskode
8.04  *
8.08 c                   for       i = 1 to t + 1
8.08 c                   if        mk(i) <> ' '
8.08 c                             or mks(i) <> ' '
8.08 c                             or bto(i) <> 0
8.08 c                             or grl(i) <> 0
8.08 c                             or imv(i) <> 0
8.08 c                             or umv(i) <> 0
8.08 c                             or imv(i) <> 0
8.08 c                             or nto(i) <> 0
8.08 c                   eval      s = i
8.08 c                   leave
8.08 c                   endif
8.08 c                   endfor
8.08  *
8.08 c                   for       i = s to t + 1
8.08 c                   eval      t1mk  = *blank
8.08 c                   eval      t1mks = mks(i)
8.08 c                   eval      t1bto = *zero
8.08 c                   eval      t1grl = *zero
8.08 c                   eval      t1imv = *zero
8.08 c                   eval      t1umv = *zero
8.08 c                   eval      t1nto = *zero
8.08 c                   dow       i < 100
8.08 c                             and mks(i) = t1mks
8.08 c                   eval      t1bto = t1bto + bto(i)
8.08 c                   eval      t1grl = t1grl + grl(i)
8.08 c                   eval      t1imv = t1imv + imv(i)
8.08 c                   eval      t1umv = t1umv + umv(i) + imu(i)
8.08 c                   eval      t1nto = t1nto + nto(i)
8.08 c                   eval      i = i + 1
8.08 c                   enddo
8.08  *
8.08 c                   write     t1det
8.08  *
8.08 c                   eval      i = i - 1
8.08 c                   endfor
8.05  *
8.05  *  Skriv ut sum all med spes. konto
8.05  *
8.05 c                   eval      t1mk  = *blank
8.05 c                   eval      t1mks = 'Ut'
8.05 c                   eval      t1bto = u1bto
8.05 c                   eval      t1grl = u1grl
8.05 c                   eval      t1imv = u1imv
8.05sc**                 eval      t1umv = u1umv + u1imv
8.05sc                   eval      t1umv = u1umv
8.05 c                   eval      t1nto = u1nto
8.05 c                   eval      t1umv = u1mva
      * Debug1
8.05 c                   write     t1det
      *
      * Hent saldo på fylkesskattesjefens konto
      *
     c                   move      l_firm        rifirm
     c                   move      radk04        rhsal1_kont
     c                   move      rads04        rhsal1_spes
     c                   move      rada04        rhsal1_avde
     c                   move      rhprÅr        rhsal1_raar
     c                   move      1             rhsal1_type
      *
     c     rhsal1_key    chain     rhsal1                             61
     c                   if        *in61 = *off
      *
      * Beregn saldo denne periode
      *
     c                   eval      tsal = sal(14)
      *
     c     1             do        rhpper        x
     c                   eval      tsal = tsal + sal(x)
     c                   enddo
      *
     c                   else
     c                   eval      tsal = *zero
     c                   endif
      *
      * Summer periodens beløp
      * til tidligere saldo på konto
      *
     c                   eval      wsfylk = wsumva + wsimva - wsimvu
      *
     c                   eval      wsksal = tsal - wsfylk
      *
      * Beløp avrundes til hele kroner
      *
     c                   eval(h)   oms01g = wmva01g
sst4 c                   eval(h)   oms02g = wmva02g
sst4 c*                  eval(h)   oms02g = wmva02g * -1
      *
     c                   eval(h)   oms03g = wmva03g
     c                   eval(h)   oms03a = wmva03a
      *
     c                   eval(h)   oms04g = wmva04g
     c                   eval(h)   oms04a = wmva04a
      *
     c                   eval(h)   oms05g = wmva05g
     c                   eval(h)   oms05a = wmva05a
      *
     c                   eval(h)   oms06g = wmva06g
      *
     c                   eval(h)   oms07g = wmva07g
      *
sst4 c                   eval(h)   oms08g = wmva08g
sst4 c**                 eval(h)   oms08g = wmva08g * -1
      *
     c                   eval(h)   oms09g = wmva09g * -1
     c                   eval(h)   oms09a = wmva09a * -1
      *
     c                   eval(h)   oms10g = wmva10g * -1
     c                   eval(h)   oms10a = wmva10a * -1
      *
     c                   eval      oms11g = wmva11g * -1
      *
     c                   eval(h)   oms11g = wmva11g * -1
      *
     c                   eval(h)   oms12g = wmva12g * -1
     c                   eval(h)   oms12a = wmva12a * -1
      *
     c                   eval(h)   oms13g = wmva13g * -1
     c                   eval(h)   oms13a = wmva13a * -1
     c*
     c                   eval(h)   oms14a = wmva14a
     c*
     c                   eval(h)   oms15a = wmva15a
     c*
     c                   eval(h)   oms16a = wmva16a
     c*
     c                   eval(h)   oms17a = wmva17a
     c*
     c                   eval(h)   oms18a = wmva18a
     c*
     c                   eval(h)   oms19a = oms03a + oms04a +
     c                             oms05a + oms09a + oms10a +
     c                             oms12a + oms13a + oms14a +
     c                             oms15a + oms16a + oms17a +
     c                             oms18a
     c*
     c                   if        oms19a > *zero
     c                   move      *on           *in80
     c                   else
     c                   move      *off          *in80
     c                   endif
      *
      * Hent Fylkesskattesjefens konto
      *
     c                   move      radk04        rhovlr_kont
     c                   move      rads04        rhovlr_spes
     c                   move      rada04        rhovlr_avde
      *
     c     rhovlr_key    chain     rhovlr                             61
      *
     c                   eval      t1tek1 = *blanks
     c                   move      '9'           rjmvak
      *
     c                   if        *in61  = *off
     c                   movel     rhtext        t1tek1
     c                   move      rhmvak        rjmvak
     c                   endif
      *
      * Skriv MVA-oppgave
      *
     c                   write     t1mva
      *
      * Legg ut posteringer
      *
     c                   exsr      mvapos
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for å legge ut posteringer                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     mvapos        begsr
      *
     c                   eval      rjreid = 'H'
     c                   eval      rjfirm  = w_firm
     c                   eval      rjmmrk  = '1'
     c                   eval      rjmvap  = rhpmva
     c     *dmy          move      rhpkda        rjbdat
     c                   eval      rjbiln = ww4sgb
     c                   eval      rjdbkr = ' '
     c                   eval      rjbilk = 99
     c                   eval      rjtext = a01txt
     c                   eval      rjfeik = '1'
     c                   eval      rjatte = ' '
     c                   eval      rjtype = 2
     c                   eval      rjrper = rhpper
     c                   move      rhprÅr        rjraar
      *
      * Overført inngående avgift
      *
     c                   if        wsimva <> *zero
     c                   eval      rjneto = wsimva * -1
     c                   eval      rhpost = 'J'
     c                   move      radk02        rjkont
     c                   move      rads02        rjspes
     c                   move      rada02        rjavde
     c                   move      recnr1        rjbunt
610  c                   eval      rjnivo = *blank
610  c                   eval      rjmemb = w_memb
610  c                   time                    rjedat
610  c                   time                    rjetim
610  c                   eval      rjeusr = l_user
     c                   write     rjoupfr
     c                   endif
      *
V5.40 * Overført utgående avgift utenlandske tjenester
V5.40 *
V5.40c                   if        wsimvu <> *zero
V5.40c***                eval      rjneto = wsimvu * -1
V5.41c                   eval      rjneto = wsimvu
V5.40c                   eval      rhpost = 'J'
V5.40c                   move      radk08        rjkont
V5.40c                   move      rads08        rjspes
V5.40c                   move      rada08        rjavde
V5.40c                   move      recnr1        rjbunt
V5.40c                   write     rjoupfr
610  c                   eval      rjnivo = *blank
610  c                   eval      rjmemb = w_memb
610  c                   time                    rjedat
610  c                   time                    rjetim
610  c                   eval      rjeusr = l_user
V5.40c                   endif
      *
      * Overført utgående avgift
      *
     c                   if        wsumva <> *zero
     c                   eval      rjneto = wsumva * -1
     c                   eval      rhpost = 'J'
     c                   move      radk01        rjkont
     c                   move      rads01        rjspes
     c                   move      rada01        rjavde
     c                   move      recnr1        rjbunt
610  c                   eval      rjnivo = *blank
610  c                   eval      rjmemb = w_memb
610  c                   time                    rjedat
610  c                   time                    rjetim
610  c                   eval      rjeusr = l_user
     c                   write     rjoupfr
     c                   endif
      *
      * Overført fylkesskattesjefen
      *
     c                   if        wsfylk <> *zero
     c                   eval      rjneto = wsfylk
     c                   eval      rhpost = 'J'
     c                   move      radk04        rjkont
     c                   move      rads04        rjspes
     c                   move      rada04        rjavde
     c                   move      recnr1        rjbunt
610  c                   eval      rjnivo = *blank
610  c                   eval      rjmemb = w_memb
610  c                   time                    rjedat
610  c                   time                    rjetim
610  c                   eval      rjeusr = l_user
     c                   write     rjoupfr
     c                   endif
      *
     c                   endsr
      *
      /eject
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Finner spool som er generert av jobben
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     spoolnbr      begsr
pdf   /Free
pdf
pdf            QSPRILSP( SPRL0100
pdf                    : %size(SPRL0100)
pdf                    : 'SPRL0100'
pdf                    : errorcode );
pdf   /End-free
pdf  c*
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Kaller eget program for generering av xml fil. Eget pgm         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_create    begsr
pdf   *
pdf  c                   eval      splfname2 = *blanks
pdf  c                   eval      splfname3 = *blanks
pdf  c                   eval      jobname2 = *blanks
pdf  c                   eval      jobname3 = *blanks
pdf  c                   eval      username2 = *blanks
pdf  c                   eval      username3 = *blanks
pdf  c                   eval      jobnbr2 = *blanks
pdf  c                   eval      jobnbr3 = *blanks
pdf  c                   eval      splfnbr2 = *zeros
pdf  c                   eval      splfnbr3 = *zeros
6.24 c**                 eval      p_btyp = 'MVA-OPPGJØR'
6.24 c                   eval      p_btyp = 'MVAOPPGAVE'
6.20 c                   if        *in81 = *off
6.20 c                   eval      p_dspl = 'MVA - oppgjør, kjørt dato: '+
6.20 c                                      %char(udate)+' Mva periode: '+
6.20 c                                      %char(rhpmva)
6.20 c                   else
6.20 c                   eval      p_dspl = 'Test MVA - oppgjør, kjørt dato: '+
6.20 c                                      %char(udate)+' Mva periode: '+
6.20 c                                      %char(rhpmva)
6.20 c                   endif
6.20 c                   eval      p_refn = 'MOP-' + %char(udate)
6.20 c                   eval      p_tagg0 = *blanks
6.20 c                   eval      p_tagg0val = *blanks
6.20 c                   eval      p_tagg1 = *blanks
6.20 c                   eval      p_tagg1val = *blanks
6.20 c                   eval      p_tagg2 = *blanks
6.20 c                   eval      p_tagg2val = *blanks
6.20 c                   eval      p_tagg3 = *blanks
6.20 c                   eval      p_tagg3val = *blanks
6.20 c                   eval      p_tagg4 = *blanks
6.20 c                   eval      p_tagg4val = *blanks
6.20 c                   eval      p_tagg5 = *blanks
6.20 c                   eval      p_tagg5val = *blanks
6.20 c                   eval      p_tagg6 = *blanks
6.20 c                   eval      p_tagg6val = *blanks
6.20 c                   eval      p_tagg7 = *blanks
6.20 c                   eval      p_tagg7val = *blanks
6.20 c                   eval      p_tagg8 = *blanks
6.20 c                   eval      p_tagg8val = *blanks
6.20 c                   eval      p_tagg9 = *blanks
6.20 c                   eval      p_tagg9val = *blanks
pdf   *
6.20 c**                 call      'AP620R'
6.20 c                   call      'AP627R'
pdf  c                   PARM                    splfname
pdf  c                   PARM                    jobname
pdf  c                   PARM                    username
pdf  c                   PARM                    jobnbr
pdf  c                   PARM                    splfnbr
pdf  c                   PARM                    splfname2
pdf  c                   PARM                    jobname2
pdf  c                   PARM                    username2
pdf  c                   PARM                    jobnbr2
pdf  c                   PARM                    splfnbr2
pdf  c                   PARM                    splfname3
pdf  c                   PARM                    jobname3
pdf  c                   PARM                    username3
pdf  c                   PARM                    jobnbr3
pdf  c                   PARM                    splfnbr3
6.20 c                   parm                    p_tagg0
6.20 c                   parm                    p_tagg0val
6.20 c                   parm                    p_tagg1
6.20 c                   parm                    p_tagg1val
6.20 c                   parm                    p_tagg2
6.20 c                   parm                    p_tagg2val
6.20 c                   parm                    p_tagg3
6.20 c                   parm                    p_tagg3val
6.20 c                   parm                    p_tagg4
6.20 c                   parm                    p_tagg4val
6.20 c                   parm                    p_tagg5
6.20 c                   parm                    p_tagg5val
6.20 c                   parm                    p_tagg6
6.20 c                   parm                    p_tagg6val
6.20 c                   parm                    p_tagg7
6.20 c                   parm                    p_tagg7val
6.20 c                   parm                    p_tagg8
6.20 c                   parm                    p_tagg8val
6.20 c                   parm                    p_tagg9
6.20 c                   parm                    p_tagg9val
pdf  c                   PARM                    l_bach
6.12 c                   PARM                    p_btyp
6.20 c                   PARM                    p_refn
6.20 c                   PARM                    p_dspl
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     pdf_preview   begsr
pdf  c                   if        l_skje = 1
pdf   * Vi kaller program for launch av PDF i browser
pdf  c                   call      'AP621R'
pdf  c                   parm                    l_bach
pdf   *
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
     c     *entry        plist
610  c                   parm                    w_memb
      *
     c                   eval      w_msg = 'Start RH664R'
6.22 c*                  call      'DEBUGCL'
6.22 c*                  parm                    w_msg

pdf  c                   open      rh664s
      * Definisjoner av arbeidsfelt
      *
     c                   eval      recnr1 = 1
     c                   eval      x = 0
      *
     c                   eval      wsbel = 0
     c                   eval      wsimva = 0
V5.40c                   eval      wsimvu = 0
     c                   eval      wsumva = 0
     c                   eval      wsnett = 0
     c                   eval      wmva01g = 0
     c                   eval      wmva02g = 0
     c                   eval      wmva03g = 0
     c                   eval      wmva03a = 0
     c                   eval      wmva04g = 0
     c                   eval      wmva04a = 0
     c                   eval      wmva05g = 0
     c                   eval      wmva05a = 0
     c                   eval      wmva06g = 0
     c                   eval      wmva07g = 0
     c                   eval      wmva08g = 0
     c                   eval      wmva09g = 0
     c                   eval      wmva09a = 0
     c                   eval      wmva10g = 0
     c                   eval      wmva10a = 0
     c                   eval      wmva11g = 0
     c                   eval      wmva12g = 0
     c                   eval      wmva12a = 0
     c                   eval      wmva13g = 0
     c                   eval      wmva13a = 0
     c                   eval      wmva14a = 0
     c                   eval      wmva15a = 0
     c                   eval      wmva16a = 0
     c                   eval      wmva17a = 0
     c                   eval      wmva18a = 0
     c                   eval      wmva19a = 0
     c                   eval      page = 0
      *
     c                   eval      mk = *blank
     c                   eval      rhpost = *blank
      *
      * Hent sist brukte bilagsnummer
      *
     c                   move      l_firm        w_firm
     c                   move      rhprÅr        raa4l1_4aar
     c     raa4l1_key    chain     raa4l1                             61
      *
     c                   if        *in61 = *off
     c                   eval      ww4sgb = ra4sgb + 1
     c                   eval      ra4sgb = ww4sgb
     c                   update    raa4l1r
     c                   endif
      *
      * Hent faste kontonr fra koderegister
      *
     c     ra04l1_key    chain     ra04l1                             61
      *
     c                   eval      a01txt = 'OVERFØRT'
      *
     c*** sst 20.12.2021 eval      x = 10
      *
T5.60c                   if        rhptst = 'J'
T5.60c                   eval      *in81  = *on
T5.60c                   endif
      *
      * Skriv heading
     c                   write     t1hdr
      *
      *
      *
      * Key for posteringsregister - MVA
      *
     c     rhtrlb_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhtrlb_raar
      *
      * Key for posteringsregister - oppdatering
      *
     c     rhtrlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhtrlu_raar
     c                   kfld                    rhtrlu_kont
     c                   kfld                    rhtrlu_spes
     c                   kfld                    rhtrlu_avde
     c                   kfld                    rhtrlu_rper
     c                   kfld                    rhtrlu_bdat
     c                   kfld                    rhtrlu_tist
      *
      * Key for saldo-file
      *
     c     rhsal1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhsal1_kont
     c                   kfld                    rhsal1_spes
     c                   kfld                    rhsal1_avde
     c                   kfld                    rhsal1_raar
     c                   kfld                    rhsal1_type
      *
      * Key for kontoplan
      *
     c     rhovlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhovlr_kont
     c                   kfld                    rhovlr_spes
     c                   kfld                    rhovlr_avde
      *
      * Key for statuskode 4
      *
     c     raa4l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    raa4l1_4aar
      *
      * Key for faste konti
      *
     c     ra04l1_key    klist
     c                   kfld                    w_firm
      *
      * Key for mva-kode
      *
     c     ra05lr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra05lr_ekod
8.02  *
8.02  * Key for mva-kode
8.02  *
8.02 c     rat5pf_key    klist
8.02 c                   kfld                    w_firm
8.02 c                   kfld                    rat5pf_kode
      *
      * Key for firma
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
8.05  *
8.05  * Key for kontohenvisning
8.05  *
8.05 c     vkhvl1_key    klist
8.05 c                   kfld                    vkhvl1_firm
8.05 c                   kfld                    vkhvl1_kode
8.05 c                   kfld                    vkhvl1_lety
8.05 c                   kfld                    vkhvl1_otyp
8.05  *
8.06  *
8.06  * Key for Sum pr Saft mvakode til xml-utskrift
8.06  *
8.06 c     rmvxlu_key    klist
8.06 c                   kfld                    rmvxlu_firm
8.06 c                   kfld                    rmvxlu_smvk
8.10 c                   kfld                    rmvxlu_mvap
      *
     c     afirl1_key    chain     afirl1
     c                   move      aafnav        p_fnavn
     c                   move      aafftn        p_orgnr
     c                   move      aafbgi        p_konto
8.05  *
8.05 c                   eval      vkhvl1_firm = w_firm
8.05 c                   eval      vkhvl1_kode = 'OFAK'
8.05 c                   eval      vkhvl1_lety = *zero
8.05 c                   eval      vkhvl1_otyp = 'FI'
8.05 c     vkhvl1_key    chain     vkhvl1
8.05 c                   if        %found(vkhvl1)
8.05 c                   eval      utkkon = vakko1
8.05 c                   endif
8.05  *
     c                   endsr
      *
