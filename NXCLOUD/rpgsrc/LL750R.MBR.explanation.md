# Overview
This program (ASLAGR / LL750R) updates both the historical inventory ledger (vhisl3) and the active inventory register (vlagl1, vlaglu) when a given item (“vare”) changes from its current storage unit (“lagerenhet”) to a new unit. It retrieves a conversion factor from the item/unit reference file (vvenl1), then recalculates quantities in the ledger files accordingly.

Key points:

- It reads the new desired unit from the program parameter (p_enhe).  
- It uses the vvenl1 file to look up the volume conversion factor (veomre), which is applied to ledger quantities.  
- The program processes all historical ledger entries (vhisl3), then all active ledger entries (vlagl1/vlaglu).  
- Quantities are updated by multiplying with veomre and dividing by the original factor (w_omrl).  
- The program tracks the user and timestamp of each record update for audit/logging (using the Local Data Area for user ID and RPG’s TIME op-code for date/time).  

# File Interactions

1. **vvenl1 (Item/Unit)**
   - Routines use CHAIN with a composite key (firm, item, unit) to find the conversion factor (veomre).  
   - If veomre = 0 or the CHAIN fails, the program skips the conversion (jumps to the “avslutt” label).

2. **vhisl3 (Historical Inventory Ledger)**
   - The program scans through all records matching the item (using SETLL and READE).  
   - For each record, if vhenhl differs from the new unit (p_enhe), it attempts to retrieve the old unit’s factor.  
   - On success, the program updates vhenhl to the new unit and recalculates vhanta, vhbehl, etc.  
   - Date, time, and user fields are updated for each record.

3. **vlagl1 / vlaglu (Active Inventory Register)**
   - Similar logic is applied for the active ledger: scanning items via vlagl1, then updating details via vlaglu.  
   - The program again checks veomre from the previously retrieved factor and applies it to fields like vlpakk, vloord, vlbehl, etc.  
   - If the CHAIN to vlaglur (firm, item, location) succeeds, the program updates vlenhl to the new unit and recalculates various quantities.  
   - It records date, time, and user in the file fields before writing updates.

# Notable Design Details

- **Using a Single Conversion Factor (w_omrl):**  
  The code captures veomre in a local variable (w_omrl) and then consistently uses it to ensure multiplication/division remains accurate for all rows of the inventory files.

- **Versioned Adjustments (6.10, 7.01):**  
  Comments and conditionally commented blocks reflect incremental changes over time (e.g., adjusting logic to avoid fetching the old factor from the new unit field). These version tags document historical tweaks to the conversion process.

- **User/Date/Time Stamps:**  
  The program uses the local data area (l_user) and the TIME opcode to log who performed the update and when. This is critical for traceability in an environment where inventory adjustments must be auditable.

- **Conditional Replay of Conversion:**  
  The code only recalculates if the old unit differs from the new parameter-based unit and the relevant conversion factor is nonzero. This prevents inappropriate or redundant conversions.

- **Tag/GOTO Flow Control:**  
  The logic uses tag and goto statements (e.g., “avslutt,” “les_neste”) in places for clarity and direct control flow. While this is somewhat traditional in older RPG coding styles, it can still be seen in production systems to manage file I/O loops and error exits.

# Summary of Process
1. **Setup & Parameter Handling:**  
   - The “*ENTRY” PLIST reads p_firm, p_vare, p_enhe.  
   - w_firm is set from p_firm for building file keys.

2. **Obtain Conversion Factor (vvenl1):**  
   - CHAIN using (firm, p_vare, p_enhe).  
   - If not found or zero, jump to “avslutt.”

3. **Update Historical Ledger (vhisl3):**  
   - Loop through all vhisl3 records for p_vare.  
   - If the record’s unit differs from p_enhe, chain to vvenl1 to find the old unit’s conversion factor; then update fields and write changes.

4. **Update Active Ledger (vlagl1 / vlaglu):**  
   - Loop through vlagl1 for p_vare.  
   - For each record, chain to vlaglu and recalculate fields by multiplying with veomre / w_omrl, then update vlenhl to p_enhe.

5. **Finish & Return:**  
   - The program sets *INLR = *ON and returns.

This design ensures that historical and active inventory files remain consistent after a unit change. The procedure is controlled by file lookups and numeric checks, and captures an audit trail (user/date/time) for all updates.