# Explanation of RPG Program ND102R

This program appears to be an ILE RPG (RPG IV) program for IBM i, written in fixed-format style. The documentation and comments in the code are mainly in Norwegian. The program's primary purpose is to display an order reference ("Vise ordrreferanse") using a subfile interface on a workstation display.

Below is a structured explanation to onboard developers to the key components, logic, and flow:

---

## 1. File Declarations

```rpg
fedhelr    if   e           k disk    rename(edhepfr:edhelrr)
fnohel1    if   e           k disk    rename(nohepfr:nohel1r)
fnkeolr    if   e           k disk    rename(nkeopfr:nkeolrr)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
fnd102d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- Declares database files and renames *program described* records to RPG record formats.
- `nd102d` is a display file (likely has subfile/screen formats), with the subfile `b1sfl` and the subfile relative record number variable `w_srrn`.
- `infds(dspfbk)` sets up a display feedback data structure.

---

## 2. Data Structures & Variables

**Local Data Area / External Data References**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Defines access to data in the Local Data Area (LDA), e.g., user, firm number, etc.

**Display Feedback Data Structure**
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Used for intermediate display feedback, e.g., current subfile record.

**Working Variables**
- Many variables are declared for subfile paging, navigation, keys for reading files, and temporary storage.

```rpg
d w_fcrn          s              4  0      // First record number on page
d w_stel          s              4  0      // Subfile counter
d w_spge          s              4  0      // Subfile page size
d w_srrn          s              4  0      // Subfile relative record number
d w_sfrn/w_ssrn   s              ...       // Subfile navigation helpers
d w_seqe          s              1
d b_forn          s              1    inz(*off) // Forny (renew)
d w_firm          s                   like(eofirm)
d ...
```

**Parameter Variables**
- For parameters passed to the program.

```rpg
d p_firm          s                   like(eofirm)
d p_fsys          s                   like(eofsys)
d p_tell          s                   like(eotell)
```

**Constant**
```rpg
d c_sfil          s              2  0 inz(14) // Subfile page size
```

---

## 3. Special Indicators

The program uses classic RPG indicators for flow control and UI handling:

- LR = Last record, ends the program
- 10 = Roll (usually Page Down)
- 11 = Rolldown (Page Up)
- 12 = Sfldsp (Subfile display)
- 13 = Sfldspctl (Subfile display control)
- 14 = Sflclr (Subfile clear)
- 15 = Sflend (Subfile end)
- 21, 22, 30 = Cursor, field protection, etc.
- 31-79 = User messages, field notifications
- 80-99 = Work indicators

---

## 4. Main Program Flow

### Entry Point & Parameter Handling

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_fsys
c                   parm                    p_tell
...
c                   eval      w_firm = l_firm
c                   eval      b2fsys = p_fsys
...
c                   exsr      crt_subfile
c                   endsr
```
- The program receives 3 parameters: `p_firm` (firm), `p_fsys` (system), `p_tell` (order reference).
- It initializes various screen and subfile settings, loads descriptions, and sets up the subfile with initial data.

### Main Loop (Tag-based, Classic Structure)

```rpg
c     b2taga        tag
c                   write     b2cmd
c     b2tagb        tag
c                   exsr      dsp_subfile
c                   select
c                   when      *inkc or *inkl   // F3/F12 = Exit
c                   goto      avslutt
c                   when      *inke            // Enter = Renew
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10            // Roll (PageDown)
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   when      *in11            // Rolldown (PageUp)
c                   exsr      bck_subfile
c                   goto      b2tagb
c                   when      *in21            // Home
c                   eval      *in22 = *on
c                   goto      b2taga
c                   endsl
...
c                   exsr      subfile
c                   goto      b2taga
```
#### Main states:
1. Display a command screen (`b2cmd`).
2. Display subfile (`dsp_subfile`), showing relevant order refs.
3. Handle function keys: F3/F12 exits, Enter renews, F10/F11 are page navigation, Home returns to the start.
4. Perform subfile handling (`subfile` subroutine) if not exited.

### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Exits the program.

---

## 5. Subroutines (EXSR Sections)

### forny

- Repositions and refreshes the subfile data, based on the current cursor (if any).
- Chains to current position, clears, and refills the subfile.

### subfile

- Loops through displayed subfile records (`readc b1sfl`).
- Handles events for each line, like selection (if field `b1valg = 5`), which triggers a detail (via `xc2bld`).
- If needed, calls forny to refresh.

### xc2bld

- Calls external program 'ND103R' to display or process detailed lines for the chosen order.

### clr_subfile

- Sets indicators to clear subfile/storage and resets subfile navigation variables.

### crt_subfile

- Fills the subfile page with records from the database, up to the page size.
- Sets subfile fields, fetches additional data for lookup (like names/descriptions).
- Manages indicator for end-of-subfile (F15), updates navigation variables.

### bck_subfile

- Handles "Page Up" behavior: Reads back `c_sfil` records, repositions, clears, and refills subfile.

### dsp_subfile

- Handles subfile display logic.
- Shows the subfile control record (`b2ctl`), and manages screen indicators.

### *inzsr

- Initialization logic, as described earlier.

---

## 6. Subfile Paging Logic

- The program implements classic subfile paging, using variables to track:
  - Where the user currently is (`w_fcrn`)
  - Which page is displayed
  - Navigation logic for next/previous pages (`crt_subfile`, `bck_subfile`)
- The user can page up/down (F10/F11), select records, or exit.

---

## 7. Summary: What Does This Program Do?

- Displays a list of order references in a subfile on a display screen.
- Allows the user to scroll (page up/down) through the list.
- Allows selection of an item for further detail, which launches (calls) another program for item detail.
- Is highly keyed to various company/order fields and does lookups for extra descriptions as needed.
- Is modular with all database access and screen management done in subroutines for clarity and reuse.

---

## 8. Useful Notes for New Developers

- This is a legacy RPG program using fixed-format C specs, still widely used but increasingly replaced with /free format.
- Subfile handling is central to RPG "workstn" (workstation) display programs.
- Most business logic is in the subroutines, and navigation is controlled using indicators.
- The "tag"/GOTO pattern is a classic technique for strongly structured interactive programs.
- All database access uses keyed access, mostly for display/lookup, not for updates.

---

## 9. Key Terms (Norwegian)

- "Ordre": Order
- "Vise": Display/show
- "Fornye": Renew/refresh
- "Bla tilbake": Page back
- "Skjermbilde": Screen image
- "Subfil": Subfile (displayed list/grid)
- "Slette": Delete

---

This should give a new developer a clear view of how ND102R works, where to look for logic, and how to start modifying or troubleshooting it. For a deeper technical dive, one would look at the associated display file (ND102D) and any data areas or called programs.