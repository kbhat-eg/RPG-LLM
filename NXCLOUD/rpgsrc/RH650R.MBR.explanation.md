# RPG Source Code Explanation

## High-Level Overview

This program (`RH650R`) is written in RPG/400 (ILE RPG) and is used in an IBM i (AS/400) environment. Its purpose appears to be handling parameters for a revision journal in a general ledger system (“Hovedbok - revisjonsjournal - parameter”). The code interacts both with disk files and display files, gathers user input through a workstation screen, validates parameters including dates and accounting years, and finally returns parameters to a calling program.

The comments and some variables are in Norwegian. Below is a thorough walkthrough of the code structure and its main operations.

---

## Section-by-Section Detailed Explanation

### 1. Header & Comments

```rpg
     h datedit(*dmy) option(*nodebugio)
```
- `hedit(*dmy)` : Default date format is Day-Month-Year.
- `option(*nodebugio)` : Disables debug for input/output operations.

```rpg
      * System. . . . . : ASOKON
      * Program . . . . : RH650R
      * Beskrivelse . . : Hovedbok - revisjonsjournal - parameter
      * ... (More documentation) ...
      * BRUK AV INDIKATORER
      *   KA = F1  = Valg av firma
      *   KC = F3  = Exit
      *   ...indicator conventions...
```
- Documentation covers function keys, use of indicators, and history.

---

### 2. File Declarations

```rpg
     fausrl1    if   e           k disk
     frh650d    cf   e             workstn
```
- `ausrl1`: Input file, keyed, disk. User records.
- `rh650d`: Combined file, external, workstation (display/display file). For screen input/output.

---

### 3. Data Definitions

```rpg
     d                uds
     d rhpkda                300    305  0
     d rhprår                         4  0
     d rhpper                         2  0
     d rhpblk                         1
     d rhpskr                         1
```
- Declares various fields used for parameters (date, year, period, flags).

```rpg
     d l_user                911    920
     d l_firm                944    946  0
     d l_fnav                951    980
```
- Variables to hold user, firm, and company name information, probably passed in via parameter list.

```rpg
     d waar            s              4  0
     d wmnd            s              2  0
     d wpakod          s              2  0
     d wpdat1          s              6  0
     d p_in03          s              1
     d wwaar           s              2  0
```
- Working storage: temporary variables for year, month, etc.

```rpg
     d w_firm          s                   like(l_firm)
     d w_user          s                   like(l_user)
     d w_navn          s                   like(l_fnav)
```
- Working storage fields similar to the input parameters.

---

### 4. Main Logic Tags

#### Program Entry (`dummy` tag)

```rpg
     c     dummy         tag
```
- Placeholder tag, the actual processing starts at `*inzsr` subroutine.

---

#### * Screen Handling (Display File) *

##### Main input screen for parameter selection

```rpg
     c     a2taga        tag
     c     a2tagb        tag
     c                   exfmt     a2bld
```
- Presents the screen (`a2bld`) to the user for input.

##### Handling function keys

```rpg
     c                   if        *inkc = *on
     c                   move      '1'           p_in03
     c                   goto      xslutt
     c                   endif
```
- If the user presses F3 (`KC`), sets return parameter to '1' (meaning "exit") and goes to program end.

---

#### * Validation *

##### Check running date

```rpg
     c                   if        a2pkda = *zero
     c                   move      udate         a2pkda
     c                   endif

     c                   move      a2pkda        wwaar
     c     *dmy          test(d)                 a2pkda                 33
     c                   if        *in33 = *on
     c                   goto      a2taga
     c                   endif
```
- If the running date is zero (not entered), it sets it to the current date.
- Tests if the input date is valid; if not, sets indicator 33 and goes back to the input screen for correction.

##### Check accounting year

```rpg
     c                   if        a2prår > *year
     c                   eval      *in34 = *on
     c                   goto      a2taga
     c                   endif
```
- If the entered year is in the future, sets indicator 34 (error) and returns to input screen.

---

#### * Write parameters to return fields *

```rpg
     c                   move      a2pkda        rhpkda
     c                   move      a2prår        rhprår
     c                   move      a2pper        rhpper
     c                   move      a2pblk        rhpblk
     c                   move      a2pskr        rhpskr
```
- Copies validated input to output variables.

---

#### * Program Exit *

```rpg
     c     xslutt        tag
     c                   eval      *inlr = *on
     c                   return
```
- Sets last record indicator (*INLR) to end the program; returns to caller.

---

### 5. Initialization Subroutine (`*inzsr`)

Runs as the implicit first step.

```rpg
     c     *inzsr        begsr
     c                   eval      wpakod = *zero
     c                   eval      wpdat1 = 0
     c                   move      l_user        w_user
     c                   move      l_firm        w_firm
     c                   move      l_fnav        w_navn
     c                   move      udate         a2pkda
```
- Initializes working variables.
- Loads parameters `user`, `firm`, `company name` from the passed-in input.

##### Set default period based on date

```rpg
     c                   move      *year         waar
     c                   eval      wmnd = *month - 1
     c                   if        wmnd = *zero
     c                   movel     12            wmnd
     c                   eval      waar = waar - 1
     c                   move      waar          a2prår
     c                   else
     c                   move      waar          a2prår
     c                   endif
     c                   move      wmnd          a2pper
     c                   move      'N'           a2pblk
     c                   eval      p_in03 =' '
```
- Sets the period (`wmnd`) to last month; if current month is January, wraps to December and decrements the year.
- Sets `a2prår` (accounting year), `a2pper` (accounting period).
- Sets block parameter to `'N'`.

##### Retrieve user record

```rpg
     c     ausrl1_key    chain     ausrl1                             63
```
- Attempts to retrieve the user's record from `ausrl1` keyed file.

---

#### Parameter List Definition

```rpg
     c     *entry        plist
     c                   parm                    p_in03
```
- Defines the parameter list for input/output (here just `p_in03`).

---

#### Key List for User File

```rpg
     c     ausrl1_key    klist
     c                   kfld                    w_user
```
- Defines the key used in the chain operation for `ausrl1`.

---

### 6. Indicators

The program uses classic RPG indicator variables (`*INnn`), assigned for:
- Errors/validation (e.g., 33, 34),
- Screen control,
- File and subroutine processing.

---

## Overall Flow

1. **Initialization (`*inzsr`)**: Loads input parameters, initializes variables, sets default values for year/period, retrieves user data.
2. **Screen Display/Input**: Shows parameter entry screen (`exfmt a2bld`).
3. **Validation**: User input is validated for date and year.
4. **Error Handling**: If errors occur, screen is redisplayed with error messages/indicators.
5. **Exit Processing**: If user cancels (F3), sets output param and exits.
6. **Return**: On success, parameters are copied to output variables and program ends.

---

## Key Concepts for Onboarding

- **Files**: Disk file for user (ausrl1), display file for input/output (rh650d).
- **Indicators**: Used throughout for error handling, field protection, and control flow.
- **Parameter Handling**: Input and output via parameter list.
- **Display File**: Main interaction via `exfmt a2bld` for user parameter entry.
- **Data Validation**: Date and year checked rigorously, errors prompt for correction.
- **Return to Caller**: Final values are set; exit codes communicated via `p_in03`.

---

### Useful for New Developers

- The primary job is interactive: "get parameter values from the user, check them, return them to the caller."
- Error feedback is done by screen indicators (`*IN33`, `*IN34`) and looping back to the input.
- The program can be exited at any time with F3 (setting `p_in03` to `'1'`).
- All user/company context is passed in and copied into local work variables at startup.
- Date and period calculations handle year turnover (e.g., if it's January, “last month” is December of previous year).

---

## Summary

This program is a "parameter entry and validation" module for a general ledger revision journal. It prompts the user for date/year/period criteria, checks their validity, and returns the values. It is a typical AS/400 RPG/400 style program, using indicators for control, and screens for user entry, with strong documentation (in Norwegian) and structured error handling, suitable for business finance applications.