# ASOFAK FO702R – Order Header Update from Lines

## Overview

This program, part of the ASOFAK system, recalculates order totals (including VAT) at the order header level by aggregating data from the order lines. It is typically invoked after changes to order lines to ensure the order header reflects the correct gross, net, discount, and VAT totals.

## Main Purpose

- **Aggregates financial totals** (gross, net, discount, VAT, etc.) from all order lines for a given order.
- **Handles VAT calculation** across multiple rates.
- **Updates output parameters** with the new calculated totals, which can then be written back to the order header by the caller.

## File Usage

- **VLtyl1**: Line type master (for line classification, e.g., text lines vs. item lines).
- **Fodtl1**: Order line details.
- **Fohel1**: Order header (main order record).
- **Vvarl1**: Item master (for additional item info, possibly VAT codes).

All files are accessed in keyed mode, with renaming for record format clarity.

## Parameter Handling

The program receives and returns several parameters, mostly relating to order identity and totals:

- **Input**: Company (`p_firm`), order number (`p_numm`), order suffix (`p_suff`).
- **Output**: Totals for gross, discount, net, VAT by group, VAT by amount, other totals.

## Key Data Structures

- **Arrays for VAT Handling**:
  - `mko`: VAT code per rate (up to 9 rates).
  - `msa`: VAT rate per group.
  - `mgr`: Net base per VAT group.
  - `mbe`: VAT amount per group.
  - `mog`/`mor`: Used for discountable amounts and rebate calculations.

## Main Logic Flow

### 1. Initialization

- Arrays for VAT and totals are cleared.
- Company, order number, and suffix are set from parameters.

### 2. Order Header Lookup

- Attempts to retrieve the order header (`fohel1`).
- If not found, the program terminates early.

### 3. Order Line Aggregation

- Loops through all order lines for the order.
- For each line:
  - Retrieves line type (`vltyl1`) to determine if it is a text line or a product line.
  - If not a text line:
    - Looks up item master data (`vvarl1`) for additional info.
    - Aggregates gross (`p_brto`), discount (`p_raba`), and net (`p_neto`) values.
    - Invokes VAT calculation subroutine for the line.

### 4. VAT Calculation by Group

- After all lines are processed:
  - Calculates VAT per group: `(mgr - mor) * msa / 100`.
  - Sums VAT across all groups to compute the total VAT.
  - Computes order total as net + total VAT.

- Iterates over VAT groups (up to 9):
  - If the VAT code is present, updates group VAT and base totals.

### 5. Program End

- Sets LR indicator and returns.

## Subroutines

### `calc_mva` – VAT Calculation

- Called for each eligible order line.
- If a VAT code is present:
  - Calls external program `RS205R` to resolve the VAT rate and related info (likely a tax master lookup).
  - Calculates VAT amount for the line.
  - Updates group arrays via `xarray` subroutine.

### `xarray` – VAT Group Array Handling

- Maintains up to 9 VAT groups per order.
- If a group with the current VAT code exists or is empty, updates it:
  - Stores VAT code and rate.
  - Adds the net base for this line.
  - If a rebate percentage (`forabp`) applies and the item is not a rebate line (`vvkord = 0`), calculates the rebate base and amount for the group.

### `*inzsr` – Initialization

- Standard parameter list handling.
- Sets up all the key lists for file access.
- Stores the company number for later key construction.

## Notable Design Decisions & Conventions

- **Multi-rate VAT Support**: The use of arrays for VAT codes, rates, and bases allows multiple VAT rates per order—a requirement in many European tax regimes.
- **External VAT Rate Resolution**: Delegates VAT rate lookup to `RS205R`, allowing for centralized and consistent tax logic.
- **Text Line Filtering**: Only non-text lines contribute to financial totals.
- **Rebate Handling**: Special logic for group-level rebates, using `forabp` and `vvkord` fields.
- **No Direct Database Updates**: The program only calculates and returns totals via parameters; responsibility for writing results to the database lies with the caller.

## File Relationships & Dependencies

- **Order lines (`fodtl1`)** are linked to the order header (`fohel1`) by company, order number, and suffix.
- **Line type (`vltyl1`)** is used to filter out non-financial lines (e.g., text lines).
- **Item master (`vvarl1`)** provides supplementary info for each line item.
- **VAT rates and codes** are resolved via an external program, not directly from a file.

## Business/Domain-Specific Logic

- **Order Suffix**: Used to support split or multi-part orders.
- **Discounts and Rebates**: Calculated at both line and group level.
- **Norwegian Tax Context**: Variable names and comments indicate adaptation for Norwegian VAT (MVA) and business practices.

## Extension & Maintenance Notes

- **Adding More VAT Groups**: Increase array dimensions if more than 9 VAT rates per order are ever needed.
- **Changing VAT Logic**: Update or replace `RS205R` for changes in tax rules.
- **Order Types**: If new line types are introduced, ensure `vltyl1` and related logic are updated accordingly.

---

For any further questions regarding integration points (e.g., `RS205R` interface, field mapping to database), consult the system documentation or reach out to the business analyst team.