# Program Documentation: SF871R – Sales Statistics Transaction Aggregator

## Overview

**System:** ASSTAT  
**Program:** SF871R  
**Description:**  
This program aggregates sales statistics on a per-transaction basis. It collects, enriches, and exports transaction records from the sales statistics transaction file, integrating master data from several domain tables. The output is an export/aggregate file suitable for downstream reporting or further processing.

**Special Notes:**  
- Price group field was expanded from 1 to 2 positions as of version 8.01 (PRG2, 220622).
- The code is written in traditional fixed-format RPG IV.

---

## Purpose and Business Logic

The main function of SF871R is to process unhandled (i.e., not yet exported) sales transactions, enrich them with master data (e.g., customer, product, department), calculate derived fields (such as gross margin), and write the aggregated result to an export file. After processing, each transaction is marked as handled to prevent reprocessing.

---

## File Relationships

### Input Files

- **sstalh (sstapfr → sstalhr):** Sales statistics transaction file (primary input, keyed).
- **afirl1 (afirpfr → afirl1r):** Company master data.
- **ra07l1 (ra07pfr → ra07l1r):** Department master data.
- **rkunl1 (rkunpfr → rkunl1r):** Customer master data.
- **ra11l1 (ra11pfr → ra11l1r):** Customer category master data.
- **ra06l1 (ra06pfr → ra06l1r):** Discount category master data.
- **ra09l1 (ra09pfr → ra09l1r):** Salesperson master data.
- **rlevl1 (rlevpfr → rlevl1r):** Supplier master data.
- **vugrl1 (vugrpfr → vugrl1r):** Product group master data.
- **jmodl1 (jmodpfr → jmodl1r):** Module master data.

### Output File

- **sos1pf:** Aggregated sales statistics export file.

### External Program

- **VP704R:** Pricing calculation routine, called per transaction to retrieve price information at the point of sale.

---

## Key Data Flow

1. **Initialization (`*INZSR`):**
   - Receives parameters: price group (`p_fgrp`) and company (`p_firm`).
   - Prepares key lists for all file lookups.
   - Converts company parameter to numeric and stores in working variable.

2. **Main Processing Loop:**
   - Attempts to find company in `afirl1`. If not found, terminates.
   - Iterates over all unhandled transactions in `sstalh` (where `erap` = 0).
   - For each transaction, calls the `oppdater` subroutine to process.

3. **Transaction Processing (`oppdater`):**
   - Performs chained lookups to enrich the transaction with master data:
     - Department, customer, category, discount category, salesperson, supplier, product group, module.
   - Transfers and calculates a comprehensive set of fields for the export record.
   - Calculates net sales, cost, gross profit, and gross margin percent, with capping logic for extreme values.
   - Calls external program `VP704R` to retrieve pricing information at the time of sale.
   - Applies business rule: if cost price is zero but inventory price exists, use inventory price as cost.
   - Writes the processed record to the export file.
   - Marks the transaction as handled in `sstalh` (sets `erap` = 1).

---

## Design Decisions and Patterns

- **File Renaming:**  
  Input files are renamed to local record formats for clarity and to avoid naming conflicts.

- **Master Data Enrichment:**  
  For every transaction, the code performs chained lookups to multiple master tables. This ensures that the export file contains not only transactional but also contextual master data.

- **Key List Usage:**  
  Key lists (`klist`) are defined for all lookup operations, supporting multi-field keys and improving code maintainability.

- **Derived Calculations:**  
  The program calculates a number of derived fields, most notably:
    - **s1sumn:** Net sales (gross minus discounts).
    - **s1dekb:** Gross profit (net sales minus cost).
    - **s1dekg:** Gross margin percent, capped between -999.99 and 999.99.

- **Pricing Routine Integration:**  
  The external program `VP704R` is called for each transaction to fetch point-in-time pricing, ensuring accurate reporting.

- **Idempotent Processing:**  
  Each transaction is marked as handled after processing, preventing duplicate exports.

- **Parameterization:**  
  The company and price group are passed as parameters, allowing the program to be reused for different entities/data partitions.

---

## Domain/Business-Specific Notes

- **Transaction Handling:**  
  Only unhandled transactions (where `erap` = 0) are processed. This is a standard pattern for incremental batch processing.

- **Master Data Dependencies:**  
  The program assumes that all referenced master data exists and is up to date; missing lookups result in blank/zero fields but do not halt processing.

- **Gross Margin Calculation:**  
  The gross margin percent (`s1dekg`) is carefully capped to prevent outlier values from distorting reports.

- **Pricing Logic:**  
  The fallback logic for cost price fields ensures that, even if the main cost field is zero, an alternative is used if available.

---

## Conventions

- **Field Naming:**  
  - Input fields from `sstalh` use the `sf` prefix (e.g., `sfvkun` for customer).
  - Output fields to `sos1pf` use the `s1` prefix (e.g., `s1vkun`).
  - Master data fields retain their original naming with appropriate record format prefixes.

- **Subroutines:**  
  - `oppdater`: Main processing/enrichment logic for each transaction.
  - `*INZSR`: Initialization, parameter handling, and key list setup.

- **Error Handling:**  
  - Minimal; missing master data is tolerated, but missing company record causes program termination.

---

## External Interactions

- **Pricing Calculation (`VP704R`):**  
  This program is invoked for each transaction to obtain accurate sales and cost prices as of the transaction date/time. The call passes all relevant context (company, product, unit, price group, etc.) and receives back calculated prices.

---

## Summary of Main Processing Steps

1. **Initialize:** Read parameters, prepare keys.
2. **Validate Company:** Ensure the company exists in master data.
3. **Iterate Transactions:** For each unhandled sales transaction:
   - Enrich with master data.
   - Calculate derived fields.
   - Fetch prices using external program.
   - Write to export file.
   - Mark as handled.
4. **Exit:** Set LR indicator and return.

---

## Key Points for New Developers

- **This program is central to the sales data pipeline:** It aggregates and exports all sales transactions, ensuring they are enriched and deduplicated.
- **Master data lookups are fundamental:** If you change master data structures, update the key lists and enrichment logic here.
- **Pricing logic is externalized:** Any changes to pricing calculation require changes in `VP704R`, not here.
- **Field mappings are explicit:** Both for input and output, field assignments are clear and direct, reflecting the business requirement for traceability.
- **Batch processing pattern:** The program is designed to be run repeatedly, always picking up only new/unhandled transactions.

---

## Potential Extension Points

- **Error Logging:** Currently, failures in master data lookups do not log warnings. Consider adding logging if this becomes a concern.
- **Parallelism:** For large volumes, consider partitioning by company or date.
- **Configurable Capping:** The gross margin capping values are hardcoded; these could be made configurable if business needs change.
- **Additional Enrichment:** If new master data tables are added, extend the `oppdater` subroutine accordingly.

---

## Conclusion

SF871R is a robust, batch-oriented sales transaction aggregator, designed for reliability and extensibility. Its modular structure, reliance on master data, and integration with external pricing logic make it a key component of the ASSTAT system's sales reporting and analytics pipeline.