# RPG Program RT010R Explanation

This RPG (Report Program Generator) program is written for the IBM i (AS/400) environment, using the ILE RPG language. Below is a detailed explanation of its structure, components, and logic.

---

## 1. **Header and Program Description**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `option(*nodebugio)` disables debug input/output.
- `datedit(*dmy)` sets the date editing format to day/month/year.

The comments at the top provide metadata:
- System: ASOKON
- Program: RT010R
- Description: Create total chart of accounts (Danne total kontoplan)
- Purpose: Adds company and account names
- Author/Revision info: Created by HFL on 2004-08-06

---

## 2. **File Declarations**

```rpg
frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
Frtotl1    uf   e           k disk    rename(rtotpfr:rtotl1r)
```
- **rhovl1**: Input full-procedural file, externally described, keyed, renamed record format to `rhovl1r`.
- **rtotl1**: Update full-procedural file, externally described, keyed, renamed record format to `rtotl1r`.

---

## 3. **Local Data Area (LDA) Definitions**

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d lcnavn                951    980
```
- Using the user data structure (`uds`) from LDA.
- Defines:
  - `l_user`: Characters 911-920 (user identifier)
  - `l_firm`: Characters 944-946, 0 decimals (company identifier)
  - `lcnavn`: Characters 951-980 (company name)

---

## 4. **Key Variable Definitions**

```rpg
d rhovl1_kont     s                   like(rhkont)
d rhovl1_spes     s                   like(rhspes)
d rhovl1_avde     s                   like(rhavde)
d w_firm          s                   like(rhfirm)
d wkonto          s                   like(rhkont)
```
- **rhovl1_kont, rhovl1_spes, rhovl1_avde**: Variables for holding key fields similar to their definitions in the file.
- **w_firm, wkonto**: Working variables for company and account.

---

## 5. **Field Renaming for RTOTL1**

```rpg
IRTOTL1R
I              FIRMA                       TOFIRM
I              KONTO                       TOKONT
```
- Within the renamed RTOTL1R record format, `FIRMA` is referenced as `TOFIRM` and `KONTO` as `TOKONT`.

---

## 6. **Main Program Logic**

### Main Loop

```rpg
C     *IN50         DOWEQ     *OFF
C                   READ      RTOTL1R                                50
C     *IN50         IFEQ      *OFF
```
- Loops through the `RTOTL1R` records until EOF (`*IN50` ON).

### Account Break Processing

```rpg
C     TOKONT        IFNE      WKONTO
c                   eval      rhovl1_kont = tokont
c                   eval      rhovl1_spes = *zeros
c                   eval      rhovl1_avde = *zeros
c     rhovl1_key    chain     rhovl1                             90
C                   MOVE      TOKONT        WKONTO
C                   END                                                    TOKONT
```
- If the account (`TOKONT`) has changed since the last record (`WKONTO`):
  - Set up keys and zero out spec/department subfields.
  - **CHAIN** statement retrieves corresponding account plan info from `rhovl1`.
  - Updates `WKONTO` to the current value.

### Updating Names and Codes

```rpg
C                   MOVE      lcnavn        FINAVN
C                   MOVE      rhtext        KONAVN
c                   eval      refnr  = rhrefn
c                   eval      reftxt = rhreft
C                   UPDATE    RTOTL1R
C                   ENDIF                                                  <IN50
C                   ENDDO                                                  <IN50
```
- Moves company and account names from LDA/lookup (`lcnavn`, `rhtext`) to appropriate fields (`FINAVN`, `KONAVN`).
- Sets reference numbers/texts from lookup (`rhrefn`, `rhreft`) to the local fields (`refnr`, `reftxt`).
- **UPDATE** the current record in `RTOTL1R`.

### Program End

```rpg
C                   MOVE      '1'           *INLR
```
- Set last record indicator (`*INLR = '1'`) to end the program and release resources.

---

## 7. **Initialization Subroutine**

```rpg
c     *inzsr        begsr
c     rhovl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rhovl1_kont
c                   kfld                    rhovl1_spes
c                   kfld                    rhovl1_avde
c                   eval      w_firm = l_firm
c                   endsr
```
- **INZSR**: Runs at program start.
- Builds the key list structure for database access using company, account, spec, department.
- Initializes `w_firm` with the value from LDA (`l_firm`).

---

## 8. **Summary**

- The program reads through the total accounts file (`RTOTL1`), and on each account change, it chains to the account plan file (`RHOVL1`) to retrieve and assign company and account names.
- It updates the total accounts records with this information.
- Initialization loads company number from LDA and sets up key structure.

---

## 9. **Key RPG Concepts Demonstrated**

- File processing with `READ`, `CHAIN`, `UPDATE`
- Keyed access to files
- Use of Local Data Area (LDA) for configuration/context
- Subroutine initialization (`*INZSR`)
- Conditional logic on account changes ("break" processing)
- Field renaming for clarity
- Efficient looping and record updating

---

This program is a typical batch update utility, enriching a detailed ledger or account table with descriptive information via a master lookup, common in financial/ERP systems on IBM i.