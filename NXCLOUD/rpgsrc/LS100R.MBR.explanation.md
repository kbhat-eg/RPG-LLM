# RPG Program LS100R: Registration of Inventory Transaction Lines

## Overview

This program is an ILE RPG application for IBM i (AS/400) that manages inventory transaction lines (registrering av lagertransaksjonslinjer). It supports creating, updating, displaying, and deleting transaction lines tied to an inventory bundle/document. The code uses standard RPG/400 cycle-control logic and leverages subfiles for display and maintenance.

It is well-commented in Norwegian, with history logs showing changes and enhancements over multiple versions.

---

## File Definitions

- **Physical and Logical Files:**
  - `llhelr`: Inventory bundle header file (with record format rename).
  - `lldtlr`, `lldtl1`, `lldtl2`, `lldtlu`: Different logical views/updates of the inventory transaction lines.
  - `vvarl1`: Item master.
  - `vvenlr`: Item/unit master.
  - `vvlel1`: (possibly) lumber assortment.
- **Workstation File:**
  - `ls100d`: Display device file using a subfile called `b1sfl` (with subfile record number controlled via `w_srrn`).

---

## Key Variables and Their Use

- **Indicator Usage:**
  - *LR*: End of program.
  - 10,12,13,14,15,16,21,22,30,31-99: Various control and error conditions, screen behavior, file access.

- **Local Data Area (LDA):**
  - Contains user, firm, and file name data extracted from fixed LDA positions.

- **Working Variables:**
  - `w_numm`: Current bundle/document number.
  - `w_slin`: Highest used transaction line number.
  - `w_srrn`, `w_ssrn`, `w_spge`, `w_sfrn`: Tracking subfile record and paging.
  - `w_vtyp`, `w_utda`, `w_ldor`, etc.: Used for item type, expiry, and tracking.

---

## Core Logic and Main Flow

### Program Initialization (`*inzsr`)

- Reads program parameter (`p_numm`), initializes keys, reads header (`llhelr`), determines the highest used line, and pre-loads the subfile (`crt_subfile`).
- Sets up key lists for reading and updating records by different access paths (by line, by item, etc.).

---

### Main Control Loop

- **Main Tags:** `b2taga` and `b2tagb` are the main control points.
- **Display and Update Cycle:**
  1. Display command window (`b2cmd`).
  2. Process the subfile (`dsp_subfile`), showing existing lines.
  3. Handle function keys:
     - Exit/cancel: End program.
     - F4=Prompt: Subfile "search" and field prompting (`sp_input`).
     - F5=Refresh: Recreate subfile (`forny`).
     - F6=Create: Open "add/change line" window (`xc2win`).
     - F10=Next Page: Fetch more records (`crt_subfile`).
  4. Positioning subroutine enables the user to position the subfile by line/item.
  5. Main subfile processing: looping through records to detect edits (`b1valg=2`), deletes (`b1valg=4`), and updating/deleting records accordingly.

---

### Subroutines (Key Logic Blocks)

#### 1. `forny` (Refresh)
- Repositions file pointers depending on sort order (`w_seqe`) and refills the subfile, preparing for display.

#### 2. `posisjoner` (Positioning)
- Allows user to position the subfile either by line or item number, then refreshes view.

#### 3. `subfile`
- Loops through user actions in the subfile (edit, delete), calls appropriate routines.

#### 4. `xc2win` (Edit/Create Window)
- Handles both **add** (new line) and **edit** (existing line):
  - For add: blanks out fields, sets up default values.
  - For edit: Loads values from existing line, validates item, storage locations, quantity, unit, type code, and reason code.
  - Calls pricing routine (`VP700R`) to fetch cost and price.
  - Writes or updates the transaction line.
  - Handles field validation, error indicators and prompt logic.

#### 5. `xb4win` (Delete Window)
- Displays confirm-delete window.
- Deletes transaction line if confirmed.

#### 6. `clr_subfile`
- Clears the subfile and control fields.

#### 7. `crt_subfile`
- Reads and loads lines into the subfile for display/paging.
- Handles paging for the subfile.

#### 8. `dsp_subfile`
- Handles actual display of the subfile.

#### 9. `les_vare` (Read Item)
- Fetches item info (description, unit) from the item master. Flags error if item not found.

#### 10. `sp_input` (Prompting)
- Calls external programs for item/unit/location/reason code prompting. Updates screen fields as appropriate.

#### 11. `sjekk_lager` (Check Location)
- Calls an external routine (`RS710R`) to verify the warehouse location; sets error if invalid.

#### 12. `sjekk_årsaker` (Check Reason Code)
- Calls an external routine (`RS724R`) to verify the reason code; sets error if invalid.

#### 13. `les_vare_enh` (Check Item/Unit)
- Verifies that the item/unit combination is valid; flags error if not.

#### 14. `hent_prisgr` (Get Price Group)
- Calls external routine to fetch the price group for the item/location.

---

## Additional Notes

- **Function Calls:** Several external programs are called for validation, prompting, and fetching info (e.g., `VP700R`, `VL710R`, `VV500R`, etc.).
- **Indicators:** RPG indicators are heavily used for controlling screen fields, error signaling, and file operations.
- **Version History:** The program has evolved over time, handling new requirements such as price group extension, tracking, assortments, and GUI-related changes.

---

## Subfile/Paging Mechanism

- The subfile is used to display pages of transaction lines with support for paging (`w_spge`), positioning, and selection for edit/delete.

---

## Summary Table

| Function        | Purpose/Notes                                                             |
|-----------------|--------------------------------------------------------------------------|
| xc2win          | Edit or add new transaction line                                         |
| xb4win          | Delete a transaction line                                                |
| crt_subfile     | Populate subfile with lines from database, handle paging                 |
| clr_subfile     | Clear subfile, reset counters                                            |
| dsp_subfile     | Display subfile on the screen                                            |
| sp_input        | Prompt for inputs using external programs                                |
| les_vare        | Retrieve item info from master                                           |
| les_vare_enh    | Validate item/unit combination                                           |
| sjekk_lager     | Validate storage location code                                           |
| sjekk_årsaker   | Validate reason code                                                     |
| hent_prisgr     | Fetch item's price group for pricing                                     |

---

## Key Takeaways for New Developers

- **This is a traditional physical file/subfile-based RPG program for inventory transaction entry.**
- The code structure is modular, relying heavily on subroutines and external validation programs.
- **Indicators must be carefully tracked:** much logic depends on their state.
- **Many fields are re-used and reset:** especially in add/change logic. Pay attention to when variables are blanked.
- **All file access is via well-defined key lists**, which are set up in the `*inzsr` initialization routine.
- **The program expects to be called with a bundle/document number and manages all lines for that document.**
- **Extensive version history and comments** help clarify why certain logic blocks exist.

---

## Learning Path
- Familiarize yourself with ILE RPG syntax, especially subfiles, indicator usage, and external program calls.
- Understand the structure of the inventory master files, transaction header/line files, and their logical views.
- Study the interaction between main control logic and subroutines, especially those handling edit/add/delete.
- Review the external programs called for prompting and validation, as they are integral to business rules enforcement.

---

This explanation should provide a strong starting point for onboarding onto the LS100R inventory transaction management program.