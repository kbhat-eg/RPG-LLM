# Program IT114R – Documentation

## Overview

**Program Name:** IT114R  
**System:** ASNAVIOKO  
**Purpose:**  
This program updates district codes ("distrikter") in the system, based on data received from the Norwegian Labour and Welfare Administration (NAV). It supports inserting, updating, and deleting district code records in the `RA07LU` file, which is a district code master file.

**Special Notes:**  
- The program is called with parameters indicating the operation (INSERT, UPDATE, DELETE), the target firm, user, and data payload.
- The code follows Norwegian naming conventions and includes some domain-specific terminology (e.g., "gkod" for code, "besk" for description).

---

## File Definitions

```rpg
fra07lu    uf a e           k disk    rename(ra07pfr:ra07lur)
```
- **RA07LU**: The main physical file being updated. It is accessed with a user open (UF), keyed (K), and renamed locally as `RA07LUR`.
- The record format `RA07PFR` is renamed to `RA07LUR` in this program for clarity or naming convention consistency.

---

## Parameters

The program is called with the following parameters:

- `p_firm`: Firm identifier (like `ragfir`)
- `p_comd`: Command (20A) – must be 'INSERT', 'UPDATE', or 'DELETE'
- `p_parm`: Data payload (2048A) – contains the district code and description
- `p_user`: User ID (10A)
- `p_stat`: Status flag (1A) – output parameter indicating success ('1') or failure (' ')

---

## Data Structures and Variables

### Parameter Data Structure

```rpg
d d_parm          ds          2048
d  d_gkod                        2
d  d_besk                       40
```
- `d_gkod`: District code (2A)
- `d_besk`: District description (40A)
- This structure is loaded from `p_parm` and used to extract the relevant fields for processing.

### Working Variables

- `w_firm`: Working firm code
- `w_date`, `w_time`: Current date and time (ISO format) – used for audit fields
- `w_gkod`: Working district code

---

## Main Flow

1. **Parameter Preparation**
    - The incoming parameter string (`p_parm`) is moved into the `d_parm` data structure for field extraction.
    - Subroutines `red_num` and `red_flt` are called to sanitize and convert numeric fields as needed (currently only `red_flt` is active).

2. **Command Dispatch**
    - Based on `p_comd`, the program selects the appropriate operation:
        - `INSERT` → `nyrec`
        - `UPDATE` → `oppdrec`
        - `DELETE` → `sletrec`

3. **Program End**
    - Sets on LR (`*INLR = *ON`) and returns.

---

## Subroutines

### 1. Insert Record (`nyrec`)

- Checks if the record already exists for the given firm and district code.
- If not found:
    - Populates record fields (`ragfir`, `ragkod`, `ragtxt`, `ragdat`, `ragtim`, `ragusr`) from parameters and system time.
    - Writes the new record.
    - Sets `p_stat` to '1' (success).

### 2. Update Record (`oppdrec`)

- Looks up the record by firm and district code.
- If found:
    - Updates the description, date, time, and user fields.
    - Updates the record.
    - Sets `p_stat` to '1' (success).

### 3. Delete Record (`sletrec`)

- Looks up the record by firm and district code.
- If found:
    - Deletes the record.
    - Sets `p_stat` to '1' (success).

### 4. Edit Numeric Fields (`red_num`)

- Placeholder for logic to replace blanks with zeros in numeric fields.
- Currently empty, but reserved for data cleansing if needed.

### 5. Edit Floating/Numeric Fields (`red_flt`)

- Converts `d_gkod` (district code from parameter) to numeric and stores in `w_gkod`.
- Ensures the district code is in the correct format for file operations.

### 6. Error Routine (`*pssr`)

- Sets `p_stat` to blank (failure).
- Ends the program immediately.

### 7. Initialization (`*inzsr`)

- Receives all input parameters.
- Sets up the key list (`ra07lu_key`) for record access (firm + district code).
- Captures the current date and time for audit fields.

---

## Key Lists

```rpg
c     ra07lu_key    klist
c                   kfld                    w_firm
c                   kfld                    ra07lu_gkod
```
- Used for keyed access (CHAIN) to the district code file.
- Ensures operations are always scoped to the correct firm and district code.

---

## Business/Domain-Specific Logic

- **District Code Management:** The program is dedicated to maintaining district codes, which are likely used for regional or organizational segmentation within the NAV context.
- **Audit Trail:** Updates to records include stamping with current date, time, and user, providing traceability.
- **Parameter Handling:** Uses a generic parameter buffer (`p_parm`), parsed into a data structure for flexibility and potential future expansion.
- **Status Feedback:** The output parameter `p_stat` is used by the caller to determine success or failure of the operation, following a simple convention (`'1'` for OK, blank for error).

---

## Design Patterns and Conventions

- **Subroutine-Driven:** All business logic is encapsulated in subroutines, keeping the mainline code clean and focused on flow control.
- **Keyed File Access:** Operations are always performed using keyed access to ensure data integrity and performance.
- **Error Handling:** Uses a PSSR routine for standard error handling, setting status and terminating gracefully.
- **Initialization:** All setup (parameter reception, key list definition, timestamping) is handled in the `*inzsr` subroutine.

---

## Integration and Dependencies

- **RA07LU File:** Central to all operations; must exist and be defined with the expected keys and fields (`ragfir`, `ragkod`, etc.).
- **External Callers:** Designed to be invoked by other programs or batch jobs, likely as part of a larger data integration process with NAV.
- **No External APIs:** All logic is self-contained; there are no external service or API calls.

---

## Noteworthy Points

- **Language/Comments:** Norwegian comments and field names reflect the business context. Familiarity with NAV and local terminology is helpful.
- **Extensibility:** The parameter structure and data cleansing subroutines suggest the code is designed for potential future enhancements.
- **No Debug I/O:** The H-spec disables debug I/O for performance and security.

---

## Summary Table

| Operation | Subroutine | Action                                  | Status on Success |
|-----------|------------|-----------------------------------------|-------------------|
| INSERT    | nyrec      | Add new district code                   | '1'               |
| UPDATE    | oppdrec    | Update existing district code           | '1'               |
| DELETE    | sletrec    | Remove district code                    | '1'               |
| ERROR     | *pssr      | Set status blank, terminate             | ' '               |

---

## Conclusion

This program provides robust, auditable management of district codes as part of NAV integration, following established RPG and business conventions. It is designed for maintainability, extensibility, and safe batch operation. Understanding the file structure, parameter conventions, and business context will be essential for effective onboarding and future enhancements.