# Explanation of RPG Program (SO510R): Invoice Display and History

This IBM ILE RPG program (SO510R) is a traditional, production-style application for the ASOFAK system. It is designed to **display invoice details**, **allow subfile navigation**, and provide access to related historical and archive functions. The code is written primarily in fixed-format RPG IV (ILE RPG) and interacts heavily with physical files (tables/databases) and display files.

Below is an explanation of the major sections and how the program works.

---

## 1. **Header, Documentation, and Change History**

- The `/TITLE` directive gives a title for the program: "Faktura, vise faktura" (Invoice, show invoice).
- The `H` spec sets program options, including `datedit(*dmy)` for date formatting.  
- The large comment block documents the change history by version, author, and description. This is typical for legacy RPG codebases.  
- There are explanations for **indicator usage** and **screen field purposes**.

---

## 2. **File Declarations (`F` Specs)**

These lines open database files and declare a display file:

### Database files  
- `sohel1`, `rkunl1`, `sodtl1`, `vpkol1`, `votyl1`, `fnufl1`, `fmftl1`, `fntrl1`
    - All are declared as input, externally described, keyed disk files.
    - Renaming is used to avoid name clashes and for clarity in subroutine usage.
- Each file generally represents a table—e.g., `sohel1` for invoice headers, `sodtl1` for invoice details, etc.

### Display file  
- `so510d` is declared as a display file with subfile support, using `sfile(b1sfl:w_srrn)` to specify the subfile record format and relative record number.

---

## 3. **Data Structures and Working Variables (`D` Specs)**

- Various data structures are defined for:
    - Display feedback (`dspfbk`)
    - Local data area
    - Overlayed fields for subfile line formatting (`d_text`, `d_vare`, `d_tek1`, etc.)
- **Parameters** and **working variables** for key data (`w_firm`, `w_aarr`, `w_kund`, etc.)
- Constants (`c_sfil` for subfile page size)
- Variables to track subfile positioning, current record, and screen navigation.

---

## 4. **Program Logic and Mainline**

### Initialization

- The control screen is initialized (`exsr control_init`).
- The subfile (list of invoice detail lines) is loaded (`setll`/`exsr crt_subfile`).

### Main Input/Output Loop

- Navigates between control screen (`b2taga`), subfile display (`b2tagb`), and handles function key processing.
- **Function keys supported:**
    - Exit (F3/F12)
    - Refresh (F5)
    - Rolling (paging: F10, etc.)
    - F15: Generate order from invoice history
    - F20: Print invoice copy

### Subfile Handling

- Subroutines handle:
    - Subfile read/refresh (`subfile`, `forny`)
    - Subfile clear (`clr_subfile`)
    - Subfile load (`crt_subfile`)
    - Subfile display (`dsp_subfile`)
- Special logic is included for showing related documents (order headers, archive, etc.) depending on user selection.

### Subroutines for Specific Functions

- **control_init** – Load and verify the invoice header, populate control (header) fields (customer info, seller, payment terms, etc.).
    - Includes logic to check for the invoice in previous or subsequent years if not found.
    - Checks if the displayed invoice is for the right customer.
    - Loads invoice type, seller info, and customer address.
- **forny** – Refresh/reload the subfile based on page/record position.
- **subfile, clr_subfile, crt_subfile, dsp_subfile** – Subfile navigation, clearing, loading, and displaying.
- **xh1win** – Display and confirm generation of an historical order from the invoice (F15), including lookup and validation of the order type.
- **spørring** – “Inquiry” subroutine, typically for lookup of fields.

---

## 5. **Key-Lists (`KLIST`)**

Key-lists are used to group parameters for file I/O operations:
- For invoice header, customer, invoice details, price code, order types, invoice logs, and card transactions.

---

## 6. **Entry Parameters and Initialization (`*inzsr`)**

- The program can be called with parameters: company (firm), accounting year (aarr), customer, and branch (binr).
- These are used to build the keys for file operations and navigation.

---

## 7. **Business Logic Highlights**

- **Multi-year Invoice Lookup:** If the invoice isn’t found for the nominated year, the program checks the year before (and optionally +2 years) to cover date mismatches.
- **Subfile Navigation:** Uses a combination of indicators and working variables to track subfile paging and current record position for roll/roll-down, home, and cursor positioning.
- **Rich Function Key Support:** Beyond paging and refresh, supports generating orders from historical invoices and accessing invoice archives (PDFs) if permitted.
- **Security/Archive Access:** Via the `AX700R` call, the program verifies if the user is allowed to view archives, then invokes the appropriate archive display program.

---

## 8. **Indicator Usage**

- Extensive use of indicators to control display, screen functions, and error/warning messaging.
    - E.g.:
        - `*in31`-`*in79`: Warnings/messages (e.g., invalid order type)
        - `*in10`, `*in11`: Roll/Roll-down
        - `*in14`, `*in15`: Subfile end/clear
        - `*in22`: Cursor positioning

---

## 9. **Other Details**

- Integration with display files for subfiles (DDS), which are not shown here.
- Adapts to business and GUI changes over time (evident from the history log).
- Uses both direct RPG fixed-format code and some modern built-in functions (like `%trim`, `%editc`, etc.).
- Mixture of “mainline” code and named subroutines.
- Some sections commented out (with `*`), reflecting evolving requirements or alternative layouts.

---

# **Summary Table of Main Entities and Their Roles**

| File/Data Structure | Purpose                                       |
|---------------------|-----------------------------------------------|
| `sohel1`            | Invoice header                                |
| `rkunl1`            | Customer master                               |
| `sodtl1`            | Invoice detail lines                          |
| `vpkol1`            | Price code descriptions                       |
| `votyl1`            | Order type register                           |
| `fnufl1/fmftl1/fntrl1` | Invoice type/card transaction/history       |
| `so510d`            | Main display file (contains subfiles)         |
| `b1sfl`             | Subfile for invoice detail lines              |
| `b2ctl`, `b2cmd`    | Control screens and function key screens      |

---

# **Typical User Interaction Flow**

1. **User invokes program with invoice parameters** (company, year, branch, customer).
2. **Program loads and displays the invoice header** and the first page of invoice detail lines in a subfile.
3. **User navigates** (page up/down, refresh, function keys).
4. **User can choose to view related docs, see order headers, print, or generate a new order** from the history.

---

# **Conclusion**

This program exemplifies a classic RPG subfile-based inquiry/maintenance application. It's robust, heavily indexed, and relies on established RPG idioms, including indicators, subfiles, external display files, and procedural subroutine structure. It also demonstrates careful handling of business rules, navigational logic, and dynamic display control for a mission-critical invoice/accounting system.