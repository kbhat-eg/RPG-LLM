# RPG ILE Source Code Explanation: RH965R

This RPG program (`RH965R`) is used for extracting journal transactions from the general ledger, customer ledger, and supplier ledger for further processing (such as re-journaling). The source is written in RPG/400 (fixed-form) and contains Norwegian comments and variable names.

Below is a breakdown of the main components and logic of the code:

---

## 1. **Header & Documentation**

- `h datedit(*dmy.) option(*nodebugio)`: Specifies date formatting and disables debug I/O.
- The comment block at the top documents:
  - System and program names
  - Description (in Norwegian): Main ledger – journal rerouting – selection
  - History of changes

---

## 2. **File Declarations**

```rpg
frhtrl1    if   e           k disk    rename(rhtrpfr:rhtrl1r)
frktrl1    if   e           k disk    rename(rktrpfr:rktrl1r)
frltrl1    if   e           k disk    rename(rltrpfr:rltrl1r)
frhwapf    o    e           k disk
```
- Input files:
  - `rhtrl1`: General ledger transactions
  - `rktrl1`: Customer ledger transactions
  - `rltrl1`: Supplier ledger transactions
- Output file:
  - `rhwapf`: Output work file for selected transactions

---

## 3. **Data Structures**

### Work Key Structure (`wksort`)
A Data Structure (DS) used for sorting/unique keying in the output file, with overlays for various fields:

```rpg
d wksort                  2     65
d  wkfirm                        3  0 overlay(wksort)                     
d  wkjour                        5  0 overlay(wksort:4)                   
d  wkbiln                        8  0 overlay(wksort:10)                  
d  wkbdat                         d   overlay(wksort:18)  datfmt(*iso)    
d  wkkont                        6  0 overlay(wksort:28)                  
d  wkspes                        4  0 overlay(wksort:34)                  
d  wkavde                        4  0 overlay(wksort:38)                  
d  wkrper                        2  0 overlay(wksort:42)                  
d  wktist                         t   overlay(wksort:44)                  
```
- This DS provides a single area (`wksort`) that overlays all the key fields, which are filled for each transaction processed.

### User Data Area (LDA) Parameter Mapping

```rpg
d                uds
d rhpkda                300    305  0
d rhprår                         4  0
d rhpper                         2  0
[...]
```
- Several variables are mapped to specific positions in the program's user data area (LDA), which stores selection parameters (e.g., year, journal numbers, firm).

### Local Work Variables

Variables for temporary usage, mostly holding field values from the files for copying and processing.

---

## 4. **Processing Logic**

The main logic is divided into three sections—one for each ledger.

### 4.1. General Ledger Transactions (`rhtrl1`)
- **Set Key:** Use `rhtrl1_key` klist based on firm and year
- **Read Loop:** Reads each record and processes if:
  - The journal number (`rbjour`) is within specified range (`rhpjof` - `rhpjot`)
  - Excludes auto-posted customer/supplier transactions (`rbbilk` = 94 or 95)
- **Data Preparation:** Clears `wksort`, fills in the structure fields from the file's fields, copies to output record, and writes to work file (`rhwapfr`).

```rpg
c     rhtrl1_key    setll     rhtrl1
c     rhtrl1_key    reade     rhtrl1
c                   dow       *in60 = *off
  -- check journal number range
  -- skip auto-poster entries
  -- prepare output structure
  -- write to output
c     lesh          tag
c     rhtrl1_key    reade     rhtrl1
c                   enddo
```

### 4.2. Customer Ledger Transactions (`rktrl1`)
- **Set Key:** Uses firm as key
- **Read Loop:** Reads each record and processes if:
  - The year (`rnraar`) matches the selection
  - The journal number (`rnjour`) is within specified range
- **Data Preparation:** Similar as above, fills in output fields, and writes to work file.

### 4.3. Supplier Ledger Transactions (`rltrl1`)
- **Set Key**: Uses firm as key
- **Read Loop:** Reads each record and processes if:
  - Year (`roraar`) matches selection
  - Journal number (`rojour`) is within specified range
- **Data Preparation:** Same as above.

---

## 5. **Subroutines and Key Lists**

### Initialization Subroutine (`*inzsr`)
- Sets up key lists for file access.
- Initializes working fields (`w_firm`, `w_raar`) from LDA parameters.

```rpg
c     *inzsr        begsr
c     rhtrl1_key    klist
c                   kfld                    w_firm
c                   kfld                    w_raar
[...]
c                   eval      w_firm = l_firm
c                   eval      w_raar = rhprår
c                   endsr
```

---

## 6. **End of Program**

```rpg
c                   eval      *inlr = *on
```
- Sets LR (Last Record) indicator to end the program and perform clean-up.

---

## 7. **Summary of Flow**

1. **Initialization:** Set up keys and selection parameters.
2. **Loop through each ledger (general, customer, supplier):**
   - For each record in the current ledger:
     - If the record matches selection criteria:
       - Prepare and clear a work structure (`wksort`), fill fields, and write to output file.
3. **Finish program.**

---

## 8. **Key Points / Business Rules**

- Only transactions within selected journal number and year ranges are processed.
- Certain automatically posted records (e.g., reskontro, `rbbilk` = 94/95) are skipped for the general ledger.
- The output file receives a standardized record for each selected transaction (the record layout is built using DS overlays).
- Norwegian field and comment names:
  - "Firma" = Company
  - "Journal" = Journal
  - "Bilag" = Voucher
  - "Kunde" = Customer
  - "Leverandør" = Supplier
- Utilizes overlays, data structures, and the LDA for parameter passing.

---

## 9. **For Onboarding/Developers**

- Understanding the field usage and how DS overlays are used is crucial for maintenance or extension.
- The program is transactional, processing ledger entries per selection, mapping input to a normalized output layout.
- Selection criteria are passed using the program's LDA; changes to selection logic may require LDA mapping updates.
- For enhancements, consider refactoring to /free RPG or modularize repetitive code.

---

If you have questions about specific fields/mappings or processing logic, you can dive deeper into those areas.