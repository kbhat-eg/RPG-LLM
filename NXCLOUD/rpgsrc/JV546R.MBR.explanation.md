## Overview

This RPG program (`JV546R`) is part of the ASPNIB system. Its primary function is to display a list of sub-suppliers (underleverandører) for a given supplier (leverandør) of an item (vare). The program is designed to be called with a company (firm) and supplier number as parameters, and then presents a subfile-based interface for browsing and interacting with these sub-suppliers.

The code is written in traditional (fixed-format) RPG IV, and makes heavy use of subfiles, indicators, and file access patterns common in legacy IBM i applications. The business logic and field names are in Norwegian.

---

## Main Business Logic

### Purpose

- **Display all sub-suppliers for a given supplier and item.**
- The user can browse, page through, and select sub-suppliers for further actions.
- The program supports paging (forward/backward), subfile refresh, and invokes another program (`JV547R`) for further details/actions on a selected sub-supplier.

---

## Key Files and Data Sources

- **VVARLA** (renamed `vvarlar`): Item file, likely mapping suppliers to items.
- **VVPRL1** (renamed `vvprl1r`): Item price file, used to find sub-suppliers for an item.
- **RLEVL1** (renamed `rlevl1r`): Supplier master file, used to fetch supplier names.
- **JLEVL1** (renamed `jlevl1r`): Main supplier file, used to fetch the main supplier’s name and number.
- **JV546d**: Display file with subfile (`b1sfl`) and control records (`b2ctl`, `b2cmd`).

---

## Program Flow

### Initialization (`*inzsr`)

- Receives parameters: company (`p_firm`) and supplier number (`p_ldor`).
- Sets up key lists for file access.
- Looks up the main supplier’s name and number in `JLEVL1`. If not found, displays "Ukjent hovedleverandør" (Unknown main supplier).
- Initializes the display and populates the subfile by calling `crt_subfile`.

### Main Loop

- The program alternates between displaying the subfile and handling user input.
- Function keys are mapped to actions:
  - **F3/F12**: Exit program.
  - **F5**: Refresh (rebuild) the subfile.
  - **Roll Up (F10)**: Next page.
  - **Roll Down (F11)**: Previous page.
  - **Home (F21)**: Cursor positioning.
- The subfile is processed for user actions (e.g., selecting a line for details).

---

## Subfile Handling

### Subfile Structure

- **Subfile page size**: Controlled by `c_sfil` (14 records per page).
- **Paging**: Managed via `w_srrn`, `w_sfrn`, `w_ssrn`, `w_spge`.
- **Subfile indicators**: `*in12`, `*in13`, `*in14`, `*in15` for display, control, clear, and end-of-file.

### Subfile Population (`crt_subfile`)

- If the main supplier number (`jlenum`) is zero, the routine exits.
- If a search is triggered (`b_sok`), an array (`a_ldor`) is built with all unique sub-supplier numbers for the item, excluding the main supplier.
  - **VVARLA** is read for all items matching the main supplier.
  - For each item, **VVPRL1** is read to find all sub-suppliers.
  - Sub-suppliers are deduplicated using `%lookup` on `a_ldor`.
- The subfile is filled with up to 14 sub-suppliers per page.
  - For each, the supplier name is fetched from **RLEVL1**. If not found, "Ukjent leverandør" is displayed.
- Paging variables are updated accordingly.

### Subfile Display (`dsp_subfile`)

- If the subfile is not empty, indicator 12 is set to enable subfile display.
- The control record (`b2ctl`) is displayed with `exfmt`.
- The current first record number (`w_fcrn`) is updated from the display feedback data structure.

### Subfile Clear (`clr_subfile`)

- Sets indicator 14 to clear the subfile and writes the control record.
- Resets all paging variables.

### Subfile Backward Paging (`bck_subfile`)

- Calls `forny` to refresh the subfile (effectively goes to the previous page).

---

## User Actions

- **Selecting a Sub-supplier (b1valg = 5):**
  - Calls program `JV547R` with the company, supplier number, and sub-supplier number as parameters for further processing.
  - Resets the selection indicator and updates the subfile record.

---

## Indicators

The program uses a well-documented indicator scheme:

- **LR**: End of program.
- **10/11**: Paging (Roll Up/Down).
- **12/13**: Subfile display and control.
- **14/15**: Subfile clear and end.
- **21/22**: Home key and cursor positioning.
- **30**: Field protection.
- **31-79**: Error/warning messages.
- **80-99**: Work indicators.

---

## Special Variables and Structures

- **a_ldor**: Array holding up to 99 unique sub-supplier numbers for the current context.
- **dspfbk**: Display feedback data structure, used to track the current cursor and record positions.
- **Paging variables**: `w_fcrn`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` manage subfile page navigation.
- **b_sok**: Flag indicating whether a search/refresh is in progress.

---

## Screen Layout

- **b1sfl**: Subfile record format for displaying sub-suppliers.
- **b2ctl**: Control record for subfile display.
- **b2cmd**: Command key screen.

---

## Program-to-Program Interaction

- **CALL 'JV547R'**: When a user selects a sub-supplier, the program calls `JV547R` for further processing, passing the relevant company and supplier information.

---

## Design Notes and Conventions

- **Indicator-driven UI**: The program relies on indicators for controlling UI state, a common pattern in legacy RPG.
- **Separation of Subfile Logic**: All subfile management (clear, create, display, page) is handled in dedicated subroutines.
- **Business terminology**: Norwegian field and variable names are used throughout; familiarity with terms like "leverandør" (supplier), "underleverandør" (sub-supplier), and "vare" (item) is essential.
- **Error handling**: If a supplier or sub-supplier cannot be found, the program displays "Ukjent leverandør/hovedleverandør" (Unknown supplier/main supplier).

---

## Summary

This program is a classic subfile-based RPG application for browsing and managing sub-suppliers of a given supplier in a specific business context. It demonstrates standard IBM i design patterns, including indicator-based UI control, subfile paging, and modular subroutine structure. The code is tightly coupled to its business domain, with Norwegian terminology and direct file access to core master and transaction files. 

When onboarding, focus on understanding the relationships between the files (especially how sub-suppliers are derived from item and price files), the indicator scheme, and the paging/subfile logic, as these are central to both the technical and business operation of this program.