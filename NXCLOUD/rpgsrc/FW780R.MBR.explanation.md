# RPGLE Program Explanation (`FW780R`)

This ILE RPG program handles the creation of product (item) records in an inventory/item master ("vareregister"), based on validated and quality-checked item data from a supplier. The program processes items from a supplier file and inserts them into the main item register if certain conditions are met. This is a "fast track" function to bulk create items via a "backdoor" process.

## 1. **Program Structure and Purpose**

- **Header/Comments:**  
  Contains program version, history, and description. The program is intended to automate the creation of new items from a supplier into the company's item master table, checking for required fields and avoiding duplicates.
- **Files:**  
  Multiple files (physical/logical) are declared for reading and writing data related to items, pricing, units, suppliers, warehouse, etc. Many files are renamed upon declaration to distinguish record formats.

## 2. **Key Data Structures**

- **Local Data Area:**  
  `l_wsid`, `l_user`: workspace/user IDs.
- **Parameters:**  
  `p_firm`, `p_ldor`: company and supplier codes passed to the program.
- **Working Variables:**  
  Item keys (`vvarl1_vare`, `vvarl5_lvar`, etc.), temporary storage for field values, status flags, timestamps, etc.
- **Flags:**  
  `b_dupp`: Flag to mark duplicate EAN numbers.

## 3. **Main Logic Overview**

### A. **Initialization and Main Flow**

- The program begins by calling the `behandling` (processing) subroutine.
- After processing, it sets the last record indicator (`*inlr = *on`) and returns.

### B. **Processing Subroutine (`behandling`)**

- **Loop through the supplier items (`flval3`) for the provided firm/supplier.**
  - **Verify minimum field requirements:**  
    - If essential fields (item number, group codes, description, unit, prices) are missing, the item is skipped.
  - **Check for duplicates:**  
    - Looks for existing items by primary and alternate item number in main item files.
    - If a match is found, the item is skipped.

- If the item passes all checks, calls the `oppdater` (update) subroutine to insert the item into the registry.

### C. **Insert/Update Logic (`oppdater`)**

- **Prepare and assign item number:**
  - Use supplier's item number, or call external program to get the next available item number (`VV700R`).
  - Abort if no valid item number is found.

- **Write item master (vareregister) record:**
  - Populate and clear all necessary fields, including description, group codes, unit, dimensions, and user/stamp fields.
  - Write the record.

- **Write item pricing record (for price/unit):**
  - Sets price, unit, and timestamps, then writes the record.

- **Write item unit record:**
  - Stores dimensions, weight, volume, etc.
  - If volume is missing but length, width, and height exist, it calculates volume.
  - Writes the record.

- **Handle EAN numbers:**
  - If EAN (barcode) is provided, check if it already exists (`sjekk_ean` subroutine).
  - If not a duplicate, update or add the EAN to the item unit/pricing file.

- **Cleanup EAN-register:**
  - If EAN exists in the old register, remove itâ€”should only be stored in the item unit.

- **If the item is a stock item (`vvvtyp='L'`):**
  - Check if location exists and is active, then call warehouse stock creation program (`LL760R`).

- **Cleanup deleted items register:**
  - Removes entry if this just-created item was previously deleted.

- **Call search text updating program (`VV750R`):**
  - For updating lookup/search functionality.

### D. **EAN Check Subroutine (`sjekk_ean`)**

- Checks if the EAN number already exists for another item/unit; sets duplicate flag.

### E. **Initialization Subroutine (`*inzsr`)**

- Handles parameter input.
- Defines keys for file access (to be used in `CHAIN`/`SETLL`/etc.).

## 4. **Key RPG/Business Concepts Used**

- **File-level Operations:**  
  Uses `SETLL`, `READE`, and keyed `CHAIN`/`WRITE`/`UPDATE`/`DELETE`.
- **Subroutines for logical breakup:**  
  `behandling` (main loop), `oppdater` (insert/update), `sjekk_ean` (EAN check), `*inzsr` (initialization).
- **Parameter Lists:**  
  For calling external RPG programs or passing in from CL, etc.
- **Conditional Logic:**  
  To verify required data, check for existence, skip/invoke business logic.
- **Record-Level Timestamps:**  
  Uses `TIME` to stamp writes, as well as user IDs.

## 5. **Business Rules Encoded**

- Items must meet certain minimum fields before being created.
- Items cannot be duplicated by item number or EAN/barcode.
- If a unit of measure is missing calculated volume, it is computed on-the-fly.
- EANs are carefully managed so they're not duplicated within the register.
- If an item is a "stock item," it's also created in the warehouse (inventory) file.
- If an item was previously deleted, that record is removed upon re-creation.

---

## 6. **Summary Table of Important Files & Functions:**

| File       | Purpose                               | Usage          |
|------------|---------------------------------------|----------------|
| FLVAPF/FLVAL3 | Supplier item input file               | Read (source)  |
| VVARPF/VVARL1| Item master                           | Check/Insert   |
| VVARPF/VVARL5| Alt item master                       | Check          |
| VVARPF/VVARLU| Item master update                    | Write          |
| VVPRPF/VVPRLU| Item price                            | Write          |
| VVENPF/VVENLU| Item unit                             | Write          |
| VVEPPF/VVEPLU| Item unit price (EAN mapping)         | Write/Update   |
| VEANPF/VEANLU| EAN register                          | Delete         |
| FSTSPF/FSTSL1| Warehouse location                    | Check          |
| VVASPFR/VVASLU| Deleted item register                | Delete         |
| AFIRPF/AFIRL1| Company master                        | Key structure  |
| External Programs | `VV700R`, `LL760R`, `VV750R`    | Get next item number, create warehouse stock, update search text |

---

# **Conclusion**

This program automates the creation of item, price, and unit records from supplier-provided data into the company's master item files, ensuring data quality, avoiding duplicates, and updating multiple related registers. It follows good RPG practices of breaking down logic into subroutines and using keyed file access for efficiency and data integrity.