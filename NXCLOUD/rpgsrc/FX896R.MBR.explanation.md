# RPG Source Code Explanation

This RPG (Report Program Generator) program is intended to update the invoice type (fakturatype) on a customer project file (kundeprosj.) based on information from the customer master file (kunde). It’s written in RPG IV (fixed-format), typical for IBM i (AS400) environments.

---

## Header Section

```rpg
h option(*nodebugio) datedit(*dmy)
```

- `option(*nodebugio)`: Runs the program without debug input/output overhead.
- `datedit(*dmy)`: Sets default date edit order to Day-Month-Year.

---

## File Declarations

```rpg
ffkprlu    uf   e           k disk    rename(fkprpfr:fkprlur)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
```

- `fkprlu`: User open, full procedural, keyed disk file. Represents the customer project file, *renamed* as `fkprlur`.
- `rkunl1`: Input, full procedural, keyed disk file. Represents the customer master file, *renamed* as `rkunl1r`.

---

## Work Fields

```rpg
d rkunl1_firm     s                   like(rkfirm)
d rkunl1_kund     s                   like(rkkund)
```

- These two variables (`rkunl1_firm`, `rkunl1_kund`) are defined with the same type and length as the corresponding fields in the customer master record format (`rkfirm`, `rkkund`).

---

## Main Program Logic

### Main Loop

```rpg
c                   read      fkprlur
c                   dow       not %eof
```

- Begin reading through all records in the customer project file (`fkprlur`).
- Continue processing until end-of-file.

### Retrieving the Relevant Customer Record

```rpg
c                   eval      rkunl1_firm = flfirm
c                   eval      rkunl1_kund = flkund
c     rkunl1_key    chain     rkunl1                             60
```

- Populate the search keys for the customer master file from the current customer project record.
- Use `chain` to attempt to retrieve the matching customer record (keyed by firm and customer).
- `rkunl1_key` is a KLIST (Key List) defined in the `*inzsr` subroutine.

### Conditional Update

```rpg
c                   if        %found(rkunl1) and
c                             rkfaty <> 0
c                   eval      flfaty = rkfaty
c                   update    fkprlur
c                   endif
```

- If the customer record was found **and** the customer's invoice type (`rkfaty`) is not zero:
  - Update the invoice type (`flfaty`) in the customer project record to match the customer's invoice type.
  - Write the update back to the customer project file.

### Read Next Record

```rpg
c                   read      fkprlur
c                   enddo
```

- Continue to the next record until the file is completely processed.

---

## Program Termination

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```

- Sets the LR (Last Record) flag to indicate program completion and releases record locks, closes files, and performs cleanup.
- Returns control to the operating system.

---

## Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
c     rkunl1_key    klist
c                   kfld                    rkunl1_firm
c                   kfld                    rkunl1_kund
c                   endsr
```

- Defines a key list (`rkunl1_key`) which includes the firm and customer fields. This is used for the keyed lookup (CHAIN) into the customer master file.

---

## In Summary

**The program loops through every record in the customer project file. For each, it looks up the corresponding customer record in the customer master file. If the customer is found and an invoice type is present, the program copies this type onto the project record and updates it. The process continues until all project records are examined, after which the program terminates.**

### Typical Use Case

This is a batch update program used to synchronize the invoice type on customer project records according to the current values on the corresponding customer master records.

---

### Notes

- Variables like `flfirm`, `flkund`, `flfaty` are assumed to be fields in the `fkprlur` record format (customer project file).
- Variables like `rkfaty` are fields in the `rkunl1r` record format (customer master file).
- The `KLIST` mechanism is a classic way in RPG to bundle keys for indexed file access.

---

This pattern is common for mass-updating related files based on master data changes. If you’re onboarding, familiarize yourself with the data structures and file layouts, as this is standard "data synchronization" logic in IBM i environments.