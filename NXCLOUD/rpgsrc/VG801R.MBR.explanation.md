# RPG Program Explanation: VG801R

## Overview

This RPG (Report Program Generator) III program, titled "Varegrupper â€“ leser inn unspc", is designed for the ASOFAK system. Its main function is to read data from an input file and update product groups ("varegrupper") with UNSPSC codes, utilizing the `VGUFRI` field.

It reads from an external file containing product data (`LWEXPF`), processes each record, and updates another file (`VUGRLF`, renamed as `VUGRLUR`) with relevant UNSPSC information.

---

## Key Sections and Data Definitions

### File Declarations

```rpg
flwexpf    if   e           k disk
fvugrlu    uf a e           k disk    rename(vugrpfr:vugrlur)
```
- **LWEXPF**: Input file, keyed, external.
- **VUGRLF (as VUGRLUR)**: Update file, keyed, allows updates/additions, record format renamed.

---

### Data Structures

#### UDS Local Data Area

```rpg
d                uds
d l_firm                944    946  0
d l_user                911    920
```
- **UDS**: References User Data Space (UDS), to pick up company (`l_firm`) and user (`l_user`) from positions in the UDS.

#### Group Code Data Structure

```rpg
d                 ds
d d_vgrp                         7
d  d_ogrp                        2  0 overlay(d_vgrp:1)
d  d_hgrp                        2  0 overlay(d_vgrp:3)
d  d_ugrp                        3  0 overlay(d_vgrp:5)
```
- **d_vgrp**: 7-character group code.
- **d_ogrp, d_hgrp, d_ugrp**: Overlaid fields extracting organizational, hierarchical, and subgroup codes from **d_vgrp**.

#### Key Variables (for VUGRLU)

```rpg
d vugrlu_uogr     s                   like(vguogr)
d vugrlu_uhgr     s                   like(vguhgr)
d vugrlu_uugr     s                   like(vguugr)
```
- Used to store portions of the group code needed for keyed operations on the VUGRLF file.

#### Working Variables

```rpg
d w_firm          s                   like(vgufir)
d w_ugrp          s              7
d w_ufri          s                   like(vgufri)
```
- **w_firm**: Holds the company number.
- **w_ugrp**: Working variable for group code.
- **w_ufri**: Working variable for UNSPSC code.

---

## Main Logic

### Reading and Processing Input File

```rpg
c                   read      lwexpf                                 90
c                   dow       *in90 = *off
  ...
c                   read      lwexpf                                 90
c                   enddo
```
- Reads the **LWEXPF** file record by record.
- Loop continues until end of file (`*IN90` on).

### Extracting and Validating Data

```rpg
c                   eval      w_ugrp = %subst(exclin:1:7)
c                   eval      w_ufri = %trim(%subst(exclin:38:8))
c                   if        %len(%trim(w_ugrp)) = 7      and
c                             w_ufri <> *blank
```
- Extracts group code (`w_ugrp`) from positions 1-7 of the input line (`exclin`).
- Extracts and trims UNSPSC code (`w_ufri`) from positions 38-45.
- Continues only if group code is fully populated and UNSPSC code is not blank.

### Preparing Keys and Updating Group Table

```rpg
c                   move      w_ugrp        d_vgrp
c                   eval      vugrlu_uogr = d_ogrp
c                   eval      vugrlu_uhgr = d_hgrp
c                   eval      vugrlu_uugr = d_ugrp
c     vugrlu_key    chain     vugrlu
c                   if        %found(vugrlu)
c                   eval      vgufri = w_ufri
c                   time                    vgueda
c                   time                    vgueti
c                   eval      vgueus = l_user
c                   update    vugrlur
c                   endif
```
- Moves extracted group code in **d_vgrp**.
- Splits it into organizational, hierarchical, and subgroup keys for the VUGRLF table.
- Uses **CHAIN** to find the entry in VUGRLF.
- If found:
    - Updates the **UNSPSC** code (`vgufri`).
    - Sets current date/time fields (`vgueda`, `vgueti`).
    - Updates "last user" (`vgueus`).
    - Saves the changes via **UPDATE**.

---

## Program End

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
```
- Marks the logical end of the program and ends it, returning resources.

---

## Initialization Subroutine (*INZSR)

```rpg
c     *inzsr        begsr
  ...
c                   endsr
```
- Builds a key list for **VUGRLU** access.
- Assigns company from UDS (`l_firm`) to the working key (`w_firm`).

---

## Summary

**In essence:**  
The program reads a list of items, extracts group codes and UNSPSC codes, finds corresponding records in the product-group master file, and updates UNSPSC codes, tracking date/time and user for each update.

- Reads from input file (`lwexpf`)
- Extracts group and UNSPSC codes
- Finds matching entry in group table (`vugrlu`)
- If found, updates UNSPSC code, timestamp, and user info

## Additional Notes

- The code uses "fixed format" RPG IV (ILE RPG) syntax.
- Norwegian comments and field names reflect the domain/context.
- The operation is batch-style: process all, then end.

This is a classic data update/migration utility for IBM i DB2 files.