# RPG Program Explanation: RE140R – Visma Integration

This RPG program, **RE140R**, is designed as an integration between a Visma payroll system and another system (ASOKON). It imports payroll transactions from a Visma-exported file, processes them, and writes output records to another file.

## 1. Header Section

```rpg
h/TITLE    Program : RE140R   ASOKON     Visma integrasjon
h decedit(',') datedit(*dmy.)
```
- **h/TITLE:** Specifies the program title.
- **decedit(','):** Sets the decimal editing character to comma.
- **dateedit(*dmy.):** Sets date editing to day-month-year order.

## 2. File Declarations

```rpg
freinpf    if   e           k disk
freutpf    o  a e           k disk
```
- **reinpf:** Input file (likely the Visma-exported file).
- **reutpf:** Output file (to ASOKON).  
  - `i` = input, `o` = output, `f` = full procedural, `a` = add (write), `e` = externally described, `k` = keyed, `disk` = on disk.

## 3. Data Definitions

### Stand-alone Variables (Top)

```rpg
d p_flgr          s              3
d p_firmx         s              3
d w_firm          s              3  0
```
- **p_flgr, p_firmx:** Program parameters.
- **w_firm:** Local work variable.

### Data Structure: Input Record Layout

```rpg
d                 ds
d d_inpu                       130
d  d_kont                        6    overlay(d_inpu:3)
d   d_kontn                      6  0 overlay(d_kont:1)
... etc.
```
- **d_inpu:** Complete input record from Visma (130 chars).
- **d_kont, d_avde, d_pros, d_dato, d_bdat, d_ants, d_sign, d_bel:** Various fields extracted from the input with overlays (subfields mapped to positions within the record).
- **Overlays:** RPG overlays allow these fields to reference specific positions/lengths within the input buffer.

### Data Structure: Bilagsdato (Voucher Date)

```rpg
d                 ds
dw_bdat                   1      8  0
dtbaar                    1      4  0
dtbmnd                    5      6  0
dtbdag                    7      8  0
```
- Used for date manipulation, breaking down and assembling date parts.

## 4. Main Logic

### Main Loop

```rpg
c                   read      reinpf
c                   dow       not %eof
    ...
c                   read      reinpf
c                   enddo
```
- Reads each record from the input file (**reinpf**).
- For each record, processes it by:
    - Assigning the input buffer (`d_inpu = reinrec`)
    - Calling the subroutine `oppr_lpos` to process and map fields.
    - Continues until end of file.

### Program Exit

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Standard RPG program termination; sets the *LR (last record indicator) to *ON and returns.

## 5. Subroutines

### `oppr_lpos`: Process Payroll Posting

This is the main processing subroutine.

```rpg
c     oppr_lpos     begsr
c                   clear                   reutpfr
c                   eval      d_avde = %xlate(' ':'0':d_avde)
c                   eval      d_pros = %xlate(' ':'0':d_pros)
```
- **clear reutpfr:** Clears the output record buffer before populating.
- **%xlate:** Replaces spaces with zeroes in department (`d_avde`) and project (`d_pros`) codes.

```rpg
c                   eval      reflgr = p_flgr
c                   eval      refirm = w_firm
c                   eval      rekont = d_kontn
c                   eval      remvak = '0'
c                   eval      reavde = d_avden
c                   eval      repros = d_pros
c                   eval      remngd = 0
c                   eval      rerper = d_per
c                   eval      reraar = d_aar
c                   eval      tbaar  = d_baar
c                   eval      tbmnd  = d_bmnd
c                   eval      tbdag  = d_bdag
c                   move      w_bdat        rebdat
```
- Maps the processed/converted fields to the output record fields.
- **remngd = 0**: The quantity is specifically set to zero as a business correction (see comment).

#### Sign Handling

```rpg
c                   if        d_sign = '-'
c                   z-sub     d_bel         rebel�
c                   else
c                   eval      rebel� = d_bel
c                   endif
```
- If the sign field is '-', negates the amount.

#### Write Output Record

```rpg
c                   write     reutpfr
c                   endsr
```
- Writes the assembled output record.

### `*inzsr`: Initialization Subroutine

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_flgr
c                   parm                    p_firmx
c                   move      p_firmx       w_firm
c                   endsr
```
- Handles initial parameters passed to the program (`p_flgr`, `p_firmx`), and initializes the local `w_firm` variable.

---

## 6. Special Notes and Comments

- **Date Handling:** Various overlays and moves handle the breakdown of dates from the input.
- **Commented-Out Code:** Indicates prior or potential logic, especially around fields like `d_akt` and `d_spes`.
- **Version Comments:** At the top, change logs and descriptions document historic changes.

---

## 7. Summary

**RE140R** is a classic ILE RPG program to:
- Ingest Visma payroll exports,
- Parse/convert the records and fields,
- Apply business logic (e.g., hardcoded zero values, sign conversion),
- Write a normalized output record for downstream use.

Care should be taken to understand the field positions in the input file and ensure any changes in Visma exports are matched in overlays. The processing logic is straightforward, mapping and possible transformation, but pay attention to hardcoded overrides or corrections per business rules.