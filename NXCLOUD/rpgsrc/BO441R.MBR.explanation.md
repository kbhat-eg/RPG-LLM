# RPG Source Code Explanation

## General Overview

This RPG program is named `BO441R`, part of the `ASSHOP` system, and is designed to remove records from a historical "bong register" (probably an invoice or transaction log), including both header and line-level entries.

The application processes records from a source file, and if the record's date is older than a given parameter, it deletes both the header and associated lines from their respective historical tables.

---

## File Definitions

```rpg
fboheld    if   e           k disk    rename(bohepfr:boheldr)
fbohelu    uf   e           k disk    rename(bohepfr:bohelur)
fbodtlu    uf   e           k disk    rename(bodtpfr:bodtlur)
```
- **boheld**: Input file for reading headers (possibly from a historical/purge file).
- **bohelu**: Update file for header records to be deleted.
- **bodtlu**: Update file for line items to be deleted.

Each uses a renamed record format for clarity/separation (`boheldr`, `bohelur`, `bodtlur`).

---

## Data Definitions

### Program Parameters

```rpg
d p_afir          s              3
d p_dato          s               d   datfmt(*iso)
```
- `p_afir`: Company/firm identifier (3 characters).
- `p_dato`: Cutoff date for deletion (ISO date).

### Key Variables

```rpg
d bohelu_aarr     s                   like(boaarr)
d bohelu_wsid     s                   like(bowsid)
d bohelu_numm     s                   like(bobong)
d bodtlu_aarr     s                   like(bdaarr)
d bodtlu_wsid     s                   like(bdwsid)
d bodtlu_numm     s                   like(bdbong)
```
These hold key fields for headers (`bohelu_*`) and lines (`bodtlu_*`), using the same type as the underlying database fields.

### General Variables

```rpg
d w_firm          s                   like(bofirm)
d w_date          s                   like(bodate)
```
Working/fetch fields for company and date.

---

## Main Program Logic

### Entry Point

```rpg
c     boheld_key    setll     boheld
c                   read      boheld                                 60
```
- **Position** at the first matching record (using key list) in `boheld`.
- **Read** the first header record.

---

### Main Deletion Loop

```rpg
c                   dow       *in60 = *off
c                             and bodate < p_dato

c                   exsr      oppdat     Backup/slett

c                   read      boheld                                 60
c                   enddo
```

- **Loop** while not EOF (`*in60 = *off`) and the record date is before the cutoff.
- **Call subroutine** `oppdat` to handle backup/delete.
- **Read** the next record.

---

### Program End/Return

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Marks the end of the program, sets LR (last record) to end.

---

## Subroutines

### `oppdat` (Delete Header and Lines)

```rpg
c     oppdat        begsr

c                   eval      bohelu_aarr = boaarr
c                   eval      bohelu_wsid = bowsid
c                   eval      bohelu_numm = bobong

c                   eval      bodtlu_aarr = boaarr
c                   eval      bodtlu_wsid = bowsid
c                   eval      bodtlu_numm = bobong
```
- **Assigns keys** from the current header to working variables.

#### Delete the Header

```rpg
c     bohelu_key    chain     bohelu                             61
c                   if        *in61 = *off
c                   delete    bohelur   Slette hode
```
- **Finds** the matching header in `bohelu`.
- **Deletes** the header if found.

#### Delete the Lines

```rpg
c     bodtlu_key    setll     bodtlu
c     bodtlu_key    reade     bodtlu                                 61
c                   dow       *in61 = *off
c                   delete    bodtlur   Slette linje
c     bodtlu_key    reade     bodtlu                                 61
c                   enddo
```
- **Positions** to the first matching line item(s) (by key).
- **Loop** through and delete every detail line for this bong/invoice.

---

### Initialization (`*inzsr`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_afir
c                   parm                    p_dato
...
c                   move      p_afir        w_firm
c                   endsr
```
- **Receives parameters** on entry (company and date).
- **Initializes key lists** for record access.
- **Moves** the parameter firm into the working variable.

--- 

## Key Lists (`klist`)

- `boheld_key`: For reading header records.
- `bohelu_key`: For deleting a specific header.
- `bodtlu_key`: For deleting associated lines.

Each is constructed from company, year, workstation ID, and invoice/bong number.

---

## Summary

1. The program **accepts a company ID and a cutoff date**.
2. It **reads header records** for that company, **older than the cutoff date**.
3. For each, it:
   - **Deletes** the header from the historical header file.
   - **Deletes all related lines** for that header from the line file.
4. **Repeats** until no more qualifying headers are found.

---

## Key Points

- Strong use of **keyed database access**.
- All deletions are by **compound key** (firm, year, WSID, invoice number).
- Parameter-driven, suitable for regular purging or archival routines.

---

## Comments on Maintainability

- The code is written in **legacy RPG/400 style**; modernization could improve readability.
- Uses fixed-format, but variable names are reasonably descriptive.
- Subroutine structure is clear, with explicit parameter and key management.

---

## Potential Enhancements

- Logging of what was deleted.
- Error handling for database operations.
- Migration to /free-form RPG for more modern readability.

---

If you have specific questions about any part of the code, feel free to ask for more detail!