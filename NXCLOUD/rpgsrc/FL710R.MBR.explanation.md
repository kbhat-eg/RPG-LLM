# RPG Source Code Explanation: `ASOFAK / FL710R`
This explanation covers the RPG/400 program described in your source, used to determine a customer’s discount category ("rabattkategori") by checking customer and/or customer-project data.

---

## High-Level Purpose

**Program:** FL710R (System: ASOFAK)  
**Description:**  
Fetches the discount category for a customer, possibly overridden by a customer-project.  
The logic checks, in order:

1. If a customer number (`p_kund`) is provided, it looks up the customer’s discount category.
2. If a project number (`p_kpro`) is provided, it checks for overrides in the customer-project table.

---

## File Declarations

```rpgle
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
```
- `rkunl1`: Customer file, keyed, renamed record format.
- `fkprl1`: Customer-project file, keyed, renamed record format.

---

## Parameter and Variable Definitions

```rpgle
d p_firm          s                   like(flfirm)
d p_kund          s                   like(flkund)
d p_kpro          s                   like(flkpro)
d p_rkat          s                   like(florka)
```
- `p_firm`: Company code (input; from caller).
- `p_kund`: Customer number (input).
- `p_kpro`: Project number (input).
- `p_rkat`: Discount category (output; set by this program).

Other variables mirror field types from file layouts for keys and intermediate logic.

---

## Initialization / *INZSR Subroutine

**Purpose:** Initialize variables, receive parameters, and set up key-lists.

```rpgle
c     *inzsr        begsr
```
- **Parameter List:** Receives input/output variables via `*entry plist`.
- **Key-lists:** Build composite keys for customer and customer-project files using company, customer, and (for project) project number.
- **Initialize:** 
    - Load company code into working variable.
    - Set output (`p_rkat`) to zero as default.

---

## Main Logic (Hovedprogram)

### 1. Lookup Discount Category from Customer

```rpgle
c                   if        p_kund <> 0
c                   eval      rkunl1_kund = p_kund
c     rkunl1_key    chain     rkunl1                             90
c                   if        *in90 = *off
c                   eval      p_rkat = rkrabk
c                   endif
c                   endif
```
- **If customer number is provided:**  
    - Set up key and try to read the customer (`chain`).
    - If found (`*in90 = *off`), set the output discount category to the customer’s discount code `rkrabk`.

---

### 2. Override with Customer-Project Data

```rpgle
c                   if        p_kpro <> 0
c                   eval      fkprl1_kund = p_kund
c                   eval      fkprl1_kpro = p_kpro
c     fkprl1_key    chain     fkprl1                             90
c                   if        *in90 = *off
...
c                   endif
c                   endif
```
- **If project number is provided:**  
    - Set up keys and look for matching record in customer-project file.
    - If found:
        - **Override 1:** If `florka` (project-specific discount) is set, use it.
        - **Override 2:** If `flokun` (overridden customer number) is set, lookup that customer’s discount code and use it.

---

### 3. Program End

```rpgle
c                   eval      *inlr = *on
c                   return
```
- Set last record indicator (`*inlr`) to end program and release resources.

---

## Important Variables

- `*in90`, `*in91`: Standard indicators for unsuccessful (`*on`) or successful (`*off`) keyed file lookups.
- `rkrabk`, `florka`, `flokun`: Fields from customer or customer-project files with discount categories or overridden customer info.

---

## Summary Table of Logic

| Condition(s)                               | Discount Category Set To |
|--------------------------------------------|-------------------------|
| Customer found, no project                 | Customer’s rkrabk       |
| Project found, florka set                  | Project’s florka        |
| Project found, flokun set and customer found | flokun customer's rkrabk|
| Neither found                              | 0 (default)             |

---

## Onboarding Tips

- Understand the structure of `rkunl1` (Customer) and `fkprl1` (Customer-Project) files.
- `CHAIN` operations retrieve records via composite keys built from company, customer, and project numbers.
- Discount category can come from three sources: customer, project, or customer defined by an override on the project.
- Output parameter `p_rkat` is always set, defaulting to 0 if nothing is found.
- The program operates as a "lookup utility" for discount codes, managing business rules for customer-project overrides.

---

## Norwegian Terms

- **Kunde**: Customer
- **Prosjekt**: Project
- **Rabattkategori**: Discount category
- **Overstyring**: Override

---

This program is a classic RPG/400 utility for resolving business rules around discount setup using IBM i (AS/400) files, with clear logic for handling overrides via customer and project data.