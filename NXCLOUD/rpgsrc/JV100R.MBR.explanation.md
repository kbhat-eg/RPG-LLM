# Documentation: RPG Program JV100R – Product Maintenance

## Overview

**Program:** JV100R  
**System:** ASVADM  
**Purpose:**  
This program serves as the main entry point for product (item) maintenance in the application. It provides a subfile-based user interface for searching, viewing, creating, editing, copying, and deleting product records. It replaces the previous program C2BLD, and calls JV101R for product creation and editing.

**Business Domain:**  
The program is part of a product master data management suite, supporting advanced search, group navigation, and integration with related modules (pricing, packaging, attributes, etc.).

---

## Key Functional Areas

### 1. Subfile Management

- **Subfile screens** (B1SFL, B2CTL, B2CMD) are used to display product lists, support paging, and process user commands.
- **Subfile navigation** includes roll-up, roll-down, and direct positioning based on various product keys (number, text, NOBB, supplier item number, etc.).
- **Subfile actions**: Each row allows actions such as edit, copy, delete, view, and access to related functions (prices, packaging, attributes, etc.).

### 2. Search and Positioning

- Advanced search via:
  - **Product group hierarchy** (overgroup, main group, subgroup).
  - **Search text** (via AS702R).
  - **Free text** (via AS701R).
- **Positioning**: Direct navigation to a product by number, NOBB number, supplier item number, or product text.

### 3. Product Maintenance

- **Create/Edit**: Calls JV101R for product maintenance.
- **Copy**: Allows copying an existing product.
- **Delete**: Calls JV400R for deletion, with confirmation window.
- **View**: Calls JV510R for viewing product details.

### 4. Integration with Related Modules

- **Price maintenance:** JX100R
- **Packaging:** JW505R
- **Search text maintenance:** JS100R
- **Terms/conditions:** JP500R
- **Product information:** JU510R
- **Campaign prices:** JM510R
- **Alternative item numbers, charges, NRF:** JV113R, JV114R, JV115R
- **Upselling/cross-selling (BM module):** JV116R
- **Free text, composition, supplier info, attributes:** JV512R, JV117R, JV118R, JV190R
- **Group lookup popups:** VG510R, VG511R, VG512R
- **NOBB info:** AP633R

### 5. Business Logic Highlights

- **Deleted/Discontinued items**: Product text is annotated with "** SLETTET **" (deleted) or "** UTGÅTT **" (discontinued) based on status and JVLEPF records.
- **Logistics item check**: Uses JVKLPR to determine if the product is a logistics item or has a logistics parent, setting indicators for UI display.
- **BM Module**: Conditional features (e.g., upselling) enabled if the BM module is present.

---

## Data Model and Files

### Physical Files

- **jvarpf**: Main product master file.
- **jvsost/jsokpf/jvsost**: Search text and free text indexes.
- **jlevpf**: Supplier master.
- **jvlepf**: Product-supplier (discontinuation info).
- **amodpf**: Module presence (BM module).
- **jvklpf**: Logistics item relations.

### File Usage

- Multiple logical files over **jvarpf** for group and key-based access (overgroup, main group, subgroup, product number, NOBB, etc.).
- **Sfile** (B1SFL) for subfile display; **workstn** for screen handling.

---

## Indicators and UI Conventions

- **LR**: End of program.
- **10/11**: Rollup/Rolldown.
- **12/13/14/15**: Subfile display, control, clear, end.
- **21/22**: Home key, cursor positioning.
- **30**: Protect fields for view mode.
- **31–79**: Error/warning indicators.
- **80–99**: Working indicators (flags, state).

---

## Subroutine Structure

The program is heavily structured around subroutines for modularity:

- **forny**: Refresh subfile based on current search/positioning.
- **søk**: Perform search and fill subfile accordingly.
- **posisjoner**: Position subfile to a specific item.
- **subfile**: Process user actions on subfile rows.
- **xc1bld/xc1msg/xc2bld**: Screens and logic for creation, error messaging, and maintenance.
- **xd1win/xk1win**: Delete/copy confirmation windows.
- **clr_subfile/crt_subfile**: Clear and fill subfile.
- **bck_subfile**: Page back in subfile.
- **dsp_subfile**: Display subfile and handle UI feedback.
- **spørring**: Handle group lookup popups.
- **vis_nobb/finn_logivar/xb13win**: Specialized subroutines for NOBB info, logistics item check, and info windows.
- **Initialization**: *inzsr sets up keys, module flags, loads initial data.

---

## SQL Usage

- **Embedded SQL** is used extensively for advanced search and join operations, especially for text-based and group-based searches.
- **Cursors** are declared and opened dynamically based on search context (`w_seqe`).
- **Special handling** for OS/400 version differences, and for correct language collation and date formats.

---

## Design and Domain-Specific Patterns

- **Subfile-driven UI**: Central to user experience, with paging and in-place actions.
- **Dynamic search context**: The `w_seqe` variable determines the search mode and which logical file or SQL cursor to use.
- **Modular integration**: The program acts as a hub, delegating domain-specific logic to specialized programs (called via `CALL`/`PARM`).
- **Soft deletion/discontinuation**: Instead of removing records, status fields and text annotations are used.
- **BM Module detection**: Dynamically enables features if present.
- **Indicator-driven UI logic**: Extensive use of indicators for UI state, error handling, and feature toggling.
- **Comprehensive group navigation**: Supports navigation and search at multiple levels of product grouping.

---

## Notable Non-Obvious Aspects

- **Search and Positioning Logic**: The program differentiates between various search modes (group, text, free text, direct key) and adapts both database access and UI feedback accordingly.
- **Subfile Refill Triggers**: Many actions (search, page, edit, etc.) result in the subfile being cleared and refilled, ensuring UI is always in sync with current context.
- **Soft Deletion/Discontinuation**: Instead of removing records, the UI displays status based on product and supplier discontinuation logic (including future-dated discontinuations).
- **Logistics Item Handling**: Uses SQL to check for logistics parent/child relationships and sets UI flags for special display.
- **Extensive Use of External Programs**: The program is a coordinator, with actual maintenance and lookup logic implemented in other modules.
- **Versioned Enhancements**: The code is annotated with version numbers and change logs, indicating incremental business-driven enhancements (e.g., new search options, GUI adaptations, new groupings).

---

## External Program Interactions

- **JV101R**: Product creation/editing.
- **JV400R**: Product deletion (with cascading relations).
- **JX100R, JW505R, JS100R, JP500R, JU510R, JM510R, JV113R, JV114R, JV115R, JV116R, JV117R, JV118R, JV190R**: Various product-related maintenance and query programs.
- **VG510R, VG511R, VG512R**: Group lookup popups.
- **AS701R, AS702R**: Full-text and search text lookup.
- **AP633R**: NOBB information.
- **BM Module Detection**: AMODPF file.

---

## Summary of User Flow

1. **Startup**: Loads initial data, sets up keys, detects BM module.
2. **User sees subfile with product list**.
3. **User can search, position, or select actions**:
   - Search by group/text.
   - Position by product number/NOBB/etc.
   - Select action (edit, copy, delete, etc.) on a row.
4. **Actions may open popups, call other programs, or update the subfile**.
5. **Subfile is refreshed as needed to reflect current state**.
6. **Program ends on user request (LR indicator)**.

---

## Conventions and Patterns

- **All field names and indicators follow company/domain naming standards** (e.g., `jv` prefix for product, `b1` for subfile row, etc.).
- **Subroutines are used for all logical operations**, aiding maintainability and clarity.
- **Change history is maintained in the source for traceability**.

---

## For New Developers

- **Understand the subfile model and indicator-driven UI logic**; these are central to user interaction.
- **Familiarize yourself with the external programs**; many business rules and edits are delegated.
- **Be aware of the business rules for product groupings, status, and logistics**; these are enforced at multiple points.
- **When modifying or extending, follow the established subroutine and change-log conventions**.

---

## References

- **Physical/logical file definitions**: See DDS for `jvarpf`, `jvsost`, `jsokpf`, etc.
- **External programs**: Refer to their respective source for detailed business logic.
- **Indicator usage**: See code comments for indicator assignments.

---

**If you need further clarification on specific subroutines, external program interfaces, or business rules, please refer to the relevant section above or contact the system architect.**