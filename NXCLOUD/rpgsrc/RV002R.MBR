     h option(*nodebugio) datedit(*dmy)
     h decedit('0.')
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : RV002R
      * Beskrivelse . . : Leser linjer fra BOVF til kommaseparert til
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * ----- ------ ---- -------------------------------------------------
      *       100209 nho  Visma  / Global
6.21  * V6.20 030912 bof  Sjekker om det er kort kid + litt rydding
6.22  * V6.20 050814 nho  Må sjekke om navnefeltet inneholder ','
6.23  *       141014 nho  Test på firma
6.24  *       171214 nho  Blanker felt RKMKOD
6.25  * V6.20 280515 nho  Alfafelt var for lagnt for å sjekke ','
6.30  * V6.30 040517 nho  Endring vedr. mvakode
7.00  * V7.00 260419 nho  Henter inn konvertering av bilagskode
6.nu  * R6.20     280515  Utvidelse av kort kid                          NHO  *
7.03  *       120521 mst  Henter avvikende momskode, hvis den finnes
8.00  *  8.00 211221 sst  Henter ev. motpost fra BODTPF
8.01  *  8.00 010422 sst  Justering av 8.00
8.02  *  8.00 030522 sst  Oppslag mot rhtr for å finne ut om referanse skal med
8.03  *  8.00 200522 mst  Summering pr. bilag
8.04  *  8.00 200522 mst  Summering pr. konto
8.05  *  UTGÅR! .00 310822 mst  Viser til 8.00, dette blir feil ved omkjøring
7.04  * 7.00  281022 mst  Sjekker også firma=000 vedr. bilagskode
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.04 f*bovfl2    if   e           k disk
8.04 fbovfl3    if   e           k disk
     fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
8.02 frktrl8    if   e           k disk    rename(rktrpfr:rktrl8r)
6.21 fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
6.21 faforl1    if   e           k disk    rename(aforpfr:aforl1r)
7.00 frb10l1    if   e           k disk    rename(rb10pfr:rb10l1r)
7.03 frb00l1    if   e           k disk    rename(rb00pfr:rb00l1r)
      *
      *
     frv02pf    o    e           k disk
      *
      * Definering av Local data area
      *
     d                uds
     d l_firm                944    946  0
6.11  *
6.11 d w_pste          s             30
7.00 d xxbilk          s              5  0
8.00 d w_motp8         s              8  0
      *
     d w_dato_alf      s              6
     d w_dato_al1      s              6
     d w_dato_al2      s              6
      * Datastruktur for forfallsdato
     d                 ds
     d d_fdat                  1      6  0
     d  d_fa1                  1      1  0
     d  d_fag                  1      2  0
     d  d_fnd                  3      4  0
     d  d_far                  5      6  0
      *
     d                 ds
     d d_fdati                 1     10
     d  d_fa                   1      4
     d  d_f1                   5      5
     d  d_fn                   6      7
     d  d_f2                   8      8
     d  d_fd                   9     10
     d*
      *
      * Datastruktur for bilagsdato
     d                 ds
     d d_date                  1      6  0
     d  d_da1                  1      1  0
     d  d_dag                  1      2  0
     d  d_mnd                  3      4  0
     d  d_aar                  5      6  0
      *
     d                 ds
     d d_dati                  1     10
     d  d_aa                   1      4
     d  d_a1                   5      5
     d  d_mn                   6      7
     d  d_a2                   8      8
     d  d_dd                   9     10
      *
6.11  * Datastruktur for postted
6.11 d                 ds
6.11 d d_pste                  1     30
6.11 d  d_ps1                  6     30
      *
6.21  * Variabler for nøkler
6.21  *
6.21 d votyl1_otyp     s                   like(vaotyp)
6.21 d aforl1_ruti     s                   like(afruti)
7.00 d rb10l1_gkod     s                   like(raakod)
     d rkunl1_kund     s                   like(rkkund)
8.03 d rktrl8_kund     s                   like(rnkund)
8.03 d rktrl8_biln     s                   like(rnbiln)
      *
6.12 d w_kund          s                   like(rkkund)
6.12 d w_navn          s                   like(rknavn)
6.12 d w_gate          s                   like(rkgate)
6.12 d w_adr2          s                   like(rkadr2)
6.12 d w_tlfn          s                   like(rktlfn)
6.12 d w_tlfx          s                   like(rktlfx)
6.12 d w_alfa          s                   like(rkalfa)
6.12 d w_bgir          s                   like(rkbgir)
6.12  *
6.12 d w_firm          s                   like(bffirm)
     d w_aarr          s                   like(soaarr)
     d w_binr          s                   like(sobinr)
     d w_avde          s                   like(bfdavd)
6.30 d w_mkod          s                   like(bfdmom)
7.03 d w_mkodn         s              2
     d w_fnutt         s              1    inz('"')
     d w_ponr          s              4
     d w_grns          s             11  2
     d*
6.22 d wkalfa          s                   like(rkalfa)
6.22 d w2navn          s                   like(rknavn)
6.22 d w2fnav          s                   like(rknavn)
6.22 d wknavu          s                   like(rknavn)
6.22 d w_posm          s              2  0
6.22 d*w_lnavn         s                   like(rknavn)
6.22 d w_lnav          s                   like(rknavn)
     d w_ladr1         s                   like(rkgate)
     d w_ladr2         s                   like(rkadr2)
     d w_lposn         s              4
     d w_lposs         s                   like(rksted)
6.nu d*w_kidr          s              6  0
6.nu d w_kidr          s              8  0
6.21 d w_kidd          s                   like(sokidd)
6.21 d w_kid2          s                   like(sokidd)
      *
6.21 d b_kkid          s              1    inz(*off)
7.03 d rb00l1_gkod     s                   like(r00kod)
7.03 d w_type          s             10
      *
8.03  * Tar vare på verdier til brudd
8.03 d x_bfperi        s                   like(bfperi)
8.03 d x_bfbunt        s                   like(bfbunt)
8.03 d x_bfbiln        s                   like(bfbiln)
8.03 d x_bfbdat        s                   like(bfbdat)
8.03 d x_bffdat        s                   like(bffdat)
8.03 d x_bfbilk        s                   like(bfbilk)
8.03 d x_bftext        s                   like(bftext)
8.03 d x_bfdavd        s                   like(bfdavd)
8.03 d x_bfdkto        s                   like(bfdkto)
8.03 d x_bfdsps        s                   like(bfdsps)
8.03 d x_bfdmom        s                   like(bfdmom)
8.03 d x_bfbelp        s                   like(bfbelp)
8.03 d x_bfmvag        s                   like(bfmvag)
8.03 d x_bfcavd        s                   like(bfcavd)
8.03 d x_bfckto        s                   like(bfckto)
8.03 d x_bfcsps        s                   like(bfcsps)
8.03 d x_bfcmom        s                   like(bfcmom)
8.03 d x_bfproj        s                   like(bfproj)
8.03 d x_bfakti        s                   like(bfakti)
8.03 d x_bfmngd        s                   like(bfmngd)
8.03 d x_bfkund        s                   like(bfkund)
8.03 d x_bfkref        s                   like(bfkref)
8.03 d w_forste        s              1
8.03 d w_ferdig        s              1
8.03 d w_sumbel        s                   like(bfbelp)
8.03 d w_summngd       s                   like(bfmngd)
      * ------------------------------------------------------------------------
      *
      * Leser poster
8.03 c     lesp          tag
8.04 c*                  read      bovfl2
8.04 c                   read      bovfl3
8.03 c                   if        %eof
8.03 c                   eval      w_ferdig  = '1'
8.03 c                   goto      siste
8.03 c                   endif
      *
8.03 c                   if        w_forste = '1'
8.03 c                   eval      w_forste  = '0'
8.03 c                   eval      x_bfbiln  = bfbiln
8.04 c                   eval      x_bftext  = bftext
8.04 c                   eval      x_bfbilk  = bfbilk
8.04 c                   eval      x_bfdkto  = bfdkto
8.04 c                   eval      x_bfckto  = bfckto
     c                   eval      x_bfdmom  = bfdmom
     c                   eval      x_bfcmom  = bfcmom
8.04 c                   eval      x_bfdavd  = bfdavd
8.04 c                   eval      x_bfcavd  = bfcavd
8.04 c                   eval      x_bfkund  = bfkund
8.04 c                   eval      x_bfkref  = bfkref
8.03 c                   add       bfbelp        w_sumbel
8.03 c                   add       bfmngd        w_summngd
8.03 c                   goto      lesp
8.03 c                   endif
      *
8.03 c*                  if        l_firm <> bffirm
8.03 c*                  goto      slutt
8.03 c*                  endif
6.23  *
8.04 c*                  if        x_bfbiln  <> bfbiln
8.04 c                   if        x_bftext  <> bftext
8.04 c                   exsr      brudd
8.04 c                   write     rv02pfr
8.04 c                   clear                   w_sumbel
8.04 c                   clear                   w_summngd
8.04 c                   eval      x_bfbiln  = bfbiln
8.04 c                   eval      x_bftext  = bftext
8.04 c                   eval      x_bfbilk  = bfbilk
8.04 c                   eval      x_bfckto  = bfckto
8.04 c                   eval      x_bfdkto  = bfdkto
     c                   eval      x_bfcmom  = bfcmom
     c                   eval      x_bfdmom  = bfdmom
8.04 c                   eval      x_bfcavd  = bfcavd
8.04 c                   eval      x_bfdavd  = bfdavd
8.04 c                   eval      x_bfkund  = bfkund
8.04 c                   eval      x_bfkref  = bfkref
8.04 c                   add       bfbelp        w_sumbel
8.04 c                   add       bfmngd        w_summngd
8.04 c                   goto      lesp
8.04 c                   endif
8.04 c                   if        x_bfckto  = bfckto
8.04 c                             and bfckto <> 0
8.04 c                   add       bfbelp        w_sumbel
8.04 c                   add       bfmngd        w_summngd
8.04 c                   goto      lesp
8.04 c                   endif
8.04 c                   if        x_bfdkto  = bfdkto
8.04 c                             and bfdkto <> 0
8.04 c                   add       bfbelp        w_sumbel
8.04 c                   add       bfmngd        w_summngd
8.04 c                   goto      lesp
8.04 c                   endif
8.04  *
8.04 c                   if        x_bfckto  <> bfckto
8.04 c                   if        bfckto  <> 0
8.04 c*                  add       bfbelp        w_sumbel
8.04 c*                  add       bfmngd        w_summngd
8.04 c*                  else
8.04 c                   exsr      brudd
8.04 c                   write     rv02pfr
8.04 c                   clear                   w_sumbel
8.04 c                   clear                   w_summngd
8.04 c                   add       bfbelp        w_sumbel
8.04 c                   add       bfmngd        w_summngd
8.04 c                   eval      x_bfckto  = bfckto
8.04 c                   eval      x_bfdkto  = bfdkto
     c                   eval      x_bfbiln  = bfbiln
     c                   eval      x_bftext  = bftext
8.04 c                   eval      x_bfbilk  = bfbilk
     c                   eval      x_bfcmom  = bfcmom
     c                   eval      x_bfdmom  = bfdmom
8.04 c                   eval      x_bfcavd  = bfcavd
8.04 c                   eval      x_bfdavd  = bfdavd
8.04 c                   eval      x_bfkund  = bfkund
8.04 c                   eval      x_bfkref  = bfkref
8.04 c                   goto      lesp
8.04 c                   endif
8.04 c                   endif
8.04 c                   if        x_bfdkto  <> bfdkto
8.04 c                   if        bfdkto  <> 0
8.04 c*                  add       bfbelp        w_sumbel
8.04 c*                  add       bfmngd        w_summngd
8.04 c*                  else
8.04 c                   exsr      brudd
8.04 c                   write     rv02pfr
8.04 c                   clear                   w_sumbel
8.04 c                   clear                   w_summngd
8.04 c                   add       bfbelp        w_sumbel
8.04 c                   add       bfmngd        w_summngd
8.04 c                   eval      x_bfdkto  = bfdkto
8.04 c                   eval      x_bfckto  = bfckto
     c                   eval      x_bfbiln  = bfbiln
     c                   eval      x_bftext  = bftext
8.04 c                   eval      x_bfbilk  = bfbilk
     c                   eval      x_bfcmom  = bfcmom
8.04 c                   eval      x_bfdmom  = bfdmom
8.04 c                   eval      x_bfcavd  = bfcavd
8.04 c                   eval      x_bfdavd  = bfdavd
8.04 c                   eval      x_bfkund  = bfkund
8.04 c                   eval      x_bfkref  = bfkref
8.04 c                   goto      lesp
8.04 c                   endif
8.04 c                   endif
8.04  *
8.03 c* Sjekk om det er mer igjen
8.03 c     siste         tag
8.03 c                   if        w_ferdig = '1' and w_sumbel  = 0
8.03 c                   goto      sluttl
8.03 c                   endif
     c* Blanker felt
     c                   eval      d_dati  = *blanks
     c                   eval      d_fdati = *blanks
6.22 c**                 eval      w_lnavn = *blanks
6.22 c                   eval      w_lnav  = *blanks
6.22 c                   eval      wknavu  = *blanks
6.22 c                   eval      w_posm  = *zeros
6.22 c                   eval      w2fnav  = *blanks
6.22 c                   eval      wkalfa  = *blanks
6.22 c                   eval      w2navn  = *blanks
     c                   eval      w_ladr1 = *blanks
     c                   eval      w_ladr2 = *blanks
     c                   eval      w_lposn = *blanks
     c                   eval      w_lposs = *blanks
      *
6.12 c                   eval      w_navn = *blanks
6.12 c                   eval      w_adr2 = *blanks
6.12 c                   eval      w_gate = *blanks
6.12 c                   eval      w_tlfn = *blanks
6.12 c                   eval      w_tlfx = *blanks
6.12 c                   eval      w_alfa = *blanks
6.12 c                   eval      w_bgir = *zeros
6.12 c                   eval      w_pste = *blanks
6.12 c                   eval      d_pste = *blanks
6.12 c                   eval      w_ponr = *blanks
6.12 c                   eval      w_grns = *zeros
6.12 c                   eval      w_kund = *zeros
6.30  * Moms kode
8.04 c*                  if        bfdmom = *blank
8.04 c                   if        x_bfdmom = *blank
6.30 c                   eval      w_mkod = x_bfcmom
6.30 c                   else
6.30 c                   eval      w_mkod = x_bfdmom
6.30 c                   endif
7.03 c                   move      w_mkod        w_mkodn
7.03  * Sjekker om momskode  skal konverteres
7.03 c                   eval      w_type      = 'MVAKODE'
7.03 c                   move      w_mkod        rb00l1_gkod
7.03 c     rb00l1_key    chain     rb00l1
7.03 c                   if        %found
7.03 c*                  movel     r00nko        w_mkod
7.03 c                   move      r00nko        w_mkodn
8.04 c                   else
8.04 c*                  clear                   w_mkodn
7.03 c                   endif
     c*
     c                   move      bfbdat        d_dati
     c                   move      d_aa          d_aar
     c                   move      d_mn          d_mnd
     c                   move      d_dd          d_dag
     c                   move      d_date        w_dato_al1
     c*
     c**********
     c                   move      bffdat        d_fdati
     c                   move      d_fa          d_far
     c                   move      d_fn          d_fnd
     c                   move      d_fd          d_fag
     c*
     c*
     c                   move      d_fdat        w_dato_alf
      *
     c                   move      udate         w_dato_al2
      *
6.24 c                   eval      rkmkod = 0
      *
      * Finner data fra faktura-hode og kundereg
     c                   exsr      control_init
     c*
7.00  * Sjekker om bilagstype skal konverteres
7.00 c                   eval      xxbilk = bfbilk
7.00 c                   eval      rb10l1_gkod = bfbilk
7.00 c     rb10l1_key    chain     rb10l1
7.00 c                   if        %found
7.00 c                   eval      xxbilk = rankod
7.04 c                   else
7.04 c                   eval      w_firm = *zeros
7.04 c     rb10l1_key    chain     rb10l1
7.04 c                   if        %found
7.04 c                   eval      xxbilk = rankod
7.04 c                   endif
7.00 c                   endif
7.00  *
8.04 c                   if        x_bfdavd = *zeros
8.04 c                   eval      w_avde = x_bfcavd
     c                   else
8.04 c                   eval      w_avde = x_bfdavd
     c                   endif
     c*
6.12 c*
8.00 c                   eval      rkunl1_kund = *zero
8.00 c                   eval      w_motp8      = *zero
8.00  *
6.12 c                   if        bfdkto > 9999
6.12 c                   eval      rkunl1_kund = bfdkto
6.12 c     rkunl1_key    chain     rkunl1                             90
6.12 c                   if        *in90 = '0'
6.12 c                   exsr      w_flytt
6.12 c                   endif
6.12 c                   else
6.12 c                   if        bfckto > 9999
6.12 c                   eval      rkunl1_kund = bfckto
6.12 c     rkunl1_key    chain     rkunl1                             90
6.12 c                   if        *in90 = '0'
6.12 c                   exsr      w_flytt
6.12 c                   endif
6.12 c                   else
6.12 c                   endif
6.12 c                   endif
     c*
8.00  *   Sjekk om motpost skal fylles ut
8.00  *
8.00 c                   if        rkunl1_kund > 0
8.04 c                   eval      w_motp8 = x_bfkref
8.01 c                   else
8.01 c                   eval      w_motp8 = *zero
8.00 c                   endif
8.02  *   Sjekk om motpost finnes med samme beløp, hvis ikke fjernes ref.
8.02 c                   if        w_motp8 <> *zero
8.02 c                   eval      rktrl8_kund = rkunl1_kund
8.02 c                   eval      rktrl8_biln = w_motp8
8.02 c     rktrl8_key    setll     rktrl8
8.02 c     rktrl8_key    reade     rktrl8
8.02 c                   dow       not %eof(rktrl8)
8.02 c                   if        rnrest = bfbelp
8.02 c                   goto      ref_ok
8.02 c                   endif
8.02 c     rktrl8_key    reade     rktrl8
8.02 c                   enddo
8.05 c                   eval      w_motp8 = *zero
8.02 c     ref_ok        tag
8.02 c                   endif
     c*
     c**********
     c                   eval      rvdata = *blank
      * Trans.type
     c                   eval      rvdata =  %char(1)        + ',' +
      * Post.dato
     c                                     %trim(w_dato_al2) + ',' +
      * Bilagsnr.
8.03 c*                                    %char(bfbiln)     + ',' +
8.03 c                                     %char(x_bfbiln)     + ',' +
      * Bil.dato
     c                                     %trim(w_dato_al1) + ',' +
      * Bil.art ??????
7.00 c**                                   %char(bfbilk)     + ',' +
8.04 c                                     %char(xxbilk)     + ',' +
8.04 c*                                    %char(x_bfbilk)     + ',' +
      * Bil.tekst
8.04 c*                              '"'+  %trim(bftext) + '"' + ',' +
8.04 c                               '"'+  %trim(x_bftext) + '"' + ',' +
      * Avdeling
8.04 c                                     %char(w_avde)     + ',' +
      * Prosjektnr.
     c                                     %trim(bfproj)     + ',' +
      * Deb.konto
     c                                     %char(bfdkto)     + ',' +
      * Kred.konto
     c                                     %char(bfckto)     + ',' +
     c*
      * MVA-kode deb???????
7.03 c*                                    %trim(w_mkod)     + ',' +
7.03 c                                     %trim(w_mkodn)    + ',' +
      * Valutakode
     c                                     %char(0)          + ',' +
      * Valutakurs
     c                                     %char(0)          + ',' +
      * Valutabeløp
     c                                     %char(bfvalb)     + ',' +
      * Beløp på linje
8.03 c*                                    %char(bfbelp)     + ',' +
8.03 c                                     %char(w_sumbel)     + ',' +
      * Motbilagsnr
8.00 c                               %trim(%char(w_motp8))   + ',' +
      * Forf.dato
     c                                     %trim(w_dato_alf) + ',' +
      * Kjedenummer
     c                                     %char(0)          + ',' +
      * Mengde
8.03 c*                                    %char(bfmngd)     + ',' +
8.03 c                                     %char(w_summngd)     + ',' +
      * Kid nr ???????
     c                               '"'+  %trim(sokidd) + '"' + ',' +
      * Avgifts klasse ???????
     c                                     %char(0)          + ',' +
      * Hovedbokskto kunde ????
8.04 c*                                    %char(bfkund)     + ',' +
8.04 c                                     %char(x_bfkund)     + ',' +
      * Lev.fakturanr.
     c                               '"'+  %trim(w_fnutt)    + ',' +
      * Remittance no.
     c                                     %char(0)          + ',' +
      * Produktnr.
     c                                     %char(0)          + ',' +
      * Medarbeidernr.
     c                                     %char(0)          + ',' +
      * Ekstra 1 nr
     c                                     %char(0)          + ',' +
      * Ekstra 2 nr
     c                                     %char(0)          + ',' +
      * Ekstra 3 nr
     c                                     %char(0)          + ',' +
      * Ekstra 4 nr
     c                                     %char(0)          + ',' +
      * Kundenr
6.12 c                                     %char(w_kund)     + ',' +
      * Kjedenr
     c                                     %char(0)          + ',' +
6.12  * Navn
6.12 c                               '"'+  %trim(w_navn) + '"' + ',' +
6.12  * Adresse 1
6.12 c                               '"'+  %trim(w_gate) + '"' + ',' +
6.12  * Adresse 2
6.12 c                               '"'+  %trim(w_adr2) + '"' + ',' +
6.12  * Postnr
     c                               '"'+  %trim(w_ponr) + '"' + ',' +
      * Poststed
6.11 c                               '"'+  %trim(w_pste) + '"' + ',' +
      * Skipalfa
     c                               '"'+  %trim(w_fnutt)    + ','   +
      * Telefon
6.12 c                               '"'+  %trim(w_tlfn) + '"' + ',' +
      * Telefax
6.12 c                               '"'+  %trim(w_tlfx) + '"' + ',' +
      * Alfa sort. navn
6.12 c                               '"'+  %trim(w_alfa) + '"' + ',' +
      * Postkto nr.
     c                               '"'+  %trim(w_fnutt)    + ','   +
      * Bankkonto ?????????
6.12 c***                            '"'+  %char(w_bgir)    + ','   +
     c                               '"'+  %char(w_bgir) + '"' + ','    +
      * Kredittgrense
     c                                     %char(w_grns)     + ','   +
      * Lev.navn  ?????????
6.22 c**                             '"'+  %trim(w_lnavn) + '"' + ','   +
6.22 c                               '"'+  %trim(w_lnav) + '"' + ','    +
      * Lev.adr.1 ?????????
     c                               '"'+  %trim(w_ladr1) + '"' + ','   +
      * Lev.adr.2 ?????????
     c                               '"'+  %trim(w_ladr2) + '"' + ','   +
      * Lev.postn ?????????
     c                               '"'+  %trim(w_lposn) + '"'  + ','  +
      * Lev.poststed ??????
     c                               '"'+  %trim(w_lposs) + '"'  + ','   +
      * Medarb.nr på kunden???
     c                                     %char(0)          + ',' +
      * Distrikt
     c                                     %char(rkdist)     + ',' +
      * Betalingsbet
     c                                     %char(rkbetb)     + ',' +
      * Skipnum????
     c                                     %char(0)          + ',' +
      * Kundetype
     c                                     %char(0)          + ',' +
      * Rabattgr./bet.profiler
     c                                     %char(rkrabk)     + ',' +
      * Behandlingsprofiler
     c                                     %char(0)          + ','
     c************************************************************************
     c*    'Æ':X'46'     xlate     nsdata        nsdata
     c*    'æ':X'A0'     xlate     nsdata        nsdata
     c*    'Ø':X'77'     xlate     nsdata        nsdata
     c*    'ø':X'90'     xlate     nsdata        nsdata
     c*    'Å':X'2A'     xlate     nsdata        nsdata
     c*    'å':X'EF'     xlate     nsdata        nsdata
     c                   write     rv02pfr
8.04 c                   clear                   w_sumbel
8.04 c                   clear                   w_summngd
8.04 c                   clear                   w_mkodn
8.03 c                   if        w_ferdig   = '1'
8.03 c                   goto      sluttl
8.03 c                   endif
8.03 c                   eval      x_bfbiln  = bfbiln
     c* Tar vare på felt
     c                   eval      x_bfperi   =  bfperi
8.03 c                   eval      x_bfbunt   =  bfbunt
8.03 c                   eval      x_bfbiln   =  bfbiln
8.03 c                   eval      x_bfbdat   =  bfbdat
8.03 c                   eval      x_bffdat   =  bffdat
8.03 c                   eval      x_bfbilk   =  bfbilk
8.03 c                   eval      x_bftext   =  bftext
8.03 c                   eval      x_bfdavd   =  bfdavd
8.03 c                   eval      x_bfdkto   =  bfdkto
8.03 c                   eval      x_bfdsps   =  bfdsps
8.03 c                   eval      x_bfdmom   =  bfdmom
8.03 c                   eval      x_bfbelp   =  bfbelp
8.03 c                   eval      x_bfmvag   =  bfmvag
8.03 c                   eval      x_bfcavd   =  bfcavd
8.03 c                   eval      x_bfckto   =  bfckto
8.03 c                   eval      x_bfcsps   =  bfcsps
8.03 c                   eval      x_bfcmom   =  bfcmom
8.03 c                   eval      x_bfproj   =  bfproj
8.03 c                   eval      x_bfakti   =  bfakti
8.03 c                   eval      x_bfmngd   =  bfmngd
8.04 c                   eval      x_bfkund   =  bfkund
8.04 c                   eval      x_bfkref   =  bfkref
8.04  *
6.23 c     slutt         tag
8.03 c                   goto      lesp
      *
     c     dd999         tag
8.03 c     sluttl        tag
      *
     c                   eval      *inlr = *on
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.04 c     brudd         begsr
8.04  * Moms kode
8.04 c*                  if        bfdmom = *blank
8.04 c                   if        x_bfdmom = *blank
8.04 c                   eval      w_mkod = x_bfcmom
8.04 c                   else
8.04 c                   eval      w_mkod = x_bfdmom
8.04 c                   endif
8.04 c                   move      w_mkod        w_mkodn
8.04  * Sjekker om momskode  skal konverteres
8.04 c                   eval      w_type      = 'MVAKODE'
8.04 c                   move      w_mkod        rb00l1_gkod
8.04 c     rb00l1_key    chain     rb00l1
8.04 c                   if        %found
8.04 c*                  movel     r00nko        w_mkod
8.04 c                   move      r00nko        w_mkodn
8.04 c                   else
8.04 c*                  clear                   w_mkodn
8.04 c                   endif
8.04 c*
8.04 c                   move      bfbdat        d_dati
8.04 c                   move      d_aa          d_aar
8.04 c                   move      d_mn          d_mnd
8.04 c                   move      d_dd          d_dag
8.04 c                   move      d_date        w_dato_al1
8.04 c*
8.04 c**********
8.04 c                   move      bffdat        d_fdati
8.04 c                   move      d_fa          d_far
8.04 c                   move      d_fn          d_fnd
8.04 c                   move      d_fd          d_fag
8.04 c*
8.04 c*
8.04 c                   move      d_fdat        w_dato_alf
8.04  *
8.04 c                   move      udate         w_dato_al2
8.04  *
8.04 c                   eval      rkmkod = 0
8.04  *
8.04  * Finner data fra faktura-hode og kundereg
8.04 c*                  exsr      control_init
8.04 c*
8.04  * Sjekker om bilagstype skal konverteres
8.04 c                   eval      xxbilk = bfbilk
8.04 c                   eval      rb10l1_gkod = bfbilk
8.04 c     rb10l1_key    chain     rb10l1
8.04 c                   if        %found
8.04 c                   eval      xxbilk = rankod
8.04 c                   endif
8.04  *
8.04 c                   if        x_bfdavd = *zeros
8.04 c                   eval      w_avde = x_bfcavd
8.04 c                   else
8.04 c                   eval      w_avde = x_bfdavd
8.04 c                   endif
8.04 c*
8.04 c*
8.04 c                   eval      rkunl1_kund = *zero
8.04 c                   eval      w_motp8      = *zero
8.04  *
8.04 c                   if        x_bfdkto > 9999
8.04 c*                  eval      rkunl1_kund = bfdkto
8.04 c                   eval      rkunl1_kund = x_bfdkto
8.04 c     rkunl1_key    chain     rkunl1                             90
8.04 c                   if        *in90 = '0'
8.04 c                   exsr      w_flytt
8.04 c                   endif
8.04 c                   else
8.04 c                   if        x_bfckto > 9999
8.04 c*                  eval      rkunl1_kund = bfckto
8.04 c                   eval      rkunl1_kund = x_bfckto
8.04 c     rkunl1_key    chain     rkunl1                             90
8.04 c                   if        *in90 = '0'
8.04 c                   exsr      w_flytt
8.04 c                   endif
8.04 c                   else
8.04 c                   endif
8.04 c                   endif
8.04 c*
8.04  *   Sjekk om motpost skal fylles ut
8.04  *
8.04 c                   if        rkunl1_kund > 0
8.04 c                   eval      w_motp8 = x_bfkref
8.04 c                   else
8.04 c                   eval      w_motp8 = *zero
8.04 c                   endif
8.04  *   Sjekk om motpost finnes med samme beløp, hvis ikke fjernes ref.
8.04 c                   if        w_motp8 <> *zero
8.04 c                   eval      rktrl8_kund = rkunl1_kund
8.04 c                   eval      rktrl8_biln = w_motp8
8.04 c     rktrl8_key    setll     rktrl8
8.04 c     rktrl8_key    reade     rktrl8
8.04 c                   dow       not %eof(rktrl8)
8.04 c                   if        rnrest = bfbelp
8.04 c                   goto      ref_ok1
8.04 c                   endif
8.04 c     rktrl8_key    reade     rktrl8
8.04 c                   enddo
8.05 c                   eval      w_motp8 = *zero
8.04 c     ref_ok1       tag
8.04 c                   endif
8.04 c                   eval      rvdata = *blank
8.04  * Trans.type
8.04 c                   eval      rvdata =  %char(1)        + ',' +
8.04  * Post.dato
8.04 c                                     %trim(w_dato_al2) + ',' +
8.04  * Bilagsnr.
8.04 c*                                    %char(bfbiln)     + ',' +
8.04 c                                     %char(x_bfbiln)     + ',' +
8.04  * Bil.dato
8.04 c                                     %trim(w_dato_al1) + ',' +
8.04  * Bil.art ??????
8.04 c**                                   %char(bfbilk)     + ',' +
8.04 c                                     %char(xxbilk)     + ',' +
8.04 c*                                    %char(x_bfbilk)     + ',' +
8.04  * Bil.tekst
8.04 c*                              '"'+  %trim(bftext) + '"' + ',' +
8.04 c                               '"'+  %trim(x_bftext) + '"' + ',' +
8.04  * Avdeling
8.04 c                                     %char(w_avde)     + ',' +
8.04  * Prosjektnr.
8.04 c                                     %trim(bfproj)     + ',' +
8.04  * Deb.konto
8.04 c                                     %char(x_bfdkto)     + ',' +
8.04  * Kred.konto
8.04 c                                     %char(x_bfckto)     + ',' +
8.04 c*                                              yt
8.04  * MVA-kode deb???????
8.04 c*                                    %trim(w_mkod)     + ',' +
8.04 c                                     %trim(w_mkodn)    + ',' +
8.04  * Valutakode
8.04 c                                     %char(0)          + ',' +
8.04  * Valutakurs
8.04 c                                     %char(0)          + ',' +
8.04  * Valutabeløp
8.04 c                                     %char(bfvalb)     + ',' +
8.04  * Beløp på linje
8.04 c*                                    %char(bfbelp)     + ',' +
8.04 c                                     %char(w_sumbel)     + ',' +
8.04  * Motbilagsnr
8.04 c                               %trim(%char(w_motp8))   + ',' +
8.04  * Forf.dato
8.04 c                                     %trim(w_dato_alf) + ',' +
8.04  * Kjedenummer
8.04 c                                     %char(0)          + ',' +
8.04  * Mengde
8.04 c*                                    %char(bfmngd)     + ',' +
8.04 c                                     %char(w_summngd)     + ',' +
8.04  * Kid nr ???????
8.04 c                               '"'+  %trim(sokidd) + '"' + ',' +
8.04  * Avgifts klasse ???????
8.04 c                                     %char(0)          + ',' +
8.04  * Hovedbokskto kunde ????
8.04 c*                                    %char(bfkund)     + ',' +
8.04 c                                     %char(x_bfkund)     + ',' +
8.04  * Lev.fakturanr.
8.04 c                               '"'+  %trim(w_fnutt)    + ',' +
8.04  * Remittance no.
8.04 c                                     %char(0)          + ',' +
8.04  * Produktnr.
8.04 c                                     %char(0)          + ',' +
8.04  * Medarbeidernr.
8.04 c                                     %char(0)          + ',' +
8.04  * Ekstra 1 nr
8.04 c                                     %char(0)          + ',' +
8.04  * Ekstra 2 nr
8.04 c                                     %char(0)          + ',' +
8.04  * Ekstra 3 nr
8.04 c                                     %char(0)          + ',' +
8.04  * Ekstra 4 nr
8.04 c                                     %char(0)          + ',' +
8.04  * Kundenr
8.04 c                                     %char(w_kund)     + ',' +
8.04  * Kjedenr
8.04 c                                     %char(0)          + ',' +
8.04  * Navn
8.04 c                               '"'+  %trim(w_navn) + '"' + ',' +
8.04  * Adresse 1
8.04 c                               '"'+  %trim(w_gate) + '"' + ',' +
8.04  * Adresse 2
8.04 c                               '"'+  %trim(w_adr2) + '"' + ',' +
8.04  * Postnr
8.04 c                               '"'+  %trim(w_ponr) + '"' + ',' +
8.04  * Poststed
8.04 c                               '"'+  %trim(w_pste) + '"' + ',' +
8.04  * Skipalfa
8.04 c                               '"'+  %trim(w_fnutt)    + ','   +
8.04  * Telefon
8.04 c                               '"'+  %trim(w_tlfn) + '"' + ',' +
8.04  * Telefax
8.04 c                               '"'+  %trim(w_tlfx) + '"' + ',' +
8.04  * Alfa sort. navn
8.04 c                               '"'+  %trim(w_alfa) + '"' + ',' +
8.04  * Postkto nr.
8.04 c                               '"'+  %trim(w_fnutt)    + ','   +
8.04  * Bankkonto ?????????
8.04 c***                            '"'+  %char(w_bgir)    + ','   +
8.04 c                               '"'+  %char(w_bgir) + '"' + ','    +
8.04  * Kredittgrense
8.04 c                                     %char(w_grns)     + ','   +
8.04  * Lev.navn  ?????????
8.04 c**                             '"'+  %trim(w_lnavn) + '"' + ','   +
8.04 c                               '"'+  %trim(w_lnav) + '"' + ','    +
8.04  * Lev.adr.1 ?????????
8.04 c                               '"'+  %trim(w_ladr1) + '"' + ','   +
8.04  * Lev.adr.2 ?????????
8.04 c                               '"'+  %trim(w_ladr2) + '"' + ','   +
8.04  * Lev.postn ?????????
8.04 c                               '"'+  %trim(w_lposn) + '"'  + ','  +
8.04  * Lev.poststed ??????
8.04 c                               '"'+  %trim(w_lposs) + '"'  + ','   +
8.04  * Medarb.nr på kunden???
8.04 c                                     %char(0)          + ',' +
8.04  * Distrikt
8.04 c                                     %char(rkdist)     + ',' +
8.04  * Betalingsbet
8.04 c                                     %char(rkbetb)     + ',' +
8.04  * Skipnum????
8.04 c                                     %char(0)          + ',' +
8.04  * Kundetype
8.04 c                                     %char(0)          + ',' +
8.04  * Rabattgr./bet.profiler
8.04 c                                     %char(rkrabk)     + ',' +
8.04  * Behandlingsprofiler
8.04 c                                     %char(0)          + ','
8.04 c*******************c****************************************************
8.04 c*    'Æ':X'46'     xlate     nsdata        nsdata
8.04 c*    'æ':X'A0'     xlate     nsdata        nsdata
8.04 c*    'Ø':X'77'     xlate     nsdata        nsdata
8.04 c*    'ø':X'90'     xlate     nsdata        nsdata
8.04 c*    'Å':X'2A'     xlate     nsdata        nsdata
8.04 c*    'å':X'EF'     xlate     nsdata        nsdata
      *
     c* Blanker felt
8.04 c                   clear                   w_kund
8.04 c**                 eval      w_lnavn = *blanks
8.04 c                   eval      w_lnav  = *blanks
8.04 c                   eval      wknavu  = *blanks
8.04 c                   eval      w_posm  = *zeros
8.04 c                   eval      w2fnav  = *blanks
8.04 c                   eval      wkalfa  = *blanks
8.04 c                   eval      w2navn  = *blanks
8.04 c                   eval      w_ladr1 = *blanks
8.04 c                   eval      w_ladr2 = *blanks
8.04 c                   eval      w_lposn = *blanks
8.04 c                   eval      w_lposs = *blanks
8.04  *
8.04 c                   eval      w_navn = *blanks
8.04 c                   eval      w_adr2 = *blanks
8.04 c                   eval      w_gate = *blanks
8.04 c                   eval      w_tlfn = *blanks
8.04 c                   eval      w_tlfx = *blanks
8.04 c                   eval      w_alfa = *blanks
8.04 c                   eval      w_bgir = *zeros
8.04 c                   eval      w_pste = *blanks
8.04 c                   eval      d_pste = *blanks
8.04 c                   eval      w_ponr = *blanks
8.04 c                   eval      w_grns = *zeros
      *
8.04 c                   endsr
8.04  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     control_init  begsr
      *
     c                   eval      w_firm = bffirm
8.04 c*                  eval      w_binr = bfbiln
8.04 c                   eval      w_binr = x_bfbiln
     c                   move      d_aa          w_aarr
      * Finner siste faktura-hode for faktura
      *
     c     sohel1_key    setll     sohel1
     c     sohel1_key    reade     sohel1                                 90
     c                   if        *in90 = *on
     c                   goto      avslutt
     c                   endif
      *
     c                   dow       *in90 = *off
     c     sohel1_key    reade     sohel1                                 90
     c                   enddo
      *
     c     avslutt       tag
      * Henter lev.adresse dersom fyllt ut
     c                   if        solkun  <> *zeros
     c                   eval      rkunl1_kund = solkun
     c     rkunl1_key    chain     rkunl1                             90
6.22  * Sjekker om det ligger ',' i leveringsnavn
6.22 c                   eval      w_posm = 0
6.22 c                   eval      w_posm = %scan(',':rknavn)
6.22  *
6.22 c                   if        w_posm > 0 and
6.22 c                             w_posm < 29
6.22 c                   eval      w2navn = %subst(rknavn:1:w_posm - 1)
6.22 c                   eval      w2fnav = %subst(rknavn:w_posm + 2)
6.22 c                   eval      w_lnav = %trim(w2navn) + ' ' + %trim(w2fnav)
6.22 c                   else
6.22 c                   eval      w_lnav = rknavn
6.22 c                   endif
6.22 c**                 eval      w_lnavn     = rknavn
     c                   eval      w_ladr1     = rkgate
     c                   eval      w_ladr2     = rkadr2
     c                   move      rkponr        w_lposn
     c                   eval      w_lposs     = rksted
     c                   endif
      * Henter kundenavn
      *
     c                   eval      rkunl1_kund = sokund
     c     rkunl1_key    chain     rkunl1                             90
6.21  *
6.21  * Henter rutine fra ordretype
6.21  *
6.21 c                   eval      b_kkid = *off
6.21 c                   eval      votyl1_otyp = sootyp
6.21 c     votyl1_key    chain     votyl1
6.21 c                   if        %found(votyl1)   and
6.21 c                             vaorut <> *blank
6.21 c                   eval      aforl1_ruti = vaorut
6.21 c     aforl1_key    chain     aforl1
6.21 c                   if        %found(aforl1) and
6.21 c                             afkidk = 2
6.21 c                   eval      b_kkid = *on
6.21 c                   endif
6.21 c                   endif
6.21 c                   if        b_kkid = *on
6.21 c                   movel     sokidr        w_kidr
6.21 c                   call      'AK710R'
6.21 c                   parm                    w_firm
6.21 c                   parm                    w_kidr
6.21 c                   parm                    w_kidd
6.21 c                   parm                    w_kid2
6.21 c                   movel     w_kid2        sokidd
6.21 c                   endif
6.21  *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.12  *
6.12 c     w_flytt       begsr
6.12  *
6.12 c                   eval      w_kund = rkkund
6.22  *
6.22  * Sjekker om det ligger ',' i kundenavn
6.22 c                   eval      w_posm = 0
6.22 c                   eval      w_posm = %scan(',':rknavn)
6.22  *
6.22 c                   if        w_posm > 0 and
6.22 c                             w_posm < 29
6.22 c                   eval      w2navn = %subst(rknavn:1:w_posm - 1)
6.22 c                   eval      w2fnav = %subst(rknavn:w_posm + 2)
6.22 c                   eval      w_navn = %trim(w2navn) + ' ' + %trim(w2fnav)
6.22 c                   else
6.22 c                   eval      w_navn = rknavn
6.22 c                   endif
6.22  *
6.12 c                   eval      w_gate = rkgate
6.12 c                   eval      w_adr2 = rkadr2
6.12 c                   eval      w_tlfn = rktlfn
6.22  * Sjekker om det ligger ',' i alfafelt
6.22 c                   eval      w_posm = 0
6.22 c                   eval      w_posm = %scan(',':rkalfa)
6.22  *
6.22 c                   if        w_posm > 0 and
6.22 c* 6.25                       w_posm < 29
6.25 c                             w_posm < 17
6.22 c                   eval      w2navn = %subst(rkalfa:1:w_posm - 1)
6.22 c                   eval      w2fnav = %subst(rkalfa:w_posm + 2)
6.22 c                   eval      w_alfa = %trim(w2navn) + ' ' + %trim(w2fnav)
6.22 c                   else
6.22 c                   eval      w_alfa = rkalfa
6.22 c                   endif
6.22  *
6.12 c                   eval      w_bgir = rkbgir
6.11 c                   eval      d_pste = rksted
6.11 c                   eval      w_pste = d_ps1
6.12 c                   move      rkponr        w_ponr
6.12 c                   z-add     rkgrns        w_grns
6.11 c*
6.12  *
6.12 c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  * Subrutine for initiering av program
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  *
6.21 c     *inzsr        begsr
6.21  *
6.21  * Key for oppslag på faktura-hode-register
6.21  *
6.21 c     sohel1_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    w_aarr
6.21 c                   kfld                    w_binr
6.21  *
6.21  * Key for oppslag på kunde
6.21  *
6.21 c     rkunl1_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    rkunl1_kund
8.02  *
8.02  * Key for oppslag på kunde-transer
8.02  *
8.02 c     rktrl8_key    klist
8.02 c                   kfld                    w_firm
8.02 c                   kfld                    rktrl8_kund
8.02 c                   kfld                    rktrl8_biln
6.21  *
6.21  * Key for les av ordretype
6.21  *
6.21 c     votyl1_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    votyl1_otyp
6.21  *
6.21  * Key for les av rutine-register
6.21  *
6.21 c     aforl1_key    klist
6.21 c                   kfld                    aforl1_ruti
      *
7.00  * Key for posisjonering på bilagskoder
7.00  *
7.00 c     rb10l1_key    klist
7.00 c                   kfld                    w_firm
7.00 c                   kfld                    rb10l1_gkod
7.00  *
7.03  * Key for posisjonering på koder (moms)
7.03  *
7.03 c     rb00l1_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    w_type
7.03 c                   kfld                    rb00l1_gkod
6.21  *
     c                   eval      w_firm = l_firm
8.03 c                   eval      w_forste = '1'
8.03 c                   eval      w_ferdig = '0'
6.21  *
6.21 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
