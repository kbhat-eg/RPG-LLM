# Documentation for Program MO701R

## Overview

**Program:** MO701R  
**System:** ASLAGR  
**Description:**  
This program is a monitoring utility that generates base data for monitoring types 2 and 3:

- **Type 2:** Sales of special order items (skaffevare) without an associated purchase order.
- **Type 3:** Orders without a delivery date.

The program processes sales statistics and order files, identifies anomalies according to the above criteria, and logs them for further follow-up.

---

## Key Business Logic

### 1. **Input Parameters and Initialization**

- The program is launched with a date parameter (`p_dato`), which determines the processing period.
- The company/firm number (`w_firm`) is retrieved from the Local Data Area (LDA).
- The processing year (`w_aar`) is extracted from `w_dato`.

### 2. **Data Cleanup**

Before processing, the program deletes all existing monitoring records (types 2 and 3) for the selected date from the `lwo2lu` and `lwo3lu` files to avoid duplicate logging.

### 3. **Processing Sales Statistics (Type 2 Monitoring)**

- Reads the **sales statistics file** (`sstal1`).
- For each record matching the selected date and where:
    - Item type (`sfvtyp`) is 'S' (skaffevare/special order item).
    - Associated purchase order number (`sfbenr`) is zero (i.e., no linked PO).
- Logs the anomaly to the monitoring file (`lwo2lu`).

### 4. **Processing Orders (Type 2 and 3 Monitoring)**

- Reads the **order header file** (`foheld`) for the selected date.
- For each order:
    - Checks the order type (`footyp`) against the **order type file** (`votylr`). Only orders with processing code (`vaoakk`) not equal to zero are considered (i.e., not quotes).
    - Evaluates the delivery date at both header (`foldat`) and line (`fdldat`) levels.

#### **Type 2: Sales of Special Order Items Without PO**
- For each order line, if:
    - Item type is 'S' (via call to `VL710R` program to obtain item type).
    - No linked purchase order (`fdbenr = 0`).
- Logs the anomaly to the monitoring file (`lwo2lu`).

#### **Type 3: Orders Without Delivery Dates**
- For each order line, if both header and line delivery dates are blank/low value and the line type is not 'TX' (text line):
    - Logs the anomaly to the monitoring file (`lwo3lu`).
- If **all** lines in an order lack delivery dates, logs a header-level anomaly to `lwo3lu`.

### 5. **Logging**

- **Type 2 logging:** Uses `skriv_logg` subroutine to insert/update records in `lwo2lu`.
- **Type 3 logging:** Uses `skriv_logg3` subroutine to insert/update records in `lwo3lu`.
- Logging includes contextual information such as sales rep, department, user, item, net amount, and various groupings.

### 6. **Auxiliary Data**

- **Salesperson Name Lookup:** The `les_selg` subroutine fetches the name of the sales rep from the `ra09l1` file using the sales rep code.

### 7. **External Program Call**

- **VL710R:** For each order line, the program calls `VL710R` to retrieve extended item information, including item type and (in later versions) additional attributes relevant for the building materials business.

---

## File Relationships

- **sstal1:** Sales statistics (input)
- **foheld:** Order header (input)
- **fodtl1:** Order lines/details (input)
- **vvarl1:** Item master (input, for item type and attributes)
- **votylr:** Order type master (input, for order type processing code)
- **ra09l1:** Salesperson master (input, for sales rep name)
- **lwo2lu:** Monitoring log type 2 (output, update/insert/delete)
- **lwo3lu:** Monitoring log type 3 (output, update/insert/delete)

---

## Design Decisions and Conventions

- **Modularization:** The program is organized using subroutines for major tasks (reading statistics/orders, logging, salesperson lookup).
- **Key Lists:** Keys for file access are defined in the *INZSR subroutine for maintainability and clarity.
- **Data Consistency:** Before processing, all monitoring records for the target date are deleted to ensure that only current anomalies are logged.
- **Externalization:** Item type and related logic are externalized to the `VL710R` program, supporting business rules that may change independently of this program.
- **Code Maintenance:** The code includes extensive versioning comments and change history, reflecting ongoing adaptation to business needs (e.g., support for extended item numbers, new product groups, etc.).
- **Business Rules:** The logic for identifying anomalies is tightly coupled to business definitions (e.g., what constitutes a special order item, what is considered missing delivery date).

---

## Notable Patterns

- **READE/SETLL Loops:** Used for efficient keyed reads of files with possible multiple records per key.
- **Conditional Logging:** Only logs anomalies that match strict business criteria, minimizing noise in monitoring files.
- **Separation of Concerns:** Logging for type 2 and type 3 anomalies is handled separately, reflecting their different business meanings.

---

## Integration Points

- **VL710R:** Must be kept in sync with this program regarding the parameters and returned data structure.
- **Monitoring files (`lwo2lu`, `lwo3lu`):** These are likely consumed by downstream reporting or alerting processes.

---

## Summary Table: Monitoring Types

| Type | Criteria                                                                                    | Output File |
|------|--------------------------------------------------------------------------------------------|-------------|
| 2    | Sale of special order items (item type 'S') with no linked purchase order                   | lwo2lu      |
| 3    | Orders (lines or headers) without a delivery date (both header and line)                    | lwo3lu      |

---

## Maintenance Notes

- **Adding New Anomaly Types:** Extend with new output files and logging subroutines as per business requirements.
- **Changing Business Rules:** Update selection criteria in the relevant subroutines.
- **File Layout Changes:** If file keys or fields change, update key lists and field references accordingly.
- **External Program Changes:** If `VL710R` is modified, ensure parameter lists remain compatible.

---

## Subroutine Reference

- **les_sstat:** Process sales statistics, log type 2 anomalies.
- **les_ordre:** Process orders, log type 2 (order lines) and type 3 (order lines and headers) anomalies.
- **skriv_logg:** Log or update type 2 anomalies in `lwo2lu`.
- **skriv_logg3:** Log or update type 3 anomalies in `lwo3lu`.
- **les_selg:** Lookup sales rep name for contextual logging.
- **INZSR:** Initialize keys, input parameters, and working variables.

---

## Special Considerations

- **Language/Localization:** Some comments and field names are in Norwegian (e.g., "lev.dato" = delivery date, "skaffevare" = special order item).
- **Version Control:** The program header contains detailed change tracking; refer to this for understanding recent modifications and business context.

---

## Conclusion

MO701R is a critical monitoring tool for operational integrity in sales and order management, ensuring that exceptions such as unlinked special orders and orders missing delivery dates are identified and logged for follow-up. The program is tightly integrated with master data and external logic, and its design reflects both performance and maintainability considerations.