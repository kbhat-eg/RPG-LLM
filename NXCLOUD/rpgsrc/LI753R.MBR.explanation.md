```markdown
# Program LI753R – Payment Transactions for PowerOfficeGO

## 1. Overview
This ILE RPG program reads incoming invoice‐transactions from the file **WEFPF**, parses each “EDxx” record segment, and generates corresponding payment postings for PowerOfficeGO in the file **IPOGST**. It also writes audit/log records into SQL tables.

## 2. File Declarations
- **WEFPF** (input, keyed-disk)  
- **IPOGST** (output, keyed-disk) — renamed internally as `IPOGSTR`.

## 3. LDA & Parameters
- **LDA** fields for user, file group, firm number.  
- One parameter `P_FAKL` (invoice number, length 13) passed on program entry.

## 4. Working Variables
- Control flags:  
  - `B_SJEK` – “should we process a new invoice?”  
  - `B_FAKL` – “are we inside an invoice?”  
  - `U_REMF` – “disable remittance flag?”  
- Invoice context:  
  - `W_LFAKNR` – invoice number  
  - `W_DEKR` – Debit/Credit indicator  
  - `W_FLEV`, `W_VLEV` – creditor/debtor IDs  
  - `W_FADA`, `W_FFDA` – invoice date / due date  
  - `W_SUMT` – invoice total, numeric  
- Posting context:  
  - `W_BILN`, `W_BILK`, `W_BILT` – voucher number, code, text  
  - `W_BETB`, `W_BETF` – payment term code  
  - `W_LINTEL`, `W_LOGG` – logging sequence & timestamp  

## 5. Data Structures for ED Segments
For each ED record type (ED00 through ED27), there is a DS named `F_EDxx` that overlays the 80-char input record and exposes fields like:
- **ED01**: message header (sender, receiver, date/time, invoice number)  
- **ED04**: references (e.g. `PEPA04` = invoice reference)  
- **ED05**: party info (identifies the invoiced party)  
- … through  
- **ED25**: invoice totals (parses string into numeric `W_HELN`, `W_DESM`, `W_SUMT`)  

## 6. External Program Call
At start, the *ENTRY subroutine calls:
```
CALLP CO402R( FILEGROUP, FIRM, 0, 'POWOFF_REM_AV', VERDI1, VERDI2 );
```
to read a configuration value that determines if remittance (`U_REMF`) is disabled.

## 7. SQL Environment Setup
An embedded SQL block sets ISO date formats and language options. Subsequent subroutines use embedded SQL to:
- Fetch vendor (`RLEVPF`) and payment terms (`RA03PF`).  
- Insert log records into `RLODST`, `RLOBST`, `RLOHST`.

## 8. Initialization (*ENTRY)
- Initialize `W_TIME`, `W_DATE`, `W_FIRM` from LDA.  
- Obtain `U_REMF` flag via **CO402R** call.

## 9. Main Loop
1. **READ** WEFPF into the 80-char buffer.  
2. Loop until `%EOF`:  
   - Extract `W_RECT = %SUBST(faklin:1:4)` – the ED record type.  
   - If inside an invoice (`B_FAKL on`) or `B_SJEK = *off`, proceed.  
   - **SELECT / WHEN** on `W_RECT = 'ED01'`, `'ED02'`, … `'ED27'`:  
     - **EXSR** the corresponding subroutine `ED01`–`ED27`.  
   - **READ** next record.

## 10. EDxx Subroutines
- **ED01** (Header):  
  - If a previous invoice was open, finish it (`hent_bilnum`, `POSTERING`), clear `B_SJEK`.  
  - Store header fields (e.g. debit/credit indicator, invoice number).
- **ED02..ED03** (Date, free text): currently placeholders.  
- **ED04** (Reference): when record code `PQ `, capture customer KID (ID) number.  
- **ED05** (Party):  
  - On party qualifier `II ` and matching invoice number:  
    - Call `HENT_LEV` to fetch vendor terms; set `B_FAKL = *on`.  
  - On `SU ` qualifier (ship‐to): set `W_VLEV`.  
- **ED06..ED24**: placeholders for other segments.  
- **ED25** (Totals): parse total line string into numeric total (`W_SUMT`).  
- **ED26..ED27**: placeholders.

## 11. Fetch Vendor & Payment Terms
- **HENT_LEV**  
  - SQL `SELECT RLLEVR, RLBETB` into `W_LDOR`, `W_BETB` from `RLEVPF`.  
- **HENT_BET**  
  - SQL `SELECT RACDA1, RACDAG` into `W_DAGR`, `W_DAGK` from `RA03PF`.  
- Both subroutines zero out on SQL error or “no data”.

## 12. Posting & Output
When an invoice is complete (or at program end) **POSTERING** is called:
1. Prepare header fields (`IIFIRM`, `IIBILN`, `IIBDAT`, `IIFDAT`, `IIBILK`, `IITEXT`, etc.).  
2. Write two lines to IPOGST:
   - **SKRIV_DEB** — the debit side, with `IIDKTO` = account number, `IIBELP` = amount.  
   - **SKRIV_KRE** — the credit side, negative amount.  
3. Optionally set `IIREMI = 'JA '` or `'NEI'` based on `U_REMF`.

## 13. Logging
- **LOGG_LINJER** (free-form): inserts each line into `RLODST`.  
- **LOGG_BILAG**: summarizes per‐voucher data into `RLOBST` via an `INSERT … SELECT GROUP BY`.  
- **LOGG_HODE**: summarizes total amount into `RLOHST`.

## 14. Voucher Number Retrieval
- **HENT_BILNUM**: calls the external module `AS100R` to obtain the next voucher number, passing firm, journal (“FBILAG”), type (“PO”), etc.

## 15. Program End
- After final invoice and logging, set `*INLR = *ON` and `RETURN`.

---

*By following the EDxx dispatch model, this program cleanly separates the parsing of each invoice segment from the posting and logging logic, making it easier to maintain or extend for additional ED segments in the future.*