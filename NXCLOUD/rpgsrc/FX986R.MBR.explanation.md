## Program Overview

### Purpose

This program (`FX986R`) is a batch utility for the ASOFAK system. Its main function is to process all records in the `FODTPF` file (order line file), specifically reading from a logical file (`fodtl1`) and updating another logical file (`fodtlu`) when certain problematic special characters are found in text fields. The program replaces these special characters and updates the affected records.

### Business Context

- **FODTPF** is the order line file. It contains detailed information about order lines, such as firm number, order number, suffix, line number, and two text fields (`fdtek1`, `fdtek2`).
- The need for this program arises from special characters (specifically hexadecimal `x'1C'`) in text fields that cause issues in downstream processes or systems. The program sanitizes these fields by replacing the problematic character with a space.

---

## File Definitions

```rpg
ffodtlu    uf   e           k disk    rename(fodtpfr:fodtlur)
f                                     prefix(xx:2)
ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
```
- **fodtlu**: Update-capable logical file over `FODTPF`, renamed as `fodtlur` in this program, with all fields prefixed by `xx` to avoid naming conflicts.
- **fodtl1**: Input-only logical file over `FODTPF`, renamed as `fodtl1r`.

### Design Note

The use of two logical files over the same physical file allows the program to read (`fodtl1`) and update (`fodtlu`) the same underlying data without record lock conflicts or field name ambiguity.

---

## Data Definitions

- **UDS Local Data Area**: Used for temporary storage of key fields.
- **Work Variables**: Used to store original and potentially modified values of the text fields and key fields for lookup and update operations.
- **`b_oppd`**: Flag indicating whether an update is to be performed on the current record.

---

## Main Loop Logic

### Record Processing

1. **Read Loop**: Reads all records from `fodtl1`.
2. **Backup Original Text**: Stores original `fdtek1` and `fdtek2` into work variables.
3. **Character Translation**: Replaces all occurrences of `x'1C'` in both text fields with a space using `XLATE`.
4. **Change Detection**: If either text field was changed, proceeds to update.
5. **Key Preparation**: Prepares the full key (firm, number, suffix, line) for the update.
6. **CHAIN to fodtlu**: Locates the corresponding record in `fodtlu` using the key.
7. **Update**: If found, updates the text fields in `fodtlu` (using the `xx`-prefixed fields) with the sanitized values.
8. **Repeat**: Continues until all records are processed.

### Subroutine: Key List (`fodtlu_key`)

Defines the key fields for accessing `fodtlu`:
- `w_firm`, `w_numm`, `w_suff`, `w_line`

---

## Notable Patterns and Conventions

- **Field Prefixing**: The use of `prefix(xx:2)` on `fodtlu` ensures that updates are performed on the correct fields and avoids accidental overwriting of input fields.
- **Separate Work Variables**: Original and potentially changed values are kept distinct to facilitate change detection and correct update logic.
- **Batch Update Pattern**: The program reads from one logical file and updates via another, a common pattern for mass data corrections in IBM i environments.

---

## Interactions and Dependencies

- **FODTPF**: All operations ultimately affect this physical file via its logical views.
- **Other Modules**: No explicit API or external module calls; the program is self-contained but relies on the integrity and structure of the `FODTPF` file and its logicals.

---

## Error Handling

- **Record Not Found**: If the record is not found in `fodtlu` during the update attempt, the program silently skips the update (no error or logging).
- **No Logging or Reporting**: The program does not report which records were changed or skipped.

---

## Business-Specific Logic

- **Special Character Replacement**: Only the `x'1C'` character is targeted for replacement, reflecting a specific business or integration requirement.
- **Text Fields Only**: Only `fdtek1` and `fdtek2` are sanitized; other fields are not touched.

---

## Change History

- **Initial Creation**: 2018-03-19 by BKV.
- **Price Group Extension**: 2021-06-22 by `bof`, but this logic is not present in the provided code, possibly a reference to another part of the system.

---

## Summary

This batch program is a targeted data cleansing utility for order line text fields in the ASOFAK system. It systematically removes problematic special characters from two text fields across all records, updating only those that require changes. The design uses logical files and field prefixing to safely perform in-place updates while ensuring data integrity. The program is intended to be run as needed to maintain data quality for downstream processes.