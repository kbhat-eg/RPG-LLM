# IBM ILE RPG Source Code Explanation

This is a classic ILE RPG (RPG IV) program focused on maintenance of customer groups (`Kundegrupper, vedlikehold`). It follows the traditional interactive model using subfiles and workstn (display) files, and is tailored to handle display and update logic for customer group master data.

Below is an explanation of the key program components, overall logic flow, and significant details.

---

## High-Level Program Structure

- **Header Section:** The program header (`H`) sets up options and date editing style.
- **File Declarations:** Database and display files, including subfiles.
- **Data Definitions:** Local fields, constants, indicators, keys, and variables.
- **Main Logic and Subroutines:** Processing display screens, handling function keys, subfile logic, CRUD operations, navigation.
- **Comments:** The source is well-documented with comments describing logic, subroutine purpose, and indicator usage.

---

## 1. File Declarations

```rpg
fra32l2    if   e           k disk    rename(ra32pfr:ra32l2r)
fra32l1    if   e           k disk    rename(ra32pfr:ra32l1r)
fra32lr    if   e           k disk    rename(ra32pfr:ra32lrr)
fra32lu    uf a e           k disk    rename(ra32pfr:ra32lur)

fra132d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- **Physical/Logical Files:** `fra32l2`, `fra32l1`, `fra32lr`, `fra32lu` are (typically) logical files built over a customer group master file.
- **Display File:** `fra132d` is the display file. It uses a subfile (`b1sfl`) with a display-relative record number (`w_srrn`).

---

## 2. Data and Indicator Usage

- **Local Data Area (LDA):** Used for user info, firm/company code, etc.
- **Work Variables:** Used for subfile record counting, current record, keys, selection flags, etc.
- **Indicators:**  
  - `LR`: Last record, to end the program.
  - `10-15, 21-22, 30, 31-99`: Control screen navigation, subfile handling, and error/working states.
- **Subfile Fields (`w_*`):** Used to manage page size, record numbers, active fields for cursor, etc.
- **Constants:**  
  - `c_sfil` (14): Subfile page size.

---

## 3. Main Processing Loop

- **Main Tags and Control:** Uses program labels/tags (`b2taga`, `b2tagb`, `avslutt`, etc.) for looping and navigation.
- **Screen/Function Key Handling:**  
  - Function keys (e.g., Roll up, Roll down, Home, Add) are processed in `SELECT/WHEN` blocks.
  - Subfile screens are displayed, records validated, updated, or deleted.

---

## 4. CRUD Operations Using Subroutines

The program is organized into subroutines (`begsr/endsr`) for discrete responsibilities:

### a. `forny`
- Refreshes the subfile from the database after a change.

### b. `posisjoner`
- Sets up the subfile for positioning, using either key code or description.

### c. `subfile`
- Main subfile processing loop:
  - Reads and processes lines in the subfile based on user selection (edit, copy, delete, view).
  - Invokes further subroutines as needed for each action.

### d. `xc1bld` / `xc1msg` / `xc2bld` / `xd1win` / `xk1win`
- Handlers for "new row", messages, edit/view, delete, and copy actions.
- `xc1bld`: New entry screen; checks for duplicates.
- `xc1msg`: Message screen when duplicate found.
- `xc2bld`: Edit/view screen, including input validation, DB write/update.
- `xd1win`: Delete screen, deletes if confirmed.
- `xk1win`: Copy handler, checks destination doesn't exist, copies data.

### e. Subfile Utility Routines

- `clr_subfile`: Blanks/clears the subfile before refill.
- `crt_subfile`: Reads records to fill up the subfile, handling paging.
- `bck_subfile`: Reads records backward for subfile paging.
- `dsp_subfile`: Shows the subfile control screen.

---

## 5. Initialization Subroutine (`*inzsr`)

- Sets up key lists for DB operations.
- Gets the current firm code from LDA, positions to beginning.
- Clears and fills the subfile with initial data.

---

## 6. Keylists

Keylists (`klist/kfld`) are used for database access:
- By firm + group code.
- By firm + description.

---

## 7. Subfile Paging and Navigation

- Subfile page size is 14.
- Variables track current, first, and last record numbers in the subfile.
- Navigation routines (`crt_subfile`, `bck_subfile`, etc.) manage forward and backward paging in the subfile.

---

## 8. Function Key Assignments (Examples)

- `*INKC`: F3=Exit
- `*INKL`: F12=Cancel
- `*IN10`: Rollup (Page down)
- `*IN11`: Rolldown (Page up)
- `*IN21`: Home
- `*IN22`: Cursor placement
- `*IN30`: Field protection
- `*IN31-*IN79`: Error and warning messages

---

## Summary Table

| Section         | Purpose                                                |
|-----------------|--------------------------------------------------------|
| File Decls      | Logical/physical DB files, display/subfile             |
| Data Decls      | User/firm info, keys, subfile navigation               |
| Main Loop       | Handles screen, user commands, dispatches subroutines  |
| Subroutines     | CRUD: new, edit, delete, copy, message, subfile util   |
| Initialization  | Setup keys, LDA, initial DB/subfile state              |
| Paging          | Subfile reading, forward/backward navigation           |
| Keys & Errors   | Indicator-driven for control and error feedback        |
| Comments        | Extensive, for maintainability and onboarding          |

---

## Key Takeaways for Developers

- **Subfile-based UI:** The main UI is based on a subfile, with paging and record selection logic.
- **Function Key Driven:** User navigation and actions are controlled primarily by function keys and indicators.
- **CRUD Logic Modularized:** Each customer group maintenance action is encapsulated in its own subroutine.
- **Error Handling:** Prevents duplicate keys, validates input fields, and gives feedback via messages and indicators.
- **Paging:** Supports forward/backward navigation in subfile lists.
- **LDA Usage:** Uses the Local Data Area for session/user context.
- **Code is Commented:** Norwegian comments and indicator documentation aid understanding and hand-over.

---

**Tip:**  
If you're new to RPG or subfiles, focus initially on how the "subfile control" and "subfile record" formats interact, how indicators control subfile display/clear, and how database keys are built and used for record access. Refer to the display file (`fra132d`) and its DDS for full UI understanding.