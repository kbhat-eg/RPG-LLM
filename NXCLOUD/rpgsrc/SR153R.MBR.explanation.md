# Documentation: Program SR153R (ASSTAT System) â€“ "Utvalg Lager"

## Overview

This program, `SR153R`, is a maintenance and selection utility for a "Utvalg Lager" (Selection Store) within the ASSTAT system. It provides a subfile-based interactive interface for users to view, create, update, and delete entries in a selection table, filtered by business-specific keys (such as company, type, and code). The program is designed for use in a work station environment and interacts with several database files and display files.

---

## Key Business Concepts

- **Utvalg Lager**: A selection or lookup table, likely representing codes or options used elsewhere in the business system.
- **Company Context**: All operations are performed within the context of a specific company (`w_firm`), which is fetched from the Local Data Area (LDA).
- **Type/Code**: The selection entries are further filtered by type (`wptype`) and code (`wpkode`), which are parameters to the program and set at initialization.

---

## File Interactions

- **SR153d**: Display file, with subfile support (`b1sfl:w_srrn`).
- **SLPML1**: Primary selection file (logical file), used for reading and populating the subfile.
- **SLPMLR**: Used for reading existing entries (e.g., for validation or display).
- **SLPMLU**: Used for updating/writing entries.
- **RA10PF**: Lookup file for validating codes and retrieving descriptive text.

All file access is keyed by company, type, code, and value.

---

## Program Structure

### Initialization (`*inzsr`)

- Sets up key lists for all files.
- Retrieves program parameters (`wptype`, `wptext`) for type and description.
- Sets default code (`wpkode = 53`), possibly a business default.
- Reads the company number from the LDA.
- Positions the selection file and populates the subfile with matching entries.

### Main Loop

The program runs a main loop that alternates between displaying the subfile and processing user input:

- **Display Subfile**: Shows a paged subfile of selection entries.
- **Function Key Processing**: Handles actions such as create, update, delete, and navigation.
- **Positioning**: Allows the user to position the subfile to a specific key value.
- **Subfile Control**: Handles create and delete operations via subfile control fields.

### Subroutines

#### Subfile Management

- **`clr_subfile`**: Clears the subfile and resets counters.
- **`crt_subfile`**: Reads entries from SLPML1 matching the current filters and populates the subfile, paginating as needed.
- **`dsp_subfile`**: Handles display logic, including setting indicators for empty/full subfiles.

#### Entry Operations

- **`xc1bld`**: Handles the screen for creating a new entry. Validates for duplicates and existence in RA10PF, then calls `xc2bld` to register.
- **`xc1msg`**: Informs the user if an entry already exists when trying to create.
- **`xc2bld`**: Handles the screen for viewing/changing an entry. Updates or writes to SLPMLU.
- **`xd1win`**: Handles the delete confirmation screen and deletes the entry from SLPMLU if confirmed.

#### Subfile Navigation

- **`forny`**: Refreshes the subfile (clear and recreate).
- **`posisjoner`**: Positions the subfile at a given key value, then refreshes.
- **`control`**: Processes subfile control actions (create/delete), including validation.

#### Subfile Row Processing

- **`subfile`**: Processes user actions on subfile rows, such as deleting individual entries.

---

## Notable Design Decisions and Conventions

- **Subfile Paging**: The subfile is paged in increments of 12 (`c_sfil`), with logic to maintain current and visible row numbers for smooth navigation.
- **Indicator Usage**: Standard IBM indicators are used extensively for function key handling and display logic.
- **Key List Usage**: All file access is performed via named key lists, ensuring consistency and clarity.
- **Separation of Concerns**: Each major operation (create, update, delete, display) is encapsulated in a dedicated subroutine, simplifying maintenance and onboarding.
- **Validation**: All create and delete operations are validated for existence and business rules before being performed.
- **LDA for Company Context**: The company number is sourced from the Local Data Area, enforcing company-level data isolation.

---

## Interactions with Other Modules

- **RA510R**: Called from the create screen as a lookup/validation routine for codes.
- **RA10PF**: Used to validate that a code exists and to retrieve its description.

---

## Special Cases and Error Handling

- **Duplicate Entry Handling**: Attempts to create a duplicate entry prompt an informational message and allow the user to cancel.
- **Non-Existent Code Handling**: If a code does not exist in RA10PF, an error is shown and the user is prompted to re-enter.
- **Function Key Handling**: All relevant function keys (create, delete, exit, etc.) are handled with appropriate branching and indicator management.

---

## Business Rules and Domain-Specific Logic

- **Only entries matching the current company, type, and code are shown and manipulated.**
- **All create, update, and delete operations are performed at the company/type/code granularity.**
- **Code values must exist in the master code file (RA10PF) to be valid for creation.**
- **All changes are immediately reflected in the subfile after operation (refresh pattern).**

---

## Conventions and Patterns in This Codebase

- **Subfile pattern**: Standard IBM i subfile pattern with explicit clear, create, and display subroutines.
- **Keyed access**: All file operations use explicit key lists for clarity and maintainability.
- **Separation of UI and Business Logic**: Screen handling is separated from business rule processing.
- **Indicator-driven Flow**: Heavily uses indicators for both user input and internal state management.

---

## Summary

This program provides a robust, paged, subfile-driven maintenance interface for selection tables used elsewhere in the system, with comprehensive support for create, update, delete, and navigation, all within the context of a company and code type. It enforces business rules via validation against master tables and ensures data integrity through careful key management and error handling.

New developers should become familiar with the subfile pattern, the use of key lists, and the business meaning of the selection tables and their keys. Integration points with RA10PF and RA510R are critical for understanding validation and code lookup behavior.