# RPG Program RP801R - Project Report Printing

This program is part of the "ASOKON" system and is designed to produce a project report ("prosjektrapport") based on dynamic selection criteria. It supports different levels of filtering (by project, department, project manager, year-to-date, etc.) and summarises data by account postings.

Below is a structured, section-by-section explanation:

---

## 1. **Header & Program Metadata**

- `H datedit(*dmy)`: Sets date edit format (day/month/year).
- The `/TITLE` and comment block explain the purpose (printing project reports) and document the change history.
- Comments are in Norwegian.

---

## 2. **File Declarations**

- Input (`FRPRRL1`, `FRHTRLC`, etc.) and output (`FRP802P`) files are declared.
- Input files are database files, some use `RENAME` to map external to internal record formats.
- Output file is for printing the report.

---

## 3. **Variables and Data Structures**

- Arrays (`t`, `h`, `k`) for storing temporary and result values per report line/column.
- Local Data Area (LDA): workspace for runtime information from the environment.
- Working fields: for timestamp, company number, period, sums, line numbers, etc.
- Parameter fields for runtime input (report period, project, status, "hittil i prosjektet"/year-to-date, etc.).
- File key variables for indexed access.

---

## 4. **Mainline Logic**

### a. **Entry Point / Parameter Handling (`*ENTRY` and `*INZSR`)**

- Program parameters are received: start/end period, project(s), report, department, leader, status, etc.
- Sets up some working fields, converts and initializes periods, determines whether "year-to-date" applies.
- Reads company info from `afirl1` file.
- Sets up standard heading/metadata fields for output.

### b. **Selection Loop**

- Decides which projects to process:
    - If a single project is specified, go directly to `enkelt_prosj`.
    - If a range (by department/leader), loops through all relevant projects in `rp1plr`.
    - For each project, tests:
        - Company match
        - Status match (active, inactive, or those with postings only)
        - Project within range
        - Optional department, project leader filtering
    - For status 3 ("aktive m/posteringer"), checks if any postings exist in period.

- If the project passes checks, calls `behpro` subroutine to process it; otherwise, skips.
- After processing all, writes total summary line and exits.

### c. **Subroutine: Process a Project (`behpro`)**

- Reads all report lines for the selected report definition from `rprrl1`.
- For each line, calls `raplin` to process that line.

### d. **Subroutine: Process a Report Line (`raplin`)**

- Handles each report line:
    - If the line is a heading, store its text for the report columns.
    - For calculation lines, determines what to sum or calculate:
        - Account postings (`Poster`)
        - Arithmetic (`+`, `-`, `%`)
        - Budget values (`K`, `S`)
    - Results are stored in arrays (`t`, `h`, `k`) by column/line.
- If the line should be output, updates the corresponding summary array.

### e. **Subroutine: Posting Summation (`Poster`)**

- Reads all postings for the current project and account(s) over the defined period.
- Sums values for month/periode ("h") and selected period ("t").
- Handles special cases, e.g., reversing sign if required, filtering by sub-account range, limiting to current year if "hittil" requested.

### f. **Subroutine: ASCII Conversion (`KnvAscii`)**

- Converts project identifiers (possibly alphanumeric) to a sortable/integer form for looping/comparisons using hexadecimal mapping.
- Handles both case-sensitive characters and Norwegian-specific letters ("ÆØÅ").

### g. **Subroutine: Write Report Headings and Lines (`hode`, `nylin`, `avslutt`)**

- `hode`: Prints the report heading, fetches/report project leader name from `ilonl1` if given.
- `nylin`: Advances output line count, prints new heading if page overflow.
- `avslutt`: Writes the detailed project line, updates summary totals.

---

## 5. **Control Structures and Flow**

- Main loop built with tags and `goto` (traditional RPG style).
- Extensive use of `select/when` for branching within subroutines.
- End-of-file conditions checked with `%eof(file)` and `%found(file)`.

---

## 6. **Parameter Documentation**

Parameters received at entry:
- `p_dpf`, `p_dpt`: From/to period
- `p_prof`, `p_prot`: From/to project
- `p_rapp`: Report id
- `p_avdx`: Department
- `p_prox`: Project leader
- `p_sts`: Status filter (different modes)
- `p_hit`: "Hittil"/to-date flag (if only year-to-date is required)

---

## 7. **Special Features and Comments**

- Handles Norwegian characters and uses Norwegian comments.
- Flexible to allow extracting per-project, range, or by department/manager.
- Modular logic for coming years/periods and for detailed or summary output.
- Program is tailored for accounting/project tracking and is typical for reports on IBM i.

---

## 8. **Usage Scenarios**

- Print a single project report.
- Print summary or details for all projects belonging to a department, leader, or status, with optional period restrictions.
- Calculate and display budget, postings, and percentage metrics for detail and summary levels.

---

## 9. **Onboarding Guidance**

- **To modify:** Update file declarations and record mappings as per your files.
- **To add selection fields:** Enhance the parameter section and selection logic.
- **To change report output:** Update subroutines writing the detail and heading lines.
- **For debugging:** Use working fields (like `eval`) and conditional branches (e.g., `if rphlin = 40`) for setting breakpoints.

---

**In Summary:**  
This is a robust, flexible project report generator using classic RPG III/400 techniques. It pulls project, account, and posting data, filters it dynamically, supports different output formats, and prints a well-structured report with summary lines.

---

**Tip:** If you are new to RPG, focus on understanding the main program flow (project selection, line processing, posting summation), and how keys are built for indexed file reads. The use of arrays for temporary storage is a classic RPG pattern for accumulating results across lines and columns.