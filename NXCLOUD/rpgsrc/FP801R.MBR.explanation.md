# Documentation: FP801R – Order Entry, Report Printout

## Overview

**Program:** FP801R  
**System:** ASOFAK  
**Description:**  
This program is responsible for generating a report based on order entry data. It reads order header records, aggregates and summarizes by seller, and prints detailed and summarized information. The report is customizable via a complex parameter list, supporting selection on various attributes (e.g., seller, department, order types, info codes, date ranges).

## Business Context

- **Order Entry (Ordreinngang):**  
  The main function is to produce a report of orders, grouped and subtotaled by seller, within a given company and for selected criteria.
- **Reporting:**  
  Output is to a printer file (`fp801p`), and includes both detail and subtotal lines per seller, as well as a total summary.

## File Interactions

- **wohel9** (Order Header)  
  Main source of order data. Each record represents an order header.
- **ra09l1** (Seller Register)  
  Used to retrieve seller names for subtotal lines.
- **afirl1** (Company Register)  
  Used to retrieve company name for the report header.
- **rkunl1** (Customer Register)  
  Used to retrieve customer names for detail lines.
- **votyl1** (Order Type Register)  
  Used to determine the sign of order amounts, based on order type.

## Parameterization

The program is highly parameterized. It receives a 128-byte parameter list (`w_list`), broken down into a data structure (`d_list`) with overlays for each selection criterion:

- **d_firm:** Company number
- **d_hist:** Historical flag
- **d_selg:** Seller number (up to 4 digits)
- **d_avde:** Department
- **d_hot1..d_hot6:** Order header types (6 possible)
- **d_oot1..d_oot6:** Order order types (6 possible)
- **d_bot1..d_bot6:** Order bottom types (6 possible)
- **d_inf1..d_inf6:** Info codes (6 possible)
- **d_fdat, d_tdat:** Date range (from/to, ISO format)
- **d_sort, d_ityp, d_oiar, d_bong, d_hvlg, d_ovlg, d_bvlg, d_ivlg, d_dvlg:** Various selection and control flags

This design allows for significant flexibility in report generation, supporting multiple selection and grouping scenarios.

## Main Program Flow

1. **Initialization (`*inzsr`):**
   - Parses the parameter list and populates working variables and header fields.
   - Sets up keys for file access.
   - Retrieves company information for the report header.
   - Prepares to read the order header file (`wohel9`).

2. **Header Printout (`hode` subroutine):**
   - Sets timestamp, user, and workstation info.
   - Retrieves company name.
   - Writes the report header.

3. **Order Processing (`detalje_fohe` subroutine):**
   - Reads through `wohel9` (order headers) in key order (by company, seller, date).
   - For each record:
     - Checks for seller change (to trigger subtotal and reset).
     - Retrieves sign from order type (via `votyl1`), inverting amounts if necessary.
     - Calculates amounts: order sum, cost price, gross margin, and gross margin percent.
     - Aggregates subtotals (per seller) and totals (overall).
     - Retrieves customer name (via `rkunl1`).
     - Writes detail line.
     - Handles page overflow.

   - After all records:
     - Writes final subtotal and total summary.

4. **Subtotal Handling (`selg_brudd` subroutine):**
   - On seller change, retrieves seller name (via `ra09l1`).
   - Calculates and writes seller subtotal.
   - Resets seller subtotal accumulators.

5. **Overflow Handling (`overflow` subroutine):**
   - On page overflow, reprints the header.

## Design Decisions and Conventions

- **Data Structure Overlays:**  
  The parameter list is broken down using overlays, allowing for efficient passing and extraction of multiple selection criteria in a single parameter. This is a common pattern in legacy RPG, but requires careful maintenance if the parameter list changes.

- **File Prefixing:**  
  File fields are prefixed (e.g., `fo` for `wohel9`) to avoid name clashes and improve code clarity.

- **Key Lists:**  
  Key lists are defined for each logical file access, improving maintainability and enabling straightforward changes to file access patterns.

- **Subroutine Structure:**  
  The program is structured with clear subroutines for initialization, header printout, detail processing, subtotal handling, and overflow. This modularity aids readability and maintainability.

- **Error Handling:**  
  Most file accesses check the record-not-found indicator (`*in60`, `*in61`), and handle missing data gracefully (e.g., blanking names when not found).

- **Historical Comments:**  
  The code contains detailed change history, with version numbers and descriptions, which is valuable for understanding the evolution of the program and the business requirements.

## Relationships with Other Modules

- **Integration with Master Data:**  
  The program relies on up-to-date seller, company, customer, and order type master files. Any changes in those files' structures or business rules may impact this report.

- **Parameter List Origin:**  
  The parameter list (`w_list`) is likely constructed by a calling program or job submission interface, possibly a menu system or batch scheduler in the ASOFAK system.

## Special Considerations

- **Extensibility:**  
  The design supports easy extension for additional selection criteria, provided the parameter list and overlays are updated accordingly.

- **Localization:**  
  Variable and comment names are in Norwegian, reflecting the business context. Field names and business logic (e.g., "selger" for seller, "kunde" for customer) are domain-specific.

- **Legacy RPG IV Style:**  
  The code uses fixed-format RPG IV, which is consistent with the codebase’s age and the IBM i ecosystem, but may require adaptation for newer RPG free-format or modernization efforts.

## Summary Table: Key Files and Their Roles

| File      | Purpose                            | Key Fields Used                   |
|-----------|------------------------------------|-----------------------------------|
| wohel9    | Order header data                  | firm, selg, bdat                  |
| ra09l1    | Seller register (for names)        | firm, selg                        |
| afirl1    | Company register (for company name)| firm                              |
| rkunl1    | Customer register (for names)      | firm, kund                        |
| votyl1    | Order type register (for sign)     | firm, otyp                        |

## Conclusion

FP801R is a robust, parameter-driven reporting program for order entry data, supporting complex selection and grouping requirements. Its modular structure, extensive parameterization, and careful handling of business master data make it a flexible tool within the ASOFAK system. Understanding the parameter list structure and the relationships between files is key for effective maintenance and extension of this program.