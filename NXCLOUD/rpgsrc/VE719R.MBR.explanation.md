# Program Overview

This RPG program, VE719R, is designed to **retrieve a GTIN (Global Trade Item Number)** for a specific item, given the company (firma), item number (varenr), unit (enhet), and supplier (leverand√∏r). It returns the GTIN and a status code indicating success.

## High-Level Workflow

1. **Input Parameters**: Receives company, supplier, item, and unit.
2. **Lookups**: Checks several files/records in a prioritized order to find a valid GTIN.
3. **Output**: Sets GTIN and status code (success indicator).

---

## Key Files Referenced

- **vvarlr** (Product register)
- **vveplr** (Product unit register)
- **jvpkl1** (Product packaging/administration, referred to as "VA")
- **jlevl3** (Supplier in VA)

---

## Data Structures and Variables

### Input/Output Parameters

- `p_firm` (company)
- `p_ldor` (supplier)
- `p_vare` (item)
- `p_enhe` (unit)
- `p_eann` (GTIN output)
- `p_stat` (status output, 1 char)

### Working Variables

Variables are defined to build keys for file access or temporarily store field data.

---

## Main Logic Flow

### 1. Initialization

- Output params set to defaults (p_eann=0, p_stat=*blank).

### 2. Check If Item Exists

- Uses `vvarlr` (product register) to check if supplied item exists for the company.
- If not found, **exit program**.

### 3. Retrieve GTIN

#### a. 1st Attempt: GTIN by specific unit and supplier (`vveplr`)
- If a supplier is specified, search for a GTIN in `vveplr` using all input keys.
- If found and GTIN is non-zero, outputs GTIN and sets status to `'1'`.

#### b. 2nd Attempt: GTIN by unit only (`vveplr`)
- Regardless of supplier, loops through `vveplr` for the item/unit.
- If found (and GTIN is non-zero), outputs GTIN and sets status to `'1'`.

#### c. 3rd Attempt: GTIN from packaging/VA (`jvpkl1`)
- Searches in the VA tables for matching supplier and item.
- For each read, checks if the date is valid (using `sjekk_pkdato` subroutine).
- If found and GTIN is non-zero, outputs GTIN and sets status to `'2'`.

#### d. 4th Attempt: GTIN from VA, item only
- Searches `jvpkl1` by item only (no supplier constraint).
- If found with GTIN and matching unit, outputs GTIN and sets status to `'2'`.

### 4. Exit/Return

- Once GTIN is found (in any search), returns immediately.
- If not found in any lookup stage, outputs remain at default.

---

## Subroutines

### sjekk_pkdato (Check packaging date validity)
- Ensures the packaging record is valid for today's date.
- Considers various combinations of open/closed date ranges using *loval (lowest possible value) and system time.
- Sets flag `b_pakn` on/off to indicate validity.

### *inzsr (Initialization - called once at start)
- Accepts program parameters (plist).
- Builds key lists for file accesses (for chain/reade/setll operations).
- Preloads supplier data from `jlevl3` if needed.

---

## Key RPG Operations

- **CHAIN**: Random retrieval based on key.
- **SETLL**: Position file pointer to start of key area.
- **READE**: Read next record with same key fields.
- **DOW/IF/ENDIF**: Loop/conditional constructs.
- **LEAVESR**: Leaves a subroutine.
- **EVAL**: Assign values.
- **GOTO/GOTO TAG**: Jump for flow control (used for quick exit).

---

## Status Codes

- **'1'**: GTIN found directly by item/unit or with supplier in `vveplr`
- **'2'**: GTIN found via VA Packaging register (`jvpkl1`)
- *blank*: No GTIN found

---

## Comments and Version Notes

- The code is well-documented with version history and Norwegian comments.
- Updates include checks for packaging date validity and error-handling for supplier matching.

---

## Typical Usage

A calling program would supply:

- **Company, Supplier, Item, Unit**

and expect, as output:

- **GTIN** (if found)
- **Status code** (1/2/blank, as above)

---

## Summary Table

| Search Step | File    | Match on Supplier? | Match on Unit? | Status Code | Comments                       |
|-------------|---------|--------------------|----------------|-------------|-------------------------------|
| 1           | vveplr  | Yes                | Yes            | '1'         | Input supplier & unit         |
| 2           | vveplr  | No                 | Yes            | '1'         | Any supplier, match on unit   |
| 3           | jvpkl1  | Yes                | -              | '2'         | VA, supplier required, date valid |
| 4           | jvpkl1  | No                 | Yes            | '2'         | VA, any supplier, match unit  |

---

## Takeaway

- The program attempts to find a GTIN quickly and efficiently for an item, attempting the most restrictive (specific) matches first, and falling back to broader searches.
- Subroutines handle validation (date range).
- The structure supports easy future maintenance and extension, as shown by historical versioning.

---

**If you need to track or debug the logic, focus on the order of searches and the construction of the composite keys for lookups in each file.**