# Program Overview

This RPG/400 (ILE RPG) program processes and distributes account balances ("Fordeling utfra saldobalanse") from a balance file, posting corresponding entries into transaction and batch files. It runs on IBM i (AS/400) and is named `RH191R`. The code is annotated with historical changes, indicating ongoing maintenance.

The overall flow is:
1. Read balances from a "saldo-register" (`rhsal1`).
2. For each valid record, calculate the amount to be posted.
3. Post the transaction to an output file (`rtrapf`).
4. After all transactions, update the batch file (`rbunlu`).

---

## File Declarations

```rpg
frhsal1    if   e           k disk    rename(rhsapfr:rhsal1r)
frbunlu    uf a e           k disk    rename(rbunpfr:rbunlur)
frtrapf    o  a e             disk
```
- **rhsal1**: Input file for the saldo register, renamed as `rhsal1r` in this program.
- **rbunlu**: Update file for batches, renamed as `rbunlur`.
- **rtrapf**: Output file for transactions (postings).

---

## Data Structure Definitions

### Arrays

```rpg
d sal             s             15  2 dim(14)  // Monthly balances + 1
d txt             s             30    dim(1) ctdata perrcd(1)
```
- `sal`: Array of 14 balances (likely 12 months + 1 or 2 additional periods).
- `txt`: One-line constant text array, loaded from compile-time data.

### Work Variables

Defines numerous variables, including keys, amounts, user info, and batch counters. Examples:

```rpg
d l_user                911    920
d l_firm                944    946  0
...
d wwbiln          s                   like(rtbiln)
d wwbunt          s                   like(rsbunt)
...
d wwsist          s                   like(rssist)
```
- These track batch numbers, amounts, users, etc.

---

## File Field Mapping (Input Specifications)

```rpg
irhsal1r
i              risa01                      sal(01)
i              risa02                      sal(02)
...
i              risa00                      sal(14)
```
- Maps fields from `rhsal1r` (input file) to the `sal` array.

---

## Main Loop

```rpg
c     les           tag
...
c                   read      rhsal1                                 98
...
c                   if        *in98 = *on
c                   goto      slutt
c                   endif
...
c                   goto      les
```
- **Label `les`** is the main loop. It reads the next record from `rhsal1`; if end-of-file, it jumps to `slutt` (end).

---

## Record Filtering

Multiple checks ensure the current record is valid for processing:
- **Firma (Company) match**
- **Accounting year** (`riraar` matches `rhprår`)
- **Record type** (`ritype` equals 1)
- **Account number and department in target range** (between `rhpktf/rhpktt` and `rhpavf/rhpavt`)

If any condition fails, it skips to label `neste`, which jumps back to the next read.

---

## Posting Calculation

```rpg
c                   eval      rtbel� = 0
c                   move      rhppef        x
c                   dou       rhppet < x
c                   eval      rtbel� = rtbel� + sal(x)
c                   eval      x = x + 1
c                   enddo
```
- Sums balances (`sal(x)`) from period `rhppef` to `rhppet` into `rtbelø` (the amount to post).

---

## Skips Zero Amounts

```rpg
c                   if        rtbel� = *zero
c                   goto      neste
c                   endif
```
- If calculated amount is zero, skip record.

---

## Posting (Transaction Creation)

1. Increments batch/line counters.
2. Sets up fields for the posting (debit/credit side based on sign).
3. Moves company, batch, and line numbers, and various constants.
4. Moves text from the compile-time constant.
5. Sets posting amount, account, department, and more.
6. Writes the posting to the transaction file (`rtrapf`).

---

## End-of-Loop

After processing, it jumps back to `les` for the next record.

---

## Batch File Update (at end)

After all records are processed:
- Collects totals and batch summary info.
- Writes a batch control record (`rbunlu`).

---

## Initialization (*INZSR)

This subroutine runs at program start:
- Sets up program variables and batch numbers.
- Locates next available batch number by reading the batch file backwards (`readp`). If none, starts at 1.
- Sets keys for reading saldo records.

---

## Key Lists

Defines key fields for various indexed access patterns, e.g.:
- `rikey`: For saldo register access
- `keybun`: For batch file access

---

## Business Rules & Logic

- Posting amounts are summed from specific periods within the balance array.
- Positive and negative balances are posted to debit and credit sides, respectively.
- Many fields are initialized to zeros or blanks for each posting.
- Special handling for certain versions and fields (see comments with version numbers).

---

## Comments & Versioning

Detailed header explains purpose, history, and responsibilities.

---

## Summary

**This program takes opening balances, filters and distributes these based on given criteria, and posts each as a transaction, accumulating batch totals. It ensures that only relevant and non-zero balances become postings. Batch control records are kept in sync. Initialization and key handling is robust and clearly structured.** 

---

## Onboarding Tips

- **Understand the data files (rhsal1, rbunlu, rtrapf)**: Their layout is central.
- **Follow the tags and labels**: Program flow uses `goto` and tags heavily.
- **Period/amount logic**: The posting logic centers on which periods to sum.
- **Batch management**: Look at how batch numbers are calculated and stored.
- **Customizations**: Pay attention to maintenance comments (e.g., R6.20).

---

## Visualized Main Processing Loop

```plaintext
START
↓
Initialize (*INZSR)
↓
Read saldo record
↓
Apply filters:
   - Company
   - Year
   - Record type
   - Account/department range
↓
If not valid → skip to next
Else:
   Calculate amount (sum periods)
   If zero → next
   Else:
      Post transaction (debit/credit based on sign)
      Accumulate batch totals
↓
Repeat until end of file
↓
Write batch record
↓
END
```