## Program Overview

**System:** NXCLOUD  
**Program:** PM500R  
**Description:** Profile Inquiry (Profiler - spørring)  
**Purpose:**  
This program provides an interactive subfile-based inquiry interface for “profiles” (likely user or business profiles) stored in the `PROMIR` file. Users can page through, select, and position on records using function keys. The program uses standard IBM i subfile patterns for display and navigation.

---

## File Definitions and Relationships

- **PROMIR (promst:promirr):**  
  Physical file containing profile records. Accessed via keyed operations, likely using member and key fields.
- **PM500D (workstn, SFILE):**  
  Display file with subfile support.  
  - Subfile: `B1SFL`
  - Control record: `B2CTL`
  - Command screen: `B2CMD`

---

## Key Data Structures and Variables

### Indicators

- **LR:** Program end
- **10/11:** Roll/Roll-down (paging)
- **12/13:** Subfile display/control
- **14/15:** Subfile clear/end
- **21/22:** Home key / Cursor placement
- **30:** Protect fields on view
- **31-79:** Error/message indicators
- **80-99:** Work indicators

### Parameters

- `p_memb`: Profile member (key)
- `p_pmtx`: Matrix or profile type (key)
- `p_noit`: Numeric identifier

### Subfile Paging Variables

- `w_stel`: Subfile record counter
- `w_spge`: Subfile page size (records per page)
- `w_srrn`: Relative record number in subfile
- `w_sfrn`: First record number on page
- `w_ssrn`: Last record number on page
- `w_virn`: Current page/record to display
- `b_valg_ok`: Selection made indicator

### Constants

- `c_sfil`: Subfile page size (initialized to 9)

---

## Display File (PM500D) Structure

- **B1SFL:** Subfile record format (shown per row)
- **B2CTL:** Subfile control (header, page controls)
- **B2CMD:** Command line screen (for function keys and navigation)

---

## Program Flow and Main Logic

### Initialization (`*inzsr`)

- Receives parameters for member, profile type, and identifier.
- Initializes the key for positioning in `PROMIR`.
- Sets the cursor placement indicator.
- Positions the database to the first relevant record using `SETLL`.
- Fills the subfile with the first page of records via `crt_subfile`.

---

### Main Loop

- Alternates between writing the command screen and displaying the subfile.
- Handles function keys for navigation and selection:
    - **Exit (F3/F12):** Goto program end.
    - **Refresh (F5):** Calls `forny` to refresh subfile.
    - **Roll Up (F10):** Calls `crt_subfile` for next page.
    - **Roll Down (F11):** Calls `bck_subfile` for previous page.
    - **Home (F21):** Sets cursor placement.
- Calls `subfile` subroutine to process user selections.
- If a selection is made (`b_valg_ok`), program ends.

---

### Subroutines

#### 1. `forny` (Refresh Subfile)
- Optionally positions to the start of the subfile page.
- Clears and recreates the subfile contents.

#### 2. `posisjoner` (Positioning)
- (Commented out: support for positioning by district code)
- Clears and recreates the subfile based on positioning.

#### 3. `subfile` (Process Subfile)
- Toggles cursor placement indicator.
- Reads through the subfile records (using `READC`).
- If user selects a record (`b1valg = 1`), sets output parameters and exits.

#### 4. `clr_subfile` (Clear Subfile)
- Sets the subfile clear indicator, writes the control record, and resets counters.

#### 5. `crt_subfile` (Create/Fill Subfile)
- Increments page size and record number.
- Loops to read and write subfile records up to the page limit.
- Handles end-of-file/record conditions.
- Updates subfile counters.

#### 6. `bck_subfile` (Back Page)
- If at end of file, positions to previous records.
- Reads back a page of records.
- Clears and refills the subfile with new page.

#### 7. `dsp_subfile` (Display Subfile)
- If records exist, sets display indicator and shows subfile control.
- Otherwise, writes the command screen.
- Waits for user input.

---

## Business/Domain-Specific Logic

- The program is used for profile inquiries, where users can navigate, page, and select profile records.
- The subfile pattern allows for efficient paging and selection in large datasets.
- Indicators and display file conventions follow standard IBM i subfile design.
- Parameters and key fields suggest the program is called from other modules, passing in context for which profiles to display.

---

## Notable Design Decisions & Patterns

- **Subfile Paging:**  
  Uses a fixed page size (`c_sfil = 9`) and maintains explicit counters for current, first, and last record numbers.
- **Function Key Handling:**  
  Uses a `SELECT` block for clarity, mapping each function key to a specific subroutine or action.
- **Separation of Concerns:**  
  Each subfile operation (clear, create, back page, display) is encapsulated in its own subroutine for maintainability.
- **Commented-Out Logic:**  
  The code contains commented-out sections for additional positioning by “district,” suggesting extensibility for future requirements.
- **Indicator Usage:**  
  Follows a disciplined indicator convention, which is critical for subfile and display file management in RPG.

---

## Integration Points

- **PROMIR File:**  
  Central data source for profiles. Accessed with keyed operations.
- **Display File (PM500D):**  
  Provides the user interface for subfile display, navigation, and selection.
- **External Calls:**  
  The program is designed to be called with parameters, indicating integration with other business modules or menus.

---

## Summary

PM500R is a classic IBM i subfile inquiry program for profile records. It provides efficient paging, navigation, and selection mechanisms, leveraging RPG subfile best practices. The code is modular, with clear separation of display, data, and control logic, and is structured to be extensible for additional positioning or filtering requirements. The business logic is centered around interactive inquiry and selection of profile records, with integration points for upstream modules and user interface controls.