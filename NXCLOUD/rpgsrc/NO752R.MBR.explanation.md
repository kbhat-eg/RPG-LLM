```markdown
# RPG Program Explanation: NO752R

## Overview

This RPG program (`NO752R`) is designed to import order header and order line data from a CSV file (exported from SmartKalk), enrich it with customer and project information from internal files, and write it into new "external order" files on the IBM iSeries (AS/400). Its main functions are:

- Clearing a work file.
- Importing a CSV file using a CL program.
- Creating an order header in the database.
- Creating one or more order lines, with data extracted and parsed from the CSV file.
- Enriching data by looking up customer, project, and item information.
- Handling errors and initialization.

Most field names and comments are in Norwegian (e.g., "kunde" for customer, "prosjekt" for project, "ordre" for order).

---

## File Definitions (`F-specs`)

```rpg
fneowpf    if   e           k disk    rename(neowpfr:neowpfr)
...
```
These are files the program interacts with. Notable ones:
- `neowpf`: Work file for imported CSV data.
- `fstsl1`, `rkunl1`, `fkprlr`, `nkeol1`, `fenklr`: Master data files (status, customer, project, etc.).
- `nohelu`, `nodtlu`: Target output files for order header (`nohelu`) and order lines (`nodtlu`).

---

## Data Definitions (`D-specs`)

There are three major types of variables defined:  
- **Parameter variables** (`p_*`): Passed to the program (company, customer, project, file path, etc.).
- **Working variables** (`w_*`): Used for parsing and processing data.
- **Key variables**: Used for chained file access to retrieve records.

Examples:
- `w_firm`, `p_firm`: Company number.
- `w_line`: Line sequence number.

Constants like `Lo` and `Up` are character sets for lowercase and uppercase Norwegian characters.

---

## Main Program Flow (`C-specs`)

### 1. Initialization
- Sets system identifier (`w_fsys` = 'SKC').
- Sets error indicator (`p_feil` = *off).

### 2. Clear Work File

```rpg
/exec sql
+ delete from neowpf
/end-exec
```
Clears out previous import data.

### 3. Call CL Program to Import CSV

```rpg
call 'NO752C'
parm p_mapp
parm p_file
parm p_feil
```
Imports the SmartKalk file. Aborts if `p_feil` is turned on.

### 4. Create Order Header

```rpg
exsr ordre_hode
```
Creates and writes an order header record.
If error occurs, aborts.

### 5. Loop Through Imported Data and Create Order Lines

```rpg
eval w_line = 0
read neowpf
dow not %eof
  eval w_prec = nwirad
  ...
  if w_head <> 'PROSJEKTNR'
    exsr ordre_linje
  endif
  read neowpf
enddo
```
- Loops over lines in the imported work file.
- Calls `ordre_linje` subroutine to process and write each line.

---

## Subroutines

### `ordre_hode` - Creates the Order Header

- Gathers company, customer, and project info using keys (`chain`).
- Writes order header to `nohelu`.
- Generates order/order number by calling another program (`AS100R`).

### `ordre_linje` - Creates an Order Line

- Calls `linje_red` to parse and extract data from the CSV line.
- Calls `log_vare` to look up a logistic item number if available.
- Clears and fills the order line record.
- Writes it to `nodtlu`.

### `linje_red` - Parses CSV Line Data

- Steps through the CSV using `;` as delimiter.
- Extracts columns in order: project, item number, description, spec1, spec2, quantity, amount, unit, price, total, delivery date, (skips unused), and finally load number.
- Each field is parsed using `%scan` and `%subst`.

### `log_vare` - Looks Up Logistics Item

- If possible, translates item number to a logistics item number via an SQL select.

### Error Handling (`*pssr`)

- Sets error flag (`p_feil = *on`) and exits via `goto avslutt`.

### Initialization (`*inzsr`)

- Receives parameters and establishes key lists for file access.

---

## Key Technical Concepts

- **File I/O:** Uses traditional RPG file handling (`chain`, `read`, `write`) and SQL for some lookups.
- **Subroutines:** Central tasks broken into reusable subroutines (`begsr`/`endsr`).
- **String Parsing:** Uses `%scan` and `%subst` to parse semicolon-separated CSV lines.
- **Extensible/Configurable:** By changing key lists and record layouts, it's ready for various master data.
- **Error Handling:** Uses indicators (`p_feil`) and a global error subroutine.

---

## Summary

This program acts as an ETL (Extract, Transform, Load) tool mapping SmartKalk (external) order data into the company's own order files, enriching the data as it goes. The code is organized in a classic RPG style, with key logic broken into subroutines for maintainability. It leverages both classic file access and embedded SQL for lookups, with explicit string parsing for the CSV file.

### Typical Flow

1. **Clear** work area.
2. **Import** CSV with CL program.
3. **Create** order header (with lookups).
4. **For each line** in CSV:
    - **Parse** line fields.
    - **Look up** logistics item if available.
    - **Write** order line.
5. **Error handling** at every step.

This should give a new developer a strong orientation for both understanding and modifying/extending this program.
```