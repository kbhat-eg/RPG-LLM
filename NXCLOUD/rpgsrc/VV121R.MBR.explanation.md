## Program Overview

This ILE RPG program (VV121R) is for **maintaining alternative items** ("Alternativ vare, vedlikehold") in a business application. It presents a subfile (SFL) interface, allowing users to manage alternative item relationships—adding, editing, or deleting as needed.

The code is well-structured, using traditional **fixed-format RPG**, and is heavily commented (in Norwegian).

---

### High-Level Flow

1. **Initialization** (`*inzsr`)
   - Retrieves parameters (company and item number).
   - Sets up keys for database access.
   - Reads the initial data and fills the subfile.

2. **Main Display & Function Handling**
   - Main loop (`b2tagb`): shows the subfile and waits for user input.
   - Handles function keys for actions like inquire (F4), refresh, add, or exit.
   - Subroutines are called as needed for subfile processing, data refresh, and maintenance.

3. **Subfile Processing**
   - Handles user updates to subfile records:
     - Validates alternative item codes.
     - Adds, updates, or deletes corresponding database records.
     - Provides feedback on errors (e.g., invalid or duplicate entries).

---

## Key Sections Explained

### File Declarations

```rpg
fvvaal1    if   e           k disk    rename(vvaapfr:vvaal1r)
fvvaalr    if   e           k disk    rename(vvaapfr:vvaalrr)
fvvaalu    uf a e           k disk    rename(vvaapfr:vvaalur)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)

fvv121d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Declares input/output files:
  - `vvaal1`, `vvaalr`, `vvaalu`: alternative item files (with different purposes).
  - `vvarl1`: item master file.
  - `vv121d`: workstation file, using subfile (screen).
- `infds(dspfbk)`: feedback structure for display attributes.

---

### Indicator Usage

```rpg
* LR = end program | 10 = Roll Up | 11 = Roll Down | 12-15 = Subfile control
* 21 = Home key | 22 = cursor position | 30 = field protection
* 31-79 = error/screen indicators | 80-99 = work indicators
```
- Outlines which indicators are used for what: navigation, subfile control, error flags, etc.

---

### Variables and Data Structures

- **Parameters**: `p_firm`, `p_nobb` — company and item number.
- **Local Data Area**: `l_user` — current user.
- **Feedback Data Structure**: `dspfbk` with `d_fcrn` for cursor positioning.
- **Subfile Variables**: e.g., `w_srrn`, `w_ssrn`, `w_sfrn`, etc., for managing subfile pages, rows, and record numbers.

---

### Main Processing Loop

**Tags and Subroutines:**
```rpg
c     b2taga        tag
c                   write     b2cmd
c     b2tagb        tag
c                   exsr      dsp_subfile
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inkd
c                   exsr      spørring
c                   goto      b2tagb
c                   when      *inke
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   endsl
c                   exsr      subfile
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Writes initial command screen.
- Displays subfile with `exsr dsp_subfile`.
- Handles function keys:
  - `*inkc`, `*inkl`: exit program.
  - `*inkd`: F4/inquiry (calls external program with item data).
  - `*inke`: refresh data.
  - `*in10`: add subfile page.
- After handling, processes subfile changes.
- Ends via tag `avslutt`.

---

### Subroutines

#### `forny` — Refresh Subfile

1. Reposition file pointer.
2. Clear existing subfile.
3. Recreate subfile by reading from the database.

#### `subfile` — Process Subfile Changes

- Loops through subfile records.
- For each row:
  - If alternative item (`b1aava`) is blank (deletion):
    - Deletes entry in DB (if exists).
    - Clears subfile row.
  - If not blank (add/change):
    - Validates item exists in item master (`vvarl1`).
    - Checks for duplicates.
    - If original entry exists, deletes it.
    - Inserts or updates with new data (timestamps, user, etc.).
    - Error indicators set as needed.

#### `clr_subfile` — Clear Subfile

- Activates subfile clear indicators.
- Resets subfile counters.

#### `crt_subfile` — Fill Subfile

- Increments subfile page size.
- Reads from DB, fills each subfile row.
- For each record, checks if item exists in master for description.

#### `dsp_subfile` — Display Subfile

- Shows subfile if records exist, or command screen otherwise.
- Sets display feedback/cursor position.

#### `spørring` — Inquiry Handling (F4)

- If current field is alternative item var, calls external inquiry program (`VV500R`) to look up/update item details.

#### `*inzsr` — Initialization

- Reads entry parameters.
- Sets up keys for DB access.
- Fills subfile for initial display.

---

### Special Notes

- **Indicators** drive all screen/subfile handling and much logic.
- **Multi-record subfiles**: multiple records are shown in a pageable list, all changes are processed in bulk on each cycle.
- **Audit fields** (`vvaoda`, `vvaoti`, `vvaous`, etc.): sets timestamps and user for tracking.
- **Screen fields**: Names like `b1aava`, `b1work`, `b1tek1` are subfile fields for alternative item, original item, and description.

---

## Takeaways for Onboarding

- The program is a CRUD (Create/Read/Update/Delete) tool for **alternative items**, using a subfile to list and edit them.
- **Validation** is performed before any change, and DB updates are made accordingly.
- **Function keys** are actively used for navigation and actions.
- **Subroutines** are used for modular logic, including screen refresh/fill, data validation and update, and inquiry.
- If you need to add/change business rules, look in the relevant subroutine (`subfile` for core logic, `crt_subfile` for initial fill, etc.).
- All DB access is via keyed access, using keys defined in the `*inzsr` subroutine.

---

### For further development or debugging:

- Carefully check indicator usage.
- Watch for database file structure changes, as fields like `vvaava`, `vvfirm`, etc., are directly referenced.
- Subfile paging logic relies on counters like `w_srrn`, `w_ssrn`, etc.; be sure to understand their interplay if modifying display/paging.
- "Sporingsinformasjon" (tracking info) fields (`vvaoda`, `vvaoti`, `vvaous`, etc.) are updated with each change for auditability.

---

**In summary**:  
This is a modular, subfile-driven maintenance program for alternative item relationships, with all the classic navigation and data validation patterns of IBM i green screen applications.