# JO601R – Matched Items Printout Program

## Overview

**Program Name:** JO601R  
**Purpose:** Prints a report of matched items (“matchede varer”) according to various selection parameters.  
**Business Domain:** Inventory/Item Matching – likely in a wholesale or distribution context, based on Norwegian variable names (e.g., “vare” for item, “leverandør” for supplier).

This program extracts, filters, and prints records of matched items from the matching register (`jmatl6`), with detailed grouping and heading logic based on supplier and item groupings.

---

## File Dependencies

- **Input/Inquiry Files:**  
  - `jmatl6` (Matching register, renamed as `jmatl6r`)
  - `afirl1` (Company master, renamed as `afirl1r`)
  - `jvarl1` (Item master, renamed as `jvarl1r`)
  - `jlevl1` (Supplier master, renamed as `jlevl1r`)
  - `vogrl1` (Overgroup master, renamed as `vogrl1r`)
  - `vhgrl1` (Main group master, renamed as `vhgrl1r`)
  - `vugrl1` (Subgroup master, renamed as `vugrl1r`)

- **Output File:**  
  - `jo601p` (Printer file for report output)

---

## Parameter and Data Area Handling

- **Parameter Structure:**  
  The program receives a 32-character parameter block (`p_parm`) at entry, which is parsed into individual fields (`firm`, `ldo2`, `ogrp`, `hgrp`, `ugrp`, `kode`) using overlays in a data structure (`d_list`). These are used as selection criteria for the report.

- **Local Data Area:**  
  Used to extract workstation ID (`l_wsid`) and user (`l_user`) for inclusion in report headings.

---

## Key Business Logic

### 1. **Initialization (`*INZSR`)**

- Receives and parses parameters.
- Sets up key lists for all logical file accesses.
- Sets the initial value for `a4ldo2` (used for supplier break logic).

### 2. **Header Section (`hode` subroutine)**

- Populates heading fields with company, user, workstation, date, and time.
- Fetches company name from `afirl1`.
- Fetches descriptions for the selected supplier, overgroup, main group, and subgroup, if applicable.
- Writes report header lines (`a1hdr`, `a2hdr`, `a3hdr`).

### 3. **Detail Extraction and Printing (`detalj` subroutine)**

- Loops through `jmatl6` (matching register), using keys derived from parameters.
- Applies a series of filters:
  - **Update code (`jovkod`)**: Only include records with `jovkod = 0`.
  - **Supplier (`joldo2`)**: If supplied in parameters, only include matching.
  - **Overgroup, Main group, Subgroup**: If specified, only include matches.
  - **Match status (`jokode`)**: Only include matched items (`jokode <> 0`).
  - **Match code**: If specified, only include matching code.
- **Supplier Break Logic:**  
  When supplier changes (if not fixed by parameter), prints a supplier heading (`a4hdr`), and optionally repeats main headers.
- **Detail Line Construction:**  
  - Moves item, group, and description fields into print fields.
  - If a second item (variant) exists, fetches its description from item master.
- **Prints detail line** via `skriv_dtl` subroutine.

### 4. **Overflow Handling (`overflow` subroutine)**

- If printer overflow indicator (`*IN30`) is set, repeats the main headers to maintain report readability.

---

## Design and Coding Conventions

- **Parameter Overlay:**  
  The use of a 32-character parameter block with overlays allows for flexible passing of selection criteria, a pattern common in legacy RPG applications for batch/report programs.
- **Break Logic:**  
  Supplier break logic is handled by tracking the last supplier printed (`a4ldo2`), and reprinting headers as needed. This ensures grouping in the report output.
- **Key List Usage:**  
  Key lists (`KLIST`) are defined for all file accesses, keeping file I/O consistent and maintainable.
- **Data Movement:**  
  Uses both `EVAL` and `MOVEL` for data assignment, the latter where left-justified assignment is required (notably for item numbers, as per the 6.30 modification note).
- **Error Handling:**  
  File I/O errors are handled with indicator variables (e.g., `*IN90`, `*IN91`). If a lookup fails, blank values are used as fallbacks in headings.

---

## Relationships with Other Modules

- **Master Files:**  
  The program relies on several master files for enrichment of report data (company, item, supplier, groupings).
- **Parameter Passing:**  
  Likely called from a menu or batch controller that assembles the parameter block.

---

## Business/Domain-Specific Notes

- **Groupings:**  
  The use of overgroup, main group, and subgroup is central to the item classification schema in this business domain.
- **Matching Register:**  
  The `jmatl6` file is a register of matched items, possibly resulting from a prior reconciliation or matching process.
- **Supplier Logic:**  
  The report can either be supplier-specific or grouped by supplier, depending on whether the supplier parameter is set.

---

## Modification/Version Notes

- **6.30 / 290514 BKV:**  
  Field `LVAR` (likely item number/variant) increased from length 15 to 20. Code changes for this are marked (6.30) and involve using `MOVEL` instead of `EVAL` for correct data alignment.

---

## Summary of Main Flow

1. **Initialization:**  
   - Parse parameters, set up keys, initialize variables.
2. **Header Print:**  
   - Print company, user, and selection criteria in headers.
3. **Detail Extraction:**  
   - Read matched items, apply all selection filters.
   - On supplier break, print supplier heading.
   - For each qualifying record, assemble and print detail line.
   - On page overflow, repeat headers.
4. **Program End:**  
   - Set LR indicator and return.

---

## Key Subroutine/Section References

| Subroutine   | Purpose                                         |
|--------------|-------------------------------------------------|
| `*INZSR`     | Program initialization, parameter parsing       |
| `hode`       | Header printout, fetches company and group info |
| `detalj`     | Main extraction and detail line logic           |
| `skriv_dtl`  | Print detail line, check for overflow           |
| `overflow`   | Handle page overflow, repeat headers            |

---

## Noteworthy Points for New Developers

- **Parameter Handling:**  
  All selection logic is driven by the parameter block; understand its structure and how overlays are used.
- **Master Data Dependencies:**  
  This program’s output quality depends on the accuracy and completeness of master files.
- **Report Layout:**  
  The printer file (`jo601p`) defines the physical layout of the report, including headers and detail lines.
- **Error Indicators:**  
  Watch for the use of file I/O indicators (`*IN90`, `*IN91`) for error and end-of-file handling.

---

## Conclusion

This is a classic RPG batch report program, tailored for matched item reporting with flexible selection and grouping. The code is structured for maintainability, with clear separation of initialization, heading, detail, and overflow handling. Familiarity with the business’s item and supplier classification system will be essential for effective maintenance or enhancement of this program.