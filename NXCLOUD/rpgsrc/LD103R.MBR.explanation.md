# RPG Program LD103R – Documentation

## Overview

**Program:** LD103R  
**System:** ASLAGR  
**Purpose:** Handles order line (bestilling-linje) inquiry and registration of product lines, including display, selection, and maintenance via subfiles. It is central to the process of adding, reviewing, and editing items on purchase orders, with special handling for campaigns, supplier agreements, and product assortment logic.

This program is a key part of the order management workflow, providing a user interface (workstation file) for line item management with integration to multiple master and transaction files.

---

## Business/Domain Context

- **Bestilling-linje:** Refers to the lines on a purchase order (each representing a product, quantity, price, etc.).
- **Kampanje:** Special campaign or promotion affecting pricing or product selection.
- **Trelast sortiment:** Special handling for lumber assortment, reflecting business-specific logic for product types.
- **Prisgruppe:** Pricing group, used for calculating prices based on groupings.

---

## File Dependencies and Data Relationships

The program interacts with a range of physical and logical files, each providing specific data (product master, pricing, supplier, user, etc.). Notable files include:

- **VVSOPF:** Product master file.
- **VVARLR, VVARL3, VVARL4:** Product lookup files (by product number, NOBB number, supplier product number).
- **LSTSL1, FSTSL1:** Status and code register files.
- **LUSRL1:** User register.
- **RLEVL1:** Supplier master.
- **VLTP, LOHEL1, LODTL1, LODTLV:** Order header/line files.
- **VTILL5:** Campaign/offer file (assortment for campaigns).
- **VVLEL1:** Lumber assortment (trelast sortiment).
- **Workstation file LD103D:** Handles the display, using subfile `b1sfl` for line items.

---

## Key Variables and Structures

### Parameters

- **p_kode, p_firm, p_numm, p_suff, p_line, p_kost, p_orde, p_kamp:** Passed to the program for context (company, order, line, campaign, etc.).

### Working Variables

- **w_firm, w_numm, w_suff, w_line:** Current order context.
- **w_vare, w_anta, w_kopr:** Product, quantity, cost price for current line.
- **w_toti, w_totr:** Totals for order (sum including/excluding discounts).
- **w_mvap, w_mvat, w_mvaf:** VAT rates and factors.
- **w_prgr:** Price group (expanded to 2 positions in v8.01).
- **b1...:** Fields representing subfile records.

### Control Flags

- **b_feil, b_open_sok, b_sess, b_sent, b_inlr:** Various flags for error, session, sent status, etc.
- **Function key indicators:** *inXX for handling display function keys.

---

## Program Structure and Flow

### Initialization (`*INZSR`)

- Receives parameters and initializes context (company, order, campaign, etc.).
- Loads code, user, supplier, and order header data.
- Fetches tax rates and price group.
- Prepares the first subfile page for display.

### Main Display Loop

- Uses subfiles to display available (campaign) products for order lines.
- Handles function keys for navigation, filtering, and special actions:
  - **F2:** Register text lines.
  - **F10/F11:** Page forward/back in subfile.
  - **F21/F22/F23:** Toggle filters (assortment, price display, positioning).
- Allows direct positioning by product number (NOBB and supplier number logic is present but commented out).

### Subfile Management

- **Subfile is the primary UI for listing/selecting products to add to the order.**
- Subroutines handle:
  - **forny:** Refreshes/rebuilds the subfile (e.g., after filter changes).
  - **clr_subfile / crt_subfile:** Clear and refill subfile records based on current filters and positioning.
  - **bck_subfile:** Page back in subfile.
  - **dsp_subfile:** Display subfile page.

### Product Selection and Registration

- When a quantity is entered, the `registrer` subroutine is called:
  - Increments line number.
  - Calls program `LD105R` for detailed registration of the order line.
  - Updates totals.

### Campaign/Assortment Filtering

- Uses `VTILL5` (campaign assortment) to determine which products are available for selection, filtering by campaign, supplier, and already-registered products.
- SQL is used to retrieve special assortment data for lumber (vvlepf).

### Price/Tax Handling

- Calls to `VP750R`, `VL710R`, and `FØ705R` (tax) retrieve pricing and VAT information, considering campaign and product group logic.

### Supplier/Product Assortment Logic

- Integrates supplier and product assortment checks (including calls to `VD771R` and `VD772R` for central warehouse and period-controlled assortment).
- Business rule: Products with mismatching suppliers between campaign file and order are excluded.

### Totals Calculation

- `hent_total` subroutine sums up order totals for display.

---

## Special Design/Business Logic

- **Subfile Paging:** Uses record number variables (`w_srrn`, `w_sfrn`, `w_ssrn`, `w_spge`) to manage subfile paging, supporting wide screen displays (v7.01 update).
- **Assortment Filtering:** Assortment logic (incl. lumber/trelast) is extensible via SQL and provides for campaign-specific product selection.
- **Supplier Consistency:** Strict filtering to ensure only products with matching suppliers (between campaign and order) are selectable.
- **VAT/Price Display Toggle:** Allows toggling between displaying prices with or without VAT.
- **Multi-key Positioning:** Supports positioning in the subfile by product number, NOBB number, or supplier product number (though only product number is active; the others are commented out).
- **Support for Extended Product Identifiers:** Product code fields have been extended (e.g., LVAR from 15 to 20 chars, v6.30 update).
- **Campaign-aware Pricing:** All cost/price calculations consider active campaigns.

---

## External Program Calls

- **LD105R:** Handles detailed registration of selected order lines.
- **LD110R:** Handles registration of text lines.
- **VL710R:** Retrieves product info from warehouse.
- **VP750R:** Calculates prices, considering price group and campaign.
- **VD771R/VD772R:** Checks if product is in central warehouse or period-controlled assortment.
- **FØ705R:** Retrieves VAT rates.
- **VL712R:** Determines price group for warehouse.

---

## Notable Conventions and Patterns

- **Norwegian Naming and Comments:** All business logic and field names are in Norwegian, reflecting the business domain (Norwegian retail/wholesale).
- **Versioned Change History:** Extensive use of in-line comments to document changes, with references to system versions and developer initials.
- **SQL Integration:** Program uses embedded SQL for certain assortment lookups (lumber assortment).
- **Subfile-Driven UI:** All user interactions for order line selection/registration are via subfile screens.

---

## Summary Table: Main Subroutines

| Subroutine     | Purpose                                                                                 |
| -------------- | --------------------------------------------------------------------------------------- |
| `forny`        | Refreshes the subfile (clear + refill)                                                 |
| `posisjoner`   | Positions the subfile to a specific product (by number)                                |
| `subfile`      | Processes user input in the subfile (registers selected lines)                         |
| `registrer`    | Registers a selected product line (calls LD105R)                                       |
| `clr_subfile`  | Clears the subfile                                                                     |
| `crt_subfile`  | Refills the subfile with available products (filtered by campaign, supplier, etc.)      |
| `bck_subfile`  | Pages back in the subfile                                                              |
| `dsp_subfile`  | Handles display logic for the subfile                                                  |
| `spørring`     | Placeholder for inquiry logic (not implemented here)                                   |
| `hent_total`   | Calculates and displays order totals                                                   |
| `sjekk_vsor`   | Checks if product is part of central warehouse or period-controlled assortment          |
| `*inzsr`       | Initialization logic (parameter handling, data loading, first subfile build)           |

---

## Integration Points

- **Order Header/Line Files:** Tight integration with order data (LOHEL1, LODTL1, LODTLV).
- **Campaign/Assortment:** VTILL5 (campaign assortment) is central for filtering available products.
- **Supplier/Product Master:** Ensures only valid, active products/suppliers are selectable.
- **External Programs:** Relies on a suite of external programs for pricing, VAT, assortment checks, and detailed line registration.

---

## Key Business Rules

- Only products in the current campaign and with the correct supplier are selectable.
- Already-registered order lines are excluded from selection.
- Price and tax display is user-toggleable.
- Assortment logic (central warehouse, period-controlled, lumber) is enforced at selection.

---

## Version/Change Notes

- **6.20:** Initial version.
- **6.21:** Campaign-aware cost/price calculation.
- **6.30:** Extended product identifier fields.
- **6.31:** Lumber assortment support.
- **6.32:** Uses supplier from order header.
- **7.01:** Supports wide screen subfiles.
- **8.01:** Price group expanded to 2 positions.

---

## Summary

This program is a sophisticated order line selection and registration tool, central to purchase order processing in a campaign-driven, assortment-sensitive retail/wholesale environment. It enforces strict business rules around product/supplier/campaign relationships, supports advanced filtering and positioning, and is designed to be extensible for future assortment and pricing logic. Integration with multiple master and transaction files, as well as external programs, is a key feature. The subfile-driven UI and business logic are tightly coupled to the Norwegian retail domain.

---

**For further onboarding, review the VTILL5, VVSOPF, LODTL1, and LOHEL1 files, as well as the external programs (LD105R, VP750R, VL710R, etc.) to understand the full data and process flow.**