## Overview

This ILE RPG source code is for the program **FW600R** in the system **ASOFAK**. The purpose of the program is to gather parameters from the user for printing (utskrift) a report of items (varer) from a supplier (leverandør). It is a display file driven parameter program—the user enters/selects the criteria, and the parameters are passed to a print program (`FW600C`).

The code is well-commented, and the structure is typical for legacy RPG applications with data validation, subroutines, and screen I/O (workstn).

---

## File and Data Definitions

### File Specifications

- **frlevl1**: Input file with key, most likely a supplier master file, renamed for local use.
- **ffw600d**: Workstation file for user interaction; the display file for parameter entry.

### Data Area and Data Structures

- **LDA (Local Data Area)**: Used to retrieve company (`l_firm`) and company name (`l_fnav`).
- **Parameter List Data Structure (`d_list`)**: 
    - Contains all necessary parameters for the report, mapped (overlayed) fields for easy packing and unpacking.
    - Fields include:
        - `d_firm` (company)
        - `d_rtyp` (report type)
        - `d_ldor` (supplier)
        - `d_lvaf`, `d_lvat` (item number range)
        - `d_dato` (price date)
        - `d_oper` (date operand)
        - `d_endr` (change %)
        - `d_ekod` (change code)

### Variables

- Variables for input fields, validation flags (`b_feil`), working dates, etc.

---

## Mainline Logic

1. **Screen Initialization**:
    - Set `b1rtyp` (report type) to 1 by default.

2. **Input Loop** (`b1taga` label):
    - Display (`exfmt b1bld`) and fetch user input from the display file.

3. **Function Key Handling** (F3/F12/others):
    - If exit key (F3/F12): Goto `avslutt` to end the program.
    - If inquiry key (F4): Call the `spørring` subroutine.
    - Otherwise, proceed to validation.

4. **Input Validation**:
    - Call `sjekk_inp` subroutine.
    - If any errors (`b_feil = *on`), re-display the screen with errors signaled.

5. **Prepare Parameter List**:
    - Move individual screen variables to their corresponding positions in `d_list`.
    - Date handling: If input, move and convert date; else set to *LOVAL ("zero date").

6. **Call Print Program**:
    - Calls `FW600C` with the packed `d_list` parameter structure.

7. **Repeat Loop**:
    - Returns to input screen for another request.

8. **Exit Routine (`avslutt`)**:
    - Set last record indicator (`*inlr = *on`) and return.

---

## Subroutines

### `spørring` (Inquiry Subroutine)

- Handles field-level inquiries (such as F4 lookups).
- If the field being prompted is the supplier (B1LDOR), it calls program `RL500R` to do a supplier lookup.

### `sjekk_inp` (Input Validation Subroutine)

Performs a series of checks:
- **Report Type**: Must be 1, 2, or 3.
- **Supplier**: Must be specified and exist (chain to supplier file using keys).
- **Item Number Range**: `lvaf` cannot be greater than `lvat`.
- **Date and Operand**: If date is specified, check validity. If operand missing, default to 'EQ'. Only certain values accepted.
- **Change Percentage**: Can only be specified if report type is 1.
- **Change Code**: Must be blank or one of 'X', 'N', 'E', 'S', 'P'.

If any validation fails, sets the associated error indicator and `b_feil`, and returns control to the input screen.

### Initialization Subroutine (`*inzsr`)

- Defines the supplier lookup key (company + supplier).
- Fetches company number from LDA for use in key and parameter structure.

---

## Key Points

- **DDS/Screen-Driven**: The program is designed around the green screen/IBM iDDS paradigm.
- **Parameter Packing**: Uses overlays on a data structure to pack all parameters for a single program call.
- **Error Handling**: Uses flag fields and indicator variables for field-level error signaling on the screen.
- **Extensible**: Parameter and field changes are commented and versioned, e.g., item number length increased in v6.30.
- **Subroutine Structure**: RPG subroutines used for modularity (validation, inquiry, initialization).

---

## The User Flow

1. **User enters parameters** on a screen (supplier, item number range, date, etc.).
2. **Function keys** allow field inquiries.
3. **On submit**, inputs are validated:
    - Errors are highlighted if present.
4. **If validation passes**, parameters are packed and **passed to the print program**.
5. **Program loops** for further input until the user exits.

---

## Notes for Onboarding

- **Understanding Indicators**: RPG indicator variables (`*inxx`) are essential—used for both error signaling and key processing.
- **Screen Variables** (`b1xxx`): These are mapped directly to fields on the display file.
- **Parameter Data Structure**: Overlay technique allows easy parameter passing but careful maintenance is needed if fields change size.

---

## Summary Table: Main Fields & Purpose

| Field          | Description                   |
|----------------|------------------------------|
| d_firm         | Company number               |
| d_rtyp         | Report type (1, 2, 3)        |
| d_ldor         | Supplier number              |
| d_lvaf/lvat    | Item number (range)          |
| d_dato         | Price date                   |
| d_oper         | Date operand (EQ/GT/LT)      |
| d_endr         | Change percentage            |
| d_ekod         | Change code                  |

---

## Suggested Next Steps for Developers

- Study the display file `FW600D` to understand field mappings.
- Review the called print program (`FW600C`) for parameter usage.
- Familiarize yourself with supplier file structure (`frlevl1`/`rlevpfr`).
- Learn how error indicators tie to field-level messages in the DDS.

---

*This code is a classical RPG example of a parameter-driven interface for report execution on IBM i systems using display files and modular validation logic.*