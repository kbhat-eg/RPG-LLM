# RPG Program LI121R – EDI Invoice Log Inquiry (ASOFAK System)

## Overview

This RPG program (LI121R) is part of the ASOFAK system and is responsible for inquiry and display of EDI invoice logs. Its primary function is to present EDI invoice log entries to the user in a subfile, supporting advanced filtering, navigation, and detailed record display. The program is designed for interactive use, leveraging display files with subfiles and control records for a GUI or DDS-based green-screen interface.

## Business Context

- **Domain:** EDI (Electronic Data Interchange) invoice processing and tracking.
- **Main Use Case:** Allowing users to search for, browse, and view details of EDI invoice logs, with filtering by company, year, supplier, invoice number, and type.
- **Data Sources:** The program reads from several physical files (or logical views) related to invoice logs (`elogpfr`), supplier master (`rlevpfr`), and uses various keys for efficient access.

## File and Record Format Usage

- **elogpfr:** Main EDI invoice log file; accessed via three record formats (`eloglrr`, `elogl2r`, `elogl3r`) for different keying strategies.
- **rlevpfr:** Supplier master file; accessed via two record formats (`rlevl1r`, `rlevl5r`).
- **Display File (li121d):** Contains the subfile (B1SFL), control records, and window definitions for command and filter entry.

### Subfile Handling

- **B1SFL:** Main subfile for displaying EDI invoice log entries.
- **B2CTL:** Subfile control record for managing the display and user input.
- **B2CMD:** Command screen for function key handling.
- **F1WIN:** Window for entering search filters.

## Major Data Structures and Variables

- **Parameters:** Company code, year, supplier, invoice number, and type are passed in as parameters on program entry.
- **Keys:** Multiple key lists are defined for chaining and setting lower limits on files, supporting flexible positioning and filtering.
- **Subfile Management Variables:** Track current, first, last record numbers, page sizes, and cursor positioning within the subfile.
- **Indicators:** Standard IBM indicator usage for program flow, subfile control, error handling, and UI feedback.

## High-Level Program Flow

1. **Initialization (`*inzsr`)**
    - Receives parameters, sets up key lists, initializes display fields.
    - Retrieves supplier name/address if available.
    - Positions and fills the subfile according to parameters.

2. **Main Loop**
    - Handles user interaction via subfile control display.
    - Responds to function keys for filtering (F1), exit (F3/F12), page navigation (Roll), and repositioning.

3. **Subfile Operations**
    - **Display (`dsp_subfile`):** Shows the subfile or command screen depending on subfile state.
    - **Clear (`clr_subfile`):** Empties the subfile and resets counters.
    - **Create (`crt_subfile`):** Reads records from the log file(s) into the subfile, applying filters (date, error-only, etc.).
    - **Process (`subfile`):** Handles user actions on subfile records, including displaying detailed invoice log data in a window (B3WIN) if requested.

4. **Filtering and Positioning**
    - **Filter Window (`xf1win`):** Allows entry of additional filtering criteria, including date and error-only flags.
    - **Positioning (`posisjoner`):** Supports direct positioning to a specific invoice number or EDI sequence number.

## Notable Design Aspects

- **Subfile Paging:** The program uses manual tracking of subfile pages and record numbers to support paging and cursor placement, reflecting a design compatible with both DDS and GUI front-ends.
- **Flexible Keying:** Multiple logical views/keys on the invoice log file allow for efficient searching and positioning by different criteria (invoice number, EDI sequence, etc.).
- **Error Handling:** Indicators and error codes are used for both file operations (e.g., record-not-found) and for UI feedback.
- **Extensibility:** The program is structured with clear subroutines for each major function, making it relatively straightforward to maintain or extend (e.g., adding new filters or display fields).
- **Business Rules:** Filters for supplier, date, and error-only mode are applied when populating the subfile. Supplier names are looked up and displayed alongside log entries when possible.

## Module Interactions

- **Invoice Log (`elogpfr`):** Central data source for EDI invoice events.
- **Supplier Master (`rlevpfr`):** Used to supplement log entries with supplier names and addresses.
- **Display File (`li121d`):** User interface for all interactions.

## Key Conventions

- **Indicator Usage:** Follows a documented convention for indicator assignment (see comment block at the top).
- **Record Naming:** Renames record formats for clarity and to avoid conflicts.
- **Subfile Variables:** Uses a consistent naming scheme (`w_` prefix for working variables, `b1`/`b2`/`b3` for subfile and window fields).
- **Versioning and Change History:** Maintains a detailed header with version notes and change tracking.

## Important Business Logic

- **Filtering:** Only records matching the supplied company, year, and (optionally) supplier, invoice number, or type are included.
- **Date Filter:** If a date is entered, only records with a matching date are shown.
- **Error-only Filter:** If specified, only records with error messages are included.
- **Supplier Lookup:** When displaying a log entry, the program attempts to resolve and display the supplier’s name using the EAN location number.

## User Interaction

- **Function Keys:** Support for filter entry (F1), exit (F3/F12), page up/down, and direct positioning.
- **Detail Display:** Users can select a record to view all fields in a popup window.
- **Dynamic Filtering:** Users can refine or clear filters at any time to update the displayed data.

## Maintenance Notes

- **GUI Compatibility:** Some changes are flagged as relevant only for GUI/DDS front-ends.
- **Field Extensions:** New fields have been added over time to meet evolving business needs.
- **Indicator Expansion:** Additional indicators are reserved for future error/warning states.

---

**In summary:**  
LI121R is a robust, extensible EDI invoice log inquiry module, supporting advanced filtering, dynamic subfile display, and detailed record inspection. It is tightly integrated with the invoice log and supplier master files, providing users with a powerful tool to monitor and investigate EDI invoice flows within the ASOFAK system. The codebase follows established RPG and ASOFAK conventions for indicators, variable naming, and file/key management.