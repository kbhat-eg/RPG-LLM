# Program Overview

This RPG program (`RF120R`) processes bank and postal payment files (OCR files). It reads input transactions, looks up and enriches data from various registers, handles special cases (e.g., negative amounts, KID processing for Santander/PayEx), and writes the results to an output file for further accounting processing.

The code is written in ILE RPG (RPG IV), using fixed-format syntax. It is well-commented, with Norwegian business terminology.

---

## Main Components

### 1. **Header and Metadata**
- Describes the system, program, function, and a detailed change log.
- Key terms:
  - **Innlesing av innbetalinger OCR**: "Reading of incoming OCR payments"
  - **Spesialversjon**: Special version
  - **Beløp har minustegn foran når negativt**: Amount is negative when minus sign is in front

---

### 2. **File Declarations (`F`-specs)**
- `ocrin`: Input file, 83 positions wide, holds OCR payment data (disk file).
- Various register files (`raa3l1`, `akidl1`, etc.) for lookup/enrichment, read as keyed files.
- `frjoupf`: Output file for processed transactions.

---

### 3. **Data & Working Structures (`D`-specs)**
- **PERIODER (`per`)**: Array holding period info (for accounting periods).
- **User/Firm Info**: Holds information about session (user, firm, etc.).
- **Date & Reference Structures**: Overlay fields for easy access to day/month/year and subfields.
- **Sorting/Keying DS**: For constructing sort or key fields.
- **KID-related DS**: Used for interpreting both short and long KID (customer id/reference) numbers.

---

### 4. **Input Specifications (`I`-specs)**
- Describes layout of incoming records (positions for fields like amount, KID, dates, codes, and their subfields).

---

### 5. **Main Logic (`C`-specs)**

#### **Initialization**
- Checks that the read-in firm matches the expected (`l_firm = gdqofi`). If not, exits.
- Initialization subroutine sets up period info, keys for lookups, etc.

#### **Processing Loop**
- The loop is organized around transaction codes:
  - **Transaction code 30**: Main payment processing.
    - **Santander/PayEx KID**: Special routines (`santand`, `payex`) for these providers.
    - **Short KID handling**: Looks up the long KID and associated data from `akidl1`.
      - If found, enrich data fields accordingly.
      - If not found, blank/zero out relevant fields to signal an error.
    - **Negative Amount Handling**: Handles amounts with a leading minus by converting strings and setting the credit/debit indicator.
    - **Field mapping**: Populates output record fields from input and lookup results.
    - **Special case for KID starting with 111**: Alters account and reference mapping for test cases.
    - **Sorting fields**: Populates output sort fields for later processing.
  - **Transaction code 31**: Additional/batch posting logic.
    - Uses new dates if provided.
    - Handles period/year logic for accounting.
    - Sets sort fields.
    - Looks up supplier account if no account is provided.

---

#### **End-of-Transaction Processing**
- Writes the processed record to output file.
- Deletes the input record from `ocrin`.
- If interrupted, the program can be rerun to process only unhandled records.

---

### 6. **Subroutines**
#### **Santander/PayEx KID Lookup**
- For records flagged as Santander (`bsant == 2`) or PayEx (`bpayx == 55555`), the program searches the `akidl2` file for matching KID/year, updating data fields accordingly.
- If not found, blanks out relevant fields to cause a control error.

#### **Initialization Subroutine (`*inzsr`)**
- Loads period data from `raa3l1`.
- Sets up keys for various lookups.

---

### 7. **Special Notes**
- **Handling of Negatives**: Negative amounts are handled either by a leading sign in the amount or a separate sign field.
- **KID, Account, and Reference Handling**: KID can be short or long, with lookup and field mapping for each scenario.
- **Patch/Functionality Traceability**: The program has a detailed in-line history for changes.

---

## Summary Table of Key Fields

| Field        | Purpose                                     |
|--------------|---------------------------------------------|
| bbelø, bbeløx | Payment amount (string, possibly negative)  |
| bkid         | KID (customer reference) – short/long       |
| bkund        | Customer account number (from lookup)       |
| bfakt        | Invoice/factura number                      |
| bkode        | Special code (lookup)                       |
| bmvak        | VAT code                                    |
| bfort        | Debit/Credit sign indicator                 |
| rj...        | Output file fields                          |

---

## Summary of Business Logic

1. **Reads OCR payment records**.
2. **Enriches data** (from KID register, supplier register, etc.).
3. **Special cases** for major suppliers like Santander and PayEx.
4. **Validates and transforms**: Handles negative amounts, various KID formats.
5. **Outputs results** to a work file for later accounting processing.
6. **Deletes input record** to avoid double processing.

---

## Key Takeaways for Onboarding

- **Main flow**: Read, enrich, special-case, output, delete input.
- **File lookups and overlays** are central to interpreting transactions.
- **Subroutines** handle complex/special KID requirements (Santander, PayEx).
- **Field mapping and error logic**: If lookups fail, output is deliberately blanked to cause a controlled error downstream.
- **Change log** in the comments is a valuable reference for understanding feature evolution.

---

### If you are onboarding:
- Familiarize yourself with the **input file layout** and **key registers** (`akidl1`, `akidl2`, `raa3l1`, `rlevl6`).
- Study the handling of **negative amounts** and **special KID logic**.
- Use the **comments/change log** to understand which features/patches may affect newer clients or special cases.
- Explore the **output file layout** (`frjoupf`) for downstream processes or reporting.

---

**This program is a good example of legacy RPG code handling advanced business logic in batch-style bank reconciliation and payment input processing.**