# Comprehensive Documentation – Program LO930R

## Overview and Purpose

**LO930R** is a report program for generating packing slips (**Pakkseddel**) without prices or amounts. The program is part of a larger purchasing and logistics solution, and its main function is to print packing slips for purchase orders, showing item lines, quantities, and various references, but explicitly omitting any pricing or value information.

This version is harmonized with earlier versions (notably ASOKON 1.01) and includes several enhancements and bug fixes, such as handling extended reference fields and correcting overflow issues.

---

## Key Features

- **Prints packing slips** for purchase orders, omitting prices and line totals.
- Handles **multiple order types** and supports both regular and one-time vendors.
- Supports **extended references** and adapts to extended number fields.
- Integrates with multiple master and transaction files for order, item, vendor, and company data.
- Handles **item lines, free-text lines, and length specification lines**.
- Manages **page overflow** and ensures proper formatting and page breaks.
- Supports **company-specific information** and VAT codes.

---

## File Dependencies

The program interacts with the following physical and logical files (typically DB2/400 tables):

- **Order and Line Files**: `LOHEL1R`, `LODTL1R`, `LOTXL1R`
- **Vendor Files**: `RLEVL1R`, `RKUNL1R`
- **Company Files**: `AFIRL1R`, `AFORL1R`
- **Item and Warehouse Files**: `VVARL1R`, `VLAGL1R`
- **Order and Line Type Files**: `VOTYL1R`, `VLTYL1R`
- **Auxiliary Files**: `LPSOL1R`, `LSTSL1R`, `FOHEL1R`, `FVL1L1R`
- **Printer File**: `LO935P`

All files are opened for input (`I`), except for the printer file which is output (`O`).

---

## Data Structures and Variables

### Data Structures

- **DSFFTX (1-30)**: Used for formatting the company registration/VAT number for the printout.
- **UDS (User Data Structure)**: Used for importing data from the LDA (Local Data Area), including routine name, line counts, and company number.

### Key Variables

- **vlagl1_lage / vlagl1_vare**: Used for accessing warehouse/item master data.
- **fvlsl1_numm / fvlsl1_suff / fvlsl1_line**: Used for accessing length specification lines.
- **Various working fields**: `WWNUMM`, `WWSUFF`, `WWLINE`, etc., used for keying into files.

### Indicators

- Several indicators (`*INxx`) are used for conditional logic, such as overflow handling, presence of addresses, references, etc.

---

## Program Flow

### Main Control Routine

The program processes input records from `LPSOL1R` (likely a spool or work file), using the field `LKSKOD` to determine record type:

- **'H'**: Order header → triggers heading processing (`TAG01`)
- **'V'**: Item line → triggers detail line processing (`TAG02`)
- **'K'**: Text/comment line → triggers text line processing (`TAG03`)
- **Other**: End of processing for this record

### Heading Handling (`TAG01` / `TAG01A`)

- Retrieves order header from `LOHEL1R`.
- Gathers order, vendor, delivery, and reference information from related files.
- Handles one-time vendor logic and customer order linkage.
- Determines which references, addresses, and delivery information to print, setting indicators accordingly.
- Calls external program (`FØ705R`) to determine VAT codes.
- Writes heading formats (`A1HDR`, `A4HDR`).

### Detail Line Handling (`TAG02`)

- Retrieves detail line from `LODTL1R`.
- Looks up line type (`VLTYL1R`) and checks if line should be printed (skips certain order types).
- Handles both normal item lines and text lines.
- Looks up item master (`VVARL1R`) and warehouse master (`VLAGL1R`).
- Determines number of decimals for quantity and assigns to the correct field.
- Writes detail format (`D1DET`) and, if applicable, triggers length specification subroutine.

### Text Line Handling (`TAG03`)

- Retrieves text line from `LOTXL1R`.
- If not in summary mode and line number is above 5000, skips printing (these are printed at the end).
- Writes text line format (`E1DET`).

### Totals and End-of-Order Processing (`T1TOT`)

- Determines if there is enough space on the page for final totals and text; if not, triggers a new page.
- Writes total format (`T1TOT`).
- In non-summary mode, prints any remaining text lines with line numbers above 5000.

### Overflow Handling (`XOVRFL`)

- Writes a new page heading and resets line count when overflow indicator is set.

### Subroutines

- **`len_spec`**: Handles printing of length specification lines for certain items. Iterates through all length lines for the current item and writes them as text lines.
- **`XSTRSR`**: Startup subroutine. Initializes keys, loads company and vendor information, and sets up order type context.
- **`*INZSR`**: Program initialization. Defines field mappings, initializes working fields, and sets up all key lists for file access.

---

## Business and Domain-Specific Logic

- **Packing Slips Without Prices**: This version is specifically tailored to omit all price and value fields, in compliance with business requirements for certain packing slips.
- **One-Time Vendors**: Special logic is included to handle orders with one-time vendors, copying address/reference info as needed.
- **Order Type Exclusions**: Some order types are explicitly excluded from printing item lines, as defined by constants (`VALO01`–`VALO04`).
- **Length Specification**: For certain items, a separate length specification is printed using data from the `FVLSL1R` file.
- **Summary vs. Non-Summary Mode**: The `VAOSAM` flag controls whether text lines above line number 5000 are printed immediately or deferred to the end of the order.
- **Reference and Address Handling**: Multiple checks and indicator settings determine which references (delivery, requisition, etc.) and addresses (vendor, delivery, customer) are present and should be printed.
- **Overflow and Pagination**: The program carefully tracks line counts and manages page overflow to ensure printout integrity.

---

## Design Patterns and Conventions

- **Key Lists (`KLIST`)**: Used extensively for file access, ensuring consistent and maintainable key management.
- **Indicator-Based Control Flow**: Heavy use of RPG indicators for conditional logic, reflecting traditional RPG design.
- **Modular Subroutines**: Core logic is broken into subroutines for startup, overflow, length specification, and initialization.
- **Separation of Concerns**: Each major record type (header, detail, text) has a dedicated processing section.

---

## Integration Points

- **External VAT Routine (`FØ705R`)**: Called to retrieve VAT rates, passing company and date information.
- **Multiple Master Files**: The program draws on a wide range of master data (items, vendors, warehouses, company, order types) to enrich the packing slip.
- **Printer File (`LO935P`)**: All output is formatted and written to this printer file; specific print formats are referenced by name (e.g., `A1HDR`, `D1DET`).

---

## Notable Enhancements and Fixes (from comments)

- **R6.10**: Expanded reference fields in output.
- **R6.10**: Corrected double overflow handling in page breaks.
- **R6.30**: Checked and adapted for extended number fields.

---

## Summary Table: Main Print Formats

| Format  | Description                              | When Used               |
|---------|------------------------------------------|-------------------------|
| A1HDR   | Main heading (order header)              | Start of order          |
| A4HDR   | Sub-heading above item lines             | Before item lines       |
| D1DET   | Item detail line                         | For each item line      |
| E1DET   | Text/comment line                        | For each text line      |
| O1DET   | Overflow transfer line                   | On page overflow        |
| T1TOT   | Order total (no prices in this version)  | End of order            |

---

## Recommendations for New Developers

- **Familiarize yourself with the business logic** for packing slips, especially regarding when and why prices are omitted.
- **Understand the file structure and relationships** between orders, items, vendors, and company data.
- **Pay attention to indicator usage**, as much of the program flow depends on these.
- **Review the key lists** and their corresponding files to grasp data access patterns.
- **Note the special handling for length specification lines and one-time vendors**—these are common sources of confusion.

---

## References

- **ASOKON**: Earlier version of the purchasing/logistics system.
- **AFIRL1R, AFORL1R**: Company master and text files.
- **VVARL1R, VLAGL1R**: Item and warehouse master files.
- **LOHEL1R, LODTL1R, LOTXL1R**: Order header, detail, and text lines.
- **RLEVL1R, RKUNL1R**: Vendor and customer master files.

---

If you have further questions about specific business rules or file layouts, consult the system documentation or reach out to the business analysts for clarification.