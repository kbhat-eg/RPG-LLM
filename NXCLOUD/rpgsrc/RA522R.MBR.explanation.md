# RA522R – ILE RPG Program Explanation

## General Information

- **System:** ASOKON  
- **Program:** RA522R  
- **Purpose:** Inquiry on freight forwarders (Speditører, spørring)  
- **Original Author:** KOB (01.05.02)  
- **Type:** Green screen, workstation application using subfiles  

---

## Header Spec

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: Disables debugging for input/output operations.
- `DATEDIT(*DMY)`: Sets date format to Day-Month-Year.

---

## Files and Display Files

```rpg
fra22l1    if   e           k disk    rename(ra22pfr:ra22l1r)
fra22l2    if   e           k disk    rename(ra22pfr:ra22l2r)
fra522d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **fra22l1** and **fra22l2**: Physical files, both using the same underlying file (`ra22pfr`), but referencing different record formats.
- **fra522d**: Workstation (display) device, using subfile `b1sfl` with a relative record number `w_srrn`.

---

## Indicator Usage

- **LR**: End of program (Last record)
- **10**: Roll (page down)
- **11**: Rolldown (page up)
- **12-15**: Control subfile visibility and state
- **21-22, 30**: Home key, cursor placement, and field protection
- **31-99**: Warnings, messages, and work indicators

---

## Data Definitions

### Parameters

```rpg
d p_firm          s                   like(ravfir)
d p_vkod          s                   like(ravkod)
d p_vtxt          s                   like(ravtxt)
```
- Input parameters for the company, code, and description fields.

### Key Variables

```rpg
d ra22l1_vkod     s                   like(ravkod)
d ra22l2_vtxt     s                   like(ravtxt)
```
- Used in key lists for database positioning.

### Working Variables

```rpg
d w_stel          s              4  0    // Subfile counter
d w_spge          s              4  0    // Subfile page size
d w_srrn          s              4  0    // Relative record number
d w_sfrn          s                   like(w_srrn) // First record nbr on page
d w_ssrn          s                   like(w_srrn) // Last record nbr on page
d w_seqe          s              1
d b_valg_ok       s              1    inz(*off)
d w_firm          s                   like(ravfir)
d c_sfil          s              2  0 inz(8)   // Subfile page size constant (8)
```

---

## Mainline Program Flow

### Main Tags and Loop

- **b2taga** (Main tag)
  - Writes the control display (`b2cmd`)
- **b2tagb** (Subfile processing)
  - Calls subroutine to display the subfile.
  - Calculates the start record for paging.
  - Handles function key processing (Page up/down, Home, etc).
    - **F3/F12**: Exit
    - **F5**: Refresh (calls `forny`)
    - **F10**: Page Down (calls `crt_subfile`)
    - **F11**: Page Up (calls `bck_subfile`)
    - **Home**: Positions cursor (uses *in22 indicator)
  - Handles positioning if search fields filled.
  - Calls `subfile` subroutine for selection.
  - Loops back to main display unless exiting.

- **avslutt** (Exit)
  - Sets *INLR (Last record), ends program.

---

## Subroutines

### forny

- Refreshes and recreates the subfile.
- Repositions based on current key (code or description).
- Calls `clr_subfile` (clear) and `crt_subfile` (create/fill).

### posisjoner

- Handles field-based search (either by code or description).
- Sets up correct key for positioning.
- Calls `clr_subfile` and `crt_subfile` to update the subfile with matched rows.
- Blanks out search fields after positioning.

### subfile

- Reads subfile records for processing (typically after user input).
- If an entry is selected (`b1valg = 1`), updates output parameters and sets `b_valg_ok = *on` to indicate a selection.
- Toggles indicator 22 to manage cursor/home placement.

### clr_subfile

- Sets indicator 14 (*in14 = *on*) to clear the display subfile.
- Resets the subfile record counters and page size.

### crt_subfile

- Populates subfile with next page-worth (8) records from the database.
- Reads records either from code (`ra22l1`) or description (`ra22l2`) index, depending on search mode.
- Marks end of subfile (*in15 = *on*) if EOF or company changes.
- Updates subfile work variables.

### bck_subfile

- Handles page up (back) operation in subfile.
- Reads previous page-worth of records (using `readp`).
- Resets the subfile with previous records, then calls `clr_subfile` and `crt_subfile` to refresh it.

### dsp_subfile

- Handles subfile display logic.
- If subfile has entries, enables indicator 12 for control record.
- Formats and displays screen via `exfmt b2ctl`.
- Clears display control indicators after screen output.

### *inzsr

- Initialization subroutine.
- Defines parameter list (*ENTRY).
- Builds key lists for file positioning.
- Sets up initial file position and fills first subfile page.

---

## Key RPG Patterns

- **Subfiles:** Used for displaying lists of records for paging and selection.
- **Indicators:** Classic RPG III-style UI/logic flow control.
- **Tag/GOTO:** Used for mainline control flow (typical in older RPG, less common in modern free-format).
- **Chain/Setll/Read/ReadP:** Indexed file access for efficient paging and searching.
- **Subroutines (BEGSR/ENDSR):** Encapsulate logic for reusability and clarity.

---

## User Interface

- **Displays a subfile of forwarders**, paged in increments of 8, with ability to search by code or description.
- **Selection:** User can select an entry; selection values are returned in the parameters.
- **Function keys:** Standard for page up, page down, home, exit, and refresh.

---

## Summary

This program implements a **workstation subfile inquiry** for freight forwarders, leveraging indexed files for efficient searches by either code or description. It uses classic RPG logic with indicators, subfiles, subroutines, and work fields. The user can scroll (page up/down), search, and select entries, all managed through a structured mainline and modular subroutines. The structure is robust for multi-screen, multi-key file navigation in green-screen (5250) IBM i environments.