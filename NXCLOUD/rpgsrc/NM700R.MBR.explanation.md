# NM700R – Nettbutikk Kundeinformasjon Eksport

## Overview

**Program:** NM700R  
**System:** ASOFAK  
**Purpose:**  
Exports extended customer information for the web shop (nettbutikk) to an external interface. This program is a specialized version for "Mestergruppen", based on a copy of NN700R, with enhancements for customer/project/contact data and integration with additional registers.

## Business Context

- **Exports customer, project, and contact person data** from the ERP system to an external consumer (likely the web shop or a data integration layer).
- **Supports extended customer information** (e.g., professional portal access, bonus, classifications).
- **Handles special business rules** for Mestergruppen, e.g., assigning email addresses, project handling, and role-based contact selection.

## File Usage and Data Sources

- **Master Data:**  
  - `rkunl1` (Customer master)
  - `anbll3`, `anbhl1` (Web shop and owner info)
- **Customer Extensions:**  
  - `rkbplr` (Professional portal access)
  - `fkprl1` (Customer projects)
  - `fkmalr` (Project registry/matrikkelinfo)
- **Contact Persons:**  
  - `rukpl6` (Contact persons with roles)
- **Bonus:**  
  - `ekbtir` (Customer bonus register)
- **Auxiliary:**  
  - `apospf` (Postal code register)
  - `ckgrl2`, `ckkllr` (Customer classification/category)
- **Output:**  
  - `netkund` (Main export file)
  - `netkrapp` (Error/report file)

## Key Data Structures

- **Message Segments:**  
  - `d_unh` – Message header  
  - `d_bgm` – Message start  
  - `d_org` – Organization info  
  - `d_cus` – Customer info (extensive, includes contact, classification, bonus, etc.)  
  - `d_cpr` – Customer project info  
  - `d_unt` – Message trailer (segment count, reference)

## Main Program Flow

1. **Initialization:**  
   - Loads company and group from LDA.
   - Reads web shop and owner data; aborts if not found.

2. **Message Header/Start:**  
   - Writes header and start segments (`d_unh`, `d_bgm`) to `netkund`.

3. **Organization Segment:**  
   - Populates and writes organization info (`d_org`).

4. **Customer Loop:**  
   - Iterates over customers (`rkunl1`) for the current company.
   - For each customer:
     - Looks up professional portal access (`rkbplr`).
     - Validates organization number and address; logs/report errors if missing.
     - Populates customer segment (`d_cus`) with master, extension, and classification data.
     - Looks up and includes contact person info (`exsr kontpers`).
     - Looks up and includes bonus info (`exsr kunbonus`).
     - Writes customer segment to `netkund`.
     - Iterates over projects (`fkprl1`) for the customer:
       - Populates project segment (`d_cpr`), including address, contact, and matrikkelinfo.
       - Handles special logic for "diverse" projects.
       - Writes project segment to `netkund`.
     - Handles customers missing email addresses, logs to error file.

5. **Message Trailer:**  
   - Writes trailer segment (`d_unt`) with segment count.

6. **Exit:**  
   - Returns to caller.

## Subroutines

### `kontpers` – Contact Person Extraction

- Looks for contact persons with role `'EHANDEL'` (web shop contact).
- If found, populates contact fields in `d_cus` with name, email, phone, etc.
- If the contact has an email, it overrides the customer’s email address (per business rule).
- Only the first matching contact is used.

### `kunbonus` – Bonus Calculation

- Aggregates bonus sales (`ektsbo`) from `ekbtir` for the customer.
- Sets the last bonus date if available.

### `*inzsr` – Initialization

- Sets up field lists (KLISTs) for keyed file access, based on the current firm.
- Loads firm number from LDA.

## Business/Domain-Specific Logic & Notable Patterns

- **Data Export Format:**  
  - Each segment (ORG, CUS, CPR) is a fixed-length, semicolon-separated record, conforming to an external integration specification.
- **Contact Person Selection:**  
  - Only contacts with the role `'EHANDEL'` (case sensitive, updated to uppercase in v9.05) are considered.
  - If a contact email is present, it overrides the main customer email (as of v9.04).
- **Error/Report Handling:**  
  - Customers missing critical data (org number, address, or email) are not exported but instead logged to `netkrapp`.
- **Classification Lookup:**  
  - Customer classification is determined via a two-step lookup:  
    1. Customer category (`rkkatg`) → chain to `ckgrl2`  
    2. Chain to `ckkllr` for final classification code/text
- **Bonus Calculation:**  
  - Bonus is summed over all relevant bonus records for the customer.
- **Project Data:**  
  - Projects without a start date are handled (v9.02).
  - Additional matrikkel/project info is included if available.
  - Projects with number over 900000 are flagged as "diverse" (`d_cprdiv = 'D'`).
- **Localization:**  
  - Country code defaults to 'NO' unless overridden by customer master (`rkland`).
  - Postal address is built using the postal code lookup (`apospf`).

## Versioning and Customizations

- **v9.01:** Added lookup in `rkbplr` for professional portal access.
- **v9.02:** Projects without start date exported; added organization ID to customer/project.
- **v9.04:** If contact person has an email, it overrides the customer’s email.
- **v9.05:** Role check for contact person changed to uppercase `'EHANDEL'`.

## Conventions and Design Decisions

- **Overlayed Data Structures:**  
  - All output records are built using overlayed data structures for efficient segment construction and field population.
- **KLIST Usage:**  
  - All key lists are defined in `*inzsr` for consistent keyed access throughout the program.
- **Error Handling:**  
  - Uses `goto avslutt` for early program exit on fatal errors (e.g., missing web shop data).
- **Character Case Handling:**  
  - Email addresses are uppercased using `xlate` for consistency.
- **Field Population:**  
  - Many fields are zeroed or blanked explicitly to avoid garbage data in output segments.

## External Dependencies

- **File Relationships:**  
  - The program expects all referenced files to be available and keyed by company (firm) and customer/project numbers as appropriate.
- **LDA (Local Data Area):**  
  - Used for passing company and group numbers into the program.

## Integration Points

- **Output Files:**  
  - `netkund` is the main export file, likely consumed by the web shop or an integration engine.
  - `netkrapp` is used for logging/reporting skipped customers with data issues.

## Summary Table: Key Files and Their Roles

| File      | Purpose                              | Key Fields                |
|-----------|--------------------------------------|---------------------------|
| rkunl1    | Customer master                      | firm, customer number     |
| rkbplr    | Customer extension (portal access)   | firm, customer number     |
| fkprl1    | Customer projects                    | firm, customer number     |
| fkmalr    | Project registry/matrikkelinfo       | firm, customer, project   |
| rukpl6    | Contact persons                      | firm, customer number     |
| ekbtir    | Customer bonus                       | firm, customer number     |
| apospf    | Postal code lookup                   | postal code               |
| ckgrl2    | Customer category mapping            | firm, category code       |
| ckkllr    | Chain category mapping               | firm, chain code          |
| anbll3    | Web shop data                        | group, firm               |
| anbhl1    | Web shop owner info                  | owner number              |
| netkund   | Export output file                   | n/a                       |
| netkrapp  | Error/report output                  | n/a                       |

---

**For new developers:**  
- Familiarize yourself with the referenced files and their key structures.
- Understand the business rules around customer data quality and project handling.
- Note the overlayed data structures for record building, and the use of subroutines for contact and bonus logic.
- Pay attention to the version comments for recent business rule changes.  
- The program is tightly coupled to the data model and business processes of the web shop/customer integration for Mestergruppen.