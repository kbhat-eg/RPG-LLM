# RPG Source Code Explanation

This ILE RPG program is used to generate a "night routine" with special procedures for system automation. The program mainly outputs customized CL (Control Language) program source for further automation on IBM i (AS/400) or S/36 systems.

Let's break it down section by section:

---

## Header & File Declarations

```rpg
 h option(*nodebugio) datedit(*dmy)
 fqcllesrc  o  a f  096        disk
```
- `h option(*nodebugio)`: disables debug for input/output operations.
- `fqcllesrc`: declares a program-described output file of 96 bytes, used to write CL source lines.

---

## Data Structure & Array Declarations

### Table Definitions

```rpg
 d rec             s             80    dim(20) ctdata perrcd(1)             
 d bxx             s              1    dim(10)
 d pxx             s              1    dim(8)
 d fra             s              1    dim(30)
 d til             s              1    dim(30)
```
- `rec`: An array of 20 x 80-char lines. Holds lines of the CL program template.
- `bxx`, `pxx`: char arrays, used for manipulating library and procedure names.
- `fra`, `til`: helper arrays for string operations.

### Program/Library Type Arrays

```rpg
 d pro             s              8    dim(2)
 d bib             s             10    dim(2)
 d sys             s              2    dim(2)
```
- Each holds up to 2 procedure/library/system type entries.

### Date Data Structure

```rpg
 d                 ds
 d d_dato                         6  0
 d  d_aaar                        2  0 overlay(d_dato)
 d  d_mmnd                        2  0 overlay(d_dato:3)
 d  d_ddag                        2  0 overlay(d_dato:5)
```
- For date handling, split into year-month-day with overlays.

### Record Construction Data Structure

```rpg
 d                 ds
 d d_recc                        84
 d  d_flt1                       27    overlay(d_recc)
 d  d_flt2                       57    overlay(d_recc:28)
```
- Used to build an output record from fields.

### Local Data Area (Parameter Area)

```rpg
 d                 ds
 d d_valg                       128
 d  d_time                        6  0 overlay(d_valg)
 d  ...
 d  d_pro1                        8    overlay(d_valg:31)
 d  d_bib1                       10    overlay(d_valg:39)
 d  d_sys1                        2    overlay(d_valg:49)
 d  d_pro2                        8    overlay(d_valg:51)
 d  d_bib2                       10    overlay(d_valg:59)
 d  d_sys2                        2    overlay(d_valg:69)
```
- `d_valg` is a parameter string holding various options, including two procedure/library/system sets.

---

## Variables

```rpg
 d p_valg          s            128
 d n               s              2  0
 d x               s              2  0
 d y               s              2  0
 d z               s              2  0
 d w_dato          s              6  0
 d w_recc          s             84
 d w_tell          s              6  0
 d w_bib1          s                   like(d_bib1)
 d w_pro1          s                   like(d_pro1)
 d w_sys1          s                   like(d_sys1)
```
- Various temporary and working variables.

---

## Program Logic

### Initialization

- The `*inzsr` subroutine initializes working variables and loads parameters.

### Main Processing

- **Assign parameters to working variables:**
    ```rpg
    c eval pro(01) = d_pro1
    c eval bib(01) = d_bib1
    c eval sys(01) = d_sys1
    c eval pro(02) = d_pro2
    c eval bib(02) = d_bib2
    c eval sys(02) = d_sys2
    ```
    Sets up the two procedure/library/type entries for further processing.

- **First Part:** Outputs the first 7 lines from the `rec` array to the target file.
- **Middle Part:** For each of up to two procedures:
    - If a system type is provided (not blank), process the entry.
    - Calls the `xsubr` subroutine to compose the correct command line for either AS/400 or S/36.
    - Outputs several template lines (10 to 18) for each procedure.
- **Final Part:** Outputs the remaining template records (19, 20).
- **Program Exit:** Sets `*INLR` to *ON to finish the program.

---

## Subroutines

### xsubr

- Determines which system type (AS/400 or S/36) is being handled and delegates to the right subroutine (`xas400` or `xs36`).

### xas400

- Builds a CL CALL command to execute a program in a given library for AS/400.
- Concatenates the library and procedure name with `/` and adds the result to the command.

### xs36

- Builds a CL STRS36PRC command for S/36, inserting the procedure and library in the correct format for S/36's Control Language.

---

## Initialization Subroutine (`*inzsr`)

- Sets all working variables to blank/zero.
- Extracts date parts (`uyear`, `umonth`, `uday`) and stores them in the working date variable.
- Receives and sets the parameter block (`p_valg`).

---

## Output Specifications (O-specs)

```rpg
 oqcllesrc  eadd         xrecut
 o                       w_recc              96
 o                       w_tell               6
 o                       w_dato              12
```
- Describes the format when writing each output record:
    - `w_recc` (96 bytes): main CL template line
    - `w_tell` (6 bytes): sequence or identifier field (usage context-specific)
    - `w_dato` (12 bytes): date field (usage context-specific)

---

## Data Section: CL Program Template (`rec` array)

The lines starting with `/*...*/` at the bottom are the raw data used to initialize the `rec` array. These are template lines of the CL program to be generated. Notice how the template includes substitution markers for program/library names and error handling.

---

## Summary

**Purpose:**  
- The program generates a CL source member with the appropriate CALL or STRS36PRC command for the selected procedures and system types (AS/400 or S/36), using input parameters, and wraps it with a customizable CL program template.

**Key Features:**  
- Fully parameterized via a packed parameter block.
- Supports two procedures/libraries of potentially two different system types.
- Outputs a CL program ready for execution, including error handling via `MONMSG`.

**Typical Usage:**  
- Run overnight or as part of a batch process to generate or refresh job control scripts dynamically.

**Main onboarding tip:**  
- **Understand the parameter block (`d_valg`):** That's where you direct the program what to generate.
- **Update or add CL template lines by modifying the `rec` array data.**
- **Expand for more procedures by extending corresponding arrays and loops.**

---

If you focus on the data mapping and subroutines that format the right CL command line, youâ€™ll quickly see how to tailor the output for different job automation needs!