# Overview

This program handles the display and maintenance of purchase parameters (“innkjøpsparameter”) for items (varer) within a warehouse or stock context. It uses a subfile to present and filter data, allowing users to position (search) on various fields, roll forwards/backwards through records, and invoke external programs for related data. 

The main entity here is a set of “MPROL” files (MPROL1, MPROL4, MPROL5, MPROL6, MPROL7, MPROL8), each indexed differently. This allows the user to navigate the same data set in different sequences (e.g., by item, warehouse, ABC codes, best point, etc.).

It also integrates with:
• VVARL1 for item descriptions (vvarl1)  
• VLAGL1 for warehouse details (vlagl1)  
• Various external programs (e.g., VP750R, LL101R, LL502R, MM502R, AX711R, VV500R, and VL712R) to handle more complex lookups and actions, such as cost pricing (“kostpris”) calculation, campaign handling (“kampanje”), warehouse maintenance, or general item inquiries.

## Key Responsibilities
1. **Displaying Purchase Parameters:** The program pulls data from the MPROL files and displays it in a subfile. Users can filter or position by item number, warehouse, ABC code, ordering thresholds, etc.  
2. **Subfile Navigation:** Standard subfile logic (roll up, roll down) is implemented to navigate data. The program uses indicators (e.g., *IN10, *IN11) to move through records.  
3. **Filtering & Positioning:** Users can provide specific filters (e.g., item code, ABC code) or partial filters, and the program repositions the database cursor accordingly. This is done through subroutines like POSISJONER, FORNY, CRT_SUBFILE, and BCK_SUBFILE.  
4. **Conditional Field Display:** Certain fields (like cost price, warehouse unit, or ABC classification) are selectively shown based on user input.  
5. **Integration with External Programs:**  
   - **LL101R, LL502R, MM502R, AX711R:** These handle warehouse maintenance, warehouse inquiries, and item forecasting.  
   - **VP750R:** Used to retrieve the cost price and potentially campaign-related pricing.  
   - **VL712R:** Retrieves the “prisgruppe” (price group) to factor in advanced pricing or discount logic.

## Notable Design and Conventions

1. **Multiple File References (MPROL1–MPROL8):**  
   - These references suggest that the same physical data is accessible under different logical views or keyed sequences. For example, MPROL1 is keyed by item, MPROL4 by warehouse, MPROL5 by ABC code, and so forth. This design lets the user change how records are sorted or found without rewriting the entire code—each file name is simply read in the relevant subroutine.

2. **Use of Indicators for Subfile Control:**  
   - Different indicators (10, 11, 12, etc.) are used for standard subfile page navigation, clearing the subfile, displaying it, and controlling various screen states (see the comment block for a list of which indicator is used for which purpose).

3. **Positional Searches (POSISJONER):**  
   - When the user enters search criteria (like a partial item number or warehouse code), the program sets the relevant file key (e.g., MPROL1_KEY) and does a SETLL to position the cursor. Then it refreshes the subfile to show data from that new position onward.

4. **Support for “Bla-alternativer” (xh1win subroutine):**  
   - The “xh1win” window is an additional filter or “browse options” feature. It modifies how the program determines whether to show only items with certain purchase parameters (for instance, only items that have nonzero best point or minimum stock).

5. **Cost Price and Campaign Logic:**  
   - The subroutine FINN_PRIS calls VP750R to determine cost price (w_kopr) and additional pricing info (w_inpr, w_kamp). This is part of the domain-specific logic, where items can have special pricing or campaign details that must be retrieved in real time.

6. **ABC Classification Handling:**  
   - Code checks for the ABC classification (mokabc) and whether it only contains an “ABC” portion or an “XYZ” portion. This logic filters items based on ABC code or extended ABC/XYZ codes.  
   - The H1KABC data structure (d_kabc, d_kxyz) indicates a split classification: one character each for “A/B/C” and “X/Y/Z.” The program checks these separately.

7. **LDA (Local Data Area) Usage:**  
   - The program stores user or firm references in LDA (e.g., l_firm). It reads those at initialization (in *INZSR) to figure out the current firm context (w_firm). This is a common approach to share environment settings.

8. **Subfile Page Size Management:**  
   - The constant c_sfil (initialized to 14) is the chunk size for each subfile page. The program increments a counter (w_spge) and then reads up to that many records. If the user pages backward, the program uses READP to step through the files in reverse.

## Flow Summary

1. **Initialization (*INZSR):**  
   - Sets keys, reads LDA values (like w_firm), and performs an initial SETLL (mprol1_key) to prepare the first subfile page.

2. **Main Routing (B2CTL logic):**  
   - Displays a command screen (b2cmd), then manages function keys. Examples:  
     - F3 / F12 (INKC / INKL) → Exit the program.  
     - F5 (INKE) → Refresh the subfile (calls FORNY).  
     - F9 (INKI) → Calls “MM733C” for an external routine, then refreshes.  
     - F11 (INKK) → Toggles “b_vise” (a flag that changes how item data is shown on the subfile line).  
     - F10 / F11 (IN10 / IN11) → Roll up / roll down subfile.  

3. **Subfile Build & Display:**  
   - SUBFILE subroutine loops through each record in the subfile (READC) to capture user interactions.  
   - CRT_SUBFILE reads data from the current keyed file sequence (MPROL1, MPROL4, etc.) until the page is filled or end-of-file is reached.  
   - BCK_SUBFILE handles paging backward, using READP to move records in reverse.

4. **Positioning / Filtering:**  
   - User-specified search fields (b2vare, b2lage, etc.) invoke the POSISJONER subroutine, which sets the appropriate key (SETLL) and rebuilds the subfile to show data starting from that position. The code then clears those search fields once the subfile is refreshed.

5. **Extended Detail Calls:**  
   - If a user indicates certain function-key selections (e.g., b1valg = 7), the program calls external modules for additional items or warehouse inquiries (MM502R, LL101R, LL502R).  

By structuring the code around different sequences (MPROL1–MPROL8) and a shared subfile design, this program centralizes how purchase parameters are displayed, navigated, and updated, making it an essential hub for users working with item- or warehouse-specific purchase data.