# Program VP726R – Documentation

## Overview

**Program Name:** VP726R  
**System:** ASOFAK  
**Purpose:**  
This program retrieves product prices for up to three sales units, including regular sales price, store price, cost price, and purchase price for the primary unit. It also fetches offer prices, campaign details, conversion factors, and related product information.

**Context:**  
VP726R is a variant of VP716R, specifically used for price inquiry scenarios where price suggestions should not be set as list prices.

---

## High-Level Functionality

Given input parameters (company, product, price group, delivery type, date, time, and warehouse), the program:

- Finds up to three sales units for the product.
- Retrieves prices (sales, store, cost, purchase) for the primary unit.
- Retrieves sales and store prices, and conversion factors for units 2 and 3.
- Determines valid offer/campaign prices and their periods.
- Finds the first purchase unit and the price comparison unit.
- Handles cases where no active offer is found by returning the most recent offer.
- Applies business rules for fallback logic on delivery type, price group, and product group hierarchy.

---

## Input and Output Parameters

### Inputs

- **Company (p_firm)**
- **Product (p_vare)**
- **Price group (p_prgr)**
- **Warehouse (p_lage)**
- **Delivery type (p_lety)**
- **Date (p_dato)**
- **Time (p_time)**

### Outputs

- **Sales unit 1–3 (p_enh1, p_enh2, p_enh3)**
- **Sales price 1–3 (p_sap1, p_sap2, p_sap3)**
- **Store price 1–3 (p_bup1, p_bup2, p_bup3)**
- **Cost price (p_kop1)**
- **Purchase price (p_inp1)**
- **Price date 1–3 (p_pda1, p_pda2, p_pda3)**
- **Conversion factor (p_omr2, p_omr3)**
- **Offer/campaign period (p_fdat, p_ftid, p_tdat, p_ttid)**
- **Campaign code (p_kamp)**
- **Offer price 1–3 (p_tip1, p_tip2, p_tip3)**
- **Offer cost price (p_tkp1)**
- **First purchase unit (p_enin)**
- **Price comparison unit (p_enps)**
- **Price for comparison unit (p_pspr)**

---

## File Dependencies

The program uses several physical files (tables), each renamed for local use:

- **vvprl1**: Product price register (`vvprpfr`)
- **vvenl2/vvenl4**: Product unit registers (`vvenpfr`)
- **vtill1**: Offer register (`vtilpfr`)
- **vvarl1**: Product master (`vvarpfr`)
- **vugrl1**: Product group register (`vugrpfr`)

---

## Key Business Logic and Flow

### Initialization (`*inzsr`)

- Loads parameters and sets up key lists for indexed file access.
- Initializes output parameters to default values.
- Determines "best price" logic by calling external program CO402R (see below).

### Main Processing

1. **Warehouse/Delivery Type Determination**
   - Calls program `VL721R` to determine the supplier for the product and warehouse.

2. **Product Information Retrieval**
   - Chains to the product master to ensure the product exists.

3. **Sales Units and Price Retrieval**
   - Iterates through up to three sales units for the product.
   - For each unit, attempts price retrieval in this order:
     1. Warehouse supplier (`w_ldor`)
     2. Main supplier (`vvldor`)
     3. No supplier (`0`)
   - For each, calls `hent_pris` subroutine to fetch price data.

4. **Conversion Factors**
   - Calculates conversion factors for units 2 and 3 relative to unit 1.

5. **Offer Price Retrieval**
   - Iteratively searches for valid offers in the following order:
     1. Product/price group/delivery type
     2. Delivery type = 0
     3. Price group blank
     4. Price group blank and delivery type = 0
     5. Product group/price group/delivery type (via `tilb_sjekk`)
     6. Most recent offer if no active offer found

   - Uses subroutines `bestem_tilb`, `tilb_sjekk`, and `hent_tilb` for these searches.

6. **Cost Price Calculation**
   - If cost price is zero, calculates based on margin percentage at product or group level.

7. **Purchase and Comparison Units**
   - Determines first purchase unit from product unit register.
   - If price comparison unit is not specified, attempts to retrieve from product group.

8. **Comparison Price**
   - Sets price for the comparison unit if available.

---

## Subroutines

### `hent_pris`
Retrieves price information for the current sales unit, using the following fallback order:

1. Specific supplier and delivery type.
2. Delivery type = 0.
3. Price group blank.

Populates the relevant output parameters for the current unit.

### `bestem_tilb`
Extracts offer/campaign data and offer prices for each sales unit from the offer record.

### `tilb_sjekk`
Attempts to find an offer at various product group levels, with or without supplier, by manipulating the offer register key and calling `hent_tilb`.

### `hent_tilb`
Performs the actual file reads for offers at the current key and populates offer prices using percentage discounts if found.

---

## External Program Calls

- **VL721R**: Determines supplier for product/warehouse.
- **CO402R**: Determines if "best price" logic should be used. If so, the program will always select the lowest available offer price.

---

## Notable Design Details

- **Fallback Logic**:  
  The program is highly defensive, with multiple fallback strategies for both price and offer lookups, reflecting complex business requirements for pricing.
  
- **Key Construction**:  
  All file accesses use pre-built key lists, making index management explicit and maintainable.
  
- **Offer Price Selection**:  
  If "best price" logic is active (set by CO402R), the program will scan all available offers and select the one with the lowest price, rather than stopping at the first match.

- **Margin-Based Cost Calculation**:  
  If no cost price is found, the margin percentage (either at product or group level) is used to estimate cost price from the sales price.

- **Parameter Passing**:  
  All input/output is via parameters, making the program suitable for use as a subroutine or service in batch or interactive contexts.

- **Product Group Hierarchy**:  
  The program can search for offers at multiple levels of the product group hierarchy (overgroup, main group, subgroup), and with/without supplier, to maximize the chance of finding a relevant offer.

---

## File Relationships

- **vvprl1**: Product price by supplier, price group, unit, delivery type.
- **vvenl2/vvenl4**: Sales and purchase units for products.
- **vtill1**: Offers/campaigns by product, group, supplier, price group, delivery type.
- **vvarl1**: Product master for base data.
- **vugrl1**: Product group hierarchy and margin data.

---

## Special Version Notes / Customization

- The program has evolved over time to support:
  - Extended price group field.
  - Offer lookups by product group and supplier.
  - Warehouse as an input parameter.
  - "Best price" logic.
- Comments and version tags in the code (e.g., `5.70`, `6.20`, `7.01`) indicate major business or logic changes, often tied to customer requirements or regulatory changes.

---

## Error Handling

- If a product is not found in the master file, the program exits early.
- If no prices or offers are found at any level, output fields remain at their initialized values (typically zero or blank).
- The program never raises exceptions; it is designed to always return a result, even if that result is "no price found".

---

## Integration Points

- **CO402R**: Used to determine whether to use "best price" logic.
- **VL721R**: Used to determine the supplier for a product/warehouse.

---

## Usage Notes for New Developers

- The program is designed for use by other RPG programs or CL programs, not as a standalone interactive tool.
- All input/output is via parameter lists; ensure correct parameter order and types.
- When extending the pricing logic, ensure new fallback rules are consistent with the existing order of precedence.
- Changes to file structures (e.g., price group length) must be reflected in both the RPG code and the database.
- The offer search logic is intentionally exhaustive; do not short-circuit unless the business requirements change.

---

## Summary Table: Output Fields

| Field         | Description                                  |
|---------------|----------------------------------------------|
| p_enh1-3      | Sales units 1–3                              |
| p_sap1-3      | Sales prices 1–3                             |
| p_bup1-3      | Store prices 1–3                             |
| p_kop1        | Cost price for unit 1                        |
| p_inp1        | Purchase price for unit 1                    |
| p_pda1-3      | Price dates for units 1–3                    |
| p_omr2-3      | Conversion factors for units 2 and 3         |
| p_fdat/tdat   | Offer/campaign period (from/to date)         |
| p_ftid/ttid   | Offer/campaign period (from/to time)         |
| p_kamp        | Campaign code                                |
| p_tip1-3      | Offer prices for units 1–3                   |
| p_tkp1        | Offer cost price for unit 1                  |
| p_enin        | First purchase unit                          |
| p_enps        | Price comparison unit                        |
| p_pspr        | Price for comparison unit                    |

---

## For Further Reference

- **Business Rules**: See comments in the code for detailed explanations of fallback scenarios.
- **File Layouts**: Ensure familiarity with the physical files referenced, especially key structures.
- **External Programs**: Review documentation for CO402R and VL721R for integration details.

---

**If you have further questions about specific sections or business rules, consult the in-code comments (notably in Norwegian) or contact the system analyst for ASOFAK.**