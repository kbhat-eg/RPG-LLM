pdf  h option(*nodebugio) datedit(*dmy-) decedit('0.')
pdf  h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
pdf   /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Program . . . . : LE612R
      *  Beskrivelse . . : Utskrift av avvik-liste, Utskriften
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Spesialversjon. :
      *  Tilpasset for . :
      *
      *  Referanse  Dato   Endringsbeskrivelse                     Sign.
      *  --------- ------  -------------------------------------------------
FIX   *  FIX       290408  Skriver hdr på inzsr                    TSV
5.61  *  R5.61     060110  Variabler som sprekker på utskrift      AMD
5.70  *  PRGR     021208  Utvidet med prisgruppe                   bof
6.10  *  R6.10    191109  Henter saldo fra lest lager              bsa
6.11  *  R6.10    230710  Må huske å behandle alle linjene ;-)     bsa
pdf   *  R6.10    260811  Lagt inn mulighet for eksport til excel  bsa
6.20  *  R6.20    190111  Hvis syklisk telling,så timestamp        bof
6.12  *  R6.10    161211  Mangler linje, feiler xml validering     bsa
6.30  *  R6.30    130814  Utvidet med kolonner og utvalg           bsa
6.30  *                   Avvikskolonne i bunnen
6.30  *                   Tatt bort * for å hente fra historikk
6.30  *                   Utvidet felter da de sprekker på
6.30  *                   størrelse.
6.31  * R6.30 120914 bsa  Utvidet parameterliste til FO798R.
6.32  * 6.30  280115 bsa  Skriver til datakø for å trigge java sniffer
6.33  * 6.30  220514 BKV  Utvidet parameterliste til FÅ707R
6.34  * 6.30  050615 bsa  Nullstill minne
6.35  * 6.30  140315 nho  Rekompilert pga endring i  printerfil
6.36  * 6.30  211016 bsa  Tar høyde for 0 i lagerverdi
6.37  * 6.30  281216 bsa  Hvis ikke syklisk telling, skal antall hentes
6.37  *                   fra telleliste, og ikke historisk lager.
6.38  * 6.30  030117 bsa  Sender med lager til prisprogram.
6.39  * 6.30  040117 bsa  Endrer batchtype pga mulige problemer med
6.39  *                   excel og firefox.
6.3a  * 6.30  090117 bsa  Hvis ikke excel er valgt, men PROA aktivert,
6.3a  *                   må vi hente spoolmal.
6.3b  * 6.30  241017 nho  Skaffevarer skal også ut på lista
6.3c  * 6.30  081018 bof  Utvidet med trelast sortiment
6.3d  * 6.30  040118 bof  sjekk om  d1diff > 99999
7.01  * 7.00  050320 bsa  Utvidet med lagerplass
8.01  *PRG2   150622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flsorl2    if   e           k disk    rename(lsorpfr:lsorl2r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
     flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
     flbchl1    if   e           k disk    rename(lbchpfr:lbchl1r)
     fvhisl1    uf   e           k disk    rename(vhispfr:vhisl1r)
pdf  fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
pdf  fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
6.30 fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
      *
     fle612p    o    e             printer
6.3a f                                     usropn
      *
      * Parameter-inn
      *
     d                 ds
     d d_prec                        64
     d  d_batc                       10    overlay(d_prec)
     d  d_fogr                        2  0 overlay(d_prec:11)
     d  d_togr                        2  0 overlay(d_prec:13)
     d  d_fhgr                        2  0 overlay(d_prec:15)
     d  d_thgr                        2  0 overlay(d_prec:17)
     d  d_fugr                        3  0 overlay(d_prec:19)
     d  d_tugr                        3  0 overlay(d_prec:22)
     d  d_fvar                       15    overlay(d_prec:25)
     d  d_tvar                       15    overlay(d_prec:40)
     d  d_flag                        2  0 overlay(d_prec:55)
     d  d_tlag                        2  0 overlay(d_prec:57)
     d  d_val1                        1  0 overlay(d_prec:59)
     d  d_val2                        1  0 overlay(d_prec:60)
      *
      * Definering av LDA
      *
     d                uds
pdf  d l_poff                584    584
pdf  d l_utqm                585    594
pdf  d l_bach                595    635
pdf  d l_arch                636    636  0
pdf  d l_skje                637    637  0
pdf  d l_land                638    638  0
pdf  d l_exlp                639    639  0
pdf  d l_mail                640    640  0
pdf  d l_prfi                750    750  0
pdf  d l_outq                810    819
pdf  d l_copy                838    843  0
     d l_ruti                800    809
     d l_wsid                901    910
     d l_user                        10
pdf  d l_filg                931    933
     d l_firm                944    946  0
pdf  d l_avde                947    950  0
     d l_fnav                951    980
pdf   *
pdf   * Definering av parametre
pdf   *
pdf  d p_mail          s              1
pdf  d p_kund          s              6  0
pdf  d p_kpro          s              6  0
6.nu d p_numm          s              8  0
6.31 d p_suff          s              2  0
pdf  d p_selg          s              4  0
pdf  d p_serv          s             35
pdf  d p_stat          s              1
pdf  d p_kule          s              1
pdf  d p_navn          s             30
pdf  d p_emal          s             50
pdf  d p_ema2          s             50
6.31 d p_ema3          s             50
6.31 d p_kopi          s             50
pdf  d p_emne          s             50
pdf  d p_txt1          s             50
pdf  d p_txt2          s             50
pdf  d p_txt3          s             50
pdf  d p_txt4          s             50
pdf  d p_pers          s             50
pdf  d p_inif          s             40
pdf  d p_in03          s              1
pdf  d p_ok            s              1
pdf  d p_lr            s              1
pdf  d p_str_in        s            512
pdf  d p_str_out       s            512
6.32 d p_filg          s             10
6.32 d p_xmlf          s            256
6.38 d p_lage          s              2  0
      *
pdf  d b_pdfp          s              1    inz(*off)
pdf  d b_deta          s              1    inz(*off)
pdf  d b_tota          s              1    inz(*off)
6.12 d b_line          s              1    inz(*off)
6.3c d b_inlr          s              1    inz(*off)
      *
      * Definering av variable i parametre
      *
     d p_vare          s             15
     d p_lety          s              1  0
     d p_dato          s                   like(lcedat)
     d p_enhe          s              3
     d p_sapr          s              9  2
     d p_gmpr          s              9  2
     d p_kopr          s              9  2
     d p_inpr          s              9  2
      *
      * Definering av variable i nøkler
      *
     d aforl1_ruti     s                   like(afruti)
     d lstsl1_firm     s                   like(laafir)
     d lbchl1_batc     s                   like(lcbatc)
     d vhisl1_lage     s                   like(vhlage)
     d vhisl1_vare     s                   like(vhvare)
     d vhisl1_dato     s                   like(vhdato)
     d vhisl1_time     s                   like(vhtime)
pdf  d vvarl1_vare     s                   like(vvvare)
6.30 d vlagl1_vare     s                   like(vlvare)
6.30 d vlagl1_lage     s                   like(vllage)
      *
      * Definering av variable
      *
     d w_parm          s             64
     d w_firm          s                   like(lwfirm)
     d w_antl          s                   like(lwantl)
     d w_slag          s                   like(lwlage)
5.70 d w_avde          s              4  0
8.01 d w_prgr          s              2
6.3c d w_vtyp          s              1
6.3c d w_nobb          s                   like(vvnobb)
6.3c d w_ldor          s              6  0
6.3c d w_utda          s                   like(lcedat)
6.3c d w_lv_nobb       s                   like(vvnobb)
6.3c d w_lv_modn       s                   like(vvnmod)
6.3c d w_lv_lldo       s                   like(vvldor)
6.3c d w_lv_llva       s                   like(vvlvar)
7.01 d w_plas          s             50
7.01 d w_pla1          s             50
7.01 d w_pla2          s             50

      *
6.20 d b_sykl          s              1    inz(*off)
      *
pdf  d w_ddmy          s              6  0
pdf  d w_prfi          s              1  0
pdf  d w_ffir          s              3  0
pdf  d w_fnav          s             30
pdf  d w_fad1          s             30
pdf  d w_fad2          s             30
pdf  d w_fste          s             30
pdf  d w_fftx          s             30
pdf  d w_tfax          s              8
pdf  d w_ftlf          s             11
pdf  d w_ffax          s             11
6.33 d w_mail          s             50
6.33 d w_weba          s             50
pdf  d w_head          s             75
      *
pdf  d w_bdat          s               d   datfmt(*iso)
pdf  d w_date          s               d   datfmt(*iso)
pdf  d w_dato2         s             12  0
pdf  d w_kode          s              1
pdf  d w_fell          s              6
pdf  d w_type          s              2
pdf  d w_fast          s             10
pdf  d w_ruti          s             10
pdf  d w_numm          s              6  0
pdf  d w_pdf           s              1  0
pdf  d w_jnav          s             15
pdf  d w_jkey          s             41
pdf  d w_jtxt          s             35
pdf  d w_pdf_ds        s            512
pdf  d w_mtxt          s            300
pdf  d w_jstat         s              2  0
pdf  d w_jtext         s            200
pdf  d w_text          s            200
pdf  d w_ogtx          s             50
pdf  d w_hgtx          s             50
pdf  d w_ugtx          s             50
pdf  d w_khtx          s             50
pdf  d w_ltek          s             50
pdf  d w_land          s              9
pdf  d w_mark          s              5
pdf  d w_spol          s              5
pdf  d w_x             s              3  0
pdf  d w_path          s            256
pdf  d w_ema2          s             50
pdf  d w_ttype         s              1
pdf  d w_draw1         s             10
pdf  d w_draw2         s             10
pdf  d w_dspl          s            100
pdf  d w_tek1          s            512
pdf  d w_tek2          s            512
pdf  d w_copy          s              3  0
pdf  d w_faks          s             30
pdf  d w_pemne         s             75
pdf  d w_ptxt1         s             75
pdf  d w_ptxt2         s             75
pdf  d w_ptxt3         s             75
pdf  d w_ptxt4         s             75
pdf  d w_ppers         s             75
pdf  d w_rekv          s             50
pdf  d w_1fnav         s             50
pdf  d w_1fad1         s             50
pdf  d w_1fad2         s             50
pdf  d w_1navn         s             50
pdf  d w_1gate         s             50
pdf  d w_1adr2         s             50
pdf  d w_txt1          s             75
pdf  d w_rtyp          s             50
pdf  d w_txt2          s             50
6.34 d w_mime          s             24
pdf  d t_spsu          s             11  2
pdf  d t_kpsu          s             11  2
6.30 d t_topp          s             11  2
6.30 d t_totl          s             11  2
6.30 d t_totd          s             11  2
6.30 d t_todp          s             11  4
pdf  d t_text          s             75
pdf   *
pdf  d XML_Output      s            256a   Varying
pdf  d XML_path        s            256a   Varying
pdf  d                                     Inz('/home/asp/print/adb')
pdf  d jasper_mal      s            256a
pdf  d jasper_logo     s            256a   varying
pdf  d tmpdate         s               D
pdf  d tmptime         s               T
pdf  d crlf            c                   const(X'0d25')
pdf   *
pdf  d d_pdf_ds        ds
pdf  d  d_xmlm                       75
pdf  d  d_jasm                       75
pdf  d  d_logo                       75
pdf  d  d_path                      100
pdf  d  d_emal                       50
6.32 d  d_fifo                       75
6.32 d  d_fkop                        1
6.32 d  d_dtaq                        1
6.32 d  d_sign                        1
pdf   /copy prototypeb
pdf   /copy usec
pdf   *
6.3a d p_btyp          s            100
6.3a d splfname2       s             10a
6.3a d jobname2        s             10a
6.3a d username2       s             10a
6.3a d jobnbr2         s              6a
6.3a d splfnbr2        s             10i 0
6.3a d splfname3       s             10a
6.3a d jobname3        s             10a
6.3a d username3       s             10a
6.3a d jobnbr3         s              6a
6.3a d splfnbr3        s             10i 0
6.3a d p_tagg0         s             20
6.3a d p_tagg0val      s             50
6.3a d p_tagg1         s             20
6.3a d p_tagg1val      s             50
6.3a d p_tagg2         s             20
6.3a d p_tagg2val      s             50
6.3a d p_tagg3         s             20
6.3a d p_tagg3val      s             50
6.3a d p_tagg4         s             20
6.3a d p_tagg4val      s             50
6.3a d p_tagg5         s             20
6.3a d p_tagg5val      s             50
6.3a d p_tagg6         s             20
6.3a d p_tagg6val      s             50
6.3a d p_tagg7         s             20
6.3a d p_tagg7val      s             50
6.3a d p_tagg8         s             20
6.3a d p_tagg8val      s             50
6.3a d p_tagg9         s             20
6.3a d p_tagg9val      s             50
6.3a d p_refn          s             50
6.3a d p_dspl          s            100
6.3a  *
6.3a d qsprilsp        pr                  extpgm('QSPRILSP')
6.3a d rcvvar                     32767a   options(*varsize)
6.3a d rcvvarlen                     10i 0 const
6.3a d format                         8a   const
6.3a d errorcode                  32767a   options(*varsize)
6.3a  *
6.3a d sprl0100        ds
6.3a d  bytesrtn                     10i 0
6.3a d  bytesavl                     10i 0
6.3a d  splfname                     10a
6.3a d  jobname                      10a
6.3a d  username                     10a
6.3a d  jobnbr                        6a
6.3a d  splfnbr                      10i 0
6.3a d  systemname                    8a
6.3a d  createdate                    7a
6.3a d                                1a
6.3a d  createtime                    6a
6.3a  *
6.3a d errorcode       ds
6.3a d  bytesprov                    10i 0 inz(0)
6.3a d  byteavail                    10i 0 inz(0)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av LAGER-RECORD-Opplysninger
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     les_neste     tag
     c                   read      lsorl2
     c                   if        %eof
     c                   goto      slutt
     c                   endif
      *
      * Brudd på lager?
      *
     c                   if        w_slag <> 0 and
     c                             w_slag <> lwlage
     c                   exsr      lagut
     c                   endif
     c                   eval      w_slag = lwlage
      *
      *  Legger inn data i utskrifts-felter
      *
     c                   exsr      hent_lage
     c                   exsr      hent_pris
pdf  c                   exsr      hent_vare
6.30 c                   exsr      hent_lagvare
      *
5.61  *
5.61 c                   if        lwantt > 99999,999
5.61 c                   eval      lwantt = 99999,999
5.61 c                   endif
5.61 c                   if        lwantt < -99999,999
5.61 c                   eval      lwantt = -99999,999
5.61 c                   endif
5.61  *
5.61  *
5.61 c                   if        w_antl > 99999,999
5.61 c                   eval      w_antl = 99999,999
5.61 c                   endif
5.61 c                   if        w_antl < -99999,999
5.61 c                   eval      w_antl = -99999,999
5.61 c                   endif
5.61  *
     c                   eval      d1lage = lwlage
     c                   eval      d1vare = lwvare
     c                   eval      d1tek1 = lwtek1
     c                   eval      d1antt = lwantt
     c                   eval      d1enh1 = lwenh1
     c                   eval      d1antl = w_antl
6.3d C                   if        (lwantt - w_antl) > 99999
6.3d c                   eval      d1diff = 99999,999
6.3d c                   else
     c                   eval      d1diff = lwantt - w_antl
6.3d c                   endif
     c                   eval      d1spny = p_sapr
     c                   eval      d1kpny = p_kopr
     c                   eval(h)   d1spsu = d1spny * d1diff
     c                   eval(h)   d1kpsu = d1kpny * d1diff
6.30 c                   eval(h)   d1topp = d1kpny * lwantt
6.30 c                   eval(h)   d1totl = d1kpny * w_antl
6.30 c                   eval(h)   d1totd = d1kpny * d1diff
6.30 c                   if        d1totd < 0
6.30 c                   eval      d1totd = d1totd * -1
6.30 c                   endif
      *
      *  Sjekk, Skal det bare skrives ut varer med differanse
      *
     c                   if        d_val2 = 1
     c                   if        d1diff = *zero
6.11 c**                 goto      slutt
6.11 c                   goto      les_neste
     c                   endif
     c                   endif
      *
      *  Sjekk, Skal det bare skrives ut varer med 0 i antall tellet
      *
     c                   if        d_val2 = 2
     c                   if        d1antt > *zero
6.11 c**                 goto      slutt
6.11 c                   goto      les_neste
     c                   endif
     c                   endif
6.30  *
6.30  *  Sjekk, Skal det bare skrives ut negativ differanse
6.30  *
6.30 c                   if        d_val2 = 3
6.30 c                   if        d1diff >= *zero
6.30 c                   goto      les_neste
6.30 c                   endif
6.30 c                   endif
6.30  *
6.30  *  Sjekk, Skal det bare skrives ut positiv differanse
6.30  *
6.30 c                   if        d_val2 = 4
6.30 c                   if        d1diff <= *zero
6.30 c                   goto      les_neste
6.30 c                   endif
6.30 c                   endif
6.30  *
6.30  *  Sjekk, Skal det bare skrives uten differanse
6.30  *
6.30 c                   if        d_val2 = 5
6.30 c                   if        d1diff <> *zero
6.30 c                   goto      les_neste
6.30 c                   endif
6.30 c                   endif
      *
      *  Akkumulerer til totalfelter
      *
     c                   eval      l1spsu = l1spsu + d1spsu
     c                   eval      l2spsu = l2spsu + d1spsu
     c                   eval      l1kpsu = l1kpsu + d1kpsu
     c                   eval      l2kpsu = l2kpsu + d1kpsu
6.30 c                   eval      l1topp = l1topp + d1topp
6.30 c                   eval      l2topp = l2topp + d1topp
6.30 c                   eval      l1totl = l1totl + d1totl
6.30 c                   eval      l2totl = l2totl + d1totl
6.30 c                   eval      l1totd = l1totd + d1totd
6.30 c                   eval      l2totd = l2totd + d1totd
      *
      *  Skriver ut vanlige varer
      *
     c   70              if        lwnumm = *zero
pdf  c                   if        b_pdfp = *off
     c                   write     d1det                                30
6.3b c                   eval      *in55 = '0'
     c                   if        *in30 = *on
     c                   exsr      ovflow
     c                   endif
pdf   * Skriver XML tagger for detaljer
pdf  c                   else
pdf  c                   exsr      xml_deta
pdf  c                   endif
     c                   endif
      *
     c                   goto      les_neste
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     slutt         tag
      *
     c                   exsr      lagut
     c                   exsr      firut
pdf   * Hvis xml gen, må vi kvittere med siste vanlige linjetag
pdf  c                   if        b_pdfp = *on
pdf   * Skriv xml fila på disk
pdf  c                   exsr      xml_end
pdf   * Hvis forhåndvisning må vi kjøre linken
pdf  c                   if        l_skje = 1 and
pdf  c                             l_bach = w_jkey or
pdf  c                             l_exlp = 1 and
pdf  c                             l_bach = w_jkey
pdf  c                   exsr      pdf_preview
pdf  c                   endif
pdf   * Avslutt jobbiden
pdf  c                   call      'AB710R'
pdf  c                   parm                    l_bach
6.3a c                   goto      avslutt
pdf  c                   endif
6.3a  *
6.3a c                   if        l_poff = '1'
6.3a c                   exsr      spoolnbr
6.3a c                   endif
6.3a  *
6.3a c                   close     le612p
6.3a  *
6.3a  * Hvis ikke excel, og proa er aktivert, lag standard spoolfile
6.3a  *
6.3a c                   if        l_poff = '1'
6.3a c                   exsr      xml_create
6.3a c                   exsr      pdf_preview2
6.3a  * Avslutt jobbid
6.3a c                   call      'AB710R'
6.3a c                   parm                    l_bach
6.3a c                   endif
      *
6.3a c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  LAGUT     Behandling av brudd på lager
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     lagut         begsr
      *
6.30 c                   eval      l1todp = 0
6.30 c                   if        l1totl <> 0
6.30 c                   eval      l1todp = (l1totd/l1totl)*100
6.30 c                   endif
      *
pdf  c                   if        b_pdfp = *off
     c                   write     l1tot                                30
     c                   if        *in30 = *on
     c                   exsr      ovflow
     c                   endif
pdf   * Skriver XML tagger for detaljer
pdf  c                   else
pdf  c                   eval      t_text = 'Totalt lager:     '
pdf  c                   eval      t_spsu = l1spsu
pdf  c                   eval      t_kpsu = l1kpsu
6.30 c                   eval      t_topp = l1topp
6.30 c                   eval      t_totl = l1totl
6.30 c                   eval      t_totd = l1totd
6.30 c                   eval      t_todp = 0
6.36 c                   if        t_totl <> 0 and
6.36 c                             t_totd <> 0
6.30 c                   eval      t_todp = (t_totd/t_totl)*100
6.30 c                   endif
pdf  c                   exsr      xml_total
pdf  c                   endif
     c                   eval      l1spsu = 0
     c                   eval      l1kpsu = 0
6.30 c                   eval      l1topp = 0
6.30 c                   eval      l1totl = 0
6.30 c                   eval      l1totd = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  FIRUT     Behandling av brudd på firma
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     firut         begsr
      *
6.30 c                   eval      l2todp = 0
6.30 c                   if        l2totl <> 0
6.30 c                   eval      l2todp = (l2totd/l2totl)*100
6.30 c                   endif
      *
pdf  c                   if        b_pdfp = *off
     c                   write     l2tot                                30
pdf   * Skriver XML tagger for detaljer
pdf  c                   else
pdf  c                   eval      t_text = 'Totalt firma:     '
pdf  c                   eval      t_spsu = l2spsu
pdf  c                   eval      t_kpsu = l2kpsu
6.30 c                   eval      t_topp = l2topp
6.30 c                   eval      t_totl = l2totl
6.30 c                   eval      t_totd = l2totd
6.30 c                   eval      t_todp = 0
6.36 c                   if        t_totl <> 0 and
6.36 c                             t_totd <> 0
6.30 c                   eval      t_todp = (t_totd/t_totl)*100
6.30 c                   endif
pdf  c                   exsr      xml_total
pdf  c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  OVFLOW    Behandling av overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     ovflow        begsr
      *
      *  Skriver heading
      *
     c                   write     a1hdr                                30
      *
     c                   endsr
      *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
pdf   *  Subrutine for å hente vareinformasjon
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
pdf  c     hent_vare     begsr
pdf   *
pdf   * Finn vareinformasjon
pdf   *
pdf  c                   eval      vvarl1_vare = lwvare
pdf  c     vvarl1_key    chain     vvarl1
pdf   *
pdf  c*                  if        not %eof
pdf  c*                  eval      w_antl = vhbehl
pdf  c*                  endif
      * henter info om logistikk-vare
6.3c c                   call      'VL710R'
6.3c c                   parm                    w_firm
6.3c c                   parm                    lwvare
6.3c c                   parm                    lwlage
6.3c c                   parm                    w_vtyp
6.3c c                   parm                    w_utda
6.3c c                   parm                    w_ldor
6.3c c                   parm                    b_inlr
6.3c c                   parm                    w_lv_nobb
6.3c c                   parm                    w_lv_modn
6.3c c                   parm                    w_lv_lldo
6.3c c                   parm                    w_lv_llva
6.3c  *
pdf  c                   endsr
pdf   *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.30  *  Subrutine for å hente lagerinformasjon
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.30 c     hent_lagvare  begsr
6.30  *
6.30 c                   eval      d1abck = *blanks
7.01 c                   eval      w_plas = *blank
7.01 c                   eval      w_pla1 = *blank
7.01 c                   eval      w_pla2 = *blank
6.30  *
6.30 c                   eval      vlagl1_vare = lwvare
6.30 c                   eval      vlagl1_lage = lwlage
6.30 c     vlagl1_key    chain     vlagl1
6.30  *
6.30 c                   if        not %eof
6.30 c                   eval      d1abck = vltabc
6.30 c                   endif
6.30  *
7.01 c                   if        %found
7.01 c                   eval      w_plas = vlplas
7.01 c                   eval      w_pla1 = vlpla1
7.01 c                   eval      w_pla2 = vlpla2
7.01 c                   endif
6.30  *
6.3b c                   if        vlvtyp = 'S'
6.3b c                   eval      d1skaf = '(S)'
6.3b c                   eval      *in55  = '1'
6.3b c                   endif
6.3b  *
6.30 c                   endsr
6.30  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for å hente lagersaldo
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_lage     begsr
      *
     c                   eval      w_antl = 0
6.37  * Hent i utgangspunktet beholdning fra telleliste
6.37 c                   eval      w_antl = lwantl
      *
      * Finn riktig startpunkt og beholdning
      *
6.37 c                   if        b_sykl = *on
     c                   eval      vhisl1_vare = lwvare
6.10 c**                 eval      vhisl1_lage = d_flag
6.10 c                   eval      vhisl1_lage = lwlage
6.37 c**                 if        b_sykl = *on
6.30 c                   move      lwtims        vhisl1_dato
6.30 c                   move      lwtims        vhisl1_time
6.37 c**                 endif
     c     vhisl1_key1   setll     vhisl1
     c     vhisl1_key1   reade     vhisl1
     c                   if        %eof
     c     vhisl1_key1   setll     vhisl1
     c     vhisl1_key2   readpe    vhisl1
     c                   endif
      *
     c                   if        not %eof
     c                   eval      w_antl = vhbehl
     c                   endif
      *
6.37 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for å hente priser på lagerenhet ved telleslutt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_pris     begsr
      *
5.70 c                   exsr      hent_prisgr
     c                   eval      p_lety = 0
     c                   eval      p_vare = lwvare
     c                   eval      p_enhe = lwenh1
6.38 c                   eval      p_lage = lwlage
      *
     c                   call      'VP730R'
     c                   parm                    w_firm
     c                   parm                    p_vare
5.70 c                   parm                    w_prgr
     c                   parm                    p_lety
     c                   parm                    p_dato
     c                   parm                    p_enhe
     c                   parm                    p_sapr
     c                   parm                    p_gmpr
     c                   parm                    p_kopr
     c                   parm                    p_inpr
6.38 c                   parm                    p_lage
      *
     c     pris_end      endsr
5 70  *
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5 70  * Subrutine for å hente prisgruppe
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.70  *
5.70 c     hent_prisgr   begsr
5.70  *
5.70 c                   eval      w_avde = 0
5.70 c                   call      'VL712R'
5.70 c                   parm                    w_firm
5.70 c                   parm                    lwlage
5.70 c                   parm                    w_avde
5.70 c                   parm                    w_prgr
5.70  *
5.70 c                   endsr
      *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_envm      begsr
pdf   * Hvis skjermvisning skal vi ikke lagre i spoolfile
pdf  c                   if        l_skje = 1 or
pdf  c                             l_exlp = 1
pdf  c                   eval      w_spol = 'true'
pdf  c                   else
pdf  c                   eval      w_spol = 'false'
pdf  c                   endif
pdf   * Sjekk om det er PDF eller excel som skal vises
pdf  c                   if        l_exlp > 0
pdf  c                   eval      w_rtyp = 'XmlExcelDocumentReportCommand'
pdf  c                   eval      d_jasm = *blank
6.30 c*                  eval      d_jasm = 'FILE:/HOME/ADBBER/PRINT/MALER/+
pdf  c*****              eval      d_jasm = 'FILE:/HOME/ADBBER/PRINT/MALER/+
6.30 c*                            TELLEAVVIKSLISTE/TELLEAVVIKSLISTE_XL.JASPER'
pdf  c                   else
pdf  c                   eval      w_rtyp = 'XmlDocumentReportCommand'
pdf  c                   endif
pdf   *
pdf   /Free
pdf        // Finne nytt batch nummer
pdf            UpdHTMLVar('BatchNo':               w_jkey);
6.39           UpdHTMLVar('Batchtype':       'TELLEAVVIK');
pdf            UpdHTMLVar('Username':              l_user);
pdf            WrtSection('Topp');
pdf        // Finn report command variabler
pdf            UpdHTMLVar('User':                l_user);
pdf            UpdHTMLVar('PW':                     ' ');
pdf            UpdHTMLVar('IPAdr':                  ' ');
pdf            UpdHTMLVar('Schema':        'ADB'+l_filg);
pdf            UpdHTMLVar('Companyno':    %char(l_firm));
pdf            WrtSection('Credential');
pdf        // Finn report command variabler
pdf            UpdHTMLVar('Reportcommandtype':   w_rtyp);
pdf            UpdHTMLVar('Jaspertemplate':      d_jasm);
pdf            UpdHTMLVar('Logo':           jasper_logo);
pdf            UpdHTMLVar('Keepspool':           w_spol);
pdf            WrtSection('ReportCommand');
pdf   /End-free
pdf   *
pdf   * Hvis skjermvisning skal ikke PDF skrives
pdf   *
pdf  c                   if        l_skje = 0 and
pdf  c                             l_mail = 0 and
pdf  c                             l_exlp = 0
pdf   * Hvis *ARKIV er valgt som skriver, skal det ikke skrives ut
pdf  c                   if        l_utqm <> '*ARKIV'
pdf   *
pdf  c                   if        l_land = 1
pdf  c                   eval      w_land = 'LANDSCAPE'
pdf  c                   else
pdf  c                   eval      w_land = 'PORTRAIT'
pdf  c                   endif
pdf   * Sjekk at valgt outq støttes av skriveren. Kan skli gjennom hvis
pdf   * jobben legges på jobbkø.
pdf  c                   eval      p_ok = '0'
pdf  c                   call      'AP612R'
pdf  c                   parm                    l_filg
pdf  c                   parm                    l_outq
pdf  c                   parm                    p_ok
pdf   * Hvis feil utkø, logges dette i transaksjonsloggen
pdf  c                   if        p_ok = '0'
pdf  c                   eval      w_jstat = 20
pdf  c                   eval      w_jtext = 'Ugyldig utkø '+ l_outq + ' er val+
pdf  c                             gt. Ingen utskrift er generert. Utskrift kan+
pdf  c                              arkiveres.'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf  c                   else
pdf   *
pdf  c                   if        l_copy > 0
pdf  c                   eval      w_copy = l_copy
pdf  c                   else
pdf  c                   eval      w_copy = 1
pdf  c                   endif
pdf   *
pdf   *
pdf   /Free
pdf        // Finn print informasjon
pdf            UpdHTMLVar('Printername':         l_outq);
pdf            UpdHTMLVar('Copies':        %char(w_copy));
pdf            UpdHTMLVar('Papersource':            ' ');
pdf            UpdHTMLVar('Lastpagedrawer':         ' ');
pdf            UpdHTMLVar('Duplex':              'true');
pdf            UpdHTMLVar('Quality':                ' ');
pdf            UpdHTMLVar('Sorting':                ' ');
pdf            UpdHTMLVar('Staple':              'true');
pdf            UPDHTMLVar('Alignment':           w_land);
pdf            WrtSection('PrintCommand');
pdf   /End-free
pdf  c                   endif
pdf  c                   endif
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading                 *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_head      begsr
pdf   *
pdf  c                   eval      w_head = 'Utskrift av avviksliste telling'
pdf   *
pdf   * Hvis mail skal skrives, må vi hente mail informasjon
pdf   *
pdf  c                   if        l_mail = 1
pdf  c                   eval      p_kule = 'L'
pdf  c                   eval      p_kund = vvldor
pdf  c                   eval      p_kpro = *zeros
pdf  c                   eval      p_numm = *zeros
6.31 c                   eval      p_suff = *zeros
pdf  c                   eval      p_selg = *zeros
pdf  c                   eval      p_in03 = *off
pdf   * Henter ut mailserver
pdf  c                   eval      p_serv = *blank
pdf  c                   eval      p_stat = *blank
pdf  c                   call      'AM705C'
pdf  c                   parm                    p_serv
pdf  c                   parm                    p_stat
pdf   *
pdf  c                   call      'FO798R'
pdf  c                   parm                    p_kule
pdf  c                   parm                    p_kund
pdf  c                   parm                    p_kpro
pdf  c                   parm                    p_numm
6.31 c                   parm                    p_suff
pdf  c                   parm                    p_selg
pdf  c                   parm                    p_navn
pdf  c                   parm                    p_emal
6.31 c                   parm                    p_ema2
6.31 c                   parm                    p_ema3
pdf  c                   parm                    p_emne
pdf  c                   parm                    p_txt1
pdf  c                   parm                    p_txt2
pdf  c                   parm                    p_txt3
pdf  c                   parm                    p_txt4
pdf  c                   parm                    p_pers
6.31 c                   parm                    p_kopi
pdf  c                   parm                    p_inif
pdf  c                   parm                    p_in03
pdf   * Scann av strenger
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_emne        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_pemne
pdf   * Scann av strenger
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt1        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt1
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt2        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt2
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt3        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt3
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_txt4        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ptxt4
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     p_pers        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_ppers
pdf   *
pdf  c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
pdf  c                                      %trim(w_ptxt2) + crlf +
pdf  c                                      %trim(w_ptxt3) + crlf +
pdf  c                                      %trim(w_ptxt4) + crlf +
pdf  c                                      %trim(w_ppers)
pdf   *
6.31 c                   if        p_kopi = *blanks
6.31 c                   eval      p_kopi = d_emal
pdf  c                   endif
pdf   *
pdf  c                   if        p_in03 = *off
pdf   *
pdf   /Free
pdf        // Skriv mailinformasjon
6.31           WrtSection('MailCommandStart');
6.31       //  UpdHTMLVar('Receivers':           p_emal);
6.31           if %Trim(p_emal)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_emal);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema2)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema2);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema3)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema3);
6.31           WrtSection('MailReceiver');
6.31           endif;
pdf            UpdHTMLVar('CC':                     ' ');
6.31           UpdHTMLVar('BCC':                 p_kopi);
6.31           UpdHTMLVar('Sender':              p_kopi);
pdf            UpdHTMLVar('Subject':             w_pemne);
pdf            UpdHTMLVar('Message':             w_mtxt);
pdf            UpdHTMLVar('SMTPServer':          p_serv);
pdf            UPDHTMLVar('SMTPUser':               ' ');
pdf            UPDHTMLVar('SMTPPw':                 ' ');
6.31       //  WrtSection('MailCommand');
6.31           WrtSection('MailCommandEnd');
pdf   /End-free
pdf  c                   endif
pdf  c                   endif
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Firma
pdf  c                   eval      w_1fnav = *blank
pdf  c                   eval      w_1fad1 = *blank
pdf  c                   eval      w_1fad2 = *blank
pdf  c                   eval      w_1navn = *blank
pdf  c                   eval      w_1gate = *blank
pdf  c                   eval      w_1adr2 = *blank
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     a1fnav        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     a1fnav
pdf  c                   movel     p_str_out     w_1fnav
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     w_fad1        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_fad1
pdf  c                   movel     p_str_out     w_1fad1
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     w_fad2        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_fad2
pdf  c                   movel     p_str_out     w_1fad2
pdf   /Free
pdf
pdf        // Skriv firmavariabler
pdf            UpdHTMLVar('Reporttext':            w_txt1);
pdf            UpdHTMLVar('CompanyName':          w_1fnav);
pdf            UpdHTMLVar('Companyadress1':       w_1fad1);
pdf            UpdHTMLVar('Companyadress2':       w_1fad2);
pdf            UpdHTMLVar('Companypostalcode':        ' ');
pdf            UpdHTMLVar('Companypostoffice':     w_fste);
pdf            UpdHTMLVar('Companyphone':          w_ftlf);
pdf            UpdHTMLVar('Companyfax':            w_ffax);
pdf            UpdHTMLVar('Companyorgno':   %char(aafftn));
pdf            UpdHTMLVar('Companygiro':    %char(aafbgi));
pdf            WrtSection('Company');
pdf
pdf            test(de) *dmy w_ddmy;
pdf            if %error;
pdf            tmpdate = *loval;
pdf            else;
pdf            tmpdate = %date(w_ddmy : *dmy);
pdf            endif;
pdf            UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
pdf
pdf            test(te) *hms w_tids;
pdf            if %error;
pdf            tmptime = *loval;
pdf            else;
pdf            tmptime = %time(w_tids : *hms);
pdf            endif;
pdf            UpdHTMLVar('Creationtime': %char(tmptime : *hms));
pdf            UpdHTMLVar('Batchnummer':          %trim(a1batc));
pdf            WrtSection('DocumentInformation');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Detaljer                *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_deta      begsr
6.3c  * sjekk logistikk-vare
6.3c c                   eval      w_nobb = 0
6.3c c                   if        w_lv_nobb <> 0
6.3c c                   eval      w_nobb = w_lv_nobb
6.3c c                   else
6.3c c                   eval      w_nobb = vvnobb
6.3c c                   endif
pdf   * Scann varetekst
pdf  c                   eval      w_tek1 = *blank
pdf  c                   eval      w_tek2 = *blank
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     d1tek1        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_tek1
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     vvtek2        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_tek2
7.01  *
7.01 c                   if        %trim(w_plas) <> *blanks
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     w_plas        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_plas
7.01 c                   endif
7.01  *
7.01 c                   if        %trim(w_pla1) <> *blanks
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     w_pla1        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_pla1
7.01 c                   endif
7.01  *
7.01 c                   if        %trim(w_pla2) <> *blanks
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     w_pla2        p_str_in
7.01 c                   call      'AP613R'
7.01 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_pla2
7.01 c                   endif
7.01  *
pdf   /Free
pdf        // Skriv mailinformasjon
pdf            UpdHTMLVar('Overgruppe':      %char(vvogrp));
pdf            UpdHTMLVar('Hovedgruppe':     %char(vvhgrp));
pdf            UpdHTMLVar('Undergruppe':     %char(vvugrp));
pdf            UpdHTMLVar('Storage':         %char(d1lage));
6.3c           UpdHTMLVar('Nobbno':          %char(w_nobb));
pdf            UpdHTMLVar('Itemno':                 d1vare);
pdf            UpdHTMLVar('Text1':                  w_tek1);
pdf            UPDHTMLVar('Text2':                  w_tek2);
pdf            UPDHTMLVar('Unit':                   d1enh1);
pdf            UPDHTMLVar('Countquantity':   %char(d1antt));
pdf            UPDHTMLVar('Stockquantity':   %char(d1antl));
pdf            UPDHTMLVar('Countdifference': %char(d1diff));
pdf            UPDHTMLVar('Salesprice':      %char(d1spny));
pdf            UPDHTMLVar('Salesvalue':      %char(d1spsu));
pdf            UPDHTMLVar('Costprice':       %char(d1kpny));
pdf            UPDHTMLVar('Costvalue':       %char(d1kpsu));
6.30           UPDHTMLVar('Countvalue':      %char(d1topp));
6.30           UPDHTMLVar('Instockvalue':    %char(d1totl));
6.30           UPDHTMLVar('Diffvalue':       %char(d1totd));
6.30           UPDHTMLVar('Stockcountcode':         d1abck);
7.01           UPDHTMLVar('Mainlocation':    %trim(w_plas));
7.01           UPDHTMLVar('Altlocation1':    %trim(w_pla1));
7.01           UPDHTMLVar('Altlocation2':    %trim(w_pla2));
pdf
pdf            WrtSection('Line');
pdf   /End-free
pdf   *
6.12 c                   eval      b_line = *on
pdf   *
pdf  c                   endsr
6.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.12  * Subrutiner for XML/jasper integrasjon - Detaljer                *
6.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.12 c     xml_tom_line  begsr
6.12  * Scann varetekst
6.12 c                   eval      w_tek1 = 'Tom linje'
6.12  *
6.12  /Free
6.12       // Skriv mailinformasjon
6.12           UpdHTMLVar('Overgruppe':                '0');
6.12           UpdHTMLVar('Hovedgruppe':               '0');
6.12           UpdHTMLVar('Undergruppe':               '0');
6.12           UpdHTMLVar('Storage':                   '0');
6.12           UpdHTMLVar('Nobbno':                    '0');
6.12           UpdHTMLVar('Itemno':                    ' ');
6.12           UpdHTMLVar('Text1':                  w_tek1);
6.12           UPDHTMLVar('Text2':                     ' ');
6.12           UPDHTMLVar('Unit':                      ' ');
6.12           UPDHTMLVar('Countquantity':             '0');
6.12           UPDHTMLVar('Stockquantity':             '0');
6.12           UPDHTMLVar('Countdifference':           '0');
6.12           UPDHTMLVar('Salesprice':                '0');
6.12           UPDHTMLVar('Salesvalue':                '0');
6.12           UPDHTMLVar('Costprice':                 '0');
6.12           UPDHTMLVar('Costvalue':                 '0');
6.30           UPDHTMLVar('Countvalue':                '0');
6.30           UPDHTMLVar('Instockvalue':              '0');
6.30           UPDHTMLVar('Diffvalue':                 '0');
6.30           UPDHTMLVar('Stockcountcode':            ' ');
7.01           UPDHTMLVar('MainLocation':              ' ');
7.01           UPDHTMLVar('AltLocation1':              ' ');
7.01           UPDHTMLVar('AltLocation2':              ' ');
6.12
6.12           WrtSection('Line');
6.12  /End-free
6.12  *
6.12 c                   eval      b_line = *on
6.12  *
6.12 c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - total                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_total     begsr
6.12  * Hvis tom liste, må vi "jukse" inn linje for å lure java validering
6.12 c                   if        b_line = *off
6.12 c                   exsr      xml_tom_line
6.12 c                   endif
pdf   * Avsluttende linjetag, hvis ikke er skrevet tidligere.
pdf  c                   if        b_tota = *off
pdf  c                   exsr      xml_line_end
pdf  c                   endif
pdf   *
pdf   * Legger ut sorteringsbegrep
pdf   *
pdf   /Free
pdf            UpdHTMLVar('Totaltext':               t_text);
pdf            UpdHTMLVar('Totalsalesvalue':  %char(t_spsu));
pdf            UpdHTMLVar('Totalcostvalue':   %char(t_kpsu));
6.30           UpdHTMLVar('Totalcountvalue':   %char(t_topp));
6.30           UpdHTMLVar('Totalinstockvalue': %char(t_totl));
6.30           UpdHTMLVar('Totaldiffvalue':   %char(t_totd));
6.30           UpdHTMLVar('Totaldiffpro':     %char(t_todp));
pdf            WrtSection('SortingTotalvalue');
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - totallinjer             *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_line_end  begsr
pdf   * Skriv avsluttende total
pdf   /Free
pdf        //  Legg ut 'sluttag' på linjer
pdf            WrtSection('EndCountListLines');
pdf   /End-free
pdf   *
pdf  c                   eval      b_tota = *on
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Slutt                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_end       begsr
pdf   *
pdf   /Free
pdf            WrtSection('EndCountListDocument');
pdf   /End-free
pdf   *
pdf   * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
pdf   *
pdf  c                   if        l_arch = 1
pdf   * Lag tag for vising i arkivklienten
pdf  c                   eval      w_dspl = *blank
pdf  c                   eval      w_dspl = 'Telleliste avvik'
pdf   *
pdf  c                   eval      p_str_in = *blank
pdf  c                   eval      p_lr = '0'
pdf  c                   movel     w_dspl        p_str_in
pdf  c                   call      'AP613R'
pdf  c                   parm                    p_str_in
pdf  c                   parm                    p_str_out
pdf  c                   parm                    p_lr
pdf  c                   movel     p_str_out     w_dspl
pdf   /Free
pdf        // Skriv metattags
pdf
pdf            UpdHTMLVar('Displaytag':     %trim(w_dspl));
pdf            WrtSection('ArchiveCommandStart');
pdf
pdf            UpdHTMLVar('Metavalue':                ' ');
pdf            UpdHTMLVar('Metakey':   'TELLELISTE AVVIK');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue':             l_user);
pdf            UpdHTMLVar('Metakey':             'BRUKER');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue': %char(w_date:*iso));
pdf            UpdHTMLVar('Metakey':               'DATO');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue':             w_txt1);
pdf            UpdHTMLVar('Metakey':         'RUTINETEKST');
pdf            WrtSection('MetaTag');
pdf
pdf            WrtSection('ArchiveCommandEnd');
pdf   /End-free
pdf   *
pdf  c                   endif
pdf   *
pdf   /Free
pdf            WrtSection('Footer');
pdf   /End-free
pdf   *
pdf  c                   eval      XML_Output = XML_path + l_filg +'/'+
pdf  c                             'TAvik_'+ %trim(w_jkey) + '.xml'
pdf   *
pdf  c                   callp     WrtHtmlToStmf(XML_Output: 819)
6.32  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
6.32 c                   if        d_dtaq = '1'
6.32 c                   eval      p_xmlf = xml_output
6.32 c                   eval      p_filg = 'ADB'+l_filg
6.32 c                   call      'AP629C'
6.32 c                   parm                    p_filg
6.32 c                   parm                    p_xmlf
6.32 c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     pdf_preview   begsr
pdf   *
pdf   * Vi kaller program for launch av PDF i browser
pdf  c                   call      'AP621R'
pdf  c                   parm                    w_jkey
pdf   *
pdf  c                   endsr
pdf   *
6.3a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.3a  * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
6.3a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.3a c     pdf_preview2  begsr
6.3a c                   if        l_skje = 1
6.3a  * Vi kaller program for launch av PDF i browser
6.3a c                   call      'AP621R'
6.3a c                   parm                    l_bach
6.3a  *
6.3a c                   endif
6.3a  *
6.3a c                   endsr
6.3a  *
6.3a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.3a  * Finner spool som er generert av jobben
6.3a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.3a c     spoolnbr      begsr
6.3a  /Free
6.3a
6.3a           QSPRILSP( SPRL0100
6.3a                   : %size(SPRL0100)
6.3a                   : 'SPRL0100'
6.3a                   : errorcode );
6.3a  /End-free
6.3a c*
6.3a c                   endsr
6.3a  *
6.3a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.3a  * Kaller eget program for generering av xml fil. Eget pgm         *
6.3a  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.3a c     xml_create    begsr
6.3a  *
6.3a c                   eval      splfname2 = *blanks
6.3a c                   eval      splfname3 = *blanks
6.3a c                   eval      jobname2 = *blanks
6.3a c                   eval      jobname3 = *blanks
6.3a c                   eval      username2 = *blanks
6.3a c                   eval      username3 = *blanks
6.3a c                   eval      jobnbr2 = *blanks
6.3a c                   eval      jobnbr3 = *blanks
6.3a c                   eval      splfnbr2 = *zeros
6.3a c                   eval      splfnbr3 = *zeros
6.3a c                   eval      p_btyp = 'LAGERAVVIKSLISTE'
6.3a c                   eval      p_dspl = *blanks
6.3a c                   eval      p_refn = 'LAGERAVVIKSILISTE ' + %char(a1date)
6.3a c                   eval      p_tagg0 = *blanks
6.3a c                   eval      p_tagg0val = *blanks
6.3a c                   eval      p_tagg1 = *blanks
6.3a c                   eval      p_tagg1val = *blanks
6.3a c                   eval      p_tagg2 = *blanks
6.3a c                   eval      p_tagg2val = *blanks
6.3a c                   eval      p_tagg3 = *blanks
6.3a c                   eval      p_tagg3val = *blanks
6.3a c                   eval      p_tagg4 = *blanks
6.3a c                   eval      p_tagg4val = *blanks
6.3a c                   eval      p_tagg5 = *blanks
6.3a c                   eval      p_tagg5val = *blanks
6.3a c                   eval      p_tagg6 = *blanks
6.3a c                   eval      p_tagg6val = *blanks
6.3a c                   eval      p_tagg7 = *blanks
6.3a c                   eval      p_tagg7val = *blanks
6.3a c                   eval      p_tagg8 = *blanks
6.3a c                   eval      p_tagg8val = *blanks
6.3a c                   eval      p_tagg9 = *blanks
6.3a c                   eval      p_tagg9val = *blanks
6.3a  *
6.3a c                   call      'AP627R'
6.3a c                   parm                    splfname
6.3a c                   parm                    jobname
6.3a c                   parm                    username
6.3a c                   parm                    jobnbr
6.3a c                   parm                    splfnbr
6.3a c                   parm                    splfname2
6.3a c                   parm                    jobname2
6.3a c                   parm                    username2
6.3a c                   parm                    jobnbr2
6.3a c                   parm                    splfnbr2
6.3a c                   parm                    splfname3
6.3a c                   parm                    jobname3
6.3a c                   parm                    username3
6.3a c                   parm                    jobnbr3
6.3a c                   parm                    splfnbr3
6.3a c                   parm                    p_tagg0
6.3a c                   parm                    p_tagg0val
6.3a c                   parm                    p_tagg1
6.3a c                   parm                    p_tagg1val
6.3a c                   parm                    p_tagg2
6.3a c                   parm                    p_tagg2val
6.3a c                   parm                    p_tagg3
6.3a c                   parm                    p_tagg3val
6.3a c                   parm                    p_tagg4
6.3a c                   parm                    p_tagg4val
6.3a c                   parm                    p_tagg5
6.3a c                   parm                    p_tagg5val
6.3a c                   parm                    p_tagg6
6.3a c                   parm                    p_tagg6val
6.3a c                   parm                    p_tagg7
6.3a c                   parm                    p_tagg7val
6.3a c                   parm                    p_tagg8
6.3a c                   parm                    p_tagg8val
6.3a c                   parm                    p_tagg9
6.3a c                   parm                    p_tagg9val
6.3a c                   parm                    l_bach
6.3a c                   parm                    p_btyp
6.3a c                   parm                    p_refn
6.3a c                   parm                    p_dspl
6.3a  *
6.3a c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *  Key for les av FORMULAR
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      *  Key for les av LAGER-KODE
      *
     c     lstsl1_key    klist
     c                   kfld                    lstsl1_firm
      *
      * Key for les av BATCH
      *
     c     lbchl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lbchl1_batc
      *
      *  Key for les av HISTORISK-LAGERBOK
      *
     c     vhisl1_key1   klist
     c                   kfld                    w_firm
     c                   kfld                    vhisl1_lage
     c                   kfld                    vhisl1_vare
     c                   kfld                    vhisl1_dato
     c                   kfld                    vhisl1_time
      *
     c     vhisl1_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    vhisl1_lage
     c                   kfld                    vhisl1_vare
pdf   *
pdf   *  Key for les av vareregsiter
pdf   *
pdf  c     vvarl1_key    klist
pdf  c                   kfld                    w_firm
pdf  c                   kfld                    vvarl1_vare
pdf   *
pdf   * Key for firmaregister
pdf   *
pdf  c     afirl1_key    klist
pdf  c                   kfld                    w_firm
pdf   *
6.30  *
6.30  *  Key for les av lagerregister
6.30  *
6.30 c     vlagl1_key    klist
6.30 c                   kfld                    w_firm
6.30 c                   kfld                    vlagl1_vare
6.30 c                   kfld                    vlagl1_lage
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    w_parm
      *
      *  Legger inn firmanummer i nøklene
      *
     c                   eval      lstsl1_firm = l_firm
     c                   eval      w_firm = l_firm
      *
      *  Behandling av parameter-felter
      *
     c                   eval      d_prec = w_parm
6.11 c                   eval      a1batc = d_batc
      *
      *  Legger inn opplysninger i utfelter
      *
     c                   eval      a1wsid = l_wsid
     c                   eval      a1user = l_user
     c                   eval      a1firm = l_firm
     c                   eval      a1fnav = l_fnav
      *
     c                   eval      a1date = udate
     c                   time                    a1time
      *
      *  Sjekk, hva skal vises i utskriften
      *
     c                   eval      *in71 = *off
     c                   eval      *in70 = *on
     c                   eval      *in73 = *on
     c                   eval      *in74 = *on
     c                   eval      *in76 = *on
      *
     c                   if        d_val1 = 3
     c                   eval      *in73 = *off
     c                   eval      *in74 = *off
     c                   endif
      *
      *  Hent opplysninger fra LAGER-KODE-REGISTER
      *
     c     lstsl1_key    chain     lstsl1r
      *
      *  Hent opplysninger fra RUTINE-REGISTER
      *
pdf  c                   eval      w_ruti = l_ruti
pdf  c                   eval      w_txt1 = *blank
      *
     c                   eval      aforl1_ruti = l_ruti
     c     aforl1_key    chain     aforl1r
pdf  c                   move      aftxt1        w_txt1
      *
      *  Hent opplysninger fra BATCH-REGISTER
      *
     c                   eval      lbchl1_batc = d_batc
     c     lbchl1_key    chain     lbchl1r
6.20 c                   if        lcstel = 1
6.20 c                   eval      b_sykl = *on
6.20 c                   endif
     c                   eval      vhisl1_dato = lcbdat
     c                   eval      vhisl1_time = lcbtim
     c                   eval      p_dato = lcbdat
pdf   *
pdf   * Sjekk om vi skal bruke JASPER og XML generering av dokumenter
pdf  c                   if        l_poff = '1'
pdf  c                   eval      b_pdfp = *off
pdf  c                   eval      w_pdf = 0
pdf  c                   eval      w_pdf_ds = *blanks
pdf  c                   eval      w_ruti = l_ruti
pdf   *
pdf  c                   call      'AP609R'
pdf  c                   parm                    w_ruti
pdf  c                   parm                    w_pdf
pdf  c                   parm                    w_pdf_ds
pdf  c                   eval      d_pdf_ds = w_pdf_ds
pdf   * Vi skal kjøre med jasper
pdf  c                   if        w_pdf = 1 and
pdf  c                             %trim(d_xmlm) <> *blanks
pdf  c                   eval      p_mail = '0'
pdf  c                   eval      w_jkey = l_bach
pdf   *
6.3a  * Hent inn xml templaten - NB Kun hvis excel er valgt
pdf   *
6.3a c                   if        l_exlp = 1
pdf  c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
6.34 c                   callp     ClrHtmlBuffer
pdf   *
pdf   * Finn hvor xml'en skal legges
pdf   *
pdf  c                   eval      XML_path = *blanks
pdf  c                   eval      XML_path = %trim(d_path)
pdf   *
pdf   * Finn path til logo
pdf   *
pdf  c                   eval      jasper_logo = *blanks
pdf  c                   eval      jasper_logo = %trim(d_logo)
pdf   *
pdf   * Jobbnummer er allerede generert i AP600R. Overføres i *lda
pdf   *
pdf  c                   time                    w_date
pdf   * Vi logger ar utskriftprogrammet har startet
pdf  c                   eval      w_jstat = 10
pdf  c                   eval      w_jtext = 'Utskrift av telleavviksliste ha+
pdf  c                                       r startet'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf   * Vi skriver xml for miljø formater
pdf  c                   exsr      xml_envm
pdf  c                   eval      b_pdfp = *on
6.3a c                   endif
pdf   *
pdf  c                   endif
pdf   * Hvis et eller annet er galt med parametrene, logges og kjør uten PROA
pdf  c                   if        %trim(d_xmlm) = *blanks
pdf  c                   eval      b_pdfp = *off
pdf   * Vi logger at noe er galt med parametrene
pdf  c                   eval      w_jstat = 20
pdf  c                   eval      w_jtext = 'Finner ikke path til xml !!! +
pdf  c                             Sjekk rutineregister !'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf  c                   endif
pdf   *
pdf   *  Hent inn firma/avd. opplysninger dersom
pdf   *  kode for det er satt i rutineregister
pdf   *
pdf  c                   if        l_prfi = 1 or
pdf  c                             l_prfi = 2
pdf  c                   eval      w_prfi = l_prfi
pdf  c                   eval      w_ffir = w_firm
pdf  c                   eval      w_avde = l_avde
pdf   *
pdf  c                   call      'FÅ707R'
pdf  c                   parm                    w_prfi
pdf  c                   parm                    w_ffir
pdf  c                   parm                    w_avde
pdf  c                   parm                    w_fnav
pdf  c                   parm                    w_fad1
pdf  c                   parm                    w_fad2
pdf  c                   parm                    w_fste
pdf  c                   parm                    w_fftx
pdf  c                   parm                    w_tfax
pdf  c                   parm                    w_ftlf
pdf  c                   parm                    w_ffax
6.33 c                   parm                    w_mail
6.33 c                   parm                    w_weba
pdf  c                   endif
pdf   *
pdf  c                   time                    w_dato2
pdf  c                   movel     w_dato2       w_tids            6 0
pdf  c                   move      w_dato2       w_ddmy
pdf  c                   eval      b_deta = *off
pdf  c                   eval      b_tota = *off
6.12 c                   eval      b_line = *off
pdf   *
pdf  c                   else
pdf  c                   eval      b_pdfp = *off
pdf  c                   endif
pdf   *
pdf   * Slår opp etter firmainformasjon
pdf   *
pdf  c     afirl1_key    chain     afirl1r
      *
pdf  c                   if        b_pdfp = *off
6.3a c                   open      le612p
FIX   * Skriver ut overskrifter 1.ste gang
FIX  c                   exsr      ovflow
pdf  c                   else
pdf  c                   exsr      xml_head
pdf  c                   endif
      *
     c                   endsr
