# RPG Program EK101R - Customer Bonus Maintenance - Explanation

This RPG program is responsible for maintaining customer bonus information in an IBM i (AS400) environment. It provides a green-screen (5250) interactive interface for users to create, update, delete, view, copy, and query various bonus structures linked to customers, products, groups, vendors, and more. Below you will find an explanation to help onboard a developer to this codebase.

---

## 1. **Program Header and Options**

```rpg
h option(*nodebugio) datedit(*dmy)
```

- `option(*nodebugio)`: Disables debug I/O for performance.
- `datedit(*dmy)`: Sets default date format to Day-Month-Year for input/output operations.

---

## 2. **Comments & Change Log**

The long comment block documents the program's origin, ownership, purpose, and summary of change history with references, making it easier to track evolution and new functionality.

---

## 3. **Indicator Usage**

The program uses indicators (e.g., `*IN10`) to control program flow, especially around display file interaction, subfile handling, field-level protection, and error signaling:

- `LR`: Last record, causes program end.
- Indicators 10-15: Subfile paging and display control.
- Indicators 21-22: Cursor positioning.
- Indicators 30, 31-79: Field protection and error indications.
- Indicators 80-99: Work indicators.

---

## 4. **File Declarations**

Several files are declared, mostly keyed physical files (`if`, `uf`, etc.), sometimes renamed for local clarity (e.g., `rename(ekbost:ekboirr)`). These files contain customer bonus structures, lookup tables for customers, products, groups, vendors, bonus types, etc.

Example:
```rpg
fekboir if e k disk rename(ekbost:ekboirr)
```
- Input keyed file for reading bonus data.

Display file:
```rpg
fek101d cf e workstn sfile(b1sfl:w_srrn) infds(dspfbk)
```
- Control file for the display station, using subfile `b1sfl` for displaying multiple rows, with record number `w_srrn`.

---

## 5. **Data Declarations**

### Parameters and Data Areas

- `p_firm`, `p_bkun`, `p_tbot`: Input parameters for firm, bonus customer, and bonus type.
- User-specific fields loaded from the User Data Area (UDS).

### Structures

- `dspfbk`: Used to hold display feedback, e.g., the current record number on the display.

### Work Variables

Numerous variables prefixed by `w_` (work), `b_` (bonus), `c_` (copy), etc., for managing state, current keys, field values, error flags, record numbers, etc.

### Key Variables

Variables structured to build file keys for positioning and fetching bonus records at various levels (e.g., customer, group, product, vendor, etc.).

---

## 6. **Constants**

- `c_sfil`: Subfile page size, set to 12.

---

## 7. **Screen Handling and Documentation**

Detailed comments document variables used for display handling and the different screens (e.g., B1SFL, B2CTL, C1BLD, etc.), primarily for interactive subfile-based maintenance.

---

## 8. **Main Program Flow**

### Main Loop

The program runs an outer loop processing:
1. **Display/subfile interaction** (`exsr dsp_subfile`)
2. **Function key handling** (`select...when...`)
    - F3/F12 (`*INKC`, `*INKL`): Exit
    - F5 (`*INKD`): Inquiry
    - F6 (`*INKE`): Refresh/renew
    - F7 (`*INKF`): Create new entry
    - Page up/down (10/11): Paging subfile
    - HOME navigation (21/22)

3. **Positioning**: If filtering fields are specified, position subfile accordingly (`exsr posisjoner`).

4. **Subfile Handling**: Handles subfile entries (update, copy, delete, view, and bonus element editing).

5. **Exit**: Sets `*inlr= *on` and returns.

---

### Subfile & Display Management

- **B2CTL**: Main control loop for subfile display, function key handling, and navigation.
- **Display subfile rows** (`crt_subfile`), blank subfile (`clr_subfile`).
- **Paging**: Handles rollup/rolldown via subfile paging logic.

---

### Subroutines

#### 8.1. **forny (Renew/Refresh Subfile)**

- Repositions subfile to the current key depending on navigation.
- Blanks and refills the subfile view.

#### 8.2. **posisjoner (Positioning Subfile)**

- Determines subfile key based on which filtering field (e.g., Customer, Product, Group) is specified.
- Calls `clr_subfile` and `crt_subfile` to reset and refill subfile.
- Resets positioning fields.

#### 8.3. **subfile (Subfile Processing Loop)**

- Loops through subfile records, handling options:
    - 2: Edit
    - 3: Copy
    - 4: Delete
    - 5: View
    - 7: Edit bonus elements (via call to `EK110R`)
    - 9: Mass copy to all customers in a category

#### 8.4. **xc1bld (Create New Row Handling)**

- Present input screen for new record.
- Validate input (via `sjekk_input`).
- If record already exists, show info window (`xc1msg`).
- Call `xc2bld` for detailed maintenance.

#### 8.5. **xc2bld (New/Edit/View Handler)**

- Loads existing data if present.
- Calls `hent_info` to fetch descriptions.
- Presents detailed input window for edit/view.
- Handles validation and saves or updates bonus record as needed.

#### 8.6. **xd1win (Delete Window Handler)**

- Loads bonus record for deletion, prompts user for confirmation.
- Deletes both bonus record and its child elements.

#### 8.7. **xk1win (Copy Window Handler)**

- Used for copying a bonus row.
- Handles existence check, validates input, and calls main maintenance routine.

#### 8.8. **xm1win and kopier (Bulk Copying)**

- Allows copying a bonus element to all customers in a selected customer category.
- Iterates through all customers in a category, updating or inserting bonus records as needed.
- Cleans up (removes) previous bonus elements for target customers to avoid duplicates.

#### 8.9. **clr_subfile, crt_subfile**

- Blank and (re)populate the subfile for paging.

#### 8.10. **bck_subfile (Page Backwards Handling)**

- Handles backward navigation through subfile pages, using `readp` operations.

#### 8.11. **dsp_subfile (Subfile Display Subroutine)**

- Handles actual subfile display, paging.

#### 8.12. **spørring (Inquiry Subroutine)**

- Responds to inquiries on various fields—e.g., customer, product, group codes—by calling lookup programs and returning descriptions.

#### 8.13. **sjekk_input (Input Validation Subroutine)**

- Validates all input for correctness and existence (e.g., customer must exist, dates are valid, no conflicting levels, bonus type must be filled, etc.).
- Sets error indicators as required.

#### 8.14. **hent_info (Fetch Descriptions Subroutine)**

- Looks up descriptions (names, texts) for customer, product, group, vendor, etc., to display next to codes for user convenience.

#### 8.15. **Initialization Routine (`*inzsr`)**

- Receives parameters (`p_firm`, `p_bkun`, `p_tbot`) on entry.
- Initializes keys for the different files and subfiles.
- Positions the initial view and subfile.

---

## 9. **Keylists (KLISTs)**

Keylists are defined for all major physical file accesses; each defines the set of fields used for indexed access or positioning (e.g., for reading a specific customer bonus, bonus type, group, etc.).

---

## 10. **Use of External Programs**

The program makes extensive use of external APIs/programs for various lookups—these include calls to programs:
- `RA506R`, `RK500R`: Customer/category lookups
- `VG510R`, `VG511R`, `VG512R`: Group lookups
- `VY500R`: Delivery type lookup
- `VA565R`: Bonus type lookup
- `FO714C`, etc.: Special lookups for module info

---

## 11. **Special Notes on Data Structure**

- **Subfiles**: Used for efficient paging and display of large numbers of bonus rows.
- **Bonus hierarchy**: The code treats bonus structures as hierarchical, supporting filtering and maintenance at different levels—by category, customer, group, etc.
- **Bulk operations**: Mass-copy features enable managing bonuses for entire customer categories in one go.
- **Child element cleanup**: Upon deletion of a parent record, any associated bonus elements are also deleted to maintain consistency.

---

## 12. **Field/Variable Naming Conventions**

- Prefixes like `b1`, `c1`, `k1`, `m1`, `d1` distinguish different screen or logic contexts (e.g., B1SFL, C1BLD, K1WIN).
- Suffixes like `_key` or KLIST names are used for key structures in file access.

---

## 13. **Error Handling**

Error handling is performed via indicators, with error explanations sent to the display using message indicators or subfile error lines. Validation routines (`sjekk_input`) cover both existence and business rule errors.

---

## 14. **Comments and Documentation**

The code is well-commented, especially in legacy RPG/400 style, with detailed in-line notes about purpose, field usage, and business logic. This is essential for maintenance and onboarding.

---

## 15. **Modification History**

Mods are marked inline by version and initials (e.g., `6.20`, `9.01`). Most represent customer/process-specific changes or bug fixes and are kept visible for historical traceability.

---

# **Summary Table of Main Subroutines**

| Subroutine     | Purpose                                                      |
|----------------|-------------------------------------------------------------|
| forny          | Refreshes subfile based on current selection                |
| posisjoner     | Positions subfile to a specific key/filter                  |
| subfile        | Processes subfile options (edit, copy, delete, etc.)        |
| xc1bld         | Screen logic for creating a new bonus row                   |
| xc2bld         | Main maintenance (edit/view) of a bonus row                 |
| xd1win         | Deletion confirmation and execution                         |
| xk1win         | Screen logic for copying a row                              |
| xm1win         | Copy to all customers in a category                         |
| kopier         | Executes the actual copying per customer                    |
| clr_subfile    | Clears the subfile display                                  |
| crt_subfile    | Populates the subfile (paging)                              |
| bck_subfile    | Handles backward paging in subfile                          |
| dsp_subfile    | Subfile display logic                                       |
| spørring       | Field value inquiries                                       |
| sjekk_input    | Input validation logic                                      |
| hent_info      | Fetches and displays descriptions (names, text)             |
| *inzsr         | Initialization routine on entry                             |

---

# **Onboarding Recommendations**

- **Understand the legacy RPG structure**, especially how it handles interactive display, subfiles, and file I/O.
- **Familiarize yourself with the key file structures and their relationships** (bonus, customer, product, group, vendor).
- **Walk through the subroutine flow** when maintaining or debugging a problem.
- **Consult the comments and versioned change notes** for business rules that evolved over time.

---

This program is a complex but well-documented example of classic interactive RPG for managing multi-level customer bonuses, with user-friendly paging, filtering, and mass update functionality.