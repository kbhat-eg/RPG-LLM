# RPG Program RF111R Explanation

This ILE RPG program is a legacy batch routine, apparently for reconciliation (matching/clearing) of customer and supplier postings ("avkryssingsrutine kunder/leverandører"). It is likely used for the automated settlement and balancing (saldering) of invoices and payments, with special logic for records originating from “SHOP” and “TELE” (which might refer to specific integration sources such as webshops or bank/telecom). Comments and code are partly in Norwegian, following Norwegian accounting terminology.

Below, the key components and logic are explained for onboarding developers:

---

## High-Level Structure

- **File Definitions**: Several physical and logical files are defined, each with conditional or renamed names, to access customer, vendor, and transaction information.
- **Data Structures and Variables**: The program defines variables and data structures to handle keys and program state.
- **Subroutines**: The program is divided into several subroutines, including an initialization routine and the main logic for nullifying ("Nullstille") open balances on specific postings.
- **External Program Calls**: The program calls an external program (CO402R) to retrieve configuration flags and control program behavior.
- **Main Logic**: Processes postings, and if certain criteria are met (origin is SHOP and a control flag is set), it marks the remaining outstanding amount as cleared for the affected records.

---

## Detailed Sections

### 1. **File Definitions**
```rpg
 frjoupf    if   e           k disk    rename(rjoupfr:rjoupfr)
 fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
 frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
 frktrl8    uf   e           k disk    rename(rktrpfr:rktrl8r)
 frktrlc    uf   e           k disk    rename(rktrpfr:rktrlcr)
 fraa1l1    if   e           k disk    rename(raa1pfr:raa1l1r)
 frjoulu    uf a e           k disk    rename(rjoupfr:rjoulur)
```
- **Physical and logical files** for customers, postings, status, and transaction details.
- Files are renamed locally for this program.

### 2. **Data Structures and Variables**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
d l_filg                931    933
```
- **UDS (User Data Section)**: Holds session/user-specific data.
- **Key variables**: `w_firm` (company), `w_kont` (account/customer), etc.
- **Flags**: `u_s701`, `u_Null_Bilag_S` control exception and nullification logic.
- **Program parameter**: `p_adra` controls special reconciliation.

### 3. **External Program Declaration**
```rpg
DCL-PR CO402R EXTPGM('CO402R');
  p_filgrp            char(3)     const;
  p_firm              packed(3:0) const;
  p_lager             packed(2:0) const;
  p_nokkel            char(50)    const;
  p_verdi1            char(1);
  p_verdi2            char(2048);
END-PR;
```
- **CO402R** is called for control/parameter lookup (returns configuration values).

### 4. **Main Logic (Clearing SHOP Postings)**

**Nullify outstanding amounts for SHOP records**  
```rpg
 if %subst(w_mem1:4:4) = 'SHOP' and U_Null_Bilag_s = *on
   exsr Null_Bilag
 endif
```
- If the record source (w_mem1) is 'SHOP', and the config flag is ON, the `Null_Bilag` subroutine is called.

#### **Subroutine: Null_Bilag**
- **Objective**: For each customer posting originating from "SHOP", sum all debits and credits for the given voucher (bilagsnr) and customer. If the sum is zero, set all "outstanding amounts" (restbeløp) to zero for those records.

Process:
1. **Restart reading** RJOU posting file.
2. **Iterate over postings for the given customer**.
3. For each unique voucher number:
    - **Calculate the net sum** by reading both “bnr” and “ref” records from RKTRL8 and RKTRLC files.
    - **If the summed amount is zero**, loop through all related records and **set their outstanding balance to zero** and update the timestamp fields.
4. Continue to the next posting.

#### **Field and Key Setup**
Key lists (`klist`) set up composite keys used for file access.

---

### 5. **Initialization Subroutine (`*inzsr`)**

- **Purpose**: Set up initial values, read parameter records, and check for special processing flags using calls to CO402R.
- E.g.:
    - Flag `u_s701` for exceptional auto-reconciliation from TELE/Adra.
    - Flag `u_Null_Bilag_S` for enabling nullification-from-SHOP logic.

- **Parameter List**: Accepts `w_mem1` (indicates origin/source of posting).
- **File Key Setup**: Sets up keys for accessing records in main files.

---

## **Key Notes for Developers**

- **Specialized/Legacy Code**: This program uses fixed-format RPG and is closely tied to Norwegian accounting concepts.
- **Automation of Matching**: Automates clearing of open items for records from integrators ("SHOP", "TELE"), reducing manual reconciliation.
- **Configurable Behavior**: Uses external config (CO402R) for toggling auto-matching or nullification per company/process.
- **Updating Postings**: When nullifying, updates outstanding amount (`rnrest`) and timestamps (`rnedat`, `rnetim`) for each relevant record.
- **Error Handling**: Sparse, relies on key lists and controlled updates; any failures would require investigation in integration logs or job logs.

---

## **Summary Table: Main Flags/Fields**

| Variable         | Purpose                                                    |
|------------------|-----------------------------------------------------------|
| `w_mem1`         | Posting origin/source (determines special processing)     |
| `u_s701`         | Enables special cross-matching for Adra/Tele              |
| `u_Null_Bilag_S` | Enables SHOP nullification logic                          |
| `rnrest`         | Remaining amount on transaction record                    |
| `rnedat`, `rnetim` | Date and time of last update (set on nullification)    |
| `CO402R`         | External config program, returns control flags            |

---

## **Typical Use Case**
- Run as a scheduled batch or triggered process to periodically reconcile and/or clear customer or supplier accounts—especially for postings originating from automated integration sources ("SHOP" or "TELE").
- Can be adapted for changes in integration with new sources or new reconciliation rules by changing config in CO402R or adjusting subroutine logic.

---

**Recommendation:**  
If you’re onboarding, study the business process behind "avkryssing" (clearing/matching), understand how files such as RJOU, RKTRL8, RKTRLC relate to your organization's transaction flow, and check the configuration in CO402R for each company before making changes. Debugging is legacy-style (no *DEBUG IO) and changes should be thoroughly tested in a QA environment.