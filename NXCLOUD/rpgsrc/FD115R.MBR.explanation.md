## Program Overview

This RPG program, `FD115R`, is part of the ASOFAK system and is responsible for the maintenance of length specifications for order lines ("Ordre-linje, vedlikehold av lengdespesifikasjon"). It provides a subfile-based user interface for viewing, adding, updating, and deleting length specification lines tied to a specific order line.

The program is designed as an interactive, workstation-based application (uses display files with subfiles) and interacts with several physical files related to orders, length specifications, and item master data.

---

## Main Data Files and Their Roles

- **FODTL1**: Order line header file (renamed to FODTL1R). Used to retrieve order line details.
- **FVLSL1**: Length specification lines (renamed to FVLSL1R). Main file for line items specifying lengths tied to an order line.
- **FVLSLU**: Update-capable view of length specification lines (renamed to FVLSLUR). Used for update and delete operations.
- **VVARL1**: Item master file (renamed to VVARL1R). Used to retrieve item descriptions and data.

---

## Display Files

- **FD115D**: The display file containing the main subfile (`b1sfl`) and control formats (`b2ctl`, `b2cmd`). Used for all user interaction.
- Subfile record format: `b1sfl` (with relative record number `w_srrn`).
- Control and command formats: `b2ctl`, `b2cmd`, `d1win` (delete confirmation window).

---

## Parameters and Data Flow

Upon entry, the program receives:
- `p_firm`: Company identifier
- `p_numm`: Order number
- `p_suff`: Order suffix/part
- `p_line`: Order line number
- `p_vare`: Item number
- `p_totm`: Total running meters (output parameter)

These are used to position the program on the correct order line and to filter the length specification lines.

---

## Key Variables and Structures

- **Key fields**: Used for setll/reade/chain operations on the files, defined for both current and secondary navigation within subfiles.
- **Subfile navigation variables**: `w_srrn`, `w_ssrn`, `w_stel`, etc., manage paging, current record, and relative positions in the subfile.
- **Flags**: `b_endr`, `b_forn`, `b_feil`, `b_nyrg` indicate update states, errors, and whether a new record is being processed.

---

## Main Program Flow

1. **Initialization (`*inzsr`)**
   - Receives parameters, sets up keys, fetches item text, and loads the subfile with existing length specification lines for the selected order line.
   - Calculates and displays the total running meters for the current lines.

2. **Main Loop**
   - Displays the subfile and control formats.
   - Handles function keys: exit, refresh, paging (next/previous), and toggling between display and entry modes.
   - Processes add, update, and delete actions on subfile lines.

3. **Subfile Processing**
   - Reads all subfile entries, checking for user actions:
     - **Change (valg=2)**: Loads data into the entry fields and calls the update subroutine.
     - **Delete (valg=4)**: Calls the delete confirmation window and, if confirmed, deletes the selected line.
   - After processing changes, refreshes the subfile.

4. **Add New Line**
   - Determines the next available sequence number (`lpnr`), populates the new record fields, and writes the new length specification line.
   - Updates totals and refreshes the subfile.

5. **Update Line**
   - Loads the selected line, allows the user to edit, and writes changes back to the file.
   - Recalculates totals.

6. **Delete Line**
   - Displays a confirmation window with line details.
   - If confirmed, deletes the record and updates totals.

7. **Paging**
   - Supports forward and backward paging through the subfile, using the `crt_subfile` and `bck_subfile` subroutines.

8. **Totals Calculation**
   - After every add, update, or delete, recalculates the total running meters for the order line and updates both the display and the output parameter.

---

## Notable Design and Business Logic

### Subfile Handling

- The subfile is paged in blocks (`c_sfil`, default 10 lines per page), with navigation logic to ensure the current record/page is maintained after changes.
- `pos_lin` ensures that after adding a new line, the subfile is positioned to the correct page so the new line is visible.

### Length Specification Logic

- Each length specification line has a sequence (`lpnr`), length (`leng`), and quantity (`anta`).
- The total running meters (`lopm`) is calculated as `(length * quantity) / 1000` for each line, and summed for the order line.

### Audit Fields

- When adding or updating lines, the program records timestamps and user IDs for creation (`fvoudat`, `fvotim`, `fvousr`) and last update (`fvedat`, `fvetim`, `fveusr`).

### Error and State Management

- Flags such as `b_nyrg` and `b_forn` are used to control state transitions between display, add, and update modes.
- The program is robust to EOF and not found conditions, ensuring that navigation and data integrity are maintained.

### Data Relationships

- The program is tightly bound to the order line context (via parameters and key fields).
- All length specification lines are filtered and managed strictly within the context of the selected order line.

---

## Integration Points

- **Order Line File (`FODTL1`)**: Used for context and possibly validation, but not updated by this program.
- **Length Specification Files (`FVLSL1`, `FVLSLU`)**: Main CRUD operations.
- **Item Master (`VVARL1`)**: Used to fetch item description and display it to the user.

---

## Naming and Conventions

- Variable and key names follow a convention where the first part denotes the file (e.g., `fvlsl1_`), and the suffix denotes the field or purpose.
- Subfile control variables all start with `w_` for "work" or "working".
- Subroutines are named in Norwegian, reflecting the business context and domain.

---

## User Interface

- The program uses a standard IBM i subfile pattern with control and command areas.
- Supports function keys for navigation, add, update, delete, and exit.
- Uses a confirmation window for delete operations.

---

## Summary

This program is a classic interactive RPG application for maintaining length specification lines tied to an order line. It is designed for high integrity and user efficiency, with careful state and paging management, and business logic focused on running meter calculation and auditability. The code is modular, with clear subroutines for each business action (add, update, delete, paging, total calculation), and is built to integrate seamlessly with the broader ASOFAK order management system.