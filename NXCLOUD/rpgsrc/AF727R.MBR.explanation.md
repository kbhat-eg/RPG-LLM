# RPG Program: AF727R — Generate XML for Mailing from Order Proposals

This program is written in ILE RPG and is designed to generate an XML file used for email dispatches based on order proposals. The code leverages the CGIDEV2 library for handling HTML/XML templates and writing output to the IFS (Integrated File System). Below is a breakdown to onboard a developer quickly.

---

## 1. **Header and Setup**
- **H-specs**
  - `decedit('0.') datedit(*dmy-) option(*nodebugio)`: Sets decimal and date edit codes; disables debug I/O.
  - `DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')`: Not running in default activation group; binds to CGIDEV2 binding directory.
- **Copy Books**
  - `/copy hspecsbnd`, `/copy prototypeb`, `/copy usec`: These likely import prototypes, service programs, or standard specifications.

---

## 2. **File Declaration**
```RPGLE
fafpslr    if   e           k disk    rename(afpspfr:afpslrr)
```
- Defines a keyed file for reading parameters/configuration from the table `afpspfr` (renamed to `afpslrr`).

---

## 3. **Data Structures and Variables**
- A wide variety of working variables are declared (subject, sender, message, paths, and formatting buffers).
- **UDS (User Data Structure)**: Used to retrieve job/user-specific values, such as `l_user`, `l_filg`, and `l_firm`, from local data area (LDA).
- **Date/Time Handling**: Uses overlays inside a data structure for managing timestamps.

---

## 4. **Main Program Logic**

### **Entry and Initialization**
```RPGLE
*entry        plist
parm  p_rec1
parm  p_send
parm  p_subj
parm  p_txt1
```
- Receives four parameters (receiver, sender, subject, and message text) from the caller.
- Calls the `*inzsr` subroutine, which:
  - Looks up various paths and settings from the configuration file—XML template path, output path, and a flag for whether to write to a data queue (for a "sniffer").
  - Calls an external program `AS100R` to obtain a batch/job number for this run.
  - Writes log entries to record the start of the batch/job and the start of XML generation.

---

### **Mainline Processing**
1. **Path Validation**
    ```RPGLE
    if XML_path = *blanks or OUT_path = *blanks
        goto avslutt
    endif
    ```
    - If either the XML template path or output path is missing, exit the program immediately.

2. **Load Template and Server**
    - Calls subroutine `xml_env` to load the XML template using the CGIDEV2 HTML reader.
    - Calls external program `AM705C` to retrieve the mail server address/status.

3. **Prepare Subject and Message**
    - Calls `AP613R` to scan/clean up subject and message strings.

4. **Prepare and Write Output Mail Command**
    - Using CGIDEV2 routines:
      - Inserts variables (recipient, CC, BCC, sender, subject, message, SMTP server, etc.) into the HTML/XML template.
      - Writes template sections (`MailCommandStart`, `MailReceiver`, etc.).

5. **Write XML to IFS**
    - Calls subroutine `xml_end`, which:
        - Writes the closing section of the XML.
        - Constructs the target output filename.
        - Writes the HTML/XML to a stream file (using `WrtHtmlToStmf`).
        - Optionally calls `AP629C` to enqueue the output filename on a data queue if monitoring ("sniffer") is active.

6. **Close Out Job**
    - Calls external program `AB710R` to mark the job as finished.

---

### **Exit/End**
- Tagged section (`avslutt`) sets the last record indicator and `return`s from the program.

---

## 5. **Key Subroutines**

### **xml_env**
- Loads the XML template from the IFS.
- Inserts batch/job information into the template.
- Writes credential information into the template (schema and company number).

### **xml_end**
- Writes the final (footer) section of the XML.
- Generates the final output filename and writes the XML to the IFS.
- Optionally places output info on a data queue for monitoring.

### **Initialization (*inzsr)**
- Reads necessary configuration values from the parameter file.
- Obtains a new batch/job number.
- Logs the start of the job and the XML generation.

---

## 6. **External Programs/Service Programs Used**
- `AM705C`: Gets mail server name/address.
- `AP613R`: Scans and processes input strings.
- `AS100R`: Fetches/generates batch/job numbers.
- `AB700R`, `AB705R`, `AB710R`: Job logging/tracking.
- CGIDEV2 routines:
    - `GetHTMLIFS`, `UpdHTMLVar`, `WrtSection`, `ClrHtmlBuffer`, `WrtHtmlToStmf`

---

## 7. **General Flow**
1. **Initialization:** Read mail template path, output path, and other settings.
2. **Template Processing:** Load template, fill in variable fields (recipient, subject, message, etc.).
3. **Output:** Write completed XML to IFS file system.
4. **Job Logging:** Mark batch/job progress and completion.
5. **Optional Data Queue Posting:** If configured, tell an external monitor/sniffer about new XML files.
6. **Exit.**

---

## 8. **Notable RPG Techniques**
- Use of overlays for date/time parsing.
- Use of CGIDEV2 for dynamic XML/HTML template handling.
- Use of external programs for system configuration and logging.
- String and buffer handling for safe output.

---

## 9. **Comments**
- Comments are in Norwegian; function and variable names are a mix of Norwegian and English.
- The design is modular, with clear separation of configuration, template loading, mail writing, and job tracking.

---

## 10. **Key Points for Onboarding**
- Understand the parameter/configuration file structure (`afpspfr`) and how different settings are loaded.
- CGIDEV2 routines are essential for template operations.
- Rational for components like data queue output (for "sniffer") should be checked if you adapt/extend the code.
- Several external programs handle key business processes/job management—knowledge of their interfaces will be necessary.

---

**Summary:**  
This RPG program prepares an XML message for mailing, using templates stored on the IFS, filling in dynamic variables, and writing the completed file out to disk for further processing, with extensive logging and configurability.