# Program IT118R – Update Freight Forwarder Codes from NAV

## Overview

This program, `IT118R`, is part of the ASNAVIOKO system and is responsible for updating freight forwarder (speditør) codes in the database, based on data received from NAV. The program supports inserting, updating, and deleting records, depending on the command received as an input parameter.

The program is written in traditional (fixed-format) RPG IV, and interacts primarily with the physical file `FRA22LU` (renamed as `RA22LUR` in the program). The program is designed to be called with parameters, likely from another system or a batch interface.

---

## Key Components and Data Flow

### File Definitions

- **FRA22LU** – Main database file containing freight forwarder codes.
  - Renamed as `RA22LUR` for internal use.
  - Accessed with keyed operations.

### Parameters

The program expects the following parameters on entry:

| Parameter | Type/Length     | Description                                 |
|-----------|----------------|---------------------------------------------|
| p_firm    | like(ravfir)   | Company identifier                          |
| p_comd    | Char(20)       | Command: 'INSERT', 'UPDATE', or 'DELETE'    |
| p_parm    | Char(2048)     | Data payload (structure defined below)      |
| p_user    | Char(10)       | User ID                                     |
| p_stat    | Char(1)        | Status flag (output: '1' = success)         |

#### Parameter Data Structure (`d_parm`)

The first part of the `p_parm` parameter is mapped to a data structure:

- `d_vkod` (Char(3)): Code value (to be converted to numeric)
- `d_besk` (Char(20)): Description text

---

## Program Flow

### Initialization (`*inzsr`)

- Parameters are mapped to local variables.
- Key list (`ra22lu_key`) is built for locating records by company and code.
- Current date/time are captured for audit fields.

### Main Logic

1. **Parameter Preprocessing**
   - `d_parm = p_parm`: Copies parameter data into the data structure.
   - `exsr red_num`: Placeholder for numeric field normalization (currently empty).
   - `exsr red_flt`: Converts code field (`d_vkod`) from character to numeric (`w_vkod`).

2. **Command Selection**
   - Based on `p_comd`, the appropriate subroutine is called:
     - `nyrec` for INSERT
     - `oppdrec` for UPDATE
     - `sletrec` for DELETE

3. **Exit**
   - Sets LR indicator and returns.

---

## Subroutines

### `nyrec` – Insert New Record

- Checks if record exists for the given company and code.
- If not found:
  - Populates fields from parameters and timestamp.
  - Writes new record to `RA22LUR`.
  - Sets status flag (`p_stat = '1'`).

### `oppdrec` – Update Existing Record

- Checks if record exists for the given company and code.
- If found:
  - Updates description, date, time, and user fields.
  - Updates record in `RA22LUR`.
  - Sets status flag (`p_stat = '1'`).

### `sletrec` – Delete Record

- Checks if record exists for the given company and code.
- If found:
  - Deletes record from `RA22LUR`.
  - Sets status flag (`p_stat = '1'`).

### `red_num` – Normalize Numeric Fields

- Placeholder for logic to replace blanks with zeros in numeric fields.
- Currently empty; included for future extensibility.

### `red_flt` – Edit Numeric Fields

- Converts the code field (`d_vkod`) from character to packed decimal (`w_vkod`) for use as a key.

### Error Handling (`*pssr`)

- Sets status flag to blank.
- Ends program with LR indicator.

---

## Business and Domain-Specific Logic

- **Freight Forwarder Codes**: The program manages a codebook for freight forwarders, likely used for logistics or shipping processes.
- **NAV Integration**: Data is received from NAV (Norwegian Labour and Welfare Administration), so the program is part of a larger integration pipeline.
- **Audit Fields**: Each write or update operation records the user, date, and time for traceability.
- **Idempotency**: Insert and update operations are protected with existence checks to prevent duplicates or erroneous updates.

---

## Design Decisions and Conventions

- **Parameter Passing**: Uses a large parameter block (`p_parm`) for future extensibility, though only a small portion is currently used.
- **Status Flag (`p_stat`)**: Used to communicate success/failure back to the caller.
- **Key List Usage**: Standardized key list (`ra22lu_key`) for all file operations ensures consistency.
- **Date/Time Handling**: Timestamps are set at the start of the program, not per operation, which may be relevant for batch processing consistency.
- **Error Handling**: Simple error routine; does not provide detailed diagnostics, only signals failure to the caller.

---

## External Interactions

- **FRA22LU (RA22LUR)**: All CRUD operations are performed on this file.
- **No API Calls**: The program operates entirely on the database level; no external APIs are invoked.
- **Caller Responsibility**: The calling program/system is responsible for constructing the parameter block and handling the status flag.

---

## Summary Table of Subroutines

| Subroutine | Purpose                  | Called When    |
|------------|--------------------------|---------------|
| `nyrec`    | Insert new code record   | `p_comd=INSERT` |
| `oppdrec`  | Update existing record   | `p_comd=UPDATE` |
| `sletrec`  | Delete code record       | `p_comd=DELETE` |
| `red_num`  | Normalize numerics       | Always (empty) |
| `red_flt`  | Convert code to numeric  | Always         |
| `*pssr`    | Error handling           | On error       |
| `*inzsr`   | Initialization           | On start       |

---

## Maintenance Notes

- **Extensibility**: The parameter data structure and numeric field editing routines are set up for future expansion.
- **Localization**: Some comments and variable names are in Norwegian; maintainers should be aware of business terminology.
- **Legacy Format**: The program uses classic fixed-format RPG IV; modernization may improve maintainability.

---

## Related Modules

- Any process that provides NAV data or consumes the status flag from this program.
- Other codebook maintenance programs may follow similar structure and conventions.

---

## Conclusion

`IT118R` is a focused, parameter-driven update utility for managing freight forwarder codes, designed for batch or integration use. It adheres to local conventions for parameter handling, auditing, and status reporting, and is structured for future extensibility. Understanding its role within the larger NAV integration context is important for effective maintenance and enhancement.