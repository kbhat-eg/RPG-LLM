```markdown
# FR700R – Rabattmatrise DG Calculation

## 1. Overview  
This ILE RPG program calculates the average DG (margin percentage) for a single matrix row, given all discount fields and a date. It supports different matrix “levels” (item, module, supplier, item group) and delegates price‐base lookup to the external routine `VP700R`. The computed DG (or an input override) is returned in the `p_dggj` parameter.

---

## 2. File Declarations  
- **FRABPF** (disk): the main discount‐matrix file.  
- **VVARL1, VVARL8, VVARLA, VVARLB** (disk, renamed): keyed files for looking up valid item numbers, item groups, suppliers, and module numbers.

---

## 3. Parameters (all input except `p_dggj`)  
- Matrix “key” fields:  
  - `p_firm` (company), `p_prgr` (price‐group),  
  - `p_ogrp`/`p_hgrp`/`p_ugrp` (item group levels),  
  - `p_ldor` (supplier), `p_modn` (module), `p_vare` (item), `p_enhe` (unit), `p_lety` (price type).  
- Line discounts and date validity ranges:  
  - `p_rab1, p_ra1d, p_ra1f, p_ra1t` (first line discount),  
  - `p_rab2, p_ra2d, p_ra2f, p_ra2t` (second line discount),  
  - `p_rabn, p_rand, p_ranf, p_rant` (net price discount),  
  - `p_rabb, p_rabd, p_rbuf, p_rbut` (bottom price discount),  
  - `p_rabt, p_ratd, p_ratf, p_ratt` (offer price discount).  
- Pre‐filled DG override: `p_dekn, p_dekd, p_dekf, p_dekt`.  
- Runtime: `p_dato` (date), `p_time`, `p_inlr` (leave‐on‐last‐record), and output `p_dggj` (5,2).

---

## 4. Working Variables  
- **Matrix‐lookup keys**:  
  - `vvarl1_vare`, `vvarl8_ogrp/hgrp/ugrp`, `vvarla_ldor`, `vvarlb_nmod`.  
- **Price accumulators**:  
  - `w_sapr` (sale price), `w_bupr` (bottom price), `w_tipr` (offer price),  
  - `w_kopr` (cost price), plus summary totals `w_sapr_sum`, `w_kopr_sum`, and counter `w_anta`.  
- **Selected discounts**: `w_rab1`, `w_rab2`, `w_rabn`, `w_rabb`, `w_rabt`.  

---

## 5. Main Logic  

1. **Check for Pre‐filled DG**  
   - If `p_dekn/p_dekd` non‐zero and date within `p_dekf–p_dekt`, use that; otherwise use `p_dekn`.  
   - If `w_dekn` ≠ 0, assign to `p_dggj` and exit.

2. **Load Discounts** (`hent_rab` subroutine)  
   - For each discount field (`rab1`, `rab2`, `rabn`, `rabb`, `rabt`), pick either the default rate or the date‐override rate if `p_dato` is in the override period.

3. **Select by Matrix Level**  
   - If `p_vare` = item ⇒ `behandl_vare`  
   - Else if `p_modn` ⇒ `behandl_modn`  
   - Else if `p_ldor` ⇒ `behandl_ldor`  
   - Else if `p_ogrp` ⇒ `behandl_vgrp`  
   - Else exit.

4. **Compute Average DG**  
   - If at least one item processed (`w_sapr_sum` ≠ 0),  
     DG = 100 – (tot_cost * 100 / tot_sale), clamped to ±999.99.  
   - Assign to `p_dggj` and exit.

---

## 6. Subroutines  

### 6.1 hent_rab  
Populates working discounts (`w_rab1`, `w_rab2`, `w_rabn`, `w_rabb`, `w_rabt`) based on date validity:
- If override rate non‐zero and `p_dato` within its range, use it  
- Else use the default rate.

### 6.2 behandl_vare / behandl_modn / behandl_ldor / behandl_vgrp  
Each locates all matching matrix rows at the given level and for each row calls **kalkuler**:
- **behandl_vare**: chain on exact item.  
- **behandl_modn**: setll & reade on module number.  
- **behandl_ldor**: setll & reade on supplier, with additional checks on group levels.  
- **behandl_vgrp**: setll & reade on item groups and, per record, check supplier match if specified.

### 6.3 kalkuler  
For each matched matrix‐row:
1. Initialize `w_sapr`, `w_bupr`, `w_tipr`, `w_kopr` to zero.  
2. Determine unit (`w_enhe` = parameter or register default).  
3. CALL 'VP700R' (external routine)  
   - Inputs: firm, item, price‐group, unit, price‐type, date/time, LR-flag  
   - Outputs: list price, bottom price, offer price, cost price.  
4. `EXSR bestem_pris`  
5. Increment `w_anta`, add `w_kopr` to `w_kopr_sum`, add `w_sapr` to `w_sapr_sum`.

### 6.4 bestem_pris  
Adjusts `w_sapr` according to the applicable discounts and picks the lowest valid price:
1. If there is an offer price (`w_tipr`) and line offer discount (`w_rabt`), reduce `w_tipr`.  
2. Depending on the item’s price type (`vvkpri`):
   - Blank (normal): apply `w_rab1`, then `w_rab2`.  
   - 'N' (net‐priced): apply `w_rabn`.  
   - 'B' (bottom‐priced): apply `w_rabb`.  
3. Finally, ensure `w_sapr` is not above the bottom price (`w_bupr`) or the (possibly discounted) offer price.

### 6.5 Initialization (`*INZSR`)  
- Moves all incoming parameters into working fields.  
- Clears the output `p_dggj`.  
- Builds key lists for each file access.

---

## 7. Exit  
Sets `*INLR = *ON` and returns, ensuring the subroutine remains active until it’s explicitly ended by the caller.