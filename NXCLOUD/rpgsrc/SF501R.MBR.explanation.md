# RPG Program Explanation: SF501R ("Salgsstatistikk, spørring på salg til kunde")

This document explains the legacy ILE RPG/400 program for AS/400 (IBM i) titled `SF501R`. The program is designed for **customer sales inquiries**—displaying and working with sales statistics regarding sales to a customer. This is an interactive workstation (5250) program, using subfiles to display sales lines, and integrates directly or indirectly with various support modules, as well as providing options for exporting results to Excel via XML.

Below is a structured explanation for onboarding RPG developers.

---

## 1. **Program Structure and Main Features**

- **Purpose**: Customer sales inquiry with subfile listing of sales lines, options to view, print, or export details.
- **Entry/Exit**: Called with parameters for firm, year, customer, project, and document/billing date. Ends with LR (*INLR) set on.
- **Modes**:
  - Workstation mode (interactive 5250)
  - Exports (XML/Excel) if enabled
- **Navigation**: Multiple "position by" options: item, item text, project, invoice date, invoice number, order number.
- **Subfile options**: Details, print copy, view, archive lookup.

---

## 2. **File Declarations**

### a. **Logical and Physical Files**

- **Statistical Files (`sstal3`..`sstal8`)**: Variants for different position keys (by item, text, project, date, invoice, order)
- **Customer & Project Files**: `rkunl1` (customer), `fkprl1` (customer project)
- **Invoice/Order files**: `sohel1`, `bohel1`, etc.
- **Other/Misc**: `afirl1/aforl1` (firm, routine), `votyl1` (order type, for archive)

### b. **Workstation File**

- `sf501d`: Main display file, defines subfile (`b1sfl`) with screen record feedback (`infds`).

---

## 3. **Key Data Structures and Variables**

- **Parameters (`p_*`)**: Firm, year, customer, project, billing date
- **Local Data Area (LDA) Offsets**: Used to pull configuration (e.g., print/export flags, OutQ, user id, etc.)
- **Subfile Control Variables**:
    - `w_fcrn` = First record number on page
    - `w_srrn`, `w_sfrn`, `w_ssrn`: Subfile relative row numbers (current, first, last)
    - `w_spge`: Page size for subfile
    - `w_seqe`: Indicates which positioning mode is in use ('T', 'A', 'D', 'F', 'O', blank)
- **Export/Integration (Excel/XML)**: `XML_Output`, `XML_path`, and working fields for jasper/pdf integration.
- **Display Feedback Structure**: For handling cursor row.

---

## 4. **Indicator Usage (as per header comments)**

- `*INLR`: Program end
- `*IN10`, `*IN11`: Roll, Rolldown (paging)
- `*IN12`~`*IN15`: Subfile display, control, clear, end
- `*IN22`: Cursor positioning
- `*IN30`~`*IN99`: Error and working indicators.

---

## 5. **Main Program Flow**

### a. **Initialization (`*INZSR`)**

- Loads parameters
- Sets up initial selection/positioning keys
- Reads customer/project name for display
- Fills the subfile on startup.

### b. **Main Display Loop**

- Presents options (menu, subfile, etc).
- Handles function key events (`select`/`when`):
    - Exit
    - New inquiry (F12)
    - Refresh (F5)
    - Export to Excel (custom i, only if integration is active)
    - Page forward/back
    - Cursor home

### c. **Positioning Subroutines**

- Allows user to position the subfile by different keys: item, text, project, invoice date, invoice/order number.
- Each has a dedicated key list and SETLL statement.

### d. **Subfile Handling**

- **Fill**: Reads data from correct file by current key type, populates subfile records in blocks.
- **Navigation**: Handles page forward/back, keeps track of subfile paging variables.
- **Selection**: User may choose lines for details/print/view/archiving—invokes separate programs with correct parameters.

### e. **Export to Excel (XML Integration)**

- If enabled and selected, constructs an XML file representing the sales lines.
- Calls routines for environment, heading, line detail, and writes out the XML via provided APIs (CGIDEV2 or equivalent).
- Optionally, triggers batch or sniffer jobs, and launches reports in browser.

---

## 6. **Subroutines Overview**

| Subroutine      | Description                                           |
|-----------------|------------------------------------------------------|
| `forny`         | Refreshes current subfile by the latest selection    |
| `posisjoner`    | Positions subfile by item/text/project/date/invoice  |
| `subfile`       | Main processing for subfile selection/actions        |
| `clr_subfile`   | Clears subfile and related counters                  |
| `crt_subfile`   | Fills subfile with next page of data                 |
| `bck_subfile`   | Moves backwards one page in subfile                  |
| `dsp_subfile`   | Displays subfile to user; update cursor              |
| `spørring`      | Handles inquiry for item/project fields (calls other RPG) |
| `vise`          | Shows invoice or shop receipt (calls SO510R/BO310R) |
| `skriv`         | Prints a copy of invoice (calls FO681R)             |
| `exl_eksport`   | Prepares and exports data to Excel (XML)             |
| `pdf_batchno`   | Generates/requests new batch/job number              |
| `xml_envm`      | Writes out XML for environment (metadata/header)     |
| `xml_head`      | Writes out XML for document heading                  |
| `xml_head_val`  | Writes out individual header values (xml)            |
| `xml_detal`     | Writes out XML for each detail line                  |
| `xml_line_val`  | Writes out value for one XML detail field            |
| `xml_end`       | Writes out XML to disk and triggers sniffer/job if required |
| `pdf_preview`   | Calls preview program for PDF output                 |

---

## 7. **Integration and Extensibility**

- **CGIDEV2**: Used for export and XML/HTML composition for Excel export.
- **Jasper/PDF**: Optionally enabled for advanced document creation and preview.
- **Custom API calls**: E.g., `AP613R` (convert text for XML), `AB705R/AB700R` (log/report), `AS100R` (batch/job number), etc.
- **Data queues**: Can trigger external processes e.g. Java-based sniffers.
- **Archival/Order types**: Archive lookup and advanced order type handling included.

---

## 8. **Function Key Handling (In Screen Control)**

- F3/F12: Exit
- F5: Refresh
- F10: Page forward (create next subfile page)
- F11: Page back (previous page)
- Alt-i: Export Excel (if enabled)
- Roll/Rolldown: Standard navigation

---

## 9. **Comments on Code Style and Conventions**

- **Legacy Style**: Uses fixed-form RPG IV (ILE RPG), with classic cycle and indicator approach.
- **Extensive use of subfiles**: For efficient paged display of lists.
- **Strong dependence on external programs**: For most actions (printing, details, XML conversion, etc).
- **Norwegian naming and comments**: Some comments and variables use Norwegian (e.g., "kunde" = customer, "vare" = item).

---

## 10. **Summary of Typical User Interaction**

1. **User starts inquiry**—parameters determine customer, year, etc.
2. **Subfile displays matching sales lines**—user can page, search, position by various fields.
3. **Options per line**—view invoice, print copy, export, archive lookup, etc.
4. **Exports**—if enabled, can export current result set as an Excel-compatible XML file, which integrates with Jasper or CGIDEV2 output.
5. **Program ends on user exit**—sets LR and returns.

---

## 11. **Key Takeaways**

- **Multiple position/search keys** allow efficient navigation in large customer sales data.
- **Modular, extensible design** (for its era), with hooks for modern integrations.
- **Strong separation** between display logic, subfile maintenance, and data export logic.
- **Configurability via LDA** allows runtime features to be toggled (e.g. PDF/Excel export).

---

### **For New Developers**

- Focus on understanding subfile logic (paging, selection, positioning), as this is central.
- Take note of conventions for calling other programs, especially how parameter lists are built.
- When extending for new fields/options, replicate the established patterns for subfile control and selection handling.
- If working on integration, review external APIs and data queue usage—these are key for automation/export.

---

**End of Explanation**