     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : FO100R
      * Beskrivelse . . : Registrering av tilbud/ordre
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
3.11  * R3.11 220900 AMD  Selgernr. er utvidet fra 2 til 4 posisjoner
3.12  * R3.12 061000 AMD  Lagt inn løsning for planlagt/virkelig lev. dato
3.13  * R3.13 191000 AMD  Lagt inn varsling om krav til rekvisisjon
3.31  * R3.31 020301 AMD  Lagt inn samme kontroller som i FO500R med
      *                   hensyn til bruk av info-koder. (se AAINF330)
3.32  * R3.32 080301 AMD  Lagt inn kontroll på at oppgitt ordretype har
      *                   systemkode 0 (Salg/Ofak)
3.33  * R3.37 150301 AMD  Dersom valg 1 er foretatt (for oppretting av ny
      *                   ordre) posisjonerer programmet på denne ordre ved
      *                   retur til oversiktsbildet.
3.35  * R3.35 120701 AMD  Tilbud skal kunne registreres selv om det er
      *                   satt kredittsperre på kunden.
3.38  * R3.38 280301 AMD  Lagt inn mulighet for å styre om rabatter skal
      *                   vises med prosent, eller som bare et nettobeløp.
3.39  * R3.39 040401 AMD  Avtaletekst er utvidet til 3 linjer, og hentes nå
      *                   fra et eget avtale-register i økonomisystemet.
3.39  * R3.39 170901 AMD  Sperret mulighet for å kunne endre pakkseddel ved
      *                   valg 1, og registrering av ordrenummer.
3.39  * R3.39 020101 AMD  Lager hentes inn fra brukerregister. Bygget inn
      *                   kontroll på gyldig lager selv uten F10-bilder
5.01  * R5.01 241002 AMD  Lagt om rutiner for oppdatering av lager
5.20  * R5.20 291003 AMD  Lagt inn kontroll på om bruker har lov til
5.20  *                   å opprette kunder direkte fra ordresystem
5.21  * R5.21 261103 AMD  Lagt inn mobilnummer i ordrehode
      *       191203 HKO  Henter leveringstype fra avdeling
5.22  * R5.22 250304 AMD  Henter leveringstype fra kunde dersom oppgitt
5.31  * R5.31 130804 GRO  Endringer ifm kort/purchasing
5.32  * R5.32 080904 AMD  Lagt inn ordretype for nummerserie (se dok)
      *       080805 HKO  Fjernet nettovekt og bruttovekt fra ordre-
      *                   hode
      *       131005 HKO  Endret logikk for oppretting av kundeprosjekt
5.51  *       211005 AMD  Endret logikk slik at dersom det på bruker er
5.51  *                   satt opp en ordretype, skal denne benyttes ved
5.51  *                   ny ordre igjen (ikke sist brukte som idag)
      *       241005 HKO  Redesignet bildet samt lagt inn oppfølgingsdato
      *                   og informasjonsfelter
5.52  *       271005 AMD  Lagt inn automatikk ved oppdatering av leverings-
      *                   typer. Oppdaterer på linjenivå ved endring i hode
      *       281105 HKO  Ved opppretting av tilbud, hentes oppfølgingsdato
      *                   og utgår-dato i.h.t. antall dager satt i
      *                   kode/status-registeret
      *       011205 HKO  Fjernet krav om at navn må være utfylt før
      *                   oppretting av ny kunde
      *                   Fjernet kall av FA932R
      *       050206 HKO  Lagt inn bilde for å advare dersom ordren er
      *                   sendt til plukking
      *       150206 HKO  Viser telefonnr, mobilnr og kundeprosjekt-nr
      *                   Erstattet melding ved overskredet kreditgrense
      *                   med eget bilde
5.41  * R5.41 291106 AMD  Hjelpefelt distrikt utvidet fra 2.0 til 4.0
      *       060307 BOF  RKFATY oppd. ordren FOFATY - brukes videre
5.53  * R5.53 210307 AMD  Lagt på mva på memosaldo for å få riktigere
      *                   beregning av kredittgrense
5.54  * R5.54 290307 AMD  Lagt om kjørekontorløsning til logg-filen
5.55  * R5.55 060807 KOB  Lagt inn kontroll mot beløpsgrense almenning
5.60  * R5.60 091107 AMD  Lagt inn løsning for kontroll av grense for
      *                   almenningsrabatter
5.61  * R5.61 070108 bof  Utvidet logg-fil med år
5.61  * R5.61 090108 bof  Utvidet kundeprosjekt med kjørerute
5.62  * R5.62 230308 KOB  Lagt ut telefon og mobilnummer i kvitteringsb
5.63  * R5.63 090109 bof  Endr. på kommentar ved sletting ordre
6.10  * R6.10 240609 BSA  Oppdatert med sporingsinformasjon
6.10  * R6.10 250809 BSA  Utvidet ref. felter fra 20 til 30 posisjoner
6.11  * R6.10 030909 BSA  Lagt til F4 funksjon for kundens ref.
6.13  * 6.13  280109 bof  Tester på om kreditgrense er låst
6.14  * 6.14  110310 AMD  Fjernet sletting av ordre og tilbakestilling
6.14  *                   av ordrenr. når varelinjer ikke er registrert
6.15  * 6.10  040810 BSA  Problemer med lengden på alfafelt, kundenavn og
6.15  *                   midlertidig variabel for kudenavn.
6.16  * 6.10  130910 BSA  Endret parameterliste til RK503R
6.17  * 6.10  050111 BSA  Korttypekode blir liggende fra forrige ordre
6.18  * 6.18  091111 AMD  Krav om rekvisisjon ble hengende igjen
6.18  *                   over til neste ordre
6.19  * 6.10  160512 BOF  Lagt inn ryddeprogram ved oppr.av ordre
6.20  * 6.20  121110 NHO  Endret flytt til proj, er nå alfa
6.21  * 6.20  150211 bof  Paremeterstyre  om leveringsdato er utfylt
6.22  * 6.20  160311 nho  Dersom kunde har verdi i avgiftsfri samt
      *                   spes.fakt skal ordre gjøres om til int.ordre
      *                   Feilmeld. dersom int.ordre prøves å tastes
      *                   inn på kunde som ikke har disse kriteriene
6.23  * 6.20  060511 bof  Lagt inn firmastyrt validering på felt.
6.24  * 6.20  100511 bof  Utvidet med lev.adr. ok
6.25  * 6.20  280411 AMD  Flere muligheter rundt kredit-alternativer
6.26  * 6.20  260511 bof  Legger ut pakkseddeldato istd.f. Aksept dato
6.27  * 6.20  140611 bsa  Memosaldo ligger på egen file
6.28  * 6.20  081111 bof  Hvis kjørekontor skal man havne på FO102R
6.28  *                   hvis man ikke har har valgt på bruker
6.29  * 6.20  081111 bof  Tvungen lev.dato, kun hvis beh.kode otyp> 0
6.2A  * 6.2A  140312 amd  Endring av funksjon for tvungen leverings -
6.2A  *                   adresse
6.2b  * 6.20  030712 bof  Hvis valg=2, skal ikke otyp hentes automatisk
6.2c  * 6.20  280813 bkv  Henter Fakturatype fra kundeprosjekt
6.2d  * 6.20  300713 bof  Lagt inn styring på intern ordretype,ref 6.22
6.2e  * 6.20  270813 bof  Gir melding hvis endre lev.type og det finnes best.
6.2f  * 6.20  030114 bof  Endr.levtype og akktype >=2 gi melding
6.2g  * 6.20  060214 nho  Henter postnr inn i ordrebildet dersom det
      *                   er opprettet under kundeprosjekt F7
6.2h  * 6.20  010414 bkv  Flytter cursor til Lev.Adr. OK
6.2i  * 6.20  050814 bof  Hvis endr.kundeprosjekt,beregn priser
6.2k  * 6.20  180216 bof  Ikke lov å registrere ordre på kontant kunde kassa
6.30  * 6.30  080214 bof  Validering av oppf.dato ifølge AVALPF
6.NU  * R6.30 260514 bsa  Programmet gjennomgått mtp nummerutvidelser.
6.31  * 6.30  060814 bsa  Omskrevet for å begrense antall bilder og
6.31  *                   tastetrykk.
6.32  * 6.30  110914 bsa  Legger ut kontaktpersonnr
6.33  * 6.30  120914 BKV  Henter overstyrt info fra kundeprosjekt
6.34  * 6.30  160914 NHO  *in26 må settes av dersom selger finnes
6.35  * 6.30  141014 bsa  Tilpasser skjermbildet tilø jacada automatikk
6.36  * 6.30  240615 bof  Brukerbegr. endre ordre skal også gjelde akkt=3
6.37  * 6.30  180915 bsa  Skal tillate å lage tilbud selv om kunden har låst
6.37  *                   kreditgrense. NB Må godkjennes med F18
6.38  * 6.30  220915 bsa  Når en legger ut adresseinfo, vis bildet igjen før
6.38  *                   nye valideringer kjøres.
6.39  * 6.30  101215 nho  Feilmelding på lager lå ikke inne            n før
6.3a  * 6.30  160316 nho  Selger hentes ikke fra kundereg..            n før
6.4b  * 6.30  160316 nho  Selger på forrige registrerte kunde
      *                   skal ikke legges ut på neste ordre
6.3c  * 6.30  290316 bof  Hvis nyreg.så validering (var feil)
6.3d  * 6.30  130416 nho  Se 6.30.. Fjernet test på oppfølgingsdato
6.3e  * 6.30  200416 bof  Rettelse av 6.3c
6.3f  * 6.30  191216 bof  Feilretting, test på avdeling
6.3g  * 6.30  290317 bof  Endre lev.typ/uten best.skal også korrigere lager
6.3h  * 6.30  220218 bkv  Fjernet 6.3d
6.3i  * 6.30  140318 nho  Mulighet til å vedlikeholde tekstlinjer når
6.3i  *                   kreditgrense er oversteget.
6.3j  * 6.30  130618 bof   Ved korr. av lag (endr.levtype) kun endr.pr ordre
6.3k  * 6.30  110618 nho  Tok ikke med seg kontaktperson, kun dersom
6.3k  *                   F4 ble tastet
6.3l  * 6.30  050718 bkv  Hvis rkmems blir for høy
6.3m  * 6.30  220818 bsa  Utvidet bestillingsnummer
6.3n  * 6.30  160218 nho  Feilmelding derom ordredato mer enn 1 år tilbake
6.3o  * 6.30  040518 nho  Ikke teste på kreditgrense dersom ordretype
6.3o  *                   er '-'
6.3p  * 6.30  160519 BKV  Automatiks infotype på angitt ordretype
      *
7.xx  * 7.00  210116 bsa  Endringer reltart til ny GUI. NB Kan kun gjelde DDS
7.02  * 7.00  240417 bkv  Newlook SID kopier fra B1LKUN til B1KUND ved ny kunde
7.02  *                   Dette må håndters spesielt i avslutting
7.03  *                   Viser spesialavtaler tidligere
7.04  * 7.00  250917 bkv  Tatt vekk den ene av 7.02
7.05  * 7.00  031017 bkv  Utvidet bestnr
7.06  * 7.00  281217 bkv  Bruker full screen "popup"
7.07  * 7.00  240318 bkv  Mulighet til å lagre F15, uten via linjer
7.08  * 7.00  260818 bkv  Henter mobilnr fra kontaktperson
Q.01  * 7.00  020819 bsa  Quick wins - større skjerm
Q.02  * 7.00  020419 bsa  Quick wins - sjekker mot koder om leveringsdato
Q.02  *                   skal initieres.
7.09  * 7.00  080518 bkv  Automatisk nobb frakt på direktelevert
7.10  * 7.00  090519 sst  Test på sammenheng lager og avdeling (fra d22)
7.11  * 7.00  090519 sst  Fjernet spørring ved F4 i Kundeprosjekt Gaute (d22)
7.12  * 7.00  150519 bsa  Legger ut ekstern ordrereferanse
7.13  * 7.00  060619 ask  Henter selger, avdeling og lager fra bruker
7.14  * 7.00  060619 ask  Logger opprettelsen av tilbud i loggfil
7.15  * 7.00  060619 ask  Logger endring av oppfølgings og utgår dato på tilbud
7.16  * 7.00  060619 sst  Ber flytende Memosaldo m/ordre pr ant. dager
      *       060619 sst  Hente parameter meosaldo fra AFPSPF
7.17  *       060619 sst  Nullstille feilindikator for selger
7.18  *       060619 sst  Hente opp underprosjekt og aktivitet
7.19  *       070619 sst  Sperre tilbudskunde for annet enn ordretye T
7.20  *       070619 sst  Valgmulighet om rekalkulering av priser ved
7.20  *                    endring av leveringstype.
7.21  * IKKE  070619 bsa  Må velge kundeprosjekt hvis det er satt på
      *                   kundekategorien.
7.22  *       220619 bof  Hvis direkte valgt på fors.m, så levtype=1
7.23  *       220619 BSA  Legger PN ordre på hold.
7.24  * 7.00  240619 bsa  Håndterer kopiering av kontantkunder til master      *
7.25  * 7.00  160919 bkv  Kopiere ordre ut fra referanse ordre
7.26  * 7.00  041219 bkv  Leveringsdato fylles ut ved registrering av ordre
7.27  * 7.00  030119 bkv  Vasker ulovlige tegn
7.28  *       140220 bkv  Hvis kunde XXXXXX skal ordretype 'YY' gjelde
7.29  *       110320 sst  Hente opp prosjekt fra fohe til fodt dersom kundeprosj
      *                   er lagt på etter at varelinjer er registrert
7.2a  *K00    230420 sst Bård     Oppgradering av versjon fra I06
7.2b  *K00    210121 bsa  Rettet parameterliste til RP601.
7.30  * 7.00  021219 sst  Åpne for reg av tekst selv om usr sperret for endring
7.31  *       180520 bof   Hvis ikke int.kund + PI : legg *H i info-type
7.32  *       090920 ask   Sjekker om det er samsvar mellom varekunde og fakturakunde
7.33  *K00    250320 ask  Lagt inn søk mot 1881
7.34  *K000   281220 bsa  Legger inn switch om det skal sjekkes mot kreditgrense
7.34  *K000               hvis det er tilbud.
7.35  * 7.00  240620 ask  Viser ekstern ordrerferanse
7.36  * 6.20  090614 ask  Lagt inn kontroll mot valg av kundeprosjekt
      *
8.01  *       260519 ask  Krav om at avd. fylles ut  (tidligere 7.22)
8.02  *       060422 ask  Korrigert switch navn for 1881 oppslag
8.03  *K000   050122 bsa  Viser varekundeinfo når det er valgt kunde m/fakturakunde
8.03  *K000               og kundeprosjekt.
8.04  *K000   101022 bsa  Fjerner kall til FO766R, da den ikke behøver å kjøres.
8.05  *K000   231122 sst  Flyttet ant memo-dager og utv.kreditgrense til  UTVIDET_MEMOSALDO (nx)
8.06  *K000   030123 bsa  Hvis vi kjører med ekstern flåtestyring, kjør
8.06  *K000               request til API for opprettelse av transport.
8.06  *K000               Flåtestyring på lagernivå.
8.07  *K000   050123 bsa  Hvis vi endrer forsendelsesmåte, sjekk om det
8.07  *K000               skal sendes kansellering av transportoppdrag.
8.08  *K000   170123 bsa  Flagg om skaffetekst i transportlogg.
8.09  *K000   060223 bsa  Flagg om sjekk på loggkode i transportlogging
8.10  *       210223 sst  Endret bygging av memosaldo
8.11  *K000   300522 bsa  Fortsetter endring 8.03. Forutsetter at det er faktura-
8.11  *K000               kunde på varekunden, og ikke valgt kundeprosjekt.
8.11  *K000               Hvis sjekk på FONAVN, settes varekunde på både ordre/levering.
8.11  *K000               Hvis ikke sjekk, skal leveringsadresse være blank.
8.12  *K000   170223 ask  Henter mobilnummer og kontaktperson fra kundeprosjekt om det er valgt
8.13  *K000   030523 bsa  Endrer logikken rundt mobilnummer.
8.14  *K000   160223 bsa  Flyttet på sjekk mot endring av kundeprosjekt.
8.15  *K000   290623 bsa  Hvis kundens ref allerede er utfylt, skal det ikke
8.15  *K000               skrives over fra prosjektet.
8.16  * K000  301023 bsa  Hvis det er kontantkunde, skal det ikke kunne plukkes  til
8.16  * K000              annet enn tilbud. Justert endring 7.19. Tester ikke lenger
8.16  * K000              på hardkodet kundenummer.
8.17  *PRG2   090622 BOF  Utvidet prisgruppe fra 1 til 2 posisjoner
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fausrl1    if   e           k disk    rename(ausrpfr:ausrl1r)
6.23 favall1    if   e           k disk    rename(avalpfr:avall1r)
     ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
8.03 frkunlr    if   e           k disk    rename(rkunpfr:rkunlrr)
8.03 f                                     prefix(xk:2)
6.27 frkmel1    if   e           k disk    rename(rkmepfr:rkmel1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
6.2d fvot1l1    if   e           k disk    rename(vot1pfr:vot1l1r)
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     ffohelu    uf a e           k disk    rename(fohepfr:fohelur)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
7.14 ffkp2l1    if   e           k disk    rename(fkp2pfr:fkp2l1r)
     fvltpl1    if   e           k disk    rename(vltppfr:vltpl1r)
     fvinfl1    if   e           k disk    rename(vinfpfr:vinfl1r)
6.2e ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
6.2e flohel1    if   e           k disk    rename(lohepfr:lohel1r)
6.2e fvotylr    if   e           k disk    rename(votypfr:votylrr)
6.2e f                                     prefix(xa:2)
6.2e flfdtl6    if   e           k disk    rename(lfdtpfr:lfdtl6r)
6.2e flfhelu    uf   e           k disk    rename(lfhepfr:lfhelur)
6.2e flfdtlu    uf   e           k disk    rename(lfdtpfr:lfdtlur)
6.2g faposl1    if   e           k disk    rename(apospfr:aposl1r)
     fra07l1    if   e           k disk    rename(ra07pfr:ra07l1r)
     fra09l1    if   e           k disk    rename(ra09pfr:ra09l1r)
8.05 f*afpslr    if   e           k disk    rename(afpspfr:afpslrr)
6.2k fbstsl1    if   e           k disk    rename(bstspfr:bstsl1r)
7.09 ffoh2lu    uf a e           k disk    rename(foh2pfr:foh2lur)
7.09 ffodtlu    uf   e           k disk    rename(fodtpfr:fodtlur)
7.18 frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
7.18 frp2ul1    if   e           k disk    rename(rp2upfr:rp2ul1r)
7.21 f*ra11l1    if   e           k disk    rename(ra11pfr:ra11l1r)
7.22 fra17l1    if   e           k disk    rename(ra17pfr:ra17l1r)
7.25 fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
7.36 frku2l1    if   e           k disk    rename(rku2pfr:rku2l1r)
8.06 ffloglr    if   e           k disk    rename(flogpfr:floglrr)
8.07 fftrpi2    if   e           k disk    rename(ftrpst:ftrpi2r)
      *
     ffo100d    cf   e             workstn
      *
      * Definering av array's
      *
6.2A d a_mld1          s             50    dim(3) ctdata perrcd(1)
      *
7.05 d a_benr          s              8  0 dim(5)
      *
      * Definering av local data area
      *
     d                uds
     d l_wsid                901    910
     d l_user                911    920
7.00 d l_filg                931    933
     d l_sfir                944    946  0
     d l_fnav                951    980
     d l_syst                999    999
      *
6.2g d                 ds
6.2g d d_post                  1     30
6.2g d  d_nr                   1      4
6.2g d  d_st                   6     30
      * Definering av parametere
      *
6.NU d p_numm          s              8  0
     d p_suff          s              2  0
     d p_valg          s              2  0
6.3i d p_txtl          s              2
7.24 d p_dato          s              8  0
7.24 d p_time          s              6  0
7.29 d p_numx          s              8
7.29 d p_sufx          s              2
      *
      * Definering av variabler i nøkler
      *
     d w_firm          s                   like(fofirm)
7.24 d w_mfir          s                   like(fofirm)
     d ausrl1_user     s                   like(abuser)
     d fusrl1_user     s                   like(fbuser)
6.23 d avall1_apgm     s                   like(avapgm)
     d rkunl1_kund     s                   like(rkkund)
8.03 d rkunlr_kund     s                   like(rkkund)
     d votyl1_otyp     s                   like(vaotyp)
6.2d d vot1l1_otyp     s                   like(va1typ)
     d fohel1_numm     s                   like(fonumm)
     d fohel1_suff     s                   like(fosuff)
     d fkprl1_kund     s                   like(flkund)
     d fkprl1_kpro     s                   like(flkpro)
     d vltpl1_lety     s                   like(vylety)
     d vinfl1_ityp     s                   like(vaityp)
6.2e d fodtl1_numm     s                   like(fdnumm)
6.2e d lohel1_numm     s                   like(lonumm)
6.2e d votylr_otyp     s                   like(vaotyp)
6.2e d lfdtl6_ornr     s                   like(lfornr)
6.2e d lfhelu_numm     s                   like(lhnumm)
6.2e d lfdtlu_numm     s                   like(lhnumm)
6.2g d aposl1_ponr     s                   like(apponr)
     d ra07l1_gkod     s                   like(ragkod)
     d ra09l1_ikod     s                   like(raikod)
9.xx d edhel2_numm     s                   like(fonumm)
8.05 d*afpslr_ufil     s                   like(afufil)
8.05 d*afpslr_uide     s                   like(afuide)
7.18 d rp1pl1_pros     s                   like(rp1pro)
7.18 d rp2ul1_pros     s                   like(rp2pro)
7.18 d rp2ul1_upro     s                   like(rp2upr)
7.21 d* ra11l1_kkod     s                   like(rakkod)
7.22 d ra17l1_qkod     s                   like(raqkod)
7.25 d sohel1_aarr     s                   like(soaarr)
7.25 d sohel1_binr     s                   like(sobinr)
7.25 d sohel1_numm     s                   like(sonumm)
7.25 d sohel1_suff     s                   like(sosuff)
7.36 d rku2l1_2kun     s                   like(rkkund)
8.06 d floglr_aarr     s                   like(fuaarr)
8.06 d floglr_numm     s                   like(funumm)
8.06 d floglr_suff     s                   like(fusuff)
8.07 d ftrpi2_rnum     s                   like(ftrnum)
8.07 d ftrpi2_rsuf     s                   like(ftrsuf)
      *
      * Definering av variable
      *
     d w_udat          s               d   datfmt(*iso)
     d w_ltxt          s                   like(vybesk)
     d w_kund          s                   like(rkkund)
     d w_bdat          s                   like(fobdat)
     d w_ddat          s                   like(foddat)
     d w_ldat          s                   like(foldat)
     d w_tdat          s                   like(fotdat)
6.26 d w_pada          s                   like(fopada)
     d w_itxt          s                   like(vaitxt)
5.32 d w_onum          s                   like(vaonum)
5.20 d w_ko12          s                   like(fbko12)
     d w_enor          s              1
5.01 d w_opdt          s              1
3.39 d w_mld1          s             50
6.16 d w_emal          s             50
7.08 d w_mobi          s             11
6.2e d w_mld2          s             50
6.2e d w_svar          s              1
6.2e d w_in12          s              1  0
6.32 d w_kpnr          s                   like(fokpnr)
6.3n d x1bdat          s              6  0
6.3n d w1_bdat         s                   like(fobdat)
6.3n d w_aar1          s              4  0
6.3n d w_aar2          s              2  0
6.3n d w_aar3          s              4  0
6.3n d w_aamd          s              4  0
6.3n d w_avik          s              4  0
6.3n d w_tesdt         s              6  0
6.3n d w_aarm          s              2  0
6.3n d w_aard          s              2  0
6.3n d w1_dato         s               d   datfmt(*iso)
7.24 d w_mfil          s              3
8.06 d w_reqs          s              5
8.07 d w_lmat          s              2  0
      *
     d w_dato          s                   like(flfdat)
     d w_kpro          s                   like(flkpro)
     d w_navn          s                   like(flnavn)
     d w_adr1          s                   like(fladr1)
     d w_adr2          s                   like(fladr2)
     d w_sted          s                   like(fosted)
     d w_kprs          s                   like(flkprs)
     d w_tlfa          s                   like(fltlfa)
     d w_tlfp          s                   like(fltlfp)
     d w_tlfm          s                   like(fltlfm)
     d w_mail          s                   like(flmail)
     d w_orka          s                   like(florka)
     d w_okun          s                   like(flokun)
     d w_okpr          s                   like(flokpr)
     d w_opda          s                   like(flopda)
     d w_proj          s                   like(flproj)
7.18 d w_upro          s                   like(flupro)
5.61 d w_kjor          s                   like(flkjor)
5.61 d w_kjnr          s                   like(flkjnr)
6.31 d w_ikod          s              4  0
6.31 d w_jkod          s              2  0
6.31 d w_qkod          s              2  0
6.31 d w_qtxt          s             20
6.31 d w_avde          s                   like(foavde)
6.31 d w_gtxt          s             30
3.39  *
3.39 d w_sat1          s                   like(fonavn)
3.39 d w_sat2          s                   like(fonavn)
3.39 d w_sat3          s                   like(fonavn)
3.39  *
     d w_kund_kopi     s                   like(flkund)
     d w_kpro_kopi     s                   like(flkpro)
3.39  *
3.39 d w_retk          s              1
3.39 d w_jtxt          s             20
3.10 d w_jadr          s             30
3.10 d w_jpnr          s              4  0
3.10 d w_jste          s             30
3.10 d w_javd          s              4  0
3.39  *
     d w_in01          s              1  0
     d w_feil_kund     s              1
     d w_kom1          s             30
     d w_kom2          s             30
     d w_sald          s             11  2
5.60 d w_sal2          s             11  2
     d w_retu          s              1
     d w_fast          s             10
     d w_fell          s              6
     d w_kode          s              1
5.61 d w_aarr          s              4  0
6.nu d w_numm          s              8  0
     d w_ordr          s              1  0
     d w_linj          s              1
     d w_type          s              2
     d w_text          s              4
     d b_feil          s              1    inz(*off)
6.2e d b_bkjo          s              1    inz(*off)
6.2e d b_lety          s              1    inz(*off)
6.2e d b_bfoh          s              1    inz(*off)
7.22 d b_dirl          s              1    inz(*off)
8.06 d b_trpl          s              1    inz(*off)
      *
     d w_ksob          s              1  0
     d w_ktxt          s              1  0
     d w_kfak          s              1  0
     d w_kspr          s              1  0
     d w_lmtx          s             20
     d w_lbtx          s             75
     d w_rabp          s              5  2
     d w_selg          s              4  0
      *
     d w_cord          s              1  0
     d w_bind          s              1
     d w_otyp          s              2
     d w_odat          s              6  0
     d w_aord          s              1  0
6.10 d w_vref          s             30
6.11 d w_kref          s             30
6.11 d w_lkun          s                   like(fokund)
7.03 d w_akun          s                   like(fokund)
5.31 d w_stat          s              1
5.52 d w_flty          s                   like(folety)
5.52 d w_valg          s              1
5.52 d w_in03          s              1
6.2d d w_1int          s                   like(va1int)
6.33 d w_betb          s                   like(rkbetb)
6.33 d w_mkod          s                   like(rkmkod)
6.33 d w_kgek          s                   like(rkekgb)
6.33 d w_neto          s                   like(rkneto)
6.33 d w_fagb          s                   like(rkfagb)
7.14 d w_aktp          s             15
7.14 d w_sgru          s             60
7.14 d w_slko          s              2  0
7.14 d w_kkko          s              2  0
7.16  *w_utvgrns = utvidelse av memosaldo(Mestergruppen)
7.16 d w_utvgrns       s              2  0
7.16  *w_memodagr = antall dager ordre skal med i memosaldo
7.16 d w_memodagr      s              3  0
7.16 d w_3x            s              3
7.16 d p_fir           s              3
7.16 d p_kun           s              6
7.16 d w_904           s              1    inz('N')
7.18 d p_upro          s                   like(rp2upr)
7.18 d p_akti          s              6
7.18 d p_txt1          s                   like(rp2txt)
7.18 d p_txt2          s                   like(rp2tx2)
7.18 d p_uprs          s                   like(rp2upr)
7.18 d p_prt1          s                   like(rp2txt)
7.18 d p_kund          s                   like(rp1knr)
7.24 d w_mtime         s               t
7.24 d w_mdato         s               d
7.32 d w_faku          s                   like(rkfaku)
5.53  *
5.53  * Parametre til RS205R - hent mva %
5.53  *
5.53 d w_mvak          s              1
5.53 d w_mvtx          s             30
5.53 d w_mvas          s              6  2
5.53 d w_mvat          s              5  4
5.53 d w_mvaf          s             10  9
5.53 d w_bpro          s              5  2
5.53 d w_date          s               d   datfmt(*iso)
5.54 d w_dat2          s               d   datfmt(*iso)
5.54 d w_time          s               t   timfmt(*iso)
5.54 d w_user          s             10
5.54 d w_wsid          s             10
5.54 d w_sva2          s              1
5.54 d w_kod2          s              1
5.55 d w_bgrn          s                   like(rkgral)
6.39 d w_pval          s              1
6.39 d w_lage          s                   like(folage)
6.39 d w_lag1          s                   like(folage)
6.3p d w_ityp          s                   like(foityp)
6.3p d w_otyp2         s                   like(footyp)
6.3p d w_pos           s              2s 0
7.09 d w_prgr          s                   like(fdprgr)
7.09 d w_lety          s                   like(folety)
7.09 d b_inlr          s              1    inz(*off)
7.09 d w_inpr2         s                   like(fdinpr)
7.09 d w_kopr2         s                   like(fdkopr)
7.09 d w_sapr2         s                   like(fdsapr)
7.09 d w_bupr2         s                   like(fdsapr)
7.09 d w_hlev          s              1  0
7.09 d w_kopr          s              9  2
7.09 d w_inpr          s              9  2
7.09 d w_lenh          s                   like(fdenh1)
7.09 d w_kamp          s                   like(fdkamp)
7.25 d w_rord          s              1    inz(*off)
7.25 d w_vrefk         s                   like(fovref)
7.25 d w_otypk         s                   like(footyp)
7.25 d w_sobinr        s                   like(sobinr)
7.28 d w_fokund        s                   like(fokund)
7.28 d w_footyp        s                   like(footyp)
7.33 d w_ponr          s              4  0
7.2b d w_rakt          s              1
8.08 d w_skaf          s              1  0
8.09 d w_logg          s              1  0
7.2b d p_fdat          s              6  0
7.2b d p_tdat          s              6  0
7.2b d w_kunf          s              6  0
7.2b d w_knav          s             30
7.2b d p_kpro          s              6  0
7.2b d p_selg          s              4  0
7.30  *  w_tekst_pakk = J betyr at firmaet tillater reg tekst på pakkseddel
7.30  *                   selv om bruker er sperret for endring
7.30  *                   styres fra: PAKK_TEKST_ENDRE_OM_IKKE_TILGANG
7.30 d w_tekst_pakk    s              1    inz(' ')
7.30  *  w_pakk_sperr = J betyr at bruker er sperret for en del valg og f-taster
7.30  *                   Åpne valg:    Åpne F-taster: F1, F3, F5, F11, F15, F21
7.30 d w_pakk_sperr    s              1    inz(' ')
      *
6.2e d x               s              1  0
      *
      * Definering av save-variable
      *
3.38 d s_neto          s                   like(foneto)
     d s_kpro          s                   like(fokpro)
     d s_proj          s                   like(foproj)
     d s_orka          s                   like(forkat)
     d s_rkat          s                   like(forkat)
     d s_kund          s                   like(fokund)
6.NU d s_numm          s                   like(fonumm)
     d s_suff          s                   like(fosuff)
     d s_lety          s                   like(folety)
     d s_akun          s              6  0
     d s_sald          s             11  2
     d s_sper          s              1  0
     d s_gren          s             11  2
6.15 d*s_kuna          s             12
6.15 d s_kuna          s             18
     d s_lage          s              2  0
     d s_avde          s              4  0
     d s_betb          s              2  0
     d s_faty          s              2  0
5.41 d s_dist          s              4  0
     d s_lmat          s              2  0
     d s_lbet          s              2  0
     d s_valk          s              3
     d s_sped          s              3  0
     d s_kjor          s              2  0
5.61 d s_kjnr          s              5  0
     d s_mkod          s              1  0
     d s_kobk          s              1  0
     d s_kgfa          s              1  0
     d s_kgek          s              1  0
     d s_kgfr          s              1  0
5.55 d s_gral          s                   like(rkgral)
5.55 d s_kjal          s                   like(rkkjal)
7.15 d s_ddat          s                   like(foddat)
7.15 d s_tdat          s                   like(fotdat)
      *
6.23  * Firmastyrt validering av felt
6.23  *
6.23 d u_vref          s              1    inz(*off)
6.23 d u_dref          s              1    inz(*off)
6.23 d u_ldat          s              1    inz(*off)
6.30 d u_ddat          s              1    inz(*off)
6.23 d u_navn          s              1    inz(*off)
7.33 d u_1881          s              1    inz(*off)
7.33 d b_1881          s              1    inz(*off)
      *
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
7.00 d u_nofa          s              1    inz(*off)
7.10 d u_710           s              1    inz(*off)
7.11 d u_711           s              1    inz(*off)
7.12 d u_712           s              1    inz(*off)
6.3p d u_63p           s              1    inz(*off)
7.13 d u_713           s              1    inz(*off)
7.14 d u_714           s              1    inz(*off)
7.15 d u_715           s              1    inz(*off)
7.16 d u_716           s              1    inz(*off)
7.18 d u_718           s              1    inz(*off)
7.19 d u_719           s              1    inz(*off)
7.20 d u_720           s              1    inz(*off)
7.21 d u_721           s              1    inz(*off)
7.22 d u_722           s              1    inz(*off)
7.23 d u_723           s              1    inz(*off)
7.24 d u_724           s              1    inz(*off)
7.25 d u_725           s              1    inz(*off)
7.26 d u_726           s              1    inz(*off)
7.28 d u_728           s              1    inz(*off)
7.31 d u_731           s              1    inz(*off)
7.34 d u_734           s              1    inz(*off)
7.36 d u_736           s              1    inz(*off)
8.01 d u_801           s              1    inz(*off)
8.06 d u_806           s              1    inz(*off)
8.05 d u_kmem          s              1    inz(*off)
8.16 d u_til           s              1    inz(*off)
      *
      * Definering av Konstanter
      *
     d lo              c                   'abcdefghijklmnopqrstuvwxyzæøåäö'
     d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅÄÖ'
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av tilbud/ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
      * Forklaring til statuskoder
      *
      *       w_retu       Benyttes ved retur fra ett annet program
      *       w_ordr       Dersom ordre finnes =1, ellers =0
      *       w_linj       Retur-kode, fra varelinjer  (=1, dersom vedl.)
      *       w_feil_kund  A=Feil fakturakunde, B=Feil varekunde C=Internkunde
6.2k  *                    D=Kontantkunde
      *
     C/Exec SQL
     C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
     C/End-Exec
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Startrutine for program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Valg 2 for endring, send opp aktuell ordre
      *
     c                   if        p_valg = 2
     c                   eval      b1onum = p_numm
     c                   eval      b1osuf = p_suff
     c                   goto      b1tag0
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * B1 Behandler åpningsbildet samt funksjonstaster
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     b1tag         tag
      *
      * Valg 2 for endring, gå tilbake til spørreprogram
      *
     c                   if        p_valg = 2
     c                   exsr      merke_ordre
     c                   goto      avslutt
     c                   endif
      *
     c                   exsr      init_b1bld
      *
     c     b1taga        tag
     c                   eval      w_retu = *blank
     c                   eval      w_in01 = 0
     c                   eval      *in23  = w_cord = 1
     c                   if        *in23  = *off
     c                   eval      *in25  = *on
     c                   endif
      *
     c     b1tagb        tag
      *
7.03 c*                  eval      *in28 = rkspav <> 0
7.03 c                   eval      *in28 = b2sat1 <> ''
5.52 c                   eval      w_valg = ' '
5.52 c                   eval      w_in03 = ' '
      *
      * Send Alt
      *
     c                   exfmt     b1bld
     c                   eval      *in23 = *off
     c                   eval      *in25 = *off
7.17 c                   eval      *in26 = *off
     c                   eval      *in27 = *off
     c                   eval      *in28 = *off
6.2h c                   eval      *in29 = *off
7.30  *
7.30  *    Sjekk om bruker har tilgang til funksjonstast
7.30  *                            *in16 betyr at f-tast er trykket
7.30 c                   if        *in16
7.30 c                             and w_pakk_sperr = 'J'
7.30 c                             and not (*inka
7.30 c                                   or *inkc
7.30 c                                   or *inke
7.30 c                                   or *inkk
7.30 c                                   or *inkp
7.30 c                                   or *inkv)
7.30 c                   eval      w_mld1 = 'Funksjonstast ikke tillatt for +
7.30 c                                       din bruker'
7.30 c                   call      'AA005R'
7.30 c                   parm                    w_mld1
7.30 c                   goto      b1tagb
7.30 c                   endif
      *
      * F1=Hente inn kundeprosjekt
      *
     c                   if        *inka = *on
     c                   exsr      hente_kproj
     c                   goto      b1tagb
     c                   endif
      *
      * F3=Avslutt program
      *
     c                   if        *inkc = *on
     c                   exsr      merke_ordre
3.33 c                   eval      p_numm = fonumm
3.33 c                   eval      p_suff = fosuff
     c                   goto      avslutt
     c                   endif
      *
      * F4=Spørring
      *
     c                   if        *inkd  = *on
     c                   exsr      spØrring
7.33  *
7.33  * Søk mot 1881 dersom kunde ikke funnet
7.33  *
7.33 c                   if        w_afld = 'B1LKUN' and
7.33 c                             u_1881 = *on and
7.33 c                             b1lkun = 0
7.33 c                   eval      b_1881 = *off
7.33 c                   exsr      xe2win
7.33 c                   if        b_1881 = *on
7.33 c                   exsr      oppr_kunde
7.33 c                   if        w_retu = *blank
7.33 c                   goto      b1tag0
7.33 c                   endif
7.33 c                   eval      b1navn = *blank
7.33 c                   eval      b1adr1 = *blank
7.33 c                   eval      b1adr2 = *blank
7.33 c                   eval      b1sted = *blank
7.33 c                   eval      e2tlfn = *blank
7.33 c                   endif
7.33 c                   endif
     c                   goto      b1tagb
     c                   endif
      *
      * F6=Opprett ny kunde i kunde-register
      *
     c                   if        *inkf = *on
     c                   exsr      oppr_kunde
     c                   if        w_retu = *blank
     c                   goto      b1tag0
     c                   endif
     c                   endif
      *
      * F7=Opprett nytt kundeprosjekt
      *
     c                   if        *inkg = *on
     c                   exsr      oppr_kundepro
     c                   goto      b1tagb
     c                   endif
      *
      * F10=Vedlikehold av faste opplysninger i ORDRE-HODE-REGISTER
      *
     c                   if        *inkj = *on
     c                   if        fohel1_numm <> 0
     c                   call      'FO101R'
     c                   parm                    w_firm
     c                   parm                    fohel1_numm
     c                   parm                    fohel1_suff
     c                   endif
     c                   goto      b1taga
     c                   endif
      *
      * F11=Vedlikehold av frie tekster i ORDRE-TEKST-REGISTER
      *
     c                   if        *inkk = *on
     c                   if        fohel1_numm <> 0
     c                   call      'FO105R'
     c                   parm                    w_firm
     c                   parm                    fohel1_numm
     c                   parm                    fohel1_suff
     c                   endif
     c                   goto      b1taga
     c                   endif
      *
      * F12=Frigjør det som er igang, og sender opp blankt bilde
      *
     c                   if        *inkl = *on
     c                   exsr      merke_ordre
     c                   goto      b1tag
     c                   endif
      *
      * F21=Spørring i vare-register
      *
     c                   if        *inkv = *on
     c                   call      'VV550R'
     c                   parm                    w_retu
     c                   parm                    w_firm
     c                   goto      b1tag
     c                   endif
      *
7.25 c                   if        b1rnum <> 0 and *in61 = *off
7.25 c                   exsr      kopier_ordre
7.25 c                   goto      b1tagb
7.25 c*                   eval      b1rnum = 0
7.25 c                   endif
7.21  ** Hent informasjon rundt kundekategori
7.21 c*                   if        u_721 = *on
7.21 c*                   eval      rkunl1_kund = b1lkun
7.21 c*     rkunl1_key    chain     rkunl1r
7.21 c*                   if        %found
7.21 c*                   eval      ra11l1_kkod = rkkatg
7.21 c*     ra11l1_key    chain     ra11l1
7.21 c*                   if        not %found
7.21 c*                   eval      rakkpr = *blanks
7.21 c*                   endif
7.21 c*                   endif
7.21 c*                   endif
6.2A  *
6.2A  * tester om lev.adresse ikke utfylt og om fakt.adresse i så
6.2A  * fall skal fylles inn
6.2A c                   if        b1navn = *blank and
6.2A c                             b1adr1 = *blank and
6.2A c                             b1adr2 = *blank and
6.2A c                             b1laok = 1
6.2A c                   eval      rkunl1_kund = b1lkun
6.2A c     rkunl1_key    chain     rkunl1r                            66
6.2A c                   eval      b1navn = rknavn
6.2A c                   eval      b1adr1 = rkgate
6.2A c                   eval      b1adr2 = rkadr2
6.2A c                   eval      b1sted = rksted
7.13 c                   if        u_713 = *off
7.13 c                   if        rkslgr <> 0
6.3a c                   eval      b1selg = rkslgr
6.3a c                   endif
7.13 c                   endif
7.03 c                   exsr      hent_avts
6.38 c                   goto      b1tagb
6.2A c                   endif
      *
     c                   if        w_retu = '9'
     c                   goto      b1tag
     c                   endif
7.32  *
7.32  * Sjekk om samsvar mellom varekunde og fakturakunde
7.32  *
7.32 c                   if        b1lkun <> 0 and
7.32 c                             b1kund <> 0
7.32 c/exec sql
7.32 c+ SELECT RKFAKU INTO :w_faku
7.32 c+  FROM RKUNPF
7.32 c+  WHERE RKFIRM = :w_firm and RKKUND = :b1lkun
7.32 c/end-exec
7.32
7.32 c                   if        w_faku <> b1kund
7.32 c                   exfmt     f4win
7.32 c                   goto      b1tagb
7.32 c                   endif
7.32 c                   endif
      *
      * Sjekk av input
      *
     c                   exsr      sjekk_input
      *
     c                   if        b_feil = *on
     c                   goto      b1tagb
     c                   endif
      *
      * Dersom nytt tilbud hentes oppfølgingsdato og utgår-dato
      * i.h.t. antall dager i kode/status-register
      *
     c                   if        w_ordr = 0 and
     c                             vaoakk = 0
     c                   if        faaopf <> 0 and
     c                             b1ddat = 0
     c     *dmy          move      b1bdat        w_bdat
     c     w_bdat        adddur    faaopf:*d     w_ddat
     c     *dmy          move      w_ddat        b1ddat
     c                   endif
     c                   if        faautg <> 0 and
     c                             b1tdat = 0
     c     *dmy          move      b1bdat        w_bdat
     c     w_bdat        adddur    faautg:*d     w_tdat
     c     *dmy          move      w_tdat        b1tdat
     c                   endif
     c                   endif
      *
      * Dersom det finnes kundeprosjekt på kunden
      * skal vindu for valg komme opp automatisk
      *
     c                   if        b1lkun <> 0
     c                   eval      fkprl1_kund = b1lkun
     c                   else
     c                   eval      fkprl1_kund = b1kund
     c                   endif
      *
     c     fkprl1_key2   chain     fkprl1
     c                   if        not %found
6.23 c                   eval      w_in01 = 1
     c                   goto      b1tag0
     c                   endif
      *
7.21 c*                   if        u_721 = *on
7.21 c*                   if        b1navn <> *blank and
7.21 c*                             rakkpr =  *blank or
7.21 c*                             b1navn <> *blank and
7.21 c*                             rakkpr =  'J'    and
7.21 c*                             fokpro <> 0
7.21 c*                   if        b1navn <> *blank
7.21 c*                   goto      b1tag0
7.21 c*                   endif
7.21 c*                   endif
7.21 c*                   else
     c                   if        b1navn <> *blank
     c                   goto      b1tag0
     c                   endif
7.21 c*                   endif
      *
7.21 c*                   if        u_721 = *on
7.21 c*                   if        w_in01 = 1  and
7.21 c*                             rakkpr <> 'J' or
7.21 c*                             w_in01 = 1  and
7.21 c*                             rakkpr = 'J' and
7.21 c*                             fokpro <> 0  or
7.21 c*                             w_in01 = 1  and
7.21 c*                             rakkpr = 'J' and
7.21 c*                             w_kpro <> 0
7.21 c*                   if        w_in01 = 1
7.21 c*                   goto      b1tag0
7.21 c*                   endif
7.21 c*                   endif
7.21 c*                   else
     c                   if        w_in01 = 1
     c                   goto      b1tag0
     c                   endif
7.21 c*                   endif
      *
     c                   eval      w_kund = fkprl1_kund
     c                   move      udate         w_dato
     c                   eval      w_kpro = 0
     c                   eval      w_navn = *blank
     c                   eval      w_adr1 = *blank
     c                   eval      w_adr2 = *blank
     c                   eval      w_sted = *blank
     c                   eval      w_kprs = *blank
     c                   eval      w_tlfa = *blank
     c                   eval      w_tlfp = *blank
     c                   eval      w_tlfm = *blank
     c                   eval      w_mail = *blank
     c                   eval      w_orka = 0
     c                   eval      w_okun = 0
     c                   eval      w_okpr = 0
6.20 c**                 eval      w_proj = 0
6.20 c                   eval      w_proj = *blanks
5.61 c                   eval      w_kjor = 0
5.61 c                   eval      w_kjnr = 0
7.18 c                   if        u_718 = *on
7.18 c                   eval      w_proj = *blank
7.18 c                   eval      s_proj = *blank
7.18 c                   eval      p_upro = *blank
7.18 c                   eval      p_akti = *blank
7.18 c                   eval      foproj = *blank
7.18 c                   eval      foupro = *blank
7.18 c                   eval      foakti = *blank
7.18 c                   endif
      *
     c                   call      'FL501R'
     c                   parm                    w_firm
     c                   parm                    w_kund
     c                   parm                    w_dato
     c                   parm                    w_kpro
     c                   parm                    w_navn
     c                   parm                    w_adr1
     c                   parm                    w_adr2
     c                   parm                    w_sted
     c                   parm                    w_kprs
     c                   parm                    w_tlfa
     c                   parm                    w_tlfp
     c                   parm                    w_tlfm
     c                   parm                    w_mail
     c                   parm                    w_orka
     c                   parm                    w_okun
     c                   parm                    w_okpr
     c                   parm                    w_opda
     c                   parm                    w_proj
5.61 c                   parm                    w_kjor
5.61 c                   parm                    w_kjnr
7.18  *  Hente opp ev. aktivitet  på nytt
7.18  *  sstdebug_1
7.18 c                   if        u_718 = *on
7.18 c                   if        w_proj <> *blank
7.18 c                   eval      rp1pl1_pros = w_proj
7.18 c     rp1pl1_key    chain     rp1pl1
7.18 c                   if        not %found(rp1pl1)
7.18 c                   goto      noprosj2
7.18 c                   else
7.18 c                   if        rp1rup = 'J'
7.18 c                             or rp1rak = 'J'
7.18 c                   eval      p_upro = *blank
7.18 c                   eval      p_uprs = *blank
7.18 c                   eval      fkprl1_kpro = w_kpro
7.18 c     fkprl1_key    chain     fkprl1
7.18 c     fkprl1_key    chain     fkp2l1
7.18 c                   if        %found(fkprl1)
7.18 c                   eval      w_proj = flproj
7.18 c                   endif
7.18 c                   if        %found(fkp2l1)
7.18 c                   eval      p_upro = flupro
7.18 c                   endif
7.18 c                   if        p_upro <> *blank
7.18 c                   eval      rp2ul1_pros = w_proj
7.18 c                   eval      rp2ul1_upro = p_upro
7.18 c     rp2ul1_key    chain     rp2ul1
7.18 c                   endif
7.18 c                   if        (%found(rp2ul1)
7.18 c                              and rp2rak = 'J'
7.18 c                              and rp1rup = 'J')
7.18 c                             or (rp1rup <> 'J'
7.18 c                             and rp1rak = 'J')
7.18 c                   call      'RP605R'
7.18 c                   parm                    w_firm
7.18 c                   parm                    w_proj
7.18 c                   parm                    p_upro
7.18 c                   parm                    p_txt1
7.18 c                   parm                    p_txt2
7.18 c                   parm                    p_kund
7.18 c                   parm                    p_akti
7.18 c                   endif
7.18 c                   endif
7.18 c                   endif
7.18 c                   endif
7.18 c                   endif
7.18  *
7.18 c     noprosj2      tag
      *
     c                   if        w_navn <> *blank
     c                   eval      b1kpro = w_kpro
     c                   eval      b1navn = w_navn
     c                   eval      b1adr1 = w_adr1
     c                   eval      b1adr2 = w_adr2
     c                   eval      b1sted = w_sted
     c                   if        w_tlfa <> *blank
     c                   eval      b1tlfn = w_tlfa
     c                   endif
     c                   if        w_tlfm <> *blank
     c                   eval      b1mobn = w_tlfm
8.13 c                   eval      b1mobi = w_tlfm
     c                   endif
8.15 c                   if        %trim(b1dref) = *blanks
8.15 c                   eval      b1dref = w_kprs
8.15 c                   endif
6.2i  *
6.2i  * Hvis endring av kundeprosjekt, så spørsmål om priser skal endres
6.2i  *
6.2i c                   if        p_valg = 2 and
6.2i c                             s_kpro <> w_kpro
6.2i c                   eval      w_mld1 = 'Kundeprosjekt er endret'
6.2i c                   eval      w_mld2 = 'Skal priser rekalkuleres?'
6.2i c                   eval      w_svar = 'J'
6.2i c                   call      'AA007R'
6.2i c                   parm                    w_mld1
6.2i c                   parm                    w_mld2
6.2i c                   parm                    w_svar
6.2i c                   parm                    w_in12
6.2i c                   if        w_svar = 'J'
6.2i c                   eval      w_enor =  '1'
6.2i  * prosjekt må oppdateres på ordre før kall
6.2i  *
6.2i c     fohel1_key    chain     fohelur
6.2i c                   if        %found(fohelu)
6.2i c                   eval      fokpro = w_kpro
7.18 c                   if        u_718 = *on
7.18 c                   eval      foproj = w_proj
7.18 c                   eval      foupro = p_upro
7.18 c                   eval      foakti = p_akti
7.18 c                   endif
7.18 c
6.2i c                   time                    foedat
6.2i c                   time                    foetim
6.2i c                   eval      foeusr = l_user
6.2i c                   update    fohelur
6.2i c                   endif
6.2i c
6.2i c                   call      'FO730R'
6.2i c                   parm                    w_enor
6.2i c                   parm                    w_firm
6.2i c                   parm                    fohel1_numm
6.2i c                   parm                    fohel1_suff
6.2i c                   endif
6.2i c                   endif
6.2i  *
7.18  *  sstdebug_2
7.18 c                   if        u_718 = *on
7.18 c                   eval      b1pros = w_proj
7.18 c                   if        p_upro <> *blank
7.18 c                   if        b1pros <> *blank
7.18 c                   eval      b1pros = %trim(b1pros) + '/' +
7.18 c                                      %trim(p_upro)
7.18 c                   else
7.18 c                   eval      b1pros = p_upro
7.18 c                   endif
7.18 c                   endif
7.18 c                   if        p_akti <> *blank
7.18 c                   if        b1pros <> *blank
7.18 c                   eval      b1pros = %trim(b1pros) + '/' +
7.18 c                                      %trim(p_akti)
7.18 c                   else
7.18 c                   eval      b1pros = p_akti
7.18 c                   endif
7.18 c                   endif
7.18 c                   endif
7.18  *
     c                   eval      s_orka = w_orka
     c                   eval      s_proj = w_proj
5.61 c                   eval      s_kjor = w_kjor
5.61 c                   eval      s_kjnr = w_kjnr
     c                   eval      s_kpro = w_kpro
      *
6.2c c                   if        b1lkun <> 0
6.2c c                   eval      fkprl1_kund = b1lkun
6.2c c                   else
6.2c c                   eval      fkprl1_kund = b1kund
6.2c c                   endif
6.2c c                   eval      fkprl1_kpro = w_kpro
6.2c c     fkprl1_key    chain     fkprl1
6.2c c                   if        %found
6.2c c                   eval      s_faty = flfaty
6.33 c                   eval      s_betb = flbetb
6.33 c                   eval      s_mkod = flmkod
6.33 c                   eval      s_kgek = flekgb
6.33 c                   eval      s_neto = flneto
6.33 c                   eval      s_kgfa = flfagb
6.2c c                   endif
6.2c c
     c                   endif
      *
     c                   eval      w_in01 = 1
     c                   goto      b1tagb
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Ordrenummer er tastet inn direkte, dette kan være en endring
      * eller nyregistrering med bruk av direkte ordrenummer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     b1tag0        tag
7.36  *
7.36  * Sjekker om kunden har krav om at kundeprosjekt må fylles ut
7.36  *
7.36 c                   if        u_736 = *on
7.36 c                   eval      rku2l1_2kun = b1lkun
7.36 c     rku2l1_key    chain     rku2l1
7.36 c                   if        %found(rku2l1) and
7.36 c*                            rkprkr = 1 and
7.36 c                             b1kpro = 0
7.36 c                   eval      *in62  = *on
7.36 c                   goto      b1tagb
7.36 c                   endif
7.36 c                   endif
7.36  *
7.21  **
7.21  ** Hvis krav til prosjekt må det velges
7.21  **
7.21 c*                   if        u_721 = *on
7.21 c*                   if        rakkpr = 'J' and
7.21 c*                             w_kpro = 0   and
7.21 c*                             fokpro = 0
7.21 c*                   eval      *in69 = *on
7.21 c*                   goto      b1tagb
7.21 c*                   endif
7.21 c*                   endif
6.24  *
6.24  * tester om lev.adresse ikke utfylt og om fakt.adresse i så
6.24  * fall skal fylles inn
6.24 c                   if        b1navn = *blank and
6.24 c                             b1adr1 = *blank and
6.24 c                             b1adr2 = *blank and
6.24 c                             b1laok = 1
6.24 c                   eval      rkunl1_kund = b1lkun
6.24 c     rkunl1_key    chain     rkunl1r                            66
6.24 c                   eval      b1navn = rknavn
6.24 c                   eval      b1adr1 = rkgate
6.24 c                   eval      b1adr2 = rkadr2
6.24 c                   eval      b1sted = rksted
     c                   eval      s_sper = rkkres
7.03 c                   exsr      hent_avts
6.38 c                   goto      b1tagb
6.24 c                   endif
      *
     c                   if        b1onum <> s_numm
      *
      * Legger in ordrenummer og suffix i nøkklene
      *
     c                   eval      fohel1_numm = b1onum
     c                   eval      fohel1_suff = b1osuf
      *
      * Henter opp ordreopplysninger fra ORDRE-HODE-REGISTER
      *
     c                   exsr      hente_ordre
7.18  *  Lagt inn 02.10.2017
7.18 c                   if        u_718 = *on
7.18 c                   eval      b1pros = foproj
7.18 c                   if        foupro <> *blank
7.18 c                   if        b1pros <> *blank
7.18 c                   eval      b1pros = %trim(b1pros) + '/' +
7.18 c                                      %trim(foupro)
7.18 c                   else
7.18 c                   eval      b1pros = foupro
7.18 c                   endif
7.18 c                   endif
7.18 c                   if        foakti <> *blank
7.18 c                   if        b1pros <> *blank
7.18 c                   eval      b1pros = %trim(b1pros) + '/' +
7.18 c                                      %trim(foakti)
7.18 c                   else
7.18 c                   eval      b1pros = foakti
7.18 c                   endif
7.18 c                   endif
7.18 c                   endif
      *
      * Det varsles her dersom det i statusregister ikke er satt kode 1,
      * som tillater manuell ordrenummertildeling, og ordre som er oppgitt
      * ikke ble funnet. (Det er da kun tillatt å endre ordre, nye ordre
      * skal ikke ha ordrenummer, men tildeles fra nummerregister)
      *
     c                   if        faaman = 0
     c                   if        w_ordr = 0
     c                   eval      *in45 = *on
     c                   goto      b1tagb
     c                   endif
     c                   endif
      *
      * Sjekk,  Blir ordren allerede behandlet
      *
     c                   if        fokode <> 0
     c                   eval      fohel1_numm = 0
     c                   eval      fohel1_suff = 0
     c                   eval      *in37 = *on
     c                   goto      b1tagb
     c                   endif
      *
      * Sjekk,  er ordren under plukking
      *
5.54 c                   if        faakjk = 1
5.54  *
5.61 c                   eval      w_aarr = %subdt(fobdat:*years)
5.54 c                   eval      w_kod2 = '4'
5.54 c                   call      'FU702R'
5.61 c                   parm                    w_aarr
5.54 c                   parm                    fonumm
5.54 c                   parm                    fosuff
5.54 c                   parm                    w_kod2
5.54 c                   parm                    w_sva2
5.54  *
5.54 c                   if        w_sva2 = 'J'
     c                   exsr      xc2win
5.54  *
     c                   if        *inks = *off
     c                   exsr      merke_ordre
3.33 c                   eval      p_numm = fonumm
3.33 c                   eval      p_suff = fosuff
     c                   goto      avslutt
     c                   endif
5.54 c                   endif
     c                   endif
      *
      * Sjekk,  Ved ny ordre skal alltid suffix være null
      *
     c                   if        w_ordr = 0
     c                   if        b1osuf <> 0
     c                   eval      *in38 = *on
     c                   goto      b1tagb
     c                   endif
     c                   endif
3.39  *
3.39  * Sjekk,  Har bruker lov til å endre ?  (gjelder pakkseddel)
3.39  *
6.36 c                   if        vaoakk > 1
3.39 c                   if        fbko07 = 0
7.30 c                   if        w_tekst_pakk <> 'J'
3.39 c                   eval      w_mld1 = a_mld1(1)
3.39 c                   call      'AA005R'
3.39 c                   parm                    w_mld1
3.39 c                   goto      b1tagb
7.30 c                   else
7.30 c                   eval      *in79 = *on
7.30 c                   endif
3.39 c                   endif
3.39 c                   endif
      *
      * Dersom ordren finnes fra før, gjør klar opplysninger
      *
     c                   if        w_ordr = 1
      *
      * Merk av at ordren nå er til behandling som vedlikehold
      *
     c                   call      'FO709R'
     c                   parm                    fohel1_numm
     c                   parm                    fohel1_suff
      *
     c     fohel1_key    chain     fohelur                            64
     c                   eval      fokode = 1
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
      *
      * Legg tilside valgt ordrenummer, suffix og kundenummer
      *
     c                   eval      s_numm = b1onum
     c                   eval      s_suff = b1osuf
     c                   eval      s_kund = b1kund
      *
     c                   eval      *in23 = w_cord = 1
     c                   if        *in23 = *off
     c                   eval      *in25 = *on
     c                   endif
     c                   goto      b1tagb
     c                   endif
      *
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandler opplysninger for registrering/vedlikehold av ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Sjekk  Kundenummer / Hent kundeopplysninger
      *
     c                   exsr      hente_kunde
      *
      * Sjekk,  Er kunden sperret for ordre-registering
      *         (Kan ikke overstyres)
3.35  *         (Tilbud skal kunne registreres)
      *
6.25 c                   if        s_sper = 1
3.35 c                   if        vaoakk > 0
     c                   eval      *in41 = *on
     c                   goto      b1tagb
     c                   endif
3.35 c                   endif
7.19  *
7.19  * 1  MGR.  Ikke lov med annet enn ordretype 'T' på tilbudskunde
7.19  *
8.16 c*                  if          u_719 = *on
8.16 c*                  if          (b1lkun = 59998
8.16 c*                            or b1kund = 59998)
8.16 c                   if          u_til = *on
8.16 c                   if          (b1lkun = faakun
8.16 c                             or b1kund = faakun)
7.19 c                             and b1otyp <> 'T'
7.19 c                   eval      *in68 = *on
7.19 c                   goto      b1tagb
7.19 c                   endif
7.19 c                   endif
      *
6.25  * Sjekk,  Er kunden sperret for kredittsalg tillaters
6 25  *         ikke pakkseddel
6.25  *         (Tilbud skal kunne registreres)
6.25  *
6.25 c                   if        s_sper = 2
6.25 c                   if        vaoakk > 1
6.25 c                   eval      *in41 = *on
6.25 c                   goto      b1tagb
6.25 c                   endif
6.25 c                   endif
      *
      * Leveringskunde finnes ikke i kunde-register
      *
6.2k c                   if        w_feil_kund = 'A'  or
6.2k c                             w_feil_kund = 'D'
     c                   eval      *in39 = *on
     c                   goto      b1tagb
     c                   endif
      *
      * Fakturakunde finnes ikke i kunde-register
      *
     c                   if        w_feil_kund = 'B'
     c                   eval      *in40 = *on
     c                   goto      b1tagb
     c                   endif
6.2d  *
6.2d  * slår opp opp med ordrtype-tilleggsregister
6.2d  *
6.2d c                   eval      vot1l1_otyp = b1otyp
6.2d c     vot1l1_key    chain     vot1l1
6.2d c                   if        %found(vot1l1)
6.2d c                   eval      w_1int = va1int
6.2d c                   else
6.2d c                   eval      w_1int = 0
6.2d c                   endif
      *
6.22  * Kunde kan ikke ha intern ordre
6.22  *
6.22 c                   if        w_feil_kund = 'C'
6.22 c                   eval      *in55 = *on
6.22 c                   goto      b1tagb
6.22 c                   endif
      *
      * Dersom forrige kunde ikke er lik nyregistrert send bilde pånytt
      *
     c                   if        b1kund <> s_kund
7.04 c*                            and s_kund > 0
     c                   exsr      opdat_kunde
     c                   eval      *in27  = *on
     c                   eval      s_kund = b1kund
     c                   goto      b1tagb
     c                   endif
      *
     c     b1tage        tag
      *
      * Sjekk,  Skal rabattkategori hentes fra
      *         leverings-adresse-register ?
      *
     c                   if        s_orka <> 0
     c                   eval      s_rkat = s_orka
     c                   endif
      *
      * Sjekk,  Er kunden sperret for ordre-registering
      *         (Kan ikke overstyres)
3.35  *         (Tilbud skal kunne registreres)
      *
6.25 c                   if        s_sper = 1
3.35 c                   if        vaoakk > 0
     c                   eval      *in41 = *on
     c                   goto      b1tagb
     c                   endif
3.35 c                   endif
      *
6.3o c                   if        vaokre = '-'
6.3o c                   goto      x2tagb
6.3o c                   endif
      * Sjekk,  Har kunden overskredet kredittgrensen
      *         (Kan overstyre vha F18)
6.37  * Hvis ordretype tilsvarer "tilbud" kan det godkjennes selv om
6.37  * kreditgrensen er låst.
      *
     c                   if        s_gren <> 0 and
     c                             s_sald > s_gren
6.37 c                   if        rkkgrk = 'J' and
6.37 c                             vaoakk > 0
6.3i  * Dersom vidlikehold skal kun tx linjer vedlikeholdes
6.3i c                   if        p_valg = 2
6.3i c                   eval      *in65 = '1'
6.3i c                   eval      p_txtl = 'TX'
6.3i c                   else
6.3i c                   eval      *in65 = '0'
6.3i c                   eval      p_txtl = *blank
6.3i c                   endif
6.3i  *
     c                   exfmt     g3win
6.3i c  N65              goto      b1tagb
6.3i c   65              goto      x1tagb
     c                   endif
7.34  * Varsle om kreditgrense hvis det er tilbud og kreditgrensen er overtrått
7.34 c                   if        u_734 = *off
7.34 c                   if        vaoakk > 0
     c                   exfmt     g2win
     c                   if        *inks = *off
     c                   exsr      merke_ordre
3.33 c                   eval      p_numm = fonumm
3.33 c                   eval      p_suff = fosuff
     c                   goto      avslutt
     c                   endif
7.34 c                   endif
7.34 c                   else
7.34 c                   exfmt     g2win
7.34 c                   if        *inks = *off
7.34 c                   exsr      merke_ordre
7.34 c                   eval      p_numm = fonumm
7.34 c                   eval      p_suff = fosuff
7.34 c                   goto      avslutt
7.34 c                   endif
7.34 c                   endif
     c                   endif
5.55  *
6.3o c     x2tagb        tag
5.55  * Sjekk,  Har kunden overskredet beløpsgrense almenning
5.55  *
5.55 c                   if        s_gral <> 0 and
5.55 c                             s_kjal > s_gral
5.55 c                   exfmt     f2win
5.55 c                   if        *inkc = *on
5.55 c                   exsr      merke_ordre
5.55 c                   goto      avslutt
5.55 c                   endif
5.55 c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandler registrerte ordreverdier
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Tar vare på de sist brukte opplysninger for noen utvalgte felter
      * Disse verdiene blir lagt ut neste gang ny ordre skal registres
      *
     c                   if        w_ordr = 0
6.31 c**                 eval      w_bind = b1bind
     c                   eval      w_otyp = b1otyp
     c                   eval      w_odat = b1bdat
     c                   eval      w_vref = b1vref
     c                   endif
      *
      * Kaller opp subrutine for oppdatering av ORDRE-HODE-REGISTER
      *
     c                   exsr      opdat_ordre
      *
      * F5=Oppdatering av ORDRE-HODE-REGISTER er gjort
      *    Start registrering av ny ordre
      *
     c                   if        *inke = *on
     c                   goto      b1tag
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandler ORDRE-LINJE-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Kaller opp subprogram for registering av faste opplysninger
      *
     c                   if        fbvise <> 0
      *
     c                   if        fbvise = 1
     c                   call      'FO101R'
     c                   parm                    w_firm
     c                   parm                    fohel1_numm
     c                   parm                    fohel1_suff
     c                   endif
6.31  * Kaller ikke lenger progr., da feltene vedlikeholdes "lokalt"
6.31 c**                 if        fbvise = 2
6.31 c**                 call      'FO102R'
6.31 c**                 parm                    w_retu
6.31 c**                 parm                    w_firm
6.31 c**                 parm                    fohel1_numm
6.31 c**                 parm                    fohel1_suff
6.31 c**                 endif
      *
     c                   if        fbvise = 3
     c                   call      'FO103R'
     c                   parm                    w_retu
     c                   parm                    w_firm
     c                   parm                    fohel1_numm
     c                   parm                    fohel1_suff
     c                   endif
      *
6.28 c                   else
6.28  *
6.28 c*6.31              if        faakjk = 1
6.28 c*6.31              call      'FO102R'
6.28 c*6.31              parm                    w_retu
6.28 c*6.31              parm                    w_firm
6.28 c*6.31              parm                    fohel1_numm
6.28 c*6.31              parm                    fohel1_suff
6.28 c*6.31              endif
6.28  *
6.28 c                   endif
      *
      * F3=Trykket i subprogram
      *
     c                   if        w_retu = '9'
     c     fohel1_key    chain     fohelur                            64
     c                   eval      fokode = 0
     c                   eval      fokoda = *loval
     c                   eval      fokoti = *loval
     c                   eval      fokous = *blank
     c                   eval      fokows = *blank
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   goto      b1tag
     c                   endif
3.39  *
3.39  * Sjekk,  Kontroll av gyldig lager.
3.39  *         (Hentes fra brukerregister, men kan overstyres)
3.39  *
3.39 c     fohel1_key    chain     fohel1r                            64
3.39 c                   exsr      hente_lager
3.39 c*6.31              if        w_retk = '1'
3.39 c*6.31              call      'FO102R'
3.39 c*6.31              parm                    w_retu
3.39 c*6.31              parm                    w_firm
3.39 c*6.31              parm                    fohel1_numm
3.39 c*6.31              parm                    fohel1_suff
3.39 c*6.31              endif
      *
6.39  *   Oppdaterer lagerlinjer, hentet fra FO102R
6.39 c                   if        folage <> w_lage
6.39 c                   call      'FO732R'
6.39 c                   parm                    w_firm
6.39 c                   parm                    fohel1_numm
6.39 c                   parm                    fohel1_suff
6.39 c                   parm                    footyp
6.39 c                   parm                    w_lage
6.39 c                   parm                    w_valg
6.39 c                   parm                    w_pval
6.39 c                   endif
      *
7.07  *
7.07  * F15=Lagrer uten å viser ordrelinjer
7.07  *
7.07 c                   if        *inkp = *on
7.07  *                  lagrer uten å gå via ordrelinjer
7.07 c                   else
      *
      * Kaller opp subprogram for registrering/vedlikehold
      * av varelinjer/tekstlinjer i ORDRE-LINJE-REGISTER
      *
6.3i c     x1tagb        tag
      *
     c                   call      'FD100R'
     c                   parm                    w_linj
     c                   parm                    w_firm
     c                   parm                    fohel1_numm
     c                   parm                    fohel1_suff
6.3i c                   parm                    p_txtl
7.07 c                   endif
7.07  *
     c                   goto      b1tag
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     avslutt       tag
7.29  *
7.29  *   Oppdatere FODT fra FOHE dersom ordre har prosjekt
7.29  *
7.2a c**                 if        foproj <> *blank
7.29 c                   move      p_numm        p_numx
7.29 c                   move      p_suff        p_sufx
7.29 c                   call      'RP141R'
7.29 c                   parm                    p_numx
7.29 c                   parm                    p_sufx
7.2a c**                 endif
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Initiering av skjermbildet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     init_b1bld    begsr
      *
      * Legger inn faste felter som gjentaes for neste bilde
      *
6.31 c**                 eval      b1bind = w_bind
     c                   eval      b1otyp = w_otyp
     c                   eval      b1bdat = w_odat
     c                   eval      b1vref = w_vref
5.51  *
5.51  * Dersom det på bruker er satt opp en standard ordretype
5.51  * skal denne benyttes i stedet for sist brukte
5.51  *
5.51 c                   if        fbotyp <> *blank
5.51 c                   eval      b1otyp = fbotyp
5.51 c                   endif
      *
      * Nullstiller/Blanker felter som skal benyttes
      *
     c                   eval      b1ityp = *blank
     c                   eval      b1itxt = *blank
     c                   eval      b1lety = s_lety
     c                   eval      b1onum = 0
     c                   eval      b1osuf = 0
7.25 c                   eval      b1rnum = 0
7.25 c*                   eval      b1rsuf = 0
     c                   eval      b1lkun = 0
     c                   eval      b1kund = 0
     c                   eval      b1kpro = 0
     c                   eval      b1navn = *blank
     c                   eval      b1adr1 = *blank
     c                   eval      b1adr2 = *blank
     c                   eval      b1sted = *blank
     c                   eval      b1tlfn = *blank
     c                   eval      b1mobn = *blank
     c                   eval      b1dref = *blank
     c                   eval      b1rekv = *blank
     c                   eval      b1ddat = 0
     c                   eval      b1ldat = 0
     c                   eval      b1tdat = 0
6-26 c                   eval      b1pada = 0
5.21 c                   eval      b1mobi = *blank
5.21 c                   eval      b1inf1 = *blank
5.21 c                   eval      b1inf2 = *blank
6.24 c                   eval      b1laok = 0
6.3b c                   eval      b1selg = 0
7.12 c                   eval      b1eref = *blanks
      *
     c                   eval      b2navn = *blank
     c                   eval      b2gate = *blank
     c                   eval      b2adr2 = *blank
     c                   eval      b2sted = *blank
3.39 c                   eval      b2sat1 = *blank
3.39 c                   eval      b2sat2 = *blank
3.39 c                   eval      b2sat3 = *blank
6.31 c** 6.3b            eval      b1selg = w_selg
6.3b c                   eval      b1selg = fbselg
6.31 c                   eval      b1lage = s_lage
6.39 c                   eval      w_lage = s_lage
6.31 c                   eval      b1lmat = s_lmat
6.31 c                   eval      b1lmtx = *blanks
6.31 c                   eval      b1avde = s_avde
      *
7.25 c                   eval      *in61  = *off
7.25 c                   eval      w_rord  = *off
      *
     c                   eval      w_ordr = 0
     c                   eval      w_linj = *blank
     c                   eval      s_numm = 0
     c                   eval      s_kund = 0
     c                   eval      fohel1_numm = 0
     c                   eval      s_kpro = 0
     c                   eval      s_orka = 0
6.20 c**                 eval      s_proj = 0
6.20 c                   eval      s_proj = *blanks
5.61 c                   eval      s_kjor = 0
5.61 c                   eval      s_kjnr = 0
5.61 c                   eval      w_kjor = 0
5.61 c                   eval      w_kjnr = 0
3.38 c                   eval      s_neto = 0
     c                   eval      rkspav = 0
6.18 c                   eval      rkrekv = 0
Q.02  *
Q.02  * Skal vi initiere leveringsdato
Q.02  *
Q.02 c                   eval      votyl1_otyp = b1otyp
Q.02 c     votyl1_key    chain     votyl1r
Q.02  *
Q.02 c                   if        faak06 = 1 and
Q.02 c                             vaoakk =1
Q.02 c                   eval      b1ldat = w_odat
Q.02 c                   endif
Q.02  *
Q.02 c                   if        faak07 = 1 and
Q.02 c                             vaoakk =2
Q.02 c                   eval      b1ldat = w_odat
Q.02 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Sjekker input
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_input   begsr
      *
     c                   eval      b_feil = *off
      *
      * Sjekk,  Finnes ordre-info-kode i inforegister
      *
     c                   if        b1ityp <> *blank
     c                   eval      vinfl1_ityp = b1ityp
     c     vinfl1_key    chain     vinfl1r                            67
     c                   if        *in67  = *on
     c                   eval      *in47  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Sjekk,  Finnes ordretype i KODE-REGISTER
      *
     c                   eval      votyl1_otyp = b1otyp
     c     votyl1_key    chain     votyl1r                            62
     c   62              do
     c                   eval      *in31  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   enddo
3.32  *
3.32  * Sjekk,  Har ordretype systemkode = 0 ?
3.32  *
3.32 c                   if        vaosys <> 0
3.32 c                   eval      *in50  =  *on
3.32 c                   eval      b_feil =  *on
3.32 c                   leavesr
3.32 c                   endif
      *
      * Sjekk,  Er ordretype endret
      *
     c                   if        w_ordr = 1
     c                   if        b1otyp <> footyp
     c                   eval      *in43  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
6.2d  *
6.2d  * slår opp opp med ordrtype-tilleggsregister
6.2d  *
6.2d c                   eval      vot1l1_otyp = b1otyp
6.2d c     vot1l1_key    chain     vot1l1
6.2d c                   if        %found(vot1l1)
6.2d c                   eval      w_1int = va1int
6.2d c                   else
6.2d c                   eval      w_1int = 0
6.2d c                   endif
7.19  *
7.19  * 2  MGR.  Ikke lov med annet enn ordretype 'T' på tilbudskunde
7.19  *
8.16 c*                  if          u_719 = *on
8.16 c*                  if          (b1lkun = 59998
8.16 c*                            or b1kund = 59998)
8.16 c                   if          u_til = *on
8.16 c                   if          (b1lkun = faakun
8.16 c                             or b1kund = faakun)
7.19 c                             and b1otyp <> 'T'
7.19 c                   eval      *in68 = *on
7.19 c                   eval      b_feil = *on
7.19 c                   leavesr
7.19 c                   endif
7.19 c                   endif
      *
      * Sjekk,  Er leveringstype gyldig
      *
     c                   if        b1lety <> 0
     c                   eval      vltpl1_lety = b1lety
     c     vltpl1_key    chain     vltpl1                             67
     c                   if        *in67  = *on
     c                   eval      *in46  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
5.52  *
5.52  * Dersom dette er en endring og leveringstype
5.52  * er endret, skal dette også oppdateres på hver
5.52  * enkelt ordrelinje. (Sjekker også mot bestilling)
5.52  * Kaller opp program som gir valg på hvordan
5.52  * oppdateringen skal utføres.
5.52  * (Bildet skal bare sendes ved endring, ikke ved ny ordre)
5.52  *
5.52 c                   if        w_ordr = 1
5.52 c                   if        b1lety <> folety
6.2f c                   if        vaoakk >=2
6 2f c                   eval      *in59  = *on
6 2f c                   eval      b_feil = *on
6.2f c                   leavesr
6.2f c                   endif
6.2e  *
6.2e c                   exsr      levtyp_msg
6.2e c                   if        w_in12 = 1  or
     c                             w_svar = 'N'
6.2e c                   goto      b1tagb
6.2e c*                  else
6.2e c*                  if        b_lety = *on
6.2e c*                  exsr      korrig_lag
6.2e c*                  endif
6.2e c                   endif
6.2e  *
5.52 c                   call      'FO796R'
5.52 c                   parm                    w_valg
5.52 c                   parm                    w_in03
5.52  *
5.52  * Dersom F3, gå tilbake
5.52  *
5.52 c                   if        w_in03 = '1'
5.52 c                   goto      b1tagb
5.52 c                   endif
5.52  *
5.52 c                   eval      w_flty = folety
      *
5.52  * Oppdater ordrehode med leveringstype
      *
      *
     c     fohel1_key    chain     fohelur                            64
     c                   eval      folety =  b1lety
6.10 C                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
5.52  *
5.52  * Oppdater på linjenivå
5.52  *
5.52 c                   call      'FO738R'
5.52 c                   parm                    fofirm
5.52 c                   parm                    fonumm
5.52 c                   parm                    fosuff
5.52 c                   parm                    w_flty
5.52 c                   parm                    w_valg
6.2e  *
6.2e  * Korrigerer i ordre på lagerregister
6.2e  *
6.3g c*                  if        b_lety = *on
6.2e c                   exsr      korrig_lag
6.3g c*                  endif
5.52  *
5.52  * Ny prisberegning
5.52  *
7.20  *    Valg av om rekalkulering skal utføres    sven
7.20  *
7.20 c                   if        u_720 = *on
7.20 c                   eval      w_mld1 = 'Leveringstype er endret'
7.20 c                   eval      w_mld2 = 'Skal priser rekalkuleres?'
7.20 c                   eval      w_svar = 'J'
7.20 c                   call      'AA007R'
7.20 c                   parm                    w_mld1
7.20 c                   parm                    w_mld2
7.20 c                   parm                    w_svar
7.20 c                   parm                    w_in12
7.20 c                   if        w_svar = 'J'
7.20 c                   eval      w_enor =  '1'
7.20 c                   call      'FO730R'
7.20 c                   parm                    w_enor
7.20 c                   parm                    fofirm
7.20 c                   parm                    fonumm
7.20 c                   parm                    fosuff
7.20 c                   endif
7.20 c                   else
     c                   eval      w_enor =  '1'
     c                   call      'FO730R'
     c                   parm                    w_enor
     c                   parm                    fofirm
     c                   parm                    fonumm
     c                   parm                    fosuff
7.20 c                   endif
     c                   endif
     c                   endif
      *
      * Nobb frakt behandling
      *
7.09 c                   exsr      bhnd_nobf
      *
      * Sjekk,  Er kundenummer endret
      *
     c                   if        w_ordr = 1
     c                   if        b1kund <> fokund
     c                   eval      *in44  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Sjekk,  Er kundenummer sperret for registrering ?
      *
     c                   if        rksprk = 'J'
     c                   eval      *in48  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
3.13  *
3.13  * Sjekk,  Har denne kunde krav til rekvisisjon ?
3.13  *
3.13 c                   if        vaoakk <> 0
3.13 c                   if        rkrekv = 1
3.13 c                   if        b1rekv = *blank
3.13 c                   eval      *in49  = *on
3.13 c                   eval      b_feil = *on
3.13 c                   leavesr
3.13 c                   endif
3.13 c                   endif
3.13 c                   endif
      *
6.2e  * Obl. tester sjekkes når  w_in01 = 1 eller w_ordr =1
6.23 c                   if        w_in01 = 1 or
6.3e c                             w_ordr = 1
6.2A  *
6.2A  * Sjekk,  Er det krav til Leveringsadresse
6.2A  *
6.2A c*-> Lagt om        if        u_navn = *on  and
6.2A c*-> til pop                  b1navn = *blank
6.2A c*-> up             eval      *in58  = *on
6.2A c*->                eval      b_feil = *on
6.2A c*->                leavesr
6.2A c*->                endif
6.2A  *
6.2A  * Sjekk,  Er det krav til Leveringsadresse
6.2A  *
6.2A c                   if        u_navn = *on  and
6.2A c                             b1navn = *blank
6.2A c                   eval      w_mld1 = a_mld1(3)
6.2A c                   call      'AA005R'
6.2A c                   parm                    w_mld1
6.2A c                   eval      b_feil = *on
6.2h c                   eval      *in29  = *on
6.2A c                   leavesr
6.2A c                   endif
6.23  *
6.23  * Sjekk,  Er det krav til Vår referanse
6.23  *
6.23 c                   if        u_vref = *on  and
6.23 c                             b1vref = *blank
6.23 c                   eval      *in56  = *on
6.23 c                   eval      b_feil = *on
6.23 c                   leavesr
6.23 c                   endif
6.23  *
6.23  * Sjekk,  Er det krav til Deres referanse
6.23  *
6.23 c                   if        u_dref = *on  and
6.23 c                             b1dref = *blank
6.23 c                   eval      *in57  = *on
6.23 c                   eval      b_feil = *on
6.23 c                   leavesr
6.23 c                   endif
6.30  *
6.30  * Sjekk,  Er det krav til oppfølgingsdato - kun ved tilbud
6.30  *
6.3h c                   if        vaoakk = 0  and
6.3h c                             u_ddat = *on  and
6.3h c                             b1ddat = 0
6.3h c                   eval      *in58  = *on
6.3h c                   eval      b_feil = *on
6.3h c                   leavesr
6.3h c                   endif
6.23  *
6.2e c                   endif
      *
      * Sjekk,  Er ordredato en gyldig dato
      *
     c                   if        b1bdat = 0
     c                   eval      *in32  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
      *
     c     *dmy          test(d)                 b1bdat                 32
     c                   if        *in32  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
      *
      * Sjekk,  Er oppfølgingsdato en gyldig dato
      *
     c                   if        b1ddat <> 0
     c     *dmy          test(d)                 b1ddat                 51
     c                   if        *in51  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Sjekk,  Er oppfølgingsdato større enn/lik ordre-dato
      *
     c                   if        b1ddat <> 0
     c     *dmy          move      b1bdat        w_bdat
     c     *dmy          move      b1ddat        w_ddat
     c                   if        w_ddat < w_bdat
     c                   eval      *in52  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Sjekk,  Er leveringsdato en gyldig dato
      *
6.21  * Parameterstyre om det alltid er sjekk av leveringsdato
6.21  *
6.21 c                   if        (faalds = 0  and
6.21 c                             b1ldat <> 0) or
6.29 c                             (faalds = 1 and
6.29 c                             vaoakk > 0)
     c     *dmy          test(d)                 b1ldat                 33
     c                   if        *in33  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Sjekk,  Er leveringsdato større enn/lik ordre-dato
      *
     c                   if        b1ldat <> 0
     c     *dmy          move      b1bdat        w_bdat
     c     *dmy          move      b1ldat        w_ldat
     c                   if        w_ldat < w_bdat
     c                   eval      *in34  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
7.26  *
7.26  * Sjekk,  Dersom ordre, skal leveringsdato fylles ut
7.26  *
7.26 c                   if        vaoakk > 0 and u_726 = *on
7.26 c                   if        b1ldat = 0
7.26 c                   eval      *in53  = *on
7.26 c                   eval      b_feil = *on
7.26 c                   leavesr
7.26 c                   endif
7.26 c                   endif
      *
      *
      * Sjekk,  Er utgårdato en gyldig dato
      *
     c                   if        b1tdat <> 0
     c     *dmy          test(d)                 b1tdat                 35
     c                   if        *in35  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Sjekk,  Er utgårdato større enn ordredato
      *
     c                   if        b1tdat <> 0
     c     *dmy          move      b1bdat        w_bdat
     c     *dmy          move      b1tdat        w_tdat
     c                   if        w_tdat < w_bdat
     c                   eval      *in36  = *on
     c                   eval      b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
6.26  *
6.26  * Sjekk,  Er akseptdato en gyldig dato
6.26  *
6.26 c*                  if        b1adat <> 0
6.26 c*    *dmy          test(d)                 b1adat                 37
6.26 c*                  if        *in37  = *on
6.26 c*                  eval      b_feil = *on
6.26 c*                  leavesr
6.26 c*                  endif
6.26 c*                  endif
6.26  *
6.26  * Sjekk,  Er akseptdato større enn ordredato
6.26  *
6.26 c*                  if        b1adat <> 0
6.26 c*    *dmy          move      b1bdat        w_bdat
6.26 c*    *dmy          move      b1adat        w_adat
6.26 c*                  if        w_adat < w_bdat
6.26 c*                  eval      *in38  = *on
6.26 c*                  eval      b_feil = *on
6.26 c*                  leavesr
6.26 c*                  endif
6.26 c*                  endif
6.31  *
6.31  * Sjekk om gyldig selger, eller om at den finnes ?
6.31  *
6.31 c                   if        b1selg = 0
6.31 c                   eval      *in26  = *on
6.31 c                   eval      b_feil = *on
6.31 c                   leavesr
6.31 c                   else
6.31 c                   exsr      sbselg
6.31 c                   if        w_retk <> *blank
6.31 c                   eval      *in26  = *on
6.31 c                   eval      b_feil = *on
6.31 c                   leavesr
6.31 c                   endif
6.31 c                   endif
6.31  *
6.31  * Sjekk om gyldig lager, eller om at den finnes ?
6.31  *
6.31 c                   exsr      sblagr
6.31 c                   if        w_retk = '1'
6.31 c                   eval      *in42  = *on
6.31 c                   eval      b_feil = *on
6.31 c                   leavesr
6.31 c                   endif
6.31  *
6.39  *
6.39  * Dersom lager er endret, skal varelinjer oppdateres.
6.39  * Kall opp program hvor det kan velges hva som skal
6.39  * oppdateres, alle linjer eller bare de med likt fra lager.
6.39  * (Bilde skal bare sendes ved endring, ikke ved ny ordre)
6.39  *
6.39 c                   if        w_lag1 <> b1lage
6.39 c                   if        folage <> 0
6.39 c                   if        b1lage <> folage
6.39 c                   eval      w_lag1 = b1lage
6.39 c                   call      'FO794R'
6.39 c                   parm                    w_valg
6.39 c                   parm                    w_pval
6.39 c                   parm                    w_in03
6.39  * Dersom F3, gå tilbake
6.39  *
6.39 c                   if        w_in03 = '1'
6.39 c                   leavesr
6.39 c                   endif
6.39 c                   endif
6.39 c                   endif
6.39 c                   endif
6.31  * Sjekk om gyldig leveringsmåte, eller om den finnes
6.31  *
6.31 c                   if        b1lmat <> *zero
6.31 c                   if        b1lmat <> folmat
6.31 c                   exsr      sbform
6.31 c                   if        w_retk <> *blank
6.31 c                   eval      *in30 = *on
6.31 c                   eval      b_feil = *on
6.31 c                   leavesr
6.31 c                   endif
6.31 c                   endif
6.31 c                   endif
6.31  *
6.31 c                   if        faakjk = 1
6.31 c                   exsr      sbform
6.31 c                   if        w_retk <> *blank
6.31 c                   eval      *in30 = *on
6.31 c                   eval      b_feil = *on
6.31 c                   leavesr
6.31 c                   endif
6.31 c                   endif
7.22  *
7.22 c                   if        u_722 = *on
7.22 c                   eval      b_dirl = *off
7.22 c                   eval      ra17l1_qkod = b1lmat
7.22 c     ra17l1_key    chain     ra17l1
7.22 c                   if        %found(ra17l1) and
7.22 c                             raqdir = 1
7.22 c                   eval      b_dirl = *on
7.22 c                   endif
7.22 c                   endif
6.31  *
6.31  * Sjekk om gyldig avdeling, eller om den finnes
6.31  *
8.01  * Krav om at avdeling fylles ut?
8.01  *
8.01 c                   if        u_801 = *on
8.01 c                   if        b1avde = 0
8.01 c                   eval      b_feil = *on
8.01 c                   eval      *in24 = *on
8.01 c                   leavesr
8.01 c                   endif
8.01 c                   endif
8.01  *
6.31 c                   if        b1avde <> *zero
6.31 c                   exsr      sbavde
6.31 c                   if        w_retk <> *blank
6.3f c                   eval      b_feil = *on
6.31 c                   eval      *in24 = *on
6.31 c                   leavesr
6.31 c                   endif
6.31 c                   endif
7.10  *   Sjekk sammenheng mellom Lager og Avdeling
7.10 c                   if        u_710 = *on
7.10 c                   if        b1avde = 10
7.10 c                             or b1avde = 20
7.10 c                             or b1lage = 1
7.10 c                             or b1lage = 2
7.10 c                   if        b1avde <> b1lage * 10
7.10 c                   eval      *in60 = *on
7.10 c                   eval      b_feil = *on
7.10 c                   leavesr
7.10 c                   endif
7.10 c                   endif
7.10 c                   endif
      *
6.3n c                   if        p_valg = 1  and
6.3n c                             *inkb = '0' and
6.3n c                             *in21 = '0'
6.3n  * Test om avvik på dato <> på 1 år (foreløpig 1 år tilbake)
6.3n  * w1_dato = dagens dato
6.3n c                   time                    w1_dato
6.3n c                   extrct    w1_dato:*y    w_aar3
6.3n c                   extrct    w1_dato:*m    w_aarm
6.3n c                   extrct    w1_dato:*d    w_aard
6.3n  * trekk fra 1 på år, gi melding
6.3n c     w_aar3        sub       1             w_aar3
6.3n  *
6.3n c                   move      w_aar3        w_aar2            2 0
6.3n c                   movel     w_aarm        w_aarmd           4 0
6.3n c                   move      w_aard        w_aarmd           4 0
6.3n c                   movel     w_aar2        w_tesdt           6 0
6.3n c                   move      w_aarmd       w_tesdt
6.3n  *
6.3n c     *dmy          move      b1bdat        w1_bdat
6.3n  *
6.3n c     *ymd          move      w1_bdat       x1bdat
6.3n  *
6.3n c                   if        x1bdat <= w_tesdt
6.3n c                   eval      *in22  = *on
6.3n c                   eval      *in21  = *on
6.3n c                   eval      b_feil = *on
6.3n c                   leavesr
6.3n c                   endif
6.3n  *(Foreløpig tatt bort) legg til 1 på år, gi melding
6.3n c*                  time                    w1_dato
6.3n c*                  extrct    w1_dato:*y    w_aar3
6.3n c*                  extrct    w1_dato:*m    w_aarm
6.3n c*                  extrct    w1_dato:*d    w_aard
6.3n c*    w_aar3        add       1             w_aar3
6.3n  *
6.3n c*                  move      w_aar3        w_aar2            2 0
6.3n c*                  movel     w_aarm        w_aarmd           4 0
6.3n c*                  move      w_aard        w_aarmd           4 0
6.3n c*                  movel     w_aar2        w_tesdt           6 0
6.3n c*                  move      w_aarmd       w_tesdt
6.3n  *
6.3n c*    *dmy          move      b1bdat        w1_bdat
6.3n  *
6.3n c*    *ymd          move      w1_bdat       x1bdat
6.3n  *
6.3n c*                  if        x1bdat >= w_tesdt
6.3n c*                  eval      *in22  = *on
6.3n c*                  eval      b_feil = *on
6.3n c*                  leavesr
6.3n c*                  endif
6.3n  *
6.3n c                   else
6.3n c                   eval      *in22 = *off
6.3n c                   endif
6.3n  *
      *
      *
     c                   endsr
      *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Sjekk/Hent tekst for selger                       RS709R
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     sbselg        begsr
6.31  *
6.31 c                   call      'RS709R'
6.31 c                   parm                    w_retk
6.31 c                   parm                    b1selg
6.31 c                   parm                    w_itxt
6.31  *
6.31 c                   endsr
6.31  *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Sjekk/Hent tekst for leveringsmåte                RS717R
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     sbform        begsr
6.31  *
6.31 c                   eval      b1lmtx = *blank
6.31 c                   call      'RS717R'
6.31 c                   parm                    w_retk
6.31 c                   parm                    b1lmat
6.31 c                   parm                    w_qtxt
6.31  *
6.31 c                   if        w_retk = *blank
6.31 c                   movel     w_qtxt        b1lmtx
6.31 c                   endif
6.31  *
6.31 c                   endsr
6.31  *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Sjekk/Hent tekst for lager
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     sblagr        begsr
6.31  *
6.31 c                   call      'FÅ720R'
6.31 c                   parm                    w_firm
6.31 c                   parm                    b1lage
6.31 c                   parm                    w_jtxt
6.31 c                   parm                    w_jadr
6.31 c                   parm                    w_jpnr
6.31 c                   parm                    w_jste
6.31 c                   parm                    w_javd
6.31 c                   parm                    w_retk
6.31  *
6.31 c                   endsr
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Sjekk/Hent tekst for avdeling                     RS707R
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     sbavde        begsr
6.31  *
6.31 c                   call      'RS707R'
6.31 c                   parm                    w_retk
6.31 c                   parm                    b1avde
6.31 c                   parm                    w_gtxt
6.31  *
6.31 c*                  if        w_retk = *blank
6.31 c*                  movel     w_gtxt        c2avtx
6.31 c*                  endif
6.31  *
6.31 c                   endsr
6.31  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for spørring
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     spØrring      begsr
      *
      * Spørring på ordre-info-type
      *
     c                   if        w_afld = 'B1ITYP'
     c                   call      'VA540R'
     c                   parm                    w_firm
     c                   parm                    b1ityp
     c                   parm                    w_itxt
     c                   eval      b1itxt = w_itxt
     c                   leavesr
     c                   endif
      *
      * Spørring på ordretyper
      *
     c                   if        w_afld = 'B1OTYP'
     c                   call      'VA550R'
     c                   parm                    w_firm
     c                   parm                    b1otyp
     c                   leavesr
     c                   endif
      *
      * Spørring på Leveringstype
      *
     c                   if        w_afld = 'B1LETY'
     c                   call      'VY500R'
     c                   parm                    w_firm
     c                   parm                    b1lety
     c                   parm                    w_ltxt
     c                   eval      *in25 = *on
     c                   leavesr
     c                   endif
6.11  *
6.11  * Spørring på kundens refreanse
6.11  *
6.11 c                   if        w_afld = 'B1DREF'
6.11 c                   if        b1lkun <> *zero
6.11 c                   eval      w_lkun = b1lkun
6.11 c                   else
6.11 c                   eval      w_lkun = b1kund
6.11 c                   endif
7.08 c                   call      'RK504R'
6.11 c                   parm                    w_firm
6.11 c                   parm                    w_lkun
6.11 c                   parm                    w_kref
6.32 c                   parm                    w_kpnr
6.16 c                   parm                    w_emal
7.08 c                   parm                    w_mobi
6.11 c                   eval      b1dref = w_kref
7.08 c                   if        (%trim(w_mobi) <> *blank)
7.08 c                   eval      b1mobi = w_mobi
7.08 c                   endif
6.11 c                   leavesr
6.11 c                   endif
6.31  *
6.31  * Call program for selger
6.31  *
6.31 c                   if        w_afld = 'B1SELG'
6.31 c                   call      'RA509R'
6.31 c                   parm                    w_firm
6.31 c                   parm                    w_ikod
6.31 c                   parm                    w_itxt
6.31 c                   if        w_ikod <> 0
6.34 c                   eval      *in26 = '0'
6.31 c                   eval      b1selg = w_ikod
6.31 c                   endif
6.31 c                   leavesr
6.31 c                   endif
6.31  *
6.31  * Call program for lager
6.31  *
6.31 c                   if        w_afld = 'B1LAGE'
6.31 c                   call      'RA510R'
6.31 c                   parm                    w_firm
6.31 c                   parm                    w_jkod
6.31 c                   parm                    w_jtxt
6.31 c                   if        w_jkod <> 0
6.31 c                   eval      b1lage = w_jkod
6.31 c                   endif
6.31 c                   leavesr
6.31 c                   endif
6.31  *
6.31  * Call program for leveringsmåte
6.31  *
6.31 c                   if        w_afld = 'B1LMAT'
6.31 c                   call      'RA517R'
6.31 c                   parm                    w_firm
6.31 c                   parm                    w_qkod
6.31 c                   parm                    w_qtxt
6.31 c                   if        w_qkod <> 0
6.31 c                   eval      b1lmat = w_qkod
6.31 c                   eval      b1lmtx = w_qtxt
6.31 c                   endif
6.31 c                   leavesr
6.31 c                   endif
6.31  *
6.31  * Call program for avdeling
6.31  *
6.31 c                   if        w_afld = 'B1AVDE'
6.31 c                   call      'RA507R'
6.31 c                   parm                    w_firm
6.31 c                   parm                    w_avde
6.31 c                   parm                    w_gtxt
6.31 c                   if        w_avde <> 0
6.31 c                   eval      b1avde = w_avde
6.31 c                   endif
6.31 c                   leavesr
6.31 c                   endif
7.25  *
7.25  * Call program for referanse ordre
7.25  *
7.25 c*                   if        w_afld = 'B1RNUM'
7.25 c*                   call      'FO550R'  ???
7.25 c*                   parm                    b1rnum
7.25 c*                   parm                    b1rsuf
7.25 c*                   leavesr
7.25 c*                   endif
      *
      * Spørring i kunde-register
      * Aktiviseres dersom ikke tilslag på noen av de andre hvis
7.11  * u_711=*off
7.11  * Hvis u_711=*on, så vil den bare slå til hviw w_alfd = 'B1LKUN'
      *
      * Kaller opp subprogram for spørring mot KUNDE-REGISTER
      *
7.11 c                   if        w_afld = 'B1LKUN' or u_711=*off
     c                   eval      w_kund = b1lkun
      *
     c                   call      'RK500R'
     c                   parm                    w_firm
     c                   parm                    b1lkun
     c                   parm                    w_navn
      *
      * Blanker kundopplysninger dersom nytt kundenummer funnet
      *
     c                   if        b1lkun <> w_kund
     c                   eval      b1kund  = 0
     c                   eval      b1kpro  = 0
     c                   eval      b1navn  = *blank
     c                   eval      b1adr1  = *blank
     c                   eval      b1adr2  = *blank
     c                   eval      b1sted  = *blank
     c                   eval      b1tlfn  = *blank
     c                   eval      b1mobn  = *blank
     c                   eval      s_kund  = 0
7.xx c                   eval      *in25 = *on
8.13 c                   eval      rkunl1_kund = b1lkun
8.13 c     rkunl1_key    chain     rkunl1r
8.13 c                   if        %found
8.13 c                   eval      b1mobn = %trim(rkmobn)
8.13 c                   eval      b1mobi = %trim(rkmobn)
8.13 c                   endif
     c                   endif
7.11 c                   endif
      *
7.03 c                   exsr      hent_avts
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Merker ordren med at den ikke lenger er til behandling
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     merke_ordre   begsr
      *
      * Dersom ordre ligger til utskrift, eller til
      * utplukk, skal ikke kode settes til null.
      *
     c     fohel1_key    chain     fohelur                            64
     c                   if        *in64 = *off
     c                   if        fokode <> 2
     c                   if        fokode <> 3
     c                   eval      fokode = 0
     c                   eval      fokoda = *loval
     c                   eval      fokoti = *loval
     c                   eval      fokous = *blank
     c                   eval      fokows = *blank
     c                   endif
     c                   endif
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hent inn kundeopplysninger
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hente_kunde   begsr
      *
      * Nullstiller/Blanker variable
      *
     c                   eval      s_sper = 0
     c                   eval      s_gren = 0
     c                   eval      s_sald = 0
     c                   eval      w_feil_kund = *blank
      *
      * Sjekk,  Finnes vareadressekundenummer i KUNDE-REGISTER
      *
     c                   if        b1lkun <> 0
     c                   eval      rkunl1_kund = b1lkun
     c     rkunl1_key    chain     rkunl1r                            66
     c                   if        *in66 = *on
     c                   eval      w_feil_kund = 'A'
     c                   goto      hntk99
     c                   endif
6.2k  *
6.2k  * Sjekk om kunde er kontant kunde i kasse
6.2k c                   if        p_valg <> 2  and
6.2k c                             b1lkun = baakun
6.2k c                   eval      w_feil_kund = 'D'
6.2k c                   goto      hntk99
6.2k c                   endif
      *
      * Sjekk,  Finnes fakturakundenummer i KUNDE-REGISTER
      *
     c                   if        b1kund = 0
7.02 c                             or b1lkun = b1kund
     c                   if        rkfaku <> 0
     c                   eval      b1kund = rkfaku
     c                   else
     c                   eval      b1kund = b1lkun
     c                   eval      b1lkun = 0
     c                   endif
     c                   endif
      *
     c                   endif
      *
      * Flytt kundenummer til fakt.kunde fra varekunde.
      *
     c                   if        b1kund = 0
     c                   if        b1navn <> *blank
     c                   eval      b1kund = s_akun
     c                   endif
     c                   endif
      *
      * Henter inn kundeopplysninger
      *
     c                   eval      rkunl1_kund = b1kund
     c     rkunl1_key    chain     rkunl1r                            66
     c                   if        *in66 = *on
     c                   if        b1kund = 0
     c                   eval      w_feil_kund = 'A'
     c                   goto      hntk99
     c                   endif
     c                   endif
7.21  ** Hent informasjon rundt kundekategori
7.21 c*                   if        u_721 = *on
7.21 c*                   eval      ra11l1_kkod = rkkatg
7.21 c*     ra11l1_key    chain     ra11l1
7.21 c*                   if        not %found
7.21 c*                   eval      rakkpr = *blanks
7.21 c*                   endif
7.21 c*                   endif
6.2k  *
6.2k  * Sjekk om kunde er kontant kunde i kasse
6.2k c                   if        p_valg <> 2  and
6.2k c                             b1kund = baakun
6.2k c                   eval      w_feil_kund = 'D'
6.2k c                   goto      hntk99
6.2k c                   endif
      *
     c                   if        *in66 = *on
     c                   if        b1kund <> 0
     c                   eval      w_feil_kund = 'B'
     c                   goto      hntk99
     c                   endif
     c                   endif
6.27  * Henter inn informasjon om memosaldo
6.27 c     rkunl1_key    chain     rkmel1r                            66
6.22  *
6.33 c                   eval      w_betb = rkbetb
6.33 c                   eval      w_mkod = rkmkod
6.33 c                   eval      w_kgek = rkekgb
6.33 c                   eval      w_neto = rkneto
6.33 c                   eval      w_fagb = rkfagb
6.33  * Slå opp på kundeprosjekt for å finne om prosjekt er
6.33  * overstyrer verdi på kunde
6.33 c                   if        b1kpro > 0
6.33 c                   eval      fkprl1_kund = b1kund
6.33 c                   eval      fkprl1_kpro = b1kpro
6.33 c     fkprl1_key    chain     fkprl1
6.33 c                   if        %found(fkprl1)
6.33 c                   eval      w_betb = flbetb
6.33 c                   eval      w_mkod = flmkod
6.33 c                   eval      w_kgek = flekgb
6.33 c                   eval      w_neto = flneto
6.33 c                   eval      w_fagb = flfagb
6.33 c                   endif
6.33 c                   endif
6.33  *
6.22  * Sjekk om kunde skal ha intern ordre, event. feilmelding
6.33 c                   if        w_mkod = 0 and
6.22 c                             rkspfa <> 0 and
6.2d c                             w_1int = 1
6.22 c                   eval      w_feil_kund = 'C'
6.22 c                   goto      hntk99
6.22 c                   endif
6.22  *
6.22 c                   if        rkspfa = 0 and
6.33 c                             w_mkod <> 0 and
6.2d c                             w_1int = 1
6.22 c                   eval      w_feil_kund = 'C'
6.22 c                   goto      hntk99
6.22 c                   endif
6.22  *
6.22 c                   if        rkspfa = 0 and
6.33 c                             w_mkod = 0 and
6.2d c                             w_1int = 1
6.22 c                   eval      w_feil_kund = 'C'
6.22 c                   goto      hntk99
6.22 c                   endif
6.22  *
6.33 c                   if        w_mkod <> 0 and
6.2b c                             rkspfa <> 0 and
6.2b c                             p_valg <> 2
6.2d c                   if        w_1int = 0
6.22 c                   eval      b1otyp = faaot6
6.2d c                   endif
6.22 c                   endif
7.28 c                   if        u_728 = *on and b1kund = w_fokund
7.28 c                   eval      b1otyp = w_footyp
7.28 c                   endif
6.22  *
5.55  *
5.55  * Benytt beløpsgrense almenning fra kunde dersom utfylt
5.55  *
5.55 c                   if        rkgral <> 0
5.55 c                   eval      s_gral = rkgral
5.55  *
5.55 c                   else
5.55  *
5.55  * Ellers hent beløpsgrense almenning
5.55  *
5.55 c                   call      'FO106R'
5.55 c                   parm                    b1kund
5.55 c                   parm                    w_bgrn
5.55  *
5.55 c                   eval      s_gral = w_bgrn
5.55 c                   endif
      *
     c                   eval      s_sper = rkkres
     c                   eval      s_gren = rkgrns * 1000
     c                   eval      s_sald = rksald
6.3l c                   if        (s_sald + (rkmems * w_mvat)) < 999999999,99
5.53 c                   eval      s_sald = s_sald + (rkmems * w_mvat)
6.3l c                   else
6.3l c                   eval      s_sald = 999999999,99
6.3l c                   endif
7.16  *   Utvide kreditgrense   (Mestergruppen løsning 2017_01) sst
7.16 c                   if        u_716 = *on
7.16 c                   if        w_904 = 'J'
7.16 c                   if        s_sald < rkgrns * 1000
7.16 c                   eval      s_gren = rkgrns * 1000 *
7.16 c                                      (1+w_utvgrns/100)
7.16 c                   else
7.16 c                   eval      s_gren = rkgrns * 1000
7.16 c                   endif
7.16 c                   endif
7.16 c                   endif
5.55 c                   eval      s_kjal = rkkjal +  rkmema
     c                   eval      w_feil_kund = *blank
     c                   eval      s_kuna = rkalfa
     c                   eval      b2navn = rknavn
     c                   eval      b2gate = rkgate
     c                   eval      b2adr2 = rkadr2
     c                   eval      b2sted = rksted
5.62 c                   eval      b1tlfn = rktlfn
5.62 c                   eval      b1mobn = rkmobn
5.22  *
5.22  * Henter inn leveringstype fra kunderegister
5.22  * dersom leveringstype er oppgitt
5.22  *
5.22 c                   if        rklety <> 0
5.22 c                   eval      b1lety =  rklety
5.22 c                   endif
7.03 c                   exsr      hent_avts
7.03  *
7.03  * Henter inn tekst fra avtalespesifikasjon
7.03  *
7.03 c*                  call      'FÅ709R'
7.03 c*                  parm                    w_firm
7.03 c*                  parm                    b1kund
7.03 c*                  parm                    w_sat1
7.03 c*                  parm                    w_sat2
7.03 c*                  parm                    w_sat3
7.03  *
7.03 c*                  if        w_sat1 <> *blank
7.03 c*                  eval      b2sat1 =  w_sat1
7.03 c*                  eval      b2sat2 =  w_sat2
7.03 c*                  eval      b2sat3 =  w_sat3
7.03 c*                  endif
      *
      * Legger tilside kundeopplysninger dersom ny ordre
      *
     c                   if        w_ordr = 0
      *
      * Legger inn kundeopplysninger fra fakturakundenummer
      *
6.33 c                   eval      s_betb = w_betb
     c                   eval      s_dist = rkdist
     c                   eval      s_lmat = rkform
     c                   eval      s_lbet = rklbet
     c                   eval      s_valk = rkvalk
     c                   eval      s_rkat = rkrabk
     c                   eval      s_sped = rksped
     c                   eval      s_kjor = rkkjØr
5.61 c                   eval      s_kjnr = rkkjnr
5.61 c                   if        w_kjor <> 0
5.61 c                   eval      s_kjor = w_kjor
5.61 c                   eval      s_kjnr = w_kjnr
5.61 c                   endif
6.33 c                   eval      s_mkod = w_mkod
6.2c c                   if        s_kpro = 0
     c                   eval      s_faty = rkfaty
6.2c c                   endif
      *
     c                   eval      s_kobk = rkordb
6.33 c                   eval      s_kgfa = w_fagb
     c                   eval      s_kgfr = rkfrgb
6.33 c                   eval      s_kgek = w_kgek
      *
KOB  c                   eval      w_rabp = rkorab
      *
7.13 c                   if        u_713 = *off
     c                   if        rkslgr <> 0
     c                   eval      w_selg = rkslgr
     c                   endif
7.13 c                   endif
3.38  *
3.38  * Tar vare på kode for nettofaktura
3.38  *
6.33 c                   eval      s_neto = w_neto
      *
     c                   if        b1lkun <> 0
     c                   eval      rkunl1_kund = b1lkun
     c     rkunl1_key    chain     rkunl1r                            66
      *
      * Legger inn kundeopplysninger fra vareadressekundenummer
      *
8.03 c                   if        %trim(b1navn) = *blanks
     c                   eval      b1navn = rknavn
     c                   eval      b1adr1 = rkgate
     c                   eval      b1adr2 = rkadr2
     c                   eval      b1sted = rksted
8.03 c                   endif
     c                   eval      b1tlfn = rktlfn
     c                   eval      b1mobn = rkmobn
      *
     c                   eval      s_dist = rkdist
     c                   eval      s_lmat = rkform
     c                   eval      s_lbet = rklbet
     c                   eval      s_rkat = rkrabk
     c                   eval      s_sped = rksped
     c                   eval      s_kjor = rkkjØr
5.61 c                   eval      s_kjnr = rkkjnr
5.61 c                   if        w_kjor <> 0
5.61 c                   eval      s_kjor = w_kjor
5.61 c                   eval      s_kjnr = w_kjnr
5.61 c                   endif
      *
KOB  c                   eval      w_rabp = rkorab
      *
7.13 c                   if        u_713 = *off
     c                   if        rkslgr <> 0
     c                   eval      w_selg = rkslgr
     c                   endif
7.13 c                   endif
      *
     c                   endif
     c                   endif
8.03  *
8.03  * Hvis utfylt både varekunde/fakturakunde og prosjekt. Hentes adresse fra
8.03  * varekunden. (Ref NXS-10959)
8.03  *
8.03 c                   if        b1lkun <> 0 and
8.03 c                             b1kund <> 0 and
8.03 c                             b1lkun <> b1kund and
8.03 c                             b1kpro <> 0
8.03 c                   eval      rkunlr_kund = b1lkun
8.03 c     rkunlr_key    chain     rkunlr
8.03 c                   if        %found
8.03 c                   eval      b2navn = xknavn
8.03 c                   eval      b2gate = xkgate
8.03 c                   eval      b2adr2 = xkadr2
8.03 c                   eval      b2sted = xksted
8.03 c                   eval      b1tlfn = xktlfn
8.03 c                   eval      b1mobn = xkmobn
8.03 c                   endif
8.03 c                   endif
8.11  *
8.11  * Hvis varekunde/fakturakunde og prosjekt = 0. Da sjekkes om
8.11  * FONAVN = 1, noe som setter u_navn=*on
8.11  *
8.11 c                   if        b1lkun <> 0 and
8.11 c                             b1kund <> 0 and
8.11 c                             b1lkun <> b1kund and
8.11 c                             b1kpro = 0
8.11 c                   if        u_navn = *on
8.11 c                   eval      rkunlr_kund = b1lkun
8.11 c     rkunlr_key    chain     rkunlr
8.11 c                   if        %found
8.11 c                   eval      b2navn = xknavn
8.11 c                   eval      b2gate = xkgate
8.11 c                   eval      b2adr2 = xkadr2
8.11 c                   eval      b2sted = xksted
8.11 c                   eval      b1tlfn = xktlfn
8.11 c                   eval      b1mobn = xkmobn
8.11 c                   endif
8.11 c                   else
8.11 c                   eval      b2navn = *blanks
8.11 c                   eval      b2gate = *blanks
8.11 c                   eval      b2adr2 = *blanks
8.11 c                   eval      b2sted = *blanks
8.11 c                   endif
8.11 c                   endif
      *
     c     hntk99        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hent kundeprosjekt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hente_kproj   begsr
      *
     c                   if        b1lkun <> 0
     c                   eval      w_kund = b1lkun
     c                   else
     c                   eval      w_kund = b1kund
     c                   endif
      *
     c                   move      udate         w_dato
     c                   eval      w_kpro = 0
     c                   eval      w_navn = *blank
     c                   eval      w_adr1 = *blank
     c                   eval      w_adr2 = *blank
     c                   eval      w_sted = *blank
     c                   eval      w_kprs = *blank
     c                   eval      w_tlfa = *blank
     c                   eval      w_tlfp = *blank
     c                   eval      w_tlfm = *blank
     c                   eval      w_mail = *blank
     c                   eval      w_orka = 0
     c                   eval      w_okun = 0
     c                   eval      w_okpr = 0
6.20 c**                 eval      w_proj = 0
6.20 c                   eval      w_proj = *zeros
5.61 c                   eval      w_kjor = 0
5.61 c                   eval      w_kjnr = 0
      *
     c                   call      'FL501R'
     c                   parm                    w_firm
     c                   parm                    w_kund
     c                   parm                    w_dato
     c                   parm                    w_kpro
     c                   parm                    w_navn
     c                   parm                    w_adr1
     c                   parm                    w_adr2
     c                   parm                    w_sted
     c                   parm                    w_kprs
     c                   parm                    w_tlfa
     c                   parm                    w_tlfp
     c                   parm                    w_tlfm
     c                   parm                    w_mail
     c                   parm                    w_orka
     c                   parm                    w_okun
     c                   parm                    w_okpr
     c                   parm                    w_opda
     c                   parm                    w_proj
5.61 c                   parm                    w_kjor
5.61 c                   parm                    w_kjnr
      *
7.18 c                   if        u_718 = *on
7.18 c                   if        w_navn <> *blank
7.18 c                   eval      b1kpro = w_kpro
7.18 c                   eval      b1navn = w_navn
7.18 c                   eval      b1adr1 = w_adr1
7.18 c                   eval      b1adr2 = w_adr2
7.18 c                   eval      b1sted = w_sted
7.18 c                   if        w_tlfa <> *blank
7.18 c                   eval      b1tlfn = w_tlfa
7.18 c                   endif
7.18 c                   if        w_tlfm <> *blank
7.18 c                   eval      b1mobn = w_tlfm
8.13 c                   eval      b1mobi = w_tlfm
7.18 c                   endif
7.18  ****
7.18  ****
7.18  *  sstdebug_3
7.18  *  Hente opp ev. underprosejkt og akktivitet
7.18 c                   if        w_proj <> *blank
7.18 c                   eval      rp1pl1_pros = w_proj
7.18 c     rp1pl1_key    chain     rp1pl1
7.18 c                   if        not %found(rp1pl1)
7.18 c                   goto      noprosj
7.18 c                   else
7.18 c                   eval      p_upro = *blank
7.18 c                   eval      p_uprs = *blank
7.18 c                   if        rp1rup = 'J'
7.18 c                             or rp1rak = 'J'
7.18 c                   eval      fkprl1_kpro = w_kpro
7.18 c     fkprl1_key    chain     fkprl1
7.18 c     fkprl1_key    chain     fkp2l1
7.18 c                   if        %found(fkprl1)
7.18 c                   eval      w_proj = flproj
7.18 c                   endif
7.18 c                   if        %found(fkp2l1)
7.18 c                   eval      p_upro = flupro
7.18 c                   endif
7.18 c                   if        p_upro = *blank
7.18 c                             and rp1rup = 'J'
7.2b c                   eval      w_kunf = 0
7.2b c                   eval      p_fdat = 0
7.2b c                   eval      p_tdat = 0
7.2b c                   eval      p_selg = 0
7.2b c                   eval      p_kpro = 0
7.2b c                   eval      w_knav = *blanks
7.18 c                   call      'RP601R'
7.18 c                   parm                    w_firm
7.18 c                   parm                    w_proj
7.18 c                   parm                    p_upro
7.2b c                   parm                    p_uprs
7.18 c                   parm                    p_txt1
7.18 c                   parm                    p_txt2
7.18 c                   parm                    p_kund
7.18 c                   parm                    p_uprs
7.2b c                   parm                    p_fdat
7.2b c                   parm                    p_tdat
7.2b c                   parm                    w_knav
7.2b c                   parm                    p_selg
7.2b c                   parm                    w_kunf
7.2b c                   parm                    p_kpro
7.18 c                   endif
7.18 c                   endif
7.18 c                   if        p_upro <> *blank
7.18 c                   eval      rp2ul1_pros = w_proj
7.18 c                   eval      rp2ul1_upro = p_upro
7.18 c     rp2ul1_key    chain     rp2ul1
7.18 c                   endif
7.18 c                   if        (%found(rp2ul1)
7.18 c                              and rp2rak = 'J'
7.18 c                              and rp1rup = 'J')
7.18 c                             or (rp1rup <> 'J'
7.18 c                             and rp1rak = 'J')
7.18 c                   call      'RP605R'
7.18 c                   parm                    w_firm
7.18 c                   parm                    w_proj
7.18 c                   parm                    p_upro
7.18 c                   parm                    p_txt1
7.18 c                   parm                    p_txt2
7.18 c                   parm                    p_kund
7.18 c                   parm                    p_akti
7.18 c                   endif
7.18 c                   endif
7.18 c                   endif
7.18 c                   else
7.18 c                   eval      w_proj = *blank
7.18 c                   eval      s_proj = *blank
7.18 c                   eval      p_upro = *blank
7.18 c                   eval      p_akti = *blank
7.18 c                   eval      foproj = *blank
7.18 c                   eval      foupro = *blank
7.18 c                   eval      foakti = *blank
7.18 c                   endif
7.18  *
7.18 c     noprosj       tag
7.18 c                   eval      b1pros = w_proj
7.18 c                   if        p_upro <> *blank
7.18 c                   if        b1pros <> *blank
7.18 c                   eval      b1pros = %trim(b1pros) + '/' +
7.18 c                                      %trim(p_upro)
7.18 c                   else
7.18 c                   eval      b1pros = p_upro
7.18 c                   endif
7.18 c                   endif
7.18 c                   if        p_akti <> *blank
7.18 c                   if        b1pros <> *blank
7.18 c                   eval      b1pros = %trim(b1pros) + '/' +
7.18 c                                      %trim(p_akti)
7.18 c                   else
7.18 c                   eval      b1pros = p_akti
7.18 c                   endif
7.18 c                   endif
7.18  *
7.18 c                   eval      s_orka = w_orka
7.18 c                   eval      s_proj = w_proj
7.18 c                   eval      s_kpro = w_kpro
7.18 c                   eval      s_kjor = w_kjor
7.18 c                   eval      s_kjnr = w_kjnr
7.18 c                   if        b1lkun <> 0
7.18 c                   eval      fkprl1_kund = b1lkun
7.18 c                   else
7.18 c                   eval      fkprl1_kund = b1kund
7.18 c                   endif
7.18 c                   eval      fkprl1_kpro = w_kpro
7.18 c     fkprl1_key    chain     fkprl1
7.18 c                   if        %found
7.18 c                   eval      s_faty = flfaty
7.18 c                   eval      s_betb = flbetb
7.18 c                   eval      s_mkod = flmkod
7.18 c                   eval      s_kgek = flekgb
7.18 c                   eval      s_neto = flneto
7.18 c                   eval      s_kgfa = flfagb
7.18 c** e1              endif
7.18 c
7.18 c                   endif
     c                   else
     c                   if        w_navn <> *blank
     c                   eval      b1kpro = w_kpro
     c                   eval      b1navn = w_navn
     c                   eval      b1adr1 = w_adr1
     c                   eval      b1adr2 = w_adr2
     c                   eval      b1sted = w_sted
     c                   if        w_tlfa <> *blank
     c                   eval      b1tlfn = w_tlfa
     c                   endif
     c                   if        w_tlfm <> *blank
     c                   eval      b1mobn = w_tlfm
     c                   endif
8.12 c                   eval      b1mobi = w_tlfm
8.15 c                   if        %trim(b1dref) = *blanks
8.12 c                   eval      b1dref = w_kprs
8.15 c                   endif
     c                   eval      s_orka = w_orka
     c                   eval      s_proj = w_proj
     c                   eval      s_kpro = w_kpro
5.61 c                   eval      s_kjor = w_kjor
5.61 c                   eval      s_kjnr = w_kjnr
6.2c c                   if        b1lkun <> 0
6.2c c                   eval      fkprl1_kund = b1lkun
6.2c c                   else
6.2c c                   eval      fkprl1_kund = b1kund
6.2c c                   endif
6.2c c                   eval      fkprl1_kpro = w_kpro
6.2c c     fkprl1_key    chain     fkprl1
6.2c c                   if        %found
6.2c c                   eval      s_faty = flfaty
6.33 c                   eval      s_betb = flbetb
6.33 c                   eval      s_mkod = flmkod
6.33 c                   eval      s_kgek = flekgb
6.33 c                   eval      s_neto = flneto
6.33 c                   eval      s_kgfa = flfagb
6.2c c                   endif
6.2c c
     c                   endif
     c                   endif
      *
     c                   eval      w_in01 = 1
      *
     c                   endsr
      *
7.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.25  * Hent opplysninger fra FAKTURA-HODE-REGISTER
7.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.25  *
7.25 c     hente_faktura begsr
7.25  *
7.25  *
7.25  * Legger inn år og fakturanummer i nøkklene
7.25  *
7.25  * sjekker først om referanse finnes som ordre, finner ordren sitt
7.25  * fakturanummer
7.25 c                   eval      w_sobinr = 0
7.25 c/exec sql
7.25 c+ SELECT SOBINR INTO :w_sobinr FROM SOHEPF WHERE SOFIRM = :w_firm
7.25 c+ and SONUMM = :b1rnum
7.25 c+ ORDER BY SOAARR DESC FETCH FIRST 1 ROWS ONLY
7.25 c/end-exec
7.25 c                   if        w_sobinr <> 0
7.25 c                   eval      b1rnum = w_sobinr
7.25 c                   endif
7.25  * finner siste år dette fakturanummer ble brukt
7.25 c/exec sql
7.25 c+ SELECT MAX(SOAARR) INTO :w_aarr FROM SOHEPF
7.25 c+   WHERE SOFIRM = :w_firm and SOBINR = :b1rnum
7.25 c/end-exec
7.25 c*                   eval      sohel1_binr = b1rnum
7.25 c*                   else
7.25 c*/exec sql
7.25 c*+ SELECT MAX(SOAARR) INTO :w_aarr FROM SOHEPF
7.25 c*+   WHERE SOFIRM = :w_firm and SOBINR = :w_sobinr
7.25 c*/end-exec
7.25 c*                   eval      sohel1_binr = w_sobinr
7.25 c*                   endif
7.25 c                   eval      sohel1_binr = b1rnum
7.25 c                   eval      sohel1_aarr = w_aarr
7.25 c                   eval      sohel1_numm = *zero
7.25 c                   eval      sohel1_suff = *zero
7.25  *
7.25 c     sohel1_key    setll     sohel1
7.25 c                   read      sohel1                                 64
7.25 c                   if        *in64 = *on
7.25 c                   leavesr
7.25 c                   endif
7.25 c                   if        soaarr <> sohel1_aarr or
7.25 c                             sobinr <> sohel1_binr
7.25 c                   eval      *in64 = *on
7.25 c                   leavesr
7.25 c                   endif
7.25  *
7.25  *
7.25 c                   eval      *in61  = *on
7.25 c                   eval      b1onum = sonumm
7.25 c                   eval      b1osuf = sosuff
7.25 c*                   eval      b1ityp = soityp
7.25  * beholder valgt ordretype
7.25 c                   if        b1otyp = *blank
7.25 c                   eval      b1otyp = sootyp
7.25 c                   endif
7.25 c                   eval      b1lety = solety
7.25 c**                 eval      b1bind = fobind
7.25 c                   eval      b1bdat = 0
7.25 c                   eval      b1lkun = solkun
7.25 c                   eval      b1kund = sokund
7.25 c                   eval      b1kpro = sokpro
7.25 c                   eval      b1navn = sonavn
7.25 c                   eval      b1adr1 = soadr1
7.25 c                   eval      b1adr2 = soadr2
7.25 c                   eval      b1sted = sosted
7.25 c                   eval      b1vref = sovref
7.25 c                   eval      b1dref = sodref
7.25 c                   eval      b1rekv = sorekv
7.25 c                   eval      b1ddat = 0
7.25 c                   eval      b1ldat = 0
7.25 c                   eval      b1tdat = 0
7.25 c                   eval      b1pada = 0
7.25 c                   eval      b1mobi = somobi
7.25 c                   eval      b1inf1 = soinf1
7.25 c                   eval      b1inf2 = soinf2
7.25 c                   eval      b1selg = soselg
7.25 c                   eval      b1avde = soavde
7.25 c                   eval      b1lage = solage
7.25 c                   eval      w_lage = solage
7.25 c                   eval      b1lmat = solmat
7.25 c                   eval      b1lmtx = solmtx
      *
     c                   eval      fokund = b1kund
     c                   eval      folkun = b1lkun
     c                   eval      footyp = b1otyp
     c                   eval      fokpro = b1kpro
7.25  *
7.25 c                   eval      rkunl1_kund = fokund
7.25  *
7.25  * Hent inn ordretype
7.25  *
7.25 c                   eval      votyl1_otyp = footyp
7.25 c     votyl1_key    chain     votyl1r                            62
7.25  *
7.25  * Hent ordre-info-kode-tekst
7.25  *
7.25 c                   eval      vinfl1_ityp = b1ityp
7.25 c     vinfl1_key    chain     vinfl1r                            67
7.25 c                   if        *in67  = *off
7.25 c                   eval      b1itxt = vaitxt
7.25 c                   endif
7.25  *
7.25  * slår opp opp med ordrtype-tilleggsregister
7.25  *
7.25 c                   eval      vot1l1_otyp = b1otyp
7.25 c     vot1l1_key    chain     vot1l1
7.25 c                   if        %found(vot1l1)
7.25 c                   eval      w_1int = va1int
7.25 c                   else
7.25 c                   eval      w_1int = 0
7.25 c                   endif
7.25  *
7.25  * Hent ekstern ordrereferanse, hvis den finnes.
7.25  *
7.25 c                   if        u_712 = *on
7.25 c/exec sql
7.25 c+                  select eonref
7.25 c+                  into :b1eref
7.25 c+                  from  edhepf
7.25 c+                  where eonumm = :fonumm
7.25 c/end-exec
7.25 c*                   eval      edhel2_numm = fonumm
7.25 c*     edhel2_key    chain     edhel2
7.25 c*                   if        %found
7.25 c*                   eval      b1eref = eonref
7.25 c*                   endif
7.25 c                   endif
7.25  *
7.25  * Hent kundeopplysninger
7.25  *
7.25 c                   exsr      hente_kunde
7.25  *
7.25  * Henter eventuelt telefonnr og mobilnr fra kundeprosjektet
7.25  *
7.25 c                   if        fokpro <> 0
7.25  *
7.25 c                   if        folkun <> 0
7.25 c                   eval      fkprl1_kund = folkun
7.25 c                   else
7.25 c                   eval      fkprl1_kund = fokund
7.25 c                   endif
7.25  *
7.25 c                   eval      fkprl1_kpro = fokpro
7.25 c     fkprl1_key    chain     fkprl1
7.25 c                   if        %found
7.25 c                   if        fltlfa <> *blank
7.25 c                   eval      b1tlfn = fltlfa
7.25 c                   endif
7.25 c                   if        fltlfm <> *blank
7.25 c                   eval      b1mobn = fltlfm
7.25 c                   endif
7.25 c                   eval      fofaty = flfaty
7.25 c                   eval      s_faty = flfaty
7.25 c                   eval      s_betb = flbetb
7.25 c                   eval      s_mkod = flmkod
7.25 c                   eval      s_kgek = flekgb
7.25 c                   eval      s_neto = flneto
7.25 c                   eval      s_kgfa = flfagb
7.25 c                   endif
7.25  *
7.25 c                   endif
7.25  *
7.25 c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hent opplysninger fra ORDRE-HODE-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hente_ordre   begsr
      *
     c     fohel1_key    chain     fohel1r                            64
     c                   if        *in64 = *on
     c                   eval      w_ordr = 0
     c                   eval      fokode = 0
     c                   leavesr
     c                   endif
      *
7.25 c                   eval      *in61  = *on
     c                   eval      w_ordr = 1
     c                   eval      b1onum = fonumm
     c                   eval      b1osuf = fosuff
     c                   eval      b1ityp = foityp
7.25  * hvis kopi av referanse skal b1otyp beholdes
7.25 c                   if        b1rnum <> 0 and fohel1_numm = b1rnum
7.25 c                   eval      footyp = b1otyp
7.25 c                   else
     c                   eval      b1otyp = footyp
7.25 c                   endif
     c                   eval      b1lety = folety
6.31 c**                 eval      b1bind = fobind
     c                   eval      b1bdat = 0
     c                   eval      b1lkun = folkun
     c                   eval      b1kund = fokund
     c                   eval      b1kpro = fokpro
     c                   eval      b1navn = fonavn
     c                   eval      b1adr1 = foadr1
     c                   eval      b1adr2 = foadr2
     c                   eval      b1sted = fosted
     c                   eval      b1vref = fovref
     c                   eval      b1dref = fodref
     c                   eval      b1rekv = forekv
     c                   eval      b1ddat = 0
     c                   eval      b1ldat = 0
     c                   eval      b1tdat = 0
6.26 c                   eval      b1pada = 0
5.21 c                   eval      b1mobi = fomobi
5.21 c                   eval      b1inf1 = foinf1
5.21 c                   eval      b1inf2 = foinf2
6.31 c                   eval      b1selg = foselg
6.31 c                   eval      b1avde = foavde
6.31 c                   eval      b1lage = folage
6.39 c                   eval      w_lage = folage
6.31 c                   eval      b1lmat = folmat
6.31 c                   eval      b1lmtx = folmtx
7.35 c                   eval      b1nref = fonref
      *
     c                   if        fobdat <> *loval
     c     *dmy          move      fobdat        b1bdat
     c                   endif
      *
     c                   if        foddat <> *loval
     c     *dmy          move      foddat        b1ddat
     c                   endif
      *
     c                   if        foldat <> *loval
     c     *dmy          move      foldat        b1ldat
     c                   endif
      *
     c                   if        fotdat <> *loval
     c     *dmy          move      fotdat        b1tdat
     c                   endif
      *
6.26 c                   if        fopada <> *loval
6.26 c     *dmy          move      fopada        b1pada
6.26 c                   endif
      *
     c                   eval      rkunl1_kund = fokund
3.39  *
3.39  * Hent inn ordretype
3.39  *
3.39 c                   eval      votyl1_otyp = footyp
3.39 c     votyl1_key    chain     votyl1r                            62
      *
      * Hent ordre-info-kode-tekst
      *
     c                   eval      vinfl1_ityp = b1ityp
     c     vinfl1_key    chain     vinfl1r                            67
     c                   if        *in67  = *off
     c                   eval      b1itxt = vaitxt
     c                   endif
6.2d  *
6.2d  * slår opp opp med ordrtype-tilleggsregister
6.2d  *
6.2d c                   eval      vot1l1_otyp = b1otyp
6.2d c     vot1l1_key    chain     vot1l1
6.2d c                   if        %found(vot1l1)
6.2d c                   eval      w_1int = va1int
6.2d c                   else
6.2d c                   eval      w_1int = 0
6.2d c                   endif
7.12  *
7.12  * Hent ekstern ordrereferanse, hvis den finnes.
7.12  *
7.12 c                   if        u_712 = *on
7.12 c/exec sql
7.12 c+                  select eonref
7.12 c+                  into :b1eref
7.12 c+                  from  edhepf
7.12 c+                  where eonumm = :fonumm
7.12 c/end-exec
7.12 c*                   eval      edhel2_numm = fonumm
7.12 c*     edhel2_key    chain     edhel2
7.12 c*                   if        %found
7.12 c*                   eval      b1eref = eonref
7.12 c*                   endif
7.12 c                   endif
      *
      * Hent kundeopplysninger
      *
     c                   exsr      hente_kunde
      *
      * Henter eventuelt telefonnr og mobilnr fra kundeprosjektet
      *
     c                   if        fokpro <> 0
      *
     c                   if        folkun <> 0
     c                   eval      fkprl1_kund = folkun
     c                   else
     c                   eval      fkprl1_kund = fokund
     c                   endif
      *
     c                   eval      fkprl1_kpro = fokpro
     c     fkprl1_key    chain     fkprl1
     c                   if        %found
     c                   if        fltlfa <> *blank
     c                   eval      b1tlfn = fltlfa
     c                   endif
     c                   if        fltlfm <> *blank
     c                   eval      b1mobn = fltlfm
     c                   endif
     c                   endif
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppdatering av ORDRE-HODE-REGISTER  Ny ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hente_nyord   begsr
     c                   eval      w_aord = 0
      *
      * Henter inn neste ledige ordrenummer fra STATUS-KODER
      *
     c     ordstr        tag
     c                   if        fohel1_numm = 0
     c                   eval      w_aord = 1
      *
     c                   eval      w_kode = '0'
     c                   eval      w_numm = 0
     c                   exsr      hente_numm
     c                   eval      fohel1_numm = w_numm
     c                   endif
      *
     c     fohel1_key    chain     fohel1r                            64
      *
     c  n64              do
     c                   eval      fohel1_numm = 0
     c                   goto      ordstr
     c                   enddo
      *
      * Legger inn opplysninger i ORDRE-HODE-REGISTER felter
      *
6.31 c**                 eval      folage = s_lage
     c                   eval      fobinr = 0
     c                   eval      fokref = 0
     c                   eval      fofkda = *loval
     c                   eval      foffda = *loval
     c                   eval      fobetb = s_betb
6.31 c**                 eval      foselg = w_selg
     c                   eval      fodist = s_dist
6.31 c**                 eval      folmat = s_lmat
     c                   eval      folbet = s_lbet
     c                   eval      fovalk = s_valk
     c                   eval      forkat = s_rkat
     c                   eval      fosped = s_sped
     c                   eval      fokjor = s_kjor
5.61 c                   eval      fokjnr = s_kjnr
     c                   eval      fomkod = s_mkod
6.31 c**                 eval      foavde = s_avde
     c                   eval      fofaty = s_faty
     c                   eval      fokont = 0
     c                   eval      fospes = 0
6.20 c**                 eval      foproj = 0
6.20 c                   eval      foproj = *blanks
6.20 c                   eval      foupro = *blanks
     c                   eval      foakti = *blank
     c                   eval      fokobk = s_kobk
     c                   eval      fokgfa = s_kgfa
     c                   eval      fokgek = s_kgek
     c                   eval      fokgfr = s_kgfr
     c                   eval      foksob = w_ksob
     c                   eval      foktxt = w_ktxt
     c                   eval      fokfak = w_kfak
     c                   eval      fokspr = w_kspr
     c                   eval      folmtx = w_lmtx
     c                   eval      folbtx = w_lbtx
     c                   eval      forabp = w_rabp
     c                   eval      fopasl = 0
     c                   eval      fopask = *blank
     c                   eval      fokoli = 0
     c                   eval      foedih = 0
     c                   eval      fokkun = 0
     c                   eval      fobkun = 0
     c                   eval      fokpro = s_kpro
6.17 c                   eval      fopsuf = 0
      *
      * Legg inn kode som sier at
      * ordre er opptatt
      *
     c                   eval      fokode = 1
      *
     c                   eval      fowsid = l_wsid
     c                   eval      fouser = l_user
      *
     c                   eval      fotots = 0
     c                   eval      fototr = 0
     c                   eval      fototk = 0
      *
      * Legger inn dagens dato
      *
     c                   time                    fodate
     c                   time                    fotime
      *
6.2c c                   eval      s_faty = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Henter/Oppdatering av NUMMER-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hente_numm    begsr
      *
     c                   eval      w_fell = faaork
     c                   eval      w_type = b1otyp
     c                   eval      w_fast = l_wsid
5.32  *
5.32  * Hente inn eventuell overstyrt
5.32  * ordretype for nummerserie
5.32  *
5.32 c                   call      'VA752R'
5.32 c                   parm                    w_firm
5.32 c                   parm                    b1otyp
5.32 c                   parm                    w_onum
5.32  *
5.32 c                   if        w_onum <> *blank
5.32 c                   eval      w_type = w_onum
5.32 c                   endif
      *
      * Kaller opp subprogram for henting av nummer fra NUMMER-REGISTER
      *
     c                   call      'AS100R'
     c                   parm                    w_kode
     c                   parm                    w_firm
     c                   parm                    w_fell
     c                   parm                    w_type
     c                   parm                    w_fast
     c                   parm                    w_numm
6.19  *
6.19  * sjekker at ordrenr ikke har tidligere relasjoner liggende
6.19  *
6.19 c                   call      'FO415R '
6.19 c                   parm                    w_firm
6.19 c                   parm                    w_numm
      *
     c                   endsr
3.39  *
3.39  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.39  * Sjekk/Hent tekst for lager
3.39  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
3.39  *
3.39 c     hente_lager   begsr
3.39  *
3.39 c                   call      'FÅ720R'
3.39 c                   parm                    w_firm
3.39 c                   parm                    folage
3.39 c                   parm                    w_jtxt
3.39 c                   parm                    w_jadr
3.39 c                   parm                    w_jpnr
3.39 c                   parm                    w_jste
3.39 c                   parm                    w_javd
3.39 c                   parm                    w_retk
3.39  *
3.39 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Rutine for å trekke ut ordreverdien fra den kunden som er aktiv
      * Oppdaterer den nye kunden med ny samme ordreverdi
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     opdat_kunde   begsr
      *
      * Oppdater kunden som VAR AKTIV
      *
      * Beregner justeringsbeløp
      *
     c                   eval      w_sald = fototr - fotots
5.60 c                   eval      w_sal2 = fobrra * -1
      *
      * Kaller opp subrutine for oppdatering av memosaldo
      *
8.10 c                   move      w_firm        p_fir
8.10 c                   move      s_kund        p_kun
8.10 c*                  call      'FA922R'
8.10 c                   call      'FO763R'
8.10 c                   parm                    p_fir
8.10 c*                  parm                    footyp
8.10 c                   parm                    p_kun
8.10 c*                  parm                    w_sald
8.10 c*                  parm                    w_sal2
      *
      * Oppdater kunden SOM NÅ ER AKTIV
      *
      * Beregner justeringsbeløp
      *
     c                   eval      w_sald = fotots - fototr
5.60 c                   eval      w_sal2 = fobrra
      *
      * Kaller opp subrutine for oppdatering av memosaldo
      *
8.10 c                   move      b1kund        p_kun
8.10 c*                  call      'FA922R'
8.10 c                   call      'FO763R'
8.10 c                   parm                    p_fir
8.10 c*                  parm                    footyp
8.10 c                   parm                    p_kun
8.10 c*                  parm                    w_sald
8.10 c*                  parm                    w_sal2
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppdatering av ORDRE-HODE-REGISTER  (60-On, Ny ordre)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     opdat_ordre   begsr
      *
8.07 c                   eval      w_lmat = 0
      *
     c                   eval      fohel1_numm = b1onum
     c                   eval      fohel1_suff = b1osuf
     c     fohel1_key    chain     fohel1r                            64
     c                   if        *in64 = *off
     c                   eval      w_linj = '1'
     c                   endif
     c                   if        *in64 = *on
     c                   exsr      hente_nyord
     c                   endif
      *
     c     fohel1_key    chain     fohelur                            64
      *
     c                   if        *inke = *on
     c                   eval      fokode = 0
     c                   eval      fokoda = *loval
     c                   eval      fokoti = *loval
     c                   eval      fokous = *blank
     c                   eval      fokows = *blank
     c                   endif
7.27  *
7.27  * Vasker ulovlige tegn
7.27  *
7.27 c     x'1C':' '     xlate     b1navn        b1navn
7.27 c     x'1C':' '     xlate     b1dref        b1dref
7.27 c     x'1C':' '     xlate     b1vref        b1vref
7.27 c     x'25':' '     xlate     b1navn        b1navn
7.27 c     x'25':' '     xlate     b1dref        b1dref
7.27 c     x'25':' '     xlate     b1vref        b1vref
     c
      *
      * Konvertere alfafelt
      * til store bokataver
      *
     c                   if        faahoy = 1
     c     lo:up         xlate     b1navn        b1navn
     c     lo:up         xlate     b1adr1        b1adr1
     c     lo:up         xlate     b1adr2        b1adr2
     c     lo:up         xlate     b1sted        b1sted
     c                   endif
      *
      * Info-type skal ikke kunne endres dersom
3.31  * den har krav om brukerkontroll, og bruker
3.31  * ikke har tilgang til endring.
      *
3.31  *
3.31  * Hent inn ordre-info-kode i inforegister
3.31  *
3.31 c                   eval      vinfl1_ityp = foityp
3.31 c     vinfl1_key    chain     vinfl1r                            92
3.31 c                   if        *in92  = *on
3.31 c                   eval      vaiusr = *blank
3.31 c                   endif
3.31  *
3.31 c                   if        vaiusr = '1'
     c                   if        fbko06 = 0
     c                   else
     c                   eval      foityp = b1ityp
     c                   endif
     c                   endif
      *
3.31 c                   if        vaiusr <> '1'
     c                   eval      foityp = b1ityp
     c                   endif
      *
     c                   eval      footyp = b1otyp
     c                   eval      folety = b1lety
7.22 c                   if        u_722 = *on
7.22 c                   if        b_dirl = *on
7.22 c                   eval      folety = 1
7.22 c                   endif
7.22 c                   endif
6.31 c**                 eval      fobind = b1bind
6.31 c                   eval      fobind = w_bind
     c                   eval      folkun = b1lkun
     c                   eval      fokund = b1kund
     c                   movel     s_kuna        fokuna
      *
     c                   eval      fonavn = b1navn
     c                   eval      foadr1 = b1adr1
     c                   eval      foadr2 = b1adr2
     c                   eval      fosted = b1sted
     c                   eval      fovref = %trim(b1vref)
     c                   eval      fodref = %trim(b1dref)
6.3k  *
6.3k c                   if        w_kpnr <> 0
6.32 c                   eval      fokpnr = w_kpnr
6.3k c                   endif
6.32 c                   if        %trim(b1dref) = *blanks
6.32 c                   eval      fokpnr = 0
6.32 c                   endif
     c                   eval      forekv = %trim(b1rekv)
5.21 c                   eval      fomobi = %trim(b1mobi)
5.21 c                   eval      foinf1 = %trim(b1inf1)
5.21 c                   eval      foinf2 = %trim(b1inf2)
      *
      * Er kundeprosjekt endret ?
      *
     c                   if        s_kpro <> 0
     c                   eval      fokpro = s_kpro
     c                   if        s_orka <> 0
     c                   eval      forkat = s_orka
     c                   endif
7.18 c                   if        u_718 = *on
7.18 c**                 if        s_proj <> 0
7.18 c** TEST  sst       if        s_proj <> *blanks
7.18 c                   eval      foproj = s_proj
7.18 c                   eval      foupro = p_upro
7.18 c                   eval      foakti = p_akti
7.18 c**test sst         endif
7.18 c                   else
6.20 c**                 if        s_proj <> 0
6.20 c                   if        s_proj <> *blanks
     c                   eval      foproj = s_proj
     c                   endif
7.18 c                   endif
5.61 c                   if        s_kjor <> 0
5.61 c                   eval      fokjor = s_kjor
5.61 c                   eval      fokjnr = s_kjnr
5.61 c                   endif
     c                   endif
8.03  *
8.03  * Hvis utfylt både varekunde/fakturakunde og prosjekt. Legges RKALFA fra
8.03  * varekunden i FOKUNA. (Ref NXS-10959)
8.14  * Flyttet slik at kundeprosjekt ligger i FOKPRO hvis kundeprosjekt er tildet
8.14  * på nytt, eller kommer via F7.
8.03  *
8.03 c                   if        folkun <> 0 and
8.03 c                             fokund <> 0 and
8.03 c                             folkun <> fokund and
8.03 c                             fokpro <> 0
8.03 c                   eval      rkunl1_kund = folkun
8.03 c     rkunl1_key    chain     rkunl1
8.03 c                   if        %found and
8.03 c                             rkalfa <> fokuna
8.03 c                   eval      fokuna = rkalfa
8.03 c                   endif
8.03 c                   endif
      *
7.15  * Lagrer tilbud utgår og oppfølgingsdato for å sjekke om de endres
7.15  *
7.15  *
7.15 c                   eval      s_tdat = fotdat
7.15 c                   eval      s_ddat = foddat
7.15  *
     c                   eval      fobdat = *loval
     c                   eval      foddat = *loval
     c                   eval      foldat = *loval
3.12 c                   eval      fopdat = *loval
     c                   eval      fotdat = *loval
6.26 c                   eval      fopada = *loval
      *
     c                   if        b1bdat <> 0
     c     *dmy          move      b1bdat        fobdat
     c                   endif
      *
     c                   if        b1ddat <> 0
     c     *dmy          move      b1ddat        foddat
     c                   endif
      *
     c                   if        b1ldat <> 0
     c     *dmy          move      b1ldat        foldat
     c                   endif
      *
     c                   if        b1tdat <> 0
     c     *dmy          move      b1tdat        fotdat
     c                   endif
      *
6.26 c                   if        b1pada <> 0
6.26 c     *dmy          move      b1pada        fopada
     c                   endif
      *
3.12 c                   if        vaoakk =  2
3.12 c                   if        fopdat =  *loval
3.12 c                   eval      fopdat =  foldat
3.12 c                   endif
3.12 c                   if        foldat =  *loval
3.12 c                   eval      foldat =  w_udat
3.12 c                   endif
3.12 c                   endif
3.38  *
3.38  * Her er det lagt klart for henting av kode
3.38  * fra kunderegister for nettofaktura
3.38  * (Legges inn på nye ordre)
3.38  *
3.38 c                   if        w_ordr = 0
3.38 c                   eval      foneto = s_neto
3.38 c                   endif
5.01  *
5.01  * Dersom dette er en ordre med behandlingskode
5.01  * 2 eller 3, skal kode for at beholdning er
5.01  * oppdatert settes = 1,  i motsatt fall = 0
5.01  *
5.01 c                   if        vaoakk = 2 or
5.01 c                             vaoakk = 3
5.01 c                   eval      foolag = 1
5.01 c                   else
5.01 c                   eval      foolag = 0
5.01 c                   endif
6.31  * Legg inn nye felter
6.31 c                   eval      foselg = b1selg
6.31 c                   eval      foavde = b1avde
6.31 c                   eval      folage = b1lage
8.07 c                   if        b1lmat <> folmat
8.07 c                   eval      w_lmat = folmat
8.07 c                   endif
6.31 c                   eval      folmat = b1lmat
6.31 c                   eval      folmtx = b1lmtx
      *
      * Oppdaterer eller oppretter ordre
      *
     c                   if        *in64 = *off
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
8.06  *
8.06  * Hvis vi kjører med integrasjon til transportstyrer, må vi sende request.
8.06  * - sjekk at forsendelsesmåten har flåtestyring.
8.06  *
8.06 c                   if        u_806 = *on
8.07  * Har vi endret forsendelsesmåte, sjekk om tidligere transportoppdrag
8.07  * må avlyses.
8.07 c                   if        w_lmat <> 0
8.07 c                   eval      ftrpi2_rnum = fonumm
8.07 c                   eval      ftrpi2_rsuf = fosuff
8.07 c     ftrpi2_key    chain     ftrpi2
8.07 c                   if        %found
8.07 c                   eval      w_reqs = *blanks
8.07 c                   call      'AP057R '
8.07 c                   parm                    fofirm
8.07 c                   parm                    fonumm
8.07 c                   parm                    fosuff
8.07 c                   parm                    w_lmat
8.07 c                   parm                    w_reqs
8.07 c                   endif
8.07 c                   endif
8.06  * Må ha loggkode allerede for at den skal sendes. Primært brukes dette
8.06  * for opppdatering av feks leveringsdato.
8.06 c                   eval      b_trpl = *off
8.06 c                   eval      w_aarr = %subdt(w_date:*years)
8.06 c                   eval      floglr_aarr = w_aarr
8.06 c                   eval      floglr_numm = fonumm
8.06 c                   eval      floglr_suff = fosuff
8.06 c     floglr_key    setll     floglr
8.06 c     floglr_key    reade     floglr
8.06 c                   dow       not %eof
8.06 c                   if        fukode = '2' or
8.06 c                             fukode = '4' or
8.06 c                             fukode = '6'
8.06 c                   eval      b_trpl = *on
8.06 c                   endif
8.06 c     floglr_key    reade     floglr
8.06 c                   enddo
8.06  *
8.06  * Sjekk på forrige år, hvis ikke ordren er plukket. Året følger
8.06  * første hendelse på ordren.
8.06  *
8.06 c                   if        b_trpl = *off
8.06  *
8.06 c                   eval      floglr_aarr = w_aarr - 1
8.06 c     floglr_key    setll     floglr
8.06 c     floglr_key    reade     floglr
8.06 c                   dow       not %eof
8.06 c                   if        fukode = '2' or
8.06 c                             fukode = '4' or
8.06 c                             fukode = '6'
8.06 c                   eval      b_trpl = *on
8.06 c                   endif
8.06 c     floglr_key    reade     floglr
8.06 c                   enddo
8.06  *
8.06 c                   endif
8.06  * Kjør logging
8.06 c                   if        b_trpl = *on
8.06  *
8.06 c                   eval      w_reqs = *blanks
8.08 c                   eval      w_skaf = 0
8.09 c                   eval      w_logg = 0
8.08 c                   call      'AP058R '
8.06 c                   parm                    fofirm
8.06 c                   parm                    fonumm
8.06 c                   parm                    fosuff
8.08 c                   parm                    w_skaf
8.09 c                   parm                    w_logg
8.06 c                   parm                    w_reqs
8.06  *
8.06 c                   endif
8.06  *
8.06 c                   endif
7.15  *
7.15  *  Dersom ordretype T og oppfølgings/utgår dato er endret logges dette
7.15  *
7.15  *
7.15 c                   if        u_715 = *on
7.15 c                   if        footyp = 'T '
7.15 c                   if        fotdat <> s_tdat or
7.15 c                             foddat <> s_ddat
7.15 c                   eval      w_aktp = 'DATO     '
7.15 c                   eval      w_slko = 0
7.15 c                   eval      w_kkko = 0
7.15 c                   eval      w_sgru = *blank
7.15  *
7.15 c                   call      'XL700R'
7.15 c                   parm                    fonumm
7.15 c                   parm                    w_aktp
7.15 c                   parm                    w_slko
7.15 c                   parm                    w_kkko
7.15 c                   parm                    w_sgru
7.15 c                   endif
7.15 c                   endif
7.15 c                   endif
7.15  *
     c                   else
6.3p  * Legger inn infokode hvis ordretypen på ordretype w_otyp2
6.3p c                   if        u_63p = *on
6.3p c                   if        footyp = w_otyp2
6.3p c                   if        foityp = *blank
6.3p c                   eval      foityp = w_ityp
6.3p c                   endif
6.3p c                   endif
6.3p c                   endif
6.3p  *
7.23  * Legger inn hold kode hvis ordretypen er PN
7.23 c                   if        u_723 = *on
7.23 c                   if        footyp = 'PN'
7.23 c                   exsr      es_hold
7.23 c                   endif
7.23 c                   endif
7.31  * hvis kunde ikke er internkunde og PI, så hold
7.31 c                   if        u_731 = *on
7.31 c                   if        rkmkod <> 1 and
7.31 c                             rkspfa <> 1 and
7.31 c                             footyp = 'PI'
7.31 c                   eval      foityp = faak98
7.31 c                   endif
7.31 c                   endif
      *
     c                   eval      fofirm = w_firm
     c                   eval      fonumm = fohel1_numm
     c                   eval      fosuff = fohel1_suff
6.10 c                   time                    fodate
6.10 c                   time                    fotime
6.10 c                   eval      fooous = l_user
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   write     fohelur
7.09 c                   exsr      bhnd_nobf
7.14  *
7.14  *  Dersom ordretype T logges oppretting av tilbud i loggfile
7.14  *
7.14 c                   if        u_714 = *on
7.14 c                   if        footyp = 'T '
7.14 c                   eval      w_aktp = 'OPPRETTET'
7.14 c                   eval      w_slko = 0
7.14 c                   eval      w_kkko = 0
7.14 c                   eval      w_sgru = *blank
7.14  *
7.14 c                   call      'XL700R'
7.14 c                   parm                    fonumm
7.14 c                   parm                    w_aktp
7.14 c                   parm                    w_slko
7.14 c                   parm                    w_kkko
7.14 c                   parm                    w_sgru
7.14 c                   endif
7.14 c                   endif
7.25  *
7.25  *  Dersom referanse ordre - spørr om varelinjer
7.25  *
7.25 c                   if        w_rord = *on
7.25 c                   call      'FD510R'
7.25 c                   parm                    b1rnum
7.25 c                   parm                    fonumm
7.25 c
7.25 c                   endif
7.25  *
     c                   endif
5.31  *
5.31  * Sjekk om alternativ fakturering
5.31  *
5.31 c                   if        *in64 = *on
5.31 c                   call      'FO190R'
5.31 c                   parm                    w_stat
5.31 c                   parm                    w_firm
5.31 c                   parm                    fohel1_numm
5.31 c                   parm                    fohel1_suff
5.31 c                   parm                    fokund
5.31 c                   parm                    fokpro
5.31 c                   endif
      *
     c                   if        *in64 = *on
     c                   call      'FO709R'
     c                   parm                    fohel1_numm
     c                   parm                    fohel1_suff
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppretter kunde i KUNDE-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppr_kunde    begsr
5.20  *
5.20  * Kontrollerer om bruker har lov til å opprette kunder
5.20  *
6.25 c                   if        w_ko12 = 0
5.20 c                   eval      w_mld1 = a_mld1(2)
5.20 c                   call      'AA005R'
5.20 c                   parm                    w_mld1
5.20 c                   eval      w_retu = '9'
5.20 c                   leavesr
5.20 c                   endif
      *
      * Kaller program for oppretting av kunde
      *
7.24 c                   if        u_724 = *on
7.24 c                   call      'FA930R'
7.24 c                   parm                    w_retu
7.24 c                   parm                    w_firm
7.24 c                   parm                    b1navn
7.24 c                   parm                    b1adr1
7.24 c                   parm                    b1adr2
7.24 c                   parm                    b1sted
7.24 c                   parm                    b1lkun
7.24 c                   parm                    p_dato
7.24 c                   parm                    p_time
7.24 c                   else
     c                   call      'FA930R'
     c                   parm                    w_retu
     c                   parm                    w_firm
     c                   parm                    b1navn
     c                   parm                    b1adr1
     c                   parm                    b1adr2
     c                   parm                    b1sted
     c                   parm                    b1lkun
7.33 c                   parm                    e2tlfn
7.24 c                   endif
      *
      * Blanker kundopplysninger dersom kundenummer funnet
      *
     c                   if        w_retu = *blank
     c                   eval      b1kund = 0
     c                   eval      b1navn = *blank
     c                   eval      b1adr1 = *blank
     c                   eval      b1adr2 = *blank
     c                   eval      b1sted = *blank
     c                   eval      s_kund = 0
     c                   endif
7.24  * Sørg for at ny kunde kopieres til tilhørende master og filgrupper
7.24 c                   if        u_724 = *on
7.24 c                   if        b1lkun <> 0  and
7.24 c                             w_retu <> '1'
7.24 c                   exsr      synk_kunde
7.24 c                   endif
7.24 c                   endif
      *
     c                   endsr
7.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.24  * Synker kunde
7.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.24  *
7.24 c     synk_kunde    begsr
7.24  *
7.24  * Legg til kunde i Master - NB Hardkodet verdier
7.24  *
7.24 c                   eval      w_mfil = 'H00'
7.24 c                   eval      w_mfir = w_firm
7.24 c                   call      'KM002C'
7.24 c                   parm                    w_mfil
7.24 c                   parm                    w_mfir
7.24 c                   parm                    p_dato
7.24 c                   parm                    p_time
7.24  *
7.24  * Spre ny kunde til alle filgrupper
7.24  *
7.24 c                   call      'KM000R'
7.24 c                   parm                    p_dato
7.24 c                   parm                    p_time
7.24  *
7.24 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppretter kundeprosjekt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppr_kundepro begsr
      *
      * Utleder kunde
      *
     c                   if        b1lkun <> 0
     c                   eval      w_kund = b1lkun
     c                   else
     c                   eval      w_kund = b1kund
     c                   endif
      *
      * Oppretter kundeprosjekt
      *
     c                   if        w_kund = 0
     c                   call      'FL104R'
     c                   parm                    w_firm
     c                   parm                    w_kund
     c                   parm                    w_kpro
     c                   else
     c                   call      'FL105R'
     c                   parm                    w_firm
     c                   parm                    w_kund
     c                   parm                    w_kpro
     c                   parm                    b1navn
     c                   parm                    b1adr1
     c                   parm                    b1adr2
     c                   parm                    w_kund_kopi
     c                   parm                    w_kpro_kopi
6.2g  *
6.2g c                   eval      fkprl1_kund = w_kund
6.2g c                   eval      fkprl1_kpro = w_kpro
6.2g c     fkprl1_key    chain     fkprl1
6.2g  *
6.2g c                   if        %found
6.2g c                   movel     flponr        d_nr
6.2g  * Henter poststed
6.2g  *
6.2g c                   eval      aposl1_ponr = flponr
6.2g c     aposl1_key    chain     aposl1
6.2g c                   if        %found
6.2g c                   movel     apsted        d_st
6.2g c                   endif
6.2g c                   eval      b1sted = d_post
6.2g c                   endif
     c                   endif
      *
      * Dersom kundeprosjekt er opprettet velges dette
      *
     c                   if        b1lkun = 0 and
     c                             b1kund = 0
     c                   eval      b1lkun = w_kund
     c                   endif
      *
     c                   if        w_kpro <> 0
     c                   eval      fkprl1_kund = w_kund
     c                   eval      fkprl1_kpro = w_kpro
     c     fkprl1_key    chain     fkprl1
     c                   if        %found
     c                   eval      b1kpro = w_kpro
     c                   eval      b1navn = flnavn
     c                   eval      b1adr1 = fladr1
     c                   eval      b1adr2 = fladr2
     c****               eval      b1sted = w_sted
     c                   if        fltlfa <> *blank
     c                   eval      b1tlfn = fltlfa
     c                   endif
     c                   if        fltlfm <> *blank
     c                   eval      b1mobn = fltlfm
     c                   endif
     c                   eval      s_orka = florka
     c                   eval      s_proj = flproj
     c                   eval      s_kpro = flkpro
5.61 c                   eval      s_kjor = flkjor
5.61 c                   eval      s_kjnr = flkjnr
6.2c c                   eval      s_faty = flfaty
6.33 c                   eval      s_betb = flbetb
6.33 c                   eval      s_mkod = flmkod
6.33 c                   eval      s_kgek = flekgb
6.33 c                   eval      s_neto = flneto
6.33 c                   eval      s_kgfa = flfagb
     c                   eval      w_in01 = 1
     c                   endif
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Viser bilde for å fortelle at ordren er under plukking
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc2win        begsr
      *
     c                   eval      c2numm = fonumm
     c                   eval      c2suff = fosuff
     c                   eval      c2plna = *blank
      *
5.54 c                   eval      c2plda = 0
5.54 c                   eval      c2plti = 0
5.54 c                   eval      c2plus = *blank
5.54 c                   eval      c2plws = *blank
5.54 c                   eval      c2upda = 0
5.54 c                   eval      c2upti = 0
5.54 c                   eval      c2upus = *blank
5.54 c                   eval      c2upws = *blank
5.54 c                   eval      c2fpda = 0
5.54 c                   eval      c2fpti = 0
5.54 c                   eval      c2fpus = *blank
5.54 c                   eval      c2fpws = *blank
5.54  *
5.54 c                   eval      w_kod2 = '2'
5.61 c                   eval      w_aarr = %subdt(fobdat:*years)
5.54 c                   call      'FU704R'
5.61 c                   parm                    w_aarr
5.54 c                   parm                    fonumm
5.54 c                   parm                    fosuff
5.54 c                   parm                    w_kod2
5.54 c                   parm                    w_sva2
5.54 c                   parm                    w_dat2
5.54 c                   parm                    w_time
5.54 c                   parm                    w_user
5.54 c                   parm                    w_wsid
5.54  *
5.54 c                   if        w_sva2 = 'J'
5.54  *
5.54 c                   if        w_dat2 <> *loval
5.54 c     *dmy          move      w_dat2        c2plda
5.54 c                   endif
5.54 c                   if        w_time <> *loval
5.54 c     *hms          move      w_time        c2plti
5.54 c                   endif
5.54 c                   eval      c2plus = w_user
5.54 c                   eval      c2plws = w_wsid
5.54 c                   endif
5.54  *
5.54 c                   eval      w_kod2 = '4'
5.61 c                   eval      w_aarr = %subdt(fobdat:*years)
5.54 c                   call      'FU704R'
5.61 c                   parm                    w_aarr
5.54 c                   parm                    fonumm
5.54 c                   parm                    fosuff
5.54 c                   parm                    w_kod2
5.54 c                   parm                    w_sva2
5.54 c                   parm                    w_dat2
5.54 c                   parm                    w_time
5.54 c                   parm                    w_user
5.54 c                   parm                    w_wsid
5.54  *
5.54 c                   if        w_sva2 = 'J'
5.54  *
5.54 c                   if        w_dat2 <> *loval
5.54 c     *dmy          move      w_dat2        c2upda
5.54 c                   endif
5.54 c                   if        w_time <> *loval
5.54 c     *hms          move      w_time        c2upti
5.54 c                   endif
5.54 c                   eval      c2upus = w_user
5.54 c                   eval      c2upws = w_wsid
5.54 c                   endif
5.54  *
5.54 c                   eval      w_kod2 = '6'
5.61 c                   eval      w_aarr = %subdt(fobdat:*years)
5.54 c                   call      'FU704R'
5.61 c                   parm                    w_aarr
5.54 c                   parm                    fonumm
5.54 c                   parm                    fosuff
5.54 c                   parm                    w_kod2
5.54 c                   parm                    w_sva2
5.54 c                   parm                    w_dat2
5.54 c                   parm                    w_time
5.54 c                   parm                    w_user
5.54 c                   parm                    w_wsid
5.54  *
5.54 c                   if        w_sva2 = 'J'
5.54  *
5.54 c                   if        w_dat2 <> *loval
5.54 c     *dmy          move      w_dat2        c2fpda
5.54 c                   endif
5.54 c                   if        w_time <> *loval
5.54 c     *hms          move      w_time        c2fpti
5.54 c                   endif
5.54 c                   eval      c2fpus = w_user
5.54 c                   eval      c2fpws = w_wsid
5.54  *
5.54 c                   endif
      *
      * Henter inn opplysninger fra selger
      *
     c                   if        foplse <> 0
     c                   eval      ra09l1_ikod = foplse
     c     ra09l1_key    chain     ra09l1r
     c                   if        %found
     c                   eval      c2plna = raitxt
     c                   endif
     c                   endif
      *
      * Send bilde
      *
     c     c2tag         tag
      *
     c                   exfmt     c2win
      *
     c                   endsr
7.33  *
7.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.33  * Søking på 1881
7.33  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.33  *
7.33 c     xe2win        begsr
7.33  *
7.33 c                   eval      e2tlfn = *blanks
7.33  *
7.33 c                   exfmt     e2win
7.33  *
7.33 c                   if        *inkc = *on
7 33 c                   eval      b1navn = *blank
7 33 c                   eval      b1adr1 = *blank
7 33 c                   eval      b1adr2 = *blank
7 33 c                   eval      b1sted = *blank
7.33 c                   eval      e2tlfn = *blank
7.33 c                   leavesr
7.33 c                   endif
7.33  *
7.33 c                   if        *inkf = *on
7 33 c                   eval      b1navn = *blank
7 33 c                   eval      b1adr1 = *blank
7 33 c                   eval      b1adr2 = *blank
7 33 c                   eval      b1sted = *blank
7.33 c                   eval      e2tlfn = *blank
7.33 c                   eval      b_1881 = *on
7.33 c                   leavesr
7.33 c                   endif
7.33  *
7.33 c*                  eval      b1mobn = e2tlfn
7.33 c                   eval      b1mobn = %subst(e2tlfn:1:8)
7.33 c                   call      'FA933R'
7.33 c                   parm                    w_firm
7.33 c                   parm                    b1navn
7.33 c                   parm                    b1adr1
7.33 c                   parm                    b1adr2
7.33 c                   parm                    b1sted
7.33 c                   parm                    b1mobn
7.33 c                   parm                    w_ponr
7.33 c                   eval      b_1881 = *on
7.33  *
7.33 c                   endsr
6.2e  *
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  * Subrutine for å gi melding om endring av leveringstype
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  *
6.2e c     levtyp_msg    begsr
6.2e  *
6.2e  * sjekker om det finnes bestillinger
6.2e c                   eval      w_svar = *blank
6.2e c                   eval      w_in12 = 0
6.2e c                   eval      x = 0
6.2e c                   eval      b_bkjo = *off
6.2e c                   eval      b_lety = *off
6.2e c                   eval      a_benr(*) = 0
6.2e c                   eval      fodtl1_numm = fonumm
6.2e c     fodtl1_key    setll     fodtl1
6.2e c     fodtl1_key    reade     fodtl1
6.2e c                   dow       not %eof(fodtl1)
6.2e  * leser ordrelinjer
6.2e c                   if        fdbenr <> 0
6.2e c                   if        %lookup(fdbenr:a_benr) = 0
6.2e c                   eval      x = x + 1
6.2e c                   eval      a_benr(x) = fdbenr
6.2e  * sjekk behandlingskode på bestilling
6.2e c                   eval      lohel1_numm = fdbenr
6.2e c     lohel1_key    setll     lohel1
6.2e c     lohel1_key    reade     lohel1
6.2e c                   dow       not %eof(lohel1)
6.2e c                   eval      votylr_otyp = lootyp
6.2e c     votylr_key    chain     votylr
6.2e c                   if        %found(votylr) and
6.2e c                             xaoakk > 1
6.2e c                   eval      b_bkjo = *on
6.2e c                   endif
6.2e c     lohel1_key    reade     lohel1
6.2e c                   enddo
6.2e  *
6.2e c                   if        x >=4
6.2e c                   leave
6.2e c                   endif
6.2e c                   endif
6.2e c                   endif
6.2e  *
6.2e c     fodtl1_key    reade     fodtl1
6.2e c                   enddo
6.2e  *
6.2e  * bestillinger finnes
6.2e  *
6.2e c                   if        x > 0
6.2e c                   eval      b_lety = *on
6.2e  * leveringstype endres fra 1 til 0
6.2e c                   if        b1lety = 0
6.2e  *
6.2e c                   eval      w_mld1 = 'Bestillinger finnes'
6.2e c                   if        a_benr(1) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(1))
6.2e c                   endif
6.2e c                   if        a_benr(2) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(2))
6.2e c                   endif
6.2e c                   if        a_benr(3) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(3))
6.2e c                   endif
6.2e c                   if        a_benr(4) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(4))
6.2e c                   endif
6.2e c                   eval      w_mld2 = 'I Ordre/I best. vil bli korrigert.'
6.2e c                   eval      w_svar = 'J'
6.2e c                   call      'AA007R'
6.2e c                   parm                    w_mld1
6.2e c                   parm                    w_mld2
6.2e c                   parm                    w_svar
6.2e c                   parm                    w_in12
6.2e  *
6.2e c                   endif
6.2e  *
6.2e  * leveringstype endres fra 0 til 1
6.2e  *
6.2e c                   if        b1lety = 1
6.2e  *
6.2e c                   eval      w_mld1 = 'Bestillinger finnes'
6.2e c                   if        a_benr(1) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(1))
6.2e c                   endif
6.2e c                   if        a_benr(2) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(2))
6.2e c                   endif
6.2e c                   if        a_benr(3) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(3))
6.2e c                   endif
6.2e c                   if        a_benr(4) <> 0
6.2e c                   eval      w_mld1 = %trim(w_mld1) + ' ' +
6.2e c                                      %char(a_benr(4))
6.2e c                   endif
6.2e c                   if        b_bkjo = *on
6.2e c                   eval      w_mld2 = 'Minst 1 er allerede sendt !!    '
6.2e c                   eval      w_svar = 'J'
6.2e c                   call      'AA007R'
6.2e c                   parm                    w_mld1
6.2e c                   parm                    w_mld2
6.2e c                   parm                    w_svar
6.2e c                   parm                    w_in12
6.2e c                   eval      w_in12 = 1
6.2e c                   eval      b_lety = *off
6.2e c                   else
6.2e c                   eval      w_mld2 = 'I Ordre/I best. vil bli korrigert.'
6.2e c                   eval      w_svar = 'J'
6.2e c                   call      'AA007R'
6.2e c                   parm                    w_mld1
6.2e c                   parm                    w_mld2
6.2e c                   parm                    w_svar
6.2e c                   parm                    w_in12
6.2e  *
6.2e c                   endif
6.2e  *
6.2e c                   endif
6.2e  *
6.2e c                   else
6.2e c                   exsr      sjekk_b_fors
6.2e c                   endif
6.2e  *
6.2e c                   endsr
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  * Subrutine for å gi å korrigerer i best. i ordre
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  *
6.2e c     korrig_lag    begsr
6.2e  *
6.2e c                   eval      w_mld1 = 'I ordre /I best. for alle ' +
6.2e c                             'lager korrigeres'
6.2e c                   eval      w_mld2 = 'Ikke avbryt jobben !      '
6.2e c                   eval      w_svar = 'J'
7.06 c                   call      'AA029R'
6.2e c                   parm                    w_mld1
6.2e c                   parm                    w_mld2
6.2e c                   parm                    w_svar
6.2e c                   parm                    w_in12
6.3j c*                  call      'FO764R  '
6.3j c*                  call      'FO760R  '
6.3j c*                  call      'LA920RNAT'
6.3j c*                  eval      w_in12 = 0
6.3j  * leser alle varer på ordren
6.3j  *
6.3j c                   eval      fodtl1_numm = fonumm
6.3j c     fodtl1_key    setll     fodtl1
6.3j c     fodtl1_key    reade     fodtl1
6.3j c                   dow       not %eof(fodtl1)
6.3j  *
8.34 c**                 call      'FO766R  '
8.04 c**                 parm                    fdfirm
8.04 c**                 parm                    fdvare
6.3j  *
6.3j c                   call      'FO765R  '
6.3j c                   parm                    fdfirm
6.3j c                   parm                    fdvare
6.3j c                   parm                    fdlage
6.3j  *
6.3j c                   call      'LA923R'
6.3j c                   parm                    fdfirm
6.3j c                   parm                    fdvare
6.3j c                   parm                    fdlage
6.3j  *
6.3j c     fodtl1_key    reade     fodtl1
6.3j c                   enddo
6.3j c                   eval      w_in12 = 0
6.2e  *
6.2e c                   endsr
6.2e  *
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  * Subrutine for å sjekke om det finnes best.forslag heading
6.2e  * evt. oppdatere lev.type
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  *
6.2e c     sjekk_b_fors  begsr
6.2e  *
6.2e c                   eval      b_bfoh = *off
6.2e c                   eval      b_lety = *off
6.2e c                   eval      lfdtl6_ornr =   fonumm
6.2e c     lfdtl6_key    setll     lfdtl6
6.2e c     lfdtl6_key    reade     lfdtl6
6.2e c                   dow       not %eof(lfdtl6)
6.2e c                   eval      lfhelu_numm = lfnumm
6.2e c                   eval      b_bfoh = *on
6.2e c                   eval      b_lety = *on
6.2e c     lfdtl6_key    reade     lfdtl6
6.2e c                   enddo
6.2e  *
6.2e c                   if        b_bfoh = *on
6.2e c     lfhelu_key    chain     lfhelu
6.2e c                   if        %found(lfhelu)
6.2e c                   eval      lhlety = b1lety
6.2e c                   time                    lhedat
6.2e c                   time                    lhetim
6.2e c                   eval      lheusr = l_user
6.2e c                   update    lfhelur
6.2e c                   endif
6.2e c                   eval      lfdtlu_numm = lhnumm
6.2e c     lfdtlu_key    setll     lfdtlu
6.2e c     lfdtlu_key    reade     lfdtlu
6.2e c                   dow       not %eof(lfdtlu)
6.2e c                   eval      lflety = b1lety
6.2e c                   time                    lfedat
6.2e c                   time                    lfetim
6.2e c                   eval      lfeusr = l_user
6.2e c                   update    lfdtlur
6.2e c     lfdtlu_key    reade     lfdtlu
6.2e c                   enddo
6.2e c                   endif
6.2e  *
6.2e c                   endsr
      *
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  * Henter teskt fra avtalespesifikasjon
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  *
7.03 c     hent_avts     begsr
7.03 c
7.03  *
7.03  * Henter inn tekst fra avtalespesifikasjon
7.03  *
7.03 c                   eval      w_akun = 0
7.03 c                   if        b1lkun <> 0
7.03 c                   eval      w_akun = b1lkun
7.03 c                   elseif    b1kund <> 0
7.03 c                   eval      w_akun = b1kund
7.03 c                   endif
7.03 c                   if        w_akun = 0
7.03 c                   leavesr
7.03 c                   endif
7.03 c                   call      'FÅ709R'
7.03 c                   parm                    w_firm
7.03 c                   parm                    w_akun
7.03 c                   parm                    w_sat1
7.03 c                   parm                    w_sat2
7.03 c                   parm                    w_sat3
7.03  *
7.03 c                   if        w_sat1 <> *blank
7.03 c                   eval      b2sat1 =  w_sat1
7.03 c                   eval      b2sat2 =  w_sat2
7.03 c                   eval      b2sat3 =  w_sat3
7.03 c                   eval      *in28 =*on
7.03 c                   endif
7.03 c
7.03 c                   endsr
7.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.09  * Behandle NOBB frakt
7.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.09  *
7.09 c     bhnd_nobf     begsr
7.09 c
7.09 c                   if        u_nofa = *off
7.09 c                   leavesr
7.09 c                   endif
7.09 c
7.09  * kommer hit, hvis auto nobb frakt er på
7.09 c
7.09 c                   if        w_ordr = 0
7.09  *
7.09  * NY ordre
7.09  *
7.09 c                   if        folety = 1
7.09 c     foh2lu_key    chain     foh2lur
7.09 c                   if        not %found
7.09 c                   eval      fo2fir = w_firm
7.09 c                   eval      fo2num = fohel1_numm
7.09 c                   eval      fo2suf = fohel1_suff
7.09 c                   eval      fo2nbf = 1
7.09 c                   time                    fo2dat
7.09 c                   time                    fo2tim
7.09 c                   eval      fo2oou = l_user
7.09 c                   time                    fo2eda
7.09 c                   time                    fo2eti
7.09 c                   eval      fo2eus = l_user
7.09 c                   write     foh2lur
7.09 c                   endif
7.09 c                   endif
7.09 c                   else
7.09  *
7.09  * Eksisterende ordre
7.09  *
7.09 c                   if        w_flty <> folety
7.09 c                   if        w_flty = 1 and folety = 0
7.09  * byttet fra direkte til hentes
7.09 c     foh2lu_key    chain     foh2lur
7.09 c                   if        %found
7.09 c                   eval      fo2nbf = 0
7.09 c                   time                    fo2eda
7.09 c                   time                    fo2eti
7.09 c                   eval      fo2eus = l_user
7.09 c                   update    foh2lur
7.09  *  Kaller opp subprogram for endring av ordre
7.09  *
     c                   eval      w_enor = '1'
7.09 c                   CALL      'FO730R'
7.09 c                   PARM                    w_enor
7.09 c                   PARM                    w_firm
7.09 c                   PARM                    fohel1_numm
7.09 c                   PARM                    fohel1_suff
7.09 c                   endif
7.09 c                   elseif    w_flty = 0 and folety = 1
7.09  * byttet fra hentes til direkte
7.09 c     foh2lu_key    chain     foh2lur
7.09 c                   if        %found
7.09 c                   eval      fo2nbf = 1
7.09 c                   time                    fo2eda
7.09 c                   time                    fo2eti
7.09 c                   eval      fo2eus = l_user
7.09 c                   update    foh2lur
7.09 c                   else
7.09 c                   eval      fo2fir = w_firm
7.09 c                   eval      fo2num = fohel1_numm
7.09 c                   eval      fo2suf = fohel1_suff
7.09 c                   eval      fo2nbf = 1
7.09 c                   time                    fo2dat
7.09 c                   time                    fo2tim
7.09 c                   eval      fo2oou = l_user
7.09 c                   time                    fo2eda
7.09 c                   time                    fo2eti
7.09 c                   eval      fo2eus = l_user
7.09 c                   write     foh2lur
7.09 c                   endif
7.09  *
7.09  * Leser alle ordrelinjer og setter kostpris lik innkjøpspris
7.09  *
7.09 c     fodtlu_key    setll     fodtlu
7.09 c     fodtlu_key    reade     fodtlu
7.09 c                   dow       not %eof
7.09 c                   if        fdinpr = *zero
7.09 c                   exsr      innpri
7.09 c                   if        w_inpr <> *zero
7.09 c                   eval      fdinpr = w_inpr
7.09 c                   endif
7.09 c                   endif
7.09 c                   if        fdinpr <> *zero
7.09 c                   eval      fdkopr = fdinpr
7.09 c                   time                    fdedat
7.09 c                   time                    fdetim
7.09 c                   eval      fdeusr = l_user
7.09 c                   update    fodtlur
7.09 c                   else
7.09 c                   unlock    fodtlu
7.09 c                   endif
7.09 c     fodtlu_key    reade     fodtlur
7.09 c                   enddo
7.09  *  Kaller opp subprogram for kalkulering av ordre
7.09  *
7.09 c                   eval      w_enor = ''
7.09 c                   CALL      'FO730R'
7.09 c                   PARM                    w_enor
7.09 c                   PARM                    w_firm
7.09 c                   PARM                    fohel1_numm
7.09 c                   PARM                    fohel1_suff
7.09 c                   endif
7.09 c                   endif
7.09 c                   endif
7.09  *
7.09 c                   endsr
7.09  *
7.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.09  *  Hent innkjøpspris                                              *
7.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.09  *
7.09 c     INNPRI        BEGSR
7.09  *
7.09 c                   eval      w_lety = folety
7.09 c                   eval      w_prgr = fdprgr
7.09 c                   eval      w_lenh = fdenh1
7.09 c                   eval      w_kamp = fdkamp
      *
7.09 c                   call      'VP712R'
7.09 c                   parm                    w_firm
7.09 c                   parm                    fdvare
7.09 c                   parm                    fdldor
7.09 c                   parm                    w_prgr
7.09 c                   parm                    w_lenh
7.09 c                   parm                    w_lety
7.09 c                   parm                    w_dato
7.09 c                   parm                    b_inlr
7.09 c                   parm                    w_sapr2
7.09 c                   parm                    w_bupr2
7.09 c                   parm                    w_kopr2
7.09 c                   parm                    w_inpr
7.09 c                   parm                    w_inpr2
7.09 c                   parm                    w_hlev
7.09  *
7.09 c                   ENDSR
7.23  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.23  * Setter hold op ordren hvis ordretypen er PN
7.23  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.23 c     es_hold       begsr
7.23  *
7.23 c                   eval      foityp =  faak98
7.23 c                   if        fbko98 <> *blank
7.23 c                   eval      foityp =  fbko98
7.23 c                   endif
7.23  *
7.23 c                   endsr
7.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.25  * Kopiere ordre - henter info fra referanse ordre
7.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.25 c     kopier_ordre  begsr
7.25  *
7.25 c                   eval      w_vrefk = %trim(b1vref)
7.25 c                   eval      w_otypk = b1otyp
7.25 c                   eval      fohel1_numm = b1rnum
7.25 c                   eval      fohel1_suff = 0
7.25 c                   exsr      hente_ordre
7.25 c                   if        *in64 = *on
7.25 c                   exsr      hente_faktura
7.25 c                   endif
      * sjekk om fant ordre eller faktura
7.25 c                   if        *in64 = *off
7.25 c                   eval      w_rord = *on
7.25 c                   eval      w_ordr = 0
7.25 c                   eval      b1vref = %trim(w_vrefk)
7.25 c                   eval      b1otyp = w_otypk
7.25 c                   eval      fonumm = 0
7.25 c                   eval      b1onum = 0
7.25 c                   eval      b1bdat = w_odat
7.25 c                   eval      b1ldat = 0
7.25 c                   eval      b1ddat = 0
7.25 c                   eval      b1tdat = 0
7.25 c                   eval      b1pada = 0
7.25 c                   eval      w_kpro = fokpro
7.25 c                   eval      s_kpro = w_kpro
7.25 c
7.25 c                   if        s_lage <> b1lage or s_avde <> b1avde
7.25 c                   eval      w_mld1 = 'Lager og/eller avdeling avviker'
7.25 c                   eval      f3lage = b1lage
7.25 c                   eval      F3AVDE = b1avde
7.25 c                   exfmt     f3win
7.25 c                   endif
7.25 c                   eval      *in61 = *on
7.25 c                   else
7.25 c                   eval      w_mld1 = 'Ordre/faktura ikke funnet'
7.25 c                   call      'AA005R'
7.25 c                   parm                    w_mld1
7.25 c                   eval      b1rnum = 0
7.25 c                   eval      *in61 = *off
7.25 c                   endif
7.25 c
7.25  *
7.25 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Nullstilling av felter som ikke kan redefineres
      *
     c                   eval      w_feil_kund = *blank
     c                   eval      w_text = *blank
      *
     c                   eval      w_ordr = 0
     c                   eval      w_retu = *blank
     c                   eval      w_linj = *blank
      *
     c                   eval      w_sald = 0
5.60 c                   eval      w_sal2 = 0
      *
     c                   eval      w_kode = *blank
     c                   eval      w_fell = *blank
     c                   eval      w_type = *blank
     c                   eval      w_fast = *blank
     c                   eval      w_numm = 0
      *
     c                   eval      w_kom1 = *blank
     c                   eval      w_kom2 = *blank
      *
     c                   eval      w_in01 = 0
      *
      * Key for file : GPL-BRUKER-REGISTER
      *
      *
6.2g c     aposl1_key    klist
6.2g c                   kfld                    aposl1_ponr
6.2g  *
     c     ausrl1_key    klist
     c                   kfld                    ausrl1_user
6.23  *
6.23  * Key for file : Firmastyrt validering
6.23  *
6.23 c     avall1_key    klist
6.23 c                   kfld                    w_firm
6.23 c                   kfld                    avall1_apgm
      *
      * Key for file : GPL-BRUKER-REGISTER
      *
     c     fusrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fusrl1_user
      *
      * Key for file : KUNDE-REGISTER
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
8.03  *
8.03  * Key for file : KUNDE-REGISTER
8.03  *
8.03 c     rkunlr_key    klist
8.03 c                   kfld                    w_firm
8.03 c                   kfld                    rkunlr_kund
      *
      * Key for file : STATUS-KODER
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
6.2k  *
6.2k  * Key for file : STATUS-KODER
6.2k  *
6.2k c     bstsl1_key    klist
6.2k c                   kfld                    w_firm
      *
      * Key for file : ORDRE-TYPE-REGISTER
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
6.2d  *
6.2d  * Key for file : ORDRE-TYPE-REGISTER tilleggsregister
6.2d  *
6.2d c     vot1l1_key    klist
6.2d c                   kfld                    w_firm
6.2d c                   kfld                    vot1l1_otyp
      *
      * Key for file : ORDRE-HODE-REGISTER
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohel1_numm
     c                   kfld                    fohel1_suff
      *
      * Key for oppslag/les kundeprosjekt
      *
     c     fkprl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fkprl1_kund
     c                   kfld                    fkprl1_kpro
      *
     c     fkprl1_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    fkprl1_kund
      *
      * Key for oppslag på leveringstype
      *
     c     vltpl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltpl1_lety
      *
      * Key for oppslag på ordre-info-type
      *
     c     vinfl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vinfl1_ityp
6.2e  *
6.2e  * Key for oppslag på ordre-linje
6.2e  *
6.2e c     fodtl1_key    klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    fodtl1_numm
6.2e  *
6.2e  * Key for oppslag på bestillingshold
6.2e  *
6.2e c     lohel1_key    klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    lohel1_numm
6.2e  *
6.2e  * Key for file : ORDRE-TYPE-REGISTER
6.2e  *
6.2e c     votylr_key    klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    votylr_otyp
6.2e  *
6.2e  * Key for file : best.forslag linjer
6.2e  *
6.2e c     lfdtl6_key    klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    lfdtl6_ornr
6.2e  *
6.2e  * Key for file : best.forslag heading
6.2e  *
6.2e c     lfhelu_key    klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    lfhelu_numm
6.2e  *
6.2e  * Key for file : best.forslag linjer
6.2e  *
6.2e c     lfdtlu_key    klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    lfdtlu_numm
      *
      * Key for oppslag på avdeling
      *
     c     ra07l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra07l1_gkod
      *
      * Key for oppslag på selger
      *
     c     ra09l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra09l1_ikod
7.09  *
7.09  * Key for oppdatering av ordre-hode SIDETABELL
7.09  *
7.09 c     foh2lu_key    klist
7.09 c                   kfld                    w_firm
7.09 c                   kfld                    fohel1_numm
7.09 c                   kfld                    fohel1_suff
7.09  *
7.09  * Key for oppdater ordre-linje
7.09  *
7.09 c     fodtlu_key    klist
7.09 c                   kfld                    w_firm
7.09 c                   kfld                    fohel1_numm
7.09 c                   kfld                    fohel1_suff
7.16  *
7.16  * Key for propertiesfil
7.16  *
8.05 c*    afpslr_key    klist
8.05 c*                  kfld                    afpslr_ufil
8.05 c*                  kfld                    afpslr_uide
7.18  *
7.18  * Key for oppslag på prosjekt
7.18  *
7.18 c     rp1pl1_key    klist
7.18 c                   kfld                    w_firm
7.18 c                   kfld                    rp1pl1_pros
7.18  *
7.18  * Key for oppslag på under prosjekt
7.18  *
7.18 c     rp2ul1_key    klist
7.18 c                   kfld                    w_firm
7.18 c                   kfld                    rp2ul1_pros
7.18 c                   kfld                    rp2ul1_upro
7.21  ** Key for oppslag på kundekategori
7.21  **
7.21 c*     ra11l1_key    klist
7.21 c*                   kfld                    w_firm
7.21 c*                   kfld                    ra11l1_kkod
7.22  *
7.22  * Key for file : forsendelsesmåte
7.22  *
7.22 c     ra17l1_key    klist
7.22 c                   kfld                    w_firm
7.22 c                   kfld                    ra17l1_qkod
7.25  *
7.25  * Key for file : HISTORISK-FAKTURA-REGISTER HODE
7.25  *
7.25 c     sohel1_key    klist
7.25 c                   kfld                    w_firm
7.25 c                   kfld                    sohel1_aarr
7.25 c                   kfld                    sohel1_binr
7.25 c                   kfld                    sohel1_numm
7.25 c                   kfld                    sohel1_suff
7.36  *
7.36  * Key for oppslag på kunde - sideregister
7.36  *
7.36 c     rku2l1_key    klist
7.36 c                   kfld                    w_firm
7.36 c                   kfld                    rku2l1_2kun
8.06  *
8.06  * Key for oppslag på loggfil
8.06  *
8.06 c     floglr_key    klist
8.06 c                   kfld                    w_firm
8.06 c                   kfld                    floglr_aarr
8.06 c                   kfld                    floglr_numm
8.06 c                   kfld                    floglr_suff
8.07  *
8.07  * Key for posisjonering på transportoppdrag
8.07  *
8.07 c     ftrpi2_key    klist
8.07 c                   kfld                    w_firm
8.07 c                   kfld                    ftrpi2_rnum
8.07 c                   kfld                    ftrpi2_rsuf
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    p_valg
6.NU c                   parm                    p_numm
     c                   parm                    p_suff
      *
      * Legger inn firmanummer i nøkklene
      *
     c                   eval      w_firm = l_sfir
      *
      * Nullstiller/blanker hjelpe-felter
      *
     c                   eval      s_lage = 0
     c                   eval      s_betb = 0
     c                   eval      s_faty = 0

     c                   eval      s_dist = 0
     c                   eval      s_lmat = 0
     c                   eval      s_lbet = 0
     c                   eval      s_valk = *blank
     c                   eval      s_rkat = 0
     c                   eval      s_sped = 0
     c                   eval      s_kjor = 0
5.61 c                   eval      s_kjnr = 0
     c                   eval      s_mkod = 0
     c                   eval      s_kobk = 0
     c                   eval      s_kgfa = 0
     c                   eval      s_kgek = 0
     c                   eval      s_kgfr = 0
     c                   eval      w_ksob = 0
     c                   eval      w_ktxt = 0
     c                   eval      w_kfak = 0
     c                   eval      w_kspr = 0
     c                   eval      w_lmtx = *blank
     c                   eval      w_lbtx = *blank
     c                   eval      w_rabp = 0
7.09  *
7.09  * NOBB frakt på direkte leverte ordre
7.09  *
7.09   CallP CO402R(l_filg:w_firm:0:'AUTOMATISK_NOBB_FRAKTKALKULATOR':
7.09                    co402_verdi1:co402_verdi2);
7.09   if co402_verdi1 = '1';
7.09     u_nofa = *on;
7.09   endif;
7.10  *
7.10  * Endring 7.10
7.10  *
7.10   CallP CO402R(l_filg:w_firm:0:'FO100R_710':
7.10                    co402_verdi1:co402_verdi2);
7.10   if co402_verdi1 = '1';
7.10     u_710 = *on;
7.10   endif;
7.11  *
7.11  * Endring 7.11
7.11  *
7.11   CallP CO402R(l_filg:w_firm:0:'FO100R_711':
7.11                    co402_verdi1:co402_verdi2);
7.11   if co402_verdi1 = '1';
7.11     u_711 = *on;
7.11   endif;
7.12  *
7.12  * Endring 7.12
7.12  *
7.12   *in54 = *off;
7.12   CallP CO402R(l_filg:w_firm:0:'FO100R_712':
7.12                    co402_verdi1:co402_verdi2);
7.12   if co402_verdi1 = '1';
7.12     u_712 = *on;
7.12     *in54 = *on;
7.12   endif;
6.3p  *
6.3p  * Endring 6.3p
6.3p  *
6.3p   CallP CO402R(l_filg:w_firm:0:'FO100R_63P':
6.3p                    co402_verdi1:co402_verdi2);
6.3p   if co402_verdi1 = '1';
6.3p     w_pos = %scan(':' : co402_verdi2);
6.3p     if (w_pos > 0);
6.3p       w_otyp2 = %subst(co402_verdi2 : 1 : w_pos - 1);
6.3p       w_ityp = %subst(co402_verdi2 : w_pos + 1 : 2);
6.3p       if (w_otyp2 <> *blank and w_ityp <> *blank);
6.3p         u_63p = *on;
6.3p       endif;
6.3p     endif;
6.3p   endif;
7.13  *
7.13  * Endring 7.13
7.13  *
7.13   CallP CO402R(l_filg:w_firm:0:'FO100R_713':
7.13                    co402_verdi1:co402_verdi2);
7.13   if co402_verdi1 = '1';
7.13     u_713 = *on;
7.13   endif;
7.14  *
7.14  * Endring 7.14
7.14  *
7.14   CallP CO402R(l_filg:w_firm:0:'FO100R_714':
7.14                    co402_verdi1:co402_verdi2);
7.14   if co402_verdi1 = '1';
7.14     u_714 = *on;
7.14   endif;
7.15  *
7.15  * Endring 7.15
7.15  *
7.15   CallP CO402R(l_filg:w_firm:0:'FO100R_715':
7.15                    co402_verdi1:co402_verdi2);
7.15   if co402_verdi1 = '1';
7.15     u_715 = *on;
7.15   endif;
7.16  *
7.16  * Endring 7.16
7.16  *
7.16   CallP CO402R(l_filg:w_firm:0:'FO100R_716':
7.16                    co402_verdi1:co402_verdi2);
7.16   if co402_verdi1 = '1';
7.16     u_716 = *on;
7.16   endif;
7.18  *
7.18  * Endring 7.18
7.18  *
7.18   CallP CO402R(l_filg:w_firm:0:'FO100R_718':
7.18                    co402_verdi1:co402_verdi2);
7.18   if co402_verdi1 = '1';
7.18     u_718 = *on;
7.18   endif;
7.19  *
7.19  * Endring 7.19
7.19  *
7.19   CallP CO402R(l_filg:w_firm:0:'FO100R_719':
7.19                    co402_verdi1:co402_verdi2);
7.19   if co402_verdi1 = '1';
7.19     u_719 = *on;
7.19   endif;
7.20  *
7.20  * Endring 7.20
7.20  *
7.20   CallP CO402R(l_filg:w_firm:0:'FO100R_720':
7.20                    co402_verdi1:co402_verdi2);
7.20   if co402_verdi1 = '1';
7.20     u_720 = *on;
7.20   endif;
7.21  *
7.21  * Endring 7.21
7.21  *
7.21   CallP CO402R(l_filg:w_firm:0:'FO100R_721':
7.21                   co402_verdi1:co402_verdi2);
7.21   if co402_verdi1 = '1';
7.21     u_721 = *on;
7.21   endif;
7.22  *
7.22  * Endring 7.22
7.22  *
7.22   CallP CO402R(l_filg:w_firm:0:'FO100R_722':
7.22                   co402_verdi1:co402_verdi2);
7.22   if co402_verdi1 = '1';
7.22     u_722 = *on;
7.22   endif;
7.23  *
7.23  * Endring 7.23
7.23  *
7.23   CallP CO402R(l_filg:w_firm:0:'FO100R_723':
7.23                   co402_verdi1:co402_verdi2);
7.23   if co402_verdi1 = '1';
7.23     u_723 = *on;
7.23   endif;
7.24  *
7.24  * Endring 7.24
7.24  *
7.24   CallP CO402R(l_filg:w_firm:0:'FO100R_724':
7.24                   co402_verdi1:co402_verdi2);
7.24   if co402_verdi1 = '1';
7.24     u_724 = *on;
7.24   endif;
7.25  *
7.25  * Endring 7.25
7.25  *
7.25   CallP CO402R(l_filg:w_firm:0:'AKTIVER_REFERANSEORDRE':
7.25                   co402_verdi1:co402_verdi2);
7.25   if co402_verdi1 = '1';
7.25     u_725 = *on;
7.25     *in63 = *on;
7.25   endif;
7.26  *
7.26  * Endring 7.26
7.26  *
7.26   CallP CO402R(l_filg:w_firm:0:'FO100R_726':
7.26                   co402_verdi1:co402_verdi2);
7.26   if co402_verdi1 = '1';
7.26     u_726 = *on;
7.26   endif;
7.28  *
7.28  * Endring 7.28
7.28  *
7.28   CallP CO402R(l_filg:w_firm:0:'FO100R_728':
7.28                   co402_verdi1:co402_verdi2);
7.28   if co402_verdi1 = '1';
7.28     w_pos = %scan('¤' : co402_verdi2);
7.28     if (w_pos > 0);
7.28       w_fokund = %DEC(%subst(co402_verdi2 : 1 : w_pos - 1) : 6 : 0);
7.28       co402_verdi2 =  %subst(co402_verdi2:w_pos+1:512-w_pos);
7.28       w_pos = %scan('¤' : co402_verdi2);
7.28       w_footyp  = %subst(co402_verdi2 : 1 : w_pos - 1);
7.28       if ((w_fokund > 0) and (w_footyp <> *blank));
7.28         u_728 = *on;
7.28       endif;
7.28     endif;
7.28   endif;
7.31  *
7.31  * Endring 7.31
7.31  *
7.31   CallP CO402R(l_filg:w_firm:0:'FO100R_731':
7.31                   co402_verdi1:co402_verdi2);
7.31   if co402_verdi1 = '1';
7.31     u_731 = *on;
7.31   endif;
7.33  *
7.33  * Eksternt kundesøk  - vrdi2 styrer type søk
7.33  *
8.02   CallP CO402R(l_filg:w_firm:0:'1881 - EKSTERNT_KUNDESØK':
7.33                   co402_verdi1:co402_verdi2);
7.33   if co402_verdi1 = '1';
7.33    if co402_verdi2 = '1881';
7.33         u_1881 = *on;
7.33    endif;
7.33   endif;
7.34  *
7.34  * Endring 7.34
7.34  *
7.34   CallP CO402R(l_filg:w_firm:0:'FO100R_734':
7.34                   co402_verdi1:co402_verdi2);
7.34   if co402_verdi1 = '1';
7.34     u_734 = *on;
7.34   endif;
7.36  *
7.36  * Endring 7.36
7.36  *
7.36   CallP CO402R(l_filg:w_firm:0:'FO100R_736':
7.36                   co402_verdi1:co402_verdi2);
7.36   if co402_verdi1 = '1';
7.36     u_736 = *on;
7.36   endif;
8.01  *
8.01  * Endring 8.01
8.01  *
8.01   CallP CO402R(l_filg:w_firm:0:'FO100R_801':
8.01                   co402_verdi1:co402_verdi2);
8.01   if co402_verdi1 = '1';
8.01     u_801 = *on;
8.01   endif;
8.06  *
8.06  * Endring 8.06 - Koblet til ekstern flåtestyring
8.06  *
8.06   CallP CO402R(l_filg:w_firm:0:'EKSTERN_FLATESTYRING':
8.06                    co402_verdi1:co402_verdi2);
8.06   if co402_verdi1 = '1';
8.06     u_806 = *on;
8.06   endif;
8.16  *
8.16  * Endring 8.16 Tilbudskunde
8.16  *
8.16   CallP CO402R(l_filg:w_firm:0:'FO736_707':
8.16                   co402_verdi1:co402_verdi2);
8.16   if co402_verdi1 = '1';
8.16     u_til = *on;
8.16   endif;
      *
      * Henter statusopplysninger fra STATUS-REGISTER
      *
     c     fstsl1_key    chain     fstsl1r
     c                   if        %found
     c                   eval      w_bind = faabnd
     c                   eval      w_otyp = faaoty
     c                   eval      w_aord = 1
     c                   eval      s_akun = faakun
     c                   else
     c                   eval      w_bind = 'N'
     c                   eval      w_otyp = *blank
     c                   eval      w_aord = 1
     c                   eval      s_akun = 0
     c                   endif
6.2k  *
6.2k  * Henter statusopplysninger fra STATUS-REGISTER kasse
6.2k  *
6.2k c     bstsl1_key    chain     bstsl1r
      *
      * Henter statusopplysninger fra BRUKER-REGISTERENE
      *
     c                   eval      ausrl1_user = l_user
6.23 c     ausrl1_key    chain     ausrl1
6.23 c                   if        %found(ausrl1)
     c                   eval      s_avde = absavd
3.39 c                   eval      s_lage = ablagr
     c                   else
     c                   eval      s_avde = 0
3.39 c                   eval      s_lage = 0
     c                   endif
      *
     c                   eval      fusrl1_user = l_user
6.23 c     fusrl1_key    chain     fusrl1
6.23 c                   if        %found(fusrl1)
     c                   eval      w_vref = fbvref
     c                   eval      w_selg = fbselg
     c                   eval      w_bind = fbbind
     c                   if        fbotyp <> *blank
     c                   eval      w_otyp = fbotyp
     c                   endif
     c                   eval      w_cord = fbcord
5.20 c                   eval      w_ko12 = fbko12
     c                   else
     c                   eval      w_vref = *blank
     c                   eval      w_selg = 0
     c                   eval      w_cord = 0
5.20 c                   eval      w_ko12 = 0
     c                   endif
      *
      * Henter leveringstype fra avdeling
      *
     c                   eval      ra07l1_gkod = s_avde
     c     ra07l1_key    chain     ra07l1
     c                   if        %found
     c                   eval      s_lety = raglty
     c                   endif
      *
      * Legger inn dagens dato
      *
     c                   time                    w_udat
     c     *dmy          move      w_udat        w_odat
5.53  *
5.53  * Hent mva % for beregning av memosaldo inkl. mva
5.53  *
5.53 c                   eval      w_stat = *blank
5.53 c                   eval      w_mvak = '3'
5.53 c                   time                    w_date
5.53  *
5.53 c                   call      'RS205R'
5.53 c                   parm                    w_stat
5.53 c                   parm                    w_mvak
5.53 c                   parm                    w_mvtx
5.53 c                   parm                    w_date
5.53 c                   parm                    w_mvas
5.53 c                   parm                    w_mvat
5.53 c                   parm                    w_mvaf
5.53 c                   parm                    w_bpro
      *
6.23  * Firmastyrt validering av utvalgte felter
6.23  *
6.23  *
6.23 c                   eval      avall1_apgm = 'FO100R'
6.23 c     avall1_key    setll     avall1
6.23 c     avall1_key    reade     avall1
6.23 c                   dow       not %eof(avall1)
6.23 c                   if        avaflt = 'FOVREF'  and
6.23 c                             avaval = 1
6.23 c                   eval      u_vref = *on
7.01 c                   eval      *in70 = *on
6.23 c                   endif
6.23 c                   if        avaflt = 'FODREF'  and
6.23 c                             avaval = 1
6.23 c                   eval      u_dref = *on
7.01 c                   eval      *in71 = *on
6.23 c                   endif
6.23 c                   if        avaflt = 'FOLDAT'  and
6.23 c                             avaval = 1
6.23 c                   eval      u_ldat = *on
7.01 c                   eval      *in72 = *on
6.23 c                   endif
6.30 c                   if        avaflt = 'FODDAT'  and
6.30 c                             avaval = 1
6.30 c                   eval      u_ddat = *on
7.01 c                   eval      *in73 = *on
6.30 c                   endif
6.23 c                   if        avaflt = 'FONAVN'  and
6.23 c                             avaval = 1
6.23 c                   eval      u_navn = *on
7.01 c                   eval      *in74 = *on
6.23 c                   endif
6.23 c     avall1_key    reade     avall1
6.23 c                   enddo
7.01  *
7.01 c                   if        faakjk = 1
7.01 c                   eval      *in75 = *on
7.01 c                   endif
7.01  *
7.01 c                   if        faalds = 1
7.01 c                   eval      *in72 = *on
7.01 c                   endif
7.16  *
7.16  *   Hent inn % utvidelse av kreditgrense
8.05 c*                  eval      afpslr_ufil = l_filg
8.05 c*                  eval      afpslr_uide = 'KRGRNSUTV'
8.05 c*    afpslr_key    chain     afpslrr
8.05 c*                  if        %found(afpslr)
8.05 c*                  movel     afudss        w_utvgrns
8.05 c*                  endif
7.16  *
7.16  *   Hent inn ant dager fram ordre skal med i memosaldo
8.05 c*                  eval      afpslr_uide = 'MEMODAGER'
8.05 c*    afpslr_key    chain     afpslrr
8.05 c*                  if        %found(afpslr)
8.05 c*                  movel     afudss        w_3x
8.05 c*                  move      w_3x          w_memodagr
8.05 c*                  endif
7.01  *
8.015 * Utvidet memosaldo
8.05  *   Hent inn ant dager fram ordre skal med i memosaldo
8.05  *   Hent inn % utvidelse av kreditgrense
8.05  *
8.05 c                   eval      w_memodagr = 999
8.05 c                   eval      w_utvgrns  = 0
8.05  *
8.05   CallP CO402R(l_filg:w_firm:0:'UTVIDET_MEMOSALDO':
8.05                    co402_verdi1:co402_verdi2);
8.05   if co402_verdi1 = '1';
8.05     u_kmem = *on;
8.05     if  %subst(co402_verdi2:1:3) <> *blank;
8.05       w_memodagr = %dec(%subst(co402_verdi2:1:3):3:0);
8.05     endif;
8.05     if  %subst(co402_verdi2:133:2) <> *blank;
8.05       w_utvgrns = %dec(%subst(co402_verdi2:133:2):2:0);
8.05     endif;
7.05   endif;
7.16  *
7.24 c                   time                    w_mdato
7.24 c     *ymd          move      w_mdato       p_dato
7.24 c                   time                    w_mtime
7.24 c     *hms          move      w_mtime       p_time
7.30  *
7.30  *    Sjekk om 'Pakkseddel' og om bruker kan endre tekst
7.30  *
7.30  * PAKK_TEKST_ENDRE_OM_IKKE_TILGANG
7.30  *
7.30   CallP CO402R(l_filg:w_firm:0:'PAKK_TEKST_ENDRE_OM_IKKE_TILGANG':
7.30                    co402_verdi1:co402_verdi2);
7.30   if co402_verdi1 = '1';
7.30     w_tekst_pakk = 'J';
7.30   endif;
7.30  *
7.30 c                   eval      fohel1_numm = p_numm
7.30 c                   eval      fohel1_suff = p_suff
7.30 c     fohel1_key    chain     fohel1
7.30  *
7.30  * Hent opplysninger fra ordretype-register
7.30  *
7.30 c                   eval      votyl1_otyp = footyp
7.30 c     votyl1_key    chain     votyl1
7.30  *
7.30  * Sjekk, oppdaterer denne akkumlatoretypen "memosaldo"
7.30  *
7.30 c                   if        vaoakk >= 2
7.30 c                             and  w_tekst_pakk = 'J'
7.30 c                   eval      w_pakk_sperr = 'J'
7.30 c                   endif
7.30  *
6.23  *
     c                   endsr
      *
**     M e l d i n g e r
Det er ikke tillatt å endre pakkseddel, bruk vise.<---
Oppretting av kunder er ikke tilgjengelig
Lev adr må fylles ut,eller kryss Lev adr=Fakt adr
