# RE600R – Saldobalanse til PC (Parameter Validation and Initialization)

## Overview

This program, **RE600R**, is part of the ASOKON system and is responsible for validating and initializing parameters for generating a trial balance (saldobalanse) for export to PC or other subsystems. The program is typically called as a pre-processor to gather and validate user input before running a financial report, ensuring that all required fields are correct and consistent. It interacts with display file `RE600D` for user input and calls validation routines for department codes.

## Main Responsibilities

- **Display and collect user parameters** for the trial balance report via a workstation file.
- **Validate input fields** such as date, fiscal year, period, department codes, and summary codes.
- **Initialize parameters** based on the calling subsystem (PC, FINA, TOTA, etc.).
- **Prepare and return validated parameter values** to the calling program.

## Structure and Flow

### 1. File Declarations

- `re600d` is defined as a workstation file (`workstn`), used for user interaction.

### 2. Data Definitions

- **Parameter fields** (e.g., `pfirm`, `pnavn`, `puser`, `pdato`, etc.) are used to store the values passed to or from the calling program.
- **Local variables** (e.g., `l_user`, `l_firm`, `l_fnav`) are mapped to specific positions in the user space, likely passed from the calling environment.
- **Work fields** (e.g., `w_aar`, `w_mnd`, `w_in03`, `w_syst`) are used for calculations and subsystem identification.
- **Flags and status variables** (e.g., `p_stat`, `p_gkod`, `p_gtxt`) are used for validation and inter-program communication.

### 3. Main Logic

#### Input Loop and Field Validation

- **Display Format:** The program displays the `a2bld` format for user input.
- **Indicator Reset:** Indicators 31–36 are reset before validation, used for field error highlighting.
- **Exit Handling:** If the user triggers function key C (`*inkc`), the program sets an exit flag and jumps to cleanup.
- **Date Validation:** If no date is entered, it defaults to the current system date (`udate`). The date is validated; if invalid, input is re-displayed.
- **Fiscal Year Validation:** Checks that the entered year is not in the future.
- **Period Validation:** Ensures that the period is within a valid range (1–13).
- **Department Code Validation:** If a single department is specified (`a2pavf = a2pavt`), the code is validated by calling program `RS707R`. If not valid, an error is flagged.
- **Summary Code Validation:** Checks that summary codes (`a2pspl`, `a2psal`) are either 'N' or 'J'.

#### Parameter Assignment

- Once all validations pass, the program assigns the validated and derived values to the output parameters, which are returned to the caller.

#### Program End

- The program sets the last record indicator (`*inlr = *on`) and returns.

### 4. Initialization Subroutine (`*inzsr`)

- **Parameter List:** Accepts subsystem identifier (`w_syst`) and a flag (`w_in03`).
- **Subsystem Identification:** Sets corresponding indicators (13–18) based on the subsystem (e.g., 'PC  ', 'FINA', 'TOTA', 'MAES', 'MAX ', 'AKEL').
- **Default Date:** Sets the processing date to the current system date.
- **Period Calculation:** Determines the default fiscal year and period based on the current date. If the current month is January, it rolls back to December of the previous year.
- **Default Values:** Sets default values for department range and summary codes.

## Business/Domain-Specific Logic

- **Department Validation:** Calls program `RS707R` to validate department codes. This is a business rule ensuring only valid departments are reported.
- **Period/Year Handling:** Enforces accounting period and year rules specific to the Norwegian fiscal calendar (periods 1–13).
- **Summary Codes:** The codes 'J' (Yes) and 'N' (No) for summary options are specific to the reporting requirements.
- **Subsystem Adaptation:** The initialization routine adapts the program's behavior based on the calling subsystem, supporting integration with multiple modules (PC, Finance, etc.).

## Design Patterns and Conventions

- **Indicator Usage:** The code uses indicators for field-level error reporting and for controlling display file behavior, following traditional RPG/400 conventions.
- **Tag/Goto Structure:** The code uses tags (`a2taga`, `slutt`) and `goto` statements for error handling and control flow, a common pattern in legacy RPG.
- **Parameter Passing:** Input and output values are passed as parameters, supporting modular integration with other programs.
- **Hardcoded Field Mapping:** Many fields are mapped to specific positions in the user space, reflecting integration with a broader system or data area.

## External Interactions

- **Display File (`RE600D`):** Used for user input and error display.
- **Department Validation Program (`RS707R`):** Called to check the validity of a department code, returning status and description.
- **System Date/Time Functions:** Uses system variables like `*year`, `*month`, and `udate` for defaulting and validation.

## Noteworthy Implementation Details

- **Error Feedback:** Field-specific error indicators are used to provide immediate feedback to the user, requiring correction before proceeding.
- **Flexible Subsystem Support:** The initialization routine allows the same program to be reused across different modules, reducing duplication.
- **Default Handling:** The program is robust against missing or incomplete input by providing sensible defaults, minimizing user errors.
- **Legacy Practices:** The code follows traditional RPG/400 practices, including indicator-based logic and explicit field mapping, which may differ from modern ILE RPG conventions.

## Summary

**RE600R** acts as a robust front-end parameter validator and initializer for trial balance reporting, ensuring data integrity before report generation. Its design allows for flexible integration with various subsystems and enforces strict business rules regarding fiscal periods, departments, and summary options. The modular structure, use of external validation, and detailed error handling reflect domain-specific requirements and legacy RPG programming standards.