# RPG Program: RK656R – Printing Payment Reminder Notice with Bank Giro (A4)

This program is a classic IBM i (AS/400) ILE RPG program. Its purpose is to generate payment reminder notices, including bank giro slips, typically for customers with overdue invoices. The output is intended to be printed on A4. The code is meticulously documented and structured with subroutines, file declarations, work fields, and business logic.

## High-Level Flow

- **Initialization**: Set up keys, parameters, and read in various code texts and company-related info.
- **Main Processing Loop**: For each customer transaction record, group and summarize by customer, calculate totals, penalties (interest/gebyr), and prepare the print-out.
- **Subroutines**: Handle customer changes, print endings, compute penalties, manage overflow, process customer invoices, and prepare the giro (KID) number.

---

## Key Sections Explained

### 1. **File Declarations (`F` specs)**

Various files are loaded using if/uf specs, and renamed so that the program can have meaningful references to their record formats:

```rpg
frkwbl2    if   e           k disk    rename(rkwbpfr:rkwbl2r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
...
frk656p    o    e             printer infds(d_infds)
```

- Input (`i`) and update (`u`) files for customers, accounts, formulas, etc.
- The output is to a printer file (`frk656p`).

---

### 2. **Working Fields and Data Structures (`D` specs)**

- **Arrays**: To store multi-language headings (`btab`, `ktab`, etc.) and general texts (`fo1`...`fo15`).
- **Data structures**: Used for parsing and building formatted lines, managing LDA (Local Data Area), "KID" (customer/invoice reference for Norway), and printer info.
- **Variables**: For holding customer numbers, firm numbers, addresses, totals, etc.

Examples:
```rpg
d akr             s              1    dim(9)
d btab            s             12    dim(5)
...
d                 ds
d for01                         79
d  forb                         12    overlay(for01:5)
```

---

### 3. **Key Lists and Initialization**

Key lists (`klist`) are defined for each physical file, containing the fields needed to access records via `CHAIN`, `SETLL`, etc.

Example:
```rpg
c     rkwbl2_key    klist
c                   kfld                    w_firm
...
c     ra16l1_key    klist
c                   kfld                    w_firm
c                   kfld                    ra16l1_pkod
```

---

### 4. **Main Loop (Processing Transactions)**

The main loop reads through the transaction file (`rkwbl2`), and processes each transaction, grouping and breaking by customer.

#### Key Activities:

- **Break on customer number**: When the customer number changes, subtotal, print, and reset.
- **Aggregate sums**: For each invoice line, sums overdue, interest, and other totals.
- **Check whether to calculate penalties**: Interest and fees are computed depending on flags and codes.
- **Write Line**: Output the invoice/transaction line, trigger subroutines to handle possible page overflow.

Example:
```rpg
c     rkwbl2_key    setll     rkwbl2
c     rkwbl2_key    reade     rkwbl2
c                   dow       *in60 = *off
...
c                   write(e)  d1det
c                   exsr      overflow
...
c     rkwbl2_key    reade     rkwbl2
c                   enddo
```

---

### 5. **Subroutine Structure (`BEGSR`/`ENDSR`)**

- `ny_kund` – Handles setup when new customer encountered: reads customer master, sets up addresses, language, interest rates, etc.
- `brd_kund` – Handles print and subtotal actions on customer break.
- `skr_post` – Prepares and posts the calculated interest and/or fee.
- `beh_gebyr` – Computes the fee (gebyr), possibly with currency conversion if necessary.
- `beh_rente` – Computes the interest charge (rente), again possibly with currency conversion.
- `skr_slut` – Handles the printing of summary/ending lines for the notice, including the giro slip and bank details.
- `xprint` – Does the actual formatted printing of the giro/payment stub (bank slip).
- `klargj` – Initial read and setup of multi-language forms/texts, gets starting numbers, account codes, etc.
- `leslin` – Reads "formula" texts for different languages and lines from a code table.
- `xkidd` – Builds the "KID" number (standard Norwegian bank/customer reference), calculates check digit, and updates relevant records.
- `overflow` – Checks for page overflow, increments page number, writes new header if needed.
- `*inzsr` – Initial program setup after entry (like a constructor).

Example:
```rpg
c     skr_post      begsr
...
c                   endsr
```

---

### 6. **Interest/Fees Calculation**

- The code determines if the customer or invoice is interest-bearing, based on customer master and code tables.
- Converts amounts as needed (different currencies).
- Applies minimum thresholds for charging interest/fees.

```rpg
c                   if        ppros > 0
c                   exsr      beh_rente
c                   endif
...
c                   eval(h)   w_rent = w_rgrl * ppros / 12 / 100 * w_pmti
```

---

### 7. **Multilingual Support**

- Arrays `btab`, `ktab`, `dtab`, etc. hold header and label texts in up to 5 languages.
- Subroutines `klargj` and `leslin` read and populate these arrays from a code table.

---

### 8. **OCR/KID Handling (Bank Slip References)**

- **KID generation (`xkidd`):**
  - Constructs the KID string according to standards (adds customer, invoice, company IDs).
  - Calls an external program to generate/modulus-10 check digit (`AK720R`).
  - Updates output variables and references.

---

### 9. **Printing Logic**

- Output is structured in terms of print file formats: header, detail, totals, and payment slip.
- Handles formatting for different printer types (OCR, non-OCR, etc.).
- Carefully manages page overflow and prints headers when needed.

---

## Special Considerations

- The program contains logic for a number of business rules:
  - Minimum number of reminders before including late fee/interest.
  - Skipping certain types/codes for interest calculation.
  - Adapting to customers in different countries (currency, language, bank details).
  - Printing different notice texts and forms based on language and company settings.
- Handles Norwegian specifics: KID (OCR reference), DMY date format, multi-language text, local late payment regulations.
- Heavy use of overlays and data area management, typical of RPG in this era.

---

## Glossary

- **KID**: Customer identification number, used in Norway for payment reconciliation.
- **GEBYR**: Fee.
- **RENTE**: Interest.
- **BUNT**: Batch (of accounting entries).
- **BILAG**: Voucher.
- **OCR**: Optical character recognition (for payment slips).
- **PURRING**: Reminder.

---

## Onboarding Tips

- **Understand the data files** used – which fields are keys, which are amounts, how codes (routines, language, etc.) affect calculation.
- **Study the subroutines**, as most business logic is there.
- **Note** the program outputs directly to a printer file with formatting logic distributed across the subroutines.
- **External programs called** (e.g., `AK720R`, `AK700R`, `RS701R`, `RØ707R`) perform KID calculation, account lookups, etc.
- **Look for language/country customizations** especially around currency, giro slip, and textual output.
- Comments (Norwegian/English) are highly informative and often key to understanding business rules.

---

## Diagram: Main Processing Flow

```plaintext
[Initialization (*INZSR)]
        |
        v
[klargj] - Read code texts, account info, etc.
        |
        v
[Main Loop: per transaction]
        |
        +---> [Customer break?] -- Yes --> [brd_kund]
        |                                 |
        |                                 v
        |                         [ny_kund] - Setup for new customer
        |
        v
[Sum amounts, check codes, calculate penalty (if applicable)]
        |
        v
[Write detail line, check overflow]
        |
        v
[Next transaction...]
        |
        v
[After last transaction: slutt]
        |
        +---> [Final printout, update batch/notice numbers, finish]
```

---

## Conclusion

This program is a robust and comprehensive solution for batch-producing payment reminders with legal and accounting support for Norwegian customers. It is highly parameterized for multilingual and multi-company use, and is carefully structured to support key business processes around debt collection and accounting on IBM i systems. New developers should start with the "happy path" for a single customer and trace through the subroutines for that flow, then circle back to understand how multilingual and multi-country details are handled.