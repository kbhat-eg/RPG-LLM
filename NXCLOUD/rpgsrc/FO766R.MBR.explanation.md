# Explanation of RPG Source Code

This RPG program, named `FO766R`, is designed for IBM i (AS/400) systems. Its purpose is to update order lines (`ordredetaljer`) based on data from order headers (`ordrehode`) for a specific item (`vare`). The code is written in RPG/400 (RPG III or early RPG IV, before fully free format). Below is a breakdown of the program's structure and logic for easier onboarding.

---

## Header Section

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Specifies compile options: disables debug I/O and sets date format to `day/month/year`.

---

## Program Description and History

The large comment block at the top documents:
- System, program name, and description (in Norwegian).
- Change history: e.g., logging added, price group field expanded, etc.

---

## File Specifications

```rpg
ffohel1    uf   e           k disk    rename(fohepfr:fohel1r)
ffodtlu    uf   e           k disk    rename(fodtpfr:fodtlur)
ffodtlv    if   e           k disk    rename(fodtpfr:fodtlvr)
```
- Declares three disk files:
  - `fohel1` (order header)
  - `fodtlu` (order lines, update mode)
  - `fodtlv` (order lines, input mode)
- Files are renamed locally for this program.

---

## Data Definitions

### Parameters

```rpg
d p_firm          s                   like(fdfirm)
d p_vare          s                   like(fdvare)
```
- `p_firm`: Input parameter, company/firm number.
- `p_vare`: Input parameter, item number.

### Working Variables

Several working variables for holding company, counters, keys, job logging, etc:
```rpg
d w_firm          s                   like(fdfirm)
d w_anta          s              8  0      // Counter for updated lines
d w_kode          s              1
d w_fell          s              6
...
d w_jtext         s            200          // Job text
d w_jtxt          s             35          // Job text (short)
...
d b_oppd          s              1    inz(*off) // Boolean: updated?
```

### Key Structures

For reading/updating records, keys for each file are laid out:
```rpg
d fodtlv_vare     s                   like(fdvare)
d fodtlu_numm     s                   like(fdnumm)
...
d fohel1_numm     s                   like(fonumm)
```
- These hold key fields for reading specific records.

### User Data Area

```rpg
D                UDS
6.10 d l_user                911    920
D  DSSFIR               944    946  0
```
- **UDS** refers to the User Data Structure, often used for user/job info.

---

## Main Program Logic

### Initial Setup (*INZSR Subroutine)

- **Parameter Loading**: Receives `p_firm` and `p_vare`.
- **Key Lists**: Sets up key lists for file access.
- **Initialize Variables**: Company/firm assignment, logging initialization, and job start logging. Calls external programs (`AS100R`, `AB700R`, `AB705R`) for logging and job control.
- **Purpose**: Documents that the job is starting, for audit/logging.

---

### Main Processing Loop

#### 1. **Set Up for Order Line Reading**

```rpg
c                   eval      fodtlv_vare = p_vare
c     fodtlv_key    setll     fodtlv
c     fodtlv_key    reade     fodtlv
```
- Starts reading order lines (`fodtlv`) for the specified item (`p_vare`) using the key.

#### 2. **Process Each Order Line**

```rpg
c                   dow       not %eof(fodtlv)
```
- Loops through all order lines for the item.

**For each order line:**
- **Read Header:** Get corresponding order header from `fohel1` using keys (`fdnumm`, `fdsuff`).
- **If Header Found:**
  - **Read Order Line (update file):** Find and lock the order line record in `fodtlu`.
  - **If Order Line Found:**
    - **Determine Updates Needed:**
      - If the department (`fdavde`) is different in the line vs. the header, update it.
      - If the customer number (`fdkund`) is different or header's customer number is not zero, update it.
      - Set `b_oppd` to indicate an update is needed.
    - **If Update Needed:**
      - Set audit fields (`fdedat`, `fdetim`, `fdeusr`) to timestamp and user.
      - Update the order line (`update fodtlur`).
      - Increment counter (`w_anta`).
    - **If No Update Needed:**
      - Unlock the record (`unlock fodtlu`).

#### 3. **Next Record**

```rpg
c     fodtlv_key    reade     fodtlv
```
- Reads the next line and continues loop.

---

### Program End and Logging

After all order lines are processed:
- **Log Completion:**
  - Set status and descriptive text about how many lines were updated.
  - Call external programs (`AB705R`, `AB710R`) for logging and finalization.

- **End the Program:**

```rpg
C                   SETON                                        LR
C                   RETURN
```
- Sets last record indicator and returns.

---

## Subroutines

### *INZSR (Initialization Subroutine)

- **Receives Parameters**
- **Prepares Key Structures**
- **Logs Start of the Job**
- **Calls Job Control/Logging Programs**
- Used to initialize state and document that the job has begun.

---

## External Program Calls

- **AS100R, AB700R, AB705R, AB710R**: These are likely company-standard programs for logging, audit trails, job tracking, etc.

---

## Business Purpose

- **Mass Update:** Updates order lines for a given item (`vare`) across one company (`firm`) to reflect changes from the order header, but only if necessary.
- **Audit-Friendly:** Heavily logs job start, completion, and results for traceability.
- **Efficient/Selective Update:** Only updates order lines if values would actually change.

---

## Key Points for Onboarding

- **Input**: Company number and item number.
- **Main Task**: Find all order lines for the item, for this company, and update line fields from their headers if needed.
- **Cross-References**: Be familiar with what fields like `fdavde`, `foavde`, `fdkund`, and `folkun` mean in your business context.
- **Logging**: Job statistics and results are written by calling external job management programs.

---

## Summary Table

| Section                 | Function                                                    |
|-------------------------|-------------------------------------------------------------|
| File Declarations       | Defines and renames order header and line files             |
| Parameter Input         | Receives company and item numbers                           |
| Initialization (*INZSR) | Prepares keys, initializes variables, logs job start        |
| Main Loop               | For all order lines for the item:                           |
|                         | — Read header, compare/update line if needed                |
|                         | — Only update if values change                              |
|                         | — Count and log each update                                 |
| End Routine             | Logs summary, finalizes and ends program                    |

---

## Final Notes

- Comments and variable names are largely in Norwegian.
- Standard IBM i program structure: parameter reception, setup (`*INZSR`), main logic, and clean up.
- If you’re new to this style, focus first on understanding the files, the key fields, and how updates are made only when necessary. The logging routines may be standard across your company.

---

**This program is an example of a batch update utility, designed for reliability, selectivity (no unnecessary updates), and strong traceability via external logging calls.**