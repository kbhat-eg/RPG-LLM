# FO915R – Documentation

## Overview

**Program:** FO915R  
**Purpose:** Printout of quotations ("Utskrift av Tilbud")  
**Domain:** Sales/Order Management  
**Key Outputs:** Formatted quotation printouts, optionally for email delivery  
**Key Features:**  
- Handles multiple VAT rates and discount schemes  
- Integrates with customer, product, and company master data  
- Supports dynamic output formatting (company/department info, phone/fax/mobile, custom texts, etc.)  
- Robust handling of line types (product, text, comments)  
- Email integration for output delivery

---

## Files and Data Sources

The program interacts with several physical files, all renamed for local clarity:

- **FPSOL1** (Order summary)
- **FSTSL1** (Order status)
- **VOTYL1** (Order type)
- **VLTYL1** (Line type)
- **VPKOL1** (Price code)
- **FOHEL1** (Order header)
- **FODTL1** (Order detail lines)
- **FOTXL1** (Order text lines)
- **VVARL1** (Item master)
- **RKUNL1** (Customer master)
- **AFORL1** (Formular register)
- **RA09L1** (Salesperson master, for mobile number lookup, version 6.20+)

**Output:**  
- **FO915P** (Printer file for the formatted quotation output)

---

## Major Data Structures

### Arrays for VAT Handling (6.12+)

- `mko(9)`: VAT code
- `msa(9)`: VAT rates (5.2)
- `mgr(9)`: Gross amounts (11.2)
- `mbe(9)`: Calculated VAT amounts (11.2)
- `mog(9)`: Order discount base (11.2)
- `mor(9)`: Order discount amount (11.2)

### LDA (Local Data Area) Fields

- `l_prfi`: Company/department info print control (5.41+)
- `l_ruti`: Routine code
- `l_outq`: Output queue (for email detection, 5.01+)
- `l_alin`: Number of lines per page
- `l_firm`: Company number

### Parameters (Entry List)

- `p_mail`: Output as email flag
- `p_kund`: Customer number
- `p_kpro`: Customer project number (5.61+)
- `p_numm`: Order number (6.nu+)
- `p_selg`: Salesperson number (5.02+)

---

## Key Business Logic

### 1. Initialization

- Loads company, order, and customer context from input and LDA.
- Initializes VAT arrays and accumulators.
- Determines if output should be emailed (based on `l_outq`).

### 2. Main Processing Loop

The program processes input records based on the `FKSKOD` field, which determines the record type:

- `'H'`: **Order Header** (`TAG01`)
- `'V'`: **Product Line** (`TAG02`)
- `'K'`: **Text/Comment Line** (`TAG03`)

Each tag branches to distinct logic for handling that record type.

---

### 3. Order Header Handling (`TAG01`)

- Loads order header and related customer data.
- Handles swapped customer info if the offer is for a different customer than the order.
- Retrieves company/department info if configured.
- Calls external programs for:
  - Customer contact info (`FØ710R`)
  - Company/department details (`FØ707R`)
  - Payment terms (`FØ703R`)
- Handles email parameter population if printing to email.
- Prepares and writes report headings (`A1HDR`, `A2HDR`, `A4HDR`).

#### Notable Features

- **Mobile Number Override:** If a mobile number is present in the order header, it overrides the customer master (5.21+).
- **Company/Department Switch:** If `l_prfi` is set, switches to department info for heading (3.12, 5.41+).
- **Dynamic Field Population:** Fields for address, reference, delivery method, etc., are only populated if present.

---

### 4. Product Line Handling (`TAG02`)

- Loads order detail line, determines line type.
- Skips certain line types based on business rules (order type validation).
- Loads product master data for line item.
- Handles pricing, discounts, and VAT calculations:
  - **Line Discount:** Calculates combined line discount from two possible sources.
  - **Order Discount Base:** Accumulates eligible lines for later order-wide discount calculation.
  - **VAT:** Calls external program (`RS205R`) to determine VAT rate and calculates VAT per line.
  - **VAT Array:** Populates/updates VAT arrays for reporting multiple VAT rates on a single order (6.12+).
- Prepares and writes product line to report (`D1DET`).
- Handles additional text lines if present (`D2DET`, `D1DET2`).

---

### 5. Text/Comment Line Handling (`TAG03`)

- Loads associated text line from `FOTXL1`.
- Skips lines with high line numbers unless in "accumulation" mode.
- Writes comment line to report (`E1DET`).

---

### 6. Totals and Order Discount Handling (`T1TOT` etc.)

- Calculates net total, applies order-wide discount if applicable.
- Handles VAT totals, supporting multiple VAT rates.
- Writes totals and VAT breakdown to the report (`T1TOT`, `T1TOT2`, `T1TOT3`).
- Handles page overflow and ensures proper heading placement.

---

### 7. Subroutines

- **SBBETB:** Retrieves payment terms text via `FØ703R`.
- **XOVRFL:** Handles page overflow (writes transfer lines, new headers).
- **XARRAY:** Updates VAT arrays for each VAT code encountered (6.12+).
- **XSTRSR:** Program startup logic (loads company/order context, resets accumulators).
- **INZSR:** Program initialization (parameter handling, LIKE definitions, key list setup).

---

## Integration Points

- **Customer, Product, and Company Masters:** For dynamic heading and contact info.
- **Order and Line Type Masters:** For business rule validation and text translation.
- **External Programs:**
  - `FØ703R`: Payment terms text
  - `FØ707R`: Company/department info
  - `FØ710R`: Customer contact info (phone, fax, mobile)
  - `RS205R`: VAT rate lookup and calculation

---

## Notable Design Decisions / Patterns

- **Extensive Use of External Programs:** Business logic for payment terms, VAT, and contact info is modularized into callable programs, supporting reuse and central maintenance.
- **Dynamic Data Population:** All address and heading fields are populated conditionally, supporting flexible output formats.
- **VAT Array Handling:** The use of arrays for VAT codes, rates, and bases allows the system to report on multiple VAT rates per order, supporting complex fiscal requirements (6.12+).
- **Email Integration:** Output queue logic enables seamless switch between print and email delivery, with subject auto-generation (5.01+).
- **Comprehensive Key List Management:** All file access uses well-defined key lists, ensuring consistent and maintainable database access patterns.

---

## Conventions and Versioning

- **Change Log:** Extensive in-source change log documents enhancements, bug fixes, and business-driven changes.
- **Field Naming:** Local variables prefixed by context (`w_` for work, `p_` for parameter, etc.).
- **Format Naming:** Output formats (`A1HDR`, `A2HDR`, etc.) are documented and mapped to report sections.
- **Conditional Logic:** Use of indicators and field-based flags for optional data and output control.

---

## Summary

FO915R is a robust, highly integrated program for generating formatted quotations. It leverages modular business logic, supports complex pricing and VAT scenarios, and adapts output to both print and email. The codebase emphasizes maintainability, flexibility, and compliance with evolving business requirements. New developers should familiarize themselves with the external program interfaces, the VAT array logic, and the conventions for dynamic data population and conditional output.