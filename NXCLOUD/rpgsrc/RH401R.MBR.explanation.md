```markdown
# Program RH401R – General Ledger Record Deletion

This RPG ILE program cleans up old general-ledger (hovedbok) detail and summary records for a single company (firm) in the ASOKON system. Records with year (`RAAR`) less than a cutoff (`D_RAAR`) are deleted.

---

## 1. File Declarations

- **rhtrl1 / rhtrlur**  
  ‑ Detail records (input and update access) from physical file `RHTRPFR` renamed to `RHTRL1R` / `RHTRLUR`.  
- **rzuml1 / rzumlur**  
  ‑ Summary records (input and update) from physical file `RZUMPFR` renamed to `RZUML1R` / `RZUMLUR`.

Each file is defined with externals and keyed access.

---

## 2. Data Declarations

### 2.1 Record-field Copies

For each update file (`RHTRLUR`, `RZUMLUR`) we define work-fields to build keys:

- **Detail key fields** (`RHTRLU_*`):  
  • RAAR (Year), KONT (Account), SPES (Special), AVDE (Dept), RPER (Period), BDAT (Date), TIST (Time)  

- **Summary key fields** (`RZUMLU_*`):  
  • RAAR (Year), BILN (Batch-number), BDAT (Date), TELL (Sequence)  

### 2.2 Local Data Area (UDS)

Offset 300–303:  
  • `D_RAAR` – Cutoff year (records older than this will be deleted)  
Offset 944–946:  
  • `L_FIRM` – Company (firm) number for filtering  
Offset 951–980:  
  • `L_FNAV` – Company name (not used in logic here)

Work field:  
  • `W_FIRM` – Holds `L_FIRM` before each file scan

---

## 3. Main Processing Logic

1. **Set Company Filter**  
   ```rpg
   EVAL W_FIRM = L_FIRM
   ```

2. **Detail-record Loop**  
   - Position to first detail record for the company:  
     ```rpg
     SETLL RHTRL1R       KEYLIST 90
     ```
   - Loop (`RHTRL1_LES` tag):  
     ```rpg
     READ RHTRL1R        KEYLIST 90
     IF %EOF or RB_FIRM > W_FIRM
       GOTO ZUM
     ENDIF
     ```
   - If record’s year `< D_RAAR`:  
     • Build key fields from the record into `RHTRLU_*`  
     • `CHAIN` to RHTRLUR (update file) using that key  
     • If found, `DELETE RHTRLUR`  
   - Repeat with `GOTO RHTRL1_LES`

3. **Summary-record Loop (tag ZUM → RZUML1_LES)**  
   - Position to first summary record for the company  
   - Read each record; exit on EOF or firm change  
   - If year `< D_RAAR`: build key, `CHAIN` into `RZUMLUR`, and `DELETE` if found  
   - Loop with `GOTO RZUML1_LES`

4. **Program End (tag AVSLUTT)**  
   ```rpg
   EVAL *INLR = *ON
   RETURN
   ```

---

## 4. Initialization Subroutine (*INZSR)

Runs at program start. It defines the **key lists** used by `SETLL`, `READ`, and `CHAIN`:

- **RHTRL1_KEY (90)**  
  • Key field: `W_FIRM`

- **RHTRLU_KEY (update file)**  
  • Key fields: `W_FIRM`, `RHTRLU_RAAR`, `RHTRLU_KONT`, … , `RHTRLU_TIST`

- **RZUML1_KEY (91)**  
  • Key field: `W_FIRM`

- **RZUMLU_KEY (update)**  
  • Key fields: `W_FIRM`, `RZUMLU_RAAR`, `RZUMLU_BILN`, … , `RZUMLU_TELL`

This ensures all file operations use the correct sort sequence and filtering on `W_FIRM`.

---

### Summary

- **Purpose**: Delete GL detail & summary records older than a specified year for one firm  
- **Mechanism**: Sequential reads (`READ`) with key lists, conditional `CHAIN` into the update file, and `DELETE` if record is found  
- **Control**: Year cutoff (`D_RAAR`) + firm filter (`L_FIRM`)  
- **Structure**:  
  1. Initialize key lists  
  2. Loop detail records → delete old  
  3. Loop summary records → delete old  
  4. End program  
```