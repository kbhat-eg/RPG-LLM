# Explanation of RPG Program VL718R

This RPG (Report Program Generator) program is an IBM i (AS/400, iSeries) ILE RPG program, designed to calculate the available quantity (disponibel beholdning) of a given item in stock, for a given date, in a specified unit and warehouse. The overall purpose is to return the available stock in the requested unit at a given date, factoring in current stock, open orders, and open purchase orders.

Let's break down the program and its logic.

---

## 1. Header/Metadata

- `h option(*nodebugio)` disables some debug IO
- `h datedit(*dmy)` specifies date edit for decimal-date conversions
- The header comments document versions, changes, and purposes (in Norwegian).
- **Main Purpose:**  
  Calculate available inventory at a specified date:  
  `disponibel beholdning = lagerbeholdning - i ordre + i bestilling`  
  (stock on hand - on order + on purchase order)

---

## 2. File Declarations

Each file (`F-spec`) is declared for disk access (`if e k disk`), with some using the `rename` keyword to map external PF/RF names to local names.

Examples:
- `vlagl1` = Inventory on hand by warehouse
- `vvarl1` = Item master
- `fstsl1` = Some code (not used in main logic here)
- `vvenl1`/`vvenl2` = Item units and conversions
- `fohel1`, `fodtlv` = Sales order header/lines
- `lohel1`, `lodtlv` = Purchase order header/lines
- `vltyl1` = Line type codes
- `votyl1` = Order type codes

---

## 3. Key/Variable Definitions

### Key Variables

Variables for primary and secondary keys are defined to be used with the file access operations (`chain`, `setll`, `reade`). Most variables use the `like()` to match field types with database fields, which helps keep code in sync with database definitions.

### Parameter Variables

Variables with prefix `p_` represent parameters passed to the program (company, item, unit, warehouse, date, calculation type, etc.). Output parameters are `p_behl` (available quantity) and `p_lenh` (output unit).

### Working Variables

- `w_behl` - Calculated available stock
- `w_ordr` - Quantity on customer orders
- `w_best` - Quantity on purchase orders
- `w_anta` - Temporary quantity for conversion/subroutines

---

## 4. Parameter List

At `*inzsr` (initialization subroutine), the parameter list is defined using `plist` and `parm` for all input/output parameters.

---

## 5. Main Program Logic

### Initialization

- Clears key output variables, including setting calculated stock and result parameters to zero or blanks.
- Checks if company (firm) is valid (`faalag = 1`).

### Read/Validate Item Master (`vvarl1`)
- Set company and item from parameters.
- Chain fetch from item master file.
- If not found, go to end.

### Read/Validate Warehouse Stock (`vlagl1`)
- Set warehouse, company, and item from parameters.
- Chain fetch from warehouse stock file.
- If not found, go to end.

### Check if Item is Stock Managed
- If line type (`vlvtyp`) is not 'D', 'T', or 'S' (i.e., is a stock item):
  - Set `w_behl` to stock on hand.

### Subroutine: Fetch Order and Purchase Order Requirements

#### 1. Customer Orders (`hent_ordre`)
  - Subtract sum of all open orders until the given date, for the item and warehouse.

#### 2. Purchase Orders (`hent_bestil`)
  - Add sum of all confirmed (if required) purchase orders until the given date, for the item and warehouse.

#### 3. Unit Conversion (if needed)
  - If requested output unit is not the warehouse unit:
    - Reads conversion factors from unit table (`vvenl1`)
    - Calculates conversion ratio (using volume factor) and converts available quantity to requested unit

### Set Output Parameters

- `p_behl` = final calculated available quantity
- `p_lenh` = resulting unit (either warehouse or requested)
- End program

---

## 6. Subroutines

### `hent_ordre`
- Loops through all customer order lines for this company and item.
- For each line:
  - Checks line type and order header for correct order classification
  - Skips if the order is not for the desired warehouse
  - Skips if delivery date (on line, order header, or order date) is after the requested date
  - Converts quantity if order unit is not warehouse unit (calls `omr_antall`)
  - Negates quantity if order type requires
  - Sums up total ordered quantity
- At the end, `w_ordr` contains the total ordered quantity to subtract from stock.

### `hent_bestil`
- Loops through all purchase order lines for this company and item.
- For each line:
  - Checks line type and order header for correct order classification
  - Skips if the order is not for the desired warehouse
  - Optionally (feature flag), only includes confirmed orders (`u_802 = *on`)
  - Skips if neither the confirmed nor planned delivery date is set
  - Skips if the delivery date is after the requested date
  - Converts quantity if unit is not warehouse unit (calls `omr_antall`)
  - Negates quantity if order type requires
  - Sums up total open purchase order quantity
- At the end, `w_best` contains the total purchase order quantity to add to stock.

### `omr_antall` (Unit Conversion)
- If the units match, returns immediately.
- Else, looks up conversion factors for requested unit and warehouse unit from `vvenl1`.
- Converts quantity using the ratio of volume/conversion factors.
- Sets `w_anta` to the converted value.

---

## 7. Special Features / Version History

Lines prefixed with comments (`7.02`, `8.02`, etc.) refer to enhancements and bugfixes, such as:
- Only including purchase order lines with a confirmed delivery date.
- Rounding and not converting when not necessary.
- Option to display only available purchase orders with confirmation set.
- External call to a configuration program (`CO402R`) for feature flag `u_802`.

---

## 8. Error Handling & End Routine

- If a `chain` (db fetch) fails, skips to the next logical block, or ends.
- On exit, sets `*inlr = *on` if not running interactively.

---

## 9. Data Flow Summary

1. **Inputs:** Company, item, unit, warehouse, date, calculation type
2. **Lookups:** Item master, warehouse record
3. **Calculate:**  
   - Read warehouse stock
   - Subtract open sales orders (with various date and type filters)
   - Add open purchase orders (with filters as above)
   - Convert result to requested unit, if needed  
4. **Outputs:** Available stock and unit (in param variables)

---

## 10. Key Points for Onboarding

- **Every calculation is strictly based on what's available as of a given date, honoring both orders and purchase orders.**  
- **Unit conversion is handled for both orders and output, using a conversion table.**
- **Multiple order types and line types are filtered using reference files.**
- **Feature flags and enhancements are supported via external configuration program calls.**
- **All database access is via keyed access (`chain`, `setll`, `reade`), no SQL used here.**
- **The code is written in classic "Fixed Format" RPG IV, with some RPGLE enhancements.**

---

## 11. Practical Usage

To use or debug this program:
- **Understand field mappings:** All database fields are referenced by structuresâ€”review associated PF (physical file) definitions for understanding.
- **Test with various units:** Unit conversion logic is robust but requires careful validation of master data.
- **Feature flags** (e.g., for confirmed orders) can alter business logic significantly.

---

## 12. Conclusion

This program provides a robust, date-sensitive available stock calculation, suitable for integrations, inquiries, or batch processing. Understanding its flow, key usage, and unit conversion logic is critical for maintaining or extending its functionality.