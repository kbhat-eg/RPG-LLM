# RPG Program `sr112R` â€“ ASSTAT Alternative Subgroup Selection

## Overview

This RPG program (`sr112R`) is part of the ASSTAT system and implements a subfile-driven interface for selecting, creating, updating, and deleting alternative subgroups ("alternativ undergruppe") within a given business context. The program is designed to be used from a workstation and is driven by user interactions with a subfile on the display.

The program is highly modular, with clear separation of concerns via subroutines. It interacts with several physical and logical files that represent master data and lookup tables for group and subgroup alternatives. The business domain appears to be related to maintenance of code tables or reference data, with support for multi-firm (company) operation.

## Key Files and Data Sources

- **Display File (`sr112d`)**: Provides the subfile (`b1sfl`) and control formats for user interaction.
- **Physical/Logical Files:**
    - `slpml1`, `slpmlr`, `slpmlu`: Master and update files for subgroups, with logical views for maintenance and lookup.
    - `vaugl1`: Lookup for group/subgroup descriptions.
- **Local Data Area (LDA)**: Used to retrieve firm/company number and user info.

## Main Data Structures and Variables

- **Key Fields**: Used for positioning and accessing records in the various files. These are always constructed with the current firm, type, code, and value/group.
- **Working Variables**: For subfile record numbers, page handling, and control flags (`b_forn`, `b_anul`, `b_feil`).
- **Subfile Buffer**: The subfile uses a fixed-size buffer and paging logic (`w_srrn`, `w_ssrn`, `w_spge`, etc.).
- **Constants**: For subfile page size (`c_sfil`).

## Program Flow

### Initialization (`*inzsr`)

- Sets up key lists for each file.
- Receives parameters for type and description from the calling program.
- Initializes subfile and working variables.
- Retrieves the firm number from the LDA.
- Positions to the correct place in the master file and fills the subfile with initial data.

### Main Loop

- **Display and User Input**: The main loop alternates between displaying the subfile and handling user input.
- **Function Key Handling**: Function keys are mapped to specific actions:
    - Exit (`*INKC`, `*INKL`): Ends the program.
    - Refresh (`*INKE`): Calls `forny` to refresh the subfile.
    - Create (`*INKF`): Enters the create new row routine (`xc1bld`).
    - Page Down (`*IN10`): Loads the next page of the subfile.
    - Other keys as needed for navigation and control.
- **Positioning**: Allows the user to position the subfile based on group/subgroup input.
- **Subfile Control**: Handles create and delete requests from the subfile control area.
- **Subfile Processing**: Iterates through changed subfile records, handling deletions as requested.

### Subroutines

#### `forny`
- Clears and rebuilds the subfile from the current database position.

#### `posisjoner`
- Positions the subfile based on user-specified group/subgroup values.
- Clears and rebuilds the subfile, then resets the positioning fields.

#### `control`
- Handles create (`b2valg = '1'`) and delete (`b2valg = '4'`) requests from the subfile control area.
- Validates input and sets error indicators as needed.
- Triggers subfile refresh if necessary.

#### `subfile`
- Processes user changes within the subfile.
- Handles row-level delete requests and updates the subfile accordingly.

#### `xc1bld` (New/Edit Row Screen)
- Manages the dialog for creating or editing a row.
- Handles lookup and validation against master and lookup files.
- Calls registration subroutine (`xc2bld`) for actual database update.

#### `xc1msg`
- Displays a message when the user attempts to create a row that already exists.

#### `xc2bld` (Registration Screen)
- Handles the update or creation of a subgroup record in the master file.
- Updates the subfile if a new row was created.

#### `xd1win` (Delete Dialog)
- Manages the dialog for deleting a row.
- Deletes the corresponding record from the master file and sets refresh flags.

#### `clr_subfile`
- Clears the subfile and resets all paging and record number variables.

#### `crt_subfile`
- Reads records from the master file and populates the subfile buffer up to the page size.
- Handles end-of-file and mismatches in firm/type/code.

#### `dsp_subfile`
- Displays the subfile and manages the display indicators for proper UI behavior.

## Design and Business Logic Notes

- **Multi-Firm Support**: All file accesses are keyed by firm number, supporting multi-company operation.
- **Subfile Paging**: The subfile is paged, with logic to handle loading additional records as the user navigates.
- **Key Management**: Key lists are explicitly defined and used for all file operations, ensuring consistency.
- **UI Flow**: The program uses a combination of subfile control and row-level actions, with separate dialogs for create/edit and delete operations.
- **Error Handling**: Error indicators and message screens are used to guide the user and prevent invalid operations.
- **Modularity**: Business logic is separated into well-named subroutines, following a pattern used throughout the codebase.

## Integration Points

- **External Programs**: Calls `VF511R` for group/subgroup lookup (in `xc1bld`).
- **Calling Program**: Receives parameters (type, description) from the previous program in the workflow.
- **Local Data Area (LDA)**: Reads firm and user context at startup.

## Naming and Conventions

- **Prefixes**: 
    - `b1`, `b2`: Subfile and control fields.
    - `c1`, `c2`, `d1`: Dialog/maintenance screen fields.
    - `w_`: Working variables.
    - `sr`, `vf`: Fields from the master and lookup files.
- **Subroutine Names**: Prefixed by `x` for dialogs, `dsp`/`crt`/`clr` for subfile operations, `forny` for refresh, etc.
- **Indicators**: Used extensively for function keys and error handling.

## Summary

This program provides a robust, interactive interface for maintaining alternative subgroups in the ASSTAT system. It leverages RPG's subfile and display file capabilities, with a focus on modular design and clear separation of business logic. The code adheres to established patterns for key management, error handling, and user interaction, consistent with other programs in this codebase. Integration with external programs and multi-firm support are built-in, reflecting the broader architecture of the ASSTAT system.