# RPG Program JR151R â€“ Explanation

## Overview

This RPG/400 (ILE RPG) program is part of an application system named "ASVADM". The program ID is `JR151R` and its purpose is to process a "vareregister", which can be interpreted as a product or item register, specifically handling input for parameter 2 related to reports. The system appears to be Norwegian.

### Key Features

- Reads and validates input data from a workstation display.
- Interacts with multiple physical files (`jrapl1`, `jlevl1`, `jvrcl1`, `ra30l1`).
- Calls other programs (`JR151C`, `JR152C`) for further data processing.
- Utilizes a parameter list for receiving company (`firm`), report number (`rapp`), and date.
- Handles error checking, especially on input fields and price group validation.

---

## Code Sections

### 1. File Declarations

```rpg
fjrapl1    if   e           k disk    rename(jrappfr:jrapl1r)
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
fjvrcl1    if   e           k disk    rename(jvrcpfr:jvrcl1r)
fra30l1    if   e           k disk    rename(ra30pfr:ra30l1r)
fjr151d    cf   e             workstn
```
- Four database files are declared (`jrapl1`, `jlevl1`, `jvrcl1`, and `ra30l1`) with record format renaming, plus a display file (`jr151d`).
- These files are used for company, supplier, product format, and price group lookups.

---

### 2. Parameter and Data Definitions

```rpg
d p_firm          s                   like(jrfirm)
d p_rapp          s                   like(jrrapp)
d p_dato          s               d   datfmt(*iso)
```
- Declare stand-alone fields for procedure parameters (incoming values).

```rpg
d                uds
d l_fnav                951    980
```
- Defines a User Data Section (UDS) typically used to map the local data area.

```rpg
d                 ds
d d_list                        32
d  d_firm                        3  0 overlay(d_list)
d  d_rapp                        2  0 overlay(d_list:4)
d  d_rfmt                       10    overlay(d_list:6)
d  d_dato                         d   overlay(d_list:16) datfmt(*iso)
d  d_prgr                        2    overlay(d_list:30)
```
- Defines a data structure overlaying a 32-char buffer used for passing parameters to other programs.

---

### 3. Key Variable Definitions

```rpg
d jrapl1_rapp     s                   like(jrrapp)
d jvrcl1_rfmt     s                   like(jfrfmt)
d jlevl1_ldor     s                   like(jlldor)
d ra30l1_dkod     s                   like(redkod)
```
- Variables used as keys for record retrieval (`CHAIN` operations) from the respective files.

---

### 4. Mainline Logic

#### Input Processing Loop

```rpg
c     b1taga        tag
c                   exfmt     b1bld
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   endsl
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   goto      b1taga
c                   endif
<...>
c                   call      'JR151C'
c                   parm                    b1file
c                   parm                    b1fldr
c                   parm                    b_feil
c                   if        b_feil = *on
c                   eval      *in35 = *on
c                   goto      b1taga
c                   endif
```
- Repeatedly displays a data entry screen (`exfmt b1bld`).
- Handles exit function keys (`*inkc`, `*inkl`).
- Calls subroutine to check input fields (`sjekk_input`).
- Calls an external program (`JR151C`) for further logic; if errors are detected, it returns to the input.

#### Data Packing and Batch Program Call

```rpg
c                   eval      d_firm = w_firm
c                   eval      d_rapp = b1rapp
c                   eval      d_rfmt = b1rfmt
c                   eval      d_dato = p_dato
c                   eval      d_prgr = b1prgr
c                   call      'JR152C'
c                   parm                    d_list
```
- Packs relevant fields into the data structure and calls another batch program (`JR152C`).

#### Batch Job Message and Program End

```rpg
c                   exfmt     b1sbm
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Displays a submission screen/message.
- Terminates the program.

---

### 5. Subroutine: Input Field Check (`sjekk_input`)

```rpg
c     sjekk_input   begsr
c                   eval      b_feil = *off
c                   if        b1file = *blank
c                   eval      *in31  = *on
c                   eval      b_feil = *on
c                   goto      end_sjekk
c                   endif
* Prisgruppe validation
c                   if        b1prgr <> *blank
c                   eval      ra30l1_dkod = b1prgr
c     ra30l1_key    chain     ra30l1                             46
c                   if        *in46 = *on
c                   eval      b_feil = *on
c                   leavesr
c                   endif
c                   endif
c     end_sjekk     endsr
```
- Checks if required input field `b1file` is blank.
- If price group (`b1prgr`) is entered, validates that it exists in the `ra30l1` file using `CHAIN`.

---

### 6. Subroutine: Initialization (`*inzsr`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_rapp
c                   parm                    p_dato
* Key lists for chained access
c     jrapl1_key    klist
c                   kfld                    w_firm
c                   kfld                    jrapl1_rapp
c     jlevl1_key    klist
c                   kfld                    jlevl1_ldor
c     jvrcl1_key    klist
c                   kfld                    jvrcl1_rfmt
* Price group key
c     ra30l1_key    klist
c                   kfld                    w_firm
c                   kfld                    ra30l1_dkod
* Initialization logic
c                   eval      w_firm = p_firm
c                   eval      jrapl1_rapp = p_rapp
c     jrapl1_key    chain     jrapl1                             90
c                   eval      b1rapp = p_rapp
c                   eval      b1navn = jrnavn
c                   eval      b1ldor = jrldor
c                   eval      b1rfmt = jrrfmt
c                   eval      b1file = jrfile
c                   eval      b1fldr = jrfldr
c                   eval      b1eusr = jreusr
c                   eval      b1edat = 0
c                   if        jredat <> *loval
c     *dmy          move      jredat        b1edat
c                   endif
* Other lookups if available
c                   if        b1ldor <> 0
c                   eval      jlevl1_ldor = b1ldor
c     jlevl1_key    chain     jlevl1                             90
c                   if        *in90 = *off
c                   eval      b1lnav = jlnavn
c                   endif
c                   endif
c                   if        b1rfmt <> *blank
c                   eval      jvrcl1_rfmt = b1rfmt
c     jvrcl1_key    chain     jvrcl1                             90
c                   if        *in90 = *off
c                   eval      b1rbes = jfbesk
c                   endif
c                   endif
c                   endsr
```
- Populates screen fields and other variables from files, using received parameters.
- Initializes key lists for efficient chained database lookup.

---

## Noteworthy Details

- Extensive use of **CHAIN** (random access) for validation and lookup of keys in files.
- Input validation ensures the correctness of both required values and reference data (e.g., price group).
- The program is compatible with expansions; e.g., price group field was expanded at some point (`d_prgr`).
- The code is predominantly procedural and written in **fixed-format RPG**, which is less common in new codebases but still prevalent in many IBM i shops.

---

## Summary

This program is designed as a data entry and validation module within a larger reporting and batch system, emphasizing integrity checks and proper communication between programs. It demonstrates best practices for fixed-format RPG: clean subroutine organization, structured file access, and separation between initialization, validation, and main processing logic. 

**New developers should focus on understanding file structures, parameter passing, and the role of each field in the business logic.**