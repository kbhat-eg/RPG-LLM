## Program Overview

This program, `JV881R`, is part of the ASVADM system. Its primary function is to monitor whether product data from NIB/NOBB sources has been updated in the last two days. If the data is not current, it triggers an error and sends a notification (intended for the customer service center).

### Business Context

- **NIB/NOBB**: Refer to external product data feeds, common in the Norwegian building materials sector.
- **Data Freshness**: The program ensures that data updates from these sources are timely. A failure to update within the last two days is considered an error condition.
- **Notification**: When an error is detected, a message is prepared for customer service.

---

## File Definitions

```rpg
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
fjstsl1    if   e           k disk    rename(jstspfr:jstsl1r)
```
- **afirl1**: File holding firm (company) information, renamed from `afirpfr` to `afirl1r`.
- **jstsl1**: File holding status information, renamed from `jstspfr` to `jstsl1r`.

---

## Data Definitions

- **w_dato**: Work variable of type date, used for comparison (like `jaaopd` field).
- **w_afir**: Work variable for firm key, matches the type of `jaafir`.
- **p_stat**: Status code (1 character), used to signal result ('F' = Failure, 'U' = Unknown/Setup error).
- **p_ftxt**: Message text (200 characters), holds the error or status message.
- **p_firm**: Input/output firm key.
- **p_fra**: Email sender or similar (50 characters).

---

## Main Logic Flow

### 1. Calculate Cutoff Date

```rpg
c                   time                    w_dato
c                   subdur    2:*D          w_dato
```
- Sets `w_dato` to the current date minus two days. This is the threshold for determining if the data is "fresh".

### 2. Initialize Output Parameters

```rpg
c                   eval      p_stat = *blank
c                   eval      p_ftxt = *blank
c                   eval      p_fra  = *blank
```
- Resets output parameters.

### 3. Firm Lookup

```rpg
c                   eval      w_afir = p_firm
c     afirl1_key    chain     afirl1
c                   if        %found(afirl1)
c                   eval      p_fra = aamail
c                   else
c                   eval      p_stat = 'U'
c                   goto      avslutt
c                   endif
```
- Looks up the firm in `afirl1` using the provided firm key (`p_firm`).
- If found, retrieves the email address (`aamail`) for notifications.
- If not found, sets status to 'U' (unknown/setup error) and exits.

### 4. Status Lookup

```rpg
c                   eval      w_afir = p_firm
c     jstsl1_key    chain     jstsl1
c                   if        %found(jstsl1)
c                   if        jaaopd < w_dato
c                   eval      p_stat = 'F'
c                   endif
c                   else
c                   eval      p_stat = 'U'
c                   endif
```
- Looks up the status record in `jstsl1` for the same firm.
- If found, checks if the last update date (`jaaopd`) is older than the cutoff (`w_dato`).
    - If so, sets status to 'F' (failure).
- If not found, sets status to 'U' (unknown/setup error).

### 5. Compose Notification Message

```rpg
c                   if        p_stat = 'F'
c                   eval      p_ftxt = 'Overf�ring fra NIB/NOBB' +
c                                      ' har g�tt feil hos ' +
c                                      %trim(aafnav) +
c                                      %trim(aafste)
c                   endif
c                   if        p_stat = 'U'
c                   eval      p_ftxt = 'Melding fra overf. NIB/' +
c                                      '/NOBB er feil oppsatt hos ' +
c                                      %trim(aafnav) +
c                                      %trim(aafste)
c                   endif
```
- If a failure is detected, constructs a message indicating a failed data transfer for the firm (including firm name and location).
- If a setup error is detected, constructs a message indicating a configuration error.

### 6. Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets the last record indicator and returns.

---

## Subroutine: Initialization (`*inzsr`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_fra
c                   parm                    p_stat
c                   parm                    p_ftxt
```
- Standard RPG initialization subroutine.
- Declares the program’s parameter list (firm key, from address, status, message text).
- Defines key lists for file access (`jstsl1_key`, `afirl1_key`).

---

## Design Notes & Conventions

- **Error Handling**: Uses status codes ('F' for failure, 'U' for unknown) and message text for downstream processing.
- **Key Lists**: Key lists (`klist`) are defined for file access, even though only a single field is used. This is a standard pattern in this codebase for consistency and future extensibility.
- **Parameter Passing**: The program is designed to be called by another program or job, passing parameters by reference.
- **Notification**: The actual sending of notification (e.g., email) is not handled here; this program prepares the necessary information for another component to act upon.
- **Language/Localization**: Messages are in Norwegian, as is common in this codebase.

---

## External Relationships

- **File Dependencies**: Relies on two physical files (`afirpfr` and `jstspfr`) for firm and status data.
- **Integration Point**: Expected to be part of a batch or scheduled job that checks data feeds and triggers notifications.

---

## Summary

This program is a monitoring and alerting component for NIB/NOBB data integration. It checks for recent updates, flags issues, and prepares notification messages for customer service. Its design follows established codebase conventions (key lists, parameter lists, modular error/status handling) and is intended for integration with other operational or notification modules.