# FO775R – Order Splitting by Warehouse Suffix

## Overview

This program (FO775R) is part of the ASOFAK system and is responsible for splitting order lines (`ordrelinjer`) into separate order suffixes (`suffix`) based on the warehouse (`lager`) from which items are to be picked. The main goal is to ensure that each unique warehouse on an order results in a distinct order suffix, grouping all lines for that warehouse together. The original suffix remains for the first warehouse, and new suffixes are generated for the others.

The program updates both order headers (`ordrehode`) and order lines, and ensures related records (such as purchase order lines) are kept in sync. It also logs these changes for audit purposes.

## Key Business Concepts

- **Order Suffix (`suffix`)**: Orders can have multiple suffixes, each representing a distinct "sub-order" for logistical or business reasons (here, per warehouse).
- **Warehouse Splitting**: If an order contains lines from multiple warehouses, each warehouse (except the first) gets a new suffix.
- **Text Lines**: Special handling ensures that text/comment lines attached to an item line follow the correct warehouse grouping.
- **Data Integrity**: Related records, such as purchase order lines, are updated to reflect new suffix assignments.
- **Logging**: All changes to suffixes are logged for traceability.

## File Relationships

- **VLTYL1**: Line type definitions (used to distinguish text lines from item lines).
- **FODTL1/FODTLU**: Order detail lines (read/write).
- **FOHEL1/FOHELR/FOHELU**: Order headers (read/write).
- **LODTLU**: Purchase order lines (for updating related records).
- **AS110R**: API/program to fetch the highest used suffix for an order.
- **FO700R**: API/program to recalculate order totals after splitting.
- **FU900R**: API/program to log changes.

## Main Program Flow

1. **Initialization (`*inzsr`)**: Reads input parameters (company, order number, suffix) and sets up key lists for file access.
2. **Warehouse Analysis (`sjk_splitt`)**: Scans all order lines for the given order/suffix, collects a list of unique warehouses (`a_lage`). If only one warehouse is present, no splitting is needed.
3. **Splitting (`splitt`)**: For each additional warehouse:
   - Fetches the next available suffix (via `AS110R`).
   - Writes a new order header for the new suffix.
   - Moves all order lines for that warehouse to the new suffix (including associated text lines).
   - Updates related purchase order lines, if present.
   - Deletes moved lines from the original suffix.
4. **Recalculation (`nye_summer`)**: After splitting, recalculates order totals for all affected suffixes (via `FO700R`) and logs the change (via `upd_logg` and `FU900R`).
5. **Exit**: Ends the program.

## Detailed Subroutine Explanations

### 1. `sjk_splitt` – Check if Splitting is Needed

- Iterates through all order lines for the input order/suffix.
- Builds an array (`a_lage`) of unique warehouse numbers found on the lines.
- Sets `i` to the number of unique warehouses.
- If `i > 1`, splitting is required.

**Design Note:** The warehouse array is capped at 99 entries, which should be sufficient for practical purposes.

### 2. `splitt` – Perform the Splitting

- For each warehouse beyond the first:
  - Copies the order header to a new suffix (with updated timestamps and user info).
  - For each order line:
    - Handles text lines specially: assigns them the warehouse of the preceding item line.
    - If the line matches the current warehouse:
      - Updates the suffix to the new one.
      - Updates timestamps and user info.
      - Writes the line to the new suffix.
      - If the line is linked to a purchase order, updates the corresponding purchase order line (`LODTLU`) to reflect the new suffix.
      - Deletes the original line from the old suffix.
- Ensures text/comment lines follow their associated item lines to the correct suffix.

**Design Note:** The logic for handling text lines ensures that comments or notes attached to an item line remain with their item after splitting.

### 3. `hent_suff` – Get the Next Suffix

- Calls external program `AS110R` to retrieve the highest used suffix for the order, ensuring new suffixes are unique and sequential.

**Design Note:** This decouples suffix number management from the main program, centralizing it in `AS110R`.

### 4. `nye_summer` – Recalculate Order Totals and Log

- For each suffix on the order:
  - Calls `FO700R` to recalculate order totals.
  - If the suffix is not the original, logs the change with code '2' by calling `upd_logg`.

### 5. `upd_logg` – Update the Log Register

- Prepares a log record with company, order, suffix, timestamp, user, and workstation.
- Calls `FU900R` to write the log entry.

## Notable Conventions & Patterns

- **Suffix Management**: All suffix assignment and incrementing is handled externally for consistency across the system.
- **Text Line Handling**: The program distinguishes between item and text lines using the line type file (`VLTYL1`), ensuring correct grouping after splitting.
- **Audit Logging**: All significant changes (new suffixes) are logged with rich context for traceability.
- **Parameter Passing**: Most subroutines use parameter lists or overlays for data exchange, a common pattern in this codebase.
- **Key Lists**: Keys for file operations are built in the initialization subroutine for clarity and reuse.

## File/Module Interactions

- **AS110R**: Determines the next available suffix for an order.
- **FO700R**: Recalculates order totals after splitting.
- **FU900R**: Logs changes to the order suffix/register.
- **LODTLU**: Purchase order lines are updated when their associated order lines are moved to a new suffix.

## Special Handling

- **Text Lines**: Identified via `VLTYL1`, text lines inherit the warehouse of the preceding item line to ensure they are grouped correctly.
- **Purchase Order Links**: If an order line is linked to a purchase order (via `fdbenr`), the corresponding purchase order line is updated with the new suffix to maintain referential integrity.
- **Logging**: Logging is only performed for new suffixes, not the original.

## Version History Highlights

- **6.20**: Improved handling of text lines and line types.
- **6.30**: Adjusted for order number field length expansions.
- **8.01**: Price group field expanded.
- **8.02**: Suffix retrieval delegated to `AS110R`.
- **8.03**: Updates to linked purchase order lines when splitting.

## Summary

This program is a key component for ensuring that orders with items from multiple warehouses are split into distinct suffixes, enabling clear separation for fulfillment and logistics. It maintains data integrity across related tables, supports auditability, and is robust against order structure changes (e.g., text lines, related purchase orders).

**When onboarding to this part of the codebase, pay particular attention to:**
- The handling of text lines versus item lines.
- The externalization of suffix management and logging.
- The updating of related records, especially purchase orders, to ensure consistency.

For any changes or extensions, ensure that these core patterns and data integrity rules are preserved.