# Comprehensive Documentation: JV751R – Product Pricing for Orders

## Overview

**Program Name:** JV751R  
**System:** ASVADM  
**Purpose:**  
This program determines and returns product pricing and related information for sales orders. It incorporates a complex, hierarchical business logic for calculating net, cost, and sales prices, considering various factors such as product, supplier, groupings, pricing conditions, surcharges, and freight. The logic supports multiple business scenarios, including special supplier solutions, logistics items, and multi-level price/discount/freight groupings.

---

## High-Level Process Flow

1. **Initialization:**  
   - Load parameters, clear output variables, set up keys, and prepare runtime variables.

2. **Product Lookup:**  
   - Retrieve the product from the master file. If not found, set status and exit.

3. **Product Details:**  
   - Fetch product detail records (e.g., packaging code).

4. **Group Validation:**  
   - Ensure the product is assigned to all required groups (overgroup, main group, subgroup).

5. **Supplier Determination:**  
   - Identify the price-giving supplier, including logistics supplier logic if applicable.

6. **Pricing Condition Search:**  
   - Search for applicable pricing conditions (discounts, net prices) in a strict order of specificity, using the price group if defined.

7. **Fallback for Price Group:**  
   - If no condition found for the given price group, retry with a blank price group.

8. **Surcharge Factor Search:**  
   - Similarly, search for applicable surcharges (markups) in a strict hierarchy.

9. **Fallback for Surcharge Price Group:**  
   - Retry with blank price group if not found.

10. **Supplier Register Validation:**  
    - Ensure the supplier is valid in the supplier register.

11. **Unit/Packaging Retrieval:**  
    - Fetch units of measure and conversion factors for the product (including fallback logic for missing data).

12. **Freight Condition Search:**  
    - Search for applicable freight conditions, with fallback to blank price group if necessary.

13. **Price Calculation:**  
    - Calculate net price, cost price, sales price, and margin based on all retrieved factors.

14. **Exit and Return:**  
    - Output all calculated and collected data.

---

## Key Business Concepts and Data Relationships

- **Product (Vare):**  
  The core entity for which pricing is calculated.

- **Supplier (Leverandør):**  
  The supplier whose conditions and markups may apply. Supports special logic for logistics items.

- **Groups (Overgruppe/Hovedgruppe/Undergruppe):**  
  Hierarchical product groupings used for condition and surcharge lookup.

- **Price Group (Prisgruppe):**  
  Used to segment pricing/discount/freight conditions. Supports fallback to blank group.

- **Condition (Betingelse):**  
  Discount or net price rules, found in a strict order from most to least specific (see below).

- **Surcharge (Påslag):**  
  Markup rules, also searched in a strict specificity hierarchy.

- **Freight (Frakt):**  
  Freight calculation rules, found in a similar hierarchical manner.

- **Units/Packaging:**  
  Multiple levels of units and conversion factors, critical for price calculations.

- **Dates:**  
  All conditions, surcharges, and packaging records are validated for date ranges.

---

## Condition/Surcharge/Freight Lookup Hierarchies

Each lookup is performed in a strict order of specificity, from most to least specific, as documented in the source (see the in-code tables). For example, conditions are searched in the following order:

1. **By Product, Type, Delivery Type**
2. **By Product, Type, Delivery Type = 0**
3. **By Product, Delivery Type**
4. **By Product, Delivery Type = 0**
5. **By Module, Type, Delivery Type**
6. **...**
7. **By Overgroup, Main Group, Subgroup, Type, Delivery Type**
8. **...**
9. **General (on supplier only)**

This ensures the most specific applicable rule is always used.

---

## Key Files and Their Roles

- **jvarpfr (Product Master):**  
  Product information.

- **jvdtpfr (Product Detail):**  
  Additional product attributes (e.g., packaging code).

- **jvprpfr (Product Price):**  
  Base prices.

- **jvpkpfr (Product Packaging):**  
  Units and conversion factors.

- **jbetpfr (Condition):**  
  Pricing/discount conditions.

- **jraepfr (Discount Elements):**  
  Discount breakdowns under a condition.

- **jpfapfr (Surcharge Factors):**  
  Markup rules.

- **jlevpfr (Supplier):**  
  Supplier register.

- **jvlepfr (Logistics Supplier):**  
  Additional supplier info for logistics items.

- **jfbepfr (Freight Conditions):**  
  Freight calculation rules.

- **ra16pfr (Currency Rates):**  
  Currency conversion.

---

## Notable Design Patterns and Conventions

- **Strict Specificity Search:**  
  All condition/surcharge/freight lookups are performed in a predefined order, falling back to less specific matches only when more specific ones are not found.

- **Fallback for Price Group:**  
  If a price group is specified but not found, the logic retries with a blank group, ensuring broadest possible match.

- **Date Validation:**  
  All lookups are validated against from/to dates, with *loval (lowest value) used to indicate open-ended ranges.

- **Support for Logistics Items:**  
  Special logic (including SQL) is used to handle logistics products, which may require different supplier and module references.

- **Parameter List Organization:**  
  The parameter list is extensive, supporting both input (e.g., firm, product, date, price group, delivery type) and output (e.g., prices, units, factors, status, group info).

- **Status Codes (p_osts):**  
  Used throughout to indicate specific error or processing states (e.g., product not found, missing group, missing supplier, missing unit, etc.).

- **Currency Handling:**  
  If the product price is in foreign currency, it is converted using current rates from the currency file.

- **Subroutine Structure:**  
  All business logic is encapsulated in subroutines, each handling a distinct aspect of the process.

---

## Subroutines and Their Responsibilities

### Initialization (`*inzsr`)
- Loads parameters, clears output variables, sets up keys.
- Calls CO402R for special cost price logic (Skattum).
- Sets up date variables for later use.

### Main Routine
- Chains to product master; if not found, sets status.
- Chains to product detail for packaging code.
- Validates group assignments.
- Calls `hent_lev` to get supplier.
- Calls `hent_beti` to get pricing conditions.
- If not found for price group, retries with blank.
- Calls `hent_pasl` for surcharge factors, with fallback.
- Calls `hent_elev` for supplier validation.
- Calls `hent_enhet` for unit/packaging info.
- Calls `hent_frakt` for freight conditions, with fallback.
- Calls `hent_pris` to calculate all prices and outputs.

### `hent_lev`
- Determines the correct supplier, including logistics item logic.
- Handles fallback scenarios for missing logistics info.
- Retrieves price from product price file, validates date.
- Handles currency conversion if needed.
- Retrieves logistics supplier number if available.

### `hent_beti`
- Searches for applicable pricing conditions in strict specificity order.
- Calls `sjekk_dato` to validate date ranges.
- If found, retrieves all relevant condition data and discount elements, calculates net price and factors.

### `hent_frakt`
- Searches for applicable freight conditions in strict specificity order.
- If found and dates are valid, calculates freight factors for later price calculation.

### `hent_pasl`
- Searches for applicable surcharge factors (markups) in strict specificity order.
- If found, retrieves all relevant surcharge data.
- If not found, defaults cost and sales price factors to 1.

### `hent_elev`
- Validates supplier in the supplier register.
- If not found, sets status and exits.
- Retrieves supplier name and number.

### `hent_enhet`
- Retrieves unit/packaging info for up to three units with conversion factors.
- Handles fallback for missing data.
- Ensures at least primary unit is found; otherwise, sets status.

### `hent_pris`
- Calculates net, cost, and sales prices based on all collected data.
- Applies freight, surcharge, and conversion factors.
- Calculates margin (Dekningsgrad).

### Utility Subroutines
- `sjekk_pkdato`: Validates packaging records against date.
- `sjekk_dato`: Validates condition/surcharge records against date.
- `valuta`: Retrieves currency conversion rate for given code/date.
- `finn_logivar`: SQL-based lookup for logistics supplier info.

---

## Key Error and Status Handling

- **p_osts:**  
  Status code, set at various points to indicate why processing stopped or failed (e.g., product not found, missing group, missing supplier, missing unit, etc.).
- **Error Subroutine (`*pssr`):**  
  Handles unexpected errors by setting status and exiting.

---

## Integration and Dependencies

- **Data Files:**  
  The program is tightly coupled to a range of physical/logical files that contain master data, pricing, packaging, supplier, and currency information.
- **External Program (CO402R):**  
  Called for special cost price logic in some customer-specific scenarios.
- **SQL (Embedded):**  
  Used for logistics supplier lookup, reflecting newer data access patterns in the logistics domain.

---

## Business Domain-Specific Notes

- **Scandinavian/Norwegian Business Logic:**  
  The code and comments reflect Norwegian terminology and business practices, such as "vare" (product), "leverandør" (supplier), "prisgruppe" (price group), "påslag" (markup), etc.

- **Special Customer Logic (Skattum):**  
  Conditional logic for cost price handling is invoked for customer-specific scenarios.

- **Logistics Items:**  
  Special handling for logistics items, including alternative supplier/module references and alternative price calculations.

- **Multi-Level Groupings and Fallbacks:**  
  The hierarchical search and fallback logic is critical for supporting the complexity of real-world product and supplier relationships.

---

## Versioning and Change History

- The code is heavily versioned, with in-line comments indicating changes by version and developer initials.  
- All major logic changes (e.g., price group extension, logistics item support, currency handling, freight logic) are annotated for traceability.

---

## Summary

**JV751R** is a core pricing engine for the order process, designed to handle a wide range of business scenarios and hierarchies. The program encapsulates decades of evolving business logic, supporting fallback and specificity in all major lookups, and is designed to be robust in the face of missing or incomplete data. It is critical to understand the strict order of lookups, the fallback conventions, and the business meaning of each field and status code when working with or extending this code.

---

**For onboarding:**  
- Focus on understanding the lookup hierarchies and fallback logic.
- Be aware of the dependencies on master data files and their structures.
- Pay attention to the business meaning of each field and the significance of the status codes.
- Review the handling of logistics items and customer-specific logic, as these represent key extensions to the base logic.
- Use the in-code documentation as a guide for the sequence and conditions of each search and calculation step.