# RPG Program RP603R - Window Inquiry and Maintenance for ILONPF

## Purpose

This ILE RPG program (RP603R) is a maintenance and inquiry "window" over the ILONPF file. It provides a subfile-based interface for selecting, viewing, modifying, and (potentially) creating records. The user interface is driven by display files, subfiles, and function key indicators.

---

## High-Level Flow

1. **Program Initialization**:
   - The *INZSR (initialization subroutine) sets up work variables, keys, state indicators, and fills the display subfile with data from ILONPF, either sorted by number or name.

2. **Main Display Loop**:
   - The user interacts with a subfile window (B2WCT) to select, browse, or edit records. Keys (F3=exit, F5=refresh, F12=cancel, etc.) are handled by checking indicators.

3. **Record Actions**:
   - **Select** (option 1): Returns the selected record to the caller.
   - **Edit** (option 2): Opens the record in an edit window (C2WIN).
   - **View** (option 5): Opens the record in read-only mode (fields protected).
   - **Create** (called via indicator *INKF): Opens a new record entry window.

4. **Subfile Management**:
   - Subroutines clear (XCLR01) and refill (XCRT01) the subfile, handle paging, and positioning.

5. **Data Updates**:
   - Changes to records are written back to the ILONPF file using standard RPG file operations (WRITE, UPDATE).

6. **Exit**:
   - Function key F3 (*INKC) ends the program, returning to the caller.

---

## File Definitions

```rpg
Filonl1 IF E K DISK RENAME(ilonpfr:ilonl1r)
Filonl2 IF E K DISK RENAME(ilonpfr:ilonl2r)
Filonlu UF A E K DISK RENAME(ilonpfr:ilonlur)
Frp603d CF E WORKSTN SFILE(B1WSF:SRRN01)
```
- **Filonl1, Filonl2, Filonlu**: Three logical views of the ILONPF file for different access paths (by number, by name, for update).
- **Frp603d**: The display file, with subfile B1WSF controlled by SRRN01.

---

## Key Work Variables

- `MLD` - An array used for field labels / messages.
- `ilonl1_lnr`, `ilonl2_nav` - Work keys (numeric and alphanumeric).
- `l_user`, `l_filg`, `l_firm`, `l_fnav` - LDA-related (Local Data Area) variables for security, file, and company info.
- `w_tilgko`, `w_rutine`, `w_adv`, `w_status` - Used for calling security/authorization check program (AD005R).

---

## Indicators

- **Function Key Indicators**
  - KC = F3 (Exit)
  - KE = F5 (Refresh)
  - KL = F12 (Cancel)
- **Screen/Control**
  - LR = Last record (end program)
  - 10 = Roll (page up/down)
  - 12, 13, 14, 15 = Subfile display/control
  - 16 = No more records in subfile
  - 30 = Field protection (view)
  - 31–59 = Error/warning messages
  - 60–69 = File status (chain, not found, etc.)
  - 70–99 = Work indicators (subroutines/temporary)

---

## Main Program Flow (Simplified)

### Initialization (*INZSR)
- Sets all work variables to initial values.
- Prepares key lists for both numeric and name-based access.
- Positions to first record (by number or name).
- Loads/refreshes subfile with records (`EXSR XCRT01`).

### Main Display Loop
- Displays the main window.
- Handles function keys:
  - **F3/F12**: End.
  - **F5**: Refresh - repositions and refills subfile.
  - **Roll (10)**: Refill subfile for next/previous page.
  - **Positioning**: Allows search by number (B2LNR) or name (B2LNAV).

### Record Operations
- Loops through displayed subfile records:
    - Reads marked records.
    - 1 = Select: sets return data and exits.
    - 2 = Edit: opens record in edit window (calls `XC2WIN`).
    - 5 = View: opens record in protected/view-only mode (calls `XC2WIN`).

### Subfile Processing (XCLR01, XCRT01, XDSP01)
- **XCLR01**: Clears subfile and its page/record counters.
- **XCRT01**: Loads next page of records into the subfile based on current position (by number or name).
- **XDSP01**: Displays the subfile control window, activating indicators as needed.

### Edit/Add Window (XC2WIN)
- Chains to the selected record (by key), moves data into display fields.
- If record not found, prepares for new record entry.
- Displays window for user entry (EXFMT C2WIN).
- On confirmation, writes/updates record in file.

---

## Security Check

Before writing a new record, calls external program AD005R to verify if user is authorized (`w_status` set to 'Sperret' if blocked).

---

## Key Subroutines/Pseudocode

- **XCLR01**: Clear subfile and paging vars.
- **XCRT01**: For each record (by key), fill subfile page.
- **XDSP01**: Display current subfile page.
- **XC2WIN**: Chain to record, show window, update or write as needed.
- **Initialization**: Setup access keys, load first records, startup screen.

---

## Data Structure and Subfile Explanation

- **Subfile B1WSF**: Used for displaying a "window" of records for user selection.
- **Page/Record Counters (SRRN01, SSRN01, SFRN01, SPGE01, SVRN01)**:
  - SRRNnn: Relative record number.
  - SFRNnn: First record on page.
  - SSRNnn: Last record on page.
  - SPGEnn: Subfile page size.
  - SVRNnn: Page containing specific record.

---

## Notable Conventions

- **Norwegian Comments & Variable Names**: Comments and some fields use Norwegian, e.g., "Spørrevindu" (Inquiry window), "vedlikehold" (maintenance).
- **Indicator Usage**: Follows IBM S/36, S/38, and AS/400 RPG indicator conventions.
- **File Naming**: ILONPF is assumed as the base physical file; logicals are used for sort/order.

---

## Example Function Key Handling

```rpg
C     *INKC         CABEQ     *ON           XSLUTT       // F3: End
C     *INKE         IFEQ      *ON
   ... // F5: Refresh, refill subfile
C     *IN10         IFEQ      *ON
   ... // Roll, page subfile
```

---

## Integration Points

- **AD005R**: Security/authorization check before new record creation.
- **RP150R**: Possible callout, purpose not clarified in listing.

---

## Summary

This RPG program provides an interactive, indicator-driven window for maintaining and inquiring into the ILONPF file via subfile display and detail dialogs, supporting selection, creation, editing, and viewing of records, with paging and search by both number and name. It is built with standard IBM i subfile and windowing techniques, using both numeric and alphanumeric keying, and illustrates classic monolithic RPG III/400-style application windowing.