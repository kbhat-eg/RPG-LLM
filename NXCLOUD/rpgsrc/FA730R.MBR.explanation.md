# Documentation: FA730R – Jobb-register Status, Access Control

## Overview

**Program:** FA730R  
**System:** ASOFAK  
**Purpose:**  
This program is responsible for job status checking and access control within the job register (“Jobb-register”). It is typically used to prevent certain operations from being performed if related jobs are currently active, enforcing business rules around job concurrency and user access.

The program is invoked with parameters indicating which job status to check. If an active job is found, it retrieves and displays a relevant message to the user, allowing them to retry or exit.

---

## Structure and Flow

### Files

- **fjobl1**  
  Physical file containing job status flags. Renamed in the program as `fjobl1r` for internal use.

- **fa730d**  
  Display file used for user interaction (workstation device).

### Data Definitions

- **a_meld**  
  Array of 10 message strings (50 characters each), loaded from compile-time data (*CTDATA*). Each message corresponds to a specific job code and is displayed if the relevant job is active.

- **l_firm**  
  Company code, obtained from the Local Data Area (LDA). Used as a key to access company-specific records in the job register.

- **p_kode**  
  Input parameter: Job code (1-10). Indicates which job status to check.

- **p_onof**  
  Output parameter: Returns the status (on/off) of the requested job.

- **w_firm**  
  Local variable, copy of the company code (`l_firm`), used as a key field.

- **w_stop**  
  Local variable, used as a flag to indicate if the checked job is active.

---

## Main Logic

### Initialization

- **Entry Parameters:**  
  The program receives `p_kode` (job code to check) and `p_onof` (status to return) as parameters.
- **Key Setup:**  
  The company code (`l_firm`) is copied into `w_firm`, which is used as the key for accessing the job register file.

### Job Status Check

1. **Retrieve Record:**  
   The program attempts to chain to the job register (`fjobl1r`) using the company key (`w_firm`).

2. **Job Code Switch:**  
   Depending on the value of `p_kode` (01–10), the corresponding job status field (`fajb01`–`fajb10`) is checked in the job register record:
   - `p_onof` is set to the value of the field.
   - `w_stop` is also set to this value for further logic.

3. **Active Job Handling:**  
   If the job is active (`w_stop = 1`):
   - The corresponding message from `a_meld` is loaded into the display variable.
   - The user is presented with a message window (`exfmt a1win`).
   - If the user chooses to retry (`a1svar = 1`), the process loops and rechecks the status.
   - Otherwise, the program exits.

4. **Program Exit:**  
   If the job is not active or the user chooses not to retry, the program ends and returns control to the caller.

---

## Business/Domain Logic

- **Concurrency Control:**  
  The main business rule enforced here is that certain operations cannot proceed if a related job is already running. This is implemented by checking specific job status flags in the job register.

- **User Guidance:**  
  If a job is active, the user is informed via a specific message (from `a_meld`) indicating which operation is blocked and why.

- **Company-Specific Logic:**  
  All job status checks are company-specific, based on the company code from LDA.

---

## Design Decisions and Conventions

- **Job Status Flags:**  
  Each job type has a dedicated status field (`fajb01`–`fajb10`). The mapping between `p_kode` and these fields is direct and hardcoded.

- **Message Array:**  
  Messages are maintained in a compile-time array, allowing for easy updates or localization without code changes.

- **Retry Pattern:**  
  The program uses a loop (`goto nytest`) to allow the user to retry the operation if the blocking job becomes inactive.

- **Parameter Passing:**  
  The program is designed as a subroutine or utility, invoked by other programs to check job status before proceeding with critical operations.

- **File Keying:**  
  Company code is always used as a key, ensuring all job status checks are company-contextual.

---

## External Dependencies and Integration

- **Job Register File (`fjobl1`):**  
  Central data store for job status flags. Must be maintained by other processes to accurately reflect job activity.

- **Display File (`fa730d`):**  
  Used for user interaction when an active job is detected.

- **LDA:**  
  The Local Data Area must be properly initialized with the correct company code before this program is called.

---

## Message Array Content

At the end of the source, the *CTDATA* section for `a_meld` provides the actual messages displayed for each job code. Examples include:

- "Fakturering kjøres fra en annen skjerm" (Invoicing is running from another screen)
- "Oppdatering av regnskap kjøres fra en annen skjerm" (Accounting update is running from another screen)
- "Avstemmingsliste kjøres fra en annen skjerm" (Reconciliation list is running from another screen)
- Several placeholders ("Ledig") for unused job codes.

Each message is associated with a specific job code and system (e.g., ASOFAK, ASSHOP, ASLAGR).

---

## Summary

This program is a core utility for enforcing single-job concurrency and access control within the ASOFAK system. It is tightly coupled to the job register file structure and relies on company code context. The message-driven user interaction ensures that end-users are informed of blocking conditions and given the option to retry, supporting robust business process flows.