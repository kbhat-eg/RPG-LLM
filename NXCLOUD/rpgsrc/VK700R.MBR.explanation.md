# RPG Program Explanation: VK700R

This is a classic ILE RPG (RPG IV / RPGLE) program, apparently written for an IBM i (AS/400) system. The program is named **VK700R** and its main function is to find the "alternate product group" for a given "product group" (as received via parameters). The code is written with Norwegian comments, so some variable names and comments are in Norwegian.

---

## 1. Header and File Specification

```rpg
h option(*nodebugio) datedit(*dmy)
```

- Sets compile options: disables debug IO and specifies date format as day-month-year.

```rpg
fvvgkl1    if   e           k disk    rename(vvgkpfr:vvgkl1r)
```

- Declares a disk file named `vvgkl1` (external definition), keyed access, and renames record format from `vvgkpfr` to `vvgkl1r`.  
- This file is presumably used for looking up product group connections.

---

## 2. Parameter and Variable Definitions

### Parameters Passed into Program

```rpg
d p_firm          s                   like(vkfirm)
d p_ogrp          s                   like(vkogrp)
d p_hgrp          s                   like(vkhgrp)
d p_ugrp          s                   like(vkugrp)
d p_ldor          s                   like(vkldor)
d p_ahgr          s                   like(vkahgr)
d p_augr          s                   like(vkaugr)
```
- These are the incoming and outgoing parameters:
    - `p_firm`  = company
    - `p_ogrp`  = original product group
    - `p_hgrp`  = main group
    - `p_ugrp`  = sub group
    - `p_ldor`  = supplier
    - `p_ahgr`  = alternate main group (to return)
    - `p_augr`  = alternate sub group (to return)

### Variables for Key Construction

```rpg
d vvgkl1_ogrp     s                   like(vkogrp)
d vvgkl1_hgrp     s                   like(vkhgrp)
d vvgkl1_ugrp     s                   like(vkugrp)
d vvgkl1_ldor     s                   like(vkldor)
d w_firm          s                   like(vkfirm)
```
- Used to hold key values when reading the file.

---

## 3. Entry Parameter List and Initialization

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_ogrp
c                   parm                    p_hgrp
c                   parm                    p_ugrp
c                   parm                    p_ldor
c                   parm                    p_ahgr
c                   parm                    p_augr
...
c                   eval      w_firm = p_firm
c                   eval      p_ahgr = 0
c                   eval      p_augr = 0
c                   endsr
```

- Defines the expected parameter list for the program entry.
- Initializes `w_firm` with incoming `p_firm`.
- Initializes outgoing parameters `p_ahgr` and `p_augr` to zero.

---

## 4. Key List Definition

```rpg
c     vvgkl1_key    klist
c                   kfld                    w_firm
c                   kfld                    vvgkl1_ogrp
c                   kfld                    vvgkl1_hgrp
c                   kfld                    vvgkl1_ugrp
c                   kfld                    vvgkl1_ldor
```
- Defines a key list for the file lookup.
- Fields in the key: firm, original group, main group, sub group, supplier.

---

## 5. Main Logic: Searching for Alternate Product Groups

### Step-by-step Search with Fallback Logic

The core program logic is a series of file lookups (`chain`) with progressively less specific keys if a match isn't found (progressively "widening" the search).

1. **First**, assign parameter values to key variables:

    ```rpg
    c                   eval      vvgkl1_ogrp = p_ogrp
    c                   eval      vvgkl1_hgrp = p_hgrp
    c                   eval      vvgkl1_ugrp = p_ugrp
    c                   eval      vvgkl1_ldor = p_ldor
    ```
2. **Try full key (with supplier):**

    ```rpg
    c     vvgkl1_key    chain     vvgkl1                             91
    c                   if        *in91 = *on
    ```
   - If not found,
     - Remove supplier from key:
   
    ```rpg
    c                   eval      vvgkl1_ldor = 0
    c     vvgkl1_key    chain     vvgkl1                             91
    c                   if        *in91 = *on
    ```
   - If still not found,
     - Restore supplier, remove sub group:
   
    ```rpg
    c                   eval      vvgkl1_ldor = p_ldor
    c                   eval      vvgkl1_ugrp = 0
    c     vvgkl1_key    chain     vvgkl1                             91
    c                   if        *in91 = *on
    ```
   - If still not found,
     - Remove supplier again:
   
    ```rpg
    c                   eval      vvgkl1_ldor = 0
    c     vvgkl1_key    chain     vvgkl1                             91
    c                   if        *in91 = *on
    ```
   - If still not found,
     - Restore supplier, remove main group:
   
    ```rpg
    c                   eval      vvgkl1_ldor = p_ldor
    c                   eval      vvgkl1_hgrp = 0
    c     vvgkl1_key    chain     vvgkl1                             91
    c                   if        *in91 = *on
    ```
   - If still not found,
     - Remove supplier one last time:
   
    ```rpg
    c                   eval      vvgkl1_ldor = 0
    c     vvgkl1_key    chain     vvgkl1                             91
    c                   endif
    c                   endif
    c                   endif
    c                   endif
    c                   endif
    ```

**In each fall-through case, the search becomes less restrictive, broadening the scope in case no specific match exists.**

#### Note about `*in91`:

- After each `chain`, indicator 91 (`*in91`) is set ON if the record was **not found**.
- The chained searches are nested in `IF *IN91 = *ON` blocks, so it only continues to the next level if a record wasn't found.

---

## 6. Success Case: Record Found

```rpg
c                   if        *in91 = *off
c                   eval      p_ahgr = vkahgr
c                   eval      p_augr = vkaugr
c                   goto      avslutt
c                   endif
```

- If a record is found (`*in91 = *off`):
    - Set outgoing alternate group values from the found record fields (`vkahgr` and `vkaugr`).
    - Jump to program end.

---

## 7. Program End and Cleanup

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```

- The label `avslutt` is the common exit path.
- Sets `*INLR` (last record indicator) to `*ON`, signaling program end.
- Returns control to the caller.

---

## Summary

- **Purpose:** Given a set of product group parameters, find the most specific alternate group mapping in the `vvgkl1` file. If no exact match is found, the search is broadened step-by-step by zeroing out less important keys (supplier, sub group, main group).
- **Inputs/Outputs:** Parameters for company, group, subgroup, main group, supplier, and result fields for alternate group/subgroup.
- **Fallback Logic:** Implements a cascading search for broader matches.
- **File Access:** Uses keyed access to an external file throughout.
- **Initialization:** Parameters and local variables are initialized in the subroutine.

---

### Key Coding Patterns

- **File Key Lists (`klist`):** Classic RPG technique for keyed file operations.
- **Nested IFs:** For fallback logic; in modern RPG, you might use a loop for clarity.
- **Parameter Handling:** via `plist` and `parm`.

### Onboarding Tips

- Understand the field and key structure of the `vvgkl1` file, as its data and index design drive the business logic.
- Refactoring this program in free-format RPG may improve readability and maintainability.
- The logic is robust for fallback searches, but future enhancements could simplify the nested IFs and increase flexibility.