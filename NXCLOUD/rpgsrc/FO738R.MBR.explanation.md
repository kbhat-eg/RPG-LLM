# FO738R – Change Delivery Type on Order Lines

## Overview

This program, FO738R, is part of the ASOFAK system and is responsible for updating the delivery type (`leveringstype`) on order lines (`ordrelinjer`). It can update both sales order lines and, if present, related purchase order lines. The program supports conditional updating based on parameters, and performs audit stamping (date, time, user) on updates.

---

## Key Business Logic

- **Primary Function:**  
  Update the delivery type for all lines on a given sales order, and—if applicable—on corresponding purchase order lines.
- **Conditional Update:**  
  The update is controlled by parameters, allowing either selective or blanket updating of lines.
- **Audit Trail:**  
  When a line is updated, the program writes the current date, time, and user to the record for traceability.

---

## Files and Data Relationships

- **fohel1** (ORDRE-HODE-REGISTER):  
  Sales order header file. Used to retrieve the current delivery type for the order.
- **fodtl1** (ORDRE-LINJE-REGISTER):  
  Sales order line file. Iterated to process each line of the order.
- **fodtlu** (ORDRE-LINJE-REGISTER UPDATE):  
  Used for updating order lines.
- **lodtlu** (BESTILLINGS-LINJE-REGISTER UPDATE):  
  Used for updating related purchase order lines, if they exist.

All files are keyed by firm number, order number, suffix, and (for line files) line number.

---

## Parameters

The program receives the following parameters via the *ENTRY PLIST:

- `p_firm`: Firm number.
- `p_numm`: Order number.
- `p_suff`: Order suffix.
- `p_flty`: New delivery type to be set (from order header).
- `p_valg`: Update mode selector (1 = update all, otherwise conditional).

---

## Main Processing Flow

### 1. Initialization (`*INZSR`)

- Sets up key lists for all files.
- Receives parameters and initializes key variables for file access.

### 2. Read Order Header

- Reads the order header to obtain the current delivery type (`folety`).  
  This value (`w_tlty`) will be used to update the order lines.

### 3. Iterate Over Order Lines

- Loops through all order lines for the given order.
- For each line, determines if it should be updated:
  - If `p_valg = '1'`: update all lines.
  - Otherwise, only update lines where the current delivery type matches `p_flty`.

### 4. Update Order Line (if applicable)

- Uses `fodtlu` to update the order line:
  - Sets `fdlety` (delivery type) to the new value.
  - Stamps current date, time, and user (`fdedat`, `fdetim`, `fdeusr`).
- If the order line has an associated purchase order line (`fdbenr` not zero):
  - Uses `lodtlu` to update the purchase order line in a similar manner.

### 5. End Program

- Sets LR indicator and returns.

---

## Special/Non-Obvious Design Considerations

- **File Renaming:**  
  The program uses the `RENAME` keyword to map physical files to program-specific record formats, supporting multiple logical views over the same physical files.
- **Audit Stamping:**  
  Date, time, and user updates are done using the `TIME` opcode and LDA user field (`l_user`), ensuring all changes are traceable.
- **Firm Number Propagation:**  
  The firm number is always included in all keys, supporting multi-company operation.
- **Key Management:**  
  Key fields are explicitly managed and set in the initialization subroutine for clarity and maintainability.

---

## External Interactions and Dependencies

- **LDA (Local Data Area):**  
  The user ID is fetched from the LDA (positions 911–920), which must be populated by the calling environment.
- **Parameter Passing:**  
  The program is designed to be called from other programs, receiving its context via parameters.

---

## Naming and Conventions

- **File/Field Prefixes:**  
  - `fo` = sales order header/line
  - `fd` = sales order line fields
  - `lo` = purchase order line
  - `ld` = purchase order line fields
- **Suffixes:**  
  - `r` = record format
  - `ur` = update record format

- **Comments and Change Log:**  
  The program header includes a detailed change log and business context (in Norwegian), indicating active maintenance and adaptation to business needs (e.g., number expansions, price group extension).

---

## Summary Table

| File    | Purpose                              | Access | Notes                          |
|---------|--------------------------------------|--------|--------------------------------|
| fohel1  | Sales order header                   | Read   | For delivery type retrieval    |
| fodtl1  | Sales order lines                    | Read   | For iteration                  |
| fodtlu  | Sales order lines (update)           | Update | For updating delivery type     |
| lodtlu  | Purchase order lines (update)        | Update | If corresponding line exists   |

---

## Business Rules Encoded

- Only lines that match the selection criteria are updated.
- If an order line is linked to a purchase order line, both are updated for consistency.
- All updates are audit-stamped with user, date, and time.
- The process is parameter-driven for flexibility and reusability.

---

## Integration Points

- Typically called as part of an order management workflow, possibly from a user interface or batch process.
- Relies on correct population of LDA and parameter passing from the calling program.

---

## Maintenance Notes

- Ensure that the LDA user field is set before calling this program.
- If file structures change (e.g., key fields, audit fields), corresponding updates are required in this program.
- The program is sensitive to the correct mapping of keys and record formats due to the use of RENAME and explicit key lists.

---

## Conclusion

FO738R is a focused utility for mass-updating delivery types on order lines, with robust audit support and careful handling of related purchase order lines. It is designed for multi-company environments, is parameter-driven, and is tightly integrated into the order processing subsystem. Understanding the file relationships, key management, and audit stamping is essential for effective maintenance and extension of this program.