# RPG Program Explanation - "Utskrift av autogiro - utplukk" (RK820R)

This program is designed to select ("utplukk") customers for direct debit (autogiro) processing, most likely as part of a periodic payment reminder or collection routine. The code is written in traditional (fixed-form) ILE RPG, common on IBM i (AS/400) systems.

---

## **Program Overview**

- **Title / Documentation Area:**  
  The program is well-documented at the top, including comments on system, program name, purpose, and indicator usage conventions.  
  **Purpose:** Selects customers and their open items for autogiro processing based on a variety of filtering parameters.

- **Options & Attributes:**  
  ```rpg
  h option(*nodebugio) datedit(*dmy)
  ```
  - `*NODEBUGIO`: Debugger will not step through input/output.
  - `DATEDIT(*DMY)`: Default date editing day/month/year.

---

## **File Declarations**

- **Files Used:**
  - **rkwcl2:** Customer item file, input keyed, renamed record format.
  - **rkunpf:** Customer master file, input keyed.
  - **rkunlu:** Some variant of the customer file, update keyed.
  - **rkw4pf:** Output file, to which selected records ("posts") are written.

  ```rpg
  frkwcl2    if   e           k disk    rename(rktrpfr:rkwcl2r)
  frkunpf    if   e           k disk
  frkunlu    uf   e           k disk
  f                                     rename(rkunpfr:rkunlur)
  frkw4pf    o  a e           k disk
  ```

---

## **Data Structure Declarations**

### **Parameter Data Structure - d_parm**
- 120 bytes, overlays with `w_parm` for parameter passing.
- Contains customer, firm and filtering information (e.g., firm, customer number ranges, dates, categories).
- `overlay` is used to map subfields to different parts of the parameter area.

### **Work/Key Data Structures**
- `wkkey`, `wkalfa`: Used for various composite keys.
- `wwdato` / `wnforf`: Work date fields for range checking.
- Temporary work fields: `w_pdat`, `wnrest`, `wpakod`, etc.

---

## **Indicator Usage**

The comments specify a convention of how numbered indicators are used (e.g., file I/O, error messages, subroutine flags, etc.), which is a common practice in legacy RPG programs.

---

## **Main Program Flow**

### 1. **Parameter Initialization**
- Parameters for filtering (firm, customer number ranges, etc.) come in via the entry parameter list and are distributed into their fields via overlays.

### 2. **Select Customers**
- Sets up the key to the customer master file (`rkunpf`) and begins looping over customers:
  - Only processes customers that match the filtering parameters (firm, customer number ranges, etc.).
  - There are multiple skip conditions. If a record does not match, it skips (`goto nykund`).
  - Once the customer is validated, it checks if direct debit authorization is sent (field `rksent = 1`).
  - Some filters (e.g., payment method, seller) are commented out for possible inclusion later.

### 3. **Process Customer Items**
- For each valid customer:
  - Sets up keys and begins reading customer items from `rkwcl2`:
    - Loops over customer items (open invoices, etc.), checking each against date ranges, complaint flags, and whether the item is already set for autogiro.
    - Skips items that do not qualify.
    - For qualifying items, it determines the sorting order (alphanumeric or original key).
    - Writes the record (`write rkw4pfr`) to the output file.
    - Adds the amount to a running total.

### 4. **End of Customer**
- After items have been processed, checks if the sum is zero or negative.
- Optionally marks or updates the customer file accordingly (commented out).
- Moves to the next customer (`goto nykund`).

### 5. **End of Program**
- Tag `xslutt`: Sets LR indicator and returns.

### 6. **Initialization Subroutine**
- Standard RPG *INZSR used to initialize variables and set up keys.
- Handles date manipulations for the selected period, etc.

---

## **Key Features & Logic**

- **Filtering:**
  - The program is parameter-driven: users (or callers) can specify ranges for firm, customer, department, category, seller, date, etc.
  - Only items meeting all active criteria are selected for output.

- **File Handling:**
  - Chain/Setll/Read(With Key) are used for keyed file access, optimizing performance for large datasets.

- **Indicators:**
  - File indicators (e.g., 10, 61) are used for checking I/O statuses.
  - Work indicators (30–99) handle errors, UI, and program flow.

- **Skipping/Branching:**
  - Classic use of `goto` and labeled tags (e.g. `nykund`, `les_ntr`).  
  - Ensures that if a record fails a filter, processing jumps directly to fetch the next record without further checks.

- **Output:**
  - Selected records are written to `rkw4pf` (output file), possibly for printing, file transfer, or further processing.

---

## **Subtleties & Comments**

- **Fields like `rksent`, `rkbetm`, `rnstat`, `rnauto`** are specific status/flag fields in the customer/item records (likely defined in the physical files).
- **Commented code (`c*`)**: There are commented-out lines for additional business rules (e.g., payment method checks).
- **Date Handling:**  
  Dates may be stored in various formats (packed, character, etc.) and require manipulation to extract year/month/day for filtering.

---

## **Summary Table**

| Section             | What it Does                                               |
|---------------------|-----------------------------------------------------------|
| File Declarations   | Declares input/output and update files                    |
| Data Structures     | Defines parameters, keys, and working storage             |
| Parameter Handling  | Parses and overlays input parameters                      |
| Customer Loop       | Iterates through customers, applying filters              |
| Item Loop           | Iterates through customer items, applies filters, writes  |
| Indicators & Tags   | Manages program flow, skips, and exits                    |
| Initialization      | Sets up working variables and composite keys              |

---

## **For Onboarding Developers**

- **Legacy Code:** Written in fixed-form RPG, which differs from modern free-form syntax.
- **Business Rules:** Most branching is driven by business filtering; understand what each filter represents (consult field definitions).
- **Files & Fields:** Get layouts for files like `rkunpf`, `rkwcl2`, etc.—field names (`rkfirm`, `rkkund`, etc.) must be understood in context.
- **Parameter Structure:** This is the main interface for the program—ensure you know what each subfield means.
- **Testing:** When modifying filters or logic, test with a wide range of input parameters to ensure correct selection/exclusion of customers/items.

---

## **Typical Execution Flow (Simplified)**

1. Initialize parameters.
2. Loop over all customers in selected firm/range.
3. For each customer:
   - If customer matches parameters, loop over their items.
   - For each item:
     - If item matches criteria, write to output file.
     - Sum outstanding amounts.
   - If total is zero/negative, possibly update flag in customer file.
4. End of program.

---

**In summary**:  
This RPG program is a batch selection and extraction process for customers eligible for direct debit, based on a comprehensive set of input parameters, producing an output file (likely as a basis for further payment processing). Understanding the file layouts and business rules for filters is key to onboarding and maintaining this program.