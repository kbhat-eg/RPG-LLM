# Explanation of the RPG Program "LL648R" - "Utskrift av omløpshastighet"

This RPG/400 program produces a report showing the inventory turnover rate (omløpshastighet) for items, grouped and summarized in various ways, based on sorting parameters. The code is written in fixed-format RPG IV (ILE RPG), with Norwegian variable and comment names.

---

## 1. **Program Overview**

- **Purpose:** To print a report showing the inventory turnover rate for items (stock), including details and various group/subtotal summaries.
- **Input:** The main parameter is a 128-character data structure (`p_prec`) which contains various parameters such as item ranges, group ranges, sorting options, etc.
- **Output:** Sends report output to a printer file (`LL648P`).
- **Files Used:**
  - Master files (items, groups, warehouses)
  - Statistics files (sales, purchases)
  - Printer file for report output

---

## 2. **File Declarations**

```rpg
flwa1l1    if   e           k disk    rename(lwa1pfr:lwa1l1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
fsstalb    if   e           k disk    rename(sstapfr:sstalbr)
fsistlb    if   e           k disk    rename(sistpfr:sistlbr)
fll648p    o    e             printer
```
- These are logical files for items, item groups, statistics, etc., renamed for local use.

---

## 3. **Data Structures and Key Variables**

- **Parameter DS (`p_prec`)**: Overlays define specific parameter fields within the input parameter structure. These determine filters and options for the report:
  - From/To item, group, warehouse, etc.
  - Sorting and print options.

- **Local Data Area (LDA)** variables are used for user, firm, etc.

- **Working Variables:** For counters, accumulators, temporary storage, group keys, etc.

---

## 4. **Subfile Formats**

- **Report Headings and Totals:**
  - `A1HDR, A2HDR, A3HDR, A4HDR, A6HDR`: Headings for company, group, subgroup, warehouse, etc.
  - `D1DET`: Detail for each item/warehouse.
  - `T1SUM` to `T7SUM`: Subtotals for various summarization levels (item, group, warehouse, company).

---

## 5. **Main Logic**

### a) **Print First Heading**
```rpg
c                   if        p_sort <> 2
c                   write     a1hdr
c                   endif
```
- Prints the main report header (unless sorting by group).

### b) **Set Initial Values**
```rpg
c                   eval      g_lage = *hival
c                   eval      g_ogrp = *hival
c                   eval      g_hgrp = *hival
c                   eval      g_ugrp = *hival
```
- Initialize group tracking variables to high values to ensure first record triggers a break.

### c) **Main Read/Process Loop**
```rpg
c                   read      lwa1l1
c                   dow       *in90 = *off
    ...main process...
c                   read      lwa1l1
c                   enddo
```
- Main processing loop: Reads each item/warehouse record and processes for output and totals.

### d) **Group/Subgroup/Lager Break Logic**
- Checks if group/warehouse/subgroup/overgroup/hovedgruppe boundaries have changed (based on sorting mode), and if so, calls subroutines to:
  - Print subtotals
  - Print group headers

### e) **Detail Line Processing**
- Chains to item master and assigns item descriptions.
- Calls subroutines to fetch sales and purchase statistics for the last 12 months.
- Calculates quantities, values, and turnover rate (`d1omlh`).
- Writes detail record, updates group/warehouse/total accumulator variables.

### f) **Subtotal Accumulation**
- According to the sort/grouping, accumulates statistics in subtotal fields (`t1ants`, `t2salv`, etc.).

### g) **At end of input:**
- Writes any pending subtotals for all grouping levels.

---

## 6. **Subroutines**

### a) **Subtotal and Group Break Subroutines**
- `sum_t1` - Print item total (if more than one warehouse per item)
- `sum_t2` - Print undergroup (subgroup) total
- `sum_t3` - Print main group (hovedgruppe) total
- `sum_t4` - Print overgroup (overgruppe) total
- `sum_t6` - Print warehouse (lager) total
- `sum_t7` - Print firm (company) total

Each calculates the turnover rate, writes the subtotal record, and clears their accumulator fields.

### b) **Heading Subroutines**
- `hed_a2` - Overgroup break
- `hed_a3` - Main group break
- `hed_a4` - Subgroup break
- `hed_a6` - Warehouse break

Each fetches the description from the relevant group master file (or writes "Ukjent ..." if not found), writes group heading, and handles page overflow.

### c) **Overflow Subroutine**
- Handles printer page overflow by writing the report heading again.

### d) **find_salg (finn_salg) & find_innkj (finn_innkj)**
- Both routines scan monthly statistics records for the previous and current year, and sum up quantity and cost for sales and purchases respectively for the last 12 months for the item/warehouse in question.

### e) ***INZSR (Initialization Subroutine)**
- Loads parameter list
- Sets up key lists for CHAIN/SETLL/READE operations
- Extracts year and month from the system date
- Sets up report headings (date, time, user, etc.)

---

## 7. **Sorting/Grouping Modes (`p_sort` parameter):**

Determines the level of detail and group breaks:
- `1` - Item/Warehouse
- `2` - Item group/Item/Warehouse
- `3` - Warehouse
- `4` - Warehouse/Item group/Item

---

## 8. **Calculation of Turnover Rate**

For details and subtotals, the turnover rate is generally calculated as:

```
Turnover Rate = Sales Value / ( (End Quantity * Unit Price) + Sale Cost - Purchase Cost ) / 2
```
- It is capped at `99999.99` to avoid overflow.

---

## 9. **Report Output**

- For each record and group/subtotal, the corresponding output format (header, detail, subtotal) is written to the printer file.
- Handles page overflow and prints needed headers.

---

## 10. **Error Handling**

- If a group or item cannot be found in the relevant master file, writes "Ukjent ..." (Unknown ...) as description.

---

## 11. **Special Notes**

- The code uses Norwegian terms for business entities.
- The logic is "batch reporting" style, processing all records and printing a formatted report with multiple levels of detail and group breaks.
- The code is designed to be generic and configurable, driven by parameter data.

---

## 12. **Summary for Onboarding**

- **What does this program do?**  
  It prints a highly customizable inventory turnover report, summarizing at several group levels, using data from master and statistics files.

- **Where do I change parameters?**  
  The structure `p_prec` (and overlays) defines parameter input; check how the calling system sets these values.

- **How are data read and written?**  
  Data is read using logical file access (`READ`, `CHAIN`, etc.), and written via output specs to a printer file.

- **How are groups/subtotals handled?**  
  Sorting mode (`p_sort`) controls group breaks. Subtotal routines handle calculation, printing, and resetting of accumulators.

- **What subroutines are important?**  
  All `sum_tN` subroutines for totals, `hed_aN` for headings, `finn_salg` and `finn_innkj` for finding statistics.

- **Error output?**  
  If a group cannot be resolved, the output will say "Ukjent ...".

---

### **In summary:**  
This is a classic batch-report program, driven by parameters, processing master and statistical data to produce a breakdown of inventory turnover for items, by group and warehouse, with robust subtotal and grouping logic.

---

## **If you have specific business or technical questions, or want further detail on a section, let me know!**