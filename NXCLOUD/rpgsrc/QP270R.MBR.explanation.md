```markdown
# RPG Program Explanation: FP270R (Kollietikett Maintenance and Printing)

## Overview

This ILE RPG program (`FP270R`) is designed to maintain and print "kollietiketter" (colli/parcel labels) related to customer orders. It handles user input, order and customer master data retrieval, and the maintenance of additional information/items ("Trelast", "Pall", "Andre") on parcel lines in an order. It then calls a print program (`FP270C`) to output the labels.

---

## **1. File Definitions (`F-Specs`)**

- **fohel1, fodtlr, fodtl1, fodtlu, rkunl1:**  
  Logical files for order headers and details, and customer master.
  - `if/uf` = input/update files
  - `e` = externally described
  - `k` = keyed access
  - `rename(...)` = internal record format renaming

- **qp270d:**  
  Display file (`workstn`) for screen interaction.

---

## **2. Data Definitions (`D-Specs`)**

- **Local Data Area (LDA) fields (`l_user`, `l_firm`, `l_fnav`):**  
  Used for session/user information.

- **Order and line key variables:**  
  Variables like `fohel1_numm`, `fohel1_suff`, `fodtlr_numm`, etc., mimic key fields in physical files for convenient access.

- **Work variables:**  
  For handling current firm, line details, and various counters/texts per item type.

- **Data Structure `d_line`:**  
  Used to parse a string containing type, quantity, and descriptive text for a parcel line.

---

## **3. Main Logic (Calculation Specifications, `C-Specs`)**

### A. **Initialization**

- **`*inzsr` Subroutine:**  
  - Sets up initial keys and work variables.
  - Values are taken from program parameters and the LDA.

### B. **Screen Flow (`a1taga` and `a1tagb` tags)**

1. **Reset working variables**
2. **Fetch order header (`fohel1`)**
3. **If found, populate working variables for the order.**
4. **Fetch customer info from customer master (`rkunl1`)**
5. **Iterate over order detail records (`fodtlr`) to find and parse any existing information lines (9000: Trelast, 9001: Pall, 9002: Andre) for this order.**

### C. **User Interaction**

- **EXFMT a1bld:**  
  Displays the main maintenance screen (record format `a1bld`). User can perform actions via function keys.

#### Function Keys Handled:

- **F3 (INKC): Exit**
  - Ends the program (`goto end_pgm`).

- **F4 (INKD): Order Inquiry**  
  - Commented out in this version.

- **F10 (INKJ): Start Order Processing**  
  - Calls program `FO500R` to retrieve or search for a new order number.

#### Input Validation

- **Checks that required information is entered:**
  - Ensures that for each item type (Trelast/Pall/Andre), if text is entered, a quantity must also be set (else displays an error).

#### **F6 (INKF): Maintenance and Printing**

- **For each item type (Trelast, Pall, Andre):**
  - If quantity > 0, attempt to retrieve existing line in update file (`fodtlur`).
    - If not found: call subroutine `ny_linje` to create.
    - If found: call subroutine `opd_linje` to update.
- **Calls print program (`FP270C`)** to print the labels.

---

## **4. Subroutines**

### **A. `ny_linje` (Create New Order Line)**

- Clears the update record.
- Sets all fields for the new line, including date/time stamping and user, and writes (`write`) the record.

### **B. `opd_linje` (Update Existing Order Line)**

- Updates the text in the line, date/time/user, and issues an `update`.

### **C. `*inzsr` (Initialization Subroutine)**

- Loads program parameters into working variables and constructs keyed lists for file access.

---

## **5. Key Lists (KLIST)**

- Used as input keys for CHAIN/SETLL/READE, to access specific order header, detail lines, or customer.

---

## **6. Error Handling and User Guidance**

- Screen indicators (`*IN31`, `*IN32`, `*IN33`) are set if there are validation errors to prompt the user for correction.

---

## **7. Program End**

- On F3 (exit), sets last record indicator (`*INLR`) and returns, ensuring program and resources are cleaned up properly.

---

## **8. Comments and Documentation**

- The code is heavily commented, explaining the logic in Norwegian, including what each block or subroutine is responsible for.

---

## **Summary Table of the Main Types and Flows**

| Item Type  | Internal Code | Displayed As    | Special Line No. |
|------------|---------------|-----------------|------------------|
| Trelast    | Trelast       | Trelast:        | 9000             |
| Pall       | Pall          | Pall:           | 9001             |
| Andre      | Andre         | Andre:          | 9002             |

---

## **Typical Flow**

1. **User calls up the program with an order/suffix.**
2. **Program retrieves and displays order and customer info.**
3. **User enters/modifies additional info (colli lines).**
4. **On F6 (save/print):**
    - Program writes or updates details for Trelast, Pall, Andre.
    - Call to print program (`FP270C`) is made.
5. **User can exit or process another order.**

---

## **Usage Scenario**

Suppose a warehouse worker is processing an order and needs to print colli labels:
- They open FP270R, type in the order, confirm or alter any details (quantities, descriptions for Trelast/Pall/Andre).
- Press F6 to save/update these details in the order and send them to the printer.
- The system ensures all required fields are populated and maintains accurate history and audit (user, date, time).

---

## **Note**

- Some functions (e.g., F4 for order inquiry) are present but commented out, indicating that in this context the feature is not in use or handled elsewhere.
- The code uses "classic" fixed-form RPG IV syntax, which is typical for legacy IBM i (AS/400, iSeries) programs.

---
```