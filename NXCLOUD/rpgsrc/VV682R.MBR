6.30 h option(*nodebugio) datedit(*dmy-) decedit('0.')
6.30 h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
6.30  /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : VV682R
      * Beskrivelse . . : Vare, sletting av varer uten salg
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       141101 HKO  Nytt program
      *       161103 HKO  Fjernet behandling av rabattgruppe
      *       100204 HKO  Kaller slette-program uten *inLR
5.70  * PRGR  241008 bof  Innført prisgruppe /varetype fra lager
6.10  *       150312 bof  Tester om vppdat = *loval
6.20  *       010411 bof  Uvidet vare-pris med prisgiver
6.21  * 6.20  190511 bø   Utvidet vl710r med div. info
6.30  * 6.30  200814 bsa  Innført PDF og excel på listevalg
6.31  * 6.30  051414 bof  Feilretting vedr. hent pris
6.32  * R6.30 150914 bsa  Utvidet parameterliste til FO798R. Håndterer
6.32  *                   flere mailadresser.
6.33  * R6.30 160115 bsa  Utvidet parameterliste til FÅ707R.
6.34  * 6.30  280115 bsa  Skriver til datakø for å trigge java sniffer
6.35  * 6.30  050615 bsa  Nullstill minne for bruk av XML
6.36  * R6.30 180816 bsa  Rokkert på rekkefølge av close printerfile
6.37  * R6.30 311016 bsa  Utvidet streng som legger ut verdier i xml fila
6.37  *                   Enkelte varetekster har så mange norske tegn
6.37  *                   at 15 posisjoner blir for lite.
6.38  * R6.30 140317 bsa  Vasker leverandørens varenummer for ugyldige tegn.
6.39  * 6.30  170918 bkv  Utvidet med trelast sortiment
      *
8.01  *PRG2   140622 bsa  Utvidet prisgruppe fra 1 til 2 posisjoner
8.01  *PRG2               Endringer består kun i kompilering, da alle
8.01  *PRG2               referanser er eksternt definert.
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fvvawpf    if   e           k disk
      *
     fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)
     fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
     fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
6.30 faforl1    if   e           k disk    rename(aforpfr:aforl1r)
6.39 fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
      *
     fvv682p    o    e             printer
6.30 f                                     usropn
      *
      * Local data area
      *
     d                uds
6.30 d l_poff                584    584
6.30 d l_utqm                585    594
6.30 d l_bach                595    635
6.30 d l_arch                636    636  0
6.30 d l_skje                637    637  0
6.30 d l_exlp                639    639  0
6.30 d l_mail                640    640  0
6.30 d l_prfi                750    750  0
6.30 d l_outq                810    819
6.30 d l_copy                838    843  0
6.30 d l_ruti                800    809
     d l_wsid                901    910
     d l_user                911    920
6.30 d l_filg                931    933
6.30 d l_firm                944    946  0
6.30 d l_avde                947    950  0
6.30 d l_fnav                951    980
5.70 d l_lagr               1001   1002  0
      *
      * Datastruktur for parameterliste -inn
      *
     d                 ds
     d d_list                        80
     d  d_firm                        3  0 overlay(d_list:1)
     d  d_kntr                        1  0 overlay(d_list: 4)
     d  d_batc                       10    overlay(d_list: 5)
     d  d_srt1                        1  0 overlay(d_list:15)
     d  d_srt2                        1  0 overlay(d_list:16)
     d  d_srt3                        1  0 overlay(d_list:17)
     d  d_srt4                        1  0 overlay(d_list:18)
      *
      * Definering av parametre
      *
     d p_list          s             80
      *
      * Definering av variabler i nøkler
      *
     d vvenl1_vare     s                   like(vevare)
     d vvprl1_vare     s                   like(vpvare)
6.20 d vvprl1_ldor     s                   like(vpldor)
5.70 d vvprl1_prgr     s                   like(vpprgr)
     d vvprl1_enhe     s                   like(vpenhe)
     d rlevl1_levr     s                   like(rllevr)
     d vugrl1_uogr     s                   like(vguogr)
     d vugrl1_uhgr     s                   like(vguhgr)
     d vugrl1_uugr     s                   like(vguugr)
6.30 d aforl1_ruti     s                   like(afruti)
      *
      * Definering av variable
      *
     d b_enh1          s              1    inz(*off)
     d b_inlr          s              1    inz(*on)
     d b_pris          s              1    inz(*off)
      *
     d w_timestamp     s             12  0
     d w_mvap          s              6  2
     d w_mvat          s              5  4
     d w_mvaf          s             10  9
     d w_udat          s               d   datfmt(*iso)
     d w_kode          s              1  0
      *
     d w_firm          s                   like(vvfirm)
     d w_kopr          s                   like(vpkopr)
     d w_dekn          s                   like(vvdekn)
     d w_enhe_gml      s                   like(vpenhe)
     d w_lety_gml      s                   like(vplety)
5.70 d w_prgr          s                   like(vpprgr)
5.70 d w_lage          s              2  0
5.70 d w_vtyp          s                   like(vvvtyp)
6.20 d w_ldor          s                   like(vpldor)
6.21 d w_utda          s                   like(vvudat)
6.39 d w_lv_nobb       s                   like(vvlnob)
6.39 d w_lv_modn       s                   like(vvlmod)
6.39 d w_lv_lldo       s                   like(vvlnle)
6.39 d w_lv_llva       s                   like(vvllva)
6.33 d w_mail          s                   like(aamail)
6.33 d w_weba          s                   like(aaweba)
6.38 d w_lvar          s            100
      *
6.30 d p_mail          s              1
6.30 d p_kund          s              6  0
6.30 d p_kpro          s              6  0
6.nu d p_numm          s              8  0
6.32 d p_suff          s              2  0
6.30 d p_selg          s              4  0
6.30 d p_serv          s             35
6.30 d p_stat          s              1
6.30 d p_kule          s              1
6.30 d p_navn          s             30
6.30 d p_emal          s             50
6.30 d p_ema2          s             50
6.32 d p_ema3          s             50
6.32 d p_kopi          s             50
6.30 d p_emne          s             50
6.30 d p_txt1          s             50
6.30 d p_txt2          s             50
6.30 d p_txt3          s             50
6.30 d p_txt4          s             50
6.30 d p_pers          s             50
6.30 d p_inif          s             40
6.30 d p_in03          s              1
6.30 d p_btyp          s            100
6.30 d p_ok            s              1
6.30 d p_lr            s              1
6.30 d p_str_in        s            512
6.30 d p_str_out       s            512
6.34 d p_filg          s             10
6.34 d p_xmlf          s            256
6.30 d w_tek1          s             75
6.30 d w_lnav          s             50
6.30 d w_mvak          s              3
6.30 d w_dspl          s            100
6.30 d w_jkey          s             41
6.30 d w_jstat         s              2  0
6.30 d w_jtext         s            200
6.30 d w_pdf           s              1  0
6.30 d w_pdf_ds        s            512
6.30 d w_rtyp          s             50
6.30 d w_dato2         s             12  0
6.30 d w_ddmy          s              6  0
6.30 d w_tids          s              6  0
6.30 d w_ruti          s             10
6.30 d w_txt1          s             75
6.30 d w_mime          s             24
6.30 d w_date          s               d   datfmt(*iso)
6.30 d w_1fnav         s             50
6.30 d w_1fad1         s             50
6.30 d w_1fad2         s             50
6.30 d w_prfi          s              1  0
6.30 d w_ffir          s              3  0
6.30 d w_fnav          s             30
6.30 d w_fad1          s             30
6.30 d w_fad2          s             30
6.30 d w_fste          s             30
6.30 d w_fftx          s             30
6.30 d w_tfax          s              8
6.30 d w_ftlf          s             11
6.30 d w_ffax          s             11
6.30 d w_pemne         s             75
6.30 d w_ptxt1         s             75
6.30 d w_ptxt2         s             75
6.30 d w_ptxt3         s             75
6.30 d w_ptxt4         s             75
6.30 d w_ppers         s             75
6.30 d w_avde          s              4  0
6.30 d w_mtxt          s            300
6.30 d h_valu          s             15
6.37 d*d_valu          s             50
6.37 d d_valu          s            100
6.30 d d_type          s             10
      *
6.30 d b_excl          s              1    inz(*off)
      *
6.30 d splfname2       s             10a
6.30 d jobname2        s             10a
6.30 d username2       s             10a
6.30 d jobnbr2         s              6a
6.30 d splfnbr2        s             10i 0
6.30 d splfname3       s             10a
6.30 d jobname3        s             10a
6.30 d username3       s             10a
6.30 d jobnbr3         s              6a
6.30 d splfnbr3        s             10i 0
6.30 d p_tagg0         s             20
6.30 d p_tagg0val      s             50
6.30 d p_tagg1         s             20
6.30 d p_tagg1val      s             50
6.30 d p_tagg2         s             20
6.30 d p_tagg2val      s             50
6.30 d p_tagg3         s             20
6.30 d p_tagg3val      s             50
6.30 d p_tagg4         s             20
6.30 d p_tagg4val      s             50
6.30 d p_tagg5         s             20
6.30 d p_tagg5val      s             50
6.30 d p_tagg6         s             20
6.30 d p_tagg6val      s             50
6.30 d p_tagg7         s             20
6.30 d p_tagg7val      s             50
6.30 d p_tagg8         s             20
6.30 d p_tagg8val      s             50
6.30 d p_tagg9         s             20
6.30 d p_tagg9val      s             50
6.30 d p_refn          s             50
6.30 d p_dspl          s            100
6.30  *
6.30 d qsprilsp        pr                  extpgm('QSPRILSP')
6.30 d rcvvar                     32767a   options(*varsize)
6.30 d rcvvarlen                     10i 0 const
6.30 d format                         8a   const
6.30 d errorcode                  32767a   options(*varsize)
6.30  *
6.30 d sprl0100        ds
6.30 d  bytesrtn                     10i 0
6.30 d  bytesavl                     10i 0
6.30 d  splfname                     10a
6.30 d  jobname                      10a
6.30 d  username                     10a
6.30 d  jobnbr                        6a
6.30 d  splfnbr                      10i 0
6.30 d  systemname                    8a
6.30 d  createdate                    7a
6.30 d                                1a
6.30 d  createtime                    6a
6.30  *
6.30 d errorcode       ds
6.30 d  bytesprov                    10i 0 inz(0)
6.30 d  byteavail                    10i 0 inz(0)
      *
6.30  *
6.30 d XML_Output      s            256a   Varying
6.30 d XML_path        s            256a   Varying
6.30 d                                     Inz('/home/asp/print/adb')
6.30 d jasper_mal      s            256a
6.30 d jasper_logo     s            256a   varying
6.30 d tmpdate         s               D
6.30 d tmptime         s               T
6.30 d crlf            c                   const(X'0d25')
6.30  *
6.30 d d_pdf_ds        ds
6.30 d  d_xmlm                       75
6.30 d  d_jasm                       75
6.30 d  d_logo                       75
6.30 d  d_path                      100
6.30 d  d_emal                       50
6.30 d  d_fifo                       75
6.30 d  d_fkop                        1
6.34 d  d_dtaq                        1
6.34 d  d_sign                        1
6.30  /copy prototypeb
6.30  /copy usec
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Utskrift av header
      *
     c                   exsr      hode
      *
      * Utskrift av vareregister
      *
     c                   exsr      behandling
6.30  * Generer xml for videre utskrift
6.30 c                   if        l_poff = '1' and
6.30 c                             b_excl = *off
6.30 c                   exsr      spoolnbr
6.36 c                   close     vv682p
6.36 c                   exsr      xml_create
6.30 c                   exsr      pdf_preview
6.30 c                   endif
6.30  * Excel rapport
6.30 c                   if        l_poff = '1' and
6.30 c                             b_excl = *on
6.30 c                   exsr      xml_end
6.30  * Hvis EXCEL må vi forhåndsvise linken, slik at vi får den opp i browser
6.30 c                   exsr      pdf_preview
6.30 c                   endif
6.30  * Avslutt jobbiden
6.30 c                   if        l_poff = '1'
6.30 c                   call      'AB710R'
6.30 c                   parm                    l_bach
6.30 c                   endif
      *
      * Avslutt
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering og utskrift av hode-opplysninger
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hode          begsr
      *
      * Overskrift
      *
     c                   if        d_kntr = 1
     c                   eval      a1otxt = 'Kontrolliste'
     c                   else
     c                   eval      a1otxt = '  Kvittering'
     c                   endif
      *
      * Legger inn arb.stasjon og bruker i faste felter
      *
     c                   eval      a1firm = w_firm
     c                   eval      a1user = l_user
     c                   eval      a1wsid = l_wsid
     c                   time                    w_timestamp
     c                   move      w_timestamp   a1date
     c                   movel     w_timestamp   a1time
      *
      * Henter firmaopplysninger
      *
     c     afirl1_key    chain     afirl1r                            90
     c                   eval      a1fnav = aafnav
      *
      * Sortering
      *
     c                   select
     c                   when      d_srt1 = 1
     c                   eval      a2sort = 'Varegruppe'
     c                   when      d_srt2 = 1
     c                   eval      a2sort = 'Leverandør'
     c                   when      d_srt3 = 1
     c                   eval      a2sort = 'Varetekst'
     c                   when      d_srt4 = 1
     c                   eval      a2sort = 'Varenummer'
     c                   endsl
      *
     c                   select
     c                   when      d_srt1 = 2
     c                   eval      a2sort = %trim(a2sort) + ' - Varegruppe'
     c                   when      d_srt2 = 2
     c                   eval      a2sort = %trim(a2sort) + ' - Leverandør'
     c                   when      d_srt3 = 2
     c                   eval      a2sort = %trim(a2sort) + ' - Varetekst'
     c                   when      d_srt4 = 2
     c                   eval      a2sort = %trim(a2sort) + ' - Varenummer'
     c                   endsl
      *
     c                   select
     c                   when      d_srt1 = 3
     c                   eval      a2sort = %trim(a2sort) + ' - Varegruppe'
     c                   when      d_srt2 = 3
     c                   eval      a2sort = %trim(a2sort) + ' - Leverandør'
     c                   when      d_srt3 = 3
     c                   eval      a2sort = %trim(a2sort) + ' - Varetekst'
     c                   when      d_srt4 = 3
     c                   eval      a2sort = %trim(a2sort) + ' - Varenummer'
     c                   endsl
      *
      * Skriver heading
      *
6.30 c                   if        b_excl = *off
     c                   write     a1hdr
     c                   write     a2hdr
     c                   write     a3hdr
6.30 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Leser arbeidsregsiter, og behandler utskrift av detaljlinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     behandling    begsr
      *
     c                   read      vvawpf                                 90
     c                   dow       *in90 = *off
      *
      * Skriver detaljlinje
      *
     c                   exsr      detalj
      *
      * Dersom ikke kontrolliste, kalles program for sletting av varer
      * med relasjoner
      *
     c                   if        d_kntr = 0
     c                   eval      b_inlr = *on
     c                   call      'VV400R'
     c                   parm                    vvfirm
     c                   parm                    vvvare
     c                   parm                    b_inlr
     c                   endif
      *
      * Leser neste rad
      *
     c                   read      vvawpf                                 90
     c                   enddo
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine utskrift av detaljlinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     detalj        begsr
      *
6.31 c                   eval      b_pris = *off
      *
      * henter varetype
      *
5.70 c                   call      'VL710R'
5.70 c                   parm                    w_firm
5.70 c                   parm                    vvvare
5.70 c                   parm                    w_lage
5.70 c                   parm                    w_vtyp
6.21 c                   parm                    w_utda
6.21 c                   parm                    w_ldor
6.21 c                   parm                    b_inlr
6.39 c                   parm                    w_lv_nobb
6.39 c                   parm                    w_lv_modn
6.39 c                   parm                    w_lv_lldo
6.39 c                   parm                    w_lv_llva
      *
      * Henter vareinformasjon
      *
     c                   eval      d1ogrp = vvogrp
     c                   eval      d1hgrp = vvhgrp
     c                   eval      d1ugrp = vvugrp
     c                   eval      d1ldor = vvldor
     c                   eval      d1tek1 = vvtek1
     c                   eval      d1vare = vvvare
6.39 c                   if        w_lv_nobb > 0
6.39 c                   eval      d1nobb = w_lv_nobb
6.39 c                   eval      d1lvar = w_lv_llva
6.39 c                   else
     c                   eval      d1nobb = vvnobb
     c                   eval      d1lvar = vvlvar
6.39 c                   endif
     c                   eval      d1lnav = *blank
     c                   eval      d1kpri = vvkpri
     c                   eval      d1vtyp = w_vtyp
     c                   eval      d1enhe = *blank
     c                   eval      d1lety = 0
     c                   eval      d1pdat = 0
     c                   eval      d1inpr = 0
     c                   eval      d1kopr = 0
     c                   eval      d1bupr = 0
     c                   eval      d1sapr = 0
     c                   eval      d1saim = 0
     c                   eval      d1dekn = 0
      *
      * Henter leverandørnavn
      *
     c                   eval      rlevl1_levr = vvldor
     c     rlevl1_key    chain     rlevl1                             91
     c                   if        *in91 = *off
     c                   eval      d1lnav = rlnavn
     c                   endif
      *
      * Henter og skriver priser for alle enheter/leveringstyper
      *
     c                   eval      b_enh1 = *on
     c                   eval      w_enhe_gml = *blank
     c                   eval      w_lety_gml = 0
      *
      *
     c                   eval      vvenl1_vare = vvvare
     c     vvenl1_key    setll     vvenl1
     c     vvenl1_key    reade     vvenl1                                 91
     c                   dow       *in91 = *off
6.20  * 1. leverandør for lageret
6.20 c                   eval      vvprl1_ldor = w_ldor
6.20 c                   exsr      hent_prlev
6.20 c                   if        b_pris = *off  and
6.20 c                             w_ldor <> vvldor
6.20  * 2. hovedleverandør
6.20 c                   eval      vvprl1_ldor = vvldor
6.20 c                   exsr      hent_prlev
6.20 c                   if        b_pris = *off
6.20  * siste mulighet...
6.20 c                   eval      vvprl1_ldor = 0
6.20 c                   exsr      hent_prlev
6.20 c                   endif
6.20 c                   endif
      *
      *
     c     vvenl1_key    reade     vvenl1                                 91
     c                   enddo
      *
     c                   endsr
      *
      *
6.20  *------------------------------------------------------------------------------
6.20  *  Beregner pris i forhold til test på prisgivere
6.20  *------------------------------------------------------------------------------
6.20 c     hent_prlev    begsr
6.20  *
6.20 c                   eval      vvprl1_vare = vevare
6.20 c                   eval      vvprl1_prgr = w_prgr
6.20 c                   eval      vvprl1_enhe = veenhe
6.20 c     vvprl1_key    setll     vvprl1
6.20 c     vvprl1_key    reade     vvprl1                                 92
6.20 c                   dow       *in92 = *off
6.20  *
6.20 c                   eval      b_pris = *on
6.20 c                   exsr      hent_priser
6.20  *
6.20 c                   if        b_enh1 = *on or
6.20 c                             vpenhe <> w_enhe_gml or
6.20 c                             vplety <> w_lety_gml
6.20  *
6.30 c                   if        b_excl = *on
6.30 c                   exsr      xml_detal
6.30 c                   else
6.20 c                   write     d1dtl                                30
6.20 c                   exsr      overflow
6.30 c                   endif
6.20  *
6.20 c                   eval      b_enh1 = *off
6.20 c                   eval      w_enhe_gml = vpenhe
6.20 c                   eval      w_lety_gml = vplety
6.20  *
6.20 c                   endif
6.20  *
6.20 c     vvprl1_key    reade     vvprl1                                 92
6.20 c                   enddo
6.20  *
6.20  * Dersom pris ikke finnes for oppgitt prisgruppe, hentes pris fra
6.20  * prisgruppe = *blank
6.20 c                   if        b_pris = *off and
6.20 c                             w_prgr <> *blank
6.20  *
6.20 c                   eval      vvprl1_vare = vevare
6.20 c                   eval      vvprl1_prgr = *blank
6.20 c                   eval      vvprl1_enhe = veenhe
6.20 c     vvprl1_key    setll     vvprl1
6.20 c     vvprl1_key    reade     vvprl1                                 92
6.20 c                   dow       *in92 = *off
6.20  *
6.20 c                   eval      b_pris = *on
6.20 c                   exsr      hent_priser
6.20  *
6.20 c                   if        b_enh1 = *on or
6.20 c                             vpenhe <> w_enhe_gml or
6.20 c                             vplety <> w_lety_gml
6.20  *
6.30 c                   if        b_excl = *on
6.30 c                   exsr      xml_detal
6.30 c                   else
6.20 c                   write     d1dtl                                30
6.20 c                   exsr      overflow
6.30 c                   endif
6.20  *
6.20 c                   eval      b_enh1 = *off
6.20 c                   eval      w_enhe_gml = vpenhe
6.20 c                   eval      w_lety_gml = vplety
6.20  *
6.20 c                   endif
6.20  *
6.20 c     vvprl1_key    reade     vvprl1                                 92
6.20 c                   enddo
6.20  *
6.20 c                   endif
6.20  *
6.20 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for henting av priser for enhet/leveringstype
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_priser   begsr
      *
     c                   eval      d1enhe = vpenhe
     c                   eval      d1lety = vplety
     c                   eval      d1inpr = vpinpr
     c                   eval      d1kopr = vpkopr
     c                   eval      d1bupr = vpbupr
     c                   eval      d1sapr = vpsapr
     c                   eval      d1saim = 0
     c                   eval      d1dekn = 0
      *
6.10 c                   if        vppdat <> *loval
     c     *dmy          move      vppdat        d1pdat
6.10 c                   else
6.10 c                   eval      d1pdat = 0
6.10 c                   endif
      *
     c                   if        b_enh1 = *off
     c                   eval      d1ogrp = 0
     c                   eval      d1hgrp = 0
     c                   eval      d1ugrp = 0
     c                   eval      d1ldor = 0
     c                   eval      d1tek1 = *blank
     c                   eval      d1vare = *blank
     c                   eval      d1nobb = 0
     c                   eval      d1lvar = *blank
     c                   eval      d1lnav = *blank
     c                   eval      d1kpri = *blank
     c                   eval      d1vtyp = *blank
     c                   endif
      *
      * Beregner salgspris inkl. mva
      *
     c                   eval      d1saim = d1sapr * w_mvat
      *
     c                   if        d1saim <> 0
     c                   eval      w_kode = 4
     c                   call      'FA909R'
     c                   parm                    w_firm
     c                   parm                    vvvare
     c                   parm                    w_kode
     c                   parm                    d1saim
     c                   endif
      *
      * Beregner dekningsgrad (DG)
      * Dersom kostpris = 0, beregnes kostpris ut fra standard deknings-
      * bidrag på vare eller undergruppe
      *
     c                   eval      w_kopr = d1kopr
      *
     c                   if        w_kopr = 0
      *
     c                   eval      w_dekn = vvdekn
     c                   if        w_dekn = 0
     c                   eval      vugrl1_uogr = vvogrp
     c                   eval      vugrl1_uhgr = vvhgrp
     c                   eval      vugrl1_uugr = vvugrp
     c     vugrl1_key    chain     vugrl1                             91
     c                   if        *in91 = *off
     c                   eval      w_dekn = vgudek
     c                   endif
     c                   endif
      *
     c                   eval      w_kopr = d1sapr * w_dekn / 100
     c                   if        w_kopr <> 0
     c                   eval      w_kopr = d1sapr - w_kopr
     c                   endif
      *
     c                   endif
      *
     c                   if        d1sapr <> 0
     c                   select
     c                   when      (100 - (w_kopr * 100 / d1sapr)) < -999,99
     c                   eval      d1dekn = -999,99
     c                   when      (100 - (w_kopr * 100 / d1sapr)) > 999,99
     c                   eval      d1dekn = 999,99
     c                   other
     c                   eval(h)   d1dekn = 100 - (w_kopr * 100 / d1sapr)
     c                   endsl
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     overflow      begsr
      *
     c                   if        *in30 = *on
     c                   write     a1hdr
     c                   write     a3hdr
     c                   endif
      *
     c                   endsr
      *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Finner spool som er generert av jobben
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     spoolnbr      begsr
6.30  /Free
6.30
6.30           QSPRILSP( SPRL0100
6.30                   : %size(SPRL0100)
6.30                   : 'SPRL0100'
6.30                   : errorcode );
6.30  /End-free
6.30 c*
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Kaller eget program for generering av xml fil. Eget pgm         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_create    begsr
6.30  *
6.30 c                   eval      splfname2 = *blanks
6.30 c                   eval      splfname3 = *blanks
6.30 c                   eval      jobname2 = *blanks
6.30 c                   eval      jobname3 = *blanks
6.30 c                   eval      username2 = *blanks
6.30 c                   eval      username3 = *blanks
6.30 c                   eval      jobnbr2 = *blanks
6.30 c                   eval      jobnbr3 = *blanks
6.30 c                   eval      splfnbr2 = *zeros
6.30 c                   eval      splfnbr3 = *zeros
6.30 c                   eval      p_btyp = 'DELVARE'
6.30 c                   eval      p_dspl = 'Slettede varer uten salg - kjørt +
6.30 c                                       dato: '+ %char(udate)
6.30 c                   eval      p_refn = 'SLV-' + %char(udate)
6.30 c                   eval      p_tagg0 = *blanks
6.30 c                   eval      p_tagg0val = *blanks
6.30 c                   eval      p_tagg1 = *blanks
6.30 c                   eval      p_tagg1val = *blanks
6.30 c                   eval      p_tagg2 = *blanks
6.30 c                   eval      p_tagg2val = *blanks
6.30 c                   eval      p_tagg3 = *blanks
6.30 c                   eval      p_tagg3val = *blanks
6.30 c                   eval      p_tagg4 = *blanks
6.30 c                   eval      p_tagg4val = *blanks
6.30 c                   eval      p_tagg5 = *blanks
6.30 c                   eval      p_tagg5val = *blanks
6.30 c                   eval      p_tagg6 = *blanks
6.30 c                   eval      p_tagg6val = *blanks
6.30 c                   eval      p_tagg7 = *blanks
6.30 c                   eval      p_tagg7val = *blanks
6.30 c                   eval      p_tagg8 = *blanks
6.30 c                   eval      p_tagg8val = *blanks
6.30 c                   eval      p_tagg9 = *blanks
6.30 c                   eval      p_tagg9val = *blanks
6.30  *
6.30 c                   call      'AP627R'
6.30 c                   PARM                    splfname
6.30 c                   PARM                    jobname
6.30 c                   PARM                    username
6.30 c                   PARM                    jobnbr
6.30 c                   PARM                    splfnbr
6.30 c                   PARM                    splfname2
6.30 c                   PARM                    jobname2
6.30 c                   PARM                    username2
6.30 c                   PARM                    jobnbr2
6.30 c                   PARM                    splfnbr2
6.30 c                   PARM                    splfname3
6.30 c                   PARM                    jobname3
6.30 c                   PARM                    username3
6.30 c                   PARM                    jobnbr3
6.30 c                   PARM                    splfnbr3
6.30 c                   parm                    p_tagg0
6.30 c                   parm                    p_tagg0val
6.30 c                   parm                    p_tagg1
6.30 c                   parm                    p_tagg1val
6.30 c                   parm                    p_tagg2
6.30 c                   parm                    p_tagg2val
6.30 c                   parm                    p_tagg3
6.30 c                   parm                    p_tagg3val
6.30 c                   parm                    p_tagg4
6.30 c                   parm                    p_tagg4val
6.30 c                   parm                    p_tagg5
6.30 c                   parm                    p_tagg5val
6.30 c                   parm                    p_tagg6
6.30 c                   parm                    p_tagg6val
6.30 c                   parm                    p_tagg7
6.30 c                   parm                    p_tagg7val
6.30 c                   parm                    p_tagg8
6.30 c                   parm                    p_tagg8val
6.30 c                   parm                    p_tagg9
6.30 c                   parm                    p_tagg9val
6.30 c                   PARM                    l_bach
6.30 c                   PARM                    p_btyp
6.30 c                   PARM                    p_refn
6.30 c                   PARM                    p_dspl
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     pdf_preview   begsr
6.30 c                   if        l_skje = 1 or
6.30 c                             b_excl = *on
6.30  * Vi kaller program for launch av PDF i browser
6.30 c                   call      'AP621R'
6.30 c                   parm                    l_bach
6.30  *
6.30 c                   endif
6.30  *
6.30 c                   endsr
6.30  *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_envm      begsr
6.30  *
6.30 c                   eval      w_rtyp = 'XsltCommand'
6.30 c                   eval      w_mime = 'application/vnd.ms-excel'
6.30 c                   eval      d_jasm = *blank
6.30  *
6.30  /Free
6.30       // Finne nytt batch nummer
6.30           UpdHTMLVar('BatchNo':               w_jkey);
6.30           UpdHTMLVar('Batchtype':            'EXCEL');
6.30           UpdHTMLVar('Username':              l_user);
6.30           WrtSection('Topp');
6.30       // Finn report command variabler
6.30           UpdHTMLVar('User':                        l_user);
6.30           UpdHTMLVar('PW':                             ' ');
6.30           UpdHTMLVar('IPAdr':                          ' ');
6.30           UpdHTMLVar('Schema':                'ADB'+l_filg);
6.30           UpdHTMLVar('Companyno':            %char(l_firm));
6.30           WrtSection('Credential');
6.30       // Finn report command variabler
6.30           UpdHTMLVar('Reportcommandtype':           w_rtyp);
6.30      //   UpdHTMLVar('Jaspertemplate':              d_jasm);
6.30           UpdHTMLVar('Logo':                           ' ');
6.30           UpdHTMLVar('Keepspool':                   'true');
6.30           UpdHTMLVar('Xsltschemapath':                 ' ');
6.30           UpdHTMLVar('Mimetype':                    w_mime);
6.30           WrtSection('ReportCommand');
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Heading                        *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_head      begsr
6.30  *
6.30 c                   eval      aforl1_ruti = l_ruti
6.30 c     aforl1_key    chain     aforl1r
6.30  * Hvis mail skal skrives, må vi hente mail informasjon
6.30  *
6.30 c                   if        l_mail = 1
6.30 c                   eval      p_kule = 'L'
6.30 c                   eval      p_kund = vvldor
6.30 c                   eval      p_kpro = *zeros
6.30 c                   eval      p_numm = *zeros
6.32 c                   eval      p_suff = *zeros
6.30 c                   eval      p_selg = *zeros
6.30 c                   eval      p_in03 = *off
6.30  * Henter ut mailserver
6.30 c                   eval      p_serv = *blank
6.30 c                   eval      p_stat = *blank
6.30 c                   call      'AM705C'
6.30 c                   parm                    p_serv
6.30 c                   parm                    p_stat
6.30  *
6.30 c                   call      'FO798R'
6.30 c                   parm                    p_kule
6.30 c                   parm                    p_kund
6.30 c                   parm                    p_kpro
6.30 c                   parm                    p_numm
6.32 c                   parm                    p_suff
6.30 c                   parm                    p_selg
6.30 c                   parm                    p_navn
6.30 c                   parm                    p_emal
6.32 c                   parm                    p_ema2
6.32 c                   parm                    p_ema3
6.30 c                   parm                    p_emne
6.30 c                   parm                    p_txt1
6.30 c                   parm                    p_txt2
6.30 c                   parm                    p_txt3
6.30 c                   parm                    p_txt4
6.30 c                   parm                    p_pers
6.32 c                   parm                    p_kopi
6.30 c                   parm                    p_inif
6.30 c                   parm                    p_in03
6.30  * Scann av strenger
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_emne        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_pemne
6.30  * Scann av strenger
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt1
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt2
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt3        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt3
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt4        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt4
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_pers        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ppers
6.30  *
6.30 c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
6.30 c                                      %trim(w_ptxt2) + crlf +
6.30 c                                      %trim(w_ptxt3) + crlf +
6.30 c                                      %trim(w_ptxt4) + crlf +
6.30 c                                      %trim(w_ppers)
6.30  *
6.32 c                   if        p_kopi = *blanks
6.32 c                   eval      p_kopi = d_emal
6.30 c                   endif
6.30  *
6.30 c                   if        p_in03 = *off
6.30  *
6.30  /Free
6.30       // Skriv mailinformasjon
6.32           WrtSection('MailCommandStart');
6.32      //   UpdHTMLVar('Receivers':           p_emal);
6.32           if %Trim(p_emal)<> *blanks;
6.32           UpdHTMLVar('Receivers':           p_emal);
6.32           WrtSection('MailReceiver');
6.32           endif;
6.32           if %Trim(p_ema2)<> *blanks;
6.32           UpdHTMLVar('Receivers':           p_ema2);
6.32           WrtSection('MailReceiver');
6.32           endif;
6.32           if %Trim(p_ema3)<> *blanks;
6.32           UpdHTMLVar('Receivers':           p_ema3);
6.32           WrtSection('MailReceiver');
6.32           endif;
6.30           UpdHTMLVar('CC':                     ' ');
6.32           UpdHTMLVar('BCC':                 p_kopi);
6.32           UpdHTMLVar('Sender':              p_kopi);
6.30           UpdHTMLVar('Subject':             w_pemne);
6.30           UpdHTMLVar('Message':             w_mtxt);
6.30           UpdHTMLVar('SMTPServer':          p_serv);
6.30           UPDHTMLVar('SMTPUser':               ' ');
6.30           UPDHTMLVar('SMTPPw':                 ' ');
6.32      //   WrtSection('MailCommand');
6.38           WrtSection('MailCommandEnd');
6.30  /End-free
6.30 c                   endif
6.30 c                   endif
6.30  * Scann av rutinetekst
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     aftxt1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_txt1
6.30  *
6.30  * Vi må oversette aktuelle tekster til "xml" tegn - Firma
6.30 c                   eval      w_1fnav = *blank
6.30 c                   eval      w_1fad1 = *blank
6.30 c                   eval      w_1fad2 = *blank
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_fnav        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1fnav
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_fad1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1fad1
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_fad2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_1fad2
6.30  *
6.30  /Free
6.30
6.30       // Skriv firmavariabler
6.30           UpdHTMLVar('Reporttext':            w_txt1);
6.30           UpdHTMLVar('Subheader':                ' ');
6.30           UpdHTMLVar('CompanyName':          w_1fnav);
6.30           UpdHTMLVar('Companyadress1':       w_1fad1);
6.30           UpdHTMLVar('Companyadress2':       w_1fad2);
6.30           UpdHTMLVar('Companypostalcode':        ' ');
6.30           UpdHTMLVar('Companypostoffice':     w_fste);
6.30           UpdHTMLVar('Companyphone':          w_ftlf);
6.30           UpdHTMLVar('Companyfax':            w_ffax);
6.30           UpdHTMLVar('Companyorgno':   %char(aafftn));
6.30           UpdHTMLVar('Companygiro':    %char(aafbgi));
6.30           UpdHTMLVar('Companyemail':          aamail);
6.30           UpdHTMLVar('Companywebpage': %trim(aaweba));
6.30
6.30           test(de) *dmy w_ddmy;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(w_ddmy : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
6.30
6.30           test(te) *hms w_tids;
6.30           if %error;
6.30           tmptime = *loval;
6.30           else;
6.30           tmptime = %time(w_tids : *hms);
6.30           endif;
6.30           UpdHTMLVar('Creationtime': %char(tmptime : *hms));
6.30           WrtSection('DocumentInformation');
6.30
6.30           WrtSection('FreedefHeader');
6.30
6.30  /End-free
6.30  *
6.30 c                   eval      h_valu='Overgruppe'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Hovedgruppe'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Undergruppe'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Leverandør'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Varetekst 1'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Varenr'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Nobb-nr'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Lev.varenr'
6.30 c                   exsr      xml_head_val
6.30 c**                 eval      h_valu='Rabattgruppe'
6.30 c**                 exsr      xml_head_val
6.30 c                   eval      h_valu='P'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='T'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Enhet'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='PG'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='L'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Prisdato'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Innkj.pris'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Kostpris'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Butikkpris'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Salgspris eks.mva'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Salgspris ink.mva'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='DG (%)'
6.30 c                   exsr      xml_head_val
6.30  *
6.30  /Free
6.30
6.30       // Avslutt headervalues
6.30           WrtSection('HeaderLineEnd');
6.30
6.30  /End-free
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Heading                        *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_head_val  begsr
6.30  *
6.30  /Free
6.30
6.30       // Skriv headervalue
6.30           UpdHTMLVar('Headervalue':  %trim(h_valu));
6.30           WrtSection('HeaderLineValue');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - detaljlinjer                   *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_detal     begsr
6.30  *
6.30  /Free
6.30
6.30       // Skriv detaljer
6.30           WrtSection('DetailLineStart');
6.30
6.30           WrtSection('FreedefLine');
6.30
6.30  /End-free
6.30  * Varetekst
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     d1tek1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_tek1
6.30  * Leverandørnavn
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     d1lnav        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_lnav
6.38  * Leverandørens varenummer
6.38 c                   eval      p_str_in = *blank
6.38 c                   eval      p_lr = '0'
6.38 c                   movel     d1lvar        p_str_in
6.38 c                   call      'AP613R'
6.38 c                   parm                    p_str_in
6.38 c                   parm                    p_str_out
6.38 c                   parm                    p_lr
6.38 c                   movel     p_str_out     w_lvar
6.38  *
6.30  * Så skriver vi de foskjellige linjene
6.30  *
6.30  * Overgruppe
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1ogrp)
6.30 c                   exsr      xml_line_val
6.30  * Hovedgruppe
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1hgrp)
6.30 c                   exsr      xml_line_val
6.30  * Undegruppe
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1ugrp)
6.30 c                   exsr      xml_line_val
6.30  * Leverandør
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1ldor)
6.30 c                   exsr      xml_line_val
6.30  * Varetekst
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(w_tek1)
6.30 c                   exsr      xml_line_val
6.30  * Varenummer
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(d1vare)
6.30 c                   exsr      xml_line_val
6.30  * Nobbnummer
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1nobb)
6.30 c                   exsr      xml_line_val
6.30  * Leverandørens varenummer
6.30 c                   eval      d_type='Char'
6.38 c                   eval      d_valu=%trim(w_lvar)
6.30 c                   exsr      xml_line_val
6.30  * Kpris
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(d1kpri)
6.30 c                   exsr      xml_line_val
6.30  * Varetype
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(d1vtyp)
6.30 c                   exsr      xml_line_val
6.30  * Enhet
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(d1enhe)
6.30 c                   exsr      xml_line_val
6.30  * Prisgruppe
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(d1prgr)
6.30 c                   exsr      xml_line_val
6.30  * Leveringstype
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1lety)
6.30 c                   exsr      xml_line_val
6.30  * Prisdato
6.30 c                   eval      d_type='Date'
6.30  /Free
6.30
6.30           UpdHTMLVar('type':         %trim(d_type));
6.30           test(de) *dmy d1pdat;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(d1pdat : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Linevalue':   %char(tmpdate : *iso));
6.30           WrtSection('DetailLineValue');
6.30
6.30  /End-free
6.30  *
6.30  * Innkjøpspris
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1inpr)
6.30 c                   exsr      xml_line_val
6.30  * Kostpris
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1kopr)
6.30 c                   exsr      xml_line_val
6.30  * Butikkpris
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1bupr)
6.30 c                   exsr      xml_line_val
6.30  * Salgspris eks mva
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1sapr)
6.30 c                   exsr      xml_line_val
6.30  * Salgspris ink mva
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1saim)
6.30 c                   exsr      xml_line_val
6.30  * Dekningsgrad
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1dekn)
6.30 c                   exsr      xml_line_val
6.30  *
6.30  /Free
6.30
6.30       // Skriv avslutning
6.30
6.30           WrtSection('DetailLineEnd');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Linjer                         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_line_val  begsr
6.30  *
6.30  /Free
6.30
6.30       // Skriv linevalue
6.30           UpdHTMLVar('type':         %trim(d_type));
6.30           UpdHTMLVar('Linevalue':    %trim(d_valu));
6.30           WrtSection('DetailLineValue');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Slutt                          *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_end       begsr
6.30  *
6.30  /Free
6.30           WrtSection('EndExcelLines');
6.30  /End-free
6.30  *
6.30  * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
6.30  *
6.30 c                   if        l_arch = 1
6.30  * Lag tag for vising i arkivklienten
6.30 c                   eval      w_dspl = *blank
6.30 c                   eval      w_dspl = 'Sletting av varer uten salg'
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_dspl        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_dspl
6.30  /Free
6.30       // Skriv metattags
6.30
6.30           UpdHTMLVar('Displaytag':     %trim(w_dspl));
6.30           WrtSection('ArchiveCommandStart');
6.30
6.30           UpdHTMLVar('Metavalue':                ' ');
6.30           UpdHTMLVar('Metakey':              'EXCEL');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             l_user);
6.30           UpdHTMLVar('Metakey':             'BRUKER');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue': %char(w_date:*iso));
6.30           UpdHTMLVar('Metakey':               'DATO');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             w_txt1);
6.30           UpdHTMLVar('Metakey':         'RUTINETEKST');
6.30           WrtSection('MetaTag');
6.30
6.30           WrtSection('ArchiveCommandEnd');
6.30  /End-free
6.30  *
6.30 c                   endif
6.30  *
6.30  /Free
6.30           WrtSection('Footer');
6.30  /End-free
6.30  *
6.30 c                   eval      XML_Output = XML_path + l_filg +'/'+
6.30 c                             'VV682_'+ %trim(w_jkey) + '.xml'
6.30  *
6.30 c                   callp     WrtHtmlToStmf(XML_Output: 819)
6.34  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
6.34 c                   if        d_dtaq = '1'
6.34 c                   eval      p_xmlf = xml_output
6.34 c                   eval      p_filg = 'ADB'+l_filg
6.34 c                   call      'AP629C'
6.34 c                   parm                    p_filg
6.34 c                   parm                    p_xmlf
6.34 c                   endif
6.30  *
6.30 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_list
      *
      * Key for oppslag på firma
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for les på vare-enhet-register
      *
     c     vvenl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl1_vare
      *
      * Key for les på vare-pris-register
      *
     c     vvprl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvprl1_vare
6.20 c                   kfld                    vvprl1_ldor
5.70 c                   kfld                    vvprl1_prgr
     c                   kfld                    vvprl1_enhe
      *
      * Key for oppslag på leverandør
      *
     c     rlevl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rlevl1_levr
      *
      * Key for oppslag på undergruppe
      *
     c     vugrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vugrl1_uogr
     c                   kfld                    vugrl1_uhgr
     c                   kfld                    vugrl1_uugr
6.30  *
6.30  * Key for rutineregisteret
6.30  *
6.30 c     aforl1_key    klist
6.30 c                   kfld                    aforl1_ruti
      *
      *
      * Kopierer parameterliste til datastruktur
      *
     c                   eval      d_list = p_list
      *
      * Henter dagens dato og firma fra parameter
      *
     c                   time                    w_udat
      *
     c                   eval      w_firm = d_firm
      *
      * Henter mva-faktor
      *
     c                   call      'FÅ705R'
     c                   parm                    w_firm
     c                   parm                    w_udat
     c                   parm                    w_mvap
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
5.70  *
5.70  * Henter prisgruppe
5.70  *
5.70 c                   call      'VL711R   '
5.70 c                   parm                    w_prgr
      *
5.70 c                   eval      w_lage = l_lagr
      *
6.30  * Sjekk om vi skal bruke XML generering av dokumenter
6.30  * NB KUN hvis EXCEL rapport. Hvis ikke skal det dannes PDF av spoolfile
6.30  *
6.30 c                   if        l_poff = '1' and
6.30 c                             l_exlp = 1
6.30 c                   eval      b_excl = *off
6.30 c                   eval      w_pdf = 0
6.30 c                   eval      w_pdf_ds = *blanks
6.30 c                   eval      w_ruti = l_ruti
6.30  *
6.30 c                   call      'AP609R'
6.30 c                   parm                    w_ruti
6.30 c                   parm                    w_pdf
6.30 c                   parm                    w_pdf_ds
6.30 c                   eval      d_pdf_ds = w_pdf_ds
6.30  * PROA er aktivert
6.30 c                   if        w_pdf = 1 and
6.30 c                             %trim(d_xmlm) <> *blanks
6.30 c                   eval      w_jkey = l_bach
6.30  *
6.30  * Hent inn xml templaten
6.30  *
6.30 c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
6.35 c                   callp     ClrHtmlBuffer
6.30  *
6.30  * Finn hvor xml'en skal legges
6.30  *
6.30 c                   eval      XML_path = *blanks
6.30 c                   eval      XML_path = %trim(d_path)
6.30  *
6.30  * Jobbnummer er allerede generert i AP600R. Overføres i *lda
6.30  *
6.30 c                   time                    w_date
6.30 c                   time                    w_dato2
6.30 c                   movel     w_dato2       w_tids
6.30 c                   move      w_dato2       w_ddmy
6.30  * Vi logger at utskriftprogrammet har startet
6.30 c                   eval      w_jstat = 10
6.30 c                   eval      w_jtext = 'Excel av hovedbok+
6.30 c                                        har startet'
6.30 c                   call      'AB705R'
6.30 c                   parm                    l_bach
6.30 c                   parm                    w_jstat
6.30 c                   parm                    w_jtext
6.30  * Vi skriver xml for miljø formater
6.30 c                   exsr      xml_envm
6.30 c                   exsr      xml_head
6.30 c                   eval      b_excl = *on
6.30 c                   else
6.30  * Vi logger at noe er galt med parametrene
6.30 c                   eval      w_jstat = 20
6.30 c                   eval      w_jtext = 'Finner ikke path til xml !!! +
6.30 c                             Sjekk rutineregister !'
6.30 c                   call      'AB705R'
6.30 c                   parm                    l_bach
6.30 c                   parm                    w_jstat
6.30 c                   parm                    w_jtext
6.30 c                   endif
6.30  *
6.30  *  Hent inn firma/avd. opplysninger dersom
6.30  *  kode for det er satt i rutineregister
6.30  *
6.30 c                   if        l_prfi = 1 or
6.30 c                             l_prfi = 2
6.30 c                   eval      w_prfi = l_prfi
6.30 c                   eval      w_ffir = w_firm
6.30 c                   eval      w_avde = l_avde
6.30  *
6.30 c                   call      'FÅ707R'
6.30 c                   parm                    w_prfi
6.30 c                   parm                    w_ffir
6.30 c                   parm                    w_avde
6.30 c                   parm                    w_fnav
6.30 c                   parm                    w_fad1
6.30 c                   parm                    w_fad2
6.30 c                   parm                    w_fste
6.30 c                   parm                    w_fftx
6.30 c                   parm                    w_tfax
6.30 c                   parm                    w_ftlf
6.30 c                   parm                    w_ffax
6.33 c                   parm                    w_mail
6.33 c                   parm                    w_weba
6.30 c                   endif
6.30  *
6.30 c                   else
6.30 c                   eval      b_excl = *off
6.30 c                   endif
6.30  *
6.30 c                   if        b_excl = *off
6.30 c                   open      vv682p
6.30 c                   endif
      *
     c                   endsr
