# RPG Source Code Explanation: AA001R

This RPG (Report Program Generator) program is an ILE RPG application designed to allow users to select a "file group" (databibl.) from a list. It's typically used in environments such as IBM i (AS/400), featuring subfile and display file (workstn) processing. The code appears to be written using the fixed-format RPG IV (RPGLE), with Norwegian comments.

Below, you'll find a high-level summary, key data structure explanations, and a breakdown of major sections and subroutines.

---

## High-Level Purpose

- **Main Function:** Presents a selection screen over subfiles, letting users choose a "file group" possibly stored in a database.
- **Features:** Supports paging, subfile handling, cursor positioning, function key handling (such as roll up/down, home, etc.).
- **Data Handling:** Reads and updates files, tracks user choices, writes selections to a user registry.

---

## File Declarations

```rpg
fafill1    if   e           k disk    rename(afilpfr:afill1r)
fausrlu    uf   e           k disk    rename(ausrpfr:ausrlur)
faa001d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **fafill1:** Database file for file groups (`afilpfr`), renamed to local format `afill1r`.
- **fausrlu:** Another DB file, presumably a user registry (`ausrpfr`), renamed `ausrlur`.
- **faa001d:** Display file (workstation device), using a subfile (B1SFL) controlled with `w_srrn`.

---

## Main Data Area and Variables

### **Local Data Area:**
- **l_fgrp / l_bibl:** For storing user's selected file group and library.
- **l_sw12:** A flag, likely for special status/exit handling.

### **Information Data Structure (for display feedback):**
- **dspfbk / d_fcrn:** Used to track current record number/cursor position for the subfile.

### **Subfile and Paging Variables:**
- **w_acli, w_acpo:** Current line and position, typically for cursor or display management.
- **w_fcrn, w_stel, w_spge, w_srrn, w_sfrn, w_ssrn:** Various subfile page and record pointers and counters (first/last record per page, current record, etc.).
- **w_seqe:** Sequence/type flag for special processing.
- **b_valg_ok:** Boolean flag indicating if a selection ("valg") is accepted.

---

## Indicator Usage

- **LR:** End the program.
- **10-99:** Various special indicators (paging, error, display, subfile control, etc.).
- **Specific examples:**  
  *10* = Roll,  
  *11* = Rolldown,  
  *12* = Sfldsp (subfile display),  
  *14* = Sflclr (clear subfile),  
  *15* = Sflend (reached end), etc.

---

## Program Flow Overview

### **1. Start/Initialization (`*inzsr`)**
- Receives parameter for current user (`p_user`).
- Initializes keys for file group and user registry files.
- Positions database at beginning and fills the subfile for the first screen page.

### **2. Main Screen Loop**
- Uses tags (`b2taga`, `b2tagb`) to control flow:
  - **b2taga:** Prepare and write command display.
  - **b2tagb:** Display and handle subfile; process user input.

- **Input Handling:**
  - Depending on function key indicators, performs:
    - Exit (set flag, goto avslutt)
    - Refresh (call subroutine forny)
    - Page Down (crt_subfile)
    - Page Up (bck_subfile)
    - Home (set indicator, reposition)

- If user enters a value for positioning, calls `posisjoner` to position subfile accordingly.

- Calls `subfile` to process subfile records for selection, updates the user registry, and stores selections locally.

- Loop continues until a selection is made (`b_valg_ok`) or the program is ended.

### **3. Subroutines**

#### **forny**
- Refreshes the subfile contents, possibly after external update.

#### **posisjoner**
- Repositions subfile based on search key (such as group name).

#### **subfile**
- Reads subfile records, checks for a "valg" (selection by user), stores selected group/library, updates user registry.

#### **clr_subfile**
- Clears subfile area and related counters.

#### **crt_subfile**
- Fills subfile with next page of data; paging logic included.

#### **bck_subfile**
- Handles paging backward (PageUp), managing file positioning and reloading subfile.

#### **dsp_subfile**
- Manages display of subfile, including which indicators to use and updating the current record position.

#### **avslutt**
- Program exit: sets LR (*last record*) indicator and returns.

---

## Special Comments & Norwegian Key Terms

- **Varsle:** Warn/alert (error and screen indicators)
- **Blanke:** Blank out/clear
- **Benyttede skjermbilder:** "Used screens" – list of display formats/subfiles referenced
- **Behandle:** Handle/process
- **Tømme:** Empty/clear (as in emptying subfile)
- **Fylle opp:** Fill (as in filling subfile with data)
- **Bla tilbake:** Page backward

---

## Summary Table: Key Subfile Fields

| Variable     | Meaning                                         |
|--------------|-------------------------------------------------|
| w_fcrn       | First record number on the page                 |
| w_stel       | Subfile record counter                          |
| w_spge       | Page size in the subfile                        |
| w_srrn       | Relative record number in the subfile           |
| w_sfrn       | First record number on the last page            |
| w_ssrn       | Last record number on the last page             |
| w_acli       | Current display line                            |
| w_acpo       | Current display position                        |
| b1valg       | "Valg" field: used to indicate user selection   |
| b1fgrp       | File group field in subfile                     |
| b1bibl       | Library field in subfile                        |

---

## Typical Program Flow Example

1. **Start program and display first page of file groups (subfile).**
2. **Wait for user selection/command:**
    - Page forward/backward with function keys.
    - Position to specific group.
    - Select a group by marking "valg".
    - Exit with F3 or F12.
3. **If group selected:**
    - Store selection, update user registry, and exit.

---

## Additional Notes

- **Display File (DDS) Required:** The code is tightly bound to a DDS display file (`AA001D`), especially for subfile processing.
- **Paging & Subfile:** Code is careful to manage subfile slots, page size, and cursor for efficient UI paging.
- **Norwegian Comments/Terms:** Most business logic comments and variables use Norwegian; see inline translations above for context.

---

## Conclusion

This program is a classic ILE RPG subfile selector, providing robust navigation and selection of "file groups" for end users, with persistent user profile handling. Understanding the variables and subroutine flow, along with indicator management, is key to successful onboarding.

---

**Let me know if you want a more detailed explanation of a specific subroutine or variable!**