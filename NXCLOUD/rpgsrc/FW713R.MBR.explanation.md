# RPG Program FW713R – Explanation

This program is part of the ASOFAK system and is designed to generate (populate) a supplier item register (leverandør vareregister), specifically for a client named Coward. Below you’ll find a detailed explanation of the code structure, its logic, and its key routines.

---

## 1. **File Declarations**

```rpg
fflvwpf    if   e           k disk
ffenkl1    if   e           k disk    rename(fenkpfr:fenkl1r)
fflvapf    o  a e             disk
```
- **flvwpf**: Input file, keyed, probably contains the source item data.
- **fenkl1**: Input file, keyed, used for unit conversion (renamed record format).
- **flvapf**: Output file, likely the supplier item register.

---

## 2. **Data Area, Variables, and Parameters**

### a. *Local Data Area*  
```rpg
d                uds
d l_user                911    920
```
- `uds`: User data structure.
- `l_user`: User code from the data area.

### b. *Program Parameters*
```rpg
d p_firm          s              3  0
d p_ldor          s              6  0
```
- `p_firm`: Firm number (company code).
- `p_ldor`: ? Possibly a date or code parameter.

### c. *Variables for Keys and Processing*
Several working variables are defined for key composition and field manipulation, for example:
- `w_vare`, `w_vtxt`, `w_enhe`: Item number, item description, and unit.
- `w_inpr`, `w_saim`: Purchase and sales prices.
- `w_plun`, `w_anta`: EAN number and order quantity.

---

## 3. **Main Program Logic**

### a. *Read Input Records*
```rpg
c                   read      flvwpf                                 90
c                   read      flvwpf                                 90
c                   dow       *in90 = *off
```
- Reads the input file and skips the first record (usually a header row).

### b. *Main Processing Loop*
Iterates over each row, performing the following steps:
1. **Parse Row into Fields**  
   Calls `splitt` subroutine to extract item number, text, unit, prices, EAN, and order quantity.

2. **Populate Output Record**  
   Sets output fields (`fwfirm`, `fwtek1`, `fwtek2`, etc.) using parsed and processed data.

3. **Unit Conversion**
   Does a CHAIN (keyed lookup) on `fenkl1` to potentially convert units (e.g., 'KGS' to 'KG').

4. **Price Handling**
   Processes purchase and sales prices, splitting integer and decimal parts, and formatting as required.

5. **Sales Price VAT Adjustment**
   Multiplies the sales price by a VAT factor read during initialization.

6. **EAN Handling**
   Formats the EAN number to 13 digits (zero-padded as needed).

7. **Order Quantity**
   Processes the order quantity, again splitting for decimals.

8. **Audit/Trace Fields**
   Captures timestamps and user IDs for audit fields.

9. **Write to Output**
   Writes the formed record to the output file.

10. **Loop**
    Reads the next record.

### c. *Program Termination*
Sets last record indicator (`*inlr`) and returns from the program.

---

## 4. **Subroutines**

### a. **splitt**  
Splits a CSV-style input line into individual fields:
- Parses item number, description, unit, prices, EAN, and order quantity using `scan` and `subst` operations.
- Translates certain special characters in text fields.
- Carefully walks through the CSV fields, updating position indicators per delimiter.

### b. ***inzsr** (Initialization)**
- Handles parameter passing from the caller, sets up keys, and
- Calls program `'F�705R'` to get the current VAT rates/factors for price adjustment.

---

## 5. **Special Topics**

- **Decimal Handling:**  
  Prices and quantities may include decimals (handled with `scan` for `'.'`) and the integer and decimal parts are extracted and merged into the correct format for the target database.

- **Audit Trail:**  
  From version 6.10, user and timestamp info is recorded both at the time of writing the record and for last update info.

---

## 6. **Summary**

- This is a batch-style RPG program for transforming and migrating supplier item data from one format (input file) to another (register file).
- Major processing steps include parsing, data conversion, formatting, unit translation, price calculation (inc VAT), and comprehensive audit stamping.
- The code is structured for maintainability, using subroutines for repeated logic and careful variable naming for clarity.
- Some comments and variable names are in Norwegian, but logic is straightforward and well-commented for onboarding.

---

## 7. **Typical Program Flow**

1. **Start:** Initialize, get VAT data.
2. **For each input record:**
   - Split CSV row into fields.
   - Format and process each field as needed.
   - Write to output register.
3. **After all records:** Clean up and end.

---

## 8. **Key Takeaways for Developers**

- If you add more input fields, update both `splitt` and the main loop logic.
- If you change output audit requirements, modify the corresponding timestamp and user assignments.
- For new unit codes or VAT rules, check both the `fenkl1` lookup logic and the VAT program interface.

---

**In sum**: This program is a classic RPG batch data conversion utility, with attention paid to correct parsing, value formatting, and auditability. It is a good example of a maintainable, transaction-style RPG application.