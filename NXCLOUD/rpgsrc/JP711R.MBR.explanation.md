# RPG Program Explanation: JP711R

---

## Overview

This RPG (ILE RPG/400, fixed-format) program, named **JP711R**, is used to find the next available line number for a discount (rabattelement) element in a database. It appears to belong to a Norwegian-speaking team/system (based on comments and variable naming). The program receives several parameters, uses them as a key to search a database file, and determines the next available line number (`linjenummer`) by reading existing records.

---

## Structure and Key Concepts

### 1. Header and File Declarations

```rpg
     h option(*nodebugio) datedit(*dmy)
     fjrael1    if   e           k disk    rename(jraepfr:jrael1r)
```

- `h option(*nodebugio)`: Disables debug I/O for performance.
- `h datedit(*dmy)`: Sets date editing for day/month/year.
- `fjrael1`: Declares file `JRAEPFR` for input (`i`), full procedural (`f`), externally described (`e`), keyed access (`k`), disk file, renamed as `jrael1r` internally.

---

### 2. Definition of Parameters and Key Variables

```rpg
     d p_firm          s                   like(jpefir)
     d p_eldo          s                   like(jpeldo)
     ...
     d p_elin          s                   like(jpelin)
```

- Defines input/output parameters (`p_firm`, `p_eldo`, ..., `p_elin`) for the program using the same data types as the corresponding fields in the database.

Key variables used to construct the file’s search key are defined similarly:
```rpg
     d jrael1_eldo     s                   like(jpeldo)
     ...
     d jrael1_erst     s                   like(jperst)
```

---

### 3. Other Variable Declarations

```rpg
     d w_firm          s                   like(jpefir)
```
- Temporary variable to hold the `firm` (company) code during the program.

---

### 4. Main Program Logic

#### **Initialization and Key Building**

```rpg
     c                   eval      jpelin = 0
     c                   eval      jrael1_eldo = p_eldo
     ...
     c                   eval      jrael1_erst = p_erst
```

- Resets the line number to zero.
- Copy all incoming parameters to their corresponding local key fields.

#### **File Search**

```rpg
     c     jrael1_key    setll     jrael1
     c     jrael1_key    reade     jrael1
     c                   dow       not %eof
     c     jrael1_key    reade     jrael1
     c                   enddo
```

- Uses a *key list* (`jrael1_key`, defined later) to position to the group of records in `jrael1r` that match the given key.
- Reads records with that key, moving through all matching records.
- This loop advances until there are no more records with that key (`%eof`), so when done, the last value of the line number field will be present.

#### **Next Line Number Calculation**

```rpg
     c                   eval      p_elin = jpelin + 1
```
- Sets the output parameter `p_elin` to the next available line number (one more than the last found).

#### **End Program**

```rpg
     c     avslutt       tag
     c                   eval      *inlr = *on
     c                   return
```
- Marks the logical end of the program, sets `*INLR` (last record indicator) to true (causing program to close files and end), and returns.

---

### 5. Subroutine: *INZSR (Initialization)

```rpg
     c     *inzsr        begsr
     c     *entry        plist
     c                   parm                    p_firm
        ...
     c                   parm                    p_elin

     c     jrael1_key    klist
     c                   kfld                    w_firm
        ...
     c                   kfld                    jrael1_erst

     c                   eval      w_firm = p_firm
     c                   endsr
```

- Runs at program start.
- Receives parameter values via `plist` (`*entry`), assigning them to program variables.
- Sets up the key list (`jrael1_key`) for file access — the sequence of fields that uniquely identify a set of records in `jrael1`.
- Copies the `p_firm` parameter into the working variable `w_firm` for use in the key.

---

## Program Flow (Step-by-Step)

1. **Initialization**: Receives all parameter values, initializes the record key fields.
2. **Key Setup**: Sets up the key list for file access.
3. **File Positioning and Reading**:
    - Positions at the first record matching the key using `setll`.
    - Reads each record with the key using `reade` (loop).
    - Continues until no more records match.
4. **Determine Next Line Number**:
    - After the loop, increments the last found line number by one.
    - Returns this as the next available line number (`p_elin`).
5. **End**: Closes the program and files.

---

## Key Takeaways

- **Purpose**: To deliver the next available line number for a specific combination of parameters (likely for order, discount, or transaction entry).
- **Data Access**: Works directly with a keyed physical file (database table).
- **Parameterization**: Accepts many parameters, allowing for searching within complex, multi-part keys.
- **Classic Style**: Uses fixed-format RPG IV with explicit key lists and parameter lists.
- **Localization**: Variable names and comments use Norwegian, reflecting local business logic.

---

## A Typical Use Case

A calling program wants to add a new discount line for a product/order combination and needs to know what the next line number should be. It calls this program with the key parameters, receives the next available line number as output, and then adds the new record using that number.

---

## Note on Modernization

While this code is functional, it could be made more readable and maintainable using /free format RPG, and by incorporating subprocedures and service programs in modern RPG IV.

---