# VE510R – Item Unit Display for Item

## Overview

This program (VE510R) is part of the ASOFAK system and is designed to display and manage unit information for a specific item (product). Its primary function is to present all units associated with an item (such as sales unit, purchase unit, and price book unit) in a subfile, allowing the user to view detailed information about each unit, including dimensions, volume, and weight.

The program is interactive, using a display file (workstn) with subfile support, and allows for various actions such as paging through units, viewing details, and (as of version 6.10) showing unit information per price provider.

## Files and Data Relationships

- **vvarl1**: Item master file (renamed record format `vvarl1r`), keyed access.
- **vvenl1**: Item-unit relationship file (renamed record format `vvenl1r`), keyed access.
- **vvenlr**: Detailed unit information file (renamed record format `vvenlrr`), keyed access.
- **ve510d**: Display file (workstn), with subfile (`b1sfl`) and control record (`b2ctl`).

## Key Data Structures and Variables

- **Parameters:** `p_firm` (company), `p_vare` (item number) – both passed in at program start.
- **Local variables:** Used for tracking subfile state (row numbers, page size, etc.).
- **Display feedback structure (`dspfbk`):** Used for cursor position and function key handling.
- **Subfile fields:** Various, including unit code, area, volume, weight, etc.

## Main Program Flow

### Initialization

- The program begins by reading the item master (`vvarl1`) using the passed keys (`p_firm`, `p_vare`). If not found, it exits.
- Item description and base unit are loaded for display.
- The unit relationship file (`vvenl1`) is positioned to the correct item.
- The subfile is cleared and then populated with all units for the item.

### Main Loop

- The main loop displays the subfile and processes user input.
- Function keys are handled:
    - **Exit keys:** End program.
    - **Page down (F10):** Load next page of units.
    - **Page up (F11):** (Stubbed) – logic for paging backwards could be implemented.
    - **Other custom keys (e.g., F21):** Set flags for special display modes.
- After processing function keys, the program checks for subfile selections (user actions on subfile rows).

### Subfile Handling

- **Display:** The subfile (`b1sfl`) displays all units for the item, including key attributes (unit code, area, volume, etc.).
- **Selection:** If the user selects a row (e.g., `b1valg = 5`), details for that unit are displayed in a popup.
- **Show per price provider (6.10):** If selected (`b1valg = 7`), calls program `VE515R` with the current company and item.

### Display of Unit Details

- When a unit is selected for detail view, the program retrieves full unit details from `vvenlr` and displays all relevant fields (area, dimensions, volume, weight, and audit fields).

### Subfile Management

- **crt_subfile:** Populates the subfile with units for the current item, paginated.
- **clr_subfile:** Clears the subfile and resets navigation variables.
- **dsp_subfile:** Handles the display and refresh logic for the subfile.
- **bck_subfile:** Placeholder for "page up" logic (not implemented in this version).

### Data and Key Handling

- Keys for all file accesses are constructed using the company and item number, with unit code added where appropriate.
- The program uses standard subfile navigation variables: current row, start row, end row, and page size.

## Special/Non-Obvious Design Decisions

- **Subfile Paging:** Only forward paging is implemented; backward paging is stubbed but not functional.
- **Selection Handling:** The selection variable (`b1valg`) is reset after handling to prevent repeated actions on the same row.
- **Display Feedback (`dspfbk`):** Used to track cursor position and enable certain UI behaviors.
- **Versioned Enhancements:** Noted in comments (e.g., version 6.10 added price provider unit display).

## Interactions with Other Modules

- **VE515R:** Called when the user requests to display unit information per price provider (as of version 6.10).
- **Item and unit master files:** This program is a "viewer" for data maintained elsewhere in the system.

## Conventions and Patterns

- **Record format renaming:** Used for clarity and to support multiple logical views over the same physical file.
- **Subfile pattern:** Classic RPG subfile design, with paging and selection support.
- **Parameter passing:** Entry parameters are used for context (company and item).
- **Norwegian comments and variable names:** Reflects the original business domain and language; be mindful of this when extending or maintaining.

## Business/Domain Logic

- **Units per item:** Items can have multiple units (sales, purchase, price book, etc.), each with their own metrics.
- **Unit details:** For each unit, the system tracks area, length, width, height, volume, weight, and audit information.
- **User interaction:** The program is designed for operational users who need to review or analyze unit information for items, possibly for pricing, logistics, or sales purposes.

## Summary Table of Main Subroutines

| Subroutine     | Purpose                                                      |
|----------------|-------------------------------------------------------------|
| *inzsr         | Initialization, parameter handling, key setup               |
| clr_subfile    | Clears the subfile and resets navigation variables          |
| crt_subfile    | Populates the subfile with item unit data                   |
| dsp_subfile    | Displays the subfile and handles control record logic       |
| subfile        | Handles user selections/actions on subfile rows             |
| xc2bld         | Displays detailed information for a selected unit           |
| bck_subfile    | Placeholder for backward paging (not implemented)           |

## Key Function Codes

- **5:** View details for the selected unit.
- **7:** (6.10+) Show units per price provider (calls VE515R).
- **F10:** Next page.
- **F11:** Previous page (not implemented).
- **F21:** Special mode (sets a flag).

## Error Handling

- If the item is not found, the program exits immediately.
- If no more units are found when paging, sets EOF and disables further paging.

## Maintenance Notes

- Paging logic could be enhanced to support backward navigation.
- The use of Norwegian variable names and comments is consistent with the rest of the system.
- Integration with other modules (like VE515R) should be verified if further changes are made to the unit data structure.

---

**In summary:**  
VE510R is a subfile-driven display program for item units, supporting detailed unit inspection and, from version 6.10 onwards, per-price-provider unit display. It relies on standard file structures and subfile patterns, with navigation and selection logic tailored to the business needs of item/unit management in a Norwegian context.