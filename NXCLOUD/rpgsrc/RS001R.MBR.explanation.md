# Program: RS001R â€“ Retrieve Last Used Customer Number

## Overview

This program is part of the **ASOKON** system and is responsible for retrieving and updating the last used customer number for a given company (firm). It ensures that the next available customer number is determined according to business rules and is not already in use. The program interacts with several physical files (tables) to maintain and validate customer numbering.

## Business Context

- **Customer Numbering**: The system maintains a sequential customer number per company. This program ensures that new customer numbers are assigned correctly, within allowed ranges, and are unique (i.e., not already assigned to an existing customer).
- **Files Involved**:
  - **RAA4L1/RAA4LU**: Hold the current (and possibly previous) last used customer number for each company.
  - **RAA1L1**: Contains the valid range for customer numbers for a company.
  - **RKUNLR**: The main customer register, used to verify if a customer number is already assigned.

## Data Structures

- **Parameters**:
  - `p_retk` (1 char): Return code, used to indicate result/status.
  - `w_firm`: The company/firm identifier.
  - `p_4knr`: The current last used customer number (passed in/out).

- **Work Variables**:
  - `w_test`: Copy of `p_retk` at entry, used to determine operation mode.
  - `w_4knr`: Work variable for candidate customer number.
  - `w_kund`: Work variable for checking customer number availability.

- **File Record Fields**:
  - `ra4knr`: Last used customer number.
  - `ra4fir`: Company/firm.
  - `ra4aar`: Year or period (used as part of keys).
  - `ra1hkt`, `ra1hrs`: Lower and upper bounds for valid customer numbers.
  - `rkkund`: Customer number in customer register.

## File Relationships

- All files are keyed by `w_firm` (company). Some also use `ra4aar` (year) as part of the key.
- The program reads and updates the customer number status in **RAA4LU** and **RAA4L1**.
- It checks the valid range in **RAA1L1**.
- It ensures uniqueness by checking **RKUNLR** for existing customer numbers.

## Program Flow

### 1. Initialization (`*inzsr`)

- Receives parameters: `p_retk`, `w_firm`, `p_4knr`.
- Builds key lists for all files.
- Retrieves range limits for customer numbers from **RAA1L1** for the company.

### 2. Main Logic

#### a. Retrieve Current Last Used Number

- Attempts to chain (lookup) the current last used customer number for the company in **RAA4L1**.
- If not found, sets `p_retk` to `'N'` (not found) and exits.

#### b. Determine Next Customer Number

- Operation mode is determined by `w_test` (original value of `p_retk`):
  - **Blank**: Normal mode, increment last used number by 1.
  - **'S'**: Special mode, decrement last used number by 1 if `p_4knr` matches current.
  - **'K'**: Use `p_4knr` as the candidate number.

#### c. Range Validation

- Checks if the candidate number (`w_4knr`) is within the valid range (`ra1hkt` to `ra1hrs`).
- If not, sets `p_retk` to `'N'` and exits.

#### d. Ensure Uniqueness

- Checks if the candidate customer number exists in **RKUNLR**.
- If it does, increments candidate number and repeats the check until an unused number is found.

#### e. Update Last Used Number

- Chains to **RAA4LU** (update file).
- If found, updates `ra4knr` with the new last used customer number if it is greater than the previous value (or according to special mode logic).
- Updates the file.

#### f. Return Values

- Updates `p_4knr` with the new last used customer number.
- Sets `p_retk` to blank (success).

### 3. Program Exit

- Sets LR indicator and returns.

## Notable Design/Implementation Details

- **Mode Switching**: The program supports multiple operation modes via the `p_retk` parameter (`'S'`, `'K'`, or blank), allowing both normal and special-case updates.
- **Tag/GOTO Loop**: Uses a `tag`/`goto` loop (`finnes`) to incrementally search for the next unused customer number. This is a common pattern in legacy RPG for simple iterative processes.
- **Range Enforcement**: Strictly enforces business rules regarding valid customer number ranges per company, as defined in **RAA1L1**.
- **File Renaming**: Logical file names are renamed for clarity and to avoid conflicts, following local naming conventions.
- **Error Handling**: Uses indicator `*IN90` to detect record-not-found situations after `chain` operations.

## Interaction with Other Modules

- This program is likely called by higher-level customer management routines or batch processes that need to assign new customer numbers.
- The parameters allow it to be used flexibly in different contexts (normal add, special correction, etc.).

## Conventions and Patterns

- **File Naming**: Prefixes like `raa4`, `raa1`, and `rkun` indicate file purpose (status, ranges, customers).
- **Key Lists**: Uses `klist`/`kfld` for all file access, supporting multi-part keys.
- **Return Codes**: Single-character return codes are used for status, which is common in older RPG systems.

## Maintenance Notes

- Ensure that all files are opened with the correct access (input/output/update) as required by their usage.
- The program assumes that customer numbers are strictly numeric and sequential.
- If customer numbering logic changes (e.g., alphanumeric, gaps allowed), significant refactoring may be needed.

---

**In summary:**  
This program manages the retrieval and update of the last used customer number for a company, ensuring that the next number is valid and unique, and updates the relevant status files accordingly. It is a core utility in the customer onboarding/maintenance process within the ASOKON system.