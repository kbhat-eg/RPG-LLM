# RPG Program MM501R - Source Code Explanation

## General Purpose

This is an ILE RPG program for IBM i (AS/400) called `MM501R`, part of the "ASLOGI" system. Its main purpose is to **list items (varer) with weekly forecasts (ukeprognose)**. It manages a display file using a subfile (SFL), allowing users to search, browse, and maintain item forecasts. Users can search by item number, warehouse (lager), or ABC code, and can perform actions such as deleting forecasts or viewing details.

---

## File Specifications

- **mprul1 / mprulu**: Forecast master and update files, renamed for input/output specificity.
- **vvarl1, vlagl1**: Item and warehouse master files.
- **mm501d**: Display file with SFL, using indicators and data structures for feedback.

---

## Data Structures and Variables

- **Local Data Area (LDA):**  
  Used for user, company, and name information, loaded at program start.
- **Display Feedback (dspfbk):**  
  Used for managing subfile record numbers and cursor position.
- **Key fields:**  
  Variables used for positioning and operations against physical files.
- **Work Variables:**  
  For controlling page size, scroll position, active filters, and search criteria.
- **Constants:**  
  `c_sfil = 14` — subfile page size.

---

## Indicators (INxx Usage)

- **LR**: End program.
- **10–15, 21-22, 30, 31-79, 80-99**: Used for subfile actions, function keys, cursor placement, screen protection, warnings, processing, etc.

---

## Subfiles and Screens

- **B1SFL**: Main subfile record format.
- **B2CTL**: Subfile control format.
- **B2CMD**: Command key window.
- **Other Windows**: For creating, deleting, or messaging related to items.

---

## Main Program Flow

1. **Initialization**
    - INZSR subroutine loads LDA, initializes variables, and fills the subfile via `crt_subfile`.

2. **Main Loop (Control Logic)**
    - Displays the command window (`b2cmd`).
    - Executes `dsp_subfile` to show the subfile.
    - Handles function keys via a SELECT (e.g., F3/12 to exit, F10 rollup, F11 rolldown, help, search, etc.).
    - Based on user input:
        - Refreshes, searches, or browses the subfile.
        - Calls other programs for extended functionality.

3. **Search and Filtering**
    - Subfile can be filtered by item number, warehouse, or ABC code.
    - Search logic (`søk` subroutine) sets up the type of search and re-loads the subfile by calling `crt_subfile`.

---

## Subroutines

### forny (Renew Subfile)
- Refreshes the subfile starting from the selected position, based on the current key (item, warehouse, etc.).

### søk (Search Subroutine)
- Sets up filter variables based on user input (item, warehouse, ABC code).
- Calls `clr_subfile` (clear) and `crt_subfile` (fill) to reflect search results.
- Clears the search fields.

### subfile (Subfile Processing)
- Toggles the cursor placement indicator.
- Reads each SFL record (via `READC`), checks for delete or view actions:
    - **Delete**: Calls `xd1win` (delete window), deletes forecast records.
    - **View**: Calls another program to show weekly forecast details.
- If records have changed, refreshes the subfile.

### xd1win (Delete Window)
- Presents a confirmation window for deletion.
- If confirmed, deletes all forecast records for the given item and warehouse.

### xh1win (Help Window)
- Displays a help/option window for ABC code selection.

### clr_subfile (Clear Subfile)
- Sets indicator to clear SFL (IN14), writes control record, resets SFL pointers.

### crt_subfile (Create/Fill Subfile)
- Sets up SQL cursors depending on the search type (`w_seqe` = O/L/A).
- Fetches records from the database accordingly, applies further filtering logic (incl. ABC code), and writes records to the subfile.
- Integrates item and warehouse details for display.
- Handles end-of-file and populates control variables for SFL scrolling.

### bck_subfile (Scroll Backwards)
- Scrolls the subfile backward (page up), repositions and reloads the subfile.

### dsp_subfile (Display Subfile)
- Sets up indicators and displays the control window (`B2CTL`), tracks the current cursor position and record number.

### spørring (Inquiry)
- Handles lookups for item (calls `VV500R`) or warehouse (calls `RA510R`), helps fill search fields.

---

## SQL Integration

- The program uses embedded SQL for searching/positioning within the forecast file (`mprupf`).
- Supports dynamic filtering by item, warehouse, or ABC code, in addition to direct record traversal via keyed access.

---

## Key Lists (KLIST) for File Access

- Define composite keys for efficient, precise file access for both read (SETLL, CHAIN) and delete operations.

---

## Comments and Documentation

- The code is heavily commented in Norwegian. It describes indicator usage, screen layout, field meaning, and gives context for each subroutine.
- Modification logs at the top detail feature changes and enhancements over time.

---

## Summary for New Developers

- **Subfile Driven:** Main user interface is an SFL supporting filtering, browsing, and item-level actions.
- **Search/Filter:** Users can filter the forecast by item number, warehouse, or ABC-class.
- **Item Details:** Reads supplementary information from the item and warehouse masters for display.
- **Maintenance:** Allows deleting or viewing forecasts, with confirmation.
- **SQL & Native DB:** Combination of SQL (for dynamic searches) and keyed record-level access.
- **Extensive Use of Indicators and Status Variables:** For user-interface and data control.

---

## Tips for Onboarding

- **Familiarize yourself with the files:** `mprupf`, `vvarpf`, `vlagpf` and their logical relationships.
- **Understand the subfile logic:** How the program loads, clears, and manages screens.
- **Get to know the indicators (INxx):** Essential for following user actions and screen flows.
- **Study the SQL queries:** They are dynamically built based on search filters.
- **Multi-program interaction:** Note that it calls out to other RPG programs (e.g., `VV500R`, `MM502R`).
- **Check program modifications (version comments):** They highlight where logic has changed over time.

If you have a specific area (subfile, search logic, file I/O, etc.) you’d like a deeper explanation on, let me know!