# RPG Program VA520R – Detailed Explanation

## Overview

This RPG (Report Program Generator) ILE program, named **VA520R**, is designed for **account referencing and inquiry (Kontohenvisning, spørring)** on an IBM i (AS/400) system. It utilizes subfiles for paging through records and allows searching by **account code** or **description** ("kontohenvisning" or "beskrivelse"). It interacts with physical files (`vkhvl1`, `vkhvla`) and a workstation display file (`va520d`). The program supports function key navigation (rolling, selection, positioning, etc.) and manages the subfile display using several subroutines.

---

## Control and File Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
```
- H-spec disables debug I/O and sets date format for editing (*dmy = Day-Month-Year).

**File Specifications:**
- `vkhvl1` and `vkhvla`: Input, externally described files, likely storing account records.
- Both files are **renamed** to local record formats `vkhvl1r` and `vkhvlar`.
- `va520d`: Workstation file, subfile defined as `b1sfl` with relative record variable `w_srrn`.
- `infds(dspfbk)`: Uses an information data structure to provide display feedback.

---

## Indicators

RPG classic programs use numeric indicators. The comments document their specific use:

- `LR`: Last record indicator, ends program.
- `10-15, 21, 22, 30-99`: Used for screen navigation, cursor, field protection, error/warning states, working flags, etc.

---

## Data Definitions (D-Specs)

**Parameters to the Program:**
- `p_firm`, `p_kkod`, `p_ktxt`: Passed into the program, corresponding to firm/company, account code, and description respectively.

**Information Data Structure:**
- `dspfbk` structure, with `d_fcrn` used for retrieving the first displayed subfile record number.

**Key Variable Buffers:**
- `vkhvl1_kkod` and `vkhvla_ktxt`: For storing key values to position in respective files.

**Working Variables:**
- Multiple variables (e.g., `w_fcrn`, `w_stel`, `w_spge`, etc.) managing subfile paging, screen states, and navigation.

**Constants:**
- `c_sfil`: The subfile page size (set to 8).

---

## Comments – Key Subfile Fields

Annotated explanations for fields involved in subfile handling (e.g., first/last record, current page, row, cursor position).

---

## High-Level Program Flow

### Main Logic

- **Two main entry tags**: `b2taga` and `b2tagb`
    - `b2taga`: Handles screen initializations and command key screen (`b2cmd`)
    - `b2tagb`: Core subfile display, record navigation
- **Function Key Handling**: Uses a `select` to manage function key input for exit, refresh, rolling, backward page, home key, etc.
- **Positioning**: If lookup parameters are entered (account or description), `posisjoner` subroutine is called to reposition to the desired record set and refresh the subfile.
- **Subfile Handling**: Calls the `subfile` subroutine for selection and processing.
- **Program Exit**: Sets LR (last record indicator) and returns.

---

## Subroutines

### `forny` – Refresh Subfile

- If subfile is currently displayed, positions to the current subfile record.
- Loads the appropriate physical file (`vkhvl1` or `vkhvla`) based on search mode.
- Clears and rebuilds subfile records.

---

### `posisjoner` – Position in Subfile

- Checks if an account number (`b2kkod`) or description (`b2ktxt`) is provided.
- Sets up the key buffer and positions to the right record in the corresponding file.
- Calls subfile clear and create routines to display the newly positioned set.
- Clears out search/position fields for reuse.

---

### `subfile` – Subfile Processing

- Toggles indicator 22 to manage display state.
- For each record in subfile, reads and processes user selection.
- If selection (`b1valg = 1`), fills program parameters and sets selection flag.

---

### `clr_subfile` – Clear Subfile

- Sets subfile clear indicator (14), writes control record, then resets it.
- Resets counters and pointers for subfile navigation.

---

### `crt_subfile` – Create Subfile Page

- Calculates next page's record count.
- Reads records from the appropriate file (`vkhvl1` or `vkhvla`) into the subfile, up to the defined subfile size.
- Transfers fields from file record to subfile record.
- Handles last-record indicators and book-keeping for paging.

---

### `bck_subfile` – Back-page in Subfile

- If at end, positions to previous page.
- Reads previous records (using `readp`), fills the subfile backwards.
- Clears and re-fills the subfile for the previous page.

---

### `dsp_subfile` – Display Subfile

- Sets indicators for display fields.
- Executes the format of the subfile control record.

---

### `*inzsr` – Initialization

- Handles program entry and parameter passing.
- Sets key-lists for searching in physical files by account or description.
- Initializes subfile display by positioning at start and filling the subfile.

---

## Special Notes

- Support for inquiry by both **account code** and **description**.
- Paging logic ensures efficient navigation with subfile display size limit.
- Uses traditional RPG indicators and subfile patterns.
- Extensively commented with Norwegian terms; adapted for account referencing and tailored to local needs.
- Handles advanced subfile features, e.g., relative record number, last record, page navigation, and cursor placement.

---

## Summary of Key Functionality

- **Subfile Paging:** Allows the user to scroll forward and backward through account records in pages.
- **Positioning/Search:** Supports lookup by account code (*kontohenvisning*) or description (*beskrivelse*).
- **Selection Handling:** Allows user to select a record in the subfile for further processing.
- **Keyboard Navigation:** Handles various function keys for rolling, refreshing, home, and others.
- **Robust Subfile Management:** Employs routines for clearing, creating, paging, and displaying subfile content.

---

**In essence:**  
This is a classic IBM i interactive RPG program implementing a subfile-based search and selection screen for account reference browsing and inquiry. It demonstrates well-organized subroutine-driven code and classic subfile handling patterns.