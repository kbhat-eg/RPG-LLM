# FR612R – Discount Matrix Customer Letter

## 1. Overview  
FR612R is an IBM ILE RPG program that generates a customer letter detailing special prices and discounts. It:  
- Accepts company, customer, project, date, free‐text lines and options as parameters.  
- Determines the customer’s discount category and any project‐based overrides.  
- Retrieves special prices and discount matrix entries.  
- Prints a formatted letter with header, detail lines (prices then discounts), and footer.

---

## 2. File Declarations  
All files are defined as externally described (E) and keyed (K) on disk:

• **ffprwl1 / ffprwl2**  
  – Work files for special prices  
  – Renamed for two retrieval levels (detailed vs. summary)  

• **ffrawl1 / ffrawl2**  
  – Work files for discount matrix entries  

• **rkunl1, fkprl1**  
  – Customer master and customer‐project overrides  

• **Ancillary files**:  
  – Price‐code descriptions (vpkol1)  
  – Product group texts (vogrl1, vhgrl1, vugrl1)  
  – Item text (vvarl1), supplier (rlevl1), routine register (aforl1), post‐office (apospf)

• **ffr612p**  
  – Printer file for the letter output  

---

## 3. Data Areas and Parameters  

### 3.1 Local Data Area (LDA)  
- `l_ruti` (positions 800–809) used to look up program registry entries.

### 3.2 Input Parameters  
| Name   | Type/Length     | Description                                  |
|--------|-----------------|----------------------------------------------|
| p_firm | like(frfirm)    | Company identifier                           |
| p_kund | like(frkund)    | Customer number                              |
| p_kpro | like(frkpro)    | Customer project number                      |
| p_rdat | date (ISO)      | Reporting date                               |
| p_txt1 | char(60)        | Footer text line 1                           |
| p_txt2 | char(60)        | Footer text line 2                           |
| p_txt3 | char(60)        | Footer text line 3                           |
| p_valg | packed(1,0)     | Selection flag                               |
| p_prgr | like(frprgr)    | Price group                                  |

### 3.3 Working Variables  
- Flags: `b_pris` (prices printed), `b_inlr` (LR control).  
- Work keys: `w_rkat` (discount category), `w_kkat` (customer category), `w_kund`, `w_kpro`, `w_prgr`.  
- Date: `w_opda` (override date).  
- Price‐lookup: `w_bupr`, `w_kopr`, `w_inpr`.

---

## 4. Main Logic Flow  

1. **Initialize work keys**  
   - Zero out categories, set them from input parameters.  
   - Capture current date into `w_opda`.

2. **Lookup base discount and customer category**  
   - Chain into `rkunl1` (customer master) by `w_firm` + `w_kund`.  
   - On success, load `w_rkat`, `w_kkat`.

3. **Apply project overrides (if any)**  
   - If `p_kpro ≠ 0`, chain into `fkprl1`.  
   - Use override fields (`florka`, `flokun`, etc.) to reset work keys and `w_opda`.

4. **Abort if customer not found**  
   - Chain into `rkunl1` again; if not found, GOTO `avslutt`.

5. **Check existence of any special price or discount matrix**  
   - Try a key2 read on `fprwl1` and `frawl1`.  
   - If none found and no project + selection combination, GOTO `avslutt`.

6. **Print header**  
   - EXSR `hode` to gather customer/project info and price‐code descriptions.  
   - Write heading records.

7. **Select and print detail lines**  
   - EXSR `utplukk` does two loops:  
     a. **Special Prices** – Read `ffprwl2`, filter by category/customer/project, date ranges, then call `detalj_pris`.  
     b. **Discount Matrix** – Read `ffrawl2`, similar filtering, then call `detalj_rabatt`.

8. **Print footer**  
   - EXSR `bunnlinje` writes free‐text lines plus routine‐register messages.

9. **End program**  
   - Set `*INLR = *ON`, return.

---

## 5. Key Subroutines  

### 5.1 hode (Header)  
- Reads customer name/address from `rkunl1`.  
- If project specified, chains `fkprl1` then `apospf` for postal place.  
- Chains `vpkol1` to get text for price codes 'N' (normal) and 'T' (temporary).  
- Writes the three header records (`a1hdr`, `a2hdr`, `a3hdr`).

### 5.2 utplukk (Detail Selection)  
- **Special Prices**:  
  • SETLL/READE on `ffprwl2`.  
  • Filters by fprkat, fpkkat, fpkund, fpkpro and date ranges.  
  • Verifies item eligibility with secondary chain to `fprwl1`.  
  • Calls `detalj_pris` if valid.

- **Blank line & overflow** if any price lines were printed.

- **Discount Matrix**:  
  • SETLL/READE on `ffrawl2`.  
  • Filters by frkat, frkkat, frkund, frkpro.  
  • Verifies group/item eligibility via `frawl1` chain.  
  • Calls `detalj_rabatt`.

### 5.3 detalj_pris (Print Special Price)  
- Moves item code, text, unit, quantity, special price into print fields.  
- If `fpsapr` = 0, calls external program `VP701R` to fetch list price.  
- Applies up to two price discounts (`fprab1`, `fprab2`).  
- Writes detail line (`d1dtl`) and checks for page overflow.

### 5.4 detalj_rabatt (Print Discount Line)  
- Skips if coverage fields (`frdekn`/`frdekd`) non‐zero.  
- Builds display group code (`d1vgrp`) from over/major/minor groups.  
- Fetches group or supplier text if item code is blank.  
- Determines up to four discount rates (`d1rab1`–`d1rabt`) based on input date `p_rdat`.  
- Checks item/pricing eligibility via `vvarl1`.  
- Writes detail line (`d1dtl`) and handles overflow.

### 5.5 bunnlinje (Footer)  
- Moves free‐text lines (`p_txt1`–`p_txt3`) and routine messages to print fields.  
- Writes footer record (`b1bot`).

### 5.6 overflow  
- If page overflow (`*IN30` on), rewrites header records to the new page.

---

## 6. Initialization (*INZSR)  
- Populates `w_firm` from `p_firm`.  
- Chains `aforl1` to `aforl1_ruti = l_ruti` to pick up any program registry messages.  
- Defines all keyed lists (`KLIST`) for chain, setll, reade on work files.

---

**Pedagogical Notes:**  
- Key–level reads (`chain`/`setll`/`reade`) are central to filtering price and discount entries by category, customer, project, date, group/item.  
- The two‐stage chain into `fprwl1`/`frawl1` ensures that a higher‐level override exists before printing detail.  
- Subroutines segment the logic for clarity: header, detail loops, detail printing, footer, overflow handling.  
- Date‐based discount selection allows rate overrides during defined periods (e.g. seasonal discounts).