# RPG Code Explanation: `RH630R` (Hovedbok - utskrift/parameter)

This RPG III (ILE RPG) program is designed for the handling and validation of parameters for a general ledger printout. It's likely used as part of a larger financial management system, running on an IBM i (AS/400) platform. The language style and comments are in Norwegian, but the code conventions are standard for "traditional" RPG.

Below, you'll find a detailed walkthrough of its main components and logic.

---

## 1. **Control and File Specifications**

```rpg
h datedit(*dmy) option(*nodebugio)
fausrl1    if   e           k disk
frh630d    cf   e             workstn
```
- The `h` spec sets the date format and disables debug I/O.
- File `AUSRL1` is a keyed disk file (likely user records).
- File `RH630D` is a display file (used for interactive workstation screens).

---

## 2. **Field Definitions**

### **Arrays for Accounts:**
```rpg
d bkt             s              5  0 dim(41)   KONTI
d ukt             s              5  0 dim(41)   KONTI
```
- Two arrays for accounts (`KONTI`): one for initial entry, one for a processed (filtered/sorted) version.

### **Parameter Storage:**
```rpg
d rhpkda                300    305  0
d rhpr�r                         4  0
...
d rhpk40                         5  0
```
- These fields store parameters such as date, fiscal year (`rhpr�r`), period, range fields, and up to 40 account numbers.
- Fields like `rhpavf` and `rhpavt` are for department ranges, `rhpb�f` and `rhpb�t` for cost carrier ranges, etc.

### **User Info and Working Variables:**
```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
d flytt           s              1
d m               s              2  0
...
d w_navn          s                   like(l_fnav)
```
- Holds user, company number, names, and working variables for internal logic (indexes, temp storage, flags).

### **Message Variables and CTDATA:**
```rpg
T5.30d var             s             40    dim(2) ctdata perrcd(1)
T5.30d wsavli          s              2  0
T5.30d wsavpo          s              3  0
```
- `var` used for messages requiring confirmation, stored as compile-time data.

---

## 3. **Main Logic Flow**

### **Initial Tag - Field Assignments**
```rpg
c     dummy         tag
```
- Placeholder (entry point label for code navigation).

### **Screen Handling**
```rpg
c     a2tagb        tag
c                   exfmt     a2bld
```
- Presents the screen format `A2BLD` for user entry of criteria.

### **Exit Handling**
```rpg
c                   if        *inkc = *on
c                   move      '1'           p_in03
c                   goto      xslutt
c                   endif
```
- Exit if the user presses F3 (sets function key indicator KC).

### **Parameter Validation**
- The program checks, in order:
  - *Department range* (`a2pavf > a2pavt`): Set error indicator if invalid; returns to screen.
  - *Cost carrier range* (`a2pb�f > a2pb�t`): Similar check and handling.
  - *Account range* (`a2pktf > a2pktt`): Similar check and handling.
  - *Run date (`a2pkda`)*: If zero, set to current system date.
  - *Date validity* checked with `test(d)`.
  - *Fiscal year* (`a2pr�r > *year`): If set to a year beyond the current, issue a warning. The user must confirm (subroutine: `xm1win`).
  - *Period from-to* (`a2ppef > a2ppet`): Invalid entry if true.
  - *Account table* processing: Moves all entered accounts into an array. Any overlap between individual account selection and range will trigger a warning.

### **Account Table Sorting**
- The code moves non-zero accounts to the front of the `ukt` array.
- It then sorts the `ukt` array in ascending order.

### **Parameter Copy**
- Once validated and sorted, copies all input fields and processed accounts back to the program's output parameters (e.g., for use by a calling program or report).

---

## 4. **Program Termination**
```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Sets *LR (Last Record) indicator to signal end-of-program and returns.

---

## 5. **Subroutines**

### **1. Message Window Subroutine (`xm1win`):**
Handles confirmation message when fiscal year is set beyond the current year.
```rpg
T5.30c     xm1win        begsr
...
T5.30c                   exfmt     m1win
T5.30c                   if        *inkc = *on
T5.30c                   move      'N'           m1svar
T5.30c                   endif
T5.30c                   endsr
```
- Displays confirmation message and sets response variable depending on user input.

### **2. Initialization Subroutine (`*inzsr`):**
- Initializes key variables, user/company info, and parameter defaults.
- Sets up date and period parameters based on current date.
- Reads user record from `AUSRL1`.
- Sets up the parameter interface for the program.

---

## 6. **Indicator Usage Notes**

The program makes significant use of classic RPG indicators for controlling flow:
- **Function Keys:**
  - `KA` (F1): Company selection
  - `KC` (F3): Exit
- **Indicators for errors and display logic:**
  - `LR`: End of program
  - 30: Protect fields on display
  - 31–59: Warning/error indicators
  - 60–69: File and chain indicators
  - 70–99: Temporary/subroutine indicators

---

## 7. **User Messages (at end of program)**

```rpg
**
Valgt periode er neste år.
Bekreft dersom dette er riktig.
```
- Means: "Selected period is next year. Confirm if this is correct."
- Used when fiscal year is greater than system year.

---

# **Summary**

- **Purpose:** Collects, validates, and processes parameters for a ledger report (department, periods, account ranges, etc.).
- **User Interface:** Screen-based prompt with data validation and error feedback.
- **Output:** Sets up parameters and sorted account selection for use by downstream programs.
- **Error Handling:** Comprehensive validation, with warnings for unusual conditions (like fiscal year > system year), requiring explicit user confirmation.
- **Structure:** Uses tags and subroutines for logical flow; no free-format RPG; heavy use of indicator variables.
- **Localization:** Norwegian comments and field names.

**This program is a classic, highly-structured RPG application focused on correct data capture and validation for financial reporting operations.**