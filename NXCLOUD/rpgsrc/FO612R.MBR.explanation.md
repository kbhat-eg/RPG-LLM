# Explanation of RPG Program: FO612R (ASOFAK)

## Overview

This RPG program (FO612R) runs on IBM i (formerly AS/400) and handles moving parameter records from one physical file (PLUKK-1-LINJE-REGISTER) to another (PLUKK-2-LINJE-REGISTER), potentially in the context of batch job processing. The core logic checks specific conditions (such as matching workstation and user), copies the parameter record, and removes the original if found. It also handles "multi-order" scenarios by preparing for repeated invocation.

---

## File Declarations

```rpg
ffpm1l1    ip   e           k disk    rename(fpm1pfr:fpm1l1r)
ffpm1lu    uf   e           k disk    rename(fpm1pfr:fpm1lur)
ffpm2lu    uf a e           k disk    rename(fpm2pfr:fpm2lur)
```
- **fpm1l1, fpm1lu**: Input files tied to the first parameter/register, renamed for record format alignment.
- **fpm2lu**: Update file for the second parameter/register; supports adding new records.

---

## Data Structures

```rpg
d                 ds
d d_memb                        10
d  d_boks                        1    overlay(d_memb)
d  d_firm                        3  0 overlay(d_memb:2)
d  d_list                        6  0 overlay(d_memb:5)
```
- Defines a 10-char member name (`d_memb`)
  - `d_boks` overlays first char (box/type)
  - `d_firm` overlays chars 2-4 (company/firm)
  - `d_list` overlays chars 5-10 (list/number)

### Local Data Area

```rpg
d                uds
d l_vlg1                500    500  0
d l_vlg2                         1  0
d l_memb                        10
d l_vlg3                599    599  0
d l_wsid                901    910
d l_user                        10
```
- Area for control variables and job info passed to/from CL or other programs.

### Variables for Keys and Miscellaneous

```rpg
d w_firm          s                   like(fk1fir)
d fpm1lu_1wsd     s                   like(fk1wsd)
d fpm1lu_1usr     s                   like(fk1usr)
d fpm1lu_1lst     s                   like(fk1lst)
d w_numm          s              6  0
d w_stat          s              1
```
- For managing keys and state during file operations.

---

## Main Program Flow

### Initialization

- Local data area fields are reset (zeroed/blanked) at the start.

```rpg
c                   eval      l_vlg1 = *zero
c                   eval      l_vlg2 = *zero
c                   eval      l_memb = *blank
```

### Record Existence and Eligibility Checks

- If no record found for the input key (`*in01` = off), exit routine.
- Verifies that the parameter is for the correct workstation (`fk1wsd`) and user (`fk1usr`)â€”otherwise, exit.

```rpg
c     *in01         cabeq     *off          xslutt
c     fk1wsd        cabne     l_wsid        xslutt
c     fk1usr        cabne     l_user        xslutt
```

### Transfer Logic

- Set flag (l_vlg1) to instruct downstream to start process FO610C (value 1 by default, 2 if `fk1vg0=2`).
- Copy matching record from fpm1lu (param 1) to fpm2lu (param 2), writing new record if doesn't exist.
- Delete original record from PLUKK-1-LINJE-REGISTER.

### Multi-Order Handling

- If order number field `fk1onr` is zero (indicating batch/multi-order printout):
    1. Calls program 'FA920R' to retrieve the next available number (`w_numm`).
    2. Constructs new member name for the next operation.
    3. Signals (by setting l_vlg2/l_vlg3) that the process should repeat for the next order.

### Program End

- If all processing is done, sets LR (`*inlr`) to signal program termination and returns.

---

## Subroutine: *INZSR (Initialization)

- Zeroes out working fields (w_stat, w_numm).
- Builds composite keys for both PLUKK-1 and PLUKK-2 registers, to be used in subsequent database operations.

---

## Comments and Special Points

- **Condition Handling:** Uses `cabeq`, `cabne`, and `chain` operations for record existence, matching, and navigation.
- **Overlay/Redefinition:** Efficient use of overlays in data structures for parsing member names.
- **Batch Able:** If processing involves multiple orders, the program prepares for repeated runs via CL by setting specific flags.
- **Integration:** Calls another program ('FA920R') to get sequence numbers.

---

## Summary

This program serves as a robust, parameterized "move" utility between two similar data registers/files with special attention to job queues, user/session context, and multi-order scenarios. It is modular, using a CL program for setup and a separate sequence number service. Each run processes a single eligible record unless instructed to repeat for a batch.

---

### Common Onboarding Questions

- **What is PLUKK-1/PLUKK-2?**: Physical files representing different parameter "registers" in the application, possibly for staged/batched jobs.
- **Why chain/delete?**: To move records atomically between registers and avoid duplication.
- **What is the member name structure?**: A composed string of box/type, firm, and list/number.
- **What triggers batch mode?**: If the order number is zero, the program repeats for multiple orders.

---

## Further Reading

- "IBM i RPG Programming Guide" for file operations and subfile processing
- CL Programming Guide for understanding how this program is invoked and how the local data area is used in orchestration

---

Let me know if you'd like a flowchart or a line-by-line walkthrough of a specific section!