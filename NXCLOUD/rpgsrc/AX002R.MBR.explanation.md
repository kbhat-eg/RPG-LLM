# RPG Program AX002R Code Explanation

---

## Overview

This RPG (Report Program Generator) program, `AX002R`, is part of a system to export a Chart of Accounts ("KONTOPLAN") in XML format for SAF-T (Standard Audit File for Tax) reporting. The program reads account and balance data from various files, processes and formats it, and writes the results to an XML output file. It includes logic for parameter handling, data formatting, encoding special XML characters, and balance calculations.

---

## Main Components

### 1. **File Declarations**

- **Input Files:**
  - `rhovl1` (Account plan)
  - `rhsal1` (Balances)
  - `rhstl1` (Standard accounts)
  - `rxmll1` (XML template lines)

- **Output File:**
  - `axmlut` (Produced XML records)

All files use external definitions, using `rename` to map from physical file names to RPG record formats.

---

### 2. **Data Definitions**
- Local fields for:
  - Holding keys and data for each record
  - Temporary processing
  - Parameters (e.g., period selection, company, user)
  - For XML string processing and encoding

---

### 3. **Mainline Processing**

#### **Program Start (`start` label)**

- Reads records from the XML template file (`rxmll1`).
- Processes only if `axhead = 'KONTOPLAN'`.
- Skips lines not ready (`axtype = 'X'`).
- If `axmaop = 'S'` (indicating a loop operation), invokes the `LoopA` subroutine for iterating accounts.
- Handles lines with variable or fixed substitution markers:
  - `?V?` for variable fields (e.g., current date, account text, parameter fields).
  - `?F?` for fixed fields.
  - Performs substitution depending on `axtype` (C=current date, T=text, N=numeric, D=date, P=parameter, F=fixed XML).
- Each processed or substituted XML line is written to the output file (`axmlut`).

---

### 4. **Account Iteration (`LoopA` subroutine)**

- Loops through all accounts from `rhovl1` for the given company.
- For each account:
  - Ensures each account is only processed once.
  - Checks for valid standard account links, aborting with a message if missing.
  - Looks up corresponding standard account in `rhstl1`.
  - Calls `BerSaldo` to calculate opening and closing balances.
  - Formats and strips leading zeroes from account numbers for XML output.
- For each template line (`rxmll1`) with relevant `axmaop`:
  - Performs variable/fixed substitution as appropriate.
  - Handles balance fields (positive/negative opening and closing balances).
  - Writes each produced XML record.
- Handles 'end-of-section' template lines.

---

### 5. **XML Escaping (`sjk_XML_esc` subroutine)**

- Escapes special XML characters in text:
  - `&` → `&amp;`
  - `<` → `&lt;`
  - `>` → `&gt;`
  - `'` (apostrophe) → `&apos;`
  - `"` (quote) → `&quot;`
  - Special case: replaces 'Ø' (character code `�`) with 'P' (per requirements).
- Ensures output does not exceed buffer lengths.

---

### 6. **Balance Calculation (`BerSaldo` subroutine)**

- Loops through balances in `rhsal1` for the account and period.
- Calculates:
  - **Opening balance (`w_saldoi`)** for the start period (parameters `p_pfa`, `p_pfm`).
  - **Closing balance (`w_saldou`)** for the end period (`p_pta`, `p_ptm`).
- Sums up period fields (`risa00`–`risa12`) as appropriate for periods.
- Formats balances as strings for XML (removing leading zeros, adding decimal).
- Handles positive/negative balances for correct XML field assignment.

---

### 7. **Initialization (`*inzsr` subroutine)**

- Defines key lists for file access.
- Sets up company and user values from program parameters (LDA/dtaara).

---

### 8. **Program Entry Point (`*entry` subroutine)**

- Accepts input parameter for abort status.
- Loads period and comment parameters from data area (`AX000PAR`).
- Copies parameter data for easy access.
- Sets up the primary company info and initializes the XML template pointer.

---

## **Business Rules & Features**

- **SAF-T/SAFT XML output:** The purpose is to create a standard-compliant XML representation of the chart of accounts and balances for tax-reporting.
- **Parameterized:** The program is driven by values in a data area (for period, year, comments).
- **Robustness:** Checks for missing or invalid account links and aborts with informative messages.
- **XML Safe:** Escapes special XML characters to prevent illegal XML output.
- **Flexible template:** Uses a template file to allow future-proofing or changes to XML structure by simply adjusting the template file.

---

## **How to Read/Onboard This Program**

- **Understand the input data:** Familiarize yourself with the physical files for accounts (`rhovl1`), balances (`rhsal1`), and XML templates (`rxmll1`).
- **Parameters/data area:** Know how the data area (`AX000PAR`) is populated and used to drive periods and other config.
- **Modify logic:** Most changes (e.g., new fields, different XML structure) are handled either in the template file or by updating/adding variables for substitution.
- **Testing:** Always check generated XML for validity and correct account/balance mapping, especially after template changes.

---

## **Modifications (as seen in version history)**

- 7.00: Initial rollout for SAFT reports.
- 7.01: Replacement of special Norwegian character 'Ø' with 'P' in output.
- 7.02: Expanded balance fields for managers.

---

## **Key Points for Developers**

- **File-driven:** New accounts or structures simply require updating the files (or templates), not the code.
- **Template logic:** Learn how `?V?` and `?F?` are used in the XML template for substitution.
- **Balance logic:** Understand how opening and closing balances are built from period fields.
- **Subroutines:** The main logic is modular (account loop, XML escaping, balance calculation).
- **Exit/Abort:** The program aborts cleanly with messages if data integrity fails.
- **Extensibility:** For new fields/logic, add to the relevant subroutine and template.

---

**In summary:**  
AX002R is a classic ILE RPG program for automating XML output from account and balance data, with extensible template-driven logic, robust error handling, and compliant output for financial reporting purposes.