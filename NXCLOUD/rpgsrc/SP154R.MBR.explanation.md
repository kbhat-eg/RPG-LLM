# ASSTAT – SP154R – Product Responsible Selection

## Overview

This program (SP154R) is a part of the ASSTAT system and is responsible for managing the selection, creation, update, and deletion of "Produktansvarlig" (Product Responsible) records via a subfile-based user interface. It is tailored for use with a GUI and interacts closely with physical and logical files in the SKPML1 file family.

The primary business logic revolves around presenting, maintaining, and validating product responsible entries for a particular firm and product type.

---

## File Definitions

- **sp154d** – Workstation file (display), uses a subfile (`b1sfl`) with relative record number (`w_srrn`).
- **skpml1** (and related logical files: skpmlr, skpmlu) – Disk files for storing product responsible data, all renamed from the base physical file `skpmpfr`.
    - `skpml1` – Main access (read/update).
    - `skpmlr` – Read access, alternate key.
    - `skpmlu` – Update access.

---

## Key Data Structures and Variables

- **Key Variables**: Used for file access (`skpml1_type`, `skpml1_kode`, `skpml1_valg`, etc.), each corresponding to file key fields.
- **Work Variables**: For subfile page control and status (`w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`), and for user interaction state (`b_forn`, `b_anul`, `b_feil`).
- **Firm and Product Type**: `w_firm`, `wptype`, `wpkode`, `wptext` represent the current firm and product type context.
- **Parameter Passing**: Program receives `wptype` and `wptext` as parameters from the calling program (see `*entry` PLIST).

---

## Local Data Area (LDA)

- **dsfirm**: Firm number (positions 944-946 in the LDA) is loaded into `w_firm` at initialization and used as part of all file keys.

---

## Main Processing Flow

1. **Initialization (`*inzsr`)**
    - Parameter values for product type and description are set.
    - Key variables are initialized for all file access paths.
    - Firm number is loaded from LDA.
    - Subfile is populated with initial data.

2. **Main Loop**
    - Alternates between command display (`b2cmd`), subfile display/update, and function key handling.
    - Handles function keys for exit, refresh, create, and other actions using `select/when` logic.

3. **Subfile Processing**
    - **Display**: Subfile is shown with current product responsible records.
    - **Paging**: Supports paging via page and record counters.
    - **Selection**: Allows positioning to a specific record.
    - **Create/Update/Delete**: Handles add, change, and delete actions, validating keys and managing file updates.

---

## Subroutines

### 1. `forny` – Refresh Subfile
- Repositions file pointer and reloads the subfile records.

### 2. `posisjoner` – Position in Subfile
- Positions subfile on a specific value (`b2pran`).
- Clears and refills subfile starting from the positioned record.

### 3. `control` – Subfile Control Handler
- Handles create (`b2valg = '1'`), delete (`b2valg = '4'`), and validation of input.
- Sets error indicators and refreshes as needed.

### 4. `subfile` – Subfile Record Processing
- Loops through visible subfile records.
- Handles inline delete requests from subfile rows.

### 5. `xc1bld` – Create/Change Entry Screen
- Presents screen for new or changed entry.
- If the entry already exists, displays an info message (`xc1msg`).
- Calls registration routine (`xc2bld`) for actual update/write.

### 6. `xc1msg` – Duplicate Entry Message
- Shows message if user attempts to create a record that already exists.

### 7. `xc2bld` – Edit/Display Entry Details
- Loads details for the selected entry.
- Allows editing and updates or creates the record in `skpmlur`.
- Refreshes subfile if needed.

### 8. `xd1win` – Delete Confirmation
- Presents a confirmation screen for deletion.
- Deletes the record upon confirmation.

### 9. `clr_subfile` – Clear Subfile
- Clears subfile display and resets paging variables.

### 10. `crt_subfile` – Populate Subfile
- Reads records from `skpml1` and fills the subfile up to a page limit (`c_sfil`).

### 11. `dsp_subfile` – Display Subfile
- Manages the display and formatting of the subfile, including page navigation.

---

## Key Business Logic and Conventions

- **Subfile Paging**: The subfile is managed in pages (default of 12 rows per page, `c_sfil`), supporting scrolling and positioning.
- **Firm/Product Context**: All operations are scoped to the current firm and product type, enforced by key composition.
- **Inline and Dialog Actions**: Supports both inline subfile actions (e.g., delete from subfile row) and dialog-based actions (e.g., create/change via separate screens).
- **Error Handling**: Uses flags (`b_feil`, `b_anul`, etc.) and indicator fields for error and control flow.
- **File Locking/Concurrency**: Standard RPG practices are used; no explicit lock management is visible, but update/delete via chain ensures record-level concurrency.

---

## Integration Points

- **External Program Call**: Calls program `RA526R` for some lookups or validations when function key is pressed on the create/change screen.
- **LDA Usage**: Reads firm number from the LDA, which must be set by the calling environment.
- **Parameter Passing**: Receives product type and description as parameters from the caller.

---

## Notable Design Patterns and Conventions

- **Subfile Pattern**: Standard IBM i subfile pattern with explicit subfile control, paging, and record-level processing.
- **Key List Abstraction**: Use of named KLISTs for file access improves readability and maintainability.
- **Separation of Concerns**: Business logic for create, update, delete, and display are encapsulated in dedicated subroutines.
- **GUI Adaptation**: Some comments and code are specific to GUI requirements, e.g., DDS dependencies, which may not apply to green-screen only versions.

---

## Relationships to Other Modules

- **skpmpfr**: Underlying physical file for product responsible data.
- **RA526R**: External program for additional validation or lookup during entry creation/change.
- **LDA**: The program expects the LDA to be correctly populated with firm and user information.

---

## Summary

SP154R is a robust, modular subfile maintenance program for managing product responsible records within the ASSTAT system. It follows established IBM i subfile and file handling patterns, with clear separation of display, control, and database logic. Domain-specific conventions (firm, product type, entry validation) are consistently enforced, ensuring data integrity and user guidance throughout the maintenance workflow.

---

**Note:** For further understanding, refer to the display file (`sp154d`) and the physical/logical file definitions for `skpmpfr`, as well as any business rules regarding product responsible data in the ASSTAT system.