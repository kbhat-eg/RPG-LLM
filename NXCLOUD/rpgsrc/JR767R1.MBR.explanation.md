# Program Overview  
This IBM i ILE RPG program (JR767R) reads an input file with record format **OLEMOE** (containing item/pricing data), then:  
  - Updates existing item prices in the LVR price file based on supplier-item matches.  
  - For new items matching by EAN number, creates a price record as the supplying vendor.  
  - Invokes a separate program (JV790R) to update search text for each processed item.  

---  

## File Declarations  
- **fjrvapf (JRVRADF)** – Input file containing raw pricing data (record format **OLEMOE**).  
- **fjvprl2 (JVRPL2R)** – File of existing item-price records, keyed by (supplier, item).  
- **fjvprlu (JVRPLUR)** – Update-capable version of the same price file.  
- **fjvarld (JVARLDR)** – File of items indexed by EAN number.  
- **fjlevl1 (JLEVL1R)** – Supplier master file, keyed by supplier number.  
- **fjrapl1 (JRAPLR1R)** – Report writer master, keyed by firm & report number.  

Each file is defined with `if e k disk` (input) or `uf a e k disk` (update). Some are renamed for clarity.  

---  

## Data Structures & Fields  

1. **Parameter List (`p_list`, 32 bytes)**  
   - **d_list** overlays it:  
     - `d_firm` (3 digits) – Company code  
     - `d_rapp` (2 digits) – Report number  
     - `d_dato` (date ISO) – Processing date  

2. **User Data Structure (`uds`)**  
   - `l_user` (positions 911–920) holds the programmer/user ID for audit fields.  

3. **Input Record Description (`d_inpu`, length 173)**  
   Overlays the raw record into typed fields:  
   - `d_vare` (13) – Item number  
   - `d_vgrp` (4) – Item group code  
   - `d_tek1`/`d_tek2` (30 each) – Item description lines  
   - `d_enhe` (3) – Unit of measure  
   - `d_anta` (5) – Quantity per pack  
   - `d_sapr`, `d_inpr`, `d_grpr`, `d_grp2` – Sales, purchase, base prices, etc.  
   - `d_eann` (13 digits) – EAN number  
   - `d_rgrp` (5) – Discount group  
   - `d_gtxt` (20) – Group text  

4. **Key Variables for Lookups**  
   - `jrapl1_rapp`, `jlevl1_ldor`, `jvprl2_ldor/jvprl2_lvar`, `jvarld_ean1`, `jvprlu_vare/jvprlu_ldor`  

5. **Working Fields**  
   - `b_inlr` – Flag to pass *INLR to called program  
   - `w_firm` – Company code copy  
   - `w_pris` – Computed purchase price  
   - Constants `Lo`/`Up` – Lower/upper-case maps for text translation  

---  

## Initialization (`*INZSR`)  
1. **Parameter Entry**  
   - Reads `p_list`, populates `d_list` → `w_firm`, `d_rapp`, `d_dato`.  
2. **Key List Setup for CHAIN/READ Operations**  
   - Defines the order of key fields for each file operation.  

---  

## Main Program Logic  
1. **Load Report Writer Info**  
   - `jrapl1_key chain jrapl1` using `(w_firm, d_rapp)`  
   - If not found, exit.  

2. **Load Supplier Info**  
   - `jlevl1_key chain jlevl1` using `(jrldor)` (supplier ID from JRAPLR1R)  
   - Upper-case the supplier name (`xlate Lo→Up`).  

3. **Process File**  
   - Call subroutine `behandling`.  

4. **Exit**  
   - Set `*inlr = *on` and return.  

---  

## Subroutine: behandling (Process Items)  
Loop through input file (**OLEMOE**):  
1. `read jrvapf` → fills `d_inpu`.  
2. Skip if `d_vare` blank.  
3. Attempt to chain into existing price record (**JVRPL2R**) by `(supplier, item)`:  
   - If found (`*in91 = *off`), call `endr_pris` (modify if needed).  
   - Else, call `oppr_pris` (create new price record).  
4. If an item number (`jxvare`) was set, call external program **'JV790R'** to update search text, passing:  
   - `w_firm`, `jxvare`, `b_inlr`.  
5. Repeat until end of file.  

---  

## Subroutine: oppr_pris (Create New Price)  
1. Exit immediately if no EAN (`d_eann = 0`).  
2. Chain to item master file (**JVARLDR**) by EAN → `jvvare`.  
3. If item not found, exit.  
4. **Cleanup**: Delete any existing price records for this `(item=jvvare, supplier=jrldor)` in **JVRPLUR**.  
5. **Write New Price**  
   - Populate `jxvare`, `jxldor`, `jxlvar` (vendor’s item no.), `jxpris` (purchase price), `jxgdat` (effective date), audit fields (`jxeusr`, `jxodat`, `jxedat`, `jxetim`, etc.).  
   - `write jvprlur` to file.  

---  

## Subroutine: endr_pris (Modify Existing Price)  
1. Compute `w_pris` = purchase price from input.  
2. If unchanged (`w_pris = jxpris`), exit.  
3. Chain to the existing record in **JVRPLUR** by `(item=jxvare, supplier=jrldor)`.  
4. Update `jxlvar`, `jxpris`, `jxgdat`, audit date/time fields.  
5. `update jvprlur`.  

---  

# Key Takeaways for Onboarding  
- Uses traditional **fixed-format RPG** with manual `CHAIN/READ/DELETE/WRITE/UPDATE`.  
- Overlays a 173-byte record into typed fields for easy access.  
- Separates logic into small subroutines for clarity (`behandling`, `oppr_pris`, `endr_pris`).  
- Employs parameter list/INZSR for startup, driving by a **firm/report/date** triplet.  
- Integrates with external utility **JV790R** to maintain search text after price changes.