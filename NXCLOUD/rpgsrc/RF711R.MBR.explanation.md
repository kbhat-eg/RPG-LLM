# RPG Program Explanation

This RPG (Report Program Generator) source code is for an IBM i (AS/400) system, written in traditional (fixed-format) RPG IV. The purpose of this program is to delete records from the physical file `rtx2l1` (renamed from `rtx2pfr`), based on certain key criteria passed in as parameters.

## High-Level Overview

- The program deletes records from the file `rtx2l1` that match a specific firm, member, and batch number.
- The member and batch to be deleted are passed as parameters to the program (`w_memb` and `w_bunt`).
- The "firm" to be deleted is obtained from a local data structure field (`l_firm`).

---

## File Declarations

```rpg
frtx2l1    uf   e           k disk    rename(rtx2pfr:rtx2l1r)
```
- `frtx2l1`: Input/output file, full procedural, externally-described, keyed file.
- `rename(rtx2pfr:rtx2l1r)`: The RPG program refers to the format `rtx2pfr` as `rtx2l1r` internally.

---

## Data Declarations

- `rtx2l1_firm`, `rtx2l1_memb`, `rtx2l1_bunt`: Local variables, used in key lists or storing parameter values.
- `w_bunt`, `w_memb`: Parameter variables for batch and member, respectively.
- `l_firm`: Subfield (at byte positions 944-946) of an unnamed data structure, stores the 'firm' code for processing.

---

## Key List Definition

```rpg
c     rtx2l1_key    klist
c                   kfld                    rtx2l1_memb
c                   kfld                    rtx2l1_firm
c                   kfld                    rtx2l1_bunt
```
- Defines a composite key for access to file `rtx2l1`, made up of member, firm, and batch.

---

## Mainline Logic

### Entry Point

- `*inzsr` subroutine is the initialization section for startup logic:
    - Receives parameters (`w_memb`, `w_bunt`) via the parameter list (`plist`/`parm`).
    - Initializes variables for later use.

### Record Deletion Loop

1. **Set Lower Limit for Key**:  
   `setll rtx2l1` positions the file at the first record based on the key.

2. **Loop ("start" tag)**:
    - Reads the next record (`read rtx2l1`).
    - If EOF (`*in15` is on), jumps to `slutt` (end tag).
    - If the `rx2fir` field (firm) does not match `l_firm`, ends the loop.
    - If the `rx2unt` field (batch) does not match the parameter, skips to next record.
    - If the `rx2emb` field (member) does not match the parameter, skips to next record.
    - If all the above criteria match, deletes the record.
    - Loops back to the start to read the next record.

3. **Exit Point ("slutt" tag)**:
    - Sets on the last record indicator (`*inlr = *on`), signalling program cleanup and end.

---

## Subroutine: *inzsr

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    w_memb
c                   parm                    w_bunt
c                   eval      rtx2l1_firm = l_firm
c                   eval      rtx2l1_memb = w_memb
c                   eval      rtx2l1_bunt = w_bunt
c                   endsr
```

- Handles program initialization.
- Receives parameters (`w_memb`, `w_bunt`).
- Sets up local copies of those parameters and the firm code for later use.

---

## Summary Table

| Variable/File      | Description                                    |
|--------------------|------------------------------------------------|
| `rtx2l1`           | The working file (keyed physical file, delete from) |
| `w_memb`           | Member code (input parameter)                  |
| `w_bunt`           | Batch number (input parameter)                 |
| `l_firm`           | Firm code (extracted from a data structure)    |
| `rtx2l1_firm`      | Local copy of firm code (for key list)         |
| `rtx2l1_memb`      | Local copy of member (for key list)            |
| `rtx2l1_bunt`      | Local copy of batch (for key list)             |

---

## Flow Diagram

```
Initialization (*inzsr)
   ↓
Set key position (setll)
   ↓
Read first record
   ↓
[If EOF?] → Yes → End
   ↓
No
   ↓
[If firm matches?] → No → End
   ↓
Yes
   ↓
[If batch matches?] → No → Next record
   ↓
Yes
   ↓
[If member matches?] → No → Next record
   ↓
Yes
   ↓
Delete record
   ↓
Next record (loop)
```

---

## Key Points

- The program is written in fixed-format RPG IV.
- It processes records in `rtx2l1` by key, deleting records matching all three criteria (firm, member, batch).
- Parameters `w_memb` and `w_bunt` are passed into the program; `l_firm` is internally set.
- It uses RPG's indicator variables (e.g., `*in15` for EOF, `*inlr` for end of program).

---

## Conclusion

This program is a batch utility for deleting records from a keyed file based on provided member, batch, and firm codes. By carefully comparing each record and looping only until EOF or a firm boundary, it safely and efficiently purges only the intended records.