# RA525R – “Kjøreruter, spørring” (Route Inquiry) Program

This program is designed to display and select route information (in Norwegian, “Kjøreruter”) from one or more database files, using a subfile-driven interactive screen. It can retrieve and filter routes either by route code or by descriptive text, then present them in a scrollable subfile interface. Below is an overview of key elements and logic specific to this application.

---

## Purpose and Overall Flow

1. **Initialization and Parameters**  
   • The program receives three parameters:  
     – Firm number (p_firm)  
     – Initial route code (p_yrut)  
     – Initial route text (p_ytxt)  

   • It stores these parameters in local work fields and prepares for subfile operations.  
   • The program then positions (using SetLL) to the starting point in the route database (RA25L1 or RA25L2) based on the passed route information, and immediately populates the subfile (via the subroutine crt_subfile).

2. **Main Display Loop**  
   • The program alternates between writing a command/tips record (B2CMD) and a control record (B2CTL) for the subfile.  
   • Users can press various function keys (e.g., *INKC, *IN10, *IN11) to exit, scroll forward, scroll backward, or reposition.  
   • Business logic for these function keys appears within a SELECT/WHEN block, invoking subroutines like crt_subfile (build next page), bck_subfile (page backward), and dsp_subfile (refresh display).

3. **Subfile Structure**  
   • The subfile record format is B1SFL, controlled by B2CTL. A separate record format B2CMD is used for commands.  
   • The program tracks:  
     – w_srrn: Current relative record number  
     – w_spge: Page size counter  
     – w_sfrn: First record number on the current subfile page  
     – w_ssrn: Last record number on the current subfile page  

4. **Route Selection**  
   • Each displayed subfile record has an indicator (b1valg). If set to 1, it means the user chose that route.  
   • Once a selection is made, the program moves the chosen route data (b1yrut, b1ytxt) into the output parameters (p_yrut, p_ytxt) and ends.

---

## Relevant Domain Logic

1. **Database Files**  
   • RA25L1 / RA25L2: These files hold route data for the system. They contain fields like:  
     – rayfir (firm number)  
     – rayrut (route code)  
     – raytxt (route description)  

   • The program dynamically decides which file to read based on w_seqe.  
   • If w_seqe = 'B', it reads RA25L2 (sorted or keyed by description). Otherwise, it reads RA25L1 (sorted or keyed by route code).

2. **Search Criteria**  
   • The user can optionally specify a route (b2yrut) or route description (b2ytxt) for initial positioning.  
   • Subroutine posisjoner sets the appropriate key list (ra25l1_key or ra25l2_key) to jump directly to the requested route or description.

3. **Firm Context**  
   • w_firm is used to ensure the user is only shown routes for the active firm. During reads from RA25L1/RA25L2, the program checks if the record’s firm number matches w_firm; if not, it stops fetching data for the subfile.

---

## Key Subroutines

1. **clr_subfile**  
   • Clears the existing subfile data by turning on indicator 14, writing B2CTL, then resetting counters and indicators.

2. **crt_subfile**  
   • Fills the subfile page by reading the next chunk of records (size c_sfil).  
   • Decides which database file to read based on w_seqe.  
   • Populates the subfile fields (b1yrut, b1ytxt) and writes each record to B1SFL until reaching the page limit or end of file (indicator 15).

3. **forny**  
   • Refreshes the subfile after a new positioning or user action, often chaining back to the record from which the user navigated.  
   • Calls clr_subfile followed by crt_subfile to reconstruct the subfile content in the new position.

4. **posisjoner**  
   • Reads user inputs (b2yrut, b2ytxt) that override the current key.  
   • Sets up w_seqe and the relevant Key List (ra25l1_key or ra25l2_key) to reposition before clearing and rebuilding the subfile.

5. **subfile**  
   • Reads the subfile records directly from the display (READC on b1sfl) to check if the user has selected a record (b1valg = 1).  
   • If so, the chosen values are passed back in p_yrut and p_ytxt, and the program exits.

6. **bck_subfile**  
   • Scrolls one page backward. Uses READP to move the file cursor backward, effectively retrieving the previous set of records.  
   • Rebuilds the subfile from that point by calling clr_subfile and crt_subfile.

7. **dsp_subfile**  
   • Handles subfile display operations: sets indicators (such as *IN12 for subfile display) and calls EXFMT on B2CTL to interact with the user.

---

## Notable Design Considerations

1. **Dual File Access**  
   • The choice between RA25L1 (route code keyed) or RA25L2 (text keyed) gives flexibility to search by code or description. The flag w_seqe conveys the user’s “mode.”

2. **Paging Control**  
   • The program manages subfile paging manually, rather than letting the system handle all subfile scrolling. This manual approach allows backward and forward reads in the database files to pick up the exact set of records for each screen page.

3. **Indicator Usage**  
   • The code uses a set of standard indicators (10, 11, 14, 15, etc.) to handle scrolling, clearing, subfile control, and user feedback. This is typical in subfile-based applications but noteworthy for new developers who must recognize which indicators control which screen behaviors.

4. **Returning Selected Data**  
   • Once a user selects a route (b1valg = 1), the program sets p_yrut and p_ytxt with the chosen record. This approach lets a calling program receive the user’s selection seamlessly.

---

## Interaction with Other Components

• The program is part of the ASOKON system. It interacts primarily with the RA25 database files (RA25L1 and RA25L2) for route information.  
• Any further integration (e.g., with a GUI or other modules) likely happens through the parameters p_firm, p_yrut, and p_ytxt that the caller provides and then receives back after selection.  

---

This program, RA525R, provides a subfile-based inquiry for routes, allowing the user to locate, scroll through, and select route records by code or description. It showcases standard subfile techniques—clearing, populating, scrolling, and returning chosen data—adapted to the business requirement of flexible positioning and a firm-specific filter.