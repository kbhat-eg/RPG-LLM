# Documentation: RH654R – Stikkprøver Hovedbok Rapport

## Purpose

This program, `RH654R`, generates a report of sampled ("stikkprøver") transactions from the general ledger (`hovedbok`). The report supports selection by company, department, account number, special codes, and allows for sampling by interval and minimum transaction amount.

The program is designed for auditing or control purposes, enabling users to review a subset of ledger entries according to specific criteria.

---

## Structure Overview

### Files

- **Input File: `rhtrl3`**
  - Disk file containing general ledger transactions.
  - Renamed data structure: `rhtrl3r`.
- **Output File: `rh654p`**
  - Printer file for report output.
  - Overflow indicator: `*in30`.

### Data Structures

#### Brudd (Break) Structures

- `nybrd` / `gmbrd`: 13-digit control value used for detecting breaks (changes) in grouping fields.
  - Overlays for grouping:
    - `avd` (department)
    - `kto` (account)
    - `grp` (group)
    - `kla` (class)
    - `sps` (special code)
- `ny*` are the "current" values from the transaction being processed.
- `gm*` are the "previous" values, used to detect breaks.

#### Parameters in LDA

- Various fields (`rhpfir`, `rhpnav`, etc.) are loaded from the user area (LDA). These control the report selection criteria:
  - Company, user, date, year, period, department/account from/to, sampling interval, amount threshold, etc.

#### Work Variables

- `antskr`, `anttra`: Counters for lines and transactions.
- `l1*`, `l2*`, `lr*`: Accumulators for subtotals at different grouping levels (account, department, report).
- `whpbel`, `whpran`: Working fields for sampling logic.
- `w_firm`: Working firm key.

---

## Business/Domain Logic

### Selection and Sampling

1. **Period Filter:** Only includes transactions within the selected period (`rbrper` vs. `rhppef`/`rhppet`).
2. **Department/Account Ranges:** Transactions filtered by department (`rbavd`) and account (`rbkont`) within from/to ranges.
3. **Sampling:**
   - **Interval Sampling:** If `rhpran` > 0, only every Nth transaction is included.
   - **Amount Threshold:** If `rhpbel` is set, only transactions above/below this value are included.

### Grouping and Break Logic

- The report is grouped by account and optionally by department (if sorted by department, `rhpsrt = 'A'`).
- On change (break) of account or department, the program:
  - Writes subtotal lines.
  - Fetches and prints descriptive text for account/department.
  - Resets relevant accumulators.

### Subtotals and Accumulators

- Subtotals are maintained at multiple levels:
  - **Account Level (`l1*`):** Resets on account break.
  - **Department Level (`l2*`):** Resets on department break.
  - **Report Level (`lr*`):** Used for grand totals.

### External Program Calls

- **`RS740R`:** Fetches account descriptive text from the chart of accounts.
- **`RS707R`:** Fetches department descriptive text from the code register.

### Output

- **Headings:** Printed at the start and on each break.
- **Transaction Lines:** Printed for each included transaction.
- **Subtotals:** Printed on account and department breaks.
- **Grand Totals:** Printed at end of report.

---

## Design Decisions & Patterns

- **Overlay Data Structures:** Used extensively for efficient break/grouping detection.
- **Indicator Usage:** Follows a documented convention for indicator assignments (see header comments).
- **Subroutines:** Key business logic (break processing, subtotaling, heading writing) is encapsulated in subroutines for maintainability.
- **Sampling Logic:** Implemented using working fields (`whpran`, `whpbel`) for flexible inclusion criteria.

---

## Interactions with Other Modules

- **Code/Account Text Retrieval:** Relies on external programs (`RS740R`, `RS707R`) for fetching descriptive text. These must be available and return expected results.
- **LDA Parameter Usage:** Assumes parameters are correctly populated in the LDA by the calling environment or job setup.

---

## Notable Conventions

- **Break Detection:** Uses composite keys in data structures for efficient detection and handling of group changes.
- **Subroutine Naming:** Norwegian abbreviations are used (`flytt` = move/copy, `brkto` = account break, `bravd` = department break, `skriv` = write/print).
- **Indicator-Driven Flow:** Many actions are gated by indicators, especially for file I/O and screen/protect logic, consistent with legacy RPG practices.

---

## Summary of Main Flow

1. **Initialization (`*inzsr`):** Sets up working fields, fetches initial texts, prints headings.
2. **Read Loop:**
   - Reads transactions sequentially.
   - Applies selection filters (period, department, account, sampling).
   - On inclusion, handles break logic, prints lines, updates accumulators.
   - On break, calls subroutines to print subtotals and reset fields.
3. **Finalization:** Prints grand totals and ends the report.

---

## Key Points for New Developers

- **Understand the break logic:** The heart of the report lies in correctly detecting and handling breaks on account and department.
- **Sampling is flexible:** Both interval and amount-based sampling are supported; ensure parameters are set as intended.
- **External dependencies:** The report's descriptive texts depend on external programs; errors here may impact output quality.
- **Indicators drive control:** Familiarity with the indicator assignments (see header) is essential for troubleshooting and enhancements.

---

## Related Modules

- **RS740R:** Account plan text retrieval.
- **RS707R:** Department code text retrieval.

---

## Further Reading

- **General Ledger File Layout (`rhtrl3`)**
- **Parameter Setup in LDA**
- **Printer File Layout (`rh654p`)**
- **Indicator Usage Conventions in ASOKON System**