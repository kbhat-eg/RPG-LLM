```markdown
# VV740R – Update Product Number in All Tables

## 1. Introduction
- **System:** ASOFAK  
- **Program:** VV740R  
- **Description:**  
  This program replaces a product number (`p_gvar`) with a new product number (`p_vare`) in all related database tables (except the main product master).  
  **Note:** When adding new tables, the batch copy job must also be adjusted to override the correct tables.

## 2. Change History
| Version | Date     | Author | Description                                    |
| ------- | -------- | ------ | ---------------------------------------------- |
| 1.00    | 22-06-99 | HKO    | Initial creation                               |
| 1.01    | 27-02-00 | HKO    | Added note-ID swap in ANOTLU                   |
| 1.02    | 13-01-02 | HKO    | Added price-lookup line swap                   |
| …       | …        | …      | …                                              |
| 8.01    | 22-06-22 | bof    | Extended price group from 1 to 2 positions     |

## 3. Parameters
| Name    | Position | Type | Length | Meaning                         |
| ------- | -------- | ---- | ------ | ------------------------------- |
| p_firm  | 1        | ZONED| 3,0    | Company code                    |
| p_gvar  | 2        | CHAR | 15     | Old product number (to replace) |
| p_vare  | 3        | CHAR | 15     | New product number              |
| p_inlr  | 4        | CHAR | 1      | *ON if LR should be set on exit |

## 4. Working Variables
- **w_firm, w_gvar** – copies of `p_firm`/`p_gvar` used in key lists  
- **w_modn** – VA module number (if using VA product features)  
- **jvarl1_vare** – holds the product number for a VA lookup  
- **anotlu_syst, anotlu_noid** – key fields for ANOTLU (notes) update

## 5. File Declarations
Each database file is declared as **UF   …   KEYED   DISK** and uses `RENAME` to give the work record a “…R” suffix.  
Example:
```
     FVVENLU  UF   E           K DISK  RENAME(VVENPFR:VVENLUR)
```
- **UF** – Update file  
- **E**  – Entry type  
- **K DISK** – Keyed, on-disk  
- **RENAME** – alias for the record format

## 6. Main Logic
### 6.1 Initialization
1. `w_firm = p_firm`  
2. `w_gvar = p_gvar`  
3. *Optional VA step:* read `JVARL1` by `(w_firm, p_vare)` to fetch `w_modn`.

### 6.2 Batch-Update Loop
For each target file (e.g. **VVENLU**, **VVEPLU**, **VVPRLU**…):

1. **Position** on the first matching record:
   ```
   SETLL   (w_firm, w_gvar) on <file>
   READE   <filerec>R       +→ L90
   ```
2. **Loop** while record exists (`*IN90 = *OFF` or `not %Eof`):
   - Assign new product number:  
     `VEVARE = p_vare`  (field names vary per file)  
   - Optionally update date/time/user fields  
   - Write updated record:  
     `UPDATE <filerec>R`  
   - Read next record:  
     `READE <filerec>R       +→ L90`
3. **End** loop with `ENDDO`.

#### Example: Update Product Unit Register (VVENLU)
```
SETLL   (w_firm,w_gvar) on VVENLU
READE   VVENLUR                         90
DOW     *IN90 = *OFF
  VEVARE = p_vare
  UPDATE VVENLUR
  READE VVENLUR                        90
ENDDO
```

### 6.3 Special Cases
- **Sortiment Lines (VSDTL7):**  
  If both `vdmodn` and `w_modn` are non-zero, set `vdmodn = w_modn`.  
- **History Ledger (VHISL3):**  
  To avoid duplicates, increment `vhsekv` by 9000.  
- **Notes Table (ANOTLU):**  
  Key is `(w_firm, 'VVAR', w_gvar)` and `aunoid = p_vare`.  
- **VA Price Lookup (JPFAL6):**  
  If present, update `jcmodn` similarly to sortiment logic.

### 6.4 Exit
- If `p_inlr = *ON`, then set `*INLR = *ON`.  
- `RETURN` to caller.

## 7. Initialization Subroutine (`*INZSR`)
- **PLIST** defines the four parameters in incoming order.  
- **KLISTs** build key definitions for:
  - `key01`  → `(w_firm, w_gvar)`  
  - `anotlu_key` → `(w_firm, anotlu_syst, anotlu_noid)`  
  - `jvarl1_key` → `(jvarl1_vare)` for the optional VA master read  

```rpg
     *INZSR  BEGSR
     PLIST
       PARM p_firm
       PARM p_gvar
       PARM p_vare
       PARM p_inlr
     KLIST key01
       KFLD w_firm
       KFLD w_gvar
     KLIST anotlu_key
       KFLD w_firm
       KFLD anotlu_syst
       KFLD anotlu_noid
     KLIST jvarl1_key      // VA special
       KFLD jvarl1_vare
     ENDSR
```

## 8. Extending VV740R
When new tables must adopt a product-number swap:

1. **Declare** the file in the F-spec with `UF`, `KEYED`, `RENAME`.
2. **Add** a SETLL/READE/DOW/UPDATE/ENDDO block in the main logic.
3. **Include** any special date/time/user or module logic.
4. **Update** the copy job if file overrides are needed.
```