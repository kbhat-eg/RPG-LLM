# Explanation of IBM ILE RPG Code (LL623R)

This program is written in ILE RPG (RPG IV) and is used for printing a "varebevegelsesliste" (Norwegian for: product movement list). Below is a section-by-section breakdown of the program to help new developers understand its structure and logic.

---

## 1. Header and Program Documentation

```rpg
/TITLE  Utskrift av varebevegelsesliste
h datedit(*dmy) option(*nodebugio)
```

- `/TITLE` sets a descriptive title for the program.
- `H` specification sets date formatting and disables debug I/O.

The initial comment block describes the program:  
- Name: LL623R
- Purpose: Printing a product movement list
- Maintains a changelog with developer initials.

---

## 2. File Declarations (`F-Specs`)

```rpg
flwa1l1    if   e           k disk    rename(lwa1pfr:lwa1l1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
fll623p    o    e             printer
```

- Declares several input files (`lwa1l1`, `vvarl1`, etc.) with external descriptions.
- Renames the file formats in RPG for internal use.
- `ll623p` is declared as an output printer file.

---

## 3. Data Structure for Parameters

```rpg
d                 ds
d p_prec                       128
d  p_fvar                        8  0 overlay(p_prec)
d  ... (etc.)
```

- A data structure overlays `p_prec` (128 bytes) with various fields such as:
  - `p_fvar`, `p_tvar`: item number range
  - `p_flag`, `p_tlag`, etc.: group and flag parameters
  - This structure is used to pass parameters into the program and break them into named fields using overlays.

---

## 4. Local Data Area (LDA)

```rpg
d                uds
d l_wsid                901    910
d l_user                        10
d l_firm                944    946  0
d l_fnav                951    980
```

- Declares fields mapped over the IBM i Local Data Area.
- Commonly used to fetch user, workstation, and company information.

---

## 5. Key Variables and Working Fields

```rpg
d vvarl1_vare     s                   like(vvvare)
...etc...
d w_parm          s            128
d w_firm          s                   like(vvfirm)
d w_dato          s               d   datfmt(*iso)
d w_time          s               t   timfmt(*iso)
...etc...
```

- Declares variables for key fields needed for reading and joining files.
- Includes working fields for date/time, address, and control logic.

---

## 6. Indicators

```rpg
d b_feil          s              1    inz(*off)
d b_init          s              1    inz(*on)
```

- Simple toggles for control flow (error, initialization states).

---

## 7. Report Format Documentation

Comments block out the format names for reference. For example:
- `A1HDR`: Main report header
- `D1DET`: Detail line

---

## 8. Main Processing Loop

### a. Write First Heading

```rpg
c                   write     a1hdr                                30
```

- Outputs the initial report heading.

### b. Initialization

```rpg
c                   eval      w_lage = *loval
...
c                   read      lwa1l1                                 90
```
- Sets working keys to lowest value as a starting point.
- Reads the first record from the main movement file (`lwa1l1`).

### c. Main Loop

```rpg
c                   dow       *in90 = *off
```

#### Record Reading and Lookup

```rpg
c                   movel     mlvare        d1vare
c                   movel     mlvare        vvarl1_vare
c     vvarl1_key    chain     vvarl1                             91
c                   if        *in91 = *off
c                   eval      d1tek1 = vvtek1
c                   else
c                   eval      d1tek1 = 'Ukjent vare'
c                   endif
```
- Moves the product number from movement to the detail and key variables.
- Performs a keyed lookup (`chain`) in the item master (`vvarl1`).
- If found, retrieves descriptive text; if not, sets "Unknown item".

#### Field Assignments

```rpg
c                   eval      d1enhl = vvenhl
c                   eval      d1lage = mllage
...
c                   if        mltrda <> *loval
c     *dmy          move      mltrda        d1trda
c                   else
c                   move      *zeros        d1trda
c                   endif
...
c                   eval      d1beve = mlbeve
c                   eval      d1behl = mlbehl
c                   eval      d1kpri = mlkpri
c                   eval      d1kost = mlkost
c                   eval      d1spri = mlspri
c                   eval      d1omst = mlomst
```
- Assigns values for detail printing (unit, location, financials etc.)
- Handles possible blanks in movement date.

#### Print Detail

```rpg
c                   write     d1det                                30
c                   if        *in30 = *on
c                   exsr      overflow
c                   endif
```
- Prints the detail line.
- If overflow (new page), calls the overflow subroutine.

#### Next Record

```rpg
c                   read      lwa1l1                                 90
c                   enddo
```
- Reads the next movement record; repeats until EOF.

---

## 9. Program End

```rpg
c     end_pgm       tag
c                   eval      *inlr = *on
```
- Ends program processing and releases resources.

---

## 10. Subroutines

### a. Overflow Subroutine

```rpg
c     overflow      begsr
c                   write     a1hdr                                30
c                   endsr
```
- Writes a new page header when the printer page overflows.

### b. Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
...
c     vvarl1_key    klist
c                   kfld                    w_firm
c                   kfld                    vvarl1_vare
...
c     *entry        plist
c                   parm                    w_parm
c                   eval      p_prec = w_parm
c                   time                    w_dato
c                   time                    w_time
c                   eval      w_firm = l_firm
...
c                   endsr
```

- Sets up the key list for `vvarl1`.
- Receives the parameter string and overlays it onto the parameter data structure.
- Loads program info from the LDA (company, user, etc.)
- Sets up report heading fields.

---

## 11. Summary

- **Main Function:** Reads movement transactions, looks up item master information, formats and prints a detailed product movement report with periodic headers.
- **Input:** Parameters (passed as a 128-byte string), several database files.
- **Output:** Formatted report (printer output).
- **Structure:** Clear separation by section, with use of overlays for parameter handling, key lists for file access, and subroutines for repeated logic (such as heading printing).

---

**Tip for New Developers:**  
- Understand how overlays are used for parameters.
- Note the use of RPG indicators for EOF (`*in90`), overflow (`*in30`), and file not found (`*in91`).
- File lookups are central to this logic and often drive what is printed.
- The code makes extensive use of the Local Data Area (LDA) fields for session and user information.