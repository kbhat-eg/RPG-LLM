# RPG Program FW124R – Explanation

## Overview

This IBM ILE RPG (RPG IV) program, named `FW124R`, is part of the "ASOFAK" system. Its main purpose is to create new product items ("varer") and initiate their transfer ("overføring"). It interacts primarily with a workstation display file (`fw124d`) and calls another program (`FW620C`) to handle the actual transfer. The code contains initialization logic, parameter handling, screen interaction, and a controlled program end. 

The comments and variable names are in Norwegian, which is typical in Scandinavian RPG codebases. Below, each significant section is explained in detail.


---

## 1. File Specification

```rpg
ffw124d    cf   e             workstn
```
- **fw124d**: A display file used for interactive workstation I/O
- `cf`: File control, for input/output
- `e`: External file description
- `workstn`: Workstation device

---

## 2. Data Structures for Parameter List

```rpg
d                 ds
d d_list                       120
d  d_firm                        3  0 overlay(d_list)
d  d_ldor                        6  0 overlay(d_list:4)
6.30 d  d_lvaf                  20    overlay(d_list:10)
6.30 d  d_lvat                  20    overlay(d_list:30)
6.30 d  d_dato                    d   overlay(d_list:50) datfmt(*iso)
6.30 d  d_ipro                   5  2 overlay(d_list:60)
6.30 d  d_kpro                   5  2 overlay(d_list:65)
6.30 d  d_spro                   5  2 overlay(d_list:70)
6.30 d  d_ogrp                   2  0 overlay(d_list:75)
6.30 d  d_hgrp                   2  0 overlay(d_list:77)
6.30 d  d_ugrp                   3  0 overlay(d_list:79)
6.30 d  d_vtyp                   1    overlay(d_list:89)
6.30 d  d_kpri                   1    overlay(d_list:90)
6.30 d  d_varf                  15    overlay(d_list:91)
6.30 d  d_kvar                   1  0 overlay(d_list:106)
6.30 d  d_oppd                   1  0 overlay(d_list:107)
```
- `d_list`: Base 120-byte data structure for passing parameters.
- The other fields (`d_firm`, `d_ldor`, etc.) are overlays within `d_list`, mapping portions of this structure to named fields for easier reference, matching the parameter layout.
  - `overlay(d_list:xx)`: Field starts at byte `xx` in `d_list`.
- `datfmt(*iso)`: Date is stored in ISO format.
- This structure is prepared to be sent to another program.

---

## 3. Parameter Variables

```rpg
d p_firm          s              3  0
d p_ldor          s              6  0
6.30 d p_lvaf     s             20
6.30 d p_lvat     s             20
d p_dato          s               d   datfmt(*iso)
d p_ipro          s              5  2
d p_kpro          s              5  2
d p_spro          s              5  2
d p_ogrp          s              2  0
d p_hgrp          s              2  0
d p_ugrp          s              3  0
d p_vtyp          s              1
d p_kpri          s              1
d p_varf          s             15
d p_kvar          s              1  0
```
- These variables are the input parameters to the program, received via the program’s parameter list (`PLIST`).
- Types and lengths match their overlays in `d_list`.

---

## 4. Main Program Logic

### Tag: `b1taga`

```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- Tags mark locations in RPG flow control (`goto`/`tag` labels).
- `exfmt b1bld`: Displays the screen record `b1bld`, waits for user input.

### Handling Function Keys

```rpg
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
```
- `*INKC`, `*INKL`: Function key indicators (e.g., PF3 – Exit, PF12 – Cancel).
- If either is pressed, control jumps to `avslutt` (exit section).

### Collecting Update Option

```rpg
c                   eval      d_oppd = b1valg
```
- Assigns the value from the screen field `b1valg` to the outgoing parameter structure's update field (`d_oppd`).

### Calling the Transfer Program

```rpg
c                   call      'FW620C'
c                   parm                    d_list
```
- Calls program `FW620C`, passing `d_list` (the structure with all parameters).

---

## 5. Program Exit

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- `*INLR = *ON`: Last record indicator - marks the program as done, releases resources.
- `return`: Ends the program.

---

## 6. Initialization Subroutine (`*inzsr`)

### Handles parameter input and initialization.

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_ldor
...
c                   parm                    p_kvar
```
- Declares the entry parameters received from the calling program.

### Moves incoming parameters into outbound data structure

```rpg
c                   eval      d_firm = p_firm
c                   eval      d_ldor = p_ldor
c                   eval      d_lvaf = p_lvaf
c                   eval      d_lvat = p_lvat
...
c                   eval      d_kvar = p_kvar
```
- For each field, copies the parameter value into the corresponding field in `d_list`. This sets up the structure to be sent to `FW620C`.

### Initializes a screen field

```rpg
c                   eval      b1valg = 1
```
- Sets the default value for the screen option field (`b1valg`).

---

## 7. Additional Notes

- **Version Comments**: The changes at "6.30" (e.g., expanding fields from length 15 to 20) show the code's maintenance and version tracking.
- **No Business Logic**: The program’s logic is mostly about data passing, user interaction, and shelling out to the transfer program – not much processing is done locally.
- **Modularity**: All business logic for the actual transfer is expected to be handled by the called program `FW620C`.

---

## 8. Typical Flow

1. **Initialization**: Receives parameter fields and populates the outbound data structure.
2. **Screen Display**: Prompts the user with a display screen, waiting for input.
3. **Function Key Handling**: If the user chooses to exit (e.g., via PF3/PF12), the program ends cleanly.
4. **Update Option**: If not exiting, collects user's update choice.
5. **Calls Transfer Program**: Passes the data structure to `FW620C` for processing.
6. **Ends**: Control then exits.

---

## 9. Intended User

This program is typically run by a user tasked with setting up new item records for transfer, possibly in a warehouse/logistics environment. The screen interface (`fw124d`) collects relevant item parameters, then dispatches them to be handled by another process or system.

---

**Summary:**  
This RPG program is a simple UI and parameter-passing shell for item creation and transfer initiation, setting up data for another program, with clean resource handling and basic function key support. It’s an example of classic RPG modular design, where UI logic is separated from processing logic.