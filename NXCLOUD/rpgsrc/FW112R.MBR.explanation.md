# RPG Program FW112R – Supplier Item Maintenance (Lev.vare, vedlikehold)

This program is written in RPG/400 (ILE RPG) and is designed to maintain supplier item (leverandørvare) records within an IBM i (AS/400) system. Below is a thorough explanation of the program structure, variables, subroutines, and program logic to help onboard new developers.

---

## 1. **Header and Description**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **option(*nodebugio):** Suppresses debug I/O operations for better performance.
- **datedit(*dmy):** Default date format is day-month-year.

The program documentation provides a change log, program description, and special versions. This is typical for Scandinavian (likely Norwegian) installations.

---

## 2. **File Declarations (`F-specs`)**

```rpg
fflval1    if   e           k disk    rename(flvapfr:flval1r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fvvarl5    if   e           k disk    rename(vvarpfr:vvarl5r)
fflvalu    uf   e           k disk    rename(flvapfr:flvalur)
ffw112d    cf   e             workstn
```

- `flval1`/`flvalu`: Supplier item master files (input and update).
- `rlevl1`        : Supplier register file.
- `vvarl5`        : Item master file.
- `fw112d`        : Workstation (display file).
- `rename`: Logical/physical file names mapped to record format names.
- File types: `I` (Input), `U` (Update), `E` (Externally described), `K` (Keyed), `F` (Full procedural).
  
---

## 3. **Data Area and Variable Declarations (`D-specs`)**

### a. **Local Data Area (LDA)**
```rpg
d                uds
6.10 d l_user                911    920
     d l_fnav                951    980
```
- Accesses user information from the LDA.

### b. **Parameters**
```rpg
d p_firm          s                   like(fwfirm)
d p_ldor          s                   like(fwldor)
d p_line          s                   like(fwline)
d p_kvar          s              1  0
d p_stat          s              1  0
d p_valg          s              1  0
```
- Parameters received by the program: company, supplier, line, etc.

### c. **Variables Used in Keys**
```rpg
d vvarl5_lvar     s                   like(vvlvar)
```

### d. **Working Variables**
```rpg
d b_feil          s              1    inz(*off)  // Error flag
d w_mvap          s              6  2
d w_mvat          s              5  4
d w_mvaf          s             10  9
d w_udat          s               d   datfmt(*iso)
d w_lety          s              1  0
d w_inlr          s              1
d w_indi          s              2  0
d w_etxt          s             35
...
d w_firm          s                   like(fwfirm)
d w_ldor          s                   like(fwldor)
d w_line          s                   like(fwline)
d w_prgr          s              2    // Price group (was 1 char, now 2)
...
```
- Variables to hold prices, dates, working values, error flags, previous values for comparison, etc.

---

## 4. **Main Program Logic (`C-specs`)**

### a. **Entry Point: Retrieving an Item**

```rpg
c     flval1_key    chain     flval1                             90
c                   if        *in90 = *on
c                   goto      avslutt
c                   endif
```
- Tries to read the supplier item record. If not found, jumps to the end of the program.

### b. **Initialize the Screen**
```rpg
c                   exsr      init_bilde
```
- Loads all item information into the display fields for the initial screen.

### c. **Main Screen Loop**
```rpg
c     c2tagb        tag
c                   exfmt     c2bld
```
- Shows the screen, waits for user input.

#### **Handling Function Keys (Standard and Custom)**
```rpg
c                   select
c                   when      *inkc or *inkl  // F3 or F12 = Exit
c                   goto      avslutt
c                   when      *inkd           // F4 = Inquiry/Lookup
c                   exsr      spørring
c                   goto      c2tagb
c                   endsl
```
- Handles exit (F3, F12) and inquiry (F4).

#### **Custom Function Key (Show Status Codes)**
```rpg
c                   if        *inkm = *on     // F13
c                   call      'FW110R'
c                   goto      c2tagb
c                   endif
```

#### **Display-Only Mode**
```rpg
c                   if        p_valg = 5
c                   goto      avslutt
c                   endif
```
- If in display-only mode, exit after showing the screen.

#### **Input Validation**
```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   goto      c2tagb
c                   endif
```
- Validates the entered data; if errors, redisplay for correction.

#### **Reload Screen If Key Values Changed**
```rpg
c                   if        c2enhe <> w_enhe_gml or ...
c                   exsr      hent_kontr
c                   ... (update working variables)
c                   goto      c2tagb
c                   endif
```
- If unit, purchase or sales price have changed, reload pricing data.

#### **Update Register and End**
```rpg
c                   exsr      oppdater
...
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
---

## 5. **Subroutines**

### a. **`init_bilde` – Initialize Screen**
- Loads current item data into display variables.
- Fetches supplier name.
- Calls `hent_kontr` to fetch and calculate pricing/dg data.
- Stores "old" values to track changes.
- Sets input indicators for display-only mode.

### b. **`hent_kontr` – Fetch Control/Contract Info**
- Zeroes out calculation fields.
- Calculates contribution margin (dekningsgrad) as %.
- Calculates sales price including VAT.
- For items with a reference, fetches existing prices via program `VP701R`.
- Calculates % change in purchase and sales prices (if exists).

### c. **`spørring` – Inquiry/Lookup (F4)**
- If field is 'C2ENHE', calls program `VA510R` for unit lookup.

### d. **`sjekk_input` – Check Input Fields**
- Calls `FW113R` for validation:
  - Checks for errors; sets indicators `*in31...*in41` if different error codes returned.
  - Returns error (`b_feil = *on`) if found.
- Tests validity of dates (`c2dato`, `c2udat`).

### e. **`oppdater` – Write/Update Register**
- Loads display variables into file fields.
- Converts dates, if necessary.
- Only updates if the record was found.
- Updates audit information (date, time, user).
- Writes update to file.

### f. **`*inzsr` – Initialization Subroutine**
- Loads entry parameters to working variables.
- Gets today’s date.
- Retrieves VAT factors by calling `FØ705R`.
- Determines price group by calling `VL711R`.
- Builds key lists for file access.

---

## 6. **Key Lists**

Defined for efficient record access:
- `flval1_key`, `rlevl1_key`, `vvarl5_key`, `flvalu_key`.

---

## 7. **External Programs Called**

- `FW110R`: Show status codes.
- `FW113R`: Validate supplier item fields.
- `FØ705R`: Get VAT factors.
- `VP701R`: Fetch existing prices for item.
- `VL711R`: Get price groups.
- `VA510R`: Lookup units of measure.

---

## 8. **Display File (Workstation)**

- Controlled by `fw112d`: All user interactions and field displays/edits.

---

## 9. **Special Notes & Maintenance**

- Several routines updated with new fields (e.g., price group from 1 to 2 chars).
- Some code bears the mark of Scandinavian business logic (naming, documentation, VAT handling, etc.).
- Auditing fields updated on record change (date, time, user).

---

## 10. **Typical Program Flow (Summary)**
1. **Initialization:** Set keys, get current date/VAT/pricing info.
2. **Retrieve item:** If not found → exit.
3. **Display screen:** User input/edits.
4. **Function keys:** F3/F12 exit, F4 lookup, F13 show status, etc.
5. **Input validation:** Check all fields, if invalid highlight errors.
6. **Update:** If OK, write changes (with audit fields).
7. **Repeat/exit:** Based on user selection.

---

# **Key Takeaways for Onboarding**

- **File and data field names** reflect Norwegian business logic, e.g., **lev. = leverandør (supplier), vare = item**.
- **All data input and validation** is handled interactively via the display file.
- **All business rules** for editing, pricing, and VAT are centralized in this and the called programs.
- **Error handling** is thorough: input indicators trigger display errors for user correction.
- **Audit logic** is present for all updates.

---

## **If you are new to IBM i/RPG:**
- Familiarize yourself with **RPG/400 syntax** (especially F/D/C specs),
- Understand IBM i **display file programming**,
- Learn about **program calls and parameter passing**,
- Study **key lists** for database access.

---

**This program is a well-structured, interactive maintenance utility for supplier-item records, following Scandinavian business practices and system standards.**