# AA500R â€“ Valid Printers for PDF Output

## Overview

**Program:** AA500R  
**System:** ASPROA  
**Purpose:**  
This program provides a subfile-based interactive display of valid printers for PDF output. Users can browse, page through, and select from a list of printers. The interface supports typical subfile navigation (paging, roll up/down, positioning) and selection operations. The program is designed to be called with optional positioning parameters and returns the selected printer code and description.

## Key Data Structures and Files

- **afprlr**: Physical file containing printer definitions. Accessed via keyed operations.
- **aa500d**: Display file with subfiles (`b1sfl`), control (`b2ctl`), and command (`b2cmd`) records.
- **Subfile:** Used to present printer records page by page.
- **Parameters:** The program is called with two parameters: printer code and printer description.

## Indicators

- **LR**: End program
- **10, 11**: Roll up/down
- **12, 13, 14, 15**: Subfile display, control, clear, end
- **21, 22**: Home key, cursor positioning
- **30**: Field protection in view mode
- **31-79**: Message/warning indicators
- **80-99**: Work indicators

## Core Variables

- **w_stel, w_spge, w_srrn, w_sfrn, w_ssrn**: Subfile counters and page management
- **w_seqe**: Sequence/positioning mode (currently only 'printer' supported; 'B' for description is commented out)
- **b_valg_ok**: Selection flag

## Program Flow

### Initialization (`*inzsr`)

- Receives input parameters for initial positioning.
- Builds the key for the printer file using the supplied printer code.
- Initializes the display and subfile with the relevant records.

### Main Display Loop

1. **Display the command screen (`b2cmd`).**
2. **Fill and display the subfile (`dsp_subfile`).**
3. **Handle page navigation and function keys:**
   - Roll up (`*in10`): Next page (`crt_subfile`)
   - Roll down (`*in11`): Previous page (`bck_subfile`)
   - Home (`*in21`): Set cursor positioning indicator
   - Refresh (`*inke`): Refresh subfile (`forny`)
   - Cancel/Exit (`*inkc` or `*inkl`): Exit program
4. **Process subfile input:**
   - If a selection is made, set the output parameters and exit.
   - Otherwise, loop back to display.

### Subfile Management

- **forny**: Refreshes the subfile, optionally repositions based on the current record.
- **posisjoner**: (Partially commented out) Supports positioning by printer code (and, if enabled, by description).
- **subfile**: Handles selection logic, toggles cursor positioning, and processes user input in the subfile.
- **clr_subfile**: Clears subfile and resets counters.
- **crt_subfile**: Populates subfile with the next page of records.
- **bck_subfile**: Populates subfile with the previous page of records.
- **dsp_subfile**: Displays the subfile control record, and manages indicators for display.

### Data Relationships

- **afprlr**: Main data source for printers. Accessed using `setll`, `read`, `readp` for paging and positioning.
- **aa500d**: Display file with subfile and control records. The subfile (`b1sfl`) is loaded with printer records for display and selection.

### User Interaction

- **Selection**: User can select a printer from the subfile. The selected printer code and description are returned via parameters.
- **Paging**: Supports next/previous page navigation.
- **Positioning**: Supports positioning by printer code (description positioning is present but commented out).
- **Exit**: Program can be exited with function keys.

## Notable Design/Implementation Details

- **Subfile Paging**: Subfile page size is defined by constant `c_sfil` (8 records per page). Paging logic is handled by incrementing/decrementing counters and using keyed reads.
- **Commented-Out Features**: Code for positioning and paging by description (`w_seqe='B'`) is present but inactive. Only printer code-based navigation is enabled.
- **Indicators**: Standard IBM subfile indicators are used for display control and navigation.
- **Parameter Passing**: Uses parameter list for input/output, allowing the program to be called from other programs or menus.
- **Cursor Positioning**: Indicator 22 is used to control cursor placement on the display.
- **Localization/Language**: Comments and some variable names are in Norwegian (e.g., "Gyldige skrivere for PDF utskrift" = "Valid printers for PDF output").
- **Display File Structure**: Relies on a display file with at least three record formats: subfile, subfile control, and command screen.

## Interactions with Other Modules

- **No external APIs**: The program interacts only with its primary printer file (`afprlr`) and display file (`aa500d`). No external services or APIs are called.
- **Can be called by other programs**: Designed to be invoked as a modal selection list, returning selected values via parameters.

## Business/Domain Logic

- **Printer Selection for PDF Output**: The program is specifically tailored to allow users to select a valid printer for PDF output from a maintained list.
- **Positioning**: Users can jump to a specific printer code for quick access.
- **Paging**: Supports efficient navigation through potentially large printer lists.

## Summary Table of Main Subroutines

| Subroutine      | Purpose                                                          |
|-----------------|------------------------------------------------------------------|
| *inzsr          | Initialization, parameter handling, initial subfile fill         |
| forny           | Refresh subfile (optionally repositioned)                        |
| posisjoner      | Position to a specific printer code (description pos. is off)    |
| subfile         | Handle subfile input and selection logic                         |
| clr_subfile     | Clear subfile and reset counters                                 |
| crt_subfile     | Fill subfile with next page of records                           |
| bck_subfile     | Fill subfile with previous page of records                       |
| dsp_subfile     | Display subfile and control record                               |

## Conventions and Patterns

- **Subfile Navigation**: Standard IBM i subfile navigation model.
- **Indicator Usage**: Follows traditional indicator assignments for subfile control.
- **Parameter Passing**: Allows for flexible integration with calling programs.
- **Separation of Concerns**: Subroutines are used to encapsulate each logical operation (paging, clearing, filling, displaying).
- **Extensibility**: Commented code indicates potential for future enhancements (e.g., positioning by description).

---

### Onboarding Notes

- **Display File**: Ensure you review the layout of `aa500d` to understand the fields available in the subfile and control records.
- **afprlr File**: Understand the printer file's key structure and data fields (`afsprt`, `afsbes`, etc.).
- **Paging Logic**: Familiarize yourself with how subfile counters are managed for navigation.
- **Localization**: Some variable names and comments are in Norwegian; consult the business team for clarification if needed.

If you need to extend this program (e.g., enable description-based positioning), uncomment and adapt the relevant sections. For integration, ensure calling programs pass and receive the printer parameters as designed.