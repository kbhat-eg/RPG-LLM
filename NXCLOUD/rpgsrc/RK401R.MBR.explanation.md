# Explanation of RPG Program: "Sletting av kunder" (Customer Deletion)

This RPG program is designed for the IBM i (AS/400) platform. Its purpose is to delete customer records from a customer register (kunderegister) based on specific business rules. The code is written in ILE RPG (RPG IV / RPGLE) using fixed-format specifications, and includes file and data area manipulation, business logic, and report generation.

Below is a structured explanation for onboarding developers:

---

## 1. Program Header and Metadata

The header (`/TITLE`, comments, and change log) documents the program name, purpose, related files, changes, and conventions for indicator usage.

- **Program Name:** RK401R
- **Purpose:** Deletion of customer records
- **Special Notes:** Tracks changes, explains indicator allocation, and describes key business rules.

---

## 2. File Declarations

The program opens several files, both input and update, with some fields and records being renamed for clarity:

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r) // Customer register (main)
frkunlu    uf   e           k disk    rename(rkunpfr:rkunlur) // Customer register (update)
frksolu    uf   e           k disk    rename(rksopfr:rksolur) // Customer search term (update)
frktrl1    if   e           k disk    rename(rktrpfr:rktrl1r) // Customer transactions
frk401p    o    e             printer oflind(*in30)           // Report printer
```

Additional files are conditionally included (with version tagging, e.g., `6.20`, `5.60`) for memo balance management.

---

## 3. Data Definitions

Fields and data structures are declared to manage program variables, keys, and workspace data:

- **Key fields:** For chaining and updating records in various files
- **Local data area fields:** For runtime/user information (workstation ID, user, firm number, etc.)
- **Date fields:** For business logic comparisons (deletion date limits, entry date, etc.)
- **Counters:** For statistics (number of customers processed/deleted)
- **Working variables:** For type flags, status indicators, and deletion markers

---

## 4. Main Processing Loop

The main logic iterates over each customer record:

```rpg
c     rkunl1_key    setll     rkunl1             // Position to first customer
c     rkunl1_key    reade     rkunl1    90       // Read first customer
c                   dow       *in90 = *off       // Loop while not end-of-file
    c                   exsr      kontroll       // Call subroutine to check deletion conditions
    c                   if        w_slett = ' '  // If marked OK for deletion
        c                   exsr      utskrift   // Print to report
        c                   if        w_type  = 'N'
            c     (chain/delete logic on supporting files)
        c                   endif
    c                   endif
    c     rkunl1_key    reade     rkunl1    90   // Read next customer
c                   enddo
```

### High-Level Flow:

1. **Position to start of customer file**
2. **For each customer:**
   - Call `kontroll` to determine eligibility for deletion.
   - If eligible, print to report and perform deletion in all related files (`rkunlu`, `rksolu`, `rkmelu`).
3. **Repeat until all records processed.**

---

## 5. Deletion Criteria: The `kontroll` Subroutine

The main business rules for deletion are implemented here:

- **Transaction Date:** Do not delete if the customer had a transaction after a certain cutoff date (`w_edat`).
- **Entry Date:** Do not delete if the customer was created after a certain date (`w_ndat`).
- **Balance:** Do not delete if the customer has an account balance (`rksald <> 0`).
- **Memo Balance:** Do not delete if the customer has a memo balance (`rkmems` or `rkmema` <> 0).
- **Transactions Exist:** Do not delete if the customer has transactions in the transaction file.
- **Orders Exist:** Do not delete if there are existing orders for the customer.

If any of the above checks fail, `w_slett` is set to `'X'` (not OK to delete). If all checks pass, `w_slett` remains blank (OK to delete).

---

## 6. Report Generation: The `utskrift` Subroutine

If a customer is eligible for deletion, the following occurs:

- **Increment deletion counter (`w_anta`)**
- **Print details to report**
- **Handle overflow conditions by printing headers if necessary (`*in30`)**

---

## 7. Initialization: The `*INZSR` Subroutine

Upon program start:

- **Parameter passing:** Input parameters include type of run and cutoff dates.
- **Key lists:** Prepare compound keys for various file operations.
- **Set working `w_firm` from local data area**
- **Write report heading**

---

## 8. End of Program

After processing all records:

- **Set LR (`*INLR`) to end the program**
- **Write final summary to report**
- **Call exit/cleanup routines as needed**

---

## 9. Indicator Usage

Indicators control flow, status, and special runtime conditions, as documented in the program header:

- **F1, F3:** User function keys
- **LR:** Last record
- **30, 31-59, 60-69, etc.:** Various business logic and file operation flags

---

## 10. Versioned Enhancements

Throughout the code, modifications are tagged with version codes (e.g., `T5.00`, `6.20`). These typically add fields, checks, or file operations, such as handling memo balances or refining date logic.

---

## 11. External Calls

The program calls another program (`RK792C`) for order existence checks and file/resource management.

---

# Summary

**In essence: This RPG program automates the safe cleanup of a customer register by deleting only those customers who meet a strict set of business rules (no recent transactions, balances, or orders), keeps an audit/report of deleted entries, and handles associated records in related files.** The program is modular, with subroutines for business rules and reporting, and supports flexible file/key management.

---

## Key Business Logic: Eligibility for Deletion

A customer can be deleted if all the following are true:
- No transactions after the cutoff date
- Entered before a certain date
- Zero balance and zero memo balances
- No records in related transaction and order files

---

## For Onboarding

- **Familiarize yourself with the customer file layouts and related files.**
- **Review indicator usage for program control.**
- **Understand the subroutines for deletion logic and reporting.**
- **Take note of version tags, as newer requirements may have altered original logic.**
- **Parameterization allows for flexibility in how and when customers are deleted.**

---

This overview should help you quickly understand the structure, intent, and key flow of the "Sletting av kunder" program.