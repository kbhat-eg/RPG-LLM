# RPG Program FP720R – Explanation and Developer Onboarding Notes

---

## Overview

This RPG (ILE RPG, "original" style with fixed format C specs) program named **FP720R** is designed for the IBM i (AS/400) system. Its main purpose is to **generate special prices ("spesialpriser") based on quotes** for customers, projects, or discount categories.

The code is highly modular and feature-rich, with developments and corrections spanning many years, as indicated by the history in the comments.

---

## 1. **High-Level Functionality**

- **User Interface**: The program interacts with the user through a workstation (display file `FP720D`).
- **Business Purpose**: It copies quote/order lines (`fodtl1`) to a special pricing file (`fprilu`), updating or creating records according to user selections.
- **Selection**: The user can specify customer, project, or discount category for which the special prices are to be generated.
- **Date Control**: The program enforces proper "from"/"to" date logic when creating or updating special prices.
- **Unit Handling**: Supports updating special prices for one or multiple sales units for a product.

---

## 2. **File Declarations**

Files (`F` specs) are declared for reading, updating, and writing:

- **fprilu**, **fpril1**: Special price files (for update, inquiry)
- **fodtl1**: Order line file (lines from the quote/order used as the basis)
- **fohel1**: Order header
- **rkunl1**, **fkprl1**: Customer and customer project master files
- **ra06pf**: Discount category table
- **vvenl2**: Product sales unit table
- **jvarl1**, **jvpkl1**: Additional product/packaging tables for unit fallback
- **fohelu**, **vinfl1**: Order info (type) files
- **FP720D**: Workstation/display file
- [All with descriptive RENAMEs for member/record formats]

---

## 3. **Data Structures and Variables**

- **Indicator Usage**: Indicators (LR, 10-99) are well-documented in comments. They handle display logic, file operations, and error states.
- **Work Variables**: For keys, field movement, and temporary storage during processing (e.g., `w_kund`, `w_kpro`, `w_prgr`, `w_rkat`, etc.).
- **Arrays**: `a_meld` is used for confirmation messages.

---

## 4. **Key Subroutines and Logic Blocks**

### **Initialization**

- **Subroutine `*INZSR`**: (Program startup)
  - Sets up keylists for file access.
  - Initializes runtime variables (date, firm, parameter input).
  - Calls an external program (`CO402R`) to fetch/validate information type, if relevant.

### **Main Loop/Entry**

- Display the main window (`write a1win`, `exfmt a1win`).
- **Function key handling**:
  - *F3/Cancel*: Exit program.
  - *F4/Søk*: Inquiry subroutine (`spørring`).
  - *F8*: Triggers update/special price subroutine (`spesial`).

### **Input Validation (`sjekk_input`)**

- Ensures that only valid combinations of customer/project/discount category are selected.
- Validates existence of customer, project, or discount category in relevant files.
- Checks that period ("from"-"to" date) is valid and populated as required.
- Fills in names/descriptions for selected entities for display.

### **Create/Update Special Prices (`oppdater`)**

- Core "business logic":
  - For every order line, builds a key and either updates an existing special price or inserts a new one.
  - Handles "from"/"to" dates, discounted prices, cost price locking, and special business rules (e.g., only transfer discounts if chosen).
  - If the user requests, handles **all sales units** (not just the main one), with logic to get alternate units from product master files.

### **Confirm Overwrite of Existing Special Price**

- If target special prices already exist for the customer/project/category, the user is asked whether to update them or not (with a confirmation display/call).

### **Subroutines (`begsr`/`endsr` pairs)**

- **`initier`**: Initializes screen fields, fetches customer/project names for display.
- **`spørring`**: Handles lookup/inquiry for customer, project, or discount category via external programs.
- **`spesial`**: Calls another program (`FP100R`) for additional special price work.
- **`sjekk_input`**: Validates all input fields and conditions.
- **`oppdater`**: Does the line-by-line update of the special prices.
- **`sjekk_pkdato`**: Helper for checking if a package date is within the valid "from"/"to" window.

---

## 5. **Notable Details and Features**

- **Backward Compatibility, Feature Growth**: Code is highly versioned (sections marked with e.g. `6.33`, `7.01`) and comments document functionality changes.
- **Date Handling**: Uses ISO and DMY date formats, with RPG's `move`, `test(d)`, and `time` for conversions and validations.
- **External Program Calls**: Several points in the code use `call` to invoke other RPG programs for validation, maintenance, or confirmation dialogs.
- **Advanced Key Usage**: Uses `klist`/`kfld` for efficient keyed access for chain, setll, reade ops on files.
- **Unit (UOM) Handling**: If a product has multiple selling units, the program recalculates and updates prices/rates for all relevant units, including fallback logic if primary unit lookup fails.

---

## 6. **Error and Confirmation Handling**

- Error conditions (e.g., not founds, invalid combos, missing period data) are signaled via indicators (`*in31`, `*in32`, etc.) and corresponding display messages.
- Confirmation dialogs protect against overwriting existing special prices.

---

## 7. **Integration Touchpoints**

- **Customer/Project Lookup**: via `RK500R` and `FL501R`
- **Discount Category Lookup**: via `RA506R`
- **Special Price Maintenance**: via `FP100R`
- **Firm/warehouse parameter fetch**: via `CO402R`

---

## 8. **Typical Workflow**

1. **Entry:** User starts the program, selects order/quote.
2. **Screen:** Main screen is displayed; user can specify customer, project, or discount category, plus period and options (lock cost price, only discounts, all units).
3. **Validation:** Input is checked for validity.
4. **Confirmation:** If special prices already exist, user confirms update.
5. **Processing:** For each relevant order line, the program generates/updates special price records for the indicated entities and units.
6. **Completion:** Success message displayed; user may repeat or exit.

---

## 9. **Onboarding Tips**

- **Understand File Structures:** You should be familiar with the logical files (and physical) such as `fprilu`, `fodtl1`, `fohel1`, etc. Review DDS for these files if possible.
- **Testing:** Because this program updates key pricing records, always test with a non-production database first.
- **Indicators:** Classic RPG style relies heavily on indicators for control and error signaling.
- **Enhancements:** Before making changes, check for existing version tags (e.g., `6.33`, `7.01`) to avoid regressions for previous customizations.
- **Multi-Unit Logic:** Study the logic for updating all sales units carefully (including fallback from `vvenpf` to `jvarl1/jvpkl1`).

---

## 10. **References and Maintenance**

- Use the version history in the comments to track previous changes and potential reasons behind logic.
- Consult the external programs’ documentation for the called programs (`FP100R`, `RK500R`, `FL501R`, `RA506R`, etc.) as their contracts (parameters, file updates) are important.

---

### **Typical Call Stack and Data Flow**

1. Start → *INZSR (initialize keys, fetch firm/date) → Main Screen → Input/Validation → (Optionally Calls Inquiry) → Confirm Overwrite if Needed → For Each Order Line: `oppdater` → Subfile(s) updated → Completion/Exit.

---

### **Key Takeaway**

This RPG program is a robust, enhanced tool for managing quote-to-special-price logic, integrated deep in the customer/project/product pricing and sales infrastructure, with advanced handling for dates, units, and business rules. Its maintenance requires understanding both legacy RPG code and the business processes around special pricing.