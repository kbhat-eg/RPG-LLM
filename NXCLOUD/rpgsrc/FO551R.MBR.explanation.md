# Explanation of RPG Source Code "FO551R" (Find Order by Invoice Number)

## Overview

This program, named **FO551R**, is an Interactive ILE RPG (RPG IV) application that facilitates the lookup of orders via an invoice number, using subfiles for display and selection. It is meant to run on IBM i (AS/400) systems, using physical file `SOHEL2` (aliased as `sohel2r`) as the main data source, and displays information via display file `FO551D`, which contains subfile records.

### Main Features

- **Parameter-driven:** Started with parameters for company (`firm`), invoice number (`fakt`), and order number (`numm`).
- **Interactive subfile:** Shows a list of matching orders in a subfile, where the user may scroll, select, and work with the results.
- **Function key handling:** Supports paging, selection, refresh, cursor positioning, and more.

---

## File & Display Definitions

```rpg
fsohel2    if   e           k disk    rename(sohepfr:sohel2r)
```
- Input file `SOHEL2`, externally described, renamed as `sohel2r`.

```rpg
ffo551d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- Display file `FO551D` with subfile `b1sfl` controlled by subfile relative record number `w_srrn`.

---

## Key Data Structures

### Parameters

```rpg
d p_firm          s                   like(sofirm)
6.nu d p_fakt     s                   like(sobinr)
6.nu d p_numm     s                   like(sonumm)
```
- Parameters to receive company, invoice number, and order number.

### Subfile Control and Paging

- `w_stel`: Subfile counter
- `w_spge`: Page size (number of records per page)
- `w_srrn`: Subfile Relative Record Number (last record loaded)
- `w_sfrn`: First record number displayed on the page
- `w_ssrn`: Last record number displayed on the page

### General Variables

```rpg
d b_eof           s              1    inz(*off)
d b_valg_ok       s              1    inz(*off)
```
- Flags for end-of-file and valid selection.

---

## Program Flow

### Initialization (`*inzsr`)

1. **Receive input parameters** (`p_firm`, `p_fakt`, `p_numm`).
2. **Set up subfile key** and initialize main variables.
3. **Position the file** (`setll`) and create the first subfile page (`crt_subfile`).

### Main Loop

- Two primary tags control the workflow: **b2taga** (display menu) and **b2tagb** (process data/display subfile).
- **Display/refresh subfile** as needed.
- **Handle function keys:** (Roll up/down, refresh, cursor, selection).
- **Process selections:** Accept user choices from the subfile (e.g., which order to pick).
- **Exit** upon valid selection or program termination.

---

## Subroutines

### **forny**: Refresh the Subfile
- Reposition the cursor in the subfile if possible.
- Reset the file position and re-create the subfile from scratch.

### **subfile**: Process User Interaction in Subfile
- Loops through the subfile records for user selections.
- Checks if a row is selected, sets output parameters, flags selection and exits the loop.

### **clr_subfile**: Clear Subfile
- Triggers subfile clear indicators and resets all counters.

### **crt_subfile**: Create/Load Subfile
- Reads records from the main file and loads them into the subfile up to the page size.
- Populates each subfile record with the order data.
- Updates subfile control fields for paging.

### **dsp_subfile**: Display Subfile
- Issues the subfile control record for display.
- Handles indicators for display formatting.

---

## Function Key Handling

The program uses a series of indicators (e.g., `*in10`, `*in11`, `*in12`, etc.) to process function keys. These include:

- **10**: Roll (page up)
- **11**: Rolldown (page down)
- **21**: Home-key
- **22**: Cursor positioning

---

## Comments and Documentation in the Code

- The code is heavily commented (in Norwegian), providing indicator usage, variable explanations, subfile management notes, and change log info.
- There are explanations for each utility variable and subfile concept, aiding maintainability and onboarding.

---

## Summary Table: Key Concepts

| **Concept**      | **Purpose/Usage**                                                           |
|------------------|-----------------------------------------------------------------------------|
| File: SOHEL2     | Physical file with order/invoice records                                    |
| Display: FO551D  | Display file with subfile for order listing                                 |
| Subfile          | Shows list of orders, supports selection/paging                             |
| Parameters       | Company, Invoice Number, Order Number—drives lookup and selection           |
| Indicators (xx)  | Function keys and UI control (see code comments for mapping)                |
| Main Routines    | Initialization, Subfile Load, Clear, Display, Refresh, Selection Handling   |

---

## Typical Use

1. **Start the program** with firm/invoice/order parameters.
2. **View orders** matching the search in a subfile list.
3. **Page through records** and make a selection.
4. **Upon selection,** the chosen order number is placed back in the parameter for use by the caller.

---

## Onboarding Tips

- **Learn basic subfile processing** in RPG IV, as this is a textbook subfile-driven selection program.
- **Understand indicator usage** in old RPG code; much of the logic is controlled through them.
- **Review the display file FO551D** and physical file SOHEL2 layouts—they define what data you’re interacting with and how it appears to the user.
- **Practice debugging interactively:** The program suppresses debug I/O (`option(*nodebugio)`), so debugging must be planned accordingly.
- **Read the Norwegian comments:** They provide direct context for variable usage and business logic.

---

## Further Reading

- IBM Knowledge Center: [ILE RPG Subfile Programming](https://www.ibm.com/docs/en/i)
- Midrange.com archives for similar sample programs.
- Existing application documentation for local conventions and field meanings.

---

If you need further breakdown of any specific section or logic, just ask!