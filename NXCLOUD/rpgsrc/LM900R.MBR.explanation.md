# RPG Source Code Explanation

---

## Program Description

- **Program Name:** LM900R
- **System:** ASOFAK
- **Description:** Update of log file for order process flow ("Oppdatering av loggfil for ordreforløp").
- **History:**
  - Initial program: 2007-03-09
  - 2014-05-28: Change due to number expansion.
  - 2018-12-10: Lookup before writing.

---

## High-Level Functionality

This program receives transaction data, ensures date/time values are set, and writes a new log entry, but only if a matching log entry does not already exist in the log file. It uses data from the Local Data Area (LDA), and is designed to avoid duplicate log entries for a given key.

---

## Source File Section

```rpg
3.32 flloglu    uf a e           k disk    rename(llogpfr:lloglur)
```
- **flloglu:** This is the log file being accessed.
- **uf a e k disk:** Update, full procedural (not externally described), allow Add/Update, keyed access on disk.
- **rename:** File's record format is renamed for internal use (**llogpfr** to **lloglur**).

---

## Data Definitions

### Parameters

```rpg
d p_urec          s             80
d p_stat          s              1
```
- **p_urec:** Incoming 80-byte parameter, probably the log record to add.
- **p_stat:** 1-byte parameter, used as a status flag.

### Local Data Area (LDA) Fields

```rpg
d                uds
d l_wsid                901    910
d l_user                911    920
d l_firm                944    946  0
```
- Defines overlays on the LDA:
  - **l_wsid:** Workstation ID (10 chars)
  - **l_user:** User ID (10 chars)
  - **l_firm:** Company/Firm (3-digit numeric)

### Work Record Data Structure

```rpg
d                 ds
d d_urec                        80
d  d_firm                        3  0 overlay(d_urec)
d  d_numm                        8  0 overlay(d_urec:4)
d  d_suff                        2  0 overlay(d_urec:12)
d  d_kode                        1    overlay(d_urec:14)
d  d_date                         d   overlay(d_urec:15) datfmt(*iso)
d  d_time                         t   overlay(d_urec:25) timfmt(*iso)
d  d_user                       10    overlay(d_urec:33)
d  d_wsid                       10    overlay(d_urec:43)
```
- **d_urec:** Complete record buffer.
- **d_firm**–**d_wsid:** Each field overlays a portion of **d_urec** for individual data access.

### Variables for Key Fields

```rpg
d lloglu_numm     s                   like(lmnumm)
d lloglu_suff     s                   like(lmsuff)
d lloglu_kode     s                   like(lmkode)
d lloglu_date     s                   like(lmdate)
d lloglu_time     s                   like(lmtime)
```
- Used to build the composite key for accessing the log file.

### Other Variables

```rpg
d w_firm          s                   like(lmfirm)
```
- Holds the firm number extracted from the LDA.

---

## Main Logic

### Parameter Preparation and Initialization

```rpg
c                   eval      d_urec = p_urec
c                   eval      p_stat = *on
```
- Copies the input parameter to the working record.
- Sets the status flag to "on" (probably success).

### Extract Firm from LDA

```rpg
c                   eval      w_firm = l_firm
```
- Loads firm number from the LDA.

### Date/Time Handling

```rpg
c                   if        d_date = *loval
c                   time                    d_date
c                   endif
c                   if        d_time = *loval
c                   time                    d_time
c                   endif
```
- If date or time is *loval (lowest value, i.e., unset), set to system date/time.

### Write Log Entry (if not already present)

```rpg
c                   exsr      oppr_logg
c                   goto      avslutt
```
- Calls the subroutine to write the log entry, then goes to program end.

---

## Subroutines

### oppr_logg (Create Log Transaction)

```rpg
c     oppr_logg     begsr
...
c                   eval      lloglu_numm = d_numm
c                   eval      lloglu_suff = d_suff
c                   eval      lloglu_kode = d_kode
c                   eval      lloglu_date = d_date
c                   eval      lloglu_time = d_time
c     lloglu_key    chain     lloglu
c                   if        not %found
   ...
c                   write     lloglur
c                   endif
c                   endsr
```
- Sets up key variables from the input record.
- Uses **CHAIN** to check if a record with this key already exists in the log file.
- If not found, populates log record fields and writes a new log entry.

### *inzsr (Initialization Subroutine)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_stat
c                   parm                    p_urec
...
c     lloglu_key    klist
c                   kfld                    w_firm
c                   kfld                    lloglu_numm
c                   kfld                    lloglu_suff
c                   kfld                    lloglu_kode
c                   kfld                    lloglu_date
c                   kfld                    lloglu_time
c                   eval      w_firm = l_firm
c                   endsr
```
- Handles procedure entry and parameter linking.
- Defines the key list used to access the log file.
- Sets **w_firm** from the LDA.

---

## Program Exit

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks end of program: releases resources and returns.

---

## Key Points & Flow Summary

1. **Receives a record and status as parameters.**
2. **Extracts firm, user, and workstation info from LDA.**
3. **If date/time not set in record, fills with system values.**
4. **Checks if a log record with the same key exists.**
   - If not, writes the new entry.
5. **Program ends, setting on the LR indicator.**

---

## Use Cases

- Logging order flow events.
- Ensuring no duplicate logs are created for the same key (firm, order number, suffix, code, date, time).
- Populating missing date/time information automatically.

---

## Maintenance Notes

- **Date/time fields:** Uses system date/time if not supplied, ensuring all records are timestamped.
- **Key fields:** Must be kept in sync with the log file definition.
- **LDA usage:** Relies on external job data (user, workstation, firm).
- **No duplicates:** Uses CHAIN to prevent duplicate log entries.

---

This program demonstrates common ILE RPG idioms for file handling, parameter passing, LDA usage, and duplicate checking in transactional logging contexts.