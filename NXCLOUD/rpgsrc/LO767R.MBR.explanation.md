# RPG Program LO767R - Generating Order Confirmation in EDIFACT Format

---

## Overview

This RPG program (`LO767R`) is designed for IBM i (AS/400) to generate an order confirmation in EDIFACT EDI format **without an electronically received order**. The code is heavily documented with both business and technical comments, and is in a traditional fixed-format ILE RPG style with C-specs and D-specs.

- **Purpose:** Generate EDIFACT order confirmations (ORDRSP) for orders **not received electronically**.
- **Key Output:** Writes records to two files (`lwedpfr`, `lwelpfr`) in an EDIFACT-like layout.
- **Context:** Used in a Norwegian business setting (Norwegian comments and variable names), handling customers, suppliers, order headers, lines, etc.

---

## File Declarations

```rpg
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
fraa8l1    if   e           k disk    rename(raa8pfr:raa8l1r)
... many others ...
flwedpf    o    e           k disk
flwelpf    o    e           k disk
```
- Multiple input files (with `if`, input full procedural) are declared, each representing master data for customers, orders, products, etc.
- Output files (`flwedpf`, `flwelpf`) receive the generated EDI segments.

---

## Data Structures

### EDI Segment Structures

```rpg
d                 ds
d d_ed00                        80
d  d_id00                        4    overlay(d_ed00)     inz('ED00')
d  d_decs00                      1    overlay(d_ed00:5)   inz(',')
d  d_send00                     13  0 overlay(d_ed00:6)
8.01 d  d_pref00                  4    overlay(d_ed00:19)
8.01 d  d_mott00                 13    overlay(d_ed00:19)
...
```
- Multiple 80-character data structures (`d_ed00`, `d_ed01`, ... `d_ed21`), each modeling a line (segment) in the EDI output.
- Each field overlays a part of the corresponding 80-char buffer, imitating a fixed-format output record.
- Most segments come pre-initialized with identifiers and qualifiers as per the EDIFACT specification.

### Working Variables

- Numerous variables for temporary storage of keys, working values, dates, numbers, customer references, etc.

---

## Code Structure

### 1. Program Initialization (`*inzsr` subroutine)

- Receives order number/suffix as parameters.
- Builds key lists for all required files.
- Fetches company and warehouse data.
- Initializes date/time variables for use in EDI segments.
- Prepares logging variables (`logind`, `logtyp`).

---

### 2. Main Processing Logic

#### a. Header Data Retrieval

- Fetches static company data (`raa8l1`).
- Fetches the order header (`fohel1r`).
- Fetches customer information (`rkunl1`).
- Fetches seller info (for email, via `ra09lr`).

#### b. EDI Segment Generation (Header Level)

- **ED00/ED01/ED02/ED03:** Output core EDI control, document metadata, and header-level free text.
  - `ED00`: Message envelope info (sender, receiver, date/time).
  - `ED01`: Message metadata (reference numbers, flags, deviations).
  - `ED02`: Date segments.
  - `ED03`: Free-text at header level (order notes).
- **ED04:** Produces references (customer order, requisition number, external project number) as needed.
- **ED05-ED07:** Party identification segments.
  - For "seller" (`SU`), "buyer" (`BY`), "invoicee" (`IV`), and possibly a delivery party (`DP`) if address deviates.
- **ED08:** Output transport and delivery terms.

#### c. Order Line/Detail Segments

- Loops through all detail records (`fodtlrr`).
- For each line:
  - **Subroutine `sjekk_type`:** Determines if line is a text or a normal product line, and if it should be output.
  - **Free Text Lines (ED15):** If the line is a free-text/comment line, outputs as ED15.
  - **Product Lines:**
    - **ED10:** Product number identification, uses `finn_varenr` to fill EAN/NOBB numbers.
    - **ED11:** Product description.
    - **ED12:** Quantity/unit (delivered).
    - **ED13:** Delivery dates.
    - **ED14:** Nett line amounts.
    - **ED16 (Price):** Price and unit.
    - **ED17:** Buyer reference.
    - **ED18:** Tax/fee info.
    - **ED19/ED20:** Discounts (up to two per line).

#### d. Totals (ED21)

- Calls external program (`FO702R`) to calculate order totals (gross, discount, VAT, net).
- Outputs totals using the `ED21` segment.

---

### 3. Subroutines

#### `finn_varenr` - Find Product Numbers

- Gets EAN/GTIN and NOBB numbers for product lines.
- Calls an external program (`VE713R`) if EAN is not present.

#### `sjekk_type` - Check Line Type

- Examines the line type from the product line (via `vltyl1`).
- Sets flags to determine if the line should be output and if it's a free-text line.

---

## Key Business Rules & Customizations

- **Norwegian Market Customization:** Address, party, VAT, and GLN/OrgNr logic is tailored for Norwegian business flows.
- **GLN vs OrgNr Handling:** If the receiver number is not a GLN (14 digits), `EEEE` is prepended to indicate OrgNr.
- **Non-electronic Orders:** Sets deviation flags in EDI (e.g., `d_aksp01 = '4  '`) since order was not received electronically.
- **External project number, requisition, etc.:** Several enhancements (`8.01`, `8.02` ...) add project and reference handling.
- **Discounts, Prices, Quantities:** All required commercial info is mapped to corresponding EDI segments.
- **Logging:** Each EDI segment is written to two outputsâ€”a working and a log file.

---

## Error Handling

- Basic: If required records are missing on `chain` (DB read), program jumps to `end_pgm` label and exits.

---

## Indicators

- Traditional RPG indicators, especially for controlling output, loop flow, and program exit (`LR`).

---

## Summary Table of Main EDI Segments

| Segment | Purpose                                                  |
|---------|----------------------------------------------------------|
| ED00    | Message control envelope (sender, receiver, date)        |
| ED01    | Message metadata and references                          |
| ED02    | Dates                                                    |
| ED03    | Free text (header)                                       |
| ED04    | References (requisition, customer order, external proj.) |
| ED05    | Party identification (seller/buyer/invoice/delivery)     |
| ED06    | Party address 1                                          |
| ED07    | Party address 2                                          |
| ED08    | Transport and delivery terms                             |
| ED10    | Product identification (EAN/GTIN/NOBB)                   |
| ED11    | Product description                                      |
| ED12    | Quantities/unit                                          |
| ED13    | Delivery dates                                           |
| ED14    | Line amounts (net)                                       |
| ED15    | Free text (line)                                         |
| ED16    | Price/unit                                               |
| ED17    | Buyer reference                                          |
| ED18    | Taxes                                                    |
| ED19/20 | Discounts                                                |
| ED21    | Order totals (gross, vat, net, etc.)                     |

---

## Typical Data Flow

1. **Receive order keys and initialize.**
2. **Fetch all master data (company, customer, order).**
3. **Output all header-related EDI segments.**
4. **For each line:**
   - Determine type (text/product).
   - Output segments per line type.
5. **Output order summary/total segments.**
6. **End program.**

---

## Onboarding Tips

- **File Naming:** Most files and fields use Norwegian abbreviations (e.g., `fohel1` for order header, `fodtl1`/`fodtlr` for order lines).
- **Segment Naming:** `EDnn` notation is local to this system but follows EDIFACT logic.
- **Customization:** Many blocks are marked with change numbers (e.g., `8.01`, `8.02`) for version tracking.
- **External Programs:** Calculation and lookup routines are partly handled by external programs. Ensure these are available/tested when onboarding or migrating.

---

## Conclusion

This program acts as a robust EDI generator for Norwegian B2B flows, mapping a traditional order and its details into the corresponding EDI segments for transmission. The approach is strongly business-driven, with rich mapping logic, structured error handling, and thorough integration with master data.