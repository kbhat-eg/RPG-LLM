# JV161R – Selection of Price-Setting Supplier for Special-Order Items

## Purpose and Business Context

This program (`JV161R`) is part of the ASOFAK system and is responsible for managing the selection and maintenance of prioritized suppliers for "skaffevarer" (special-order items). The program provides a green-screen, subfile-based interface for users to view, add, update, copy, and delete supplier prioritization records, as well as to filter and search these records using various product and supplier attributes.

The business logic centers around associating up to three prioritized suppliers with combinations of product groupings (warehouse, overgroup, main group, subgroup, module, item number). This is a key function for procurement and pricing in the system, ensuring that the correct supplier is referenced for special-order procurement scenarios.

## High-Level Structure

- **Physical and Logical Files**: The program uses several files for reading and updating supplier, product, and group information. Many are renamed upon declaration for clarity.
- **Subfiles**: The main user interface is a subfile (B1SFL) that lists prioritized supplier records. Associated control and command records manage navigation and data entry.
- **Screen Images**: Multiple display formats (e.g., B1SFL, B2CTL, C1BLD, C2BLD, D1WIN, K1WIN) are used for subfile display, detail entry, confirmation dialogs, etc.
- **Navigation and Function Keys**: A comprehensive set of function keys is supported for paging, filtering, CRUD operations, and invoking lookup dialogs.
- **Subroutines**: The program is organized around subroutines for each major function (display, filter, CRUD, lookup, validation, etc.).
- **Data Area**: The local data area (LDA) is used to retrieve user and company context.

## Key Domain Concepts

- **Prioritized Supplier Matrix**: Each record links a combination of product grouping fields to up to three prioritized suppliers.
- **Product Group Hierarchy**: Warehouses, overgroups, main groups, subgroups, modules, and item numbers are used to define the granularity of the prioritization.
- **Supplier Master**: Supplier details are validated and retrieved from the supplier master file.
- **Filtering and Positioning**: Users can filter the subfile list by groupings and suppliers, or position directly to a specific record.

## File Relationships

| File      | Purpose / Key Data                        | Relationships                                  |
|-----------|-------------------------------------------|------------------------------------------------|
| VPRLL1    | Main supplier prioritization records      | CRUD operations, subfile population            |
| VPRLLR    | Read access to prioritization records     | Used for subfile paging/navigation             |
| VPRLLU    | Update access to prioritization records   | Used for updating/deleting records             |
| VOGRL1    | Overgroup master                         | Lookup/validation for overgroup fields         |
| VHGRL1    | Main group master                        | Lookup/validation for main group fields        |
| VUGRL1    | Subgroup master                          | Lookup/validation for subgroup fields          |
| RLEVL1    | Supplier master                          | Validation and description fetch for suppliers |
| VVARL1    | Item master                              | Validation and description fetch for items     |
| VVARLB    | Module master                            | Validation and description fetch for modules   |
| JVARL1    | Alternative item master                  | Fallback for item description                  |
| JMODL1    | Alternative module master                | Fallback for module description                |
| RA10L1    | Warehouse master                         | Validation and description fetch for warehouse |

## Main Program Flow

### Initialization (`*INZSR`)
- Key lists for file access are defined.
- Company (firm) number is retrieved from LDA.
- Initial subfile is populated by positioning to the first relevant record.

### Main Loop
- Alternates between command display and subfile display.
- Handles function key events for:
  - Exiting
  - Inquiry/lookup dialogs
  - Filtering
  - CRUD operations (Add, Edit, Copy, Delete, View)
  - Paging (roll up/down, home, etc.)

### Subfile Management
- **clr_subfile**: Clears the subfile and resets counters.
- **crt_subfile**: Populates the subfile with records from VPRLLR, applying any active filters.
- **bck_subfile**: Handles paging backward in the subfile.
- **dsp_subfile**: Controls display of the subfile and associated command/indicator logic.

### CRUD Operations
- **xc1bld**: Handles creation of new records (with duplicate checking and validation).
- **xc2bld**: Handles editing/viewing of records, including validation of supplier numbers and updating the VPRLLU file.
- **xd1win**: Handles deletion of records.
- **xk1win**: Handles copying of existing records to new keys (with duplicate checking).

### Filtering and Positioning
- **filter**: Manages the filter dialog, validates input, and repopulates the subfile accordingly.
- **posisjoner**: Positions the subfile to a specific record based on entered group or item values.

### Lookup/Inquiry
- **spørring**: Invokes external programs to lookup and return descriptions for warehouses, groups, suppliers, modules, and items based on the current field in focus.

### Validation and Description Fetch
- **sjekk_input**: Validates entered group, module, and item values, ensuring combinations are valid and fetching descriptions.
- **hent_info**: Populates description fields for group, module, item, and supplier fields for display.

### Excel Import
- **xc7bld**: Calls an external program (`JV162C`) to import prioritized supplier data from an Excel spreadsheet.

## Indicators and Conventions

- **Indicators 10-15, 21-22, 30, 31-79, 80-99**: Used for standard subfile and screen management (paging, field protection, error/warning indicators, work indicators).
- **b_forn, b_oppr, b_anul, b_feil, b_inlr**: Local boolean flags for subfile refresh, operation state, cancel state, error state, and program end.
- **w_fcrn, w_stel, w_spge, w_srrn, w_sfrn, w_ssrn**: Subfile paging and record counters.

## Design Patterns and Notable Practices

- **Separation of Concerns**: Each major user and data operation is encapsulated in a subroutine, facilitating maintainability.
- **Key List Usage**: All file access is controlled by well-defined key lists, making file operations explicit and consistent.
- **Extensive Use of Lookup/Validation**: All user input for group, item, supplier, etc., is validated against master files, and descriptions are fetched for user feedback.
- **Subfile Paging**: Manual management of subfile pages, including roll-up/roll-down logic and relative record numbers.
- **External Program Calls**: Lookup dialogs and Excel import are delegated to external programs, keeping the main program focused on its core logic.
- **Screen Feedback**: Error and warning indicators are set based on validation outcomes, driving user feedback on the screens.

## External Dependencies

- **Lookup Programs**: `RA510R`, `VG510R`, `VG511R`, `VG512R`, `RL500R`, `FO707C`, `VV500R`, `FO714C` are called for field validation and description retrieval.
- **Excel Import**: `JV162C` is called to import prioritized supplier data.

## User Interaction Flow

1. **Subfile Display**: User sees a paged list of supplier prioritizations, with options to page, filter, add, edit, copy, delete, or view details.
2. **Filter**: User can filter the list by warehouse, group, or supplier.
3. **Add/Edit/Copy**: User enters or modifies prioritization data, with lookups and validations for all fields.
4. **Delete**: User confirms deletion of a record.
5. **Excel Import**: User can trigger import of prioritizations from Excel.
6. **Field Lookup**: At any data entry field, user can invoke a lookup dialog for valid values.

## Special/Non-Obvious Aspects

- **Multi-Level Grouping**: The program supports prioritization at multiple levels of product grouping, allowing for fine-grained supplier selection.
- **Prioritization Logic**: Up to three prioritized suppliers can be associated with any grouping; validation ensures these suppliers exist.
- **Subfile Navigation**: Manual management of subfile pages and record numbers, rather than relying on implicit subfile paging.
- **Conditional Validation**: Certain combinations of group, module, and item fields are mutually exclusive and enforced in validation logic.
- **Fallback Logic**: When a description is not found in the main master file, alternative files are checked (e.g., JVARL1 for items).

## Summary Table: Key Subroutines

| Subroutine      | Purpose                                                    |
|-----------------|------------------------------------------------------------|
| `forny`         | Refreshes subfile display after changes                    |
| `posisjoner`    | Positions subfile to a specific record                     |
| `subfile`       | Main subfile processing loop (edit, copy, delete, view)    |
| `xc1bld`        | Handles creation of new records                            |
| `xc2bld`        | Handles edit/view of records                               |
| `xd1win`        | Handles record deletion                                    |
| `xk1win`        | Handles record copying                                     |
| `xc7bld`        | Handles Excel import                                       |
| `clr_subfile`   | Clears subfile and resets counters                         |
| `crt_subfile`   | Populates subfile with records                             |
| `bck_subfile`   | Pages back in subfile                                      |
| `dsp_subfile`   | Displays subfile                                           |
| `spørring`      | Field lookup dialogs                                       |
| `filter`        | Filter dialog and subfile refresh                          |
| `sjekk_input`   | Validates input and fetches descriptions                   |
| `hent_info`     | Fetches all relevant descriptions for current record       |

---

**Note:** This program is tightly integrated with the master data structure of the ASOFAK system and relies on consistent keying and validation across product and supplier master files. Understanding the relationships between these files and the business rules for prioritization is essential for effective maintenance and development.