# Explanation of Program LI102R

This program handles the creation, display, and update of “ordrebekreftelse” (order confirmations) within the system, particularly focusing on EDI-based messages. It is tightly integrated with ordering (“bestilling”), inventory management, references to external data such as GTIN/EAN, various subsystem lookups, and the possibility of updating corresponding purchase orders (and sometimes directly related “kundeordre”). Below is an overview of the major components and key flows.

## Core Purpose
LI102R coordinates what happens after an EDI order confirmation arrives and is stored in the database. It presents the confirmed lines to the user, compares them with the underlying “bestilling” (purchase order) or “ordre” (customer order), and allows various forms of updates:
- Adjusting confirmed quantity or price.  
- Deleting lines in cases of mismatched or zero-confirmed lines.  
- Displaying other order and line details such as freight costs or references.  
- Potentially updating the original purchase order and any associated sales order with the new confirmations.

This program is built around reading records from EDI message files (e.g., LEDIL1 / LEDILR) and matching them to purchase order headers/lines (LOHEL1 / LODTL1 / LODTLR) and, if applicable, matching sales order lines (FODTLR). It also interacts with numerous domain “helper” programs (LO700R, LO701R, FO700R, FO701R, LI716R) for recalculation of totals, updates of status flags, and other specialized business rules.

## Data Structures and Files
The main data structures (Ds) handle different segments of the message:

- D_OBKH* (header information):  
  Contains overall order confirmation data like date ranges, references to external documents, acceptance code at the header, textual lines, and so forth.

- D_OBKL* (line information):  
  Stores line-level confirmations (quantities, prices, acceptance code, GTIN/EAN references, etc.).  
  There are separate structures (e.g. D_OBKL vs. X_OBKL) because of differences in GTIN lengths (13 vs. 14 digits). The program checks which format to apply and overlays the data into the correct fields.  

- D_OBKS (order totals):  
  Summations of net amount, tax amounts, total amounts, and so on.

- Subfile records (B1SFL, B2CTL, etc.):  
  The program uses a subfile to display all relevant EDI lines. Each line can be scrolled, selected, and updated. Various indicator-driven flows (F-keys) reveal or change additional details.

## EDI and “Bestilling” Integration
Each line from the EDI confirmation (LEDIL1/LEDILR) is cross-referenced with lines in the internal purchasing module (LODTL1/LODTLR) or, if relevant, in the sales order module (FODTLR). The program checks:
1. Whether the purchase order line exists.  
2. Whether the order type or acceptance code is valid.  
3. If price or quantity differs, it calls subprograms (LO701R, LO700R, FO701R, FO700R) to perform the line update and recalculate totals.  

There are also controls preventing updates if the “bestilling” or “ordre” has advanced too far in workflow (e.g., “otype” checks).

### Deleting Lines
A special scenario is if the user wants to delete lines from the EDI confirmation that do not match or have zero-confirmed quantity. The code checks various conditions (e.g., referencing lines 550000–554999, the acceptance status) and then removes them from both the message file (LEDILU) and “bestilling” (LODTLU), followed by recalculating totals. If inventory was allocated, the program calls VL001R to decrement stock accordingly.

## Acceptance Code Handling
Lines carry an “akseptkode” (e.g., “1”, “3”, “5”, “7”, or blank). The Subroutine SJERK_AKSEPT maps these numeric or blank codes to textual statuses like “Ny,” “Endret,” “OK,” or “Avvist.” In some cases, a blank acceptance code is translated to “OK,” reflecting local business rules.

## Subfile Processing
The subfile shows lines from the EDI message (500000–599999 range) as well as any text lines (700000–799999). Users can page up/down, make changes, or select actions (e.g., see detailed line info, show references, update price/quantity). When the user confirms changes, the program loops through changed subfile records (READC) and performs the necessary updates.

### Additional Windows / Displays
- “B5WIN” shows line-level detail, including GTIN, a potential NOBB (Norwegian national building product number), discount, net or gross price, etc.  
- “B7WIN” displays “partsinfo” — extended addressing data for each role (BY = buyer, OB = bestiller, DP = delivery party, etc.).  
- “B8WIN” is for header-level charges or allowances (tillegg/fradrag).  
- “B9WIN” shows total amounts from the message (net totals, tax, final totals).  
- “B11WIN” is for reference data (e.g., project number, contract reference).  
- “B15WIN” is for free-form text lines attached to either the header or lines.

## Specialized Subroutines
Several non-obvious routines demonstrate the domain-specific logic:

1. “BEST_LINJE” checks if a given confirmed line can be mapped to an internal “bestilling” line (LODTLR). If found, it also tries to find a matching “ordre” line (FODTLR).  
2. “OMREGN_PRIS” converts the unit price when the confirmed unit of measure differs from the purchase order’s unit. It does cross-lookups in vvenlr, jvpkl2, etc. to derive conversion factors.  
3. “NY_KONTROLL” calls LI716R to do an overall re-validation if lines were updated. This re-check might change statuses, acceptance codes, or recalculate further aspects.  
4. “VIS_Otext,” “VIS_Tillegg,” and “VIS_Total” illustrate how the program displays free text, header-level charges, and order totals from the EDI message.  
5. “NEWLO_VASK” is a cleanup subroutine for certain trailing punctuation that broaches compatibility issues in Newlook-based GUIs.

## Relationship to Other Programs
- LO500R and FO500R are high-level bestilling/ordre entry programs that can be invoked from function keys.  
- LO700R, LO701R, FO700R, FO701R recalculate or update lines, costs, or totals for “bestilling” or “ordre.”  
- VL001R is used for inventory updates if lines are deleted or changed in quantity.  
- LI716R (called in “NY_KONTROLL”) triggers a re-validation after updates. 

Overall, LI102R is heavily driven by subfile interactions, displaying line items from the EDI confirmation, and conditionally updating the underlying purchase order or sales order lines. It carefully handles domain-specific acceptance codes, inventory adjustments, and “bestilling”/“ordre” references to keep integrated data consistent.