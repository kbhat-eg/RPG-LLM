# RPG Program JQ500R Explanation

This is a traditional IBM ILE RPG (RPG IV) program for the IBM i system (formerly AS/400), written in fixed-format RPG with extensive Norwegian comments and naming. The purpose of the program is to query and display a list of "produsent" (producer/manufacturer) records using a subfile interface on a display (workstation) device.

Below is a structured walkthrough of the key parts of the program, focusing on its logic, data structures, and screen handling.

---

## 1. Control and File Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Sets compile options: disables debug I/O, expects date entry as day/month/year.

**File Specs**:
```rpg
fjprol1    if   e           k disk    rename(jpropfr:jprol1r)
fjprol2    if   e           k disk    rename(jpropfr:jprol2r)
fjq500d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- `jprol1`, `jprol2`: Disk files, keyed access, both renamed from physical file `jpropfr`.
- `fjq500d`: Workstation file (display), with subfile `b1sfl` (records controlled by `w_srrn`), and info data structure `dspfbk` for feedback (e.g., cursor location).

---

## 2. Data Structures and Variables

### Parameters
```rpg
d p_prod          s                   like(jqprod)
d p_navn          s                   like(jqnavn)
```
- Used to receive and return selected producer and name values.

### Display Feedback
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Structure for display feedback, `d_fcrn` holds the first record number on the page for cursor-control.

### Key Variables and General Working Variables
```rpg
d jprol1_prod     s                   like(jqprod)
d jprol2_navn     s                   like(jqnavn)
d w_fcrn          s              4  0
...
d w_ssrn          s                   like(w_srrn)
...
d w_seqe          s              1
d b_valg_ok       s              1    inz(*off)
```
- Various working variables for subfile handling (record numbers, sequencing, flags).
- `w_seqe` indicates whether selection is by producer ('P') or name (' ').
- `b_valg_ok` signals that a selection has been made.

### Constants
```rpg
d c_sfil          s              2  0 inz(8)
```
- Subfile page size (8 records per page).

---

## 3. Indicator Usage

Legend from comments:
- `LR`: Last Record, ends program.
- 10, 11: Page up/down (roll, rolldown).
- 12~15: Subfile/display control.
- 21, 22: Home key, cursor placement.
- 30: Field protection for display.
- 31-99: Various work and error indicators.

---

## 4. Screen and Subfile Layout

- `B1SFL`: Main subfile record format.
- `B2CTL`: Subfile control record format.
- `B2CMD`: Command key instruction/display.

---

## 5. Main Program Flow

**Program is structured as a select-and-process loop around the subfile interface:**

- **Main Loop Tags**: `b2taga`, `b2tagb`
- **Initial display**: Writes `B2CMD` (instructions), moves to `b2tagb`.
- **Subfile display and interaction**: Calls subroutine `dsp_subfile`, then processes F-keys via `select` block.
    - F3/F12 (Exit): goto `avslutt`
    - F5 (Refresh): exsr `forny`
    - F10 (Page up): exsr `crt_subfile`
    - F11 (Page down): exsr `bck_subfile`
    - Home key: resets screen.
- **Positioning**: If a name or code is entered, subroutine `posisjoner` positions to that record in the file and refreshes the subfile.
- **Subfile Processing**: exsr `subfile` checks for selection (`b_valg_ok`), if selected, exits; else, redisplays.

**Exit:** Sets LR indicator, returns.

---

## 6. Subroutines

### a. `forny` - Refresh Subfile

- Chains to the relevant record if required, positions file pointer for subfile creation, and clears/creates subfile for refresh.

### b. `posisjoner` - Position in Subfile

- Checks if a search by name or producer is entered, sets the respective key variable, positions the disk file, then clears and fills the subfile accordingly. Clears user-entered search after positioning.

### c. `subfile` - Handle Subfile Selection

- Toggles cursor-placement indicator.
- Loops through the subfile records (using `readc`), and if a selection (`b1valg = 1`) is made, sets the return parameters and a flag to exit.

### d. `clr_subfile` - Clear Subfile

- Activates SFLCLR and SFLEND indicators, clears subfile-related variables.

### e. `crt_subfile` - Fill Subfile Page (Page Up)

- Increments page size, loops to read in records by key (`jprol1` if by producer, else `jprol2`), writing to subfile until the "page" is filled or EOF. Sets indicators if last record/page.

### f. `bck_subfile` - Page Down in Subfile

- If at end-of-file, backs up a page by reading previous records and re-filling subfile accordingly.

### g. `dsp_subfile` - Display Subfile

- If subfile has records, sets indicator to display subfile (`*IN12 = *ON`), else displays command screen. Handles feedback data structure for current record.

### h. `*inzsr` - Initialization

- Handles program entry, parameter loading, and initializes key-lists for file positioning. Fills subfile initially.

---

## 7. Key-Lists for File Positioning

```rpg
c     jprol1_key    klist
c                   kfld                    jprol1_prod
...
c     jprol2_key    klist
c                   kfld                    jprol2_navn
```
- Used for relative record positioning (SETLL/SETGT ops) in files when searching by producer code or name.

---

## 8. Entry Point

On entry, the program:
- Accepts `p_prod` and `p_navn` as parameters.
- Sets initial positioning by name (`jprol2`).
- Calls `crt_subfile` to populate the first page.
- Enters the main display and interaction loop.

---

## 9. High-level Workflow

**User Actions:**
- Views a paginated list of producers in a subfile interface.
- May search by producer (`produsent`) code or name.
- Can move page up/down.
- Selects an entry (probably by setting a field in the subfile and pressing Enter).
- On selection, the program returns the selected producer code and name.

**Handling of Indicators, Subfile Control, and Paging** is standard for subfile interaction on IBM i green screens.

---

## 10. Summary

- **Purpose**: Display/query and select a producer from a list, via subfile interface.
- **Input**: Optionally, a producer code or name for positioning; interaction via function keys.
- **Output**: Selected producer code and name.
- **Techniques**: Classic subfile control, file positioning with SETLL/READ, indicator-driven display logic.

---

## 11. Key Points for New RPG Developers

- **Fixed-format RPG**: Each column has meaning; C-specs (`c`) for code, D-specs (`d`) for data.
- **Subfiles**: Used for list display and selection on IBM i green screens.
- **Indicators**: 01-99 for program flow and display logic.
- **Positioning Logic**: Uses SETLL (set lower limit), CHAIN, READ/READC for indexed file navigation.
- **Work Variables**: Manage subfile record numbering, paging, and selection.

---

If you are onboarding to this program, focus on understanding subfile processing, indicator usage, and how file I/O and user interaction are woven through the subroutines. The program is modular, with subroutines for each core display and data function, making navigation and modification relatively straightforward for experienced RPG programmers.