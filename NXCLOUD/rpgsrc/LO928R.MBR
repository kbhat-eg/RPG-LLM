     H decedit('0.') datedit(*dmy-) option(*nodebugio)
     h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
      /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Program . . . . : LO928R
      * Beskrivelse . . : BEstillingsutskrift - sende mail automatisk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * 800   210622 ask  Nytt program - basert på LO920R
8.01  * 800   060123 ASK  Lagt inn oppslag mot systemregister for å hante desimal info
8.02  * 800   061023 ask  Lagt inn oppslag mot kontaktperson register for å finne mailadr.
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     flohel1    if   e           k disk    rename(lohepfr:lohel1r)
     flodtl1    if   e           k disk    rename(lodtpfr:lodtl1r)
     flotxl1    if   e           k disk    rename(lotxpfr:lotxl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
     ffvlsl1    if   e           k disk    rename(fvlspfr:fvlsl1r)
     fvsprl1    if   e           k disk    rename(vsprpfr:vsprl1r)
     fra12l1    if   e           k disk    rename(ra12pfr:ra12l1r)
     fra16l1    if   e           k disk    rename(ra16pfr:ra16l1r)
     fra09l1    if   e           k disk    rename(ra09pfr:ra09l1r)
     fra18l1    if   e           k disk    rename(ra18pfr:ra18l1r)
8.02 frukpl1    if   e           k disk    rename(rukppfr:rukpl1r)
     fra07pf    if   e           k disk
      *
      * Henter inn data fra LDA
      *
     d                UDS
     d l_prfi                750    750  0
     d l_ruti                800    809
     d l_wsid                901    910
     d l_user                911    920
     d l_filg                931    933
     d l_firm                944    946  0
     d l_avde                947    950  0
      *
      * Definering av parametre
      *
     d p_numm          s                   like(lonumm)
     d p_suff          s                   like(losuff)
     d p_stat          s              1
      *
     d p_serv          s             35
     d p_emal          s             50
     d p_ema2          s             50
     d p_ema3          s             50
     d p_kopi          s             50
     d p_emne          s             50
     d p_txt1          s             50
     d p_txt2          s             50
     d p_txt3          s             50
     d p_txt4          s             50
     d p_pers          s             50
     d p_inif          s             40
     d p_lr            s              1
     d p_str_in        s            512
     d p_str_out       s            512
     d p_filg          s             10
     d p_xmlf          s            256
      *
      * Definering av variabler i nøkler
      *
     d lohel1_numm     s                   like(lonumm)
     d lohel1_suff     s                   like(losuff)
     d lodtl1_numm     s                   like(ldnumm)
     d lodtl1_suff     s                   like(ldsuff)
     d lotxl1_numm     s                   like(ltnumm)
     d lotxl1_suff     s                   like(ltsuff)
     d lotxl1_line     s                   like(ltline)
     d fvlsl1_numm     s                   like(fvnumm)
     d fvlsl1_suff     s                   like(fvsuff)
     d fvlsl1_line     s                   like(fvline)
     d ra12l1_lkod     s                   like(ralkod)
     d vsprl1_tvar     s                   like(vvtvar)
     d vsprl1_tspr     s                   like(vvtspr)
     d ra16l1_pkod     s                   like(rapkod)
     d ra09l1_ikod     s                   like(raikod)
     d ra07pf_avde     s                   like(ragkod)
     d ra18l1_rkod     s                   like(rarkod)
     d votyl1_otyp     s                   like(vaotyp)
     d rlevl1_ldor     s                   like(loldor)
     d vltyl1_ltyp     s                   like(ldltyp)
     d aforl1_ruti     s                   like(l_ruti)
     d vvarl1_vare     s                   like(vvvare)
8.02 d rukpl1_kund     s                   like(rukund)
8.02 d rukpl1_levr     s                   like(rulevr)
      *
      * Definering av variable
      *
     d w_prfi          s              1  0
     d w_ffir          s              3  0
     d w_avde          s              4  0
     d w_fnav          s             30
     d w_fste          s             30
     d w_fftx          s             30
     d w_tfax          s              8
     d w_ftlf          s             11
     d w_ffax          s             11
     d sptek1          s                   like(vvtte1)
     d sptek2          s                   like(vvtte2)
      *
     d b_pdfp          s              1    inz(*off)
     d x_numm          s             15
     d x_vref          s             25
     d w_date          s               d   datfmt(*iso)
     d w_lang          s              1
     d w_firm          s                   like(ldfirm)
     d w_bpri          s                   like(ldipny)
     d w_nbel          s                   like(ldsumi)
     d w_tnet          s                   like(lototi)
     d w_tmva          s                   like(lototi)
     d w_totb          s                   like(lototi)
     d w_nnet          s                   like(lototi)
     d w_ntot          s                   like(lototi)
     d w_nmva          s                   like(lototi)
     d w_vnet          s                   like(lototi)
     d w_vtot          s                   like(lototi)
     d w_vmva          s                   like(lototi)
     d w_1anta         s                   like(ldanta)
     d w_rab1          s                   like(ldipny)
     d w_npri          s                   like(ldipny)
     d d1npri          s                   like(ldipny)
     d d1bbel          s                   like(ldsumi)
     d w_pdf           s              1  0
     d w_jnav          s             15
     d w_jkey          s             41
     d w_jtxt          s             35
     d w_pdf_ds        s            512
     d w_mtxt          s            300
     d w_mark          s              5
     d w_spol          s              5
     d w_str_in        s            512
     d w_str_out       s            512
     d w_ptyp          s              1
     d w_dspl          s            250
     d w_tek1          s            512
     d w_tek2          s            512
     d w_tek0          s            512
     d w_1dref         s            512
     d w_1vref         s            512
     d w_1fnav         s             50
     d w_1fad1         s             50
     d w_1fad2         s             50
     d w_1navn         s             50
     d w_1gate         s             50
     d w_1adr2         s             50
     d w_2navn         s             50
     d w_2adr1         s             50
     d w_2adr2         s             50
     d w_2tek1         s            512
     d w_2tek2         s            512
     d w_ptxt1         s             75
     d w_ptxt2         s             75
     d w_ptxt3         s             75
     d w_ptxt4         s             75
     d w_ppers         s             75
     d w_pemne         s             75
     d w_rekv          s             50
     d w_lmtx          s             50
     d crlf            c                   const(X'0d25')
     d w_lbtx          s             50
     d w_ddeno         s                   like(ragkod)
     d w_dnavn         s             50
     d w_dadr1         s             50
     d w_dadr2         s             50
     d w_dpcde         s                   like(ragpnr)
     d w_dpstd         s             50
     d w_dphon         s                   like(ragtlf)
     d w_dfaxn         s                   like(ragfax)
     d w_ldat          s              6  0
     d w_lddt          s              6  0
     d w_refn          s             50
     d w_lvar          s             50
     d w_2sted         s             50
     d w_mail          s             50
     d w_weba          s             50
     d w_anta          s              6  0
     d w_lv_nobb       s                   like(vvnobb)
     d w_lv_lvar       s                   like(vvvare)
     d w_frix          s            512
     d w_mvas          s              6  2
     d w_mvat          s              5  4
     d w_mvaf          s             10  9
      *
      * Erstatter varible fra printerfile
      *
     d w_navn          s                   like(rlnavn)
     d w_trsp          s                   like(ldsumi)
     d w_vtrs          s                   like(ldsumi)
     d w_mld1          s                   like(afmld1)
     d w_adr2          s                   like(loadr2)
     d w_bdat          s              6S 0
     d w_dref          s                   like(lodref)
     d w_fad1          s                   like(aafad1)
     d w_fad2          s                   like(aafad2)
     d w_vtmv          s                   like(lototi)
     d w_vtne          s                   like(lototi)
     d w_gate          s                   like(loadr1)
     d w_sted          s                   like(losted)
     d w_ldor          s                   like(loldor)
     d w_numm          s                   like(lonumm)
     d w_suff          s              3
     d w_ornr          s                   like(loornr)
     d w_time          s              6S 0
     d w_txt1          s                   like(aftxt1)
     d w_vref          s                   like(lovref)
     d w_vare          s                   like(ldvare)
     d w_ant0          s              6S 0
     d w_ant1          s              7S 1
     d w_ant2          s              8S 2
     d w_ant3          s              9S 3
     d w_enh1          s                   like(ldenh1)
     d w_vbpr          s                   like(ldipny)
     d w_vnbe          s                   like(ldsumi)
     d w_valk          s                   like(lovalk)
     d w_text          s                   like(lttext)
8.02 d w_krol          s                   like(rukrol)
     d b_topt          s              1    inz(*off)
     d b_toph          s              1    inz(*off)
     d b_bott          s              1    inz(*off)
     d b_both          s              1    inz(*off)
      *
     d XML_Output      s            256a   Varying
     d XML_path        s            256a   Varying
     d                                     Inz('/home/asp/print/adb')
     d jasper_mal      s            256a   inz('file:/home/asp/print/maler/+
     d                                     Bestilling/Bestilling.jasper')
     d jasper_logo     s            256a   Varying
     d tmpdate         s               D
     d tmptime         s               T
      *
     d d_pdf_ds        ds
     d  d_xmlm                       75
     d  d_jasm                       75
     d  d_logo                       75
     d  d_path                      100
     d  d_emal                       50
     d  d_fifo                       75
     d  d_kopi                        1
     d  d_dtaq                        1
     d  d_sign                        1
      /copy prototypeb
      /copy usec
      *
     c/Exec SQL
     c+  Set Option DatFmt=*ISO
     c/End-Exec
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedrutine
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Sjekker bestilling
      *
     c                   eval      lohel1_numm = p_numm
     c                   eval      lohel1_suff = p_suff
     c     lohel1_key    chain     lohel1r
     c                   if        not %found
     c                   eval      p_stat = 'F'
     c                   goto      pgm_end
     c                   endif
      *
      * Initierer xml dersom bestilling er funnet
      *
     c                   exsr      xml_envm
     c                   eval      b_pdfp = *on
      *
      * Behandler bestillingshode
      *
     c                   if        lobdat <> *loval
     c     *dmy          move      lobdat        w_bdat
     c                   endif
      *
     c                   eval      rapmti = 1
     c                   if        lovalk <> *blank
     c                   eval      w_valk = lovalk
     c                   endif
      *
      * Slår opp ordretype
      *
     c                   eval      votyl1_otyp = lootyp
     c     votyl1_key    chain     votyl1r
      *
      * Er ordretype negativ ?
      *
     c     vaokre        ifeq      '-'
     c                   eval      *in36 = *on
     c                   endif
      *
      * Slår opp etter firmainformasjon
      *
     c     afirl1_key    chain     afirl1r
      *
      * Null-stilling av variabler
      *
     c                   eval      w_trsp = 0
     c                   eval      w_vtrs = 0
     c                   eval      w_bdat = 0
     c                   eval      *in60 = *off
     c                   eval      w_valk = *blank
      *
      * Sjekk om vi skal gjøre valutaomregning av beløp/summer
      *
     c                   eval      ra16l1_pkod = lovalk
     c     ra16l1_key    chain     ra16l1r
     c                   if        not %found
     c                   eval      w_valk = 'NOK'
     c                   eval      rapmti = 1
     c                   else
     c                   eval      w_valk = 'NOK'
     c                   eval      rapmti = 1
     C                   endif
      *
     c                   if        loldat <> *loval
     c     *dmy          move      loldat        w_ldat
     c                   endif
      *
      * Legg inn bestillingsnummer og suffix
      *
     c                   eval      w_numm = lonumm
     c                   eval      w_suff = '/' + %char(losuff)
      *
      * Hente inn leverandør informasjon
      *
     c                   eval      rlevl1_ldor = loldor
     c     rlevl1_key    chain     rlevl1r
     c                   eval      w_ldor  = loldor
     c                   eval      w_navn = rlnavn
     c                   eval      w_gate = rlgate
     c                   eval      w_adr2 = rladr2
     c                   eval      w_sted = rlsted
      *
      * Finner hvilken mva-sats som skal benyttes
      *
     c                   call      'FÅ705R'
     c                   parm                    w_firm
     c                   parm                    lobdat
     c                   parm                    w_mvas
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
      *
      * Er det registrert leveringsadresse?
      *
     c                   eval      *in31 = *off
     c     lonavn        ifne      *blank
     c                   eval      w_2navn = lonavn
     c                   eval      w_2adr1 = loadr1
     c                   eval      w_2adr2 = loadr2
     c                   eval      w_2sted = losted
     c                   eval      *in31 = *on
     c                   endif
      *
      * Er det registrert leveringsdato?
      *
     c                   eval      *in32 = *off
     c     loldat        ifne      *loval
     c                   eval      *in32 = *on
     c                   endif
      *
      * Er det registrert leverandørens referanse?
      *
     c                   eval      *in33 = *off
     c     lodref        ifne      *blank
     c                   eval      *in33 = *on
     c                   eval      w_dref = lodref
     c                   endif
      *
      * Er det registrert leveringsmåte?
      *
     c                   eval      *in34 = *off
     c     lolmtx        ifne      *blank
     c                   eval      *in34 = *on
     c                   eval      w_lmtx = lolmtx
     c                   endif
      *
      * Er det registrert rekvisisjon?
      *
     c                   eval      *in35 = *off
     c     lorekv        ifne      *blank
     c                   eval      *in35 = *on
     c                   eval      w_rekv = lorekv
     c                   endif
      *
      * Er det registrert ordrenummer?
      *
     c                   eval      *in36 = *off
     c     loornr        ifne      0
     c                   eval      *in36 = *on
     c                   eval      w_ornr = loornr
     c                   endif
      *
      * Flytte øvrige felter
      *
     C     *hms          MOVE      LOTIME        w_time
     c*                  eval      w_time = lotime
     c                   eval      w_vref = lovref
      * Hent inn selgerinfo
     c                   if        loinnk <> 0
     c                   eval      ra09l1_ikod = loinnk
     c     ra09l1_key    chain     ra09l1
     c                   endif
      *
      *  Hent inn firma/avd. opplysninger dersom
      *  kode for det er satt i rutineregister
      *
     c                   if        w_prfi = 1 or
     c                             w_prfi = 2
     c                   eval      w_ffir = w_firm
     c                   eval      w_avde = loavde
      *
     c                   call      'FÅ707R'
     c                   parm                    w_prfi
     c                   parm                    w_ffir
     c                   parm                    w_avde
     c                   parm                    w_fnav
     c                   parm                    w_fad1
     c                   parm                    w_fad2
     c                   parm                    w_fste
     c                   parm                    w_fftx
     c                   parm                    w_tfax
     c                   parm                    w_ftlf
     c                   parm                    w_ffax
     c                   parm                    w_mail
     c                   parm                    w_weba
      *
     c                   endif
      *
      * Sjekk om det er norsk eller engelsk språk på blanketten
      *
     c                   eval      w_lang = '1'
     c                   if        rlland = '  ' or
     c                             rlland = 'NO'
     c                   eval      *in60 = *off
     c                   else
     c                   eval      ra12l1_lkod = rlland
     c     ra12l1_key    chain     ra12l1r
     c                   if        %found
     c                   if        ralspr > 1
     c                   eval      *in60 = *on
     c                   eval      w_lang = %char(ralspr)
     c                   endif
     c                   endif
     c                   endif
      *
     c                   exsr      hnt_avde
      *
      * Vi skriver til XML taggene for heading
      *
     c                   exsr      xml_head
      *
      * Behandler topptekstlinjer
      *
      *
     c                   eval      lotxl1_numm = p_numm
     c                   eval      lotxl1_suff = p_suff
     c                   eval      lotxl1_line = 1000
     c     lotxl1_key    setll     lotxl1r
      *
     c                   read      lotxl1r
     c                   dow       not %eof and
     c                             ltnumm = p_numm and
     c                             ltsuff = p_suff
     c                   if        ltline < 5000
     c                   eval      b_topt = *on
     c                   if        b_toph = *off
     c                   exsr      xml_topt_str
     c                   eval      b_toph = *on
     c                   endif
     c                   eval      w_text = lttext
     c                   exsr      xml_topptxt
     c                   endif
      *
     c                   read      lotxl1r
     c                   enddo
      *
     c                   if        b_topt = *on
     c                   exsr      xml_topt_end
     c                   endif
      *
      * Behandler varelinjer
      *
     c                   move      *off          *in44
     c                   move      *off          *in46
      *
     c                   eval      lodtl1_numm = p_numm
     c                   eval      lodtl1_suff = p_suff
     c     lodtl1_key    setll     lodtl1r
      *
     c     lodtl1_key    reade     lodtl1r
     c                   dow       not %eof
      *
      * Hent linje-type
      *
     c                   eval      vltyl1_ltyp = ldltyp
     c     vltyl1_key    chain     vltyl1r
      *
      * Sjekker om linjen ikke skrives på ordretypen
      *
     c                   if        lootyp = valo01 or
     c                             lootyp = valo02 or
     c                             lootyp = valo03 or
     c                             lootyp = valo04
     c                   goto      les_neste
     c                   endif
      *
      * Sjekker om tekstlinjer
      *
     c                   if        valktx = 1
     c                   exsr      xml_textl
     c                   goto      les_neste
     c                   endif
      *
      * Oppslag mot vareregister
      *
     c                   eval      vvarl1_vare = ldvare
     c     vvarl1_key    chain     vvarl1r
      *
      * Sjekker om logistikk-vare
      *
     c                   eval      w_lv_nobb = 0
     c                   eval      w_lv_lvar = *blank
     c/exec sql
     c+ select vvlnob, vvllva
     c+ into   :w_lv_nobb,
     c+        :w_lv_lvar
     c+ from   vvlepf
     c+ where  vvlvnr = :ldvare and
     c+        vvlldo = :loldor
     c+ fetch first 1 rows only
     c/end-exec
      *
      * Sjekk om tilbud/netto-pris
      *
     c     ldsumr        ifeq      *zero
     c                   eval      *in46 = *on
     c                   end
      *
      * Test på antall desimaler
      *
     c                   eval      *in40 = *off
     c                   eval      *in41 = *off
     c                   eval      *in42 = *off
     c                   eval      *in43 = *off
      *
     c                   if        ldlvre = 0
     c     vvdesi        comp      0                                      40
     c     vvdesi        comp      1                                      41
     c     vvdesi        comp      2                                      42
     c     vvdesi        comp      3                                      43
     c   40              z-add     ldanta        w_ant0
     c   41              z-add     ldanta        w_ant1
     c   42              z-add     ldanta        w_ant2
     c   43              z-add     ldanta        w_ant3
     c                   else
     c     laades        comp      0                                      40
     c     laades        comp      1                                      41
     c     laades        comp      2                                      42
     c     laades        comp      3                                      43
     c   40              z-add     ldanta        w_ant0
     c   41              z-add     ldanta        w_ant1
     c   42              z-add     ldanta        w_ant2
     c   43              z-add     ldanta        w_ant3
     c                   endif
      *
      * Varelinje
      *
     c                   if        ldlvre = 0
     c                   if        w_lv_nobb <> 0
     c                   movel     w_lv_nobb     w_vare
     c                   else
     c                   movel     vvnobb        w_vare
     c                   endif
     c                   else
     c                   movel     ldnobb        w_vare
     c                   endif
     c                   movel     ldtek1        w_tek1
     c                   movel     ldtek2        w_tek2
     c                   move      ldenh1        w_enh1
     c                   z-add     ldipny        w_bpri
      *
      * Omregnes til valuta
      *
     c                   eval(h)   w_vbpr = ldipny * rapmti
      *
      * Hente språktekster fra tilleggsregister
      *
     c                   if        *in60 = *on
     c                   eval      vsprl1_tvar = ldvare
     c                   eval      vsprl1_tspr = ralspr
     c     vsprl1_key    chain     vsprl1r
     c                   if        %found
     c                   eval      sptek1 = vvtte1
     c                   eval      sptek2 = vvtte2
     c                   eval      w_tek1 = vvtte1
     c                   eval      w_tek2 = vvtte2
     c                   endif
     c                   endif
      *
      * Netto pris
      *
     c                   z-add     ldanta        w_1anta
     c     w_1anta       ifeq      0
     c                   z-add     1             w_1anta
     c                   endif
     c     ldsumi        sub       ldsumr        w_npri
     c     w_npri        div       w_1anta       d1npri
      *
      * Beregne snittrabatt
      *
     c     100           sub       ldrab1        w_rab1
     c                   mult      ldrab2        w_rab1
     c                   div       100           w_rab1
     c                   add       ldrab1        w_rab1
      *
      * Sum Beløp
      *
     c                   z-add     ldsumi        d1bbel
     c     ldsumi        sub       ldsumr        w_nbel
      *
      * Omregnes til valuta
      *
     c                   eval(h)   w_vnbe = w_nbel * rapmti
      *
      * Skal mva. beregnes ?
      *
     c     afmvak        ifeq      1
     c                   move      *on           *in37
      *
     c                   endif
      *
      * Akkumuler til overføringssum
      *
     c                   add       w_nbel        w_trsp
     c                   add       w_vnbe        w_vtrs
      *
      * Skriv varelinjer
      *
     c                   exsr      xml_deta
      *
      * Sjekk om lengde spesifikasjon
      *
     c                   exsr      len_spec
      *
     c     les_neste     tag
     c     lodtl1_key    reade     lodtl1r
     c                   enddo
      *
      * Skrive totalsum
      *
     c                   eval      w_nnet = lototi - lototr
     c                   eval      w_ntot = w_nnet * w_mvat
     c                   eval      w_nmva = w_ntot - w_nnet
      *
     c                   exsr      xml_totaler
      *
      * Behandler bunntekstlinjer
      *
     c                   eval      lotxl1_numm = p_numm
     c                   eval      lotxl1_suff = p_suff
     c                   eval      lotxl1_line = 5000
     c     lotxl1_key    setll     lotxl1r
      *
     c                   read      lotxl1r
     c                   dow       not %eof and
     c                             ltnumm = p_numm and
     c                             ltsuff = p_suff
     c                   if        ltline > 5000
     c                   eval      b_bott = *on
     c                   if        b_both = *off
     c                   exsr      xml_bott_str
     c                   eval      b_both = *on
     c                   endif
     c                   eval      w_text = lttext
     c                   exsr      xml_bunntxt
     c                   endif
      *
     c                   read      lotxl1r
     c                   enddo
      *
     c                   if        b_topt = *on
     c                   exsr      xml_bott_end
     c                   endif
      *
      * Skriv xml fila på disk
      *
     c                   exsr      xml_end
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     pgm_end       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Miljø variabler
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xml_envm      begsr
      *
     c                   eval      w_spol = 'false'
      *
      /Free
           // Finne nytt batch nummer
               UpdHTMLVar('BatchNo':               w_jkey);
               UpdHTMLVar('Batchtype':       'BESTILLING');
               UpdHTMLVar('Username':              l_user);
               WrtSection('Topp');

           // Finn credetial variabler
               UpdHTMLVar('IPAdr':                  ' ');
               UpdHTMLVar('User':                l_user);
               UpdHTMLVar('PW':                     ' ');
               UpdHTMLVar('Schema':        'ADB'+l_filg);
               UpdHTMLVar('Companyno':    %char(l_firm));
               UpdHTMLVar('Departmentnoarkiv': %char(l_avde));
               WrtSection('Credential');

           // Finn report command variabler
               UpdHTMLVar('Jaspertemplate':      d_jasm);
               UpdHTMLVar('Logo':           jasper_logo);
               UpdHTMLVar('Keepspool':           w_spol);
               WrtSection('ReportCommand');
      /End-free
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Heading
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xml_head      begsr
      *
     c                   eval      w_str_in = *blanks
     c                   eval      w_str_out = *blanks
     c                   eval      w_mtxt = *blanks
     c                   eval      x_numm = %char(w_numm)+w_suff
     c                   eval      x_vref = w_vref
      * Henter ut mailserver
     c                   eval      p_serv = *blank
     c                   eval      p_stat = *blank
     c                   call      'AM705C'
     c                   parm                    p_serv
     c                   parm                    p_stat
      *
8.02  * Legger inn mailinformasjon - sjekker om mailinfo på kontaktperson register
      *
     c                   eval      p_emal = rlemal
8.02  *
8.02  * - kontaktperson
8.02  *
8.02 c                   eval      w_krol = 'MAILBEST_' +
8.02 c                                      %char(lolage)
8.02 c                   eval      rukpl1_kund = 0
8.02 c                   eval      rukpl1_levr = loldor
8.02 c     rukpl1_key2   setll     rukpl1r
8.02 c     rukpl1_key2   reade     rukpl1r
8.02 c                   dow       not %eof(rukpl1)
8.02 c                   if        rukrol = w_krol  and
8.02 c                             rumail <> *blank
8.02 c                   eval      p_emal = rumail
8.02 c                   endif
8.02 c     rukpl1_key2   reade     rukpl1r
8.02 c                   enddo
8.02  *
     c                   eval      p_ema2 = raiema
     c                   eval      p_ema3 = ' '
     c                   eval      p_emne = %trim(aftxt1) + ' ' +
     c                                           %char(lonumm) + '/' +
     c                                           %char(losuff) + ' ' +
     c                                           ('fra')  + ' ' +
     c                                      %trim(aafnav)
     c                   eval      p_txt1 = 'Automatisk bestilling'
     c                   eval      p_txt2 = ' '
     c                   eval      p_txt3 = ' '
     c                   eval      p_txt4 = ' '
     c                   eval      p_pers = 'Vennlig hilsen: ' + %trim(raitxt) +
     c                             ', ' + raimob
     c                   eval      p_kopi = raiema
     c                   eval      p_inif = afhex1 + afhex2
      *
      * Scann av strenger
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     p_emne        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pemne
      * Scann av strenger
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     p_txt1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ptxt1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     p_txt2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ptxt2
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     p_txt3        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ptxt3
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     p_txt4        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ptxt4
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     p_pers        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ppers
      *
     c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
     c                                      %trim(w_ptxt2) + crlf +
     c                                      %trim(w_ptxt3) + crlf +
     c                                      %trim(w_ptxt4) + crlf +
     c                                      %trim(w_ppers)
      *
     c                   if        p_kopi = *blanks
     c                   eval      p_kopi = d_emal
     c                   endif
      *
      /Free
           // Skriv mailinformasjon
               WrtSection('MailCommandStart');
               if %Trim(p_emal)<> *blanks;
               UpdHTMLVar('Receivers':           p_emal);
               WrtSection('MailReceiver');
               endif;
               if %Trim(p_ema2)<> *blanks;
               UpdHTMLVar('Receivers':           p_ema2);
               WrtSection('MailReceiver');
               endif;
               if %Trim(p_ema3)<> *blanks;
               UpdHTMLVar('Receivers':           p_ema3);
               WrtSection('MailReceiver');
               endif;
               UpdHTMLVar('CC':                     ' ');
               UpdHTMLVar('BCC':                 p_kopi);
               UpdHTMLVar('Sender':              p_kopi);
               UpdHTMLVar('Subject':             w_pemne);
               UpdHTMLVar('Message':             w_mtxt);
               UpdHTMLVar('SMTPServer':          p_serv);
               UPDHTMLVar('SMTPUser':               ' ');
               UPDHTMLVar('SMTPPw':                 ' ');
               WrtSection('MailCommandEnd');
      /End-free
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_fnav        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1fnav
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_fad1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1fad1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_fad2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1fad2
      *
      * Vi må oversette aktuelle tekster til "xml" tegn - Partner
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_navn        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1navn
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_gate        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1gate
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_adr2        P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1adr2
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_dref        P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1dref
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_vref        P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1vref
      * Rekvisisjonsnummer
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_rekv        P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_rekv
      * Avdelingsinformasjon - navn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_dnavn       P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dnavn
      * Avdelingsinformasjon - adresse
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_dadr1       P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dadr1
      * Avdelingsinformasjon - adresse 2
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_dadr2       P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dadr2
      * Avdelingsinformasjon - poststed
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_dpstd       P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dpstd
      /Free

           // Skriv firmavariabler
               UpdHTMLVar('Reporttext':            w_txt1);
               UpdHTMLVar('CompanyName':          w_1fnav);
               UpdHTMLVar('Companyadress1':       w_1fad1);
               UpdHTMLVar('Companyadress2':       w_1fad2);
               UpdHTMLVar('Companypostalcode':        ' ');
               UpdHTMLVar('Companypostoffice':     w_fste);
               UpdHTMLVar('Companyphone':          w_ftlf);
               UpdHTMLVar('Companyfax':            w_ffax);
          //   UpdHTMLVar('Companyorgno':   %char(aafftn));
               UpdHTMLVar('Companyorgno':          w_fftx);
               UpdHTMLVar('Companygiro':    %char(aafbgi));
               UpdHTMLVar('Companyemail':   %trim(w_mail));
               UpdHTMLVar('Companywebpage': %trim(w_weba));
               WrtSection('Company');

               UpdHTMLVar('Departmentno':    %char(loavde));
               UpdHTMLVar('Departmentname':        w_dnavn);
               UpdHTMLVar('Departmentadress1':     w_dadr1);
               UpdHTMLVar('Departmentadress2':     w_dadr2);
               UpdHTMLVar('Departmentpostalcode':      ' ');
               UpdHTMLVar('Departmentpostoffice':  w_dpstd);
               UpdHTMLVar('Departmentphone':       w_dphon);
               UpdHTMLVar('Departmentfax':         w_dfaxn);
               WrtSection('Department');

               test(de) *dmy w_bdat;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_bdat : *dmy);
               endif;
               UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
               test(te) *hms w_time;
               if %error;
               tmptime = *loval;
               else;
               tmptime = %time(w_time : *hms);
               endif;
               UpdHTMLVar('Creationtime': %char(tmptime : *hms));
               WrtSection('Creation');

           // Skriv partnerinfo (kunde)
               UpdHTMLVar('Partnerno':      %char(w_ldor ));
               UpdHTMLVar('Partnercategory':%char(rlkatg));
               UpdHTMLVar('Partnername':          w_1navn);
               UpdHTMLVar('Partneradress1':       w_1gate);
               UpdHTMLVar('Partneradress2':       w_1adr2);
               UpdHTMLVar('Partnerpostalcode':        ' ');
               UpdHTMLVar('Partnerpostoffice':     w_sted);
               UpdHTMLVar('Partnerphone':          rltlfn);
               UpdHTMLVar('Partnercellphone':      rlmobn);
               UpdHTMLVar('Partnerfax':            rltlfx);
               UpdHTMLVar('Salesdocumentno':       x_numm);
               UpdHTMLVar('Partnerrefname':       w_1dref);
               UpdHTMLVar('Partnerrefphone':       rlmobn);
           //  UpdHTMLVar('Partnerrefmail':           ' ');
               UpdHTMLVar('Partnerrefmail': %trim(rlemal));
               UpdHTMLVar('Requisitionno':         w_rekv);
               WrtSection('Partner');

           // Selger informasjon
               UpdHTMLVar('Salesrefno':              '  ');
               UpdHTMLVar('Salesrefname':         w_1vref);
               UpdHTMLVar('Salesrefemail':         raiema);
               UpdHTMLVar('Salesrefcellphone':     raimob);
               WrtSection('SalesRef');
      /End-free
      *
     c                   if        %trim(w_2navn) <> *blank
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   eval      p_lr = '0'
     c                   movel     w_2navn       p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_2navn
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_2adr1       p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_2adr1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_2adr2       p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_2adr2
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     lolmtx        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_lmtx
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_2sted       p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_2sted
      *
      /Free
           // Prosjekt informasjon
               UpdHTMLVar('Projectno':                '0');
               UpdHTMLVar('Projectname':          w_2navn);
               UpdHTMLVar('Projectadress1':       w_2adr1);
               UpdHTMLVar('Projectadress2':       w_2adr2);
               UpdHTMLVar('Projectpostalcode':        ' ');
           //  UpdHTMLVar('Projectpostoffice':     a2sted);
               UpdHTMLVar('Projectpostoffice':    w_2sted);
               WrtSection('Project');
      /End-free
     c                   endif
      *
     c                   if        %trim(lolbtx) = *blanks
     c                   eval      ra18l1_rkod = lolbet
     c     ra18l1_key    chain     ra18l1
     c                   if        %found
     c                   eval      lolbtx = rartx1
     c                   endif
     c                   endif
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     lolbtx        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_lbtx
      *
      /Free
               UpdHTMLVar('Currency':              lovalk);
               UpdHTMLVar('Discountcat':    %char(lorkat));
               UpdHTMLVar('Agent':          %char(losped));
               WrtSection('InfoHead1');

               UpdHTMLVar('Deliverymethod':               w_lmtx);
               test(de) *dmy w_ldat;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_ldat : *dmy);
               endif;
               UpdHTMLVar('Deliverydate':   %char(tmpdate : *iso));
               UpdHTMLVar('Deliverytype':                     ' ');
               UpdHTMLVar('Deliveryterms':                 w_lbtx);
               UpdHTMLVar('Drivingroute':           %char(lokjor));
               WrtSection('DeliveryInfo');

               UpdHTMLVar('District':       %char(lodist));
               UpdHTMLVar('Warehouse':      %char(lolage));
               UpdHTMLVar('Documenttype':          lootyp);
               UpdHTMLVar('Purchasetype':                w_ptyp);
               UpdHTMLVar('Languagecode':                w_lang);
               test(de) *dmy w_ldat;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_ldat : *dmy);
               endif;
               UpdHTMLVar('Deliverydate': %char(tmpdate : *iso));
               UpdHTMLVar('Paymentcondition':               ' ');
               UpdHTMLVar('Deliverymethod':              w_lmtx);
               UpdHTMLVar('Orderreference':        %char(w_ornr));
               WrtSection('InfoHead2');

           //  Legg ut 'heading' på linje
               WrtSection('OrderLines');

      /End-free
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Topptekst start
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xml_topt_str  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('TopTextStart');

      /End-free
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Topptekst
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xml_topptxt   begsr
      *
     c                   eval      p_str_in = *blank
     c                   eval      w_frix = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_text        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_frix
      *
      /Free
           // Skriv tekstlinjer
          //   UpdHTMLVar('Toptext':     w_text);
               UpdHTMLVar('Toptext':     %trim(w_frix));
               WrtSection('TopTextLine');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Topptekst slutt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_topt_end  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('TopTextEnd');

      /End-free
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Detaljer                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xml_deta      begsr
      *
     c                   eval      w_lvar = *blank
      *
     c                   if        valktx <> 1
      *
     c                   eval      w_tek1 = ldtek1
     c                   eval      w_tek2 = ldtek2
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_tek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek1
      *
     c                   if        ldtek2 <> *blank
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ldtek2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek2
     c                   endif
      * Lev.varenummer
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ldlvar        P_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_lvar
      *
     c                   eval      w_mark = 'false'
      * Valuta
     c                   if        *in60 = *off
     c                   eval      w_bpri = w_vbpr
     c                   eval      w_nbel = w_vnbe
     c                   endif
      *
      * Håndtere riktig antall desimaler
      *
     c                   if        *in40 = *on
     c                   callp     updHTMLVar('Quantity':%char(w_ant0))
     c                   callp     updHTMLVar('NoDecimals':        '0')
     c                   elseif    *in41 = *on
     c                   callp     updHTMLVar('Quantity':%char(w_ant1))
     c                   callp     updHTMLVar('NoDecimals':        '1')
     c                   elseif    *in42 = *on
     c                   callp     updHTMLVar('Quantity':%char(w_ant2))
     c                   callp     updHTMLVar('NoDecimals':        '2')
     c                   elseif    *in43 = *on
     c                   callp     updHTMLVar('Quantity':%char(w_ant3))
     c                   callp     updHTMLVar('NoDecimals':        '3')
     c                   endif
      *
     c                   if        ldldat <> *loval
     c     *dmy          move      ldldat        w_lddt
     c                   endif
      *
      /Free
           // Skriv detaljer
               UpdHTMLVar('Itemno':             w_vare);
               UpdHTMLVar('Supplieritemno':%trim(w_lvar));
               UpdHTMLVar('Text1':              w_tek1);
               UpdHTMLVar('Text2':              w_tek2);
               UpdHTMLVar('Unit':                w_enh1);
               UpdHTMLVar('Vat':                   '0');
               UpdHTMLVar('Currency':           w_valk);
               UpdHTMLVar('Netprice':     %char(w_bpri));
               UpdHTMLVar('Discount':             '0');
               UpdHTMLVar('Totalsum':     %char(w_nbel));
               UpdHTMLVar('Linetype':              '0');
               UpdHTMLVar('Bookingno':             '0');
               UpdHTMLVar('DiscountAccounting': %trim(w_mark));
               UpdHTMLVar('Nobbno':        %char(ldnobb));
               UpdHTMLVar('Lineno':        %char(ldline));
               UpdHTMLVar('Warehouse':     %char(ldlage));
               test(de) *dmy w_lddt;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_lddt : *dmy);
               endif;
               UpdHTMLVar('Deliverydate': %char(tmpdate : *iso));
          //   UpdHTMLVar('Partneritemno':       ldlvar);
               UpdHTMLVar('Partneritemno':%trim(w_lvar));
               UpdHTMLVar('Campaign':               ' ');
               UpdHTMLVar('Gtin':           %char(ldeann));
               WrtSection('Line');

      /End-free
      *
     c                   else
     c                   eval      w_tek1 = *blank
     c                   eval      w_tek2 = *blank
     c                   movel     ldtek1        w_tek1
     c                   movel     ldtek2        w_tek2
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_tek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_tek2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek2
     c**6.27             eval      w_tek0 = %trim(w_tek1) + ' ' + %trim(w_tek2)
     c                   if        %subst(w_tek1:35:1) = ' ' or
     c                             %subst(w_tek2:1:1) = ' '
     c                   eval      w_tek0 = %trim(w_tek1) + ' ' + %trim(w_tek2)
     c                   else
     c                   eval      w_tek0 = %trim(w_tek1) + %trimr(w_tek2)
     c                   endif
      *
      /Free
          //   UpdHTMLVar('Text1':              w_tek1);
               UpdHTMLVar('Text1':       %trim(w_tek0));
               UpdHTMLVar('Text2':                 ' ');
               WrtSection('TextLine');

      /End-free
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Vanlige tekstlinjer     *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xml_textl     begsr
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ldtek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_2tek1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ldtek2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_2tek2
      *
      /Free
               UpdHTMLVar('Text1':             w_2tek1);
               UpdHTMLVar('Text2':             w_2tek2);
               WrtSection('TextLine');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Totaler                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_totaler   begsr
      * Valuta
     c                   if        *in60 = *off
     c                   eval      w_tnet = w_nnet
     c                   eval      w_tmva = w_nmva
     c                   eval      w_totb = w_ntot
     c                   else
     c                   eval      w_tnet = w_vnet
     c                   eval      w_tmva = w_vmva
     c                   eval      w_totb = w_vtot
     c                   endif
      *
      /Free
           // Skriv nettolinje
               UpdHTMLVar('Sumnettoexcvat':       %char(w_tnet));
               WrtSection('NettoLine');

           // Skriv mva linje
               UpdHTMLVar('Vatbasis':             %char(w_tnet));
               UpdHTMLVar('Sumvat':               %char(w_tmva));
               UpdHTMLVar('Vatpercent':           %char(w_mvas));
               WrtSection('VatLine');

           // Skriv totallinje
               UpdHTMLVar('Sumtotal':             %char(w_totb));
               WrtSection('TotalLine');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Bunntekst start         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_bott_str  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('BottomTextStart');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Bunntekst               *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_bunntxt   begsr
      * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
     c                   eval      p_str_in = *blank
     c                   eval      w_frix = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_text        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c**                 movel     p_str_out     w_text
     c                   movel     p_str_out     w_frix
      *
      /Free
           // Skriv bunntekst
          //   UpdHTMLVar('Bottomtext':  w_text);
               UpdHTMLVar('Bottomtext':  %trim(w_frix));
               WrtSection('BottomTextLine');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Bunntekst slutt         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_bott_end  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('BottomTextEnd');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Slutt                   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_end       begsr
      *
      * Skriv xmlfila til disk
      *
      /Free
               WrtSection('EndOrderLines');
      /End-free
      *
      * Lag tag for vising i arkivklienten
      *
     c                   eval      w_dspl = *blank
     c                   eval      w_dspl = 'Bestilling: '+%char(w_numm)+
     c                             ' Leverandør: '+ %trim(%char(w_ldor) + ' - '+
     c                             %trim(w_1navn) + '  Beløp ' + %char(w_totb))
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '1'
     c                   movel     w_dspl        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dspl
      *
      * Referansetagg
      *
     c                   eval      w_refn = *blank
     c                   eval      w_refn = %char(%subdt(w_date:*years)) +
     c                             %char(w_numm)
      /Free
           // Skriv metattags

               UpdHTMLVar('Refno':          %trim(w_refn));
               UpdHTMLVar('Displaytag':     %trim(w_dspl));
               WrtSection('ArchiveCommandStart');

               UpdHTMLVar('Metavalue':      %char(w_numm));
               UpdHTMLVar('Metakey':        'BESTILLING');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':      %char(w_ldor));
               UpdHTMLVar('Metakey':         'LEVERANDØR');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':            w_1navn);
               UpdHTMLVar('Metakey':     'LEVERANDØRNAVN');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':      %char(w_totb));
               UpdHTMLVar('Metakey':              'BELOP');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':      %char(loornr));
               UpdHTMLVar('Metakey':        'ORDRENUMMER');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':             l_user);
               UpdHTMLVar('Metakey':             'BRUKER');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue': %char(w_date:*iso));
               UpdHTMLVar('Metakey':               'DATO');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':             w_txt1);
               UpdHTMLVar('Metakey':         'RUTINETEKST');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':             l_ruti);
               UpdHTMLVar('Metakey':             'RUTINE');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':      %char(l_firm));
               UpdHTMLVar('Metakey':              'FIRMA');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':             l_wsid);
               UpdHTMLVar('Metakey':             'SKJERM');
               WrtSection('MetaTag');

               WrtSection('ArchiveCommandEnd');
      /End-free
      *
      /Free
               WrtSection('Footer');
      /End-free
      *
      * Skriv xml fila til disk
      *
     c                   eval      XML_Output = XML_path + l_filg +'/'+
     c                             'Best_'+ %trim(w_jkey) + '.xml'
      *
     c                   callp     WrtHtmlToStmf(XML_Output: 819)
      *
      * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
      *
     c                   if        d_dtaq = '1'
     c                   eval      p_xmlf = xml_output
     c                   eval      p_filg = 'ADB'+l_filg
     c                   call      'AP629C'
     c                   parm                    p_filg
     c                   parm                    p_xmlf
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutiner for XML/jasper integrasjon - Detaljer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hnt_avde      begsr
      *
      * Hent inn avdelingsinformasjon
      *
     c
     c                   eval      w_ddeno = loavde
     c                   eval      w_dnavn = *blank
     c                   eval      w_dadr1 = *blank
     c                   eval      w_dadr2 = *blank
     c                   eval      w_dpcde = *zeros
     c                   eval      w_dpstd = *blank
     c                   eval      w_dphon = *blank
     c                   eval      w_dfaxn = *blank
      *
     c                   eval      ra07pf_avde = loavde
     c     ra07pf_key    chain     ra07pfr                            90
     c                   if        *in90  = *off
     c                   eval      w_dnavn = ragtxt
     c                   eval      w_dadr1 = ragadr
     c                   eval      w_dadr2 = ragad2
     c                   eval      w_dpcde = ragpnr
     c                   eval      w_dpstd = (%char(ragpnr) + ' ' + ragste)
     c                   if        ragtlf <> *blank
     c                   eval      w_dphon = ragtlf
     c                   endif
     c                   if        ragfax <> *blank
     c                   eval      w_dfaxn = ragfax
     c                   endif
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for lengde spesifikasjon
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     len_spec      begsr
      *
     c                   eval      fvlsl1_numm = ldornu
     c                   eval      fvlsl1_suff = ldorsu
     c                   eval      fvlsl1_line = ldorli
     c     fvlsl1_key    setll     fvlsl1
     c     fvlsl1_key    reade     fvlsl1
      *
     c                   dow       not %eof
     c                   eval(h)   w_anta = fvanta
     c                   eval      w_tek2 = %char(fvleng) + ' mm x ' +
     c                                      %char(w_anta) + ' stk'
     c                   exsr      xml_spec
     c     fvlsl1_key    reade     fvlsl1
     c                   enddo
      *
     c     end_spec      endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Spesifikasjoner
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xml_spec      begsr
      *
      /Free
           // Skriv spesifikasjoner
               UpdHTMLVar('Text1':       w_tek2);
               UpdHTMLVar('Text2':          ' ');
               WrtSection('TextLine');
      /End-free
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre inn
      *
     c     *entry        plist
     c                   parm                    p_numm
     c                   parm                    p_suff
     c                   parm                    p_stat
      *
      * Key for bestillings hode
      *
     c     lohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lohel1_numm
     c                   kfld                    lohel1_suff
      *
      * Key for bestillingslinjer
      *
     c     lodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lodtl1_numm
     c                   kfld                    lodtl1_suff
      *
      * Key for tekst-linjer
      *
     c     lotxl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lotxl1_numm
     c                   kfld                    lotxl1_suff
     c                   kfld                    lotxl1_line
      *
      * Key for leverandør-register
      *
     c     rlevl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rlevl1_ldor
      *
      * Key for ordretyper
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for linjetyper
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for statusregister
      *
     c     lstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for formular-register
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      * Key for vare-register
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for oppslag på lengdespesif.linje
      *
     c     fvlsl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fvlsl1_numm
     c                   kfld                    fvlsl1_suff
     c                   kfld                    fvlsl1_line
      *
      * Key for oppslag på språkregister
      *
     c     vsprl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vsprl1_tvar
     c                   kfld                    vsprl1_tspr
      *
      * Key for oppslag på landkode
      *
     c     ra12l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra12l1_lkod
      *
      * Key for oppslag på valutakode
      *
     c     ra16l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra16l1_pkod
      *
      * Key for firmaregister
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag på selger
      *
     c     ra09l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra09l1_ikod
      *
      * Key for oppslag på avdelings-register
      *
     c     ra07pf_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra07pf_avde
      *
      * Key for posisjonering på leveringsbetingelse
      *
     c     ra18l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra18l1_rkod
8.02  *
8.02  * Key for oppslag på kontaktpersonregister
8.02  *
8.02 c     rukpl1_key2   klist
8.02 c                   kfld                    w_firm
8.02 c                   kfld                    rukpl1_kund
8.02 c                   kfld                    rukpl1_levr
      *
      * Henter inn faste data
      *
     c                   eval      w_firm = l_firm
     c                   time                    w_date
     c                   eval      l_ruti = 'LIFAX'
8.01  *
8.01  * Hente antall desimaler for skaffevarer
8.01  *
8.01 c     lstsl1_key    chain     lstsl1r
8.01  *
8.01 C                   if        not %found
8.01 C                   eval      laades = 3
8.01 C                   endif
      *
      * Hente inn rutinenavn og meldingstekst
      *
     c                   eval      aforl1_ruti = l_ruti
      *
     c     aforl1_key    chain     aforl1r
     c                   eval      w_txt1 = aftxt1
     c                   eval      w_mld1 = afmld1
     c                   eval      w_prfi = afprfi
      *
      * Sjekk om vi skal bruke jasper og xml generering av dokumenter
      *     her settes w_ptyp til '1' for å få utskrift uten priser
      *
     c                   eval      b_pdfp = *off
     c                   eval      w_pdf = 0
     c                   eval      w_pdf_ds = *blanks
     c                   eval      w_ptyp = '1'
      *
     c                   call      'AP609R'
     c                   parm                    l_ruti
     c                   parm                    w_pdf
     c                   parm                    w_pdf_ds
     c                   eval      d_pdf_ds = w_pdf_ds
      *
      * Hent inn xml templaten
      *
     c                   callp     gethtmlifs(d_xmlm :'<as400>')
     c                   callp     clrhtmlbuffer
      *
      * Finn hvor xml'en skal legges
      *
     c                   eval      xml_path = *blanks
     c                   eval      xml_path = %trim(d_path)
      *
      * Finn path til logo
      *
     c                   eval      jasper_logo = *blanks
     c                   eval      jasper_logo = %trim(d_logo)
      *
      * Henter batch ident
      *
     c                   eval      w_jnav = 'PDF' + %char(p_numm)
     c                   eval      w_jtxt = 'Utskrift av bestilling har +
     c                                       startet'
     c                   call      'AB700R'
     c                   parm                    w_jnav
     c                   parm                    w_jkey
     c                   parm                    w_jtxt
      *
     c                   endsr
