# Program AP056R – Integration with Lognet Transport Service

## Purpose

This program is a central integration point between our ERP system and the external Lognet transport service. It is responsible for constructing and sending shipment (transport) requests as JSON via API, processing the response, and updating internal records accordingly. The program is designed to be called from other business logic, encapsulating all necessary validation and data gathering for transport requests.

## High-level Workflow

1. **Initialization**: Load configuration and runtime parameters (API keys, URLs, JSON templates, etc.) from system tables.
2. **Validation**: Ensure that the order and its context are eligible for transport processing (e.g., correct status, not internal orders, not connected to certain suppliers).
3. **Data Gathering**:
    - Retrieve order header, lines, customer, warehouse, and seller information.
    - Calculate total packages, weight, and volume.
    - Fetch additional data from NGN and other subsystems if configured.
4. **JSON Request Construction**:
    - Build the JSON payload using a template, substituting dynamic values.
    - Handle special cases (e.g., returns, transport-only orders).
5. **API Interaction**:
    - Write the request and headers to the IFS.
    - Call the external API (via `AW702C`).
    - Process the response, extract relevant values, and store results.
6. **Cleanup**: Optionally remove temporary files from the IFS.

## Key Business/Domain Logic

- **Order Eligibility**: Only orders that are fully picked, not canceled, not internal, and not connected to certain suppliers are processed.
- **Flow Control**: The logic for whether to process an order is controlled by configuration switches in the database (see `CO402R` calls).
- **Transport Item Handling**: The system supports marking orders as "transport only" if all items are flagged as transport goods.
- **Returns Handling**: For return orders, sender and receiver information is swapped in the JSON.
- **Data Sourcing**: All critical configuration (API keys, endpoints, templates) is managed in DB tables for flexibility.
- **Error Handling**: If any critical step fails, the status is set to FALSE and the program exits cleanly.

## Technical Structure

### File Declarations

- Multiple physical and logical files are declared, each renamed for clarity. These represent order headers (`fohel1`), order lines (`fodtlr`), customer master (`rkunl1`), transport registers, etc.
- Files are opened for input, update, or both as needed.

### Key Data Structures & Variables

- **LDA Fields**: Used to retrieve runtime user and company context.
- **Parameter Fields**: Order identity and status are passed in and out.
- **Working Variables**: Large set of working variables for constructing requests, handling file paths, and accumulating totals.
- **Configuration Switches**: Flags (`u_flat`, `u_inte`, `u_konv`) determine which features are active based on configuration.

### Initialization (`*inzsr`)

- Loads all runtime configuration (user/password, URLs, templates, API keys) from the `afpspf` and `aposextnst` tables using embedded SQL.
- Evaluates configuration switches via external program `CO402R`.
- Sets up all necessary keys for file access.

### Main Logic

#### 1. **Configuration and Eligibility Checks**

- Verifies that flow control is enabled and all required configuration is present.
- Checks that the order exists and is eligible (correct status, not internal, not excluded supplier, etc.).
- For orders tied to purchases, checks if the supplier is an external warehouse (in which case, skips transport).

#### 2. **Order Data Retrieval**

- Retrieves data from order header and lines.
- Fetches customer, warehouse, and seller info.
- Calculates package count (minimum 1), total weight, and volume (calls `FO780R` for totals).

#### 3. **Address and Contact Processing**

- For returns, swaps sender/receiver in the JSON.
- Handles missing or incomplete contact information by attempting to fill from various sources (order, project, customer).

#### 4. **JSON Construction**

- Loads a JSON template from the IFS.
- Uses `UpdHTMLVar` to substitute all variable values into the template.
- Handles special cases:
    - Returns: swaps sender/receiver.
    - Transport-only orders: sets special flags.
    - Cleans up problematic characters from item descriptions to avoid JSON parsing errors.

#### 5. **Order Line Processing**

- Iterates through all order lines, calculating per-line weight and volume (calls subroutine `kalk_linje`).
- Writes each line’s data into the JSON request.

#### 6. **API Call Preparation**

- Writes the JSON request and required headers (including the API key) to the IFS.
- Constructs the file paths dynamically based on company code and order number.

#### 7. **API Call and Response Handling**

- Invokes the external API using program `AW702C`.
- Checks for the existence of a response file, and attempts to convert its CCSID if necessary (calls `AP060C`).
- Reads the response, extracts the consignment reference, and updates the transport register.

#### 8. **IFS Cleanup**

- Optionally deletes the temporary files created for the request/response cycle.

### Subroutines

- **kalk_linje**: Calculates weight and volume for an order line, with fallback logic for missing data and unit conversions.
- **sjk_tr_item**: Splits a comma-separated list of transport item numbers into an array.
- **sjk_trp_ord**: Checks if all order lines are transport items or text lines, for special handling.

### Integration Points

- **CO402R**: External program for configuration switches.
- **FO780R**: Calculates total weight and volume for an order.
- **VL710R**: Gets item type and related info.
- **AW702C**: Handles the HTTP POST to the Lognet API.
- **NG002R**: Retrieves pick/driver info from NGN.
- **AP060C**: Converts CCSID of response files if needed.

### Patterns and Conventions

- **Versioning and Change Log**: Extensive use of version and change comments (e.g., `8.05`, `7.02`) to document business logic evolution.
- **File Renaming**: All files are renamed on input for clarity and to avoid conflicts.
- **Use of IFS**: JSON payloads and headers are written to IFS files for the web service call, ensuring traceability and debugging capability.
- **Dynamic Configuration**: All external and environment-specific values are sourced from database tables, not hardcoded.
- **Error Handling**: All error paths set `p_stat` to 'FALSE' and exit gracefully.

## Special Business Rules

- **Flow Control**: Only process if both the shipping method and warehouse are configured for flow control.
- **Internal Orders**: Excluded based on configuration.
- **Supplier Exclusion**: Orders tied to certain suppliers (e.g., RDS) are excluded from transport processing.
- **Order Status**: Only processed if ready for dispatch (log code >= 4 or 6), with fallback to previous year’s log if needed.
- **Transport Items**: If all items on the order are transport items, a special flag is set in the JSON.

## File and Table Relationships

- **Order Header/Lines**: `fohel1`, `fodtlr`
- **Customer**: `rkunl1`
- **Warehouse (Avdeling)**: `ra10l1`
- **Transport Register**: `ftrpi2`, `ftrpiu`
- **Item Master**: `vvarl1`, `vvasl1`, `vvenl1`, `jvarl1`
- **Configuration**: `afpspf`, `aposextnst`
- **NGN/External Info**: `NG002R`, `aposextnst` (for transport items)

## Notable Design Decisions

- **All-in-One Logic**: The program is designed to encapsulate all logic for transport request preparation, reducing code duplication in calling programs.
- **Heavy Use of Embedded SQL**: For dynamic configuration, instead of hardcoding values.
- **IFS Usage**: For interoperability with external APIs and for debugging purposes.
- **Extensive Fallbacks**: Many fields have fallback logic to ensure requests are never missing required information.
- **Domain-Driven Validation**: All eligibility checks are based on business rules, not just technical constraints.

## Maintenance Notes

- **Change Log**: Always review the inline change log for recent business rule changes.
- **Configuration-Driven**: Changes to transport processing often require updates in the configuration tables, not just code.
- **Error Handling**: All error exits should set `p_stat` to 'FALSE' and return.
- **IFS Cleanup**: File deletion is currently disabled for debugging (`if 1=2`). Enable as needed.

---

**For onboarding:**
- Become familiar with the configuration tables (`afpspf`, `aposextnst`) and how to update them.
- Understand the file structure and naming conventions for order-related files.
- Review the external programs called for configuration and calculations.
- Pay attention to the comments marked by version numbers for historical context on business logic changes.

**Contact the system architect or business analyst for clarification on any business rules that are unclear from the code or comments.**