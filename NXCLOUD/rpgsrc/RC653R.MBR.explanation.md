# Program RC653R – Inkasso: Printing New Cases

## Overview

This program, **RC653R**, is part of the ASOKON system and is responsible for generating printouts (and optionally Excel exports) for new debt collection ("inkasso") cases. The program processes and aggregates transaction records, generates summary and detail reports, and provides an option to export data to Excel for further processing.

Key features include:
- Grouping and reporting on customer-level debt collection records.
- Filtering and business logic for inclusion/exclusion of records.
- Support for both printed output and Excel data extraction.
- Integration with external modules for configuration and notifications.

---

## File Definitions

- **rkwbpf**: Main transaction file for debt collection cases (renamed as `rkwbpfr`).
- **rkunl1**: Customer master file (renamed as `rkunl1r`).
- **rca0l1**: Control file, used for fetching the last used inkasso number (renamed as `rca0l1r`).
- **rc653p**: Printer file for report output, with overflow indicator `*in30`.

---

## Data Structures and Variables

### Parameter Area (300–490)
- Fields like `pfirm`, `pnavn`, `puser`, `pkdat`, etc., represent parameters passed to the program, including firm, user, period, and customer numbers.
- The `kun` array and `pknr1`–`pknr0` represent up to 10 customer numbers.

### Working Variables
- `w_bdat`, `w_fdat`, `w_idat`: Dates for transaction, due, and last reminder.
- `w_kund_gml`: Previous customer number, used for break logic.
- `wbforp`, `wbfort`: Totals for overdue amounts (per customer and grand total).
- `Fil_Til_Excel`: Flag to control Excel export.
- `w_sql`, `w_map`, `w_tildok`, `w_typ`: Used for Excel export (SQL statement, file path, document name, file type).
- `w_dat`, `w_tim`: Current date and time (ISO format).

### Subroutine Variables
- `l_wsid`, `l_user`, `l_fgrp`, `l_firm`, `l_fnav`: User/session/firm info.

### External Program Interface
- **CO402R**: Configuration/parameter retrieval program.
- **ASPTOXLSX**: Converts SQL result set to Excel.
- **AA007R**: Sends notification to the user.

---

## Main Processing Logic

### Initialization (`*inzsr`)

- Sets up key lists and initializes variables.
- Retrieves the last used inkasso number from `rca0l1r`.
- Calls `CO402R` to check if Excel export is enabled for this firm/group. If so, sets `Fil_Til_Excel` flag.
- Writes report header.

### Main Loop

1. **Read and Process Transactions**
   - Reads from `rkwbpfr` (debt collection cases).
   - Loops until EOF (`*in61`).

2. **Customer Break Logic**
   - On change of customer number (`rnkund`):
     - If previous customer exists, writes customer totals.
     - Resets per-customer totals and commentary.
     - Reads customer master (`rkunl1r`) for current customer.

3. **Filtering and Business Rules**
   - Excludes customers with non-positive balance or not marked for inkasso.
   - Skips records with complaints (`rnbilk = 89`) or zero outstanding amount.
   - Only processes records that pass all filters.

4. **Report Output**
   - On first record for a customer, writes header and customer info.
   - For each valid transaction, writes detail line (`d1det`).
   - Accumulates per-customer and grand totals.

5. **Date Handling**
   - Sets transaction, due, and last reminder dates as appropriate.

6. **Loop Continuation**
   - Reads next record and continues.

### End of Processing

- Writes final totals (`t1tot`, `t2tot`).
- If Excel export is enabled:
  - Constructs SQL query for relevant data.
  - Builds output file name based on user and timestamp.
  - Calls `ASPTOXLSX` to generate Excel file in IFS.
  - Notifies user via `AA007R`, providing file location.

---

## Business/Domain-Specific Logic

- **Inkasso Filtering**: Only includes customers and transactions eligible for debt collection (positive balance, correct marking, no complaints).
- **Excel Export**: Controlled via parameter from `CO402R`, can be enabled/disabled per firm/group.
- **Customer Breaks**: Reports are grouped by customer; totals and commentary are per customer.
- **Notifications**: If Excel export is performed, user is notified with the file location in the IFS.

---

## Integration Points

- **CO402R**: Retrieves configuration (whether Excel export is enabled for this context).
- **ASPTOXLSX**: Performs SQL-to-Excel conversion and writes to IFS.
- **AA007R**: Sends a message to the user about the location of the exported Excel file.

---

## Design Decisions and Conventions

- **Record-Level Processing**: The program processes one transaction at a time, grouping by customer.
- **Break Handling**: Uses the classic RPG break logic pattern for customer-level aggregation.
- **Parameter Passing**: Uses a fixed-format parameter block for input, supporting batch and interactive invocation.
- **Conditional Output**: Uses indicators (e.g., `*in30`) to control when headers and sections are written.
- **Excel Export**: Modern enhancement (v7.00) uses SQL and an external utility for spreadsheet export, decoupling data extraction from the RPG logic.
- **Notifications**: User messaging is integrated for workflow completion feedback.

---

## Notes for New Developers

- **File Naming**: File names are often abbreviated; refer to the renames at the top for clarity.
- **Indicators**: Many report and logic flows are controlled by classic RPG indicators.
- **Error Handling**: Minimal; assumes data integrity and presence. Review for possible enhancements if needed.
- **Parameter Expansion**: The parameter block is large and used in other programs; be aware of field overlaps.
- **Localization**: Some field names and comments are in Norwegian; familiarize yourself with key terms (e.g., "inkasso" = debt collection, "kunde" = customer).
- **Versioning**: Changes and enhancements are marked with version comments (e.g., `7.00`), and business requirements are referenced in comments.

---

## Summary

RC653R is a core reporting and extraction program for new debt collection cases, supporting both printed reports and Excel exports, with logic tailored for business rules around customer eligibility and transaction filtering. It is extensible and integrates with other system modules for configuration and notification. Understanding the customer grouping and break logic, as well as the Excel export workflow, is key for effective maintenance and enhancement.