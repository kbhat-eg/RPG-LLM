# RPG Onboarding Guide: Program RH661R (MVA VAT Settlement Main Book Report)

This program is designed to process and print VAT settlements (MVA oppgjør) from the main ledger. It reads accounting entries, processes VAT codes, calculates totals, prints reports, and outputs data suitable for archiving and, more recently, for XML-based regulatory reporting and digital formats.

The code is rather large and complex; this guide covers its architecture and explains the most critical sections so new developers can understand and extend it safely.

---

## 1. **Header and Documentation Block**

- **Header (`h` spec):**
  - `datedit(*dmy)` sets default date format for edits.
  - `option(*nodebugio)` disables debug info on I/O operations.

- **Documentation:**
  - Includes program history, version comments, change logs, and indicator usage.
  - Details what various indicators (KA, KC, LR, etc.) mean.
  - Lists changes by version and author—good for understanding historical context.

---

## 2. **File Declarations**

- Multiple database files (disk files) are declared (`F` spec), either for input or update, with renaming where necessary.
- Main files:
  - `rhtrlb`, `rhsal1`, `rhtrlu`, etc. (journals, balances, master data)
  - `frjoupf`: Output/update file for VAT postings.
  - `frh664s`: Main printer output file.
  - `pdf`-tagged logicals for working with spool files.
- Some files are used specifically for fetching codes, descriptions, or company metadata.

---

## 3. **Data Declarations**

- **Worktables/Arrays:** For accumulating VAT calculations per code:
  - `mk`, `bto`, `nto`, `knto`, `grl`, `imv`, `imu`, `umv`, `sal`, `mks`, etc.
  - Each holds a different aspect (brutto, netto, grunnlag, input/output VAT, etc.) per VAT code (`dim(99)`).

- **Work Fields/Structures:**
  - Many work variables representing fields from database records: period, account, VAT code, etc.
  - Indicators and intermediary fields for report layout and logic.
  - Several upper-case variables for totals (e.g., `oms01g`, `wmva03g`, etc.)

- **PDF/Spool Handling:**
  - Work fields for spool file integration and external calls.

---

## 4. **Input File Record Formats**

- Input specs for reading balances into the `sal` array. These are used for reporting or calculating running balances.

---

## 5. **Main Processing Loop**

### Initialization (`*INZSR` subroutine)

- Initializes work variables and arrays.
- Fetches the latest used voucher number.
- Loads default accounts from code tables.
- Writes the header record to the output.

### Main Loop

```rpg
c     rhtrlb_key    setll     rhtrlb
c     rhtrlb_key    reade     rhtrlb
c     dow       *in60 = *off
    ... process each entry ...
c     rhtrlb_key    reade     rhtrlb
c     enddo
```
- Loops through `rhtrlb` (posting journal) records for a given firm and year.
- Flags and fields are reset before processing each record.

#### Within the Loop

- **VAT Code Normalization:** Blank codes are set to `'0'`.
- **Break Handling:** If the VAT code changes, process breaks by calling the `brudd` subroutine.
- **Eligibility Check:** Only records for the current period and not previously processed are handled.
- **Posting processing:** Calls subroutine `beh_post` for detailed VAT logic.

---

## 6. **Subroutines**

### `brudd` (Handling VAT Code Change)

- Called whenever the VAT code changes.
- Adds the found code to the list (array `mk`).
- Retrieves code details from the code table to retrieve the processing code.
- Updates local work variables with current info.

---

### `beh_post` (Processing an Entry)

- Handles one posting/ledger record.
- Parses and splits the gross/net amounts based on VAT code.
- Calculates and accumulates amounts (gross, basis, input, and output VAT) into the per-code arrays.
- Handles direct postings for special VAT codes.
- Updates totals for each VAT 'type'.
- Maintains running sums for special accounts (like Fylkesskattesjefen/Fylkeskommune, i.e., the regional tax authority), foreign services, and there are distinctions for processing foreign VAT.

#### Summarized Steps in `beh_post`:

- Calculate gross/net values and update per-code arrays.
- Map accounting entries to correct VAT 'buckets' based on the code (input, output, direct, high/middle/low rate).
- Special handling for foreign VAT and adjustments.
- Once processed, print, update, or write output records as necessary.
- Mark the record as processed in the source file so it's not handled again.

---

### `mvatot` (Finalize/Print VAT Totals and Summary)

- At the end of processing, this subroutine:
    - Sums up all per-code arrays and writes the summary lines to the output file.
    - Also sorts per-code totals by code and new 'SAFT' VAT code (for modern reporting).
    - Handles writing of sum lines grouped by different criteria.
    - Outputs totals for 'special' postings if required.
    - Fetches and prints the account balances for the relevant accounts.

---

### `mvapos` (Post VAT Settlement Entries)

- Writes VAT settlement entries to the output file for archiving/reporting.
    - Handles entries for input VAT, output VAT, special VAT (like foreign services).
    - Each entry is populated with the appropriate account, amount, and metadata.

---

### Spool/Jasper/PDF Integration

- Routines handle locating the correct spool files, producing reports, and (optionally) launching a PDF preview in a browser.
- Calls external programs as needed to finalise the output for digital archiving (XML, PDF).

---

## 7. **Key-Lists for Chains**

At the end, key-lists are defined for all the files being chained to (searched by primary key):

- Posting Register
- VAT Posting Register (update)
- Balances
- Chart of Accounts
- Status code/fixed account files
- VAT Code tables (standard and new 'SAFT' table)
- Company info

These definitions are critical for correct file access and must be maintained in sync with the physical/logical files in the database.

---

## 8. **Extensibility and Maintenance Tips**

- **Indicators:** Used extensively for control flow. Ensure you reset/set them carefully if adding code.
- **Subroutines:** Main process is modular; add new processing logic into appropriate subroutines.
- **Arrays:** Each VAT code (up to 99) has a parallel set of arrays. Be careful not to overflow; size-check if extending VAT code logic.
- **SAFT/Modern Reporting:** Adaptations for new regulatory standards (like 'SAFT') are marked in comments and new variables. Any new regulation might require updating these sections.
- **External Calls:** Integration with other programs for report output, PDF viewing, etc. Ensure required programs (like `AP627R`, `AP621R`) are deployed in production.
- **Testing:** Use the indicator-driven 'test' path when validating new code.

---

## 9. **Summary of Workflow**

1. **Initialize** program variables, fetch configuration and metadata.
2. **Loop** through all journal entries for the target period/company.
3. **Process** each entry with correct logic based on VAT type—calculate sums.
4. **Handle breaks** where VAT code changes to accumulate properly by code.
5. **Aggregate** and print totals, writing summary/settlement entries.
6. **Output** results to print, file, and optionally spool/PDF/XML for archiving and digital reporting.

---

## 10. **Common Norwegian Terms in Source**

- **mva (merverdiavgift):** VAT.
- **oppgjør:** Settlement.
- **postering:** Posting/entry.
- **grunnlag:** Basis (amount on which VAT is calculated).
- **inngående/utgående:** Input/output (VAT).
- **fylkesskattesjefen:** Regional tax authority's account.
- **bilagsnummer:** Voucher number.
- **konto:** Account.

---

## 11. **Best Practices for Developers**

- Never change indicator usage unless you fully understand their role.
- If adding new VAT codes/types, update arrays and processing logic accordingly.
- When troubleshooting, use existing debug comments as guides for safe places to insert additional tracing.
- Test thoroughly, especially any logic affecting file updates, VAT calculations, and output/integration points.
- Coordinate any new external program calls or file format changes with the operations team.

---

**In summary:**  
This program is central to the VAT settlement and reporting process, deeply connected to both transaction data and regulatory reporting requirements. Safeguard the integrity of account, VAT code, and period logic, and always validate your changes with the output reports and, where possible, with accounting domain experts.

---

For any onboarding or specific code section questions, reach out to the functional lead or consult the in-program comments and metadata blocks which are unusually informative in this codebase.