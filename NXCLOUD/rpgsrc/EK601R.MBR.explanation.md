# EK601R â€“ Customer Bonus Calculation and Reporting

## Purpose

This program, `EK601R`, is part of the ASOFAK system and is responsible for calculating and printing the basis for customer bonuses ("kunde bonus, skriver ut grunnlag"). It generates a report listing the bonus basis and calculated bonus for either a range of customer categories or a range of customer numbers, with options to filter by bonus type and to include all customers with agreements or only those with actual bonus activity.

## Structure Overview

- **Input Files:**  
  - `ekbtst` (two logical views: `ekbti3`, `ekbti1`): Bonus basis per category (`ekbti3`) and per customer (`ekbti1`)
  - `ekbost` (`ekboir`): Bonus basis details per customer
  - `rkunpfr` (`rkunl1`): Customer master data
  - `vbotpfr` (`vbotl1`): Bonus type master data

- **Output File:**  
  - `ek601p`: Printer file for report output

- **Parameters:**  
  Passed in a user data structure (UDS) with fields for year, category range, customer range, bonus type, and print options.

- **Subroutines:**  
  - `kal_kkat`: Process by customer category
  - `kal_kund`: Process by customer number
  - `kal_bgrl`: Calculate bonus basis for a customer
  - `finn_ktext`: Fetch customer name and category
  - `finn_btext`: Fetch bonus type description
  - `xovrfl`: Handle page overflow (new page)
  - `*inzsr`: Initialization

## Business and Domain-Specific Logic

### Parameter Handling

Parameters are passed in a fixed-position UDS, including:

- **Year (`paarf`, `paart`)**: Filter for bonus calculation period.
- **Category (`pkatf`, `pkatt`)**: Range of customer categories to include.
- **Customer (`pknrf`, `pknrt`)**: Range of customer numbers to include.
- **Bonus Type (`ptbot`)**: Specific bonus type to filter by.
- **Print Option (`pabon`)**: Whether to print all customers with agreements or only those with bonus activity.

### Main Flow

1. **Initialization:**  
   - Sets up key lists for file access.
   - Moves firm number from UDS to working variable.

2. **Print Heading:**  
   - Writes report header with the selected year.

3. **Processing:**  
   - If a customer category range is specified (`pkatt` not zero), processes by category (`kal_kkat`). Otherwise, processes by customer number (`kal_kund`).

4. **Subtotal and Totals:**  
   - Sums up bonus basis and calculated bonuses.
   - Writes totals if any bonuses were found.

5. **Program End:**  
   - Sets LR indicator and returns.

### Category Processing (`kal_kkat`)

- Loops through all bonus records in `ekbti3` within the specified category range.
- Filters by bonus type if specified.
- For each record:
  - Fetches bonus type and customer text if changed.
  - Calculates the bonus basis via `kal_bgrl`.
  - Depending on print option, decides whether to print the detail line.
  - Accumulates subtotals.

### Customer Processing (`kal_kund`)

- Analogous to category processing, but loops through bonus records in `ekbti1` within the customer number range.

### Bonus Basis Calculation (`kal_bgrl`)

- For the current customer, reads all bonus basis records in `ekboir`.
- **Important business rule:** Only includes elements where `ekebyg = 0` (i.e., elements that are bonus-building).
- For each relevant record:
  - If a bonus date (`ekbdat`) is present, extracts the year; otherwise, uses the parameter year.
  - Sums up the bonus basis (`ekbgru`) for the specified bonus type and year.
  - (Since 6.30) Excludes non-bonus-building elements from the calculation.

### Customer and Bonus Type Text (`finn_ktext`, `finn_btext`)

- Fetches and sets the customer name and category, or bonus type description, for inclusion in the report.

### Page Overflow Handling (`xovrfl`)

- Writes a new header when the printer overflow indicator is set.

## Design Decisions and Conventions

- **Key Lists:**  
  Key lists are defined in the initialization subroutine and are reused for file access, ensuring consistent keying for chains and reads.

- **Data Model:**  
  - `ekbti3` and `ekbti1` provide summary bonus data per category and customer, respectively.
  - `ekboir` provides detailed bonus basis transactions.
  - Customer and bonus type master files are joined for descriptive text.

- **Filtering Logic:**  
  - The program can operate in two modes: by category or by customer, determined by the presence of a category range.
  - Filtering by bonus type is optional and controlled by the `ptbot` parameter.
  - The print option (`pabon`) allows for inclusion of all customers with agreements, regardless of bonus activity.

- **Exclusion of Non-Bonus-Building Elements:**  
  As of version 6.30, only bonus-building elements are included in the basis calculation, in line with business requirements.

- **Printer Overflow Handling:**  
  The program tracks printer overflow using indicator `*in30` and writes a new header as needed.

## External Relationships

- **Data Dependencies:**  
  The program depends on the integrity and completeness of the bonus basis (`ekbti3`, `ekbti1`, `ekboir`), customer master (`rkunl1`), and bonus type master (`vbotl1`) files.

- **Integration Points:**  
  The output is a printed report, which may be further processed or distributed per business needs.

## Version History

- **6.10 (140312):** No longer checks against year in some logic (see commented code).
- **6.30 (080617):** Excludes non-bonus-building elements from the basis.

## Notable Patterns

- **Use of UDS for Parameter Passing:**  
  Parameters are passed as a packed structure, reflecting legacy batch/reporting conventions.

- **Conditional Processing:**  
  Extensive use of conditional logic to control printing and calculation based on parameters.

- **Efficient File Access:**  
  Use of `setll`/`reade` and `chain` for indexed access, minimizing full table scans.

## Summary

`EK601R` is a reporting program that calculates and prints customer bonus bases, supporting flexible selection by customer category or number, optional filtering by bonus type, and configurable detail inclusion. It reflects standard reporting patterns in legacy RPG applications, with domain-specific logic to ensure only valid, bonus-building transactions are included in the calculation. The program is tightly coupled to the data model of the ASOFAK system and should be maintained with careful attention to business rules regarding bonus eligibility and reporting requirements.