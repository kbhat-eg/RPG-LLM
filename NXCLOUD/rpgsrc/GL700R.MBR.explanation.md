# Explanation of the RPG Source Code (`GL700R`)

## Overview

This RPG (Report Program Generator) program is designed to prepare a communication file for banking transaction transfers. It handles input parameters, validates critical fields, formats and writes communication records, and invokes a secondary communication program. It supports different communication partners, such as `IBM` and `NIT`, and adapts the data formatting accordingly.

The code includes both file I/O (disk and workstation), screen handling, field validations, subroutines for various formatting tasks, and a structured use of indicators and control fields.

---

## Files Defined

```rpg
fdirpie    uf a e           k disk
fdiriie    if   e           k disk
fdiruie    o  a e           k disk
fgl700d    cf   e             workstn
```

**Purpose:**
- `dirpie` (input), `diriie` (input), `diruie` (output): Disk files for reading/writing transaction parameters and records.
- `gl700d`: Workstation file for interactive screen IO (displays).

---

## Key Data Structures

```rpg
d rci             s              1    dim(80)  // Editing in
d rcu             s              1    dim(80)  // Editing out

d wbtot           s              6  0          // Total byte counter
d wfnut           s              1             // Utility for special chars
d wlogn           s             80             // Work field for logon string
d wpparm          s              2             // Parameter key
d wrend           s              2  0          // End point for output record
d wsend           s             80             // Work field for send string
d x1              s              2  0          // Generic counter
d x2              s              2  0          // Generic counter
```

---

## Indicators

As per the comment section, indicators have specialized uses:

- Function keys: `KC` (F3=Exit), `KE` (F5=Edit receiver), `KF` (F6=Edit FMS-record for NIT)
- `LR`: End program
- 31-59: Error/Screen status
- 60-69: File status
- 70-99: Work indicators

---

## Program Flow

### 1. Program Entry

```rpg
c     *entry        plist
c                   parm                    wpparm
```
- Starts program, receives two-character parameter key.

### 2. Initialize Variables

Counters, pointers, and byte totals are set to zero. `wfnut` is set and cleared for specific character sequences (details depend on charset).

### 3. Screen Handling ("A1BLD")

Displays a main input screen for the user to enter account, user ID, password, etc. It first attempts to fetch existing values from `dirpie`. If not found (`*in60`), it initializes all fields to blanks.

### 4. Main Input/Edit/Validation Loop

- Waits for screen input.
- **F3 key (`KC`)**: Exit.
- **F5 key (`KE`)**: Show receiver info edit window.
- **F6 key (`KF`)**: Show NIT info edit window.
- **Validation**: Checks that all required fields are filled (account, user ID, password, message class, partner, etc.). If not, sets appropriate screen indicator (`*in31`–`*in36`) and redisplays for correction.

### 5. Update Parameter File

After successful validation, updates or writes a record in the parameter file (`dirpie`) with the entered values.

### 6. Logon Sequence for NIT

If the communication partner is `NIT`, writes a fixed sequence of logon instructions to the output file (`diruie`):
- "CESN" (logon)
- User ID
- Password
- "EXPV" (start application)

### 7. Logon String Generation (IBM vs NIT)

- **IBM**: Calls subroutine `xlogn1` to create a formatted logon string (with password).
- **NIT**: Calls subroutine `xlogn2` (without password).

### 8. Send String Generation

- **IBM**: Subroutine `xsend1` writes a detailed "SEND" command with embedded parameters.
- **NIT**: Subroutine `xsend2` writes a simplified "SEND" command.

### 9. FMS-Record Handling for NIT

If the FMS-record is present and partner is `IBM`, special formatting/subroutine (`xredi`) divides the record over two file records (according to computed endpoint).

### 10. Write Transaction Records

Reads each record from `diriie` (input file). For each:
- **IBM**: Edits and splits the record as above.
- **Others**: Directly writes to output file.

### 11. Send Record Termination

After processing all records, adds a termination record:
- **IBM**: Uses special characters (`'�'`).
- **Others**: Uses a semicolon (`;`).

### 12. Close Output File and Launch Communication Program

Closes the communication file and calls `GL701R`, passing the total number of bytes processed.

---

## Program Termination

Sets `*inlr` indicator to `*ON` (end-of-program), then returns.

---

## Subroutines

### `xlogn1`: Format IBM Logon String

Builds a logon string with account, user ID, and password:
```
IELOGON ACCOU...NT(account)...USERID(user)...PASSWORD(pass)...);
```
Writes to output.

### `xlogn2`: Format NIT Logon String

Same as above, but omits password:
```
IELOGON ACCOU...NT(account)...USERID(user)...);
```
Writes to output.

### `xsend1`: Format IBM Send String

Builds a "SEND" command with account, user ID, message class, and special delimiters. Locates the endpoint (`wrend`) based on a semicolon, for splitting logic later.

### `xsend2`: Format NIT Send String

Simpler "SEND" command without user ID and message class.

### `xredi`: Split and Write IBM Records

Based on calculated endpoint, splits a record into two, writes both to output.

---

## General Comments

- **Screen handling** is central – users interactively maintain all required transmission data.
- **File handling** updates parameter and output files accordingly.
- **Conditional logic** supports different partner requirements (IBM vs NIT).
- **Indicators** are used heavily for flow control and file/screen status.
- **Modular subroutines** handle differences in record formatting, keeping the core logic readable.

---

## Useful for

Banking batch interfaces, legacy integration, or any process where transaction files are staged and formatted for communication programs on IBM i/AS400.

---

### Suggestion

If onboarding, focus on:
- Understanding screen field mapping/flow
- How parameters are validated and stored
- The differences between IBM and NIT formatting
- The structure and sequencing of file records (logon, send, data, termination)
- How to troubleshoot based on indicator usage and error handling

---

Let me know if you want any particular section explained in even more detail!