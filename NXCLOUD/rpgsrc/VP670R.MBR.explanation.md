# RPG Program VP670R – Code Explanation

This RPG (Report Program Generator) program, named **VP670R**, is designed for IBM i systems. The intent is to produce a "price file" for SmartKalk based on various customer or customer project parameters, with logic to handle extensions for GLN (Global Location Number), file name, and optional parameters such as "nobbnummer". The code uses the traditional fixed-format RPG IV style.

Below is a detailed walkthrough to help you understand the structure and function of the code.

---

## 1. **Header and Documentation**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **H-spec**: Sets the compile options—no debug I/O and date editing using Day-Month-Year format.
- The header comments provide information about the system, program name, description, version history, and modifications.

---

## 2. **File Declarations**

```rpg
ffkdil1    if   e           k disk    rename(fkdipfr:fkdil1r)
```
- **File fkdil1** (probably a distribution list or customer file) is declared for Input, Full procedural, externally described, Keyed disk file.
- File is renamed in RPG to `fkdil1r`.

---

## 3. **Definition of Parameters and Variables**

**Parameters**: These are variables received as parameters to the program (via *ENTRY parameter list), such as company, customer number, customer project, etc.

```rpg
d p_firm          s              3  0
d p_kund          s              6  0
d p_kpro          s              6  0
... (and so on)
```
- `p_firm`: Company code
- `p_kund`: Customer number
- `p_kpro`: Customer project code
- `p_rfmt`: Format code
- `p_vsor`: Source code
- etc.

**Key Variables**: Used for chaining into the file using composite keys.
- `fkdil1_kund`, `fkdil1_kpro`

**Working Variables**: Used throughout the program and for passing to called programs.

```rpg
d w_vsor          s             10
d w_ogrp          s              2  0
...
d w_memb          s             10
```
- These are mostly "work" versions of the parameters. E.g., `w_vsor` is local working copy of source.

---

## 4. **Main Program Logic**

This starts after initalizing (see subroutine `*inzsr` for how parameters are loaded).

### Parameter-based processing
```rpg
c                   select
c                   when      p_kpro <> 0
c                   exsr      behandl_kpro
c                   when      p_kund <> 0
c                   exsr      behandl_kund
c                   endsl
```
- If customer project (`p_kpro`) is provided, process by project (`behandl_kpro`).
- Else, if customer (`p_kund`) is provided, process by customer (`behandl_kund`).

Then, sets on LR (end of program) and returns.

---

## 5. **Subroutines**

### `behandl_kpro` – Handle by Customer Project

- Sets up key variables.
- Tries to chain (fetch) a record with (company, customer, project) as key.
- Loads working variables from parameters.
- If a distribution record is found (`%found`):
  - If certain fields are not blank, override the working variables with those from the file.
- Calls `prisfil` subroutine to do the actual file writing.

### `behandl_kund` – Handle by Customer

- Similar to `behandl_kpro`, but only uses (company, customer) as key.
- Remainder logic is analogous.

### `prisfil` – Write to Price File

- If `w_rfmt` (format) is blank, skips processing.
- If parameter `p_ogrp` ("ogrp" group) is provided, sets `w_vsor` to blank.
- Sets up all required working variables.
- Gets a timestamp, and creates a unique "member" name for the price file.
- Calls external program `'VP671C'` with all relevant parameters (including recently added fields like GLN and NOBB number).
  - This is likely the program that does the actual writing of data to the price file.

### `*inzsr` – Initialization Subroutine

- Loads program parameters from the *ENTRY parameter list.
- Sets up key lists for file access (composite keys).
- Sets the main working variables with parameter values (company, GLN, etc.).
- Grabs a timestamp for use as a unique identifier.

---

## 6. **Key RPG Idioms used**

- **CHAIN**: Used for random access to a DB file using a composite key.
- **%found**: Built-in function to check if the last file operation was successful.
- **Subroutines (BEGSR/ENDSR)**: Used for modular processing.
- **KLIST/KFLD**: For defining keys for file operations.
- **PLIST/PARM**: For parameter passing.
- **CALL/PARM**: For calling another RPG (or CL) program with a parameter list.

---

## 7. **Special Notes**

- The code references changes (e.g., `8.01`, `8.02`) which indicate enhancements such as GLN numbers and additional parameters.
- Extensive use of legacy RPG (fixed format C specs).
- The program is structured for maintainability; changes to logic relating to new parameters have been marked in both parameter, variable, and subroutine calls.

---

## 8. **What the Program Does**

- Initializes by reading in a wide set of parameters about company, customer, project, and output format.
- Decides, based on parameters, whether to process by customer or project.
- Looks up a customer/project distribution list to potentially override parameters.
- Calls a utility program to write a record (or set of records) to a price file for use in another application (SmartKalk).
- Handles extensions to parameters and output format, such as support for GLN (global location number) and new pricing options.

---

## 9. **Onboarding Tips**

- **Understand the parameter list:** Most logic revolves around what is passed in.
- **Know the distribution file structure:** `fkdil1` is central to how customer/project parameter overrides work.
- **Changes and Extensions:** Marked by version comments; check these for understanding new features.
- **External Program Call:** `'VP671C'` is where the price file is generated/written—review this for output details.
- **RPG style:** This is classic fixed-format RPG IV. If you are used to free-format, take time to get used to column-sensitivity.

---

### Summary

This program is essentially a controller or dispatcher, handling input and parameter logic, updating fields as required (from distributed lists if available), and orchestrating the call to a specialized price file creation utility. It is highly parameter-driven and modular, with logic paths for both customer and customer project use-cases. 

If you are enhancing or debugging it, pay attention to the parameter management, file access patterns, and especially the way parameters are passed into the utility program (`VP671C`). Changes flagged by comments (e.g., GLN, NOBB number) highlight critical extensions relevant to recent business requirements.