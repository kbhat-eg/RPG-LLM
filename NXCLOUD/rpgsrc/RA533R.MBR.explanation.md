## Overview

This program (`RA533R`) is part of the ASOKON system and manages the display and selection of shipping methods (“Forsendelsesmåter”). It presents data in a subfile, allowing the user to scroll forward (F10) or backward (F11), position the list based on a code or partial text, and make a selection. Once a shipping method is chosen, the program returns the code and text in parameters.

The program uses two physical files, `RA31L1` and `RA31L2`, which store shipping records keyed by firm number and either numeric code (`RA31L1`) or descriptive text (`RA31L2`). The subfile data is displayed via three screen formats (`B1SFL`, `B2CTL`, and `B2CMD`).

## Key Points

1. **Parameters and Return Values:**
   - The program expects three parameters:
     - `p_firm` (firm number).
     - `p_ekod` (shipping code).
     - `p_etxt` (shipping text).
   - If the user selects a shipping method from the subfile, the chosen values are placed into `p_ekod` and `p_etxt` before the program ends.

2. **Subfile Management:**
   - The subfile record format is `B1SFL`, with a corresponding control record `B2CTL`. A separate display (`B2CMD`) shows command keys or instructions.
   - The program uses indicators 12, 13, 14, and 15 to manage subfile display states:
     - 12: Controls subfile display.
     - 13: Enables subfile control format.
     - 14: Clears the subfile.
     - 15: Signals subfile end (e.g., no more records to load).
   - Paging occurs in blocks of 8 records (`c_sfil = 8`). The variables `w_srrn`, `w_sfrn`, `w_ssrn`, and `w_spge` track subfile position:
     - `w_srrn`: Current subfile record number being written or read.
     - `w_sfrn`: The first record number on the subfile page.
     - `w_ssrn`: The last record number loaded into the subfile.
     - `w_spge`: The subfile page size counter (increments by 8).

3. **Domain Logic & Positioning:**
   - The program may position the subfile by code (`ra31l1_ekod`) or description (`ra31l2_etxt`), depending on user input in `b2ekod` and `b2etxt`.
   - `w_seqe` is used to remember which type of positioning (Blank for code, `B` for description).
   - Positioning is handled via `SETLL`, `READ`, and `READP` against either `RA31L1` or `RA31L2`.

4. **User Interactions:**
   - F3 (indicator *INKC) or F12 (indicator *INKL) ends the program immediately.
   - F5 (indicator *INKE) triggers the “forny” subroutine to refresh the subfile from its current position.
   - F10 (indicator *IN10) pages forward (`crt_subfile`).
   - F11 (indicator *IN11) pages backward (`bck_subfile`).
   - If the user enters a code or text to position on, the “posisjoner” subroutine uses `w_seqe` to decide whether to match by code or description, adjusting the subfile accordingly.
   - Once a row in the subfile is marked with `b1valg = 1`, the method’s code and text are stored in the parameters, and the program ends.

5. **Subroutine Structure:**
   - **clr_subfile**: Clears the subfile (indicator 14 on, writes control format once).
   - **crt_subfile**: Appends up to 8 records from either `RA31L1` or `RA31L2` into the subfile, setting subfile fields `b1ekod`, `b1etxt`, and `b1valg`.
   - **bck_subfile**: Pages backward using `READP`. It repositions the file pointer above the current set of data, reads backward to ensure the subfile can be rebuilt for the previous page.
   - **subfile**: Called after display to check if the user selected a row (`b1valg = 1`). If so, it sets the output parameters and signals completion.
   - **posisjoner**: Evaluates which key (code vs. text) to use for setll, then rebuilds the subfile from that position.
   - **forny**: Similar to positioning logic but based on the current screen record (`w_sfrn`), reloading the subfile from that point.
   - **dsp_subfile**: Handles writing or formatting the subfile control display (EXFMT on `B2CTL`), taking into account whether any records exist.

6. **Initialization & Exit:**
   - The program initializes in the *INZSR (implicit) subroutine:
     - Reads parameters into local fields (`w_firm`, etc.).
     - Positions `RA31L1` on the first record for that firm and calls `crt_subfile`.
   - On exit, it sets `*INLR = *ON`, marking the program for end of job.

## Relationships to Other Modules

- This module depends on the physical files `RA31L1` and `RA31L2` (both likely keyed by firm and either shipping code or text).  
- It renames the input records from these files (`rename(ra31pfr:ra31l1r)` / `ra31l2r`) so existing code references them as `ra31l1` and `ra31l2`.
- The user interface (screen formats `B1SFL`, `B2CTL`, `B2CMD`) is defined in a display file (`RA533D`), which must match the field references (`b1valg`, `b1ekod`, `b1etxt`, etc.).

## Notable Design Choices

- The program deliberately uses two separate physical files to allow positioning by numeric code or description. The variable `w_seqe` and the subroutines handle deciding which file to read based on user input.
- It maintains its own subfile positioning logic (page size = 8, track current/first/last records, etc.) instead of using certain built-in subfile keywords (e.g., SFLSIZ, SFLPAG) for full system-managed pagination.
- All function key actions are gathered in one `SELECT`/`WHEN` block for readability, easing the addition of future key-driven functionality.

This design allows a flexible user experience for looking up and selecting shipping methods by code or description while preserving compatibility with the existing application structure.