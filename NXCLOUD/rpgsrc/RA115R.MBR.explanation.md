# RPG Code Explanation: Program RA115R (Mengdekoder, vedlikehold)

---

## 1. Overview

This RPG program is for maintaining "mengdekoder" ("quantity codes" or similar) and associated descriptions. The program utilizes subfiles for display and maintenance, supports operations like add, change, copy, delete, and view, and interacts with several physical/logical files. The user interface is handled via workstation device files and subfile displays.

---

## 2. File Declarations

### Physical/Logical Files
```rpg
fra15l1    if   e           k disk    rename(ra15pfr:ra15l1r)
fra15l2    if   e           k disk    rename(ra15pfr:ra15l2r)
fra15lr    if   e           k disk    rename(ra15pfr:ra15lrr)
fra15lu    uf a e           k disk    rename(ra15pfr:ra15lur)
```
- Logical files over the same physical file (`ra15pfr`), each renamed for unique record formats. Used for different access paths (by code, by text, for update etc.)

### Workstation File
```rpg
fra115d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- The display file (with subfile support).

---

## 3. Data Definitions

### Local Data Area (LDA)
- Used for user (l_user), firm (l_firm), name (l_fnav).
- These are fetched from the system's LDA.

### Variables for Keys & Subfile Handling
- Variables represent keys/fields like code, description, etc., and are used for record positioning and subfile management.

### State/Flag Variables
- Single-character flags for operation control (e.g., `b_oppr` for create mode, `b_forn` for renew/reload).

### Subfile-Related Variables
- Used to control subfile display, such as counters, page size, current/first/last relative record number, and cursor position.

### Constants
- `c_sfil`: Subfile size per page.

---

## 4. Screen Images (DSPF Record Formats)

The program uses several record formats for display:
- **B1SFL**: The subfile itself (individual rows).
- **B2CTL**: The subfile's control record (header/footer/navigation).
- **B2CMD**: Command keys screen.
- **C1BLD/C1MSG**: Screens for adding a new entry and corresponding messages.
- **C2BLD**: Main maintain/view/change screen.
- **D1WIN/K1WIN**: Windows for delete/copy operations.

---

## 5. Main Program Flow

### Initial Entry
- Control starts by displaying the command screen (`b2taga` tag, `write b2cmd`).

### Main Loop (b2tagb)
1. **Display Subfile**: Calls `dsp_subfile` subroutine.
2. **Function Key Handling**:
    - F3/F12 (*inkc/*inkl): Exit program
    - F5 (*inke): Refresh (calls `forny`)
    - F6 (*inkf): Start add new (calls `xc1bld`)
    - Roll up/down (*in10/*in11): Page through subfile (calls `crt_subfile`/`bck_subfile`)
    - Home key (*in21): Place cursor
3. **Positioning**: If search fields (code or text) are filled, calls `posisjoner`.
4. **Subfile Processing**: Handles row-level actions (edit, copy, delete, view) via `subfile` subroutine.
5. **Loop**: Returns to `b2taga` to keep processing.

### Exit
- Sets LR indicator (`*inlr`) to end the program.

---

## 6. Subroutines

### Subfile Maintenance

#### `forny`
- Repositions and reloads the subfile, based on the current mode (by code or description).

#### `posisjoner`
- Positions the logical file according to search fields (by code or by description).
- Clears and fills the subfile from that position.

#### `subfile`
- Iterates through the subfile using `readc` (read changed records).
- Handles actions:
  - **2**: Edit (`xc2bld`)
  - **3**: Copy (`xk1win`)
  - **4**: Delete (`xd1win`)
  - **5**: View (`xc2bld` in view mode)
- In each case, updates the subfile row and re-displays as needed.

---

### Add/Edit/View/Delete/Copy

#### `xc1bld`
- Dialog for adding new rows.
- Validates input, checks for duplicates, and if the row exists displays an info window (`xc1msg`).
- Calls main maintain routine (`xc2bld`) for actual add/update.

#### `xc1msg`
- Dialog for "record exists" message. Lets user cancel.

#### `xc2bld`
- Main add/edit/view routine:
  - Loads existing data if present.
  - Handles copy/view mode.
  - Input validation.
  - Updates or writes to file as appropriate.
  - Updates subfile if the current operation warrants it.

#### `xd1win`
- Delete dialog and actual delete operation.

#### `xk1win`
- Copy operation dialog. Checks for duplicate key, then calls `xc2bld` to maintain the new entry.

---

### Subfile Handling

#### `clr_subfile`
- Clears the subfile, resets all counters.

#### `crt_subfile`
- Fills the subfile with the next N (e.g. 14) entries.
- Handles paging logic and field population for the subfile display.

#### `bck_subfile`
- Pages the subfile backward (previous N entries).
- Uses `readp` to read previous records.

#### `dsp_subfile`
- Displays the subfile or command window depending on state.

---

### Initialization

#### `*inzsr`
- Defines record keys (KLISTs for different access paths).
- Initializes program state from LDA and positions logical files for the initial subfile fill.

---

## 7. Indicator Usage

Indicators 10-99 have assigned roles, e.g.:
- 10: RollUp
- 11: RollDown
- 12: Display subfile
- 14: Clear subfile
- 15: End of subfile
- 30: Field protect when viewing
- 31-79: Error/display indicators
- 80-99: Work indicators

---

## 8. Comments and Documentation

- The code is well commented, with most variable/indicator usages explained in Norwegian.
- Comments explain the purpose of key subroutines, fields, and user interface screens.

---

## 9. Summary

This program provides a robust subfile-based maintenance application typical for IBM i (AS/400) environments. It abstracts all operations (add, update, search, copy, delete, view) on "mengdekoder" records with a dynamic and interactive UI. Its structure is modular, using RPG subroutines and clear indicator-based user interface/event handling.

---

### **Key takeaways for onboarding:**
- The core logic is around subfile display and record maintenance.
- File handling revolves around logical views with keys for different access paths.
- Screen navigation and user events are managed with indicators and subroutines.
- Changes are made in dialog windows/forms, with validation and user feedback.
- Subfile paging, positioning, and state handling are central.
- The naming and comments are in Norwegian, but logic is generic for IBM i subfile programs.

If you need a specific section or subroutine broken down further, please ask!