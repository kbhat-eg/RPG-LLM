# RPG Program Overview (`NK510R`)

This RPG program is for IBM i (AS/400) and is designed to present and manage "manual codes" (`manuelle koder`) using a display file with subfiles. It is primarily a maintenance/viewing screen for external order codes, showing a list and letting the user navigate, search, and select codes.

---

## High-Level Structure

- **Display File (`NK510D`)** is used for user interaction.
- **Physical File (`NKEOL1`)** is read for order code data.
- **Subfiles** are used for paging and displaying lists (records) to the user.
- **Function Keys** are clearly mapped to control navigation and other program functions.

---

## Main Sections

### 1. File Definitions

```rpg
fnkeol1    if   e           k disk    rename(nkeopfr:nkeol1r)
fnk510d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **NKEOL1**: Input (I) file, keyed (K), with external description, renamed for local naming.
- **NK510D**: Display file (workstation), uses subfile (`b1sfl`, with relative record number `w_srrn`). Uses an Information Data Structure (`dspfbk`) for feedback on the display.

---

### 2. Data Definitions

**Parameters, keys, and variables for use throughout subroutines:**

- **p_firm, p_kode, p_besk**: Parameters passed in, likely for initial selection/filtering.
- **dspfbk**: Data structure for display file feedback (e.g. cursor location).
- **nkeol1_kode**: Key field for file access.
- **w_* variables**: Working variables for subfile paging, counts, selection, etc.

#### Special Subfile Variables (from comments):

- `w_fcrn` - First record number on the page
- `w_stel` - Subfile counter
- `w_spge` - Page size in subfile
- `w_srrn` - Relative record number in subfile
- `w_sfrn` - First record number on last page
- `w_ssrn` - Last record number on last page

---

### 3. Indicators

There is a mapping of indicators (`*INnn`) to their function:
- `LR`: End of program
- `10`, `11`, ...: Function key handling, subfile control, cursor control, error/signaling, work indicators, etc.

---

### 4. Main Logic Flow

#### **Startup (*INZSR subroutine):**
- Gets parameters from *entry plist.
- Initializes the current company (`w_firm`) and subfile variables.
- Sets up the keyed list for accessing `NKEOL1`.
- Positions the file and creates the first page of the subfile.

#### **Main Loop (tagged b2taga & b2tagb):**
- Loops between displaying the subfile, accepting input, and processing function keys.
- Handles navigation (Next/Previous Page), search/positioning, and selection.
- Calls subroutines to clear, create, and display the subfile as appropriate.

#### **Function Key Handling:**
- End (F3/F12): Exit (goto avslutt)
- Refresh: Calls `forny` subroutine to refresh displayed data.
- Page Up (`*IN10`): Calls `crt_subfile` to create next page.
- Page Down (`*IN11`): Calls `bck_subfile` to go back one page.
- Home etc.: Manages cursor and screen focus.

#### **Positioning/Search:**
- If a search code or description is entered, calls `posisjoner` to reposition, rebuild subfile, and clear search fields.

#### **Subfile Handling:**
- **Reading (`subfile` subroutine)**: Reads the subfile, processes selection. If a row is selected (`b1valg = 1`), sets output parameters and signals to exit.
- **Clearing (`clr_subfile`)**: Resets indicators and subfile variables, writes control record to clear subfile display.
- **Creating (`crt_subfile`)**: Fills the subfile from `NKEOL1` records, skipping non-manual codes, handles paging and end-of-file logic.
- **Back Paging (`bck_subfile`)**: Navigates back a page, reading previous records (with readp), then repopulates the subfile for previous page.

#### **Display (`dsp_subfile`)**: Manages when to show subfile versus command screen, setting display indicators, and tracking cursor position.

---

### 5. Subroutines Explained

- **forny**: Refreshes subfile data based on current position.
- **posisjoner**: Repositions the subfile to a searched code/description and rebuilds the visible page.
- **subfile**: Reads through visible rows in the subfile, handles possible selection, and signals exit if selected.
- **clr_subfile**: Clears the subfile display and related working variables.
- **crt_subfile**: Fills the subfile (paged list) with the next set of eligible manual codes from disk.
- **bck_subfile**: Navigates the subfile one page backward in the dataset, then rebuilds the visible rows.
- **dsp_subfile**: Handles the actual display of the subfile or command screen, depending on state.
- **Initial Subroutine (`*inzsr`)**: Handles program initialization, retrieving passed parameters and preparing for first display.

---

## Key Points for a New Developer

- **Subfile Paging:** All paging and navigation are custom handled with working variables (`w_srrn`, `w_ssrn`, etc.). Updating and clearing are explicit, not automated.
- **Indicators:** Heavy use of classic RPG indicators to signal UI and program state (unlike modern free-form RPG).
- **Search/Position:** The user can search by code or description; code positions the file and resets the visible page.
- **Selection:** When a row is selected (`b1valg = 1`), parameters are set, and the program exits for possible usage by a caller.
- **Display Feedback:** Uses an information data structure to track cursor position and update the UI accordingly.
- **Exit Logic:** `*inlr` is set to on (`eval *inlr = *on`) to end the program cleanly.

---

## Summary

This program is a typical "subfile maintenance/inquiry" application for IBM i, providing paged display, search, and selection of manual order codes. It manually manages subfile records, cursor position, page navigation, and function key handling using RPG/400 idioms (pre-ILE/free-form style).

**To onboard:** Familiarity with RPG subfiles, indicators, and classic tagged logic is essential. Functionality is broken into clear subroutines for modularity. All subfile management is done explicitly, not through built-in paging or modern RPG features.