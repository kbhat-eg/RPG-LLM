```markdown
## Overview

This is an ILE RPG program named **SO500R** for the "ASOFAK" system. Its main purpose is to handle parameters for an invoice inquiry (`Faktura, spørsmål - parameter`). It manages user input from a display file, validates the input, and may call other programs to retrieve or verify information (such as order types and customer info).

---

## File Declarations

- `sohepf`, `votyl1`, `rkunl1`: These are physical files (database tables) used for data lookup. Some are renamed for local use.
  - `votyl1` is renamed to `votyl1r`.
  - `rkunl1` is renamed to `rkunl1r`.
- `so500d`: This is a display file (workstn), used for user interaction.

---

## Definitions

- **Local Data Area (LDA):**
  - `l_firm` extracts a company code from the LDA.

- **Key Variables for Lookups:**
  - `votyl1_otyp`: Holds order type for lookup, defined like field `vaotyp`.
  - `rkunl1_kund`: Holds customer number for lookup, like field `rkkund`.

- **Status and Working Variables:**
  - `b_feil`: Error flag, initialized to *off.
  - `w_dato`: Date variable (ISO format), for current date.
  - `w_dato_alf`: Alphanumeric representation of the date.
  - `w_firm`: Holds the firm code (like field `sofirm`).

---

## Main Flow

### Program Initialization (INZSR – *inzsr)

- Defines composite keys (`klist`) for file lookups on `votyl1` (order type) and `rkunl1` (customer).
- Loads the firm code from the LDA into program variable `w_firm`.

---

### Display Initialization and Main Loop

1. **Set Date:**  
   - Fetches system time into `w_dato`, moves and formats it to `w_dato_alf`, and then populates the display field `b1aarr`.

2. **Display Handling Loop:**  
   - Displays the main screen (`exfmt b1bld`).
   - Waits for user input and processes function keys:
     - If `*INKC` or `*INKL` (Cancel/Exit): Go to program end.
     - If `*INKD` (Inquiry): Branch to the inquiry subroutine (`spørring`), then redisplay the screen.

3. **Input Validation:**  
   - Runs `sjekk_input` subroutine to validate user input fields.
   - If validation fails (`b_feil = *on`): Redisplay the main screen.

4. **Call Inquiry Program:**  
   - Calls another program, `SO501R`, passing relevant parameters (`w_firm`, `b1aarr`, `b1otyp`, `b1kund`).
   - After returning, redisplays the main screen.

---

### Program End Label (`avslutt`)

- Sets LR (`*INLR`) to *on, ensuring program end and resource cleanup.
- Returns from the program.

---

## Subroutines

### 1. Inquiry Handling (`spørring`)

Allows the user to inquire about code values:
- If the current field is `B1OTYP` (order type):
  - Calls `VA550R` to help select an order type.
- If the current field is `B1KUND` (customer):
  - Calls `RK500R` to help select a customer.
- After inquiry, returns to the main display.

### 2. Input Validation (`sjekk_input`)

Ensures all required input fields are valid:
- Resets error flag and clears the customer name display.
- **Checks "Year" (`b1aarr`):**
  - If zero, sets indicator 31 and sets the error flag.
- **Checks "Order type" (`b1otyp`):**
  - If not blank, performs a database lookup on `votyl1` using key list.
  - If not found (`*IN90`), sets indicator 32 and the error flag.
- **Checks "Customer" (`b1kund`):**
  - If not zero, performs a lookup on `rkunl1` using key list.
  - If not found, sets indicator 33 and the error flag.
  - If found, fetches the customer name (`rknavn`) for display.

---

## Key Concepts and Usage

- **Display File Driven:**  
  The flow is largely driven by user input on a display screen.
- **Strong Input Validation:**  
  Every critical parameter is checked; the user is prompted to correct errors before proceeding.
- **Lookups:**  
  Order type and customer entries are checked for existence in master tables.
- **Subroutine Structure:**  
  Subroutines (`begsr` / `endsr`) encapsulate input checking and inquiry/selection logic.

---

## Commonly Used Indicators

- `*INKC`, `*INKL`, `*INKD`: Function keys (Cancel, Exit, Inquiry) from the display file.
- `*IN31`, `*IN32`, `*IN33`: Error indicators for display fields.
- `*IN90`: Used to detect failed CHAIN (record not found).
- `*INLR`: Last record; used to end the program.

---

## Additional Notes

- The code uses Norwegian field names and comments, reflecting its domain and user base.
- Error handling and user feedback are handled through both program variables and display indicators.
- The code is written in classic, fixed-form RPG IV.

---

## Summary

This program performs parameter input and validation for an invoice inquiry, verifying references against controlling tables and launching further data selection programs as needed. It illustrates standard techniques for RPG display file processing, record lookups, and modular subroutine design.
```