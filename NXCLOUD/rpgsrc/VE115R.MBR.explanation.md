# ILE RPG Program VE115R - Onboarding/Explanation

This RPG program (`VE115R`) is a classic ILE RPG application for IBM i (AS/400) platforms. It manages the maintenance (CRUD) of "item-units per price giver" (probably product and supplier/unit relations). The code leverages display files with subfiles for user interaction. Below, you will find an orientation to its structure and logic for onboarding purposes.

---

## Header and Comments

- **H-spec:**  
  ```
  h option(*nodebugio) datedit(*dmy)
  ```
  - `*nodebugio`: Excludes I/O debugging.
  - `*dmy`: Date format is day/month/year.

- **Comments:**  
  Describes program, revision history, indicator usage, subfile field meanings, and screens used.

## File Definitions (`F-spec`)

- Multiple **database files** (`DISK`) are declared, typically referencing item, unit, price, and supplier master tables. Many are renamed for this program's logic.
- The **display file** (`WORKSTN`) uses subfile (`sfile(b1sfl:w_srrn)`) for display and user interaction, with an **information data structure** (`infds(dspfbk)`) for feedback.

## Data Definitions (`D-spec`)

- **Parameters:** (`p_firm`, `p_pvar`, `p_penh`) are incoming program parameters (likely company, product, and unit codes).
- **Data Area:** For user info, function names, etc.
- **Display Feedback Data Structure:** Holds the first cursor record number (`d_fcrn`).
- **Key Variables:** Used to build access paths (chains/updates) for files, matching the keys in logicals/physicals.
- **Work variables:**  
  - `w_fcrn`, `w_stel`, `w_spge`, etc., for subfile navigation.
  - Several indicator and control fields (`b_enter`, `b_inlr`, etc.) for program and business logic.
- **Constants:**  
  - `c_sfil`: Subfile page size (in this case, 11 records per page).

## Subfile Field Meanings

Documented in comments; e.g.:
- `w_fcrn`: First record number on the page.
- `w_srrn`: Current relative record number in subfile.
- `w_spge`: Subfile page size.
- Names like `B1SFL`, `B2CTL`, `C1BLD`, etc., refer to particular display file records for different screens/forms.

---

## Main Program Logic

### Initialization (`*inzsr`)

- **Entry Parameters:** Loads `w_firm`, `w_pvar`, `w_penh` from `p_firm`, `p_pvar`, `p_penh`.
- **Populates item and unit description from master files.**
- **Positions database for subfile population**, fills subfile for initial display.

### Main Loop (Subfile Processing)

**Tags:** `b2taga`, `b2tagb`, `avslutt`, etc., represent points in program flow, much like labels in older languages.

- **Displays main subfile control screen (`b2ctl`/`b2cmd`).**
- **Invokes subfile display and interaction logic (`exsr dsp_subfile`).**
- **Processes function keys:**
  - Rollup/rolldown, add, change, copy, delete, view, and return (exit).
  - Example: `when *in10` triggers new record input.
- **Handles subfile record selection for edit/copy/delete/view based on a selection field (`b1valg`) in the subfile.**
  - For each, it sets up fields, invokes relevant display routines, and performs actions according to user input.

---

## Subroutines

### `forny` - Refresh Subfile
- **Repositions and refreshes** the subfile from the database according to cursor/record position.

### `subfile` - Subfile Row Handling
- Iterates through subfile records (`readc b1sfl`).
- **Handles selection field:**
  - `2` = edit, `3` = copy, `4` = delete, `5` = view.
- For each, sets fields, launches required subroutine, handles updating/deleting/etc.

### `xc1bld`/`xc2bld` - Add/Edit/View Forms
- Manages display files for entering/editing/viewing a row.
- Handles function keys inside the form.
- Handles duplicate key detection, calls subroutines for related messages or forms (`xc1msg`).
- **Calls validation and maintenance programs** as needed and updates database or subfile records.

### `xd1win` - Delete Row
- Presents delete confirmation screen.
- If confirmed, deletes the corresponding record.

### `xk1win` - Copy Row
- Prompts for "copy to" key, checks for duplicates, then calls edit logic.

### `clr_subfile`/`crt_subfile`/`bck_subfile`
- **`clr_subfile`:** Clears/initializes subfile and control variables.
- **`crt_subfile`:** Fills the subfile with data records, up to the page size.
- **`bck_subfile`:** Moves subfile window backward (previous page).

### `dsp_subfile` - Display Subfile
- Shows the subfile, enables control indicators, waits for user input.

### `spørring` - Inquiry Logic
- Calls helper programs to inquire about suppliers/items for lookup functionality.

### `sjekk_ean` - Validate GTIN/EAN
- Calls external program to validate entered EAN number.

---

## Indicators

- Classic RPG logic uses indicators (`*inxx`) for flags and flow:
  - `*in10-*in15`: Subfile navigation (rollup/down, clear, end, etc.).
  - `*in21-*in22`: Cursor/home key handling.
  - `*in30`: Display protection (view mode).
  - `*in31-*in32`: Error messages & duplicate key warning.
  - `*in80-*in99`: Working status indicators.

---

## Utilities and External Programs

- Calls out to other programs for validation, lookups, and maintenance:
  - `JX720R`, `JV790R`, `JX520R`, `FØ900R`, etc.
  - Parameters are passed for shared processing/validation with other modules.

---

## Error and Status Handling

- **Duplicates/Errors:**  
  Duplicate row and EAN existence is checked, appropriate messages/indicators are set, and user is prompted.

- **Status Variables:**  
  Used to convey state/results between subroutines and with display file.

---

## Summary of Flow

1. **Startup:** Initialization, parameter load, build subfile.
2. **Main Loop:**  
   - Display subfile, process user function key.
   - If record is selected, invoke edit/copy/delete/view handling.
   - Validate inputs, update/delete records as needed.
   - Loop until user exits.
3. **Subroutines:**  
   - Support modular handling for each maintenance function.
   - Handle page up/down, clear/fill subfile.
   - Validate external values (e.g., EAN/GTIN numbers).

---

## Key Takeaways for Onboarding

- **Subfile-centric design:**  
  All user interaction is via subfiles, for fast list/row access and maintenance.
- **Classic indicator-based RPG logic:**  
  Understand flow control is mostly by indicator, not structured logic.
- **Screen modularity:**  
  Each main action (add, edit, copy, delete, view) has a dedicated subroutine and display record.
- **External calls:**  
  Interactions are partly handled by calling other programs for specialized tasks (e.g., EAN validation, lookup).
- **Keys and data access:**  
  Know key lists and how database access (CHAIN, SETLL, SETGT, READP) ties into subfile logic.

---

**If you are new to this codebase:**
- Study the subfile flows (`crt_subfile`, `subfile`, `xc1bld`, `xc2bld`).
- Pay attention to indicator management.
- Review how error/status is handled via indicators and messages.
- Cross-reference display file (`VE115D`) DDS for understanding screen layouts and field mapping.
- Familiarize yourself with external programs called for validation and supplementary data.

---

This style of RPG may appear procedural and indicator-heavy compared to modern languages, but it is organized for modular, maintainable "green screen" CRUD operations using IBM i best practices.