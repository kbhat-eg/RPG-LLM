# Program Documentation: RK691R – Selection of Entries for General Invoice Note

## Overview

**Program Name:** RK691R  
**System:** ASOKON  
**Description:**  
This program selects customer ledger entries to be included on a general invoice note ("generalnota"). It supports both processing for a single customer and for all customers, with a variety of business rules for filtering transactions. The output is written to a work file for subsequent processing.

## Business Domain Context

- **General Invoice Note (Generalnota):** A consolidated invoice or statement sent to customers, typically aggregating several transactions.
- **Customers:** Identified by firm and customer number.
- **Transactions:** Filtered based on payment terms, due dates, and other business-specific criteria.
- **Tracking Fields:** The program includes auditing and tracking fields for traceability.

## File Usage

| File      | Type | Access | Keyed | Description / Notes                          |
|-----------|------|--------|-------|----------------------------------------------|
| rkunl1    | IF   | Disk   | Yes   | Customer register (main)                     |
| rkunlr    | IF   | Disk   | Yes   | Customer register (single customer, V5.50+)  |
| rkunlu    | UF   | Disk   | Yes   | Customer update file                         |
| rktrl2    | IF   | Disk   | Yes   | Customer transactions                        |
| rkw2pf    | O    | Disk   | Yes   | Output work file for selected transactions    |

*Note: Files are renamed to local record formats for clarity.*

## Key Data Structures

### Work Sort Key (`wksort`)

A packed data structure used as a composite key for output records, overlaying fields for firm, customer, date, and an internal counter.

### Local Variables

- `w_firm`, `wksfir`: Current firm number.
- `w_nbel`: Accumulated transaction amount for the customer.
- `l_user`, `l_firm`, `l_fnav`: User and firm context from user space.
- Date fields: `wwfdat`, `wnfdat`, etc., all using ISO date format.

### Selection Parameters

- `ppknf`: Customer number for single-customer processing (if non-zero).
- `pbetb`, `pbtyp`, `pforf`: Flags controlling payment methods and selection criteria.
- `pbdat`, `praar`, `prper`: Date and period parameters.

## Indicator Usage Convention

- **KA, KC:** Function keys (firm selection, exit).
- **LR:** End-of-program.
- **30:** Field protection on display.
- **31–59:** Error/warning indicators.
- **60–69:** File access (chain, etc.).
- **70–89:** Work indicators.
- **90–99:** Standard subroutine indicators.

## Processing Logic

### Initialization (`*inzsr`)

- Sets initial values for key variables and dates.
- Determines default payment terms if not provided.
- Initializes keyed lists for file access.

### Main Selection Logic

#### Single Customer

- If `ppknf` (customer number) is provided, process only that customer.
- Chain to `rkunlr` (single customer file). If not found, exit.
- Validate payment method (`rkbetm` must be 3 or 4).
- Call subroutine `beh_kunde` to process customer and their transactions.

#### All Customers

- Loop through all customers in `rkunl1`.
- For each, check payment method as above.
- Call `beh_kunde` for each qualifying customer.

### Customer Processing Subroutine (`beh_kunde`)

- Calculates due date based on customer's payment terms (calls `xforf` if needed).
- Processes all transactions for the customer (`les_trans`).
- Updates the customer record in `rkunlu` to flag inclusion on the general note.  
  - Sets `rksamm` to 'S' if there are no qualifying transactions.
  - Updates tracking fields for auditing (e.g., signature, program, timestamp).

### Transaction Processing Subroutine (`les_trans`)

For each transaction (`rktrl2`):

- Exclude if already included on a general note (`rnsamf`).
- Exclude if outside the accounting period (`praar`, `prper`).
- Exclude if marked as a complaint (`rnrekl`).
- Exclude if it is a balance record (`rnbilk = 98`).
- If only invoices/credit notes should be included (`pbtyp = 'J'`), filter by type (`rnbilk = 01` or `03`).
- Exclude if already partially settled (`rnbelø <> rnrest`).
- If only overdue items should be included (`pforf = 'J'`), compare due date to the reference date.
- Accumulate transaction amount.
- Write transaction to output file (`rkw2pf`) if amount is non-zero.

### Due Date Calculation Subroutine (`xforf`)

- Calls external program `RS203R` to calculate due date based on payment terms.
- Populates `wwfdat` with the resulting due date.

## Notable Design Decisions & Conventions

- **Overlayed Data Structures:** Used for efficient key management and output record construction.
- **File Naming & Renaming:** Files are renamed locally for clarity and to avoid naming conflicts.
- **Indicator Usage:** Strict conventions for indicator assignment to avoid overlap and confusion.
- **Separation of Concerns:** Main logic, customer processing, transaction processing, and due date calculation are clearly separated into subroutines.
- **External Call for Payment Terms:** Due date logic is centralized in an external program (`RS203R`), promoting reuse and consistency.

## Interactions with Other Modules

- **RS203R:** External program for payment term logic.
- **Customer Master & Transaction Files:** Reads and updates customer and transaction records as part of the selection and output process.

## Error Handling & Exit Conditions

- If a customer or transaction record is not found, or does not meet criteria, processing skips or exits gracefully.
- Indicators are used for file operation status and flow control.

## Auditing & Tracking

- Updates to customer records include user, program, and timestamp fields for audit trail (fields such as `rkepgm`, `rkesig`, `rk2dpt`).

## Maintenance Notes

- Business logic for selection is tightly coupled to field values (e.g., payment method codes, transaction type codes).
- If new payment types or transaction types are added, update the selection logic accordingly.
- The output work file (`rkw2pf`) is the interface for downstream processes.

---

**For further questions on business rules or integration points, refer to the system documentation or contact the functional lead for the ASOKON system.**