# VG805R – Cost Transaction Update Program Documentation

## Overview

`VG805R` is a core batch program in the **ASLAGR** system responsible for updating cost transactions (kosttransaksjoner) to the general ledger (hovedbok) based on shop order lines (“bonglinje”, i.e., POS receipts). It posts cost and counter entries for inventory items, ensures correct account references, and logs all postings for traceability.

The program is tightly coupled to the domain’s order, inventory, and finance modules. It handles business logic for cost price calculation, including conversion for sales in units differing from the inventory unit, and it enforces several company-specific conventions for account references and logging.

---

## File Dependencies

- **Input/Reference Files:**
  - `bohel1`: Order header (bonghode)
  - `bodtl1`: Order line (bonglinje)
  - `fstsl1`: Status codes
  - `vgkkir`: Cost parameters
  - `vkhvl1`: Account references
  - `vvarlr`: Item master (varer)
  - `vvenlr`: Item unit conversion (varer/enhet, from v8.02)

- **Output File:**
  - `bovfpf`: General ledger postings (hovedboksposteringer)

- **External Programs:**
  - `VG701R`: Calculates moving average cost price
  - `AS100R`: Fetches next document number from number register
  - `VA720R`: Resolves account references for posting

- **Logging Table:**
  - `rlodst`: SQL table for posting logs

---

## Core Processing Flow

### 1. Initialization

- **Parameters:** Receives order (year, workstation, receipt, line), logging info, and posting date.
- **Firm Code:** Retrieved from LDA (Local Data Area).
- **Key Lists:** Defined for efficient indexed access to all major files.

### 2. Status and Parameter Retrieval

- **Order Status:** Fetched from `fstsl1` to determine if posting is required.
- **Cost Parameters:** Loaded from `vgkkir`.

### 3. Posting Decision

- If posting is not required (`vgkrgn` ≠ 'J'), the program exits.
- Otherwise, it retrieves the next available voucher number via the `hntnum` subroutine (calls `AS100R`).

### 4. Order and Line Validation

- **Order Header:** Loaded from `bohel1`. If not found, the program exits.
- **Account Reference:** Default (standard) account reference fetched from `vkhvl1` using code from cost parameters.
- **Order Line:** Loaded from `bodtl1`. If not found, the program exits.

### 5. Item Validation

- **Inventory Item Check:** Only lines for inventory items (`vvarlr` found and `vvvtyp = 'L'`) are processed.

### 6. Account Reference Resolution

- **Account Reference:** `hntkon` subroutine (calls `VA720R`) resolves the correct account reference for the line, with possible override by order header department.

### 7. Cost Price Calculation

- **Base Cost:** Retrieved by calling `VG701R` (moving average cost for item/location/date).
- **Zero Cost:** If no cost price is found, the program exits.

#### 7.1. Unit Conversion (v8.02+)

- If the sales unit (`bdenh1`) differs from the inventory unit (`vvenhl`), the `beregn_kost` subroutine recalculates the cost using conversion factors from `vvenlr`:
  - Converts cost from base (inventory) unit to sales unit and vice versa as needed.

### 8. Posting Amount Calculation

- **Cost Amount (`w_belp`):** Calculated as cost price × quantity.

### 9. General Ledger Posting

- **Cost Entry:** Posts the cost to the designated cost account.
- **Counter Entry:** Posts the counter (offset) to the appropriate account.
- Both entries are written to `bovfpf` via the `skriv_post` subroutine.

### 10. Logging

- Each posting is logged to the `rlodst` SQL table (`logg_linjer` subroutine), providing a detailed audit trail.

---

## Key Subroutines

### `skriv_post`

Handles creation and writing of a single general ledger posting. Sets all relevant fields, assigns account references based on the sign of the amount, and writes to `bovfpf`. After each posting, triggers logging via `logg_linjer`.

### `logg_linjer` (v8.01+)

Logs the posting details to the `rlodst` SQL table for traceability. This includes all transaction metadata, linking the posting to source order and line.

### `beregn_kost` (v8.02+)

Handles cost price conversion if the sales unit differs from the inventory unit:
- Looks up conversion factors in `vvenlr` for both sales and inventory units.
- Adjusts the cost price accordingly.

### `hntnum`

Fetches the next available voucher number for posting via the external program `AS100R`.

### `hntkon`

Resolves the account reference for the posting line by calling `VA720R`. Applies department override from the order header if present.

---

## Notable Design Conventions

- **Overlayed Data Structures:** Used for account references (`d_hele`) to allow passing/receiving all account segments as a single block.
- **Separation of Posting and Logging:** Business logic is strictly separated from audit logging for maintainability.
- **Unit Conversion Logic:** Cost price calculations are robust against unit-of-measure mismatches between sales and inventory.
- **Key Lists:** All file accesses are via explicit key lists for performance and clarity.
- **Exit-on-Error:** The program exits immediately if any critical validation fails (e.g., missing records, zero cost).

---

## Business/Domain-Specific Logic

- **Posting Only Inventory Items:** Only lines with item type 'L' (lager, inventory) are posted to the general ledger.
- **Account Reference Hierarchy:** Line-level references are resolved, but can be overridden by order header department.
- **Moving Average Cost:** All postings use the moving average cost as determined by `VG701R`.
- **Audit Logging:** All postings are logged to `rlodst` for compliance and traceability.
- **Voucher Number Management:** Voucher numbers are centrally managed and fetched per posting.

---

## Interactions with Other Modules

- **Inventory Module:** Reads item master and unit conversion tables.
- **Order Management:** Reads order header and line details.
- **Finance:** Writes to the general ledger and logs all postings.
- **External Programs:** Interfaces with cost calculation (`VG701R`), account reference resolution (`VA720R`), and voucher number assignment (`AS100R`).

---

## Version History Highlights

- **v8.01:** Added logging of cost postings to `RLOG` (now `rlodst`).
- **v8.02:** Added unit conversion logic for sales in non-inventory units.

---

## Summary

`VG805R` is a central, business-critical program for ensuring that inventory cost postings are accurate, auditable, and robust against data inconsistencies. It is designed for high reliability and traceability, with clear separation between business logic, validation, and logging/audit requirements. Understanding this program is essential for any developer working with order, inventory, or finance integration in the ASLAGR system.