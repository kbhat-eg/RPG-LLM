# RPG Program MM120R Explanation

This ILE RPG program (`MM120R`) runs on IBM i (AS/400). Its main purpose is to display and maintain forecast records with significant deviations in order quantity ("Prognose - viste større avvik på best.mengde"). It makes heavy use of subfiles for interactive display and update.

Below you'll find explanations for the major components and logic in the program, focusing on making it easy for new developers to onboard and understand.

---

## 1. Header and Documentation

- `h option(*nodebugio) datedit(*dmy)`
  - Runs the program with *NODEBUGIO (improves performance for some display/file operations).
  - Dates are edited using day/month/year (`*dmy`) format.

- In-code comments (in Norwegian) describe:
  - Change history,
  - Screen indicator usage,
  - Subroutine purposes,
  - Field explanations.

---

## 2. File Declarations

```rpg
fmpral1    if   e           k disk    rename(mprapfr:mpral1r)
fmpralr    if   e           k disk    rename(mprapfr:mpralrr)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fmpralu    uf a e           k disk    rename(mprapfr:mpralur)
fMM120d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- Four database files are defined (`mpral1`, `mpralr`, `vvarl1`, `mpralu`), all referring to physical files using alternate record formats.
- `MM120d` is the display file, containing subfile `b1sfl`, with display feedback area `dspfbk`.

---

## 3. Data Structures & Variables

### a. Local Data Area
- Imported via `*LDA`, accessed with named subfields for user, company, etc.

### b. Display Feedback Data Structure
- `dspfbk` with subfield `d_fcrn`, used to track current record number.

### c. Key and Work Variables
- Multiple variables (`mpral1_vare`, `mpralr_vare`, `w_fcrn`, etc.) used for key values, paging, and subfile navigation.

### d. Indicator Usage
- Indicators are named and documented for various purposes: screen controls (subfile clear, subfile display, etc.), error states, input protection, navigation, and temporary flags.

---

## 4. Main Program Flow

### a. Initialization - `*inzsr`
- *Key lists* are defined for use in chained/read operations.
- The user's company (firm) is pulled from the LDA.
- Sets up a blank key for main forecast file, positions at the start, and fills initial subfile.

### b. Main Loop (`b2taga`, `b2tagb`)
- The main program uses tags and GOTOs for navigation.
- `exsr dsp_subfile` displays the subfile.
- Input indicators dictate the function being performed (`forny` = refresh, `crt_subfile` = scroll forward, `bck_subfile` = scroll backward, etc.).
- Handles function keys for position (F21), navigation (F10/F11), and program exit.

---

## 5. Subroutines

### a. `forny` (Refresh subfile)
- If a record is already displayed, re-position to it and refresh the subfile content.

### b. `posisjoner` (Position in subfile)
- Used to position to a specific item (`vare`) using the given key, then blanks and refills the subfile for that position.

### c. `subfile` (Process subfile)
- Handles interactive processing of subfile entries:
  - Loops through display records (`readc`).
  - Handles specific user actions (e.g., option 5 to view, 8 to call another program).
  - If subfile needs refresh, calls `forny`.

### d. `xc2bld` (Handle single record display/update)
- Fetches full details for a selected item if it exists, otherwise blanks the fields.
- Displays detailed maintenance screen (`c2bld`).
- Protects fields if only viewing (option 5).
- Exits on cancellation or exit keys.

### e. `clr_subfile` (Clear subfile)
- Issues the subfile clear indicator and writes the control record to clear the display.
- Resets paging counters.

### f. `crt_subfile` (Fill subfile)
- Fills subfile page-by-page up to a defined limit (`c_sfil` entries at a time).
- Reads from forecast file and writes subfile records.
- Fetches product description (`navn`) from `vvarl1` for display.

### g. `bck_subfile` (Scroll back one page)
- Backs up in the file, skipping previous entries for one page, then refreshes subfile.

### h. `dsp_subfile` (Display subfile)
- Displays the subfile (and control screen if empty), then updates record number tracking.

---

## 6. Navigation & Processing Logic

- Uses RPG in-line indicators and direct file manipulation for interactive subfile I/O.
- Relies on a combination of tags, indicators, and subroutines for managing logical flow—common style in classic RPG/400 and early ILE RPG.

---

## 7. Subfile & Paging Concepts

- **Subfiles** allow for "paged" working with many records, only a page is shown at any time.
- Variables like `w_srrn`, `w_ssrn`, and `w_spge` control the current page and position.
- Functions like "page up/page down" are mapped to function key indicators and direct subroutine calls.

---

## 8. Display Details

- **Screen Layouts**: Multiple screens are used, including subfile list, control panels, pop-up windows for maintenance, and messaging.
- **Protection Indicators**: Used to set fields read-only as needed (e.g., when only viewing, not editing).

---

## 9. File and Key Management

- **Key lists** (`klist`, `kfld`) are defined for multiple files—enabling easy `CHAIN`, `SETLL`, and `READ` operations using composite keys.

---

## 10. Error Handling and Exit

- Uses standard RPG last record indicator (`*INLR`) at exit.
- Returns immediately on escape/exit/cancel keypresses.

---

## Summary

- **Purpose**: Handles display and update of forecast records with significant deviations.
- **User Interface**: Classic green-screen, subfile-driven with function key navigation.
- **Technical**: RPG, record-level access, LDA for session data, heavy use of indicators and subroutines.
- **Paging**: Subfile logic for listing/navigating large record sets.
- **Maintenance**: Options for viewing, updating, and calling out to related maintenance functions.

**For onboarding:**  
- Understand subfile processing in RPG (paging, `readc`, `write`, etc.).
- Study the indicator usage in the context of the display file DDS.
- Familiarize yourself with the key structures for the physical files used.
- Recognize that much of the code follows classic (pre-free format) RPG conventions.

---

If you need practical, line-by-line walkthroughs or have specific questions about a subroutine or logic section, just ask!