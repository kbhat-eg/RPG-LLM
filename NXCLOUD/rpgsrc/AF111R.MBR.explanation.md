## Program Overview

This RPG IV (ILE RPG) program, named `AF111R`, is a maintenance/log viewer for FTP log lines. It has extensive use of subfiles for presenting multiple lines and handling page-up/page-down, and other screen navigation features. The program is modularized into subroutines for common subfile operations (fill, clear, display, page forward/back, etc.), and uses physical files for its data.

### File Declarations

```rpg
faftll1    if   e           k disk    rename(aftlpfr:aftll1r)
fafthlr    if   e           k disk    rename(afthpfr:afthlrr)
faf111d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **`aftll1`** and **`afthlr`**: Disk files, likely containing FTP log lines and FTP header info (renamed from physical files).
- **`af111d`**: Workstation (display) file, using a subfile (SFL) `b1sfl` with relative record number `w_srrn`. Uses an information data structure for display feedback.

### Data Structures and Variables

#### Local Data Area Extraction
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- These fields are extracted from the User Data Structure (LDA), which typically holds session/user context like user, company, etc.

#### Display Feedback Structure
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- `d_fcrn`: Used for reading cursor location from the display file.

#### Key and Variable Definitions
Variables like `aftll1_navn`, `aftll1_uidn`, etc., contain keys used to identify records in the log line and header files. 
- Many working variables are used for subfile management: `w_fcrn`, `w_stel`, `w_spge`, etc.
- Control flags (`b_oppr`, `b_forn`, `b_anul`, `b_feil`) are used to manage program logic.

#### Constants & Subfile Explanation

`c_sfil` (value: 14) defines subfile page size.
The comments extensively document the purpose of each subfile variable.

### Program Flow

#### Initialization (`*inzsr`)
- Receives parameters (`p_navn`, `p_uidn`).
- Builds keys for header and line log files.
- Sets up initial context (`w_firm`, screen fields, etc.).
- Positions cursor and populates initial subfile content using `crt_subfile`.

#### Main Loop (label `b2taga`)
1. **Display command screen** (`write b2cmd`).
2. **Display subfile** (`exsr dsp_subfile`).
3. **Process function keys** via a SELECT statement:
   - Exit on certain keys.
   - Refresh/update list, move page up/down, home key, etc.
   - For each, invoke appropriate subroutine (`forny`, `crt_subfile`, `bck_subfile`, etc.).
4. **Subfile interaction** (`exsr subfile`): Handles browsing the subfile, processing selection, updating cursor and subfile position.
5. **Return to loop** (go to `b2taga`) unless exiting.

#### Function Key Handling

Uses function key indicators (`*inkc`, etc.) for navigation:
- `*inkc`, `*inkl`: Exit.
- `*inke`: Refresh (`forny`).
- `*inkg` / `*inkh`: Horizontal scroll left/right.
- `*in10` / `*in11`: Page down/up.
- `*in21`: Home key (move cursor).
- Various indicators handle special cases.

#### Subfile Subroutines

- **forny**: Refreshes the subfile display based on the current position.
- **subfile**: Processes selection rows in the subfile (reading user input, selection, possible delete action).
- **clr_subfile**: Clears all subfile records and resets counters/indicators.
- **crt_subfile**: Loads a "page" of subfile data, writing records up to the page size or end of file.
- **bck_subfile**: Pages backward, reading previous page's records into the subfile.
- **dsp_subfile**: Displays the subfile or command screen depending on state.

### Comments and Indicators

The program uses indicators (`*INxx`) extensively for control:
- Indicators 10-15, 21-22, 30, and 31-99 are flagged for specific UI/logic use.
- Comments in Norwegian explain indicator use, variable purposes, and routines.

### Subfile Logic

- **Paging (Next/Previous)**: Uses a combination of subfile relative record numbers, file positioning (`setll`, `reade`, `readpe`) and counters to load/display the correct slice of records.
- **Cursor positioning**: Managed via display feedback data structure (`dspfbk`).
- **Refresh (F5?)**: Forces redisplay and data reload, maintaining current selection if possible.

### Summary Table of Main Subroutines

| Subroutine      | Description                                                  |
|-----------------|-------------------------------------------------------------|
| `forny`         | Refreshes/redraws subfile content from the current key      |
| `subfile`       | Processes user-selected subfile rows (read, possibly delete)|
| `clr_subfile`   | Clears (empties) the subfile area on the display            |
| `crt_subfile`   | Loads and writes the next page of subfile records           |
| `bck_subfile`   | Loads/positions for the previous page of subfile records    |
| `dsp_subfile`   | Displays the subfile or command screen, depending on state  |
| `*inzsr`        | Initialization: sets up keys, context, and first subfile    |

---

## Onboarding Notes

- **Subfile Paging**: Understanding `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, and related variables is essential. They track record number and page positions within the subfile.
- **Indicators**: They're central for logic flowâ€”study how each one is used and referenced.
- **File Structure**: You need to know the structure of `aftll1` and `afthlr` files, and what fields like `adlnav`, `adluid`, etc. mean.
- **Display file (`af111d`)**: Subfiles (SFLs) `b1sfl`, control records, etc., are critical for UI.
- **Language**: Comments are in Norwegian; be mindful of variable names and comments for context.

### Key Takeaway
This program is typical for IBM i green-screen applications: it manages and displays database-backed logs in a paginated, interactive subfile format on a 5250 terminal. All subfile, paging, function-key, and cursor logic is handled in RPG, using global indicators and local flag variables. The structure is highly modular, and new maintainers should familiarize themselves with the subfile workflow and indicator assignments.