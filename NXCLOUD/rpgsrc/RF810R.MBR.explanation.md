# RF810R – Card Transactions Export to File (Parameter Driven)

## Overview

**Program:** RF810R  
**System:** ASKORT  
**Purpose:**  
RF810R is the entry point for exporting card transactions to a file, driven by user input parameters. It supports several card types (such as Maxbo, Santander, BM Kort, and NBBL Fordelskort), with logic to validate, select, and process the export for each. The program interacts with card master files, updates transaction logs, and delegates the actual export to specialized subprograms.

## Key Concepts and Business Logic

- **Card Types Supported:**  
  The program handles several card types (IDs 3–6), each mapped to a specific export process.
- **Lager (Warehouse) Selection:**  
  The user can select a warehouse for the export; logic exists to handle multiple warehouses per card type.
- **Export Delegation:**  
  Actual export is performed by specialized programs (RF811C, RF812C, RF813C, RF814C), called with a parameter list.
- **Transaction Logging:**  
  After a successful export, the card register is updated to log the export date, time, and user.
- **Concurrency Check:**  
  The program checks if an export is already in progress or previously failed for the card type, preventing overlap.

## File and Display Definitions

- **Physical Files:**
  - `rukslr` (card master, read): Card type and warehouse master.
  - `rukslu` (card master, update): For updating the card export log.
- **Display File:**  
  - `rf810d`: Workstation display for user interaction.

## Data Structures

- **LDA (Local Data Area):**  
  Used to retrieve the current user (`l_user`) and firm (`l_firm`).
- **Parameter List (`d_list`):**  
  Structure passed to export subprograms, containing card type, date range, warehouse, description, etc.

## Main Program Flow

### 1. **Initialization (`*inzsr`):**

- Populates keys for file access.
- Retrieves firm number from LDA.
- Initializes screen texts for card types.
- If called with a card type parameter, pre-selects it and updates display text.

### 2. **Main Screen Handling (`b1taga`):**

- Presents the main screen (`exfmt b1bld`).
- Handles function keys:
  - Exit (`*inkc`, `*inkl`): Ends the program.
  - Inquiry (`*inkd`): Triggers the `spørring` subroutine for lookups.
- Validates user input (`sjekk_input`).
- If valid, chains to the card master to retrieve card-specific information.
- Sets up the parameter list for export.
- Delegates processing to the correct export program based on card type, passing the parameter list and a card identifier.
- After export, updates the card register (`upd_kort`).

### 3. **Input Validation (`sjekk_input`):**

- Ensures selected card type is within the valid range (3–6).
- Optionally checks for multiple warehouse occurrences for some card types (logic now commented out per v6.12).
- Validates date fields for correct format and logical consistency (from-date ≤ to-date).
- Ensures only one export is running for the selected card type via a status check (`AF712R`).
- Validates the "omkjøring" (rerun) flag.

### 4. **Inquiry Handling (`spørring`):**

- Supports lookups for card type (`B1KORT`) and warehouse (`B1LAGE`), using program `RA532R`.
- Updates display fields and selection variables based on lookup results.

### 5. **Card Register Update (`upd_kort`):**

- After export, updates the card register (`rukslu`) with the export date, time, user, and card identifier.

### 6. **Supporting Routines:**

- **`init_txt` / `kort_txt`:**  
  Populate display texts for card types and set display fields accordingly.
- **`sjekk_kort`:**  
  Checks existence of selected card type/warehouse in the master file. (Logic for handling multiple occurrences is now bypassed per v6.12.)

## Noteworthy Design and Conventions

- **Card Type Handling:**  
  Card types are hardcoded (IDs 3–6) and mapped to both display texts and export subprograms. The convention is consistent across the codebase.
- **Parameter Passing:**  
  Export subprograms are called with a single parameter list (`d_list`) and a card identifier, facilitating extensibility.
- **Concurrency Control:**  
  Uses a dedicated status-checking program (`AF712R`) to prevent overlapping exports for the same card type.
- **Screen Interaction:**  
  Uses display file indicators for error feedback and function key handling.
- **Commented Code:**  
  Several lines are commented out (with `**`), reflecting business rule changes over time (notably, warehouse selection and multi-occurrence logic).

## External Program Interactions

- **Export Subprograms:**  
  - `RF811C`: Maxbo Kort (DNB NOR)
  - `RF812C`: Santander (formerly GE Moneybank)
  - `RF813C`: NBBL Fordelskort
  - `RF814C`: BM Kort (DNB NOR)
- **Card Type/Warehouse Lookup:**  
  - `RA532R`: Used for display-based lookups of card types and warehouse codes.
- **Export Status Check:**  
  - `AF712R`: Ensures no concurrent or failed exports are in progress for the selected card type.

## Special Notes

- **Versioned Change Comments:**  
  The code includes inline versioned comments (e.g., `6.10`, `6.12`, `8.00`) to document business rule changes, such as the removal of multi-occurrence checks and the renaming of card types.
- **Localization:**  
  Variable names and comments are in Norwegian, reflecting business terminology (e.g., "kort" = card, "lager" = warehouse, "omkjøring" = rerun).
- **Error Handling:**  
  Error indicators are set for display fields to prompt the user to correct input.

## Key Variables and Data Structures

- `b1kort`, `b1lage`: Card type and warehouse selected by the user.
- `w_fdat`, `w_tdat`: From and to dates for export.
- `d_list`: Parameter structure for export subprograms.
- `rukslr`, `rukslu`: Card master and update files.
- `b_feil`, `b_kort`: Flags for input and card existence errors.

## Summary

RF810R is a parameter-driven front-end for exporting card transactions, designed to handle multiple card types and warehouses. It validates user input, delegates the export to specialized programs, updates the card register, and prevents concurrent exports. The program is tightly integrated with the card master files and uses external programs for lookups and status checks, following business rules that have evolved over time.