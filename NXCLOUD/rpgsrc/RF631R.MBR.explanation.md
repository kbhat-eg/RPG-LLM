# RF631R – Contact Person Report (Felles, utskrift kontaktperson - rapport)

## Overview

This RPG program generates a report of contact persons (kontaktpersoner) associated with customers (kunder) and suppliers (leverandører). The report can be filtered and produced in three modes:

- **Customer contacts only**
- **Supplier contacts only**
- **All contacts (alphabetically)**

The program is part of the ASOKON system and is used as a common (felles) utility for printing contact person data, with filtering options based on a variety of customer/supplier attributes.

## File Usage and Relationships

### Physical and Logical Files

The program accesses several files, each renamed for local usage:

- **rkunl1 / rkunlr**: Customer master data (rkunpfr)
- **rlevl1 / rlevlr**: Supplier master data (rlevpfr)
- **rukpl5 / rukpl6 / rukpl7**: Contact person data (rukppfr), with different logical views:
    - rukpl5: Alphabetic index
    - rukpl6: By customer
    - rukpl7: By supplier

**Printer file:**  
- **frf631p**: Output printer file. Uses indicator *IN30 for overflow handling.

## Data Structures and Parameters

### Date Handling

- `w_tdat`, `w_taar`, `w_tmnd`, `w_tdag`: Date fields for report date, with overlays for year, month, and day.
- `w_xdat`: ISO date format, used for date logic.

### Parameter Structure

A large unnamed data structure (`uds`) is used for input parameters, including:

- Customer/supplier number ranges
- Department, category, seller, district ranges
- Mode selection: `pkund` (customer), `plevr` (supplier)
- Other fields: `palle` (alphanumeric), user info, firm code, etc.

### Key Variables

Variables for constructing keys for file access are declared for each file, matching the key fields of the logical files.

## Indicator Usage Conventions

The codebase uses specific indicator ranges for consistent logic:

- 01–19: Not used here
- 30: Protect fields on display / print heading
- 31–59: Error/warning indicators
- 60–69: File indicators (CHAIN, SETLL, READE, etc.)
- 70–79: Subroutine work indicators
- 80–89: General work indicators
- 90–99: Standard subroutine indicators

## Main Program Flow

### Initialization (`*INZSR`)

- Determines report mode based on parameter fields (`pkund`, `plevr`).
    - Sets indicator *IN80 for customer mode, *IN81 for supplier mode, *IN82 for all contacts.
- Builds key lists for all files and sets initial positions using SETLL.
- Prints report header(s) and filter information, depending on selected mode and parameters.

### Main Selection Logic

A `SELECT` block controls which subroutine is invoked:

- **`les_kunde`**: Process customer contacts if *IN80 is on.
- **`les_lever`**: Process supplier contacts if *IN81 is on.
- **`les_alle`**: Process all contacts if neither of the above.

### Subroutines

#### `les_kunde` (Customer Contact Processing)

- Reads through the customer master (`rkunl1`).
- Applies filters for:
    - Customer number range
    - Department
    - Category
    - Seller
    - District
- For each selected customer, checks for associated contacts in `rukpl6`.
- For each contact:
    - If the contact is also linked to a supplier, fetches supplier name from `rlevlr`.
    - Formats and writes contact information to the report.
- Handles heading printing and page overflow via *IN30.

#### `les_lever` (Supplier Contact Processing)

- Similar logic to `les_kunde`, but operates on suppliers (`rlevl1`) and their contacts (`rukpl7`).
- Filters on supplier number, department, category, and district.
- For each contact, checks if linked to a customer and fetches customer name if so.

#### `les_alle` (All Contacts, Alphabetical)

- Reads all contacts from `rukpl5` (alphabetical index).
- For each contact:
    - If linked to a customer, fetches customer name.
    - If linked to a supplier, fetches supplier name.
- Handles page overflow: prints heading every 4 contacts.
- Writes contact info to the report.

## Notable Design Patterns and Conventions

- **Separation by Mode:** The code is modularized by report mode, with separate subroutines for customer, supplier, and all-contact listings.
- **File Indicator Handling:** Uses standard indicator blocks for file I/O and error handling, consistent with legacy RPG conventions.
- **Dynamic Heading:** The report headings and filter descriptions are dynamically printed based on supplied parameters.
- **Key List Usage:** Key lists are defined for all file accesses, promoting maintainability and clarity in file operations.
- **Overlay and Data Structure Usage:** For compact parameter passing and date handling, overlays and unnamed data structures are used extensively.
- **Domain-Specific Filtering:** Business logic for filtering entities is tightly coupled to the report’s filtering requirements, reflecting common patterns in master data reporting.

## Business/Domain-Specific Logic

- **Kontaktperson:** The core business object is the contact person, which can be related to either a customer or a supplier (or both).
- **Filtering:** The report allows users to restrict the output to specific number ranges, departments, categories, sellers, or districts, reflecting common business reporting needs.
- **Cross-Reference:** When a contact is linked to both a customer and a supplier, the program fetches and displays cross-referenced names to provide context in the output.

## Integration Points

- **Master Data Files:** The program is tightly integrated with the customer and supplier master files, as well as the contact person files, which are likely maintained elsewhere in the system.
- **Printer File:** Output is sent to a printer file defined specifically for this report.

## Special Considerations

- **Legacy RPG/400 Style:** The program uses fixed-format RPG with indicators and overlays, reflecting legacy codebase conventions.
- **Norwegian Comments and Field Names:** Comments and many field names are in Norwegian; understanding of business vocabulary (kunde = customer, leverandør = supplier, kontaktperson = contact person) is assumed.
- **Indicator Management:** Proper management of indicators is critical for correct file I/O and report formatting, especially with page overflow and conditional headings.

## Maintenance Notes

- **Adding Filters:** To add new filters, extend the parameter structure and add additional logic to the relevant subroutine’s filter section.
- **File Layout Changes:** Any changes to master file layouts (e.g., key fields, field names) require updates to key lists and variable declarations.
- **Printer File Format:** If the report layout changes, update the printer file definition and the corresponding WRITE statements.

## Summary Table of Key Subroutines and Files

| Subroutine   | Purpose                  | Main Files Accessed           | Filters Applied                          |
|--------------|--------------------------|-------------------------------|------------------------------------------|
| les_kunde    | Customer contacts        | rkunl1, rukpl6, rlevlr        | Customer no., dept., cat., seller, dist. |
| les_lever    | Supplier contacts        | rlevl1, rukpl7, rkunlr        | Supplier no., dept., cat., dist.         |
| les_alle     | All contacts (alphabetic)| rukpl5, rkunlr, rlevlr        | None (all contacts)                      |

---

**In summary:**  
This program provides a flexible, parameter-driven report of contact persons in the ASOKON system, supporting both customer and supplier perspectives, with robust filtering and cross-referencing logic. The code adheres to established RPG/400 conventions and is designed for maintainability within a legacy environment.