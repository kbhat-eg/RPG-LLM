# RPG Program Explanation: NO105R – External Order Header, Retrieve Error Status

This IBM ILE RPG program (`NO105R`) is designed to validate several input parameters related to an external order (customer, warehouse, user, project, delivery type, and delivery date), and set a status code (`p_stat`) reflecting any detected errors or validation results. Let's break it down by key sections and logic.

---

## 1. Control & File Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debugging I/O.
- Sets date editing to day/month/year.

### Input Files

Each `f` spec defines a database file, specifying the usage (input, full procedural, keyed access), and a record format rename for use in the program:
```rpg
fvltpl1    if   e           k disk    rename(vltppfr:vltpl1r)
fausrl1    if   e           k disk    rename(ausrpfr:ausrl1r)
ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
frkunl1    if   e           k disk    rename(rkunpfr:fkunl1r)
ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
```
- **vltpl1:** Delivery type
- **ausrl1:** User
- **fusrl1:** User (possibly for OFAK system)
- **rkunl1:** Customer
- **fkprl1:** Customer project

---

## 2. Data Definitions

### Parameters

Parameters for validation are defined as stand-alone fields, either with specific types, lengths, or based on the structure of database fields using `LIKE()`:
```rpg
d p_firm          s                   like(vyfirm)
d p_stat          s              1  0
d p_lage          s              2  0
d p_user          s                   like(fbuser)
d p_kund          s                   like(rkkund)
d p_kpro          s                   like(flkpro)
d p_lety          s                   like(vylety)
d p_ldat          s               d   datfmt(*iso)
```
- **p_firm:** Company
- **p_stat:** Status output (to report error / success)
- **p_lage:** Warehouse
- **p_user:** User ID
- **p_kund:** Customer
- **p_kpro:** Customer project
- **p_lety:** Delivery type
- **p_ldat:** Delivery date

### Local Data Area (LDA)

Fields mapped into the RPG program from the LDA for user and name.

### Key Variables

Temporary variables for building keys for chained database lookups.

### Working Variables

Additional work fields, such as status, text, date, etc.

---

## 3. Main Program Logic

### Initialization

- `p_stat` is set to 0 (no error).

### Warehouse Validation

- Intends to validate the warehouse (`p_lage`) by calling program `RS710R`, passing/receiving warehouse-related parameters.  
- If the warehouse status (`w_stat`) is not blank, sets `p_stat=1` (warehouse error) and jumps to end.

### User Validation

- If `p_user` is not blank:
  - **AUSR**: Tries to look up the user in `ausrl1`. If not found, sets `p_stat=2` (user error) and exits.
  - **FUSR**: Tries to look up the user in `fusrl1`, checks that field `fbko10` is not zero. If not, sets `p_stat=2` and exits.

### Customer Validation

- If `p_kund=0` (not provided), sets `p_stat=3` and exits.
- Tries to look up customer in `rkunl1`. If not found, sets `p_stat=3` and exits.

### Customer Project Validation

- If `p_kpro` is not 0:
  - Looks up the customer project in `fkprl1` based on firm, customer, and project.
  - If not found, sets `p_stat=4` and exits.

### Delivery Type Validation

- If `p_lety` is not 0:
  - Looks up delivery type in `vltpl1` by firm and delivery type.
  - If not found, sets `p_stat=5` and exits.

### Delivery Date Validation

- If `p_ldat` (delivery date) is not the lowest valid value:
  - Gets current date (`time w_udat`).
  - If `p_ldat` < current date, sets `p_stat=6` (delivery date error) and exits.

---

## 4. Program Termination

- `avslutt` (end): Sets last record indicator (`*INLR = *ON`) and returns.

---

## 5. Program Initialization Subroutine (`*INZSR`)

This subroutine runs automatically before main logic:

### Entry Parameter List

- Maps entry parameters to local variables.

### Key Lists

Defines composite key lists for use in database lookups, matching the structure needed for each file (`klist` / `kfld`):

- **vltpl1_key:** Company, delivery type
- **ausrl1_key:** User
- **fusrl1_key:** Company, user
- **rkunl1_key:** Company, customer
- **fkprl1_key:** Company, customer, project

### Local Assignment

- Sets the working firm code from the input parameter.

---

## 6. Status Codes

| `p_stat` | Meaning                        |
|----------|--------------------------------|
| 0        | OK / No Error                  |
| 1        | Invalid Warehouse              |
| 2        | Invalid User                   |
| 3        | Invalid Customer               |
| 4        | Invalid Customer Project       |
| 5        | Invalid Delivery Type          |
| 6        | Invalid Delivery Date (in past)|

---

## 7. Comments and Maintenance

- In-code comments are in Norwegian.
- History of changes, with developer initials and dates.
- Example: In version 5.60, code related to warehouse 0 was adjusted (see commented-out `if`/`endif` for `p_lage<>0`).

---

## Summary

**This program is a validator for order header parameters. It checks if submitted parameter values are valid by referencing several master files, and sets a status code (`p_stat`) to indicate the first error found.**  
If all validations pass, `p_stat` remains 0 (success). The program is typically called by another program, passing parameters and receiving the error code.

If you are new to this codebase:  
- Understand the structure and content of each referenced file.
- The pattern is: validate parameter → set error code if not valid → exit.
- The program is modular and easy to extend with further validations if needed.