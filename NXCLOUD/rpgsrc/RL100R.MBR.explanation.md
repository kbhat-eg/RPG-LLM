```markdown
# RL100R – Supplier Maintenance Program

## 1. Program Header  
- **H-Specification**  
  - `Option(*NODEBUGIO)` – no debug I/O  
  - `DateEdit(*DMY)` – date edit mask = DD/MM/YYYY  
- **Metadata**  
  - System: ASOKON  
  - Program: RL100R  
  - Description: Supplier maintenance (create, change, view, delete, copy, search, print, archive)  
  - Version history with enhancements (sorting, passive-supplier filter, bank account display, SQL date format, GUI flags, etc.)

---

## 2. File Declarations  
All files use **keyed reads** and many are renamed for local work fields:

- **FRLEVLR / RLEVLR** – Supplier master  
- **FRLEVL1, FRLEVL2, FRLEVL3** – Same physical file keyed by different fields (supplier number, alpha, postal code)  
- **FRLELVU / RLELVU** – For update (create/change/delete)  
- **FRLSOLU** – Supplier search text (for full–text search)  
- **FRKLAL2** – Notes block (deleted in V5.30)  
- **FRLTRL1** – Supplier posting file (to check for outstanding postings)  
- **FRAA1L1** – Status codes (e.g. default payment terms)  
- **FAPOSPF** – Postal code lookup  

Additional files for item-based deletion checks (VVARL5, VVPRL3, VLAGPF).

---

## 3. Data Declarations  

### 3.1 Local Data Area (LDA)  
- `L_USER` (user sign), `L_FILG`, `L_FIRM` (company code), `L_FNAV` (company name)

### 3.2 Subfile Control Variables  
- `W_STEL` – subfile counter  
- `W_SPGE` – page size increment (constant `C_SFIL = 12`)  
- `W_SRRN`, `W_SFRN`, `W_SSRN` – relative record numbers (current, first, last)  
- `W_SEQE` – sequence indicator:  
  - `' '` = default (by supplier)  
  - `'A'` = alphabetic  
  - `'P'` = postal code  
  - `'S'` = search  

### 3.3 Flags  
- `B_OPPR` – new-mode on/off  
- `B_FORN` – refresh subfile  
- `B_OPEN_SOK` – search cursor open

### 3.4 Search Fields  
- `W_STE1–W_STE5` – individual search terms extracted from the search string

### 3.5 Working Fields  
- `W_FIRM`, `W_LEVR` – current company and supplier  
- `W_DISP`, `W_TILG` – security flags  
- `W_PGRP`, `W_AARA`, `W_BILA`, `W_AFIR` – archive parameters  

---

## 4. External Procedures and Calls  
- **CO402R** – read GUI flags (determines if 700–series suppliers allowed)  
- **AS700R** – parse search string into up to 5 terms  
- **RL101R** – supplier upkeep program (create/change/view details)  
- **RL110R** – show postings drill-down  
- **RL112R** – display postings list  
- **RL514R** – show collective invoice  
- **RL643C** – print account statement  
- **AP622C / AH720C** – archive viewer  
- **RS002R** – next available supplier number  
- **RA502R / RA503R / RA514R** – payment methods/terms/category lookups  
- **AA005R** – display error message  

---

## 5. Key Lists  
Key definitions for CHAIN, READ, DELETE:

- **RLEVL1_KEY**: `(W_FIRM, RLEVL1_LEVR)` – position by supplier  
- **RLEVL2_KEY**: `(W_FIRM, RLEVL2_ALFA)` – position by alpha  
- **RLEVL3_KEY**: `(W_FIRM, RLEVL3_PONR)` – position by postal code  
- **RLELVU_KEY**: `(W_FIRM, RLELVU_LEVR)` – updates  
- **RLSOLU_KEY**: `(W_FIRM, RLSOLU_SLEV)` – search-text updates  
- **RLTRL1_KEY**: `(W_FIRM, RLTRL1_LEVR)` – check postings  
- **APOSPF_KEY**: `(APOSPF_PONR)` – postal lookup  
- **(plus others for history checks)**

---

## 6. Main Processing Cycle  

1. **Initialization**  
   - Load `W_FIRM` from LDA  
   - Call `CO402R` to set GUI flag `U_701`  
   - Chain `RAA1L1` to get default payment terms (F5 toggle)  
   - Get current date into `W_UDAT`  
   - Set `*IN22 = *ON` (cursor on)  
   - Set `*IN55 = *OFF` (show active only)  
   - Position file to `RLEVL1` with key 0 (start)  
   - Call subroutine `CRT_SUBFILE`  

2. **Screen Control Records**  
   - **B2CTL** – control record with indicators for roll-up/down, clear, end, protect  
   - **B2CMD** – blank command line  
   - **B1SFL** – subfile record format  

3. **Main Loop**  
   - `DSP_SUBFILE` – display or refresh the screen  
   - **Function Key Handling** (`SELECT/WHEN`)  
     - F3/F12 → `*INKC` or `*INKL`: exit program  
     - F10 → `XC1BLD` (new supplier) → redisplay  
     - F11 → toggle detail view (address/type fields) → `FORNY`  
     - F21 (Home) → turn on `*IN22` → redisplay  
   - **F5** (Show all/active) → toggle `*IN55` → `FORNY`  
   - **F8** (Drill to postings) → call RL110R → redisplay  
   - **F9** (Repeat search) → preserve last search string → redisplay  
   - **Search**: if `B2STEK` ≠ blank → `SØK` → redisplay  
   - **Position**: if `B2LEVR`/`B2ALFA`/`B2PONR` set → `POSISJONER` → redisplay  
   - **Else** → `SUBFILE` – handle per-line actions  

---

## 7. Key Subroutines  

### 7.1 FORNY  
- Chains to the correct keylist (`RLEVL1`, `RLEVL2`, or `RLEVL3` depending on `W_SEQE`)  
- Calls `CLR_SUBFILE`, then `CRT_SUBFILE`

### 7.2 SØK  
- Sets `W_SEQE = 'S'` and `B_OPEN_SOK = *ON`  
- Copies `B2STEK` to `S_STEK`  
- Calls `AS700R` to split search text into `W_STE1–W_STE5`  
- Clears `B2STEK`, then `CLR_SUBFILE` & `CRT_SUBFILE`

### 7.3 POSISJONER  
- If `B2LEVR` ≥ 1 → set key on supplier, clear others  
- Else if `B2ALFA` ≠ blank → key on alpha  
- Else if `B2PONR` ≥ 1 → key on postal code  
- Calls `CLR_SUBFILE` & `CRT_SUBFILE`  
- Clears position fields

### 7.4 SUBFILE  
- Toggles `*IN22` (cursor on/off) once  
- Captures user’s selected subfile row (`W_CURN`, `W_VIRN`)  
- Loops through each displayed record:  
  - **Change (2)** → `XC2BLD` → update subfile buffer → `UPDATE B1SFL`  
  - **Copy (3)** → `XK1WIN` → update buffer  
  - **Delete (4)** → `XD1WIN` → update buffer  
  - **View (5)** → same as change but display only  
  - **Print statement (6)** → `SKRIV`  
  - **Collective invoice (7)** → call RL514R  
  - **Show postings (8)** → `POSTERINGER`  
  - **View archive (9)** → calls AX700R + AP622C / RL archive routines  

After processing each line, if `B_FORN` = *ON, call `FORNY` to refresh.

### 7.5 XC1BLD (New Supplier)  
1. Calls `RS002R(' ',W_FIRM:W_4LNR)` → fetch next available number  
2. Display `C1BLD` input format  
3. On Enter:  
   - Validate range (`RA1HKT`)  
   - Chain `RLEVLR` to ensure uniqueness  
   - If found → `XC1MSG` (duplicate message)  
4. On success → call `XC2BLD` to do the actual create

### 7.6 XC1MSG  
- Display `C1MSG` (duplicate-number warning)  
- If user presses Cancel → set `B_ANUL = *ON` → return

### 7.7 XC2BLD (Change/View)  
- Sets `W_LEVR = B1LEVR`, `W_VALG = B1VALG`  
- Calls `RL101R(W_LEVR:W_VALG)` to show the change/view screen `C2BLD`  
- On return, if update → read back fields from `RLEVLR` into subfile buffer (`B1…`)  
- Clears position keys and if new or copied → set `B_FORN = *ON`  

### 7.8 XD1WIN (Delete)  
1. Chain `RLEVLR(D1LEVR)` to fetch supplier record  
2. Display `D1WIN` confirm window  
3. Checks:  
   - `RLSALD = 0` (zero balance)  
   - No postings: chain `RLTRL1` → if found → error  
   - No items in VVARL5 / VVPRL3 / VLAGPF → error  
4. If all clear → delete `RLELVU` and `RLSOLU` (search text) and `RKLAL2` (notes block)  
5. Set `B_FORN = *ON` for subfile refresh

### 7.9 XK1WIN (Copy)  
1. Chain source `RLEVLR(K1LEVR)` → read data into `K1…` workfields  
2. Call `RS002R` to get new supplier number → validate  
3. Display `K1WIN` copy window  
4. On Enter:  
   - Postal code lookup (`APOSPF`)  
   - Payment terms (`RA503R`), method (`RA502R`), category (`RA514R`)  
   - Duplicate check on new number  
   - Uppercase conversion on alpha and name/address fields  
5. Write new `RLELVU` record with defaults for balances, counters, etc.  
6. Call post-maintenance `XC2BLD` to allow immediate edit/view  

### 7.10 CLR_SUBFILE & CRT_SUBFILE  
- **CLR_SUBFILE**: write blank control record (`B2CTL`), reset `W_SRRN`, `W_SFRN`, `W_SSRN`, `W_SPGE`  
- **CRT_SUBFILE**:  
  - Increment page boundary (`W_SPGE += C_SFIL`), set start = last end  
  - If search mode (`W_SEQE='S'`) → open SQL cursor on `RLSOPF` for `W_STE1` filter  
  - Loop (`DOU W_SRRN = W_SPGE`):  
    - Fetch next SQL row or native read by key (`RLEVL2`, `RLEVL3`, `RLEVL1`)  
    - If EOF → `*IN15 = *ON` → exit  
    - If search mode → apply 2nd–5th search filters (`%SCAN` on `RLSTEK`)  
    - Chain `RLEVL1` to verify supplier record exists  
    - Filter out other firms, passive suppliers if `*IN55 = *ON`  
    - Write `B1SFL` subfile record, increment `W_SRRN`  
  - After loop → set `W_SFRN`, `W_SSRN`, `W_VIRN`, close SQL cursor  

### 7.11 BCK_SUBFILE (Page Back)  
- Based on `W_SEQE` and EOF on read, reposition file pointers backwards by reading with `SETGT/READP`  
- Then `CLR_SUBFILE` & `CRT_SUBFILE`

### 7.12 DSP_SUBFILE  
- If `W_SRRN > 0` → protect fields (`IN12`)  
- Write control record, display `B2CTL`

### 7.13 SJEKK_INPUT (Copy Validation)  
- Validate postal code via `APOSPF`  
- Validate payment terms, method, category (`RS703R`, `RS702R`, `RS714R`)  
- Sets error flags `IN32`, `IN33`, `IN34`, `IN35`

### 7.14 POSTERINGER & SKRIV  
- `POSTERINGER` → call `RL112R(W_VALG, B1LEVR)` → view postings  
- `SKRIV` → call `RL643C(B1LEVR)` → print statement

### 7.15 LES_HIST (History Check)  
- SQL cursor on `VLAGPF` to see if supplier has history records → set `IN40` to block deletion if found

---

## 8. Embedded SQL  
- **/EXEC SQL SET OPTION** – set ISO date, language sequence, etc.  
- **Search cursor** in `CRT_SUBFILE` when `W_SEQE='S'` to read from `RLSOPF` (search index)  
- **History cursor** in `LES_HIST` to fetch from `VLAGPF`

---

### Overall Flow  
1. **Init** → fill subfile  
2. **Display** → `DSP_SUBFILE`  
3. **User actions**: new, change, delete, copy, view, search, position, print, archive  
4. **Subfile refresh** on any structural change (create, copy, delete, toggle)  
5. **Exit** on F3/F12  

This RPGLE program uses DDS subfile techniques, RPG subroutines, native SQL and external calls to deliver a full-screen supplier maintenance utility with search, paging, detail-view and archive integration.
```