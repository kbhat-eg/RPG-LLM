# RPG Program VT741R – Developer Onboarding Guide

## Overview and Purpose

This RPG program, `VT741R`, is designed for processing campaign pricing information, specifically updating campaign ("tilbudspriser") and product data from XML files supplied by "Solve". The process involves reading data from an XML-to-SQL view, updating several DB2 physical files, and performing error handling, logging, and notification via email (with optional Excel attachment generation).

---

## High-Level Flow

1. **Initialization**
   - Receives parameters such as filename, length, last date, and status.
   - Sets up local variables, keys, and company information.

2. **Processing Steps**
   - Cleans (deletes) previous Excel data from the relevant table.
   - Processes campaign headers from the XML view.
     - Parses and adds/updates campaign header records.
     - Deletes any previously existing campaign with the same name and dates.
   - Processes campaign lines (details) from the XML view.
     - Parses and adds/updates campaign line items ("Vare" - items) and related data (units, prices, etc).
     - Checks for data validity and handles missing entries with error logging.

3. **Error Handling**
   - Any line which triggers an error gets logged for Excel export and possible notification.

4. **Reporting/Notification**
   - If any error was detected, an Excel file is generated (via CoolSpool/ASPTOXLSX).
   - An email is sent with the generated file attached, if configured.

5. **Job Logging**
   - Extensive job logging throughout via program calls (e.g., `AB705R`).

---

## Key Sections Explained

### File Definitions (`F-Specs`)

- Multiple logical and physical files, mostly with renames, representing campaign headers (`vtill1`, `vtill5`, etc.), items, vendors, and supporting data.
- Some files are used for reading (input, `I`), others for updating/writing (update, `U`), and some are both. 

### Data Definitions (`D-Specs`)

- **Campaign Data**: `w_kamp`, `w_besk`, `w_ansv`, etc., hold campaign header fields.
- **Line Data**: `w_nobb`, `w_enhe`, `w_inpr`, etc., hold details of campaign line items/product lines.
- **Error Reporting/Excel**: Variables for error text, file names, Excel cell mapping, and email sending.
- **Keys**: Many fields marked `like(…)` are for building record keys for file access.

### Main Program Logic

```rpg
len = p_lengde;
navnet = %trim(%subst(p_filNavn:1:len));
exec sql SET KAMPANJE_XML_SOLVE_VIEW_V = :navnet;
```
- Gets the trimmed filename and notifies the SQL view what XML to present.

```rpg
exsr rydd_xls;
exsr beh_kamp_hode;
exsr beh_kamp_linje;
p_sistDato = %char(%date(): *iso);

if b_feil = *on;
  exsr lag_excel;
  exsr send_mail;
endif;
```
- Cleans Excel work table, processes campaign headers, then details. If any error, generate Excel report & send mail.

### Campaign Header Processing (`beh_kamp_hode`)

- Declares and opens a SQL cursor on the XML view, fetching campaign header records.
- For each record:
  - Calls `prs_hode` (parse and move to working fields).
  - Calls `dlt_kamp_hode` (delete previous instance of that campaign, and create new record).

### Campaign Line Processing (`beh_kamp_linje`)

- Similar to header processing, but for line-level details (items, prices, etc.).
- For each detail record:
  - Calls `prs_linj` to parse line details.
  - Calls `skr_kamp_linje` to write/update the DB, performing lookups and validation.

### Parsing Routines

- `prs_hode`: Moves fields from the SQL view (as `x_*` variables) to working variables (`w_*`), normalizing case, converting dates, etc.
- `prs_linj`: Converts and maps SQL view fields into RPG types for processing.

### Deleting Existing Campaigns (`dlt_kamp_hode`)

- Checks for existing campaigns (by name) and deletes them from both main campaign files and, if enabled, additional "VA" tables.
- Recreates the campaign header in the appropriate file(s).

### Writing Line Items (`skr_kamp_linje`)

- Validates existence of items and units via chained lookups.
- If any lookup fails, logs error for Excel export and skips.
- Handles calculating three sales units for the item.
- Writes or updates the campaign line in the target physical file, converting prices/units as needed.
- Handles writing a "VA" campaign line if configured.

### VA Campaign Support (`oppr_kamp_va`)

- Optionally writes to the "JKAVPF" and "JKAHPF" tables (presumably for a secondary system or integration).

### Error Logging and Notification

- **`skriv_xls`**: Gathers error info into the `fxl2str` table for Excel export.
- **`rydd_xls`**: Clears this table at the start of the program.
- **`lag_excel`**: Calls a third-party utility (`ASPTOXLSX`) to convert the error table into an Excel file.
- **`send_mail`**: Prepares and sends an email with the error Excel file attached, to up to three recipients (looked up via logical files).

---

## Supporting Subroutines

- **`*inzsr`**: Initialization on program start; sets up parameters, keys, and company fields. Also starts job logging with program `AB700R`.
- **`klist/kfld` blocks**: Define record keys (for SETLL/CHAIN/READE) for efficient keyed access to physical files.

---

## Noteworthy Features

- **Extensive Job Logging**: Includes calls to a logging program for traceability (`AB705R`, `AB700R`).
- **Robust Error Handling**: All data issues are logged for review, and reporting is automated.
- **Dynamic XML Handling**: Uses an SQL view that is told dynamically (via variable) which XML file to present.
- **Legacy RPG**: Uses a mix of fixed-format and free-format RPGIV, with some procedure calls for integration.
- **Mail & Excel Export**: Integrates with external tools/utilities for notification/Excel production.

---

## Key Points for Maintenance/Onboarding

- **Data Model**: Understand the various campaign and product files, including VA-related ones if you're supporting multi-system integration.
- **Error Paths**: Errors on missing item/unit/record update are meant to log and skip the problematic line, not fail the entire batch.
- **Parameter Handling**: Program expects to be called with parameters (likely from CL or another RPG).
- **SQL Integration**: Usage of embedded SQL and SQL views require coordination with DBAs for changes to the underlying XML view.
- **Upgrades & Extensions**: History section in comments shows the life of the program, with references to versions and bugfixes.

---

## Section Reference

- **Comment Block**: Contains version history and modifications with developer initials and dates.
- **F-Specs**: File definitions and renames for all DB2/400 files used.
- **D-Specs**: Variable, key, constant, and parameter definitions.
- **Main Body**: Core processing, error handling, and subroutine calls.
- **Subroutines**: Modular code for parsing, error handling, Excel generation, email, etc.
- **Keylists**: All KLIST/KFLD definitions for keyed file access.
- **Initialization**: *INZSR subroutine for parameter unpacking and job log startup.

---

## Summary

The program is a batch loader for campaign data, reading from XML (via SQL view), validating and updating various IBM i DB2 files, supporting error reporting, Excel export, and email notifications, with comprehensive logging and legacy code structure. It's a critical part of the integration between the Solve system and IBM i-based campaign management.

---

**Tip for New Developers:**  
Start by tracing the mainline (top to bottom), then review each subroutine in depth. If modifying file access or campaign/business logic, ensure you understand the implications on both campaign header and line tables, as well as the VA-specific structures. Pay attention to error reporting, as failures are tracked for user notification, not immediate program abort.