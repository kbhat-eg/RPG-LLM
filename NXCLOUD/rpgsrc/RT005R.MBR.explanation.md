# Program Documentation: RT005R â€“ Generate Total Chart of Accounts

## Purpose

This program (RT005R) generates a comprehensive list of all account combinations (company, account, cost bearer, department) for the selected company. It reads financial data such as balances, budgets, and estimates from the source file `RHSAPF` and writes unique combinations to the output file `RTOTPFR`. This process ensures that the total chart of accounts reflects all relevant account combinations present in the financial records for the current year, previous year, and next year.

## High-Level Flow

1. **Initialization**: Sets up year variables and initializes key fields.
2. **Main Loop**: Iterates through all records in `RHSAPF` for the selected company and relevant years.
3. **Record Processing**: Depending on the record type (balance, budget, or estimate), it transfers relevant fields and attempts to write a unique entry to the output file.
4. **Uniqueness Enforcement**: Only writes a record if the combination does not already exist in the output file.

## File Definitions

- **Input File**:  
  `RHSAPF` (renamed as `rhsal1r`): Contains financial data.  
  - Record types:
    - `1`: Balance (current year and previous year)
    - `3`: Budget (current year and next year)
    - `4`: Estimate (current year and next year)

- **Output File**:  
  `RTOTPFR` (renamed as `rtotl1r`): Receives unique combinations of company, account, cost bearer, and department.

## Key Data Fields

- **Year Handling**:
  - `WWAAR4`: Current year (4 digits)
  - `WWIFJ`: Previous year (`WWAAR4` - 1)
  - `WWNEST`: Next year (`WWAAR4` + 1)

- **Account Combination Fields**:
  - `firma`: Company
  - `konto`: Account
  - `avde`: Department
  - `kbarer`: Cost bearer

## Key Lists

- **rhsal1_key**: Used to set position and read records for a specific company in `RHSAPF`.
- **TOTKEY**: Used to chain (look up) or write unique combinations in the output file.

## Main Processing Logic

### 1. **Initialization**

- Sets `w_firm` to the company code (`lcfirm`).
- Calculates previous and next years.

### 2. **Reading Input Records**

- Uses `SETLL` and `READE` to process all records for the selected company in `RHSAPF`.
- For each record:
  - Checks if the record year (`RIRAAR`) matches current, previous, or next year as relevant.
  - Processes the record based on its type (`RITYPE`):
    - `1` (Balance): Calls `saldo` subroutine.
    - `3` (Budget): Calls `budsj` subroutine.
    - `4` (Estimate): Calls `ansla` subroutine.

### 3. **Subroutines**

Each subroutine (`saldo`, `budsj`, `ansla`) performs the following:

- Checks if the record year is relevant for the type.
- Moves company, account, department, and cost bearer fields from input to output variables.
- Calls the `total` subroutine.

#### **total Subroutine**

- Checks if the current combination already exists in the output file using `CHAIN` with `TOTKEY`.
- If not found, writes a new record to `RTOTPFR`.

## Business/Domain-Specific Logic

- **Record Filtering**: The program only considers records for the current company and for specific years, depending on the record type (e.g., budgets and estimates include next year).
- **Combination Uniqueness**: The output file is designed to contain only unique combinations of company, account, cost bearer, and department, regardless of how many times they appear in the input data.

## Design Decisions and Conventions

- **Subroutine Structure**: The program uses named subroutines for each record type to encapsulate logic and improve maintainability.
- **Key Lists**: Key lists are used extensively for setll, reade, and chain operations, which is a common pattern for handling composite keys in RPG.
- **Output Record Creation**: The `total` subroutine ensures that no duplicate combinations are written to the output file, enforcing uniqueness at the file level.
- **Year Handling**: The use of calculated year fields (`WWIFJ`, `WWNEST`) allows the program to flexibly adapt to processing prior, current, and next year data as required by business rules.

## Interactions with Other Modules

- **Input Dependency**: Relies on `RHSAPF` for source data.
- **Output Dependency**: Populates `RTOTPFR` with unique account combinations. Other processes may consume this file as a master list of valid account structures.

## Noteworthy Details

- The program is tailored to the ASOKON system and may rely on field layouts and business rules specific to this domain.
- The record type logic (1, 3, 4) is hardcoded, reflecting specific business meanings for balance, budget, and estimate records.
- The use of `*nodebugio` and `datedit(*dmy)` in the H-spec suggests a production-level program with European date formatting.

## Summary Table

| Record Type | Years Considered         | Subroutine | Output Action           |
|-------------|-------------------------|------------|------------------------|
| 1 (Saldo)   | Current, Previous       | saldo      | Write if new combo     |
| 3 (Budsjett)| Current, Next           | budsj      | Write if new combo     |
| 4 (Anslag)  | Current, Next           | ansla      | Write if new combo     |

---

This program is foundational for building a comprehensive and deduplicated chart of accounts, supporting downstream financial reporting and analysis in the ASOKON system.