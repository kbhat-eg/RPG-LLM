# RPG ILE Program Overview: NN810R

This program, **NN810R**, is an ILE RPG program designed for an IBM i (AS400) system. Its main purpose is to serve as a backend service for a web shop (“nettbutikk”), handling price and inventory inquiries on items/products. The program reads requests for price information from a data queue, processes the request (fetches prices, calculates discounts, collects stock information), and then writes the result back to an output data queue.

---

## High-Level Workflow

1. **Initialization**: Program parameters are accepted and key lists are set up.
2. **Main Loop**: Wait for input messages from an input data queue.
3. **Processing**: For each request, carry out:
   - Customer and item number normalization.
   - Determine warehouse (lager) from customer.
   - Fetch item price group.
   - For up to 3 sales units: get price, discounts, price code text.
   - Fetch and return inventory (beholdning) for the item.
4. **Return Response**: Write the results to an output data queue.
5. **Loop**: Process next input until the data queue is empty.

---

## Program Structure

### **A. File Declarations**

- Multiple logical and physical files are declared with `RENAME`, e.g.:
  - `fstsl1`: Status codes
  - `vvarl1`: Item master
  - `vvenl2`: Item unit/sale unit
  - `vpkol1`: Price code texts
  - `vlagl1`: Warehouse stocks
  - `vvlel1`: Sawmill stock (newer function)

### **B. Variable & Data Structure Definitions**

- **Parameters**: Variables such as unique ID, data queue names, company, warehouse, etc.
- **Data Queues**:
  - `d_inpu`: Input from data queue (contains customer, contract, item, type)
  - `d_outp`: Output to queue (contains detailed price and stock info for up to 3 units, including textual fields)
- **Sub-structures**: For interacting with programs like `VP900R` (price calculation routine)
- **Keys for File Access**: `klist` defines composite keys for file access.

### **C. Main Program Flow**

#### 1. **Initialization (`*inzsr`)**

- Receives parameters
- Sets up key lists
- Fetches company information
- Gets current date/time

#### 2. **Main Loop (DOU on blank input)**

- Waits for and receives messages from the input data queue (`QRCVDTAQ`).
- On receiving valid input (not blanks):
  - Normalize customer and contract numbers by replacing blanks with zeroes.
  - Call `NN899C` to determine the correct warehouse for the customer (stored in Local Data Area).
  - Call `VL714R` to fetch the correct price group for the item/warehouse/customer combination.
  - Calls main **processing subroutine** (`behandling`).

#### 3. **Processing Subroutine (`behandling`)**

- **Validation**: (commented out) Checks if the item exists in the item file.
- **Initialize Output**: Set all output fields to blanks or default values.
- **Process Sale Units**:
  - For each sale unit (up to 3 per item), get the unit, then:
    - Call `hent_pris` subroutine to fetch price and discounts using `VP900R`.
    - Store formatted results in output buffer.
- **Fetch Price Code Texts**: For each price code (up to 3), if present, look up its textual description.
- **Get Inventory Information**: Calls `hent_lager` to get/compute available stock for the item.
- **Output**: Write composed answer to output data queue (`QSNDDTAQ`).

#### 4. **Subroutines**

- **hent_pris**: 
  - Prepares call to `VP900R` price-calculation program.
  - Supplies all necessary parameters: company, customer, contract, item, sales unit, date/time, price group, etc.
  - Reads price, applies up to two discount levels.
  - Formats price/discount as strings for output.

- **hent_lager**:
  - Checks if warehouse management is used for the item.
  - Calls `VL710R` to fetch item type and related information.
  - If the item is a stock item (type 'L'), it sums stock across warehouses or for a specific warehouse.
  - Computes available, ordered, and displayed stock, formats as strings for output.

---

## Notable Technical Details

- **Data Queue I/O**: Uses system APIs `QRCVDTAQ` (receive) and `QSNDDTAQ` (send) for message-based program interaction. Input and output consist of packed, positional fields.
- **File Access**: Uses both `chain` (direct lookup) and `reade`/`setll` (sequential reads) for files.
- **Decimal/Alpha Normalization**: Contracts/customer numbers are left-padded with zeroes for processing.
- **Price/Discount Calculation**: Discounts can be applied at up to two levels; formulas ensure correct price after cumulative discounting.
- **Use of Overlays**: Data structures overlay to allow field-level access to fields within both input/output buffers as well as parameter blocks for external program calls.
- **Commenting and Versioning**: The top comments log a detailed chronological history of changes, with Norwegian descriptions.

---

## Onboarding Summary

- **Purpose**: This program automates the retrieval of prices and inventory information for web shop requests via data queues, integrating multiple files/tables (customer, item, inventory, price, etc.) and business rules (discounts, warehouse logic, etc.).
- **Main Interaction**: Input and output go through data queues, with processing triggered per received message.
- **External Calls**: Relies heavily on subprograms (`NN899C`, `VL714R`, `VP900R`, `VL710R`) for warehouse, price group, pricing, and item type information.
- **Customization**: Many version/feature tweaks are present, reflected in history comments and code, ensuring the program remains aligned with business changes.

---

## Key Points for Developers

- **Entry Parameters**: Understand all parameters needed to start the job (data queue names, company, warehouse, etc.).
- **File Layouts**: Refer to file definitions for field mapping (item, warehouse, price code files).
- **Program Calls**: Know the interfaces/protocols of the called CL or RPG programs.
- **Business Logic**: Discounts, price formatting, and inventory availability logic are central.
- **Data Structures**: Pay attention to overlays and the precise subfield usage within I/O buffers and external calls.

---

## Maintenance Tips

- When modifying business rules (e.g., pricing, stock eligibility, price codes), ensure corresponding logic in subroutines and interface data structures is kept in sync.
- New item-unit types, warehouses, or discounts may require updating hard-coded overlays and buffer lengths.
- Keep version history at the top updated to reflect all changes for traceability.

---

**In summary:**  
NN810R is a data-queue driven server program, providing price and stock lookups for web shop integrations, and is a key middle layer interfacing with complex pricing and inventory subsystems on IBM i.