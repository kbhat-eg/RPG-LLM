# Program Overview

This RPG (ILE RPG / RPG IV) program, named `LE605R` and part of system `ASLAGR`, is used for generating an inventory counting list ("telle-liste") for warehouses, specifically selecting item numbers for cyclical counting (“syklisk telling”). The program supports a range of parameters for filtering and organizes the output with advanced sorting and filtering logic.

The source is in Norwegian (variable naming and comments), but program logic is clear and follows RPG III/400 conventions.

---

## File Definitions

The program uses several physical and logical files, with typical RPG declarations:

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
fmstpl1    if   e           k disk    rename(mstppfr:mstpl1r)
fra10l1    if   e           k disk    rename(ra10pfr:ra10l1r)
flpstlu    uf a e           k disk    rename(lpstpfr:lpstlur)
fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
```

- **vvarl1**: Item master file
- **vlagl1**: Warehouse/item file
- **vugrl1**: Item group file
- **mstpl1**: Cycle count parameters
- **ra10l1**: Warehouse code file
- **lpstlu**: Output listing for counted items

---

## Data Structures & Variables

- **Arrays** for warehouse (`a_lage`, `a_lagl`) and ABC codes (`a_tabc`).
- **Parameter structure** (`d_prec`) overlays for communication with other programs or CL.
- **Local Data Area variables** (user, firm, workstation).
- **Working variables** for filtering (e.g., `w_lage`, `w_vare`, `w_tabc`), counters, and sorting key.

---

## Main Processing Flow

### 1. Initialization

- The SQL date format is set to ISO.
- The subroutine `les_s_parm` is called to read cycle count parameters and to initialize cycle count distribution per ABC-class.
- The parameter structure is loaded (`d_prec = w_parm`).
- The cycle count date is set if provided.

### 2. Build Warehouse Arrays

- If `d_list = 0`, build the list of all warehouses with `lag_tab`.
- Always build the list of current warehouses with `lag_tab_les`.

### 3. Main Loop

- For each warehouse (in `a_lagl`)
    - For each of the 9 ABC codes (AX, AY, AZ, BX, BY, BZ, CX, CY, CZ)
        - Set up SQL cursor with selection subroutine (`sel_pr_kode`) for the ABC code.
        - For each item returned by SQL:
            - Skip if item has already reached the required count.
            - Skip if item’s primary/group/under-group filters are not matched.
            - Optionally filter by product owner (`d_pans`).
            - Get item type from external program `VL710R` (via CALL/PARM).
            - Filter by item type and optionally supplier.
            - Read latest item master (`vvarl1`).
            - Depending on `d_list`, process with either all warehouses (`lag_alle`) or only those with inventory (`lag_finnes`).
            - For each row output, call `sorsub` (sorting subroutine).

### 4. End Program

- Set LR indicator and return.

---

## Key Subroutines

### `lag_alle` / `lag_finnes`
- Output rows for either all possible warehouses (`lag_alle`) or only warehouses where the item exists (`lag_finnes`).
- Applies additional filtering on warehouse location and quantity.
- Each valid item/warehouse combination is written to the output file (`lpstlur`) via `skriv_rad`.

### `skriv_rad`
- Prepares a record for output to `lpstlur`, updating if present or writing if not.
- Sets sorting key and quantity.

### `sorsub`
- Constructs a sorting key (`w_sort`) based on the selected method (`d_val3`), which defines the order of the print/output list.
- Several options exist for sorting (by warehouse, group, item number, description, location, supplier, etc).

### `lag_tab` / `lag_tab_les`
- Build arrays of warehouse codes in use, to drive main selection loops.

### `sel_pr_kode`
- SQL pre-processing: Declares, opens, and (eventually) closes a cursor (`sok_l`) for reading items matching the current warehouse/ABC code.

### `sjekk_antt`
- Ensures an item has not been counted more than allowed for its ABC code.

### `les_s_parm`
- Reads cycle counting parameters (from `mstpl1`); calculates how many items per cycle period should be counted per ABC code.
- Ensures minimum of 1 if percentage results in less than 1.

---

## Parameters and Filtering

- **Parameter structure** (`d_prec`) is used for all list filtering:
    - Item number from/to (`d_fvar`, `d_tvar`)
    - Group/owner (`d_fogr`, `d_togr`, `d_fhgr`, `d_thgr`, `d_fugr`, `d_tugr`)
    - Warehouse from/to (`d_flag`, `d_tlag`)
    - List mode (`d_list`)
    - Sorting option (`d_val3`)
    - Item type (`d_vtyp`)
    - Supplier (`d_levr`)
    - Warehouse location from/to (`d_fpla`, `d_tpla`)

---

## SQL and External Calls

- Uses embedded SQL to fetch item/warehouse records.
- Calls external RPG program `VL710R` to get item type and extended info.

---

## Key Points For Onboarding

- **Start with the main processing loop.** Understand how each warehouse and ABC code is processed in nested loops.
- **Parameter structure is critical.** All filtering and selection rely on values passsed in `w_parm` (overlayed as `d_prec`).
- **Sorting key is flexible and configurable.** Users/programs can choose different sort orders for the output.
- **Cycle counting logic:** Uses ABC classes, distributing the expected count across cycle periods, ensuring the correct number of items are selected.
- **External dependencies:** Review structure/layout of the physical/logical files, and be aware of logic implemented in `VL710R` (item type retrieval).
- **Comments and changelog:** The source is well-commented in Norwegian, and each enhancement is marked in the header with version numbers.

---

## Example Flow (Simplified)
1. Parameters are loaded and initialized.
2. All relevant warehouses are determined.
3. For every warehouse and ABC code combination:
    - Find all items that need to be counted.
    - Exclude if already counted enough, or filtered by group/type/supplier.
    - For each selected item/warehouse, output a row to the listing.
4. The program ends after all selections.

---

## Summary Table

| Main Area         | Purpose                              |
|-------------------|--------------------------------------|
| File Definitions  | Access master & transaction files    |
| Arrays            | List warehouses, ABC codes           |
| Parameter Struct  | Filtering & selection controls       |
| Main Loop         | For each warehouse/ABC code, process |
| Subroutines       | Select/filter, build keys, output    |
| SQL               | Efficient data selection             |
| Sorting           | User-definable sort order            |
| Output            | Writes to (or updates) helper file   |

---

## Conclusion

This program is a robust and highly adaptable tool for cyclical inventory counting, allowing flexible selection, sorting, and output based on operational parameters. For onboarding, focus on understanding how parameter filtering, cycle counting, and data selection (SQL, CHAIN) combine to produce the output, and how subroutines modularize and clarify each piece of logic.