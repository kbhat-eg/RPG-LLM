# Program VV630R Documentation

## Purpose and Business Context

**VV630R** is a user-interactive RPG program designed for the ASOFAK system. Its primary function is to facilitate the printing of item records ("varer") that do not have EAN numbers, based on user-specified parameters. The program collects filtering parameters (firm, groupings, and date) from the user, validates them, and then invokes a separate print program (`VV630C`). It also provides lookup functionality for group codes via dedicated inquiry programs.

The program is tailored to a business domain where items are organized hierarchically into overgroups, main groups, and subgroups, each identified by codes. The selection and validation of these codes are critical for accurate reporting.

## Program Structure Overview

- **File Declarations**: The program interacts with three group master files (`vogrl1`, `vhgrl1`, `vugrl1`) for lookups, and a workstation display file (`vv630d`) for user interaction.
- **Local Data Area (LDA)**: Used to retrieve the current firm number for the session.
- **Parameter Data Structure**: Collects output parameters to be passed to the print program.
- **Main Processing Loop**: Handles screen display, function key processing, field validation, and print program invocation.
- **Subroutines**: 
    - `spørring`: Handles group code inquiries via external programs.
    - `sjekk_inp`: Validates user input fields.
    - `*inzsr`: Program initialization, including key lists and field defaults.

## File Interactions

- **vogrl1 (Overgroup Master)**, **vhgrl1 (Main Group Master)**, **vugrl1 (Subgroup Master)**:
    - Used for validating and retrieving group descriptions based on user input.
    - Renamed record formats are used for clarity and isolation.
- **vv630d (Workstation Display File)**:
    - Manages screen interactions, including input and display of parameter fields.

## Data Structures and Variables

### Parameter Data Structure (`d_list`)

A 32-byte structure overlays the parameter list passed to the print program, with fields for:
- `d_firm`: Firm number (3 digits)
- `d_ogrp`: Overgroup code (2 digits)
- `d_hgrp`: Main group code (2 digits)
- `d_ugrp`: Subgroup code (3 digits)
- `d_dato`: Date (ISO format)

### Key Variables

Temporary variables are defined to build keys for file lookups, following the convention of using the file/field name as a prefix (e.g., `vogrl1_oogr`).

### Error and Working Variables

- `b_feil`: Boolean flag for input errors.
- `w_udat`: Holds the current date in ISO format.
- `w_firm`: Firm number used for lookups.

## Main Processing Flow

1. **Initialization (`*inzsr`)**
    - Key lists for group lookups are defined.
    - The firm number is retrieved from the LDA.
    - The current date is set for the date field.

2. **Main Screen Loop**
    - The main parameter entry screen (`b1bld`) is displayed.
    - Function keys are handled:
        - F3/F12 (`*INKC`/`*INKL`): Exit program.
        - F5 (`*INKD`): Invoke inquiry subroutine for code lookups.
    - Input fields are validated via `sjekk_inp`.
    - On validation failure, the screen is redisplayed with error indicators.
    - On success, parameters are moved to the output structure and the print program (`VV630C`) is called with `d_list`.

3. **Exit**
    - Properly sets on LR (`*INLR`) and returns.

## Subroutines

### Inquiry Subroutine (`spørring`)

Handles user-initiated lookups for group codes:
- **Overgroup (`B1OGRP`)**: Calls `VG510R` to assist in overgroup selection.
- **Main Group (`B1HGRP`)**: Calls `VG511R` for main group selection, requiring overgroup as context.
- **Subgroup (`B1UGRP`)**: Calls `VG512R` for subgroup selection, requiring both overgroup and main group as context.

Each external program is called with the current firm and relevant group codes, and the selection text is updated accordingly.

### Input Validation Subroutine (`sjekk_inp`)

Validates user-entered group codes and date:
- For each group code (overgroup, main group, subgroup), if entered, performs a keyed lookup against the respective master file. If not found, sets an error indicator and error flag.
- If a code is valid, retrieves and displays the group description.
- If the date field is empty, defaults it to today's date.
- Validates the date field format; sets an error flag if invalid.

### Initialization Subroutine (`*inzsr`)

- Defines key lists for file lookups, matching the hierarchical structure (firm + group codes).
- Reads the firm number from the LDA.
- Initializes the date field to the current date.

## Design Patterns and Conventions

- **Key List Definitions**: Key lists are defined in `*inzsr` for use with `chain` operations, following a clear naming convention.
- **Error Handling**: Error flags (`b_feil`, `*IN90`-`*IN34`) and screen indicators (`*IN31`-`*IN33`) are used to provide user feedback on invalid input.
- **Parameter Passing**: The output parameter structure is overlaid for efficient passing to the print program.
- **External Inquiry Programs**: The inquiry functionality is modularized into separate programs (`VG510R`, `VG511R`, `VG512R`) for maintainability and reuse.
- **Screen Looping**: The main loop redisplays the screen on error or after inquiry, ensuring a responsive user experience.

## External Program Interactions

- **VG510R**: Overgroup inquiry/selection.
- **VG511R**: Main group inquiry/selection.
- **VG512R**: Subgroup inquiry/selection.
- **VV630C**: The actual print/report program, receives validated parameters.

## Notable Business Logic

- **Hierarchical Grouping**: Items are filtered and validated based on a strict hierarchy: overgroup → main group → subgroup. Each level's code must be valid within the context of its parent group(s).
- **Firm Context**: All lookups and reporting are scoped to the current firm, which is dynamically retrieved from the LDA.
- **Date Handling**: The date parameter defaults to the current date if not provided, and is validated for correctness.

## Summary

This program acts as a parameter entry and validation front-end for item reporting without EAN numbers, ensuring that only valid and contextually correct parameters are passed to the print program. It provides user assistance for code selection and robust error feedback, leveraging a modular and hierarchical approach to group management within the firm context. The design emphasizes maintainability, user guidance, and data integrity.