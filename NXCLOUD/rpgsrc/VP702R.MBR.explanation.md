# RPG Program VP702R – Onboarding Explanation

This RPG (Report Program Generator) source code implements a pricing lookup for items (varer) in a Norwegian environment. It retrieves and returns different prices for an item based on company, item, price group, unit, delivery type, and date. The program is structured in classic ILE RPG IV (fixed-form), and is designed to be called from other programs (likely as a subprocedure or external program call), passing parameters in and out.

---

## 1. Program Overview

- **Purpose:**  
  Fetches various prices (sales price, cost price, purchase price, store price), their valid date, and a conversion factor (volume in relation to a base unit) for a product, based on several lookup keys.

- **Inputs:**  
  - Company (firma)
  - Item number (vare)
  - Price group (prisgr)
  - Unit (enhet)
  - Delivery type (leveringstype)
  - Date (dato)
  - "LR flag" (controls RPG's last record flag)

- **Outputs:**  
  - Sales price (salgspris)
  - Cost price (kostpris)
  - Purchase price (innkjøpspris)
  - Store price (butikkpris)
  - Price date (prisdato)
  - Conversion factor for volume (omregningsfaktor volum)

---

## 2. File Declarations

```rpg
fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)
```
- **vvprl1**: Price records for items by various keys.
- **vvarl1**: Item master data.
- **vugrl1**: Subgroup data for items.
- **vvenl1**: Item unit/volume conversion data.

Each uses a specific record format via `RENAME`, suggesting shared physical files or logical views.

---

## 3. Data Declarations

- **Parameters (`p_...`)**: These are the in/out fields for the program’s interface.
- **Working variables (`w_...`, `b_...`)**: Used for temporary storage and control logic.
- **Key variables (`vvprl1_...`, etc.)**: Used when building keys to access database files.
- **Other**: Status fields (like `*in90` for record not found).

---

## 4. Program Logic Flow

### a. **Initialization**

- The program begins by copying incoming parameters to working variables.
- It calls another program (`VL721R`) to get the default supplier for the item and warehouse, storing the result in `w_ldor`.
- Initializes the date to the parameter value or current time if not provided.
- Sets all output prices to zero and the conversion factor as well.

### b. **Price Lookup Sequence**

The program attempts to find a price for the item with the following logic (using supplier codes as lookup keys):

1. **Supplier for the warehouse** – uses the supplier found by `VL721R`.
2. **Main supplier** – if no price found above, tries the main supplier.
3. **No supplier** – as a last resort, uses a supplier code of zero.

Each price lookup is done by calling the subroutine `hent_pris`. If no price is found at all, the program exits.

### c. **Item and Cost Price Logic**

- Once a price is found, the item master record is loaded.
- If cost price is zero:
  - The program attempts to retrieve a "contribution margin" from item master or subgroup, calculates cost price based on it.
- If purchase price is zero, it’s set equal to the (possibly calculated) cost price.

### d. **Unit Conversion Factor Lookup**

- Looks up from the item/unit file (`vvenl1`) the conversion factor of the given unit versus the base unit.
- Returns the ratio as `p_omre`.

### e. **Program Exit**

- If the LR flag parameter (`p_inlr`) is *not* set, the program sets the *inLR flag (RPG’s last-record flag), causing the program to exit gracefully.

---

## 5. `hent_pris` Subroutine: Price Search Logic

This is the core logic for searching prices, and is designed to be flexible. The process:

1. **Exact match**: Tries to find a price for the given keys (item, price group, unit, delivery type, supplier).
2. **Fallback on Delivery Type**: If not found and delivery type is non-zero, retries with delivery type zero (wildcard).
3. **Fallback on Price Group**: If still not found and price group isn't blank, tries with price group blank.
4. **Delivery Type zero + Price Group blank**: If still not found, tries again with both delivery type = zero and price group blank.
5. On the first match (with a valid date), sets all price output parameters and sets a found flag.

---

## 6. Subroutine `*INZSR`, Key Lists

- **INZSR** (Initialization subroutine) sets up parameter lists and defines all key lists (`KLIST`) for keyed file access.
- Each key list is used for CHAIN, SETLL, READE operations to the respective files.

---

## 7. RPG Style and Notes

- Heavily uses parameter lists and key lists for modular, reusable database access.
- Uses `CALL` to another program for supplier lookup, typical in modular AS/400 environments.
- Uses Scandinavian/Norwegian variable names and comments; all prices and logic are tailored for a Nordic business context.
- No SQL, classic native file I/O.
- Handles date logic, cost price fallback, and multiple fallback search strategies for robust price determination.

---

## 8. Summary Table

| Step | Action                                                 | Method/File         |
|------|-------------------------------------------------------|---------------------|
| 1    | Retrieve supplier for item/warehouse                  | CALL 'VL721R'       |
| 2    | Price lookup by supplier, item, group, unit, delivery | vvprl1              |
| 3    | Load item master – fallback for cost price            | vvarl1, vugrl1      |
| 4    | Set purchase price if needed                          | Calculated          |
| 5    | Lookup unit conversion factor                         | vvenl1              |
| 6    | Return all found/computed values as output parameters | Return parameters   |

---

## 9. Example Parameter Use

- **Input**: ("100", "A1234", "01", "STK", 2, 20231214, 0, ...)
- **Output**: (125.5, 100.0, 95.0, 110.0, 20231201, 0.8, ...)

---

## 10. Key Points for Onboarding

- Understand how key lists (`KLIST`) and file access (CHAIN, READE) work.
- Follow the stepwise fallback in price searching (supplier and group wildcards).
- Cost price may be calculated if missing, based on item contribution margin or group.
- Subroutine call structure: initialization, price search, file I/O, and clean exit.
- Parameters are all passed by reference (classic RPG style).

---

**This program is a robust, modular pricing lookup utility designed to be called by other programs, returning all relevant prices/calculations for an item as of a given date and context (unit, group, supplier, delivery type).**