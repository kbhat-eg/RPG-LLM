# RPG Program Explanation: HT701R

This program, written in IBM ILE RPG, is designed to read records from a hand terminal file and transfer them to a batch register for inventory counting (METO system). The comments in the code are partially in Norwegian, so some variable names and comments may contain Norwegian terms.

## 1. File Declarations

```rpg
fhbtepf    if   e           k disk
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
flbdtlu    uf a e           k disk    rename(lbdtpfr:lbdtlur)
```

- **hbtepf**: Input file for the hand terminal (the records to process).
- **vvarl1**: Input file for item (product) master, renamed for clarity.
- **lbdtlu**: Output file for the batch register, renamed for clarity.

## 2. Data Structures and Variables

### Local Data Area

```rpg
d                uds
d l_user                911    920
```
- Defines a user field (`l_user`) in the user data space.

### Parameter Data Structure

```rpg
d                 ds
d d_list                        64
d  d_firm                        3  0 overlay(d_list)
d  d_batc                       10    overlay(d_list:4)
d  d_numm                        6  0 overlay(d_list:14)
```
- `d_list`: Raw parameter area from program entry.
- Overlay fields extract data for:
  - `d_firm`: Firm number (3 digits).
  - `d_batc`: Batch number (10 char), offset 4.
  - `d_numm`: Some identifier/number (6 digits), offset 14.

### Hand Terminal File Structure

```rpg
d                 ds
d d_ht                          22
d  d_ht_vare                     8    overlay(d_ht)
d  d_ht_enhe                     3    overlay(d_ht:9)
d  d_ht_anta                    11    overlay(d_ht:12)
```
- `d_ht`: Raw hand terminal record.
- Overlays:
  - `d_ht_vare`: Item number (8 char)
  - `d_ht_enhe`: Unit (3 char)
  - `d_ht_anta`: Quantity (11 char)

### Other Variable Definitions

- `p_list`: Parameter list from *ENTRY (program entry).
- `vvarl1_var`: To hold item number for lookup (same type as VVARL1 field VVVARE).
- `w_anta_alf`: Temporary alphanumeric version of quantity.
- `w_firm`: Company number.

## 3. Mainline Logic

### Main Loop

```rpg
c                   read      hbtepf                                 60
c                   dow       *in60 = *off
    c                   exsr      behandling
    c                   read      hbtepf                                 60
c                   enddo
```
- Reads every record from the hand terminal file.
- For each record, execution branches to the `behandling` (processing) subroutine.

### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
```
- Standard program ending: sets LR (last record) indicator, terminating the program.

## 4. Subroutines

### behandling - Process Each Row

```rpg
c     behandling    begsr
c                   eval      d_ht = htinfo
c                   if        d_ht_vare = *blank
c                   goto      end_behand
c                   endif
    ...
c     end_behand    endsr
```
- Copies the current input record to `d_ht`.
- Skips processing if item number is blank.
- Sets up item lookup key and looks up the item in `vvarl1`.
- If not found, skips processing.
- If found, prepares data for the batch detail record:
  - Assigns company, batch, and other fields.
  - Constructs the key.
  - Converts quantity field as needed.
  - Sets timestamps and user data.
  - Writes the new batch detail record.

#### Quantity Conversion

```rpg
c                   eval      w_anta_alf = %subst(d_ht_anta:1:8) +
c                                          %subst(d_ht_anta:10:2) + '0'
c                   move      w_anta_alf    lvantt
```
- Extracts and manipulates the quantity field from the hand terminal data, possibly reformatting for the output record.

#### Tracking Fields and Audit

```rpg
6.10 c                   time                    lvodat
6.10 c                   time                    lvotim
6.10 c                   eval      lvousr = l_user
6.10 c                   time                    lvedat
6.10 c                   time                    lvetim
6.10 c                   eval      lveusr = l_user
```
- Sets creation and last update timestamps/user IDs for audit purposes (added in version 6.10).

### *inzsr - Initialization Subroutine

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_list
    ...
c                   eval      d_list = p_list
c                   eval      w_firm = d_firm
c                   endsr
```
- Receives and parses the parameter list at program start.
- Extracts company number to `w_firm` for further use.

### Key List Definition

```rpg
c     vvarl1_key    klist
c                   kfld                    w_firm
c                   kfld                    vvarl1_var
```
- Defines the composite key for access to the item master file: company + item.

## 5. Summary of Program Flow

1. On start, receives parameters (including company, batch, and identifier).
2. Reads each record from the hand terminal file.
3. For each record:
   - Validates that the item number is present.
   - Looks up the product in the item master file.
   - If found, prepares and writes a new batch detail record, setting necessary fields and audit information.
4. Loops until end of file, then exits.

## 6. Key Points for Onboarding

- The programâ€™s main purpose is to automate the transfer of hand terminal input records into the batch register for inventory processing.
- Input parameters and hand terminal record format are tightly specified; field overlays are used to extract subfields from raw data areas.
- The code is typical for older fixed-format RPG and relies heavily on data structures, overlays, and subroutines for program structure.
- Timestamps and user IDs are captured for tracking, following a 6.10 version update.
- All file operations and processing are record-based and sequential.

---

**If you are onboarding to this code:**
- Understand the data structures and overlays.
- Know the layout of the input hand terminal file, and the output batch register file.
- Familiarize yourself with the variable names (especially Norwegian terms for item, company, batch, unit, quantity, etc.).
- The main program loop and processing are centered around reading, validating, looking up, transforming, and writing records.