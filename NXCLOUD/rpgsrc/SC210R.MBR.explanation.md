# RPG Program SC210R - Maintenance of Budget Register (Vedlikehold av budsjett-register)

This ILE RPG program manages and maintains a budget register, allowing the user to view, edit, and handle budget (budsjett) and balance (saldo) records using subfiles for display and interaction. The code is written using RPG III/400 style (fixed-format), a common paradigm for IBM i (AS/400) business applications.

Below is a structured, detailed explanation of the program's organization and logic for developer onboarding.

---

## 1. **Global Setup and Metadata**

- **/TITLE**: Sets the program title.
- **H-Spec**: Control specification.
  - `datedit(*dmy.)` — Date edit format.
  - `option(*nodebugio)` — Disables debug I/O.

- **Header Documentation**: Details about the program, including version, description, and change history.

---

## 2. **File Declarations (`F-Specs`)**

- **sc210d**: Display file used for workstation interaction, with subfile `b1sfl` and subfile record number `srrn01`.
- **slakl1, slbul1 ... vvarl1**: Various database files, all defined as keyed (K) disk files, most using the `rename()` keyword to avoid name clashes.
- These files represent master and transaction data (budgets, types, groups, etc.) necessary for budget maintenance.

---

## 3. **Data and Work Field Declarations (`D-Specs`)**

- **Arrays with INZ (CTDATA)**:
  - `mld`, `txt`, `cmd`, `rpt`: Arrays holding messages, texts, command labels, and report/sort sequences.

- **Saldomatrise Arrays**:
  - `isa`, `ssa`, `san`: Arrays of 12 (one per month), store figures for monthly budgets, balances, etc.

- **Key Variables**:
  - Variables like `votyl1_otyp`, `vogrl1_oogr`, etc., mirroring key fields from various files for lookup/reference.

- **Miscellaneous Fields and Data Structures**:
  - Status, codes, display fields, command handling variables, etc.
  - **`w_*` fields**: Working fields for current firm, year, versions, codes, etc.

---

## 4. **Input/Output Maps (`I-Specs`)**

- **Array Mapping**:
  - Maps monthly numeric fields from files (e.g., `scbu01`–`scbu12`) to RPG arrays (`isa`, `ssa`, `san`), allowing indexed access.

---

## 5. **Main Control Flow (`C-Specs`)**

The flow is classic interactive RPG style, with tags and subroutine calls (EXSR) driving the logic.

### Main Processing Tags & Loops

- **`b2taga` (Tag)**: Main control loop.
  - Writes command area, processes "bare data" by running subroutine `xdsp01`.
  - Handles program exit, refresh (renew), roll, home key, and subfile positioning logic.
  - Processes search/position fields (`b2fis1`) to set working keys and refresh display.

### Subfile Handling

- **Reading the subfile**: Loop through subfile records, process user action selection (e.g., choosing to display item detail with option 5).
- **Building (displaying) details**: Calls subroutine `xc5bld` to show detail view for an item.

---

## 6. **Key Subroutines**

### a. **xc5bld - Handle Detail Screen for New/Change/View**

- Loops for interactive display and handling command keys (F5/F6 for year change, F9 for changing columns, etc).
- Handles navigation, updating display fields, and returning to master/subfile view.

### b. **xv1win - Change Column View**

- Presents/change column window, handles user changes to the detail columns.

### c. **xc5les - Load Data for Detail Screen**

- Clears and prepares the C5BLD (detail) screen.
- Sets up headers, year labels, and loads values for four columns, each supporting both saldo and budsjett (balance/budget) types.
- Chains into budget and balance files, maps values into display fields.
- Calculates totals and percentages per column/month for variances.

### d. **xclr01 - Clear Subfile**

- Clears the subfile and resets various control indicators.

### e. **xcrt01 - Fill Subfile**

- Reads records from the primary file according to key values, populates the subfile, computes necessary summaries, and invokes text lookups for headings.

### f. **xdsp01 - Display Subfile Control(s)**

- Presents the subfile control screen, handles enabling/disabling display control indicators.

### g. **hnttxt - Fetch Information from Register**

- Retrieves descriptive text based on code type and value (e.g., department, warehouse, order type, district, etc.), by calling appropriate programs or chaining into master files.
- Populates the display text fields in the subfile for user-friendly descriptions.

### h. **hntarr - Get Number Values From Code Array**

- Maps display fields to their appropriate report code numbers for later label lookup.

### i. **INIT Subroutine (`*inzsr`)**

- Initializes all relevant fields and arrays, sets default values, and establishes initial display state.

---

## 7. **Key Lists and File Operation Control**

- **Multiple KLISTS** define key fields for various file operations (lookup, update, etc.), aligning with key fields in physical/logical files.

---

## 8. **Program Entry (`*ENTRY` Parameter List)**

- Receives parameters for year, version, code, and type, sets up working fields accordingly.
- Initializes display texts, commands, columns, and default behavior.
- Triggers initial loading of the subfile.

---

## 9. **Supporting Tables (End of Source)**

- `mld`, `txt`, `cmd`, `rpt`: Contain fixed text constants for labels, command keys, headings, and report (sort) options.

---

# **Summary of Main Functional Flow**

1. **Startup / Initialization**:
   - Receives context (year, version, code, etc.), initializes working storage, and builds the initial subfile.
   
2. **Master and Subfile Display**:
   - Keeps the main subfile with relevant records on screen, allowing user to select, refresh, roll, or reposition.

3. **Detail Entry / Maintenance**:
   - On user request (e.g., option 5/View), switches to detail maintenance, allowing editing/navigating columns and years, viewing or updating data.

4. **Description and Label Retrieval**:
   - Whenever displaying a code (dept., product, district, etc.), program fetches and shows the corresponding name/description for clarity.

5. **Totals, Calculations, and Variance**:
   - Sums up monthly values, supports both amount (BELØP) and quantity (ANTALL) modes, and computes percentage variances for columns.

6. **Exit and Resource Cleanup**:
   - Properly ends program execution and closes resources.

---

## **Key Points for New Developers**

- This program is a classic example of RPG subfile-driven maintenance applications.
- The heart of the application is a cyclical loop (`b2taga`) that handles user input and subfile interaction.
- All data access is via keyed file I/O; file keys are carefully constructed for each operation.
- There is a tight mapping between codes used internally and descriptive labels/text for usability.
- All display logic is driven by subroutines that map backend data to screen arrays/fields.
- Command key handling, paging, and column changes are central to user workflow.

---

## **Glossary of Norwegian Terms Used**

| Term         | Meaning                       |
|--------------|------------------------------|
| Vedlikehold  | Maintenance                  |
| Budsjett     | Budget                       |
| Saldo        | Balance                      |
| Avdeling     | Department                   |
| Lager        | Warehouse / Stock            |
| Ordre-type   | Order Type                   |
| Distrikt     | District                     |
| Selger       | Salesperson                  |
| Kategori     | Category                     |
| Leverandør   | Supplier                     |
| Gruppe       | Group                        |
| Vare         | Item/Product                 |

---

This explanation covers the overall structure, subfile usage, main subroutines, and how key RPG idioms are applied in this budget register maintenance program. If you need a deep dive into any particular function or section, feel free to ask!