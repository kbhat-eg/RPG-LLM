# Program Overview

This ILE RPG program handles the display and retrieval of product (item) information, with integrated support for prices, units, notes, supplier info, and various related product metadata. It is designed as a screen program, using subfiles to show multiple prices/lines for a single product, and supports multiple function keys for related tasks.

The application appears to be used in a retail, wholesale, or supply chain context, given the rich product, pricing, and unit information.

## File Declarations

- **Physical & Logical Files:**  
  The program uses a number of externally-described files for item master data (`vvarl1`, `vvasl1`), item units (`vvenl1`), item prices (`vvprl1`, `vvprlr`), product groupings (`vugrl1`, `vhgrl1`), notes (`anotl1`), suppliers (`rlevl1`), and integration with VA (maybe an external system `jvarl1`).

- **Workstation File:**  
  `vv510d` is the display file, using a subfile (`b1sfl`) for lists and a display feedback data structure.

## Data Structures

- **Parameters:**  
  `p_firm`, `p_vare` hold input parameters for company and item.

- **Local Data Area (LDA):**  
  Used to store local info, including filenames.

- **Display Feedback (INFDS):**  
  `dspfbk` holds display file feedback, e.g. for function key pressed.

## Key Variables

- Numerous working storage fields starting with `w_` are used throughout the program for temporary holding of values (e.g. `w_firm`, `w_vare`, `w_tek1`, etc.).
- Flags like `b_prgr` or `u_701` control specific business logic paths.

## Subroutines

### *Main Screen Flow*

1. **Initialization:**  
   - Product lookup by key (`vvarl1_key` or `vvasl1_key`).  
   - If found, load item info, initialize subfile and supporting fields.
2. **Subfile Population:**  
   - Loads price information lines (potentially several per item) into a subfile.
   - Handles price groups (special pricing rules).
3. **Function Key Processing:**  
   - Responds to various function keys (F2=Note, F10=VA info, F13=Next screen, F14=Units, F15=Prices, F16=Search, F17=EAN/GTIN Number, F18=Offer Prices, F21=Supplier Info).
   - Calls other programs or re-displays the same screen as needed.
4. **Exit:**  
   - Sets on LR flag and returns.

### *hent_vare*
- Loads basic and detailed product info into working variables for display and further processing.
- Loads associated textual descriptions and status flags.
- Calls `hent_kontr` for group and supplier info.
- Checks for attached notes, setting a UI flag if present.
- Clears and rebuilds subfile with price lines.

### *crt_subfile*
- Iterates through possible product units, for each:
  - First tries to find price with an explicit price group.
  - Then (if not found/allowed) tries price with a blank price group.
  - Validates price values (max values), handles price group display logic.
  - Calculates margin (`dekningsgrad`) via `kalk_dekn`.
  - Writes each line to the subfile.

### *dsp_subfile*
- Manages subfile display, including setting indicators for display control, showing subfile if it has records.

### *clr_subfile*
- Clears/reset subfile and related control variables.

### *hent_kontr*
- Retrieves product group and supplier descriptions for display.

### *kalk_dekn*
- Calculates the gross margin (dekningsgrad) for each price line.
- Uses either direct calculation or falls back to item/group margin if cost price is missing.

### *sjekk_prisgr*
- Checks if a price group exists for the current item/unit/supplier combination.

### *vis_VA*
- Calls external program to show VA-specific info (via `JV145R`).

### *Initialization Routine (`*inzsr`)*
- Handles parameter list and initializes key lists for record selection.
- Sets up key structures and loads initial values.
- Retrieves additional control values (e.g., `u_701`), runs special version/price group logic.

## External Calls

- **Other RPG Programs:**  
  Calls to external programs such as `'AU500R'` (notes), `'VV102R'` (next screen), `'VE510R'` (units), `'VP505R'` (prices), `'VS500R'` (search texts), `'VE515R'` (EAN/GTIN info), `'VT510R'` (offer prices), `'VV130R'` (supplier info), `'JV145R'` (VA info).
  Most are passed the core product keys.

- **APIs (CO402R):**  
  Used for setup or control parameter retrieval (e.g., to control display of blank price groups).

## Business Logic Observations

- **Price Grouping:**  
  Sophisticated handling of price groups, including showing or hiding based on rules and settings (see `u_701`, `b_prgr`).

- **Subfile Max Value Validation:**  
  Ensures that no price field exceeds 9999999.99 to avoid overflow/display issues.

- **Function Key Handling:**  
  Broad support for extended navigation and information access via F-keys.

- **Notes/Annotations:**  
  Tightly integrated, with a system check to flag presence of notes.

- **Multi-language/Localization:**  
  Some comments/labels appear in Norwegian.

## Typical User Flow

1. **Enter product and company number (via parameters or selection).**
2. **Screen displays core product info in header, subfile with price/unit breakdown.**
3. **User can press function keys to jump to related info/screens/functions.**
4. **Display refreshes in response to most actions; user can exit the program.**

## Maintenance/Enhancement Notes

- **Version History:**  
  Extensive version/comment history at the top helps track business changes and enhancements.
- **Key Lists:**  
  Strong use of `klist/kfld` to simplify keyed file access.
- **Extensible Structure:**  
  Subroutines can be extended for additional business logic with minimal disruption.

---

## Summary Table

| Routine         | Purpose                                          |
|-----------------|--------------------------------------------------|
| hent_vare       | Loads product info into display/working fields    |
| crt_subfile     | Populates subfile with price/unit lines           |
| dsp_subfile     | Handles main subfile display logic                |
| clr_subfile     | Clears subfile lines and counters                 |
| hent_kontr      | Loads product group/supplier descriptions         |
| kalk_dekn       | Calculates price margin (dekningsgrad)           |
| sjekk_prisgr    | Checks existence of price group lines             |
| vis_VA          | Calls external program to display VA info         |
| *inzsr          | Program initialization/setup                      |

---

## Key RPG Concepts Demonstrated

- External file I/O (CHAIN, SETLL, READE)
- Subfile processing
- Workstation programming (display file with function key processing)
- Modularization via subroutines (`begsr/endsr`)
- Calls to other RPG/COBOL programs with parameter lists
- Use of INFDS (display feedback)
- Dynamic price/margin calculations

---

## Onboarding for Developers

- **Start by understanding the display file (`vv510d`), especially the subfile record (`b1sfl`) and control record (`b2ctl`)â€”these drive the UI.**
- **Review how parameters (firm, item) flow through the program and how they're used to select records and branch logic.**
- **Become familiar with the price group implications (`w_prgr`, `b_prgr`, `u_701`) and their effect on subfile population.**
- **Note the function key mapping and associated external program calls; you'll often need to look at those programs for full behavior context.**
- **Leverage the version history at the top for business context and to understand the rationale for various logic branches.**
- Work through each subroutine to see how it logically progresses data from file input, through calculations, to display.
- **If extending or modifying, pay careful attention to the key lists (`klist`) and ensure that any changes to product lookups or pricing logic maintain the integrity of the relationship between product, unit, supplier, and price group.**