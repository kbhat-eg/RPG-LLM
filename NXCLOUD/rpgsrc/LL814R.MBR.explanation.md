# Overview  
This ILE RPG program (`LL814R`) reads and updates batch-based inventory count (“telle-register”) records. For each count line it:  
- Filters out irrelevant lines (suffix ≠ 0)  
- Looks up product and prepares update records  
- Optionally fetches unit conversion, prices, product groups, and last stock balance  
- Writes back updated count details with timestamps and user info  

---  

## 1. Header (H-spec)  
```rpg
     h option(*nodebugio) datedit(*dmy)
```  
- Disables debug I/O  
- Uses DD-MM-YYYY date format  

---  

## 2. File Declarations (F-specs)  
Each file is defined with a prefix and rename of record format:  
- **ltell1** (input “telleregister” batch header)  
- **ltellu** (update “telleregister” detail)  
- **vvarl1** (product master)  
- **lbchl1** (batch register)  
- **vhisl3** (historical stock movements)  

All are keyed disk files; `uf` means update file.  

---  

## 3. Data Definitions (D-specs)  

### 3.1 Local Data Area (LDA)  
```rpg
     d                uds
     d l_user          911    920   // User from LDA  
     d l_firm          944    946   0 // Company from LDA  
```  

### 3.2 Parameter & Data Structure  
```rpg
     d p_list          s             64  // Incoming parameter list  
     d                 ds
     d d_list                        64
     d  d_batc                       10  overlay(d_list)
     d  d_val1            1  0 overlay(d_list:11)
     d  d_val2            1  0 overlay(d_list:12)
     d  d_val3            1  0 overlay(d_list:13)
     d  d_val4            1  0 overlay(d_list:14)
```
- `d_batc`: batch number  
- `d_val1`–`d_val4`: flags to control fetching of prices, unit, product groups, stock  

### 3.3 Keyed Field Variables  
Fields for building keys and holding record data, e.g.:  
- `ltell1_batc`  ← batch key for input  
- `ltellu_batc`  ← batch key for update  
- `ltellu_numm`,`ltellu_suff`,`ltellu_line` ← record identifiers  
- `vvarl1_vare` ← product code  
- `vhisl3_*`  ← historic stock key fields  

### 3.4 Working Variables  
```rpg
     w_lety         1    // price type  
     w_inlr         1    // reset indicators  
     w_bupr       9 2    // purchase price  
     w_inpr       9 2    // invoice price  
     w_avde        4 0   // inventory area  
     w_prgr        2     // price group  
     w_firm            like(lefirm) // company  
     w_enh1            like(leenh1) // old unit  
```

---  

## 4. Main Logic  

1. **Initialize loop**  
   - `ltell1_batc = d_batc`  
   - `SETLL` and `READE` on `ltell1` to find all count detail records for this batch.  

2. **Loop through records**  
   - Skip if `lesuff <> 0` (only process suffix=0).  
   - CHAIN to **vvarl1** (product master); skip if not found.  
   - CHAIN to **ltellur** (detail update file); skip if not found.  

3. **Unit of Measure**  
   - Save `w_enh1 = leenh1` (original unit).  
   - If `d_val2=1` **AND** `ledlop=0` (first pass flag):  
     - Set `leenh1 = vvenhl` (default unit from product)  
     - If `letek1` blank, set from `vvtek1`.  

4. **Fetch Prices** (when `ledlop=0` _AND_ (`d_val1=1` **OR** unit has changed))  
   - Reset flags: `w_lety=0, w_inlr=*off`  
   - (Optional) call subroutine `hent_prisgr` to get price group  
   - CALL external program `'VP701R'` with parms:  
     `w_firm, levare, w_prgr, leenh1, w_lety, lcbdat, w_inlr, lespny, w_bupr, lekpny, w_inpr`  

5. **Fetch Product Group** (if `d_val3=1`)  
   ```rpg
     leogrp = vvogrp
     lehgrp = vvhgrp
     leugrp = vvugrp
   ```

6. **Fetch Last Stock Balance** (if `d_val4=1`)  
   - EXSR `hent_saldo`  

7. **Update Record**  
   - Write current date/time (`LEEDAT`,`LEETIM`) and user (`LEEUSR = l_user`)  
   - `UPDATE ltellur`  

8. **Repeat** with next `READE` until *IN90 = *ON  

9. **Exit**  
   - Set `*INLR = *ON` and RETURN  

---  

## 5. Subroutine: hent_saldo  
```rpg
begsr hent_saldo
  // Position to last historical record
  vhisl3_vare = levare
  vhisl3_lage = lelage
  vhisl3_dato = lcbdat
  vhisl3_time= lcbtim
  SETLL vhisl3
  READP vhisl3
  if not %eof and vhvare = levare
     leantl = vhbehl    // stock on hand
  else
     leantl = 0
  endif
endsr
```
- Uses **READP** to get the most recent stock movement.  

---  

## 6. Subroutine: hent_prisgr (RPG V5.70+)  
```rpg
begsr hent_prisgr
  w_avde = 0
  CALL 'VL712R'
    PARM w_firm, lelage, w_avde, w_prgr
endsr
```
- External program `'VL712R'` returns the two-digit price group (`w_prgr`).  

---  

## 7. Initialization Subroutine (`*INZSR`)  
(Automatically invoked on program start)  

- **KLIST Definitions** for each keyed file:  
  - `ltell1_key`: `w_firm, ltell1_batc`  
  - `ltellu_key`: `w_firm, ltellu_batc, ltellu_numm, ltellu_suff, ltellu_line`  
  - `vvarl1_key`: `w_firm, vvarl1_vare`  
  - `lbchl1_key`: `w_firm, lbchl1_batc`  
  - `vhisl3_key`: `w_firm, vhisl3_vare, vhisl3_lage, vhisl3_dato, vhisl3_time`  

- **Parameter unpack**: `d_list = p_list`  
- **Load company** from LDA: `w_firm = l_firm`  
- **Read batch register**:  
  ```rpg
  lbchl1_batc = d_batc
  CHAIN lbchl1
  ```
- End of init.