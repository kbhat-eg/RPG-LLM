# Explanation of RPG Program SB611R

This program is written in the traditional fixed-format ILE RPG and is named `SB611R`. Its purpose is to print records from a budget register (budsjett-register), filtering them based on parameters received from a calling program. It reads records, checks if they match the criteria, processes some summarization, and writes a formatted report to a printer file.

Below is a structural breakdown and explanation.

---

## 1. File Declarations

```rpg
fskbul1    if   e           k disk    rename(skbupfr:skbul1r)
fsb611p    o    e             printer
```

- **skbul1**: Input file (likely physical file holding the budget records), keyed access, external, renamed as `skbul1r` in program.
- **sb611p**: Output printer file to produce the report.

---

## 2. Data Structure Definitions

### Parameter Data Structure (input)

```rpg
d                 ds
d wsparm                        64
d  wsfirm                        3  0 overlay(wsparm:01)
d  wshhaa                        4  0 overlay(wsparm:04)
d  wsvers                        2    overlay(wsparm:08)
d  wsakod                       12    overlay(wsparm:10)
d  wsaabb                        1    overlay(wsparm:22)
d  wskode                       12    overlay(wsparm:23)
```
- `wsparm`: 64-byte area for input parameters.
- Subfields are overlays, extracting specific information from `wsparm`. These likely identify company, year, version, codes, etc.

### Others
- `umtid` and `h1date`: For system date/time.
- `wxkode` and subfields: Used for mapping/decoding classification codes.
- Local Data Area fields (user info, etc.).
- Numeric/character variables for keys and fields in the file.

---

## 3. Variable Initialization

In `XINIT` section, key variables and search fields are set:

```rpg
c                   eval      w_firm      = wsfirm
...
c                   eval      skbul1_vare = *blank
```

- Variables for filtering (`w_firm`, `w_hhaa`, etc.) are set from input param fields.
- All "skbul1_xxx" fields are initialized to zero or blank before reading the file (these participate in the file search key).

```rpg
c     skbul1_key    setll     skbul1
```
- Establishes the start point for file reading based on those keys.

---

## 4. Main Processing Loop

```rpg
c     xstart        tag
c                   read      skbul1                                 10
c     *in10         cabeq     *on           xslutt
```

- Reads each record in `skbul1` matching the key.
- If EOF (`*IN10`), branch to `xslutt` for program end.

### Filters
```rpg
c     sbfirm        cabne     w_firm        xslutt
c     sbhhaa        cabne     w_hhaa        xslutt
...
```
- Checks if the current record's key fields match the search criteria. If any don't, processing ends.

### Processing
```rpg
c                   exsr      budsjett
...
c                   z-add     sbbu01        l1bu01
...
c                   write     l1line                               30
c                   if        *in30 = *on
c                   exsr      overflow
c                   endif
c                   goto      xstart
```

- Calls subroutine `budsjett` to process classification fields.
- Moves budget values (`sbbu01` to `sbbu12`) to output line fields.
- Writes the detail line to the printer.
- If overflow (`*IN30`), writes a heading.
- Loops for next record.

---

## 5. Ending the Program

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Closes files/program.

---

## 6. Subroutines

### `overflow`
- Writes a header line (`H1HODE`) when page overflow is detected.

### `budsjett`
- Moves the appropriate classification field from the record to the print line, depending on active indicators set by prior logic.
- Handles fields like Avdeling (Department), Lager (Warehouse), Land (Country), etc.

### `binit`
- Based on the content of `wxkode`, sets which indicators are on (for later printing in headings).
- Assigns display labels (e.g., 'Avdeling', 'Lager', etc.) to heading lines.

### `*inzsr`
- Program initialization subroutine.
- Sets up file keys for record reading.
- Processes input parameters and initializes heading indicators.
- Writes report heading line before any details.

---

## 7. Program Entry (`*ENTRY`)

- Accepts parameter `dsparm` (64 bytes), moves it to `wsparm` for field extraction.
- Retrieves system time.
- Calls `binit`.
- Writes first heading line.

---

## 8. Other Notes

- `move`, `movel`, and `z-add` are classic RPG operations for moving and zeroing data.
- Conditional op-codes like `cabne` (Compare and Branch if Not Equal) handle field matching.
- Indicators (e.g., `*IN41`, `*IN30`) are used to control logic, especially for output formatting and field selection.

---

## 9. Summary

- **Purpose:** Report (print) selected records from a budget register based on parameters.
- **Input:** Selection criteria via PARM (company, year, version, codes, etc.).
- **Filtering:** Only records that match search keys are processed.
- **Output:** For each selected record, lines of budget figures are printed, with page headings handled on overflow.
- **Flexibility:** The report columns/headers are dynamically defined based on input codes.

---

## 10. Onboarding Hints

- New developers should read up on file handling, data structures, and indicator usage in traditional RPG.
- Understand the file layout for `skbul1` (definition not in this code).
- Recognize that most subfield and label naming is domain-specific (Norwegian business context).
- Moving to modern RPG (RPG IV/free) would make this easier to read and maintain.