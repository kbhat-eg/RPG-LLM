# RPG Program FD130R: Creation of Order Lines from Item Data

## Overview

This is an ILE RPG (RPG IV) program for IBM i (AS/400) used in an order management system. The primary responsibility of the program is to create and register order lines ("ordre-linje") for items, fetching relevant prices, discounts, available units, and updating inventory. The program performs robust data validation, utilizes various database files, and supports feature-rich user interaction for order entry.

---

## Main Components

### 1. **File Declarations (`F-specs`)**

- The program uses multiple physical and logical files to fetch information about items (`vvarl1`, `jvarl1`), users (`fusrl1`), prices (`fpril1`, `fprnl1`), order headers (`fohel1`), etc.
- Workstation file `fd130d` is used for screen I/O (order entry interface).

### 2. **Data Definitions (`D-specs`)**

- **Parameters:** Variables like `p_firm`, `p_vare`, `p_enhe`, etc. are used as parameters for the program (e.g., item number, company code, unit, etc.).
- **Data Structures:** Several data structures are defined for interfacing with external programs (for fetching prices, holding inventory updates, etc.).
- **Local Variables:** Variables are declared for holding amounts, prices, descriptions, status, etc.
- **Constants:** Used for character conversions and validation (e.g., to convert item text to upper case).

---

### 3. **Program Flow (`C-specs` Mainline)**

#### a. **Fetch Item Information**

- **Standard Item:** Try to find the item in `vvarl1`. If not found, check `jvarl1` (special items). If both fail, exit.
- If found in `jvarl1`, marks it as a "procured" item (not in standard assortment), copies relevant item data, and sets item type.
- Fetches extended information: EAN number (`VE711R`), item type (`VL710R`), and price group from warehouse/department (`hent_prisgr` subroutine).

#### b. **Price Information Handling**

- If not a procured item, fetch prices for up to three units using `VP715R`.
- Otherwise, reads package information from `jvpkl1`.
- Handles packaging date validation (subroutine `sjekk_pkdato`).

#### c. **User Interface Loop**

- Shows registration screen (`exsr xc1win`).
- If the user cancels or exits, the program ends.

#### d. **Order Line Creation**

- Collects values from the display fields and populates the order line data structure (`fodtlur`).
- Calculates totals and discounts.
- Validates special line types (e.g., credit lines) for value sign correction.
- Populates data fields with values from items, orders, and user parameters.
- Translates item description to uppercase if requested.
- Writes the new order line (`write fodtlur`).
- Calls inventory update subroutine.

#### e. **Set Return Parameters & End**

- Sets return codes indicating successful registration and whether cost price should be shown.

---

## Subroutines

### - **notat**: Fetches and displays special price agreements/notices, searching in order of specificity (customer/project/unit) to general (customer only).

### - **xc1win**: Handles the core order entry screen logic.
- Initializes screen with prices, discounts, warehouse stock, etc.
- Validates user input for correct units, quantities, line types, dates, etc.
- Allows function keys for actions like manual cost calculation, item info, warehouse info, notes, and various item/line-specific actions.
- Recalculates prices and discounts based on changes in unit, type, or other fields, including "cost plus" and "coverage percentage (DG)".

### - **hent_pris**: Calls pricing engine (`VP900R`) with all relevant context (customer, item, date, discounts, etc.) to retrieve calculated sales and cost prices.

### - **kalkulator**: Converts entered quantity among different units (up to 3), adjusting prices if unit changes for procured items.

### - **lagerbeholdn**: Fetches current warehouse inventory for the item/unit via external program (`VL700R`).

### - **dekning**: Calculates the required sales price for a given cost price and desired gross margin (coverage percentage).

### - **oppdat_lager**: Prepares an inventory update record and calls warehouse update program (`VL001R`).

### - **sjekk_lager**: Checks if the warehouse code is valid for the given company.

### - **hent_prisgr**: Retrieves the price group for the warehouse/department by calling external program (`VL712R`).

### - **sjekk_pkdato**: Validates if the current date is within a package's valid-from/to date range.

---

## Initialization (`*inzsr`)

- Reads incoming parameters into local working variables.
- Prepares keys for file lookups.
- Fetches current date.
- Looks up system/user/order header context.
- Initializes VAT rates via external program (`FÃ˜705R`).

---

## Key Features and Business Logic

- **Multiple Unit Handling:** Supports up to three units of measure per order line, with conversion and pricing for each.
- **Dynamic Price Calculation:** Integrates with external programs to fetch pricing, handle price overrides, discounts, and margin calculations.
- **Extensive Validation:** Thorough checks on quantities, units, line/item types, project/activity codes, and dates. Prevents invalid or incomplete data entry.
- **Inventory Synchronization:** Updates warehouse stock in real time upon order line registration.
- **Discount Stacking:** Handles multiple discount layers (order, item, line, campaign, etc.).
- **User Authorization:** Controls visibility of cost price based on user rights.
- **Screen Interaction:** Implements complex user interaction and branching using indicators and function keys.

---

## Extensibility

- The program is structured to allow code enhancements and bug fixes with version/history comments.
- Subroutines are used for modularity and reuse (e.g., price fetch, note display, inventory check, etc.).
- Versions and special modifications are tracked, indicating good maintenance practices.

---

## Summary Table

| Aspect                  | Implementation Details                                       |
|-------------------------|-------------------------------------------------------------|
| **Item Info**           | vvarl1 (standard), jvarl1 (special/procured)                |
| **Price Calculation**   | VP715R, VP900R, discounts, margin, override logic           |
| **Inventory**           | VL700R (fetch), VL001R (update)                             |
| **Order Line Entry**    | Screen `fd130d`, fields mapped to/from database/parameters  |
| **User Validation**     | Extensive, with feedback to user via indicators             |
| **Notes/Agreements**    | fpril1, fprnl1 (special pricing notes)                      |
| **Ext. Integration**    | Several *CALLs to external RPG programs                     |
| **Multiple Units**      | Three units per item, conversion logic                      |
| **Function Keys**       | Manual price/cost, product info, note, inventory, etc.      |

---

## Onboarding Notes

- **External Programs:** Many subroutines rely on external RPG programs (e.g., for price fetching, inventory updates, validation). Ensure you have the specs/interfaces for these programs.
- **File Structures:** Make sure you have access to definition of all the database files and knowledge of key structures and field layouts.
- **Indicators:** Understand how indicators (e.g., *in31, *in86, *in49, etc.) are mapped to screen fields and user actions.
- **Parameter Passing:** Entry parameters both control screen data and provide return values (e.g., `p_kode`, `p_kost`).
- **Screen Layout:** The user interface is defined in `fd130d` and uses subfile records for dynamic behavior.
- **Language:** Some comments and field names use Norwegian (e.g., "vare" = item/product, "ordre" = order, "pris" = price, "kunde" = customer). Familiarity may be helpful.

---

## Final Remarks

This program is a classic example of a robust, feature-rich IBM i RPG program for order line processing. Despite its age and complexity, it is well-structured and documentated, providing many extension points and ample validation for reliable business operations.