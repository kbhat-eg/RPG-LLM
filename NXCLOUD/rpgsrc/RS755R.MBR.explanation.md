## Program Overview

This RPG program, named **RS705R** in system **ASOKON**, determines the correct VAT (Value Added Tax, “merverdiavgift” or “mva” in Norwegian) rate to use based on a provided date and VAT code. It receives input parameters and returns the appropriate VAT values for both calculations and display.

The main design reflects standard patterns in this codebase:
- It is data-driven, using master data from file **RA05L1** (VAT code master).
- Business logic is encapsulated for reuse.
- Clear conventions on parameter usage and output error handling.
- Indicators (positions 60-61) are used for record operations instead of named RPG indicators.

---

### High-Level Flow

1. **Initialization** happens in the *inzsr subroutine*, setting initial parameter values and loading user context.
2. The program expects parameters for:
    - VAT status (`p_stat`)
    - VAT code (`p_ekod`)
    - VAT code text/description (`p_etxt`)
    - Transaction date (`p_dato`)
    - VAT calculation factors: percent (`p_mvap`), inclusive (`p_mvat`), exclusive (`p_mvaf`)
3. **Lookup**: It performs a keyed chain on **RA05L1** (VAT master) using company and code.
4. **Validation**: If the record doesn’t exist (`*in60`), it sets return code and explanatory text.
5. **Logic**: Selects the correct VAT rate based on the supplied date and record fields:
    - If the date is after the record's effective date (`raemda`), it uses `raepro`; otherwise, `raegpr`.
6. **Calculation**: Converts the VAT rate for various uses (base percentage, for gross or net calculations).
7. **Termination**: Sets LR and returns.

---

## Key Data Structures and Parameter Conventions

- **File RA05L1** (known as `ra05l1r` in code) is the VAT master and contains:
    - Company (`raefir`)
    - VAT Code (`raekod`)
    - Text/description (`raetxt`)
    - Effective date for new rate (`raemda`)
    - Current/prospective rates (`raepro`, `raegpr`)
- **Parameters (PLIST / PARM)**:
    - These correspond to in/out variables for status, key, text, date, and calculation factors.
    - **Status**: Blank = OK, 'N' = Not found/invalid.
    - **Calculation outputs**:
        - *p_mvap*: The VAT percent (e.g., 25.00).
        - *p_mvat*: For gross-up (divide net by this value to get gross).
        - *p_mvaf*: For net-down (divide gross by this value to get net).

---

## Detailed Logic and Business Rules

### 1. VAT Code Lookup and Validation

- The program expects a company number (`w_firm`) and VAT code (`p_ekod`).
- Combines these as the file key (`ra05l1_key`).
- `chain` retrieves the record using this key.
- If not found, indicator 60 is on – the program:
    - Sets `p_stat` = 'N'
    - Sets `p_etxt` = "Koden er ugyldig" ("The code is invalid")
    - HALTS further calculation.
- If found, the code description (`raetxt`) is returned in `p_etxt`.

### 2. Selecting Correct VAT Rate

- **Date Logic**: Each VAT code may have a current (`raegpr`) and a new/prospective rate (`raepro`) with an effective date (`raemda`).
- If the supplied transaction date (`p_dato`) is on or after the effective date, use the new rate; otherwise, the old one.
- The chosen rate is stored in `w_mvas`.

### 3. Calculating VAT Factors

- The calculation formulas ensure accuracy in both adding and removing VAT:
    - VAT percentages are always “plus 100” (e.g., a rate of 25 implies 125 for calculations).
    - *Inclusive factor* (`p_mvat`): This is the multiplication factor to get from net to gross price (i.e., net * 1.25 for 25% VAT).
    - *Exclusive factor* (`p_mvaf`): The multiplication factor to get from gross back to net (i.e., gross * 0.8 for 25% VAT).
    - The raw percentage (`p_mvap`) is the actual VAT portion (e.g., 25.00).
- Note: The calculations protect against decimal inaccuracies and preserve scale (see data definitions, e.g., `5 2`, `5 4`, `10 9`).

---

## Design Notes and Patterns

- **Initialization**: *inzsr* sets output parameters to neutral numbers and loads `w_firm` from a user area. This is a company-contextual system.
- **Indicator Conventions**: File operations use positions 60-61; no indicator variables.
- **Status Handling**: Always check `p_stat` before using output values.
- **Parameter List (PLIST)**: All outputs are passed back as parameters for integration by calling programs/modules.
- **Date Handling**: Inputs and field comparisons use `*iso` format (YYYY-MM-DD).

---

## Integration and External Relationships

- This program is a core utility in VAT calculations; always reference it for determining correct VAT rates for any date-sensitive transaction.
- **RA05L1** is maintained elsewhere (master data); rates and effective dates are not hardcoded here.
- If integrating or changing other calculations, always use the output factors as described: multiplication or division by `p_mvat` or `p_mvaf` as appropriate.
- **Calling programs** must supply all parameters, and handle 'N' in `p_stat`.

---

## Summary

**RS705R** encapsulates business logic for selecting and applying the correct VAT rate for a transaction, taking into account company, VAT code, and transaction date. The approach is robust, data-driven, and intended for generalized use by other modules to ensure VAT is applied consistently across the system. All logic for VAT rate changes is managed in master data, decoupling rate changes from code changes. 

If you need to update logic for future VAT changes, adjust your master data; if new calculation types are required, these may need to be added to this or a similar program.