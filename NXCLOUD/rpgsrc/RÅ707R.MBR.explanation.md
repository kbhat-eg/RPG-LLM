```markdown
# RPG Program: Firm/Department Information Retriever

This program, named **RÅ707R** (originally copied from FÅ707R), is an ILE RPG application designed to retrieve and return company ("firma") or department ("avdeling") information, including formatted banking/giro details, from database files. The code is written in traditional (fixed-format) RPG IV.

---

## High-level Functionality

- The program takes input parameters indicating which firm/department to look up.
- It retrieves the relevant records from two files (`AFIRL1` and `FRA07PF`).
- Populates the output parameters (company name, address, bank giro, etc.) for use by the calling program.

---

## Key Sections and Concepts

### 1. File Declarations

```rpg
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
fra07pf    if   e           k disk
```
- **fafirl1**: Input file based on record format `afirpfr`, renamed locally to `afirl1r`.
- **fra07pf**: Another input file, likely containing department information.

### 2. Parameters and Data Structures

Parameters (`p_*` variables) are used to pass data in and out of the program.

**Bankgiro Data Structures** are defined to split/build giro numbers:
```rpg
d                 ds
d d_ktoa                        11  0
d  d_kta1                        4  0 overlay(d_ktoa)
d  d_kta2                        2  0 overlay(d_ktoa:5)
d  d_kta3                        5  0 overlay(d_ktoa:7)
```
- `d_ktoa`: Total 11 digits as integer, with overlays to access parts.

Similar structure exists for the edited output `d_ktob` (13 chars).

### 3. Key Handling Variables

Variables for database keys are defined to control which records are looked up.

### 4. Main Logic

#### Initialization

Sets all output strings to blanks/zeros before any lookup.

#### Company Lookup

- Loads the key into `afirl1_ffir`.
- Does a `chain` (search) on `afirl1r` using the key.
- If found, populates output fields with data from the record:
    - Company name, address, postal code, etc.
    - Formats the MVA ("VAT") text depending on `l_poff` and `aamvap` flags.
    - Fills in telephone and fax info.
    - Loads the bankgiro number for further processing.

#### Department Lookup (Optional)

- If parameter `p_prfi` = 2 (means: also look up department info):
    - Does a `chain` (search) on `fra07pf` using firm's key and department code.
    - If found, overwrites address fields with department data.
    - Replaces bankgiro number if department's record supplies one.

#### Bankgiro Formatting

- Copies the numeric components from the integer format to the output alpha format, ensuring that spacing/format is OCR-friendly.
- Final bankgiro is presented as a 13-character string.

#### Program End

- Sets LR (Last Record indicator) to *ON and returns to the caller.

---

## *INZSR: Initialization Subroutine

- Establishes the key lists for file lookups.
- Loads all parameters from the call stack ("*entry plist").
- Assigns received firm number to the local key variable.

---

## Special/Noteworthy Details

- **Norwegian Context:** Texts like "Foretak: NO ... MVA" relate to Norwegian company and VAT formatting.
- **Flexible Output:** The program can provide either company or department data, depending on the incoming parameter.
- **Bankgiro Formatting:** The use of overlays and moves ensures the bankgiro number is composed in a very specific format for downstream use (e.g., for OCR, printouts).

---

## Summary Table of Key Variables

| Variable     | Purpose                                             |
|--------------|-----------------------------------------------------|
| p_prfi       | Selector: 1 = firm, 2 = department                 |
| p_ffir       | Firm number (key)                                   |
| p_avde       | Department code                                     |
| p_fnav       | Output: firm/department name                        |
| p_fad1/2     | Output: address lines                               |
| p_fste       | Output: postal code/state                           |
| p_fftx       | Output: formatted VAT text                          |
| p_tfax       | Output: label for phone/fax                         |
| p_ftlf       | Output: telephone                                   |
| p_ffax       | Output: fax                                         |
| p_tbnk       | Output: label for bankgiro                          |
| p_fbgi       | Output: formatted bankgiro number                   |

---

## Typical Usage

1. **Calling program** passes in firm/dept keys, plus blank output parameters.
2. RPG program retrieves all needed details and fills output variables.
3. **Caller** receives all company/department and bank info fully populated.
```
