# RPG Program Explanation

This RPG (Report Program Generator) source code is for an IBM i (AS/400) system. The code is written in the traditional fixed-format style and its main purpose is to perform a cleanup ("opprydding") operation on various files, specifically to delete all records belonging to a given firm (company) across multiple files.

Below is a breakdown of the code and its sections:

---

## **Header and Comments**

- `/TITLE  ASSTAT Opprydding i filer`  
  Sets the title and purpose of the program: cleanup of files related to "ASSTAT".
- Additional comments:
  - Program Name: `SF402R`
  - Description: Deletes a company ("Slette firma")
  - Includes history and change log.

---

## **File Declarations (F-Specs)**

All files are declared as external, update-capable, and disk-based, with keyed access:

- **Customer-related files:**
  - `skpmpf` : Customer parameter register
  - `skbupf` : Customer budget
  - `sknipf`: Customer budget level register
  - `skakpf`: Customer accumulation register
  - `skpcpf`: Customer statistics PC register
  - `sstapf`: Customer statistics register

- **Supplier-related files:**
  - `slpmpf`: Supplier parameter register
  - `slbupf`: Supplier budget
  - `slnipf`: Supplier budget level register
  - `slakpf`: Supplier accumulation register
  - `sistpf`: Supplier statistics

Each file is opened for update (`uf`), keyed access (`k`), and externally described (`e`).

---

## **Data Declarations (D-Specs)**

Variables mapped to data areas:

- `l_user` Positions 911-920 : Likely user id (unused in this code)
- `l_firm` Positions 944-946 : The firm number (numeric, 3 digits), central for selection/deletion
- `l_navn` Positions 951-980 : Name (unused in this code)

---

## **Main Logic (C-Specs)**

This is the core of the program. The structure is repeated for each file:

### **General Pattern**

1. **Read** a record from the file.
2. **While** not end-of-file:
   - If the record's firm field (`xxfirm`) matches the firm to be deleted (`l_firm`):
     - **Delete** the record.
   - **Read** next record.
3. **Repeat** for all defined files.

### **Example for One File**

```rpg
c                   read      skpmpf                                 90
c                   dow       *in90 = *off
c                   if        spfirm = l_firm
c                   delete    skpmpfr
c                   endif
c                   read      skpmpf                                 90
c                   enddo
```

- `read skpmpf 90` : Reads a record from file `skpmpf`, sets indicator `*in90` on EOF.
- Loop continues while `*in90 = *off` (EOF not reached).
- If the firm on the record (`spfirm`) matches the input firm (`l_firm`), the record is deleted.
- Reads next record (loop continues).

### **Repeats for All Files**

- The pattern is identical, just replacing file and field names accordingly for each relevant file.

---

## **Program End & Subroutine**

- `avslutt` : A tag marking the end of the main logic.
- `*inlr = *on` : Sets the Last Record Indicator on, which closes files and ends the RPG cycle.
- `return` : Ends program execution.

### **Initialization Subroutine (`*inzsr`)**

- Defined but empty, could be used for initialization logic if needed.

---

## **Summary**

### **What Does This Program Do?**

- **Deletes all records for a specific firm (`l_firm`) from a list of customer and supplier-related tables.**
- The firm to be deleted should be loaded into `l_firm` before running the program (outside the shown code).

### **How?**

- For each relevant file, 'read' all records and, if the firm matches, delete the record.

### **Why?**

- To **clean up all traces of a company/firm** in preparation for deletion, archiving, or database maintenance.

---

## **Onboarding Notes**

- **Extremely destructive!** Use carefully, as all records for the specified firm will be deleted in all listed tables.
- Requires knowledge of how `l_firm` gets its value (not shownâ€”this would likely be set by a calling program or job setup).
- Best to run in a test environment before production use.
- The firm field names differ per file (e.g., `spfirm`, `sbfirm`, etc.), so ensure they correspond with actual file structures.

---

## **Possible Modernization / Improvements**

- Could be rewritten in free-format RPG for better readability.
- Implement confirmation dialogs, backups, or logging for safety.
- Parameterize the firm number input for clarity.

---

If you have further questions about particular files, field names, or usage, please ask!