# RPG Source Code Explanation: ASTELE - Program GL402R

---

## Overview

This RPG program, **GL402R**, is a utility program designed for **"opprydding i filer"** (file cleanup) in the ASTELE system, specifically to **delete all records in a set of files for a given company (firma)**. 

---

## Key Concepts

- **ILE RPG, "O-spec" style:** The code uses fixed-format RPG IV. 
- **Batch/utility program:** It reads and deletes records in multiple files.
- **The target company ("firma") number is stored in the field `l_firm`, a variable mapped to a position in the user space (not shown in this code).**
- **Deletes are performed record-by-record only for the given company number.**
- **No user interaction within this code.**

---

## Header and Metadata

```rpg
/TITLE  ASTELE Opprydding i filer
h option(*nodebugio)
```
- `*nodebugio` disables debug I/O for performance.
- The title and comments indicate this is for deleting company data.

---

## File Declarations

```rpg
T5.40fgfaspf    uf   e           k disk
fglonpf    uf   e           k disk
fgtrtpf    uf   e           k disk
fgubfpf    uf   e           k disk
fgulfpf    uf   e           k disk
fgul1pf    uf   e           k disk
fgul2pf    uf   e           k disk
fgurfpf    uf   e           k disk
fgur1pf    uf   e           k disk
fgur2pf    uf   e           k disk
```
- Declares 10 physical files in update mode (`uf`), keyed access, external format (`e`).
- One of the files, `gfaspf`, was added in version V5.40.

---

## Data Declarations

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_navn                951    980
```
- The `uds` (User Data Space) fields appear to map to some external area, like a program status data structure or communications area.
- `l_firm` (positions 944-946) is the company number (without decimals).
- `l_user` and `l_navn` are likely user and name fields, not used in the logic below.

---

## Main Processing Logic

The process is repeated for each declared file:

1. **Read the file (via `read` operation).**
2. **Loop (`dow *in90 = *off`):** Continue until EOF (End of File).
3. **Check if the record matches the given company (`if ... = l_firm`).**
4. **Delete record if matched (`delete ...`).**
5. **Read next record.**

This approach is taken for all the files, with the company field name differing per file.

---

### Example: `gfaspf`

```rpg
T5.40c                   read      gfaspf                                 90
T5.40c                   dow       *in90 = *off
T5.40c                   if        geffir = l_firm
T5.40c                   delete    gfaspfr
T5.40c                   endif
T5.40c                   read      gfaspf                                 90
T5.40c                   enddo
```
- Reads `gfaspf` records, deleting those for company (`firma`) = `l_firm`.
- `geffir` is the company number field in this file.
- Loop continues until EOF (`*in90` on).

---

### The Pattern

This logic is repeated for each file, with the specific field tested for the company number matching the file naming conventions, e.g.:

| File     | Company Field | Delete Record Format |
|----------|--------------|---------------------|
| gfaspf   | geffir       | gfaspfr             |
| glonpf   | glfirm       | glonpfr             |
| gtrtpf   | gdqfir       | gtrtpfr             |
| gubfpf   | gafirm       | gabfpfr             |
| gulfpf   | gdvfir       | gulfpfr             |
| gul1pf   | gdsfir       | gul1pfr             |
| gul2pf   | gdsfir       | gul2pfr             |
| gurfpf   | gdpfir       | gurfpfr             |
| gur1pf   | gdnfir       | gur1pfr             |
| gur2pf   | gdofir       | gur2pfr             |

---

## Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets the last record indicator to *on (`*inlr = *on`), telling RPG to close all files and clean up (common way to end RPG programs).
- `return` ends the program.

---

## Initialization Routine

```rpg
c     *inzsr        begsr
c                   endsr
```
- Empty *INZSR subroutine, which would run at program start if initialization logic was needed.

---

## Summary

**This program is designed to remove all records belonging to a specific company (as identified in `l_firm`) from a series of files related to payroll and payment processing in the ASTELE system.**  
It sequentially processes each file, deleting records as appropriate, and then ends execution.

---

## Typical Usage

- Called from a higher-level program or menu to "delete company" from the system.
- The company number (`l_firm`) must be set before running.
- No error handling or user interface—intended for batch or administrative use.

---

## Onboarding Notes

- **Ensure understanding of each file's structure and company field before modifying.**
- **Check how `l_firm` is populated—this is external to the code.**
- **Consider performance and locking if files are large or in use elsewhere.**
- **Backup before running, as deletes are not recoverable from within this code.**

---

**In summary:**  
This utility program automates the cleanup/removal of a company from a suite of related files by looping through each, checking the company field, and deleting all matching records. Each file may use a differently named field for the company number, so care is taken to match these correctly.