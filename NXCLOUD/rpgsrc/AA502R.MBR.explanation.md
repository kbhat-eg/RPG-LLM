# RPG Program AA002R - Explanation

This RPG program (AA002R) is designed for IBM i (AS/400) systems using ILE RPG IV (RPGLE, fixed form). Its main purpose is to present a selection screen where a user can choose a company number ("Firma-nummer") from a list. The program utilizes subfiles for displaying records and handling user interaction via function keys.

Below is an organized walkthrough:

---

## 1. Header, Options, and Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Program options: No debug I/O is generated; date editing in day-month-year format.

The comments explain the purpose (company number selection), revision history, and conventions for indicator usage.

---

## 2. File Declarations

```rpg
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
faa002d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **fafirl1**: A keyed physical file - the company master file. Renamed record format.
- **faa002d**: Display file, supports subfile `b1sfl` with relative record number `w_srrn`. `infds(dspfbk)` provides display feedback (e.g., cursor position).

---

## 3. Data Structures and Variables

### Parameters

```rpg
d p_sfir          s                   like(aaffir)
d p_fnav          s                   like(aafnav)
```
- Parameters to hold selected company number and name.

### Display Feedback

```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Data structure for Display File Feedback; e.g., cursor row on the display.

### Variables for Key and Subfile Management

```rpg
d afirl1_ffir     s                   like(aaffir) // Used for keying into company master
d w_acli          s              2  0 // Current screen line number
d w_acpo          s              3  0 // Current screen column/position
...
d w_srrn          s              4  0 // Subfile RRN
d w_sfrn, w_ssrn, w_spge, w_stel // Paging and subfile management variables
d w_seqe          s              1    // Sequence control
d b_valg_ok       s              1    inz(*off) // "Valg OK" (Selection OK) flag
...
d c_sfil          s              2  0 inz(13) // Constant, subfile page size
```

Comprehensive comments describe each variable’s purpose, mainly relating to subfile navigation, cursor location, and display logic.

---

## 4. Screen Images

Described as:

- **B1SFL**: Subfile records
- **B2CTL**: Subfile control record
- **B2CMD**: Command key display

---

## 5. Mainline Logic

### Program Flow

- **Tags** `b2taga`, `b2tagb`: Mark logical sections for display and processing.
- The flow is:
    1. Display command key screen (`b2cmd`)
    2. Display or refresh the subfile (`dsp_subfile`)
    3. Handle function keys via a `select` statement:
        - **Exit/Clear/Cancel** → End program
        - **Enter**            → Refresh subfile
        - **Roll Up/Down**     → Rebuild or page subfile
        - **Home key**         → Set cursor
    4. If a company number is entered for positioning, process it
    5. Otherwise, handle subfile row selection or loop back

---

## 6. Function Key and Subfile Control Indicators

- **LR**   = End of program
- **10/11** = Roll up/down
- **12/13/14/15** = Subfile display, control, clear, end
- **22**   = Cursor placement, etc.

---

## 7. Subroutines

### forny (Refresh subfile)

- Positions file based on current state
- Clears and rebuilds the subfile

### posisjoner (Position subfile)

- Used when user requests positioning (e.g., typing a company number)
- Sets file pointer and rebuilds subfile to show correct page

### subfile (Process subfile)

- Toggles indicator for subfile display
- Reads subfile records in a loop (`readc`)
- Checks if user selected a company (`b1valg = 1`)
- On selection, saves company number and name, sets `b_valg_ok` to end input

### clr_subfile (Clear subfile)

- Activates subfile clear indicator and resets related variables

### crt_subfile (Create subfile page)

- Fills subfile with up to `c_sfil` records per page
- Manages paging pointers and subfile state

### bck_subfile (Page back in subfile)

- Reads previous set of records for roll-back/page-up
- Resets subfile and loads previous page

### dsp_subfile (Display subfile)

- Handles display of subfile
- Sets control indicators, executes display format

### *inzsr (Initialization subroutine)

- Handles parameter list input
- Initializes subfile by setting file pointer and calling `crt_subfile`

---

## 8. General Usage and Purpose

- This program is typically called by another program, which expects the user to pick a company.
- The subfile logic supports page up/down, position-to, and selection.
- It leverages indicators and feedback structures for the IBM i/5250 display model.

---

## 9. Summary of Key Concepts

- **Subfile Paging**: Program shows lists in pages; user can page up/down.
- **Positioning**: User can type a company number to jump to that record.
- **Selection**: When user selects a company, values are returned.
- **Indicators**: Core to display, control, and logic (typical in legacy RPG).
- **Feedback**: Uses InfDS for cursor and display info.

---

This program illustrates classic subfile usage in RPG, with structured mainline, EXSR-based subroutines, and detailed comments for maintainability. It serves as a reference for user-driven selection using subfiles in IBM i environments.