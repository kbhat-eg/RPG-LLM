# Documentation for Program FB700R: Access Control Check

## Purpose

This program, `FB700R`, serves as a general-purpose utility to check if a user has access to a specific function within the ASOFAK system. It is designed to be called by other programs, which supply a function access code (from 1 to 20) and receive a binary response (0 or 1) indicating whether the user has the required access.

The access rights are determined by looking up the user in the `FUSRL1` user register file and checking the relevant access code field.

---

## Structure Overview

- **File Definition**
  - `FUSRL1` user register file is defined for keyed disk access, with internal record format renamed to `FUSRL1R`.
- **Local Data Area**
  - Reads user and firm information from the User Data Space (UDS).
- **Parameters**
  - Receives the access code to check and returns the result (on/off).
- **Key Variables**
  - Used to construct the key for accessing the user register.
- **Main Routine**
  - Looks up the user and checks the requested access code.
- **Initialization Subroutine**
  - Sets up file keys and loads parameters from the calling program.

---

## Detailed Logic

### File Interaction

- **FUSRL1 User Register**
  - The program performs a keyed lookup (`chain`) into the `FUSRL1` file, using a composite key of firm number and user ID.
  - The file fields `FBKO01` through `FBKO20` represent access codes for various functions.

### Data Flow

- **Input Parameters**
  - `p_kode`: Numeric code (1–20) specifying which access right to check.
  - `p_onof`: Output parameter, returns 0 (no access) or 1 (access granted).

- **Local Data Area (LDA)**
  - `l_firm`: Firm number (company identifier).
  - `l_user`: User ID.
  - These are used to build the key for the user register lookup.

### Main Routine

1. **Initialization**
   - Sets `p_onof` to 0 (default: no access).
2. **User Lookup**
   - Builds the file key from `l_firm` and `l_user`.
   - Performs a `chain` operation to find the corresponding user record.
3. **Access Code Check**
   - If the user is found, checks which access code was requested (`p_kode`).
   - For each possible code (1–20), assigns the corresponding field (`FBKO01`–`FBKO20`) from the user record to `p_onof`.
   - Only the requested access code is evaluated.
4. **Return**
   - Ends the program and returns control to the caller, with `p_onof` set appropriately.

### Initialization Subroutine (`*INZSR`)

- Sets up the key list for the `FUSRL1` file.
- Loads parameters from the calling program.
- Assigns `l_firm` and `l_user` from the LDA to the key variables used for the file lookup.

---

## Business/Domain Logic

- **Access Model**
  - User access rights are stored in the `FUSRL1` register, with up to 20 discrete access flags per user.
  - Each flag (`FBKO01`–`FBKO20`) represents a specific function or permission, as defined elsewhere in the business logic.
- **Usage Pattern**
  - Typically called by other programs to enforce security or access control at the function level.
  - The calling program does not need to know the internal structure of the user register; it simply requests a check for a specific code.

---

## Design Decisions & Conventions

- **Parameter Passing**
  - Uses a parameter list (`plist`) for input/output, following a common convention in legacy RPG systems.
- **Local Data Area**
  - Relies on the LDA for user and firm context, which must be set up by the calling environment.
- **Explicit Mapping**
  - Uses a series of `if` statements to map the requested code to the corresponding field. This is straightforward but could be refactored for maintainability if the number of codes increases.
- **No Error Handling**
  - If the user is not found in `FUSRL1`, `p_onof` remains 0 (no access). No explicit error or logging is performed.
- **No Debug I/O**
  - The `*NODEBUGIO` option is specified, likely for performance or security reasons.

---

## Interactions with Other Modules

- **Caller Responsibility**
  - The calling program must ensure that the LDA contains valid user and firm information before invoking this program.
- **User Register Maintenance**
  - The `FUSRL1` file must be maintained by separate administrative functions to ensure accurate access rights.

---

## Summary Table

| Component         | Description                                      |
|-------------------|--------------------------------------------------|
| Input             | Access code (1–20) via parameter                 |
| Output            | Access flag (0/1) via parameter                  |
| User File         | `FUSRL1` (user register)                         |
| Key Fields        | Firm number, User ID                             |
| Access Fields     | `FBKO01`–`FBKO20`                                |
| Context           | User and firm loaded from LDA                    |
| Caller Pre-requisites | LDA must be set, parameters passed correctly  |

---

## Maintenance Notes

- If new access codes are added, corresponding logic must be added to the code.
- If the structure of `FUSRL1` changes, update the key and access field references.
- Consider refactoring the repeated `if` statements for scalability if access codes expand significantly.

---

## Summary

`FB700R` is a generic, parameter-driven access control checker for user-function permissions in the ASOFAK system, relying on a central user register and designed for easy integration by other RPG programs. It is simple, robust, and follows established conventions for RPG-based security modules.