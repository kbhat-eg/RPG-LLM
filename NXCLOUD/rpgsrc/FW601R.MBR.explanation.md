# Explanation of the RPG ILE Source Code  
## Overview  

This RPG program prints a detailed list of items (varer) from a supplier (leverandør) in the ASOFAK system. It reads item and supplier records, applies selection/filter criteria, fetches additional pricing and item information using subroutines and called programs, and finally outputs report lines to a printer file. The code uses fixed-format RPG (pre-free) with embedded subroutines, data structures, and calls to external programs.

---

## Sections Explained  

### 1. **Header (`/TITLE`, Comments, History)**
- `/TITLE ASOFAK Lev.vare, utskrift av varer`: Title; meaning "ASOFAK Supplier items, printout of items".
- Extensive comment header:  
  - System ID, program name (FW601R)
  - Program description: "Utskrift av varer fra leverandør" = Print items from supplier
  - Change history with version info

---

### 2. **File Specifications**
```rpg
     fflval3    if   e           k disk    rename(flvapfr:flval3r)
     fvvarl5    if   e           k disk    rename(vvarpfr:vvarl5r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
6.32 fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
     ffw601p    o    e             printer
```
- Input files for various master tables (supplier-item, item, company, supplier) with renamed record formats for clarity.
- Output file `fw601p` is the printer file (for report output).

---

### 3. **Data / Working Fields**  
#### Local Data Area, Parameter Structures, Key/Working Variables
- **Local data area**: Space reserved for workstation/user IDs.
- **Parameter Data Structure**:
  - `d_list`: Whole 74-byte input parameter block
  - Overlaid fields (for extracting specific parameter values: firm#, supplier#, item range, date, etc.)

#### Key Variables (for file access)
- Used to build keys for chained access to DB records in subroutines.

#### Other Working Variables
- Flags, indicators, calculated fields (e.g., previous/current prices, percentage-change, tax rates, etc.)

---

### 4. **Mainline Logic**

#### a) **Header Output**
```rpg
     c                   exsr      hode
```
- Calls the `hode` (header) subroutine to print the report header and fetch context data.

#### b) **Detail Processing**
```rpg
     c                   exsr      behandling
```
- Calls the `behandling` (processing) routine to loop through records, apply filters, calculate pricing, and print detail lines.

#### c) **End Program**
```rpg
     c                   eval      *inlr = *on
     c                   return
```
- Ends the program, turning on the last record indicator.

---

### 5. **Subroutine: `hode` (Print Header)**
- **Fetches and prints report headers.**
  - Populates header fields, fetches company and supplier info for the header, copies parameters into display variables.
  - Handles Swedish/Norwegian characters and date presentation.
  - Writes three different header record formats (`a1hdr`, `a2hdr`, `a3hdr`).

---

### 6. **Subroutine: `behandling` (Main Processing Loop)**
- **Loops through supplier-item records matching key.**
- Applies various filters based on input parameters:
  - Item ranges (`d_lvaf`, `d_lvat`)
  - Date filtering with operators (EQ, GT, LT)
  - Status code (`d_ekod`)
- Chains to main item file; determines if item record exists and sets flags.
- Filters items based on type (`d_rtyp` = include/exclude certain matches).
- **Fetches previous/current prices and calculates percentage changes.**
  - Uses call to `VP701R` to get old prices, then computes percent changes.
  - Further filters by required percentage change amount (`d_endr`).
- Calls `detalj` subroutine to print detail line for approved records.

---

### 7. **Subroutine: `detalj` (Print Detail Line)**
- **Populates detail-line variables.**
- If item is found in the item file:
  - Calls `VL710R` for additional information (e.g., type, extra fields).
- Calls `FW113R` for item validation/status lookup.
- Sets price, calculates price including VAT (using `FA909R`), and calculates gross margin % (dekningsgrad).
- Writes the detail line to the printer (`d1dtl` record format).
- Calls `overflow` subroutine to handle page overflow.

---

### 8. **Subroutine: `overflow` (Report Pagination)**
- **If printer overflow indicator is set, prints headers again to create a visually complete page.**

---

### 9. **Subroutine: `*inzsr` (Program Initialization)**
- **Handles program initialization and parameter input.**
- Sets up file keys (KLIST/KFLD instructions).
- Copies entry parameter `p_list` into working DS.
- Loads firm/supplier params.
- Gets current date for printing and tax calculation.
- Calls other programs as needed to fetch VAT info (`FØ705R`) and price group (`VL711R`).

---

## 10. **Parameter Passing / Integration Points**
- **Multiple calls to other RPG programs:**
  - `VP701R`: Get previous price info.
  - `VL710R`: Get extended item info.
  - `FW113R`: Validate item and return status.
  - `FØ705R`: Lookup VAT data.
  - `VL711R`: Lookup price group.
  - `FA909R`: Calculate price including VAT.

---

## 11. **Business Rules Embedded**
- Only items fitting complex user-specified criteria (ranges, dates, status, % price change, etc.) are reported.
- Pricing and margin calculations are central.
- Modular, with multiple external dependencies (other RPG programs).

---

## 12. **General Observations**
- Code is modular, with clear division into report header/detail/footer logic.
- Uses classic RPG constructs: KLIST/KFLD for keys, DS overlays for parameter unpacking, indicator variables for status.
- Comments and versioning show ongoing evolution and adaptation to business needs.

---

## In Summary

- **Purpose:** Print a filtered, detailed supplier item list with price calculations and extra context.
- **Inputs:** Key range, date, operation, price change %, etc.
- **Processing:** Database lookups, conditional filtering, external program calls, calculations.
- **Output:** Printer file with paginated report.
- **Modularity:** Use of subroutines and calls to external RPG programs for key business logic tasks.

---

**If you are new to this codebase:**
- Start by understanding the parameter DS (`d_list`) and the selection logic in the `behandling` subroutine.
- Learn how each record format relates to the printer file for output.
- Study the interfaces (parameter lists) to the called RPG programs, as they encapsulate much business logic.

---

*Note: Comments and variable names are a mix of Norwegian/Swedish, e.g., "leverandør" = supplier, "vare" = item, "utsrift" = printout, etc.*