# RPG Program `BO400R` – Explanation

This RPG program (`BO400R`), used in the `ASSHOP` system, is designed to **update the company number (firma)** in a wide set of files/tables for all records in those files. The new company number is passed as a parameter. The program also updates various audit and tracking fields in some tables.

## Header (`H`) Specification

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio` disables debug for I/O operations (better performance).
- `datedit(*dmy)` sets date editing to Day-Month-Year.

## File (`F`) Specifications

The program works with a series of physical files (or logical files), all opened for update (`uf`), keyed access (`k`), and with external descriptions (`e`). Each file is renamed for internal program use.

Sample:
```rpg
fbbudlu    uf   e           k disk    rename(bbudpfr:bbudlur)
```
- File `bbudlu` (Budsjett - Budget) is accessed for update, and record format is renamed from `bbudpfr` to `bbudlur`.

The same structure is used for all similar files (store, line, header, cash, gift card, etc.).

---

## Data Definitions (`D` Specs)

### Parameters and Local Data Area (LDA)

```rpg
d p_firm          s              3  0
d                uds
6.10 d l_user                911    920
d l_firm                944    946  0
```
- `p_firm`: input parameter, the new company (firma) number (3-digit).
- `l_user`: user ID from Local Data Area (LDA), positions 911-920.
- `l_firm`: current firm number from LDA, positions 944-946.

### Working Variables

```rpg
d w_firm          s              3  0
```
- `w_firm`: working variable for firm.

---

## Mainline Logic

### File Processing Pattern

For *each file*, the process is:

1. **Position to records** for the current company (`key01`) via `setll`.
2. **Read** the first record with `reade`.
3. **Loop (`dow not %eof`)** over all records for that key:
    - Change the firm number field in the record to the new firm (`p_firm`).
    - For some files, update tracking fields like date/time/user.
    - **Update** the record.
    - **Read** next record.
4. **Repeat** for all record files.

#### Example:
```rpg
c     key01         setll     bbudlu
c     key01         reade     bbudlur
c                   dow       not %eof
c                   eval      bufirm = p_firm
c                   update    bbudlur
c     key01         reade     bbudlur
c                   enddo
```
- Reads all records for the current firm in the Budget file and updates `bufirm` field to `p_firm`.

### Audit Information (Version 6.10)

For some files/records, extra audit fields are updated:
- `time` opcode is used to update date/time fields (e.g., `bdedat`/`bdetim`).
- The user field (`bdeusr`, etc.) is set to the current user from the LDA (`l_user`).

#### Example:
```rpg
c                   eval      bdfirm = p_firm
6.10 c                   time                    bdedat
6.10 c                   time                    bdetim
6.10 c                   eval      bdeusr = l_user
c                   update    bodtlur
```
- Updates firm, date, time, and user for the "Bong-linje" (receipt line) record.

---

## Program Termination

```rpg
c                   eval      *inlr = *on
c                   return
```
- Sets the Last Record indicator (`*INLR = *ON`) to close files and end the program.

---

## Initialization Subroutine (`*INZSR`)

```rpg
c     *inzsr        begsr
      ...
c     *entry        plist
c                   parm                    p_firm
      ...
c     key01         klist
c                   kfld                    w_firm
      ...
c                   eval      w_firm = l_firm
c                   endsr
```
- Reads the input parameter (`p_firm`), the new firm number.
- Sets up a key list (`key01`) containing `w_firm`.
- Loads the current firm number from LDA to `w_firm`.

---

## Key Details

- **Program purpose:** Update all relevant records in various tables for a new company number, for data migration, correction, or reorganization.
- **Files processed:** Budget, Store, Receipt, Cash, Gift Card, User, etc.
- **Fields modified:** Usually firm number fields (typically `…firm` fields), and for some, audit fields (date, time, user).
- **Key structure:** Relies on a key (`key01`) which includes the firm number (`w_firm`) for positioning/reading.
- **Audit trail:** From version 6.10, date, time, and user are registered when updating some files.
- **Parameterization:** New firm number supplied at program invocation.
- **LDA usage:** Reads current user and firm from LDA.

---

## Summary

- The program is a **mass-update utility** for changing company numbers in a set of connected physical files.
- Each relevant record is updated to set the new firm, and additional audit info is updated where required.
- The program uses standard RPG cycle and file operations for record-by-record update.

### This is typically used during organizational changes, data migrations, or correcting data inconsistencies at the company level in a shop/retail solution on IBM i.