# Program Overview

This RPG program (`RR622R`) prints a result report, typically a financial or accounting report, based on data read from different files. It's designed for use on IBM i (AS/400) systems and makes heavy use of arrays, data structures, and subroutines to process and summarize data according to a variety of selection criteria (department, period, type, etc.).

## Main Purposes

- Print a results report, possibly by department or by line.
- Accumulate, compare, and display actuals against budgets and previous year values.
- Allow selection of up to 24 departments for inclusion in the report.
- Provide flexible formatting, including how values are shown (e.g., in thousands, whole numbers).

---

# Key Sections Explained

## **1. File Definitions**

```rpg
frrf0l1    if   e           k disk    rename(rrf0pfr:rrf0l1r)
frrf5l1    if   e           k disk    rename(rrf5pfr:rrf5l1r)
frrf9l1    if   e           k disk    rename(rrf9pfr:rrf9l1r)
frrf9l2    if   e           k disk    rename(rrf9pfr:rrf9l2r)
frr622p    o    e             printer oflind(*in30)
```

- Four input files and one output (printer file).
- Files are renamed for internal references.
- `oflind(*in30)`: Overflow indicator for page heading.

---

## **2. Arrays and Data Structures**

### Arrays

```rpg
d pav             s              4  0 dim(24)
d uav             s              4  0 dim(8)
d sal             s             11  2 dim(14)
```
- `pav`: Holds up to 24 selected departments.
- `uav`: Used for up to 8 departments (purpose not shown in the snippet).
- `sal`: Stores balances (possibly by period or category).

### Data Structures

```rpg
d                 ds
d nybrd                          9  0
d  nylin                         5  0 overlay(nybrd)
d  nyavd                         4  0 overlay(nybrd:6)
```
- Structure overlays for combining and comparing "control break" fields.
- Used to quickly compare current vs previous "break" field values for subtotaling/printing logic.

---

## **3. Variables**

- Many variables are defined for holding temporary balances, keys, comparison results, print fields, etc.
- Variables like `l1beår`, `l1bufj`, `salh`, `sum`, `bevp`, etc. are used for accumulating and calculating per line, per period, and comparison values.

---

## **4. Key Logic Flow**

### **Initialization (`*inzsr` Subroutine)**

- Initializes variables.
- Handles input parameters (e.g. which comparison to run: budget, previous year, etc.).
- Loads report heading and first text line.
- Moves up to 24 department selections to `pav` array and checks if department selection is filled.

### **Main Loop**

Within the main loop, for each record:

1. **Selection Check:**  
   - Skips records not matching department selection criteria.
2. **Break Handling:**  
   - Checks if the record is a new line or department (aka "breaks").
   - Writes subtotals/headers if a break occurs.
3. **Accumulation:**  
   - Sums up values for the current line/department.
4. **Printing:**  
   - Calls subroutines to write report lines, headings, and handle formatting (lines, blank lines, page breaks).

### **Control Break and Subtotaling**

- Uses data structures (`nybrd`, `gmbrd`, overlays) to detect when the key value for subtotaling changes, thereby triggering a subtotal output and a reset of counters.

---

## **5. Subroutines**

### `rsum`  
- Handles aggregation of totals for each record, split by record type (actual, budget, alt. budget) and period (this year, last year).

### `hsum`  
- Sums up values for the current period and accumulates movements within the specified range.

### `brlin`  
- Handles printing and resetting when there is a break on a reporting line.

### `brtxt`  
- Handles printing and formatting of text lines (including blank lines and new page headers).

### `bravd`  
- Handles printing/processing when there is a break on department, including fetching department text.

### `beregn`  
- Performs calculation of comparison values and proportions for current vs. budget, previous year, or averages.

### `l1null`  
- Resets subtotal working fields to zero.

### `xltxt`  
- Reads text lines related to the current line/department for printing.

### `brsln`
- Retrieves values for a comparison line (used for certain percentage calculations).

---

## **6. Key Design Features**

- **Control Break Programming:**  
  The way the code detects a "break" (change in sorted field, like department or line) is classic for RPG reporting programs.
- **Flexible Comparison Logic:**  
  Switches between year/budget/average based on run-time parameters.
- **Selective Reporting:**  
  Only includes departments specified as run-time parameters (up to 24).
- **Formatting:**  
  Supports output in units (whole, thousand), blank/skip lines, and conditional printing of lines with all-zero values.

---

# **Summary Table of Main Variables and Functions**

| Element         | Purpose |
|-----------------|---------|
| `pav`           | Array of up to 24 selected departments to include in report. |
| `sal`           | Array for balances (14 elements, possibly months/periods).  |
| `nybrd`/`gmbrd` | Data structures for handling control breaks (compare keys). |
| `rsum`, `hsum`  | Subroutines for accumulating values for subtotal/total lines. |
| `brlin`, `bravd`, `brtxt` | Subroutines for break logic (outputting subtotal/headers). |
| `beregn`        | Subroutine for calculating proportions/percentages. |
| `l1null`        | Resets subtotal calculation fields. |
| `xltxt`         | Reads and processes text lines from text definition file. |

---

# **How to Onboard on this Code**

- **Understand the Data Files**: Study the files `rrf0l1`, `rrf5l1`, `rrf9l1`, `rrf9l2` (likely tables holding report, text, and transaction data).
- **Parameterization**: The report behavior is heavily influenced by input parameters (report period, departments, comparison type, etc.). Test with different inputs.
- **Flow of Processing**: The main processing is a loop over selected records, with logic split at department and line breaks, which is classic RPG. Break handling is key to understanding report formatting and totals.
- **Print File**: Output is handled via a printer file, and special indicators trigger page headers, blank lines, etc.
- **Subroutines**: Observe how each subroutine encapsulates a part of the reporting logic — most are called in response to data or formatting events (like a control break).

---

# **Further Reading**

- **IBM RPG Reference Manual**: For details on RPG syntax and file-processing logic on IBM i.
- **IBM DDS for Physical and Printer Files**: To understand the layout of output on the physical printer file.
- **Company Documentation**: For the specific business meaning of each report field.

---

# **Conclusion**

This program is a classic business-report RPGII/III style application, enhanced over the years, intended for flexible financial reporting by department and line, with robust subtotaling and print formatting capabilities. Understanding the flow of control breaks (by line and department), the parameterization, and the subroutine-based logic will help a developer effectively maintain and extend this program.