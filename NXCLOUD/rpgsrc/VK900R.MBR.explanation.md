# RPG Program Explanation: VK900R

This IBM ILE RPG program is designed for updating the product master file by assigning an *alternative product group* to items that do not already have one. The relevant information and alternative group are fetched from a cross-reference register.

Below is a walkthrough of the program, with explanations for each section:

---

## Specifications and File Definitions

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Program header specifying options: no debug for IO, date format is DMY (day/month/year).

### File Declarations

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvarlu    uf   e           k disk    rename(vvarpfr:vvarlur)
```
- `vvarl1` and `vvarlu` are logical files over the product master physical file (`vvarpfr`). 
- `vvarl1` is used for input (reading), 
- `vvarlu` for update.
- Both use key access.

---

## Data Area and Variables

### From LDA (Local Data Area)

```rpg
d                uds
6.10 d l_user                911    920
d l_firm                944    946  0
```
- Describes where in the LDA user and firm info are found.

### Key Variables

```rpg
d vvarlu_vare     s                   like(vvvare)
```
- `vvarlu_vare`: A variable used for the item number key in updates, same type as the item number in the product master file.

### Other Variables

```rpg
d w_firm          s                   like(vvfirm)
d w_ahgr          s                   like(vvahgr)
d w_augr          s                   like(vvaugr)
```
- Working storage for firm, alternative main group, and alternative subgroup.

---

## Main Program Logic

### Initialization

- **Key lists** are established for file access (done in the `*inzsr` subroutine).
- Company (`firm`) is retrieved from LDA.

### Read Product Master and Process Records

```rpg
c     vvarl1_key    setll     vvarl1
c     vvarl1_key    reade     vvarl1
c                   dow       not %eof
```
- Sets the file pointer and starts reading records sequentially for the specified firm.

#### Logic Per Item

- **Skip items** already having an alternative group:

    ```rpg
    c                   if        vvahgr <> 0 and
    c                             vvaugr <> 0
    c                   goto      neste_vare
    c                   endif
    ```

    - If both alternative main group (`vvahgr`) and subgroup (`vvaugr`) are non-zero, processing is skipped for the item.

- **Obtain alternative group** from cross-reference (another program):

    ```rpg
    c                   call      'VK700R'
    c                   parm                    w_firm
    c                   parm                    vvogrp
    c                   parm                    vvhgrp
    c                   parm                    vvugrp
    c                   parm                    vvldor
    c                   parm                    w_ahgr
    c                   parm                    w_augr
    ```

    - Calls external program `VK700R` to fetch alternative group values based on current item details.

- **Update Product Master**:

    ```rpg
    c                   eval      vvarlu_vare = vvvare
    c     vvarlu_key    chain     vvarlur
    c                   if        %found
    c                   eval      vvahgr = w_ahgr
    c                   eval      vvaugr = w_augr
    6.10 c              time                    vvedat
    6.10 c              time                    vvetim
    6.10 c              eval      vveusr = l_user
    c                   update    vvarlur
    c                   endif
    ```

    - Locate the record for update using the key (firm + item number).
    - If found, update alternative group fields, as well as traceability fields (date, time, user).
    - Write the change back to the file.

- **Loop Control**:

    ```rpg
    c     neste_vare    tag
    c     vvarl1_key    reade     vvarl1r
    c                   enddo
    ```

    - Moves to the next item.

---

## Program Ending

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks the end of the program, sets LR (Last Record) to signal end-of-job, and returns.

---

## Initialization Subroutine (`*inzsr`)

- Defines the key lists used for file operations.
- Retrieves company number from LDA for use as a key.

---

## Summary of Key Operations

1. **Initialization**: Get firm from LDA, set up keys.
2. **Sequentially process each product**:
    - If alternative group already set, skip.
    - Otherwise, call a sub-program to determine group.
    - Update the product master if appropriate.
3. **Tracks updates** with user, date, time.
4. Ends gracefully.

---

## Business Context

This program is typical in ERP systems where item master data needs to be kept up-to-date and categorized for reporting, pricing, or classification purposes. It ensures all items have an alternative group, which can be crucial for processes such as sales analysis or inventory management.

---

## Key RPG Concepts Illustrated

- Keyed file access with logical files (`setll`, `reade`, `chain`, `update`)
- Use of Local Data Area (LDA) for user/session context
- Inter-program communication via `CALL` with parameter lists
- Handling traceability/auditing (user, date, time fields)
- Loop and conditional logic for processing files

---

Let me know if you want details on a specific part of the code!