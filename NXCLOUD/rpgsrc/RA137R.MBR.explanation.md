# Program RA137R – External Warehouse Maintenance (Vedlikehold av ekstern lagerinformasjon)

## Overview

This program, **RA137R**, is designed for the maintenance (create, update, delete, view) of external warehouse master data within the NXCLOUD system. It provides a subfile-driven, interactive green-screen interface for users to work with external warehouse records, including address data, GLN (Global Location Number), and supplier linkage.

The code is written in traditional (fixed-format) RPG IV, with embedded SQL for certain lookups and validations. The user interface is managed via display files and subfiles. The business logic is closely tied to domain-specific files and conventions.

---

## Data Structures & Files

### Database Files

- **ra37st**: Primary file for external warehouse master data.
  - Used in four logicals/aliases: 
    - `ra37iu` (update/write), 
    - `ra37ir` (read), 
    - `ra37i1` (positioning/sorting), 
    - `ra37i2` (existence checks).
- **rlevpf**: Supplier master file, used for supplier name lookups.
- **mjlopf**: File for checking GLN (Global Location Number) duplicates in logistics.
- **ra137d**: Display file, with subfile `b1sfl` for listing warehouse records.

### Local Data Area (LDA)

- **l_user**: User ID.
- **l_firm**: Firm/Company code.
- **l_fnav**: User name.

### Key Variables

- `ra37iu_ruid`, `ra37ir_ruid`: UID key for warehouse records.
- `ra37i1_elag`, `ra37i2_elag`: External warehouse code for positioning and existence checks.

### Working Variables

- `w_firm`, `w_lage`, `w_ldor`, etc.: Working copies of firm, warehouse, and supplier codes.
- `w_glnn`: GLN number.
- `w_latx`, `w_letx`, `w_fmtx`: Text fields for display and lookups.
- `b_oppr`, `b_forn`, `b_feil`: Flags for operation mode, refresh, and error status.

### Constants

- `c_sfil`: Subfile page size (14).

---

## SQL Environment

Embedded SQL is configured for:
- ISO date format.
- Norwegian language and sort sequence.
- No commitment control.

---

## Main Program Flow

The program’s entry point is a display-based control loop, handling user actions and subfile navigation.

### Main Display Loop

1. **b2taga**: Display the main command screen.
2. **b2tagb**: Display or refresh the subfile.
3. **Function Key Handling**: 
   - Exit (`*INKC`, `*INKL`)
   - Refresh (`*INKE`)
   - Add (`*INKF`)
   - Page down (`*IN10`)
   - Page up (`*IN11`)
   - Toggle selection (`*IN21`)
4. **Subfile Handling**: Processes user actions on subfile rows (change, delete, view).
5. **Exit**: Set LR and return.

---

## Subroutines

### forny (Refresh Subfile)
- Positions to the start of the warehouse file.
- Clears and rebuilds the subfile.

### subfile (Process Subfile Rows)
- Toggles selection mode.
- Iterates through subfile rows using `readc`.
- Handles:
  - **Change (b1valg=2)**: Calls `xc2bld` for edit.
  - **Delete (b1valg=4)**: Calls `xd1win` for delete confirmation.
  - **View (b1valg=5)**: Calls `xc2bld` in view mode.
- If changes were made, triggers a subfile refresh.

### xc2bld (Change/Create/View Warehouse)
- Loads data for the selected warehouse (via UID).
- If found and not add mode, populates fields for edit/view.
- If not found or add mode, clears fields for new entry.
- In view mode, disables input.
- Handles field-level validation:
  - Ensures all mandatory fields are filled.
  - Checks for GLN duplicates via `sjk_glnl` and `sjk_glnd`.
- On save:
  - Updates or writes the warehouse record.
  - Sets refresh flag.

### Error Message Subroutines
- **xc2msg1**: Duplicate warehouse code.
- **xc2msg2**: Missing mandatory field.
- **xc2msg3**: Duplicate GLN in logistics.
- **xc2msg4**: Duplicate GLN in warehouse.

Each displays a specific message screen.

### xd1win (Delete Confirmation)
- Loads warehouse data for delete confirmation.
- If confirmed, deletes the record.
- Sets refresh flag.

### clr_subfile (Clear Subfile)
- Clears the subfile control record and resets row counters.

### crt_subfile (Fill Subfile)
- Reads warehouse records for the firm, filling the subfile up to `c_sfil` rows.
- For each record, looks up the supplier name and writes to the subfile.

### bck_subfile (Page Up)
- Reads backward in the warehouse file to fill the previous page in the subfile.

### dsp_subfile (Display Subfile)
- Displays the subfile control screen.

### lev_sok (Supplier Search)
- Calls program `RL500R` to search/select supplier, returns code and name.

### finn_lev (Find Supplier Name)
- SQL lookup to retrieve supplier name from `rlevpf`.

### sjk_glnl (Check GLN Duplicate in Logistics)
- SQL check for GLN existence in `mjlopf`.

### sjk_glnd (Check GLN Duplicate in Warehouses)
- SQL check for GLN existence in `ra37st` (excluding current warehouse).

### *inzsr (Initialization)
- Sets up key lists for file operations.
- Loads firm code from LDA.
- Positions to the start of the warehouse file.
- Fills the initial subfile page.

---

## Domain-Specific/Non-Obvious Logic

- **GLN Validation**: The program enforces that each warehouse has a unique GLN, both within the warehouse master and in the logistics file. This is business-critical for logistics and EDI compliance.
- **Supplier Linkage**: Each warehouse record is linked to a supplier via code and name. Supplier selection uses a separate program (`RL500R`), and the name is re-fetched via SQL for display.
- **Subfile Paging**: Paging is handled manually, with explicit counters and logic for next/previous page. This is a common but non-trivial green-screen pattern.
- **Field Validation**: Mandatory fields are enforced with user feedback via dedicated message screens.

---

## Integration Points

- **Display Files**: The program relies on a display file (`ra137d`) with subfile and multiple record formats for interaction.
- **Supplier Master**: Integration with `rlevpf` for supplier data.
- **External Programs**: Calls `RL500R` for supplier search.
- **GLN Checks**: SQL queries against `mjlopf` and `ra37st` for duplicate GLN validation.

---

## Naming and Conventions

- **File Aliases**: Logical files or RENAMEs are used for the same physical file to support different access paths.
- **Norwegian Comments/Labels**: Many comments and variable names are in Norwegian; field names are often abbreviations of business terms.
- **Subfile Row Variables**: Prefix `b1` denotes subfile row fields.

---

## Maintenance Notes

- **GLN Field Change**: As of change 8.01 (211122), the external warehouse code was expanded from numeric(2,0) to alphanumeric(20) to accommodate business requirements.
- **Error Handling**: Uses RPG error indicators and dedicated message screens for user feedback.
- **SQL Error Handling**: SQL lookups check `sqlcod` for error or not found, setting fields accordingly.

---

## Summary

This program is a maintenance utility for external warehouse records, providing CRUD operations via a subfile-driven interface. It enforces strict validation of mandatory fields and GLN uniqueness, integrates with supplier data, and relies on both native RPG file I/O and embedded SQL. The code is heavily tailored to Norwegian business processes and conventions, with explicit handling of paging, key management, and user feedback. 

Familiarity with the subfile pattern, RPG file operations, and the business domain (warehousing, supplier management, GLN compliance) is essential for effective maintenance and extension of this program.