# RPG Program FO700R - Explanation

This RPG program, FO700R, is designed to **update order header (ordrehode) totals** by summing values from order lines (ordrelinjer) and writing the results back to the header.

---

## 1. Program Overview

- **System:** ASOFAK  
- **Purpose:** Update order header fields (`fotots`, `fototk`, `fototr`) based on sums from corresponding order lines.
- **Key Files:**
  - `vltyl1`: Line type master (used to check if a line is a text line)
  - `fodtl1`: Order line file
  - `fohelu`: Order header file

---

## 2. File Declarations

```rpg
fvltyl1    if a e           k disk    rename(vltypfr:vltyl1r)
ffodtl1    if a e           k disk    rename(fodtpfr:fodtl1r)
ffohelu    uf a e           k disk    rename(fohepfr:fohelur)
```
- **vltyl1**: Input file, keyed, externally described. Holds line type definitions.
- **fodtl1**: Input file, keyed, externally described. Holds order lines.
- **fohelu**: Update file, keyed, externally described. Holds order headers.

---

## 3. Data Definitions

- **Parameters and working variables** for firm, order number, suffix, and accumulators (`w_tots`, `w_totk`, `w_totr` for totals).

---

## 4. Mainline Logic

### 1) Read Parameter Values

From the program's parameter list (passed to *entry).  
Stored in variables: `p_firm`, `p_numm`, `p_suff`.

--- 

### 2) Loop Through All Order Lines For Given Order

```rpg
c     fodtl1_key    setll     fodtl1
c     fodtl1_key    reade     fodtl1                                 90
c                   dow       *in90  = *off
```
- Positions to the first order line for this order (`setll`, `reade`).
- Loops while records are found.

#### For Each Line:
- Gets `vltyl1_ltyp = fdltyp` (current line type).
- `chain` to line type master to get more info (e.g., is it a text line?).
- **If not a text line** (`valktx = 0`): Add values from line to the header totals:
    - `fdsums` → `w_tots`
    - `fdsumk` → `w_totk`
    - `fdsumr` → `w_totr`

--- 

### 3) Update Order Header

After summing all eligible order lines:

```rpg
c                   exsr      oppd_fohe
```
- Calls subroutine to update the appropriate header record with new totals.

---

### 4) Program End

```rpg
c                   eval      *inlr = *on
c                   return
```
- Sets LR indicator for program end.

---

## 5. Subroutines

### oppd_fohe - Update Order Header

```rpg
c     fohelu_key    chain     fohelur                            90
c                   eval      fotots = w_tots
c                   eval      fototk = w_totk
c                   eval      fototr = w_totr
c                   if        *in90  = *off
c                   time                    foedat
c                   time                    foetim
c                   eval      foeusr = l_user
c                   update    fohelur
c                   endif
```

- **chain** to the order header record.
- Updates totals and audit info if found:
    - `foedat`/`foetim`: Date/time for update.
    - `foeusr`: User from local data area (LDA).
- Performs `update fohelur`.

---

### *inzsr - Initialization

Handles parameter assignment, builds key lists for later use, and assigns firm number.

---

## 6. Key Lists

- **vltyl1_key**: For retrieving line type info.
- **fohelu_key**: For retrieving/updating the order header.
- **fodtl1_key**: For reading order lines.

---

## 7. Special Notes

- **Text Lines**: Any order line with `valktx ≠ 0` is skipped in total calculations.
- **Audit Trail**: Updates date/time/user on order header when saving totals.
- **LDA**: User info is extracted from the Local Data Area (`l_user`).

---

## 8. Summary

- Reads all order lines for a specific order (`firm`, `number`, `suffix`).
- Sums only "real" (non-text) lines into three total fields.
- Updates order header (`fohelu`) with these sums plus audit info.
- Skips text lines.
- Carefully manages the record keys for file operations.

---

## 9. Onboarding Tips

- **Understand the data model**: How order headers and lines relate, and which fields represent totals.
- **File structure**: Make sure you have DDS/source for the logical/physical files used for reference.
- **Test data**: Run with a sample order with multiple lines (some text, some not) for validation.
- **RPG IO Operations**: Review how 'setll', 'reade', and 'chain' work with keyed files.

---

**This program is a classic, batch-style RPG process for recalculating order header totals based on details, with careful exclusion of text lines and proper audit trail handling.**