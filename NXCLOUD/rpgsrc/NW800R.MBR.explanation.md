# NW800R â€“ WAP, API Controller Program

## Overview

**NW800R** acts as a controller or dispatcher program within the ASOFAK system, handling API requests for various WAP-related business operations. The program receives a set of parameters, initializes local variables, and routes the request to the appropriate handler program based on the operation type specified in the parameters.

This program is central in coordinating different business processes through a unified API entry point. It ensures consistent parameter passing, error handling, and initial setup for downstream programs.

---

## Structure and Flow

### 1. Parameter and Variable Definitions

**Parameters (p_*)**  
These are the input/output parameters received from the caller (likely another program, API gateway, or external interface):

- `p_fgrp` (3A): Functional group (used only for 'NBU' record type)
- `p_firm` (3A): Company/firm code
- `p_avde` (4A): Department code
- `p_recd` (3A): Record type (determines which sub-program to call)
- `p_uniq` (15A): Unique identifier for the transaction/request
- `p_bibl` (10A): Library name or reference
- `p_dtqi` (10A): Input date/time (format: DMY)
- `p_dtqo` (10A): Output date/time (format: DMY)
- `p_feil` (1A): Error flag (output, set to *ON if errors occur)

**Working Variables (w_*)**  
Local variables for internal logic and for passing to sub-programs:

- `w_fgrp`, `w_firm`, `w_avde`: Local copies of group, firm, and department
- `w_inpl`, `w_outl`: Input/output buffer lengths (default 1024)
- `w_wait`: Wait time (default 0)
- `w_keyo`, `w_keyl`: Key operation and length (default 'EQ' and 15)
- `w_sndl`, `w_sndi`: Send length (default 0) and send data (blank)

### 2. Initialization

- The program copies the incoming parameters to local variables for use and to ensure correct data typing (notably, `w_firm` and `w_avde` are defined as packed).
- Standard buffer and key variables are initialized with default values, ensuring downstream programs receive consistent and expected values.

### 3. Main Dispatch Logic

A large `SELECT` block routes processing based on the `p_recd` (record type) parameter:

- **PRO**: Calls `NW810R` (likely "Production" or similar)
- **VAR**: Calls `NW820R` (possibly "Variant" or related process)
- **VSO**: Calls `NW825R`
- **EXP**: Calls `NW850R` (possibly "Export")
- **ORD**: Calls `NW860R` (likely "Order")
- **NBU**: Calls `NW870R` (possibly "New Business Unit" or similar)
  - Only for `NBU` is `w_fgrp` (functional group) passed as a parameter.
- **OTHER**: Sets error flag and jumps to program end.

Each called program receives the same set of parameters (with minor variation for `NBU`), ensuring a standardized interface for all handler programs.

### 4. Error Handling

- If an unrecognized `p_recd` is received, `p_feil` (error flag) is set to *ON, and the program jumps to the end.
- A *PSSR error subroutine is present: If any unexpected exception occurs, it sets the error flag and terminates gracefully.

### 5. Program Termination

- On completion or error, control jumps to the `avslutt` label, sets LR on, and returns.

### 6. Initialization Subroutine (*INZSR)

- Defines the program's entry parameter list, matching the expected external call signature.

---

## Domain/Business Logic

- **Record Type Routing:**  
  The main purpose of NW800R is to centralize routing of WAP/API requests by record type. Each record type corresponds to a specific business process or transaction, handled by a dedicated program.
- **Parameter Consistency:**  
  All handler programs receive a uniform set of parameters, which simplifies downstream processing and maintenance.
- **Error Propagation:**  
  The error flag `p_feil` is used throughout the call chain to signal issues to the caller or upstream systems.

---

## Design Patterns and Conventions

- **Dispatcher Pattern:**  
  The program acts as a dispatcher, centralizing the logic for determining which downstream process to invoke.
- **Consistent Parameter Passing:**  
  All sub-programs are expected to conform to a standard parameter list, simplifying integration and reducing coupling.
- **Error Handling Convention:**  
  Use of a single error flag (`p_feil`) as a simple, consistent mechanism for error reporting across all related programs.
- **Legacy Style:**  
  The code uses fixed-form RPG, which is standard in many mature IBM i environments but may be unfamiliar to developers used to free-form RPG.

---

## Interactions with Other Modules

- **Handler Programs:**  
  - `NW810R`, `NW820R`, `NW825R`, `NW850R`, `NW860R`, `NW870R`
  - Each of these is responsible for a specific business process. They all expect the same parameter structure, with the exception that `NW870R` also receives the functional group.
- **External Callers:**  
  - NW800R is designed to be called by other programs or API interfaces, acting as a gateway or facade.

---

## Notable Implementation Details

- **Buffer Lengths and Keying:**  
  The use of `w_inpl`, `w_outl`, `w_keyo`, `w_keyl` suggests that downstream programs may perform keyed data access or messaging, possibly via data queues or similar mechanisms.
- **Date Format:**  
  The program specifies `datedit(*dmy)` in the H-spec, enforcing DMY date format for all date operations.
- **No Debug IO:**  
  `option(*nodebugio)` disables debug I/O, which might be a security or performance consideration.

---

## Summary Table

| Parameter     | Description                | Passed to Handlers | Notes           |
|---------------|---------------------------|--------------------|-----------------|
| p_fgrp        | Functional group          | Only NW870R        |                 |
| p_firm        | Company/Firm code         | All                |                 |
| p_avde        | Department code           | All                |                 |
| p_recd        | Record type (routing key) | N/A                | Used for select |
| p_uniq        | Unique ID                 | All                |                 |
| p_bibl        | Library                   | All                |                 |
| p_dtqi        | Input date/time           | All                | DMY format      |
| p_dtqo        | Output date/time          | All                | DMY format      |
| p_feil        | Error flag                | All                | Output param    |

---

## Onboarding Notes

- **When adding new record types:**  
  Extend the select/call logic and ensure the new handler program follows the same parameter interface.
- **Error handling:**  
  Always check and propagate `p_feil` in downstream programs for consistent error management.
- **Parameter typing:**  
  Be aware of the packed/alpha differences in local (`w_*`) vs. parameter (`p_*`) variables, especially when expanding or refactoring.
- **Modernization:**  
  Consider moving to free-form RPG and modularizing further if long-term maintainability is a concern.

---

## Conclusion

NW800R is a central routing program for WAP/API operations, ensuring standardized processing, error handling, and parameter passing for a suite of business processes. Understanding its role is key to integrating new functionality or troubleshooting issues in this part of the system.