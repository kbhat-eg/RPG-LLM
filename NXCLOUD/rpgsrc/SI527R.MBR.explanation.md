# SI527R – Documentation

## Overview

**Program:** SI527R  
**System:** ASSTAT  
**Description:** Handles the selection and parameterization for updating purchase statistics. This program collects user input for filtering and selection criteria, validates the input, builds a parameter structure, and then invokes the next program in the process chain (SI528C) with those parameters.

## Business Context

This program is part of the purchasing statistics subsystem. It is typically used to allow users to specify which statistics (e.g., by period, year, product group, etc.) they wish to update or process. After collecting and validating the selection, it hands over control to a subsequent program responsible for the actual processing or reporting.

## File and Display Definitions

- **fsi527d**: Workstation file used for interactive screens.  
  - Screens referenced: `a1bld` (field selection), `b1win` (period/year selection).

## Data Structures

### Parameter Structure (`d_parm`)

A 96-byte data structure used to pass selected parameters to the next program (SI528C). Individual fields are overlaid on this storage:

| Field      | Length | Description                      |
|------------|--------|----------------------------------|
| d_firm     | 3      | Company/firm number              |
| d_paar     | 4      | Year                             |
| d_fper     | 2      | From period                      |
| d_tper     | 2      | To period                        |
| d_lkat     | 1      | Category flag                    |
| d_dist     | 1      | Distributor flag                 |
| d_selg     | 1      | Seller flag                      |
| d_avde     | 1      | Department flag                  |
| d_lagr     | 1      | Warehouse flag                   |
| d_nobb     | 1      | NOBB (product code) flag         |
| d_nmod     | 1      | Model flag                       |
| d_ldor     | 1      | Door flag                        |
| d_lvar     | 1      | Variant flag                     |
| d_vgrp     | 1      | Product group flag               |
| d_agrp     | 1      | Article group flag               |

The rest of the structure is reserved for future expansion or is unused.

### Local Data Area

Fields extracted from the user’s LDA (User Data Space), including:
- `l_user` (user ID)
- `l_firm` (firm number)
- `l_fnav` (firm name)

These are used to pre-fill or validate user selections.

### Working Variables

- `w_paar`: Holds the selected year.
- `w_jobq`: Indicates if the job should be submitted to a job queue (F4 function key).

## Program Flow

### 1. Initialization (`*inzsr`)

- Sets default values for the year (`b1paar` = current year), from period (`b1fper` = 01), and to period (`b1tper` = 12).

### 2. Field Selection Screen (`a1bld`)

- Presents the user with a screen to select which fields/statistics to update.
- User can exit via function keys (F3/F12).
- If no selection is made, the screen is re-presented (enforces at least one selection).

### 3. Period/Year Selection Screen (`b1win`)

- User specifies the year and period range for the statistics update.
- Validations:
  - Year must be >= 1990.
  - From-period must not exceed To-period.
  - If invalid, screen is re-presented.
- The selected values are used to populate the parameter structure.

### 4. Parameter Assembly

- The program populates the `d_parm` structure with the selected firm, year, period, and flags from the previous screens.
- The NOBB flag (`d_nobb`) is explicitly reset to zero before being set from the screen value, likely as a workaround for possible screen field issues.

### 5. Job Queue Option (F4)

- If the F4 key is pressed (`*INKD`), sets `w_jobq` to '1', indicating the job should be submitted to a job queue in the next step.

### 6. Invocation of Next Program

- Calls program `SI528C`, passing:
  - `d_parm` (selection and filter parameters)
  - `w_jobq` (job queue indicator)
- `SI528C` is responsible for processing the selected statistics update.

### 7. Program Termination

- Sets LR (`*INLR`) to *ON and returns, ending the program.

## Design Notes and Conventions

- **Parameter Passing:** All selection criteria are packed into a single data structure (`d_parm`) for ease of maintenance and extensibility.
- **Screen Enforcement:** The program ensures at least one field is selected before proceeding, reducing the risk of unintended mass updates.
- **Job Submission:** The F4 key conventionally triggers job queue submission; this is signaled via a single-character flag.
- **Modular Design:** The program is strictly responsible for user interaction and parameter preparation; processing logic is delegated to `SI528C`.
- **Validation Loops:** Both selection screens enforce valid input via simple loopbacks (using tags and `goto`), which is a legacy but effective pattern in classic RPG.

## Interactions with Other Modules

- **SI528C:** Receives the selection parameters and processes the actual statistics update or report.
- **Workstation File (fsi527d):** Provides the user interface for data entry and selection.
- **LDA:** Used for context, such as defaulting the firm number.

## Business Rules and Domain-Specific Logic

- Users must specify at least one filter/field for updating statistics.
- Year must be within a valid range (>= 1990).
- Period range must be logical (from <= to).
- The selection and options are tightly coupled to the purchase statistics business process.

## Summary

SI527R is a user-facing selection and parameterization program in the purchasing statistics subsystem. It handles all user interaction for filtering and selection, enforces business rules, and prepares a compact parameter structure for downstream processing. Its design emphasizes separation of concerns, robust input validation, and clear handoff to processing modules.