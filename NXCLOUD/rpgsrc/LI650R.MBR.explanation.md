# RPG Code Explanation

This RPG program is a parameter entry and control program for EDI quality control. It's written for IBM i (AS/400) in the older fixed-format ILE RPG style (RPG IV). Below is an onboarding-friendly explanation, with a focus on its structure and logic flow.

---

## Header & Documentation

- `h option(*nodebugio) datedit(*dmy)`  
  Compiler options: disables debug IO & sets date editing to day/month/year.

- Extensive comments document the program ("LI800R"), its purpose (supplier parameter entry for EDI quality control), and indicator usage conventions.

---

## File Declarations

```rpg
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fli650d    cf   e             workstn
```
- `rlevl1`: Database file (likely supplier master), renamed record format; keyed access.
- `li650d`: Display device (workstation) file, for user interaction.

---

## Data Definitions

### Local Data Area
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Reads system LDA (Local Data Area) to fields `l_user`, `l_firm` (company), and `l_fnav`.

### Parameter Data Structure (to pass to subprogram)
```rpg
d                 ds
d d_parm                        15
d  d_firm                        3  0 overlay(d_parm)
d  d_ldor                        6  0 overlay(d_parm:4)
d  d_val1                        1  0 overlay(d_parm:10)
d  d_val2                        1  0 overlay(d_parm:11)
d  d_val3                        1  0 overlay(d_parm:12)
```
- `d_parm`: 15-character "packed" parameter string.
- Overlays break out company (`d_firm`), supplier (`d_ldor`), plus three check values (`d_val1`-`d_val3`).

### Variables for Keys and Fields
```rpg
d rlevl1_levr     s                   like(rllevr)
d w_firm          s                   like(rlfirm)
d w_parm          s             15
```
- `rlevl1_levr`: Supplier key field, same type as DB key.
- `w_firm`: Company field, same type as DB field.
- `w_parm`: Parameter buffer to pass to subprogram.

---

## Main Program Logic

### Initialization (`start_pgm` tag)
```rpg
c     start_pgm     tag
c                   eval      b1ldor = 0
c                   eval      b1val1 = 1
c                   eval      b1val2 = 1
c                   eval      b1val3 = 1
```
- Initializes fields for the parameter entry screen (supplier number = 0, all checks on = 1).

### Main User Interaction Loop (`bilde_ut` tag)
```rpg
c     bilde_ut      tag
c                   exfmt     b1bld
```
- Displays screen format `b1bld` for parameter input.

#### F3=Exit
```rpg
c                   if        *inkc = *on
c                   goto      end_pgm
c                   endif
```
- If F3 is pressed, goes to `end_pgm` for program end.

#### F4=Supplier Inquiry
```rpg
c                   if        *inkd = *on
c                   call      'RL500R'
c                   parm                    w_firm
c                   parm                    b1ldor
c                   parm                    b1ltek
c                   goto      bilde_ut
c                   endif
```
- If F4 is pressed, calls subprogram `RL500R` (supplier inquiry), passing company, supplier, and text buffer.
- Then loops back to parameter input.

#### Validate Supplier Number
```rpg
c                   eval      rlevl1_levr = b1ldor
c     rlevl1_key    chain     rlevl1
c                   if        not %found
c                   eval      *in33 = *on
c                   goto      bilde_ut
c                   endif
```
- Copies entered supplier number (`b1ldor`) into key variable.
- Looks up supplier in the database (`chain`).
- If not found, sets indicator 33 (error on screen), and returns to input.

#### Exit if All Checks Off
```rpg
c                   if        b1val1 = 0 and
c                             b1val2 = 0 and
c                             b1val3 = 0
c                   goto      end_pgm
c                   endif
```
- If all three checkboxes/flags are off, exit program.

#### Prepare Parameter Buffer & Call Control Routine
```rpg
c                   eval      d_firm = w_firm
c                   eval      d_ldor = b1ldor
c                   eval      d_val1 = b1val1
c                   eval      d_val2 = b1val2
c                   eval      d_val3 = b1val3
c                   eval      w_parm = d_parm

c                   call      'LI651C'
c                   parm                    w_parm
```
- Fills parameter buffer with selected values.
- Calls control routine/program `LI651C`, passing the parameter buffer.

---

## Program End (`end_pgm` tag)
```rpg
c     end_pgm       tag
c                   eval      *inlr = *on
c                   return
```
- Sets LR (last record) to end the program and return.

---

## Initialization Subroutine (`*inzsr`)
```rpg
c     *inzsr        begsr
c     rlevl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rlevl1_levr
c                   eval      w_firm = l_firm
c                   endsr
```
- Defines key list for supplier DB lookup.
- Initializes working company code (`w_firm`) from local data area.

---

## Indicators Usage (from header comment)

- `LR`: Program end
- `21`: Home-key
- `22`: Cursor placement
- `30`: Field protection
- `31-79`: Screen messages/warnings
- `80-99`: Work indicators

---

## Typical Flow

1. **User sees screen to enter/select a supplier and checks.**
2. **F4** calls supplier inquiry; **F3** exits program.
3. **When supplier entered,** checked for validity against DB.
4. **If valid and checks selected,** calls control program.
5. **If not valid, shows error and loops.**
6. **If checks are all off, exit program.**

---

## Key Points

- **Modular**: Calls other programs for supplier inquiry and parameter processing.
- **Screen-driven**: Central interaction is via `b1bld` display format.
- **Uses overlays**: For compact parameter passing.
- **Classic RPG IV structure**: Pre-free format, heavy use of indicators and tags.
- **Initialization**: Company code pulled from system LDA for security/consistency.

---

## For New Developers

- **Understand indicator usage**: They drive much of the conditional logic and screen behavior.
- **Know your display files and subprograms**: `b1bld`, `RL500R`, and `LI651C` are key.
- **The parameter structure (`d_parm`)**: Compact, overlays are used to break out/compose component values.

---

This should provide a solid onboarding overview of the code's purpose and operation!