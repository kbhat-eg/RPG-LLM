# RL134R – Maintenance of Factoring Parameters via iizy

## Purpose

This program (`RL134R`) is part of the NXCLOUD system and is responsible for the maintenance (viewing and updating) of factoring parameters for different partners, interfacing with iizy (likely a middleware or integration layer). The program provides an interactive workstation (5250 display file) UI for users to view, validate, and update factoring-related configuration for a selected company.

## Structure Overview

- **Physical and Logical Files**
  - `ra34st` (renamed as `ra34irr` and `ra34iur`): Holds parameter records per company (factoring settings).
  - The program reads (`ra34irr`) and updates (`ra34iur`) these records.

- **Display File**
  - `ra134d`: The workstation display file used for data entry and message display.

- **Local Data Area (LDA)**
  - Used to retrieve session-specific data such as user, company number, and company name.

- **Variables**
  - Local variables for working with firm number, selection flags, and screen fields.

- **Main Program Flow**
  - On startup, initialize keys and retrieve values from LDA.
  - Read existing factoring parameters for the selected company.
  - Display the data entry screen.
  - On user input, validate required fields.
  - If valid, update or insert the parameter record.
  - Show error messages as needed and loop for correction.

## Key Business and Domain Logic

### Factoring Partner Maintenance

- The program allows maintenance of factoring parameters for specific partners (DNB, SB1, NORDEA, NORDEANY, SVEA).
- Each partner configuration includes bank account, client number, FTP info, and additional fields.

### Validation

Before saving, the following validations are performed:

1. **Factoring Partner Selection**
   - Only allows specific partner codes. If invalid, error message is shown.

2. **Bank Account**
   - Must be non-zero.

3. **Client Number**
   - Must be non-zero.

4. **Post Split Code**
   - Must be specified (non-blank).

5. **FTP Information**
   - FTP server, user, and password must all be provided.

If any validation fails, the corresponding indicator is set and a message screen is displayed (handled via subroutines).

### User Interface

- Uses a main entry screen (`c2bld`) for data display and editing.
- Error messages are displayed via separate screens (`c2msg1` – `c2msg5`), each shown by a dedicated subroutine.
- The user can toggle password display with a function key (indicator *in40).
- Exit is handled via function keys (indicators *inkc or *inkl).

### Data Handling

- **Reading:** Uses a keyed CHAIN operation to fetch the parameter record for the selected company.
- **Updating/Inserting:** If a record exists, it is updated; otherwise, a new record is created.
- **Audit Fields:** Timestamps and user ID are updated on change.

### Key Design Decisions and Conventions

- **Renaming of Physical Files:** The same file (`ra34st`) is referenced with two different logical views (`ra34irr` for read, `ra34iur` for update), which is a common pattern in this codebase to separate read/write logic.
- **Screen Field Naming:** Screen fields (`c2fsel`, `c2fbkk`, etc.) are mapped directly to database fields (`rkfsel`, `rkfbkk`, etc.) for clarity and consistency.
- **Validation Loop:** The main program logic uses a tag/`goto` structure (`c2taga`) to loop back to the entry screen after errors, which is a legacy pattern for interactive RPG programs.
- **Use of Indicators:** Error states and user actions are managed via numbered indicators (*in31–*in35, *in40, etc.), which are also used to control screen attributes.

### External Interactions

- **LDA (Local Data Area):** Used to transfer session-specific data (user, company, etc.) into the program context.
- **Display File:** All user interaction is via the associated display file (`ra134d`), with format names matching the code comments and subroutine calls.
- **No External APIs:** The program is self-contained and only interacts with the database and display file.

## Relationships with Other Modules

- **Factoring Parameters Table:** The program maintains records in the factoring parameters table (`ra34st`), which may be referenced by other batch or online processes handling factoring integrations.
- **User/Company Context:** The program expects the session context to be established prior to invocation (via LDA).

## Subroutine Documentation

- **xc2msg1 – xc2msg5:** Each subroutine displays a specific error message screen. Note: `xc2msg5` incorrectly displays `c2msg4` (should be `c2msg5`).
- **\*inzsr:** Initialization subroutine, sets up key lists and retrieves firm number from LDA.

## Notable Patterns

- **Legacy RPG III/400 Style:** The code is written in a fixed-format RPG style, with heavy use of indicators and explicit field mapping.
- **Error Handling Loop:** Uses tag and goto for error correction, which is typical for interactive RPG programs but may be unfamiliar to developers used to modern control structures.

## Summary Table of Key Fields

| Screen Field | DB Field  | Description                     |
|--------------|-----------|---------------------------------|
| c2fsel       | rkfsel    | Factoring partner code          |
| c2fbkk       | rkfbkk    | Bank account number             |
| c2fkli       | rkfkli    | Client number                   |
| c2ffa1/2     | rkffa1/2  | Additional partner-specific info|
| c2fspl       | rkfspl    | Post split code                 |
| c2fiba       | rkfiba    | IBAN                            |
| c2fswi       | rkfswi    | SWIFT                           |
| c2fftp       | rkfftp    | FTP server                      |
| c2fusr       | rkfusr    | FTP user                        |
| c2fpwd       | rkfpwd    | FTP password                    |
| c2fldr       | rkffld    | FTP folder                      |
| c2uot1-5     | rkfot1-5  | User-defined fields             |
| c2edat       | rkfeda    | Last edit date                  |
| c2eusr       | rkfeus    | Last edit user                  |

## Error Message Screens

| Subroutine | Screen | Triggered When                      |
|------------|--------|-------------------------------------|
| xc2msg1    | c2msg1 | Invalid factoring partner           |
| xc2msg2    | c2msg2 | Bank account missing                |
| xc2msg3    | c2msg3 | Client number missing               |
| xc2msg4    | c2msg4 | Post split code missing             |
| xc2msg5    | c2msg4 | FTP info incomplete (possible typo) |

## Onboarding Notes

- Adhere to the read/update separation via renamed file declarations.
- Maintain the mapping between screen and DB fields for consistency.
- When modifying validation or adding partners, update both the code and the screen definitions.
- Be aware of the legacy indicator and tag/goto usage for UI flow.
- The program expects session context (user/company) to be set in the LDA before invocation.

If you have questions about the factoring partners, integration with iizy, or the structure of the parameter records, consult the business analyst or system architect responsible for NXCLOUD factoring.