# RPG Source Code Explanation

This RPG program is designed for IBM i (previously known as AS/400, iSeries) and is written in ILE RPG (RPG IV, fixed format). Its primary purpose is to print a report of accounts payable ("utskrift av leverandørgjeld") by supplier ("leverandør"). The code contains routines for processing suppliers, their transactions, totals, and supporting output in both traditional report and PDF/XML formats.

Below is a breakdown of the main sections and logic:

---

## **1. Header and Documentation**
- The program has a comprehensive documentation header explaining:
    - System, program name (RL648R)
    - Description: Print supplier payables (leverandørgjeld)
    - Modification history and references.
- Comments and change logs are in Norwegian.

---

## **2. File Declarations**
The files declared are:
- **Input files:**  
  - `rlw1l1`, `levl1`, `rltrl1`, `afirl1`, `a01l1` — all are disk files with key access and renamed record formats for local use.
- **Printer file:**  
  - `rl648p` — used for report output; user-open (`usropn`) for dynamic opening/closing, with overflow indicator.
- **CTDATA** array for hardcoded text (`txt`), as well as local arrays for names (`lna`).

---

## **3. Data Structures and Variables**
- **Data structure examples:**
    - `wkwrec` is a data structure overlayed with supplier number, company, and name fields for easy manipulation.
- **Work fields:**
    - Amounts (`w_sald`, `w_gsal`, ...), dates (`w_pdat`, `w_sdat`), and counters (`w_antlev`, `w_antusal`, `w_antpost`), flags, and keys.
- **PDF/XML/Meta Integration:**
    - Variables for spooled file handling (`splfname2`, `jobname2`, ...), XML tags (`p_tagg0`/`p_tagg0val` ...), and PDF processing (`p_btyp`).

---

## **4. Import Programs and Data Structures**
- **External Procedure:**  
  - `QSPRILSP`: IBM API to list information about spooled files.
- **Data structures for spooled file APIs (`sprl0100`, `errorcode`)** for integration with PDF/XML.

---

## **5. Main Program Flow**

#### **Initialization**
- The program writes the initial header (`h101`), then starts looping to process each supplier transaction (`nyles` loop).

#### **Main Loop**
- **Reads suppliers from `rlw1l1`.**  
  - If EOF, sets last record indicator and goes to `slutt` (end label).
- **Processes supplier data:**
    - Copies work record, resets page.
    - Reads supplier master (`levl1`).
    - Calls the subroutine `les_levtr` to process supplier transactions.

#### **Transaction Processing (`les_levtr`)**
- Initializes work fields.
- Read supplier's transactions from file (`rltrl1`) using keys.
- For each transaction record:
    - Skips transactions not matching the current year/period or those already settled.
    - Accumulates balance (`w_sald`), counts posts.
    - Writes detail lines (using printer file).
    - Handles overflow and page header logic.

#### **Output and Totals**
- For each supplier, if there are transactions, writes totals and summary lines (`h102`), increments running totals.
- At the end, writes final report headers and process selection info (parameters for specific suppliers).

#### **PDF/XML and Spool Integration**
- If running in PDF mode (`l_poff='1'`):
    - Calls subroutines to:
        - Get the actual spool ID (`spoolnbr` calls QSPRILSP)
        - Close the printer file, create the XML data (`xml_create`)
        - Invoke preview in a browser if specified (`pdf_preview`)
        - End the batch job (`call 'AB710R'`)

---

## **6. Subroutines**
### **`les_levtr`**
- Handles reading and processing open transactions for each supplier.

### **`spoolnbr`**
- Uses the IBM QSPRILSP API to get the most recent spool file info for PDF generation.

### **`xml_create`**
- Initializes fields and calls an external program (`AP627R`) to generate an XML file for the report, passing along meta and supplier information.

### **`pdf_preview`**
- Optionally calls a program to launch the PDF report in a browser if enabled.

### **`*inzsr` (Initialization Subroutine)**
- Sets up keys for external files, opens the report printer file, sets up parameters, code lookups, and other flags.
- Handles various report selection and sorting options (per department, category, etc.).

---

## **7. Messages and Texts**
- Hardcoded text messages (in Norwegian), e.g. "Avdeling", "Kategori", "Selger", "*** U K J E N T ***".

---

## **Key Functional Features**

- Reads supplier and transaction files, accumulates and prints balances per supplier.
- Flexible report selection: specific suppliers only, grouping and sorting options.
- Dynamic header and totals per supplier, department, or category as needed.
- PDF/XML export capability, with meta-tagging support for external integration (e.g. Jasper Reports).
- Handles overflow and page headers.
- Well-structured for future maintainability, with clear separation of initialization, main logic, transaction processing, and external output/export routines.

---

## **Summary Table of Major Variables and Files**

| Variable/File     | Purpose                                                         |
|-------------------|-----------------------------------------------------------------|
| `rlw1l1`          | Supplier work file (input, key access)                          |
| `levl1`           | Supplier master file (input, key access)                        |
| `rltrl1`          | Supplier transaction file (input, key access)                   |
| `afirl1`          | Company file (input, for organization-level info)               |
| `rl648p`          | Printer output file (report/statement)                          |
| `w_sald`          | Running balance per supplier                                    |
| `w_antlev`, etc   | Counter variables (suppliers, posts, unmatched, etc)            |
| `p_tagg0`-`9`     | XML/Meta tags for Jasper/pdf integration                        |
| `l_poff`          | Indicates if PDF output is required                             |

---

## **Integration Points**
- External programs (`AP627R`, `AP621R`, `AB710R`) handle XML generation, PDF viewing, and job termination.
- QSPRILSP API is used to manipulate spool file information for PDF generation.

---

## **Best Practices and Patterns Noted**
- Use of overlays in data structures for variable re-use.
- User open for the printer file, allowing mid-program close/open.
- Structured initialization and error flags.
- Tagging for XML/PDF meta-data extensibility.
- Clear and copious comments (in Norwegian, as per the application's region/standard).

---

## **In Summary**
This program is a robust, legacy-style RPG report generator for supplier payables, with modernized hooks for PDF/XML output and good modularization for maintainability and extensibility. The logic is clear and separated, with explicit control over file access, workflow, and output format—catering to both traditional print and digital workflow requirements.