# Documentation for RPG Program BO761R (ASSHOP)

## Overview

**Program:** BO761R  
**System:** ASSHOP  
**Purpose:**  
This program is the main control module for handling direct packing slips (pakkseddel) via radio terminals (radioterminal) in a shop context. It coordinates the creation and processing of sales orders, updates inventory, writes historical transaction records, prints packing slips, and manages integration with external and historical registers. The program also supports advanced business rules such as ByggDok/Cobuilder compliance, customer-specific validations, and handling of returns.

---

## Business/Domain Context

- **Packing Slip Processing:** Handles the creation and completion of packing slips from radio terminals, including order number allocation, item and header registration, and printing.
- **Order and Transaction History:** Ensures all sales transactions are recorded in historical registers for later reporting and auditing.
- **Inventory Management:** Updates warehouse inventory based on the processed transactions.
- **ByggDok/Cobuilder Integration:** Supports requirements for construction documentation (ByggDok) and Cobuilder, including customer/project-specific handling and email notifications.
- **Parameter-Driven Validation:** Implements firm-level validation rules for delivery addresses and references, driven by the `AVALPF` table.
- **Return Handling:** Can process both sale and return transactions, affecting order type and downstream logic.

---

## File Dependencies and Relationships

The program interacts with numerous physical files (tables), each representing different business entities:

- **Order, Shop, and Bong Registers:**
  - `BMHEL1R`, `BMHELU`: Shop header (current and update)
  - `BMDTL1R`, `BMDTLUR`: Shop lines (current and update)
  - `BOHELUR`, `BODTLUR`: Bong (receipt) header and lines (historical)
- **Reference and Parameter Tables:**
  - `AFORL1R`: Formular/routine register
  - `BSTSL1R`: Shop status codes
  - `BWSDL1R`: Screen/cash register register
  - `VOTYL1R`: Order type register
  - `FOHEL1R`: Order header register
  - `FUSRL1R`: User register
  - `FKPRL1R`: Customer project register
  - `AVALL1R`: Firm-level validation rules
  - `AFPSLRR`: Properties file
- **Customer and Contact:**
  - `RKUNL1R`: Customer master
  - `RUKPL6R`: Customer contact persons
- **ByggDok Output:**
  - `FBDOPF`: ByggDok output file

---

## Program Flow

### 1. **Initialization (`*inzsr`)**

- **LDA Setup:** Local Data Area is defined for program-wide context.
- **Parameter Assignment:** Firm number, reference number, and return flag are received as parameters.
- **Key Lists:** Key lists for all relevant files are defined for later use.
- **Firm/Year/Date Setup:** Current year and firm number are set, and VAT rates are retrieved.
- **Screen ID Generation:** Since radio terminals lack unique screen IDs, a convention is used: `"RT" + user ID`.
- **User and Register Lookups:** Loads user info, shop/cash register info, and checks for ByggDok/Cobuilder activation.
- **Firm-Level Validation Checks:** Reads `AVALPF` for requirements on delivery address and reference.
- **Cobuilder/NOBB Check:** Calls external program `CO402R` to check if NOBB number is required for Cobuilder.

### 2. **Main Processing Logic**

#### a. **Order Number Allocation**

- Calls subroutine (`hent_numm`) to obtain a new order number from the number register (`AS100R`).
- Checks if the order number already exists; if so, retries.

#### b. **Shop Header Update**

- Updates the shop header (`BMHELU`) with order details, including order type, department, warehouse, and (conditionally) customer info.
- If validation rules require, fills in delivery address from the invoice address and reference from the order header.

#### c. **Order Type Lookup**

- Retrieves order type details from `VOTYL1R` for further processing.

#### d. **ByggDok/Cobuilder Handling**

- If activated, checks if the customer/project requires ByggDok or Cobuilder integration and sets flags accordingly.

#### e. **LDA Update**

- Updates LDA with current routine and screen ID for downstream processes.

#### f. **Packing Slip Printing**

- Calls external print program (`AP600R`) for pre-print processing.
- Allocates a new bong (receipt) number.
- Retrieves print routine and calls the appropriate print program for the packing slip.

#### g. **Write Historical Records**

- Calls `add_hist` subroutine to write all shop line transactions to the historical bong register, and updates the bong header.
- Calculates and adds VAT to total amounts.

#### h. **Order Register Update**

- Calls external program (`BOOFOR`) to update the order register, passing relevant parameters.

#### i. **Memo Balance Update**

- Calls external program (`FA922R`) to update the memo balance for the customer.

#### j. **Cleanup**

- Calls subroutines to delete processed transactions from the hand terminal and shop registers.

#### k. **Program Exit**

- Sets LR indicator and returns.

---

## Key Subroutines and Logic

### `hent_numm` - Number Register Handling

- Calls `AS100R` to obtain the next number for orders or receipts, based on context.

### `add_hist` - Historical Register Update

- Reads all lines from the shop line register.
- For each line:
  - Writes a corresponding record to the historical bong line register.
  - Updates inventory if required.
  - If ByggDok/Cobuilder conditions are met, writes ByggDok output.
- After lines, writes the bong header record with totals and customer/order info.

### `opplag` - Inventory Update

- Prepares a data structure with item, warehouse, and transaction details.
- Calls external inventory update program `VL001R`.

### `del_handterm` - Hand Terminal Transaction Deletion

- For all lines with a unique reference, calls `BO751C` to delete matching hand terminal transactions.

### `del_butikk` - Shop Register Cleanup

- Deletes all processed lines and the corresponding header from the shop registers.

### `mva_add` - VAT Calculation

- Adds VAT to the total amount if applicable, based on the VAT code.

### `byggdok` - ByggDok Output

- If ByggDok/Cobuilder is active and item criteria are met, writes a record to the ByggDok output file, including contact info and project data.

---

## Notable Patterns and Conventions

- **Versioning and Change Log:** The source includes a detailed change log with version numbers, dates, and comments for traceability.
- **Conditional Business Logic:** Many features (e.g., ByggDok, Cobuilder, validation rules) are controlled by firm/project parameters and flags, allowing for flexible, customer-specific behavior.
- **Key List Usage:** Extensive use of KLIST/KFLD for file access, improving maintainability and clarity.
- **Integration with External Programs:** Delegates complex or business-critical logic (e.g., printing, number allocation, inventory updates) to external RPG programs, keeping this program focused on orchestration.
- **Overlayed Data Structures:** Uses overlays for efficient handling of inventory update records.
- **Localization:** Some comments and variable names are in Norwegian, reflecting the business's domain and user base.

---

## External Program Calls

- **BOHNHR:** Prepares data for the shop register.
- **AS100R:** Allocates numbers from the number register.
- **AP600R:** Handles pre-print processing.
- **BOOFOR:** Updates the order register.
- **FA922R:** Updates the customer's memo balance.
- **VL001R:** Updates inventory.
- **BO751C:** Deletes hand terminal transactions.
- **CO402R:** Checks Cobuilder/NOBB requirements.
- **FÃ˜705R:** Retrieves VAT rates.

---

## Special Business Rules

- **Firm-Level Validation:** Delivery address and reference fields are required based on `AVALPF` configuration.
- **ByggDok/Cobuilder:** Only activated if the module is present and the customer/project requires it; email/contacts may be sourced from the project, customer, or contact person.
- **Return Handling:** The program distinguishes between sale and return transactions, affecting order type and downstream processing.
- **Screen ID Convention:** To compensate for radio terminals lacking unique IDs, screen IDs are synthesized from `"RT"` and the user ID.

---

## Summary

BO761R is a central orchestration program for processing direct packing slips via radio terminals in the shop system. It ensures all necessary records are created and updated across order, shop, bong, and historical registers, handles inventory and customer-specific requirements, and integrates with external documentation and validation systems. The program is highly parameterized and modular, supporting a wide range of business scenarios and compliance requirements.