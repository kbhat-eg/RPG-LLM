# RPG Program Explanation – `js510R`

This program is written in ILE RPG (also known as RPG IV), primarily using fixed-format coding conventions. It is used for chain assortment (kjedesortiment) querying, providing a subfile-based screen to display and interact with records from physical files.

## 1. **Header and Documentation**

The code begins with a standard header section, including change history and indicator usage explanations in Norwegian.

- `h option(*nodebugio) datedit(*dmy)`: Compiler options. `*nodebugio` disables debug for I/O, and `datedit(*dmy)` sets date format.

### Indicator Usage
- ERP programs for 5250 interactive screens rely on numeric indicators (`*IN01`–`*IN99`) for screen and logic control. E.g.:
  - `LR`: Last record, end program
  - `10–15, 21–22, 30, 31–99`: Used for subfile screen logic and messaging

---

## 2. **File Declarations**

```rpg
fjsorl1    if   e           k disk    rename(jsorpfr:jsorl1r)
fjsorl2    if   e           k disk    rename(jsorpfr:jsorl2r)
fjs510d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- `jsorl1` and `jsorl2`: Input files, both keyed access, renaming record format.
- `js510d`: Display file (workstation), with subfile `b1sfl` (subfile record), and feedback data structure (`infds(dspfbk)`).

---

## 3. **Variables and Data Structures**

- Parameters: 
  - `p_osor` and `p_otxt`: Used to pass selected values out of the program.
- Display Feedback Data Structure: 
  - `dspfbk` with `d_fcrn` (cursor row/position).
- Key variables: 
  - For setting database positions/navigation.
- Paging/Subfile Variables: 
  - `w_fcrn`: First record number on page
  - `w_srrn`: Relative record number in subfile
  - `w_ssrn`, `w_sfrn`, `w_spge`, etc.: Used for paginating and managing the subfile

---

## 4. **Constants**

- `c_sfil = 8`: Subfile page size constant

---

## 5. **Mainline Logic**

This program is a classic example of a subfile selection/browsing screen. The main flow is controlled by tags and branches (using `goto` and tags).

### Main Tags
- `b2taga`: First tag, usually start of main loop or 'send alternate' (writes `b2cmd` screen).
- `b2tagb`: Main data handling (subfile display/interaction).

### Main Loop

#### 1. **Display Subfile**
- Calls `dsp_subfile` subroutine to display and maintain the subfile.

#### 2. **Function Key Handling**
- Uses `select/when` to check function keys, e.g.:
  - F3/F12 (`*INKC`, `*INKL`): Exit
  - F5 (`*INKE`): Refresh, go to `forny`
  - F10 (`*IN10`): Next page, go to `crt_subfile`
  - F11 (`*IN11`): Previous page, go to `bck_subfile`
  - Home (`*IN21`): Set cursor, redisplay page

#### 3. **Positioning**
- If search fields (`b2osor`/`b2otxt`) are filled, subfile is repositioned.

#### 4. **Subfile Selection**
- Calls `subfile` subroutine to process possible selections.

#### 5. **Exit Logic**
- Tag `avslutt` sets `*INLR = *ON` (end program).

---

## 6. **Subroutines**

RPG IV uses subroutines (`begsr`/`endsr`). Key ones:

### a) `forny`
- Refreshes subfile based on the current positioning.
- Repositions file pointer and rebuilds the subfile.

### b) `posisjoner`
- Repositions the subfile to a particular search key, either by `osor` (discount group) or `otxt` (description).
- Clears and rebuilds the subfile accordingly.

### c) `subfile`
- Handles user selection in the subfile.
- Reads changed lines, updates selection flags, and sets output parameters.

### d) `clr_subfile`
- Clears the subfile (sets indicators, writes control record, resets counters).

### e) `crt_subfile`
- Fills subfile page with records.
- Reads corresponding records from the appropriate file (`jsorl1` or `jsorl2`).
- Writes records to the subfile, handles subfile end logic.

### f) `bck_subfile`
- Scrolls subfile one page back.
- Uses `readp` (read prior) to step backwards through records.
- Rebuilds the subfile after repositioning.

### g) `dsp_subfile`
- Displays the subfile using an `exfmt` (read/write) on the control record.

### h) `*inzsr`
- Initialization logic (special RPG subroutine run at startup).
- Sets up subfile and positions file pointer.

---

## 7. **Subfile Concepts Illustrated**

- **Subfile Paging**: Handles next/previous logic, page size, last/first record numbers, and manages paging variables.
- **Selection Logic**: Lets users pick a record, stores selection in output params.
- **Direct Positioning**: Supports search on key fields by direct input.

---

## 8. **Design Patterns**

- **Tag and GOTO**: Classic approach in fixed-format RPG for managing non-linear flow, especially for menus/screens.
- **Indicators**: Heavy use of indicators for state and flow control in green-screen applications.
- **Subroutines**: Modularizes reusable logic (clear, build, display subfile, etc.).
- **File Repositioning**: Uses `setll`, `chain`, and `read/readp`/`readc` for keyed file navigation.

---

## 9. **Display Concepts**

- **Subfile Areas**: 
  - `B1SFL`: Subfile of records
  - `B2CTL`: Subfile control record (controls subfile display, e.g., page up/down)
  - `B2CMD`: Command line display or alternate screen

- **Workstn and SFILE**: RPG defines subfile (SFILE) on a display file for efficient presentation and user interaction.

---

## 10. **Summary**

This program is a robust, classic RPG green-screen subfile browser for chain assortment querying, supporting:
- Paging (next/previous)
- Direct position/search
- Selection and parameter return
- Full subfile handling best practices

It is well-structured for maintainability, with logic mostly encapsulated in subroutines and explanatory comments (in Norwegian).

---

### **For Onboarding Developers**
- Focus on understanding subfile handling, indicator usage, and navigation logic.
- If new to RPG, review how `setll`, `chain`, `read`, and `readp` work with keyed access.
- Screen logic (`B1SFL`, `B2CTL`, etc.) is coordinated with indicators for user interaction.
- The code is modular: each subroutine does a clear job—refresh, build, clear, display, etc.
- Change keys (function keys) and cursor positioning are crucial for user experience in these types of screens.

---

**Tip:** For modernizations, consider refactoring large select/goto blocks with structured logic (e.g., `SELECT`/`WHEN` replaced by subprocedures), and replacing indicators with named fields or enums if moving to free-format.