# RPG Program Explanation: `RE131R`

## Overview

This RPG program, `RE131R`, is used for integrating payroll data from Huldt&Lillevik (H&L) payroll system into the ASOKON accounting system, generating accounting postings accordingly. The code is written in traditional (fixed-format) ILE RPG and is heavily commented (in Norwegian) to document version history and logic changes.

---

## High-Level Flow

1. **Set up program environment and declare files.**
2. **Read payroll posting records from the input file.**
3. **Process each posting:**
   - Find company and period information.
   - Generate the next available batch/journal number for new postings.
   - Build and write an accounting transaction (`rtrapfr`).
   - Delete the processed payroll posting record.
4. **After processing, update summary records (batch headers and company period status).**

---

## Key Areas

### 1. File Declarations (`F-Specs`)

```rpg
freutpf    upe  e           k disk      // Input: Payroll postings (to be processed)
fafirl1    if   e           k disk      // File: Company register
f ... rename(afirpfr:afirl1r)
E5.20fraa4l1    if   e      k disk      // File: Company period registry
T5.20f ... rename(raa4pfr:raa4l1r)
6.20 frp4ol1    if   e      k disk ...  // Project registry for extended project support
```

- **`freutpf`**: Main input file; contains payroll transactions.
- **`fafirl1`**: Company master data.
- **`fraa4l1`/`fraa4lu`/`frbunlu`**: Statistical/period records and batch headers.
- **`frtralu`**: Output: Accounting transactions.
- **`frp4ol1`**: Project registry (for enhanced project coding, V6.20+).

### 2. Data Declarations (`D-Specs`)

Defines standalone work fields (e.g., counters, keys, accumulators) to be used in processing.

```rpg
d �fem0           s              5  0
d �tte0           s              8  0
d pdatx           s                   like(�tte0)
...
```
Mainly accumulators and keys for transactions, batch numbers, etc.

### 3. Input Record Format (`I-Specs`)

Defines input fields for the payroll postings and data loaded from company and period registry files.

---

## Main Processing Logic (`C-Specs`)

Most of the logic is handled in the main calculation specifications, where records are read, processed, written, or deleted.

### A. Company/Period Lookup and Break Processing

Checks for changes in company/period (lines marked "BRUDD FIRMA"); if a break is detected, updates flags and keys.

### B. Generate Next Batch Number

Finds the next free batch number for the new accounting transaction using a descending read (`readp`) into the batch header file.

### C. Transaction Preparation

- Sets all required transaction fields, including:
  - Company, period, batch, line number
  - Debit/Credit accounts, amounts, project codes, VAT codes (from payroll/item data)
  - Populates timestamps, user IDs, and other system tracking fields

#### Project Code Handling (6.20+)

- Enhanced project key lookup: Attempts to resolve project number from registry, and normalizes the project code by stripping leading zeroes if not found.

### D. Transaction Write

Writes completed transaction record to the transaction output file.

### E. Post-processing

- Deletes the input payroll posting record.
- Updates period registry and writes batch header if needed (summary/header info).

---

## Subroutines

### `*inzsr`

- **Initialization subroutine**: Sets up working variables and defines key lists for common lookups (`keyfir`, `keyaa4`, `keybun`, etc).

---

## Key RPG Idioms and Patterns

- **`chain`**: Random read by key (for lookups).
- **`setgt`/`readp`**: Used to find the highest key (e.g., highest batch number).
- **`write`/`delete`**: Writing output transaction record; deleting input after successful processing.
- **Key Lists (`klist`)**: Used for multi-part keys for database file access.
- **Indicators (`*inXX`)**: Used for control logic (e.g., error flags, flow control).

---

## Notable Enhancements in Later Versions

The code is extensively annotated with version comments (e.g., 6.10, 6.20, 6.22). Some highlights:

- **6.10**: Corrects year updating when batch number is generated.
- **6.11**: Adds VAT code handling.
- **6.20 - 6.22**: Extended support for new project systems, supports numeric project codes and extra batch uniqueness constraints.

---

## Error Handling

- Uses indicators (e.g., `*in50`) to track and process errors/breaks.
- Jumps (`goto`) to labeled sections for error/post-processing (`slutt`, `felfir`).

---

## Summary

This program reads payroll transactions, generates corresponding accounting transactions ensuring correct batching and period tracking, and writes to the accounting system while updating control files. It is designed to run in batch, is highly modular, and accommodates changes in underlying project and company systems. Most fields and logic are named/described in Norwegian.

---

### Onboarding Tips

- **Understand the file layouts (`DSPFFD`/DDS specs) for input/output files**—those are referenced throughout.
- **Familiarize yourself with Norwegian accounting terms** as many field names/values come directly from those systems.
- **Pay attention to version comments** listed in the header and inline, as the codebase is actively maintained and modified.
- **Use reference manuals for ILE RPG fixed-format** for full understanding of syntax, especially for newcomers.