# ILE RPG Program Explanation: "Postering av lønn til Prosjekt" (IL200R)

This RPG source code is an RPG/400 (fixed-format) batch program designed to extract, aggregate, and post payroll transactions ("lønn") to project accounts. Below is a detailed walkthrough and explanation for onboarding developers.

---

## 1. **Header & File Declarations**

- **`H`-specs**:
  - `H/TITLE` and other headers give context (title, debug options, and date handling).
  - Example: `option(*nodebugio)` disables I/O debug; `datedit(*dmy)` sets date format.

- **File Declarations (`F`-specs)**:
  - The program reads and writes to various DISK files, often with alternate record formats (`RENAME`).
  - Some are update-capable (`UF`), some input-only (`IF`), some use a prefix to avoid name conflicts.
  - Main files:
    - `iltrlb`/`iltrlbr`: Payroll transaction file.
    - `ilonl1`, `ilarlu`, `iltrlc`: Related master files (employee, payroll code, tracking).
    - `raa4l1`, `rbunlu`, `rbunl2`, `rtralur`: For bundling, posting, and voucher number handling.
    - `rp4ol1`: Project/order file.

---

## 2. **Data Declarations**

- Many `D`-specs for working variables, status fields, and data structures.
- Examples:
  - `w_sum`, `w_deb`, `w_kre`: Totals for posting.
  - `s_*`: Variables holding the current period, account, etc.
  - Several data structures (`DS`) for:
    - Key layout (e.g., `FRAKEY`)
    - Date splitting/handling (`WFRA`, `WTIL`, etc.)
    - Bundling and order handling.

---

## 3. **Main Logic**

### a. **Start Reading Payroll Transactions**
```rpg
c     iltrlb_key    setll     iltrlb
c                   read      iltrlb
c                   dow       not %eof(iltrlb)
```
- *Starts at the first payroll transaction record (`iltrlb`). Loops through all relevant records (filtered by external OMIT logic in the physical file).*

### b. **Payroll Line Pre-filter**
- The code expects that only non-transferred, non-authorized, and assigned records are present due to the file's OMIT logic.

### c. **Check Validity of Posting**
- For each line, checks if the payroll code exists and has cost price/account in `ilarlu`.
- If not, skips the record (`iter`).

### d. **Detect Change in Key Fields (Period, Order, Code, etc.)**
- When moving to a new period/order/art, posts the accumulated amount so far.
- Uses:
  - `s_kli`, `s_per`, `s_onr`, `s_art`: Current grouping fields.
  - `w_sum`: Accumulated posting amount.

### e. **Save State for Next Posting**
- Updates key tracking variables for later grouping.
- Also, calculates the tracking number (`iltspr`) by finding the next available sequence.

### f. **Accumulate Posting Amount**
- `w_sum = w_sum + iltant * ilakpr`
  - Accumulates the posting amount (quantity × price).

### g. **Mark Payroll Transaction as Posted**
- Sets `iltovo = 'J'` (indicating it’s transferred to project) and updates the tracking number on the payroll line.

### h. **Update Payroll Line**
- Writes changes back to `iltrlbr`.

### i. **Continue to Next Record**
- Reads next payroll record.

### j. **Final Posting**
- After loop, if any amount remains (last group), posts it.

---

## 4. **Posting Subroutine (`poster`)**

The `poster` subroutine performs the actual posting of accumulated payroll costs.

### a. **Find/Create the Bundle ("bunt")**
- Uses keys (`rbunl2_key`, `rbunlu_key`) to find or increment the posting bundle for the day/user/company/period.

### b. **Voucher Number Handling**
- Checks/updates the voucher number (`bilagsnr`) for the current period/company in file `raa4l1`.

### c. **Post to Project**
- Fills in posting record fields:
  - Main posting: Debit to project account.
  - "Motpostering": Credit (reverse) posting outside the project.
- Populates reference fields from project/order if available.

### d. **Write Project Posting Records**
- Writes both main and motpostering records to `rtralur`.

### e. **Update the Bundle Totals**
- Updates the `rbunlu` record with the new debet/kredit sums.

---

## 5. **Initialization Subroutine (`*INZSR`)**
- Sets up key lists for file access (KLIST/KFLD).
- Initializes certain variables:
  - Sets date fields, voucher series number, etc.

---

## 6. **Key Handling (`KLIST`, `KFLD`)**
- RPG fixed-form indexed file access uses `KLIST`/`KFLD` for constructing keys.
- The keys are defined for each file lookup at the bottom of the program (inside `*INZSR`).

---

## 7. **General Notes**
- The whole program is a batch process, meant to be run as an end-of-period or daily routine.
- It is highly dependent on external file layouts and the data model (payroll, project, and accounting).
- Many variables are set up to handle Norwegian payroll/accounting terminology (e.g., `bilagsnr`, `lonn`, `prosjekt`).
- Date manipulations and sequence logics are handled manually with DS and calculations.

---

## 8. **Summary of Flow**

1. **Read payroll lines (`iltrlb`)**
2. **Validate and group lines by period/customer/project/code**
3. **Accumulate posting amounts**
4. **When group changes or at end, call `poster`**
5. **`poster` creates voucher/bundle/project posting & motpost**
6. **Marks processed payroll records as transferred**
7. **Updates totals and closes transaction**

---

## 9. **Typical Touchpoints for Developers**
- **Adding fields or logic**: Most changes happen in the main loop or in `poster`.
- **Changing key logic**: Update `KLIST` definitions.
- **Adjusting calculation logic**: Look for `w_sum`, `iltant`, `ilakpr`, etc.
- **File updates**: Check that record formats match physical files.
- **Date/period handling**: Review DS and conversion logic.

---

This code is typical of older IBM RPG batch accounting processes and demands careful attention to business rules "embedded" as code and data layout. Contact business analysts or domain experts for deeper business context if needed.