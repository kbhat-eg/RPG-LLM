# RPG Source Code Explanation â€“ Program RF228R ("Tilganger, vedlikehold")

## Overview

This RPG program, named `RF228R`, is designed for maintaining "tilganger" (access rights/permissions) in a system. The code is typical of classic ILE RPG, using subfiles for work with lists, and supporting maintenance functions such as add, update, and delete for access records. 

The code is well commented in Norwegian, describing indicators, data structures, file definitions, and subroutines. Below is a breakdown of structures, logic, and flow for onboarding developers.

---

## Header and File Declarations

### Program Options
```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debug I/O and sets date edit format to day-month-year.

### File Declarations
```rpg
fruktlr    if   e           k disk    rename(ruktpfr:ruktlrr)
fruktlu    uf a e           k disk    rename(ruktpfr:ruktlur)
fruktl1    if   e           k disk    rename(ruktpfr:ruktl1r)
frukflr    if   e           k disk    rename(rukfpfr:rukflrr)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frukpl2    if   e           k disk    rename(rukppfr:rukpl2r)
```
- Declares several physical files (or logical views) for access right, permission, customer, and contact person data, some with alternate record formats.

### Display File
```rpg
frf228d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Declares the display device file, with a subfile (b1sfl), and uses an information data structure `dspfbk` for feedback from display.

---

## Data Definitions

### Parameters and Local Data Area
```rpg
d p_firm          s                   like(rkfirm)
d p_kund          s                   like(rkkund)
d p_kpnr          s                   like(rutpnr)
```
- These parameters are passed to the program: company, customer, and contact person number.

#### User Data Space
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Maps fields in the user data area (local memory) for user, company, and firm name.

### Display Feedback DS
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- For feedback from the display file (e.g., first record number on subfile page).

### Key Fields
Variables for keys used when reading/updating files. Example:
```rpg
d ruktlr_tpnr     s                   like(rutpnr)
```

### Working Variables and Flags
```rpg
d w_fcrn          s              4  0
d w_srrn          s              4  0
d b_forn          s              1    inz(*off)
d b_tgok          s              1    inz(*off)
```
- Subfile, paging, and control flags.

### Constants
```rpg
d c_sfil          s              2  0 inz(13)
d c_digi          c                   '0123456789 '
```
- c_sfil: subfile page size constant.

---

## Indicator Usage

The program employs many numbered indicators (`*INxx`). Examples are:
- LR: Last record (program end)
- 10: Roll (page up)
- 14: Subfile clear
- 15: Subfile end

---

## Program Flow and Main Logic

### Initial Screen Handling and Main Loop

#### Tags and Control Records
```rpg
c     b2taga        tag
```
- Label for returning to the main menu screen.

```rpg
c                   eval      b2navn = w_knav
c                   eval      b2kper = w_kpna
c                   write     b2cmd
```
- Fills display variables (customer name, contact person) and writes command record to the display file.

#### Subfile Display and Function Key Handling
```rpg
c                   exsr      dsp_subfile
```
- Display or refreshes the subfile on the screen.

```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inkf
c                   exsr      xc2bld
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   when      *in21
c                   eval      *in22 = *on
c                   goto      b2taga
c                   endsl
```
- Handles function keys, e.g.:
    - F3/F12: Exit
    - F6: Add (calls entry/change routine, then refreshes subfile)
    - F10: Load more records into subfile
    - F21: Home, sets indicator

#### Subfile Handling
```rpg
c                   exsr      subfile
c                   goto      b2taga
```
- Calls a subroutine to process subfile entries and returns to the main screen.

#### Program End
```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets LR indicator (signals program end) and returns.

---

## Key Subroutines

### forny: Refresh Subfile

- Sets up position, clears, and recreates subfile.

### subfile: Process Subfile Rows

- Flips indicator 22 for cursor positioning.
- For each row in the subfile:
    - Reads a subfile record.
    - If selected for deletion (`b1valg = 4`), calls delete prompt/subroutine.
- If changes were made, refreshes the subfile.

### clr_subfile: Clear Subfile

- Turns on indicator 14 (subfile clear), writes control record, clears paging variables.

### crt_subfile: Load Subfile

- Increments the page size, loops to read from main file into subfile, one record per loop until page is filled or end-of-file/other stop.
- Uses key checks to find correct records.
- Evaluates access right (`sjekk_tilgang`) and sets description field.

### dsp_subfile: Display Subfile

- Displays subfile to user with proper indicators to control screen behavior and paging.

### xc2bld: Add/Change Access Entry

- Prepares the add/change screen, displays it, and processes input.
- Validates input (cannot be blank).
- Checks if the access type is valid (`sjekk_tilgang`).
- If ok, writes the new record, then refreshes subfile.

### sjekk_tilgang: Validate Access

- Checks if the access type (`rukflr`) exists for the given "firm".
- Sets the flag (`b_tgok`) if found.

### xc2msg1: Error Message Display

- Displays an error message if an invalid access type is entered.

### xd1win: Delete Confirmation and Delete

- Displays confirmation window for deletion.
- If confirmed, deletes the selected access record.

### *inzsr: Program Initialization

- Loads program parameters.
- Builds key lists for file access.
- Fetches customer and contact person names for display.
- Positions to the correct records and loads the initial subfile contents.

---

## Summary of Main Data Flow

1. **Start:** Receives firm, customer, and contact person as parameters.
2. **Initialize:** Loads names, positions to data, builds subfile.
3. **Display:** Shows screen with subfile listing access records.
4. **User Actions:** Can add, delete, scroll, or exit.
5. **Add:** Validates and writes new access.
6. **Delete:** Confirms prompt and deletes if agreed.
7. **Refresh:** After changes, subfile is rebuilt.
8. **End:** On exit, sets LR and returns, ending the program.

---

## Key Concepts for Developers

- **Subfiles**: Used to display and interact with lists (paging, selection, etc.).
- **Indicators**: Core to controlling flow and screen in RPG.
- **Modular Design**: Uses subroutines with clear responsibilities.
- **Validation and Feedback**: Input is validated, and user receives feedback or error messages via separate screens.
- **File I/O**: All maintenance (add, delete, query) uses specific keyed file access for efficiency.

---

This program is a classic RPG application for maintaining permissions, leveraging subfiles, efficient record navigation, and robust keyboard/screen control. The code is heavily commented, and understanding the subroutines and their trigger points is key for future maintenance and enhancements. 

For onboarding, focus on:
- Subfile operations and screen handling.
- Indicator usage.
- File/key structure and how data flows among screens and files.