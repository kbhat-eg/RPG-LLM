# RPG Program LO300R - Explanation

This RPG (Report Program Generator) source code is for an IBM i (aka AS/400) system. The program's main function is to **copy an entire purchase order (bestilling) from one set of records to another**, supporting a number of business rules and data validations. The code is heavily commented (some in Norwegian), includes extensive versioning notes, and shows continuous incremental enhancement.

Below, key components and logic are explained for onboarding developers.

---

## 1. Program Overview

- **Purpose:** Copy a purchase order (including header, lines, fixed texts), with options for resetting values, handling VAT/moms codes, updating stock, and transferring references.
- **Main Files:**
  - `rlevl1`: Supplier master (leverandørregister)
  - `lstsl1`: Stock status
  - `lohel1`, `lohelu`: Order header (original/copy)
  - `lodtl1`, `lodtlu`: Order lines (original/copy)
  - `lotxl1`, `lotxlu`: Order texts (original/copy)
  - Various others for codes and lookup (product, VAT, additional registers)

- **Control Keywords:**
  - `h datedit(*dmy) option(*nodebugio)` — Date editing and disables DEBUG IO.

---

## 2. File Declarations

Files are declared for both input (original order) and output/update (copied order), using the `rename` keyword to allow use of the same record format for both original and updated/copy files.

Example:
```rpg
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
flohel1    if   e           k disk    rename(lohepfr:lohel1r)
flohelu    uf a e           k disk    rename(lohepfr:lohelur)
```

---

## 3. Data Structure and Variables

- **LDA (Local Data Area):**
  - `l_user`, `l_firm` — Used for passing user and firm information.
- **Stock update data structure (`hlrec`)**: 
  - Overlaid fields mapping logical fields to a 128-byte buffer used for stock program call.

Example:
```rpg
d                 ds
d hlrec                        128
d  hlvare                       15    overlay(hlrec)
...
d  hlonum                        8  0 overlay(hlrec:90)
d  hlolin                        4  0 overlay(hlrec:98)
```

- **Control and parameter variables:** (`p_...`), status, keys, work fields.

---

## 4. Program Workflow

### a. Program Initialization (`*inzsr`)
- Reads parameters, populates working variables and keys.
- Reads status from `lstsl1`.
- Sets up keys for later access to all relevant files.

### b. Copying Order Texts
- If `p_xtxt` ≠ 0 (copy text lines?):
    - Reads all text records from the original, checks if they exist in the target, and writes them if not.
    - Timestamps and user info are updated.

### c. Copying Order Lines
- Loops through all original order lines:
    - Modifies specific fields (order type, supplier, VAT code, delivery date, discounts, references, timestamps, etc) for the new order.
    - Resets certain fields based on parameters (e.g., discount to zero if requested).
    - Calls subroutine to determine the correct VAT/moms code (`mva_kode`).
    - Optionally updates references to original order, depending on `p_beor`.
    - Writes the new order line.
    - Calls stock update subroutine (`opplag`), unless specific conditions prevent it.

### d. Copying Order Header
- Reads original header and prepares data for the new order header.
- Updates fields for new order number, supplier, timestamps, and resets/cleans some fields.
- Optionally updates supplier info from supplier master.
- Handles business rules such as clearing fields if copying to a new supplier.

#### Additional Register (`lotii2`):
- If special references are set, makes corresponding entries in an additional register.

#### If references are to be retained:
- Updates the original order (and lines) with pointers to the new order.

---

## 5. Post-processing

- **Price and Totals Calculation:**
    - Calls an external program (`LO730R`) to recalculate prices and totals for the copied order, depending on parameter values.

---

## 6. Subroutines

### `mva_kode` — VAT/Moms Code Determination
- Determines proper VAT/moms code for new line, based on line type, item master, and overrides.
- Key rules:
    - If order VAT code = 1 → line VAT code '0'
    - Else, uses item VAT code, or falls back to further logic.

### `opplag` — Stock Update
- Prepares a 128-byte data structure and calls external program (`VL001R`) to update inventory, reflecting the new order line.

---

## 7. Entry Parameters

Parameters passed to this program (see `*entry plist`) control:
- Coordinator, firm, original/new order numbers, order types, supplier, discount handling, text copying, and reference copying.

---

## 8. Key Lists

Many `klist` Key lists are used to group key fields for database file access. These are set up during initialization for both "read original" and "write copy" scenarios.

---

## 9. End and Cleanup

The program sets *INLR = *ON and returns, signaling end of job.

---

# Common Onboarding Questions

### **How does the program handle references from old to new orders?**
- If `p_beor` = 1, certain fields in the original order are updated to reference the new order, for traceability.

### **How is VAT/Moms code decided?**
- Line-level, using combination of header, item master, and VAT master.
- Logic is encapsulated in subroutine `mva_kode`.

### **When is inventory updated?**
- For each new order line, unless specific flags prevent it (e.g. certain stock/distribution types).

### **If copying to another supplier, what changes?**
- Some fields are cleared or replaced based on supplier master data.

### **Which programs are called from this program?**
- `VL001R`: Stock update
- `LO730R`: Price/sum calculation for new order

---

# Summary

This RPG program is a standard, robust utility for copying purchase orders (including all related data: header, lines, texts, etc.) in an IBM i ERP environment. It is carefully versioned and maintains flexibility via parameters for business rules such as discount resets, text copy, reference retention, and stock handling. 

The bulk of the code is about reading records from the original order, adapting data fields to match business rules, and then writing them for the new order, with updates to multiple related files for data consistency and traceability.

New developers should pay close attention to:
- The use of parameters to control copying behavior.
- The logic for VAT/moms code determination.
- Proper use of key lists for database file access.
- The business rules around supplier transfer and reference maintenance.
- The two main subroutines (`mva_kode`, `opplag`) and their external program calls.

Understanding these will allow you to maintain, enhance, or troubleshoot this program effectively within the broader procurement/order management system.