# RPG Program VX100R – EAN Number Maintenance

## Overview

This program, `VX100R`, is a maintenance utility for EAN numbers within the ASOFAK system. Its primary function is to allow users to view, add, update, copy, and delete EAN records associated with items (products) in the inventory. The program is interactive and uses subfiles for display and selection, and it integrates with several physical and logical files to maintain referential integrity and provide supporting information.

## Business/Domain Context

- **EAN** (European Article Number) is a barcode standard, widely used for product identification.
- The program allows maintenance of EANs on a per-company (`w_firm`) basis.
- Each EAN is associated with an item number (`vare`) and potentially with other item master data (description, unit, etc.).
- The program ensures that EANs are unique and not duplicated across item-units.

## File Dependencies

- `veanl1`, `veanl2`, `veanlr`, `veanlu`: Logical/Update views of the EAN register (typically keyed by EAN, item, or both).
- `vvarl1`: Item master file, providing item descriptions.
- `vvepl2`: Item-unit mapping, used to validate EAN uniqueness at the item-unit level.
- `vx100d`: Display file with subfile support for user interaction.

## Program Structure

### Indicators Usage

- Standard indicators (LR, 10–99) are mapped to program states, screen actions, and error handling.
- Indicators 31–79 are reserved for warnings and screen messages; 80–99 for internal logic.

### Data Structures

- **Local Data Area (LDA):** Used to retrieve current user and firm context.
- **Display Feedback (DSPFBK):** Used to manage cursor positioning and subfile navigation.

### Key Variables

- `w_firm`: Current company identifier.
- `w_vare`: Item number.
- `w_srrn`, `w_ssrn`, `w_sfrn`, `w_spge`, etc.: Subfile record navigation and paging variables.
- `b1valg`: User action on a subfile record (edit, copy, delete, view).
- `b_forn`, `b_oppr`, `b_anul`, `b_feil`: Boolean flags controlling refresh, operation, cancellation, and error states.

---

## Main Processing Flow

### Program Initialization (`*inzsr`)

- Sets up keys for all relevant files based on the current company.
- Loads the initial set of EAN records into the subfile for display.
- Sets the initial screen state.

### Main Loop

- The program is structured around a main display loop (`b2taga`, `b2tagb`) where the subfile is presented, and user actions are processed.
- User actions are handled by checking function key indicators and invoking corresponding subroutines:
  - Inquiry, refresh, add, edit, copy, delete, view, paging, etc.

### Subfile Handling

- **Subfile Display:** `dsp_subfile` manages the presentation and refresh of the subfile.
- **Subfile Creation:** `crt_subfile` fills the subfile with the next page of records.
- **Subfile Clearing:** `clr_subfile` resets the subfile area.
- **Paging:** `bck_subfile` handles backward paging.
- **Positioning:** `posisjoner` allows positioning to a specific EAN or item.
- **Subfile Record Processing:** The `subfile` subroutine processes user actions (edit, copy, delete, view) for each record.

### Record Maintenance

- **Add New Record:** `xc1bld` displays the entry screen for a new EAN, checks for duplicates (both in EAN master and item-unit mapping), and calls the maintenance routine (`xc2bld`).
- **Edit/View Record:** `xc2bld` handles both editing and viewing of an EAN record, including validation, updates, and display of associated item info.
- **Delete Record:** `xd1win` presents a confirmation window and deletes the selected record.
- **Copy Record:** `xk1win` allows duplicating an existing EAN to a new one, with duplicate checks.

### Validation & Cross-References

- **Duplicate Checks:** Before adding/copying, the program checks if the EAN already exists in both the main EAN register (`veanlr`) and the item-unit mapping (`vvepl2`) to prevent duplicates.
- **Item Validation:** On edit/add, validates that the item exists in the item master (`vvarl1`).
- **External Program Call:** Calls `VV500R` for item lookup on demand (typically a pop-up search).

### Messaging and Error Handling

- **User Messages:** When attempting to add a duplicate, a message screen is displayed (`xc1msg`).
- **Screen Indicators:** Error indicators (e.g., *in31, *in32, *in33) are set to trigger error messages or field highlighting on the display.

---

## Special Design Considerations

- **Subfile Paging:** The program uses a fixed page size (`c_sfil` = 14) for the subfile and manages navigation and positioning with several helper variables.
- **Business Rule Enforcement:** The program strictly enforces the uniqueness of EANs per item-unit and prevents manual addition of units to EANs (see comments on removal of this feature).
- **Audit/Tracking:** When updating or adding records, user and timestamp information is recorded.
- **Screen Modularization:** The display file is organized into modular screens (subfile, control, command, detail, message, delete, copy) for clarity and separation of concerns.
- **Internationalization:** Date and time formats are handled explicitly for Norwegian/European format (`*dmy`) and ISO time.

---

## Integration Points

- **Item Master:** `vvarl1` is referenced for item validation and description.
- **Item-Unit Mapping:** `vvepl2` is used to ensure EAN uniqueness at the item-unit level.
- **External Item Search:** `VV500R` is called for item lookups.
- **Display File (`vx100d`):** All user interaction is managed via this display file, using subfiles and various control/detail screens.

---

## Notes on Conventions and Patterns

- **Key Lists:** All file operations use explicit keyed access, with keys constructed at initialization.
- **Indicator-Driven UI:** Uses traditional RPG indicator-based screen and logic flow.
- **Subroutine-Driven Logic:** All major actions are encapsulated in subroutines for maintainability.
- **Error Handling:** Uses RPG indicators and message screens for user feedback.
- **Commenting:** The program is well-commented, especially regarding business rules, indicator usage, and file relationships.

---

## Summary Table: Key Business Interactions

| Action         | Subroutine   | Files Accessed      | Business Rule/Note                                         |
|----------------|--------------|---------------------|------------------------------------------------------------|
| Add EAN        | xc1bld       | veanlr, vvepl2      | Duplicate check in both EAN and item-unit                  |
| Edit/View EAN  | xc2bld       | veanlr, vvarl1      | Item must exist, audit fields updated                      |
| Delete EAN     | xd1win       | veanlr, veanlu      | Confirmation required                                      |
| Copy EAN       | xk1win       | veanlr, vvepl2      | Duplicate check, then invokes edit/view logic              |
| Item Lookup    | spørring     | vvarl1, VV500R      | External program call for item search                      |
| Subfile Paging | crt_subfile, bck_subfile | veanl1, veanl2 | Handles both forward and backward navigation               |

---

## Change History Highlights

- **6.10/6.11:** Enhanced tracking and duplicate checking at the item-unit level.
- **6.12:** Switched from `VVENL6` to `VVEPL2` for item-unit lookup, reflecting a change in file structure or business rule enforcement.

---

## Conclusion

The `VX100R` program is a robust, interactive EAN maintenance tool that enforces strict business rules around EAN uniqueness, integrates tightly with item master data, and provides a user-friendly subfile-based interface for maintenance tasks. The codebase is modular, indicator-driven, and well-annotated for onboarding experienced RPG developers. Understanding the subfile processing, indicator usage, and the relationships between the EAN, item, and item-unit files is key for effective maintenance and further development.