# Program Overview

This IBM ILE RPG program is intended for automatically building financial result reports (“Automatisk bygging av resultatrapporter”) for a given company/firm. It is an example of a classic RPG III/400 (fixed-format) program, which processes account structures and generates report registers.

Its core tasks are:
- Reading account data from several physical files (tables).
- Building output report files at various aggregation levels: account, account group, and account class.
- Handling both balance sheet (balanserapport) and profit/loss (resultatrapport) reports.

## File Declarations

```rpg
frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
fra19l1    if   e           k disk    rename(ra19pfr:ra19l1r)
fra20l1    if   e           k disk    rename(ra20pfr:ra20l1r)
frrf0l1    uf a e           k disk    rename(rrf0pfr:rrf0l1r)
frrf5l2    uf a e           k disk    rename(rrf5pfr:rrf5l2r)
frrf8l1    uf a e           k disk    rename(rrf8pfr:rrf8l1r)
```
- These statements declare logical or physical files (tables) to be used in the program.
- `rename()` is used to map external names to internal RPG format names.
- Some files are intended as input (`I`), output/update (`U`), or a mixture.

## Data Declarations

Variables are declared to hold values for the different files' fields, and working variables for processing.

There is a parameter data structure (`p_list` and overlays in `d_list`) for passing input into the program:
```rpg
d                 ds
d d_list                        64
d  d_firm                        3  0 overlay(d_list)
d  d_rapp                        2  0 overlay(d_list:4)
d  d_type                        1  0 overlay(d_list:6)
d  d_linj                        1  0 overlay(d_list:7)
```
- `d_firm` = company id
- `d_rapp` = report type
- `d_type` = balance (0) or result (1) report
- `d_linj` = level (account or group)

## Program Flow

1. **Initialization**

   In the `*inzsr` subroutine:
   - Reads and parses program parameters (`*entry plist`).
   - Writes a report header (`RR0`).
   - Sets up key lists for various files.

2. **Main Logic**

   The program follows a sequence of reading data and building lines in the output reports based on level and report type.

   ### a. Account Level (if `d_linj = 0`)

   - Loops through accounts (`rhovl1` file).
   - For each account, checks if it's a main account (no special code, not department account).
   - Depending on report type (balance or result), only includes relevant accounts.
   - Calls `linje_konto` subroutine to produce report lines.

   ### b. Account Class Level

   - Reads all account classes (`ra19l1` file).
   - For each, calls `linje19` to write header and sum lines for the class.

   ### c. Account Group Level

   - Reads all account groups (`ra20l1` file).
   - If working on account level, calls `linje20` for text/sum lines of each group.
   - Otherwise, calls `linje_gruppe` at the group level.

3. **Finalization**

   Depending on report type, outputs summary lines with standardized values to mark the end of the report (e.g., 'Driftsresultat', 'Avstemming', 'Driftsutgifter').

4. **End-of-Program**

   Sets the last record indicator (`*inlr = *on`) and returns.

## Subroutines

### 1. **linje_konto**
   - Builds a report line for an account.
   - Populates fields for the report and writes to report files.

### 2. **linje_gruppe**
   - Builds a report line at the account group level.
   - Writes summarized information to the report files.

### 3. **linje19**
   - Handles output at the account class level.
   - Writes both text and sum lines for the class.

### 4. **linje20**
   - Handles output at the account group level within a class.
   - Writes both text and sum lines for the group.

### 5. **init (INZSR)**
   - This is the initialization subroutine that sets up parameters, keys, and writes the header.

## Special Features

- The program uses overlays to extract subfields from a parameter structure, a classic RPG technique for handling entry parameters.
- Loops over each level (account, class, group) are separated and processed according to the desired report structure.
- The output logic is split into subroutines that fill in report fields and write them to the report output files.

## Business Logic

- **Balance Sheet Report (d_type = 0):**
  - Only accounts/classes below certain numeric ranges included.
- **Result Report (d_type = 1):**
  - Only accounts/classes above certain numeric thresholds included (profit/loss accounts).
- **Levels:**
  - `d_linj = 0`: Output per account.
  - Else: Output per group/class.

- **Report Lines:**
  - 'K' (kontolinje): Account line.
  - 'T' (tekstlinje): Text line.
  - 'S' (sumlinje): Sum line.
  - 'B' (gruppe sum): Group sum line.
- **Reporting output logic** in the `avslutt` section creates final summary lines for distinct report sections like operating expenses/results or reconciliation.

## Comments and Code Tags

- Norwegian comment lines and field names suggest original development in Norway, probably for local financial requirements.

## Key Points for New Developers

- **Understand file structures:** You will need to be familiar with the formats of all declared input and output files.
- **Know field meanings:** Field names are often abbreviations from Norwegian financial/accounting terms.
- **Report logic is driven by parameters:** The behavior of the program is dictated by the input parameter block—make sure you understand the meaning and source of each parameter.
- **Subroutine use is extensive:** Logic is compartmentalized—look for `begsr`/`endsr` pairs to understand flow.
- **Fixed-format RPG is sensitive:** Pay attention to the position of each character in source lines.

## Conclusion

This RPG program is a reporting builder that digests complex account structures and outputs summarized report registers at account, group, and class levels, flexibly controlled by input parameters, suitable for both balance and profit/loss reporting. The clear separation of logic into file reads, report level looping, and output writing makes it maintainable, but modern developers may find the fixed-format style archaic and should pay special attention to field overlays and numeric logic split by report type.