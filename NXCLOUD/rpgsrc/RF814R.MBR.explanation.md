# Explanation of ILE RPG Program - RF814R

This ILE RPG program is a classic, single-module report generation and export utility. It's designed to export "BM Kort" (most likely "bank card") transactions into XML format. The program reads several input files, processes transaction data related to customers and cards, and generates structured XML output along with logging.

Below is a detailed explanation, focusing on code structure, important variable definitions, subroutines, data flows, and the main logic.

---

## 1. **Program Metadata and History**

The header comments include:
- System and program name: `ASOFAK`, `RF814R`.
- Description: Exports BM Card transactions to XML files.
- A detailed changelog, with version numbers and developer initials, showing maintenance and reasons for changes.

---

## 2. **File Declarations**

- **Input Files:**
  - `rukrl5`, `rukrlu`: Card/customer registers.
  - `bokkl5`: Booked card transactions.
  - `bcdtir`, `bchei1`: Cash register/bong (receipt) files.
  - `sodtlr`, `sohelr`: Historical invoice headers and lines.
- **Output Files:**
  - `xmldnbpf`, `xmlgrlpf`, `xmllogpf`: For XML output and logging.

Each file may be renamed (`RENAME`) for ease of reference.

---

## 3. **Data Structures and Variables**

- **Parameter DS:** Overlayed fields for input parameters (card type, date ranges, flags, warehouse, warehouse text).
- **Dates DS:** To decompose and format date fields.
- **Log Record DS:** Assembles records for logging each transaction detail.
- **Working Variables:**  
  - For amounts, counts, dates, product IDs, and XML content construction.
  - Many are initialized (`inz(*off)` for flags).
  - Constants for XML tag/attribute names and formatting.

---

## 4. **XML Constants**

Literal values for standard XML tags, formatting, and encoding:
- XML declaration tags.
- String constants for XML field and section names.

---

## 5. **Program Flow**

### a. **Entry and Initialization**

- **`*INZSR` Subroutine**:  
  - Parses parameters.
  - Sets up keys for various files.
  - Prepares logging.
  - Calls external program `AP613R` for warehouse text conversion (special character handling).
  - Logging the start event.

### b. **Mainline Program**

Sequence:
1. **Write Initial XML Header** (`skriv_init`).
2. **Read Card/Customer Register and Generate Output** (`les_kort`).
   - For each customer, select related transactions.
   - For each transaction, branch by whether it's an invoice or bong (receipt), process accordingly, and write qualifying transactions out as XML.
   - Mark processed transactions, logging as appropriate.
3. **Write XML Footer** (`avsl_melding`).
4. **Exit**: Set LR and return.

---

## 6. **Key Processing Subroutines**

### a. **les_kort**
- Outer loop: For each card/customer entry.
- **Process steps:**
  - Set date range for extraction.
  - For each transaction:
    - Filter by dates and status.
    - If the transaction is an invoice, call `les_hfakt`.
    - If a receipt, call `les_bong`.
    - Mark or update transaction as "read" if processed.
- Handles transitions between customers/transactions.

### b. **les_hfakt**
- Finds the correct invoice line using key fields.
- Filters on year (used for statistical purposes).
- Cross-references the invoice header.
- Filters by warehouse if specified.
- If valid, writes customer section header (`skriv_vspec`) and logs this (via `skriv_result2`).
- Reads each invoice line:
  - For the first line, writes invoice line spec header (`skriv_vlspec`).
  - Writes each transaction line as XML (`skriv_vlin`) and logs.
  - At the end, writes summary line and closes invoice/customer sections.

### c. **les_bong**
- Similar to `les_hfakt` but operates on receipts.
- Checks if the receipt is for the given warehouse.
- Reads records, writes XML for each, and logs.
- Writes summary and closes invoice/customer sections.

---

## 7. **XML Generation Subroutines**

- **skriv_init**: Generates XML header.
- **skriv_vspec**: Starts a "product specification" section, including the customer number.
- **skriv_vlspec**: Starts a line-specification (for an order or receipt), calls an external program for seller information, and writes order/delivery details.
- **skriv_vlin**: Writes an XML element for a product line, with fields for product ID, description, quantity, unit, price, discount, and amount. Handles special character escaping (see `sjk_XML_esc`). Also accumulates totals for summary lines.
- **skriv_slin**: Writes a summary line (totals for net, VAT, total).
- **avsl_vlspec / avsl_kunde / avsl_melding**: Write closing tags for respective XML sections.

---

## 8. **Support Subroutines**

- **sjk_XML_esc**: Scans text fields and replaces XML-sensitive characters (`&`, `<`, `>`, `'`, `"`) with their respective XML entities. Ensures XML output is well-formed.
- **write_outp**: Actually writes a line to the XML output file, with transliteration for Nordic characters (commented out), and resets the output record buffer.
- **skriv_logg**: Assembles and writes a detailed log record for each transaction line, for auditing and troubleshooting.

---

## 9. **Business Rules and Features**

- Only exports transactions within requested date range.
- Includes or excludes previously processed transactions, depending on flags.
- Performs warehouse checks.
- Applies different VAT/rabatt logic for invoices and receipts.
- All calculations are formatted for XML output.
- Escapes text and handles foreign/special characters robustly.

---

## 10. **Logging and Error Handling**

- Logging for both the start and for each exported record.
- Many safeguards and comments where business logic has changed, e.g., for VAT on receipts, or handling of special characters.

---

## 11. **External Programs**

- `RS709R`: Fetches seller (salesperson) information for inclusion in XML output.
- `AP613R`: Converts warehouse text to XML-compliant encoding.

---

## 12. **Conclusion**

This program is a robust, production-grade export utility for transactional data, focusing on:
- Reliable extraction,
- Clean XML output with escaped content,
- Logging,
- Handling of complex business rules,
- Modularity and maintainability.

### **Typical Flow for a Transaction**
1. Read card/customer.
2. Select relevant transactions (invoices/receipts).
3. For each transaction:
   - Write header sections.
   - For each line, write XML element, format/escape as needed.
   - Write summary totals.
   - Log activity.
   - Mark as exported.
4. Close XML structures.

---

### **Onboarding Guidance**
- Focus on main data flow (`les_kort`, `les_hfakt`, `les_bong`).
- Carefully study how XML is generated and written (`skriv_*` subroutines).
- Pay attention to the use of overlays and data structures for mapping field positions.
- Familiarize with the business rules coded in the comments and in the conditional logic.
- The codebase is well-commented, and business changes are tracked in comments for troubleshooting.

---

**If you need more details on a particular section or want an in-depth explanation of a specific function or calculation, just ask!**