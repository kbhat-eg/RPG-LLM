     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOKON
      * Program . . . . : RP145R
      * Beskrivelse . . : Prosjekt, vedlikehold Budjsetterte varer
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       030919 sst  Nytt program
7.01  * 7.00  070120 sst  Enringer vedr mail fra MBE pr 03.01.2020
7.02  * 7.00  280320 bkv  Endret para for asptoxlsx
7.04  * 7.00  121020 sst  Ikke ta med Budjettlinjer på kontonivå
      *
8.01  *PRG2   160622 bsa  Utvidet prisgruppe fra 1 til 2 posisjoner
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Bruk av indikatorer:
      *
      *       LR = Avslutt program
      *       10 = Rollup
      *       11 = Rolldown
      *       12 = Sfldsp
      *       13 = Sfldspctl
      *       14 = Sflclr
      *       15 = Sflend
      *       21 = Home-key
      *       22 = Plassering av cursor
      *       30 = Protect av felter ved vise
      *    31-79 = Varsle m/feilmeldinger/skjermindikatorer
      *    80-99 = Arbeidsindikatorer
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     frpval1    if   e           k disk    rename(rpvapfr:rpval1r)
     frpval2    if   e           k disk    rename(rpvapfr:rpval2r)
     frpval3    if   e           k disk    rename(rpvapfr:rpval3r)
     frpvalr    if   e           k disk    rename(rpvapfr:rpvalrr)
     frpvalu    uf a e           k disk    rename(rpvapfr:rpvalur)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     filonl1    if   e           k disk    rename(ilonpfr:ilonl1r)
     fra07l1    if   e           k disk    rename(ra07pfr:ra07l1r)
     fra09l1    if   e           k disk    rename(ra09pfr:ra09l1r)
     fausrl1    if   e           k disk    rename(ausrpfr:ausrl1r)
     ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
     frpkol1    if   e           k disk    rename(rpkopfr:rpkol1r)
     frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
     frp2ul1    if   e           k disk    rename(rp2upfr:rp2ul1r)
     frp3al1    if   e           k disk    rename(rp3apfr:rp3al1r)
     fanumlu    uf a e           k disk    rename(anumpfr:anumlur)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
7.03 fvkhvl1    if   e           k disk    rename(vkhvpfr:vkhvl1r)
7.03 fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
7.03 fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
7.03 fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
7.03 ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
      *
     frp145d    cf   e             workstn sfile(b1sfl:w_srrn)
     f                                     infds(dspfbk)
      *
     d lo              c                   'abcdefghijklmnopqrstuvwxyzæøå'
     d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅ'
      *
      * Definering av Local data area
      *
     d                udS
     d l_user                911    920
     d l_fgr                 931    933
     d l_firm                944    946  0
     d l_fnav                951    980
      *
      * Definering av Information Data Structure - display feedback
      *
     d dspfbk          ds
     d  d_fcrn               378    379I 0
      *
      * Definering av variabler i nøkler
      *
     d rpval1_vpro     s                   like(rpvpro)
     d rpval1_vupr     s                   like(rpvupr)
     d rpval1_vakt     s                   like(rpvakt)
     d rpval1_vvar     s                   like(rpvvar)
     d rpval1_vlas     s                   like(rpvlas)
     d rpval2_vtxt     s                   like(rpvtxt)
     d rpval2_vlas     s                   like(rpvlas)
     d rpvalr_vare     s                   like(rpvvar)
     d rpvalr_lass     s                   like(rpvlas)
     d rpvalu_vare     s                   like(rpvvar)
     d rpvalu_lass     s                   like(rpvlas)
     d rpvalu3_firm    s                   like(rpvfir)
     d rpvalu3_pros    s                   like(rpvpro)
     d rpvalu3_upro    s                   like(rpvupr)
     d rpvalu3_akti    s                   like(rpvakt)
     d rpvalu3_vare    s                   like(rpvvar)
     d rpvalu3_lass    s                   like(rpvlas)
     d rkunl1_kund     s                   like(rkkund)
     d ilonl1_kli      s                   like(ilrkli)
     d ilonl1_lnr      s                   like(ilrlnr)
     d ra09l1_fir      s                   like(raifir)
     d ra09l1_kod      s                   like(raikod)
     d ra07l1_frm      s                   like(ragfir)
     d ra07l1_kod      s                   like(ragkod)
     d fusrl1_fir      s                   like(fbfirm)
     d fusrl1_usr      s                   like(fbuser)
     d ausrl1_usr      s                   like(abuser)
     d rpkol1_firm     s                   like(rpkfir)
     d rpkol1_type     s                   like(rpktyp)
     d rpkol1_kode     s                   like(rpkkod)
     d rp1pl1_pros     s                   like(rp1pro)
     d rp2ul1_pros     s                   like(rp2pro)
     d rp2ul1_upro     s                   like(rp2upr)
     d rp3al1_pros     s                   like(rp3pro)
     d rp3al1_upro     s                   like(rp3upr)
     d rp3al1_akti     s                   like(rp3akt)
     d anumlu_fell     s                   like(anfell)
     d anumlu_type     s                   like(antype)
     d anumlu_fast     s                   like(anfast)
     d vvarl1_vare     s                   like(vvvare)
7.03 d vkhvl1_kkod     s                   like(vakkod)
7.03 d vkhvl1_klty     s                   like(vaklty)
7.03 d vkhvl1_koty     s                   like(vakoty)
7.03 d vogrl1_ogr      s                   like(vgoogr)
7.03 d vhgrl1_ogr      s                   like(vghogr)
7.03 d vhgrl1_hgr      s                   like(vghhgr)
7.03 d vugrl1_ogr      s                   like(vguogr)
7.03 d vugrl1_hgr      s                   like(vguhgr)
7.03 d vugrl1_ugr      s                   like(vguugr)
      *
      * Definering av variable
      *
     d w_fcrn          s              4  0
     d w_stel          s              4  0
     d w_spge          s              4  0
     d w_srrn          s              4  0
     d w_sfrn          s                   like(w_srrn)
     d w_ssrn          s                   like(w_srrn)
      *
     d w_seqe          s              1
     d b_forn          s              1    inz(*off)
     d b_oppr          s              1    inz(*off)
     d b_anul          s              1    inz(*off)
     d b_feil          s              1    inz(*off)
     d b_subf          s              1    inz(*off)
     d b_open_sok      s              1    inz(*off)
      *
     d w_firm          s              3  0
     d s_vare          s                   like(rpvvar)
      *
     d w_pknr          s                   like(rkkund)
     d w_pkna          s                   like(rknavn)
     d w_dato          s             10
     d w_datd          s                   like(rpvlda)
     d w_1alf          s                   like(rpvtxt)
     d w_datx          s             10
     d w_datn          s              6  0
     d w_lnr           s                   like(ilrlnr)
     d w_lnr4          s              4  0
     d w_lnav          s                   like(ilrnav)
     d p_avd           s                   like(ilravd)
     d p_tx30          s             30
     d p_rapx          s              4
     d p_fdat          s              6  0
     d p_tdat          s              6  0
     d p_knav          s             30
     d p_selg          s              4  0
     d p_kunf          s              6  0
     d p_pros          s              6
     d p_upro          s              6
     d p_akti          s              6
     d p_kont          s              5  0
     d p_vare          s             15
     d p_text          s             30
     d p_kpro          s              6  0
     d w_fper          s              6  0
     d p_rapt          s             30
     d p_firm          s              3
8.01 d p_prgr          s              2
7.01 d p_enhe          s                        like(rpvenh)
7.01 d p_lety          s              1  0
7.01 d p_dato          s                        like(rpvlda)
7.01 d p_time          s                        like(rpvoti)
7.01 d p_inlr          s              1
7.01 d p_sapr          s                        like(rpvkpr)
7.01 d p_bupr          s                        like(rpvkpr)
7.01 d p_tipr          s                        like(rpvkpr)
7.01 d p_kopr          s                        like(rpvkpr)
     d w3avde          s              4
     d w3prol          s              5
     d w_sumi          s              8  0
     d w_sumix         s             11  0
     d w_sumk          s              8  0
     d w_sumkx         s             11  0
     d w_buo           s              8  0
     d w_but           s              8  0
     d w_rest          s              8  0
     d w_pros          s              8  0
     d w_mld1          s             50
     d w_stat          s              1
     d w_spor          s              1    inz('5')
     d w_endr          s              1    inz('2')
     d w_a51           s              1  0 inz(0)
     d w_tilgko        s             10
     d w_rutine        s             10
     d w_adv           s              3
     d w_status        s             10
     d w_upro          s                   like(rpvupr)
     d                                      inz(' ')
      * w_prlslg styr om Pr.leder hentes fra prosj.leder(P) eller selger(S)
     d w_prlslg        s              1    inz('S')
     d w_m1            s             50
     d w_m2            s             50
     d w_sv            s              1
     d w_pkod          s              4
     d w_ptxt          s             30
     d w_kost          s              9  0
      * sven
     d w_pluant        s             11  3
     d w_levant        s             11  3
     d w_fakant        s             11  3
     d w_besant        s             11  3
     d w_pluantx       s              9  0
     d w_levantx       s              9  0
     d w_fakantx       s              9  0
     d w_besantx       s              9  0
     d w_avvantx       s              9  0
7.02 d w_sql           s          10000
     d w_map           s             20     inz('Prosjekt/')
7.02 d w_tildok        s             50
     d w_typ           s              4     inz('xlsx')
     d w_ms1           s             50
     d w_ms2           s             50
     d w_svar          s              1
     d w_in12          s              1  0
7.01 d w_text          s             30
      *
      * Definering av konstanter
      *
     d c_sfil          s              2  0 inz(15)
      *
      * Forklaring på spesielle felter
      * som benyttes ved sub-files.
      * - - - - - - - - - - - - - - - - -
      * w_fcrn - Første recordnummer på siden
      * w_stel - Subfile-teller
      * w_spge - Sidestørrelse i subfile (page)
      * w_srrn - Relativt recordnummer i subfile
      * w_sfrn - Første recordnummer på siste side
      * w_ssrn - Siste recordnummer på siste side
      * w_curn - Current recordnummer på siden
      * w_virn - Side og cursorplassering som skal vises
      * w_afld - Aktivt feltnavn
      * w_arow - Aktiv rad for cursor
      * w_acol - Aktiv kolonne for cursor
      *
      * Benyttede skjermbilder.
      * - - - - - - - - - - - - - - - - -
      * B1SFL  - B1 Subfile - record
      * B2CTL  - B2 Subfile - control record
      * B2CMD  - B2 Eget skjermbilde for CMD-taster
      * C1BLD  - C1 Skjermbilde for innlegging av nøkkel ved oppretting
      * C1MSG  - C1 Meldingsbilde for C1BLD
      * C2BLD  - C2 Skjermbilde for opprette/endre/vise
      * D1WIN  - D1 Vindu for slette (Delete)
      * K1WIN  - K1 Vindu for kopiere
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * B2CTL Behandle åpningsbildet med subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Send Alt
      *
     c     b2taga        tag
      *
     c                   write     b2cmd
      *
      * Bare data
      *
     c     b2tagb        tag
      *
     c                   exsr      dsp_subfile
      *
      * Behandling av funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   goto      avslutt
     c                   when      *inke
     c                   exsr      forny
     c                   goto      b2tagb
     c                   when      *inkf
     c                   exsr      xc1bld
     c                   goto      b2taga
      *   Legg ut til excel
     c                   when      *inkh
     c                   exsr      vare_excel
     c                   goto      b2tagb
      *
     c                   when      *inkk
     c                   select
     c                   when      w_a51 = 0
     c*                  eval      b2head1 = 'La     Budsj Just. Levering Plukk-
     c*                             Utlev fakt. Best. Avvik    Kost.pris       -
     c*                              Kost'
     c*                  eval      b2head2 = 'ss     Ant.  Ant.    Dato   Ant-
     c*                            .   Ant.  Ant.  Ant.  Ant.       pr.Enh     -
     c*                              Totalt'
     c                   eval      w_a51 = 1
     c                   when      w_a51 = 1
     c                   eval      w_a51 = 2
     c                   when      w_a51 = 2
     c                   eval      w_a51 = 3
     c                   when      w_a51 = 3
     c                   eval      w_a51 = 0
     c                   endsl
     c                   exsr      forny
     c                   goto      b2taga
     c                   when      *in10
     c                   exsr      crt_subfile
     c                   goto      b2tagb
     c                   when      *in21
     c                   eval      *in22 = *on
     c                   goto      b2taga
     c                   endsl
      *
      * Utvalg
      *
     c*                  if        b2vavd  <> s_avd
     c*                  eval      s_avd    = b2vavd
     c*                  eval      s_prl    = b2vprl
     c*                  exsr      forny
     c*                  goto      b2tagb
     c*                  endif
      *
      *
      * Posisjonering
      *
     c                   if        b2vare <> *blank or
     c                             b2besk <> *blank
     c                   exsr      posisjoner
     c                   goto      b2tagb
     c                   endif
      *
      * Behandling av subfile
      *
     c                   exsr      subfile
      *
     c                   if        b_subf = *on
     c                   goto      b2taga
     c                   endif
      *
      * Retur til første bilde
      *
     c                   goto      b2tagb
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for fornying av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     forny         begsr
      *
     c                   select
     c                   when      w_seqe = 'B'
     c     rpval2_key    setll     rpval2
     c*                  when      w_seqe = 'C'
     c*    rpval3_key    setll     rpval3
     c                   other
     c     rpval1_key    setll     rpval1
     c                   endsl
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c     end_forny     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for posisjonering i subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     posisjoner    begsr
      *
      * Posisjoner startverdi på prosjekt
      *
     c                   if        b2vare <> *blank
     c                   eval      w_seqe = ' '
     c                   eval      rpval1_vvar = b2vare
     c     rpval1_key    setll     rpval1
     c                   endif
      *
      * Posisjoner startverdi på teskt
      *
     c                   if        b2besk <> *blank
     c                   eval      w_seqe = 'B'
     c                   eval      rpval2_vtxt = b2besk
     c                   eval      rpval2_vlas = *zero
     c     rpval2_key    setll     rpval2
     c                   endif
      *
      *
      * Blanker subfile, og fyller opp i.h.t. posisjonering
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
      * Blanker posisjoneringsfelter
      *
     c                   eval      b2vare = *blank
     c                   eval      b2besk = *blank
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     subfile       begsr
      *
     c                   eval      b_forn = *off
     c                   eval      b_subf = *off
      *
     c                   eval      w_virn = w_fcrn
      *
      * Leser og behandler subfile
      *
     c                   do        w_ssrn
     c                   readc     b1sfl                                  16
      *
     c                   if        *in16
     c                   leave
     c                   endif
      *
     c                   eval      b_subf = *on
     c                   eval      w_virn = w_srrn
      *
      * Endre post
      *                              sven
     c                   if        b1valg = '2'
     c                   eval      c1vare = b1vare
     c                   eval      c1lass = b1lass
     c                   exsr      xc2bld
     c                   eval      b1valg = *blank
     c                   eval      b_forn = *on
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      *  Endre post vedå oversyre antall direkte i subfilen.
      *
     c                   if        b1jbuant <> b1sjbuan
     c                   eval      rpvalu_vare = b1vare
     c                   eval      rpvalu_lass = b1lass
     c     rpvalu_key    chain     rpvalu
     c                   if        %found(rpvalu)
     c                   eval      rpvabj = b1jbuant
     c                   time                    rpveda
     c                   time                    rpveti
     c                   eval      rpveus = l_user
     c                   update    rpvalur
     c                   eval      b1sjbuan = b1jbuant
     c                   eval      b_forn = *on
     c                   iter
     c                   endif
     c                   endif
      *
      * Kopiere post
      *
     c                   if        b1valg = '3'
     c                   eval      k1vare = b1vare
     c*                  exsr      xk1win
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Slette post
      *
     c                   if        b1valg = '4'
     c                   eval      d1vare = b1vare
     c                   eval      d1lass = b1lass
     c                   eval      d1besk = b1besk
     c                   exsr      xd1win
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vise post
      *
     c                   if        b1valg = '5'
     c                   eval      c1vare = b1vare
     c                   eval      c1lass = b1lass
     c                   exsr      xc2bld
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
     c                   enddo
      *
     c                   if        b_forn = *on
     c                   exsr      forny
     c                   endif
      *
     c     end_subfile   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av skjermbilde for ny rad (C1BLD)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc1bld        begsr
      *
     c                   eval      c1pros = p_pros
     c                   eval      c1upro = p_upro
     c                   eval      c1akti = p_akti
     c                   eval      c1ptxt = rp1txt
     c                   eval      c1utxt = rp2txt
     c                   eval      c1atxt = rp3txt
      *
     c                   eval      b_oppr = *on
     c                   eval      b_forn = *off
      *
     c                   eval      c1vare  = *blank
     c                   eval      c1lass  = *zero
     c                   eval      c1vtxt  = *blank
     c                   eval      c2konto = *zero
     c                   eval      c2enh   = *blank
     c                   eval      c2ens   = *blank
     c                   eval      c2ldat  = *blank
     c                   eval      c2abu   = *zero
     c                   eval      c2abj   = *zero
     c                   eval      c2kpr   = *zero
      *
     c     c1taga        tag
      *
     c                   exfmt     c1bld
      *
      * Behandling av funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   goto      end_c1bld
7.01  *
7.01 c                   when      *inkd
7.01 c                   call      'VV500R'
7.01 c                   parm                    w_firm
7.01 c                   parm                    c1vare
7.01 c                   parm                    w_text
7.01 c                   goto      c1taga
7.01 c                   endsl
      *
     c                   if        c1vare = *blank
     c                   goto      end_c1bld
     c                   endif
      *
      * Validering
      *
     c                   eval      vvarl1_vare = c1vare
     c     vvarl1_key    chain     vvarl1
     c                   if        %found(vvarl1)
     c                   eval      c1vtxt = vvtek1
     c                   eval      *in27  = *off
     c                   eval      *in29  = *on
      *
      *   Finn Kostpris
      *
7.01 c                   eval      p_vare = c1vare
7.01 c                   eval      p_prgr = *blank
7.01 c                   eval      p_enhe = vvenhe
7.01 c                   eval      p_lety = *zero
7.01 c                   time                    p_dato
7.01 c                   time                    p_time
7.01 c                   call      'VP700R'
7.01 c                   parm                    w_firm
7.01 c                   parm                    p_vare
7.01 c                   parm                    p_prgr
7.01 c                   parm                    p_enhe
7.01 c                   parm                    p_lety
7.01 c                   parm                    p_dato
7.01 c                   parm                    p_time
7.01 c                   parm                    p_inlr
7.01 c                   parm                    p_sapr
7.01 c                   parm                    p_bupr
7.01 c                   parm                    p_tipr
7.01 c                   parm                    p_kopr
7.01 c                   eval      c2kpr  = p_kopr
      *
     c                   else
     c                   eval      *in27 = *on
      *
     c                   endif
      *
      * Sender opp informasjonsbilde dersom rad finnes fra før
      *
     c                   eval      rpvalr_vare = c1vare
     c                   eval      rpvalr_lass = c1lass
     c     rpvalr_key    chain     rpvalr
     c                   if        %found
     c                   exsr      xc1msg
     c                   if        b_anul = *on
     c                   goto      c1taga
     c                   endif
     c                   endif
      *
      * Kaller vedlikeholdsprogram
      *
     c                   eval      *in23 = *on
     c                   exsr      xc2bld
      *
     c     end_c1bld     tag
      *
     c                   if        b_forn = *on
     c                   exsr      forny
     c                   endif
      *
     c                   eval      b_oppr = *off
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for utlegging av opprettelsesmelding
      * Meldingsbildet legges ut dersom det forsøkes å opprette en rad som
      * finnes fra før.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc1msg        begsr
      *
     c                   eval      b_anul = *off
      *
     c                   exfmt     c1msg
      *
      * Behandling av funksjonstaster
      *
     c                   if        *inkc or *inkl
     c                   eval      b_anul = *on
     c                   goto      end_c1msg
     c                   endif
      *
     c     end_c1msg     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å behandle bilde for ny/endring/vise (C2BLD)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc2bld        begsr
      *
     c                   eval      w_arow = 0
     c                   eval      w_acol = 0
      *
     c                   eval      c1pros = p_pros
     c                   eval      c1upro = p_upro
     c                   eval      c1akti = p_akti
     c                   eval      c1ptxt = rp1txt
     c                   eval      c1utxt = rp2txt
     c                   eval      c1atxt = rp3txt
     c                   eval      c2ldat = *blank
      *
     c                   eval      rpvalr_vare = c1vare
     c                   eval      rpvalr_lass = c1lass
     c     rpvalr_key    chain     rpvalr
      *
     c                   if        %found
     c                   eval      c1vtxt = rpvtxt
     c                   eval      c2konto = rpvkto
     c                   eval      c2abu  = rpvabu
     c                   eval      c2abj  = rpvabj
     c                   eval      c2kpr  = rpvkpr
     c                   eval      c2enh  = rpvenh
     c                   eval      c2ens  = rpvens
     c                   eval      c2eusr = rpveus
     c     *dmy          move      rpveda        c2edat
     c                   eval      c2eusr = rpveus
     c                   else
     c                   if        vvvare = c1vare
     c                   eval      c1vtxt = vvtek1
     c                   endif
     c                   eval      c2konto = *zero
     c                   eval      c2abu  = *zero
     c                   eval      c2abj  = *zero
     c                   eval      c2kpr  = *zero
     c                   eval      c2ens  = *blank
     c                   eval      c2eusr = l_user
     c                   eval      c2edat = *zero
     c                   eval      c2eusr = *blank
     c                   if        %found(vvarl1)
     c                   eval      c2enh = vvenhe
     c                   endif
      *    Hent pris
7.01 c                   eval      p_vare = c1vare
7.01 c                   eval      p_prgr = *blank
7.01 c                   eval      p_enhe = c2enh
7.01 c                   eval      p_lety = *zero
7.01 c                   time                    p_dato
7.01 c                   time                    p_time
7.01 c                   call      'VP700R'
7.01 c                   parm                    w_firm
7.01 c                   parm                    p_vare
7.01 c                   parm                    p_prgr
7.01 c                   parm                    p_enhe
7.01 c                   parm                    p_lety
7.01 c                   parm                    p_dato
7.01 c                   parm                    p_time
7.01 c                   parm                    p_inlr
7.01 c                   parm                    p_sapr
7.01 c                   parm                    p_bupr
7.01 c                   parm                    p_tipr
7.01 c                   parm                    p_kopr
7.01  **                 eval      fdsapr = p_sapr
7.01 c                   eval      c2kpr  = p_kopr
     c                   endif
      *
     c                   if        c2konto = *zero
     c                   exsr      get_konto
     c                   endif
      *
     c                   if        b1valg = '3'
     c                   eval      c1vare = k1vare
     c**                 eval      c1lass = k1lass
     c                   endif
      *
     c                   if        b1valg = '5'
     c                   eval      *in30 = *on
     c                   endif
      *
     c     c2tagb        tag
      *
     c                   exfmt     c2bld
      *
     c                   setoff                                       232425
     c                   setoff                                       262728
     c                   setoff                                       41
      *
     c                   if        *inkc or *inkl or *in30
     c                   goto      end_c2bld
     c                   endif
      *
      * Spørring
      *
      *  Prosjektleder
     c*                  if        *inkd = *on and
     c*                            w_afld = 'C2PRL '
     c*                  eval      w_lnr       = *zero
     c*                  eval      w_lnav      = *blank
     c*                  if        w_PrlSlg = 'P'
     c*                  call      'RP603R  '
     c*                  PARM                    w_firm
     c*                  PARM                    w_lnr
     c*                  PARM                    w_lnav
     c*                  else
     c*                  eval      w_lnr4 = *zero
     c*                  call      'RA509R  '
     c*                  PARM                    w_firm
     c*                  PARM                    w_lnr4
     c*                  PARM                    w_lnav
     c*                  eval      w_lnr = w_lnr4
     c*                  endif
     c*                  if        w_lnr <> *zero
     c*                  eval      c2prl  = w_lnr
     c*                  eval      c2prx  = w_lnav
     c*                  endif
     c*                  goto      c2tagb
     c*                  endif
      *
      * Validering av input
      *
     c                   if        c1vtxt = *blank
     c                   eval      *in23 = *on
     c                   goto      c2tagb
     c                   endif
      *  Leveringsdato
     c*                  if        c2ldat = *blank
     c**                 eval      *in24  = *on
     c**                 goto      c2tagb
     c*                  endif
     c*                  eval      w_dato = c2ldat
     c*                  eval      w_datn = *zero
     c*                  exsr      reddato
      *
     c*                  if        w_datn > *zero
     c*    *dmy          test (d)                w_datn                 25
     c*                  if        *in25 = *on
     c*                  goto      c2tagb
     c*                  else
     c*    *dmy          move      w_datn        w_datd
     c*                  move      w_datd        c2ldat
     c*                  endif
     c*                  endif
      *  Lass nummer
     c*                  if        c1lass = *zero
     c*                  eval      *in35 = *on
     c*                  goto      c2tagb
     c*                  endif
      *
      * Oppdatering              ssdebug
      *
     c                   clear                   rpvalur
      *
     c                   eval      rpvalu_vare = c1vare
     c                   eval      rpvalu_lass = c1lass
     c     rpvalu_key    chain     rpvalur
      *
     c                   eval      rpvtxt = c1vtxt
   d c     lo:up         xlate     c1vtxt        rpvtxt
     c                   eval      rpvvar = c1vare
     c                   eval      rpvlas = c1lass
     c                   eval      rpvkto = c2konto
     c                   eval      rpvenh = c2enh
     c                   eval      rpvens = c2ens
     c                   eval      rpvabu = c2abu
     c                   eval      rpvabj = c2abj
     c                   if        c2abu = *zero
     c                   eval      rpvabu = c2abj
     c                   endif
     c                   eval      rpvkpr = c2kpr
      *
     c                   time                    rpveda
     c                   time                    rpveti
     c                   eval      rpveus = l_user
      *
     c                   if        %found
     c                   update    rpvalur
     c                   else
     c                   eval      rpvpro = p_pros
     c                   eval      rpvupr = p_upro
     c                   eval      rpvakt = p_akti
     c                   eval      rpvfir = w_firm
     c                   eval      rpvvar = c1vare
     c                   eval      p_vare = c1vare
     c                   time                    rpvoda
     c                   time                    rpvoti
     c                   eval      rpvous = l_user
     c                   write     rpvalur
     c                   endif
      *
      * Oppdater subfile
      *
     c                   if        b1valg = '2'
     c                   eval      b1besk = rpvtxt
     c                   endif
      *
     c                   if        b_oppr = *on or
     c                             b1valg = '3'
     c                   eval      b_forn = *on
     c                   endif
      *
     c     end_c2bld     tag
      *
     c                   eval      *in30  = *off
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å redigere inntastet dato
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     reddato       begsr
      *
     c                   if        %subst(w_dato:5:1) = '-' and
     c                             %subst(w_dato:8:1) = '-'
     c                   goto      redend
     c                   endif
      *
     c                   movel     udate         w_datx
     c                   if        %subst(w_dato:2:9) = *blank
     c                   eval      %subst(w_datx:01:1) = '0'
     c                   eval      %subst(w_datx:02:1) = %subst(w_dato:1:1)
     c                   elseif    %subst(w_dato:3:8) = *blank
     c                   eval      %subst(w_datx:01:2) = %subst(w_dato:1:2)
     c                   elseif    %subst(w_dato:5:6) = *blank
     c                   eval      %subst(w_datx:01:2) = %subst(w_dato:1:2)
     c                   eval      %subst(w_datx:03:2) = %subst(w_dato:3:2)
     c                   elseif    %subst(w_dato:7:4) = *blank
     c                   eval      %subst(w_datx:01:2) = %subst(w_dato:1:2)
     c                   eval      %subst(w_datx:03:2) = %subst(w_dato:3:2)
     c                   eval      %subst(w_datx:05:2) = %subst(w_dato:5:2)
     c                   endif
     c                   movel     w_datx        w_datn
     c     redend        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av slette-bildet (D1WIN)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xd1win        begsr
      *
     c                   eval      rpvalr_vare = d1vare
     c                   eval      rpvalr_lass = d1lass
     c     rpvalr_key    chain     rpvalr
      *
      * sjekker om det finnes poster, da kan man ikke slette
      *
      *
     c                   exfmt     d1win
      *
     c                   if        *inkc or *inkl
     c                   goto      end_d1win
     c                   endif
      *
     c                   eval      b_forn = *on
      *
      * Sletter rad
      *
     c                   eval      rpvalu_vare = d1vare
     c                   eval      rpvalu_lass = d1lass
     c     rpvalu_key    chain     rpvalur
     c                   if        %found(rpvalu)
     c                   delete    rpvalur
     c                   endif
      *
     c     end_d1win     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å behandle kopierings-bildet (K1WIN)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xk1win        begsr
      *
      * Tar vare på nøkkel til rad det skal kopieres fra
      *
     c                   eval      s_vare = k1vare
      *
      * Fyller kopierings-bildet
      *
     c                   eval      rpvalr_vare = k1vare
     c**                 eval      rpvalr_lass = k1lass
     c     rpvalr_key    chain     rpvalr
      *
     c     k1tagb        tag
      *
     c                   exfmt     k1win
      *
     c                   if        *inkc or *inkl
     c                   goto      end_k1win
     c                   endif
      *
      * Sjekk om utfylt
      *
     c                   if        k1vare = *blank
     c                   eval      *in31 = *on
     c                   goto      k1tagb
     c                   endif
      *
      * Sjekker om rad finnes fra før
      *
     c                   eval      rpvalr_vare = k1vare
     c     rpvalr_key    chain     rpvalr
     c                   if        %found
     c                   eval      *in33 = *on
     c                   goto      k1tagb
     c                   endif
      *
      * Kaller vedlikeholdsprogram
      *
     c                   eval      c1vare = s_vare
     c                   exsr      xc2bld
      *
     c     end_k1win     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for tømming av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     clr_subfile   begsr
      *
     c                   eval      *in14 = *on
     c                   write     b2ctl
     c                   eval      *in14 = *off
      *
     c                   eval      *in15 = *off
     c                   eval      w_srrn = 0
     c                   eval      w_sfrn = 0
     c                   eval      w_ssrn = 0
     c                   eval      w_spge = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å fylle opp subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     crt_subfile   begsr
      *    debug
     c                   eval      w_spge = w_spge + c_sfil
     c                   eval      w_srrn = w_ssrn
      *
      *
     c                   dou       w_srrn = w_spge
      *
     c                   select
     c                   when      w_seqe = 'B'
     c                   read      rpval2                                 15
     c                   when      w_seqe = 'C'
     c                   read      rpval3                                 15
     c                   other
     c                   read      rpval1                                 15
     c                   endsl
      *
     c                   if        *in15
     c                             or rpvfir <> w_firm
     c                             or rpvpro <> p_pros
     c                   leave
     c                   endif
7.04  * Luke ut ev. konto-budsjett
7.04 c                   if        rpvsts = 'B'
7.04 c                   iter
7.04 c                   endif
      * Underprosjekt
     c                   if        p_upro <>  *blank
     c                             and rpvupr <> p_upro
     c                   iter
     c                   endif
      * Aktivitet
     c                   if        p_akti <>  *blank
     c                             and rpvakt <> p_akti
     c                   iter
     c                   endif
      * Konto
     c                   if        p_kont <>  *zero
     c                             and rpvkto <> p_kont
     c                   iter
     c                   endif
      *
     c                   eval      w_srrn = w_srrn + 1
      * debugss
     c                   if        rpvvar = '00000999'
     c                   eval      rpvvar = rpvvar
     c                   endif
     c                   eval      b1valg = *blank
     c                   eval      b1vare = rpvvar
     c                   eval      b1besk = rpvtxt
     c                   eval      b1lass = rpvlas
     c                   eval      b1lassx = %char(rpvlas)
     c                   eval      b1enhet = rpvenh
     c                   eval      b1enhet = rpvenh
     c**                 eval      b1budant = %char(rpvabu)
     c                   eval      b1budant = rpvabu
     c                   eval      b1jbuant = rpvabj
     c                   eval      b1sjbuan = rpvabj
     c                   if        rpvlda <> *loval
     c     *dmy          move      rpvlda        w_datn
     c                   eval      b1ldax = %editw(w_datn : '  .  .  ')
     c                   else
     c                   eval      b1ldax = *blank
     c                   endif
     c                   if        rpvkpr <> 0
     c                   eval      b1kstprs = rpvkpr
     c                   else
     c                   eval      b1kstprs = *zero
     c                   endif
     c                   if        b1sjbuan * rpvkpr <> 0
     c                   eval      b1ksttot = rpvkpr * b1sjbuan
     c                   else
     c                   eval      b1ksttot = *zero
     c                   endif
      *
     c                   select
     c                   when      w_a51  = 0
      * dato informasjon
     c*                  if        b1ldat <> *loval
     c*    *dmy          move      b1ldat        w_datn
     c*                  endif
     c*                  eval      b1ldax = %editw(w_datn : '  .  .  ')
      *
     c                   endsl
      *
     c                   eval      b1pluant = *blank
     c                   eval      b1levant = *blank
     c                   eval      b1fakant = *blank
     c                   eval      b1besant = *blank
      *
      * Initierer SQL for søk
     c/exec sql
     c+ select
     c+  sum1, sum2, sum3, sum4 into :w_pluant, :w_levant, :w_fakant, :w_besant
     c+              from (
     c+ SELECT
     c+    (
     c+        SELECT
     c+            coalesce(sum(FDANTA), 0)
     c+        FROM fodtpf
     c+        INNER JOIN fohepf ON
     c+            fofirm = FDFIRM AND
     c+            fonumm = FDNUMM AND
     c+            fosuff = FDSUFF
     c+        WHERE
     c+            footyp = 'OP' AND
     c+            FDFIRM = :RPVFIR AND
     c+            FDVARE = :RPVVAR AND
     c+            FDPROJ = :RPVPRO
     c+    ) as sum1,
     c+    (
     c+        SELECT
     c+            coalesce(sum(FDANTA), 0)
     c+        FROM fodtpf
     c+        INNER JOIN fohepf ON
     c+            fofirm = FDFIRM AND
     c+            fonumm = FDNUMM AND
     c+            fosuff = FDSUFF
     c+        WHERE
     c+            footyp = 'PP' AND
     c+            FDFIRM = :RPVFIR AND
     c+            FDVARE = :RPVVAR AND
     c+            FDPROJ = :RPVPRO
     c+    ) as sum2,
     c+    (
     c+        SELECT
     c+            coalesce(sum(SDANTA), 0)
     c+        FROM sodtpf
     c+        INNER JOIN sohepf ON
     c+            sofirm = sDFIRM AND
     c+            soaarr = sDaarr AND
     c+            sobinr = sDbinr AND
     c+            sonumm = sDNUMM AND
     c+            sosuff = sDSUFF
     c+        WHERE
     c+            SDFIRM = :RPVFIR AND
     c+            SDVARE = :RPVVAR AND
     c+            SDPROJ = :RPVPRO and
     c+            SOUPRO = :RPVUPR and
     c+            SDakti = :RPVakt
     c+    ) as sum3,
     c+    (
     c+        SELECT coalesce(sum(slANTA), 0)
     c+        FROM sidtpf
     c+        WHERE
     c+            SLFIRM = :RPVFIR AND
     c+            SLVARE = :RPVVAR AND
     c+            SLPROJ = :RPVPRO
     c+    ) as sum4
     c+ fROM rpvapf
     c+ WHERE
     c+    RPVPRO = :p_pros AND
     c+    rpvvar = :b1vare
     c+ ) res
     c+
     c/end-exec
     c                   goto      xxx
      *
      *        NB!!!!  Her skal man teste behanlingskode på ordretype og ikke selve Ordretypen
      *
      *                  B1PLUANT     fra FODTPF
     c/exec sql
     c+                  select sum(fdanta)  into :b1pluant
     c+                  from    fodtpf
     c+                  inner join fohepf on fonumm = fdnumm
     c+                                    and fofirm = fdfirm
     c+                                    and fosuff = fdsuff
     c+                                 where fdproj = :p_pros
     c+                                  and  fdvare = :b1vare
     c+                                  and  footyp = 'OP'
     c/end-exec
      *
      *                  B1LEVANT     fra FODTPF
     c/exec sql
     c+                  select sum(fdanta)  into :b1levant
     c+                  from    fodtpf
     c+                  inner join fohepf on fonumm = fdnumm
     c+                                    and fofirm = fdfirm
     c+                                    and fosuff = fdsuff
     c+                                 where fdproj = :p_pros
     c+                                  and  fdvare = :b1vare
     c+                                  and  footyp = 'PP'
     c/end-exec
      *
      *                  B1FAKANT    fra   SODTPF
     c/exec sql
     c+                  select sum(sdanta)  into :b1fakant
     c+                  from    sodtpf
     c+                  inner join sohepf on sonumm = sdnumm
     c+                                    and sofirm = sdfirm
     c+                                    and sosuff = sdsuff
     c+                                 where sdproj = :p_pros
     c+                                  and  sdvare = :b1vare
     c+                                  and  sootyp = 'FP'
     c/end-exec
      *
      *                  B1BESANT    fra   SIDTPF
     c/exec sql
     c+                  select sum(slanta)  into :b1BESant
     c+                  from    sidtpf
     c+                                 where slproj = :p_pros
     c+                                  and  slvare = :b1vare
     c/end-exec
      *
     c     xxx           tag
     c                   eval(h)   w_pluantx = w_pluant
     c                   eval(h)   w_levantx = w_levant
     c                   eval(h)   w_fakantx = w_fakant
     c                   eval(h)   w_besantx = w_besant
     c                   eval(h)   w_avvantx = rpvabj - w_fakant
     c                   eval      b1pluant = %char(w_pluantx)
     c                   eval      b1levant = %char(w_levantx)
     c                   eval      b1fakant = %char(w_fakantx)
     c                   eval      b1besant = %char(w_besantx)
     c                   eval      b1avvant = %char(w_avvantx)
     c                   if        b1pluant = '0     '
     c                   eval      b1pluant = *blank
     c                   else
     c                   dow       %subst(b1pluant:5:1) = ' '
     c                   eval      %subst(b1pluant:2:4) = %subst(b1pluant:1:4)
     c                   eval      %subst(b1pluant:1:1) = ' '
     c                   enddo
     c                   endif
     c                   if        b1levant = '0     '
     c                   eval      b1levant = *blank
     c                   else
     c                   dow       %subst(b1levant:5:1) = ' '
     c                   eval      %subst(b1levant:2:4) = %subst(b1levant:1:4)
     c                   eval      %subst(b1levant:1:1) = ' '
     c                   enddo
     c                   endif
     c                   if        b1fakant = '0     '
     c                   eval      b1fakant = *blank
     c                   else
     c                   dow       %subst(b1fakant:5:1) = ' '
     c                   eval      %subst(b1fakant:2:4) = %subst(b1fakant:1:4)
     c                   eval      %subst(b1fakant:1:1) = ' '
     c                   enddo
     c                   endif
     c                   if        b1besant = '0     '
     c                   eval      b1besant = *blank
     c                   else
     c                   dow       %subst(b1besant:5:1) = ' '
     c                   eval      %subst(b1besant:2:4) = %subst(b1besant:1:4)
     c                   eval      %subst(b1besant:1:1) = ' '
     c                   enddo
     c                   endif
     c                   if        b1avvant = '0     '
     c                   eval      b1avvant = *blank
     c                   else
     c                   dow       %subst(b1avvant:5:1) = ' '
     c                   eval      %subst(b1avvant:2:4) = %subst(b1avvant:1:4)
     c                   eval      %subst(b1avvant:1:1) = ' '
     c                   enddo
     c                   endif
     c                   if        b1pluant = ',000'
     c                   eval      b1pluant = *blank
     c                   endif
     c                   if        b1levant = ',000'
     c                   eval      b1levant = *blank
     c                   endif
     c                   if        b1fakant = ',000'
     c                   eval      b1fakant = *blank
     c                   endif
     c                   if        b1besant = ',000'
     c                   eval      b1besant = *blank
     c                   endif
     c                   if        b1avvant = ',000'
     c                   eval      b1avvant = *blank
     c                   endif
      *
     c                   write     b1sfl
      *
     c                   enddo
      *
     c                   if        w_srrn > w_ssrn
     c                   eval      w_sfrn = w_ssrn + 1
     c                   endif
      *
     c                   eval      w_ssrn = w_srrn
     c                   eval      w_virn = w_sfrn
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for display av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dsp_subfile   begsr
      *
     c                   if        w_srrn <> 0
     c                   eval      *in12 = *on
     c                   else
     c                   write     b2cmd
     c                   endif
      *
     c                   eval      *in13 = *on
     c                   exfmt     b2ctl
      *
     c                   eval      *in12 = *off
     c                   eval      *in13 = *off
     c                   eval      *in22 = *off
      *
     c                   eval      w_fcrn = d_fcrn
      *
     c                   endsr
7.03  *
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  * Subrutine for å hente kontohnev/konto
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  *
7.03 c     get_konto     begsr
7.03  *  ktohnv fra vare
7.03 c                   eval      vvarl1_vare = c1vare
7.03 c                   eval      vkhvl1_kkod = *blank
7.03 c     vvarl1_key    chain     vvarl1
7.03 c                   if        %found(vvarl1)
7.03 c                   eval      vkhvl1_kkod = vvkhev
7.03  *  ktohnv fra Undergruppe
7.03 c                   if        vkhvl1_kkod = *blank
7.03 c                   eval      vugrl1_ogr  = vvogrp
7.03 c                   eval      vugrl1_hgr  = vvhgrp
7.03 c                   eval      vugrl1_ugr  = vvugrp
7.03 c     vugrl1_key    chain     vugrl1
7.03 c                   if        %found(vugrl1)
7.03 c                   eval      vkhvl1_kkod = vgukhv
7.03 c                   endif
7.03 c                   endif
7.03  *  ktohnv fra hovedgruppe
7.03 c                   if        vkhvl1_kkod = *blank
7.03 c                   eval      vhgrl1_ogr  = vvogrp
7.03 c                   eval      vhgrl1_hgr  = vvhgrp
7.03 c     vhgrl1_key    chain     vhgrl1
7.03 c                   if        %found(vhgrl1)
7.03 c                   eval      vkhvl1_kkod = vghkhv
7.03 c                   endif
7.03 c                   endif
7.03  *  ktohnv fra overgruppe
7.03 c                   if        vkhvl1_kkod = *blank
7.03 c                   eval      vogrl1_ogr  = vvogrp
7.03 c     vogrl1_key    chain     vogrl1
7.03 c                   if        %found(vogrl1)
7.03 c                   eval      vkhvl1_kkod = vgokhv
7.03 c                   endif
7.03 c                   endif
7.03  *  Vare ikke funnet
7.03 c                   endif
7.03  *  ktohnv fra Statusregister
7.03 c                   if        vkhvl1_kkod = *blank
7.03 c     fstsl1_key    chain     fstsl1
7.03 c                   if        %found(fstsl1)
7.03 c                   eval      vkhvl1_kkod = faakhv
7.03 c                   endif
7.03 c                   endif
7.03  *
7.03 c                   eval      vkhvl1_klty = *zero
7.03 c                   eval      vkhvl1_koty = 'FP'
7.03 c     vkhvl1_key    chain     vkhvl1
7.03 c                   if        %found(vkhvl1)
7.03 c                   eval      c2konto = vakko7
7.03 c                   endif
7.03  *
7.03 c                   endsr
7.03  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for overføring av varelinjer til excel
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     vare_excel    begsr
      *
      *  Først må RPVAPF oppdateres fra FODT, SODT og SIDT med dagens status
      *
     c                   exsr      Upd_Rpva
      *
     c                   eval      w_sql = 'select rpvpro  as "Prosjekt" +
     c                                       ,rpvupr as "Underprosjekt" +
     c                                       ,rpvakt as "Aktivitet" +
     c                                       ,rpvkto as "Konto" +
     c                                       ,rpvvar as "Varenr" +
     c                                       ,rpvlas as "Lassnummer" +
     c                                       ,rpvtxt as "Beskrivelse" +
     c                                       ,rpvenh as "Enhet" +
     c                                       ,rpvlda as "Leveringsdato" +
     c                                       ,rpvabu as "Budsjett" +
     c                                       ,rpvabj as "Just.Budsj" +
     c                                       ,rpvkpr as "Kostpris" +
     c                                       ,rpvkpb as "Kostbeløp" +
     c                                       ,rpvaop as "Antall OP" +
     c                                       ,rpvapp as "Antall PP" +
     c                                       ,rpvafp as "Antall FP" +
     c                                       ,rpvabv as "Antall BV" +
     c                                       from rpvapf where rpvpro = ''' +
     c                                                         %trim(p_pros)
     c                   if        p_upro <> *blank
     c                   eval      w_sql = %trim(w_sql) +
     c                                                 ''' and  rpvupr = ''' +
     c                                                         %trim(p_upro)
     c                   endif
     c                   if        p_akti <> *blank
     c                   eval      w_sql = %trim(w_sql) +
     c                                                 ''' and  rpvakt = ''' +
     c                                                         %trim(p_akti)
     c                   endif
     c                   eval      w_sql = %trim(w_sql) +
     c                                                 ''''
     c                   eval      %subst(w_map:10:10) = l_user
     c                   eval      w_tildok = p_pros
     c                   if        p_upro <> *blank
     c                   eval      w_tildok = %trim(w_tildok) + '_' + p_upro
     c                   endif
     c                   if        p_akti <> *blank
     c                   if        p_upro = *blank
     c                   eval      w_tildok = %trim(w_tildok) + '_0'
     c                   endif
     c                   eval      w_tildok = %trim(w_tildok) + '_' + p_akti
     c                   endif
     c                   eval      w_tildok = %trim(w_tildok) + '_vare'
      *
     c                   call      'ASPTOXLSX'
     c                   parm                    w_sql
     c                   parm                    w_map
     c                   parm                    w_tildok
     c                   parm                    w_typ
      *
     c                   eval      w_ms1 = 'Varelinjer er lagt ut til +
     c                                      excel i IFS-området som:'
     c                   eval      w_ms2 = '\asp\' + l_fgr +
     c                                     '\' + %trim(w_map) +
     c                                     '\' + %trim(w_tildok)
     c                   eval      w_svar = 'J'
      *
     c                   call      'AA007R'
     c                   parm                    w_ms1
     c                   parm                    w_ms2
     c                   parm                    w_svar
     c                   parm                    w_in12
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for overføring av nåværende status til RPVAPF
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     Upd_rpva      begsr
      *    Slett tidligere akkumulerte felter
     c     rpvalu_key2   setll     rpvalu
     c     rpvalu_key2   reade     rpvalu
     c                   dou       %eof(rpvalu)
     c                   eval      rpvaop = *zero
     c                   eval      rpvapp = *zero
     c                   eval      rpvafp = *zero
     c                   eval      rpvabv = *zero
     c                   update    rpvalur
     c     rpvalu_key2   reade     rpvalu
     c                   enddo
      *    Oppdater alle linjer fra div register
     c     rpvalr_key2   setll     rpvalr
     c     rpvalr_key2   reade     rpvalr
     c                   dou       %eof(rpvalr)
      *
      * Initierer SQL for søk
     c/exec sql
     c+ select
     c+  sum1, sum2, sum3, sum4 into :w_pluant, :w_levant, :w_fakant, :w_besant
     c+              from (
     c+ SELECT
     c+    (
     c+        SELECT
     c+            coalesce(sum(FDANTA), 0)
     c+        FROM fodtpf
     c+        INNER JOIN fohepf ON
     c+            fofirm = FDFIRM AND
     c+            fonumm = FDNUMM AND
     c+            fosuff = FDSUFF
     c+        WHERE
     c+            footyp = 'OP' AND
     c+            FDFIRM = :RPVFIR AND
     c+            FDVARE = :RPVVAR AND
     c+            FDPROJ = :RPVPRO and
     c+            Foupro = :RPVupr and
     c+            Foakti = :RPVakt
     c+    ) as sum1,
     c+    (
     c+        SELECT
     c+            coalesce(sum(FDANTA), 0)
     c+        FROM fodtpf
     c+        INNER JOIN fohepf ON
     c+            fofirm = FDFIRM AND
     c+            fonumm = FDNUMM AND
     c+            fosuff = FDSUFF
     c+        WHERE
     c+            footyp = 'PP' AND
     c+            FDFIRM = :RPVFIR AND
     c+            FDVARE = :RPVVAR AND
     c+            FDPROJ = :RPVPRO and
     c+            FOupro = :RPVupr and
     c+            FOakti = :RPVakt
     c+    ) as sum2,
     c+    (
     c+        SELECT
     c+            coalesce(sum(SDANTA), 0)
     c+        FROM sodtpf
     c+        INNER JOIN sohepf ON
     c+            sofirm = sDFIRM AND
     c+            soaarr = sDaarr AND
     c+            sobinr = sDbinr AND
     c+            sonumm = sDNUMM AND
     c+            sosuff = sDSUFF
     c+        WHERE
     c+            SDFIRM = :RPVFIR AND
     c+            SDVARE = :RPVVAR AND
     c+            SDPROJ = :RPVPRO and
     c+            SOUPRO = :RPVUPR and
     c+            SOakti = :RPVakt
     c+    ) as sum3,
     c+    (
     c+        SELECT coalesce(sum(slANTA), 0)
     c+        FROM sidtpf
     c+        WHERE
     c+            SLFIRM = :RPVFIR AND
     c+            SLVARE = :RPVVAR AND
     c+            SLPROJ = :RPVPRO and
     c+            Slakti = :RPVakt
     c+    ) as sum4
     c+ fROM rpvapf
     c+ WHERE
     c+    RPVPRO = :p_pros AND
     c+    rpvvar = :b1vare
     c+ ) res
     c+
     c/end-exec
      *
     c                   eval(h)   w_pluantx = w_pluant
     c                   eval(h)   w_levantx = w_levant
     c                   eval(h)   w_fakantx = w_fakant
     c                   eval(h)   w_besantx = w_besant
      *
     c                   eval      rpvalu3_firm = rpvfir
     c                   eval      rpvalu3_pros = rpvpro
     c                   eval      rpvalu3_upro = rpvupr
     c                   eval      rpvalu3_akti = rpvakt
     c                   eval      rpvalu3_vare = rpvvar
     c                   eval      rpvalu3_lass = rpvlas
     c     rpvalu3_key   chain     rpvalu
     c                   if        not %found(rpvalu)
     c                   eval      rpvalu3_lass = *zero
     c     rpvalu3_key   chain     rpvalu
     c                   endif
     c                   if        %found(rpvalu)
     c                   eval      rpvaop = rpvaop +  w_pluantx
     c                   eval      rpvapp = rpvapp +  w_levantx
     c                   eval      rpvafp = rpvafp +  w_fakantx
     c                   eval      rpvabv = rpvabv +  w_besantx
     c                   update    rpvalur
     c                   endif
      *
     c     rpvalr_key2   reade     rpvalr
      *
     c                   enddo
      *
7.03 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_pros
     c                   parm                    p_upro
     c                   parm                    p_akti
     c                   parm                    p_kont
     c                   parm                    p_text
      *
      * Key for posisjonering på prosjekt
      *
     c     rpval1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    p_pros
     c                   kfld                    p_upro
     c                   kfld                    p_akti
     c                   kfld                    rpval1_vvar
     c                   kfld                    rpval1_vlas
      *
      * Key for posisjonering på tekst
      *
     c     rpval2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    p_pros
     c                   kfld                    p_upro
     c                   kfld                    p_akti
     c                   kfld                    rpval2_vtxt
     c                   kfld                    rpval2_vlas
      *
      * Key for posisjonering på avdeling
      *
     c     rpval3_key    klist
     c                   kfld                    w_firm
     c                   kfld                    p_pros
     c                   kfld                    p_upro
     c                   kfld                    p_akti
     c*                  kfld                    rpval3_vvar
      *
      * Key for les på prosjekt
      *
     c     rpvalr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    p_pros
     c                   kfld                    p_upro
     c                   kfld                    p_akti
     c                   kfld                    rpvalr_vare
     c                   kfld                    rpvalr_lass
      *
     c     rpvalr_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    p_pros
      *
      * Key for oppdatering av prosjket
      *
     c     rpvalu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    p_pros
     c                   kfld                    p_upro
     c                   kfld                    p_akti
     c                   kfld                    rpvalu_vare
     c                   kfld                    rpvalu_lass
      *
     c     rpvalu_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    p_pros
      *
     c     rpvalu3_key   klist
     c                   kfld                    rpvalu3_firm
     c                   kfld                    rpvalu3_pros
     c                   kfld                    rpvalu3_upro
     c                   kfld                    rpvalu3_akti
     c                   kfld                    rpvalu3_vare
     c                   kfld                    rpvalu3_lass
      *
      * Key for oppslag på kunde
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Key for oppslag på Prosjektleder
      *
     c     ilonl1_key    klist
     c                   kfld                    ilonl1_kli
     c                   kfld                    ilonl1_lnr
      *
      * Key for oppslag på Selger
      *
     c     ra09l1_key    klist
     c                   kfld                    ra09l1_fir
     c                   kfld                    ra09l1_kod
      *
      * Key for oppslag på avdeling
      *
     c     ra07l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra07l1_kod
      *
      * Key for les på bruker(FUSR)
      *
     c     fusrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fusrl1_usr
      *
      * Key for les på bruker(AUSR)
      *
     c     ausrl1_key    klist
     c                   kfld                    ausrl1_usr
      *
      * Key for les på Koder
      *
     c     rpkol1_key    klist
     c                   kfld                    rpkol1_firm
     c                   kfld                    rpkol1_type
     c                   kfld                    rpkol1_kode
      *
      * Key for les av nummerteller
      *
     c     anumlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    anumlu_fell
     c                   kfld                    anumlu_type
     c                   kfld                    anumlu_fast
      *
      * Key for les av prosjekt
      *
     c     rp1pl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rp1pl1_pros
      *
      * Key for les av underprosjekt
      *
     c     rp2ul1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rp2ul1_pros
     c                   kfld                    rp2ul1_upro
      *
      * Key for les av prosjekt
      *
     c     rp3al1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rp3al1_pros
     c                   kfld                    rp3al1_upro
     c                   kfld                    rp3al1_akti
      *
      * Key for les av varer
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
7.03  *
7.03  * Key for les Hovedgruppe
7.03  *
7.03 c     vogrl1_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    vogrl1_ogr
7.03  *
7.03  * Key for les Overgruppee
7.03  *
7.03 c     vhgrl1_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    vhgrl1_ogr
7.03 c                   kfld                    vhgrl1_hgr
7.03  *
7.03  * Key for les Undergruppe
7.03  *
7.03 c     vugrl1_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    vugrl1_ogr
7.03 c                   kfld                    vugrl1_hgr
7.03 c                   kfld                    vugrl1_ugr
7.03  *
7.03  * Key for les statusregister
7.03  *
7.03 c     fstsl1_key    klist
7.03 c                   kfld                    w_firm
7.03  *
7.03  * Key for les kontohenvisning
7.03  *
7.03 c     vkhvl1_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    vkhvl1_kkod
7.03 c                   kfld                    vkhvl1_klty
7.03 c                   kfld                    vkhvl1_koty
      *
     c                   eval      w_firm = l_firm
      *
      * Initierer skjermbildet
      *
     c                   eval      *in22 = *on
      *
      * Hent opp brukerens selgernummer
      *
     c                   eval      fusrl1_usr = l_user
     c     fusrl1_key    chain     fusrl1
     c                   if        %found(fusrl1)
     c**                 eval      b2vprl = fbselg
     c                   else
     c**                 eval      b2vprl = *zero
     c                   endif
      *
      * Posisjonerer databasen, og fyller opp subfile
      *
     c                   eval      w_seqe      = *blank
     c*                  eval      rpval1_pros = *blank
     c     rpval1_key    setll     rpval1
      *
     c*                  eval      b2head1 = 'La     Budsj Just. Levering Plukk-
     c*                             Utlev fakt. Best. Avvik    Kost.pris       -
     c*                              Kost'
     c*                  eval      b2head2 = 'ss     Ant.  Ant.    Dato   Ant-
     c*                            .   Ant.  Ant.  Ant.  Ant.       pr.Enh     -
     c*                              Totalt'
      *
      *   Overøfre varer fra FODT til RPVA som ikke er definert der
     c                   eval      p_pros = p_pros
     c                   call      'RP146C'
     c                   parm                    p_pros
      *
     c                   eval      b2prosj = p_pros
     c                   eval      rp1pl1_pros = p_pros
     c     rp1pl1_key    chain     rp1pl1
     c                   if        %found(rp1pl1)
     c                   eval      b2ptext = rp1txt
     c                   endif
     c                   if        p_upro <> *blank
     c                   eval      b2prosj = %trim(b2prosj) + '\' + p_upro
     c                   eval      rp2ul1_pros = p_pros
     c                   eval      rp2ul1_upro = p_upro
     c     rp2ul1_key    chain     rp2ul1
     c                   if        %found(rp2ul1)
     c                   eval      b2ptext = %trim(b2ptext) + '\' + rp2txt
     c                   endif
     c                   endif
     c                   if        p_akti <> *blank
     c                   eval      b2prosj = %trim(b2prosj) + '\' + p_akti
     c                   eval      rp3al1_pros = p_pros
     c                   eval      rp3al1_upro = p_upro
     c                   eval      rp3al1_akti = p_akti
     c     rp3al1_key    chain     rp3al1
     c                   if        %found(rp3al1)
     c                   eval      b2ptext = %trim(b2ptext) + '\' + rp3txt
     c                   endif
     c                   endif
     c                   exsr      crt_subfile
      *
     c                   endsr
