# RPG Program SI502R: Inquiry on Purchase, Purchase of Goods

This ILE RPG source code is for program **SI502R** in the **ASSTAT** system. Its main purpose is to provide a subfile-based inquiry screen for purchases and purchase of goods. It allows users to view, position, and interact with purchase records, including displaying detailed invoice and order information, and supports additional actions such as printing invoice copies and archive lookups.

## 1. **File Declarations**

The program defines several database input files (DISK), all with specified record formats and renames for internal usage:

- **sistl9, sistla, sistlb, sistlc, sistld:** Different logical views or access paths for purchase records.
- **vvarl1, vvasl1:** Access to item master files, possibly for additional item data.
- **rlevl1:** Supplier register.
- **sihel1:** Invoice header register.
- **votyl1:** Order type lookup, for authorization and archive access.
- **SI502d:** Workstation (display file) with a subfile (b1sfl) used for screen display and user input.

## 2. **Indicator Usage**

Indicators (e.g. `*in10`, `*in12`, etc.) are used to drive program logic, control screen elements, and manage subfile handling:

- 10: Roll (paging)
- 12: Subfile display
- 13: Subfile control display
- 14: Subfile clear
- 15: Subfile end
- 16: Readc: no more records in subfile
- 21: Home key
- 22: Cursor placement
- 30+: Special-purpose/error indicators

## 3. **Parameter Definitions**

Parameter variables correspond to the input parameters to the program, such as **firm (company code)**, **year**, **item**, **supplier**, etc. These are used as initial context upon program entry, and for positioning/searching within files.

## 4. **Variable Usage**

- **w_srrn, w_sfrn, w_ssrn, w_spge:** Used to track subfile record numbers (for paging, etc.)
- **w_seqe:** Sequence code (determines which file/index to use for positioning and reading).
- **w_firm, w_paar, w_vare:** Store main context values (company, year, item).
- **b1sfl fields:** Used for subfile rows; e.g., b1valg (selection action), b1line, b1binr, etc.

## 5. **Program Structure Overview**

### Initialization (`*inzsr`)
- Loads input parameters.
- Sets up key lists for various file accesses.
- Retrieves additional item text if available.
- Positions to the appropriate place in the file (using `setll`).
- Creates the initial subfile for display.

### Main Program Loop

The main program cycle is managed by "tags" and `goto` statements (classic RPG/400 control pattern):

- **b2taga:** Main entry, writes out command screen.
- **b2tagb:** Displays the subfile (by calling `dsp_subfile`).

Within this loop, user function keys are checked (`select` block):
  - **Exit (F3/F12):** `goto avslutt`
  - **Inquiry (F4):** Call `spørring` subroutine.
  - **Refresh (F5):** Call `forny` to refresh subfile.
  - **Roll (F10):** Call `crt_subfile` to load more records.
  - **Home (F21):** Set cursor placement, return to main tag.

#### Positioning
If the user has entered values in any of the position input fields (`b2valn`, `b2bida`, etc.), the program calls the `posisjoner` subroutine to re-position the subfile accordingly.

#### Subfile Handling
After any action, the subfile is processed by the `subfile` subroutine, where user actions on records are handled (see below).

### Subfile Processing (`subfile` subroutine)

For each subfile record:
- **5:** View sales details — Calls `SI510R` program with parameters from the selected record.
- **6:** Print invoice copy — Calls `skriv` subroutine.
- **7:** View invoice — Calls `vise` subroutine.
- **9:** Archive lookup — Calls an authorization program (`AX700R`), verifies access, then constructs reference and calls archive program (`AP622C`) for the relevant document type.

Actions reset the selection field after processing.

### Inquiry Subroutine (`spørring`)

Handles inquiries for supplier information (e.g., when the active field is 'B2valn'). Calls an external program to fetch supplier information.

### Refreshing and Positioning

- **forny:** Repositions file pointer and refreshes subfile data according to active sequence.
- **posisjoner:** Repositions subfile based on which positioning fields the user has filled (supplier, invoice date, invoice number, order number, etc.). Clears and reloads the subfile accordingly.

### Subfile Maintenance

- **clr_subfile:** Prepares subfile for clearing (indicator 14), resets counters.
- **crt_subfile:** Reads records from the appropriate logical file, filling subfile up to the page size or until all relevant records are loaded, applying any filter conditions from the parameter fields.
- **dsp_subfile:** Controls the display of the subfile or the empty command screen, as appropriate.

### Invoice Handling

- **vise:** If the current row is an invoice, verifies its existence and calls a program to display the invoice (`SH410R`).
- **skriv:** If the current row is an invoice, verifies its existence and calls a program to print an invoice copy (`FO681R`).

---

## **Key Concepts**

- **Subfile Pattern:** The program is a typical RPG subfile application, presenting a list of records to the user, supporting paging, record selection, function keys, and drill-down actions.
- **Logical Views:** Multiple logical files (access paths) are used to support different search/positioning strategies (supplier, address, date, invoice, order).
- **External Calls:** Business logic and auxiliary functions are offloaded to external programs via `call` and `parm`.
- **Indicator-Driven Logic:** Classic RPG indicators manage screen I/O, subfile behavior, and program flow.
- **Extensive Use of Tags and Goto:** The program relies on label-based control flow, typical of earlier RPG IV (before widespread RPGLE structured operations).

---

## **Summary Table of Major Subroutines and Actions**

| Subroutine    | Purpose                                                           |
|---------------|-------------------------------------------------------------------|
| *inzsr        | Initialization and parameter processing                           |
| spørring      | Supplier/field lookup and inquiry logic                           |
| forny         | Repositions and refreshes subfile based on sequence               |
| posisjoner    | Handles subfile positioning based on user input fields            |
| clr_subfile   | Clears the subfile and resets counters                            |
| crt_subfile   | Loads/fills subfile with data from relevant logical file          |
| dsp_subfile   | Controls display of the subfile or command screen                 |
| subfile       | Handles user actions on subfile rows (view, print, archive, etc.) |
| vise          | Shows invoice details for selected row                            |
| skriv         | Prints invoice copy for selected row                              |

---

## **Typical Flow**

1. **Program starts:** Parameters are populated (`*inzsr`).
2. **Subfile is loaded:** Data is fetched and displayed on the screen.
3. **User interacts:** Can page through, position, or act on subfile rows.
4. **Functions:** Drill-down to invoice/sales detail, print, or archive lookup.
5. **Program ends:** Exits on user request (F3, F12).

---

## **Notes for Onboarding**

- **Enhancements:** Many blocks and file accesses are commented out (e.g., addresses, some keys), signaling either deprecated features or pending reactivation.
- **Indicators:** Understanding IBM i subfile and indicator usage is key.
- **External Programs:** Documentation or source may be required to fully understand called programs (e.g., `FSPKUR`, `SI510R`, `FO681R`, etc.).
- **DDS Screens:** The display file (`SI502d`) contains the subfile (b1sfl) and control records; necessary for UI changes.
- **Internationalization:** Comments and field names are Norwegian; familiarity may be required.

---

## **Conclusion**

This program is a classic RPG IV subfile browser for purchase records, supporting inquiry, record actions, and integration with invoice and archive systems. The codebase is structured for flexibility in positioning and is extensible for additional entities or access paths as business requirements evolve. Understanding indicator usage, subfile patterns, and the logical file structures will be essential for effective onboarding and support.