# Program RK920R Documentation

## Overview

**RK920R** is an annual routine program for customer data maintenance in the ASOKON system. Its primary purpose is to reset specific customer fields at year-end, ensuring correct initialization of values for the new fiscal year. The program also handles audit-trail (sporing) fields and updates related memo records.

This program operates on two main physical files:

- **RKUNLU** (Customer master, logical file)
- **RKMELU** (Customer memo, logical file, since v6.30)

## File Declarations

- **RKUNLU**: Primary customer data file. Renamed to `rkunlur` for internal reference.
- **RKMELU**: Customer memo file. Renamed to `rkmelur` and fields prefixed with `rx` for namespacing.

## Key Variables

- **l_user**: User ID for audit-trail fields.
- **rkmelu_firm**, **rkmelu_kund**: Key fields for accessing memo records, matching the structure of `rxfirm` and `rxkund` from RKMELU.

## Main Logic

### 1. Field Initialization

The program resets several fields in the customer record (`rkunlur`):

- `rksaif` is set to the value of `rksald` (carry forward balance).
- `rkkj�f` is set to `rkkj�p` (yearly purchases).
- `rkkj�p` is reset to 0 (zero out purchases for the new year).
- `rkgral` is reset to 0 (zero out another accumulator field).
- `rkkjal` (moved to RKMELU as of v6.30) is commented out here, as it is now handled in the memo file.

### 2. Audit-Trail Fields

- **rkepgm**: Set to the program name (`RK920R`).
- **rk2dpt**: Set to the current time (date/time stamp).
- **rkesig**: Set to the current user (`l_user`).

### 3. Update Customer Record

- The updated customer record is written back to `rkunlur`.

### 4. Update Memo File (RKMELU)

As of version 6.30, certain fields previously in RKUNLU are now in RKMELU:

- The program builds the key (`rkmelu_firm`, `rkmelu_kund`) from the current customer record.
- It chains to the corresponding memo record.
- If found:
    - `rxkjal` is reset to 0.
    - Audit fields (`rxmeda`, `rxmeti`, `rxmeus`) are updated with the current date, time, and user.
    - The record is updated in `rkmelur`.

### 5. Subroutine: *INZSR

The initialization subroutine (`*inzsr`) sets up the key list for accessing RKMELU records, ensuring that `rkmelu_firm` and `rkmelu_kund` are used as the composite key.

## Business/Domain Logic

- **Year-End Processing**: The core business logic is annual reset of accumulators for each customer, ensuring that balances and yearly purchase figures are correctly rolled over.
- **Audit Trail**: The program maintains fields to track who performed the update, when, and from which program, supporting traceability.
- **Data Model Evolution**: As of v6.30, some fields have migrated from customer master (RKUNLU) to memo (RKMELU), reflecting a normalization of the data model.

## Notable Design/Implementation Details

- **Field Prefixing**: The use of the `prefix(rx:2)` directive for RKMELU fields avoids naming collisions and clarifies field origin.
- **Key List Usage**: The use of `klist` and `kfld` for key management is consistent with system conventions for keyed file access.
- **Commented Code**: Old logic for `rkkjal` is commented out, with notes indicating its new location, which helps maintainers understand changes over time.
- **Version Annotations**: Inline version markers (e.g., `6.10`, `6.30`) help trace the evolution of the program and clarify when features or changes were introduced.

## Interactions with Other Modules

- **RKUNLU**: Main customer record file; updated directly.
- **RKMELU**: Supplementary memo file; updated if a matching record exists.
- No explicit calls to external APIs or service programs are present; all logic is contained within the program and the two files.

## Conventions

- **Audit fields** are always updated on record changes.
- **Field resets** occur only for relevant fields, as dictated by business rules and system version.
- **Comments** are used extensively to document changes, especially in response to business or regulatory requirements.

## Summary

RK920R is a year-end utility for resetting customer accumulators and maintaining audit fields, with logic adapted over time to reflect changes in the data model and business requirements. The program is tightly coupled to the RKUNLU and RKMELU files, and follows established conventions for audit-trail, field prefixing, and version tracking.