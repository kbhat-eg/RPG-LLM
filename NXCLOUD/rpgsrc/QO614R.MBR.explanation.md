# QO614R – Order Processing, Picking, Resting, and Sorting

## Overview

**QO614R** is a central ILE RPG program in the ASOFAK system, handling complex order processing tasks, including:

- Order picking and printing (e.g., picking lists, order confirmations, invoices)
- Resting (splitting unfulfilled order lines to new orders/suffixes)
- Sorting/grouping for batch operations (e.g., consolidated invoicing)
- Interfacing with warehouse management, customer/project, info, and logging modules
- Managing business rules for document output (including email, direct print, and logic-driven outputs)
- Integrating with ByggDok/CoBuilder (construction documentation) and deposit handling

The program is highly parameterized, driven by control records (registers) and local data area (LDA), and interacts with a large set of files and subprograms.

---

## Key Business Concepts

- **Order resting:** When an order cannot be fulfilled completely, the remaining items are split off to a new order (with a new suffix).
- **Picking:** Selecting orders/lines for processing, printing, or further handling.
- **Suffix:** Orders are identified by number and suffix, enabling multiple "versions" or splits of the same order.
- **Batch processing:** Orders can be grouped for printing or invoicing based on customer, project, payment terms, etc.
- **Special document flows:** Emailing, direct print, and logic-based routing for various order documents.
- **ByggDok/CoBuilder:** Construction industry documentation requirements, with customer/project-specific handling.
- **Depositum:** Special handling for orders with deposits, enforcing one invoice per order.

---

## Program Structure

### 1. **File Definitions**

The program defines and renames many files (registers), each representing a business entity:

- Orders: Header (`fohel1r`/`fohelur`), lines (`fodtl1r`/`fodtlur`), texts (`fotxl1r`)
- Picking: Parameters (`fplol1r`/`fplolur`), lines (`fplllu`), output (`fpsolu`)
- Master data: Customers (`rkunl1r`), order types (`votyl1r`), info codes (`vinfl1r`), users (`fusrl1r`)
- Special: Card transactions (`fntrl1r`, `fmkal1r`), deposits (`sdepl1r`), ByggDok (`fbdopf`), etc.

### 2. **Data Structures**

- **hlrec**: Used for warehouse updates (item, warehouse, date/time, type, qty, etc.).
- **sorter**: Used for sorting/grouping orders for batch operations (customer, name/address, project, payment terms, etc.).
- **d_urec**: For logging activities (firm, order, suffix, code, date/time, user/workstation).
- **LDA (local data area)**: Used for passing parameters between programs/modules.

### 3. **Field and Key Variable Conventions**

- All key fields for file access are explicitly named and maintained (e.g., `fohel1_numm`, `fohel1_suff`, etc.).
- Many variables are reused across different file accesses, reflecting the multi-register logic.

### 4. **Main Processing Loop**

- Reads picking parameters (`fplol1r`) within a given order number/suffix range.
- For each record:
    - Validates against firm, order type, user, and workstation.
    - Loads all relevant keys for the order and associated records.
    - Loads order type and determines the correct output routine (logic for mail, print, etc.).
    - Calls output program (`QP600R`) with all required parameters via LDA.
    - Updates order status, logs, and related registers as needed.
    - Handles resting if required (splitting lines, creating new order/suffix).
    - Updates warehouse, logs, and deletes processed picking parameters.
    - Loops to next order.

### 5. **Resting Logic**

- If resting is required (partial fulfillment), calls subroutines to:
    - Determine the next available suffix (`hntsuf`, `hntnum`).
    - Split lines between old and new orders.
    - Create a new order header if needed.
    - Update or delete the old order header/lines as appropriate.
    - Update warehouse balances and memo accounts accordingly.

### 6. **Sorting/Batching Logic**

- Orders are grouped for batch output based on:
    - Customer/project
    - Payment terms
    - Overridden invoice/due dates
    - Special card transaction logic
    - Depositum (enforces one invoice per order)
- The `sorter` data structure is built up per order to control batching.

### 7. **Output Routine Selection**

- The output routine (`l_ruti`) is dynamically determined based on:
    - Order type settings (from `votyl1r`)
    - Picking parameter overrides (e.g., mail, alternative offers)
    - Special business rules (e.g., always use certain routines for confirmations)
    - Email output is handled with special routine names to include firm info.

### 8. **Warehouse and Logging Integration**

- Warehouse updates are managed via the `VL001R` program, using the `hlrec` structure.
- Logging of order and line events is handled via `FU900R`, `FS710R`, and related programs, with detailed context (user, time, order info).

### 9. **ByggDok/CoBuilder Handling**

- If enabled, the program collects and outputs construction documentation info, with special attention to customer/project-level overrides and contact person logic.
- Integration with ByggDok/CoBuilder is conditional and controlled via configuration registers.

### 10. **Subroutine Highlights**

- **hntsuf/hntnum**: Find next available suffix or order number, possibly involving external programs for number series overrides.
- **olrest**: Handles splitting of order lines during resting, including creating new lines, updating/deleting old lines, and handling related purchase order lines.
- **laglag/opplag**: Reads and updates warehouse balances for both source and destination orders.
- **ohead/linje/foran/etter**: Output order header, lines, and texts to the picking output register.
- **slett_plukk**: Cleans up temporary picking registers (e.g., for RadioTerm devices).
- **upd_logg/sjekk_lkode**: Handles logging and special business rules (e.g., "kjørekontor" selection).

---

## Integration Points

- **QP600R**: Main output/print/email program, called with dynamic routine names and parameters.
- **FO709R/FO730R/FO190R**: Order creation, totals calculation, and status update programs.
- **VL001R**: Warehouse update program.
- **FA922R**: Memo account adjustment.
- **FS710R**: Order line deletion logging.
- **FU900R/FU702R**: Logging and business rule checks.
- **AS100R/AS110R/VA752R/FO415R**: Number series and order relationship management.
- **ByggDok/CoBuilder**: Construction documentation output.
- **LDA**: Used for parameter passing between programs.

---

## Non-Obvious Design Decisions & Conventions

- **Suffix Handling**: The system uses order number + suffix as a compound key, allowing for flexible splitting and versioning of orders.
- **Sorting for Batching**: The `sorter` structure is carefully constructed to support complex business grouping rules for batch output, including customer, project, payment, and date overrides.
- **Dynamic Output Routine Selection**: Output routines are not hardcoded but are dynamically chosen based on register settings and business logic, allowing for flexible document flows and easy extension.
- **Resting Logic**: The program is designed to always create a new suffix (or order) for rested lines, ensuring traceability and auditability.
- **LDA Usage**: The program relies on the local data area for inter-program communication, following a strict field allocation convention.
- **Subroutine Organization**: All major business processes (resting, output, warehouse, logging) are encapsulated in dedicated subroutines, facilitating maintenance and business rule changes.
- **Email/Print Handling**: Special handling for email output, including firm-specific information and routine overrides, is embedded in the routine selection logic.
- **ByggDok/CoBuilder**: The logic for construction documentation is modular and only activated when relevant, minimizing impact on other order flows.
- **Comprehensive Logging**: All significant changes (resting, picking, deletions) are logged with user, timestamp, and context for audit purposes.

---

## Key Relationships with Other Modules

- **Order Management**: Interacts heavily with order header, line, and text registers.
- **Warehouse Management**: Updates and synchronizes warehouse balances via external programs.
- **Customer, Project, and Info Registers**: Uses these for grouping, business rule enforcement, and document output logic.
- **User Management**: Checks user permissions for sensitive actions (e.g., invoicing, reprinting packing slips).
- **Deposit and Card Transaction Modules**: Special business rules are enforced when these are involved.
- **ByggDok/CoBuilder**: Integrates with external documentation systems when required.
- **Batch Output**: Coordinates with output routines for printing, emailing, or other document flows.

---

## Maintenance Notes

- **Extensions are tracked by version and change comments** (e.g., 5.03, 6.22, 8.02), with business rationale documented inline.
- **All key logic is parameter-driven**; changes to business rules should be reflected in the relevant registers or configuration routines.
- **Subroutine boundaries are respected;** any changes to resting, output, or warehouse logic should be made in the corresponding subroutine.
- **When adding new document flows or output routines,** update the routine selection logic and ensure appropriate register entries exist.
- **For new business rules (e.g., grouping, deposits),** extend the `sorter` structure and associated logic.
- **All file accesses use explicit key variables,** which must be maintained consistently for correct data retrieval and updates.

---

## Summary

QO614R is a highly parameterized, extensible, and business-rule-driven program for order processing in the ASOFAK system. It supports complex flows (resting, picking, batching, document output, warehouse integration, logging, and industry-specific requirements) and is designed for maintainability and traceability. All business logic is governed by control registers and modular subroutines, facilitating adaptation to evolving requirements.