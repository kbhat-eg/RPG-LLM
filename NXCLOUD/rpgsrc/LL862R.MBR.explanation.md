# Explanation of RPG Source Code (Program: LL852R)

This program is written in IBM ILE RPG (Report Program Generator) and is designed to extract purchase transaction details by supplier (“leverandør”) and generate output suitable for import into Excel.

---

## 1. File and Program Specifications

### Header Specs
```rpg
h decedit ('0,') datedit(*dmy) option(*nodebugio)
```
- **decedit ('0,')**: Specifies how decimals are edited (comma as decimal, zero for blank).
- **datedit(*dmy)**: Dates use Day-Month-Year format.
- **option(*nodebugio)**: Disables debugging of I/O operations.

### Purpose and Change Log
The comments (in Norwegian) explain that this is a new program for extracting purchase data per supplier for Excel, with history of changes/reference fields.

### File Declarations
```rpg
fsihel1    if   e           k disk    rename(sihepfr:sihel1r)
fsidtl1    if   e           k disk    rename(sidtpfr:sidtl1r)
flwexpf    o  a e           k disk    rename(lexcpfr:lexcpfr)
```
- **sihel1**: Input file (purchase header), externally described, keyed, renamed from `sihepfr` to `sihel1r`.
- **sidtl1**: Input file (purchase detail lines), keyed, renamed from `sidtpfr` to `sidtl1r`.
- **lwexpf**: Output file (for Excel), output capable, externally described, renamed from `lexcpfr`.

---

## 2. Data Structures and Variables

### Local Data Area
```rpg
d                uds
d l_firm                944    946  0
```
- Reference to a portion of the User Data Space (`l_firm`) for the firm number.

### Parameter Record
```rpg
d                 ds
d p_prec                        55
d  p_ldor                        6  0 overlay(p_prec)
d  p_fdat                        6  0 overlay(p_prec:7)
d  p_tdat                        6  0 overlay(p_prec:13)
```
- `p_prec`: parameter record (55 chars from entry parameter).
- Overlays provide quick access to sub-fields: supplier (`p_ldor`), from-date (`p_fdat`), to-date (`p_tdat`).

### Key Variable Definitions
```rpg
d sidtl1_aarr     s                   like(slaarr)
d sidtl1_binr     s                   like(slbinr)
d sidtl1_numm     s                   like(slnumm)
d sidtl1_suff     s                   like(slsuff)
```
- Variables for key fields of detail lines.

### Output Record Buffer
```rpg
d d_orec          s           1024
```
- Output buffer for building each Excel-compatible line.

### General Working Variables
Multiple variables used for dates, firm, supplier, etc.—all are typed similarly to database fields (using `like`).

### Edit Words & Constants
```rpg
d ew112           c                   '         ,  -'
d ew113           c                   '        ,   -'
d c_fsep          c                   X'05'
```
- **Edit words:** Used for number formatting in output.
- **c_fsep:** Field separator character (hex 05, common in export files).

---

## 3. Main Logic Flow

### Heading Creation (Excel column titles)
```rpg
eval      d_orec = *blank
eval      d_orec = 'Leverandør' + c_fsep +
                                       %char(w_ldor)  + c_fsep
eval      exclin = d_orec
write     lexcpfr
eval      d_orec = *blank
eval      d_orec = 'Bilagsnr' + c_fsep +
                   'Varenr' + c_fsep +
                   'V.navn' + c_fsep +
                   'Enhet' + c_fsep +
                   'Antall' + c_fsep +
                   'Kostpris' + c_fsep +
                   'Innkjøpspris' + c_fsep +
                   'Rabatt 1' + c_fsep +
                   'Rabatt 2' + c_fsep
eval      exclin = d_orec
write     lexcpfr
```
- Builds and writes two header lines to the output file—an identifier row, then a column title row.

### SQL Cursor Declaration and Data Retrieval
A cursor `sok_v` is defined for selecting purchase headers (`sihepf`) for a specific firm, date range, and supplier, ordered by year and document number.

```rpg
/exec sql
+ declare sok_v cursor for
+ select shaarr, shbinr, shnumm, shsuff, shbdat, shldor
+ from   sihepf
+ where  shfirm = :w_firm and
+        shaarr >= :w_faar and
+        shaarr <= :w_taar and
+        shldor = :w_ldor and
+        shbdat >=:w_fdat and
+        shbdat <=:w_tdat
+ order by shaarr,shbinr
+ for read only
/end-exec
```
- The cursor is opened and a loop begins to fetch each header record.

### Fetch Loop Over Headers
```rpg
dow       *in15 = *off
/exec sql
+ fetch next from sok_v into :shaarr, :shbinr, :shnumm, :shsuff, :shbdat, :shldor
/end-exec

if        sqlcod = 100 or sqlstt = '02000'
   eval  *in15 = *on
endif

if        *in15 = *on
   leave
endif
```
- If no more records, exit the loop.

### Loop Over Detail Lines
For each header fetched, it finds all matching detail lines in `sidtl1`:
```rpg
eval      sidtl1_aarr = shaarr
eval      sidtl1_binr = shbinr
eval      sidtl1_numm = shnumm
eval      sidtl1_suff = shsuff
sidtl1_key    setll     sidtl1
sidtl1_key    reade     sidtl1
dow       not %eof(sidtl1)
   if    slvare <> *blank
      exsr skriv_vlin
   endif
   sidtl1_key    reade sidtl1
enddo
```
- For each detail line with a non-blank product, it calls subroutine `skriv_vlin` to output the record.

---

## 4. Subroutines

### skriv_vlin (Write output line)
```rpg
skriv_vlin    begsr
eval d_orec = %char(shbinr) + c_fsep +
               %trim(slvare) + c_fsep +
               %trim(sltek1) + c_fsep +
               %trim(slenh1) + c_fsep +
               %editw(slanta : ew113) + c_fsep +
               %editw(slkpny : ew112) + c_fsep +
               %editw(slipny : ew112) + c_fsep +
               %editw(slrab1 : ew112) + c_fsep +
               %editw(slrab2 : ew112) + c_fsep
eval exclin = d_orec
write lexcpfr
endsr
```
- Builds a single output row with all relevant detail line values, applies formatting, and writes to the output file.

### Initialization Subroutine (*inzsr)
Handles:
- Key list definitions for reading detail lines.
- Entry parameter unpacking.
- Reads the firm number from local data area.
- Gets the current date/time.
- Moves and extracts dates for filtering, etc.

---

## 5. Program Entry

### Parameter List and Main Startup
```rpg
*entry plist
parm w_parm
eval p_prec = w_parm
```
- Retrieves input parameters (packed into `w_parm`) passed to the program.

---

## 6. Program Exit

```rpg
end_pgm tag
eval *inlr = *on
return
```
- Ends the program, closes files, and returns.

---

## 7. Summary

- **Goal:** Reads purchase headers and details for a given supplier and date range, formats data for Excel import.
- **Input:** Parameters for supplier, date range, and firm.
- **Processing:** Uses SQL to fetch relevant headers, then reads associated detail lines via keyed I/O.
- **Output:** Creates a text file where each line is a purchase detail, fields separated by a special character.
- **Structure:** Modular, with clear separation of concerns (data selection, line formatting, output).

---

**Onboarding Note:**  
- Knowledge of Norwegian will help for field labels.
- You will need to be familiar with both RPG and SQL/400 syntax.
- All file and field names are business-specific, review their definitions in the database for full understanding.  
- Output format is designed for use with Excel or similar spreadsheet tools.