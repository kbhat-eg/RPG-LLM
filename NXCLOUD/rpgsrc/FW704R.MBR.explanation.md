# RPG Program FW704R – Supplier Item Register Generation (Jernia)

## Purpose

This program's primary function is to extract supplier item information from an input file (specifically using the "new Jernia format") and write it into a supplier item register file. The code processes each input item record, translates certain characters in the item description, performs lookups for unit conversion, handles VAT calculations, and adds tracking information.

---

## File Declarations

- **flvwpf**: Input file, keyed, disk.
- **fenkl1**: Input file, keyed, disk, renamed to `fenkl1r`.
- **flvapf**: Output file, non-keyed, disk (the supplier item register).

---

## Key Data Structures

### Local Data Area

- **l_user**: User identifier, extracted from positions 911–920 in the local data area (`*LDA`).

### Input Record Layout (`d_inpu`)

A 259-character buffer overlaid with fields such as:
- **d_ekod**: Status code (change indicator)
- **d_vare**: Item number
- **d_tek1**: Item description/text
- **d_enhe**: Unit
- **d_lvar, d_ldor, d_vgr1, ...**: Various classification, grouping, and supplier fields
- **d_eann, d_ean2, ...**: EAN numbers
- **d_nobb**: NOBB number (Norwegian building product number)
- **d_inpr, d_saim, d_antp, ...**: Prices and packaging information
- etc.

### Parameter & Work Variables

- **p_firm**: Company/firm number (parameter)
- **p_ldor**: Supplier code (parameter)
- **w_firm**: Local copy of firm number
- **w_udat**: Current date
- **w_mvaf**: VAT factor (to be used in price calculations)

---

## Main Program Flow

1. **Initialization (`*inzsr`)**
   - Receives firm and supplier parameters.
   - Prepares key lists for lookup.
   - Sets `w_firm`, fetches current date into `w_udat`.
   - Calls subprogram `'FØ705R'` to retrieve VAT factors.

2. **Processing Input Records**
   - Reads each record from input file `flvwpf`.
   - Loads the input buffer `d_inpu` from the file record.
   - Skips records missing the change code (`d_ekod` blank).
   - Translates certain ANSI-encoded Norwegian characters in the item description field to correct Norwegian letters (e.g., Æ, Ø, Å).
   - Maps fields from the input record to the output record fields for writing to the supplier item register.
     - Performs necessary field overlaps and trims (especially for NOBB number, item numbers, etc.).
     - If the unit code (`d_enhe`) requires translation, performs a lookup in the `fenkl1` file to translate to the appropriate unit text.
     - If the cross-dock code (`d_crdo`) is "CD", sets the cross-docking flag.
   - Adds tracking information: operation date/time and user, extraction date/time and user.
   - Writes the assembled output record to the output file `flvapf`.

3. **End of Program**
   - Sets program LR indicator `*INLR` (end of program) and returns.

---

## Other Notes

### Special Processing/Translations

- Character translation (`xlate`) repeatedly replaces specific hex values in text fields to correct Norwegian letters. This is important for legacy data containing non-standard character encodings.

### Unit Conversion

- Looks up unit code in `fenkl1` using firm and code as keys. If found, replaces with translated unit description.

### Conditional Handling

- Records with blank change codes are ignored.
- Some fields (e.g., NOBB number, cross-dock flag) are only set if data is present or matches a specific value.

### VAT Handling

- Price calculations include a VAT factor obtained by calling another program. This is used to compute the correct sale price (`fwsapr`).

### Logging and Tracking

- User and timestamp fields are set from the local data area and system clock to facilitate item tracking and audit trails, introduced in version 6.10.

---

## Subroutine: `*inzsr` (Initialization)

- Receives program parameters (firm, supplier).
- Prepares key lists for unit code translation.
- Gets today's date.
- Calls an external program to retrieve VAT factors (firm, date, and factor variables).

---

## Versioning and Maintenance

- The program header documents changes over time, e.g., new format adaptation, NOBB number length change, removal of rounding for VAT, etc.

---

## Summary

This RPG program is a classic batch-processing application for IBM i, reading item master records, performing data transformations (including character set corrections and unit lookups), calculating prices (with VAT), enhancing the record with tracking info, and writing the result to a supplier item register according to Jernia's format. It is modular and includes clear extensibility for future changes.