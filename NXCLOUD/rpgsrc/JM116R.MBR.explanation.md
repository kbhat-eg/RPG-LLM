# RPG Program Explanation: JM116R

## 1. Overview

This RPG (ILE RPG, traditional /free, column-based) program, `JM116R`, is designed for maintenance of campaign prices, specifically for group handling of goods and price calculation.  
It interacts with display files and physical files, supporting user interaction for entering/updating pricing and discount information, querying supplier data, and enforcing validation rules.  
The code is annotated in Norwegian.

---

## 2. File Declarations

```rpg
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
fjm116d    cf   e             workstn
```

- `jlevl1` - A keyed physical file, external (disk) for supplier data, renamed to `jlevl1r`.
- `jm116d` - A display file (workstation) for screen interaction.

---

## 3. Data & Working Variables

- **Parameters (Passed to/from the program):**
  - `p_firm` (3,0): Company number
  - `p_pldo` (like `jlldor`): Discount supplier
  - `p_rab1`, `p_rab2`, `p_pslk`, `p_raba`, `p_psls` (4,2): Various discount / surcharge rates
  - `p_vkai`, `p_vkpr`, `p_vkaa` (9,2): Prices
  - `p_retur_ok` (1): Return status flag

- **Key Variable:**
  - `jlevl1_ldor` (like `jlldor`): Used for reading supplier records via a keyed lookup.

- **Other Variables:**
  - `b_feil` (1): Error flag, initialized off
  - `w_firm` (3,0): Local copy of company number
  - `w_ldor_alf` (6): Temp work field for supplier
  - Others (screen variables, not shown here directly but referenced).

---

## 4. Main Flow (Screen Processing)

### 4.1. Initialize Screen Variables

On entry, parameter values are copied to corresponding screen variables (e.g., `b1pldo = p_pldo`).  
Return code set to success (`p_retur_ok = *on`).

### 4.2. Main Screen Loop

`b1tag:` (main interaction tag)
- Displays main screen (`exfmt b1bld`).
- Handles function keys:
    - **F3 (Exit):** Sets return status `*off`, then exits (GOTO `avslutt`).
    - **F4 (Inquiry):** Calls the `spørring` subroutine (query), then repeats display.
    - **F13 (Conditions):** Calls the `betingelser` subroutine (conditions), then repeats display.

- **Input Validation:**
    - Calls `sjekk_inp`.
    - If error, resets `b_feil` and loops to `b1taga` to redisplay screen.

- On success, moves screen values back into parameters.

### 4.3. Program Exit

- Tag `avslutt:` sets LR (last record indicator) on, ends program.

---

## 5. Subroutines

### 5.1. Inquiry (`spørring`)

Handles lookups for supplier data:
- If field is 'B1PLDO', calls program `JL500R` to retrieve supplier details into `b1pldo` and `b1plna`.

### 5.2. Conditions (`betingelser`)

Shows condition-related info:
- If `b1pldo` is set, calls `JP102R` with company and supplier.
- Otherwise, calls `JP101R` with a blanked work field.

### 5.3. Input Validation (`sjekk_inp`)

Performs various checks, setting error indicators as appropriate:
- **Supplier Lookup:** If supplier number entered, verifies it exists in `jlevl1` via keyed CHAIN. If not found, sets error.
- **Mutually Exclusive Entry:** Can't enter both discounts/surcharges and prices at the same time.
- **Consistency Checks:** E.g., can't specify a second discount without the first, can't specify surcharge both as in and out simultaneously, etc.
- **Price Dependency:** For some prices, others must be specified.

If any error is detected, a corresponding indicator is set for display file feedback, and `b_feil` is set on.

### 5.4. *INZSR (Initialization)

- Collects parameters from program call.
- Sets up key lists.
- Copies company number into work variable.

---

## 6. Notable RPG Features

- Uses RPG classic syntax (not /free).
- Heavy reliance on field-level indicators (`*in36`, `*in39`, etc.) for screen error feedback.
- Subroutine structure common for RPG, with explicit `tags` and `exsr` calls.
- Parameter passing and retrieval through PLIST.
- Norwegian language comments and variable names.

---

## 7. Summary of User Interaction

1. User is shown a screen to input or edit campaign price/discount data.
2. User can query suppliers or view conditions via function keys.
3. Input is validated according to business rules.
4. On F3 or valid completion, parameters are updated and the program ends.

---

## 8. Onboarding Notes

- Know your display files: The program expects particular screen fields (e.g., `b1pldo`, `b1rab1`, `b1vkai`, etc.).
- Error handling is via indicators mapped to screen fields—check your DDS definitions for indicator usage.
- Supplier lookups require a maintained `jlevl1` file.
- Additional programs (`JL500R`, `JP102R`, `JP101R`) must be available for inquiry/condition display.
- Business logic is tightly coupled to Norwegian domain (likely campaign pricing for wholesale/retail).

---

**In summary:**  
The program is an interactive RPG "dialog" program for campaign price and discount maintenance, with validation logic, query support, and classic RPG structure. Understanding the display file, error indicators, and related supplier files/programs is key for effective onboarding and maintenance.