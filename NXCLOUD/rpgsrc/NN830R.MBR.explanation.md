# RPG Program NN830R – Explanation and Onboarding Notes

## Overview

This is an ILE RPG program for the IBM i (AS/400) platform. The main function is to retrieve and process statistics for customer accounts receivable ("reskontrostatistikk") for a web shop (nettbutikk). The program interfaces with data queues for input and output, processes customer and account data, and outputs formatted statistics.

The program reads input requests from a data queue, fetches information about the specified customer, calculates account balances including aging distributions, handles memo balances, and writes the results to an output data queue.

---

## Key Sections Breakdown

### 1. **File Declarations**

The `F`-specs (deprecated in free format) define the physical files used (customer master, transactions, memo balances, parameter files, etc.), with data structure renaming for record formats.

```rpg
frktrl2    if   e           k disk    rename(rktrpfr:rktrl2r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frkmel1    if   e           k disk    rename(rkmepfr:rkmel1r)
fraa3l1    if   e           k disk    rename(raa3pfr:raa3l1r)
f*afpslr    if   e           k disk    rename(afpspfr:afpslrr)  // commented out
```

---

### 2. **Data Definitions**

- **Parameters**: Variables for communication via data queues and between subroutines.

- **Data Structures**: 
  - `d_inpu`: Input data queue, holds customer number.
  - `d_outp`: Output data, overlays different fields for result formatting (e.g., purchase, balance, aged values).

- **Control Variables**: For keys, work fields, aging limits, percentages, etc.

- **External Program Prototypes**: Defines the external program `CO402R`, which is called to retrieve extended parameters (e.g., for memo balance logic).

---

### 3. **Main Loop (Program Body)**

```rpg
dou d_inpu = *blank
  eval d_inpu = *blank
  call 'QRCVDTAQ' (receive input from queue)
  if d_inpu <> *blank
    exsr behandling
  endif
enddo
```
- The program runs in a loop, waiting for messages on the input data queue (`QRCVDTAQ`).
- When a request is received, it triggers the main processing subroutine (`behandling`) unless the input is blank.

---

### 4. **Subroutines**

#### a. **behandling** (Main Processing)

- Initializes the output data structure.
- Calls subroutines to fetch customer (`hent_kunde`) and balance (`hent_saldo`) info.
- Prepares numeric fields as formatted strings for output (European format, using comma as decimal separator).
- Writes the result to the output data queue (`QSNDDTAQ`).

---

#### b. **hent_kunde** (Fetch Customer Information)

- Uses customer number from input to read the customer master file.
- If not found, sets error flag and returns.
- Optionally calculates memo balance for a specific group (`Mestergruppen`) using program FO763R if memo days > 0.
- Fetches memo balance info from the separate register.
- Converts various numeric statistics to formatted strings for output (total purchase, yearly purchase, current balance, etc.).
- Memo balance is calculated including VAT using the fetched rate.

---

#### c. **hent_saldo** (Calculate Aging Distribution)

- Sets aging interval limits (e.g., 30/60/90 days).
- Reads all transaction records for the customer.
- For each, calculates days overdue, skips zero balances.
- Distributes remaining balances into aging buckets (current, 1–30, 31–60, 61–90, >90 days, and negative balances).
- Converts these values to strings for output.

---

#### d. **\*pssr** (Error Routine)

- Sets error flag and exits to cleanup/return section.

---

#### e. **\*inzsr** (Initialization on Program Start)

- Initializes keys and parameter fields.
- Reads aging bucket limits from a parameter file; if not found, uses defaults (30/60/90).
- Calls external RS205R to fetch the VAT percentage for memo balance calculations.
- (Earlier logic for reading additional memo parameters from a file has been replaced.)
- Calls external program CO402R to fetch extended parameters for memo balance and credit limit extension, parsing results as needed.

---

### 5. **Comments and Change History**

- The source includes a structured change history with version, date, author, and comments about significant logic changes.
- Comments in Norwegian indicate ongoing adaptation for specific customers/groups and business rules.

---

## Key Business Logic Concepts

- **Data Queues**: Used for communication to/from the program (decouples this logic from UIs or other systems feeding requests).
- **Customer/Account Aging**: The core calculation splits outstanding balances into buckets by how overdue they are.
- **Memo Saldo**: A "memo" or provisional balance, with options to extend the window for included orders, and to incorporate VAT.
- **External Configuration and Parameters**: Extended configuration is retrieved via an external program interface, allowing flexibility for parameters like "extended memo balance" and "credit limit extension" to be controlled outside the source code.

---

## Special Notes for Onboarding

- **Character and Decimals**: The program uses European number formats, beware of comma/period handling if integrating to other systems.
- **Program Interfaces**: The program expects certain data structure layouts on the data queues and in the files. Changes to these must be coordinated.
- **External Dependencies**:
  - RS205R: For VAT percentage.
  - FO763R: For advanced memo balance calculations (Mestergruppen).
  - CO402R: For dynamic configuration.
- **Reviewed Fields and Logic**: Some code sections are commented out, reflecting changes to logic regarding where/when parameters are sourced.
- **Error Handling**: Simple and abrupt—sets a flag and returns, relying on the calling environment to interpret errors.
- **Legacy RPG Syntax**: While there are hints of free-form in recent changes, the base is in fixed-form, which can be less readable for RPG newcomers.

---

## Key Takeaways

- The program is a batch-oriented statistic collector and responder, triggered via data queues.
- All output is marshaled into a string for the data queue, with values pre-formatted for display or further parsing.
- The core data processing leverages account aging and customer balances, with extensible configuration for special groups or changing business rules.
- Modernization of portions of the code (e.g., the CO402R interface) likely reflect continuing evolution—new RPG developers should be comfortable with both fixed and free-form RPG, as well as hybrid codebases.

---

**If you are new to RPG or this domain:**
- Start by understanding the data structures (input/output layout).
- Review the file structures and how they're used in the code.
- Trace a full cycle: from receiving a queue message, through customer lookup, calculations, to queueing the response.
- Pay attention to the business rules for memo balances, aging, and external configuration. 

**Familiarity with Norwegian business terminology (kundesaldo, memosaldo, kredittgrense) is helpful for adapting or troubleshooting this program.**