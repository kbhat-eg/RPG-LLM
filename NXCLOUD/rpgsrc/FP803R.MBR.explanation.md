# Explanation of the RPG Source Code

This program, written in ILE RPG (also known as RPG IV), is used to read and process order records from a historical invoice register. It is called **FP803R** as indicated in the header, and the comments are in Norwegian. Below is a detailed explanation of the code structure and logic.

---

## 1. Header & Metadata
```rpg
/TITLE  ASOFAK Ordreinngang, hente ordre fra historisk fakturaregister
H datedit(*dmy) option(*nodebugio)
```
- **TITLE**: Indicates this program is part of the ASOFAK system and is for "Order entry, fetch order from historical invoice register."
- **H-spec**: Sets date format (day/month/year) and disables debugging for I/O operations.

---

## 2. Files Section

```rpg
fsohel9    if   e           k disk    rename(sohepfr:sohel9r)
f                                     prefix(fo:2)
fwohepf    o  a e           k disk
```
- **sohel9**: Input file, externally described, keyed access, renamed record format, with fields prefixed by `fo`.
- **wohepf**: Output file, keyed access.

---

## 3. Data Definitions

### a. Local Data Area (LDA)
```rpg
d                uds
d l_ruti                800    809
d l_alin                856    858  0
d l_wsid                901    910
d l_user                911    920
```
- Reads values from the LDA at specific byte offsets for internal use.

### b. Parameter Data Structure
```rpg
d                 ds
d d_list                       128
d  d_firm                        3  0 overlay(d_list)
d  d_hist                        1    overlay(d_list:4)
...
d  d_ityp                        2    overlay(d_list:104)
```
- **d_list**: 128-byte flat buffer. The other fields "overlay" this buffer at set offsets, making it act as a parameter list for communication or call interface.
- Includes company, selection keys, order type selections, infokode filters, date ranges, sorting, etc.

### c. Key Variables
```rpg
dsohel9_firm      s                   like(fofirm)
dsohel9_bdat      s                   like(fobdat)
dsohel9_otyp      s                   like(footyp)
dsohel9_selg      s                   like(foselg)
```
- Used to build the key for record selection when reading the sohel9 file.

### d. Other Variables
```rpg
dgml_selg        s                   like(foselg)
dw_firm          s                   like(fofirm)
dw_timestamp     s               d   datfmt(*iso)
```
- Used for intermediate logic and timestamp tracking.

---

## 4. Main Program Logic

### a. Entry Point
```rpg
c                   if        d_hist = '1'
c                   exsr      detalje_fohe
c                   endif
c                   eval      *inlr = *on
c                   return
```
- If the `d_hist` parameter (from the parameter list) is '1' (i.e., work with historical data), the subroutine `detalje_fohe` is executed.
- The program then ends (sets LR indicator, causing program closure).

---

## 5. Subroutines

### a. detalje_fohe - Main Processing Loop

#### - Read/Select Logic
```rpg
c     detalje_fohe  begsr
c                   read      sohel9                                 60
c                   if        *in60 = *off
c                   eval      gml_selg = foselg
c                   endif
c                   dow       *in60 = *off
    ...
c                   enddo
c     end_les       tag
c                   endsr
```
- Reads the first record and stores the current seller.
- Enters a loop until EOF (`*in60 = *on`).

#### - Filtering
Within the loop, various selection criteria are applied before processing a record:
- **Company**: If `fofirm` (from record) does not match `d_firm` (from parameter), exit loop.
- **Seller**: If a specific seller is set (`d_selg <> 0`), skip records unless it matches.
- **Department**: If a specific department is set (`d_avde <> 0`), skip records unless it matches.
- **Order Type**: If order type filtering (`d_hvlg`) is enabled, check if it matches any of 6 possible input types.
- **Date Filtering**: If delivery date logic is enabled (`d_dvlg`), use delivery date as base date. Filter records either by exact date (`d_tdat = *loval`) or by a range (`d_fdat` to `d_tdat`).

#### - Output Calculation
```rpg
c                   eval      fotots = fosalp + fosalf
c                   eval      fototr = fork1p + fork2p
c                                      + fork1f + fork2f
c                   eval      fototk = fokstp + fokstf
c                   write     wohepfr
```
- Calculates totals for sales price and cost by summing up relevant fields, then writes the output record.

---

### b. *inzsr - Initialization Subroutine

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    w_list          128
c     sohel9_key    klist
c                   kfld                    sohel9_firm
c                   kfld                    sohel9_selg
c                   kfld                    sohel9_bdat
c                   eval      d_list = w_list
c                   eval      sohel9_bdat = d_fdat
c                   eval      sohel9_firm = d_firm
c                   eval      sohel9_selg = d_selg
c                   eval      fobolo = 'H'
c     sohel9_key    setll     sohel9
c                   endsr
```
- Processes the program's parameter list, initializes keys and sets the file pointer to the appropriate place in the input file for efficient reading.

---

## 6. Notable RPG Coding Idioms

- **Indicator Variables**: `*in60` is used to check EOF on file read.
- **Overlay and Prefix**: Used to manage parameter lists and file field naming conveniently.
- **goto/tag**: Used for skipping (not recommended in modern RPG but common in legacy code).

---

## 7. Evolution & Maintenance

Comment blocks at the top document the program's history, who changed it, and why—important for ongoing maintenance.

---

## 8. Summary

**FP803R** is a data extraction program designed to read history records from a sales/order file, based on various selectable criteria (company, seller, department, order type, info code, date range), calculate some totals, and write output records. It uses parameter passing, keyed file access, and contains clear filtering logic to support flexible selection.

---

### If you're onboarding:

- **Understand the field names**: Most are abbreviations (Norwegian/Scandinavian roots).
- **Know where parameter data comes from**: Usually from a calling program.
- **File layouts**: You’ll want to look up the file definitions (e.g., SOHEPF, WOHEPF) to understand the meaning of the fields.
- **Filters are highly parameterized**: Changing the criteria is as simple as updating the parameter list.

---

#### Useful for: Historical data extraction, reporting, data warehousing feeding, or migration tasks.