# Program JV750R – Article Pricing and Margin Calculation

## Overview and Purpose

This RPG program, `JV750R`, is a central part of the ASVADM system for handling article (product) pricing and margin calculations. It is responsible for determining the net price, cost price, sales prices (for up to three units), and margin (DG – "Dekningsgrad") for a given article, based on a complex set of business rules, master data, and pricing conditions.

**Key responsibilities:**
- Retrieve article and supplier data.
- Determine the applicable pricing conditions and markups.
- Resolve units of measure (sales, purchase, price book units), including their conversion factors.
- Calculate prices (net, cost, sales) and margin.
- Set status codes indicating normal or exceptional processing conditions.
- Support special cases such as expired articles, logistic articles, and special rounding rules.

The program is highly parameterized and supports a variety of input scenarios, reflecting the needs of a distribution/wholesaler business with complex supplier and pricing structures.

## Key Domain Concepts

- **Vare (Article/Product):** The item for which prices are calculated.
- **Leverandør (Supplier):** The supplier that provides the article.
- **Betingelser (Conditions):** Discount or price conditions, potentially hierarchical (by article, module, group, etc.).
- **Påslag (Markup):** Factors added to the cost to arrive at sales price.
- **Enheter (Units):** Articles can be sold, purchased, and priced in multiple units (e.g., piece, package, pallet), with conversion factors between them.
- **Prisgruppe (Price Group):** Customer or article segmentation for pricing.
- **Statuskoder (Status Codes):** Indicate special conditions (e.g., missing data, expired, excluded, etc.).
- **MVA (VAT):** Value Added Tax, hardcoded at 25% but also fetched dynamically for certain groups.

## Structure and Design

### 1. Data Access

The program opens a large number of physical files (tables) with various record formats, using `CHAIN`, `SETLL`, and `READE` for indexed access. Files are renamed and sometimes prefixed to avoid naming conflicts and clarify usage.

- **jvarl1, vvarl1:** Article master files (system and EVR).
- **jvprl1:** Article price file.
- **jvpkl1:** Article packaging/unit file.
- **jforl1, jforl5:** Packaging info by group or article.
- **jbetlb, jbetlc, jbetl1:** Pricing condition files.
- **jpfala, jpfalb, jpfal1:** Markup (påslag) files.
- **jlevl1, jlevlr:** Supplier master files.
- **vvenl1:** EVR article/unit file.
- **Others:** For status, logistic articles, temporary prices, etc.

### 2. Parameters and Variables

The program has a very extensive parameter list, both for input and output. Parameters include article number, supplier, price group, date, various units, prices, conversion factors, and status codes.

Local variables are used for working values, key fields for file access, flags, and temporary calculation fields.

### 3. Main Processing Flow

**Entry Point (`*inzsr`):**
- Initializes parameters and working variables.
- Reads VAT rates and rounding rules.
- Optionally calls another program (`CO402R`) for special logic (flag `u_701`).

**Main Routine:**
1. **Article Lookup:** Retrieves the article; if not found, sets status '9'.
2. **Group Validation:** Ensures the article has valid groupings; else status '1'.
3. **Unit Group Lookup:** Validates the article's group in the group master.
4. **Supplier Determination:** Finds the price-giving supplier.
5. **Pricing Conditions:** Looks for applicable discount/condition records, in a detailed fallback sequence (see below).
6. **Markups:** Finds applicable markups, again with a hierarchical fallback.
7. **Supplier Info:** Fetches supplier number and checks for EVR linkage.
8. **Unit Resolution:** Determines sales, purchase, and price book units, with conversion factors.
9. **Special Unit Checks:** Handles special cases (e.g., logistic articles, order units).
10. **Freight Conditions:** Looks for applicable freight markups.
11. **Special Price Handling:** If markups dictate, fetches main supplier's price.
12. **Status Checks:** Applies various business rules to set status codes (expired, excluded, GTIN conflicts, conversion mismatches, etc.).
13. **Price Calculation:** Calculates net, cost, and sales prices, applying markups, discounts, VAT, and rounding as required.
14. **Margin Calculation:** Calculates margin (DG) and applies further status checks for low/negative margin.

### 4. Condition and Markup Lookup Logic

Both condition and markup lookups are done using a **hierarchical fallback sequence**. The program attempts to find the most specific record (e.g., by article, module, group, supplier, price code, type, delivery type), and falls back to more general records if not found. This is implemented via a series of `CHAIN`/`READE` operations with progressively more fields set to zero or blank.

This design allows for very granular pricing rules, with sensible defaults if specific rules are not present.

### 5. Units and Conversion Factors

Articles can be associated with up to three sales units, three purchase units, and three price book units, each with their own conversion factors relative to a base unit. The program ensures units are resolved in the correct order (from packaging, group, or defaults) and that conversion factors are always available and consistent.

Special logic ensures that all necessary units (sales, purchase, price book, statistics, warehouse) are present and valid for the article.

### 6. Special Cases and Status Codes

The program sets a status code (`p_osts`) to indicate various exceptional or error conditions:

- '1': Missing group info.
- '2': Supplier not found or not linked to EVR.
- '3': Missing or invalid unit.
- '4': Price expired or ambiguous.
- '5': No pricing condition found.
- '6': No markup found.
- '7': Negative margin.
- '8': Article excluded from update.
- '9': General error (e.g., file access).
- 'U': Article expired.
- 'E': Unit change required.
- 'G': GTIN conflict.
- 'O': Conversion factor mismatch.
- 'L': Sourced article found as stock item.
- 'P': Conversion factor too large.
- 'Y': Order unit mismatch (now removed in v7.01).

These codes are used by calling programs to handle the result appropriately.

### 7. Price and Margin Calculation

- **Net Price (`p_ntpr`):** Calculated from NOBB price and discount factors.
- **Cost Price (`p_kopr`):** Net price plus markups and freight, multiplied by cost factor.
- **Sales Price (`p_s1pr`, etc.):** Cost price multiplied by sales factor and conversion factor.
- **Margin (`p_dekn`):** `100 - (cost price * 100 / sales price)`.

Special rounding rules and psychological pricing (for specific chains like Byggmakker) are supported via external calls (`FA911R`, `FA909R`) and a parameterized rounding rule.

### 8. Rounding and VAT

- VAT is hardcoded at 25% but also fetched dynamically for specific groups and dates.
- Rounding is handled by external programs and can be customized by price group or chain.

### 9. External Program Calls

- **FA909R, FA911R:** Rounding and psychological pricing.
- **FØ705R:** VAT rate lookup.
- **VE710R:** GTIN conflict check.
- **JA209C:** Rounding rule lookup.
- **CO402R:** Special logic for v7.01.

### 10. SQL Integration

For logistic articles, an embedded SQL statement is used to fetch related data from several joined tables. This is a modern addition to an otherwise native record-level access program.

## Design Patterns and Conventions

- **Hierarchical Fallback:** Both pricing conditions and markups are resolved using a detailed fallback sequence, ensuring the most specific rule is always used if available.
- **Status-Driven Flow:** The program uses a central status code to control error handling and flow, allowing calling programs to react appropriately.
- **Extensive Parameterization:** The program is designed to be called by other programs, with a very wide parameter list for both input and output.
- **Subroutines for Modularity:** Major business logic is separated into subroutines, each handling a specific aspect (supplier, conditions, markups, units, price calculation, etc.).
- **Version Control and Change History:** The code is extensively commented with a detailed change log, indicating careful maintenance and evolution.

## Integration with Other Modules

- **Master Data:** Relies on article, supplier, packaging, and group master files.
- **Pricing Data:** Uses condition and markup files, which are likely maintained by other processes.
- **Order and Logistics:** Checks for orderable units, logistic articles, and related data.
- **External Routines:** Delegates rounding, VAT, and psychological pricing to separate programs.
- **SQL Data:** For logistics, uses direct SQL queries to fetch related data.

## Key Takeaways for New Developers

- **Complex Fallback Logic:** Be aware of the detailed fallback sequences for both conditions and markups. This is central to the program’s flexibility.
- **Status Codes Are Critical:** Always check and interpret `p_osts` when using this program.
- **Units and Conversion Are Tricky:** Ensure you understand how sales, purchase, and price book units are resolved and how conversion factors are calculated.
- **Business Rules Evolve:** The codebase is highly dynamic, with many business rule changes and customer-specific logic (see change log).
- **External Integration:** Some logic is implemented in external programs (for rounding, VAT, etc.); understand these dependencies.
- **SQL Usage:** Newer features (logistic articles) may use SQL instead of native file access.

## Summary

`JV750R` is a critical, highly configurable program for article pricing and margin calculations in a wholesale/distribution context. It is designed to handle a wide variety of scenarios, with robust error/status handling, and integrates deeply with the master data and pricing infrastructure of the ASVADM system. Understanding its fallback logic, unit handling, and status code system is essential for effective onboarding and further development.