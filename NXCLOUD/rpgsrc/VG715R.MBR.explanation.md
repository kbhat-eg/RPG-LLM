# Documentation for Program VG715R

This program updates the sales statistics (`sstal1`) with an average cost price. It reads records for a given start year, applies various include/exclude criteria for items and warehouses, determines the correct cost price based on specific rules, and saves the computed cost price back to the statistics file. Additionally, it calls external routines (notably `VG711R`) to retrieve or finalize cost data. Below is an overview of how the program works and the core business logic that affects the sales statistics.

---

## Purpose

The overall goal of **VG715R** is to update historical or ongoing sales statistics (in file `sstal1`) with an average or “gliding” cost price. It considers:
- User-specified start year and selection parameters (such as article number, warehouse, or order type).
- Whether to overwrite an existing cost price in the statistics.
- Whether certain order or delivery types require an alternative cost calculation.

The program either uses the existing cost price in `sstal1` or fetches a more precise average cost from another component (“VG711R”). After calculating the correct price, it updates each relevant record in the sales statistics file.

---

## High-Level Flow

1. **Parameter Screen / Initial Checks**  
   - The program presents a parameter screen (records labeled “C2...”).  
   - It validates user inputs:
     - Ensures a nonzero start year (`c2saar`).  
     - Confirms a valid overwrite flag (`c2erst` must be “J” or “N”).  
   - If any check fails, it displays an error message via subroutine `xc1msg` and re-prompts the user.

2. **Reading Sales Statistics**  
   - The file `sstal1` (renamed `sstal1r` internally) is positioned at the selected start year (`c2saar`), using a key list that includes the firm ID (`w_firm`) and the statistics year (`sstal1_aarr`).  
   - The program then reads through each record in the statistics:
     - Skips records if they do not match the user’s article number, warehouse, or order-type criteria (the program supports both “include only” and “exclude” logic based on parameters like `c2lag0`, `c2lagu` for warehouses and similarly `c2oty0`, `c2otyu` for order types).

3. **Determining Proper Cost Price**  
   - If the article is found in the item master (`vvarlr`) but qualifies for special item or delivery types, the program sets the cost to an already-known “sum cost” (`sfsumk`).  
   - Otherwise, it calls a specialized subroutine `hent_gjkost` to determine the average cost price at the specific delivery date. That subroutine:  
     - Chooses which date to use (delivery date, posting date, etc.) and converts it to an ISO-based numeric date.  
     - Calls program `VG711R` to retrieve or calculate a cost component (`w_gjko`), placing the result in `w_gjkp`.  

4. **Unit Conversion**  
   - If the statistics unit (`vvenhs`) differs from the warehouse/base unit (`vvenhl`), the subroutine `beregn_pris` adjusts prices accordingly. It chains to a unit-conversion file (`vvenlr`), applies the appropriate multiplication or division factor (`veomre`), and updates the cost price in `w_gjkp`.

5. **Updating Sales Statistics**  
   - After the cost price is established, the program updates the sales statistics record with the newly computed cost price (`sfgjkp`).  
   - It continues reading the next record until the entire file is processed for the specified criteria.  

6. **Closing & Finalizing**  
   - Once all relevant records are processed, the program sets `w_inlr` to “1” and makes a final call to `VG711R`—presumably to wrap up any open references or calculations.  
   - Returns to the parameter screen tags, and if the user cancels, `*INLR` is set on to end the job.

---

## Key Subroutines and Calls

1. **xc1msg**  
   Handles error messages and function key checks on the parameter screen. If the user presses certain keys, the program branches out to “end_c1msg.”

2. **hent_gjkost**  
   Determines the correct date to use for cost calculation (among fields like `sforda`, `sfpdat`, `sfldat`, or `sfpada`).  
   Invokes `VG711R` with parameters:  
   - Article number (`sfvare`)  
   - Warehouse (`sflage`)  
   - Date (`w_gjdat`)  
   - Cost output variable (`w_gjko`)  
   - Warehouse base unit (`vvenhl`)  
   - The “inlr” flag (`w_inlr`)  

   The returned cost is then placed into `w_gjkp`.

3. **beregn_pris**  
   Adjusts the average cost (`w_gjkp`) from the warehouse/base unit to the statistics unit (or vice versa) by chaining the “vare/enhet” file (`vvenlr`) and multiplying or dividing by the conversion factor (`veomre`).

4. **VG711R**  
   An external program the current job calls to understand or compute “kostpris” (cost price). It is referenced multiple times:  
   - During `hent_gjkost` to retrieve cost data.  
   - After the loop ends to finalize or close data references.  

---

## Domain-Specific Details

- Files:  
  - `sstal1` (Sales statistics)  
  - `vvarlr` (Item master information)  
  - `vvenlr` (Unit conversion details)  
- Fields such as `sfvare`, `sflage`, and `sfotyp` represent article number, warehouse, and order type within the sales statistics.  
- A special “sum cost” (`sfsumk`) may be used for certain deliveries (delivery type 1, 5, or 8) or certain item categories (`sfvtyp` in “S”, “T”, or “D”).  
- The “glidende” cost price is stored in `sfgjkp`. When conditions require a more accurate cost, the program looks up cost data via `VG711R` for a specific date.  

---

## Non-Obvious Conventions & Points of Interest

1. **Selective Record Processing**  
   The program systematically checks include/exclude flags for warehouses and order types. These conditions can be combined (include-only logic versus exclude logic), so the flow can skip many records in `sstal1`.  

2. **Unit Conversion Logic**  
   Conversion is not done automatically in the sales statistics. Instead, `beregn_pris` does a two-step chain for the statistics unit, then (if needed) again for the warehouse/base unit. This ensures the final cost is in the record’s desired unit.  

3. **Double Date Handling**  
   The subroutine `hent_gjkost` checks multiple date fields (`sforda`, `sfpdat`, `sfldat`, `sfpada`). Whichever is valid and largest (≥ the basic order date `sforda`) becomes `w_gjdat`. This logic attempts to capture the latest relevant cost date.  

4. **Closing Steps**  
   After processing, the program calls `VG711R` again with `w_inlr = '1'`. This appears to notify `VG711R` that it should release or finalize resources for the reloaded cost references.  

---

## Summary

**VG715R** is a specialized program for maintaining and refining cost data in a sales statistics file. Its logic revolves around carefully selecting which records to update, determining or fetching the correct cost price, applying unit-of-measure conversions, and writing back to the statistics database. It coordinates with the external `VG711R` program to retrieve cost information at specific dates. This design ensures that cost prices reflect the correct average or sum-based values for each sales record, maintaining reliability and accuracy for historical and ongoing sales data.