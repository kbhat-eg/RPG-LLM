# RPG Code Explanation: FW122R – Mass Creation of New Items for a Supplier

## 1. Purpose and Context

This RPG program, **FW122R**, is used to create or update multiple items (“varer”) for suppliers in the ASLVAR system, with group processing capability. The program presents a workstation screen for user input, checks and processes input fields, updates item records, and handles user navigation and validation.

---

## 2. Files Used

- **flval2**: Supplier item records (main input file)
- **vvarl5**: Item master file
- **flvalu**: Supplier item details (updateable)
- **rlevl1**: Supplier master file (for retrieving supplier names)
- **fw122d**: Workstation display file (user interface)

All files are renamed locally to avoid naming conflicts, and opened with appropriate usage (input/output/update).

---

## 3. Data Definitions

### Parameters (from caller of program)
- **p_firm** – Company Number
- **p_ldor** – Supplier Number
- **p_lvaf** – From Item Number
- **p_lvat** – To Item Number

### Key Variables (for file access)
- **flval2_lvar** – For supplier item file key
- **vvarl5_lvar** – For item master file key
- **flvalu_line** – For supplier item line file key
- **rlevl1_levr** – For supplier master file key

### Other Variables
- **b_feil** – Boolean (error indicator)
- **w_firm/w_ldor** – Working copy of company/supplier no.
- **l_user** – Current user profile, fetched from Local Data Area (LDA).

---

## 4. Program Flow

### Section A: Initialization (`*inzsr`)

- **Receives parameters (company, supplier, from/to item numbers).**
- **Builds key lists** for accessing the respective physical files (item files, supplier file).
- **Copies parameter values into working variables** used throughout the program.

---

### Section B: Opening Screen and User Input

1. **Initial screen values**
    - Assigns parameter values to display variables: supplier number, from/to item number.

2. **Fetches supplier name** (if supplier number given)
    - Chains the supplier master file (`rlevl1`) to fetch the supplier name for display.

3. **Displays the screen** (`exfmt b1bld`)
    - Waits for user input.

4. **Function key handling**
    - If the user presses Cancel or Exit (`*INKC`/`*INKL`), the program ends.

5. **Input field validation**
    - Calls subroutine `sjekk_input` to verify combinations of selection flags. If validation fails, redisplays the screen.

6. **Update processing**
    - If input is valid, calls subroutine `oppdater` to perform group update on item records.

---

### Section C: Input Validation (`sjekk_input` subroutine)

- **Validates mutually exclusive fields**
    - If both selection flags (`b1valh` and `b1valf`) are set, sets error flag and activates error indicator for the display.
    - Exits subroutine.

---

### Section D: Item Update Processing (`oppdater` subroutine)

- **Checks if a hold/flag should be updated**
    - If either flag is set, iterates over the supplier item records (`flval2`), starting from the “from item” value.

- **Iterates through relevant records**
    - For each record in `flval2`, checks:
        - Does the record belong to the correct company and supplier?
        - Is the item number within the specified range (`p_lvat`)?

    - For each valid record:
        - Locates the corresponding item in the master file (`vvarl5`).
        - Locates the supplier line in `flvalu`.
        - Sets the hold code (`fwhkod`); 1 if flag set, else 0.
        - If record found, stamps tracking information (date, time, user), and updates the record.

- **Continues to next record until done**

---

### Section E: Cleanup and Program End

- **Tags for structured branching**
    - `avslutt` tag: Common exit point—sets LR indicator and returns.
    - Uses GOTO to control program flow (e.g., returning to screen on invalid input).

---

## 5. Summary of Key Logic

- **Parameter-driven batch processing** of supplier item records.
- **User interface for confirmation/adjustments** before performing updates.
- **Input validation** to prevent conflicting operations.
- **Iterative update**: For each item in the specified range for a supplier, update a status code and tracking information.
- **Extensive use of subroutines and file operations** (CHAIN, SETLL, READ, UPDATE).
- **Tidy program end and resource cleanup**.

---

## 6. Notable Sections and Comments

- Comments are in Norwegian.
- Code is Classic/RPG IV (fixed format).
- Tracking information (date, time, user) was added as of version 6.10.

---

## 7. Onboarding Note

- To modify validation or update logic, review the corresponding subroutines.
- File layout, field names, and key lists should be cross-referenced with the DDS source for each file.
- Display file (`FW122D`) governs user interface fields and indicators.
- The program expects to be called with the correct parameter types and values from a controlling application or menu.
