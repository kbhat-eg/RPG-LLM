```markdown
# Program RK503R – “Kontaktpersoner, spørring”

This IBM ILE RPG program displays a paginated subfile of contact persons and lets the user select one.  It uses a workstation file (`B1SFL`/`B2CTL`) for subfile control, handles function keys for navigation, and returns the chosen contact’s name, email (and number in version 6.30).

---

## 1. Header & Metadata

- **H-spec**: `option(*nodebugio) datedit(*dmy)`  
- **Program**: RK503R  
- **Description**: “Contact persons, inquiry”  
- **Change log**: Records when email and number fields were added and GUI/rule adjustments.

---

## 2. File Declarations

```rpg
FRUKPL8   IF   E    K   DISK   rename(rukppfr:rukpl8r)
FRK503D   CF   E         WORKSTN  SFILE(B1SFL:W_SRRN)
                    INFDS(dspfbk)
```

- **RU KPL8**: Physical file with key fields `(RUFIRM, RUKUND, RUENAV)`.
- **FRK503D**: Workstation file that defines:  
  - `B2CMD` (control display),  
  - Subfile record `B1SFL`,  
  - Control record `B2CTL`.  
  - `INFDS(dspfbk)`: holds display feedback (e.g. cursor row).

---

## 3. Parameters

Passed on entry via *ENTRY:
- `P_FIRM`, `P_KUND`: firm and customer ID (keys into `RUKPL8`).
- `P_NAVN`: output name (30A).
- `P_EMAL`: output email (50A).
- `P_KPNR` (6.30+): output contact person number.

---

## 4. Indicators & Control Variables

**Indicators usage**  
- LR = end program  
- 10 = Page forward  
- 11 = Page back  
- 21 = Home key  
- 22 = Maintain cursor placement  
- 12/13 = SFL Display/Control  
- 14/15 = SFL Clear/End  

**Subfile paging vars**  
- `W_FCRN`: first record number on current page  
- `W_SPGE`: page size increment  
- `W_SRRN`: relative record number in SFL  
- `W_SFRN`: first record number of last page  
- `W_SSRN`: last record number of last page  
- `W_VIRN`: cursor target position  

---

## 5. Main Program Flow

```rpg
C     B2TAGA       TAG
C                   WRITE   B2CMD         // Display command keys
C     B2TAGB       TAG
C                   EXSR    DSP_SUBFILE   // Show subfile
C   ————————————————————————————————————
C                   SELECT                 // Handle PF Keys
C                   WHEN *INKC/*INKL       // Exit
C                       GOTO AVSLUTT
C                   WHEN *IN10             // Page forward
C                       EXSR CRT_SUBFILE
C                       GOTO B2TAGB
C                   WHEN *IN11             // Page back
C                       EXSR BCK_SUBFILE
C                       GOTO B2TAGB
C                   WHEN *IN21             // Home
C                       EVAL *IN22 = *ON     // Keep cursor
C                       GOTO B2TAGA
C                   ENDSL
C                   IF B2ENAV <> *BLANK    // Direct positioning
C                       EXSR POSISJONER
C                       GOTO B2TAGB
C                   ENDIF
C                   EXSR SUBFILE           // Check selection
C                   IF B_VALG_OK = *ON
C                       GOTO AVSLUTT
C                   ENDIF
C                   GOTO B2TAGA
C
C   AVSLUTT       TAG
C                   EVAL *INLR = *ON
C                   RETURN
```

1. **B2TAGA**: Displays command keys.
2. **B2TAGB**: Invokes `DSP_SUBFILE` to show the subfile page.
3. **SELECT**:  
   - PF10 → `CRT_SUBFILE` (next page)  
   - PF11 → `BCK_SUBFILE` (previous page)  
   - PF21 → reset cursor on page 1  
4. **Positioning**: if user enters a contact name (`B2ENAV`), jump to that record via `POSISJONER`.
5. **Selection**: `SUBFILE` scans for `B1VALG = 1`, captures the chosen contact into parameters, sets `B_VALG_OK`, and exits.

---

## 6. Key Subroutines

### 6.1 CRT_SUBFILE – Fill Next Page

- Increments page boundary `W_SPGE` by `C_SFIL` (10 rows).
- Reads `RUKPL8` sequentially until reaching `W_SPGE` or EOF/different firm/customer.
- For each record:  
  - Increment `W_SRRN`, clear `B1VALG`, move `RUENAV` into `B1ENAV`, email/number, name, role → `B1SFL`.
- Updates `W_SFRN`, `W_SSRN`, `W_VIRN`.

### 6.2 BCK_SUBFILE – Move Back One Page

- Uses keyed read (`SETGT`) to position just after the last record of previous page.
- Reads backwards with `READP` until one page prior.
- Sets `RUKPL8_ENAV` to last record read.
- Clears and rebuilds the subfile from that spot.

### 6.3 CLR_SUBFILE – Clear Subfile

- Sets indicator 14 on, writes `B2CTL` (control record clears SFL).
- Resets `W_SRRN`, `W_SFRN`, `W_SSRN`, `W_SPGE`.

### 6.4 DSP_SUBFILE – Display Subfile

- If `W_SRRN <> 0` then turn on indicator 12 to display SFL; else show only command panel.
- Sets **SF** display indicator 13, issues `EXFMT B2CTL`.
- Reads `D_FCRN` from feedback DS to update `W_FCRN`.

### 6.5 POSISJONER – Position to Specific Contact

- If `B2ENAV` entered, set the file key (`RUKPL8_KEY`) to `(W_FIRM, W_KUND, B2ENAV)` and leave.
- Clears & rebuilds subfile around that entry.

### 6.6 SUBFILE – Check for Selection

- Toggles indicator 22 (cursor placement).
- Loops through all displayed subfile records (`READC B1SFL`):
  - When `B1VALG = 1`, moves values into parms `P_NAVN`, `P_EMAL`, `P_KPNR`, sets `B_VALG_OK`, and exits.

---

## 7. Initialization (`*INZSR`)

- Receives input parms (`P_FIRM`, `P_KUND`, `P_NAVN`, `P_EMAL`, `P_KPNR`).
- Builds key list `RUKPL8_KEY` on `(W_FIRM, W_KUND, RUENAV)`.
- Sets `W_FIRM = P_FIRM`, `W_KUND = P_KUND`, blank `RUENAV`.
- Calls `CRT_SUBFILE` to populate the first page.

---

### Subfile Paging Summary

| Var      | Purpose                                   |
|----------|-------------------------------------------|
| W_FCRN   | First record number on current page       |
| W_SRRN   | Relative record number (current loop)     |
| W_SFRN   | First record number of last loaded page   |
| W_SSRN   | Last record number of last loaded page    |
| W_SPGE   | Page size boundary (increments by 10)     |
| W_VIRN   | Record number where cursor lands          |

Function keys and user input drive a clear–fill–display cycle, letting the operator page through, jump to a contact, and select a record to return name, email, and number.