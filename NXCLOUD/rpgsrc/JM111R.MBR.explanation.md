```markdown
# RPG Program JM111R – Campaign Price Status Check

This IBM ILE RPG program maintains campaign prices and returns a status code (`p_stat`) indicating success or various error conditions.

---

## 1. Header and Change History

- `h option(*nodebugio) datedit(*dmy)`  
  Compiler options: no debug I/O, date format DDMMYY.
- Block comment describes system, program name (`JM111R`), purpose (“Maintain campaign prices, find status code”), and an extensive change log with versions, dates, and authors.

---

## 2. File (Data) Descriptions

Seven files are defined as input-only (`if e k disk`) with rename clauses:

- **JKAVLR** (campaign-item file) renamed to `jkavlr1`
- **JKAHL1** (campaign-header file) renamed to `jkahl11`
- **VVARL1, VVARL3** (item files in EVR)  
- **VVENL1** (unit file in EVR)  
- **JVARL1** (item file in LVR)  
- **JVPkl2** (item-package file in LVR)

These files are chained and read to lookup campaign and item data.

---

## 3. Parameter Definitions

```rpg
dcl-s p_firm    like(jmvfir);   // Company
dcl-s p_vkam    like(jmvkam);   // Campaign ID
dcl-s p_vvar    like(jmvvar);   // Item number
dcl-s p_stat    1 0;            // Status code (output)
```

Version 7.01 adds a price group parameter `p_vprg`.

---

## 4. Local Variables and Keys

- **Working fields**: `w_vvar`, `w_sapr`, `w_lety`, `w_udat`, `w_dato`, etc.
- **Flags**:  
  `b_inlr` – end-of-program flag  
  `b_enhe_ok` – packaging-unit match found  
  `b_pakn` – within package validity dates  

- **Key fields** for chain operations:  
  `jkavlr_vkam`, `jkavlr_vvar`, etc., to build keys for file lookups.

---

## 5. Main Logic Flow

1. **Initialize**  
   - `p_stat = 0` (assume success)  
   - `w_vvar = p_vvar` (working item = input item)

2. **Check LVR Item Exists**  
   - Clear and chain on `JVARL1` with key = `p_vvar`.  
   - If not found, clear record (no error yet).

3. **Load Campaign-Item and Campaign-Header**  
   - Build key `(p_firm, p_vkam, w_prgr, p_vvar)` and chain on `JKAVLR`.  
   - In version 8.01 the header is also read to get the supplier for later logistics check.

4. **Check for “Logistics Item”**  
   - SQL SELECT from `JVKLPF` table by NOBB number to find alternate item and supplier level.  
   - If found, set `w_vvar` = alternate item.  
   - Chain on `VVARL1` (EVR item). If not found, attempt chain on `JVARL1`.  
   - If that yields a `vvarl3` record (NOBB match in `VVARL3`), set `w_vvar = vvvare` there.  
   - If all fail, set `p_stat = 1` (item not found) and exit.

5. **Check Packaging Units in EVR vs LVR**  
   - Loop through units of `w_vvar` in `VVENL1`.  
   - For each unit, read matching package in `JVPkl2` (LVR package file).  
   - Version 6.32 invokes subroutine `sjekk_pkdato` to check from/to dates.  
   - If a matching unit‐package is found, set `b_enhe_ok = *on`.  
   - After loops:
     - If no valid packaging unit found: `p_stat = 2` (unit mismatch) and exit.

6. **Check Campaign Price Presence**  
   - (Commented‐out in current versions) originally tested if campaign price exists, setting `p_stat = 3` if missing.

7. **Check Campaign Price vs Recommended Price**  
   - If `jvpenh` (retail price) is not blank:  
     - Compute a comparison date `w_dato` (use actual date or start date).  
     - Call external program `VP701R` to fetch recommended (`w_sapr`), cost (`w_kopr`), etc.  
     - If campaign‐purchase or campaign‐list price > `w_sapr`, set `p_stat = 4` and exit.

8. **Exit**  
   - Tag `avslutt`: set `*inlr = *on` and return to caller.

---

## 6. Subroutine “sjekk_pkdato”

Purpose: verify that the current date (`w_udat`) falls within a package’s “from”/“to” date range (`jwfdat`, `jwtdat`).

Logic:
1. Assume valid: `b_pakn = *on`.
2. If both dates are low‐valued (`*loval`), accept.
3. If `jwfdat <= w_udat < jwtdat`, accept.
4. If start or end is open (*loval on one side), accept accordingly.
5. Else: `b_pakn = *off`.

---

## 7. Initialization Subroutine (`*inzsr`)

Runs on program entry:
- Defines parameter lists (`plist`) for chain keys:
  - `jkavlr_key`: firm, campaign, price group, item
  - `jkahl1_key`: firm, campaign, price group
  - `vvarl1_key`, `vvarl3_key`, `vvenl1_key`, `jvarl1_key`, `jvpkl2_key` likewise.
- Moves input parameters to working fields (`w_firm`, `w_prgr`, etc.).
- Captures current timestamp into `w_udat`.
- Chains on `JKahl1` to read campaign header into `jkahl11`.

---

### Status Codes (`p_stat`)

0 = OK  
1 = Item not found  
2 = Packaging unit mismatch  
3 = Price missing (older versions)  
4 = Campaign price > recommended price

---
```