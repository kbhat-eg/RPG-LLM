# RPG Source Code Explanation: FO930R – "Utskrift av Pakkseddel" (Packing Slip Print)

This program (FO930R) is an ILE RPG application for IBM i (AS/400) whose main business logic is to produce packing slips (pakkseddel) from sales/packing order information, with extended support for XML/archiving, mailing, and various customer/vendor/project-related customizations.

Below is a guided tour through its most significant parts, design, and business logic. **This explanation covers both the overall flow, the main structures, database files, and how the program manages its tasks.**

---

## 1. **Header Configuration**

```rpg
h option(*nodebugio) datedit(*dmy.) decedit('0.')
h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
/copy hspecsbnd
```
- **Compiler options**: No debug IO, date edit as day-month-year, decimal edit zero-suppressed.
- **Default Activation Group**: No.
- **Binding Directory**: Use CGIDEV2.
- **Copy source**: Includes specifications for binding.

---

## 2. **Change Log Comments**

A detailed audit trail of historical changes, upgrades, and business customizations (R3.12 through 8.08). This is useful for context and troubleshooting.

---

## 3. **File Definitions**

```rpg
FFPSOL1    IPE  E             DISK    RENAME(FPSOPFR:FPSOL1R)
...
FFO930P    O    E             PRINTER
```
- **DISK Files**: Multiple logical and physical files for orders, customers, warehouses, item types, products, etc.
- **Output**: FFO930P for direct printing (the packing slip).

---

## 4. **Data Structures and Working Variables**

- **Keys and Fields**: Multiple data structures for keys, overlays, and individual fields for order/customer/line detail.
- **LDA (Local Data Area) Overlays**: For runtime context (e.g., current user, batch number, output queue, etc.)
- **Parameter Variables** (for print, mail, XML routines).
- **Working Variables**: For company/department info, phone/fax, text lines, flags (e.g., PDF mode), and XML generation buffers.

---

## 5. **Prototype and Utility Copybooks**

```rpg
/copy prototypeb
/copy usec
```
Includes prototypes for external programs and utilities, such as string manipulation, HTML/XML handling, mailing, etc.

---

## 6. **Main Control Logic**

### Case Equivalents / Routing

```rpg
C   01FCYCLE        CASEQ     *ZERO         XSTRSR
C     FKSKOD        CABEQ     'H'           TAG01
C     FKSKOD        CABEQ     'V'           TAG02
C     FKSKOD        CABEQ     'K'           TAG03
C                   GOTO      XSLUTT
```
- **01FCYCLE**: Initialization.
- **FKSKOD**: Switches on the content type:
  - H = Header / Order header
  - V = Varelinje / Line item
  - K = Kommentar / Text Line
- **TAG01, TAG02, TAG03** are routines that process each, then continue or GOTO end (`XSLUTT`).

---

### **6.1. TAG01: Order Header**

- Resets needed flags.
- Sets current time/date for the packing slip.
- Loads order header via `FOHEL1R`.
- Loads customer records; handles overrides for projects, alternative customers, and customer projects.
- Checks/sets various business controls, e.g., if price should be displayed.
- Calls routines to fetch VAT info, payment conditions, warehouse text.
- Loads delivery address, special terms, references, and other fields.
- Assembles all data into fields used for header output or for XML/mailing as needed.
- Handles specific business requirements, such as scanning text fields for XML encoding.

### **6.2. TAG02: Order Line Items**

- Clears variables for the line.
- Loads order detail line via `FODTL1R`.
- Gets line type, checks business constraints (should this line print?).
- Loads item from product master.
- Handles decimal precision, special pricing, discounts, VAT, etc.
- Writes out the line for print or (if b_pdfp=on) XML detail.

### **6.3. TAG03: Text Line (Comments/Notes)**

- Loads the text via `FOTXL1R`, writes it out for print or XML as needed.

### **6.4. T1TOT: Totals Section**

- Handles logic to decide if a new page header is needed before printing totals.
- Writes the totals line, checks for overflow, and, if needed, prints any unsorted text lines at the end.

### **6.5. Print Rest Orders**

- Handles logic to print or output to XML any remaining lines for orders with special "rest-order" status.

---

## 7. **Subroutines (BEGSR/ENDSR blocks)**

- **SBBETB**: Loads text for payment conditions from an external program.
- **skr_leng**: Subroutine to print length specifications (e.g., for cut items or products sold by length).
- **XOVRFL**: Handles overflow (new page header when needed).
- **XSTRSR**: Initialization for each order/document. Sets up keys, loads order/customer type info, checks company settings.
- **XML-related**: Various routines (xml_envm, xml_head, xml_deta, etc.) for building up XML documents used for archiving, mailing, or JasperReports output, including encoding data, controlling structure, and invoking key 'WrtSection' commands for XML tags.
- **hnt_avde**: Lookup and load department info for XML/document tags.

---

## 8. **Business Logic Nuances**

- **Mail Integration**: If a document is to be sent by email, the program fetches mail server settings, mail addresses, builds up the mailing instructions.
- **JasperReports Integration**: If PDF/Jasper mode (b_pdfp=on), much of the output is written as XML for the JasperReports engine or for archival (document management, digital mail, etc.).
- **Rich Handling of Data and Overrides**: Document header/customer info can be highly customized per project, customer, department, or document type.
- **Restnoted Orders**: Special logic for orders with unfulfilled/rest quantities.
- **Overflows**: Full page tracking and header reprints for physical forms.
- **Data Conversion**: Heavy use of string scanning/conversion via AP613R to ensure text is XML-safe and properly encoded.
- **Meta-data for Archiving**: When archiving, the program writes meta tags and summary info for later retrieval/search.
- **Simultaneous Print and Archiving**: Supports both hard copy and XML document outputs depending on run-time flags and settings.
- **Multi-language/Locale Support**: Uses date edit, field decimals, and string scanning to support Norwegian and perhaps other configurations.

---

## 9. **Coding Style**

- **Legacy RPG C-specs**: The main logic is classic C-specification, with some /Free logic in XML routines.
- **InzSR**: Standard initializations for all fields, keys, and overlays.
- **Business Segregation**: Each major action (header, line, text, totals, restlines) is its own tag/routine, with subroutines for repeated business logic.

---

## 10. **How It All Flows (Put Together)**

1. The program is called for batch or interactive processing for one or more orders.
2. Loads Local Data Area (LDA) for print/mailing context.
3. Loops or is driven by case/by FKSKOD to process header, lines, and text as needed.
4. For each section:
    - Loads and prepares info from database files.
    - Calls out to external programs as needed (for VAT, text, payments, customer/project info, etc.)
    - Builds output for either print or XML/Jasper, or both.
5. Handles overflow (page breaks).
6. Handles rest-orders specially.
7. Writes meta-data if archiving.
8. If mailing, builds and launches mail.
9. Ends by logging actions, updating job status, and cleaning up.

---

## 11. **External Programs & Integration**

- **Mail**: AM705C (fetch mail server), FO798R/FM798R (mail data), AP621R (preview), CO402R (mail logic).
- **XML/Archiving**: AP609R (Jasper/XML setup), GetHTMLIFS, WrtHtmlToStmf (HTML/XML output), AP629C (data queue trigger).
- **Customer/Project/Payment/Terms**: FO705R, F0703R, F0707R, F0710R, RS710R, RS718R, FO780R/FO781R (weight/volume).
- **Text encoding**: AP613R for safe output in XML/HTML.

---

## 12. **Summary Table of Key Objects**

| Object            | Purpose / Notes                                    |
|-------------------|----------------------------------------------------|
| FFO930P           | Output printer file (packing slip)                 |
| FPSOL1 / FOHEL1   | Order headers                                      |
| FODTL1            | Order details / lines                              |
| FOTXL1            | Order text lines                                   |
| RKUNL1            | Customer master                                    |
| VVARL1            | Product/item master                                |
| FSTSL1            | Status/lookup                                      |
| FKPRL1            | Project/cust.project info                          |
| Various APIs      | VAT, payment, length, mail, archiving, etc         |
| Data Structure/DS | For key overlays, status flags, local context      |
| LDA               | Context for current print/mail/archiving job       |

---

## 13. **Customization/Extensions**

This program is **highly customized** with many business rules toggled via company, customer, or project flags, and is robust in supporting external integrations (Jasper, mail, archiving) and both physical and digital document output.

---

## 14. **Onboarding Advice**

- **Learn the key fields**: Order, customer, product, and "status flag" fields drive the flow.
- **Understand the case routing:** FKSKOD and TAGxx routines direct the business logic; follow these for main process insight.
- **XML routines are modular**: Each XML section (header, detail, rest, text) is handled by its own subroutine for clarity and extensibility.
- **Subroutines (BEGSR/ENDSR) hold reusable logic**: Look here for payment, overflow, mail, and XML output code to understand or extend.
- **Read the change log**: Comments provide historical context for many business requirements.
- **External program calls** are fundamental to behavior: Know what they do (mail, text, payment, etc.) to fully grasp the program's outputs.

---

## 15. **Final Notes**

This is a mature and business-heavy RPG application that mixes classic RPG with modern output needs (email, XML, digital archive). While the code is large and complex, the routing is logical, subroutines are well-isolated, and comments/documentation are good.

For new developers:
- **Trace a single document through header → detail → text line → totals** for a first run-through.
- **If working on output, focus on the b_pdfp flag** to know if you’re affecting printed, XML, or both outputs.
- **When extending**, ensure you consider both print and XML/Jasper needs, and business rules for alternate customers, projects, etc.

---

**If you need a deep dive into a particular section (mail, XML output, a subroutine), just ask!**