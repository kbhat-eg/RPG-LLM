# RPG Program FD506R – Line Deletion Details

This source code is an ILE RPG (also known as RPG IV) program for IBM i (AS/400) systems. Its main function is to display detailed information about a deleted order line, calculating discounts and related data for display, and honoring user permissions on sensitive information.

The program is thoroughly commented (in Norwegian). Below is a structured explanation of its components, data flow, and logic.

---

## 1. Control Specifications (`H` and comments)
```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: Disables debug data for files, improving performance.
- `datedit(*dmy)`: Sets date edit format to day/month/year.

The comments at the top document:
- System, program, and description.
- History of changes and enhancements.

---

## 2. File Declarations (`F` specs)
The program accesses several database physical files, with each being renamed for local usage:
```rpg
ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
ffdesl1    if   e           k disk    rename(fdespfr:fdesl1r)
ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
```
- All are input, keyed files.
- `fd506d` is the display file (for workstation user interface).

---

## 3. Data Definitions (`D` specs)

### 3.1. Data Area Extraction
```rpg
d                uds
d l_user                911    920
d l_fnav                951    980
```
- Declares a data structure overlaying the user space (likely to extract user info).

### 3.2. Parameters and Working Variables
Program parameters and their local copy:
```rpg
d p_firm          s                   like(fsfirm)
d p_aarr          s                   like(soaarr)
d p_kund          s                   like(fskund)
d p_numm          s                   like(fsnumm)
d p_suff          s                   like(fssuff)
d p_line          s                   like(fsline)
```
- These are passed into the program, representing company, order, customer, line, etc.

Variables for key fields and work fields (discounts, net values, etc.) are declared.

---

## 4. Main Logic (`C` specs)

### 4.1. Initialization and Key Setup
- The `*inzsr` subroutine is the initialization section, executed before main logic. It:
  - Reads program parameters.
  - Sets up key lists for file I/O.
  - Reads the current user from the data area.
  - Prepares company code.

### 4.2. Entry Point
- Parameters are read from the caller (another program or CL command).

### 4.3. Load Deleted Line Details
- Uses the passed keys to `CHAIN` (random access by key) into the deleted order line file (`fdesl1`).
  - If not found, program jumps to end (`goto avslutt`).

### 4.4. Lookup and Data Gathering
- Retrieves related product (`vvarl1`), supplier (`rlevl1`), and group (`vugrl1`) information for display.
- Calls program `'VE711R'` to fetch the EAN number (product barcode).

### 4.5. Copy Data to Screen Variables
- Copies data from files into the variables (likely part of the screen or print layout), e.g. `b1numm`, `b1otyp`, etc.

### 4.6. Discount Calculations (Line and Totals)
- Calculates cascading line and total discounts (`rab1`, `rab2`, `brr1`, `brr2`) progressively:
  - Discounts are applied sequentially, reducing the base after each step.
  - Results are stored in both per-unit and total values (`b1rkr1`, `b1srk1`, etc.).
  - Final net values are computed after all discounts.

### 4.7. Sensitive Data Masking
- If the user is not authorized (`fbko01 = 0`), cost price and contribution margin fields are zeroed out.

### 4.8. Supplier and Group Descriptions
- Looks up the supplier name and product group description to include in the display.

### 4.9. Deletion Metadata
- Loads details about who deleted the line and when.

### 4.10. Display Loop
- Displays the screen (`exfmt b1bld`), pausing for user input.
- Handles common exit function keys (`*inkc`, `*inkl`), then ends.

---

## 5. Program Termination
- Sets the last record indicator (`*inlr = *on`) and returns, cleaning up the program.

---

## 6. Key Lists 
- All database access is performed via named key lists, improving maintainability and clarity.

---

## 7. Summary of Flow

1. **Initialization**
   - Read parameters, set up keys, read user info.

2. **Main Processing**
   - Look up the deleted order line.
   - Retrieve supplemental data (product, group, supplier, barcode).
   - Calculate discounted prices, net values.
   - If not authorized, hide sensitive values.
   - Populate display fields.

3. **Display and Exit**
   - Show details to user.
   - Await exit command.

4. **Cleanup**
   - End program and set cleanup indicators.

---

## 8. Special Points

- **Extensive Customization**: The program shows signs of being adapted for newer fields and longer keys over time.
- **Norwegian Comments**: Useful for local developers; field names are typically abbreviations (e.g., `fsnumm` = order number).
- **Call to External Program**: Barcode lookup (`VE711R`) is delegated via subprogram call.

---

## 9. Usage Scenario

This program would be called when a user wants to view the details of a deleted order line, perhaps for audit or customer service reasons. It aggregates information from multiple reference files (products, customers, suppliers, users) and presents a full snapshot, including step-by-step discount breakdowns.

---

## 10. Onboarding Advice

- **Know the Database Structure**: Field and file naming conventions are crucial.
- **Understand Norwegian Terms**: Many comments and variables are in Norwegian.
- **Familiarize with RPG Keyed Access**: `CHAIN` and key lists are the main method for loading data.
- **Be Aware of Authority Handling**: Certain info is masked based on the user's permissions.
- **Discount Flow Is Sequential**: Each discount is applied on the result of previous discounts, both for line and total.

---

**In summary:**  
The program is a classic RPG “display details” routine for deleted order lines, heavily relying on file lookups and sequential discount calculations, enhanced with security checks and multi-language/documentation support. The main work is to assemble all related values for a line and present them in a user-friendly way for review or audit.