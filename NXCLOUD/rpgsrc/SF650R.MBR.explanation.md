# SF650R – Documentation

## Overview

**Program:** SF650R  
**System:** ASOFAK  
**Description:** "Utskrift av bruksrettytelser" (Printing of usage rights/entitlements)

This program is a user-driven report generator for usage rights, allowing users to enter selection parameters via a workstation display, validate those parameters, and then launch downstream routines for further processing and output. The program also handles job queueing and interacts with other programs and the system's Local Data Area (LDA).

---

## Structure and Flow

1. **Initialization (`*inzsr` subroutine):**
   - Sets up the LDA for output.
   - Resets working variables.

2. **Screen Parameter Entry:**
   - Prompts the user for selection parameters (year, date range, variant, etc.).
   - Validates and normalizes input.
   - Handles function keys for exit and job queueing.
   - Stores validated parameters in a packed data structure for downstream processing.

3. **Program Invocation:**
   - Calls another program (`AP600R`) to process or print the selected data.
   - Optionally calls a subprogram (`SF652C`) for further processing or job queueing.

4. **Exit:**
   - Cleans up and returns control to the caller.

---

## Key Data Structures

### Workstation File

- `sf650d` – Workstation file for user interaction (screen display/input).

### Selection Parameter Structure

- `ldprec` – 64-byte parameter area for passing selection criteria.
    - `ldalme` (4,0) – Possibly a user or client number.
    - `ldpaar` (4,0) – Year parameter.
    - `ldfdat` (10d, ISO) – "From" date.
    - `ldtdat` (10d, ISO) – "To" date.
    - `ldvari` (1,0) – Variant code (controls downstream logic).

### Local Data Area (LDA)

- Used to pass control information and parameters between programs.
    - `l_ruti` (800–809) – Routine name to be called by downstream program.
    - `l_chgv` (844) – Change/view indicator.
    - `l_sfir` (944–946, 0) – Firm/company code.

### Working Variables

- `w_firm` – Local copy of firm code.
- `w_fdat`, `w_tdat` – Working copies of "from" and "to" dates.
- `w_valg` – Option flag (set if job is to be queued).
- `w_in03`, `w_tvbt`, `w_btch` – Work variables, possibly for function key or batch handling.

---

## Core Logic

### 1. User Input and Validation

- The user is prompted for:
    - Year (`b1paar`)
    - "From" date (`b1fdat`)
    - "To" date (`b1tdat`)
    - Variant (`b1vari`)
- Defaults are set for these fields if not entered:
    - Year defaults to current year.
    - "From" date defaults to Jan 1 of current year.
    - "To" date defaults to Dec 31 of current year.
    - Variant defaults to 1.
- Dates are validated:
    - If blank, set to today’s date.
    - Date format is checked; if invalid, user is reprompted.
    - "From" date must not be after "To" date.
    - If "To" date is zero, it is set to the highest possible value to include all dates.

### 2. Parameter Preparation

- Validated user input is packed into the `ldprec` structure for downstream use.
- LDA fields are set:
    - `l_chgv` is set to '1' (indicating "view only" mode).
    - `l_ruti` is set based on the variant:
        - If variant = 1, calls routine `SF654`.
        - Otherwise, calls routine `SF653`.

### 3. Downstream Program Calls

- **`AP600R`:** Main report/processing program. Receives routine name, change/view flag, and work variables.
- **`SF652C`:** Subprogram for additional processing or job queueing. Receives parameter structure and option flag.
- If F4 is pressed (`*INKD`), job is flagged for queueing.

### 4. Program Exit

- On function key press (`*INKC`), program jumps to clean-up and sets LR indicator.

---

## Notable Patterns and Conventions

- **Parameter Passing:** Uses a packed data structure (`ldprec`) and LDA fields to pass parameters between programs, which is a common pattern in legacy RPG systems.
- **Routine Selection:** Uses a variant code to select between different downstream routines (`SF654` or `SF653`), allowing one entry point to handle multiple report types.
- **Screen Handling:** Uses workstation file and display formats (`exfmt b1bld`) for user interaction.
- **Error Handling:** Validation errors set indicators and loop back to the input screen, rather than aborting execution.
- **Job Queueing:** Supports both immediate and queued processing, controlled by function keys and option flags.

---

## External Dependencies and Interactions

- **Workstation File (`sf650d`):** For screen display and input.
- **Programs:**
    - `AP600R` – Main report/processing program.
    - `SF652C` – Subprogram for additional or batch processing.
- **Data Areas:**
    - LDA (`*LDA`) – Used for inter-program communication.
    - Data area output (`out *dtaara`) writes parameter values for use by downstream programs.
- **Function Keys:** Special handling for F3 (exit), F4 (queue job), and validation errors.

---

## Business/Domain Logic

- The program is tailored for printing or processing "bruksrettytelser" (usage rights/entitlements), likely in a legal, real estate, or utility context.
- User can select a client/user, year, date range, and variant for the report.
- Variants control which downstream routine is invoked, providing flexibility for different report types or processing modes.
- Supports both interactive and batch processing.

---

## Key Takeaways for New Developers

- **Parameter Handling:** Most inter-program communication is done via packed structures and LDA fields. Understand the overlay and mapping of these fields.
- **Screen-Driven Workflow:** Expect most user interaction to occur via workstation files and display formats, with validation and error handling looping back to the screen.
- **Downstream Calls:** The main business logic (report generation, etc.) is delegated to external programs. This module’s main function is parameter collection and validation.
- **Customization:** The program is designed to be easily customized or extended (e.g., by adding new variants or routines).
- **Error and Exit Handling:** Uses function key indicators and explicit tags for flow control.

---

## Additional Notes

- The code is written in RPG IV (ILE RPG), but with fixed-format C-specs and D-specs, indicating a legacy codebase.
- Comments and some variable names are in Norwegian; familiarity with business terms in this language will be helpful.
- Some variable names and overlays are cryptic—refer to the wider codebase or documentation for precise field meanings if needed.

---

**For further understanding, review the downstream programs (`AP600R`, `SF652C`, `SF654`, `SF653`) and the structure of the workstation display file (`sf650d`).**