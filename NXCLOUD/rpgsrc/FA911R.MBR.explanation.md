# Documentation: ASOFAK / FA911R â€“ Rounding Sales Price Including VAT

## Overview

This subprogram (`FA911R`) is responsible for rounding sales prices (including VAT) according to a complex set of business rules. It is a critical component in the Byggmakker system, supporting price calculations that must comply with various customer, product, and supplier-specific rounding requirements. The program is invoked as a subroutine, receiving parameters that identify the context (e.g., product, supplier, groupings) and the base price(s) to be rounded.

## Business Purpose

- **Domain**: Retail/Wholesale (Byggmakker)
- **Function**: Rounds a price (or multiple prices) according to a prioritized set of rules, which may depend on product, supplier, organizational groups, and other attributes.
- **Use Case**: Applied when calculating or presenting sales prices to ensure consistency with business pricing policies, especially for prices including VAT.

## Key Data Files

- **JAV1L1**: Holds rounding rules (`jav1pfr` physical file, renamed as `jav1l1r`).
- **JAV3L1**: Contains rounding parameters (`jav3pfr` physical file, renamed as `jav3l1r`).
- **JLEVL1**: Supplier lookup (`jlevpfr` physical file, renamed as `jlevl1r`).

## Parameter Structure

The program is called with a set of parameters (via *ENTRY PLIST):

- Identification fields: company, organizational group, main group, subgroup, supplier, module, item number.
- Up to three price values (`p_s1im`, `p_s2im`, `p_s3im`) and their corresponding units (`p_enh1`, `p_enh2`, `p_enh3`).
- Type indicator (`p_type`), used when selecting which price/unit to round.

## Core Logic

### 1. Supplier Check

- The program first checks if the supplier exists in `JLEVL1` using the input supplier number.
- If the supplier is not found, the program exits without adjusting prices.

### 2. Rule Lookup (JAV1L1)

- The main business logic is a prioritized search for a matching rounding rule in `JAV1L1`.
- The search is hierarchical, starting from the most specific (supplier + item) to the most general (organizational group only).
- Each search step sets key fields to either the input value or a default (`*zero` or `*blank`), then attempts a `CHAIN` to `JAV1L1`.
- If no rule is found, or the rule number is zero, the program exits with no rounding.

#### **Rule Search Priority Table**

| Priority | OGRP | HGRP | UGRP | LEVR | MODU | VARE | Description                         |
|----------|------|------|------|------|------|------|-------------------------------------|
| 1        | -    | -    | -    | x    | -    | x    | Supplier + Item                     |
| 2        | -    | -    | -    | -    | -    | x    | Item only                           |
| 3        | -    | -    | -    | x    | x    | -    | Supplier + Module                   |
| 4        | -    | -    | -    | -    | x    | -    | Module only                         |
| 5        | x    | x    | x    | x    | -    | -    | OGRP, HGRP, UGRP + Supplier         |
| 6        | x    | x    | -    | x    | -    | -    | OGRP, HGRP + Supplier               |
| 7        | x    | -    | -    | x    | -    | -    | OGRP + Supplier                     |
| 8        | -    | -    | -    | x    | -    | -    | Supplier only                       |
| 9        | x    | x    | x    | -    | -    | -    | OGRP, HGRP, UGRP                    |
| 10       | x    | x    | -    | -    | -    | -    | OGRP, HGRP                          |
| 11       | x    | -    | -    | -    | -    | -    | OGRP only                           |

- If no rule is found after all steps, no rounding is performed.

### 3. Special Rule Checks

- **NOBB Calculation**: If the supplier record (`JLEVL1`) indicates calculation should be from NOBB (`jlkkal = 1`) and the rule does not allow it (`ja1nob = 0`), the program exits.
- **Unit Matching**: If the rule specifies a unit (`ja1enh`), the program selects the corresponding price/unit from the three provided. If no match, defaults to the first.

### 4. Rounding Parameter Lookup (JAV3L1)

- Using the found rule number (`ja1rgl`), company, and the selected price, the program locates the appropriate rounding parameters in `JAV3L1`.
- The search uses a reverse-ordered read (`READP`), beginning at the current price, to find the nearest lower rounding breakpoint.

### 5. Price Calculation

- The actual rounding is performed using the parameters from `JAV3L1` and the found rule.
- The calculation involves several steps:
    - Determine the number of increments (`w_fraa`) between the base and the rounding breakpoint.
    - Calculate the rounded price (`w_utgp` / `w_utgpd`).
    - Calculate the rounding threshold (`w_gren`).
    - If the original price is below the threshold, use the calculated price; otherwise, increase by one rounding increment.
- The result is written back to the appropriate output parameter, depending on which unit/price was selected.

### 6. Output

- The rounded price is placed in the appropriate parameter (`p_s1im`, `p_s2im`, or `p_s3im`), depending on the matched unit/type.
- If no rounding was performed, output parameters are left unchanged.

## Design Decisions and Conventions

- **Rule Prioritization**: The program implements a strict, stepwise rule search. This ensures the most specific rule is always applied if present, falling back to more general rules.
- **Unit/Price Flexibility**: By supporting up to three prices/units, the program can handle items sold in multiple units of measure.
- **No LR (Last Record) Usage**: The program is designed as a subroutine, so it does not set LR, ensuring it can be called repeatedly within a job.
- **Parameter Passing**: All input and output is via the parameter list, ensuring stateless operation between calls.
- **Backward Compatibility**: Extensive comments and versioning in the header document adjustments for Byggmakker and other business-specific changes.

## Interactions

- **JAV1L1**: Rounding rule lookup.
- **JAV3L1**: Rounding parameters (breakpoints and increments).
- **JLEVL1**: Supplier-specific configuration, especially for NOBB calculation handling.

## Maintenance Notes

- Rule and parameter files must be kept up-to-date to ensure correct rounding.
- Changes in the business logic (e.g., new rule priorities, new units) require careful adjustment of the rule search sequence and parameter handling.
- The code uses some hardcoded logic for unit selection and parameter matching; changes to the unit logic will require code updates.

## Summary

This program encapsulates the business logic for price rounding in the Byggmakker system, handling a complex matrix of rules and exceptions. It is designed for robustness, flexibility, and ease of integration with other pricing modules, and is heavily reliant on up-to-date and accurate rule/parameter master data.