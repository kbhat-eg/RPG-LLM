# Overview  
Program VP712R retrieves pricing details (sales price, cost price, purchase prices, store price) for a given item (“vare”) and vendor/unit combination. It replaces the older VP701R and is tailored to the ASOFAK system. Key inputs include company, price group, item number, vendor/distribution unit, delivery type, effective date and a flag controlling LR release.  

# Parameters  
- **Input**  
  - p_firm (company)  
  - p_prgr (price group; expanded from 1 to 2 positions in v8.01)  
  - p_vare (item number)  
  - p_ldor (unit or warehouse code)  
  - p_lety (delivery type)  
  - p_dato (effective date; defaults to current time if blank)  
  - p_hlev (flag to force use of main vendor price)  
  - p_inlr (LR‐flag; controls setting of *inLR)  

- **Output**  
  - p_sapr (sales price)  
  - p_bupr (store price)  
  - p_kopr (cost price)  
  - p_inpr (primary purchase price)  
  - p_inp2 (secondary purchase price; added in v6.30)  

# High-Level Flow  
1. **Initialize**  
   - Load company, date, unit, and item into work fields.  
   - Zero out all output parameters.  

2. **Price Lookup**  
   - If `p_hlev = '1'`, use main vendor code (vvldor) directly; otherwise attempt:  
     1. Lookup for the specified warehouse/unit (`p_ldor`)  
     2. (Commented out in v6.22+) Fallback to main vendor, then “vendor = 0”  
   - Subroutine `hent_pris` is called to fetch the appropriate price record.  

3. **No-Price Abort**  
   - If no price is found (`b_pris = *off`), exit immediately.  

4. **Cost Price Fallback**  
   - If `p_kopr = 0`, retrieve a margin percentage (`vvdekn`) from either the item or its subgroup via files VVARL1 and VUGRL1.  
   - Compute cost price as `p_kopr = p_sapr – (p_sapr * margin / 100)`.  

5. **LR Flag**  
   - If `p_inlr <> *on`, set *INLR to *ON before returning.  

# Subroutine: hent_pris  
Encapsulates flexible lookup across the VVPRL1 “item pricing” file. Logic:  
1. **Set keys** using work fields: item, price group, unit, delivery type.  
2. **READ-E** from VVPRL1 until an effective‐date match (`w_dato >= vppdat`).  
3. **On first match**: set `b_pris = *on` and move prices into output parms.  
4. **Fallback strategies** (all coded but commented for readability):  
   - If no record for given delivery type, retry with `lety = 0`.  
   - If still no record and price group ≠ blank, retry with `prgr = *blank`.  
   - Repeat above with `lety = 0` and `prgr = *blank`.  

# File Relationships  
- **VVPRL1** (alias VVPRL1R): Pricing master file keyed by firm, item, price group, unit, delivery type, effective‐date.  
- **VVARL1** (alias VVARL1R): Item master file; used to fetch a default margin % (`vvdekn`) when cost price is zero.  
- **VUGRL1**: Subgroup master; used when item‐level margin = 0 or missing.  

# Domain-Specific Notes  
- **Price Group Expansion** (v8.01): Upgraded from 1 to 2 characters to accommodate new group codes.  
- **Secondary Purchase Price** (`p_inp2`): Introduced in v6.30 for split‐rate purchases.  
- **Removal of Auto‐Set**: v6.23 removed logic that defaulted `p_inpr = p_kopr` when `p_inpr = 0`.                                               
- **Main Vendor Override**: Controlled by `p_hlev = '1'`. Used when switching primary vendor requires overriding unit‐level pricing.  

# Design Conventions  
- **Flag Variables** (`b_pris`, `b_inlr`): Simple indicators (`*on/*off`) to control flow.  
- **Error Exit**: Uses `GOTO avslutt` if no price found.  
- **Date Handling**: Blank date defaults to current time; subsequent comparisons determine record validity.  
- **Chaining & SetLL/ReadE**: Standard chain/read‐equal loops for keyed files with separation of key setup and record reads.  

This structure ensures that pricing is retrieved with robust fallbacks, supports multiple price groups and delivery types, and computes missing cost prices from configured margin percentages.