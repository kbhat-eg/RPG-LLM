# RPG Program EM112R: Bonus Template Copy â€“ Overview and Walkthrough

This program is written in traditional ILE RPG (also known as RPG IV) and is used to update customer categories with a "bonus template" (bonusal mal) in an IBM i (AS/400) environment. The comments and variable names are in Norwegian, but the logic is clear.

---

## 1. **Purpose and Context**

The program copies bonus definitions (and their details) from a template to a specific customer, updating the customer's bonus categories as needed. It is typically called by another program, to which it returns after updating the database tables corresponding to bonus templates and customer bonuses.

---

## 2. **File Declarations**

At the top, several files are declared. They represent physical or logical database tables, with short 6-8 character names. The `rename()` clause allows the use of external record formats with internal names.

- Files such as `ekboiu`, `ekboic`, etc. represent bonus information for customers.
- Files such as `embeir`, `embdir`, `embhi1` represent bonus templates and their details.
- `rkunl1` is the customer master file.

Example:
```rpg
fekboiu    uf a e           k disk    rename(ekbost:ekboiur)
```
- `uf a e k disk`: User, Full procedural, externally described, keyed, disk file.
- `rename(ekbost:ekboiur)`: Rename external format `ekbost` to `ekboiur`.

---

## 3. **Work Fields and Data Structures**

### Local Data Area (LDA)
The program overlays fields over the system's LDA for runtime values:
- `l_dato`, `l_tek1`, `l_tek2`, `l_tek3`: Date and text segments.
- `l_user`, `l_firm`, etc.: Current user, firm, etc.

### Display Feedback
- `dspfbk`: Structure for display feedback usage (not heavily used here).

### Variables for Keys and Working Fields
- Many variables (e.g. `embeir_ebot`, `ekboiu_bkun`, etc.) are defined as having the same data type (`like(...)`) as fields in the files, ensuring matching data types for I/O.

### Flags and General Variables
- `b_bonus`: Set *on when a new bonus is written.
- Dates: `w_udat`, `w_date`, etc., used for date/time formatting.
- Parameters (e.g., `p_kund`, `p_tbot`, etc.): Passed from the calling program.

---

## 4. **Constants and Indicator Usage**

There's a detailed comment at the top describing indicator usage (LR, 10, 11, etc.), mostly for display file handling, though this program is batch-oriented and does not use them all.

---

## 5. **Main Logic Flow**

### **a. Initialization (`*inzsr`)**

- Handles entry parameters:
    - Customer number, template type, template number, bonus category, valid-from/to dates.
- Defines key lists for files (with `klist` and `kfld` statements).
- Retrieves the company (`w_firm`) from the LDA.
- Grabs the current date/time.

### **b. Main Program Routine**

1. **Check for Bonus Categories in Template**
    - Sets `embhi1_hbot` and `embhi1_hmnr` to the template type and number.
    - Reads the bonus template header (`embhi1_key chain embhi1`).
    - If the bonus category matches (`emhbka = p_hbka`), continues.

2. **Prepare Valid-From/To Dates**
    - If valid-from or valid-to is provided, use those; else use the lowest date value.

3. **Delete Existing Customer Bonus Records**
    - Calls subroutine `del_bonus` to remove outdated customer bonus records for this bonus type unless locked.

4. **Copy Template to Customer**
    - Calls subroutine `add_bonus` to copy the template bonus and its details to the customer.

5. **Program End**
    - Sets the last record indicator `*inlr = *on` to end the program.

---

### **c. Subroutine: `del_bonus`**

- Loops through all bonus records for the customer (`ekboic`).
- If a record is not locked (`eksper <> 1`), deletes related bonus detail records (`ekbeiu`) and then deletes the main record (`ekboicr`).

---

### **d. Subroutine: `add_bonus`**

- Reads all "element" records (`embeir`) for the template.
- For each, either updates or inserts a main customer bonus record (`ekboiu`) (if not found, creates a new one).
- For each template element, reads corresponding "detail" records from the template (`embdir`), creates customer bonus detail records (`ekbeiu`).
- Uses supplied or template dates as valid-from/to.
- If a bonus was successfully copied, updates the customer's bonus type register (`ekbtiu`).

---

### **e. Key Lists**

- Key lists (named sections with `klist`) are used to build composite keys for database file operations (`chain`, `setll`, `reade`).
- Key fields are constructed using the work variables and parameters.

---

## 6. **Programming Techniques**

- **Procedural RPG:** Uses cycle control, explicit subroutines, and old-style field movement (`move`, `eval`).
- **Parameters via PLIST:** Receives input via parameter list at program entry.
- **Data Consistency:** Always checks for locked ("sperret") records before updating/deleting.
- **Date Handling:** Date formatting and field mapping for valid-from/to dates handled carefully.
- **Indicator Usage:** Minimal, as most logic is data-driven, not display-driven.

---

## 7. **Summary of the Data Flow**

1. **Input:** Customer number + template type/number + bonus category + valid-from/to dates.
2. **Delete phase:** Remove all old bonuses for the customer in this bonus category that are not locked.
3. **Copy phase:** For every element in the template, create or update corresponding customer bonus entries and all their details.
4. **Customer bonus type register:** Add or update as necessary based on whether any bonuses were copied.

---

## 8. **Key RPG Operations Used**

- `chain`: Read by key.
- `setll`: Position to key.
- `reade`: Read next equal record.
- `delete`, `update`, `write`: Modify database files.
- `eval`, `move`, `clear`: Variable assignment and clearing.
- Date/time functions: `time`.

---

## 9. **Key Takeaways for New Developers**

- Every file access is carefully keyed; the business logic is highly data-driven.
- The structure is modular: clear separation of initialization, deletion, and addition.
- All fields for I/O are strongly typed by referencing file definitions.
- All changes are made only if the records are not marked as "locked".
- User and firm context is managed via LDA.

---

## 10. **Typical Use Case**

- A user or batch job wants to provision a customer with a bonus structure defined in a template. This program is called with the required parameters; it removes any existing non-locked bonuses for that type from the customer and copies the entire template (and all its details) into the customer's bonus files.

---

## 11. **References to Look For**

- **Bonus Template Files:** `embhi1`, `embeir`, `embdir`
- **Customer Bonus Files:** `ekboiu`, `ekboic`, `ekbeiu`
- **Type/Category Registers:** `ekbtiu`
- **Customer Master:** `rkunl1`

---

## 12. **Further Modernization**

If you plan to modernize or maintain this code:
- Consider refactoring to free format RPG (RPGLE).
- Document business rules in English for broader understanding.
- Migrate LDA use to data structures or procedures.
- Add logging and error handling, as currently all errors are ignored.

---

**In summary:**  
This program is a "template-to-customer" copier for bonus category records, ensuring updates are only performed on non-locked records, and maintains data consistency through careful key-based file operations. It is typical of business-critical, batch-oriented RPG applications on IBM i systems.