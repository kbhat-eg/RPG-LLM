# RPG Program Explanation

This RPG (Report Program Generator) program is designed to **delete records** from a physical file named `rbunlu`. It filters records based on a few key fields: "memb" (most likely meaning "member"), "firm" (company), and "bunt" (batch).

Below is a line-by-line explanation to help a developer get up to speed.

---

## **Program Overview**

- **Purpose:**  
  The program deletes records from the file `rbunlu` that match specific values for the member, firm, and batch number fields.

- **Title & Comments:**  
  The `/TITLE` and comments specify that this is a delete utility for `rtrapf`, only deleting entries matching the supplied batch number, with checks for firm and member.

---

## **File Definition**

```rpg
frbunlu    uf   e           k disk
```
- **frbunlu**: File name for the disk file (`rbunlu`).  
- **uf**: Update, Full procedural, File is used for reading and updating (deleting records).  
- **e**: External description (uses the external DDS layout).  
- **k**: File is keyed.

---

## **Data Definitions**

### Work Fields (Variables)

```rpg
d rbunlu_nivo     s                   like(rsnivo)
d rbunlu_memb     s                   like(rsmemb)
d rbunlu_firm     s                   like(rsfirm)
d rbunlu_bunt     s                   like(rsbunt)
```
- These are local variables defined to match the field types of the corresponding fields in the record format (`rsnivo`, `rsmemb`, etc.).

```rpg
d w_memb          s             10
d w_bunt          s                   like(rsbunt)
```
- **w_memb**: Input parameter for member.
- **w_bunt**: Input parameter for batch.

```rpg
d                uds
d l_firm                944    946  0
```
- **l_firm**: Three-digit field, presumably holding the firm number to work against.

---

## **Key List Definition**

```rpg
c     rbunlu_key    klist
c                   kfld                    rbunlu_nivo
c                   kfld                    rbunlu_memb
c                   kfld                    rbunlu_firm
c                   kfld                    rbunlu_bunt
```
- **rbunlu_key**: Composite key to access the file.  
  The key comprises level (nivo), member, firm, and batch.

---

## **Main Logic**

### Position to the First Record

```rpg
c     rbunlu_key    setll     rbunlu
```
- Set lower limit (SETLL) using the built key (position cursor at the first record with the key).

### Start Processing Loop

```rpg
c     start         tag
c                   read      rbunlu                                 15
```
- **start** is a tag for looping.
- Reads the next record in the file for the position set.
- If no more records, indicator **15** will be *ON*.

#### Exit on End-of-File

```rpg
c                   if        *in15 = *on
c                   goto      slutt
c                   end
```
- Go to the `slutt` tag if end of file is reached.

#### Filter by Firm

```rpg
c                   if        rsfirm <> l_firm
c                   goto      slutt
c                   endif
```
- If the firm in the current record (**rsfirm**) doesn't match the desired firm (**l_firm**), exit.

#### Filter by Member

```rpg
c                   if        rsmemb <> w_memb
c                   goto      slutt
c                   end
```
- If the member in the record (**rsmemb**) is not equal to the input **w_memb**, exit.

#### Filter by Batch

```rpg
c                   if        rsbunt <> w_bunt
c                   goto      slutt
c                   end
```
- If the batch number (**rsbunt**) is not equal to the input **w_bunt**, exit.

#### Delete the Record

```rpg
c                   delete    rbunlu
```
- Deletes the currently fetched record.

#### Loop

```rpg
c                   goto      start
```
- Go back and read the next record.

---

### End of Program

```rpg
c     slutt         tag
c                   eval      *inlr = *on
```
- **slutt** tag is the exit point.
- **eval *inlr = *on**: Set Last Record Indicator to ON to end the program and close files.

---

## **Initialization Routine**

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    w_memb
c                   parm                    w_bunt
```
- **INZSR** (Initialization Subroutine): Called once at program startup.
- **Parameter List:**  
  - Two parameters are received: w_memb and w_bunt.

```rpg
c                   eval      rbunlu_nivo = *blank
c                   eval      rbunlu_memb = w_memb
c                   eval      rbunlu_firm = l_firm
c                   eval      rbunlu_bunt = w_bunt
```
- These are used to build the key (`rbunlu_key`) for positioning in the SETLL above.

```rpg
c                   endsr
```
- End of the initialization subroutine.

---

## **Summary**

### **How the Program Works**
1. At startup, the program receives member and batch as input parameters and initializes the key for the file.
2. It positions to the first matching record with those key values.
3. For each record found:
   - It checks if the record matches the desired firm, member, and batch.
   - If any donâ€™t match, the program ends.
   - If all match, the record is deleted and the program continues to the next.
4. The program stops when there are no more records, or a record does not match the desired selection fields.

---

## **Key Points for New Developers**
- The program only deletes records that exactly match the supplied member, firm, and batch number.
- The key fields and input parameters must be carefully set up by the calling program.
- The program expects to be called with parameters for "member" and "batch."
- The use of GOTOs and *INLR is typical for older RPG code but less favored in modern RPGLE.

---

**Tip:** If you maintain or enhance this program, you will want to document key values, field definitions, and parameter sources, as well as consider refactoring for more modern exception handling and structure.