# IS110R â€“ Customer Ledger Inquiry for D365

## Overview

This RPG program (`IS110R`) is a customer ledger inquiry utility, designed to retrieve and present customer ledger entries from Microsoft Dynamics 365 (D365), integrating with external JSON-based web services and local database files. It leverages Scott Klement's YAJL (Yet Another JSON Library) for JSON parsing and interacts with multiple internal modules and files. The user interface is subfile-based, supporting inquiry, paging, and drill-down to related documents and statistics.

---

## Key Components and Structure

### 1. File and Data Definitions

- **Physical Files:**
  - `rkunlr` (Customer master)
  - `rkmel1` (Customer memo info)
  - `ilnkir` (Setup/config table)
- **Workstation File:**
  - `is110d` (Display file, with subfile `b1sfl`)
- **Local Data Area:** Used for user, firm, and name info.
- **Display Feedback Data Structure:** For handling display file feedback (e.g., cursor position).
- **Parameter Data Structure:** For interfacing with the `RF020R` program (notes/notat).

#### Customer Ledger Entries (JSON Structure)

```rpg
Dcl-ds CustomerLedgerEntries Dim(9999) Qualified;
    Posting_Date char(10);
    Document_Type  char(10);
    Document_No  char(15);
    Customer_No  char(6);
    Description  varchar(30);
    Amount   packed(11:1);
    Remaining_Amount  packed(11:1);
    Due_Date  char(10);
    Document_Date varchar(10);
end-ds;
```

This structure is populated by parsing the JSON response from the D365 web service.

---

### 2. Main Program Flow

#### Initialization (`*inzsr`)

- Receives the customer number as a parameter.
- Reads setup and customer master data.
- Calls external program `AP060R` to request ledger entries from D365; expects a response file path and status.
- Handles errors or empty responses with message display (`AA006C`).
- On success:
  - Loads setup info (`ilnkir`).
  - Retrieves customer master and memo info.
  - Reads and parses the JSON response into `CustomerLedgerEntries` using YAJL.
  - Populates the subfile for display.

#### Main Display Loop

- Presents a command screen and subfile listing customer ledger entries.
- Supports toggling between "open" and "all" entries.
- Handles function keys for:
  - Paging (forward/backward)
  - Drill-down to invoice or archive
  - Notes entry (`RF020R`)
  - Displaying customer statistics (`xe2win`)

#### Subfile Management

- `crt_subfile`: Populates the subfile from `CustomerLedgerEntries`, filtering on remaining amount if showing only open entries.
- `clr_subfile`: Clears the subfile.
- `bck_subfile`: Handles paging backward.
- `dsp_subfile`: Controls display logic.

#### Drill-down Functions

- **Invoice Display:** Calls `RK110C` with selected invoice data.
- **Archive Display:** Calls `AP622C` with document reference.
- **Notes Entry:** Calls `RF020R` for customer notes.
- **Statistics Window:** Calls `xe2win`, which:
  - Retrieves purchase sums for current and previous year via embedded SQL.
  - Retrieves and calculates VAT/memo balance if applicable.
  - Displays the statistics window.

---

## Notable Design Decisions & Conventions

- **JSON Integration:** Uses Scott Klement's YAJL library for parsing D365 web service responses, allowing modern web integration within traditional RPG.
- **Separation of Concerns:** External programs handle notes (`RF020R`), document display (`RK110C`, `AP622C`), and D365 communication (`AP060R`). This modularity supports maintainability and reusability.
- **Error Handling:** User feedback for failed or empty responses is handled via a common message program (`AA006C`).
- **Subfile Paging:** Paging logic is handled by maintaining counters (`w_tell`, `w_srrn`, `w_ssrn`, etc.) and re-populating the subfile as needed.
- **Hardcoded Test/Development Logic:** Some sections (commented with `9.xx`) are used for test scenarios (e.g., bypassing web service calls, reading from sample files).
- **Bilingual Comments:** Many comments and variable names are in Norwegian, reflecting the business domain and user base.

---

## External Interactions

- **AP060R:** Initiates the D365 ledger entry request, returns file paths and status.
- **AA006C:** Standard message display utility for error/information dialogs.
- **RF020R:** Notes entry and maintenance.
- **RK110C:** Invoice detail display.
- **AP622C:** Document archive retrieval.

---

## Business/Domain Logic

- **Customer Ledger Inquiry:** Focused on D365 integration, supporting both open and all ledger entries.
- **Subfile UI:** Allows users to browse, page, and drill into ledger entries.
- **Customer Statistics:** Embedded SQL retrieves purchase history for the customer, supporting credit evaluation and customer service.
- **Memo Balance Calculation:** Handles VAT inclusion based on customer tax status.

---

## Patterns & Conventions

- **Use of Qualified Data Structures:** For JSON data, promoting clarity and safety.
- **Overlayed Data Structures:** For parameter passing, especially when calling legacy RPG programs.
- **Extensive Use of Subroutines:** For modularity and clarity, each handling a specific UI or business function.
- **Embedded SQL:** Used for statistical queries, demonstrating integration of SQL within RPG for complex data retrieval.

---

## Inter-module Relationships

- The program relies on several external modules for business logic and UI (notes, invoice/archival display, messaging).
- Relies on the YAJL binding directory for JSON parsing.
- Reads from and writes to local database files for customer and setup data.

---

## Summary

`IS110R` is a robust, modular inquiry program for customer ledger entries, integrating modern web service data (JSON from D365) into a traditional RPG subfile UI. It encapsulates business logic for customer account review, statistics, and document drill-down, with clear error handling and separation of concerns. The codebase reflects both legacy RPG practices and newer integration patterns (YAJL, embedded SQL), serving as a template for similar inquiry or integration programs in the system.