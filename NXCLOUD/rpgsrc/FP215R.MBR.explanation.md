# RPG Program Explanation: ASOFAK (FP215R)

This ILE RPG program produces shelf labels ("hylle etiketter") for a variety of label printer types. The labels are for products, typically for use in a warehouse or store environment, and contain product information, barcodes, and other details. The program is fairly complex, supporting several printer models, and adjusts its output format accordingly.

## High-Level Flow

1. **Initialization** – Prepares the environment, sets up variables.
2. **Main Loop** – Reads product records from a database file, processes each for label printing.
3. **Label Formatting** – Prepares and formats label data per printer type and product.
4. **Printing** – Sends formatted label data to the printer using the correct commands for the print model.
5. **Termination** – Handles finalization and program exit.

---

## 1. **File Declarations**

```rpg
fvaw1pf   if   f  512   64aidisk
fEtikett  o    f  132      Printer oflind(*inof)
```
- **`vaw1pf`**: Input file, read with random access (`AID`) and keyed.
- **`Etikett`**: Output file, printer file for label output.

---

## 2. **Data Definitions**

### Work Fields

```rpg
d w_skty        s          like(l_type)
d w_hyle        s          like(vahyle)
d w_best        s         7
d w_spri        s        12
d w_dato        s         8
d w_altv        s        15
d w_lvar        s        13
d w_lvar_u      s        21
d w_tek1        s        35
d w_tek2        s        35
```
- Temporary variables to hold important pieces of data for each label.

### Constants

```rpg
d digits        c         ' 0123456789'
d nuller        c         '00000000     '
```
- Used for string checks and initializing fields.

### Counter Fields

```rpg
d w_anta_1      s          1  0
d w_anta_2      s          2  0
d w_anta_3      s          3  0
```
- Fields for number of labels to print.

---

## 3. **Input Record Format**

```rpg
i                                  1    4 0vaanta        Antall etiketter
i                                  5   19  vattxt        Tekst fra fastreg.
i                                 20   25  vatvar        Varenr.
...
i                                238  245  vapspr        Pris sammenligning
```

Describes the structure of a record read from the input file:
- Each field is extracted from a particular position in the input file.
- Fields include product number, supplier number, barcodes, quantities, date, price, etc.

---

## 4. **Main Program Loop**

### Read Input & Loop

```rpg
c                   read      vaw1pf                                 61
c                   dow       *in61 = *off
```
- Reads a product record.
- Loops until EOF (indicator 61 on) is encountered.

### Processing Each Record

1. **Filter by Label Type**

    ```rpg
    c                   if        vaetyp <> 3
    c                   goto      neste
    c                   endif
    ```
    - Only process records of label type 3.

2. **Prepare Data**

   - Assigns current label type, printer type (`w_skty = l_type`)
   - Prepares various label fields (e.g. date formatting, description, alternative product number)
   - Handles special text for supplier product number, quantity, price, etc.

3. **Alternative Product Number Logic**
    ```rpg
    c                   select
    c                   when      valvko = 1
    c                   movel     valvar        w_altv
    c                   when      valvko = 2
    c                   movel     vavare        w_altv
    c                   when      valvko = 3
    c                   movel     vanobb        w_altv
    c                   other
    c                   move      *blanks       w_altv
    c                   endsl
    ```
    - Decides which alternative article number to use, based on input field.

4. **Bestillingsinfo (Order Info) Logic**

    - Sets indicators for inclusion of order point and quantity if relevant fields are nonzero.

5. **Comparison Price**

    - If present, sets flag to print comparative pricing.

6. **Supplier Product Number Validation**

    ```rpg
    c     digits        check     valvar                                 90
    c                   if        *in90 = *off
    c                   eval      w_lvar = %trim(valvar)
    c                   else
    c                   movel     nuller        w_lvar
    c                   endif
    ```
    - Checks if supplier number (`valvar`) is numeric; if not, initializes to zeros.

7. **Barcode Selection By Label Type**

    - Based on `vahyle`, sets indicators for which barcode to print (own number, supplier, EAN, NOBB) using indicators 20–23.

8. **Printer Output Section**

    - For each supported printer type (`w_skty`), the program branches to a specific `EXCEPT` routine (`�pgm0`, `�pgm1`, etc.) which formats and outputs the label data using the proper control codes and formats for that printer.

---

## 5. **Printer Formatting (EXCEPT blocks)**

The RPG output specifications (`O-specs`) with `EXCEPT` are used for detailed line-by-line output tailored to each printer. Examples:

- **Meto 8100 Twinax** (`w_skty = 0`)
- **Meto 8100 Standard** (`w_skty = 1`)
- **Meto Bandit** (`w_skty = 2`)
- **Meto mi-4, Zebra QL320, Datamax EX-2** (other numbers)

Each block of O-specs under the label (e.g., `�data0`, `�data1`, `�data2`, `�data4`, `�data5`) sends the proper formatting and content lines for that label type and printer.

You see embedded field substitution (like `vatek1`, `w_altv`, etc.) to insert variable data, and literal control sequences as required by the printer model.

---

## 6. **End of Program/Labels**

```rpg
c     avslutt       tag
c     w_skty        ifeq      2
c                   except    �end2
c                   endif
c                   eval      *inlr = *on
c                   return
```
- Handles any printer-specific end-of-job sequences.
- Turns on *INLR (last record indicator), signaling RPG clean-up and closure.

---

## 7. **Special Notes**

- **Indicators**: RPG uses numeric indicators (e.g. 20–27, 60–66, 81–83, 90, etc.) heavily for controlling print logic and branch flow. These are typically handled with conditional logic or as print "switches".
- **Multi-printer Support**: Each printer has different format requirements. The O-specs (write output lines) contain the correct control codes, field positions, and data for each supported label printer.
- **Modifiability**: New printers can be added by introducing a new branch in the logic and a matching set of O-specs.
- **Documentation**: The source code is well-documented with both change history and functional comments in Norwegian.

---

## **Summary Table of Key Fields and Flow**

| Field           | Description                           |
|-----------------|--------------------------------------|
| vaanta          | Number of labels to print             |
| vattxt/vatek1/2 | Product descriptive text              |
| vatvar/vavare   | Article numbers (internal, own)       |
| valvar          | Supplier article number               |
| vaeann          | EAN barcode number                    |
| vanobb          | NOBB number (Norwegian building)      |
| vapri1/2        | Prices (for different sales units)    |
| vabpun/vabmen   | Order point & min. order quantity     |
| vaplas          | Warehouse location                    |
| vaetyp          | Label type                            |
| w_skty          | Printer type indicator                |
| O-Spec EXCEPT   | Output templates for each printer     |

---

## **Onboarding Tips**

- **Understand Indicators**: Study which *INnn indicators are used for display, logic, and printing.
- **Printer Codes**: Review technical documentation for each printer to understand the control codes used in O-specs.
- **Label Layout**: Use the comments and O-spec blocks to learn the label layouts per printer.
- **Adding New Fields/Printers**: Add new input fields to I-specs, new variables as needed, adjust the main loop and create/modify O-specs for output.

---

### **In Summary**

This program reads product data, processes it per label and printer requirements, and outputs shelf labels for various supported printers. Each printer type gets its unique output, both in format and data placement. The code is structured for extensibility and heavily commented, making maintenance and onboarding feasible for those familiar with RPG and printer label formats.