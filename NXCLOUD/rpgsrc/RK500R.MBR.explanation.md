# RK500R – Customer Inquiry Subprogram Documentation

## Overview

**RK500R** is a subprogram in the ASOKON system, designed for interactive customer inquiries via a subfile-based user interface (green-screen). It supports searching, browsing, and selecting customer records, with various navigation and search features. The program is tightly integrated with other modules and makes use of both native database files and embedded SQL for flexible customer lookup.

---

## Key Features and Flow

- **Subfile-based UI**: Uses subfiles (B1SFL) for displaying lists of customers, with paging, searching, and selection capabilities.
- **Flexible Search**: Supports both direct key-based access and free-text search (via SQL).
- **Navigation**: Allows scrolling forward and backward through the customer list.
- **Selection and Drill-down**: Users can select a customer for further processing or view details.
- **Integration**: Calls out to other programs (e.g., AS700R for search parsing, RK502R for customer detail display).

---

## File Dependencies

- **rkunl1 / rkunl2**: Physical files for customer master data, accessed by key (customer number or alpha key).
- **rksopf**: Used for SQL-based free-text search on customers.
- **rk500d**: Display file defining the subfile (B1SFL) and control screens (B2CTL, B2CMD).

---

## Data Structures and Variables

- **Local Data Area (LDA)**: Used to retrieve user, firm, and navigation information at initialization.
- **Work Variables**: Counters and pointers for subfile management (e.g., `w_srrn`, `w_sfrn`, `w_ssrn` for subfile record tracking).
- **Search Variables**: `w_ste1`–`w_ste5` hold parsed search terms, filled by calling AS700R.
- **State Flags**: Boolean indicators for program and subfile state (e.g., `b_open_sok`, `b_valg_ok`).

**Indicator Usage**: 
- Indicators 10–99 are used for UI and internal logic, following a documented convention (see comments in code).

---

## Main Program Logic

### Initialization (`*inzsr`)

- Receives firm, customer, and name as parameters.
- Builds key lists for customer number and alpha search.
- Retrieves the current date and initializes UI variables.
- Reads LDA for firm information.
- Sets initial indicators and positions the database to the start.
- Populates the subfile with the initial customer list.

### Main Loop

- **Display Command Screen**: Shows command options (B2CMD).
- **Display Subfile**: Shows the subfile (B1SFL) via `dsp_subfile`.
- **Function Key Handling**: Processes navigation, search, and selection keys (e.g., PageUp/Down, search repeat, toggle passive customers).
- **Search/Positioning**: Handles free-text search (`søk`), alpha positioning (`posisjoner`), and subfile refresh (`forny`).
- **Subfile Processing**: Handles record selection, detail viewing, and triggers subfile refresh as needed.
- **Exit**: Sets LR indicator and returns.

---

## Subroutines

### `newlo_vask`

- Cleans customer name and address fields for compatibility with Newlook (GUI tool).
- Removes trailing periods and colons from fields to avoid misinterpretation by the GUI.

### `forny`

- Refreshes the subfile based on the current search mode.
- Repositions the file and repopulates the subfile.

### `søk`

- Initiates a free-text customer search.
- Calls AS700R to parse the search string into up to five keywords.
- Clears and reloads the subfile with search results.

### `posisjoner`

- Positions the customer list to a specific alpha value.
- Clears and reloads the subfile starting from the given alpha key.

### `subfile`

- Processes subfile records for selection or detail display.
- Handles record selection (option 1) and detail view (option 5, calls `xc2bld`).
- Refreshes the subfile if needed.

### `clr_subfile`

- Clears the subfile by setting indicators and resetting counters.

### `crt_subfile`

- Populates the subfile with customer records.
- Handles three modes:
  - **S**: Free-text search using SQL cursor on `rksopf`.
  - **A**: Alpha-keyed sequential read from `rkunl2`.
  - **Default**: Customer number-keyed sequential read from `rkunl1`.
- Applies search term filtering on multiple keywords (w_ste2–w_ste5).
- Skips passive customers if the relevant filter is active.
- Applies "Newlook cleaning" to data before display.

### `bck_subfile`

- Scrolls the subfile backward by one page.
- Uses `readp` operations to step back through the customer file.

### `dsp_subfile`

- Manages subfile display and control record formatting.

### `xc2bld`

- Calls out to RK502R to display customer details for the selected record.

---

## Notable Design Decisions & Patterns

- **Indicator Management**: Strict conventions on indicator usage, with reserved ranges for UI, errors, and work flags.
- **Subfile Paging**: Implements its own paging logic using counters and indicators, rather than relying solely on display file SFL paging.
- **Search Parsing**: Delegates parsing of free-text search terms to a separate program (AS700R), allowing for complex search logic without cluttering the main program.
- **SQL Integration**: Uses embedded SQL for free-text search, allowing for flexible and language-sensitive queries (note `Set Option` for Norwegian language and ISO date format).
- **Passive Customer Filter**: Allows toggling display of passive customers via a function key, toggling `*in55`.
- **GUI Compatibility**: Contains logic (`newlo_vask`) to ensure data is compatible with Newlook GUI, reflecting a hybrid green-screen/GUI environment.

---

## External Program Calls

- **AS700R**: Parses the search string into up to five keywords.
- **RK502R**: Displays customer detail information when requested.

---

## Display File Relationships

- **B1SFL**: Main subfile for customer listing.
- **B2CTL**: Control record for subfile display.
- **B2CMD**: Command screen for function key display and input.

---

## Business Logic Notes

- Designed for interactive customer lookup and selection, supporting both structured and unstructured (free-text) search.
- Filtering and display logic accommodate both green-screen and GUI (Newlook) environments.
- Integration with other modules allows for modular growth and reuse of search and display routines.

---

## Summary

RK500R is a robust and flexible subprogram for customer inquiry, providing a rich set of navigation, search, and selection features. It is designed to work seamlessly in both green-screen and GUI environments, and makes extensive use of modular routines, clear indicator management, and hybrid DB/SQL access patterns to deliver an efficient user experience. 

For onboarding, focus on understanding the subfile paging logic, indicator conventions, and the interplay between SQL-based and keyed access modes. The program’s structure and modularity facilitate extension and adaptation to evolving UI and business requirements.