```markdown
# RPG Program RL516R – Explanation

## Overview

This is an ILE RPG III/IV program for IBM i (AS/400). The source is heavily commented (in Norwegian), and is designed to work with vendor records, specifically for displaying proposals for payments (“utbetalingsforslag”). Its main interaction is with a subfile interface, supporting record browsing, paging, and detail display.

---

## Key Concepts

- **Subfiles**: The program is a classic “subfile” application—displaying a page of records at a time, handling user navigation, and updating the subfile as the user moves.
- **Files Used**:
  - `RLTRLD` (physical file): The main data source, likely containing vendor/payment proposal records.
  - `RL516D` (display file): The main display file with a subfile (B1SFL), control records, and command record layouts.
- **Indicators**: Status indicators (numbered 10-99, per IBM RPG convention), used for controlling state and display logic.
- **Data Structures**:
  - `dspfbk`: For feedback from the display file (e.g., cursor position).
  - User area variables for firm, user, and file parameters.

---

## File Declarations

```rpg
frltrld    if   e           k disk    rename(rltrpfr:rltrldr)
frl516d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- `RLTRLD` is the vendor payments file, with keys and renamed record format.
- `RL516D` is the workstation (display) file, using subfile `B1SFL` and subfile record number `w_srrn`.

---

## Primary Variables

- `w_srrn`, `w_ssrn`, `w_sfrn`: Subfile record numbers, tracking which range of records are displayed.
- `w_spge`: Size of subfile page for paging logic.
- `b2raar`: The currently entered/selectable “regnskapsår” (fiscal year).
- `b2bfnr`: Likely a proposal or document number for positioning.
- `w_firm`: The current firm/company number.
- `w_bfnr`, `gml_bfnr`: Used for proposal/document number tracking.

---

## Main Logic Flow

### Program Startup - *inzsr

- Initializes key fields from the Local Data Area.
- Positions the database file at the beginning for the selected year and fills the subfile.

### Main Loop

- **Tags and Navigation**: Uses branch tags (`b2taga`, `b2tagb`) for major flow control.  
- **Display/Command Loop**:  
  - Writes the command screen (`b2cmd`).
  - Calls subroutines to refresh and display the subfile (`dsp_subfile`).
  - Handles user function keys via SELECT:
    - Exit (KC/KL), Refresh (KE), Roll (10), Roll Back (11), Home (21), etc.
    - Changes in fiscal year trigger repositioning.
- **Subfile Handling**:
  - Fills (`crt_subfile`), clears (`clr_subfile`), and updates the subfile records based on paging and filters.
  - Handles forward/backward paging and detail display via function keys.

### Subroutines

- **forny**: Refreshes the subfile, repositions on the first record if possible.
- **posisjoner**: Handles positioning when user changes filter criteria (e.g., year, proposal number).
- **subfile**: Handles user-editable records, including calling detail display program if selected.
- **clr_subfile**: Clears the subfile area in preparation for new records.
- **crt_subfile**: Reads records from `RLTRLD` and writes them to the subfile buffer, handling grouping and paging.
- **skr_subfile**: Handles actual subfile write operation for a record group.
- **bck_subfile**: Implements logic for paging backwards in the result set.
- **dsp_subfile**: Controls display of either the subfile or the command window, depending on the user state.
- **xc2win**: Calls an external program (`RL517R`) to display detail for a selected record.

---

## Subfile Paging Logic

- Records are read from `RLTRLD` into the subfile buffer in blocks of size `c_sfil`.
- Paging is handled by incrementing/decrementing `w_srrn`, `w_ssrn`, calculating new positions with `w_spge` and `c_sfil` (page size).
- Detail display is triggered by a user action (`b1valg = 5`), which calls an external program via subroutine.

---

## Indicators and Their Usage

- **LR**: Last record, end program.
- **10/11**: Roll/rolldown for paging (next/prev page).
- **12/13**: Subfile display control.
- **14**: Subfile clear for creating a new page.
- **15**: Subfile end (no more records).
- **21/22**: Home key and cursor position.
- **30**: Field protection.
- **31-79, 80-99**: Error and working indicators.

---

## Special Notes

- All subfile and paging logic is handled in memory and heavily dependent on the correct setting of the working indicators and variables.
- Error handling is mostly absent (likely handled at a different layer or via screen indicators).
- The code uses `GOTO` and branch tags (`tag` opcodes) for main control flow, common in older RPG but less so in RPG IV/free format.

---

## Summary of Screen Layouts

- `B1SFL`: Subfile record (list of proposals)
- `B2CTL`: Subfile control record (screen header, search/filter fields, page navigation)
- `B2CMD`: Command display screen (for command keys)

---

## External Calls

- `RL517R`: Called with year and proposal number as parameters, for viewing more detail about a proposal.

---

## General Flow Pseudocode

```
Initialize:
    Set up keys, get parameters, fill up first subfile page

Main Loop:
    Show command window
    Loop:
        Display subfile window
        Wait for key
        If user requests new year or proposal, reposition file and refill subfile
        If page up/down, refill subfile with next/previous group of records
        If detail requested, call external program to show it
        If exit requested, end program

Supporting routines:
    Fill subfile (read from file, group as needed, write out)
    Clear subfile (reset indicators and counters)
    Display subfile (set display indicators, show screen)
```

---

## Onboarding Tips

- Learn about subfile processing on IBM i; this program is a classic example.
- Understand how indicators control both screen and logic flow.
- Note the heavy use of DATA STRUCTURES (`ds`), especially for screen feedback.
- The business logic is interleaved with IBM i display file (DDS) conventions.
- Modernizations would use more modular, free-format RPG, but understanding this style is essential for maintaining classic/legacy applications.

---
```