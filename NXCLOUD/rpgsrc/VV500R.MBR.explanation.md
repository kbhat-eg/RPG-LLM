# Program Overview  
This RPG ILE program (VV500R) provides a subfile-based display of items (“varer”) with group selection, search, and positioning features. It interacts with the *VA*-register for item availability, supports sorting, and highlights central‐warehouse or period‐controlled items with color indicators.

---

## Files and Data Structures  

- **Database Files**  
  - `VVSOPF` (fvvsopf): Main item availability file.  
  - `VVVARLR`, `VVVARL1`–`VVVARL8`, `RLEVL1`, …: Logical files keyed on various fields for positioning/search.  
  - `VSDTL7`, `VSHEL1`, `FSTSL1`, `VVL E L1`: Used for assortment/status lookups.  

- **Workstation File**  
  - `W_SRRN`… display formats:  
    - B1SFL – Subfile record  
    - B2CTL – Subfile control  
    - B2CMD – Command-key panel  

- **InfDS for Display Feedback**  
  ```rpgle
  D dspfbk   DS                    INFDS(W_SRRN)
    D d_fcrn      378    379I 0   ← Current subfile first record number
  ```

---

## Parameters  

```rpgle
D p_firm    S       Like(VVfirm)   ← Company  
D p_vare    S       Like(VVvare)   ← Item number  
D p_tek1    S       Like(VVtek1)   ← Search text  
```

---

## Key Lists (KLISTs)  
Defines keys for file operations (POSITION, SETLL/READ, CHAIN, etc.):

- `vvarlr_key`: `(w_firm, vvarlr_vare)` – lookup by item number  
- `vvarl1_key`–`vvarl4_key`: for positioning on item number, text, supplier item, etc.  
- `vvarl6_key`–`vvarl8_key`: for search by overgroup, subgroup, etc.  
- `rlevl1_key`: supplier‐register lookup  
- `vsdtl7_key` / `vshel1_key`: assortment lookup  
- `fstsl1_key`: status register lookup  

---

## Working Variables for Subfile Control  

| Variable | Purpose                          |
|----------|----------------------------------|
| w_fcrn   | First record number on page      |
| w_spge   | Page size (records per page)     |
| w_srrn   | Current record number on page    |
| w_sfrn   | First record number last page    |
| w_ssrn   | Last record number last page     |
| w_virn   | Desired cursor position          |
| w_afld   | Active field name                |
| w_arow   | Active row                       |
| w_acol   | Active column                    |

---

## Main Processing Flow  

1. **Initialization** (`*INZSR` / `*ENTRY`)  
   - Retrieve parameters into working vars.  
   - Chain status file, set flags (`b_ksor` etc.).  
   - Position database on `vvarl2_key` (search‐text key).  
   - Call `CRT_SUBFILE` to fill the initial page.  

2. **Display Command Panel**  
   ```rpgle
   WRITE B2CMD
   CALLP DSP_SUBFILE
   ```

3. **Function-Key Handler**  
   - **Esc/Enter** → Exit  
   - **F4 (Reset)** → clear search criteria and redraw  
   - **F8** → call external VA-register routine (`JV505R`)  
   - **F9 (Repeat Search)** → reapply search text  
   - **F10/F11** → scroll forward/back subfile pages  
   - **F23** → cycle positioning mode (Item / Supplier‐item / NOBB)  

4. **Search or Positioning**  
   - If group fields or text populated → `EXSR SØK`  
   - If item/text fields set → `EXSR POSISJONER`  
   - Otherwise: fill or page through subfile (`EXSR SUBFILE`)  

5. **Exit**  
   - On selection (`b_valg_ok`) or Esc, set `*INLR = *ON` and RETURN.

---

## Key Subroutines  

### CLR_SUBFILE  
- Clears previous subfile data by writing B2CTL with `*IN14 = *ON`, resets counters.

### CRT_SUBFILE  
- Builds subfile page by looping until `w_srrn = w_spge`:
  - Opens appropriate SQL cursor (search group/text mode) when `b_open_sok = *ON`.
  - Fetches rows (via SQL FETCH or READ/E) into host variables.
  - Filters by search tokens (w_ste1…w_ste5).
  - Chains to main file (`VVARLR`) to retrieve full item data.
  - Calls sub‐programs:  
    - `VL720R` to get out‐date and skip expired items.  
    - `VL710R` to get logistic‐item info.  
  - Optionally calls `SJ EKK_VSOR` to set color flags for central/period assortments.
  - Writes each record to B1SFL.

### BCK_SUBFILE  
- Implements “page back” by setting reading position > current, reading backwards, then clearing & rebuilding subfile.

### DSP_SUBFILE  
- Displays subfile control record via EXFMT B2CTL, captures `d_fcrn` from InfDS.

### SØK  
- Validates group fields, stores them in `s_…` locals.
- If search‐text specified:  
  - Splits it into up to 5 tokens (`AS700R`).  
  - Sets `w_seqe` code (“SO”, “SH”, “SU”, or “S ”) for cursor choice.
- Otherwise sets `w_seqe` to “O”/“H”/“U” for group‐only searches.
- Clears and rebuilds subfile.

### POSISJONER  
- Similar to SØK but for positioning on a single key field (text/item/…).
- Sets `w_seqe` to “V”/“N”/“L”/blank, builds subfile accordingly.

### SPØRRING  
- Handles user queries on Overgroup/Hovedgroup/Undergroup fields via `VG510R`–`VG512R`.

### SJEKK_VSOR  
- Scans assortment detail (`VSDTL7`) and header (`VSHEL1`) to flag central (“C”) or period (“P”) assortments.  
- Sets `b_sent` / `b_sess` indicators to color-code the record.

### FINN_LOGIVAR  
- SQL lookup in `JVKLPF` to determine logistic‐item grouping and set indicators for price source.

---

## Indicator Usage  

- LR = End of program  
- 10 / 11 = Forward / backward subfile scroll  
- 12 / 13 = Display subfile control  
- 14 = Clear subfile  
- 15 = End of file reached  
- 21 / 22 = Home‐key / cursor positioning  
- 80–82 = New‐position keys (F23)  
- 50+ = Color indicators for central/period assortments  

---

This structure ensures easy onboarding:  
- **File defs & keys** → understand data sources.  
- **Working vars & indicators** → control subfile paging.  
- **Main loop** → handles function‐keys, search, positioning, exit.  
- **Subroutines** → modularize display, search, paging, and lookups.