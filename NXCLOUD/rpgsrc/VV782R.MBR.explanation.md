# Program Overview

This RPG program (`VV782R`) is used to copy product master data (vareregister) from one file group to another in a complex ERP-type system. It handles copying products, prices, units, EAN codes, offers, search texts, supplier references, and optionally updates/copies these only if there have been changes since the last copy (tracked in a "tracking file"). It is highly parameterized and supports copying all items, a selection, or even input from a CSV file.

The code is heavily commented in Norwegian (with code evolution notes and enhancement references), and the comments indicate business rules for preservation and management of sensitive fields (e.g., don't overwrite expiration dates if set, preserve stock location/type, etc.).

---

## High-Level Workflow

1. **Initialization**:
    - Loads input parameter lists with information about source and target file groups, filters, and options.
    - Initializes keys for database access and sets up work variables.
    - Reads "change tracking" information if available, to determine if a product needs to be copied.

2. **Determining What to Copy**:
    - If a "markup" (`p_pasl`) is requested, fetches general markup data.
    - If all item filters are blank and no date filter, processes the entire item register (`EXSR TOTAL`).
    - If specific item numbers are provided, processes each of those.
    - If a supplier number is provided, processes all items for that supplier.
    - If a creation date filter is provided, processes items created on that date.
    - If an input file (CSV) is provided, processes items from the file.

3. **Main Processing (`EXSR BEHANDLING`)**:
    - For each selected item, checks if it already exists in the target group.
        - If yes, runs logic to update/merge (`EXSR ENDR_VARE`).
        - If item has changed item number (matched item), runs `EXSR MATCH_VARE`.
        - If new item, runs `EXSR NY_VARE`.

4. **Subroutines**:
    - `ENDR_VARE` : Updates an existing item with data from the source if needed, with special logic to preserve certain business fields.
    - `NY_VARE` : Creates a new item entry in the target group.
    - `MATCH_VARE`: Handles items whose product number has changed — invokes another program to remap keys across all tables, then "updates" the new item.
    - `TOTAL`: Handles copying all items, including from a product assortment table, and runs global offer copying.
    - `KOPI_TILB`: Handles offers not associated with a specific product.
    - `PÅSLAG`, `JUST_PRIS`, `JUST_TILB`: Logic for calculating new prices based on markups, both percent and absolute, including group/level logic for where to get the markup from (item, group, supplier, etc.).
    - `SJEKK_ENDR` / `SJEKK_PASLAG` : Tests if an item (or associated data) has been materially changed since last copy, using "tracking" timestamps.
    - `UPD_ACPL`: Updates the tracking file with new copy timestamps if anything changed.

---

## Key Data Structure Highlights

### Parameter Structures

- `D_LIST`, `D_LIST2` provide flexible overlays for input parameters, allowing field extraction from parameter blocks.
- Fields include file groups, firm numbers, supplier/group/offer filters, up to 10 item numbers, date, item type and options.

### Work Variables

- Work variables are defined for all keys (item number, supplier, price group, etc.) and for storing original and target field data.
- Flags such as `b_vvar`, `b_vven`, etc., control which parts of product data should be processed in a given run.

### File Declarations

- Many files are declared `DISK` type for keyed access (e.g., `vvarl1`, `vvenl1`, `vvepl1`), with input/output keys set by the routines.
- Each file is mapped (renamed) to a record format, and there are versions both for reading "from" and writing "to".

---

## Key Business Rules / Logic

- **Selective Copying**: Only the relevant parts of product data are copied, based on changes, parameters, and what is actually needed.
- **Preservation**: Certain fields are preserved and not overwritten (e.g., stock location, item type, expiration date).
- **Markup Application**: Markups (`påslag`) are sophisticated and can be defined at multiple hierarchy levels (item, supplier, group, etc.), and involve both percentage and absolute increases.
- **Offer Handling**: Offers (tilbud) for both item-specific and group/supplier level are handled, with rules to skip "campaigns" starting with 'L'.
- **Change Tracking**: Timestamps of last updates for each part of the product master are checked, and only changed entities trigger copy logic (to improve performance and maintain data accuracy).
- **Cross-Reference/EAN**: If an EAN number is present elsewhere, it gets reassigned as appropriate.
- **CSV Input**: The program can process a list of items to copy, driven by an external CSV file.
- **Logging**: Updates are always timestamped and marked with the responsible user.

---

## Main Program Sections

### 1. **Initialization** (`*INZSR`)
- Loads input parameters from the calling program.
- Sets up all key-lists for file access.
- Loads change tracking information (last copied timestamps) for smart update decisions.

### 2. **Global Markup Lookup**

```rpg
if d_pasl <> *blank
    eval vpdtl1_pasl = d_pasl
    ...
endif
```
- Checks for markups to be applied during price copying.

### 3. **Data Selection Logic**

- If all filters are empty, process the entire register.
- Loop over each individually-specified item, if provided.
- Loop over all items for a supplier.
- Loop over all items of a given creation date.
- Loop over items in a CSV file, if that's specified.

### 4. **Main Copying Routine** (`EXSR BEHANDLING`)
- Tries to find the item in the target group.
    - If found: `ENDR_VARE` (update item).
    - If item number mapping: `MATCH_VARE`.
    - If not found: `NY_VARE` (add as new).

#### Subsections for Handling

- **ENDR_VARE**: Updates item attributes, applies markups, updates offer and supplier tables, ensures dates and codes are only overwritten per rules.
- **NY_VARE**: Inserts the item and all its related data as new.
- **MATCH_VARE**: Handles remapping product numbers, updating all tables and then triggers an update pass.

#### All subroutines:
- Handle copying related data: units, prices, offers, EAN, search texts, and supplier data.
- Will also, for stock items, insert entries in all warehouse/stock tables where appropriate.

### 5. **Price and Offer Calculations**
- Use a combination of table lookups and calculations to apply markups.
- Automatically adjusts prices/offers for percentage or absolute markups, and calculates sales price/deckning (margin).

### 6. **Change Tracking**
- Upon updating/copying, updates the tracking file with new timestamps, so next run can efficiently detect changes.

---

## Notable Features / Code Patterns

- **Use of "Overlay" on Data Structures** to parse parameter lists efficiently, which is a classic RPG idiom.
- **Repeatable Subroutine Execution** (`EXSR`) for applying logic to many tables/records.
- **Date and Time Stamping**: All updates are tracked with date/time/user, allowing audit trails.
- **Hierarchical Markup Calculation**: Markup may be taken from item, group, supplier, etc., "rolling up" if not found at lower levels.
- **Business Rule Comments**: Inline comments (in Norwegian) describe WHY certain things are protected or handled in special ways.

---

# Summary Table of Major Routines

| Subroutine       | Purpose                                                                              |
|------------------|--------------------------------------------------------------------------------------|
| TOTAL            | Copy all items or from assortment; optionally only changed items                     |
| BEHANDLING       | Handle copying a single item (existing, matched, or new)                             |
| ENDR_VARE        | Update item with values from source, per preservation rules                          |
| NY_VARE          | Insert new item record and all related tables                                        |
| MATCH_VARE       | Special logic for items that have changed number (across all cross-ref. tables)      |
| KOPI_TILB        | Copy offers not associated with specific items                                       |
| PÅSLAG           | Determine correct markup for prices, searching via item-group hierarchy              |
| JUST_PRIS        | Adjust/calculate new price values using determined markups                           |
| JUST_TILB        | Adjust/calculate offers using determined markups                                     |
| SJEKK_ENDR       | Check if master or dependent data has changed using timestamp comparisons            |
| SJEKK_PASLAG     | Check for changes in markup tables                                                   |
| UPD_ACPL         | Write new timestamps for tracking after changes                                      |

---

# How to Onboard a Developer on this Program

1. **Understand the Data Model**: The program is deeply tied to the product register data model, including product, supplier, price, unit, and offer tables, as well as tracking, search text, and EAN tables.
2. **Parameterization**: Study how parameters are packed/unpacked via overlays and how they are used to filter processing logic.
3. **Subroutine Structure**: Get familiar with RPG subroutines (`BEGSR/ENDSR`), especially as the main logic is highly modularized.
4. **Key Business Rules**: Pay particular attention to business rules described in comments, as they drive exceptions and data preservation.
5. **Change Tracking**: Understand how and why only changed records are updated, leveraging the tracking file.
6. **Testing**: When making changes, verify by walking through a copy operation with both new and existing items, and test with and without markups/offers.

---

## Conclusion

This is a complex, business-critical module for synchronizing product master data between different file groups in a retail/ERP system. It is robust, highly parameterized, and designed to ensure both performance and data integrity according to strict business rules. The program structure, heavy use of subroutines, and clear separation of concerns make it maintainable for experienced RPG programmers, provided they understand the underlying business logic and data structures.