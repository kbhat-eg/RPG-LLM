# ASOFAK / FO807R – Start Printing of Order Documents

## Overview

This program, **FO807R**, is part of the ASOFAK system and is responsible for initiating the printing of order-related documents ("utkjøring av ordrepapirer"). The program prepares parameters, updates the relevant print queue register, and then calls a CL program (`FO807C`) to start the actual print job. It is typically invoked by another program, passing in various parameters that determine what and how to print.

The code follows a modular, data-driven approach, relying on a combination of data structures, parameter passing, and file-based control tables to drive the print process.

---

## Key Components

### 1. Files and Data Structures

- **Files**
    - `votyl1` (`votypfr`): Order type register, read-only (input, keyed).
    - `fpm1lu` (`fpm1pfr`): Picking line register, update-capable (update, keyed).

- **LDA (Local Data Area) Fields**
    - Used to retrieve session/user-specific information (workstation ID, user, etc.) for audit and keying purposes.

- **Data Structures**
    - `d_memb`: For dynamic member naming (likely for spool file or temporary data).
    - `d_peri`: For handling year/month period values.

### 2. Parameters

The program expects the following parameters (via *ENTRY):

- `p_skor`: Selection code (usage not shown in this snippet).
- `p_firm`: Firm/company number.
- `p_numm`: Order number.
- `p_suff`: Suffix (likely for order line or variant).
- `p_otyp`: Order type.
- `p_dirk`: Direct print indicator.
- `p_outq`: Output queue for printing.

Parameters are mapped to working variables and used to build keys or drive logic throughout the program.

---

## Main Program Flow

### Initialization

- **Set `p_dirk` to zero**: Indicates default (non-direct) print unless overridden by parameters.
- **Set `w_valg` to zero**: Used as a selection/variant indicator for the print process.

### Parameter Preparation

- **Subroutine `param`**: Prepares and updates the picking parameter register (`fpm1lu`) with the current print job's parameters.
    - Builds the key using firm, workstation, user, and selection.
    - Updates or writes a record in `fpm1lu` with current parameters, including output queue, order type, order number, suffix, and control flags.
    - Sets the period and date fields.
    - Ensures only one record per combination, updating if exists, inserting if not.

### Print Job Initiation

- **Calls CL program `FO807C`**: Passes the generated member name (`d_memb`) as a parameter. The CL likely handles the actual print job submission, using the parameters prepared by this RPG program.

### Program Exit

- **Sets *INLR = *ON**: Ensures program cleanup and closure of files.
- **Returns**: Ends the program.

---

## Subroutines

### 1. `param`

Handles all updates to the picking parameter register, ensuring the correct parameters are set for the print job. It uses a combination of existing data and input parameters to update or insert a record keyed by firm, workstation, user, and selection.

### 2. `*inzsr` (Initialization Subroutine)

- Defines key lists for various files.
- Maps parameters to working variables and data structures.
- Calls another program (`FA920R`) to get the next available member number for dynamic file/member naming.
- Checks if the generated member is already used (via `FO604C`); if so, increments and retries.
- Sets the current date for logging or tracking.

---

## Business/Domain-Specific Logic

- **Order Document Printing**: The program is designed to manage the preparation and initiation of order document print jobs, supporting both batch and direct print modes.
- **Dynamic Member Naming**: Uses a combination of alpha and numeric sequences to generate unique member names for each print job, ensuring no collisions.
- **Audit and Control**: Makes use of workstation and user IDs (from LDA) for tracking and as part of composite keys in control tables.
- **Parameter Register (`fpm1lu`)**: Acts as a control table for print jobs, ensuring that each job is uniquely identified and properly parameterized before being handed off to the print process.

---

## Conventions and Patterns

- **Key Lists (`klist`)**: Used extensively for file access, ensuring consistent and maintainable key definitions.
- **Subroutine Structure**: Business logic is broken into subroutines for clarity and reuse.
- **External Program Calls**: Relies on external RPG and CL programs for member management and print initiation, promoting modularity.
- **Use of LDA**: Ensures session/user context is always available for operations and audit trails.

---

## External Interactions

- **FA920R**: RPG program called to retrieve/generate the next available member number.
- **FO604C**: CL or RPG program called to check if a member name is already used.
- **FO807C**: CL program called to actually start the print job, using the parameters and member name prepared by this program.

---

## Noteworthy Design Decisions

- **Separation of Parameter Preparation and Print Initiation**: By updating the parameter register before calling the CL, the system allows for flexible job control and easy troubleshooting.
- **Dynamic Member Handling**: Ensures that each print job is uniquely identified and avoids conflicts in spool or temporary files.
- **Robustness in Member Allocation**: Loops and checks ensure that member names are never reused, even in high-concurrency scenarios.

---

## Summary

**FO807R** is a central utility in the order document print process. It abstracts the complexities of parameter management, ensures uniqueness and auditability, and hands off the actual print job to a CL program. The design is modular, data-driven, and robust, making it easy to maintain and extend for future requirements. Integration with other RPG and CL programs is a core part of the workflow, and the use of control tables and LDA ensures reliable operation in a multi-user, multi-company environment.