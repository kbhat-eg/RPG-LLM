# Documentation: Program LX705R – Warehouse Number Change Utility

## Overview

**Program:** LX705R  
**System:** ASLAGR  
**Purpose:**  
This utility program updates (switches) warehouse numbers (lagernummer) across all relevant files in the system, ensuring data consistency when a warehouse identifier changes (e.g., due to reorganization, consolidation, or correction).

## Business Context

- The system supports a retail/wholesale distribution environment, with files representing orders, inventory, logistics, users, and related entities.
- Warehouse numbers are key identifiers present in nearly every transactional and master file.
- This program is typically run by system administrators or superusers when a warehouse number must be changed globally.
- The program ensures historical and current records are updated, including audit fields where applicable.

## Structure and Flow

### File Declarations

- **Workstation File:** `lx705d` is used for interactive user input.
- **Master and Transaction Files:** Dozens of user, transaction, logistics, and parameter files are declared for update (see file list in code). Each file contains a warehouse field that may need updating.
- **Note:** Some files are renamed for record-level access (e.g., `fmprwpf` as `mprwpfr`).

### Local Data Area

- Pulls user and firm data from the LDA for audit and filtering.
- Notably, `l_user` is used to stamp audit fields during updates.

### Main Processing Logic

#### 1. **User Input and Validation**

- The program starts by displaying a screen (`c1bld`) to collect:
    - The warehouse number to change **from** (`c1flag`)
    - The warehouse number to change **to** (`c1tlag`)
- It validates:
    - That the "from" warehouse exists.
    - That the "to" warehouse does **not** already exist.
    - If validation fails, the user is prompted again.

#### 2. **Warehouse Master Update**

- The "to" warehouse is created in the master file (`ra10l1`).
- The "from" warehouse is deleted from the master file.

#### 3. **Global Warehouse Update**

- For each relevant file, the program reads each record and checks if the warehouse field matches the "from" warehouse.
- If a match is found:
    - The warehouse field is updated to the "to" value.
    - If present, audit fields (user, date, time) are updated with current values.
    - The record is updated in place.
- This is repeated for all files and all records.

#### 4. **Audit and Tracking**

- Where applicable, audit fields are updated:
    - User (`...usr`, `...sig`)
    - Date (`...edat`)
    - Time (`...etim`)
    - Program (`...pgm`)
- This ensures traceability for all changes.

#### 5. **Special Cases and Exclusions**

- Some files have unique field names for warehouse (e.g., `lwlagr`, `lwlage`), and some require updating multiple fields per record.
- The user master file (`AUSRPF`) is **excluded** from automatic update as of version 6.13, per business decision, due to cross-environment considerations. This is documented in the code and the relevant logic is commented out.

#### 6. **Exit**

- The program ends cleanly, setting LR and returning.

### Subroutine: Initialization (`*inzsr`)

- Prepares a key list (`ra10l1_key`) for accessing the warehouse master file.

## Design Decisions and Patterns

- **Iterative Record Update:**  
  Each file is processed sequentially with a `read/dow` loop. This approach is robust but can be slow for large files; however, it ensures all records are checked and updated as needed.
- **Audit Trail:**  
  Updates to audit fields are enforced wherever possible, ensuring that all changes are tracked to a user and timestamp.
- **Field Name Variability:**  
  The code accounts for inconsistent warehouse field naming across files by explicitly referencing the correct field in each loop.
- **Versioning and Change History:**  
  Extensive comments document file additions, removals, and business rule changes over time. This is critical for maintainability and for understanding the rationale behind current behavior.
- **Manual Exclusion:**  
  The exclusion of `AUSRPF` is handled by commenting out the relevant code, with clear rationale in the comments. This reflects a business process where user records may span multiple environments and require manual intervention.

## File Relationships

- **Warehouse Master (`ra10l1`):**  
  Central source for valid warehouse codes.
- **Transaction and Parameter Files:**  
  Each file represents a business object (e.g., orders, inventory, users) that references warehouses.
- **Audit Fields:**  
  Many files contain audit fields, updated by this program to reflect the warehouse change.

## Conventions

- **Naming:**  
  File and field names are abbreviated and may be cryptic. Refer to the data dictionary for mappings.
- **Record Formats:**  
  Many files use a record format named after the file with an "r" or "fr" suffix.
- **Audit Field Suffixes:**  
  - `...usr` – user
  - `...dat` – date
  - `...tim` – time
  - `...pgm` – program

## Interactions

- **No External APIs:**  
  The program operates solely on local database files.
- **No Inter-Program Calls:**  
  All logic is contained within this program.

## Maintenance Considerations

- **Adding/Removing Files:**  
  When new files are introduced to the system that reference warehouse numbers, they must be added to this program.
- **Field Name Changes:**  
  If warehouse field names change in any file, the program must be updated accordingly.
- **Performance:**  
  For large databases, consider performance impact. This program is not optimized for batch processing of millions of records.
- **Manual Steps:**  
  Some updates (notably user file updates) may require manual intervention. Always review the latest comments for business-driven exceptions.

## Summary Table: Typical File Update Pattern

| File        | Warehouse Field(s) | Audit Fields Updated | Notes                        |
|-------------|--------------------|---------------------|------------------------------|
| bmhepf      | bnlage             |                     | Butikk hode                  |
| bohepf      | bolage             | boedat, boetim, boeusr | Bong hode                  |
| bodtpf      | bdlage             | bdedat, bdetim, bdeusr | Bong detaljer              |
| ...         | ...                | ...                 | ...                          |
| rkunpf      | rklagr             | rkedat, rketim, rkesig, rk2dpt, rkepgm | Kunder |
| rlevpf      | rllagr             | rledat, rletim, rlesig, rl2dpt, rlepgm | Leverandører |
| ...         | ...                | ...                 | ...                          |

Refer to the code for the complete list.

## Key Takeaways for New Developers

- **Purpose:**  
  This is a system-wide utility for updating all references to a warehouse number.
- **Scope:**  
  Touches almost every major file in the system where warehouse numbers are referenced.
- **Care Required:**  
  Due to its broad impact, this program should only be run by authorized personnel, with appropriate backups and coordination.
- **Extensibility:**  
  Any new modules referencing warehouses should be added here.
- **Audit and Compliance:**  
  Built-in audit updates ensure traceability for all changes.

## References

- **Data Dictionary:**  
  For field and file definitions.
- **Change Log in Source:**  
  For historical context and rationale for business rule changes.

---

**If you have further questions about specific files or audit field conventions, consult the system documentation or reach out to the application architect.**