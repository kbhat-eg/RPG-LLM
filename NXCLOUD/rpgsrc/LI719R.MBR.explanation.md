# RPG Program LI719R: Explanation

This RPG program, `LI719R`, is designed to manage and verify the active status for automatic EDI (Electronic Data Interchange) input processing. The program checks if EDI transfers are in progress and sets the relevant flags/statuses in related files. Below is an explanation of the main components and logic used in the code.

---

## 1. Program Header and Options

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `option(*nodebugio)`: No debug I/O; optimizes the program for performance.
- `datedit(*dmy)`: Default date format is day-month-year.

---

## 2. File Declarations

```rpg
ffjoblu    uf   e           k disk    rename(fjobpfr:fjoblur)
fgedglu    uf   e           k disk    rename(gedgpfr:gedglur)
ffjobl1    if   e           k disk    rename(fjobpfr:fjobl1r)
```
- Declares three files:
    - `fjoblur`: The Job Register (update access).
    - `gedglur`: Automatic update register (update access).
    - `fjobl1r`: Job Register (input access).
- Files use `rename` to refer to specific record formats.

---

## 3. Data Area and Variables

### Local Data Area (LDA)
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- `uds`: User Data Structure, mapping sections of the LDA for user, firm, and an additional field.

### Parameters
```rpg
7.01 d p_ovrf      s             10
d p_stat          s              1
```
- `p_ovrf`: EDI transfer request parameter (input).
- `p_stat`: Status indicator (output, 1-character).

### Other Variables
- Several working variables for firm, status, date/time, etc.
- `b_forn`: Boolean flag for "found" condition (unused here).
- `w_firm, w_stat, w_date, w_time, w_year, w_jsta, w_onof, w_ovrf`: Work fields for logic and file access.

### Constants
```rpg
d c_sfil          s              2  0 inz(10)
```
- Constant for status, possibly "sent file" type.

---

## 4. Main Logic Flow

### Program Initialization

```rpg
c                   eval      p_stat = *blanks
c                   exsr      sjekk_sub
c                   eval      *inlr = *on
c                   return
```
- Clear output parameter.
- Call `sjekk_sub` subroutine to perform main checks and updates.
- Set `*inlr` (last record indicator) to signal program end and clean up.
- Return from program.

---

## 5. Main Subroutine: `sjekk_sub`

This is the core process for checking and updating the EDI job status.

#### a) Check if an EDI transfer is already running (by job status register)

```rpg
c     fjobl1_key    chain     fjobl1r
c                   if        %found     and
c                             fajb07 = 1
c                   eval      p_stat = '1'
c                   goto      end_sjekk
c                   endif
```
- Uses a key (`fjobl1_key`) to check `fjobl1r` for an active job (where field `fajb07` = 1).
- If found, sets `p_stat` to '1' (active) and exits subroutine.

#### b) Check if an EDI transfer request is currently active

```rpg
c                   call      'AF775C'
7.01 c                   parm                    w_ovrf
c                   parm                    w_stat
```
- Calls an external program 'AF775C' to check for an active EDI request.
- Parameters: transfer request (`w_ovrf`) and status (`w_stat`).

```rpg
c                   if        w_stat  = '1'
c                   eval      p_stat = '1'
c                   goto      end_sjekk
c                   endif
```
- If the external program returns status '1', sets `p_stat` to '1' (active) and exits subroutine.

#### c) (Commented Out) Check if data from previous run remains

Lines:
```rpg
9.xx c**   call      'XF771C'
9.xx c**   parm                    w_stat
```
- These lines are commented out, suggesting the check for leftover temporary files is currently disabled.

#### d) (Optional) If above checks pass, update job register as active

```rpg
c     fjoblu_key    chain     fjoblur
c                   if        %found
c                   eval      fajb07 = 1
c                   update    fjoblur
c                   endif
```
- Updates `fjoblur` register, setting `fajb07` to 1 (active).

#### e) Update EDI update register with start time

```rpg
c     gedglu_key    chain     gedglur
c                   if        %found    and
c                             ggstat = 1
c                   time                    ggfdat
c                   time                    ggftid
c                   update    gedglur
c                   endif
```
- If the automation record is found and active (`ggstat = 1`), updates start date/time fields (`ggfdat` and `ggftid`) with current time, and writes back.

#### f) Subroutine End

```rpg
c     end_sjekk     endsr
```

---

## 6. Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
...
c     *entry        plist
7.01 c                   parm                    p_ovrf
c                   parm                    p_stat
...
c                   time                    w_date
c                   time                    w_time
c                   eval      w_year = %subdt(w_date:*years)
c                   eval      w_firm = l_firm
7.01 c                   eval      w_ovrf = p_ovrf
...
c                   endsr
```
- Sets up parameter list and keys for file access (`klist`/`kfld`).
- Initializes working variables, retrieves date/time, and extracts the current year.
- Assigns input parameters to working fields.

---

## 7. Comments, Change Logs, and Special Versions

- The header contains a detailed change log, including references to:
    - Initial program (`Nytt program`)
    - Test only (`Kun for test`)
    - Addition of transfer request parameter (`Overføringsanmodning kommer som parameter`)
- Norwegian comments are used throughout to clarify business logic.
- Certain version-specific code is commented out (`9.xx`).

---

## 8. Summary of File/Field Use

- `fjobl1r`, `fjoblur` — Job register, used for checking and updating job status (`fajb07`).
- `gedglur` — Register for automatic update, tracks process start time/status (`ggstat`, `ggfdat`, `ggftid`).
- `w_firm` — Key to identify the firm in the registers.
- Parameters `p_ovrf`, `p_stat` — Used for communication with external procedures/programs.

---

# **What the Program Does**

1. **Checks if an EDI process is already running** by consulting job registers and external programs.
2. **If not running, marks the process as active in the job register** and updates automated process records with the current start time.
3. **Returns a status flag (`p_stat`)** indicating whether the EDI transfer is already in progress (`'1'`) or has been newly set as active.

---

# **When to Use/Modify**

- Use this program in batch or scheduled jobs where you need to ensure only one EDI import runs at a time.
- Can be expanded to check for leftover temporary files or integrate further automation control.
- Adjust file fields (`fajb07`, `ggstat`, etc.) according to database/file definitions in your installation.

---

# **Best Practices for Onboarding**

- Familiarize yourself with the external program `'AF775C'`—it influences program control flow.
- Ensure understanding of which field in each file reflects the process status.
- The Norwegian comments provide business rules—review these carefully, especially if making functional changes.
- Test using the `p_ovrf` parameter and check that status codes are returned and set as expected.

---

**In summary:**  
This program is a control tool that prevents multiple concurrent EDI imports for a given firm and updates the relevant tracking files as soon as an import starts. It is a safety and synchronization mechanism in EDI automation.