# RH510R - General Ledger Inquiry, Voucher/Amount Search

## Overview

This RPG program (`RH510R`) is a core inquiry module in the ASOKON system, supporting advanced search and display of general ledger postings ("hovedboksposteringer"). It allows users to search, browse, and view accounting entries ("bilag") using various criteria (voucher number, amount, date, etc.), and to access details such as archived documents, sum entries, and associated notes.

The program is highly interactive, using subfiles for paginated display, and integrates with multiple other modules for extended functionality (document archive, notes, account details). It is designed for high usability in financial/accounting operations.

---

## Main Business Logic

### Functional Scope

- **Subfile-based paginated inquiry** of ledger postings.
- **Positioning/search** by voucher number, amount, or date.
- **Display of posting details** and associated metadata.
- **Access to related documents:** 
  - Invoice images (via archive integration, supports both legacy and modern archive systems).
  - Sum postings (aggregated view).
  - Post-level notes (notatark).
- **Dynamic subfile paging** and navigation (forward/backward).
- **Context-sensitive function key handling** for efficient user workflow.

---

## Key Data Structures and Files

### Physical Files

- **RHTRL4, RHTRL8, RHTRL9, RHTRL1**: Variants of the general ledger posting file, each supporting different keying schemes (by voucher, amount, date, and full posting key).
- **RKLAL3** (T5.50): Notes/annotations at the post level.

### Display Files

- **RH510D**: Main display file, includes subfile (`B1SFL`) and various control/command records (`B2CTL`, `B2CMD`).

### Data Structures

- **Local Data Area**: For user, firm, and navigation context.
- **Display Feedback (`dspfbk`)**: For subfile cursor/page management.
- **Key Variables**: Used for dynamic positioning in physical files.

---

## Core Program Flow

### Initialization (`*INZSR`)

- Sets up all key lists for file access and subfile positioning.
- Initializes context (firm, year, etc.) and primes the subfile with current year postings.

### Main Loop

1. **Display Opening Screen** (write `b2cmd`).
2. **Populate and Display Subfile** (`exsr dsp_subfile`).
3. **Handle Function Keys**:
   - Exit (`*INKC`, `*INKL`)
   - Refresh (`*INKE`): Repositions and reloads subfile.
   - Page forward/backward (`*IN10`, `*IN11`): Loads next/previous page.
   - Home/cursor management.
4. **Positioning**: If search fields are entered, call `posisjoner` to reposition the view.
5. **Subfile Interaction**: Process user actions on subfile lines (view, show sum, show archive, show notes).
6. **Repeat or Exit**.

---

## Subfile Management

### Subfile Population

- **`crt_subfile`**: Fills the subfile page-by-page. Reads from the appropriate ledger file variant, applying search criteria and firm/year filtering.
- **`clr_subfile`**: Clears the subfile (sets indicators, resets counters).
- **`bck_subfile`**: Handles paging backward, using `READP` to step through the file in reverse.

### Subfile Display

- **`dsp_subfile`**: Handles the EXFMT of the subfile control record. If subfile is empty, shows command screen.

### Subfile Interaction

- On subfile line selection, the following options are available:
  - **5: View Details** (`xc2win`): Shows full posting details, including notes if present.
  - **8: Show Sum Posting**: Calls `RH514R` with posting context.
  - **9: Show Archive Document**: Integrates with document archive (see below).
  - **Notes** (if available): Launches notepad for the posting.

---

## Positioning Logic

### `posisjoner`

- Handles user-initiated positioning by:
  - **Year change**: Repositions to the first posting for the new year.
  - **Voucher number**: Positions to the specified voucher.
  - **Amount**: Positions to the first posting with the specified amount.
  - **Date**: Positions to the first posting with the specified date.

- After positioning, clears and repopulates the subfile.

---

## Archive Integration

- **Archive Document View (Option 9)**:
  - Calls `AX700R` to check user access.
  - Determines document type and reference using `AP632R` (new logic) or legacy logic based on voucher code.
  - Calls `AP622C` to launch the document viewer, passing document type and reference.
  - Supports both ASP and Multiarchive systems (configurable).

---

## Notes/Annotations

- **Notes at Posting Level**:
  - Uses `RKLAL3` file to check for and display post-level notes.
  - If present, displays indicator (yellow voucher number) and enables note viewing/editing.
  - Notes are managed via `RF020R`, with context passed in a packed structure (`rxupar`).

---

## Account and Posting Details

- **Account Name Lookup** (`hent_text`):
  - Calls `RS740R` for account name.
  - Calls `RS707R` for department name.
  - Calls `RS728R` for cost bearer name.

- **Posting Details View** (`xc2win`):
  - Shows all posting fields and related info.
  - Integrates note status and allows launching the note editor.

---

## Design and Conventions

- **Indicator Usage**: Extensive use of IBM i indicators for state management (see comments for mapping).
- **Subfile Paging**: Custom logic for forward/backward navigation, supports arbitrary positioning.
- **Modular Integration**: Uses standard program calls to integrate with related modules (archives, notes, account details).
- **Domain-Specific Logic**: Voucher types, document type resolution, and archive integration are tightly coupled to business rules and system configuration.

---

## Key External Program Calls

- **`RS740R`**: Retrieve account name.
- **`RS707R`**: Retrieve department name.
- **`RS728R`**: Retrieve cost bearer name.
- **`RH514R`**: Show sum posting.
- **`AX700R`**: Check archive access.
- **`AP632R`/`AP622C`**: Document type resolution and archive viewer.
- **`RF020R`**: Notes management.

---

## Special/Legacy Considerations

- **Document Archive**: Supports both old and new archive systems; logic for document type and reference adapts based on availability.
- **Subfile Record Numbering**: Uses a combination of counters and feedback to manage current/first/last subfile record.
- **Data Area Usage**: Pulls firm/user context from LDA.
- **Internationalization**: Some variables and comments are in Norwegian; field names and business terms are from Norwegian accounting terminology.

---

## Summary

This program is a central, highly-interactive inquiry tool for general ledger postings, offering advanced search, navigation, and integration with document and note management. It is designed for power users in finance/accounting, and is tightly integrated with the broader ASOKON system modules.

New developers should pay close attention to:

- The subfile paging and positioning mechanics.
- The interaction with external modules (especially archive and notes).
- The business rules embedded in voucher/document type logic.
- The use of indicators and data structures for state and navigation management.