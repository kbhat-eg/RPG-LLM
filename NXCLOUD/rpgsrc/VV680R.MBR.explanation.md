# Explanation of RPG Program VV680R

This program is written in RPG IV (ILE RPG) and is designed for the IBM i (AS/400) platform. The program is called `VV680R` and, according to the comments, it is used for the deletion of items ("varer") without sales, based on parameters entered by the user.

---

## Header & File Declarations

### Header Specification

```rpg
h option(*nodebugio) datedit(*dmy)
```

- `*nodebugio`: Disables certain debug I/O features to aid performance.
- `datedit(*dmy)`: Default edit code for date fields is day/month/year.

---

### File Declarations

```rpg
flbchl1    if   e           k disk    rename(lbchpfr:lbchl1r)
fvv680d    cf   e             workstn
```

- `lbchl1`: An externally described file, used for batch validation (input).
- `vv680d`: A display file used for user interaction (workstation I/O).

---

## Data Area & Data Structures

### Local Data Area (LDA)

```rpg
d                uds
d l_firm                944    946  0
```
- LDA is used to access general information such as company number (`l_firm` from positions 944 to 946).

### Parameter List Data Structure

```rpg
d                 ds
d d_list                        80
d  d_firm                        3  0 overlay(d_list: 1)
d  d_kntr                        1  0 overlay(d_list: 4)
d  d_batc                       10    overlay(d_list: 5)
d  d_srt1                        1  0 overlay(d_list:15)
d  d_srt2                        1  0 overlay(d_list:16)
d  d_srt3                        1  0 overlay(d_list:17)
d  d_srt4                        1  0 overlay(d_list:18)
d  d_anto                        2  0 overlay(d_list:19)
d  d_ants                        2  0 overlay(d_list:21)
d  d_utgv                        1  0 overlay(d_list:23)
d  d_dummy                       1    overlay(d_list:24) inz('*')
```
- `d_list`: Raw 80-byte string for parameter passing.
- Overlays define where in `d_list` each parameter is stored (for calling subprograms).
- Fields store firm number, counter, batch, selection keys, and various delete criteria.

---

### Standalone Variables

- `lbchl1_batc`: Used to validate batch existence.
- `b_feil`: Boolean (1A), indicates an error in user input.
- `w_firm`: Company number (from LDA).
- `w_tmst`, `w_memb`, `w_tmst_20`, `w_tmst_12`, `w_tmst_9`: Used to generate a unique member name based on the current timestamp.
- `w_mld1`: Message string for error display.

---

## Main Program Logic

### Program Flow

1. **Initialization**
    - Number of months for main operations are initialized: `b1anto = 12`, `b1ants = 12`.

2. **Input Display Loop**
    - The main tag `b1tag` displays the input screen via `exfmt b1bld`.
    - The program then checks which function key was pressed (Exit, Inquiry, etc.).
        - `*inkc`/`*inkl`: Exit
        - `*inkd`: Inquiry; calls the `spørring` subroutine.

3. **Input Validation**
    - Calls subroutine `sjekk_input`.
    - If invalid input is found (`b_feil = *on`), returns to input.

4. **Generate Member Name**
    - Uses the system `TIME` opcode and string manipulation to build a unique 10-character member name (`w_memb`) from the current timestamp.

5. **Set Default Sorting**
    - If no sort values (`b1srt1-4`) are given, sets them to 1, 2, 3.

6. **Prepare and Call Deletion Program**
    - Populates the parameter list data structure (`d_list`) from screen fields.
    - Calls program `VV680C`, passing `d_list` and the unique member name.

7. **Program Exit**
    - Sets *INLR (last record indicator) to *ON and returns.

---

## Subroutines

### Inquiry (`spørring`)

- Handles lookups (e.g., batch number inquiry) by calling program `LC501R` if the user is working on the batch field.

### Input Validation (`sjekk_input`)

- Resets error flag.
- Validates:
    - If the batch is entered, checks its existence in `lbchl1` file.
    - Batch & delete-expired cannot both be filled.
    - For number-of-months input, values must not exceed 12.
    - Sorting values (b1srt1-4) must be between 1 and 3 (0 means not set).
    - Sets error indicators and flags used for screen field highlighting and for displaying error messages.
    - Displays error message through program `AA005R` if rules are broken.

### Initialization (`*inzsr`)

- Builds a key list for batch lookup.
- Retrieves company number from LDA.
- Sets initial defaults for input fields.

---

## Additional Notes

- The program heavily relies on externally described files and display files for user interaction.
- Error handling and field validation are tightly integrated with screen indicators and external message programs.
- The logic is modularized via subroutines for key operations: input validation, initialization, and inquiry.

---

## Summary Table

| Section                | Purpose                                                      |
|------------------------|--------------------------------------------------------------|
| File Declarations      | Input data and display files                                 |
| Data Structures        | Parameter passing to called programs                         |
| Standalone Variables   | Working storage and flags                                    |
| Main Logic             | Handles I/O, validation, generates unique member, calls batch|
| Subroutines            | Inquiry, validation, initialization                          |

---

### For New Developers

- **Parameter passing** uses overlays for easy transfer of multiple values between programs.
- **Input validation** is thorough and uses indicators to manipulate display feedback.
- **Error handling** is via external message program and screen indicators.
- **Batch and company number** validation ensures data integrity before performing deletions.
- **Extensive comments** (often in Norwegian) are provided for each logical section, making it easier to follow the business logic.

---

**Tip**: Review the display file (`VV680D`) and the called programs (`VV680C`, `LC501R`, `AA005R`) for a full understanding of user interaction and deletions.