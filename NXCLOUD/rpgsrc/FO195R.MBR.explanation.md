```markdown
# RPG Program FO195R - ASOFAK Gen. XML faktura

## Overview

This RPG (ILE RPG IV) program is responsible for generating invoices in XML format (EHF-standard, for SG Finans). It is designed for automation and handles electronic outbound invoices, including various business rules and exceptions. The program reads business data, gathers necessary invoice and partner information, processes orders and invoice lines, manages VAT and discounts, and outputs both XML files and (optionally) print/spool reports.

The code is historically evolved, as reflected by the many change log comments (with version markers) in Norwegian.

## Sections Overview

### 1. **Headers and Includes**
- `H`-specs for decimal edit, date edit, and options (e.g., `*nodebugio`).
- Source is bound to the `CGIDEV2` binder directory for HTML/XML generation routines.
- `/copy` statements pull in standard RPG header specs and prototypes for external calls.

### 2. **File Definitions (F-specs)**
- Multiple logical files (`if e disk`) over various tables: customers, order headers, lines, articles, price codes, etc.
- XML and print outputs are defined as output or printer files.

### 3. **Data Structures and Variables (D-specs)**
- Definitions for:
  - Local data area overlays (for job/user info, etc.)
  - Key variables for file lookups.
  - Working variables for fields found in invoices, lines, partners, and totals.
  - Arrays to accumulate VAT per rate (`mgr`, `msa`, etc.)
  - PDF/Email and XML structure variables for output management.

### 4. **Main Logic**

#### a. **Initialization**
- *INZSR subroutine processes program input parameters (`p_aarr`, `p_faty`, ...).
- Sets up various key lists for database accesses.

#### b. **Preliminary File Reads**
- Reads company data (`afirl1`), status data (`fstsl1`), invoice type, and status code 8.
- If not found, program aborts early.

#### c. **Main Loop over Invoice Logs**
- Dependent on process type (`p_omkj`), loops through invoice logs (`fnufl2` or `fnufl1`).
- Skips already processed or out-of-range logs.
- For each relevant log:
  - Checks the log with `sjk_uf_log`, possibly skips invoices without lines (EHF/E-Invoice compliance).
  - For each invoice, writes XML batch start, report header, and then loops over all orders (`sohel1`) for this invoice.
  - For each order, processes order header, partner info, and iterates through all lines, handling header/footer texts, items, and discounts.
  - Accumulates totals, VAT, and discounts.

#### d. **XML Output**
- After all invoices, writes the XML end, and if data was processed, triggers post-processing:
  - Writes totals, generates a PDF, emails, etc.
  - Optionally triggers an external archiving process via a data queue.

#### e. **Cleanup**
- Updates processed logs, closes files, and ends the job.

---

### 5. **Subroutines (Subroutines, marked with `begsr`/`endsr`)**

**XML/Jasper Integration:**
- `xml_start`, `xml_end`: Handles XML document tagging and calls to CGIDEV2 routines for XML manipulation.

**Invoice Header & Partner Information:**
- `sub_fakthod`: Gathers invoice header info, including type, recipient, bank, etc. Handles type-specific rules (e.g., invoice vs. credit note).
- `sub_fakpart`: Gathers partner/customer/seller info, and outputs multi-party blocks (buyer, seller, invoicee, delivery address).

**Order Handling:**
- `sub_ordrehod`: Adds order header info (delivery, project, seller, logistics).
- `sub_varel`: Processes each invoice line (item or text); gathers product info, does price, VAT, discount calculations, and accumulates totals.
- `sub_what`: Placeholder routine for handling unknown line types.

**Text Block Handling:**
- `sub_toppt`, `sub_topp_str`, `sub_topp_end`: Handle top/bottom text lines for XML output, ensuring the correct XML tags are emitted.
- `sub_bunnt`, `sub_bunn_str`, `sub_bunn_end`: Similar, but for "footer" texts.

**Totals and VAT:**
- `skriv_fslut`: At invoice end, writes taxes, deposit, discounts, totals to XML.
- `sub_avgifter`, `sub_avgl`: Processes additional charges (fees) as separate XML lines.
- `sub_depos`: Handles deposit (advance payment) subtractions as negative lines.
- `sub_spsrab`: Outputs special discounts (bruksrett - user rights).
- `sub_netto`: Finalizes net price/totals after all calculations.
- `sub_MVAlin`: Outputs VAT break-down lines, per rate.
- `sub_total`: Calculates and emits XML with overall totals, KID/check numbers, and rounding.

**Order Line Tagging:**
- `sub_olslutt`, `sub_oslutt`: Tag/end order lines and order sections in XML.

**Array Handling:**
- `xarray`: Accumulates VAT/totals per VAT code (multi-rate VAT support).

**Modulus 10 Calculation:**
- `mod10`: Calculates the Modulus 10 check digit, primarily for KID numbers.

**Invoice Logging:**
- `sjk_uf_log`: Verifies if invoice is eligible to be processed/logged, skips according to parameters/business rules.
- `upd_uf_log`: Updates invoice log with processing time/user info.

**Bruksrett Discount Handling:**
- `sjk_bruksrett`: Sums up special usage rights discounts across all order headers for the invoice.

**Report Printing:**
- `skr_rapph`, `skr_rappl`, `xovrfl`: Handles print header/detail and overflow for report output.

**Spool File and PDF Mailing:**
- `spoolnbr`: Retrieves spool info for the generated report (for mailing as PDF).
- `xml_create`: Calls a separate program to generate/post-process XML (e.g., for sending PDFs by email).

### 6. **Business Logic Highlights**
- Handles multi-type invoices: E-invoice, Archive, Email, Special.
- Several routines for robust partner/address/format handling (cleaning for XML, fallback logic for email, GLN, etc.).
- Handles rounding issues, null/zero checks, and localizations (ISO dates, decimal marks).
- Ensures only invoices with lines are processed and output.
- Systematically outputs all relevant information as XML tags using CGIDEV2 routines.

---

## Key Points for New Developers

### **System Architecture**
- This is a batch RPG program driven by input parameters and database contents.
- Uses **CGIDEV2** for XML/HTML generation (HTML templates, substitution variables, section writing).
- Zealously checks for found/not found, null/zero conditions to prevent errors in batch runs.
- Integrates closely with other RPG programs for address lookup, project info, email, PDF/Jasper report generation, etc.

### **Core Data Flow**
1. **Initialization**: Sets up the environment, keys, buffers.
2. **Master Loop**: For each invoice candidate from log files, perform:
   - Gather all necessary master data.
   - For each order belonging to invoice:
     - Output order header, project, delivery, seller info.
     - For each detail line:
       - Output item/fee information, calculate discounts and VAT.
   - At end: Output totals, update logs, and possibly start further routines (mail, archive, print).
3. **Termination**: Clean up, close outputs, update job logs.

### **CGIDEV2 XML Output**
- Routines like `UpdHTMLVar(field: value)` assign values to a variable used in the XML template.
- `WrtSection('SectionName')` emits a named template section to the output XML.
- The XML file is built in sequential sections to produce an EHF-compliant file.

### **Modification, Troubleshooting, and Extension**
- Changes to invoice composition (extra tags, new business rules) generally require:
  - Mapping new data from the database.
  - Adding/adjusting subroutines for output.
  - Modifying the corresponding XML template file.
- New invoice types or output destinations are controlled in the logic setting variables like `w_btyp`, `w_mtyp`, and via template names/section names.
- Thoroughly instrumented with flags for error detection and flow control (e.g., `b_logf`, `b_pdfv`).

### **Testing and Deployment**
- Tests should focus on edge cases (invoices with/without lines, multiple VAT rates, zero/negative values, deposits, rounding, etc.).
- Isolating subroutines for independent testing (e.g., VAT breakdown, partner info output) is advisable.

---

## **Summary Table**
| Module       | Purpose                                      |
|--------------|----------------------------------------------|
| Initialization (`*inzsr`) | Parameter/variable setup, keylists |
| Main Logic   | Loop over invoices, process and output XML   |
| XML Routines | Write XML tags/sections using CGIDEV2        |
| Partner/Order| Get and sanitize customer, order data        |
| Item Output  | Output invoice line (item or text line)      |
| Totals/VAT   | Calculate, accumulate and output totals/VAT  |
| Discounts    | Handle and output order/item discounts       |
| Logging      | Validate and update processing logs          |
| Spooling/PDF | Generate/Email PDF from spool, send XML      |

---

## **References**
- **CGIDEV2**: IBM i toolkit for dynamic HTML/XML generation.
- **EHF**: Norwegian standard for electronic invoices (XML-based).
- Code comments are in Norwegian; consult a native for nuanced understanding if needed.

---

### **How to Onboard Quickly**
- Start by tracing the main program flow for a single invoice, following the subroutine calls.
- Identify where your data of interest is captured, accumulated, and output.
- Use the change log in the comments to understand recent modifications and business rules.
- Validate output by running test cases and comparing output XML to EHF standards and customer requirements.

---

**Note:** This program is *complex and business rule intensive*. Always review both the RPG code and the external templates/scripts (CGIDEV2, Jasper reports) when making changes.
```