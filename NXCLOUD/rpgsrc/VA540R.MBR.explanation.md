# Program Overview

This RPG (Report Program Generator) program manages a list of "info-types" using subfiles (scrollable, interactive lists on IBM iSeries displays). It provides powerful display and selection logic, allowing users to page forward and backward through records, position to specific entries, and select an item. It interacts with two physical files, manages subfile paging, and processes function keys for navigation and selection.

The comments are a mix of Norwegian and English, but the structure and logic are typical for classic "green screen" RPG applications.

---

## File Declarations (`F-Specs`)

```rpg
fvinfl1    if   e           k disk    rename(vinfpfr:vinfl1r)
fvinfl2    if   e           k disk    rename(vinfpfr:vinfl2r)
fva540d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **vinfl1** and **vinfl2**: Input Full procedural files, keyed, renamed record formats for accessing "info type" and "description".
- **va540d**: Display file (workstation), using subfile B1SFL indexed by `w_srrn`. The display feedback area is mapped to data structure `dspfbk`.

---

## Data Structure and Variables (`D-Specs`)

### Parameters and Fields

```rpg
d p_firm      s    like(vaifir)
d p_ityp      s    like(vaityp)
d p_itxt      s    like(vaitxt)
```
- Parameters for company (`p_firm`), info type (`p_ityp`), and info text (`p_itxt`).

### Display Feedback Data Structure

```rpg
d dspfbk      ds
d  d_fcrn          378    379I 0
```
- Used to retrieve the first cursor record number for subfiles.

### Subfile and Paging Control Variables

```rpg
d w_fcrn      s    4  0
d w_stel      s    4  0
d w_spge      s    4  0
d w_srrn      s    4  0
d w_sfrn      s    like(w_srrn)
d w_ssrn      s    like(w_srrn)
d w_seqe      s    1
d b_valg_ok   s    1 inz(*off)
```
- Variables to manage subfile paging: counters, current/first/last record numbers, selection status.

### Other Working Fields

```rpg
d w_firm      s    like(vaifir)
d c_sfil      s    2  0 inz(8)
```
- `w_firm` stores the active company key, `c_sfil` is the page size (number of subfile records per page).

---

## Indicator Usage

The program makes heavy use of classic RPG indicators. Most notably:

- `*INLR` - End program
- `*IN10` - Page forward
- `*IN11` - Page backward
- `*IN12` - Subfile display
- `*IN13` - Subfile control display
- `*IN14` - Subfile clear
- `*IN15` - End of subfile/page
- `*IN21`, `*IN22` - Positioning-related
- Others (31-79) - Messages/fields; (80-99) - Working indicators

---

## Program Flow

### Entry (`*inzsr`)

- Receives parameters (`p_firm`, `p_ityp`, `p_itxt`).
- Initializes subfile keys (for info type and description).
- Positions to start of the relevant file.
- Calls subroutine to populate the first subfile page.

---

### Main Loop

#### Tags:

- `b2taga` and `b2tagb` mark the user interface loop points.

#### User Interface Handling:

- Displays the subfile, processes function and control keys (paging, positioning, selecting).
- Uses RPG's `select/when` construct to determine the user's action.

#### Function Key Logic:

- **Exit (`*INKC` or `*INKL`)**: Go to `avslutt` (exit).
- **Renew (`*INKE`)**: Calls `forny` (refresh) and displays subfile again.
- **Roll-up/Page forward (`*IN10`)**: Calls `crt_subfile` (populate next page), then redisplays.
- **Roll-down/Page back (`*IN11`)**: Calls `bck_subfile` (previous page), then redisplays.
- **Home (`*IN21`)**: Sets `*IN22` (cursor positioning), redisplays.
- **Else**: Checks for positioning requests, runs `posisjoner` if needed, and otherwise processes selection/subfile logic.

#### Selection Handling:

- If a selection is made (`b_valg_ok = *on`), the loop exits and the program ends.

---

### Subroutines

#### `forny` (Renew/Refresh Subfile)

- Repositions to current record.
- Sets key positioning for subfile depending on `w_seqe` (distinguishes search by info type or description).
- Clears and repopulates the subfile.

#### `posisjoner` (Position in Subfile)

- If a positioning field (`b2ityp` or `b2itxt`) is entered, sets key and file position accordingly.
- Clears positioning fields after use.
- Clears and refills subfile (reflecting new position).

#### `subfile` (Process Subfile)

- Toggles positioning indicator.
- Reads subfile records interactively (`readc b1sfl`).
- If a selection is made (`b1valg = 1`), sets output parameters, flags `b_valg_ok` for exit.

#### `clr_subfile` (Clear Subfile)

- Signals subfile clear by turning on relevant indicator, issues control record write, and resets all subfile counters.

#### `crt_subfile` (Create/Fill Subfile)

- Increments page number, sets next record number.
- Reads records (from the correct file) into the subfile up to the page size (or end of records/company).
- Updates data and screen buffer with file content for the subfile.

#### `bck_subfile` (Back One Page)

- Pages backward in the subfile by reading records in reverse (`readp`), then repopulates subfile at the new position.

#### `dsp_subfile` (Display Subfile)

- If the subfile has data, turns on display indicator and executes a format; if not, writes the command screen.

---

## Pseudocode Summary

```pseudo
INITIALIZE
  Get parameters (firm, info type, info text)
  Position to start/key
  Build first subfile page

MAIN LOOP
  Show subfile screen
  Wait for function key/user input
  If exit key: exit program
  If 'renew': reposition and repopulate subfile
  If 'page forward': build next page
  If 'page back': build previous page
  If 'home': position to top
  If positioning fields entered: reposition and repopulate subfile
  If row selected: copy selection to parameters, exit

EXIT
  Set LR to end program
```

---

## Subfile Variable Explanations

- `w_fcrn` - First record number on the page
- `w_stel` - Subfile record counter
- `w_spge` - Page size
- `w_srrn` - Current subfile record number
- `w_sfrn` - First record number on last page
- `w_ssrn` - Last record number on last page
- Others: Used for cursor/field management in the display.

---

## Summary

- The program takes a company, info type, and info text as parameters.
- It provides a paged, scrollable list of relevant info from one of two files.
- The user can scroll, position to a value, or select an entry using the subfile interface.
- Paging and key handling is classic for green-screen RPG subfile programs.
- All subfile and display logic is meticulously managed by RPG indicators and work fields.
- The program is well-structured, with clear separation into subroutines for each logical operation.

This is a typical, maintainable green-screen RPG interactive program using indexed files and a subfile-driven display.