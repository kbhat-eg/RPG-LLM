# Explanation of RPG Program RK630R

This RPG program, designed for the IBM i (AS/400) platform, manages user interaction to select and validate parameters for printing a customer balance report. It features display handling, input validation, and parameter preparation, integrating several subroutines for user prompts and field selection.

---

## 1. **Header and Documentation Block**
- **Purpose:** The comments at the top provide system information, program name, description, version history, and indicator usage. 
- **Version Tracking:** Modifications are clearly tracked (e.g., "V5.00", "V5.30") and are referenced in the code with tags (e.g., `T5.30`).
- **Indicator Usage:** Documents which indicators (*INxx) are used for various logic blocks, error flags, file I/O, etc.

---

## 2. **File and Display Definitions**

```rpg
fausrl1    if   e           k disk
frk630d    cf   e             workstn
```
- **ausrl1:** Input file, keyed, used to read user records.
- **rk630d:** Display file, workstn device (screen interaction).

---

## 3. **Variable Definitions**

- **Simple Variables:** e.g., `waar`, `wmnd`, `wpakod`, `wpdat1` for integer and date manipulation.
- **Parameter Variables:** prefixed with `p_` or similar, for passing/receiving data to/from subroutines and external programs.
- **Work Variables:** e.g., `w_firm`, `w_user` for current firm/user context.
- **Indicator Arrays:** For dialog messages (`var`), message location (`wsavli`, `wsavpo`).

---

## 4. **External Data Structures**

```rpg
d/COPY QCPYLESRC,RPARRKDS
```
- **RPARRKDS:** An external copybook/Data Structure is included for additional field definitions related to the parameter screen.

---

## 5. **Main Control Flow**

### a. **Display Parameter Entry Screen**

```rpg
c     exfmt     a2bld
```
- Presents the main parameter selection screen (`a2bld`).

### b. **Resetting Error Flags**

```rpg
c     eval      *in31 = *off
c     eval      *in32 = *off
...
```
- Resets error/warning indicators before validation.

### c. **Function Keys Handling**

- **F3 (Exit):**
    - If *INKC (F3) is pressed, set `p_in03 = '1'` and exit.
- **F4 (Prompt):**
    - If *INKD (F4), enter the subroutine `spr_rut` to let users prompt/select field values using search programs.

### d. **Input Validation Sections**

- **Date Validation:**
    - Ensures a processing date is provided and valid.
- **Fiscal Year Check:**
    - Warns if the entered fiscal year is greater than the current year, using the `xm1win` subroutine for user confirmation.
- **Range Checks:**
    - From/To validation for: departments, customer categories, sellers, and customer number.
- **Summary Level Validation:**
    - Ensures only one sum-level (e.g., department, category, seller) can be chosen at a time.

### e. **Parameter Preparation**

- Moves validated screen values to the program's parameter variables, preparing for the report creation or further processing.

---

## 6. **Exit Routine**
- Sets LR indicator `*inlr = *on` to end the program.

---

## 7. **Subroutines**

### a. **Field Prompt Routine (spr_rut)**
- Based on which field the cursor is on (`w_afld`), calls "search programs" for user selection (e.g., `RA507R`, `RA511R`, `RA509R`, `RK500R`).
- Updates the corresponding "From" and "To" fields on the screen and activates relevant indicators.

### b. **Warning Window Routine (xm1win)**
- Displays a popup message window for confirmation (e.g., if fiscal year exceeds current year).
- If user presses F3 in the popup, response variable `m1svar` is set to 'N'.

### c. **Initialization (*inzsr)**
- Sets up initial parameter values and default ranges.
- Loads user-specific data from `ausrl1`.
- If restricted to a specific department, sets both department from/to accordingly.
- Defines the program’s parameter list entry (`*entry plist`).

---

## 8. **Key Constants and Usage**

- **Indicators:** Used heavily for both internal flags and display attributes.
- **Tags (labelled C TAG):** Used for structured GOTO control flow.
- **PLIST/KLIST:** Old-style parameter passing and keyed lookup for user record.
- **Data Movement:** Uses MOVE/MOVEL and EVAL—reflects classic RPG IV style.

---

## 9. **Internationalization**

- Norwegian variable/comment names, labels, and messages.
- Some message texts are provided at the end, e.g., warning about selecting "next year" as accounting period.

---

## 10. **Summary of Program Function**

1. **Screen input:** Prompts user for parameters for a customer balance report.
2. **Validation:** Checks parameter consistency (e.g., date, ranges, choices).
3. **User Aid:** Allows lookup/selection via sub-programs for key fields.
4. **Confirmation:** Warns when non-standard parameters are chosen (e.g., future periods).
5. **Exit:** Returns parameters for further processing by other routines or report programs.

---

## **Getting Started as a Developer**

- **Understand Indicator Usage:** Many checks and UI logic rely on *INxx indicators.
- **Familiarize With Display Files:** `a2bld` (main screen), `m1win` (popup window) must be understood/customized as needed.
- **Trace Parameter Flow:** Variables are often moved/copied to and from screen/work/parameter variables.
- **External Programs:** Know the purpose of support programs (`RA507R`, `RA511R`, etc.) called for field lookups.

---

## **Common Maintenance Tasks**

- Adding/removing prompt logic for new fields by extending `spr_rut`.
- Adjusting validation logic per business rules.
- Updating the display file if parameter screens change.
- Ensuring data mappings to report routines remain correct after modifications.

---

This structure and extensive in-line documentation make it manageable for new developers, provided they have some familiarity with RPG IV conventions and the company-specific business context.