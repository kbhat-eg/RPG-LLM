# RPG Program RP510R — Source Code Onboarding Explanation

This RPG program, named **RP510R**, is part of an accounting or general ledger system used for **journal entry inquiry**, especially searching and displaying vouchers/amounts (bilag/beløp). It is a traditional ILE RPG (likely RPG IV) green screen program making heavy use of subfiles and database files.

Below, I break down the code structure and logic for easier onboarding.

---

## 1. **Header/Comments**

- **Purpose**: General ledger/journal inquiry by voucher/amount.
- **System**: ASOKON.
- **Notes**: Special version notes and change history, mainly GUI adaptations (7.00, 19.12.17).
- **Indicator Usage**: Lists the RPG indicators (LR, 10, 11, etc.) and what each is used for (scrolling, protecting fields, error messages, work indicators).

---

## 2. **File Declarations**

- Four database files (**rhtrlc**, **rhtrld**, **rhtrle**, **rhtrl1**) are declared with record-level access, all renamed to unique record formats.
    - Typically, each file is keyed and is used for lookup based on a different field (account, voucher number, date, etc.).
- **rklal3** is another database file, likely for notepad functionality.
- **rp510d** is the display file with a subfile (**b1sfl**).
- **infds(dspfbk)** attaches an information data structure for display feedback.

---

## 3. **Data Structure Declarations**

### a. **Local Data Area**
Mapped variables to retrieve user, firm, and name from the LDA.

### b. **Display Feedback Structure**
- **dspfbk** contains, e.g., `d_fcrn` (first record number on page), used for subfile navigation.

### c. **Key Variable Declarations**
- Variables to hold pieces of the keys for each file (e.g., `rhtrlc_kont`, `rhtrld_biln`), typically containing account or voucher-related fields.

### d. **General Working Variables**
- Subfile paging variables (`w_stel`, `w_spge`, etc.).
- Other workflow flags and fields (`w_seqe` for sequence, `b_valg_ok`, etc.).
- Constants like `c_sfil` (subfile page size).
- Several parameters for archiving/document program calls.

### e. **External Parameter Definitions**
- `/COPY QCPYLESRC,RF020PAR` copies in parameter definitions for a program called `RF020R` (for note blocks/notepad functionality).
  - These include overlays for quick field access in a flat buffer.

---

## 4. **Screen/Field Description Comments**
Explains variables, especially those related to **subfile processing** and paging, and which display formats are used (B1SFL, B2CTL, etc.).

---

## 5. **Main Program Logic**

### a. **Entry & Initialization**
- *inzsr subroutine initializes the program:
    - Reads entry parameters (`p_firm`, `p_hpro`).
    - Sets up key lists for database access.
    - Fills initial subfile page for the default year/account.

### b. **Main Menu Loop**
- Tag-based program flow using labels like `b2taga`, `b2tagb`.
- **Write b2cmd**: displays the command keys window.
- **exsr dsp_subfile**: shows the subfile window.
- **SELECT block**: Handles function keys (F3=Exit, F12=Cancel, F5=Refresh, Roll Up/Down, Home Key, etc.).
    - Calls relevant subroutines for each function (refresh, create subfile, go back, positioning).

### c. **Positioning in Subfile (`posisjoner`)**
- Repositions the subfile based on input fields (account, voucher number, voucher date, year).
- Uses SETLL to reposition the relevant file for efficient reads.
- Calls `clr_subfile` and `crt_subfile` to blank and fill the subfile based on the new position.

### d. **Subfile Handling Loop (`subfile`)**
- Toggles display indicator to alternate subfile state.
- Reads and processes subfile records with READC in a loop.
- Handles special actions based on user input in the subfile row (`b1valg` field):
    - Value 5: "View" — calls detail window (`xc2win`).
    - Value 8: "View sum post" — fetches text, calls another program.
    - Value 9: "Show archive" — checks access, optionally fetches document type and invokes archiving programs.

### e. **Subfile Fill/Clear Routines**
- **clr_subfile**: Blanks out the subfile and resets paging variables, writes B2CTL.
- **crt_subfile**: Fills next page of the subfile by reading from appropriate file based on sequence variable, populates subfile record fields, and writes them out. Handles notepad marking.
- **bck_subfile**: Handles roll-back/scroll-back by reading previous records using READP.

### f. **Subfile Display (`dsp_subfile`)**
- If there are records, sets indicator and does EXFMT on B2CTL; otherwise, writes B2CMD.

### g. **Detail View (`xc2win`)**
- Chains to detail record, loads fields for "view" window.
- Runs notepad check and shows notepad if requested by the user.

### h. **Text Retrieval (`hent_text`)**
- Calls three different programs to retrieve:
    - Account name (RS740R)
    - Department name (RS707R)
    - Cost bearer name (RS728R)
- Handles cases where cost bearer is not found.

### i. **Notepad Handling (`notat`)**
- Sets up and calls `RF020R` to display or update notepad for the journal entry.

---

## 6. **Data Access (Key lists)**
- *inzsr* sets up several keyed access lists for efficient database operations, performed with SETLL, READ, and CHAIN as appropriate.

---

## 7. **Screen/Key Handling**
- Uses indicators and fields to manage subfile state, cursor position, protection, and paging.
- Supports typical function key handling for navigation and actions.

---

## 8. **Program End**
- **Avslutt** tag: Terminates program when user exits.

---

## 9. **Special Features and Version Tags**
- Many lines are tagged with version and function comments (e.g., 6.22, T5.50, pdf, etc.).
    - These mark code added or changed for specific releases, often related to notepad or archive/document features.
- Some calls and logic are included only in certain versions (`AP632R`, `AP622C`, etc. for document management).

---

## 10. **Other Notable Aspects**
- **Internationalization**: Norwegian for variable/comments.
- **Old-style RPG**: Uses fixed-format C-specs, indicators, tag/goto flow.
- **Business Domain**: Purely accounting/journal entry domain—uses parameters and terminology standard for Norwegian ledger/accounting systems.

---

# **Quick Onboarding Summary**

- **What does the program do?**  
  Lets users browse general ledger/journal entries using various search criteria, utilizes subfiles to list/move through entries, and supports viewing details, related archive documents, and entering/viewing notepad entries per journal item.

- **Key business flows:**  
  1. User enters search (account/year/date/voucher number)  
  2. Subfile is filled with journal entries  
  3. User can scroll, filter, or select rows for more actions (view, archive, notepad)  
  4. Detail and archive programs can be called depending on user choice.

- **Files/tables:**  
  Multiple files, each supporting fast lookup based on a specific key, with related display and notepad/archive integration.

- **Display logic:**  
  Heavy subfile use for paging and navigation, detailed use of indicators for state management.

- **Extensions:**  
  Notepad functionality, archive/document handling via separate programs.

---

## **References for Developers**

- **Subfile programming**: Understand classic display file subfile techniques in RPG.
- **Indicators**: Know how indicators are used for field-level control and branching.
- **Database access**: Proficient with SETLL, READ, READC, CHAIN, and keyed access.
- **External program calls**: Key for understanding integration with notepad and archive/document systems.
- **Multi-version support**: Code is annotated for features added at various releases.

---

**In summary**: This is a classic complex RPG inquiry program using subfiles for fast user navigation of journal entries, with advanced features for viewing details, related documents, and notepad entries, and is heavily driven by business logic and display file interactions.