# Explanation of RPG Program: ASOFAK (FA912R)

## **Purpose**

This RPG program (`ASOFAK`) is a subroutine for rounding ("avrunding av beløp") amounts on the form 9:2 (9 digits, 2 decimals), used for calculating a sales price including VAT/MVA.  
It receives 3 unit codes and 3 prices, finds the correct rounding rule based on various input parameters and updates prices accordingly.

---

## **High-Level Flow**

1. **Initialization**:  
   The program receives key parameters (firm, groups, supplier, module, product, prices for 3 units, unit codes, and a type variable) through the program entry parameter list.

2. **Look up Supplier**:  
   It looks up the supplier (`levl3_enum`) using the supplier number provided in the parameters.

3. **Find Rounding Rule (Regel) in `jav1l1` (via chain statement)**:  
   A sequence of increasingly general searches is performed to find the most specific rule that matches the input (working from specific: supplier and product, to general: only group).

4. **Abort if No Rule Found**:  
   If no matching rule is found, the program ends with no rounding.

5. **Check Calculation Source**:  
   If the rule says to calculate from "nobb" and parameter says not to, exit.

6. **Select Price According to Unit**:  
   If the rule specifies a unit and it matches one of the three passed-in units, use the corresponding price.

7. **Find Rounding Parameters (`jav3l1`) and Perform Rounding Calculation**:  
   Using the found rule and the selected price, rounding calculations are performed based on the parameters from the rules file.

8. **Update Price Outputs**:  
   The relevant price parameter (`p_s1im`, `p_s2im`, or `p_s3im`) is updated with the rounded value.

---

## **Key Sections and Concepts**

### **Data Definitions**

- **Files Declared**
  - **`jav1l1`** – Rounding Rules (RENAMED from `jav1pfr`)
  - **`jav3l1`** – Rounding Parameters (RENAMED from `jav3pfr`)
  - **`jlevl3`** – Supplier Lookup (RENAMED from `jlevpfr`)

- **Variables for Keys** – Used for searching rules (`_firm`, `_ogrp`, `_hgrp`, `_ugrp`, `_levr`, `_modu`, `_vare`, etc)
- **Calculation/Working Variables** – Prices, calculation intermediates, rounded price (`w_pris`, `w_fraa`, etc)
- **Parameters** – See subroutine `*inzsr` for entry parameter list

---

### **Main Calculation Logic**

#### **1. Look up Supplier**
```rpg
levl3_enum = p_enum
chain jlevl3_key jlevl3
if not %found(jlevl3)
  goto avslutt
endif
```
- Looks up supplier based on enum passed in (`p_enum`).  
- If not found: exits immediately.

---

#### **2. Find the Most Specific Rounding Rule**
The code tries a cascade of key combinations, each time reducing specificity, e.g.:

- **Supplier & Product**
- **Product only**
- **Supplier & Module**
- **Module only**
- **Groups & Supplier**
- **... etc ...**
- **Just the group**

Each time it checks if the rule is found, otherwise it reduces the key specificity and searches again.

If no rule is found or rule is *zero*, it exits.

---

#### **3. "Nobb" Calculation Check**
```rpg
if jlkkal = 1 and ja1nob = 0
  goto avslutt
endif
```
- If the rule requires a calculation from "nobb" (which seems to be some source of base prices), but the parameter says don't, exit.

---

#### **4. Pick the Input Price Matching the Rule's Required Unit**

- The rule says whether the rounding applies to a specific unit. The code determines which price (`p_s1im`, `p_s2im`, or `p_s3im`) is relevant, based on the unit in the rule (`ja1enh`) and the three units passed in (`p_enh1`, `p_enh2`, `p_enh3`).  
- Sets working variable `w_frpr` and the unit type (`p_type`) accordingly.

---

#### **5. Retrieve Rounding Parameters & Calculate Rounded Price**

```rpg
// Set up keys for jav3l1 lookup
move p_firm to jav3l1_firm
eval jav3l1_regl = ja1rgl
eval jav3l1_frpr = w_frpr

setll jav3l1_key jav3l1
readp jav3l1

if not %eof(jav3l1) and jafrpr < jav3l1_frpr ... 
  // Rounding calculation performed here
```

**Rounding calculation details:**
- Computes how far in "rounding intervals" you are from the minimum price (`w_fraa`)
- Calculates base rounded price (`w_utgp`)
- Checks whether price falls within a certain rounding boundary (`w_gren`)
- Sets the rounded price accordingly (rounded down or up)

---

#### **6. Update Output Parameters**

Based on which unit/price was involved, puts the rounded price into the appropriate return variable (`p_s1im`, `p_s2im`, or `p_s3im`).  
If no unit required, sets `p_s1im` with the rounded price.

---

### **Entry Parameter List (`*inzsr`)**

Defines all parameters passed from the calling program:
- Firm, Over-group, Head-group, Under-group, Supplier code, Module, Product
- 3 input prices (`p_s1im`, `p_s2im`, `p_s3im`)
- 3 unit codes (`p_enh1`, `p_enh2`, `p_enh3`)
- Type

### **Key Lists**
Defines composite keys for use in chained lookups of the rule and parameter files.

---

## **Summary Table**

| Step                             | Purpose                                           |
|-----------------------------------|---------------------------------------------------|
| Supplier Lookup                   | Gets supplier record for base values              |
| Find Rounding Rule                | Selects most appropriate rounding rule            |
| "Nobb" Check                      | Optional: skips if rule calculation source mismatches |
| Select Relevant Price             | Picks which price to round based on units         |
| Rounding Parameter Lookup         | Gets intervals/details for rounding calculation   |
| Perform Rounding Calculation      | Applies math to determine rounded price           |
| Update Return Values              | Returns new price(s) in parameter(s)              |

---

## **Things To Watch/Know When Maintaining**

- The program's search for rounding rules is hierarchical: it always tries the most specific rule first, and falls back to more general rules.
- The calculation logic (in the rounding math segment) may be tightly coupled to the business rules for price intervals and must be tested for edge cases.
- File dependencies: This program relies on external data in the `jav1l1`, `jav3l1` and `jlevl3` files. Changes to those files' structures or data will impact this logic.
- The parameters are all passed by reference, so updating e.g. `p_s1im` will return the updated (rounded) price to the caller.
- Comments in Norwegian (“avrunding”, “leverandør”, “vare”) – some business terms in code and documentation.

---

## **Conclusion**

This ILE RPG program implements a complex, highly parameterized rounding logic for product sales prices, choosing the rounding rule dynamically from a set of data files, and applies rounding to the appropriate price(s) depending on units. The code structure is typical for legacy RPG, with sequential `CHAIN`/lookup logic and heavy use of parameter lists. The logic is well-documented in comments (in Norwegian), and the search for rounding rules follows a clear hierarchy from most-specific to least-specific. 

**Understanding the business rules encoded in the lookup order and rounding math is crucial for modifying or extending this program.**