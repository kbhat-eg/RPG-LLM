# RPG Program RA524R Explanation

This RPG/400 (ILE RPG) program is built for the IBM i system (AS/400) and is intended for querying inventory transaction codes. The code uses subfiles on a workstation display file, leverages several physical files, and allows for page-up/page-down navigation and selection functionality.

The code structure and its logic are typical for classic RPG, using fixed-format (C-specs and D-specs), indicators, and subroutines (EXSR). Below is a breakdown of the vital parts, with explanations for onboarding new developers.

---

## 1. Header and Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: No I/O debugging.
- `*dmy`: Default date format is day/month/year.

```rpg
* Program . . . . : RA524R
* Description . . : Inventory transaction code, inquiry
* Version history, change logs, usage of indicators, and file descriptions.
```
The code comes with detailed comments in Norwegian, explaining change history and indicator usage.

---

## 2. File Declarations

```rpg
fra24l1    if   e           k disk    rename(ra24pfr:ra24l1r)
fra24l2    if   e           k disk    rename(ra24pfr:ra24l2r)
fra524d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- `fra24l1`/`fra24l2`: Input (I) files with external descriptions and composite keys.
- `fra524d`: Workstation file with subfile (`b1sfl`) for display, using `w_srrn` as the record number.

---

## 3. Parameter and Variable Definitions

### Parameters (received at program start)
```rpg
d p_firm          s                   like(raxfir)
d p_xrko          s                   like(raxrko)
d p_xtxt          s                   like(raxtxt)
```
- For filtering/positioning when the program starts.

### Key Variables for File Access
```rpg
d ra24l1_xrko     s                   like(raxrko)
d ra24l2_xtxt     s                   like(raxtxt)
```

### Working Variables for Subfile Control
```rpg
d w_stel          s              4  0   // Subfile counter
d w_spge          s              4  0   // Subfile page size
d w_srrn          s              4  0   // Subfile relative record number
d w_sfrn          s                   like(w_srrn)   // First record number on page
d w_ssrn          s                   like(w_srrn)   // Last record number on page
d w_seqe          s              1      // Sequence flag
d b_valg_ok       s              1    inz(*off)   // Selection flag
d w_firm          s                   like(raxfir)
```

### Constants
```rpg
d c_sfil          s              2  0 inz(8)   // Subfile page size (8 records)
```

---

## 4. Comments on Subfile Fields

The comments explain the meaning of variables involved in subfile logic:
- `w_stel`: Subfile counter
- `w_spge`: Page size
- `w_srrn`: Subfile relative record number
- `w_sfrn`: First record number on the page
- `w_ssrn`: Last record number on the page

---

## 5. Main Logic and Subroutines

### Program Entry Point and Loop

- The program runs a main display loop using two tags: `b2taga` and `b2tagb`.

#### Control is Shown (`b2taga`)
```rpg
c     b2taga        tag
c                   write     b2cmd
```
- Writes the command display.

#### Main Loop (`b2tagb`)
```rpg
c     b2tagb        tag
c                   exsr      dsp_subfile
```
- Calls the display subroutine.
- Handles subfile positioning based on user cursor location (`w_curn`).
- Performs function key logic (selects, page up/down, home, etc.).
- Updates the subfile accordingly.
- If user made a valid selection, ends the program.
- Otherwise, loops back to `b2taga`.

#### Program Exit
```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets LR (last record) to end the program.

---

### Subroutines

#### FORNY: Refreshes the Subfile
- Repositions data and reloads the subfile based on current key.
- Clears and populates subfile from the appropriate file.

#### POSISJONER: Positions in Subfile
- Sets position in the file by transaction code or description.
- Loads the subfile starting at this position.

#### SUBFILE: Main Subfile Handler
- Handles selection from the subfile (marked rows, etc.).
- Toggles subfile display state, processes user selection.

#### CLR_SUBFILE: Clears the Subfile
- Activates subfile clear indicator.
- Resets record counters.

#### CRT_SUBFILE: Loads the Subfile
- Reads and writes the correct number of records from the physical file to the subfile (typically a page at a time).
- Handles both forward reads (for next page) and initialization.

#### BCK_SUBFILE: Page Back in Subfile
- Reads previous page-worth of records.
- Handles repositioning and reloads the subfile accordingly.

#### DSP_SUBFILE: Display Subfile Screen
- Formats and displays the appropriate subfile control or command screen.

#### *INZSR: Program Initialization
- Handles entry parameter list.
- Builds key lists for positioning/selection.
- Sets up initial subfile display.

---

## 6. Function/Indicator Assignments

Key indicators used (as explained in the comments, Norwegian terminology):
- `LR`: End program.
- `10`: Roll (page down)
- `11`: Rolldown (page up)
- `12`–`15`: Subfile display/clear/end
- `21`–`22`: Cursor home and positioning
- `30`: Field protection on view
- `31`–`79`: Message/warning/indicator flags
- `80`–`99`: Work indicators

---

## 7. General Flow

1. **On entry**: Parameters (filter/position) are read.
2. **Subfile is built and displayed**.
3. **User can page up/down, search, or select** an entry.
4. **Selection is captured and returned** via parameters.
5. **End**: LR is set, program returns.

---

## 8. Special Considerations

- **Subfile Paging**: Uses variables (`w_sfrn`, `w_ssrn`, page size) and indicators for managing what is displayed and where in the logical file.
- **Flexible Positioning**: User can position directly by transaction code or description.
- **Selection Logic**: Relies on users marking a line in the subfile for selection.
- **Legacy Style**: This is a classic RPG III/400 style program with heavy use of indicators. Modern RPG (ILE/Free) would look quite different.

---

## 9. Conclusion

This program serves as a "lookup window" for inventory transaction codes, supporting browsing/searching and selection. The logic is typical for inquiry-style subfile screens in legacy RPG environments.

New developers should pay attention to:
- The subfile paging and navigation model
- Use of indicators and subroutines for screen control
- How keys and file accesses are constructed and used for positioning and loading data

If you need to modify or extend the code, consider converting subroutines to procedures, and indicators to named boolean variables for clarity in modern environments.