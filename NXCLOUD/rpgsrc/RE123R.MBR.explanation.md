## Program Overview

**Program Name:** RE123R  
**System:** ASOKON  
**Description:** Prepares ("tilrettelegger") transactions from Q-FREE for further processing in the ASOKON system.  
**Special Version/Adaptation:** None noted, but version 6.20 (from 2022-02-12) changed the project number to alphanumeric.

This program primarily processes input records from Q-FREE, transforms them into the internal transaction format, and writes them to the output file for further accounting or posting.

---

## File Declarations

- **re0ipf**: Input file (primary Q-FREE transaction source).
- **afirl1**: Input file, renamed from `afirpfr` to `afirl1r`. Contains company-related information.
- **raa3l1**: Input file, renamed from `raa3pfr` to `raa3l1r`. Holds period deviation status.
- **raa4l1**: Input file, renamed from `raa4pfr` to `raa4l1r`. Holds additional period/year-related information.
- **re0tpf**: Output file. The processed transactions are written here.

---

## Main Data Structures

### Period and Text Arrays

- `per(13)`: Array of 13 2-digit numbers, used for storing period values (likely for months + possible adjustment period).
- `txt(5)`: Array of 20-character texts, loaded from compile-time data (see end of source for the texts).

### Input Buffers

- `rpcin1`, `rpcin2`, `rpcin3`: 256-byte buffers for input records.
- Overlays on `rpcin1` define the structure of incoming Q-FREE records, mapping fields like voucher number, session, date, amount, sign, etc., to specific offsets.

### Local Data

- `pfirm`, `pnavn`, `puser`, `pdato`, `praar`, `pperf`, `ppert`, `psyst`: Various program-level parameters, often company, user, or period context.
- `l_user`, `l_firm`, `l_navn`: Local variables for user, firm, and name, mapped to specific positions in the user space.
- Working variables for period, line numbers, amounts, etc.

---

## Business Logic and Flow

### Initialization (`*INZSR` Subroutine)

- Sets up key working variables, including the company (`w_firm`), bundle number (`w_bunt`), and initializes counters.
- Chains into the company master (`afirl1`), period deviation (`raa3l1`), and period/year info (`raa4l1`) files to preload relevant data for the session.
- Handles the possibility of missing records in `raa4l1` by setting a default note value (`wnota`).
- Uses keyed lists (`klist`/`kfld`) for chaining.

### Main Processing

- **Period Control:**  
  If indicator `*IN15` is off, sets transaction year and period from program parameters, then sets `*IN15` on to avoid repeating this logic.
- **Transaction Construction:**  
  - Maps input fields from Q-FREE to internal transaction fields, e.g. voucher number, date, amount, account numbers, etc.
  - Handles sign (`wdsftg`):  
    - If positive (`'+'`), posts to debit fields.
    - Otherwise, posts to credit fields.
  - Sets project number (`rtpros`) to the ferry/route number (`wdsfnr`), reflecting the 6.20 change to allow alphanumeric project numbers.
  - Sets default or blank values for many transaction fields not provided by Q-FREE.
- **Posting:**  
  - Adds the transaction amount to a running total (`wtpre`).
  - Increments the transaction line number (`wlinje`).
  - Writes the completed transaction to the output file (`re0tpf`).

### Domain/Business Notes

- **Q-FREE Integration:**  
  Q-FREE is likely an external system providing transaction data (e.g., tolls, tickets, or similar). This program adapts its records for internal accounting.
- **Company and Period Context:**  
  All postings are tied to a company (`w_firm`) and period/year, with logic to handle deviations (via `raa3l1` and `raa4l1`).
- **Project Number Change:**  
  The project number (`rtpros`) is now alphanumeric, mapped from the ferry/route number field in Q-FREE input.

---

## Patterns and Conventions

- **Overlay Data Mapping:**  
  The use of overlays on the input buffer (`rpcin1`) is central, mapping the flat Q-FREE record into named fields.
- **Indicator Usage:**  
  RPG indicators (e.g., `*IN15`) manage one-time or conditional logic.
- **Keyed File Access:**  
  Chaining with keyed lists is used for efficient lookup of master data.
- **Compile-Time Data for Texts:**  
  The posting texts (`txt`) are loaded from compile-time data at the end of the source, allowing for easy update of posting descriptions.

---

## Interactions with Other Modules/Data Sources

- **afirl1**: Company master data (likely for validation or enrichment).
- **raa3l1**: Period deviation logic (for companies with non-standard fiscal periods).
- **raa4l1**: Additional period/year info, possibly for advanced posting logic.
- **re0ipf**: Source of raw Q-FREE transactions.
- **re0tpf**: Output destination for processed transactions, to be picked up by subsequent accounting modules.

---

## Noteworthy Design Choices

- **Extensive Use of Overlays:**  
  This is efficient for fixed-format records but requires strict adherence to Q-FREE's record layout.
- **Minimal Error Handling:**  
  The code assumes the presence of master records; missing records are handled by defaulting values, but there is no explicit error reporting or logging.
- **Hardcoded Posting Texts:**  
  The use of compile-time data for posting texts is simple but inflexible; changes require recompilation.
- **Legacy RPG Style:**  
  The code uses fixed-format RPG IV with traditional C-spec, I-spec, etc., reflecting a codebase with significant history.

---

## Summary Table: Field Mapping Example

| Q-FREE Field (Overlay) | RPG Variable | Internal Field | Purpose/Notes                |
|------------------------|-------------|---------------|------------------------------|
| wdsbil (1-8)           | rpcin1      | rtbiln        | Voucher number               |
| wdsbda (21-26)         | rpcin1      | rtbdat        | Voucher date                 |
| wdsbel (49-57)         | rpcin1      | rtbel�        | Amount (signed)              |
| wdsftg (58)            | rpcin1      | Sign logic    | Determines debit/credit side |
| wdsfnr (39-42)         | rpcin1      | rtpros, rtdavd, rtcavd | Project/Dept/Activity |
| wdskto (43-48)         | rpcin1      | rtdkto, rtckto| Account number               |

---

## Compile-Time Posting Texts

The following texts are available for use as posting descriptions:

1. Faktura (Invoice)
2. Kreditnota (Credit Note)
3. Øreavrunding (Rounding)
4. Gebyr (Fee)
5. Utg. MVA (Outgoing VAT)

---

## Conclusion

This program is a classic RPG batch transformer, bridging Q-FREE's transaction format into the ASOKON accounting ecosystem. It leverages master data for company and period context, applies business logic to map and enrich transactions, and writes normalized postings for further processing. The code emphasizes efficiency and close integration with the legacy data model, with specific accommodations for evolving business requirements (e.g., alphanumeric project numbers).