# RPG Program VV110R – Program Walkthrough and Explanation

This RPG program (`VV110R`) is for IBM i (AS/400) and is written in ILE RPG/400 (RPG IV, fixed format). It serves as a utility for managing "item numbers" (varenummer) in a warehouse or inventory system, specifically for exchanging/replacing one item number with another through a workstation (display) interface. The comments and much of the naming are in Norwegian.

Below is an explanation of the structure and logic, with special attention to important blocks.

---

## **1. Program Header**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio` disables debug for input/output operations.
- `datedit(*dmy)` is the date editing option (Day/Month/Year).

---

## **2. File Definitions**

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvv110d    cf   e             workstn
```
- **vvarl1:** A keyed physical file used for item master data (vareregister).
  - `rename(vvarpfr:vvarl1r)` renames the record format.
- **vv110d:** Workstation file for a display file (DSPF), to interact with users.

---

## **3. Data Definitions**

### **Local Data Area (LDA)**

```rpg
d                uds
d l_firm                944    946  0
```
- `uds` is the User Data Section (LDA access). `l_firm` gets company code from positions 944–946.

### **Key Variables and Fields**

```rpg
d vvarl1_vare     s                   like(vvvare)
```
- Variable for item number, same type as `vvvare` (from item master).

### **Work Variables**

```rpg
d b_feil          s              1    inz(*off)    // Error flag
d w_firm          s                   like(vvfirm) // Firm key
d w_gvar          s                   like(vvvare) // Old item number
d w_nvar          s                   like(vvvare) // New item number
d w_stat          s              1                 // Status, e.g. result code
d w_stxt          s             20                 // Status text, from called program
d w_meld          s             50                 // Message text for errors
```

---

## **4. Mainline and Screen Processing**

### **Screen Loop (Main Menu Interaction)**

```rpg
b1taga   tag
exfmt     b1bld
```
- Displays the main screen (format `b1bld`). User can enter item numbers and function keys.

### **Function Key Handling**

```rpg
select
   when *inkc = *on or *inkl = *on
       goto avslutt                         // Exit if F3 or F12 pressed
   when *inkd = *on
       exsr spørring                        // Prompt handling (likely F4)
       goto b1taga
endsl
```

### **Input Validation and Update Call**

```rpg
exsr sjekk_input
if b_feil = *on
    eval b_feil = *off
    goto b1taga
endif
```
- Calls validation subroutine. If any error is found, returns to screen and shows error.

**Call to Update Program for Item Number Change**

```rpg
movel     b1gvar        w_gvar
movel     b1nvar        w_nvar

call      'VV111R'
parm                    w_firm
parm                    w_gvar
parm                    w_nvar
```
- Calls program `VV111R` (not included) to perform the actual update: changing old item number to new one.

**Reset screen fields and loop**

```rpg
eval      b1gvar = 0
eval      b1tek1 = *blank
eval      b1nvar = 0
goto      b1taga
```

---

## **5. Program Exit**

```rpg
avslutt   tag
eval      *inlr = *on
return
```
- Sets Last Record indicator to end the program.

---

## **6. Subroutine: Item Number Inquiry (`spørring`)**

```rpg
spørring  begsr
    if w_afld = 'B1GVAR'
       movel     b1gvar        w_gvar
       call      'VV500R'
       parm                    w_firm
       parm                    w_gvar
       parm                    b1tek1
       movel     w_gvar        b1gvar
       goto      end_spørr
    endif
end_spørr endsr
```
- If the active field is the 'old item number' field (`B1GVAR`), call program `VV500R` to search for item info, and display its text (`b1tek1`).

---

## **7. Subroutine: Input Validation (`sjekk_input`)**

```rpg
sjekk_input begsr
    // Reset error flags and texts
    eval      b_feil = *off
    eval      b1tek1 = *blank

    // -- Old item number required --
    if b1gvar = 0
        eval      *in31  = *on
        eval      b_feil = *on
        goto      end_sjekk
    endif

    movel     b1gvar        vvarl1_vare
    vvarl1_key chain vvarl1                             90
    if *in90 = *on
        eval      *in32  = *on
        eval      b_feil = *on
        goto      end_sjekk
    endif
    eval      b1tek1 = vvtek1

    // -- New item number required --
    if b1nvar = 0
        eval      *in33  = *on
        eval      b_feil = *on
        goto      end_sjekk
    endif

    movel     b1nvar        vvarl1_vare
    vvarl1_key chain vvarl1                             90
    if *in90 = *off
        eval      *in34 = *on
        eval      b_feil = *on
        goto      end_sjekk
    endif

    // Check if new item number already exists in other tables
    movel     b1gvar        w_gvar
    movel     b1nvar        w_nvar
    eval      w_stat = *blanks
    eval      w_stxt = *blanks

    call      'VV112R'
    parm                    w_firm
    parm                    w_gvar
    parm                    w_nvar
    parm                    w_stat
    parm                    w_stxt

    if w_stat = '1'
        eval      w_meld = 'Vare finnes fra før i : ' + %trim(w_stxt)
        call      'AA005R'
        parm                    w_meld
        eval      *in35  = *on
        eval      b_feil = *on
        goto      end_sjekk
    endif

end_sjekk endsr
```
- Checks all required fields:
    - Old item number given and exists in the master file.
    - New item number given and does **not** already exist in the master.
    - Calls `VV112R` to check for existence in any other related tables ("registers").
    - If found, displays a message and sets error indicators.

---

## **8. Subroutine: Initialization (`*inzsr`)**

```rpg
*inzsr  begsr
    vvarl1_key klist
        kfld    w_firm
        kfld    vvarl1_vare

    // Load company number from LDA
    eval      w_firm = l_firm
endsr
```
- Sets up the key list for item file access (company + item).
- Initializes the company number from the Local Data Area.

---

## **9. Summary of Program Flow**

1. **Display main screen** (`b1bld`).
2. **User enters old and new item numbers**, uses function keys.
3. If F3/F12, **exit**.
4. If F4 (inquiry), calls prompt program.
5. **Validate input**:
    - Both item numbers required.
    - Old item must exist, new item must NOT exist.
    - New item must not be present in any other tables.
6. **If validation OK, call update program** (`VV111R`) to perform the change.
7. **Clear fields and repeat**.

---

## **10. Key Points and External Programs**

- **`VV111R`**: Actually performs the item number change.
- **`VV112R`**: Checks if the new item number exists anywhere else in the system (cross-register check).
- **`AA005R`**: Displays a message (error/information).
- **`VV500R`**: Looks up item information for prompts.

---

## **11. Error Handling**

- Uses one-byte indicators (`b_feil`, `*inNN` fields) to manage and display errors to user at screen level.

---

## **12. Special Notes**

- The code predates fully free RPG and uses fixed-format RPG IV.
- All field and record names are business-specific and mostly in Norwegian; adjust comments and translation as needed for your team's context.
- This program is **driven off the screen**: all logic is in response to display file interaction.

---

**In summary:**  
This is a display-driven RPG program for changing item numbers, ensuring no duplicates, and informing the user of any issues, all while orchestrating the update via separate programs for modularity and system safety.