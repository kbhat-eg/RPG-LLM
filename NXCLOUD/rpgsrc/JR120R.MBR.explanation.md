# Program Overview

This ILE RPG (RPG IV) program is written for IBM i (AS/400) systems and manages "Varegruppereferanser" (Product Group References), allowing users to display, add, edit, copy, or delete reference records through subfile-based screens. All comments and variable descriptions are in Norwegian, but the program structure and logic are typical for RPG subfile maintenance applications.

## Structure

- **Header & Comments:**  
  Information about the program, history, variable uses, and indicator assignments.
- **File Declarations (`F` specs):**  
  Logical files and display files used by the program.
- **Data Declarations (`D` specs):**  
  Parameters, variables, and data structures, including fields used for subfile navigation.
- **Mainline Logic:**  
  The main tag-based loop controlling the screen flow and response to function keys.
- **Subroutines:**  
  Encapsulate actions like clearing/creating subfiles, handling add/edit/delete/copy screens, and validating input.

---

## Detailed Section Breakdown

### 1. **Header and Indicator Reference**

- Explains the use of indicators (e.g., *inlr for program end, *in10 for rollup/page up, *in12 for subfile display, *in30 for field protection, etc.), which is a common pattern in old RPG code before RPGLE introduced named constants.

### 2. **File Declarations**

- Logical files for various views or keys of the "varegruppereferanse" table (`jrvglr`, `jrvglu`, `jrvgl1`, `jrvgl2`), another for undergroups (`vugrl1`), and for rapporteurs/reports (`jrapl1`).
- The display file `jr120d` is declared as a workstation file with multiple record formats (including subfile format `b1sfl`).

### 3. **Data Area and Data Structure Declarations**

- System data (current user, program/function navigation) is mapped via UDS.
- The display feedback data structure is used to get cursor location and other screen properties.

### 4. **Working and Key Variables**

- Local working variables for tracking subfile row numbers, paging, and screen status.
- Fields for holding keys and descriptions while searching/updating records.

### 5. **Constants**

- `c_sfil` is set to 11, defining the subfile page size.

### 6. **Main Program (Mainline Logic)**

- **Initial Tag (`b2taga`):**  
  Shows the command line screen.
- **Show Subfile (`b2tagb`):**  
  Calls `dsp_subfile` subroutine to display the main subfile contents.
- **Function Key Handling:**  
  Uses a `select/when` block to process IBM i function keys (rollup, rolldown, add, copy, delete, etc.) and call the appropriate subroutines or tags.
- **Positioning:**  
  If search fields for group/description are used, positions subfile accordingly.
- **Processing Subfile:**  
  Calls `subfile` subroutine for row processing (edit, delete, copy, etc.).
- **End of Program:**  
  Sets *inlr and returns.

---

## 7. **Key Subroutines**

**a. SUBFILE Management**
- **clr_subfile:**  
  Clears/reset the subfile's content and counters.
- **crt_subfile:**  
  Reads records (via main or alternate key) and fills subfile until the page is full or no more records.
- **bck_subfile:**  
  Handles roll-backward (PageDown) logic in subfile listings.

**b. Subfile Row Actions (`subfile`)**
- Loops through visible subfile rows, handling user actions (edit, copy, delete, view) per row by checking a work selection field (`b1valg`), calling the corresponding screen subroutines, and updating the subfile.

**c. CRUD Operation Screens**
- **xc1bld:**  
  Handles the screen for "Add new row".
- **xc1msg:**  
  Shows a message if trying to add a record that already exists.
- **xc2bld:**  
  Handles "Edit/View" screen, performs input validation, and writes changes to the database.
- **xd1win:**  
  Handles the delete window, confirms, and deletes the record.
- **xk1win:**  
  Handles copy operation, copying a record to a new key after validation.

**d. Subfile Display and Positioning**
- **dsp_subfile:**  
  Controls when/how the subfile control record or command line is shown.
- **posisjoner:**  
  Positions the subfile based on user search criteria (group or description fields).

**e. Inquiry and Utility**
- **spørring:**  
  Placeholder for potential future inquiry logic, currently empty.
- **Initialization (`*inzsr`):**  
  Called once at program start, fetches startup parameters and positions/initializes the first subfile page.

**f. Key Lists**
- Define how database keys are built from fields for each access pattern (main key, alternate key, undergroup lookup, etc.).


---

## 8. **Subfile Paging Logic**

- Uses fields like `w_srrn` (subfile relative row number), `w_spge` (page size), `w_ssrn` (last row number in subfile), and increments/decrements these as the user pages through records.

---

## 9. **Validation & Error Handling**

- Consistently checks for blank fields, duplicate records, or missing descriptions before updating or adding rows to the physical files.
- Uses indicators (e.g., *in31, *in32, etc.) to signal field errors or duplicate keys.

---

## 10. **General Observations**

- All user interface is through subfile screens and pop-ups for add/copy/delete.
- Data integrity and UI feedback are tightly coupled via RPG indicators and subfile records.
- Norwegian variable/field names:  
  - "varegruppe" = product group  
  - "beskrivelse" = description  
  - "rapportør" = reporter
  - "undergruppe" = subgroup

---

## 11. **Program Flow (Summary)**

1. **Startup:**  
   Receives firm and reporter as parameters, initializes subfile.
2. **Displays main menu/subfile:**  
   Shows records, allows search/positioning, and paging.
3. **User selects function:**  
   - Add: pop-up for new row, validates, writes back.
   - Edit/View: pop-up, validation, updates back.
   - Delete: confirmation window, deletes record.
   - Copy: pop-up, validates new key, then copy.
   - Page Forward/Backward: reads next/previous page into subfile.
   - Position: search by group or description.
4. **Returns to subfile or command screen after each operation.**
5. **Set *INLR and end upon user exit.**

---

# **In Short**

- **This program is a classic RPG subfile maintenance application for managing product group references with search, add, update, copy, and delete capabilities.**  
- **Screen logic is controlled by indicators and tags while all main actions are coded in subroutines for modularity.**  
- **It utilizes multiple logical files for alternate sorting/keying and keeps track of subfile position and state through a set of working variables.**  
- **Nearly all user-facing actions update the subfile and/or the physical files, with robust error and input validation as required for critical master data.**