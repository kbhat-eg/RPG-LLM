# Documentation for RK664R: Interest Note Print/Export (A4, No Giro)

## Purpose

This program (`RK664R`) is responsible for generating and outputting interest notes (rentenota) for overdue receivables, without giro (payment slip) on A4 format. The program supports both traditional spool file output and modern XML/PDF generation via JasperReports, including email and archiving functionalities. It is a critical part of the accounts receivable process, ensuring customers are notified and interest is properly calculated and documented.

## High-Level Flow

1. **Initialization**: Load system parameters, company and form information, and determine output mode (spool or XML/PDF).
2. **Iterate Transactions**: For each transaction (interest item), grouped by customer:
    - On customer break: finalize previous customer, write totals, handle archiving/email if needed.
    - For each transaction: calculate interest, prepare detail lines, write output (spool or XML).
3. **Finalize**: Update last used numbers, write batch and posting records, and close out.

## Key Features and Design Choices

- **Dual Output Mode**: The program can output to traditional printer files or generate XML for JasperReports/PDF. This is controlled by the `b_pdfp` flag, set based on system parameters (`l_poff`) and Jasper template availability.
- **Language and Localization**: Supports up to 5 languages for form texts, dynamically loaded from the code register (`ra70l1`).
- **Batch/Archival Integration**: Batch numbers are centrally managed and used for archiving and job tracking, with meta tags for later retrieval/search.
- **Customer and Company Data Handling**: Reads and formats both customer and company/department data, with routines for special cases (e.g., suppressing company info on notes).
- **KID (Customer Identification) Generation**: Flexible logic for building and validating KID numbers, including short/long formats and check digit calculation.
- **External Program Calls**: Integrates with several external programs for KID calculation, mail info retrieval, string sanitization, and more.
- **Error/Overflow Handling**: Custom logic to handle page overflow and error conditions, ensuring correct pagination and output integrity.
- **Meta-Tagging for Archival**: When archiving, outputs rich meta-tags for document management systems.

## Main Data Sources and Files

- **Master Data**:
    - `rkwbl2`: Transaction records (interest items)
    - `rkunl1`: Customer master
    - `afir/afor`: Company and routine registers
    - `raa4l1/raa4lu`: Status and numbering registers
    - `ra70l1`: Form text/code register
    - `rbunlu`: Batch register
    - Others: Various supporting files for category, country, currency, department

- **Output Files**:
    - `rtrapf`: Posting (journal) records
    - `rgirpf`: Giro/interest output file
    - Printer file (`frk664p`) or XML file (for JasperReports)

## Key Program Sections

### Initialization (`*inzsr`)

- Loads company, routine, and form information.
- Determines output mode (`b_pdfp`).
- Prepares keys for all file accesses.
- Loads form texts for all supported languages.
- Reads status registers to determine the next available interest note number.
- Reads account codes and batch information.
- Sets up company/department data for output.

### Main Loop

- Iterates over transactions (`rkwbl2`) using primary key.
- On customer break:
    - Calls `brd_kund` to finalize prior customer: writes totals, posts records, handles KID, generates giro file, and closes XML if in PDF mode.
- For each transaction:
    - If needed, loads new customer data and prepares form headings (`ny_kund`).
    - Calculates interest, handles currency, and prepares detail lines.
    - Writes output: either directly to printer file or via `xml_deta` for XML/Jasper.

### Subroutines

#### `ny_kund` (New Customer)

- Resets totals and state.
- Loads customer master data, including handling for company/department info.
- Loads special interest rate if set for customer category.
- Loads country/language info for localization.
- Prepares headings and form texts for output.

#### `brd_kund` (Customer Break/Finalize)

- Writes final posting and totals for previous customer.
- Handles KID processing and giro file writing.
- Finalizes output (closes XML, logs job, etc.).

#### `skr_giro` (Giro File Output)

- Prepares and writes customer data to the giro output file, including interest amount and KID.

#### `skr_post` (Posting/Journal Entry)

- Writes a posting record for the interest note to the journal file.

#### `skr_slut` (Totals Output)

- Writes total lines for the customer/note.
- Handles both spool and XML output modes.

#### `klargj` (Preparation)

- Loads form texts for all languages from the form text register.
- Reads and sets up numbering and account codes.
- Finds the next available batch number for posting.

#### `leslin` (Read Form Line)

- Loads a single form line from the form text register for each language and stores in arrays.

#### `xkidd` (KID Preparation)

- Builds the KID (customer identification) number, including check digit calculation via external program.
- Handles different KID formats and updates reference files as needed.

#### `overflow` (Page Overflow Handler)

- Handles page overflow: increments page number and writes new header if needed.

#### `hnt_avde` (Department Info)

- Loads department information for inclusion in output and archival meta-tags.

#### XML/Jasper Integration Subroutines

- `xml_envm`: Writes environment and print command variables for JasperReports.
- `xml_head`: Writes customer (partner) info to XML.
- `xml_firm`: Writes company and department info to XML.
- `xml_deta`: Writes detail line info (one per transaction) to XML.
- `xml_totaler`: Writes totals and KID info to XML.
- `xml_end`: Writes archive and meta-tag sections, closes XML file, and triggers archiving if needed.
- `pdf_batchno`, `pdf_logg`: Manage batch number assignment and job logging.
- `pdf_preview`: Launches PDF preview in browser (if enabled).

#### External Program Calls

- **KID Calculation**: `AK720R`, `AK700R`
- **Mail Info**: `FO798R`, `AM705C`
- **String Sanitization for XML**: `AP613R`
- **Printer/Outq Info**: `AP611R`, `AP612R`, `AP614R`
- **Job/Batch Management**: `AS100R`, `AB700R`, `AB705R`, `AB710R`
- **Jasper/XML Output**: CGIDEV2 routines, `GetHTMLIFS`, `WrtHtmlToStmf`, `ClrHtmlBuffer`

## Notable Conventions and Patterns

- **PDF/XML Mode**: All PDF/Jasper-specific logic is guarded by `b_pdfp` flag. When enabled, output is routed through XML-building subroutines and CGIDEV2 APIs.
- **Language Arrays**: All form texts and labels are managed as arrays indexed by language, loaded at runtime.
- **Overlayed Data Structures**: Used for parsing and building composite fields (e.g., KID number).
- **Meta-Tagging**: Extensive use of meta-tags for archiving, including dynamic generation of reference numbers and searchable fields.
- **String Handling**: All customer and company names/addresses are sanitized for XML output via external string scan routines.

## Relationships with Other Modules

- **CGIDEV2**: Used for XML/HTML variable management and output to IFS.
- **JasperReports**: Consumes the generated XML for PDF rendering and emailing.
- **Mail/Archival Systems**: Output can be routed via email or archived, with triggers for downstream processing (e.g., via data queue).
- **Accounting/Posting**: Posting records are written to the journal file for integration with the accounting system.

## Business/Domain-Specific Logic

- **Interest Calculation**: Interest is calculated per transaction, using either a base amount, remaining amount, or original amount, depending on transaction status.
- **KID Numbering**: Supports both legacy and modern KID formats, with dynamic length and check digit calculation.
- **Multi-Company/Department Support**: Handles company and department-specific information, including output tagging for archiving and reporting.
- **Localization**: All output texts and labels are localized based on customer language/country settings.

## Key Points for New Developers

- **Understand the output mode**: Much of the code is conditional on whether PDF/XML output is enabled. Familiarize yourself with both paths.
- **External dependencies**: Many routines are handled by external programs. Ensure you know their interfaces and expected behavior.
- **Meta-data and archiving**: Archival and meta-tagging are central for document management. Carefully follow conventions for reference and meta fields.
- **Form text management**: All texts are managed via code tables for flexibility and localization.
- **Error handling**: Overflow and error conditions are handled explicitly to ensure output integrity.

## Change History

The program has evolved significantly, with major changes for:
- KID number handling (short/long, check digit)
- Jasper/XML output and integration
- Additional meta-tagging and archiving
- Department and company info management
- Email output and multi-recipient support

Refer to the in-code changelog for detailed version history and rationale for specific changes.

---

**In summary:**  
`RK664R` is a robust, highly integrated program for generating interest notes, supporting both legacy spool output and modern PDF/XML workflows, with comprehensive handling of customer, company, and document management requirements. It forms a bridge between core financial systems and modern document output/archival solutions. Understanding its modular structure, output modes, and external integrations is essential for effective maintenance and enhancement.