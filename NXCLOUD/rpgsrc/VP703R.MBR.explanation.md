# Explanation of RPG Program VP703R

This program is written in ILE RPG (Report Program Generator) and is used to retrieve item pricing information from various files, based on a set of criteria passed into the program as parameters. It is typical for use in an order/inventory system, handling product prices depending on delivery type, date, price group, etc.

## High-level Summary

- **Purpose**: Given a company, item, price group, unit, delivery type, and date, it finds the correct sale, cost, purchase, and retail prices by searching in a prioritized way through the price records.
- **Entry point**: The program is called with parameters specifying what prices are to be found for which item/setup.
- **Output**: Returns the calculated prices through parameters.

---

### 1. Header and File Declarations

```rpg
h option(*nodebugio) datedit(*dmy)
```

- `*nodebugio` disables debugging of I/O operations.
- `datedit(*dmy)` sets date format for editing (day/month/year).

**Files:**
```rpg
fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
```
- These are input (I), full procedural (F), externally described (E), keyed (K) files for item pricing, item master, and item subgroup master tables.

---

### 2. Parameter Definitions

Parameters are defined as stand-alone fields (from position `d p_firm ... p_inpr`), and will be mapped to the entry parameters.

- `p_firm` = Company code.
- `p_vare` = Item code.
- `p_prgr` = Price group (2 digits).
- `p_enhe` = Unit of measure.
- `p_lety` = Delivery type.
- `p_dato` = Date for price retrieval.
- `p_sapr` = Sale price (output).
- `p_bupr` = Retail price (output).
- `p_kopr` = Cost price (output).
- `p_inpr` = Purchase price (output).
- `p_inlr` = LR flag (controls whether *INLR is set at return).

---

### 3. Key/Working Variable Definitions

Sets up working fields and key values for file operations and for chaining to records.

- E.g. `w_firm`, `w_dato`, `vvprl1_vare`, etc., are used to construct keys for file lookups.

---

### 4. Main Program Logic

#### a. Initialization

- Moves input firm to work variable.
- Loads warehouse/location number.
- Calls external program `VL721R` to get supplier for item and warehouse; result stored in `w_ldor`.

#### b. Fetch Item Info

- Looks up item in item master (`vvarl1`) using `chain`.

#### c. Handle Date Initialization

- If date is minimal (`*loval`), sets it to current system date.

#### d. Initialize Output Prices

- All output prices are initialized to 0.

---

#### e. Price Lookup Sequence

1. **First Try:** Uses supplier for warehouse, calls subroutine `hent_pris`.
2. **If Not Found**: Tries main supplier (`vvldor`).
3. **If Still Not Found**: Tries with supplier = 0 (wildcard/no supplier).

- If no price is found after all attempts, program exits (`goto avslutt`).

---

#### f. Cost and Purchase Price Derivation

- If cost price is 0, it tries to calculate cost based on the "coverage percentage" (`DG-%`, `vvdekn`) from either the item itself or from its subgroup (if not maintained on item).
- Formula:
  ```rpg
  p_kopr = p_sapr * vvdekn / 100;
  if p_kopr <> 0;
      p_kopr = p_sapr - p_kopr;
  ```

- If purchase price is zero, it's set equal to cost price.

#### g. Clean Exit

- Handles setting of RPG's *INLR last record indicator, depending on input flag.
- Returns.

---

### 5. Subroutine hent_pris (Fetch Price)

This is the primary logic for price lookup. It attempts up to four levels of specificity:

1. **By Item, Price Group, Unit, Delivery Type**  
   (Using current supplier in the key)
2. **If Not Found, Tries with Delivery Type = 0**  
   (i.e., generic delivery type)
3. **If Not Found, Tries with Price Group = blank**  
   (i.e., falls back to generic pricing group)
4. **If Not Found, Tries with both Delivery Type = 0 and Price Group = blank**

For each attempt:
- Reads the price file for the matching key.
- If a record is found with a "start date" less than or equal to the work date, loads the output prices.
- If not, continues to next possibility.

---

### 6. Initialization Subroutine (*inzsr)

- Handles mapping of all parameters and sets up key lists for files (for efficient keyed lookup).

---

## Typical Call and Workflow

1. **Called** with item details + date; output price parameters as reference.
2. **Program attempts** to locate price for the most specific match, falling back as needed.
3. **If a price is found**, returns filled output variables.
4. **If not found**, returns 0 in price fields.

---

## Summary Table

| Input          | Description                                                           |
|----------------|----------------------------------------------------------------------|
| p_firm         | Company number                                                       |
| p_vare         | Item number                                                          |
| p_prgr         | Price group                                                          |
| p_enhe         | Unit                                                                 |
| p_lety         | Delivery type                                                        |
| p_dato         | Date for price lookup                                                |
| p_inlr         | LR flag, controls RPG cycle                                          |

| Output         | Description                                                           |
|----------------|-----------------------------------------------------------------------|
| p_sapr         | Sales price                                                          |
| p_bupr         | Retail price                                                         |
| p_kopr         | Cost price                                                           |
| p_inpr         | Purchase price                                                       |

---

## Key Points for Maintenance/New Developers

- The **file structure is central**: Knowing the contents and key structures of `vvprl1`, `vvarl1`, and `vugrl1` is critical.
- **Parameter handling** is classic RPG IV-style, with parameters defined as stand-alone fields.
- **Price Lookup Sequence** is prioritized: warehouse supplier → main supplier → generic.
- **Fallbacks** for both delivery type and price group ensure a best-effort price is always found if possible.
- The program is **modular**, with key logic in subroutines, especially `hent_pris`.
- The code is **well-commented**, with Norwegian business terms (e.g., "vare" = item, "pris" = price, "lev" = supplier).

---

## Additional Notes

- The program is compatible with **batch and interactive** jobs, because *INLR is set conditionally via `p_inlr`.
- Date handling uses RPG’s `time` opcode and supports injection of system date.
- `goto avslutt` is used for early program exit if no price found (a common pattern in legacy RPG).

---

## Quick Reference to Norwegian Business Terms

| Norwegian   | English           |
|-------------|-------------------|
| Vare        | Item/Product      |
| Pris        | Price             |
| Leverandør  | Supplier/Vendor   |
| Enhet       | Unit              |
| Kostpris    | Cost Price        |
| Innkjøpspris| Purchase Price    |
| Butikkpris  | Retail Price      |
| Salgspris   | Sales Price       |

---

### In summary:

This RPG program is a robust, parameter-driven price retrieval utility, supporting multi-level fallback logic for different pricing keys, and is representative of classic ERP business logic in Norwegian retail systems.