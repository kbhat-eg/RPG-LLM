# RPG Program VJ100R - Detailed Explanation

---

## Overview

This RPG/400 program is designed for IBM i (AS/400) and handles the maintenance (“vedlikehold”) of “påslag-linje” records. These appear to be markup or surcharge lines for some kind of inventory or pricing system, including vendor, groupings, item, and pricing information.

The program is highly interactive, using subfiles (i.e., record lists on screens) and several display/screens for CRUD operations. The code is in traditional ("fixed-format") RPG IV.

---

## Key Concepts

- **Subfile**: A list of database records displayed on-screen, with paging, add/edit/delete, and filtering.
- **Keys/Indexing**: Key lists for positioning/reading records in various logical access paths.
- **Indicator Usage**: Program indicators (e.g., *INLR, *INKC) control flow, screen behavior, error handling.
- **Screen-handling**: Display files, subfile records, and various function key actions.
- **Maintenance Logic**: Supports create, read, update, delete (CRUD) for surcharge records.

---

## Major Components

### 1. File Declarations

```rpg
fvpdtlr    if   e           k disk    rename(vpdtpfr:vpdtlrr)
fvpdtlu    uf a e           k disk    rename(vpdtpfr:vpdtlur)
fvpdtl1...fvpdtl8  ...      k disk    rename(vpdtpfr:vpdtl?r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
...
fvj100d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **vpdtlr**: Main file for surcharge lines, with various logical views (for record access by different key combinations).
- **rlevl1, vogrl1, vhgrl1, vugrl1, vvarl1, vltpl1**: Master tables for vendor, group, item, etc., used for validation.
- **vj100d**: Display file, with subfile (B1SFL) and display feedback (INDS).

### 2. Data Definitions

- **Parameters**: p_firm and p_pasl (Company and Surcharge ID)
- **LDA (Local Data Area)**: User and navigation info
- **Display Feedback Data Structure**: Holds cursor position after display
- **Working Variables**: For keys (current subfile row, sequence type, errors, paging, etc.)
- **Field Names** (often ending in `_ldor`, `_ogrp`, etc.): Representing vendor, group, item, etc.

### 3. Constants & Documentation

- **Indicator Map**: Which indicators are used for which screen behavior.
- **Subfile/Paging Variables**: Documented in comments, e.g. w_srrn = relative record number in subfile.
- **Screens Referenced**: B1SFL, B2CTL, C1BLD, C1MSG, C2BLD, D1WIN, K1WIN.

---

## Program Flow

### Main Routine (Labels: b2taga / b2tagb)

1. **Display Command Screen:** (`write b2cmd`)
2. **Display Subfile:** (`exsr dsp_subfile`)
3. **Function Key Handling:**
    - End/Exit: `*INKC or *INKL` → End program.
    - Inquiry: `*INKD` → Subroutine `spørring`.
    - Refresh/Forny: `*INKE` → Subroutine `forny`.
    - Add New Row: `*IN10` → Subroutine `crt_subfile`.
    - Create Dialog: `*INKF` → Subroutine `xc1bld`.
    - Page Back: `*IN11` → Subroutine `bck_subfile`.
    - Home: `*IN21` sets *IN22, moves cursor home.
4. **Positioning:** (if any positioning field is filled) → Subroutine `posisjoner`.
5. **Subfile Handling:** Subroutine `subfile`.
6. **Repeat Loop:** (goto b2taga)

### End Routine

- **Set LR Indicator to end program.**

---

## Important Subroutines

### `forny` (Refresh Subfile)

- Repositions to the current subfile record depending on the sequence type (overgroup, main group, subgroup, price code, item, delivery type, or standard).
- Clears and refills subfile with current position.

### `posisjoner` (Positioning)

- Repositions the database pointer based on which field (vendor, group, etc.) is entered for positioning.
- Clears and refills subfile after positioning.
- Resets filter/position fields.

### `subfile`

- Reads user changes from subfile records (loop), processes user actions:
    - **Change (2):** Loads fields into C1, calls `xc2bld` (edit/maintain), updates subfile.
    - **Copy (3):** Loads fields into K1, calls `xk1win` (copy), updates subfile.
    - **Delete (4):** Loads fields into D1, calls `xd1win` (delete), updates subfile.
    - **View (5):** Loads fields into C1, calls `xc2bld` (view), updates subfile.

### `xc1bld` (Create New Row / Dialog)

- Prepares to create a new record: populates fields, calls `hent_info` (fetches descriptions).
- Presents the C1BLD screen (format/display input).
- Handles function keys (Cancel, Inquiry).
- Validates input via `sjekk_input`.
    - Checks for duplicates, displays info message if record exists (`xc1msg`).
    - If valid, calls `xc2bld` (maintenance).
    - Clears fields upon completion, restarts dialog.

### `xc2bld` (Edit/View Dialog)

- Loads data from DB (via keys), populates C2Bld screen.
- Allows editing, validates input for required fields and business rules.
- If valid, updates or inserts into DB.
- Updates subfile if coming from change/copy.
- Sets indicator for requiring subfile refresh on completion.

### `xd1win` (Delete)

- Loads and displays the D1WIN delete screen for the selected record.
- Deletes the record if user confirms.

### `xk1win` (Copy)

- Loads fields for record to be copied, gets details, displays K1WIN screen.
- Validates input, checks for duplicate.
- If valid, calls `xc2bld` to perform copy.

### `clr_subfile` / `crt_subfile`

- **clr_subfile**: Clears subfile and resets paging/record counters.
- **crt_subfile**: Reads from the relevant logical access path (depending on sequence/position); fills the subfile display with the next or previous range of records.

### `bck_subfile`

- Handles paging backward in the subfile, repositions, and refills subfile to display a previous page.

### `dsp_subfile`

- Physically displays (EXFMT) the subfile control screen, sets appropriate indicators for subfile I/O.

### `spørring` (Lookup Helper)

- Handles on-screen lookup/help for combo fields (vendor, group, item, delivery type, etc.).
- Calls out to helper programs (e.g., RL500R for vendor, VG510R for overgroup, etc.).

### `sjekk_input` (Input Validation)

- Validates the input fields for a new or changed entry, such as ensuring combinations are legal, reference master tables to verify existence, sets error indicators as needed.
- Fetches and loads related descriptions into fields for display.

### `hent_info` (Fetch Descriptions)

- Loads descriptive text for selected fields, by performing lookups to master tables. Used to display associated names/texts for keys entered.

### `*inzsr` (Initialization)

- Receives parameters, initializes keys, positions files, fetches current date and VAT info, positions to start, and loads initial subfile content.

---

## Notable Details

- **Function Codes**: Many subroutines use *INKxx indicators (function key pressed).
- **Multi-level Grouping**: The design supports overgroup, main group, subgroup, price code, item, delivery type — allowing complex filtering, lookup, and maintenance.
- **Extensive Validation**: Every field is validated either through master table lookups or through business logic.
- **Paging**: Subfile supports paging forward/backward, retaining position with several tracking variables (w_srrn, w_ssrn, etc.).
- **Screen Design**: Multiple display formats for different tasks (entry, confirmation, lookup, messages).

---

## Best Practices Observed

- **Separation of Functionality**: Subfiles, CRUD, validation, info retrieval are separated into subroutines.
- **Consistent Use of Key Lists**: All record access is via well-defined keylists.
- **Self-Documented**: Extensive comments, indicator use map, variable naming, and documentation blocks.

---

## Summary Table

| Function Screen | Purpose                    | RPG Subroutine         |
|-----------------|---------------------------|------------------------|
| B2CTL           | Subfile Control           | Main loop, subfile     |
| B1SFL           | Subfile (list)            | subfile, crt_subfile   |
| C1BLD           | New Row input             | xc1bld                 |
| C2BLD           | Edit/View dialog          | xc2bld                 |
| D1WIN           | Delete confirmation       | xd1win                 |
| K1WIN           | Copy dialog               | xk1win                 |
| MSG             | Information popup         | xc1msg                 |

---

## How To Onboard

- **Understand the Data Model:** The surcharge record is keyed by firm, surcharge, vendor, group, price code, item, delivery type.
- **Know Where Logic Lives:** All interactive logic is event-driven (function-key based), using RPG subroutines.
- **Master the Subfile Handling:** Paging, selection, and CRUD are orchestrated via a handful of key subroutines.
- **Know the Screen Flows:** Different records/screens are for new, edit, copy, delete, and lookup.
- **Database Lookups:** All keys are validated and often result in fetching and displaying associated names.
- **Review the Comments:** They provide mapping from indicator to function, and clarify field purposes.

---

## Final Notes

- **Modernization:** This code is in fixed-format RPG IV and could be modernized to free-format, but its structure is maintainable and logical.
- **Extensibility:** Adding new fields, validation rules or lookup tables can be done by following the established patterns.
- **Testing:** Test all flows, especially complex ones (copy with changed keys, edge-case navigations in paging).

---

For a new developer, the best starting point is to trace the main display loop, understand the subfile paging logic, then follow through the subroutines that handle CRUD actions, and study the supporting validation and info-fetching routines. Always use the supplied comments as a guide to both overall and detailed logic.