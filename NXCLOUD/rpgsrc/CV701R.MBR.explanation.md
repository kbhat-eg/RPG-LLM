# RPG Program CV701R: Stock Readiness Export Explanation

This RPG program (`CV701R`) is designed to gather, process, and export data on warehouse (stock) items for further use, such as forecasting and replenishment planning. Its main function is to extract a broad set of statistics and metadata about items, exporting the results to an output file for integration, possibly with systems like RELEX.

Below is a breakdown of how the program works and its key routines:

---

## **1. Documentation and Change Log**

At the top, there is a **header comment** block listing:

- **System/program info**: Name, description ("Readiness product, export to file"), special notes, references.
- **Version history**: Who changed what and when, with notes on new features/fixes (e.g., added weekly sales, shelf min/max, lead time, supplier logic, handling seasonal codes, etc.).

---

## **2. File Declarations**

All files are declared using the `F` spec, generally with the `IF` (input, full procedural) and `E` (external) options. Each file has a `rename` to a local record format.

**Typical files:**

- Master and transaction files for items (`vvarl1`), statistics (`sstalx`), pricing (`vvprl1`), suppliers (`vvenl1`, `vvenl4`), warehouse data (`vlagl1`), order information (`lodtlv`, `fohel1`, etc.), history (`vhisl4`), groupings (`vpgrl1`), and output file (`cvarpfr`).

---

## **3. Data Structures and Variables**

- **Parameter/Entry Data**:
    - `p_list`: Holds input parameters (firm, department).
    - `d_list` DS: Holds parsed values using overlays for firm/department codes.

- **Working Variables**:
    - Variables for key construction, date calculations, and interim values for statistics, sales, pricing, and item properties.
    - Key variables help in chaining to the right records in each file.

---

## **4. Mainline Logic**

### **a. Date Calculations**

Calculates a set of base dates used extensively throughout:

- `w_da15`: Date 15 months ago.
- `w_da12`: Date 12 months ago.
- `w_da06`: Date 6 months ago.
- `w_da03`: Date 3 months ago.
- `w_da01`: Date 1 month ago.

Sets up 52 "weekly window" base dates to split and aggregate sales by week:
- `w_du01` is set to today minus 7 days; `w_du02` is 14 days ago, and so on up to `w_du52`.

### **b. Main Item Loop**

Iterates through all "stock items" in `vvarl1`:

```rpg
c     vvarl1_key    setll     vvarl1
c     vvarl1_key    reade     vvarl1
c                   dow       not %eof
c                   exsr      behandling
c     vvarl1_key    reade     vvarl1
c                   enddo
```

- For each item, the program calls subroutine `behandling`.

### **c. Program End**

Sets LR indicator and returns.

---

## **5. Subroutine: `behandling` (Processing of Each Item)**

### **a. Early Exits (Filters on Item Type)**

- Only processes stocked products (`vvvtyp` not 'D' or 'T').
- If location data is not found (for warehouse-managed items), or type does not match ('L'), skips the item.

### **b. Data Initialization and Population**

- **General Info**: Sets up firm, warehouse, item codes, standard product info.
- **Supplier Info**: Resolves main supplier, supplier from warehouse, and lead times.
- **Date Info**: Oldest/specific dates for out-of-stock, first/last received, historical events, counting.

### **c. Unit and Conversion Logic**

- Determines stock and purchase units and conversion factors.

### **d. Pricing Logic**

- Resolves price group, fetches relevant price, calculates sales price including VAT (fetches VAT rate from another program if needed).

### **e. First Sale Date**

- Finds the first date an item was sold as a stock item.

### **f. Statistics Gathering**

- **Sales Data**: Loops through the item’s history (statistics) for the last 15, 12, 6, 3, 1 months.
    - Aggregates totals (value, number of sales, average, frequency, etc.)
    - Breaks sales down in 52-week windows for trend/time-series analysis.
- **Packing Slip Sales**: Processes packing slips (recent shipments) < 1 month old; adjusts statistics as above.

### **g. Unit Conversions**

If stock and statistics units differ, converts accumulated statistics to the standard stock unit using conversion rates.

### **h. Location and Additional Info**

- Reads warehouse location, inventory data, shelf min/max, reorder levels, lead time, and synchronizes metadata.

### **i. Replacement and Logistics Info**

- If item is a replacement, records old/new item links.
- Fetches logistics master data via embedded SQL.

### **j. Supplier Name and Recent Purchase Date**

- Looks up supplier name.
- Finds last purchase date from order lines.

### **k. Output**

- Writes fully prepared and calculated record for the item to the output file (`cvarpfr`).

---

## **6. *INZSR Subroutine (Initialization)**

Executed at program start:

- Parses parameters (gets firm/department).
- Constructs all key lists for chaining/lookups in subfiles.
- Reads organizational, warehouse, and price group data for baseline context.
- Calls "FÅ705R" (gets VAT for full rate), and "FÅ706R" (gets VAT for half rate).

---

## **7. Embedded SQL**

- Used for advanced lookup for logistics items, e.g.:

```rpg
/exec sql
select vvlnob, vvllva, vvlnle
into :w_lv_nobb, :w_lv_lvar, :w_lv_nlev
from vvlepf
where vvlvnr = :vvvare
  and vvlldo = :cvldor
fetch first 1 rows only
/end-exec
```

---

## **8. Key Takeaways for Onboarding**

- The program is highly modular, with extensive use of subroutines for maintainability.
- File I/O is everywhere: expect heavy chaining, reading, and conditional processing.
- **Dates and conversions** are central—statistical windows and cross-unit calculations abound.
- **Sales and inventory logic** are built to support export for planning/forecasting (e.g., RELEX).
- The codebase is rich in business rules, so understanding the file layouts and key fields is crucial.
- **Change logs** are up to date and show ongoing adaptation for new use cases.
- **External programs** and SQL are used for specialized lookups/calculations.

---

## **Summary Table of Main Entities**

| Area    | Files/Tables         | Main Use                                    |
|---------|----------------------|---------------------------------------------|
| Items   | vvarl1, vvenl1, vvenl4  | Item master, units, and conversions         |
| Warehouse| vlagl1, mltil1         | Stock info, location, lead times            |
| Sales   | sstalx, fodtlx, fohel1  | Historical sales/statistics, packing slips  |
| Pricing | vvprl1, vpgrl1          | Price groups and values                     |
| Orders  | lodtlv, lohel1          | Purchases/last received                     |
| History | vhisl4                  | Historical inventory events                 |
| Output  | cvarpfr                 | Export file                                 |

---

## **Typical Flow for Each Item**

1. **Check if stock item:** Skip if not.
2. **Read warehouse record:** Skip if missing.
3. **Initialize item info** (codes, units, dates, prices, etc.)
4. **Calculate statistics** for sales (monthly/yearly, weekly), with unit conversions if needed.
5. **Enrich metadata** (supplier, replacement links, logistics master, last purchase location/date).
6. **Write a record** to the export file.

---

This structure ensures all relevant data for each stock item is collected, normalized, and exported for advanced planning or reporting purposes.