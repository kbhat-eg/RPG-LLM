# Explanation of the RPG IV (ILE RPG) Program

This RPG program is a product/price inquiry screen ("Vare, spørring på vare/pris") for an IBM i (AS/400) system. It is a comprehensive inquiry and selection tool for items, their groups, prices, stock, and related information, widely used in Norwegian retail/wholesale systems.

Below is a pedagogical walkthrough of the program's structure, highlighting its modules, data areas, files, main logic, subroutines, and special features.

---

## 1. Header and Documentation

- The header provides **system, program name, and description**.
- **Modification history** is well documented, with dates, developer initials, and short explanations. This is invaluable for understanding the code's evolution and features.

---

## 2. File Declarations

### Input and Output Files

```rpg
fvvsopf    if   e           k disk
fvvarlr    if   e           k disk    rename(vvarpfr:vvarlrr)
...
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
...
fvv550d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- Files `fvvsopf`, `fvvarlr`, etc., are logical/physical database files for items, groups, customers, etc.
- **Sfile (subfile)**: `fvv550d` is a display file with a subfile, enabling scrolling lists and selection.
- **infds(dspfbk)**: Declares the display feedback data structure for handling screen state and cursor position.

---

## 3. Data Area and Data Structures

```rpg
d                uds
d l_firm                944    946  0
d l_fnav                951    980
...
d dspfbk          ds
d  d_fcrn               378    379I 0
```

- **Local Data Area (LDA)** (`uds`): Carries info like firm (company) number/name, warehouse, etc., from session context.
- **dspfbk**: Display feedback DS, e.g., to know first record number shown (`d_fcrn`) for subfile paging management.

---

## 4. Working Storage and Key Variables

- **Search keys**: Variables like `vvarlr_vare`, `vvarl1_vare`, etc., are used to chain/access DB records.
- **Flags and Control Variables**:
    - `w_fcrn`, `w_spge`, `w_srrn`, ...: Handle subfile navigation (e.g., current page, first/last record).
    - `b_lager`, `b_open_sok`, etc.: Boolean flags for special state.
    - `b_reset`, `b_levr`: Used for search filter resets and supplier search.
- **Price and Stock variables**: `w_bupr`, `w_tipr`, `w_behl`, etc., hold business info for current item.

---

## 5. Main Logic (Control Flow)

- The mainline alternates between **tagged sections** (labels like `b2taga, b2tagb`) for handling display logic and **user events** (function keys).
- **Function Key Handling** (`*inkc` = F3/Exit, `*inkd` = F5/Inquiry, etc.):
    - Special keys trigger search, refresh, subfile creation, etc.
- **Validation**: Customer, project, warehouse, supplier, and group filters are looked up and validated.
- **Search and Filtering**:
    - The program supports multi-level group filtering (`overgruppe`, `hovedgruppe`, `undergruppe`) and free text.
    - Advanced filtering logic is present, e.g., skipping items of a certain type or excluded by settings.

---

## 6. Subroutines (Subrs)

Subroutines modularize complex logic, such as:

### `forny` – Refresh Subfile
- Repositions the subfile pointer based on the current search/group selection.
- Resets fields if requested (`b_reset`).
- Calls routines to clear and recreate the subfile rows.

### `søk` – Perform Search
- Checks if the same search is requested to avoid unnecessary rebuilding.
- Performs hierarchy validation (invalid group combinations).
- Sets up which key to use, prepares search text, and triggers subfile reload.

### `posisjoner` – Positioning in Subfile
- Handles specific positioning when user searches by item number, text, NOBB-number, or supplier's item number.

### `subfile`, `clr_subfile`, `crt_subfile` – Subfile Management
- **subfile**: Handles user actions on subfile records (select, show locations, product info, etc.).
- **clr_subfile**: Blanks out the subfile (clears all records).
- **crt_subfile**: Re-populates the subfile by reading records or using SQL cursors (for free text/group search).
    - This routine does much of the heavy lifting, fetching and writing item rows.
    - Handles business logic like stock, price, status, coloring, and limits.

### `bck_subfile` – Page Backward in Subfile
- Handles page-up logic for subfiles not shown via SQL searches.

### `dsp_subfile` – Display Subfile
- Manages the actual display of the subfile page and command area.

### `spørring` – Field Help
- Triggers context-sensitive help for fields (customer, group, supplier).

### `hent_info` – Lookup Customer/Project Info
- Pulls customer and project names for the current selection.

### `scanning` – Barcode/EAN Scanning Subwindow
- Allows the operator to enter and lookup an item using its EAN code.

### `sjekk_vsor` – Check Item in Central/Period Sortiments
- Reads special status for item/warehouse/sortiment for coloring/subfile status.

### `finn_logivar` – Find Logistic Item for Price Giver
- Advanced routine for logistic variant detection and subfile color/status flags.

### `vis_lokasjon` – Show Stock Locations
- Looks up and displays textual location info for the item in the warehouse.

---

## 7. Key Lists (`klist`)

- **KLISTs** define composite keys for file operations (CHAIN, READE, SETLL, etc.).
- Each logical file (e.g., item, group, customer) has its own keylist, making the code flexible and DRY.

---

## 8. Initialization (`*inzsr`)

- Loads key info from LDA (firm, warehouse, etc.).
- Initializes search settings.
- Retrieves current date/time and tax rates.
- Loads user-specific or warehouse-specific configuration (e.g., coloring, calculation modes).

---

## 9. Special Features

- **Flexible Grouping**: Supports search/browse in overgruppe/hovedgruppe/undergruppe hierarchies, with advanced logic for SQL-based searching and paging.
- **Dynamic Color/Status Handling**: Based on configuration (“FARGE_SKAFF_SORTIMENT”, etc.), the subfile rows are colored or tagged depending on various statuses and item types.
- **Stock Display**: Displays available balance (beholdning), and handles negative/large quantities gracefully.
- **Configurable Search Fields**: Users may switch displayed field from item number to NOBB-number or supplier's item number with function keys.
- **Help and Lookup Integration**: Context-sensitive field help for codes (customer, group, supplier) is integrated via external program calls.
- **Barcode/EAN Scanning**: Dedicated window for item lookup by barcode.

---

## 10. Notes on Code Organization

- **Version Control**: The codebase appears robust, with comments marking each new feature or fix.
- **External Program Calls**: Many business rules (price, tax, item detail, status) are handled via external programs—this modularizes and encapsulates business logic.
- **SQL Integration**: For advanced searches (text search, group search), SQL cursors are used for flexibility and performance.

---

## 11. Summary Table of Main Variables

| Variable       | Purpose                                      |
| -------------- | -------------------------------------------- |
| `b2kund`       | Customer number (input on screen)            |
| `b2kpro`       | Customer project number                      |
| `b2ogrp/hgrp/ugrp` | Group filters for searching           |
| `b1valg`       | Choice/action selected on a subfile row      |
| `w_firm`       | Current company code                         |
| `w_lage`       | Warehouse                                    |
| `w_seqe`       | Search/positioning mode                      |
| `b1saim`       | Item sales price                             |
| `b1behl`       | Item stock balance                           |
| `b1tek1`       | Item description                             |
| `*in##`        | Indicator variables for display logic        |

---

## 12. Typical User Flow

1. **Screen opens**, subfile is empty (or filled from previous search).
2. **Operator enters search filter(s)**: group, text, item number, etc.
3. **Operator triggers search/subfile build** (function key).
4. **Operator navigates subfile**, selects an item, or opens more info/help.
5. **Selections and actions**: See price info, stock, locations, item card, etc.
6. **Operator may refine filters and repeat the process.**

---

## 13. Key Takeaways for New Developers

- **Read the comments and the header**, as almost all features have a version and a short description—this is invaluable for troubleshooting or extending logic.
- **Subfile programming**: The code is a textbook example of advanced green-screen subfile management with paging, SQL, and flexible filtering.
- **Externalization of business rules**: Most key calculations and checks are external, keeping the main logic focused and maintainable.
- **Indicators (`*in##`)**: RPG indicators drive much of the screen logic—knowing which means what is critical (see the explanation block in the comments).

---

## 14. References and Further Reading

- **ILE RPG Reference**: For more on data structures, operation codes, SQL integration, and external program calls.
- **IBM Subfile Programming**: For details on advanced subfile features.
- **Business Logic Programs**: (e.g., 'VL710R', 'VP710R', 'CO402R', etc.) Understand what each external program encapsulates.

---

**In summary:**  
This program is a sophisticated, user-friendly inquiry tool for use in item, price, and stock management with extensive configurability, integration with master data, and an excellent example of both traditional RPG programming and modern (for IBM i) features like embedded SQL and modular architecture.