# RPG Program Explanation: FY500R

This program, written in ILE RPG, is used for **querying and handling deleted orders** (slettede ordre) in an IBM i (AS/400) system. It is built around subfiles for interactive display, allows searching by various criteria, and supports restoration or analysis actions on deleted orders, such as reconstructing a deleted order into a new "tilbud" (offer/quote).

## High-Level Structure

- **Header, Change Log, and Indicator Usage**: At the top, extensive comments document the program's purpose, its change history, and defines how indicators (flags 1-99) are used for control, display, errors, and internal logic.
- **File Declarations (`F` specs)**: Logical and physical files for deleted orders and related entities are defined, often with record format renaming for clarity.
- **Data Area and Data Structures (`D` specs)**: Includes the Local Data Area (LDA) for job/context information, a display feedback structure, work variables, search key variables, and constants.
- **Procedures (PR) & External Calls**: Includes binding to external programs (e.g., `CO402R`, `FY505R`, `FY510R`, `AA007R`) for cross-program logic, such as fetching the highest used suffix or creating new quotes.

---

## Key Files Used

- `fdell*`: Logical views for deleted orders, supporting various access paths (by customer, by date, by order type, etc.).
- `ffy500d`: The display file, using subfiles for interactive screens.
- `frkunl1`, `fvotyl1`: Customer and order type master files.
- GUI/logical files for richer functionality in newer versions.

---

## Main Variables

- **w_*:** Working variables for subfile and screen management (e.g., `w_srrn` - subfile record number, `w_salg` - order amount).
- **b_*:** Binary flags (e.g., `b_feil` for input error, `b_forn` for refresh needed).
- **fdell*_***: Variables used as composite keys for fast positioning in logical files, supporting fast search and display.
- **Screen fields:** Variables mapped to screen fields for user input and feedback.

---

## Key Program Functions

### 1. Subfile Display & Navigation

The program is driven by subfiles for displaying lists of deleted orders, with support for paging, position-to, and various search options (by year, order number, customer name, date, etc.). Key routines:

- `forny` - Refreshes the subfile, repositions and reloads data depending on user input or search criteria.
- `crt_subfile` - Reads records from the correct logical view into the subfile, handling filtering, page size, etc.
- `clr_subfile` - Empties the current subfile before reloading.
- `dsp_subfile` - Handles screen display and input for the subfile.

### 2. User Input and Positioning

The user can input values to search or position the list, such as:

- Year, order number, suffix, date, order type, customer name.
- The subroutine `posisjoner` sets the appropriate keys and positions the display according to the input field(s) filled.

### 3. Function Key Handling

- F1: Scroll alternatives/help.
- F3/F12: Exit.
- F5: Refresh.
- F23: Toggle display columns.
- Roll/rolldown: Subfile paging.
- Position-to and cursor control.

### 4. Subfile Record Actions

When a user selects a record and chooses an action:

- **View** (valg=5): Calls another program to display order details.
- **Restore/Copy to Tilbud** (valg=6 or 10): Calls another program (`FY505R`) to build a new order/offer from the deleted order. Handles special logic for valid types/orders and interacts with the user for confirmation and warnings.

### 5. Data Validation

- Routines like `xsjekk_inp` validate date fields and set flags if the input is invalid.

### 6. Suffix Management and Offer Generation

- **finn_nxtSuff**: Finds the next free suffix for a given order number.
- **bygg_tilbud**: Creates a new offer (tilbud) from a deleted order, possibly with a new offer number/suffix.
- Extensive logic ensures no duplicate records, proper logging, and user notification if the offer is created.

---

## Startup (`*INZSR`)

- Initializes key lists for record access.
- Reads firm number from LDA.
- Checks whether the "restore-to-offer" function is active using a central configuration program.
- Sets up some default column headings.
- Loads initial data into the subfile.

---

## Miscellaneous Functionality

- Query subroutines (`spørring`): Allow user to look up customers or order types using pop-up windows.
- Logging: Each restoration is logged to a log file with relevant metadata.
- Extended GUI support: In later versions, additional screens and fields are supported for richer interfaces.

---

## Common Flows Summarized

1. **Program starts**: Reads firm and context, displays subfile with deleted orders.
2. **User searches or pages through orders**: Subfile is reloaded according to input or scroll.
3. **User selects an action on a row**:
    - View details.
    - Restore as new offer (if allowed; extra logic if not an offer-type order).
4. **If restoring order**:
    - Finds next free suffix / offer number.
    - Calls offer-building logic.
    - Notifies the user and logs the action.
5. **Various utility screens**: Customer and order-type lookups, help/info windows.

---

## Special Notes for Developers

- **Indicators are heavily used** for control: Be aware of their assigned functions.
- **Subfile logic (add, clear, display) is central**: Most navigation and filters revolve around subfile routines.
- **Multiple access paths**: The same file (`FDELLPF`) is accessed via different logicals depending on search criteria.
- **Program extensibility**: Many routines/checks are version-labeled (e.g., `7.01`, `8.01`), showing ongoing maintenance and functional growth.
- **External Calls**: Much of the logic is modular, with several *CALL/PARM* instructions to external programs for customer lookup, configuration, and business rules.

---

## Example “Walkthrough” Scenario

1. User is presented with a subfile listing deleted orders.
2. User enters a search criterion, e.g., a customer name or order date.
3. Program positions to the first matching order, reloads the subfile to show only relevant records.
4. User selects an order and presses a function key to restore the order as a new offer.
5. Program checks if the action is allowed, finds the next available suffix, calls the subroutine to build the offer, then provides feedback (via pop-up or message window).
6. Action is logged for auditability.

---

## Conclusion

This program is a *robust, interactive tool* for searching, viewing, and processing deleted orders, with facilities for restoring them as new offers/quotes. It serves as a good example of classical ILE RPG interactive program design, making heavy use of subfiles, indicators, and modular external calls to encapsulate business logic and maintain flexibility. 

**Onboarding Tip**: 
- New developers should pay special attention to the subfile processing pattern, indicator usage, and the key list logic for file access, as these are foundational to understanding and modifying the program. The program is highly parameterized and modular, making it easier to enhance or adapt for new requirements.