## Program Overview

**Program Name:** NN751R  
**System:** ASOFAK  
**Purpose:**  
This program is responsible for exporting order confirmations from the e-commerce system ("nettbutikk") by generating a structured file. The output file follows a specific record format, likely for integration with other systems or for data exchange.

## High-Level Functionality

- The program creates a message file containing several structured record types, each representing a segment of the order confirmation message.
- It retrieves organization (store) information from the `anbll3` file (renamed from `anblpfr`) using keys derived from the local data area (LDA).
- It writes a message header, a message start, organization details, the order confirmation itself, and a message trailer to the output file `netores`.
- If the organization/store cannot be found in the database, the program aborts the export.

## File Usage

- **anbll3**: Input file (renamed from `anblpfr`). Used to retrieve organization/store info based on keys.
- **netores**: Output file, user open, keyed, and externally described. Receives the structured records.

## Data Structures

### Record Descriptions

The program defines several data structures (`DS`) to represent the different segments of the output message:

- **d_unh**: Message header (UNH segment)
  - Contains a segment identifier, a reference number (timestamp), type ID, and version.
- **d_bgm**: Message start (BGM segment)
  - Contains a segment identifier, type code, and function code.
- **d_org**: Organization/store info (ORG segment)
  - Contains organization ID, store ID, and organization name.
- **d_ore**: Order confirmation (ORE segment)
  - Contains a segment identifier, order reference number, and order number.
- **d_unt**: Message trailer (UNT segment)
  - Contains a segment identifier, the number of segments, and a reference number.

All record descriptions use overlays to map subfields onto a single buffer, which is then written directly to the output file.

## Parameters and Local Data Area

- **Parameters:**
  - `p_firm`: Company code
  - `p_nref`: Order reference number
  - `p_numm`: Order number (introduced in newer versions)

- **Local Data Area (LDA):**
  - Used to retrieve group, firm, and department codes (`l_fgrp`, `l_firm`, `l_avde`) for keying into the organization file.

## Key Business Logic

### Message Construction Flow

1. **Message Header (UNH):**
   - Timestamp is used as a unique reference number.
   - Written as the first record.

2. **Message Start (BGM):**
   - Contains a hardcoded type ID and function code.
   - Written after the header.

3. **Organization Segment (ORG):**
   - Key values are taken from the LDA.
   - If the first lookup fails (with the department code), it retries with department = 0 (company-wide).
   - If still not found, the program exits without generating a file.
   - Organization ID, store ID, and name are taken from the found record.

4. **Order Confirmation (ORE):**
   - Order reference and number are taken from the parameters.
   - A counter (`w_tell`) is incremented to count the segment.

5. **Message Trailer (UNT):**
   - Number of segments (from `w_tell`) and the header reference number are included.

### Error Handling

- If the organization/store cannot be found in the database (both with and without department code), the program jumps to the `avslutt` (exit) label and terminates without generating the output.

### Initialization

- The `*inzsr` subroutine handles:
  - Parameter retrieval
  - Key list (`klist`) definition for organization lookup

## Design Decisions and Conventions

- **Segmented Message Format:**  
  The output file is structured as a set of segments (UNH, BGM, ORG, ORE, UNT), each with a fixed layout. This is likely required by an external integration partner or a legacy data exchange standard.

- **Overlay Data Structures:**  
  Overlays are used to efficiently map subfields onto a buffer, which is then written out in one operation. This ensures precise control over record format and is typical for file-based integrations.

- **LDA Usage:**  
  The program relies on values in the local data area for company, group, and department context. This is a common pattern in older IBM i/AS400 applications to pass context between jobs or programs.

- **Fallback Lookup:**  
  If the organization is not found for the specific department, the program retries with a company-wide search (department = 0), implementing a fallback mechanism.

- **Versioning and Change Log:**  
  The header comment includes a detailed change log, referencing recompilations and enhancements (e.g., number expansions, file changes).

- **Exit Strategy:**  
  The program uses a `goto` to the `avslutt` tag for early exit, a legacy but clear approach in this codebase for handling abort conditions.

## Interactions and Dependencies

- **anbll3 File:**  
  Contains organization/store master data. The structure of this file is crucial to the success of the export, as missing or incorrect data here will cause the program to abort.

- **netores File:**  
  Acts as the export file. The format and structure must match downstream expectations.

- **LDA:**  
  Must be populated correctly before program invocation, as it provides key context for organization lookup.

## Notable Patterns and Conventions

- Use of overlays for record composition.
- Strict adherence to a message-based export protocol.
- Defensive programming with fallback and abort logic.
- Extensive use of fixed-format RPG, consistent with legacy IBM i codebases.

## Summary Table

| Segment | Structure | Source Data | Purpose |
|---------|-----------|-------------|---------|
| UNH     | d_unh     | Time Stamp  | Message Header (unique reference) |
| BGM     | d_bgm     | Constants   | Message Start/Type |
| ORG     | d_org     | anbll3 file | Organization/Store Info |
| ORE     | d_ore     | Parameters  | Order Confirmation |
| UNT     | d_unt     | Counter, UNH| Message Trailer |

## Integration Points

- **Input:** LDA, parameters
- **Data Source:** anbll3 file
- **Output:** netores file

## Business Domain Context

- The program is tailored for a Norwegian e-commerce ("nettbutikk") solution.
- It supports order confirmation exports, likely for EDI or batch integration with external systems.
- The record layouts and segment identifiers (UNH, BGM, ORG, ORE, UNT) suggest alignment with a custom or standardized message protocol.

---

**In summary:**  
This program is a batch export utility for order confirmations, producing a structured, segment-based file for integration purposes. It is tightly coupled to organization master data and expects correct context via the LDA. The format and flow are dictated by external integration requirements, and the codebase uses legacy RPG idioms and conventions throughout.