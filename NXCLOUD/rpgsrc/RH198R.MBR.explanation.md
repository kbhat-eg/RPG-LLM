# RH198R - Posting Generation Based on Distribution Parameters

## Overview

This program, `RH198R`, is a core component of the ASOKON system. Its main function is to generate accounting transaction records based on **distribution parameters** defined in various control files. The business logic revolves around three primary operations, controlled by the `rfkode` field in the distribution register:

- **B**: Calculation (Beregning) – Standard proportional distribution.
- **P**: Price Calculation (Prisberegning) – (Currently not in use).
- **O**: Redistribution (Omfordeling) – Allocates remaining amounts after B/P.

The program processes input transactions, checks for distribution rules, and generates new postings according to these rules. It ensures that each posting is handled according to company-specific distribution requirements, supporting both debet and kredit sides.

---

## Main Data Structures and Files

### Input/Output Files

- **rtrapf/rtrapfr**: Input transactions (posteringer inn).
- **rbunl1/rbunl1r, rbunlu/rbunlur**: Batch (bunt) control files.
- **raa1l1/raa1l1r, raa4l1/raa4l1r**: Status and last-used voucher numbers.
- **rforpfr/rfobl1r**: Distribution register (fordelingsregister).
- **rtral1/rtral1r**: Output transactions (posteringer ut).

### Key Data Structures

- **rtbrud, rfbrud**: Structures for key fields (company, account, special code, department).
- **Batch and transaction fields**: For tracking batch numbers, voucher numbers, line numbers, etc.
- **Working fields**: Accumulators and temporary variables for amounts, quantities, and values.

---

## Program Flow and Business Logic

### 1. Initialization

- The program is entered with a user/member identifier (`w_mem1`).
- Various accumulators and work fields are initialized.
- Key lists for file access are prepared.

### 2. Main Transaction Loop

For each input transaction (`rtrapfr`):

#### a. Member Filtering

- Only process transactions where `rtmemb` matches the current `w_mem1`.

#### b. Status and Voucher Number Retrieval

- If necessary, retrieve company status (`raa1l1r`) and last-used voucher number (`raa4l1r`).
- Increment and update voucher numbers as needed.

#### c. Batch (Bunt) Handling

- Check if a batch already exists; if not, determine the next available batch number.
- If the batch is expired or not found, skip processing.

#### d. Bilag Text Handling

- If the transaction text is blank, call program `RS701R` to fetch a default text based on the voucher code.

#### e. Copy Key Fields

- Store account, department, VAT, and other key info into working variables for later use.

---

### 3. Debet and Kredit Processing

Each side is processed similarly but independently:

#### a. Distribution Register Lookup

- For each account (debet and kredit), check if a distribution rule exists in `rfobl1r`.
- If found, loop through all applicable distribution records for the account.

#### b. Distribution Types

- **B (Calculation):** Proportionally allocate based on `rfpros` (percentage).
- **O (Redistribution):** Allocate remaining amounts, using both `rfpros` and `rfprot`.
- **P (Price Calculation):** Calculate posting based on quantity and unit price (`rfpris`).

#### c. Subroutine Calls

- `beregn`: Handles B-type (proportional) distribution.
- `pris`: Handles P-type (price-based) distribution.
- `omford`: Handles O-type (redistribution) distribution.

#### d. Accumulation and Remainder Handling

- Accumulate allocated amounts for each distribution.
- After all B/O/P allocations, write the original posting for any remainder (not distributed).

---

### 4. Posting Output

- For each calculated distribution, a new posting is written to the output file (`rtral1r`).
- Output postings are annotated with the operation type (`B+`, `P+`, `O+`) in the text field.

---

### 5. Batch Update

- After processing, update the batch record (`rbunlur`) with accumulated totals, last-used line number, and user/time info.

---

## Subroutines

### `beregn` (Calculation)

- Allocates amount based on percentage (`w_pros`).
- Sets appropriate account and department fields for debet/kredit.
- Writes a new posting if the amount is nonzero.
- Updates batch totals.

### `pris` (Price Calculation)

- Allocates based on quantity times price.
- Currently not in business use but implemented for future expansion.

### `omford` (Redistribution)

- Allocates remaining amounts (after B/P) using a combined factor (`w_fakt`).
- Performs rounding adjustments if the remainder is less than 1 (see `avrund`).
- Writes a new posting and updates batch totals.

### `avrund` (Rounding)

- Ensures that any tiny remainders (less than 1 in amount, value, or quantity) are added to the current distribution to avoid floating-point leftovers.

### `*inzsr` (Initialization)

- Sets up key lists and initializes variables at program start.

---

## Notable Design Patterns and Conventions

- **Distribution Register Driven:** All allocation logic is parameterized via the distribution register (`rfobl1r`), allowing business rules to be changed without code modification.
- **Batch-Oriented Processing:** Transactions are grouped and tracked by batch (bunt), with careful handling of batch status and numbering.
- **Separation of Debet/Kredit Logic:** Both sides are processed using similar but independent loops, making the code modular and easier to maintain.
- **Rounding Safeguards:** Explicit subroutine ensures no rounding errors propagate to financial records.
- **Text Annotation:** Each generated posting is labeled with its operation type for traceability.

---

## External Interactions

- **RS701R**: Called to fetch default voucher text based on code.
- **File Interactions:** Heavy use of keyed access and updates to control and transaction files.

---

## Business/Domain-Specific Notes

- **Distribution Parameters:** The system supports complex allocation schemes, including proportional splits and redistributions, which are common in accounting for shared costs or revenues.
- **Batch Lifecycle:** Batches can be expired (`rsstat = 'U'`), and the program ensures new batches are created as needed.
- **Future Expansion:** Price calculation logic is in place for future use, indicating forward compatibility with new business processes.

---

## Summary

RH198R is a robust, parameter-driven transaction generator for financial allocations. It reads input postings, applies company-specific distribution rules, and outputs detailed, traceable postings, ensuring all allocations are managed according to up-to-date business logic. The code is modular, with clear separation of concerns and strong support for auditability and future business needs.