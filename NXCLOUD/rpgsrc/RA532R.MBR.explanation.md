# RPG Program Overview and Explanation

This RPG program (RA532R) is an interactive, workstation-driven (screen-based) application, likely for querying and selecting credit card or agreement types ("kort/spørring" = "card/inquiry"). It makes extensive use of subfiles (a standard iSeries/AS400 pattern) for displaying and navigating lists on the display.

## High-Level Purpose

- **Main function:** Display and allow selection from a list of card or agreement types, possibly filtered by parameters. 
- **User interaction:** Paging, positioning, and selection within a subfile.
- **Integration:** Receives parameters, retrieves records from a master file, populates the subfile, and returns selected values.

---

## Structure and Key Features

### 1. Header and Documentation

- **`h option(*nodebugio) datedit(*dmy)`**  
  Specifies RPG compilation options: No debug for IO; date fields manipulated in day/month/year format.
- **Change log and comments:**  
  Detailed comments document program updates, field usage, and screen indicators.

---

### 2. File Declarations

```rpg
fruksl1    if   e           k disk    rename(rukspfr:ruksl1r)
fra532d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **`fruksl1`** – Input file with key; renamed record format. Likely the "cards/agreements" master.
- **`fra532d`** – Workstation file (screen), uses subfile **b1sfl** with relative subfile record number **w_srrn**.

---

### 3. Data Definitions

#### a) Parameters

```rpg
d p_firm          s                   like(rusfir)
d p_skty          s                   like(ruskty)
d p_slag          s                   like(ruslag)
d p_sbes          s                   like(rusbes)
```
- **Parameters** to be received at program entry (company, type, subtype, description), matching the master file fields.

#### b) Working Variables

- **Subfile Handling Variables**  
  E.g., `w_stel` (subfile counter), `w_spge` (page size), `w_srrn` (rel rec #), etc.
- **Indicators**  
  Standard indicator usage is documented (e.g., *in10 for Roll, *in14 for clear, etc).
- **Subfile page size constant**  
  `c_sfil` is the page size for the subfile (here 7).

---

### 4. Main Procedure Flow

_(This appears to be written in RPG/400 or RPG III, not /free-form)_

#### a) Initial Screen Handling

- **Main Tag Loop:**  
  The tags (e.g., `b2taga`, `b2tagb`) and branching/goto form the typical main event loop for a subfile-driven display:

  - **`b2taga`**: Writes command screen (`b2cmd`)
  - **`b2tagb`**: Main logic (displays subfile via `dsp_subfile`, handles selection, keys, paging, etc.)

#### b) Subfile Display & Paging

- **Handles selection, function keys (roll, roll-up, roll-down, home, etc), and navigation.**
- **Subfile is cleared and refilled as needed:**
  - `clr_subfile`: Blanks out subfile records (sets *in14, writes b2ctl, resets counters)
  - `crt_subfile`: Reads master file, fills subfile with up to `c_sfil` records per page, skipping records if filtering (`p_skty` param)
  - `bck_subfile`: Reads backward in file to load previous "page"
- **Positioning in Subfile**  
  - Handles requests for positioning/jumping to a particular card type.

#### c) Record Selection

- In the subfile processing loop, if `b1valg = 1` (the user selected this line), corresponding fields are assigned to the parameter return values and the selection flag (`b_valg_ok`) is set.

#### d) Card/Agreement Type Text

- The `kort_type` subroutine assigns human-readable text for each card/agreement type for subfile display.

#### e) Program Initialization (`*inzsr`)

- Parameters are received using a PLIST.
- Key lists (`klist`) set for later keyed access.
- Starting position set in the master file, subfile filled.

---

### 5. Subfile Concepts and Screen Fields

- Subfile management is handled *explicitly*: writing, clearing, and filling the subfile for each page.
- User can page up/down, reposition, and select using various function keys.
- Visual indicator fields (SFLDSP, SFLDSPCTL, SFLCLR, SFLEND) correspond to the subfile display control.

---

### 6. Function Key Handling

- **Case structure (SELECT/WHEN):**
  - *F3/F12* (`*inkc or *inkl`): Exit program.
  - *F5* (`*inke`): Refresh, reload the subfile.
  - *Roll up* (`*in10`): Next page.
  - *Roll down* (`*in11`): Previous page.
  - *Home* (`*in21`): Set cursor for positioning.

---

### 7. Notable Features

- **Parameter filtering:**  
  If a card type parameter is supplied, only that type is shown in the list.
- **Positioning:**  
  The user can request to jump to a particular record in the subfile.
- **Card type display:**  
  The `kort_type` subroutine maps numeric card type codes to a description for the user to see.

---

### 8. Subroutines

- **forny:** Refreshes subfile from current position.
- **posisjoner:** Positions on a card type, clears and refills subfile.
- **subfile:** Reads/display subfile, processes selection.
- **clr_subfile:** Clears subfile contents/display.
- **crt_subfile:** Reads master records, fills next page of subfile.
- **kort_type:** Sets description of card/agreement type.
- **bck_subfile:** Handles going back a page in the list.
- **dsp_subfile:** Formats and displays the subfile screen.
- **\*inzsr:** Initialization, setups up parameters, key list, fills subfile on entry.

---

## Summary Table of Important Variables

| Variable        | Purpose                                            |
|-----------------|---------------------------------------------------|
| p_firm, ...     | Input/output parameters (firm, type, etc)         |
| w_srrn          | Current subfile record (for SFL handling)         |
| w_spge          | Page size (number of records per subfile page)    |
| w_sfrn/w_ssrn   | First/last rec# on page                           |
| b1valg          | User's selection flag in subfile                  |
| ruksl1_skty     | Key variable for file access                      |
| c_sfil          | Subfile page size constant                        |

---

## Typical Program Flow

1. **Initialization (`*inzsr`):**  
   Receives parameters, sets up key lists, positions the master file.
2. **First subfile page filled and displayed.**
3. **User navigates list:**  
   - Next/Prev page, positions, or selects an entry.
4. **If entry selected:**  
   Selected fields written back to parameters; program ends.
5. **If exit requested (F3/F12):**  
   Return (set LR on).

---

## Onboarding Notes

- RPG indicators control much of the subfile logic.
- Control returns to the main "tag" loop (via GOTO) after each major user interaction.
- Comments are clear regarding field usage and program changes.
- Knowledge of DDS (Display File DDS) and subfile processing is assumed.

---

### Further Reading

For a developer new to RPG or subfile logic:
- Review how subfiles work in *display files* (DDS).
- Understand classic RPG (fixed-form) syntax and use of indicators.
- Familiarize yourself with the notion of status indicators and function key handling.

---

**In summary:**  
This program is a classic RPG subfile selection list, allowing the user to page through, position on, and select a card/agreement type, with the result returned via parameters. The user interface and logic are handled via display file subfiles and indicators, with all logic coded in traditional RPG/400 style.