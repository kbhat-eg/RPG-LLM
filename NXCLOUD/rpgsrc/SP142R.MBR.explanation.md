# SP142R – Parameter File Selection for Invoice/Credit Note Range

## Overview

This program, part of the ASSTAT system, is responsible for maintaining selection parameters in a parameter file related to invoice and credit note ranges. It is typically invoked as a subroutine or called program, receiving parameters that identify a firm and a parameter type, and then allows the user to maintain (add, update, or delete) the ranges for invoices and credit notes associated with those parameters.

The main business logic revolves around allowing the user to specify "from" and "to" values for both invoice and credit note numbers, storing these in a parameter file (SKPMLU), and ensuring data integrity and correct updating/deletion behavior.

## Key Files and Data Structures

### Files

- **SKPML1**  
  Input file (disk), keyed, renamed from `skpmpfr` to `skpml1r`. Used to check for an existing parameter record.

- **SKPMLU**  
  Update file (disk), keyed, renamed from `skpmpfr` to `skpmlur`. Used to update, delete, or write parameter records.

- **SP142D**  
  Workstation file, used for user interaction (displaying and receiving input).

### Data Structures

- **wwrest (DS, 330 bytes):**  
  Holds the full parameter record, including:
  - `wwtext` (1–30): Description
  - `wwffak` (31–36): Invoice number, from
  - `wwtfak` (37–42): Invoice number, to
  - `wwfkre` (43–48): Credit note number, from
  - `wwtkre` (49–54): Credit note number, to

- **wwvalg (DS, 15 bytes):**  
  Used as part of the key to parameter files.

- **User/firm fields (uds):**  
  Extracted from a user data structure, providing default values for firm and user.

## Program Flow

### Initialization (`*inzsr`)

- Receives two parameters:  
  - `wptype`: Parameter type  
  - `wptext`: Parameter description

- Sets up key fields (`wwfirm`, `wwtype`, `wwkode`, `wwvalg`) for file access.
- Initializes working variables and sets up display fields for the workstation.

### Main Loop

#### 1. Load Existing Record

- Uses the composite key (`wwfirm`, `wwtype`, `wwkode`, `wwvalg`) to chain into SKPML1.
- If found:
  - Loads existing parameter values into the display fields (`b2ffak`, `b2tfak`, `b2fkre`, `b2tkre`).
- If not found:
  - Initializes all values to zero.

#### 2. User Interaction

- Presents the input screen (`b2bld`) for the user to review or modify the invoice and credit note ranges.

- If the user presses Cancel (`*INKC`) or Exit (`*INKL`), the program exits.

- Validates that "from" values are not greater than "to" values for both invoice and credit note ranges. If invalid, redisplays the screen for correction.

#### 3. Update Parameter File

- Chains into SKPMLU with the same key.
- Updates the record fields with the user's input.

- If the record exists:
  - If all range values are zero, deletes the record (interpreted as a request to remove the parameter).
  - Otherwise, updates the record with new values.

- If the record does not exist:
  - Populates key fields (`spfirm`, `sptype`, `spkode`) and writes a new record.

### Program Exit

- Sets LR indicator (`*INLR`) and returns.

## Business/Domain-Specific Logic

- **Selection Parameter Maintenance:**  
  The program manages ranges for invoices and credit notes as selection parameters, likely used elsewhere in the system for filtering or processing transactions.

- **Zero Values as Deletion:**  
  If all four range values are zero, the parameter record is deleted from the file. This is a business convention in this system for removing a selection.

- **Parameter Keying:**  
  The combination of firm, type, code (`42`), and "valg" (selection) uniquely identifies a parameter record. The code `42` is hardcoded, indicating this program only manages a specific type of parameter.

- **User Context:**  
  The program retrieves firm and user information from a user data structure, ensuring that selection parameters are always associated with the correct firm context.

## Design Decisions and Patterns

- **Single Screen Maintenance:**  
  The program uses a simple loop to repeatedly display the maintenance screen until the user either enters valid data or cancels/exits.

- **Record Existence Checks:**  
  Both SKPML1 and SKPMLU are checked for existing records before update/write actions, ensuring that updates and deletions are handled correctly.

- **File Renaming:**  
  The use of `rename(skpmpfr:skpml1r)` and `rename(skpmpfr:skpmlur)` allows the same physical file to be used with different record formats or access methods, a common pattern in this codebase.

- **Separation of Input and Update Files:**  
  SKPML1 is used for input (read-only), while SKPMLU is used for updates and deletions, providing a clear separation of concerns and potentially supporting concurrent access patterns.

## Interactions with Other Modules

- **Calling Program:**  
  Receives parameters (`wptype`, `wptext`) from the calling program, which determines the context for which selection parameters are being maintained.

- **Downstream Usage:**  
  The maintained parameters are likely used by other processes in the ASSTAT system for filtering or processing invoice and credit note transactions based on the specified ranges.

## Conventions

- **Hardcoded Parameter Code (`42`):**  
  All parameter maintenance in this program is associated with code `42`. Other codes/types may be handled by different programs.

- **User/Firm Extraction:**  
  Firm and user values are extracted from a shared user data structure, which is a standard in this codebase for ensuring context.

- **Deletion by Zeroing:**  
  Deletion is triggered by setting all range values to zero, a convention that should be followed elsewhere for consistency.

## Summary Table

| Field      | Description                       | Source/Usage             |
|------------|-----------------------------------|--------------------------|
| b2ffak     | Invoice number, from              | User input               |
| b2tfak     | Invoice number, to                | User input               |
| b2fkre     | Credit note number, from          | User input               |
| b2tkre     | Credit note number, to            | User input               |
| wwfirm     | Firm number                       | From user data structure |
| wptype     | Parameter type                    | Program parameter        |
| wwkode     | Parameter code (always 42)        | Hardcoded                |
| wwvalg     | Selection key (blank)             | Initialized              |

## Maintenance/Extension Notes

- If additional parameter types or codes need to be managed, consider parameterizing the code value or refactoring to support multiple codes.
- Ensure that other programs interacting with SKPMLU honor the deletion-by-zero convention.
- The program assumes that the user data structure is correctly populated before entry.

---

For further questions about integration points or business rules, consult the ASSTAT system documentation or contact the system architect.