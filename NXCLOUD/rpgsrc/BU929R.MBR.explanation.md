## Overview

This program, **BU929R**, is a central part of the ASSHOP system, responsible for retrieving the calculated price and discounts for a given item/unit combination in a retail (butikk) context. It builds upon and is intended to replace the earlier **BU927R** program, with an extended capability to handle "prisgruppe" (price group) logic, which is required by the NGN business area.

The core function is to:
- Validate that the item and item/unit combination exist.
- Retrieve customer discount category.
- Prepare and call the pricing engine (program **VP900R**) with all relevant parameters.
- Post-process the returned values to calculate the net price after applying multiple discounts.
- Return all relevant pricing information and status indicators to the caller.

## File Usage and Data Relationships

- **rkunl1** (renamed from rkunpfr): Customer master, used to look up customer discount category.
- **vvarl1** (renamed from vvarpfr): Item master, used to validate the existence of the item.
- **vvenl1** (renamed from vvenpfr): Item/unit combination, used to validate the existence of the specific item/unit pairing.

## Parameter and Data Structure Handling

### Input Parameters

The program uses a parameter list (PLIST) for entry, which is standard for callable RPG programs in this system. Notable parameters include:
- **p_firm**: Company code.
- **p_kund**: Customer number.
- **p_kpro**: Customer project.
- **p_vare**: Item number.
- **p_enhe**: Unit of measure.
- **p_lety**: Delivery type.
- **p_lagr**: Warehouse/location.
- **p_dato**: Price date.
- **p_klub**: Customer club indicator (added in later versions).

### Output Parameters

- **p_sapr**: Sales price.
- **p_rab1/p_rab2**: Discount 1 and 2.
- **p_brr1/p_brr2**: Usage right discounts.
- **p_kpri**: Price code.
- **p_kamp**: Campaign code.
- **p_netp**: Net price (calculated).
- **p_kopr**: Cost price.
- **p_prgr**: Price group (expanded to 2 positions in v8.02).
- **p_stat**: Status indicator for error handling.

### Data Structures

- **hirec** (input to VP900R): Aggregates all input parameters for the pricing engine.
- **horec** (output from VP900R): Receives all output values from the pricing engine.

Overlay fields are used throughout to map specific subfields to the correct positions within these structures, which is a standard pattern in this codebase for interfacing with external programs.

## Key Business Logic

### 1. Validation Steps

- The program first checks if the item exists in **vvarl1**. If not, it sets **p_stat = 1** and exits.
- Next, it checks if the item/unit combination exists in **vvenl1**. If not, it sets **p_stat = 2** and exits.

This ensures data integrity before any pricing logic is attempted.

### 2. Customer Discount Category

- The program attempts to retrieve the customer's discount category from **rkunl1**. If not found, it defaults to zero.

### 3. Preparation for Pricing Engine Call

- All necessary fields are populated into the **hirec** data structure, including company, customer, item, unit, date, price group, customer club, etc.
- The price group (**w_prgr**) is fetched via a call to **VL712R**, which is responsible for determining the price group based on company, warehouse, and department.
- The item type and supplier (for wood assortment logic) are fetched by calling **BL710R**.

### 4. Call to Pricing Engine

- The program calls **VP900R**, passing **hirec** (input) and **horec** (output).
- The fields returned from **horec** are mapped to the output parameters.

### 5. Net Price Calculation

- The program applies up to four discounts (two standard, two usage right) sequentially, each time recalculating the base for the next discount.
- The net price (**p_netp**) is calculated as the original sales price minus the sum of all discounts.

### 6. Error Handling

- **p_stat** is used as a status indicator:
    - 0: OK
    - 1: Item not found
    - 2: Item/unit combination not found

## Design Patterns and Conventions

- **File Renaming**: Files are renamed on input (e.g., rkunpfr → rkunl1r) for clarity and to allow for multiple logical files over the same physical files—a common pattern in this codebase.
- **Overlay Data Structures**: Used extensively for parameter passing with external programs, reducing coupling and simplifying field mapping.
- **Versioning**: Change history is maintained in comments, with clear references to business requirements and bug fixes. This is crucial for understanding why certain logic exists (e.g., handling of price group, customer club, supplier logic for wood assortment).
- **Error Handling**: Uses parameter-based status indicators rather than exceptions, which aligns with batch and callable program conventions in this environment.
- **Modularization**: Calls to external programs (e.g., **VP900R**, **VL712R**, **BL710R**) encapsulate specific business logic, keeping this program focused on orchestration and integration.

## External Program Interactions

- **VP900R**: Core pricing engine, calculates all price and discount values based on the input structure.
- **VL712R**: Determines the price group for the item/warehouse/department combination.
- **BL710R**: Retrieves item type and supplier, specifically for wood assortment logic.

## Business Domain Specifics

- **Prisgruppe (Price Group)**: Critical for NGN requirements; the logic ensures that the price group used in the transaction is available to the caller.
- **Kundeklubb (Customer Club)**: Additional pricing logic may apply for club members, handled via an extra parameter.
- **Bruksrettsrabatt (Usage Right Discount)**: Specific to certain product categories or customer types; applied in addition to standard discounts.
- **Kampanjekode (Campaign Code)**: Used for promotional pricing, returned from the pricing engine.

## Summary

BU929R is a robust, extensible program for retrieving and calculating prices and discounts for retail transactions, with strong integration to the broader pricing and master data infrastructure. It ensures data integrity, supports evolving business requirements (such as price group and customer club logic), and delegates complex pricing calculations to a central engine. The program's structure and conventions are consistent with the rest of the ASSHOP system, facilitating maintainability and future enhancements.