# RPG Program AP500R - Explanation

## Overview

This RPG program is written for the IBM i (AS/400) environment using the ILE RPG language. The main function of the program is to provide a subfile-based display for post addresses ("Postadresse") with query functionality. The application is designed to allow the user to view, page through, and select postal information, primarily from two physical files (`aposl1` and `aposl2`). It extensively uses subfiles for displaying multiple records and handling navigation actions like roll (page down), rolldown (page up), and position-to-field.

The code is well-commented and makes use of Norwegian field and comment names. Below is a breakdown of important sections and logic of the code.

---

## Header and Definitions

### Control Specification

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debug for I/O routines.
- Sets default date edit to day/month/year.

### File Declarations

```rpg
faposl1    if   e           k disk    rename(apospfr:aposl1r)
faposl2    if   e           k disk    rename(apospfr:aposl2r)
fap500d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- `aposl1` and `aposl2`: Input files, externally described, keyed, renamed.
- `ap500d`: Workstation file for screen display, includes subfile (`b1sfl`) and an information data structure (`dspfbk`).

### Data Structures and Variables

#### Parameters

```rpg
d p_ponr          s                   like(apponr)
d p_sted          s                   like(apsted)
```
- Used to store selected post number (`p_ponr`) and place (`p_sted`) from the subfile.

#### Information Data Structure (INFDS)

```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- INFDS for `ap500d` to get display feedback (e.g., first record number displayed).

#### Key Variables

```rpg
d aposl1_ponr     s                   like(apponr)
d aposl2_sted     s                   like(apsted)
```
- Used to build key lists for positioning in files.

#### Working Variables

```rpg
d w_fcrn          s              4  0  // First record displayed in subfile page
d w_stel          s              4  0  // Subfile record counter
d w_spge          s              4  0  // Subfile page size
d w_srrn          s              4  0  // Current subfile record number
d w_sfrn          s                   // First record number on last page
d w_ssrn          s                   // Last record number on last page
...
d w_seqe          s              1     // Sequence ('S' for place, blank for number)
d b_valg_ok       s              1 inz(*off)
d c_sfil          s              2  0 inz(8) // Constant, number of subfile records per page
```
- Used for paging, record tracking, etc.

---

## Main Control Flow

### Entry and Initialization (`*inzsr`)

- Loads entry parameters.
- Sets up key lists used for file positioning.
- Initializes subfile by clearing and filling it.
- Positions database for post numbers, fills the subfile.

### Main Loop

The program uses `goto` and labels (`tags`) to handle screen redisplay and control flow (old RPG style):

1. **Tag `b2taga`**
   - Writes function key screen (`b2cmd`).
2. **Tag `b2tagb`**
   - Executes `dsp_subfile` subroutine to show/update the subfile.
   - Handles function keys via `select`:
     - Exit (F3/12): close program.
     - Refresh (F5): renew subfile.
     - Page down (F10): show next subfile page.
     - Page up (F11): show previous subfile page.
     - Home (F21): repositions cursor, redisplay.
   - Position-to logic: if position fields entered, calls `posisjoner`.
   - Handles subfile selection (`subfile` subroutine).
   - Loops until a selection is made or exited.

### Exit Point

Label `avslutt` sets last record indicator (`*INLR`) and returns.

---

## Subroutines

### `forny` - Refresh Subfile

- Repositions file pointer if necessary.
- Sets up correct key, repositions using `SETLL`.
- Clears and refills the subfile.

### `posisjoner` - Position in Subfile

- Checks if user entered a post number or place for positioning.
- Sets sequence mode accordingly (`w_seqe`).
- Positions relevant file using `SETLL`.
- Clears and refills the subfile.
- Clears position fields after use.

### `subfile` - Subfile Processing

- Toggles indicator (`*IN22`) for cursor placement.
- Reads records from the subfile with `READC`.
- Detects selection (`b1valg = 1`), stores selected values, sets `b_valg_ok = *on`, and exits.
- Loops through all records or until a selection is made.

### `clr_subfile` - Clear Subfile

- Sets indicator to clear subfile (`*IN14`).
- Resets counters and indicators for subfile.

### `crt_subfile` - Create/Fill Subfile

- Increments page count.
- Reads the correct file (`aposl1` or `aposl2`) based on sequence (`w_seqe`).
- Loads up to `c_sfil` records into the subfile.
- Marks end of records if EOF is reached.

### `bck_subfile` - Scroll Backwards (Page Up)

- Positions file correctly for backward paging using `READP` (previous record).
- Loads previous page worth of records.
- Resets position if beginning of file.
- Clears and refills subfile for display.

### `dsp_subfile` - Display Subfile

- Determines which screen to display based on subfile record counter.
- Sets necessary indicators for subfile control record.
- Loads display feedback for cursor positioning.

### `*inzsr` - Initialization Subroutine

- Handles program entry, parameter assignment, key list setup, initial subfile fill.

---

## Indicators Usage (from comments)

- `*INLR` = End of program.
- `*IN10` = Page down (Roll).
- `*IN11` = Page up (Rolldown).
- `*IN12` = Subfile display.
- `*IN13` = Subfile display control.
- `*IN14` = Subfile clear.
- `*IN15` = Subfile end.
- `*IN21` = Home key.
- `*IN22` = Cursor placement.
- Others for field protection, error, and working indicators.

---

## Screen Definitions

- **`b1sfl`**: Subfile record format.
- **`b2ctl`**: Subfile control record (header, page keys, etc).
- **`b2cmd`**: Command key screen.

---

## Summary

- The program provides a generic subfile inquiry and selection interface.
- Users can page forward/back, position to records, and select an item.
- Main business logic is contained in subroutines called via EXSR.
- Uses legacy RPG IV (fixed-format) code and indicator-driven logic, with comments explaining the use of all major fields, indicators, and routines.
- The use of subfiles, database positioning, and indicator-driven screen control is canonical for traditional green-screen RPG applications on IBM i.

---

## Key Takeaways for Onboarding

- Understand the use of indicators for controlling subfile behavior and navigation.
- Subfiles are buffered lists of records for user selection/paging, with explicit logic for loading and clearing.
- File positioning (`SETLL`, `READ`, `READP`) is fundamental for both forward and backward paging.
- The control flow is largely handled via goto statements and labels (pre-ILE procedural style).
- All data entry, display refresh, and navigation is coordinated through subfile-related subroutines.
- Norwegian variable and comment names require careful mapping (e.g., "sted" = place, "ponr" = post number).

If you need a deeper walkthrough of a specific routine or example test scenario, please ask!