# Explanation of RPG Source Code (FO681R)

This RPG program, `FO681R`, is used to print a copy of an invoice ("Utskrift av fakturakopi"). Below, you will find explanations of each section, data usage, and program flow to help you get oriented.

---

## Program Metadata & Revision History

- The program is titled and described at the top with system name (`ASOFAK`), program name (`FO681R`), and description (printing an invoice copy).
- It contains a detailed change history (in Norwegian), showing who made revisions and what was changed (e.g., parameter management, copy routines, adjustments for number expansions).

---

## File Declarations

```rpg
fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
faforl1    if   e           k disk    rename(aforpfr:aforl1r)
```

- `votyl1`: Refers to a file containing order type information, using a record format renamed to `votyl1r`.
- `aforl1`: Refers to a file (activated in version 6.20 and up) related to "routine" lookup, record format renamed to `aforl1r`.

---

## Data Structure Declarations

### Call Parameter Data Structure

```rpg
d                 ds
d d_list                        34
d  d_aarr                        4  0 overlay(d_list)
d  d_otyp                        2    overlay(d_list:5)
d  d_fbin                        8  0 overlay(d_list:7)
d  d_tbin                        8  0 overlay(d_list:15)
d  d_prog                       10    overlay(d_list:23)
d  d_kopi                        1    overlay(d_list:33)
d  d_dumy                        1    overlay(d_list:34)
```

- Defines a 34-character data structure (`d_list`), subdivided with overlays for:
  - `d_aarr`: Year
  - `d_otyp`: Order type
  - `d_fbin`, `d_tbin`: Number fields (e.g., invoice number)
  - `d_prog`: Program name
  - `d_kopi`: Copy flag
  - `d_dumy`: Dummy parameter (prevents parameter list contamination)

### Other Variables

- `p_firm`, `p_aarr`, `p_binr`, `p_otyp`: Standalone variables for input parameters
- `w_firm`: Working variable for firm code
- `votyl1_otyp`, `aforl1_ruti`, `d_orut`: For holding key values and routine names

---

## Main Program Logic

### 1. Get Routine Name

```rpg
c                   eval      votyl1_otyp = p_otyp
c     votyl1_key    chain     votyl1                             60
c                   if        *in60 = *on or
c                             vaoakk <> 3
c                   goto      avslutt
c                   endif
```

- Uses `p_otyp` (order type) to look up in the `votyl1` file.
- If the record is not found or a specific field (`vaoakk`) isn't 3, the program ends (goto `avslutt`).

### 2. Check for Copy Routine

```rpg
c                   eval      d_orut = vaorut
c                   eval      aforl1_ruti = %trim(vaorut) + '1'
c     aforl1_key    chain     aforl1                             61
c                   if        *in61 = *off
c                   eval      d_orut = aforl1_ruti
c                   endif
```

- Checks if a special "copy" routine exists: appends '1' to the trimmed routine name (`vaorut`).
- If a matching routine is found in `aforl1`, uses that; otherwise, defaults to the main routine.

### 3. Fill Data Structure & Call Print Controller

```rpg
c                   eval      d_aarr = p_aarr
c                   eval      d_otyp = p_otyp
c                   eval      d_fbin = p_binr
c                   eval      d_tbin = p_binr
c                   eval      d_kopi = 'K'
c                   eval      d_dumy = '*'
c                   call      'FO681C'
c                   parm                    d_list
c                   parm                    d_orut
```

- Populates the parameter data structure with appropriate values.
- Calls the controller program (`FO681C`) for printing, passing the filled structure and the routine name (copy or main routine).

### 4. Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```

- Ensures program state is cleaned up and marks last record indicator (`*INLR`) before returning.

---

## Initialization Subroutine (`*INZSR`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_aarr
c                   parm                    p_binr
c                   parm                    p_otyp
...
c                   eval      w_firm = p_firm
c                   endsr
```

- Handles parameter passing on program entry.
- Sets up values for main file key lookups (order type and firm code).

---

## Key Lists

- `votyl1_key`: Lookup key for the order type file, based on firm and order type.
- `aforl1_key`: Lookup key for the routine register, based on routine name (modified for "copy" routines).

---

## Summary

- The program's main function is to look up the correct routine for invoice reprinting based on order type, optionally use a dedicated "copy" routine, and then call a print controller with all relevant data passed in a well-defined structure.
- It is structured to be easily maintainable and extensible, following RPG best practices of the time, and implements special handling for copy routines and dummy parameters to protect parameter lists.

---

## Key Concepts for Onboarding

- **Parameter Handling**: Input parameters are mapped into working variables and packed into a data structure for passing to another program.
- **File Access**: Uses the `CHAIN` operation for keyed file lookups. Error handling is done via indicator variables (`*IN60`, etc.).
- **Data Structures**: Overlays are used for compact parameter management.
- **Routine Control**: Ability to switch between a standard and a "copy" routine per business rules.

If you have any specific section or concept you'd like to dig deeper into, feel free to ask!