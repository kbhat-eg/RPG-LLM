# RPG Program RA528R – Explanation

This program, written in RPG IV (ILE RPG), is an interactive (display file) application designed for IBM i systems. It handles "kostnadsbærer" (cost carrier) inquiry, allowing users to view and select records via subfiles with various navigation and selection options. The majority of comments and variable names are in Norwegian, but the underlying logic is a classic subfile browse/select pattern.

Below is a detailed breakdown by section:

---

## Header and Documentation

- `h option(*nodebugio) datedit(*dmy)`: 
  - Compile options: disables debug I/O, sets date editing to day/month/year format.
- The heading comments describe the system, program name, and its purpose. It includes change history and some explanation of field usage.

---

## Indicators

- RPG indicators (`*INxx`), with legend on their function:
  - `LR`: End-of-program indicator.
  - `10-15, 21-22, 30-99`: Used for specific display and processing logic.
  - Comments clarify what each indicator is for in the context of the screens/subfiles.

---

## File Declarations

```rpg
fra28l1    if   e           k disk    rename(ra28pfr:ra28l1r)
fra28l2    if   e           k disk    rename(ra28pfr:ra28l2r)
fra528d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- Declares two logical file inputs (`fra28l1`, `fra28l2`) for cost carriers (possibly index by code and by description).
- Declares a display file (`fra528d`) using a subfile (`b1sfl`) with relative record number (`w_srrn`).

---

## Data Definitions

### Parameters

- `p_firm`, `p_bkod`, `p_btxt`: Passed into the program; likely company/firm code, cost carrier code, and description.

### Key Variables

- `ra28l1_bkod`, `ra28l2_btxt`: For setting keys in the logical files.

### Working Variables

- Variables like `w_stel`, `w_spge`, `w_srrn`, etc., manage subfile state: total records, page size, relative numbers, etc.
- `w_seqe`: Sequence type (indicates which logical file to use for navigation).
- `b_valg_ok`: Flag to indicate a valid selection.

### Constants

- `c_sfil`: Subfile page size (defaults to 8).

---

## Important Concepts

### Subfile Handling

- Classic subfile management is used: loading, clearing, paging through, and positioning records in a “work with” list.
- Multiple display formats are referenced: `B1SFL` (subfile), `B2CTL` (control), `B2CMD` (command keys).

---

## Main Control Flow

### "Behandle åpningsbildet med subfile" (Handle the opening screen with subfile)

This is the main interactive loop operating via tags and GOTOs (a common pattern in classic RPG):

- `b2taga` and `b2tagb` tags anchor navigation in the main program loop.
- The program writes the initial screen (`b2cmd`), displays or updates the subfile, recalculates paging pointers, and processes function key input (F-keys via indicators).

#### Function Key Handling

- `*INKC` / `*INKL`: Exit program.
- `*INKE`: Refresh (call `forny` subroutine).
- `*IN10`: Next page (`crt_subfile`).
- `*IN11`: Previous page (`bck_subfile`).
- `*IN21`: Home key, positions cursor to start.
- `*IN22`: Cursor positioning.

#### Subfile Selection

- Allows for positioning based on code or description, handled by the `posisjoner` subroutine.

---

## Subroutines

### `forny` – Refresh Subfile
- Rereads database for current position and reloads subfile.

### `posisjoner` – Position Subfile
- Sets key for database access based on user input (code or description).
- Clears and repopulates the subfile accordingly.
- Blanks out positioning fields after use.

### `subfile` – Subfile Processing
- Handles record selection in subfile.
- Iterates through subfile for user selection (`b1valg=1`), returns selected values.

### `clr_subfile` – Clear Subfile
- Sets indicator to clear subfile, resets page/record pointers.

### `crt_subfile` – Create/Fill Subfile
- Reads records from the appropriate logical file and fills subfile page by page.
- Handles end-of-file and record limits.

### `bck_subfile` – Page Backwards in Subfile
- Reads previous page of records for paging backward.
- Sets keys, reads records in reverse order, and repopulates subfile.

### `dsp_subfile` – Display Subfile
- Controls display format and manages which indicators are set to show/refresh subfile.

### `*inzsr` – Initialization
- Establishes entry parameters.
- Initializes key lists for database positioning.
- Sets up first subfile page.

---

## Keylists

- `ra28l1_key` and `ra28l2_key` are key lists for accessing the two logical files, based on firm and either code or description.

---

## Entry Parameters

- At program start (`*inzsr`), parameters for firm, code, and description are fetched for use in the application logic.

---

## General Workflow

1. **Program starts**: Parameters read, keys set, first subfile loaded.
2. **Main loop**: User interacts with subfile via function keys.
3. **Paging/Positioning**: Users can search, page forward/back, or position to a specific record.
4. **Selection**: User may select a record; selected values are assigned to output parameters.
5. **Exit**: Program ends and returns control to caller.

---

## Usage Scenarios

- **Inquiry and selection**: User searches for a cost carrier by code or text.
- **Paging through results**: Subfile supports paging forward/backward.
- **Cursor positioning**: User can quickly move to home position or a specific page.
- **Selection**: Selecting a line returns associated data via parameters.

---

## Summary

This is a robust, traditional interactive subfile RPG program for searching, viewing, and selecting cost carrier records on IBM i, supporting navigation by both code and description, subfile paging, and flexible positioning. Its structure is typical for such programs with clear separation of file handling, key management, and subfile operations, making onboarding and modifications relatively straightforward for experienced RPG developers.