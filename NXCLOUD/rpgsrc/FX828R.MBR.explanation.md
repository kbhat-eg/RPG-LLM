# Explanation of ASOFAK - Program FX828R

## Purpose

This RPG program is designed to process purchase statistics records, updating their product group fields according to the current item master file. It cross-references the product number in each purchase statistics record with master item files (`vvarl1` and `vvasl1`), and if a match is found, it updates the group fields in the statistics record to match those in the item master.

## File Declarations

```rpg
fsistpf    uf a e           k disk    rename(sistpfr:sistpfr)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvasl1    if   e           k disk    rename(vvaspfr:vvasl1r)
```

- **sistpf**: Purchase statistics file (primary file being processed/updated).
- **vvarl1 / vvasl1**: Item master files (used for lookup of group information).

All files are disk files and have a record format rename.

## Key Fields for Lookups

```rpg
d vvarl1_firm     s                   like(vvfirm)
d vvarl1_vare     s                   like(vvvare)
```

- `vvarl1_firm` and `vvarl1_vare` are variables used to hold company and item number values for key lookups in the item master files.

## Main Processing Logic

### Loop and Read

```rpg
c                   read      sistpfr                                90
c                   dow       *in90 = *off
```

- Reads the first record from the purchase statistics file.
- Loops until end of file (`*in90 = *on`).

### For Each Record

1. **Check if Product Number Exists**
   ```rpg
   c                   if        sivare <> *blank
   ```
   - Processes only records where the item number (`sivare`) is not blank.

2. **Prepare Key for Lookup**
   ```rpg
   c                   eval      vvarl1_firm = sifirm
   c                   eval      vvarl1_vare = sivare
   ```
   - Sets key fields for lookup in the item master files.

3. **Try to Find a Match in Primary and Secondary Item Files**
   ```rpg
   c     vvarl1_key    chain     vvarl1                             91
   c                   if        *in91 = *on
   c     vvarl1_key    chain     vvasl1                             91
   c                   endif
   ```
   - Tries to find a matching item in `vvarl1`. If not found (`*in91 = *on`), tries `vvasl1`.
   - `*in91` is the record not found indicator for CHAIN.

4. **If Match Found, Update Group Fields**
   ```rpg
   c                   if        *in91 = *off
   c                   eval      siogrp = vvogrp
   c                   eval      sihgrp = vvhgrp
   c                   eval      siugrp = vvugrp
   c                   eval      siahgr = vvahgr
   c                   eval      siaugr = vvaugr
   c                   endif
   ```
   - If a match is found (`*in91 = *off`), updates the group fields in the current statistics record with values from the item master.

5. **Update the Purchase Statistics Record**
   ```rpg
   c                   update    sistpfr
   ```

6. **Read Next Record**
   ```rpg
   c                   read      sistpfr                                90
   c                   enddo
   ```

### End/Exit Program

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```

- Marks the end of the program with a tag.
- Sets the last record indicator (`*inlr`) to on and returns (ends the program).

## Initialization Subroutine

```rpg
c     *inzsr        begsr
c     vvarl1_key    klist
c                   kfld                    vvarl1_firm
c                   kfld                    vvarl1_vare
c                   endsr
```

- The `*inzsr` subroutine is run at program start.
- It defines a key list (`klist`) called `vvarl1_key` with two fields (company and item number) for use in keyed file operations (`CHAIN`).

## Summary

- The program reads each record in the purchase statistics file.
- If the item number is present, it attempts to find the item in one of two master files.
- If found, it updates several group fields in the statistics record to match the master.
- The updated record is then written back.
- The process repeats for all records in the statistics file.

## Key Considerations for Developers

- This is a batch update/fix program, meant to synchronize product group fields in the purchase statistics file with the master data.
- The use of two item files (`vvarl1` and `vvasl1`) suggests support for multiple item master sources.
- The update is only performed if the item is found in the master.
- The program uses indicators (`*in90`, `*in91`) for record not found/end-of-file control.
- The code does not contain error logging or reportingâ€”be mindful of silent failures if no match is found.

---

**Onboarding Tip:**  
Review the structure of the `sistpfr` (purchase statistics) and `vvarl1/vvasl1` (item master) files to understand which fields are involved and ensure this update aligns with your current data model. Also, verify if there are any new group fields or item master sources to consider.