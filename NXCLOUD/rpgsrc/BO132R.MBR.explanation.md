## RPG Program BO132R – Explanation

This RPG program (BO132R) is designed to send notification emails when errors are encountered during the batch daily settlement ("dagsoppgjør") process. Below is a breakdown of each major section, what it does, and how it fits into the overall workflow.

---

### Header Specifications

```rpg
h datedit(*dmy)
h option(*nodebugio)
```
- `datedit(*dmy)`: Specifies date editing as day/month/year.
- `option(*nodebugio)`: Disables certain runtime checks to optimize performance.

---

### Program Documentation

The extensive header comments describe:
- Purpose: To notify about errors in the daily settlement batch process.
- Change logs with dates, release versions, sign-offs, and descriptions.

---

### Data Structures and Field Definitions

#### Local Data Area (LDA) Mappings

```rpg
d lda            uds
d l_prtf                800    809
d l_chgv                844    844
d l_user                911    920
d l_filg                931    933
d l_firm                944    946  0
d l_fnav                951    980
```
- `lda uds`: Declares the Local Data Area.
- The subsequent fields map specific byte positions of LDA to named variables (e.g., `l_prtf`, `l_firm`, etc.), representing configuration or control data passed into the program.

#### Working Variables

```rpg
d w_firm          s                   like(l_firm)
d w_info_mail     s            100
d w_send          s             50
```
- `w_firm`: A working variable with the same type as `l_firm`.
- `w_info_mail`: For storing the recipient’s email address.
- `w_send`: For storing the sender's email address.

#### Message Template Variables

```rpg
d p_rec1          s             50    inz(' ')
d p_rec2          s             50    inz(' ')
d p_rec3          s             50    inz(' ')
d p_send          s             50    inz(' ')
d p_subj          s            100    inz(' ')
d p_txt1          s            100    inz(' ')
d p_txt2          s            100    inz(' ')
d p_txt3          s            100    inz(' ')
d p_txt4          s            100    inz(' ')
d p_avsl          s            100    inz(' ')
d p_wkod          s              2  0
```
- Used for forming the subject, body, and other fields of the notification email.
- `p_wkod`: Holds the incoming "code" that determines the nature of the message.

---

### Main Program Logic

#### Condition for Sending Mail

```rpg
c                   if        %trim(w_info_mail) <> *blanks and
c                             %trim(w_send) <> *blanks
```
- Proceeds only if both recipient (`w_info_mail`) and sender (`w_send`) are populated.

#### Message Preparation

- Initializes all message template variables.
- Sets up email subject and base message (`p_subj`, `p_txt1` ...).
- Decides the main text (`p_txt1`) according to the value of `p_wkod`, e.g.:
  - `1`: Previous job not finished.
  - `2`: No records for update.
  - `3`: Routine in use.
  - `4`: Error in transactions.
  - `5`: No records.
  - `9`: Access/parameter problem.
  - `99`: Job OK, posted.

Examples:
```rpg
c                   if        p_wkod = 2
c                   eval      p_txt1 = 'Ingen poster til oppdatering i reg+
c                                      nskap'
c                   endif
```

#### Sending the Email

```rpg
c                   call      'AF726R'
c                   parm                    p_rec1
c                   parm                    p_rec2
c                   parm                    p_rec3
c                   parm                    p_send
c                   parm                    p_subj
c                   parm                    p_txt1
c                   parm                    p_txt2
c                   parm                    p_txt3
c                   parm                    p_txt4
c                   parm                    p_avsl
```
- Calls external program `AF726R`, presumably responsible for constructing an XML message and sending the email, passing all relevant parameters.

---

### Program Shutdown

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Marks the logical end.
- Sets `*INLR` to *ON, closing files and cleaning up.
- Returns from the program.

---

### Initialization Subroutine (`*INZSR`)

#### Entry Parameters

```rpg
c     *entry        plist
c                   parm                    p_wkod
```
- Accepts `p_wkod` parameter at program start to determine what happened in the batch process.

#### LDA Initialization

```rpg
c     *dtaara       define    *lda          lda
```
- Loads the LDA into `lda` structure for use in the program.

#### SQL Queries for Email Addresses

```sql
exec sql
 select afudss
 into   :w_info_mail
 from   afpspf
 where  afufil = :l_filg and
        afuide = 'DAGSO_INFO';

exec sql
 select afudss
 into   :w_send
 from   afpspf
 where  afufil = :l_filg and
        afuide = 'NOMAIL';
```
- Looks up recipient (`DAGSO_INFO`) and sender (`NOMAIL`) email addresses from the `afpspf` file, filtering by company/file (`l_filg`).

---

## Summary

This program is a utility for sending error or status notifications as emails during daily batch settlement. It:
- Loads configuration from the LDA.
- Determines the message type from an input code and templates.
- Looks up email addresses via SQL.
- Calls another program to actually send the email.
- Is well-commented and structured for maintenance and updates.

**Key points for onboarding:**
- The program is data-driven (via parameters and LDA).
- Email logic is generic; only the reason code (`p_wkod`) drives the message content.
- Email sending is delegated to `AF726R`.
- Email addresses are configurable at the database/file level.