# RPG Program Explanation (ASLAGR - HK701R)

## Overview

This ILE RPG program (`HK701R`) is designed to produce a file for hand-held terminals by processing customer data and generating a new file (`METO`) containing selected customer information. The main purpose is to build a register for external scanning of the customer register, based on selected category parameters.

---

## File Declarations

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
fhbkupf    o  a e           k disk    rename(hbkupfr:hbkupfr)
```
- **rkunl1**: Input file (customer master), renamed from `rkunpfr` record format to `rkunl1r`.
- **hbkupf**: Output file (scanning register), renamed from `hbkupfr`.

---

## Data Structures

```rpg
d                 ds
d d_krec                        37
d  d_kund                        6  0 overlay(d_krec)
d  d_navn                       30    overlay(d_krec:7)
d  d_kode                        1    overlay(d_krec:37)
```
- `d_krec`: 37-byte data structure containing the entire record for output.
    - `d_kund`: Customer number (first 6 digits).
    - `d_navn`: Customer name (from 7th to 36th byte).
    - `d_kode`: 1 character code, at byte 37.

---

## Parameter Definitions

Parameters passed to the program:

```rpg
d p_firm          s                   like(rkfirm)
d p_kat1          s              2
d p_kat2          s              2
d p_kat3          s              2
d p_kat4          s              2
d p_kat5          s              2
```
- `p_firm`: Company/Firm code.
- `p_kat1` .. `p_kat5`: Category codes for filtering.

---

## Working Variables

```rpg
d rkunl1_kund     s                   like(rkkund)
d w_firm          s                   like(rkfirm)
d w_kata          s              2
```
- `rkunl1_kund`: Current key value for customers.
- `w_firm`: Working copy of firm code.
- `w_kata`: Working copy of the category.

---

## Mainline Logic

### 1. Parameter Validation

```rpg
* Tester om noen kategori er valgt
c                   if        p_kat1 = *blank and
c                             p_kat2 = *blank and
c                             p_kat3 = *blank and
c                             p_kat4 = *blank and
c                             p_kat5 = *blank
c                   goto      end_pgm
c                   endif
```
- Checks if all category parameters are blank; if so, the program ends immediately.

---

### 2. Read and Filter Customers

```rpg
c                   eval      rkunl1_kund = 0
c     rkunl1_key    setll     rkunl1
c                   read      rkunl1                                 90
c                   dow       *in90 = *off
```
- Sets customer key to 0 and positions to the beginning of the input file. Reads the first record.
- Loop through all records until EOF (`*in90 = *on`).

#### For Each Customer:
```rpg
c                   move      rkkatg        w_kata
c                   if        p_kat1 = 'AL' or
c                             w_kata = p_kat1 or
c                             w_kata = p_kat2 or
c                             w_kata = p_kat3 or
c                             w_kata = p_kat4 or
c                             w_kata = p_kat5
c                   exsr      behandling
c                   endif
```
- Loads customer category (`rkkatg`) into `w_kata`.
- If `p_kat1` is `'AL'` ("all") or the customer's category matches any of the supplied categories, calls the `behandling` subroutine to process the record.

---

### 3. End Program

```rpg
c     end_pgm       tag
c                   eval      *inlr = *on
c                   return
```
- Ends the program, sets last record indicator, returns to caller.

---

## Subroutine: behandling (Process Customer)

```rpg
c     behandling    begsr
c                   clear                   hbkupfr
c                   eval      d_kund = rkkund
c                   eval      d_navn = rknavn
c                   eval      d_kode = '*'
c                   eval      hkinfo = d_krec
c                   write     hbkupfr
c     end_behandl   endsr
```
- Clears output file buffer.
- Sets up the output record:
    - Assigns customer number and name.
    - Sets category code to `'*'`.
- Assigns the full structure to the output field `hkinfo` (expected to map to the external format).
- Writes the record to `hbkupf`.

---

## Subroutine: *inzsr (Initialization)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_kat1
c                   parm                    p_kat2
c                   parm                    p_kat3
c                   parm                    p_kat4
c                   parm                    p_kat5
c     rkunl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rkunl1_kund
c                   eval      w_firm = p_firm
c                   endsr
```
- Defines the entry parameter list.
- Builds the key list for customer file access, using the firm and customer number.
- Assigns the firm code parameter to the working variable.

---

## Summary

- The program reads customer records from an input file based on firm and category.
- Filters customers by up to 5 categories (or all, if `AL`).
- For each match, writes a formatted customer info record to an output file for hand-held terminal use.
- Control is parameter-driven, so calling programs can specify firm and category values.
- All record and field names are in Norwegian, but logic is standard for RPG customer export routines.