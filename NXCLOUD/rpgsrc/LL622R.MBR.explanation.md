# RPG Program Overview

This is an RPG/400 (ILE RPG) program for IBM iSeries (AS/400) platforms. Its primary function is to read warehouse inventory records, filter and process them according to a set of parameters, and write qualified data to a work/output file for further use, such as generating inventory movement reports.

## Program Purpose

- **Program Name**: `LL622R`
- **Description**: Selection (Utplukk) from inventory register for item movement listing (varebevegelsesliste).
- **Functionality**: The program processes inventory records, applies multiple business rules and parameters, calculates inventory values, fetches prices for items, and writes the results to a work file.

## File Declarations

```rpg
fvlagl1    if   e           k disk    rename(vlagpfr:vlaglur)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvogrl1    if   e           k disk    rename(vogrpfr:vogrl1r)
fvhgrl1    if   e           k disk    rename(vhgrpfr:vhgrl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
flwa1lu    o    e             disk    rename(lwa1pfr:lwa1lur)
```
- **Input Files**: Inventory, item master, and group master files, all renamed to local record formats for clarity.
- **Output File**: Work/output file for selected/processed records.

## Data Structures

### Parameter Record

```rpg
d                 ds
d d_prec                       128
d  d_fvar                        8  0 overlay(d_prec)
d  d_tvar                        8  0 overlay(d_prec:9)
...
d  d_sort                        1  0 overlay(d_prec:51)
```
- `d_prec` holds the entire parameter list.
- Other fields overlay onto `d_prec` to access individual parameters (e.g., from-varenr, to-varenr, from-lager, to-lager, sort sequence, etc).

### Work Key and Group Data Structures

- **Keys for output file sorting** (`d_mkey`).
- **Group fields** for handling over-, main-, and subgroup (f_vgrp, t_vgrp, v_vgrp).

### Program Working Variables

- Variables for working with item, firm, date, prices, etc.
- Used for calling price routines, filtering logic, etc.

## Main Processing Flow

### 1. Initialization (`*inzsr`)

- Loads parameter values from the entry parameter data structure.
- Sets up keys for chained database access.
- Reads parameter values for "from"/"to" filters (item number, storage, groups).
- Sets up the initial position on the inventory file using `setll`.

### 2. Inventory Record Processing Loop

Labelled as `les_lager`, this is the main processing loop:
- **Reads next inventory record**.
- Skips to program-end if EOF.
- Filters out records based on:
  - Firm number (`vlfirm` vs `l_firm`)
  - Item number outside the requested range (`d_fvar` to `d_tvar`)
  - Storage location outside the requested range (`d_flag` to `d_tlag`)
  - Non-existing item in the item master
  - Group codes outside the parameterized range (over-, main-, subgroups)
  - Inventory management flags at group and item level
  - Supplier (if filtered)
  - Case handler (if filtered)
  - Only inventory item type 'L' (lager)
  - Number of movements (antall bevegelser) thresholds
- **Sorting Key Building**: Dynamically builds key based on requested sort order (by item or by storage).
- **Price Fetching**:
  - Calls a subroutine (`hent_prisgr`) to obtain the "prisgruppe" (price group).
  - Calls another program (`VP730R`) to obtain prices for the item.
- **Calculates Inventory Values**: Extended price, cost, etc.
- **Writes Qualified Record** to the output work file.
- Loops to next inventory record.

### 3. Subroutines

#### `*inzsr`
- Initialization from entry parameter, builds group filters, sets up file positions.

#### `hent_prisgr`
- Calls another program (`VL712R`) to determine the price group for the item/store.

## Indicator Usage

- LR — last record (program end)
- 31–59 — warnings/message flags
- 70–89 — working indicators for subroutines/generics
- 90–99 — file status indicators (chain/read)

## Calls to External Programs

- **VL712R** — fetches price group for the current item/store.
- **VP730R** — fetches sales, gross, cost, and input prices for the current item.

## Business Rules & Filters Implemented

- Firm, item number, storage location, and item existence checks.
- Item group filtering using overgroup, maingroup, subgroup.
- Checks if a group/item should be inventory managed (lagerstyrt).
- Optional supplier and case handler filters.
- Optionally restricts by item movement count (bevegelser).
- Only considers inventory-managed items (`vlvtyp = 'L'`).
- Sorts output as requested.
- Calculates and writes output records fully detailed for further reporting.

## Comments and History

The program is well-commented, with a history of changes annotated (version, date, description, and initials).

---

### Onboarding Summary

- **Entry**: Program receives a packed parameter structure for all filter/sort settings.
- **Process**: Scans the inventory file, filtering using parameters and joined master/group files, and fetches prices/values.
- **Output**: Qualified inventory records with prices and values, written to a work file according to sort order.

**Tip:** When maintaining or extending, pay attention to the overlayed data structures for parameters, and to the meaning of numeric indicators for file I/O.

---

**If you have questions about specific sections, ask for a focused explanation!**