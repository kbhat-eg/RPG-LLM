```markdown
# RPG Source Code Explanation

## Program Overview

This RPG (Report Program Generator) program is designed to read customer and transaction lines from files (notably `FOVF`) and export or convert this data into a comma-separated format (CSV), typically for use with external business systems such as Visma Business or XLedger. The logic is company-specific and processes customer information records, outputting them in a structured, delimited fashion.

---

## Header Section

```rpg
     h option(*nodebugio) datedit(*dmy)
     h decedit('0.')
```
- **`option(*nodebugio)`**: Disables debug I/O, meaning the program can't be debugged interactively.
- **`datedit(*dmy)`**: Sets the default date format to day/month/year.
- **`decedit('0.')`**: Decimal editing; decimal separator is a dot.

### Documentation Block

A block of comments follows, providing:
- Program and system information.
- Description and version history (with dates and initials).
- Notes on functionality changes for various business needs.

---

## File Declarations

```rpg
ffovfl1    if   e           k disk
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frb10l1    if   e           k disk    rename(rb10pfr:rb10l1r)
frvk1pf    o    e           k disk
```
- **Input Files**:
  - `fovfl1`: Main input file, probably transaction lines.
  - `rkunl1`: Customer master file (renamed record format).
  - `rb10l1`: Additional company data (record format renamed).
- **Output File**:
  - `rvk1pf`: The output file for the CSV/exported data.

---

## Data Definitions

```rpg
d l_firm                944    946  0
d w_kund          s                   like(rkkund)
d w_biln          s                   like(ffbiln)
d w_firm          s                   like(fffirm)
d rkunl1_kund     s                   like(rkkund)
d tell            s              1  0
d w_rkftnr        s              9
```
- `l_firm`: Local data area (LDA) - used as a source for company number.
- Working variables for customer number, document number, company, and more.
- `tell`: Simple counter to track first processing (outputs headers).
- `w_rkftnr`: Workfield for organizational number handling.

---

## Main Program Logic

### Initialization

```rpg
c     eval      w_firm = l_firm
```
- Sets the working company (`w_firm`) from the local data area.

### Customer Lookup Key List

```rpg
c     rkunl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rkunl1_kund
```
- Defines a composite key for looking up the customer in `rkunl1`.

### Main Input Loop

```rpg
c     nyles         tag
c                   read      fovfl1                                 60
c                   if        *in60 = '1'
c                   goto      slutt
c                   endif
```
- Reads the next transaction line (`fovfl1`).
- If the end of file is reached (`*in60`), exit the loop (`slutt`).

### Company Filter

```rpg
c                   if        l_firm <> fffirm
c                   goto      nyles
c                   endif
```
- Skips records if the record's company does not match `l_firm` (company-specific data processing).

### Output Header Section (First Pass)

```rpg
c                   if        tell   = 0
c                   add       1             tell
c                   eval      rvdata = *blank
c                   write     rvk1pfr
c                   eval      rvdata = %trim('@IMPORT_METHOD(1)')
c                   write     rvk1pfr
c                   eval      rvdata = %trim('@ActoR(=CustNO,') +
                                            ('Nm,Shrt,Ad1,Ad2,') +
                                            ('PNo,PArea,Phone,') +
                                            ('PrivPh,Fax,') +
                                            ('InvoCust,FactNo,') +
                                            ('Org.no,email)')
c                   write     rvk1pfr
c                   eval      w_biln = ffbiln
c                   endif
```
- On the first transaction line processed, writes special header or control records to the output for import processing.
- First line blank, then an import method line, then a field list.
- Stores the first voucher number (`w_biln`).

### Process Customer Line

```rpg
c                   exsr      finnadr
c                   goto      nyles
```
- Calls the subroutine `finnadr` to fetch customer details and output the data record.
- Loops back for next record.

---

## End-of-Job Section

```rpg
c     slutt         tag
c                   eval      rvdata = *blank
c                   write     rvk1pfr
c                   eval      rvdata = *blank
c                   read      rb10l1                                 90
c                   eval      *inlr = *on
```
- Writes a blank line at the end.
- (Commented out) logic for writing a '@FIRM_END' control line (company end marker).
- Sets LR (last record) for program termination.

---

## Subroutine: `finnadr`

This subroutine fetches customer data from the customer file and assembles the output line.

### Key logic:

- **Customer selection**: Uses `ffckto` if nonzero, else `ffdkto` for "customer number."
- **Customer lookup**: Performs a keyed chain to `rkunl1` for customer master info.
- **Post address handling**: If post place (`rksted`) starts with four digits, trims these digits (business-specific requirement).
- **Org number cleaning**: If organization number is `0`, set to blanks; else, use it.
- **Output data assembly**: If customer was found, builds the export line by concatenating all the required fields, separated by semicolons (`;`). Output fields are:
    - Customer number
    - Name
    - Short name
    - Address 1
    - Address 2
    - Postal number
    - Postal area
    - Mobile phone
    - Private phone
    - Fax
    - Invoice customer
    - Factoring number
    - Organization number (or blank)
    - Email address

```rpg
c                   if        ffckto <> 0
c                   eval      w_kund = ffckto
c                   else
c                   eval      w_kund = ffdkto
c                   endif

c                   eval      rkunl1_kund = w_kund
c     rkunl1_key    chain     rkunl1                             90

c                   if            %subst(rksted:1:1) >= '0'
                                ...
c                   eval      rksted = %subst(rksted:6:25)
c                   endif

c                   if        rkftnr = 0
c                   movel     *blanks       w_rkftnr
c                   else
c                   movel     rkftnr        w_rkftnr
c                   endif

c                   if        *in90 = *off
c                   eval      rvdata = %char(w_kund)     + ';' +
                                        %trim(rknavn)     + ';' +
                                        %trim(rkalfa)     + ';' +
                                        %trim(rkgate)     + ';' +
                                        %trim(rkadr2)     + ';' +
                                        %char(rkponr)     + ';' +
                                        %trim(rksted)     + ';' +
                                        %trim(rkmobn)     + ';' +
                                        %trim(rktlfn)     + ';' +
                                        %trim(rktlfx)     + ';' +
                                        %char(rkfaku)     + ';' +
                                        %char(rkfacn)     + ';' +
                                        %trim(w_rkftnr)     + ';' +
                                        %trim(rkemal)
c                   write     rvk1pfr
c                   endif
```

---

## Business & Version-Specific Logic

- The comments and code reflect business rule changes over time (fields added, formatting changes, etc.).
- For example, organization number is suppressed (set to blank) if it's '0', reflecting a specific export format requirement.

---

## Summary

- **Reads**: Transaction lines and customer master info.
- **Filters**: By company.
- **Outputs**: CSV-like records, plus header and control records, suitable for import to accounting or ERP systems.
- **Business Logic**: Handles customer lookups, field formatting, conditional field population, and field suppression based on business rules.

---

## Key Takeaways for New Developers

- This program is highly tailored to a specific customer information export/import process, with multiple control and data records.
- Main file processing loop reads records, filters by company, and writes out either special headers or customer data lines via a dedicated subroutine.
- Modifications and enhancements are tracked in comments with version numbers, initials, and dates.
- The code uses classic fixed-format RPG, so modern RPG(LE) syntax could be considered for new development.

If you start working with this code, focus on:
- The mapping between input fields and output fields.
- The role of the `finnadr` subroutine in formatting the exported data.
- The use of output headers and control lines for whatever system consumes this export.
```