## Program Overview

This program is part of the SAFT reporting rollout (see change log: NXS-4426, version K00). It processes VAT/moms codes for all companies ("firmaer") in the system. The main function is to synchronize and update records between three logical files built over the same physical file (`ra05pfr`), each with a different record format and purpose. The program ensures that for each VAT code in the source, a corresponding and up-to-date record exists in the target, updating or creating as necessary, while handling conflicts and prompting the user for confirmation.

### File Definitions and Relationships

- **Physical File:** `ra05pfr` (to be overridden to `ra05ps` per the comment)
- **Logical Files:**
    - `ra05l1` (record format: `ra05l1r`, prefix F)
    - `ra05pf` (record format: `ra05pfr`, prefix S)
    - `ra05lu` (record format: `ra05lur`)
- All logical files are keyed and have different record formats over the same physical file.
- The program reads from `ra05l1` (list of companies), iterates over `ra05pf` (VAT code records per company), and updates or writes to `ra05lu` (the lookup/update target).

### High-Level Flow

1. **Initialization:** Key lists for each file are defined in the *INZSR subroutine.
2. **Main Loop:** For each company in `ra05l1`, process all VAT codes in `ra05pf` for that company using the `BehFirm` subroutine.
3. **Processing per Company:**
    - For each VAT code in `ra05pf`:
        - Try to find an existing record in `ra05lu`.
        - If found, compare significant fields. If differences exist, prompt the user (via `AX018R` program) whether to update.
        - If not found, write a new record to `ra05lu`.
4. **Conflict Handling:** If a code exists with different data, a message is constructed and the user is prompted. Depending on the response, the program may update the record, skip, or terminate.
5. **Termination:** The program sets *INLR and returns.

---

## Business/Domain Logic

- **Company Context:** All processing is company-specific, using the company number (`firma`) as a key.
- **VAT Code Synchronization:** The main business rule is to ensure that for every VAT code in the source (`ra05pf`), the target (`ra05lu`) is updated/inserted to match, unless the user explicitly declines.
- **User Interaction:** On conflict, a message is constructed and the external program `AX018R` is called to prompt the user. The user's response (`w_sv`) determines whether to proceed with the update.

---

## Detailed Code Structure

### File Prefixes

- `F:` (`fae*`) — fields from `ra05l1`
- `S:` (`sae*`) — fields from `ra05pf`
- Unprefixed — fields from `ra05lu` (target/update file)

### Key Variables

- `ra05l1_fir`, `ra05l1_kod` — keys for company and code in `ra05l1`
- `ra05pf_fir`, `ra05pf_kod` — keys for company and code in `ra05pf`
- `ra05lu_fir`, `ra05lu_kod` — keys for company and code in `ra05lu`

### Main Processing Loop

- Iterates through all companies in `ra05l1`.
- For each company, calls `BehFirm` to process all VAT codes for that company.
- After processing one company, skips to the next unique company in `ra05l1`.

### `BehFirm` Subroutine

- Iterates over all VAT codes in `ra05pf` for the current company.
- For each code:
    - Attempts to locate a corresponding record in `ra05lu`.
    - If found and fields differ, calls `feilmsg` to prompt the user.
        - If the user aborts (`w_in12 = 1`), ends program.
        - If the user agrees (`w_sv = 'J'`), updates the record in `ra05lu`.
        - Otherwise, skips updating.
    - If not found, writes a new record to `ra05lu`.

### `feilmsg` Subroutine

- Constructs user-friendly messages (`w_m1`, `w_m2`) describing the conflict, inserting actual code, company, and percentage values.
- Calls external program `AX018R` to display the message and collect user response.
- The user response is returned in `w_sv` (Yes/No) and `w_in12` (indicator for abort).

### Key Lists

- Key lists (`klist`) are defined for all three logical files, pairing company and code.

---

## Notable Design Decisions & Conventions

- **Single Physical File, Multiple Logical Views:** All data is read and written via logical files over the same physical file, each with its own record format. This allows for different perspectives and processing rules on the same underlying data.
- **User Prompt via External Program:** Rather than handling user interaction inline, the program delegates to `AX018R` for messaging and input, centralizing user interaction logic.
- **Manual Data Movement:** Fields are moved individually between source and target records. This is explicit but verbose, and ensures only relevant fields are updated.
- **Field Comparison:** Only a subset of fields are compared for differences (`raepro`, `raemda`, etc.), reflecting business-critical data that must match.
- **Exit on User Abort:** If the user chooses to abort (`w_in12 = 1`), the program terminates immediately.

---

## Interactions with Other Modules

- **AX018R:** External program called to display messages and collect user input. It receives the constructed message strings and returns user choices.
- **File Override Requirement:** The physical file `ra05pfr` must be overridden to `ra05ps` before running this program, as per the business standard.

---

## Error Handling and Messaging

- When a VAT code is found with differing details, the program constructs a detailed message (in Norwegian) indicating the code, company, VAT percentage, and behavior code, and asks the user if they wish to proceed and update the record.
- The user's response directly determines whether the record is updated, skipped, or if the program terminates.

---

## Summary

This program is a batch utility for maintaining VAT code consistency across companies. It reads all companies and their VAT codes, ensures the target file is up to date, and handles conflicts interactively with the user. It is designed for robustness and explicit user control in the event of data discrepancies, with clear separation of data access (via logical files), business logic, and user interaction. All business logic is tightly coupled to the structure and semantics of the `ra05pfr` file and its logical derivatives.