# Program Overview

This is an IBM ILE RPG (Report Program Generator) program, named `ND103R`, intended to display order lines by reference on an IBM i (AS/400) system. The code is well-commented in Norwegian, indicating the program's structure, indicator usage, and subfile logic. Subfiles are a common technique in RPG for working with paged lists of data on the display.

## Code Structure

### File Declarations

- **Physical Files Input/Output**  
  ```
  fnohel1    if   e           k disk    rename(nohepfr:nohel1r)
  fnkeolr    if   e           k disk    rename(nkeopfr:nkeolrr)
  feddtlr    if   e           k disk    rename(eddtpfr:eddtlrr)
  frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
  ```
  Four database files are input-defined, each with external descriptions and renamed record formats for clarity.

- **Display File and INFDS**  
  ```
  fnd103d    cf   e             workstn sfile(b1sfl:w_srrn)
  f                                     infds(dspfbk)
  ```
  A display file is declared with a subfile (`b1sfl`) and an information data structure (`dspfbk`) to access display properties, e.g., cursor position.

---

### Data and Indicators

- **Parameters**  
  ```
  d p_firm   s   like(edfirm)
  ...
  ```
  Parameters for company, order reference, etc., are defined.

- **Local Data Area**  
  ```
  d uds
  d l_user   911    920
  d l_fnav   951    980
  ```
  Fields mapped to user and navigation data from the local data area (LDA).

- **Indicator Usage**  
  The comments detail indicator usage, e.g.,  
  - `LR`: program end
  - `10-15`: subfile control (roll, clear, end, etc.)
  - `21-22`: cursor placement
  - `30`: field protection
  - `31-99`: errors, work indicators

---

### Key Variables

- Variables tracking subfile state:
  - `w_fcrn`: First record number on the page
  - `w_srrn`: Current record number in subfile
  - `w_sfrn`: First record number on last page
  - `w_ssrn`: Last record number on last page
  - `w_spge`: Page size in subfile
  These are used for paging and controlling which records are shown.

---

### Main Logic

#### Main Loop, Function-Keys and Subfile Handling

The core logic is a **subfile loop** with function key handling:

```rpg
c     b2taga        tag
c                   write     b2cmd
...
c     b2tagb        tag
c                   exsr      dsp_subfile
...
c                   select
c                   when      *inkc or *inkl     // F3=Exit, F12=Cancel
c                   goto      avslutt
c                   when      *inke              // F5=Refresh
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10              // Page down
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   when      *in11              // Page up
c                   exsr      bck_subfile
c                   goto      b2tagb
c                   when      *in21              // Home
c                   eval      *in22 = *on
c                   goto      b2taga
c                   endsl
...
c                   if        b2line <> 0
c                   exsr      posisjoner
c                   goto      b2tagb
c                   endif
...
c                   exsr      subfile
...
c                   goto      b2taga
```

**Explanation**:  
- The program loops, displaying a subfile and reacting to function keys:
  - **F3/F12**: Exit program  
  - **F5**: Refresh subfile  
  - **Page up/down**: Scroll subfile  
  - **Home**: Move cursor to top  
  - If a positioning field is entered (`b2line`), the program repositions the subfile.

---

### Subroutines

#### Subfile Handling

- **forny**: Refreshes the subfile (reloads records and resets its view).
- **posisjoner**: Positions to a certain record in the subfile, e.g., based on a line number.
- **subfile**: Handles processing of subfile records, e.g., acts on user-selected records.
- **clr_subfile**: Clears (removes) the subfile contents.
- **crt_subfile**: Fills the subfile with the next page of data.
- **bck_subfile**: Scrolls backward one page in the subfile.
- **dsp_subfile**: Displays the subfile using `exfmt b2ctl` (formatting and waiting for user input).

#### Initialization

- **\*inzsr**: The RPG program's initial subroutine, reading input parameters, building key lists, referencing company/order, and immediately populating the subfile.

---

### Keylists

Multiple `klist` (key lists) are defined and used with `chain`, `setll`, `reade`, etc. to position and retrieve records from the files, e.g., getting additional details about an order or customer.

---

### Subfile Paging

- The logic for subfile paging is handled with counters and control indicators. For example, on page up/down, `crt_subfile` and `bck_subfile` are called, which fill in the next/previous page of records.
- The relevant fields (`w_srrn`, `w_spge`, etc.) maintain the paging state.
- **clr_subfile** writes the control record with `*in14` (SFLCLR).
- **crt_subfile** loads records into the subfile, updating indicators and counters, and sets `*in15` (SFLEND) when there's no more data.

---

### Data Movement

- Data is moved between database fields and screen fields before writing to the subfile, ensuring the correct data appears in the subfile record format.

---

### Special Logic and Comments

- The program contains some commented-out code where additional logic could be implemented (e.g., "pick line" logic when an order line is selected).
- NA (Not active) code blocks exist for enhanced functionality; currently, these are disabled.

---

## Takeaways for Developers

- **Subfile Programming**: This program is a classic example of subfile paging and selection in traditional green-screen RPG.
- **Indicators**: Custom and standard indicators (`*INnn`) govern screen behavior, error display, and navigation.
- **Keylists and Record Level Access**: Data retrieval is driven by well-structured key lists for efficient access.
- **Modular Subroutines**: Each logical action (refresh, clear, display, page up/down) is isolated in a subroutine, easing maintenance.
- **Parameter-Driven**: The main logic is flexible, using program parameters for order selection, making it reusable for various order queries.

---

## Onboarding Checklist

- **Understand subfile mechanics** (especially RPG III/IV style)
- **Learn indicator usage** as patterns are common in RPG user interfaces
- **Familiarize yourself with the database layouts** (`nohel1`, `nkeolr`, `eddtlr`, `rlevl1`)
- **Know how/where to add business logic:** e.g., what to do when a line is selected in subfile processing

---

## Further Reading

- IBM RPG Reference for subfiles, indicators, and file operations.
- Tutorial on paging with subfiles in RPG, focusing on handling `SFLCLR`, `SFLEND`, and `SFLDSPCTL`.

---

**Summary:**  
This is a traditional RPG subfile-based interactive program for displaying and paging through order lines, with robust support for user navigation and dynamic data loading, following IBM best practices for green-screen applications. The code is well-structured and commented, making maintenance and enhancement approachable.