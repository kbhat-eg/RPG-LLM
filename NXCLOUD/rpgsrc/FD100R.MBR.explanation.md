# Documentation: FD100R – Order Line Registration for Offers/Orders

## Overview

**FD100R** is a central program in our order management system, responsible for registration, maintenance, and inquiry of order lines, both for offers (quotes) and customer orders. It is a complex, highly evolved application supporting a wide range of business processes, including product validation, pricing, logistics, credit control, deposit handling, and integration with external systems (e.g., warehouse, transport, and reporting modules).

This program is heavily parameterized and configurable, supporting numerous business rules, customer- and product-specific logic, and process variations. It is designed to be robust and flexible, handling both interactive and batch scenarios, and is the main interface for users working with order lines at the point of sale, customer service, or back office.

## Main Business Functions

- **Order Line Registration:** Adding, editing, deleting, and viewing order lines for offers and orders.
- **Product Validation:** Identifies products via multiple keys (internal, supplier, EAN, logistics numbers), supports advanced search and validation logic.
- **Pricing and Discount Calculation:** Handles complex pricing, discount, and bonus schemes, including integration with external pricing modules.
- **Stock and Logistics Management:** Integrates with inventory to update stock levels, validate availability, and manage logistics-specific product handling.
- **Credit and Deposit Control:** Enforces customer credit limits, calculates and manages required deposits, and blocks further processing if limits are exceeded.
- **Document Generation:** Supports printing, previewing, and emailing order confirmations, picking lists, price confirmations, and transport labels.
- **Integration with External Systems:** Calls numerous external programs for specialized tasks (e.g., warehouse updates, bonus calculation, reporting, SMS/email sending, etc.).
- **Configurable Business Logic:** Many features are controlled by switches and parameters, allowing firm-specific and context-specific behavior.

## Key Design Patterns and Conventions

- **Versioned Enhancements:** The code contains a detailed change log, with enhancements tracked by version and author. Conditional logic is often guarded by version-specific switches.
- **Parameterization:** Business rules, process flows, and UI behavior are controlled by parameters, switches, and configuration files, read at startup or dynamically.
- **External Program Calls:** Many specialized operations (pricing, logistics, printing, etc.) are delegated to other programs, supporting modularity and separation of concerns.
- **Subfile Processing:** Interactive screens use subfiles to display and manage multiple order lines efficiently.
- **Data Validation and Error Handling:** All user actions are validated, with informative error and warning messages presented to guide the user and enforce business rules.
- **SQL Integration:** For certain lookups and updates (especially logistics and product master data), embedded SQL is used for efficiency and flexibility.
- **UI Adaptation:** The program adapts to different user roles, permissions, and process contexts, including special handling for Newlook UI quirks.

## Major Data Relationships

- **Order Header (fohel1/fohelur):** The order line processing is always in the context of a specific order header, which supplies key customer, status, and process information.
- **Order Lines (fodtl1/fodtlur/fodtlrr):** The main focus of the program, with extensive logic for validation, registration, updating, and deletion.
- **Product Master (vvarl1/vvarl4, jvarl1):** Product validation and enrichment, including handling of supplier numbers, EANs, and logistics variants.
- **Customer Master (rkunl1, rkmel1):** Used for credit control, discount logic, and contact info.
- **Deposit Management (sdepl1, sdeplur, sdeplrr):** Specialized handling of required/prepaid deposits per order.
- **Bonus and Discount (EK750R, EK760R):** External programs for bonus eligibility and calculation.
- **Logistics Files (vlagl1, jlevl3, jvlel1, ra17l1):** Used for advanced logistics/transport handling and availability checks.
- **Auxiliary Tables:** Numerous other files for statuses, user permissions, order types, line types, etc.

## Main Program Structure

### Initialization (`*inzsr`)
- Reads parameters and configuration switches (via `CO402R` and others).
- Sets up keys for all major files and initializes UI flags and business logic switches.
- Loads user permissions and firm-specific validation rules.

### Main Processing Loop
- **Opening:** Checks for deleted items on the order and prompts if present.
- **Subfile Setup:** Loads order lines into the subfile for display and interaction.
- **Order Data Fetch:** Retrieves order header and customer data, including credit and deposit status.
- **Bonus Check:** Determines if the order qualifies for customer bonus schemes.

### User Interaction (Main Screen)
- **Function Key Handling:** Responds to a wide range of function keys (F1–F23), each mapped to specific business actions (e.g., add/edit/delete line, print, email, set to picking, etc.).
- **Order Line Actions:** Supports adding, editing, deleting, and viewing order lines, with full validation and integration with pricing, logistics, and credit modules.
- **Subfile Navigation:** Allows paging and searching within the subfile, including free-text search and advanced filtering.
- **Special Actions:** Includes special flows for deposit management, customer switching, logistics handling, and more.

### Subroutines

#### Registration and Validation
- **`registrer`/`reg_vare`/`tekstlinje`:** Core routines for registering new order lines, including product validation, price calculation, and deposit enforcement.
- **`ident_vare`:** Advanced logic for identifying products by various keys, including supplier number, EAN, and logistics variants.
- **`endre_linje`, `slett_linje`, `vis_linje`:** Edit, delete, and view routines, with full business rule enforcement (e.g., deposit paid lines cannot be changed).

#### Credit and Deposit Control
- **`sjekk_kunde`:** Enforces customer credit limits, triggers warnings and blocks as appropriate.
- **`xs1win`, `sjk_depo`:** Handles deposit calculation and validation, including recalculation if order value changes.
- **`sjekk_almrab`, `sjekk_rabatt`, `sjekk_bonus`:** Additional logic for general discount, bonus, and rebate control.

#### Logistics and Stock
- **`oppdat_lager`:** Updates warehouse stock levels when order lines are added, changed, or deleted.
- **`sjekk_farge`, `finn_logivar`:** Determines color coding for lines based on logistics/product status (e.g., out of stock, special order).
- **`ex_add_tral`:** Adds automatic transport lines if required by logistics rules.

#### Document and Communication Handling
- **`ex_print`, `ex_preview`, `ex_email`:** Handles printing, previewing, and emailing of order documents.
- **`ex_prt_kolli`, `ex_utlev`:** Prints transport labels, marks orders as delivered.
- **`send_kj_mail`:** Sends notification emails to logistics/warehouse as needed.
- **`ex_snd_SMS`:** Sends SMS notifications to customers.

#### Integration and Special Flows
- **`byggdok`:** Handles integration with the ByggDok/Cobuilder documentation system for building industry compliance.
- **`recalc_ordre`, `upd_ordrehode`:** Triggers recalculation of order totals and pricing, especially after customer or product changes.
- **`ex_bytt_kunde`:** Manages switching the customer on an order, with full validation and update of related data.
- **`ex_vis_tvare`:** Handles automatic addition of transport-related products.

#### Subfile Management
- **`clr_subfile`, `crt_subfile`, `bck_subfile`, `dsp_subfile`:** Core routines for managing the subfile display and navigation.

#### Miscellaneous
- **`newlo_vask`:** Cleanses subfile data for compatibility with the Newlook UI (removes problematic characters).
- **`sjk_modul`, `sjk_saldo`, `spr_ordre`:** Checks for required modules, validates card balances, and sets block codes as needed.

## Notable Business and Domain Logic

- **Deposit Management:** The program enforces deposit requirements on certain orders, with logic to block further processing if the deposit is unpaid or to prompt for recalculation if the order value increases.
- **Credit Block:** Orders exceeding credit limits are blocked from further processing. Special handling allows only text lines to be added/edited in this state.
- **Logistics Integration:** The program identifies logistics variants and can auto-add required transport products, with color coding for special statuses.
- **Configurable Features:** Many features (e.g., deposit enforcement, bonus display, special product handling, Newlook compatibility) are controlled by configuration switches, allowing site-specific adaptation.
- **Special Product Validation:** The system prevents certain product numbers (e.g., standard shop numbers, gift cards) from being used in specific contexts, with logic to enforce these rules based on configuration.

## Interactions with Other Modules

- **Pricing and Bonus:** Calls to `FD105R`, `EK750R`, `EK760R`, and others handle advanced pricing and customer bonus logic.
- **Warehouse/Stock:** Integration with `VL001R` and related programs ensures real-time warehouse updates.
- **Document Handling:** Printing, emailing, and previewing are handled via `QO600C` and related programs.
- **Deposit:** Deposit management is handled via specialized files and routines (`sdepl1`, `sdeplur`, etc.).
- **Logistics:** Calls to `VL718R`, `VR743R`, etc., handle logistics-specific product and transport logic.
- **External Compliance:** Integration with ByggDok/Cobuilder for construction industry documentation.
- **User Permissions:** User-specific access to pricing, editing, and special functions is enforced throughout, including via user master data.

## Key Conventions and Special Notes

- **Extensive Use of Indicators:** Many features and flows are controlled via indicator variables and special flags, often initialized from configuration at program start.
- **SQL for Advanced Lookups:** Embedded SQL is preferred for complex or performance-sensitive lookups, especially for logistics and product master data.
- **Subfile as Main UI:** The interactive user interface is built around subfiles, enabling efficient display and manipulation of multiple order lines.
- **UI Adaptation:** Special routines (e.g., `newlo_vask`) ensure compatibility with the Newlook UI, which has unique requirements.
- **Version Control in Code:** The source code is annotated with detailed version history, and many enhancements are guarded by version-specific logic.

## Summary Table: Major External Programs Called

| Program   | Purpose                                           |
|-----------|---------------------------------------------------|
| FO730R    | Recalculate order totals and pricing              |
| FO105R    | Maintain order header texts                       |
| FO106R    | Quick add of transport product                    |
| FO522R    | Display margin/contribution analysis              |
| FO600R    | Print order documents                             |
| QO600C    | Print/preview/email order documents               |
| QO736R    | Set order to picking                              |
| QO737R    | Mark order as delivered                           |
| QO500R    | Send SMS to customer                              |
| VL001R    | Update stock/warehouse                            |
| VL718R    | Get available stock as of delivery date           |
| EK750R    | Check if customer qualifies for bonus             |
| EK760R    | Calculate bonus for order line                    |
| FA922R    | Update customer memo balance                      |
| CO402R    | Read configuration switches                       |
| FS710R    | Log order line deletion                           |
| QD100R    | Sync order with purchasing                        |
| VV501R    | Product search/lookup                             |
| JV160R    | Access special product admin (skaffevareregister) |
| SF160R    | Add lines from sales statistics                   |
| RP147R    | Import budget lines from project                  |
| HENTORPC  | Import lines from Excel                           |
| AA005R    | Display messages/warnings                         |
| AA007R    | Confirmation dialog                               |
| AA031R    | NOBB/logistics warning dialog                     |
| AF726R    | Send email notification (logistics)               |

## Practical Advice for New Developers

- **Understand the Business Context:** Many routines are driven by nuanced business rules and customer-specific logic. When in doubt, consult business analysts or superusers.
- **Refer to the Change Log:** The in-code change log is extensive and can help you understand the motivation behind many enhancements or constraints.
- **Respect Configuration Switches:** Before changing any logic, check if it is already controlled by a configuration switch or parameter.
- **Be Careful with File Updates:** Many files are tightly integrated with other modules—ensure you understand the downstream impact of changes.
- **Test UI Flows Thoroughly:** The program supports a wide range of UI flows and user roles. Always test changes in all relevant contexts (credit blocked, deposit required, logistics flows, etc.).
- **Coordinate with External Program Owners:** If you need to change the interface to an external program, coordinate with the owning team, as these are often used by multiple modules.

---

**This documentation aims to provide a comprehensive understanding of FD100R's purpose, structure, and business logic for experienced RPG developers new to our system. For further details, consult the code annotations, business process documentation, and system architecture diagrams.**