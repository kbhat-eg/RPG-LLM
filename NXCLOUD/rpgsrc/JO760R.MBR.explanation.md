# RPG Program Explanation (JO760R)

## Program Overview

- **Purpose:**  
  This program retrieves an old item number (gammelt varenummer) from a file, only if the item has been transferred to EVR (indicated by a particular code in the file record).

- **Key Files:**  
  - Physical file: `jmatpfr` (renamed as `jmatl7r` for this program)
  - The file is accessed by key for record lookup.

---

## Header & Metadata

- `h option(*nodebugio) datedit(*dmy)`  
  - **option(*nodebugio):** Debug I/O is turned off for performance.
  - **datedit(*dmy):** Default date format is day-month-year.

### Comments

- The comments outline creation date, version history, and explain that the program's purpose is to return an old item number if the item has previously been transferred to EVR.

---

## File Definition

```rpg
 Fjmatl7    if   e           k disk    rename(jmatpfr:jmatl7r)
```

- Defines a keyed (k) input (i) full procedural (f) file, renamed locally from `jmatpfr` to `jmatl7r`.
- This file is read using keys for lookups.

---

## Data Definitions

### Parameters

```rpg
d p_firm          s                   like(jofirm)
d p_var2          s                   like(jovar2)
d p_var1          s                   like(jovar1)
```

- **p_firm:** Passed company code.
- **p_var2:** Passed item number (likely the current item number / LVR).
- **p_var1:** Output parameter, will hold the old item number if found.

### Working Variables

```rpg
d jmatl7_var2     s                   like(jovar2)
d w_firm          s                   like(jofirm)
```
- **jmatl7_var2:** Local variable for item number key.
- **w_firm:** Local variable for company code key.

---

## Mainline Logic

1. **Initialize Output Value**

    ```rpg
    c                   eval      p_var1 = *blank
    ```

    - By default, the output parameter is blank (no old item found).

2. **Set up Key and Perform Lookup**

    ```rpg
    c                   eval      jmatl7_var2 = p_var2
    c     jmatl7_key    chain     jmatl7                             90
    ```

    - Copy the input item number to a local variable for the file key.
    - Perform a keyed CHAIN (record lookup) on `jmatl7` using key `jmatl7_key`.
    - Indicator 90 is set if record is **not found**.

3. **Check Found Record and EVR Status**

    ```rpg
    c                   if        *in90  = *off and
    c                             jovkod = 1
    c                   eval      p_var1 = jovar1
    c                   endif
    ```

    - If indicator 90 is **off** (record found) and the field `jovkod` equals 1 (item transferred to EVR):
      - Set the output parameter to the old item number, `jovar1`.

4. **End Program**

    ```rpg
    c     avslutt       tag
    c                   eval      *inlr = *on
    c                   return
    ```

    - Standard RPG way to end a program and release resources (`*inlr = *on`).

---

## Initialization Subroutine

```rpg
c     *inzsr        begsr
```
- Runs automatically at program start.

### Parameter List

```rpg
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_var2
c                   parm                    p_var1
```
- Defines which parameters the program receives (company, item, output-item).

### Key List for Lookup

```rpg
c     jmatl7_key    klist
c                   kfld                    w_firm
c                   kfld                    jmatl7_var2
```
- Defines the key fields for the file CHAIN operation:
  - Company code
  - Item number

### Initialize Key Values

```rpg
c                   eval      w_firm = p_firm
```
- Copies the input company parameter to the local key variable.

```rpg
c                   endsr
```
- Ends the subroutine.

---

## Summary

**What does this program do?**
- Given a company and an item number, it looks up the item in a master file.
- If the item is found and has been transferred to EVR (`jovkod = 1`), it returns the old item number.
- Otherwise, it returns a blank value.

**Key Takeaways for New Developers:**
- The central logic is a keyed lookup with conditional output.
- The `chain` is only considered successful if the record is found **and** the item is transferred.
- Parameters must be passed in the specified order: firm, item2, item1 (output).
- Updating `p_var1` allows the caller to receive the result via the parameter list.

---

**Typical use case:**  
Called from another program or job to resolve an item's old number, relevant if the item has had its number changed due to an EVR transfer.