# Program Overview

This RPG program (program name: IG122R, system: ASNAVIOKO) is designed to **query transactions from NAV**. It uses subfiles to display log entries from the database and allows the user to view details or parameters for each transaction.

The program interacts with two database files:
- `IFNAIR` (renamed as IFNAIRR)
- `IFNAI2` (renamed as IFNAI2R)

The UI is built with a subfile (B1SFL) managed on a workstation display file (IG122D).

---

## Key Sections Explanation

### Header

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: Disables debugging for I/O operations for performance.
- `*DMY`: Sets date editing to Day-Month-Year.

---

### File Declarations

```rpg
fifnair    if   e           k disk    rename(ifnast:ifnairr)
fifnai2    if   e           k disk    rename(ifnast:ifnai2r)
fig122d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- Two input files: IFNAIRR and IFNAI2R, both keyed disk files.
- Displays are controlled via IG122D, with a subfile B1SFL.

---

### Data Definitions

**From the Local Data Area:**
```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- These variables are extracted from positions in the LDA, e.g., current user, firm, etc.

**Work Variables:**
```rpg
d ifnai2_odat     s                   like(ifodat)
d ifnai2_otim     s                   like(ifetim)
d ifnair_uid      s                   like(uid)
```
- Used as search keys for positioning.

**Subfile Control Variables:**
```rpg
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
d w_spge          s              4  0
d w_srrn          s              4  0
```
- Manage subfile record numbers for paging and display.

**Flags:**
```rpg
d b_forn          s              1    inz(*off)
d b_anul          s              1    inz(*off)
d b_feil          s              1    inz(*off)
```
- Boolean flags (On/Off) for various states.

---

### Constants

```rpg
d c_sfil          s              2  0 inz(14)
```
- Number of records displayed per subfile page.

---

## Main Processing Loop

The program follows a classic RPG cycle, with named tags for managing flow.

**Primary Tags:**
- `b2taga`: Display command screen.
- `b2tagb`: Show or refresh subfile.
- `avslutt`: Exit the program.

### Function Key Handling

```rpg
c                   select
c                   when      *inkc or *inkl   // F3 or F12 (Exit)
c                   goto      avslutt
c                   when      *inke            // F5 (Refresh)
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10            // F10 (Next Page)
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   endsl
```

---

## Subroutines

### forny

**Purpose:** Repositions to the beginning and rebuilds the subfile.

Steps:
- Reset search keys to lowest value.
- Reposition (`setll`) to start of IFNAI2R.
- Clear and then create subfile entries.

---

### posisjoner

**Purpose:** Jumps to a specific date in the log and refreshes the subfile.

Steps:
- Converts user input date (b2dato) and fills keys.
- Set current position in IFNAI2R.
- Refresh the subfile.
- Clears the date position variable.

---

### subfile

**Purpose:** Handles subfile interaction loop, such as viewing details or parameters for selected rows.

Steps:
- Restores visible row after page flip.
- Loops through records (*do* w_ssrn), then *readc* reads changed records.
- If option 5: show log entry details (calls xc1bld).
- If option 8: show parameter string (calls xd1bld).

---

### xc1bld

**Purpose:** Display detail for one log record.

- CHAINs to IFNAIRR using the specified UID.
- If found, moves and formats date/time, fills detail fields.
- Shows the detail screen (exfmt c1bld).

---

### xd1bld

**Purpose:** Display the parameter string for a log record.

- Moves parameters to display variable.
- Shows the parameter screen (exfmt d1bld).

---

### clr_subfile

**Purpose:** Clears out all the subfile records and resets paging control variables.

- Uses *IN fields to control subfile record deletion.
- Resets record number variables.

---

### crt_subfile

**Purpose:** Loads the next page of records into the subfile.

- Increments the page counter.
- Reads new records (up to c_sfil count or until EOF) from IFNAI2R and writes them into the subfile.
- Stops on EOF or change of firm code.

---

### dsp_subfile

**Purpose:** Displays subfile records, or the command screen if there are no records loaded.

- If subfile records exist, sets *in12 and displays control screen.
- Otherwise writes command screen.

---

### *inzsr

**Purpose:** Initial program setup.

- Defines key lists for IFNAI2 and IFNAIR.
- Sets up search keys to start position and loads the first page of the subfile.

---

## General Flow Summary

1. **Startup:** Initialize program, set key lists, load first subfile page.
2. **Main Loop:** Show command screen or subfile, handle paging and function keys.
3. **User Interaction:** As users select options (details or parameters), the appropriate subroutines display further information.
4. **Positioning:** Users can jump to a specific date in the log.
5. **Paging:** Additional records are loaded as needed.
6. **Exit:** Program terminates cleanly when requested.

---

## Common Variable and Field Names

- `b1sfl`: Subfile record format.
- `b1valg`: Subfile option field (user selection).
- `b1uid`, `b1parm`, `b1dato`, etc.: Fields in the subfile structure.
- `c1*`, `d1*`: Variables used on the detail/parameter display screens.
- `w_*`: Work variables for subfile and database navigation.

---

## Key Takeaways

- The program is centered around **displaying and navigating a subfile of log entries**.
- Users can **page, position, and view detail** or **parameter data** for each entry.
- It uses traditional RPG cycle control, with *do*, *readc*, and explicit tags for flow.
- Subfile handling is done manually, providing flexibility but requiring careful control of state variables.

---

This structure is typical for inquiry-type programs on IBM i, especially in environments where subfiles are the standard paradigm for record-list UIs.