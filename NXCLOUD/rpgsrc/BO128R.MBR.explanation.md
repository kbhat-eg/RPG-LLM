# RPG Program BO128R – Explanation and Onboarding Guide

This source code is for an IBM i ILE RPG program called **BO128R**, which is a highly customized, transactional reporting and updating program, used for updating financial (økonomi) and statistical records. The code is thoroughly commented and maintains an extensive revision history, reflecting years of enhancements, bugfixes, and regulatory adaptations.

The program is complex and manages posting of sales, returns, payments (including cash, card, VIPPS, Payex, Santander), cost accruals, deposit management, statistical updates, and logging for audit/tracing.

Below is a high-level onboarding walk-through, focused on how the code is structured, its major components, and the business logic flow.

---

## 1. **File Declarations (`F-specs`)**

- **Files:** The program works with a broad mix of customer, product, sales, statistics, and configuration files (e.g., `bpsola` (sales transactions), `rkunl1` (customer), `vvarl1` (product), `bohelu` (sales header), and many more).
- **Usage:** Files are opened for input (`I` or `IF`), update (`U` or `UF`), and output (`O`) as needed.
- **Renaming:** Most files are renamed upon opening for clarity and consistency (e.g., `bpsola` → `bpsolar`).
- **Conditional Files:** Some files are included only in certain program versions (e.g., `fst2l1` for status codes).

---

## 2. **Data Structures (`D-specs`) and Variables**

- **Parameter Structures:** Used for passing and overlaying various control values and configuration, often via overlays into a single 256-byte parameter block.
- **Work Variables:** Large number of variables for totals, flags, key fields, and control.
    - Examples: `w_firm` (company), `w_bela` (amounts), `w_tots` (totals), `w_resk` (AR amount), `w_kund` (customer), etc.
- **Special Data Structures:** For example, handling KID numbers for bank payments, arrays for extra text, overlayed arrays for lengths, etc.

---

## 3. **Main Logic Loop (`C-specs`)**

The program follows an **input-driven loop**:

- Reads sale/posting lines from `bpsola` (sales input).
- Processes each record according to its type (`bsorct = 'H'` = header, else line):

   1. **Header Line (Bong header)**
      - Ensures correct batch run (end previous receipt).
      - Checks if the receipt (bong) should be processed.
      - If yes, calls `bong_hode` subroutine to process the header.

   2. **Detail Line (Bong line)**
      - Checks if the line should be processed.
      - If yes, calls `bong_linje` to process line items.
      - Handles cost accruals and special posting logic if needed.

- Continues until all records are processed.

---

## 4. **Subroutines (Key Operations)**

### a) **bong_hode** – Receipt Header Processing

- Handles billing/receivable numbers.
  - Factoring in whether it’s an invoice or credit note.
- Handles date fields (due date, invoice date, proper formatting).
- Determines if the receipt is negative (credit/return).
- Looks up customer master data (for default accounts, etc).

### b) **bong_linje** – Receipt Line Processing

- Resets line totals and flags.
- Manages special lines:
  - Deposit payment (`lag_depo`).
  - Invoice payment (`lag_innbet`).
- Looks up product and subgroup information.
- Retrieves item type for proper account assignment.
- Executes tax checks and handles gift card logic.
- Converts unit to statistical unit if needed.
- Calculates gross/net amounts, applying line/order/general discounts.
- Updates financial system with sales, discounts, and costs through `exekon` and `post_kost`.
- Updates statistics if enabled.
- Resets totals for next line.

### c) **slutt_bong** – Finalizes Receipt Posting

- Updates receipt header as posted.
- Adjusts sign (negative for returns).
- Adjusts accounts receivable for deposit and payment amounts.
- Posts to accounts receivable, main ledger, and handles cash/bank postings.
- Special handling for card (Santander, Payex, VIPPS).
- Handles rounding (øreavrunding) entries.
- Resets main variables for the next receipt.

### d) **exekon** – Posting to Financial System

- Composes and writes the booking record for each transaction line.
- Handles account, amount, VAT, text, and keys for correct ledger posting.
- Provides for additional logging/auditing.

### e) **post_kost** – Inventory Cost Posting

- Posts cost changes to the financial system, with double entries for movement in/out.
- Uses separate account structures for debit/credit sides.

### f) **hntkon** – Account Determination

- Calls external program `VA720R` to determine the posting account based on item, order, and group characteristics.
- Handles overrides for department/account if specified at order header.
- Determines division of accounts for VAT and product groupings.

### g) **omr_stat** – Unit Conversion for Statistics

- Adjusts sales quantity to correct unit (statistical vs. sold unit).
- Looks up conversion factors and applies them.

### h) **oppd_stat** – Update Statistics

- Populates and writes a statistical record for each sales line.
- Pulls extended info (via routines like `utvid_stat` and `hent_gjkost`) for advanced reporting.
- Handles alternative product groups, campaign codes, etc.
- Optionally posts to a relational table for external/statistical analysis.

### i) **Other Subroutines**
- **lag_depo**: Handles deposit postings.
- **lag_innbet**: Handles invoice payment lines on a receipt.
- **utvid_stat**: Retrieves expanded statistical data for advanced reporting.
- **pos_kort**: Card company (Santander/Payex/Vipps) AR posting and KID processing.
- **logg_linjer / logg_bilag / logg_hode**: Writes to logging/audit tables for traceability.

---

## 5. **Parameters and Control Flow**

- **Entry Parameters:** The program receives a single parameter structure with control settings, which is parsed into overlay fields.
- **Company Context:** Most files and logic are company-specific (`w_firm`).
- **Feature Switches:** Many features/paths are controlled by flags, both from the parameter area and from feature files.
- **Logging:** Timestamps and user info are consistently logged for audit trails.

---

## 6. **Feature Highlights / Custom Logic**

- **Extensive Discount and VAT Handling:** Supports line, order, and general discounts, with correct reversal/signs for credits/returns, and detailed VAT base handling.
- **Deposits & Payments:** Fully integrated deposit (delbetaling) and payment posting, including AR and GL implications.
- **Card Payments:** Full support for external payment methods, including KID/OCR numbers for bank reconciliation.
- **Statistics Expansion:** Optionally collects extensive statistics for BI or reporting, including cost price at delivery, campaign/pricing codes, etc.
- **Configurability:** Many options (such as posting to statistical tables, cost posting, excluding/including cash customers) are parameter-driven.
- **Error Handling:** Uses status flags to control flow if data is not eligible for update, with a strong focus on data integrity.
- **Logging & Audit:** Advanced logging structure—each posting written to log files, with sum/totals posted for reconciliation.

---

## 7. **Business Entities / Core Concepts**

- **Bong:** A receipt (sales transaction).
- **Bongheader/Bonglinje:** The header and line components of a receipt.
- **KID:** Customer identification number for bank reconciliation (familiar in the Norwegian context).
- **Statistical Record:** Entry for reporting, separate from financial postings.
- **Reskontro:** Customer accounts receivable (AR).
- **Gift card handling, Rounding, Campaigns, Orders, Deposits:** Fully supported as business scenarios.

---

## 8. **External Programs / Calls**

- **VA720R, RS701R, RS205R:** For determining accounts, account texts, VAT calculations.
- **VG805R, VG701R:** For cost/average price handling.
- **CO402R:** For retrieving configuration parameters.
- **AK700R, AK720R:** For generating and verifying KID numbers.
- **AS100R:** For number series management.
- **AX700R, VG710R, AX711R:** Various lookups for module availability, item responsibility, week calculation, etc.

---

## 9. **Getting Started as a New Developer**

- **Understand the Data Model:** Review how sales, products, customers, and statistical records are related in your database/files.
- **Map the Process:** Follow how a receipt is processed: header → lines → totals → postings.
- **Study the Subroutines:** Focus first on `bong_hode`, `bong_linje`, `exekon`, `oppd_stat`, and `slutt_bong`—these are the main transactional subroutines.
- **Review Parameter Structure:** Critical for understanding feature switches and per-run behavior. See how overlays are used in `d_parm`.
- **Check Logging/Audit:** Logging is done in several places—understand the structures and how logs are used for reconciliation or troubleshooting.
- **External Calls:** Note that much logic is delegated to external programs—work with whoever maintains those if you need changes in account or VAT handling.

---

## 10. **Where to Make Enhancements**

- If you want to enhance or fix something:
  - **Posting Logic:** Likely in `bong_linje`, `exekon`, or one of the posting subroutines.
  - **Statistics:** In `oppd_stat`, and perhaps in the extended routines called there.
  - **Logging/Audit:** In the `logg_*` routines.
  - **Configuration/Control:** Via the overlayed parameter blocks and possibly in `CO402R`.

When extending, always check: Are there version-specific features? Are there customer-specific flags?

---

## 11. **Naming, Comments, and History**

- **Comments:** The original (Norwegian) comments are detailed and often explain business logic—use a translator if needed.
- **Revision Tags:** Lines commented or marked with version tags (e.g., `6.34`, `7.09`, `8.03`) denote when new logic was added. This can be helpful for understanding why certain code exists.

---

## 12. **Sample Business Flow (Simplified)**

1. Read receipt header from input.
2. For each header:
    - Check if it should be processed (not already posted, correct status).
    - Process header (dates, customer, AR).
    - For each line:
        - Validate eligibility for update.
        - Lookup product, perform calculations (discounts, VAT, unit conversions).
        - Write financial postings and statistics.
    - At the end of the receipt:
        - Finalize totals, handle AR/bank/postings, handle rounding, update status, log activity.

---

## Summary

This RPG program is a central part of the retail/point-of-sale to back-office integration, responsible for robustly updating both the financial and statistical side of transactions. It has evolved to handle a wide variety of business cases and payment types, with a strong focus on correctness, traceability, and configurability.

**As a developer, focus first on understanding the main business flows and subroutines. Use the detailed comments and variable names as your guide, and always trace parameter-driven switches to understand why some branches are taken.**

---

**If you need more detailed walk-through for a particular subroutine or business case, just ask!**