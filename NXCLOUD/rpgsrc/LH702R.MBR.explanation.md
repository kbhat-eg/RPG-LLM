# Overview

This ILE RPG program (LH702R) is responsible for generating purchasing proposals ("bestillingsforslag") in an inventory system, presumably for use in logistics and stock management. The program reads item (varenr) records, applies selection and calculation logic, and writes proposals for items that need to be replenished, generating output or updating files as required. There is support for many configuration parameters, selection mechanisms, and business-specific rules, including handling of replacement items, price logic, and historical changes.

The code is written in traditional fixed-format RPG IV (with enhancements), using a mix of native I/O, subroutines, data structures and calling various other programs (subprograms) for business logic. Comments throughout detail both business context and explain many logic decisions.

Below is a structured walk-through of the most important sections.

---

## Key Sections

### 1. Header and Maintenance Log

- The header contains a detailed maintenance/change log, describing program changes for each release.
- Comments specify system context (ASLAGR), a brief description, and changes over nearly 20 years.
- This section helps track business requirements evolution and is important for onboarding to understand project context.

---

### 2. File Definitions (`F-Specs`)

- Many input files (`IF`), each mapped to logical and physical files, often with renaming (e.g., `fvarl1` reads `vvarpfr` as `vvarl1r`).
- Output files for proposal lines and printing (`OF`), e.g. `Flh702P` (printer).
- Files include:
    - Item master (`vvarl1`)
    - Item stock/lager (`vlagl1`)
    - Item supplier (`vvenl1`)
    - Stock status, orders, etc.
- Files are used extensively via RPG's native record-level access (CHAIN, READE, SETLL).

---

### 3. Data Structures (`D-Specs`)

- Definition of parameter blocks for incoming data (`d_prec`), batch records, local data area, various work fields, and flags.
- Many variables are overlays for reading/writing packed parameter structures.
- Numerous working variables for quantities, statuses, item numbers, selection keys, etc.
- Flags (`b_feil`, `b_stsX`, etc.) used to control logic paths and indicate results.

---

### 4. Main Logic (C-Specs)

#### Main Loop

```rpg
c                   read      vvarl1r                                91
c                   dow       *in91 = *off
    ... business logic ...
```
- Reads records from the item master file and loops until EOF.
- For each item:
    1. **Selection**: Runs `sjekk_utvalg` to check if item should be processed (company, group, period, ABC code, etc.)
    2. **Stock Check**: Runs `sjekk_lager` to get and verify stock info, handle substitution, etc.
    3. **Proposal Test**: Calls `sjekk_bestill` to determine if/how much to reorder (complex replenishment logic).
    4. **Write Proposal**: If all checks pass, executes `skriv_forslag`, writing output and updating accumulators.
    5. Reads next item.
- Exits via `les_ferdig` tag when done.

#### After the Loop

- If any proposal lines were written, outputs or updates proposal headers.
- Sets output fields, calls programs for further processing (e.g., printing, generating XML, etc.)
- Executes clean-up, unlocks records, sets LR.

---

### 5. Subroutines

#### sjekk_utvalg

- Checks if the current record matches selection criteria:
    - Correct company
    - Is a stock item
    - Is not blocked, discontinued, or otherwise excluded
    - Checks valid ranges for supplier, item groupings, and possibly buyer
    - Handles special product selection (period items, substitutions, etc.)

#### sjekk_lager

- Verifies and retrieves the current item’s stock information for the relevant warehouse.
- Determines min/max stock levels, reorder points, calculates actual available stock (`w_behl`).
- Handles logic for replacement items, combining their stock as needed.
- Applies any percentage increases from parameters.

#### sjekk_bestill

- Main replenishment calculation:
    - Decides, based on stock and parameters, if an order should be proposed and how much.
    - Applies rules for replenishment including min/max/EOQ, special corrections for package size, and flags items needing special status.
    - Flags items by status (out of stock, below min, etc.) and calculates proposed order quantity.

#### skriv_forslag

- Writes a line for the purchasing proposal if all preconditions are met.
- Looks up and stores prices, calculates line values.
- Handles specialties like substituting prices from promotions or alternate units.
- Updates totals for reporting and output.

#### Multiple helper subroutines

- `finn_beh`, `finn_pris`, `les_ldor`, etc., each encapsulating business logic and/or file access for a part of the calculation or output.

---

### 6. Entry Parameters and Initialization

- Defines `*ENTRY PLIST` for RPG parameter passing.
- Populates key work variables from the incoming parameter block.
- Performs initial fetches for company, date, pricing information, and checks various switches via calls to `CO402R` (system parameter program).

---

### 7. Key Calculation & Status Logic

- **Stock Calculation**: Takes into account on-hand, on-order, reserved, and in-transit quantities.
- **Replacement Items**: If items are replaced or are replacements, proper logic branches are taken to sum/shift quantities.
- **Status Codes**: Various b_stsX flags track rule-specific statuses, which guide how proposal headers and lines are generated.
- **ABC Codes**: Filtering and verification of item groups important for inventory control and replenishment focus.

---

### 8. Output and Integration

- When lines are generated, the program can:
    - Write to a proposal details file
    - Write to a spool file (for reporting)
    - Generate an XML file for further processing
    - Integrate with other systems via parameter passing
- Calls to programs like `MP714R` (XML), `VP730R` (pricing), `AS100R` (numbering), etc.

---

## Special Cases and Switches

- Many business rules are enabled/disabled via switches (fetched from centralized parameter table via `CO402R`).
- Behaviors such as how to deal with status 6, rounding rules, extra stock logic for BM module, and so on, are externally controlled.
- Documented changes reflect long history of adapting the process to user/company requirements.

---

## Modification History

- The history at the top provides context for why some logic is present (e.g., fixing rounding, new status code logic, integrating replacement item calculations, etc.).

---

## Key Takeaways for New Developers

- **The program is complex, reflecting both inventory theory and deep business customization.**
- **Clear understanding of stock control, ABC analysis, and Nordic logistics practices will help.**
- **Switches and external parameters are used extensively—test with different scenarios.**
- **The code uses a lot of subfile access patterns (CHAIN, READE, SETLL).**
- **Refer to the maintenance log for why certain logic exists.**
- **Parameter structures and overlays are crucial for correct input/output field mapping.**
- **There is extensive integration with other batch and interactive programs—get to know these dependencies.**

---

## Example Flow

1. **Initialization**: Sets up key context and control switches.
2. **Item Loop**: For each item in range:
    - Selects/filters item
    - Gets stock info
    - Calculates need for order (proposed quantity)
    - Writes proposal line if required
3. **Proposal Header**: If any lines are written, writes header and produces output (print/report/XML)
4. **Exit/Cleanup**: Calls post-processing programs, closes files, ends job.

---

## Conclusion

This is a central, batch-oriented program for automating purchase proposals, highly parameterized and adapted to many business-specific requirements. It demonstrates typical RPG batch pattern—read records, process, output—plus significant evolution and integration in a large logistics system. 

**New developers should focus on:**  
- Understanding the parameter structure,
- Key subroutines and their roles,
- File access patterns,
- The meaning and flow of the many flags/status fields,
- How the program fits into the broader replenishment and order fulfillment pipeline.