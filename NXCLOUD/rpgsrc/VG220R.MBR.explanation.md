# RPG Program VG220R – Maintenance of Cost Price Factors

This RPG program is designed for IBM i (AS/400, iSeries) and is used to **maintain “factors” related to cost pricing** (likely in a manufacturing or inventory context). The code uses classic (fixed-format) ILE RPG with subfiles and multiple data files, and includes features for searching, adding, updating, copying, and deleting factor records.

Below, I've organized the explanation by logical groupings found in the code:

---

## **1. File Declarations (`F-Specs`)**

The program uses several physical files, all of which are seemingly related to various groupings, parameters, and master data.

- `uf`: Update file (can be updated and read)
- `if`: Input file (read-only)
- `cf`: Display file (workstation)
- `DISK`: Data is physically stored on disk
- `RENAME(...)`: The record format used in this program is renamed for clarity or uniqueness.

### **Examples**
```rpg
fvgkfiu    uf a e           k disk    rename(vgkfst:vgkfiur)
fvg220d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- `fvgkfiu`: Update file for factors
- `fvg220d`: Display file used for workstation interactions, featuring a subfile (`b1sfl`).

---

## **2. Data Declarations (`D-Specs`)**

### **Local Data Area and Variables**
- **LDA** (Local Data Area) variables:
    - `l_user`: User name (positions 911–920)
    - `l_firm`: Firm number (944–946)
    - `l_fnav`: Name (951–980)

- **Keys for Various Files:** Many variables (`vgkfiu_lage`, `vgkfir_flev`, etc.) are defined `LIKE field`, matching their counterparts in the database.
- **Subfile Control Variables:** For subfile navigation (page size, record number, etc.)
    - `w_stel`, `w_spge`, `w_srrn`, etc.

- **Flags and State Variables:** For flow control and function keys.

---

## **3. Constants**
```rpg
d c_sfil          s              2  0 inz(13)
```
- Subfile page size is 13.

---

## **4. Documentation of Indicators and Screens**

Comment sections explain how various indicators (e.g., `*IN10`, `*IN30`) are used. Common indicator meanings are:
- `LR`: Last record, ends program
- `*IN10–*IN15`: Subfile and display control (roll up/down, clear, end, etc.)
- `*IN30–*IN31`: Field protection, error signaling, etc.
- `*IN80–*IN99`: Work indicators

**Screen images**: `B1SFL`, `B2CTL`, `B2CMD`, etc., refer to various record formats for display/input.

---

## **5. Mainline Logic (C-Specs)**

The program is driven by a main loop and a series of labels and subroutines, typical for classic RPG/400.

### **Control Flow**

- **Program Start (`b2taga`)**: Executes initial write of command screen.
- **Main User Loop (`b2tagb`)**: Calls `dsp_subfile` to display the subfile, then handles function keys.
- **Function Key Handling**: 
    - End program on F3/F12 (`*INKC`/`*INKL`)
    - Søk/search, Refresh, Add, Update, Copy, Subfile page navigation, and cursor positioning.
- **Subfile Processing (`subfile` subroutine)**:
    - Iterates through subfile records, checking if the user wants to Edit (2), Copy (3), Delete (4), or View (5) a record.
    - Calls the appropriate subroutines for each operation.

---

## **6. Subroutines**

Here are the main subroutines and their purposes:

### **forny / posisjoner / subfile**
- **forny**: Refreshes the subfile after changes.
- **posisjoner**: Positions the subfile to a specific key (e.g., supplier or warehouse).
- **subfile**: Processes user actions on the subfile rows (edit, copy, delete, view).

### **xc1msg**
- Displays a user message if attempting to create a duplicate row.

### **xc2bld**
- Handles the Add/Edit/View screen for a single record.
- Performs field lookups/calls for validation and gets default descriptions.
- Validates entries for existence (factor type, supplier, groups, item number).
- Writes or updates the record accordingly.

### **xd1win / xk1win**
- **xd1win**: Handles the delete record confirmation and action.
- **xk1win**: Handles copying a record (including duplicate prevention and launching the edit screen for the new copied record).

### **clr_subfile / crt_subfile / bck_subfile / dsp_subfile**
- **clr_subfile**: Clears the subfile and resets control variables.
- **crt_subfile**: Reads and populates the subfile from the database, handling paging.
- **bck_subfile**: Provides page-back capability in the subfile.
- **dsp_subfile**: Writes the subfile control format, enabling user interaction.

### **upd_fakt / les_excel / sok**
- **upd_fakt**: Calls another program to update factors in batch.
- **les_excel**: Calls a program to import factors from Excel.
- **sok**: Performs lookup for supplier or warehouse based on the field the user is on.

### **hent_txt**
- Fills out descriptive fields (supplier name, group descriptions, item description) for display/editing.

---

## **7. Initialization Subroutine (`*INZSR`)**

- Sets up the key lists for file access.
- Reads Local Data Area variables into program state.
- Initializes display indicators and subfile.

---

## **8. Key Lists**

- Key lists (`KLIST`) for all file accesses are defined at the end, specifying which fields are used as keys for reading, chaining, and setting lower limits (SETLL/SETGT).
- Examples: `vgkfiu_key`, `vgkfir_key`, `vgkfi1_key` (for main factor files), and similar for lookup and description files.

---

## **9. Flow Summary**

1. **Startup**: Program reads LDA, initializes subfile, and displays the main screen.
2. **User Interaction**: The user navigates, searches, modifies, copies, adds, or deletes records using function keys.
3. **Subfile Processing**: All edits/copies/deletes occur in subfile rows, with pop-up windows for confirmations as appropriate.
4. **Data Validations**: Many lookups and validations ensure data integrity before writes/updates.
5. **Batch/Utility Actions**: Additional programs can run for mass updates or imports.

---

## **10. Noteworthy RPG/IBM i Techniques Used**

- **Subfiles**: Core to the user interface, allowing multiple records to be viewed/modified on one screen.
- **Key Lists (KLIST/KFLD)**: Used to manage complex keys for database access.
- **Indicators**: Heavy use of indicators for state and screen control (pre-RPG IV style).
- **External Calls**: Dynamically calling other RPG programs for lookups, batch processing, and Excel import.
- **Field Validation/Lookup**: Using CHAIN to verify existence and get descriptions.

---

## **Conclusion**

This program is a comprehensive, menu-driven maintenance application for cost factors (likely used in procurement/inventory/costing). Its use of subfiles, multiple files/keys, and field validations ensures a robust and user-friendly data maintenance tool typical of classic IBM i business applications.

**New maintainers should pay particular attention to:**
- The structure/usage of subfiles
- How indicators control flow and screen states
- The meaning of each key list
- Integration with other business programs via CALL/PARM
- Validation logic for each reference field (factor type, supplier, groupings, and items)

If you need a breakdown of a particular section/subroutine in more detail, please specify!