# Documentation: VP682R – Customer Price File Export

## Overview

**Program:** VP682R  
**System:** ASOFAK  
**Purpose:**  
This program exports product and price information for customers in a variety of output formats, each tailored to specific customer or system requirements (e.g., NOBB, BYGGDATA, CORRADO, REGNEARK, IBX, LOGIQ, etc). It supports multiple selection/filtering mechanisms for which products to include (by product group, supplier, assortment, or all products) and integrates with several other modules to gather and process up-to-date pricing, product, and organizational data.

## Business/Domain Context

- **Primary Use:** The program is used to generate price files for customers, often for integration with external systems or for customer-specific price catalogs.
- **Supported Formats:** Multiple output formats are supported, each with its own record structure and field requirements. Examples: NOBB (Norwegian building industry standard), BYGGDATA, CORRADO, REGNEARK (spreadsheet), and various proprietary/external formats.
- **Price Calculation:** Actual price calculation is delegated to the `VP900R` program, which receives a detailed parameter structure and returns computed prices and discounts.
- **Data Sources:** Product master, customer master, price lists, units of measure, discount structures, and assorted lookup tables.
- **Special Handling:** The program contains numerous customer- and project-specific adaptations, as reflected in the detailed change log and conditional logic throughout the code.

## High-Level Flow

1. **Initialization:**  
   - Entry parameters are parsed, including customer, project, selection criteria, and format.
   - Key lists for file access are set up.
   - Current date/time and contextual data (e.g., warehouse) are determined, sometimes based on customer/project settings.

2. **Pre-Checks:**  
   - Validates prerequisites (e.g., NOBB participant number for NOBB formats).
   - Retrieves and prepares company and customer information, including conversion of special characters for certain formats.

3. **Header Output:**  
   - Writes format-specific header rows if required (e.g., REGNEARK, CORRADO, LOGIQ, IBX).

4. **Product Selection:**  
   - Depending on selection criteria (product group, supplier, assortment, or all), iterates over the relevant set of products.
   - For each product, runs the main processing subroutine.

5. **Main Processing (per product):**  
   - Applies business rules to filter out ineligible products (e.g., discontinued, non-distributable, special types).
   - Retrieves unit(s) of measure and conversion factors.
   - Looks up product group/subgroup texts as needed.
   - Prepares and calls the price calculation program (`VP900R`), using detailed input parameters.
   - Depending on the selected output format, calls the corresponding output subroutine to format and write the product/price record.

6. **File Update:**  
   - Updates the customer distribution list with the date/time of the export.

7. **Cleanup:**  
   - Program termination.

## Key Modules and Relationships

- **VP900R:** Price calculation. Accepts a detailed product/customer context and returns price, discounts, etc.
- **VL710R, VL712R, VE713R, FO710C, FO712C, RS755R:** Various lookup and utility programs for product, price, unit, and tax data.
- **VD700R:** Product assortment selection.
- **File Access:** The program accesses a large number of files (product master, price lists, customer master, unit tables, discount tables, etc.), often via keyed access for performance.
- **Output Files:** Each format writes to its own output file, e.g., `fibspfr` for BA-KALK, `fibdpfr` for BYGGDATA, etc.

## Notable Design and Implementation Features

### 1. **Format Abstraction**
   - Each supported output format has a dedicated data structure (`DS`) defining its record layout.
   - Subroutines for each format encapsulate all logic needed to prepare and write a record in that format.
   - This design allows for easy extension and maintenance as new formats are added or requirements change.

### 2. **Flexible Product Selection**
   - The program supports selection by:
     - Product group hierarchy (overgroup/hovedgruppe/undergruppe)
     - Supplier (leverandør)
     - Product assortment (varesortiment)
     - All products
   - Selection logic is encapsulated in dedicated subroutines, which iterate over the relevant subset of the product file.

### 3. **Integration with External Programs**
   - Price calculation is centralized in `VP900R`, ensuring consistent price logic across all formats.
   - Product and tax information is retrieved from external modules, promoting single-sourcing of business logic.

### 4. **Business Rule Filtering**
   - Products are filtered out based on several business rules:
     - Exclude discontinued, special type, or non-distributable items.
     - Exclude or include certain product types based on selection parameters.
   - Filtering logic is applied before any price calculation or output.

### 5. **Multi-Unit and Conversion Handling**
   - For formats supporting multiple units (e.g., REGNEARK), the program retrieves up to three units and corresponding conversion factors.
   - If price book units are not available, falls back to sales units.
   - Conversion logic ensures that prices and quantities are represented correctly in each format.

### 6. **Complex Discount Handling**
   - Supports up to two discount levels and calculates net price accordingly.
   - For some formats, total discount is recalculated if both discounts are present.

### 7. **Special Character Conversion**
   - For formats and customers requiring it, Norwegian characters (ÆØÅ) are converted to ANSI/Windows code page equivalents.

### 8. **Offer Price/Validity Logic**
   - For prices marked as "offer" (tilbud), the program attempts to find the correct offer validity date by searching the offer file at various levels (product, group, supplier).
   - The logic is encapsulated in subroutines for maintainability.

### 9. **Output Record Construction**
   - Data is moved into format-specific DS overlays before writing.
   - For some formats, additional lookups (e.g., supplier name, GTIN, tax code, product images) are performed before output.

### 10. **Legacy and Domain-Specific Adaptations**
   - The codebase contains numerous adaptations for specific customers, projects, and format versions, as documented in the extensive change log.
   - Many output formats and business rules have evolved over time, and the code is structured to accommodate such changes.

## Key Data Structures

- **hirec/horec:** Input and output parameter structures for `VP900R` (price calculation).
- **d_bs, d_bd, d_nn, d_rc, d_hp, d_nobb, d_nvar, d_npak, d_npri, d_ra, etc.:** Output record layouts for each supported format.
- **Numerous working variables:** For price, discount, product group, units, etc.

## Subroutine Structure

- **behandl_vgrp, behandl_ldor, behandl_vsor, behandl_tot:** Product selection subroutines.
- **behandling:** Main per-product processing and format dispatch.
- **enheter:** Fetches up to three units of measure and conversion factors.
- **[format]_subroutines:** One per supported output format.
- **gml_varenr:** Looks up old product numbers for certain products.
- **tilb_sjekk, hent_tilb:** Offer/discount validity logic.
- **logiq_hode, logiq:** Specialized routines for the LOGIQ format (used for digital catalogs).

## Output Formats

Each output format has its own structure and logic. Some examples:

- **BA-KALK:** For BA-Kalk systems, includes product, group, text, unit, price, and discount info.
- **BYGGDATA:** For Byggdata systems, includes group hierarchy, EAN, product, texts, units, prices, and more.
- **CORRADO:** Special handling for Norwegian characters and format-specific fields.
- **NOBB/NOBB_INT:** Norwegian building industry standard, with strict requirements for NOBB number, unit, and offer logic.
- **REGNEARK:** Spreadsheet format, supports multiple units and prices.
- **IBX/LOGIQ:** Modern digital catalog formats, with enriched data (GTIN, UNSPSC, image URLs, etc.).

## Integration Points

- **VP900R:** Centralized price logic.
- **VL710R/VL712R:** Product and price group lookups.
- **VE713R:** GTIN/EAN lookup per price giver.
- **RS755R:** Tax code and rate lookup.
- **VD700R:** Product assortment selection.
- **FO710C/FO712C:** Old product number and unit lookup.
- **LOGIQ/IBX:** Digital catalog exports for external platforms (EHF, Tradeshift, etc.).

## Patterns and Conventions

- **Versioning:** Extensive use of version comments and conditional code for format evolution.
- **Overlay Data Structures:** For efficient record construction and output.
- **Keyed File Access:** For performance and business rule enforcement.
- **Parameter Passing:** Consistent use of parameter structures for subprogram calls.
- **Conditional Output:** Output logic is strictly format-driven, enabling support for many formats in a single program.

## Maintenance Notes

- **Adding New Formats:** Add a new DS overlay and output subroutine, update format dispatch logic in `behandling`.
- **Business Rule Changes:** Centralized in filtering and price calculation logic; ensure all affected formats are reviewed.
- **External Program Changes:** If `VP900R` or other modules change, review parameter passing and returned data.

## Summary

VP682R is a highly flexible, format-driven price export program supporting a wide range of customer and system requirements. It leverages modular subroutines, centralized price calculation, and extensive file integration to produce accurate, business-rule-compliant price files for downstream systems and customers. The codebase reflects a long evolution and is structured to accommodate ongoing changes in both business logic and technical requirements.