# RPG Program EK501R – Explanation

This program is written in ILE RPG (Report Program Generator) for IBM i (AS/400) systems. It is used to display customer bonuses (“Kunde bonus, vise”) using subfiles. The source includes documentation in Norwegian, which is preserved in the code.

## 1. **File Declarations**

- **Physical and Logical Files**: Many files are declared with `IF` (input, full procedural), e.g., `ekboir` through `ekboic`, representing various bonus index files. Each may represent a different access path for efficient searches by various keys (customer, project, group, etc.).
- **Display File**: `ek501d` is the display file for the workstation, using a subfile (`sfile(b1sfl:w_srrn)`) for scrolling through multiple bonus records on-screen.

## 2. **Indicators Usage**

- The comments explain which indicators are used for which purposes, such as *INLR (last record), *IN10/11 (rollup/down), *IN12–15 (subfile operations), and user indicators 31–99 for errors, warnings, and work.

## 3. **Data Definitions Section**

- **Parameters**: `p_firm`, `p_bkun` define the firm and bonus customer, passed as input.
- **Local Data Area**: Used to retrieve logged-in user information.
- **Display File Feedback Data Structure**: `dspfbk` is used to access the current record on the screen (`d_fcrn`).
- **Key Variables**: Variables are defined matching the keys for the various logical files for searches and positioning.

## 4. **Working Variables**

- Variables for subfile handling:
  - `w_fcrn` (first record on page), `w_stel` (subfile counter), `w_spge` (subfile page size), `w_srrn` (relative record number in subfile), etc.
- `w_seqe` (sequence) is used to indicate which level is being browsed (e.g., ‘K’ for customer, ‘P’ for project).

## 5. **Constants**

- `c_sfil` sets the subfile page size (13 records per page).

## 6. **Subfile Concepts**

- The subfile (B1SFL) displays bonus records, with a control record (B2CTL) allowing further actions such as additions, inquiries, and paging.
- Subfiles support paging, selection, and position-to logic, allowing users to scroll and search through customer bonus records efficiently.

## 7. **Mainline Logic**

### **Program Flow**

- **Initialization** (`*inzsr`): Receives parameters, initializes keys for all files based on the bonus customer and firm, sets up the subfile, and positions to the first record.
- **Main Loop**:
  - Display the command screen (`b2cmd`).
  - Display the subfile with the customer bonuses (`dsp_subfile`).
  - Process function keys (roll up/down, refresh, position, inquiries, exit).

### **Function Key Handling**

- *IN10: Roll up (next page)
- *IN11: Roll down (previous page)
- *INKC, *INKL: Exit program
- *INKD: Start inquiry (via subroutine `spørring`)
- *INKE: Refresh the subfile (`forny`)
- *IN21: Home key, sets cursor to top
- If position fields are filled (e.g., customer, group, product), calls `posisjoner` to move to that area in the subfile.

## 8. **Subroutines**

### **forny** (Refresh Subfile)

- Uses the current record number and sequence to reposition and reload the subfile from the correct record, depending on user selection (customer, project, etc.).
- Calls `clr_subfile` and then `crt_subfile` to blank and refill the subfile window.

### **posisjoner** (Position In Subfile)

- Checks which position fields are set (e.g., “position to customer”), builds the appropriate key, and positions the access path accordingly.
- Blank the position fields after positioning to prevent repeated actions.

### **subfile** (Process Subfile Entries)

- Toggles the subfile control indicator, loops through the displayed subfile rows (`readc`), and processes selection codes entered by the user on each record.
- If a record is selected:
  - 5: View details using a display window (`xc2bld`)
  - 7: Call another program (`EK510R`) to show related bonus elements for the selected record.

### **crt_subfile** (Create and Fill Subfile)

- Reads up to the subfile page size (default 13 records), filling in the subfile with bonus data using the current key (based on the position type, e.g., customer, group).
- Converts dates and sets markers as needed; writes to the subfile (`write b1sfl`).

### **bck_subfile** (Page Back in Subfile)

- Backs up one page in the subfile, repositions the access path to just before the current first record, and refills the subfile with the previous records.

### **dsp_subfile** (Display Subfile)

- Displays the subfile control screen to the user and retrieves the current cursor position for further processing.

### **spørring** (Inquiry/Lookup)

- Handles all F4 (prompt) lookups for fields such as discount category, customer number, project number, group, supplier, item, unit, type, and bonus type, calling relevant programs for lookups and returning selected values.

### **hent_info** (Fetch Descriptions)

- Given the various keys (e.g., discount category, customer, group, item), retrieves and sets descriptions for display in the detail window.

### **clr_subfile** (Clear Subfile)

- Turns the clear indicator on, writes the subfile control record (effectively blanking the subfile), resets all subfile-page working variables.

## 9. **Key List Declarations**

- Many keyed logical files are used. RPG key lists (`klist`) are declared for each file, often combining the firm, customer, and the relevant field for fast access.

## 10. **Initialization Routine (\*inzsr)**

- Sets up parameters from the *ENTRY plist.
- Prepares all key lists for future database access.
- Initializes the main subfile for the current customer.
- Positions and sets up the display with initial values.

---

## **Summary of Usage**

- The program provides a data entry and management interface for customer bonuses, allowing users to scroll, search, and view bonus details for a customer in an interactive subfile/report interface typical for 5250 screens.
- It uses multiple logical files and allows flexible searching/positioning by many levels (customer, project, item, group, etc.), facilitating complex navigation.
- The code is designed for extensibility and is heavily reliant on subfiles and indicators for interactive display and control.
- The program is modular, with distinct subroutines for all main actions: subfile handling, position-to, prompting lookups, paging, and information retrieval for popup windows.

---

## **Key Flowchart**

```text
+------------+
| *inzsr     |  <-- Initialization: sets parameters, keys, prepares subfile
+-----+------+
      |
      v
+-----+--------+
| b2taga (tag) | <-- Main display loop:
+-----+--------+     1. Show menu/command screen
      |              2. Display subfile (b2tagb)
      v              3. Process keys/selections
+-----+------+
| b2cmd      |
| WRITE      |
+-----+------+
      |
      v
+-----+------+
| b2tagb     | <-- EXSR dsp_subfile
+-----+------+
      |
      v
+--------------------+
| Process Keys/      |
| Subfile Selections |
+--------------------+
      |
      v
+-------------+
| End Program |
+-------------+
```

---

## **Tips for New Developers**

- Indicators (*INxx) control most screen I/O and subfile operations—ensure you update the correct indicator for the desired action.
- RPG’s subfile handling is central in this code: all scrolling, paging, selection is done through it.
- Understand the program’s navigation logic: keys built in subroutines match the data hierarchy (customer -> project -> group, etc.).
- Use the lookup programs (e.g., RA506R, RK500R) to aid user entries.
- When creating new searches or navigation, follow the key list pattern and add corresponding subfile routines.

---

**In summary:**  
This is a robust ILE RPG subfile application for maintaining and viewing customer bonus agreements with a high degree of search, navigation, and display flexibility, leaning heavily on IBM i best practices for interactive display and database access.