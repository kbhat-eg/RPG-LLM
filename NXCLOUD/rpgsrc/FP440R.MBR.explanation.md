# Documentation: FP440R – Customer Label Printing

## Overview

**Program:** FP440R  
**System:** ASOFAK  
**Purpose:** Prints shipping or product labels for customers, supporting multiple printer types and label formats.  
**Description:**  
This program manages the creation and printing of labels for customers, incorporating both static (fixed) and dynamic (customer-specific) data. It supports various label printers (Meto, Bandit, Eltron, etc.), handling their unique command sets and formatting requirements. The workflow is interactive, allowing operator input and label previewing before printing.

---

## File Declarations

- **fp440d**: Workstation file (CF, E, WORKSTN) – User interface for data input and control.
- **vfaspf**: Database file (UF, A, E, K, DISK) – Holds static label text, keyed by company.
- **etikett**: Printer file (O, F, 132, PRINTER, OFLIND(*INOF)) – Output device for label printing.

---

## Key Variables

- **w_firm**: Current company number.
- **w_kund**: Customer number for label.
- **w_navn**: Customer name.
- **w_navn_ut**: Output name for label formatting.
- **w_retk**: Return code from subprogram calls.
- **w_anta**: Number of labels to print.
- **w_dato**: Date for label.
- **w_skty**: Printer type (determines label format/commands).
- **w_in03, w_in12**: Input flags, possibly for UI state.
- **a1fas1–a1fas4, a1vtxt**: Static text fields from `vfaspf` (fast tekst).
- **a1kund, a1navn**: Working fields for current customer/label.

---

## Main Workflow

### 1. Initialization (`*INZSR`)

- Populates initial values for company, customer, and date.
- Sets up key lists for static label text retrieval.
- Outputs printer-specific initialization commands if required (e.g., Meto Bandit).

### 2. Main Processing Loop

#### a. Static Text Fetch

- Fetches static label text (fast tekst) from `vfaspf` using company as key.
- If not found, blanks out text fields.

#### b. Input Handling

- Displays input screen (`exfmt a1bld`) for operator to enter/modify label data.
- Handles function keys:
    - **F3 (`*INKC`)**: Set exit flag and branch to clean up.
    - **F12 (`*INKL`)**: Set alternate exit flag and branch to clean up.
    - **F4 (`*INKD`)**: Calls subprogram `RK500R` to fetch customer data (number, name).
    - **F5 (`*INKE`)**: Triggers label print via subroutine `skriv_etik`.

#### c. Customer Data Handling

- If a customer number is present, calls subprogram `RS750R` to fetch the customer name.

#### d. Loop

- After each operation, loops back to input handling unless an exit key is pressed.

### 3. Label Printing (`skriv_etik` Subroutine)

- Determines printer type via `w_skty`.
- For each supported printer type, outputs the appropriate initialization, program, and data records using EXCEPT statements.
- Handles the number of labels to print, formatting, and populating label fields (static text, customer number, name, date, etc.).
- Each printer type (Meto 8100 Twinax/Standard, Bandit, Eltron, Meto mi-4) has a dedicated output section with device-specific commands.

### 4. Cleanup

- On exit, outputs any necessary termination commands for the selected printer.
- Sets LR (`*INLR`) to end the program.

---

## Printer-Specific Logic

### Meto 8100 Twinax (w_skty = 0)

- Sends initialization and buffer-clear commands.
- Loads program and data using device-specific control sequences (e.g., `&02&20&03`).
- Populates label fields with customer and static data.

### Meto 8100 Standard (w_skty = 1)

- Similar to Twinax but uses a different command set (e.g., `{&S000005}`).
- Handles label formatting and data field population.

### Meto Bandit (w_skty = 2)

- Sends initialization and formatting commands specific to Bandit printers.
- Handles label content and counts with unique field layouts.

### Eltron (w_skty = 3)

- Outputs Eltron EPL2 command sequences for label formatting.
- Populates variable fields using mapped variables.

### Meto mi-4 (w_skty = 4)

- Uses a distinct set of control codes (e.g., `~n`, `~c0000`) for label setup and data.
- Handles field placement and data population for customer name, number, date, etc.

---

## External Subprograms

- **RK500R**: Retrieves customer data (number, name) for label population.
- **RS750R**: Retrieves customer name for a given customer number.

---

## Data Relationships

- **vfaspf**: Provides static (fixed) label text per company.
- **Customer Data**: Retrieved dynamically via subprograms, not directly from a file in this program.

---

## Design Patterns and Conventions

- **Printer Abstraction**: Uses a combination of a printer type code (`w_skty`) and EXCEPT output blocks to abstract differences between printer command sets.
- **Interactive Loop**: Main logic is an input-driven loop, allowing the operator to review, edit, and print multiple labels in a session.
- **Subroutine Structure**: Core operations (e.g., label printing, initialization) are encapsulated in subroutines for clarity and reuse.
- **Device Independence**: All printer-specific logic is isolated to EXCEPT output blocks, making it easier to add new printer support or modify existing ones.

---

## Non-Obvious Aspects

- **Label Data Population**: Some label fields (e.g., EAN number, item number) use the customer number for both fields. This may be a business-specific requirement or a placeholder for future expansion.
- **Static Text Handling**: Static label text is managed centrally in `vfaspf`, allowing for company-specific label customization without code changes.
- **Printer Command Sequences**: Each printer type uses low-level device control codes—these are critical for correct label formatting, and should not be altered without reference to printer documentation.

---

## Business/Domain Logic

- **Label Customization**: Supports both static (company-wide) and dynamic (customer-specific) label content.
- **Multi-Printer Support**: Designed for environments with heterogeneous label printers, common in logistics and distribution.
- **Operator Workflow**: Interactive design allows for on-demand label printing, error correction, and preview before output.

---

## Module Interactions

- **Subprogram Calls**: Relies on `RK500R` and `RS750R` for customer data, indicating a modular architecture for customer information management.
- **Data File (`vfaspf`)**: Central repository for static label text, likely maintained by administrative staff or via a separate management program.

---

## Error Handling

- **Missing Static Text**: If static text is not found for a company, label fields are blanked to prevent printing incorrect information.
- **Exit Handling**: Cleanly terminates and resets printer state on exit or function key commands.

---

## Summary

FP440R is a robust, modular label printing program designed for flexible, multi-printer environments. It integrates static and dynamic data, supports interactive operator control, and isolates device-specific logic for maintainability. Understanding the business context—label requirements, data sources, and printer fleet—is essential for effective maintenance and enhancement of this program.