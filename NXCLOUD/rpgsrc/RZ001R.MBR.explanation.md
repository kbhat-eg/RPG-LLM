# RPG Program RZ001R Documentation

## Overview

**Program:** RZ001R  
**System:** ASOFAK  
**Purpose:**  
This program reads invoice lines from the file `FOVF` and generates output records in the Zirius format, writing them to `RZ01PF`. It performs various data lookups and transformations, particularly around account numbers, VAT codes, and customer information, to conform to the requirements of the Zirius system.

**Key Business Functions:**
- Converts invoice lines to Zirius-compatible records.
- Handles business logic for account, VAT, and document code conversions.
- Performs lookups for customer and invoice header data to enrich output.
- Applies special handling for number expansions and code overrides.

---

## File Definitions

| File      | Type | Access | Keyed | Description / Notes                                   |
|-----------|------|--------|-------|-------------------------------------------------------|
| FOVFL1    | Input| Primary| Yes   | Source invoice lines                                  |
| SOHEL1    | Input| Full   | Yes   | Invoice header, renamed to SOHEL1R                    |
| RKUNL1    | Input| Full   | Yes   | Customer master, renamed to RKUNL1R                   |
| RB00L1    | Input| Full   | Yes   | VAT code conversion, renamed to RB00L1R (since 6.36)  |
| RB10L1    | Input| Full   | Yes   | Document code conversion, renamed to RB10L1R (since 6.37)|
| RZ01PF    | Output|       |       | Output file in Zirius format                          |

---

## Data Structures

### Local Data Area
- `l_firm`: Used for firm/organization number (positions 944-946 in the LDA).

### Date Structures
- Several DS for handling and converting invoice and due dates (`d_fdat`, `d_fdati`, `d_utdato`, etc.).
- Date fields are split into year, month, day components for manipulation.

### Zirius Record Layout (`d_inpu`)
- 433-byte structure mapping all fields required by the Zirius interface.
- Includes fields for accounting, customer, VAT, amounts, textual descriptions, etc.

### Work Variables
- Various fields for holding intermediate values, keys for lookups, and temporary data during processing.

---

## Key Business Logic

### Invoice Line Processing

1. **Field Initialization:**  
   All output fields (`d_*`) are blanked or zeroed at the start of each iteration.

2. **Bunt (Batch) and Bilagsnr (Document No):**  
   Set from the input file fields `ffbunt` and `ffbiln`.

3. **Document Code Conversion (since 6.37):**  
   If a mapping exists in `RB10L1`, converts the document code (`ffbilk`) to a new code (`rankod`).

4. **Date Handling:**  
   - Invoice and due dates are converted and mapped to Zirius fields.
   - Both are split and reassembled as needed for output.

5. **Account Logic:**
   - Debet and credit accounts are set based on input, with special handling for accounts over 9999 (likely indicating customer/vendor sub-ledger).
   - If the account is a sub-ledger, the customer number is inserted in the appropriate field.
   - Project and department logic is applied if present.

6. **VAT Code Conversion (since 6.36):**  
   - If a mapping exists in `RB00L1` for the VAT code, it is converted to the new code (`r00nko`).

7. **Text and Amounts:**  
   - Textual fields and numeric amounts (amount, quantity, currency, etc.) are moved directly.

8. **Customer and Address Info:**  
   - A subroutine (`control_init`) is used to fetch customer and invoice header data to enrich the output record with names, addresses, and postal codes.

9. **Writing Output:**  
   - The assembled record is moved into the output buffer (`rzdata`) and written to `RZ01PF`.

---

## Subroutine: `control_init`

- **Purpose:**  
  Enriches the output record with information from the invoice header (`SOHEL1`) and customer master (`RKUNL1`).
- **Process:**
  1. Sets key fields for lookup (`w_firm`, `w_binr`, `w_aarr`).
  2. Finds the most recent invoice header for the current invoice.
  3. If a supplier customer number (`solkun`) exists, fetches and stores the supplier's name and address.
  4. Always fetches the main customer name and address for the current line (`ffkund`).

---

## Special Logic and Conventions

- **VAT and Document Code Conversion:**  
  The program supports mapping/overriding of VAT and document codes via external tables (`RB00L1`, `RB10L1`). This is controlled with the `w_type` variable and key lists, allowing for flexible business rule changes without code modifications.

- **Number Expansion:**  
  There is explicit handling for account numbers greater than 9999, which are treated as sub-ledger accounts and trigger additional logic (e.g., inserting customer numbers).

- **Field Layout and Mapping:**  
  The output record (`d_inpu`) is tightly packed, with fixed positions for each field. This is necessary for the Zirius interface.

- **Error Handling:**  
  The code uses RPG's indicators (e.g., `*IN90`) to handle not found conditions during file lookups. If key data is missing, the program jumps to an end tag.

- **Extensibility:**  
  Several fields and sections are marked with comments such as `??????????`, indicating potential future expansion for additional dimensions or business needs.

---

## Relationships with Other Modules

- **Master Data:**  
  Relies on customer and invoice header master files for enriching invoice lines.
- **Code Conversion:**  
  Uses external tables for VAT and document code mapping, allowing business users to manage code changes without code deployments.
- **Output Integration:**  
  The output file (`RZ01PF`) is intended for import into Zirius or a similar downstream system.

---

## Version History Highlights

- **6.30 (230614):** Checked for number expansion logic.
- **6.36 (120521):** Added logic to fetch and convert alternative VAT codes.
- **6.37 (120521):** Added logic to fetch and convert alternative document codes.

---

## Key Takeaways for Developers

- The main function is to transform and enrich invoice line data for Zirius integration, using lookups and code mappings where required.
- The code is designed for maintainability, with business rules for code conversion externalized in tables.
- Pay special attention to the handling of account numbers and code conversion logic, as these are key to correct financial postings.
- The data structures are tightly packed and mapped to fixed positions, reflecting the requirements of the external Zirius interface.
- The codebase uses standard RPG conventions for file I/O, data area handling, and indicator-based error handling.

---

## Points of Attention

- If you need to change business rules for VAT or document codes, update the `RB00L1` or `RB10L1` tables, not the program logic.
- For new fields or changes to the Zirius interface, update the output record layout (`d_inpu`) and ensure all mapping logic is correct.
- If expanding dimension logic (`dim1`, `dim2`, etc.), follow the existing pattern and ensure all lookups are handled as needed.

---

For any questions about the business rules or integration with Zirius, consult the domain lead or business analyst associated with the ASOFAK system.