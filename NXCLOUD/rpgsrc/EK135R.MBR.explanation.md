# Program EK135R – Customer Bonus Maintenance – Parameter List

## Overview

This program (EK135R) is part of the ASOFAK system and is responsible for the maintenance of customer bonus parameters, with a focus on the generation of credit notes ("kreditnota"). It provides a display-based interface for entering, validating, and storing bonus-related parameters, such as bonus type, order type, item number, and period intervals. The program interacts with several master and transaction files, and leverages subprograms for lookups and data enrichment.

---

## File Usage and Relationships

- **ebkrl1 / ebkrlu**: Customer bonus parameter files (read-only and update versions). Used to read/update bonus parameters for a given firm.
- **vbotl1**: Bonus type master file.
- **votyl1**: Order type master file.
- **vvarl1**: Item master file.
- **EK135D**: Workstation display file (for user interaction).
- **Local Data Area (LDA)**: Used to retrieve user and firm context.

All master files are keyed by firm, and the specific parameter (bonus type, order type, or item number).

---

## Key Variables and Data Structures

- **Local Data Area (LDA)**: Used to fetch user (`l_user`), firm (`l_firm`), and firm name (`l_fnav`) for context and audit fields.
- **dspfbk**: Display feedback data structure for screen control (e.g., cursor position).
- **Working Variables**: Include fields for key values, periods, dates, times, and text fields for display and lookup results.
- **Indicator Usage**: The program uses traditional RPG indicators for screen and logic flow control (see comments in code for mapping).

---

## Screen and Input Handling

### Main Screen (P1WIN)

- **Fields**: Bonus type (`p1kbot`), order type (`p1koty`), item number (`p1kvar`), period from/to (`p1kfra`, `p1ktil`), and associated text fields.
- **User Actions**: The user can input parameters, request lookups (F4), and submit or exit.

---

## Program Flow

### Initialization (`*INZSR`)

- Reads the LDA to set the current firm and user context.
- Defines key lists for all file accesses.
- Initializes date/time variables.
- Pre-fills the screen with existing parameters if available by chaining into `ebkrl1`.
- Populates descriptive fields for bonus type, order type, and item if codes are present.

### Main Loop

1. **Screen Display**: The main window (`P1WIN`) is displayed for user input.
2. **Exit Handling**: If the user presses Cancel or F12, the program exits.
3. **Lookup Handling (F4)**: If F4 is pressed, the subroutine `sr_spor` is called to perform field-specific lookups using external programs:
   - **Bonus type**: Calls `VA565R`
   - **Order type**: Calls `VA550R`
   - **Item number**: Calls `VV500R`
   Each program is passed the firm and the relevant key, and returns a description for display.
4. **Validation**:
   - **Bonus type**: Must not be blank and must exist in `vbotl1`.
   - **Order type**: Must not be blank and must exist in `votyl1`.
   - **Item number**: Must not be blank and must exist in `vvarl1`.
   - **Period fields**: Must be non-zero and the "from" period must not be greater than the "to" period.
   - **Error Handling**: If any validation fails, the corresponding indicator is set (e.g., `*IN31`, `*IN32`, etc.), and the screen is redisplayed with error messages.
5. **Update/Create Parameter Record**:
   - Attempts to chain into `ebkrlu` (update file). If not found, clears the record.
   - Populates the record with current input values, audit information (user, date, time).
   - Updates or writes the record as appropriate.
6. **Post-Processing**:
   - Calls program `EK140C` (presumably to perform additional processing or recalculation after parameter update).
7. **Program Exit**:
   - Sets LR indicator and returns.

---

## Subroutines

### `sr_spor` (Lookup Assistance)

- Handles F4 (lookup) logic for each of the main input fields.
- Calls out to external programs to retrieve descriptions:
  - `VA565R` for bonus type
  - `VA550R` for order type
  - `VV500R` for item number
- Updates the corresponding description fields on the screen for user feedback.

### `*INZSR` (Initialization)

- Sets up key lists for all file accesses to ensure all chains are performed with the correct context.
- Loads the firm from LDA, sets date/time, and initializes the screen with current parameters if available.

---

## Business/Domain-Specific Logic

- **Bonus Maintenance**: The program is designed for maintaining bonus parameters for customers. This includes specifying which bonus type, order type, and item number the bonus applies to, along with the applicable period.
- **Credit Note Generation**: The parameters maintained here are likely used downstream for generating credit notes for customers based on sales/orders matching these criteria.
- **Multi-Firm Support**: All file accesses are firm-specific, supporting multi-company environments.
- **Audit Trail**: All updates are timestamped and attributed to a user, supporting traceability.

---

## Design and Coding Conventions

- **Indicator-Driven UI**: Uses classic RPG indicators for controlling screen flow and error messaging. Error indicators (31–35) map to specific field validations.
- **Externalized Lookups**: Rather than embedding lookup logic, the program delegates to specialized external programs (`VA565R`, `VA550R`, `VV500R`) for pop-up selection windows or field validation, promoting reuse and separation of concerns.
- **File Naming**: Files are renamed on the F-spec to clarify their role (e.g., `ebkrpfr:ebkrl1r`), a local convention for distinguishing between logical/physical files and their record formats.
- **Key List Usage**: Key lists are defined and reused for file access, ensuring consistent and maintainable key management across the program.
- **LDA Usage**: Firm and user context is consistently retrieved from the LDA, standardizing context handling across the system.

---

## External Dependencies

- **Programs Called**:
  - `EK140C`: Likely performs further processing after parameter update (details not shown).
  - `VA565R`, `VA550R`, `VV500R`: Lookup/selection programs for bonus type, order type, item number.

- **Data Area**:
  - LDA must be populated with valid firm and user information prior to running this program.

---

## Error Handling

- Field validation errors are flagged via indicators, with the corresponding screen fields highlighted or error messages displayed.
- All file accesses are guarded with `%found` checks to ensure data integrity and proper error reporting.

---

## Summary

EK135R is a parameter maintenance program for customer bonus rules, supporting entry, validation, and storage of bonus criteria per firm. It is tightly integrated with master data (bonus types, order types, items), and employs robust validation and lookup mechanisms. The program is designed for modularity, maintainability, and auditability, following established coding conventions within the ASOFAK system.