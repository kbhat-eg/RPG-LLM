# RPG Source Code Explanation: JM510R

This RPG program, named `JM510R`, is designed to **display campaign prices for an item** (vise kampanjepriser for vare). It is a classic ILE RPG (RPG IV) program using subfiles for interactive display and file maintenance.

## 1. Program Metadata and Documentation

- **Header (`H`) specifications**:  
  - `option(*nodebugio)`: No debug info for I/O operations.
  - `datedit(*dmy)`: Date fields are edited as day/month/year.
- **Comments** provide:
  - System/Program names.
  - History of changes (with references to version, date, and description).
  - Indicator usage, which is vital in classic RPG for controlling display and logic.
- **Indicators** (INxx):
  - LR: Last record, program end.
  - IN10, IN11, IN12, etc.: Various user actions like Roll, Rolldown, Display indicators, Home, Protect/lock fields, error notifications, and subfile control.

## 2. File Definitions

- **Physical/Logical files**:
  - `fjkavl3`: (Campaign Item Detail) file, renamed as `jkavl3r`.
  - `fjkahlr`: (Campaign Header) file, renamed as `jkahlrr`.
- **Display file**:
  - `fjm510d`: Display/workstation file with a subfile (`sfile(b1sfl:w_srrn)`).

## 3. Data Definitions

- **Parameters**:
  - `p_tek1` (description, 35 chars), `p_vare` (item, like `jmvvar`), `p_firm` (firm, like `jmvfir`).
- **Local Data Area**:
  - Used for temporary data, e.g., `l_fnav`.
- **Key Variables**:
  - For file access, e.g., `jkavl3_vvar`, `jkahlr_kamp`, `jkahlr_prgr`.
- **Working Variables** (subfile related):
  - `w_spge`: Subfile page size.
  - `w_srrn`: Current subfile record number.
  - `w_sfrn`, `w_ssrn`: Track first/last records on a page.
- **Constants**:
  - `c_sfil`: Subfile increment (default 14 records per page).

**Comment blocks explain each variable's purpose**, especially those related to subfile paging and control.

## 4. Subfile and Display Management

The program uses subfiles (paging lists on green screens):

- **B1SFL**: Subfile record format.
- **B2CTL**: Subfile control format.
- **B2CMD**: Command function-key display.

### Key Subfile Variables

- `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` help to manage paging, positioning, and records loaded into the subfile.

## 5. Mainline Logic

The program behaves as a display application with user input handling, typically launched from another menu/process.

### Main Steps:

1. **Initialization**
   - `*inzsr` subroutine:
     - Loads parameters (item, firm, text).
     - Sets up the primary and header file keys.
     - Populates initial subfile records.

2. **Display Loop**
   - `b2taga` and `b2tagb`: Tags for display flow.
   - Writes the command window (`b2cmd`).
   - Runs the subfile display subroutine (`dsp_subfile`).

3. **User Input Handling**
   - Handles F-keys, Roll/Down, and other standard actions:
     - `*inkc`, `*inkl`: Exit, goto `avslutt` (end program).
     - `*inke`: "Refresh" (calls `forny`, re-creates subfile).
     - `*in10`/`*in11`: Page up/down (calls subfile create/back routines).
   - After handling, loops back to display the refreshed subfile or exits.

4. **Exit (`avslutt` tag)**
   - Sets LR indicator ON and returns.

## 6. Subroutines

Each subroutine is clearly marked and documented:

### a. Subfile Refresh (`forny`)
- Positions to the correct file location.
- Calls `clr_subfile` to clear the old subfile.
- Calls `crt_subfile` to fill the subfile with fresh data.

### b. Subfile Clear (`clr_subfile`)
- Activates subfile clear indicator (`IN14`), writes control record.
- Resets all subfile working variables.

### c. Subfile Create (`crt_subfile`)
- Increases paging variables.
- Reads records from the campaign item file (`jkavl3`).
- For each record:
  - Fills subfile fields from file record.
  - Looks up description in header (`jkahlr`), if found, fills it in.
  - Writes the record to the subfile (`b1sfl`).
- Updates page tracking variables.

### d. Subfile Back (`bck_subfile`)
- Placeholder for page-up logic (currently empty).

### e. Subfile Display (`dsp_subfile`)
- If the subfile has records, activates display indicator and shows control.
- If no records, re-displays the command window.
- Waits for user input (`exfmt b2ctl`).
- Turns off display indicators afterwards.

### f. Initialization (`*inzsr`)
- Reads program parameters for firm, item, and description.
- Sets up file key lists for access.
- Sets display fields.
- Positions to the correct record and loads the first page of the subfile.

## 7. Key RPG Features

- **Subfile handling** is centralâ€”allowing users to browse campaign pricing.
- **Indicators** control all aspects of display and function key handling.
- **Modular**: Uses subroutines (`begsr` / `endsr`) for clear logic separation.

## 8. Special Notes

- **Data Naming** (prefixes):
  - `b1*`, `b2*` for subfile and control fields.
  - `jmv*`, `jmk*`, etc., map to fields in the campaign detail/header files.
- **Expansion**:
  - Comments show ongoing enhancements, like extension from 1- to 2-position price groups (PRG2).

---

## Summary

**JM510R** is a display program showing item campaign prices using a subfile/paging mechanism. It takes parameters (firm/item/description), sets up paging in a green-screen UI, and responds to user function keys for paging and actions. Most code revolves around handling subfiles, populating data, and managing user navigation, all classic patterns in legacy IBM RPG display programs.