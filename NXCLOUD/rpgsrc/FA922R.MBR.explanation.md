# Program Overview

This RPG program, named **FA922R**, is used to update the memo balance (*memosaldo*) in the customer register. It is structured for the IBM i (AS/400) platform, using the ILE RPG language. The program's primary function is to update (or create) a memo balance record for a customer, based on input parameters and business logic defined in several files (tables).

---

## Key Features and Change History

- Maintains and updates memo balances for customers.
- Creates new customer memo balance records if none exist.
- Applies sign reversal for amounts based on order type settings.
- Tracks changes for audit (user, date, time, etc.).
- Extended over time (see the change comments) for new business rules, more files, and better logging.

---

## Main Files

- **rkunlu / rkmelu**: "Kunde-register" (Customer Register) and "Memosaldo" (Memo balance) files, with physical/logical files renamed in the program for clarity.
- **votyl1**: "Ordretype-register" (Order Type Register), contains configuration for order types.

---

## Parameters and Variables

- **Parameters** (received at program entry):
    - `p_firm`: Company code/number.
    - `p_otyp`: Order type.
    - `p_kund`: Customer number.
    - `p_sald`: Memo amount to modify.
    - `p_sal2`: Alternate memo amount (added in version 5.60).

- **Work variables**:
    - `w_firm`: Firm number, used for key construction.
    - `l_user`: User from the local data area (for tracking who updated).

- **Key variables**:
    - `rkunlu_kund`, `votyl1_otyp`: Used in building file keys.

---

## Program Flow

### 1. Initialization (`*inzsr` Subroutine)
- Defines the key lists for customer and order type files.
- Reads parameters from the caller (previous program or command).
- Sets the firm/work variable (`w_firm`).

---

### 2. Main Logic

#### a. Order Type Lookup

```rpg
c                   eval      votyl1_otyp = p_otyp
c     votyl1_key    chain     votyl1r                            90
```
- Looks up the order type info for the given company/order type.
- If no such order type found, error indicator *IN90 is set.

#### b. Logic Control by Order Type

```rpg
c                   if        vaoogr = 0
c                   goto      xslutt
c                   endif
```
- If a specific field (`vaoogr`, e.g., order value code) is zero, the logic is aborted (program ends).

#### c. Amount Sign Control

```rpg
c                   if        vaokre <> *blank
c                   eval      p_sald = p_sald * -1
5.60 c                   eval      p_sal2 = p_sal2 * -1
c                   endif
```
- If a flag (`vaokre`) is non-blank, flips the sign of the memo amount (and alternate amount).
- This supports business logic where certain order types require credit/debit to be reversed.

#### d. Memo Balance Update

- Attempts to chain (lookup) the customer record.

```rpg
c                   eval      rkunlu_kund = p_kund
6.20 c     rkunlu_key    chain     rkmelu                             90
```
- If found, updates the memo amounts, date, time, and user tracking fields, then writes the update:

```rpg
c                   if        *in90 = *off
c                   eval      rkmems = rkmems + p_sald
5.60 c                   eval      rkmema = rkmema + p_sal2
6.20 c                   time                    rkmeda
6.20 c                   time                    rkmeti
6.20 c                   eval      rkmeus = l_user
6.20 c                   update    rkmelur
```

- If not found (`*IN90 = *on`), it clears a new record, fills in keys/fields, and writes a new record:

```rpg
c                   else
c                   clear                   rkmelur
c                   eval      rkfirm = w_firm
c                   eval      rkkund = p_kund
c                   eval      rkmems = rkmems + p_sald
c                   eval      rkmema = rkmema + p_sal2
c                   time                    rkmeda
c                   time                    rkmoda
c                   time                    rkmeti
c                   time                    rkmoti
c                   eval      rkmeus = l_user
c                   write     rkmelur
c                   endif
```
- This logic ensures every customer gets a memo balance record, and writes auditing info.

---

### 3. Program End

- Execution reaches the label `xslutt` (exit), sets on the Last Record indicator (`*INLR`) and returns, ending the program.

---

## Subroutines and Other RPG Features

- **Key lists (KLIST/KFLD)** are used to prepare multi-field keys for chaining/looking up in files.
- **PLIST/PARM** is used to define a parameter list for program calls.
- **LDA (Local Data Area)** is accessed for user audit information.
- **Date and Time** built-in functions (`time`) are used to stamp records.

---

## Summary Table

| Section              | Purpose                                           |
|----------------------|--------------------------------------------------|
| File Declarations    | Define access to customer/order type tables       |
| Parameter/Vars       | Capture call input, build keys, hold state       |
| Initialization       | Load parameters, prep keys                       |
| Main Logic           | Find order type, decide business rule to apply   |
|                      | Possibly reverse sign on amount                  |
|                      | Update or create memo balance in customer file   |
|                      | Audit (user, date, time) on every change        |
| Program End          | Clean exit, release resources                    |

---

## Key Business Rules

- **Order type controls memo update direction and sign.**
- **Memo balances are always consistent—no record means one is created.**
- **Audit fields (who, when) are always filled for traceability.**
- **Everything works on supplied parameters for flexibility (company, customer, order type, amount).**

---

### Developer Onboarding Notes

- The program depends on physical and logical files (`rkunlu`, `rkmelu`, `votyl1`).
- Entry parameters must match those declared in the *entry PLIST.
- If integrating or modifying, check audit and update logic carefully.
- Extensions (historically) have been added for new business features—coordinate with business analysts if changing core transaction or audit logic.
- The code is well-documented inline, with changes and business logic clearly commented.

---

**In summary:**  
This program updates (or creates) customer memo balances based on order type logic, handling sign reversals, and ensuring full audit-trail information for every change. It's driven by parameters and thus is reusable and modular within the ERP system.