# Program Overview

This ILE RPG program, named `FD510R`, is designed to **copy item/order lines from one order to another** in a business/order-processing application. It is a screen-based (workstn) program running on IBM i (AS/400), utilizing subfiles for the user interface, SQL for database access, and several physical files for order, invoice, and product (item) data.

## Main Features

- **Copy order lines** between orders, including from historic (invoiced) or open orders.
- **Handles special cases:** "skaffevare" (special order items), accumulator orders (types that also post to the warehouse), and extra price group logic.
- **Uses subfiles** to display/select lines for copying.
- **Calls other programs** for warehouse updates and messaging.

---

# Structure Breakdown

## File Declarations (`F-specs`)

- **Order and invoice tables:**
  - `fodtl1`, `fodtlur`, `fodtlrr`: Current order lines (various access paths)
  - `fohel1`: Order headers
  - `sodtl1`, `sodtlur`: Historical invoice/order lines
- **Product master:** `vvarl1` (special items)
- **Display file:** `fd510d` (with subfile for records: `b1sfl`)

## Data Structures and Variables (D-specs)

- **Parameters:** Order numbers, item codes, etc.
- **Local Data Area:** User/firm identifiers.
- **Key variables:** For building file keys.
- **Working variables:** For subfiles, screen page handling, totals calculation, warehouse/stock transfers, etc.
- **Data structure for warehouse update:** For passing details to stock update programs.
- **Other:** SQL query buffers, flags, calculation variables.

## Key Notions

- **Indicators:** RPG uses numbered indicators for controlling flow — 10/11 (roll up/down), 12–15 (subfile control), 30–99 (messages/flags).

---

# Main Logic Flow (C-specs)

### 1. **Startup/Initialization**

- Reads user, firm, new and old order numbers from parameters/LDA.
- Sets up keys for all relevant files.
- Prepares the SQL for reading order/invoice lines.
- Fills the subfile for display.

### 2. **Subfile UI/Screen Control**

- Writes/refreshes subfiles and control screens.
- Handles:
  - Function keys (exit, refresh, next page, positioning, etc.)
  - Subfile paging/scrolling
  - Subfile record selection

### 3. **Core Functions (Subroutines)**

- **`crt_subfile`**: Prepares SQL, opens a cursor, fetches lines for the subfile (order or invoice depending on presence).
- **`subfile`**: Processes user input: if a line is selected (quantity entered), triggers copy logic.
- **`kopier_ordre`/`kopier_faktu`**: Copy a selected line from order or invoice to a new order:
  - Gets the next available line number
  - FETCHES the source record
  - Populates target order fields
  - Recalculates totals (with discounts, etc.)
  - Handles "skaffevare" logic (special order items)
  - Optionally calls other programs for warehouse updates or messaging.
- **`hent_linjenr`**: Gets the highest line number on the target order.
- **Other subroutines:** Clear/refresh subfiles, position in lists, etc.

---

# Special Logic and Business Rules

## Skaffevare Handling (Special Order Items)

- Checks if the item is a "skaffevare" (not normally stocked, special order)
- If so, alerts the user (calls `AA005R` with a message)
- Updates flags to indicate if the item remains a "skaffevare" or has become a regular item.

## Warehouse/Inventory Update

- If the order type is of a specific accumulator type (value 2), triggers a call to program `VL001R` for warehouse posting.
- Builds a data structure (`hlrec`) with all needed info for the warehouse transaction.

## Discounts/Prices Calculation

- For copied lines, recalculates totals:
  - Uses price, discount, rebate fields
  - Applies several levels of discounts (`fdrab1`, `fdrab2`, `fdbrr1`, `fdbrr2`)
  - Calculates sums (gross amount, discounts, net amount)

## Flexibility: Source can be invoice or order

- If the order lines are not found (not an open order), switches to fetching lines from historic invoices.

---

# SQL Handling

- Dynamic SQL is used for fetching lines:
  - Constructs queries at runtime with "where" clauses controlling which order/bin/year/etc.
- Cursors are used for iterative fetch into subfile records.

---

# Subfile/Paging

- Subfiles are used for showing selectable lists of lines.
- Paging, clearing, and refreshing are handled manually to support rapid user interaction.

---

# External Program Calls

- **Warehouse posting:** `VL001R`
- **Vendor info retrieval:** `VV710R`
- **User message:** `AA005R`

---

# Key Business Objects

- **Order** (`fodtl*`): Open order lines
- **Historic order/invoice** (`sodtl*`): Shipped/invoiced lines
- **Product master** (`vvarl1`): Used to check for "skaffevare" status

---

# Comments and Change Log

The code is well-commented (in Norwegian), including a historical change log indicating its evolution and enhancements.

---

# Takeaways for New Developers

- **Understand RPG indicators** and subfile handling — these are the backbone of the UI.
- **Familiarize yourself with the file structure** (`fodtl*`, `sodtl*`, `vvarl1`, etc), as all logic pivots around reading/writing these physical files.
- **Note use of external programs** for specialized functions (stock, vendor info, messages).
- **Business rules** are tightly coupled to Norwegian terminology ("skaffevare", etc) — clarify with business users if in doubt.
- **SQL usage is dynamic and context-sensitive:** Know when and why the code switches from order to invoice data sources.
- **Modular logic:** Each business action (copy, alert, recalc, etc) is split into its own subroutine — follow the call chain to understand processing for each user action.

---

# Key Sections of Interest

- **File and Data Structure Declarations:** Sets up the entire program context.
- **Subfile Handling:** The user interface for this program.
- **Copy Subroutines (`kopier_ordre`, `kopier_faktu`):** The “business heart” — copying and transforming order/invoice data.
- **Special Case Handling:** Skaffevare, warehouse update, messaging.

---

# Summary Pseudocode

```
On program start:
    - Read input params: source & target order numbers
    - Initialize file keys, user, and firm info from LDA
    - Prepare the display (subfile) with lines to copy

Screen loop:
    - Present subfile with lines (using dynamic SQL to fill subfile from order/invoice)
    - User selects lines and enters quantities
    - For each line selected:
        - Copy line to target order (calculate new line#, recalc totals, apply discounts)
        - If skaffevare, alert user
        - If accumulator/warehouse update needed, call stock update program
        - Update subfile to reflect processing
    - Loop until exit key pressed
```

---

# Final Notes

This program is a classic example of a **transaction-oriented RPG application** with an interactive subfile-based UI, dynamic SQL selection, modular business logic, and extensive integration with external programs. Understanding this code provides a solid foundation for maintaining and enhancing similar RPG applications on IBM i.