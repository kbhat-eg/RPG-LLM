```markdown
# RPG Program VE723R – GTIN Lookup by Product, Unit, and Supplier

## Purpose and Context

This RPG program (`VE723R`) is designed to retrieve a GTIN (Global Trade Item Number) for a given combination of company (firma), supplier (leverandør), product (varenr), and unit (enhet). The main goal is to find the GTIN based on these keys using a prioritized logic, referencing various files (tables) for information. The output consists of the GTIN (`p_eann`) and a status flag (`p_stat`, set to `'1'` if successful).

It is based on an earlier program (`VE713R`) and is tailored for specific business needs.

---

## File Declarations

```rpg
fvvarlr    if   e           k disk    rename(vvarpfr:vvarlrr)
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvveplr    if   e           k disk    rename(vveppfr:vveplrr)
fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
fjvpkl1    if   e           k disk    rename(jvpkpfr:jvpkl1r)
fjlevl3    if   e           k disk    rename(jlevpfr:jlevl3r)
```
- These lines define the files that the program will use and the record formats to be used for each. The `rename` keyword connects each file to a specific record format.

---

## Data Structure and Variables

Variables are established to facilitate key operations for CHAIN and READE statements, ensuring correct handling of input and output fields. Most variables are defined as having the same type/length as a field in one of the files (`like(xxxx)`), promoting type safety.

Example:
```rpg
d vvarlr_firm     s                   like(vvfirm)
d p_firm          s                   like(vepfir)
d p_stat          s              1
```

---

## Parameters

Parameters for the program (passed in via *ENTRY):
- `p_firm`: Company number
- `p_ldor`: Supplier number
- `p_lage`: Warehouse/location
- `p_vare`: Product number
- `p_enhe`: Product unit
- `p_eann`: Output – GTIN number
- `p_stat`: Output – status (‘1’ = found)

---

## Main Logic Overview

### Initialization

- Output parameters are set to default:
    - `p_eann = 0`
    - `p_stat = *blank`

### Step-by-Step GTIN Retrieval Logic

The program attempts to find the GTIN with the following prioritized logic:

1. **Find Product in Master File (VVAR):**
   - CHAINs into `vvarlr` using company and product.
   - If not found, jumps to `VA` handling (`sjk_VA`).

2. **Find GTIN with Given Unit and Supplier (VVEP):**
   - CHAINs into `vveplr` using company, product, unit, and supplier.
   - If found and GTIN is nonzero, outputs it and exits.

3. **Fallback: Supplier from Warehouse (VLAG):**
   - CHAINs into `vlagl1` with product and warehouse.
   - If found, retries in `vveplr` with the supplier from the warehouse record.
   - If found and GTIN is nonzero, outputs it and exits.

4. **Fallback: Supplier from Product Master:**
   - Retries `vveplr` with supplier taken from the product master.
   - If found and GTIN is nonzero, outputs it and exits.

5. **As Last Resort: Ignore Supplier, Check by Unit in VVEP:**
   - Reads through `vveplr` records by company, product, unit.
   - For any record with nonzero GTIN, outputs it and exits.

6. **If not found in V-registered files, handle “VA” (other product administration):**
   - `sjk_VA`: CHAIN into VA product table.
   - If not found, exit.

7. **VA GTIN Handling:**
   - Lookup in VA package/GTIN register (JVPK), prioritizing matches on supplier and unit.
   - If not found, scan for any GTIN for product/unit, ignoring supplier.
   - If found, outputs it and exits.

8. **End/Return:**
   - Always sets *INLR (last record indicator) to *ON for program closure.

---

## Subroutine *INZSR (Initialization Logic)

- Handles *ENTRY parameter list population.
- Key lists (`KLIST`) are established for CHAIN/READE operations throughout the program.
- Attempts to resolve a possible override for the supplier code to use, by CHAINing into the VA supplier table (`jlevl3`).

---

## Key Prioritization Summary

1. Strict match on all: company, product, unit, supplier.
2. Falls back to supplier from warehouse or product master if direct match fails.
3. If no supplier match, tries to find GTIN for product/unit only.
4. If all product tables fail, repeats similar logic in VA subsystem.

---

## Important RPG Techniques Used

- **CHAIN**: Retrieves a single record based on a composite key.
- **READE**/**SETLL**: Reads sequentially from point in index.
- **KLIST/KFLD**: RPG methods for defining composite keys for CHAIN/READE.
- **GOTO/TAG**: Used for program flow control (modern RPG would use structured logic).
- **%FOUND/%EOF**: RPG built-in functions to test I/O operations.
- ***INLR**: Ensures program closes files and ends properly.
- **%ENTRY / PLIST / PARM**: Classic style for parameter handling.

---

## Comments/Other Notes

- Much of the code is written in a classic, column-based RPG IV style.
- Extensive use of Norwegian variable/field names and comments, but business logic is clear from context.
- Use of `goto` and tags is typical in older RPG but discouraged in modern code.

---

## Summary Table

| Step | Source Table/File | Lookup Key Components                | Purpose/Action                |
|------|-------------------|--------------------------------------|-------------------------------|
| 1    | VVAR              | Company, Product                     | Validate product, continue    |
| 2    | VVEP              | Company, Product, Unit, Supplier     | Find matching GTIN            |
| 3    | VLAG              | Product, Warehouse                   | Get supplier from warehouse   |
| 4    | VVEP              | Company, Product, Unit, Master Suppl | Try master supplier           |
| 5    | VVEP              | Company, Product, Unit               | Ignore supplier, any GTIN     |
| 6    | JVAR (VA)         | Product                              | VA subsystem, as fallback     |
| 7    | JVPK (VA)         | Product, (Supplier), Unit            | VA GTIN match                 |

---

## Typical Use

Called by other programs or procedures needing to retrieve a GTIN for a specific product/unit/supplier context, ensuring logic for various fallbacks is applied consistently.

---

## Key Output

- `p_eann`: Found GTIN, or 0 if not found.
- `p_stat`: '1' if GTIN found, blank otherwise.
```
