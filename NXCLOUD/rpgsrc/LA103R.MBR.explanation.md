# RPG Program: LA103R (ASLAGR system)  
## Description  
This program, **LA103R**, is designed for the maintenance of status codes and order types ("Vedlikehold av status-koder, Ordretyper") in an IBM i (AS/400) environment. The program is written in ILE RPG (report program generator) and uses several files, data structures, and standard RPG constructs. Comments are a mixture of English and Norwegian.

This walkthrough explains its structure and functionality for an RPG developer.

---

## Global Specifications

### Header Specifications
```rpg
h datedit(*dmy) option(*nodebugio)
```
- **datedit(*dmy):** Sets the default date format to DD/MM/YY.
- **option(*nodebugio):** Disables debug support for file I/O.

---

### File Specifications
```rpg
flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
flstslu    uf a e           k disk    rename(lstspfr:lstslur)

fla103d    cf   e             workstn
```
- **lstsl1**: Input-only, external, keyed disk file. Renamed record format `lstspfr` → `lstsl1r`.
- **lstslu**: Update, full procedural, add, external, keyed disk file. Record format `lstspfr` → `lstslur`.
- **la103d**: Display file, used for workstation I/O.

---

### Data Definitions

#### Local Data Area
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Uses the **user data structure** (UDS), mapping data from the local data area (LDA).
- **l_user**: User ID
- **l_firm**: Firm number
- **l_fnav**: Full name, or possibly navigation name

#### Program Variables
```rpg
d w_firm          s                   like(laafir)
```
- **w_firm**: Work variable, same data type as the database field `laafir`.

---

## Main Program Logic

### Labels and Tags

#### a1taga
```rpg
c     a1taga        tag
```
Defines a label/tag (for GOTO or similar referencing).

---

### Retrieve Data from "LAGER-KODE-REGISTER"
```rpg
c     lstsl1_key    chain     lstsl1
c                   if        %found
c                   eval      a1ot02 = laaot2
...
c                   else
c                   eval      a1ot02 = *blank
...
c                   endif
```
- Retrieves a record from file **lstsl1** using a key defined at the bottom (`lstsl1_key`).
- If found: Loads values from database fields (`laaot2-5`) into display/input/output fields (`a1ot02-5`).
- If not found: Sets these fields as blank.

---

### Display the Screen
```rpg
c                   exfmt     a1bld
```
- Shows the screen format **a1bld** (likely defined in display file **la103d**), prompting for user input.

---

### Function Key Handling
```rpg
c                   if        *inkc = *on
c                   goto      pgm_end
c                   endif
```
- Checks if function key F3 ("Avslutt", or "Exit") was pressed. If so, jumps to program end.

---

### Update "LAGER-KODE-REGISTER"

```rpg
c     lstslu_key    chain     lstslur
c                   eval      laaot2 = a1ot02
...
c                   if        %found
6.10 c                   time                    laaeda
6.10 c                   time                    laaeti
6.10 c                   eval      laaeus = l_user
c                   update    lstslur
c                   else
c                   eval      laafir = w_firm
6.10 c                   time                    laaoda
6.10 c                   time                    laaoti
6.10 c                   eval      laaous = l_user
6.10 c                   time                    laaeda
6.10 c                   time                    laaeti
6.10 c                   eval      laaeus = l_user
c                   write     lstslur
c                   endif
```
- **CHAIN** reads a keyed record from **lstslu**.
- Copies user-edited values (`a1ot02-5`) to corresponding database fields (`laaot2-5`).
- If the record exists:
  - Updates "edited" timestamp (`laaeda`, `laaeti`) and user fields (`laaeus`).
  - Writes back updated record (**UPDATE**).
- If not found:
  - Copies firm info (`laafir`), sets "created" and "edited" info, with associated timestamps (`laaoda`, `laaoti`, etc.), and user fields.
  - Writes new record (**WRITE**).

---

### Program End

```rpg
c     pgm_end       tag
c                   eval      *inlr = *on
c                   return
```
- Label for program termination.
- Sets *INLR (last record indicator) to ON, closing files and freeing resources.
- Returns from the program.

---

### *INZSR: Initialization Subroutine

```rpg
c     *inzsr        begsr
c     lstsl1_key    klist
c                   kfld                    w_firm
...
c                   eval      w_firm = l_firm
c                   endsr
```
- Runs at program start.
- Defines **KLIST** (key lists) for both input and update files, using **w_firm** as the key field.
- Sets **w_firm** to the value from LDA field **l_firm**.

---

## Summary Table

| Area                | Function                                                                                  |
|---------------------|------------------------------------------------------------------------------------------|
| File specs          | Opens, renames, and sets mode for database and display files.                            |
| LDA fields          | Maps user, firm, and name from system local data area.                                   |
| *INZSR subroutine   | Prepares key fields for file access, initializes work variable with the firm's value.     |
| Main logic          | - Retrieves (CHAIN) record based on firm key.<br>- Displays input screen.<br>- Handles F3 exit.<br>- Updates (UPDATE/WRITE) the record with new user values and audit info. |
| Audit fields        | Maintains timestamps and user info on create and update (fields: laaoda, laaoti, laaeda, laaeti, laaous, laaeus). |

---

## General Flow

1. **Initialization**:
    - Loads the firm number from LDA and prepares key lists.
2. **Record retrieval**:
    - Tries to load an existing status/order type for the firm.
    - Prepares screen fields with existing or blank data.
3. **User interaction**:
    - Presents the screen for maintenance.
4. **Exit or Update**:
    - If F3 pressed, exits.
    - Otherwise, updates or creates the record, capturing create/edit user and timestamps.
5. **Repeat/End**:
    - Loops or ends program based on user action.

---

## Audit and Logging

- This program adds tracking information (user/timestamp) on both new records and updates, as per the change log.

---

### For New Developers

- **Display file fields (a1ot02–a1ot05, a1bld)** correspond to status/order code values on the screen.
- **Database fields (laaot2–laaot5)** are where these values are stored in the order type/status code register.
- **Keying is always by firm (`w_firm`/`l_firm`).**
- **All maintenance is logged with user info from the LDA and current timestamps.**
- **Program structure is typical for simple RPG maintenance screens:**
  - *Chain* to get
  - *Edit* on screen
  - *Update/Write* with audit fields

---

**Tip:** Review the associated display file (`la103d`) and database file definitions for fuller context on fields and valid codes. 

---

Let me know if you need elaboration on a specific section or further translation of the Norwegian comments!