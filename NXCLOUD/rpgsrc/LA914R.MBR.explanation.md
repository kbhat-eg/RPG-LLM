# RPG Program LA914R – Year-End Inventory Reset

This RPG program is designed to reset inventory counters at the end of the year ("Nullstiller lager") for a system called ASLAGR. The code is mostly in fixed-form RPG IV (ILE RPG) with some comments in Norwegian.

---

## 1. Header and Metadata

```rpg
 h datedit(*dmy) option(*nodebugio)
```
- `datedit(*dmy)`: Dates are in Day-Month-Year format.
- `option(*nodebugio)`: Disables debug I/O for performance.

The following block is purely documentation, describing the program name (`LA914R`), description, and change history.

---

## 2. File Declarations

```rpg
 flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
 fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
 fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
```
- Declares three physical files:
    - `lstsl1`: Status code file for inventory (renamed to `lstsl1r`).
    - `vlaglu`: Inventory register update file (renamed to `vlaglur`).
    - `vlagl1`: Inventory register file (renamed to `vlagl1r`).
- `i` = Input, `u` = Update, `f` = Full procedural (user controlled I/O), `e` = External format, `k` = Keyed file.

---

## 3. Data Structure Declarations

### Parameters

```rpg
 d                 ds
 d d_prec                        64
 d  d_val1                        1  0 overlay(d_prec)
 d  d_val2                        1  0 overlay(d_prec:2)
 d  d_val3                        1  0 overlay(d_prec:3)
 d  d_val4                        1  0 overlay(d_prec:4)
```
- `d_prec`: 64-byte input parameter block.
- `d_val1`, `d_val2`, ... overlays: Individual single-digit parameters extracted from `d_prec` for easy access.

### Local Data Area

```rpg
 d                uds
6.10 d l_user                911    920
 d l_firm                944    946  0
```
- Accesses user data area (LDA). `l_user` and `l_firm` are extracted from specific positions.

### Variables for Keys

```rpg
 d vlaglu_vare     s                   like(vlvare)
 d vlaglu_lage     s                   like(vllage)
 d vlagl1_vare     s                   like(vlvare)
 d vlagl1_lage     s                   like(vllage)
```
- Holds keys for working with inventory records (product and warehouse fields).

### Other Variables

```rpg
 d w_firm          s                   like(laafir)
 d w_parm          s             64
```
- `w_firm`: Working variable for company number.
- `w_parm`: Local copy of the 64-byte parameter input.

---

## 4. Main Logic

### a. Initialize

```rpg
 c                   eval      vlagl1_vare = *blank
 c                   eval      vlagl1_lage = 0
 c     vlagl1_key    setll     vlagl1r
```
- Prepares to loop through all records in `vlagl1r` (the inventory register), starting at the beginning.

### b. Main Loop: Read Each Inventory Record

```rpg
 les_neste     tag
 C                   read      vlagl1r                                90
 c                   if        *in90 = *on
 c                   goto      end_pgm
 c                   endif
```
- Tries to read the next record using the `vlagl1_key`.
- If EOF (`*in90`), jump to program end.

### c. Update Inventory Register

```rpg
 c                   eval      vlaglu_vare = vlvare
 c                   eval      vlaglu_lage = vllage
 c     vlaglu_key    chain     vlaglu                             90
 c                   if        *in90 = *off
 c                   eval      vlinng = 0
 c                   eval      vlutta = 0
 c                   eval      vljust = 0
 c                   eval      vlsalg = 0
 c                   eval      vlretu = 0
 c                   eval      vlbeve = 0
 c                   eval      vltell = 0
 c                   eval      vlatel = 0
```
- Looks up the corresponding "update" inventory record.
- If found, resets all counters/fields (input, output, adjustments, sales, returns, movement, counts, etc.) to zero.

#### Conditional Copy

```rpg
 c                   if        d_val3 = 1
 c                   eval      vlb101 = vlbehl
 c                   endif
```
- If the 3rd parameter value equals 1, `vlb101` is set to value of `vlbehl` field.

#### Timestamp and User

```rpg
6.10 c                   time                    vledat
6.10 c                   time                    vletim
6.10 c                   eval      vleusr = l_user
 c                   update    vlaglur
```
- Updates date/time/user info on the inventory record.
- Commit the changes with `update`.

### d. Loop

```rpg
 c                   goto      les_neste
```
- Go back and read the next inventory record.

---

## 5. Program Termination

```rpg
 end_pgm       tag
 c                   eval      *inlr = *on
 c                   return
```
- Closes files and ends the program properly.

---

## 6. Initialization Subroutine (`*inzsr`)

- Builds key lists for file I/O.
- Accepts input parameter (`w_parm`) and moves it to `d_prec` for easy access.
- Sets working company number (`w_firm` from `l_firm` in LDA).
- Chains to inventory status code file using the company key to pull startup info.

---

## 7. Summary

**Purpose:**  
This program loops through all inventory records for a company, resetting annual counters (like movements, sales, returns, and cycle counts) to zero—typically performed at year-end. It tracks changes by writing date, time, and user info and allows some behavior modification via a parameter string.

**Key Techniques Used:**
- File I/O using keyed files.
- Overlaying data structures to parse input parameters.
- Reading user and firm info from the LDA.
- Encapsulating initialization in a subroutine.
- Looping and EOF handling.

**Customization:**  
The logic is guided via a 64-byte parameter and can be adjusted for special needs (as seen with the conditional update based on `d_val3`).

**Comments and Structure:**  
All major areas are commented in Norwegian, and the code follows a clean, modular structure to allow for easy extension and maintenance in an enterprise environment.