# RPG Program Explanation – GL321R

## Program Purpose and Context

This program, `GL321R`, is written in ILE RPG and is part of a system named "ASOKON". Its core purpose is to maintain file names for communication with banks—specifically file naming conventions for sending/receiving files ("Navnsetting av filer til/fra banken"). It interacts with both a database file (`GPCFPF`) and a workstation display file (`GL321D`). The program’s UI and data flow are designed around managing filenames for multiple file types involved in bank interactions.

## High-Level Structure

1. **Header and Metadata:** Title, system and program name, change history, indicator usage, and comments explain the logic of indicators and the program's position in the system.
2. **File Declarations:**
   - `GL321D` (workstation, display file).
   - `GPCFPF` (database file, keyed and update-capable).
3. **Data Structures & Variables:**
   - `LDA` user space (local data area).
   - Several working variables for filenames and positions.
4. **Mainline Logic:** Structured with RPG tags (`tag`) and processing blocks.
5. **Entry Parameters:** `wpffgr`, `wpffir`, `wpkomm` (file group, firm, and communication type).
6. **Display I/O:** Screens for user entry/maintenance.
7. **File I/O:** Chain, update, and write logic for `GPCFPF` records.
8. **Program End and *INZSR:** Initialization and exit routines.

---

## Key Details, Sections, and Logic

### 1. **File and Data Declarations**

```rpg
fgl321d    cf   e             workstn
fgpcfpf    uf a e           k disk
```
- **gl321d:** Workstation file for display screens.
- **gpcfpf:** Update file, accessed by key, holds persistent file name data.

### 2. **Indicators**

- **KC (F3):** Exit program.
- **KL (F12):** Cancel/annul (not shown in mainline code).
- **LR:** Flag to end the program.
- **31-59:** Error/notification indicators.
- **60-69:** File operation indicators (e.g., if a CHAIN fails).

### 3. **Data Structures and Working Variables**

- **LDA data structure:** Used to retrieve and store context data, e.g., `l_fgrp`, `l_firm`, etc.
- **Work variables:** For file names, overlaying pos9 to check max length, etc.

```rpg
d w_navn                        20
d  w_pos9                        1    overlay(w_navn:9)
```
Here, `w_pos9` overlays the 9th character of `w_navn` to check if a filename exceeds 8 characters.

### 4. **Main Processing Logic**

#### **Initialization – *INZSR**

- Receives entry parameters (`wpffgr`, `wpffir`, `wpkomm`).
    - `wpffgr` = file group
    - `wpffir` = firm code
    - `wpkomm` = communication type (e.g., "PC" enforces filename length limits)
- Sets key fields for file lookup.

#### **Main Screen Interaction**

- **Record Fetch:**
    - Tries to `CHAIN` (keyed fetch) record from `GPCFPF` using key `key01`.
- **Screen Population:**
    - If not found (`*IN60 = *on`), screen fields are blanked.
    - If found, existing values are loaded onto the screen.
- **User Input:**
    - Interacts with the user (`EXFMT a1win`), presenting/asking filenames.

#### **Exit Handling**

- If F3 is pressed (`*INKC`), program terminates.

#### **Validation for PC Type**

- If communication type = "PC", all file names must be ≤ 8 characters.
    - For each file name field, validates if any character after the 8th (at position 9) is non-blank. If so, sets error indicator (`*IN30`) and redisplays the screen.

#### **Record Update or Insert**

- After validation, does a `CHAIN` on `GPCFPF`.
    - If record not found (`*IN60 = *on`): uses `WRITE`.
    - If found: uses `UPDATE`.

#### **Program End**

- Sets last record indicator (`*INLR`) and returns.

---

## Step-By-Step Flow

1. **Initialization**
    - Receives parameters (file group, firm, comm type).
    - Loads key fields and other vars.
2. **Fetch Record**
    - Try to get the record for the specified group+firm.
    - If not found, blank the fields.
    - If found, load their values for display.
3. **Display Screen**
    - Shows screen where user edits/enters file names.
    - Waits for input or function key (e.g., F3 to exit).
4. **Validation (PC Type)**
    - On PC comm type, all filenames are checked for >8 chars.
    - If any fails, sets error, loops back to screen.
5. **Write Changes to Data**
    - Either writes a new record or updates existing record in `GPCFPF`.
6. **Exit**

---

## Notable Techniques & RPG Idioms

- **OVERLAY Keyword:** Used in data structure to check for overflow in filenames (for 8-char limit).
- **CHAIN with Indicators:** Classic indexed file read for RPG, with indicator (e.g., 60) for not found handling.
- ***INLR:** To end and release resources.
- **Screen File EXFMT:** Standard display file I/O cycle.
- **Parameter Entry via *ENTRY PLIST:** RPG III/400 idiom for external call parameter list (like procedure arguments).

---

## Business Rules Captured

- Allows maintenance of up to 7 different file naming fields, mapped to banking routines (remittance, reception, clearing, OCR, etc.).
- For "PC" comm type, enforces "8.3" file name restrictions (no more than 8 characters before extension).
- Allows both creation (write) and update depending on existence of the file group+firm record.

---

## Summary Table

| Section            | Description                                                                                                                                      |
|--------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| Header             | Documentation, change log, indicator usage, screen and file names.                                                                               |
| Files              | `GL321D` (display), `GPCFPF` (database).                                                                                                        |
| Fields             | Group, firm, filenames for various transaction types.                                                                                            |
| Main Flow          | Init → Fetch/Display → User Input → Validate (length if PC type) → Write/Update record → Exit.                                                   |
| Error Handling     | Redisplay screen if validation fails. Exit on F3.                                                                                                |
| RPG Idioms         | Use of indicators, overlays, data structures, and file/block I/O.                                                                               |

---

## Tips for New Developers

- **Understand Indicator Usage:** Indicators drive flow (file not found, error display, F3/F12, etc.).
- **Parameter Mapping:** Entry parameters are critical for context (what group/firm/type to process).
- **Validation Logic:** Especially important for comm type "PC"—filename length checks.
- **Data File (`GPCFPF`) Structure:** Understanding the fields will help in debugging and extending.
- **Screen File (`GL321D`) Layout:** Know how the screens relate to the mapped fields.

---

## Closing

This is a classic RPG maintenance program for file naming conventions, driven by business and platform constraints (file name lengths, key fields). All logic is centered around fetching/editing these names, enforcing rules, and persisting changes. 

If you need to onboard or modify, pay special attention to indicator logic, parameter passing, and the business constraints on filenames.