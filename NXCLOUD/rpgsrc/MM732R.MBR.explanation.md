# MM702R - Documentation

## Overview

**Program:** MM702R  
**System:** ASLOGI  
**Purpose:**  
This program generates sales forecasts per item (product number) by retrieving and processing sales statistics. It supports selection/filtering by various item attributes (such as assortment, group, supplier, etc.) and writes weekly forecast data to a dedicated forecast file.

**Business Context:**  
The program is a core component of the sales/procurement planning process. It consolidates historical sales data, applies smoothing/trend factors, and generates forward-looking forecasts for stock planning at the item/warehouse level.

---

## Key Data Files and Relationships

- **sstali** (Sales statistics)
- **vvarl1, vvarl8, vvarla, vvarlr, vvarlx, vvarly** (Item master, with different logical views for assortment, group, supplier, etc.)
- **vverlr** (Replacement item register)
- **vvenl1** (Item units/conversion)
- **vsdtl6** (Assortment master)
- **vlagl1** (Stock/warehouse master)
- **mmatlrr** (Item parameter matrix)
- **mprulr, mprulu** (Forecast/prognosis file, read/write)

The program heavily relies on chaining and reading across these files, using composite keys built from company, item, group, supplier, etc.

---

## Main Flow

### 1. **Initialization**

- **Clears deviation register** via `CALL 'MM403R'`.
- Calls subroutine `ukeaar` to build a list of year/week pairs for the forecast horizon (default: 52 weeks).
- Parses input parameters from a 128-character list (`d_list`), mapping overlays to selection criteria (assortment, groups, supplier, item, etc.).

### 2. **Selection Logic**

- If any selection criteria are provided (item, assortment, group, supplier, etc.), the corresponding `les_*` subroutine is called to retrieve the relevant set of items.
- If no criteria, all items are read from the item master (`vvarl1`).

#### Selection Subroutines:
- `les_vare` - Select by item number
- `les_vsor` - Select by assortment
- `les_ugr`  - Select by lower group
- `les_hgr`  - Select by higher group
- `les_ogr`  - Select by main group
- `les_ldor` - Select by supplier

Each subroutine reads the relevant logical file and, for each item found, calls `beh_vare` for processing.

---

### 3. **Item Processing (`beh_vare`)**

**High-level Steps:**
- **Validation:** Calls `rec_ktrl` to check if the item matches all selection criteria and business rules (company, group, not discontinued, ABC code, etc.).
- **Unit Conversion:** If stock and sales units differ, calls `hent_omr` to fetch unit conversion factors.
- **Parameter Retrieval:** Calls `les_parm` to obtain item-specific parameters (smoothing, trend, etc.) from the parameter matrix.
- **Warehouse Loop:** For each warehouse where the item is available:
    - Skips warehouses not matching selection or with missing ABC code.
    - Skips if item is discontinued at the warehouse.
    - Applies further filtering based on warehouse selection.
    - Checks item type (only 'L' or 'S' types are processed).
    - Calls `rydd_prognose` to clear old forecast records for this item/warehouse.
    - Calculates smoothing/trend if applicable (`glatp`).
    - For each forecast week, calls `finn_salg` to compute sales statistics.
    - Calls `finn_gl_ant` to calculate smoothed (glattet) forecast quantity.
    - Writes/updates forecast records in `mprulur`.

---

### 4. **Supporting Subroutines**

#### `rec_ktrl`  
Validates if the item should be processed, based on company, group, ABC code, and (optionally) discontinuation date.

#### `les_parm`  
Retrieves item parameters (smoothing, trend, etc.) from the parameter matrix (`mmatlrr`). Handles logic for cross-docking, assortment, supplier, and group-level parameters.

#### `finn_salg`  
For each year in the forecast horizon, aggregates historical sales from `sstali` for the item/warehouse/week, including sales for any replacement items (via `sjekk_erstv`). Applies unit conversion if necessary.

#### `glatp`  
Calculates a trend factor by comparing sales for the same weeks this year and last year. Calls external program `AX711R` to translate dates to year/week.

#### `ukeaar`  
Builds arrays of year/week values for the forecast horizon, starting from the input date.

#### `finn_gl_ant`  
Calculates the smoothed (glattet) forecast quantity over a configurable number of weeks by averaging the forecasted quantities from previous weeks.

#### `hent_omr`  
Retrieves unit conversion factors between stock and sales units from `vvenl1`.

#### `rydd_prognose`  
Deletes old forecast records for the given item/warehouse/week to avoid stale data.

---

## Important Business/Domain Logic

- **Selection/Filtering:** Items can be selected by assortment, group, sub-group, supplier, or item number. The selection logic is hierarchical and mutually exclusive.
- **Discontinued Items:** Items (or warehouse-specific records) with a discontinuation date before the current date are excluded.
- **ABC Code Filtering:** Only items with a non-blank ABC code (either at item or warehouse level) are included.
- **Replacement Items:** If an item has replacement items, their sales are included in the statistics.
- **Smoothing/Trend:** Forecasts can be smoothed using a moving average over a parameterized number of weeks. A trend factor is calculated by comparing sales for the same weeks this year and last year, capped at 100%.
- **Unit Conversion:** If stock and sales units differ, all sales quantities are converted to stock units for consistency.
- **Forecast Data Maintenance:** Old forecast records are cleared before writing new ones.

---

## Key Design Patterns and Conventions

- **Overlayed Data Structures:** The input parameter list (`d_list`) is overlayed with fields for easier parsing.
- **Key Lists:** Composite keys for file access are defined in `*inzsr` for clarity and reuse.
- **Parameterization:** Many behaviors (smoothing, trend, selection) are controlled by parameters, allowing for flexible business rules.
- **External Calls:** The program uses external programs (`MM403R`, `AX711R`, `VL720R`) for tasks like clearing deviation registers, converting dates to year/week, and retrieving warehouse-specific discontinuation dates.
- **Commented Change Log:** The top of the program contains a detailed change log with versioning and developer initials.

---

## Integration Points

- **External Programs:**
    - `MM403R`: Clears deviation register at the start.
    - `AX711R`: Converts a date to year/week.
    - `VL720R`: Retrieves warehouse-specific discontinuation date.

- **Forecast File (`mprulur`):**  
  The program updates or writes forecast records per item/warehouse/week.

---

## Notable Non-Obvious Logic

- **Multiple Levels of Parameter Lookup:**  
  The parameter matrix (`mmatlrr`) is checked at several levels of granularity: item+crossdock, item, assortment+crossdock, assortment, supplier+groups, and bare group levels, in a specific order.

- **Handling of ABC Code:**  
  If the ABC code exists at the warehouse level, it overrides the item-level ABC code. Items/warehouses without an ABC code are skipped.

- **Dynamic Forecast Horizon:**  
  The number of forecast weeks (`p_antu`) can be configured (default: 52), and the program builds the forecast horizon dynamically.

- **Trend Factor Calculation:**  
  The trend (glatnings%) is calculated only if both current and previous year sales data exist for the forecast period. The result is capped at 100%.

- **Replacement Item Sales:**  
  Through `sjekk_erstv`, sales from replacement items are recursively accumulated into the forecast calculation.

---

## Summary Table: Main Subroutines

| Subroutine      | Purpose                                                      |
|-----------------|--------------------------------------------------------------|
| ukeaar          | Builds forecast horizon (year/week arrays)                   |
| les_utvalg      | Directs selection to appropriate item selection subroutine   |
| les_vare        | Selects by item number                                       |
| les_vsor        | Selects by assortment                                        |
| les_ugr/hgr/ogr | Selects by group/subgroup                                    |
| les_ldor        | Selects by supplier                                          |
| beh_vare        | Main item processing logic                                   |
| rec_ktrl        | Validates item against selection and business rules          |
| les_parm        | Retrieves item parameters                                    |
| finn_salg       | Aggregates historical sales for forecast calculation         |
| sjekk_erstv     | Adds sales from replacement items                            |
| glatp           | Calculates trend factor                                      |
| finn_gl_ant     | Calculates smoothed forecast quantity                        |
| hent_omr        | Retrieves unit conversion factors                            |
| rydd_prognose   | Deletes old forecast data for item/warehouse                 |

---

## Conclusion

This program is central to the company's sales forecasting and inventory planning. It is highly parameterized, supports flexible selection criteria, and is designed to ensure data consistency and integrity by clearing outdated forecasts and applying up-to-date sales and parameter data. The codebase reflects a history of adaptations to evolving business rules, especially regarding ABC code handling, assortment logic, and supplier-specific processing.

**For new developers:**  
Understanding the relationships between the various logical files, the parameter matrix, and the forecast file is critical. Pay special attention to the business rules enforced in `rec_ktrl` and `les_parm`, as well as the use of external programs for date and status calculations. The change log at the top is a valuable reference for understanding past business-driven changes.