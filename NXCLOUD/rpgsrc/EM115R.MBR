     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : EM115R
      * Beskrivelse . . : Bonus, oppdaterer betalingsbonus med bonusmal
      *
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       191211 bsa  Nytt program
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Bruk av indikatorer:
      *
      *       LR = Avslutt program
      *       10 = Rollup
      *       11 = Rolldown
      *       12 = Sfldsp
      *       13 = Sfldspctl
      *       14 = Sflclr
      *       15 = Sflend
      *       21 = Home-key
      *       22 = Plassering av cursor
      *       30 = Protect av felter ved vise
      *    31-79 = Varsle m/feilmeldinger/skjermindikatorer
      *    80-99 = Arbeidsindikatorer
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fekboiu    uf a e           k disk    rename(ekbost:ekboiur)
     fekboic    uf a e           k disk    rename(ekbost:ekboicr)
     fekbeiu    uf a e           k disk    rename(ekbest:ekbeiur)
     fekbtiu    uf a e           k disk    rename(ekbtst:ekbtiur)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
      *
      * Definering av Local data area
      *
     d                uds
     d  l_dato               101    108
     d  l_tek1               201    270
     d  l_tek2               301    370
     d  l_tek3               401    470
     d  l_user               911    920
     d  l_firm               944    946  0
     d  l_fnav               951    980
      *
      * Definering av Information Data Structure - display feedback
      *
     d dspfbk          ds
     d  d_fcrn               378    379I 0
      *
      * Definering av variabler i nøkler
      *
     d ekboiu_bkun     s                   like(ekbkun)
     d ekboiu_rkat     s                   like(ekrkat)
     d ekboiu_kund     s                   like(ekkund)
     d ekboiu_kpro     s                   like(ekkpro)
     d ekboiu_ogrp     s                   like(ekogrp)
     d ekboiu_hgrp     s                   like(ekhgrp)
     d ekboiu_ugrp     s                   like(ekugrp)
     d ekboiu_ldor     s                   like(ekldor)
     d ekboiu_modn     s                   like(ekmodn)
     d ekboiu_vare     s                   like(ekvare)
     d ekboiu_enhe     s                   like(ekenhe)
     d ekboiu_lety     s                   like(eklety)
     d ekboiu_boty     s                   like(ekboty)
     d ekboiu_fdat     s                   like(ekfdat)
     d ekboiu_tdat     s                   like(ektdat)
      *
     d ekboic_bkun     s                   like(ekbkun)
     d ekboic_boty     s                   like(ekboty)
      *
     d ekbeiu_ebku     s                   like(ekebku)
     d ekbeiu_erka     s                   like(ekerka)
     d ekbeiu_ekun     s                   like(ekekun)
     d ekbeiu_ekpr     s                   like(ekekpr)
     d ekbeiu_eogr     s                   like(ekeogr)
     d ekbeiu_ehgr     s                   like(ekehgr)
     d ekbeiu_eugr     s                   like(ekeugr)
     d ekbeiu_eldo     s                   like(ekeldo)
     d ekbeiu_emod     s                   like(ekemod)
     d ekbeiu_evar     s                   like(ekevar)
     d ekbeiu_eenh     s                   like(ekeenh)
     d ekbeiu_elet     s                   like(ekelet)
     d ekbeiu_ebot     s                   like(ekebot)
     d ekbeiu_efda     s                   like(ekefda)
     d ekbeiu_etda     s                   like(eketda)
      *
     d ekbtiu_tbku     s                   like(ektbku)
     d ekbtiu_tbot     s                   like(ektbot)
      *
     d rkunl1_kund     s                   like(rkkund)
      *
      * Definering av variable
      *
     d w_seqe          s              1
     d b_forn          s              1    inz(*off)
     d b_oppr          s              1    inz(*off)
     d b_bonus         s              1    inz(*off)
      *
     d w_udat          s               d   datfmt(*iso)
     d w_udat_8        s              8
     d w_firm_alf      s              3
     d w_kund_alf      s              6
     d w_paar_alf      s              4
     d w_m1ar          s              4  0
     d w_naar          s              4  0
     d w_date          s               d   datfmt(*iso)
     d w_time          s               t   timfmt(*iso)
     d w_type          s              2
     d w_fast          s             10
     d w_numm          s              6  0
     d w_kode          s              1
     d w_fell          s              6
      *
     d w_firm          s                   like(ektfir)
      *
     d p_kund          s                   like(ekbkun)
     d p_hmnr          s              5  0
     d p_tbot          s                   like(ektbot)
      *
      * Definering av konstanter
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å kopiere av bonusmal
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   eval      b_bonus = *off
      *
      * Fjern alle gamle poster på kunden med valgt bonustype
      * NB På Behøver ikke finnes på betalingsbonus
      *
     c                   eval      ekboic_bkun = p_kund
     c                   eval      ekboic_boty = p_tbot
     c     ekboic_key    setll     ekboic
     c     ekboic_key    reade     ekboic
     c                   dow       not %eof(ekboic)
      * Kan ikke fjernes hvis sperrekode er satt på elementet
     c                   if        eksper <> 1
      *
      * Fjerner bonusdetaljer på kunde
      *
     c                   eval      ekbeiu_ebku = p_kund
     c                   eval      ekbeiu_erka = ekrkat
     c                   eval      ekbeiu_ekun = ekkund
     c                   eval      ekbeiu_ekpr = ekkpro
     c                   eval      ekbeiu_eogr = ekogrp
     c                   eval      ekbeiu_ehgr = ekhgrp
     c                   eval      ekbeiu_eugr = ekugrp
     c                   eval      ekbeiu_eldo = ekldor
     c                   eval      ekbeiu_emod = ekmodn
     c                   eval      ekbeiu_evar = ekvare
     c                   eval      ekbeiu_eenh = ekenhe
     c                   eval      ekbeiu_elet = eklety
     c                   eval      ekbeiu_ebot = ekboty
     c                   eval      ekbeiu_efda = ekfdat
     c                   eval      ekbeiu_etda = ektdat
     c     ekbeiu_key    setll     ekbeiu
     c     ekbeiu_key    reade     ekbeiu
     c                   dow       not %eof(ekbeiu)
     c                   delete    ekbeiur
     c     ekbeiu_key    reade     ekbeiu
     c                   enddo
      *
     c                   delete    ekboicr
     c                   endif
      *
     c     ekboic_key    reade     ekboic
     c                   enddo
      *
      * Sjekke om bonustypen som er lagt ut finnes på kunde
      * Hent informasjon fra kunderegister
     c                   eval      rkunl1_kund = p_kund
     c     rkunl1_key    chain     rkunl1
      *
     c     ekbtiu_key    chain     ekbtiu
     c                   eval      ekbtiu_tbku = p_kund
     c                   eval      ekbtiu_tbot = p_tbot
     c     ekbtiu_key    chain     ekbtiu
     c                   if        not %found
     c                   clear                   ekbtiur
     c                   eval      ektfir = w_firm
     c                   eval      ektbku = p_kund
     c                   eval      ektbot = p_tbot
     c                   eval      ektkka = rkkatg
      *
     c                   time                    ekeoda
     c                   time                    ekeoti
     c                   eval      ekeeus = l_user
     c                   time                    ekeeda
     c                   time                    ekeeti
     c                   write     ekbtiur
     c                   endif
      *
     c                   eval      *inlr = *on
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Tar inn parameter fra forrige program
      *
     c     *entry        plist
     c                   parm                    p_kund
     c                   parm                    p_tbot
     c                   parm                    p_hmnr
      *
      * Key for oppslag på kundebonus
      *
     c     ekboiu_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    ekboiu_bkun
     c                   kfld                    ekboiu_rkat
     c                   kfld                    ekboiu_kund
     c                   kfld                    ekboiu_kpro
     c                   kfld                    ekboiu_ogrp
     c                   kfld                    ekboiu_hgrp
     c                   kfld                    ekboiu_ugrp
     c                   kfld                    ekboiu_ldor
     c                   kfld                    ekboiu_modn
     c                   kfld                    ekboiu_vare
     c                   kfld                    ekboiu_enhe
     c                   kfld                    ekboiu_lety
     c                   kfld                    ekboiu_boty
     c                   kfld                    ekboiu_fdat
     c                   kfld                    ekboiu_tdat
      *
      * Key for oppslag på kundebonus
      *
     c     ekboic_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ekboic_bkun
     c                   kfld                    ekboic_boty
      *
      * Key for skriv på kundebonus-elment
      *
     c     ekbeiu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ekbeiu_ebku
     c                   kfld                    ekbeiu_erka
     c                   kfld                    ekbeiu_ekun
     c                   kfld                    ekbeiu_ekpr
     c                   kfld                    ekbeiu_eogr
     c                   kfld                    ekbeiu_ehgr
     c                   kfld                    ekbeiu_eugr
     c                   kfld                    ekbeiu_eldo
     c                   kfld                    ekbeiu_emod
     c                   kfld                    ekbeiu_evar
     c                   kfld                    ekbeiu_eenh
     c                   kfld                    ekbeiu_elet
     c                   kfld                    ekbeiu_ebot
     c                   kfld                    ekbeiu_efda
     c                   kfld                    ekbeiu_etda
      *
      * Key for oppslag på kunde typeregister
      *
     c     ekbtiu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ekbtiu_tbku
     c                   kfld                    ekbtiu_tbot
      *
      * Key for oppslag på kunderegister
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Henter firma fra LDA
      *
     c                   eval      w_firm = l_firm
     c                   time                    w_date
     c                   time                    w_time
      *
     c                   endsr
