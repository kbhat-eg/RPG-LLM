```markdown
# RPG Program Explanation: FL751R

## Overview
This RPG (Report Program Generator) source code is for an IBM i (AS/400, iSeries) application. The program updates the "search text" (s�ketekst) for all customer projects in the system. The code follows the traditional fixed-format RPG IV syntax and is well-documented with Norwegian comments.

---

## File Declarations

The program works with multiple database files. Each file is declared with its usage and external rename:

- `fkprl2` - Projects master file (`fkprpfr` → program format `fkprl2r`). Input, keyed, external.
- `fkpslu` - Search text file (`fkpspfr` → `fkpslur`). Update, keyed, external.
- `rkunl1` - Customer master file (`rkunpfr` → `rkunl1r`). Input, keyed, external.
- `apospf` - Postal code file. Input, keyed, external.

---

## Data Definitions (D-Specs)

- **LDA (Local Data Area):**
  - `l_user`: User, characters 911-920.
  - `l_firm`: Firm code, positions 944-946.

- **Key Variables:** For building keys for file access.
  - `fkpslu_skun`, `fkpslu_skpr` : From project/customer number.
  - `rkunl1_kund`, `apospf_ponr`: For accessing customer and postal code records.

- **Work Variables:** For character representation of numbers.
  - `w_ponr_alf`, `w_selg_alf`, `w_kund_alf`, `w_kpro_alf`

- **Constants:**
  - `Lo`, `Up`: Lowercase and uppercase alphabets (Scandinavian characters included), used for translation.

---

## Main Logic

### 1. Program Initialization

The main loop begins by positioning (`setll`) and reading (`reade`) records from the projects file (`fkprl2`). For each project:

- The `oppdater` subroutine is called to update the search text.
- The loop ends when there are no more records.

### 2. Exiting

- Program sets LR indicator (`*INLR`) to `*ON` and returns.

---

## Oppdater Subroutine (Search Text Update)

This subroutine is responsible for deleting existing and building new search text records for each customer project.

#### Steps:

1. **Delete Existing Search Text**
   - Builds the key from the current file record.
   - `chain` (random access) to `fkpslu`. If found, delete the record.

2. **Prepare New Search Text**
   - Initializes fields in the search text record.
   - Collates information from various sources: project name, customer name, addresses, postal info, contact person, seller number, customer number, project number, and external project number.

3. **Data Normalization**
   - Uses `XLATE` to convert strings to uppercase (using `Lo:Up` translation).

4. **String Concatenation**
   - Builds the field `flstek` by concatenating (trimmed) project name, customer name, address lines, postal number and place, contact person, seller number, customer number, project number, and optionally external project name.

5. **Audit Information**
   - Audit fields filled with time (`time`) and user from LDA.
   - Fields: creation and last update date/time/user.

6. **Write New Search Text**
   - Writes the completed record to `fkpslu`.

---

## Initialization Subroutine (*INZSR)

This subroutine, called automatically before the main processing, does the following:

- Builds key lists for various file accesses, storing the firm code in a work variable.
- Retrieves the current firm code from the LDA.

---

## Key Points & Data Flow

- **Data flow:** For each project, the program:
   - Removes any old search text record.
   - Builds a new search text field based on concatenated, normalized data from multiple sources.
   - Writes the updated search text for indexing/searching purposes.

- **Modularization:** File keys are built in subroutines for reuse and clarity.

- **Normalization:** Uses translation tables to ensure all text is uppercase (for standardized searching).

- **Internationalization:** Handles Scandinavian letters in translation charts.

---

## Version History

Code comments document version changes such as seller code expansion, tracking information, and inclusion of external project numbers in the search text.

---

## Summary Table

| Routine      | Purpose                                            |
| ------------ | ------------------------------------------------- |
| Main Loop    | Iterates all customer projects, updating each     |
| `oppdater`   | Deletes old and builds new search text            |
| `*INZSR`     | Sets up key fields and loads firm info from LDA   |

---

## Main Variables

| Name             | Description                     |
| ---------------- | ------------------------------ |
| `flstek`         | Composed search text field      |
| `flkund`, `flkpro` | Customer and project numbers   |
| `fladr1`, `fladr2` | Address lines                  |
| `flponr`         | Postal number                   |
| `apsted`         | City/Place, from postal file    |
| `flkprs`         | Contact person                  |
| `flselg`         | Seller number                   |
| `flepro`         | External project name           |
| `l_user`         | Current user (from LDA)         |
| `l_firm`         | Firm code (from LDA)            |

---

## Typical Use Case

This program is typically used as a batch maintenance job to rebuild or update the search text file for all customer projects, ensuring search consistency and up-to-date information for user interfaces or reporting.

---
```