# Documentation: Program FP420R – Maintenance of Label Information for Items

## Overview

**Program Name:** FP420R  
**System:** ASOFAK  
**Description:**  
This program is responsible for maintaining label information for inventory items. It provides a user interface for adding, updating, deleting, copying, and viewing label data associated with products and warehouses. The program is interactive, using subfiles for displaying and managing multiple records, and supports various workflows for efficient label management.

**Key Business Domain Concepts:**
- **Item (Vare):** A product or SKU in inventory.
- **Warehouse (Lager):** A storage location for items.
- **Label Information (Etikettinformasjon):** Metadata related to labeling items, including price, type, and tracking numbers (e.g., GTIN).
- **Subfile:** Used for listing and manipulating multiple label records per warehouse.

## File Relationships

- **vetil1, vetilr, vetilu:** Label information physical and logical files (read, read/update, update).
- **vvarl1:** Item master file, for item validation and description lookup.
- **ra10l1:** Warehouse master file, for warehouse validation and description.
- **fp420d:** Display file for user interface, including subfiles and control screens.

## Key Data Structures and Variables

- **Local Data Area (LDA):** Used to retrieve default company (`l_firm`), user (`l_user`), and warehouse (`l_lage`) information at program start.
- **Subfile Control Variables:**  
  - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` – manage subfile paging and navigation.
- **Key Variables:**  
  - For each file, variables like `vetil1_lage`, `vetil1_vare` are used to build composite keys for database access.
- **Work Variables:**  
  - Flags like `b_oppr`, `b_forn`, `b_anul`, `b_feil` control flow and state.
  - `w_firm`, `w_vare`, `w_lage` are working copies of company, item, and warehouse.

## User Interface Structure

- **Subfiles:**  
  - `B1SFL` – Main subfile for listing label records.
  - `B2CTL` – Subfile control record.
  - `B2CMD` – Command screen for function keys.
- **Detail/Action Screens:**  
  - `C1BLD` – Entry of new key for creating a label record.
  - `C1MSG` – Message window for duplicate key attempts.
  - `C2BLD` – Maintenance/view screen for label details.
  - `D1WIN` – Window for delete confirmation.
  - `K1WIN` – Window for copying a label record.

## Indicator Usage

- **LR:** End of program.
- **10, 11:** Paging (roll up/down).
- **12-15:** Subfile display, control, clear, end.
- **21, 22:** Cursor positioning.
- **30:** Field protection.
- **31-79:** Warnings, messages, screen indicators.
- **80-99:** Work indicators.

## Main Program Flow

1. **Initialization (`*inzsr`):**
   - Loads company and warehouse from LDA.
   - Initializes subfile keys and positions to the first record for the current warehouse.
   - Fills the subfile with initial data.

2. **Main Loop:**
   - Presents the command screen (`B2CMD`), then the subfile (`B2CTL`/`B1SFL`).
   - Handles function keys for navigation, create, copy, delete, and inquiry.
   - Allows positioning by item, page up/down, and direct field navigation.

3. **Subfile Maintenance:**
   - Handles add, update, copy, delete, and view actions on label records.
   - Uses subroutines for each action, updating both database and subfile display as needed.

## Subroutine Details

### Subfile Management

- **`clr_subfile`:** Clears the subfile, resets record counters and indicators.
- **`crt_subfile`:** Populates the subfile with label records for the current warehouse and company, up to a page size (`c_sfil`).
- **`bck_subfile`:** Reads previous page of records for backward navigation.
- **`dsp_subfile`:** Displays the current subfile page, managing indicators for subfile display.

### Record Operations

- **`xc1bld`:** Handles entry of a new label record key. Validates item and warehouse existence, checks for duplicates, and invokes maintenance if valid.
- **`xc1msg`:** Displays a message if an attempt is made to create a duplicate record.
- **`xc2bld`:** Main maintenance routine for add, update, or view. Loads existing data if present, else initializes for new entry. Updates the database and subfile accordingly.
- **`xd1win`:** Handles deletion with confirmation window. Deletes the label record if confirmed.
- **`xk1win`:** Handles copying a label record to a new key. Ensures the new key is valid and not a duplicate before invoking maintenance.

### Inquiry and Field Assistance

- **`spørring`:** Field-level assistance. Invokes external programs (`VV500R` for item, `RA510R` for warehouse) to assist the user in selecting valid values, updating the UI fields as needed.

### Positioning and Refresh

- **`forny`:** Refreshes the subfile, reloading data from the current position.
- **`posisjoner`:** Repositions the subfile to a specific item if requested.

## Data Integrity and Validation

- **Item and Warehouse Validation:**  
  - Before maintenance or creation, the existence of the item and warehouse is verified using `vvarl1` and `ra10l1` files.
- **Duplicate Prevention:**  
  - Attempts to create existing records trigger a message and prevent duplicate entries.
- **Field Assistance:**  
  - Integration with `VV500R` and `RA510R` provides lookup dialogs for item and warehouse fields.

## Notable Design Decisions & Conventions

- **Use of Subfiles:**  
  - Subfiles are used extensively for batch maintenance, enabling efficient user interaction with multiple records.
- **Indicator-Driven UI:**  
  - The UI logic is heavily controlled by indicators, following established IBM i green-screen conventions.
- **Separation of Concerns:**  
  - Key business logic is encapsulated in subroutines, keeping the mainline readable and maintainable.
- **Extensive Use of Data Structures:**  
  - Data structures (including LDA and display feedback) are used to manage context and UI state.

## Interactions with Other Modules

- **Item Lookup (`VV500R`):**  
  - Used for item selection and validation.
- **Warehouse Lookup (`RA510R`):**  
  - Used for warehouse selection and validation.

## Version History Highlights

- **Support for Warehouse in Label Register:**  
  - Extended to handle multiple warehouses per item.
- **Error Handling Improvements:**  
  - Enhanced deletion and lookup logic for edge cases.
- **Tracking Information:**  
  - Added fields for last printed price and GTIN number.
- **GUI Adaptations:**  
  - Some changes made for new GUI requirements (mainly for DDS).

## Summary

FP420R is a central maintenance program for label information, supporting robust, interactive management of item labels per warehouse. It leverages subfiles, external module integration, and rigorous validation to ensure data integrity and user efficiency. The codebase adheres to established IBM i RPG conventions and is structured for maintainability and extensibility within the business domain of inventory and labeling.