# Explanation of RPG Source Code (`rk791R`)

---

## Overview

This program (`rk791R`) is written for IBM i (AS/400) in ILE RPG/400. Its purpose is to read a CSV file containing contact persons, parse each line, validate and, if appropriate, insert or update contact information into a customer contact file.

The program makes use of several physical files and handles customer and contact data, including special handling for Norwegian characters and data field translations.

---

## Sections Breakdown

### 1. **File Specifications**

```rpg
flwexpf    if   e           k disk
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frukplu    uf a e           k disk    rename(rukppfr:rukplur)
```
- **lwexpf**: Input file. The CSV data is likely read from this file.
- **rkunl1**: Customer master file, renamed for local reference.
- **rukplu**: Contact person file, renamed for local reference.

---

### 2. **Data Area & Variables**

#### **Local Data Area (LDA) Fields**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- `l_user`: User ID (from LDA positions 911–920).
- `l_firm`: Firm/company code (from LDA positions 944–946).

#### **Input Data Structure**
```rpg
d                 ds
d d_inpu                      1024
d  d_kund                        6    overlay(d_inpu:1)
d   d_kundn                      6  0 overlay(d_kund:1)
d  d_alfa                       40    overlay(d_inpu:7)
d  d_enav                       30    overlay(d_inpu:47)
d  d_fnav                       30    overlay(d_inpu:77)
d  d_kpnr                        6    overlay(d_inpu:107)
d   d_kpnrn                      6  0 overlay(d_kpnr:1)
d  d_krol                       20    overlay(d_inpu:113)
d  d_ktlf                       11    overlay(d_inpu:133)
d  d_mtlf                       11    overlay(d_inpu:144)
d  d_mail                       50    overlay(d_inpu:155)
```
- `d_inpu`: The entire input record (up to 1024 bytes).
- Fields from `d_inpu`: used to parse out customer number, name, roles, phone numbers, email, etc., by overlays.

#### **Key Variable Templates**
```rpg
d rkunl1_kund     s                   like(rkkund)
d rukplu_kund     s                   like(rukund)
d rukplu_levr     s                   like(rulevr)
d rukplu_kpnr     s                   like(rukpnr)
```
- Used for constructing keys during file lookups.

#### **Working Variables**
```rpg
d w_firm          s              3  0
d w_udat          s               d   datfmt(*iso)
d w_kpnr          s              6  0
d w_test          s             50
d w_kund          s              6  0
d w_pos           s              5u 0
d w_posi          s              2  0
d w_posb          s              2  0
d s_kpnr          s                   like(rukpnr)
d w_retk          s              1

d b_ok            s              1    inz(*off)
```
- Temporary variables used in subroutines for parsing, checking, and holding transient information.

---

### 3. **Constants**
```rpg
d Lo              c                   'abcdefghijklmnopqrstuvwxyz�����'
d Up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZ�����'
d digits          c                   ' 0123456789'
d c_blan          s             15    inz('               ')
d digitx          c                   '0123456789'
```
- Used for letter case and digit checking, especially with Norwegian-specific letters (å, ø, æ).

---

### 4. **Main Program Logic**

#### **Reading and Processing Input**
```rpg
c                   read      lwexpf
c                   dow       not %eof
    c                   eval      d_inpu = *blank
    c                   exsr      utled_ds
    c                   if        b_ok = *ON
    c                   exsr      oppr_kun
    c                   endif
    c                   read      lwexpf
c                   enddo
```
- Reads a record from **lwexpf** (input file).
- Calls `utled_ds` subroutine to parse and extract data.
- If parsing is successful (`b_ok`), processes the contact with `oppr_kun`.
- Repeats until EOF.

#### **Program End**
```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets last record indicator (`*INLR`) and returns, ending the program.

---

### 5. **Subroutines**

#### **oppr_kun (Process Contact Person)**
- **Validates** that first and last name are not blank.
- **Checks if customer exists** in **rkunl1** (chain by key).
- **Translates** Norwegian characters from ANSI to EBCDIC.
- **Combines** trimmed first and last name into `d_alfa`.
- **Validates** and normalizes email address (must contain '@' and a '.' after '@').
- **Assigns a new contact number** if missing, by calling external program `RS003R`.
- **Builds contact record** for update or insert:
  - Converts fields to uppercase as required.
  - Formats phone numbers if needed.
  - Sets system/user/date/time fields.
  - **Updates or writes** the contact person record in **rukplu**.

#### **utled_ds (Parse Input Record)**
- **Removes quotes** from the input line.
- **Sequentially parses** fields from a semicolon-separated string:
  - Customer number
  - Contact number
  - Surname
  - First name
  - Role
  - Office phone
  - Mobile phone
  - Email
- **Validates** digits where required and sets `b_ok` status.

#### **Initialization Subroutine (\*inzsr)**
- **Builds keys** for file access.
- **Loads values** from the LDA (company code).
- **Loads date.**

---

## 6. **Important Operations & Details**

- **File Lookups**: Use CHAIN/UPDATE/WRITE to interact with DB files.
- **Character Translation**: Handles translation of Norwegian characters for proper EBCDIC storage.
- **Email Validation**: Ensures presence of '@' and a dot (`.`) after it; converts to uppercase.
- **Phone Number Formatting**: If all digits (8 in total), breaks into groups for readability (NN NN NN NN).
- **Field Parsing**: Uses `%scan`, `%subst`, `%trim`, `%check` to parse and validate fields in a CSV line.
- **Contact Number Assignment**: If missing, gets the next available contact number from an external program.
- **Uppercase Conversion**: Often converts names and roles to uppercase for storage consistency.
- **Error Handling**: If parsing or validation fails, skips the current record.

---

## 7. **Typical Record Flow**

1. **Read line** from export file.
2. **Parse** all data fields.
3. **Validate** required fields and customer existence.
4. **Normalize/translate** data (emails, names, roles, Norwegian letters).
5. **Check and format email/phone fields**.
6. **Update or insert** the contact person record in the database.

---

## 8. **Norwegian/Local Specifics**

- The code is written in Norwegian (comments, variables, and field names).
- Handles Norwegian letters (`å, ø, æ`) with special translation logic.
- The structure and logic are tailored for a Norwegian ERP/CRM system.

---

## 9. **Summary Table of Key Variables**

| Variable        | Meaning                                              |
|-----------------|-----------------------------------------------------|
| `d_kund`        | Customer number (from input)                        |
| `d_enav`        | Surname (etternavn)                                 |
| `d_fnav`        | First name (fornavn)                                |
| `d_kpnr`        | Contact person number                               |
| `d_krol`        | Role                                                |
| `d_ktlf`        | Office phone                                        |
| `d_mtlf`        | Mobile phone                                        |
| `d_mail`        | Email address                                       |
| `w_kund`        | Working customer number                             |
| `w_kpnr`        | Working contact number                              |
| `rukplu_kund`   | Key field for contact person file                   |

---

## 10. **Main Takeaways for New Developers**

- The main logic is in parsing and validating CSV input, ensuring clean/normalized data before writing it to the customer contact file.
- There is careful handling of character encoding (ANSI/EBCDIC), data validation (especially for numeric fields), and conditional updating/inserting.
- Subroutines are used to structure code for reusability and clarity.
- Understanding of file structure and key fields is crucial, as well as familiarity with Norwegian character encoding handling.

---

**In summary:**  
This program is a classic data loader/cleaner for customer contact data, designed with robustness in field parsing, data normalization, and correct database update/insert logic, focused on a Norwegian business context.