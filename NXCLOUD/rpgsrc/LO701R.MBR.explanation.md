# Program LO701R – Documentation

## Overview

**Program Name:** LO701R  
**System:** ASLAGR  
**Purpose:**  
This program is designed to update the quantity (antall), purchase price (innkjøpspris), and line amounts (linjebeløp) for order lines in the order management system. It handles both the recalculation of inventory and the recalculation of line totals, including discounts, whenever there is a change to the order line's quantity or price.

The program interacts with order header, order line, and inventory update modules, and is called as part of the business process for editing order lines.

---

## File Usage and Data Model

- **lohel1:** Order header file (BESTILLING-HODE)
- **lodtl1:** Order line file (BESTILLING-LINJE)
- **lodtlu:** Order line update file (BESTILLING-LINJE, update-capable)
- All files are accessed with keys composed of firm, order number, suffix, and line number as appropriate.

---

## Key Variables

### Parameters (Input/Output)
- `p_firm`: Company code (from calling program)
- `p_numm`: Order number (from calling program)
- `p_suff`: Order suffix (from calling program)
- `p_line`: Order line number (from calling program)
- `p_anta`: New quantity for the line (from calling program)
- `p_inkp`: New purchase price for the line (from calling program)
- `p_stat`: Status code (output, '9' indicates error)

### Key Fields
Used for chaining (reading/updating) records in files.

### Working Variables
- Pricing and quantity fields for calculations.
- `hlrec` Data Structure: Used for inventory adjustment, overlaid with specific fields (item, warehouse, quantity, etc.) for passing to inventory update program `VL001R`.

---

## Program Flow

### Initialization (`*inzsr`)

- Reads parameters from the calling program.
- Builds key lists for the three files (header, line, line update).
- Sets up local variables for subsequent file access.

---

### Main Logic

#### 1. **Read Order Header**

- Chains to the order header (`lohel1`) using the provided keys.
- If not found, sets status to '9' and exits.

#### 2. **Read Order Line**

- Chains to the order line (`lodtl1`) using the provided keys.
- If not found, sets status to '9' and exits.

#### 3. **If Quantity Change Requested (`p_anta <> 0`)**

##### a. **Reverse Original Quantity in Inventory**

- Prepares a record in `hlrec` with the original quantity (negated) and other relevant info from the order line.
- Calls external program `VL001R` to update inventory (subtracts the old quantity).

##### b. **Apply New Quantity in Inventory**

- Prepares a record in `hlrec` with the new quantity and relevant info.
- Calls `VL001R` again to update inventory (adds the new quantity).

##### c. **Update Order Line with New Quantity**

- Chains to the update-capable order line file (`lodtlu`).
- If found, updates the quantity and audit fields (user, date, time), and writes back the changes.

---

#### 4. **If Purchase Price Change Requested**

- If a new purchase price is provided and it differs from the current one:
    - Calls external program `JV752R` to retrieve the markup factor (`w_kfak`) for the item.
    - Chains to the order line update file (`lodtlu`).
    - If found, updates the purchase price (`ldipny`) and recalculates the cost price (`ldkpny = p_inkp * w_kfak`), then updates audit fields and writes back.

---

#### 5. **Recalculate Line Totals**

- Chains to the order line update file (`lodtlu`).
- If found, performs the following:
    - Calculates line amount (`w_sumi = ldipny * ldanta`).
    - Applies up to two discounts (`ldrab1`, `ldrab2`) sequentially, updating the total discount (`w_sumr`).
    - Updates line totals:
        - `ldsumi`: Line amount before discount
        - `ldsumr`: Total discount
        - `ldsumk`: Total cost (cost price * quantity)
    - Updates audit fields and writes back.

---

### Program Exit

- Sets LR indicator to end program and returns.

---

## External Program Calls

- **`VL001R`**: Inventory adjustment program. Called twice per quantity change—first to reverse the original quantity, then to apply the new one. Communicates via `hlrec` data structure.
- **`JV752R`**: Retrieves markup factor for purchase/cost price recalculation when purchase price changes.

---

## Business/Domain-Specific Logic

- **Inventory Synchronization**: Any change to order line quantity is immediately reflected in inventory via two-step adjustment (remove old, add new).
- **Price and Discount Calculation**: Handles two levels of line discounts, applied sequentially.
- **Audit Trail**: Updates user, date, and time fields on every change for traceability.
- **Error Handling**: Status code `p_stat = '9'` signals not found or other error to the caller.

---

## Design Patterns and Conventions

- **Separation of Concerns**: Inventory updates and price recalculations are handled via dedicated external programs, keeping this program focused on orchestration and file maintenance.
- **Overlay Data Structure**: Inventory update data (`hlrec`) is constructed using overlays, allowing for efficient packing of multiple fields into a single buffer for program calls.
- **Versioning/History**: The header comments track changes per release, which is common in this codebase for audit and maintenance.

---

## Interactions with Other Modules

- **Order Management**: Reads and updates order header and line files.
- **Inventory**: Calls out to `VL001R` for inventory adjustments.
- **Pricing/Markup**: Calls out to `JV752R` for cost price recalculation logic.

---

## Notable Non-Obvious Decisions

- **Two-Step Inventory Update**: Instead of calculating the delta, the program first reverses the old quantity and then applies the new. This approach simplifies inventory consistency but may have performance implications.
- **Discount Application**: Discounts are applied sequentially, not cumulatively, which can affect the total discount amount.
- **Field Overlays**: Use of overlayed data structures for external program calls is a performance and compatibility consideration common in legacy RPG environments.

---

## Summary

LO701R is a critical integration point between order management and inventory control. It ensures that any changes to order lines are accurately reflected in both inventory and financial calculations, maintaining data integrity and supporting downstream business processes. The program is structured for maintainability, auditability, and modularity, relying on external programs for specialized logic. 

Familiarity with the external modules (`VL001R`, `JV752R`) and the structure of the order files is essential for effective maintenance and enhancement of this program.