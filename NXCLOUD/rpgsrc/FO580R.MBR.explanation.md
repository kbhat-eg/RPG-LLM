## Overview and Purpose

This program, FO580R, is a central part of our order management system, specifically handling follow-up on sales quotations ("tilbud") at the order header level ("ordre-hode"). It provides a subfile-based interactive interface for users to review, maintain, and act on quotations that require follow-up. The program supports filtering, positioning, and updating of quotations, as well as integration with related modules for further order processing, printing, and information lookup.

## Business Context

- **Quotations (Tilbud):** The system distinguishes between regular orders and quotations. The focus here is on quotations that are still active (not expired) and require follow-up actions.
- **Follow-up and Expiry Dates:** Users can toggle between viewing by follow-up date ("oppfølgingsdato") and expiry date ("utgår dato"), with logic to ensure correct positioning and display in the subfile.
- **User Preferences:** The program persists user-specific filters and settings for a customized experience.
- **Integration:** The program interacts with multiple other modules (FO500R, FO505R, FO600R, FO710R, etc.) for order processing, printing, and information retrieval.

## Structure and Key Logic

### File Declarations

- Multiple logical files over the order header (fohelr, fohel1, fohela, fohelm, fohelo, fohelq, fohelv, fohelu), order lines (fodtl1), customer (rkunl1), user (fusrl1, fusrlu), order type (votyl1), info type (vinfl1), and item (vvarl1) are declared.
- The display file `fo580d` is used in workstation mode with a subfile (`b1sfl`).

### Data Areas and Data Structures

- The program uses the local data area (LDA) for session-specific information (user, firm, etc.).
- The display feedback data structure (`dspfbk`) is used for subfile record number management.

### Indicators and Conventions

- The program uses a well-documented indicator convention (see comments), e.g., for subfile control, error display, work indicators, etc.
- Subfile navigation and interaction are managed using a set of indicators and subfile variables (`w_fcrn`, `w_srrn`, `w_ssrn`, etc.).

### Main Processing Loop

#### Entry and Initialization (`*inzsr`)

- Retrieves firm and user info from LDA.
- Initializes display headings and subfile mode (default to follow-up date).
- Retrieves VAT rates by calling 'FØ705R'.
- Loads user preferences from the user register.
- Positions the database and fills the subfile with relevant quotations.

#### Subfile Display and Navigation

- The user interacts with a subfile showing quotations to be followed up.
- Function keys provide navigation (page up/down, roll), filter toggling (e.g., F23 for expiry vs. follow-up date), and action options (edit, view, print, process, etc.).
- The subfile can be positioned via order number/suffix, customer, order type, item address, follow-up date, or expiry date.

#### Subfile Maintenance

- The subfile is cleared (`clr_subfile`) and rebuilt (`crt_subfile`) as needed, especially after actions that affect the data set or when toggling views.
- Filtering logic in `chk_subfile` ensures that only relevant, active quotations are shown, considering user, customer, seller, department, warehouse, requisition, and expiry status.

#### Actions on Quotations

- **Edit (valg=2):** Opens a window (`xc2win`) for editing follow-up and expiry information, updates the order header, and refreshes the subfile.
- **View (valg=5):** Calls FO505R to display order details.
- **Print (valg=6):** Calls FO600R to print the quotation.
- **Process (valg=7):** Calls FO500R to process the quotation further.
- **Handler Assignment (valg=8):** Calls FO710R for order handler assignment.

#### User Preferences and Filters

- Users can set filters for user, customer, seller, department, warehouse, and requisition via a dedicated window (`xh1win`), with settings persisted in the user register (`lagring` subroutine).
- These filters are applied in the `chk_subfile` routine to restrict which quotations appear.

#### VAT Handling

- The program allows toggling between showing order value with or without VAT (MVA), adjusting the display and calculations accordingly.
- VAT rates are retrieved at initialization and used in subfile display and calculations.

#### Error Handling and Validation

- Date fields are validated for correct format and logical values.
- When editing, the program ensures only valid updates are accepted.

### Key Subroutines

- **forny:** Refreshes the subfile after changes or view toggling.
- **posisjoner:** Positions the subfile based on user input (order number, customer, etc.).
- **subfile:** Main subfile processing loop, handling user actions on subfile rows.
- **chk_subfile:** Determines if a quotation should be included in the subfile based on all active filters and business rules.
- **ajo_subfile:** Updates a subfile row after an external update (e.g., after calling another program).
- **crt_subfile/clr_subfile:** Build and clear the subfile records.
- **bck_subfile:** Handles paging backwards in the subfile.
- **xfarge:** Sets display color indicators based on order info type.
- **xsjekk_ord1:** Checks if an order is already being processed.
- **xh1win/lagring:** Handles the user filter window and saving filter settings.
- **xc2win:** Handles editing of follow-up and expiry information for a quotation.
- **xb6win:** Handles the print dialog for a quotation.
- **xsjekk_inp:** Validates user input fields.
- **xsjekk_lag:** Checks if a specified warehouse exists on any order line.
- **spørring:** Handles lookup dialogs for customer, seller, and department.

### Integration Points

- **FO505R:** Order detail display.
- **FO500R:** Order processing.
- **FO600R:** Quotation printing.
- **FO710R:** Order handler assignment.
- **RK500R, RA509R, RA507R:** Lookup programs for customer, seller, and department.
- **FØ705R:** VAT rate retrieval.

### Special/Non-Obvious Design Choices

- **Dynamic Subfile Keying:** The subfile can be rebuilt and positioned dynamically based on various keys (order, customer, type, date), supporting flexible navigation.
- **Filter Persistence:** User-specific filters are loaded and saved, making the interface personalized and efficient for repeat users.
- **Expiry Handling (F23):** Special logic ensures that toggling between follow-up and expiry dates doesn't lose the user's position in the subfile, even if some quotations only have one of the dates set.
- **Color Coding:** Information types can trigger different color indicators in the interface, improving usability.

### Maintenance and Extension

- The code is heavily commented, with version and change history at the top.
- Key lists (`klist`) are defined for all major file operations, making it easier to maintain and extend keying logic.
- The structure is modular, with clear subroutine boundaries for all major operations.

## Summary

FO580R is a robust, interactive module for managing the follow-up of sales quotations, providing users with a powerful, filterable, and maintainable subfile interface. It integrates deeply with the rest of the order management system, supports user-specific preferences, and enforces business rules around quotation status, expiry, and follow-up. The codebase balances flexibility and control, with thoughtful handling of navigation, filtering, and data integrity.