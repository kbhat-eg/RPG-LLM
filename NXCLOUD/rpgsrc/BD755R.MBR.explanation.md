# RPG Program BD755R Explanation

## Overview

This RPG (Report Program Generator) program is named **BD755R** and is part of a system called **ASSHOP**. The purpose of this program is to update a field (the "unit" field) on records in the file `bodtl2`, switching the unit name from an old value to a new one for a specific item (vare) within a company (firm). 

It also records tracking information (time and user) when a record is updated.

---

## Main Components

### 1. **File Declaration**

```rpg
fbodtl2    uf   e           k disk    rename(bodtpfr:bodtl2r)
```
- **bodtl2**: Physical file used for reading and updating records.  
- **uf**: User open, Full procedural file usage.
- **e**: External file description.
- **k**: File is keyed.
- **rename**: Renames the record format from `bodtpfr` to `bodtl2r` for this program.

---

### 2. **Data Structures and Variables**

- **Parameters (passed into program):**
  - `p_firm` : Firm (company) code
  - `p_vare` : Item (product) code
  - `p_enhg` : The "old" unit name (unit to be replaced)
  - `p_enhn` : The "new" unit name (replacement)

- **Working Variables:**
  - `w_firm` : Local copy of firm code
  - `w_vare` : Local copy of item code

- **User and timestamp fields:**
  - `l_user` : User ID (from positions 911â€“920 in user data structure, system-specific)
  - `bdedat`, `bdetim` : Date and Time fields for tracking

---

### 3. **Program Flow** (Hovedprogram)

#### **a. Initialization (INZSR)**

- Receives four parameters: `p_firm`, `p_vare`, `p_enhg`, `p_enhn`
- Copies them into working variables `w_firm` and `w_vare`
- Builds a key list (`key01`) for keyed lookup on `bodtl2`, using `w_firm` and `w_vare` as keys.

#### **b. Main Loop**

```rpg
c     key01         setll     bodtl2
c     key01         reade     bodtl2r
c                   dow       not %eof
  c                   if        bdenh1 = p_enhg
  c                   eval      bdenh1 = p_enhn
  c                   endif
6.10 c                   time                    bdedat
6.10 c                   time                    bdetim
6.10 c                   eval      bdeusr = l_user
  c                   update    bodtl2r
  c     key01         reade     bodtl2r
c                   enddo
```

**Step-by-step:**
1. **SETLL key01 bodtl2**: Positions the file pointer to the first record matching the firm and item code.
2. **READE key01 bodtl2r**: Reads the first record matching the key.
3. **DOW not %eof**: Loop continues as long as there are more records.
4. **IF bdenh1 = p_enhg**: If the unit field (`bdenh1`) matches the "old" unit name.
   - **EVAL bdenh1 = p_enhn**: Change it to the "new" unit name.
5. **Tracking info**: Set date (`bdedat`), time (`bdetim`), and user (`bdeusr`) fields.
6. **UPDATE bodtl2r**: Write the updated record back to the database.
7. **READE key01 bodtl2r**: Read the next matching record.
8. **Loop ends** when no more records matching criteria.

---

### 4. **End of Program**

```rpg
c                   eval      *inlr = *on
c                   return
```
- **Set on LR (Last Record) indicator** to close files and tidy up.
- **Return** to end the program.

---

## Additional Notes

- **Header directive:**  
  `h option(*nodebugio) datedit(*dmy)`
  - Disables certain debugging, sets date editing to day/month/year.

- **Comments and Change Log:**  
  The comments document the program's history and explain its functions clearly.

---

## Summary

**BD755R** is a batch update program designed to change the unit name on records in `bodtl2` for a specified company and item, only when the current unit matches the old value. All changes are tracked by date, time, and user, maintaining an audit trail. 

#### Key RPG idioms used:
- **SETLL/READE loop** for keyed file processing.
- **Parameter list (`plist`)** for input values.
- **INZSR** subroutine for initialization and parameter handling.
- **Field rename** for record format consistency.
- **Change logging**: recording change time and user.

This structure is common in legacy IBM i (AS/400) RPG applications for batch data corrections and updates.