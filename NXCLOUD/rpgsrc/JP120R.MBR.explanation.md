# RPG Program JP120R - Overview and Flow

This program (`JP120R`) is a classic OPM/ILE RPG program for maintaining "freight conditions" (frakt betingelser) in a subfile-driven interactive display. The logic is typical of multi-level maintenance panels, supporting navigation, CRUD (create, read, update, delete), and subfile paging, with several validation and lookup routines.

The domain appears to be logistics or shipping, possibly for purchasing or ERP.

The code is annotated with Norwegian comments and variable names, and is organized in a modular, subroutine-heavy style.

---

## Main Components

### 1. **Header and Indicators**

- `h option(*nodebugio) datedit(*dmy)`  
  Sets program options: no debug I/O, and date edit in day/month/year format.

- **Indicators**:  
  Documented usage for RPG indicators:  
  - LR: End program  
  - 10-15, 21-22, 30, 31-99: Various UI/subfile/processing roles  
  These are referenced throughout the flow for subfile and UI behavior.

---

### 2. **File Specifications**

- Many logical files are declared (e.g., `jfbel1`, `jfbelr`, `jfbelu`, etc.), mostly renamed from physical/logical files.  
- Files are keyed (`k disk`) for indexed access.  
- `jfp120d` is the display file, with `workstn` and a subfile (`sfile(b1sfl:w_srrn)`).

---

### 3. **Data Definitions**

- **Parameters**: Company code (`p_ffir`), supplier code (`p_fldo`), supplied at program invocation.
- **LDA Fields**: For user info, names, etc.
- **Display Feedback DS**: For display file feedback (e.g., cursor positioning).
- **Key Variable Structures**: For each file/key used.

- **Working Variables**:  
  For subfile record numbers/counters, sequence, flags for modes (create, update, delete, etc.), and working fields for data transfer between subroutines/screens.

---

### 4. **Subfile Control & Explanation (from comments)**

- Several working variables (`w_srrn`, `w_spge`, etc.) are used to control subfile paging, current record numbers, etc.
- The subfile (`B1SFL`), control records (`B2CTL`), command prompt (`B2CMD`), input panels (`C1BLD`, `C2BLD`), and windows for delete/copy actions (`D1WIN`, `K1WIN`) are all laid out and referenced by their usage.

---

## Program Flow

### **A. Program Entry & Initialization**

- Parameters are received.
- LDA values (user info, etc.) are read.
- The supplier's name is read via file, and screen fields are initialized.
- The database is positioned, and the subfile is filled (via `crt_subfile` subroutine).

---

### **B. Main Loop (User Interaction)**

The main driver is through a tag/label loop (`b2taga`, `b2tagb`) and a dispatcher using `select` and `when` for function key handling:

- **F1**: Browse alternatives (`xf1win`)
- **F3/F12**: Exit
- **F4**: Inquiry (`spørring`)
- **F5**: Refresh subfile (`forny`)
- **F6**: Add new (`xc1bld`)
- **F9**: Activate all conditions (`xc3win`, batch update)
- **Rollup, Rolldown**: Page through subfile/call paging routines
- **Home/Positioning**: Cursor placement/range
- **Positioning Fields**: If positioning fields are filled, call `posisjoner` to position subfile.
- **Main Subfile Handler**: Calls `subfile` subroutine for subfile row processing.

---

### **C. Subfile Routines**

#### 1. **Filling and Clearing the Subfile**
- `clr_subfile`: Blanks out the subfile and resets counters.
- `crt_subfile`: Reads records from the appropriate file (main, group, subgroup, etc.) and writes them to the subfile, applying filters if requested.

#### 2. **Paging**
- `bck_subfile`: Handles backward paging using `readp` (read previous), fills the subfile with the previous page.
- `dsp_subfile`: Manages display of subfile – sets indicators, writes control records, handles cursor positions.

---

#### 3. **Subfile Processing (`subfile` subroutine)**
Processes user choices from the subfile:

- **Change (valg=2)**: Calls the C2 maintenance panel (`xc2bld`) for the row's key.
- **Copy (valg=3)**: Calls the copy window (`xk1win`).
- **Delete (valg=4)**: Calls the delete window (`xd1win`).
- **Display (valg=5)**: Calls view mode in C2 panel.
- **Show product agreement (valg=8)**: Calls another program (`JV548R`).
- After each operation, updates the subfile row and may re-fill subfile if changes are made.

---

#### 4. **Add/Edit Functionality**

- **`xc1bld`**: Handles creation of a new row. Presents input panel, validates, optionally displays if the row exists, then calls maintenance.
- **`xc1msg`**: Message window displayed if the row to be created already exists.
- **`xc2bld`**: Main add/change/view panel logic. Handles both adding and editing; fetches key data, validates input, performs update or insert to the appropriate logical file.
- **Copy (`xk1win`)**: Logic for copying a row, includes key validation, display and invoking maintenance.
- **Delete (`xd1win`)**: Deletes the row after confirmation.

---

#### 5. **Positioning and Navigation**

- `posisjoner`: Handles setting file positions based on entered filters/positioning fields.
- On positioning, blanks out the subfile and refills it, then blanks positioning fields.

---

#### 6. **Validation and Lookups**

- **`spørring`**: Contextual lookups depending on which field is active (prisgruppe, overgruppe, hovedgruppe, etc.).
- Calls various other programs for code lookups (e.g., `RA530R` for price group, `VG510R` for groups, etc.).
- **`sjekk_key`**: Thoroughly validates all key components, ensures referential integrity for selected codes (price group, group, main group, subgroup, module, item, item type, delivery type). Also includes domain-specific validation rules (e.g., item type must be blank or 'S').
- **`finn_logivar`**: Looks up logistics item for correct pricing provider (using embedded SQL).

---

#### 7. **Special Batch Actions**

- **`xc3win`**: Batch activate all conditions for a supplier—marks relevant records as "active".

---

### **D. Utility and Key Definition Blocks**

- **KLISTs**: RPG key lists for keyed file operations are defined for every major data file, reflecting the structure of the keys in the domain (typically company code, supplier, plus various hierarchical codes for price group, group, module, etc.).

---

## **Summary of Domain and Usage**

- **Objective**: Maintain the 'freight conditions' for a supplier in a complex, hierarchical manner, supporting CRUD, paging, filtering, and validation.
- **Interaction**: Via subfile display, with function keys and pop-up panels for add/copy/delete and context-based lookups (called programs).
- **Validation**: Key fields are validated against their respective tables; constraint logic ensures, for example, that only certain fields are filled in a row, and that requested groups/modules/items exist.
- **Batch Operations**: Support for batch activation of all conditions for a supplier.
- **Data**: Maintained in a set of related files keyed by company, supplier, and various hierarchical codes (group, module, item, etc.).

---

## **Key Takeaways for Developers**

1. **Subfile-centric**: Nearly all interaction is via a subfile, a common IBM i pattern.
2. **Heavy use of function key indicators**: Program depends on RPG's indicator mechanism for flow control.
3. **Support for deep domain hierarchy**: (price group → group → main group → module → item → ...) reflected in file design and UI navigation.
4. **Modular, subroutines, external lookups**: Maintainability is helped by the use of subroutines and calls to external programs for code lookups.
5. **Legacy constructs**: Uses fixed-format RPG (C-specs, indicator-based logic), requiring some familiarity for maintenance.

---

## **Table of Main Subroutines and Their Purposes**

| Subroutine        | Purpose                                                                |
|-------------------|------------------------------------------------------------------------|
| forny            | Refreshes/renews the subfile display                                   |
| posisjoner       | Positions the subfile based on entered filter fields                   |
| subfile          | Handles row-level actions in the subfile (edit, copy, delete, view, etc.)|
| xc1bld           | Create new row - handles C1 input panel                                |
| xc1msg           | Message if row to create already exists                                |
| xc2bld           | Add/Edit/View a condition - handles C2 panel                          |
| xc3win           | Batch-activate all conditions for a supplier                          |
| xk1win           | Copy a row                                                             |
| xd1win           | Delete a row                                                           |
| xf1win           | Shows browse/alternate options panel                                   |
| clr_subfile      | Clears out the subfile (blanking it)                                   |
| crt_subfile      | Fills the subfile from the database                                    |
| bck_subfile      | Handles paging backward in the subfile                                 |
| dsp_subfile      | Manages subfile display and cursor positioning                         |
| spørring         | Contextual field lookup/codes (calls various programs as needed)       |
| sjekk_key        | Validates keys/foreign keys for a row                                  |
| aktiviser_bet    | Activates/deactivates a condition row                                  |
| finn_logivar     | Looks up logistics item for correct pricing (embedded SQL)             |

---

## **How to Onboard**

- Familiarize yourself with RPG fixed-format, subfiles, indicator logic, and key lists.
- Understand the subfile model: operations are performed on records in a 'window' over a large set of data.
- Key routines for any specific action: look for corresponding "exsr" subroutines and referenced labels.
- For validations, see `sjekk_key`, which covers all the referential integrity checks.
- For field lookups and code help, check `spørring`, which routes to various code lookup programs.
- Data model involves a lot of interrelated files, each for a specific hierarchy or code (price group, group, item, etc.).
- For expansions/maintenance, most new validation or code lookup logic would go into the relevant subroutine.
- For UI, changes mostly occur in the DDS display files, but this program’s logic will likely need adjusting to change functionality.

## **Glossary (Norwegian terms in code)**

- **betingelse**: condition
- **prisgruppe**: price group
- **overgruppe**, **hovedgruppe**, **undergruppe**: overgroup, main group, subgroup
- **modulnummer**: module number
- **varenummer**: item number
- **varetype**: item type
- **leveringstype**: delivery type
- **betingelser**: conditions
- **frakt**: freight
- **slette**: delete
- **kopiere**: copy
- **meldingsbilde**: message window
- **spørring**: inquiry (code lookup)
- **forny**: renew/refresh
- **vise**: show/view
- **opprette**: create
- **endre**: change/edit

---

With this knowledge, you are well-positioned to read, maintain, or extend `JP120R` for new business requirements or interface upgrades.