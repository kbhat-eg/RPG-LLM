# ILE RPG Program Explanation: AF500R

This RPG/400 program (AF500R in system ASPFTP) is designed for handling and displaying FTP jobs using subfiles on an IBM i (AS/400) system. It offers the functionality to query, roll, scroll, and select entries from a list (subfile) with various screen controls and display options.

## Overview

- **Main Purpose**: To display and interact with a list of FTP jobs (from file AFTPL1), allowing the user to scroll, position, and select jobs through a subfile interface.
- **Display File**: AF500D (with subfile `B1SFL` and control records).
- **Indicators**: Used for screen and process control, e.g. rolling, clearing, position cursor, protecting fields, etc.
- **Commands**: User can roll up/down, home, select a record, and position by job name.

---

## Key Sections

### File Definitions

```rpg
faftpl1    if   e           k disk    rename(aftppfr:aftpl1r)
faf500d    cf   e             workstn sfile(b1sfl:w_srrn)
                                         infds(dspfbk)
```
- **AFTPL1**: Input file containing FTP job records.
- **AF500D**: Display file with subfile support. Internal feedback is stored in structure `dspfbk`.

---

### Data Structures and Fields

- **Parameters and UDS**:
    - `p_navn`: Parameter, likely job name, structure matches `afnavn`.
    - `l_firm`: Company ID field from UDS, positions 944-946 of program status data structure.
- **DSPFBK**: Data structure for display feedback, e.g., `d_fcrn` holds the subfile cursor record number.
- **Work Variables**:  
    - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Used for subfile paging and record navigation.

  Subfile Variables Example:
    - `w_fcrn`: First record number on page.
    - `w_spge`: Page size (number of rows).
    - `w_srrn`: Relative record number.
    - `w_sfrn`, `w_ssrn`: Tracking first/last record on last page.
- **Other**:
    - `w_firm`: Company (matches DB key).
    - `b_valg_ok`: Flag to indicate selection is made.
    - `c_sfil`: Constant for subfile page size (8 records).

---

### Program Flow

#### 1. Initialization (`*inzsr` subroutine)

- Loaded on program startup.
- Receives `p_navn` parameter.
- Sets up key fields (`w_firm`, `aftpl1_navn`) and positions to the start of the file.
- Calls `crt_subfile` to fill the subfile from the database.

#### 2. Main Loop

The main logic is structured as a loop with the following tags:

- **b2taga**: Outer tag, writes `b2cmd` (cmd screen).
- **b2tagb**: Tag for displaying the subfile ("bare data" mode).

#### 3. User Input Handling

Via a `select` structure, it checks which function key indicator is set:

- `*inkc` or `*inkl`: Exit.
- `*inke`: Refresh (`forny` subroutine).
- `*in10`: Roll forward (next page).
- `*in11`: Roll backward (previous page).
- `*in21`: Home key (position cursor).
- If a job name is entered in `b2navn`, runs `posisjoner`.
- Otherwise, processes subfile interaction via `subfile` subroutine.

---

### Subroutines

#### `forny`
- Refreshes the subfile, re-chaining to the current record and refilling.

#### `posisjoner`
- Positions to the subfile record matching the entered job name (`b2navn`), clears and fills the subfile from that point.

#### `subfile`
- Handles read and selection processing for the subfile. 
- Reads changed records, checks if user has flagged them for selection (`b1valg = 1`).
- If selected, sets output params and marks `b_valg_ok` to exit main loop.

#### `clr_subfile`
- Clears the subfile area (sets indicator for clear, writes control record, resets subfile counters).

#### `crt_subfile`
- Fills subfile with records starting from current DB position up to the page size (`c_sfil`). 
- Increments counters as new records are added.
- Sets indicators when end-of-file is reached.

#### `bck_subfile`
- Scrolls back one page in the subfile by reading the previous set of records and refilling subfile.

#### `dsp_subfile`
- Handles displaying the subfile (sets indicators for control).
- Updates the current record number from display feedback data structure.

---

### Indicators Usage

- **LR**: Program end.
- **10, 11**: Roll up/down.
- **12, 13, 14, 15**: Subfile control (display, clear, end).
- **21, 22**: Home, cursor position.
- **30**: Field protection.
- **31-79**: Error/warning indicators.
- **80-99**: Work indicators.

---

### Subfile and Screen Handling

The program uses a "paged" subfile approach:

- Only a subset of the job records is shown at any time.
- Scrolling is managed by updating the database pointer and refilling the subfile as the user rolls up/down or positions.
- Allows selection of a record, which sets parameters to be returned to caller/program.

---

## Summary

**AF500R** is a classic ILE RPG subfile program for browsing and selecting FTP jobs from a file.  
- Initialization sets keys and loads the first page of jobs.
- Main loop handles user actions (scroll, refresh, position, select, exit).
- Subroutines manage subfile refill, clear, position, display, and reading user selections.
- The program leverages indicators and work variables extensively for subfile and display management.

---

### Onboarding Notes

- **Subfile logic**: Understand the paging mechanism (`w_srrn`, `w_spge`, `c_sfil`) for accurate modifications.
- **Display File**: Review AF500D for layout and indicator mapping.
- **Indicator handling**: If new function keys or screen elements are added, allocate and document new indicators.
- **Selection logic**: Outputs selection in parameter variables for further processing by the caller.

If you're new to RPG/400 or this system:  
Start by running the program in debug/tracing mode, monitor the subfile behavior as you scroll/navigate/select, and observe how the indicators and subroutines interact. This will give you practical insight into the program's flow and control structure.