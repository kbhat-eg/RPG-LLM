# RPG Source Code Explanation

## Overview

This RPG program (`FL510R`) is part of a system called **ASOFAK**. Its purpose is to display customer and customer/project information (Norwegian: "Kundeprosjekt, vise kunde/kundeprosjekt"). The code references many other programs and files, and it uses both display and disk files to gather and show data. The code includes extensive comments documenting changes over time, new features, and bug fixes.

## Main Functional Sections

### 1. File Declarations

- **Disk files** (`frkunl1`, `ffkprl1`, etc.): These are customer, project, memo, card, and other master files, accessed with specific record formats, and **renamed** for clarity.
- **Display file** (`ffl510d`): Used to interact with the user via a workstation screen.
- Some files are commented out or conditional (see version numbers on left), indicating version-specific usage (e.g., 6.31, 8.01).

### 2. Data Definitions

- **Parameters**: For firm, customer, and project numbers (`p_firm`, `p_kund`, `p_kpro`), mostly based on field types from the files.
- **Local Data Area**: Used for the program’s local data.
- **Variables for Keys**: For indexing and searching records in the files.
- **Working Variables**: For storing data needed for display and calculations (e.g., VAT, amounts, credit, dates, etc.).
- **Flags**: Like `u_s701` signals special logic (e.g., calculation extensions).

### 3. Subroutine: *INZSR (Initialization Routine)*

Called automatically at program start:

- **Parameter List Setup**: Receives firm, customer, and project as parameters.
- **Key Lists**: Defines composite keys for `CHAIN` and `SETLL` file operations, crucial for file access.
- **Parameter Retrieval**: Fetches system parameters for things like credit expansion and memo days using:
  - Call to external program `CO402R`
  - Directly reading from parameter files (some code now commented out in favor of `CO402R`)
- **Default Values**: Sets defaults for `w_memodagr` (number of memo days ― 999) and `w_utvgrns` (credit increase ― 0).
- **Conditional Logic**: If parameters returned by `CO402R` indicate, modifies behavior for the session.

### 4. Mainline Processing

#### A. **Customer Lookup and Display Preparation**

- **Customer Lookup**: Uses provided customer number to `CHAIN` the customer file. If not found, skips further lookup (`goto b1taga`).
- **Data Population**: Fills display fields from the customer master (name, address, contact info, account info, group, etc.).
- **Credit Limit Calculation**: Adjusts credit limit for display purposes (e.g., multiplies by 1000).
- **Cards**: Collects all card types for the customer by reading a related file and builds a comma-separated list of card names.

#### B. **Memo Balance and VAT (Tax) Calculations**

- If certain options are enabled (`u_s701 = *on`), may call external programs (e.g., `FO763R`) to calculate memo balances over a number of days.
- Fetches VAT (%) for calculations by calling program `RS205R` to display memo balances including VAT, and adds active orders to the balance for full visibility.

#### C. **Project Lookup**

- Looks up project information if a project is specified. Handles various fields, dates (with validation), and pops in the associated data for display.
- If a postal code is found, chains to the post office file to resolve the location name.

#### D. **Display and User Interaction**

- **EXFMT** of the screen: Presents display to the user.
- **Function Key Handling**: Several function keys perform different actions:
    - **F2**: Launches a notepad screen for notes on this customer.
    - **F13**: Shows the discount matrix.
    - **F14**: Shows special/contract prices.
    - **F15**: Shows bonus agreements.
    - **Exit**: Ends the program.

#### E. **Program End**

- Sets on LR indicator (`*INLR = *ON`) to close files and terminate the program.

## Key Programming Techniques Used

- **CHAIN/SETLL/READ**: Standard RPG operations to access and position in files.
- **KLIST/KFLD**: Composite key lists and fields for multi-part primary keys.
- **PLIST/PARM**: Parameter lists for subroutines or external programs.
- **EXFMT**: Read/format a display file record.
- **Conditional Compilation**: Changes in logic and data structure according to internal version numbers, using comments for historical documentation.
- **External Calls**: Integration with other RPG programs using CALL and parameters.
- **Variable Initialization and Conditional Logic**: For robust field population and avoidance of bad (low-value) data.

## Version/Change Management

- **Change Log**: Header documents every significant update, including bug fixes, functional enhancements, and data structure changes (with version numbers).
- **Conditional Code**: Sections of code marked with version numbers (e.g., 6.31, 7.01, 8.01) denote features or fixes introduced in specific releases.

## Key Business Logic Points

- **Data Integrity**: Checks for missing or invalid data (e.g., low-value dates).
- **Display Logic**: Builds up a consolidated customer/project view for the user.
- **Memo and Credit Calculations**: Incorporates current orders, memo balances, credit limits, and VAT for a comprehensive financial picture.
- **Parameterization**: System behaviors (like the number of days for memo calculations or credit limit extensions) are parameter-driven and can be changed without code modifications.

## Modernization Notes

- The program is a classic OPM/ILE RPG mix using both legacy C-specs and newer DCL-S/PR constructs.
- The use of newer constructs (`DCL-S`, `DCL-PR`, prototyped calls) is evident in the latest enhancements, alongside older fixed-form coding.

---

### In summary:

This program is a robust customer/project inquiry solution with deep integration into the underlying ASOFAK system, capable of presenting complex customer/project data, memo and financial status, and supporting various related inquiries with external calls and parameter-driven logic. It is well-commented and extensible, with clear documentation of modifications over time.