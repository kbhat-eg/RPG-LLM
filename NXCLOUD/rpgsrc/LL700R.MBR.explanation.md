# RPG Program LL700R - Purchase Planning System  
This explanation helps you onboard to the business logic, layout, and structure of the RPG program above, which is used for purchase planning (Innkjøpsplanlegging).

---

## 1. **Header and Change Log**
- **Header lines**: Describe the system, program name, purpose (purchase planning), with a detailed change log listing version, date, change description, and author initials.
- **Options**: `h datedit(*dmy)` means dates are in day/month/year format, `option(*nodebugio)` disables certain debugging.

---

## 2. **File Declarations**
Several physical files are declared, each renamed with a record format for easier field reference:
- `vvarl1` (Items/Product master)
- `vlagl1` (Stock/Lager)
- `sstalb` (Sales statistics)
- `sistlb` (Purchase statistics)
- `vvenl1` (Item units)
- `vverl4`, `vve2l1` (Replacement items)
- `ll700d` (Display file for screen I/O, WORKSTN)

---

## 3. **Data Structures and Variables**

### **Arrays**
- Store month names, headings, and values for sales/purchase/statistics over 13 months to support year-over-year comparison.

### **Local Data Area (LDA)**
- Retrieves company number, user, warehouse, etc., from the IBM i job LDA.

### **Parameter/Key Variables**
- `p_vare`, `p_lage`: Input item and warehouse from calling program.
- Variables like `vvarl1_vare`, `vlagl1_lage`, etc., are used for file access keys.

### **Working Variables**
- Store information about items, stock, addresses, purchase/sales/campaign info, and temporary fields for calculations and display.

### **Flags**
- Single-character indicators, e.g., `b_feil`, `b_lage`, flag state for error handling and process control.

### **Constants**
- Example: `c_null` used to pad EAN numbers.

---

## 4. **Program Flow Overview**

### **Startup**
- Calls `lag_hdng` subroutine to set up month headings.
- Loads company and warehouse from parameter or LDA.
- If an item is passed in, proceeds directly to process it; otherwise, prompts for input.

### **Main Input/Processing Loop**
- Screen displayed, waits for user action (F-keys for exit, search/lookups, scan, etc.).
- Handles exit via F3/F12, search via F4, switch to replacement item logic via F6, scanning via F13.
- Forwards to routines for display blanking, item search, warehouse lookup, sales/purchase statistics.

### **Replacement Item Logic**
- If the item is a replacement for another, looks up the original item and shows its data as well.

---

## 5. **Core Subroutines**

### **finn_vare**
- Finds and loads item information.
- If not found, sets error indicator for the screen.
- Pulls item description, unit, and calls routines for conversion factors and purchasing prices.

### **finn_lager**
- Loads warehouse-specific item info.
- If warehouse not found, sets error indicators.
- Always uses warehouse records for min/max quantities, order points, etc.
- Calculates available stock and sets display fields, including negative balance warnings.

### **finn_salg & finn_kjop**
- These load sales or purchase statistics for 13 months (current plus 12 previous).
- Handles conversion between sales and warehouse units.
- Accumulates monthly sales/purchase into arrays for display field population.

### **blank_skjerm**
- Clears all main screen fields and error indicators.

### **erst_vare / erst_lager**
- Used when dealing with replacement items.
- Looks up the replacement's item and warehouse data for display.

### **innkj_erst**
- Transfers control to the old purchase planning program for a legacy (replaced) item.

### **hent_inpri**
- Calls a pricing program (`VP750R`) to get purchasing/unit price information.

### **sjekk_lager**
- Calls a validation program to check warehouse validity, populates error flag if needed.

### **scanning**
- Handles barcode/EAN scanning entry, finds item by scanned code, or returns error if not found.

### **sp_input**
- Handles F4-inquiry operations, with logic for item number or warehouse.

### **lag_hdng**
- Builds the month headings (e.g. "Jan-2023") for a rolling 13-month display.

### **hent_omr**
- Gets the conversion factor between item units (sales unit to stock unit).

---

## 6. **Initialization Code**
- The `*inzsr` subroutine sets up file keys for chained I/O.
- Pulls in parameters, sets up company and warehouse context, gets price group per warehouse.
- Loads label text (for ordering point, etc.) from an external source if needed.

---

## 7. **Input Processing**
- The main loop responds to user input.
- Handles:
  - F3/F12 = Exit.
  - F4 = Search (shows list for item or warehouse).
  - F6 = Switch to old item if replacement exists.
  - F13 = Barcode scanning.
  - Entry of item/warehouse triggers lookups and fresh screen population.

---

## 8. **Special Comments and Norwegian Terms**
- Comments are in Norwegian, but code is generic
- Key terms:
    - "Innkjøpsplanlegging": Purchase Planning.
    - "Erstatningsvare": Replacement item.
    - "Lager": Warehouse/Stock.
    - "Bestillingspunkt": Reorder point.
    - "Hyllemin/-max": Shelf minimum/maximum.

---

## 9. **Sample Data**
- At the bottom, month names and labels for dynamic headings and screen fields.

---

## 10. **Summary Table: Key Records and Files**
| Short Name | Table         | Use                         |
|------------|--------------|-----------------------------|
| vvarl1     | Item master  | Item info                   |
| vlagl1     | Stock        | Warehouse-specific item info|
| sstalb     | Sales stat   | Sales stats, by month       |
| sistlb     | Purchase stat| Purchase stats, by month    |
| vvenl1     | Item unit    | Unit conversion             |
| vverl4     | Repl. item   | Replacement item lookup     |
| vve2l1     | Repl. item 2 | Replacement warehouse info  |

---

## 11. **Modernization/Legacy Notes**
- Classic fixed-format RPG, with some /FREE modern code for improvements (e.g., version 7.03).
- Heavy use of field names, indicators (`*inNN`), and display file-driven screen logic.
- Some routines replaced/extended over time (see changelog at the top).

---

## 12. **Where to Add Business Logic**
- Mainline is at the top, *entry is the parameter list.
- Core logic in subroutines (begsr/endsr): Extend or replace behaviors by updating or adding subroutines.
- For new input or output, modify display file (LL700D) and update associated subroutines.

---

# **Summary**
This program is a robust warehouse purchase planning tool that integrates master/item/warehouse/statistics data, supports barcode entry, and handles modern and legacy business logic, all centered around item/warehouse lookup and monthly stats display. The code is structured to support easy scaling or integration with new tables or UIs. 

For onboarding, focus on:
- The use and structure of the file accesses (chain/setll/reade).
- The main processing loop around display and F-keys.
- Business logic subroutines for calculation and display logic.
- Interaction with legacy and modularized code (external calls for price, validation, lookup, labels, etc.).