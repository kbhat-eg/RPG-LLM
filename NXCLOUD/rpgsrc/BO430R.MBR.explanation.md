# RPG Program Explanation: BO430R – ASSHOP Vedlikehold av butikk skjerm-kasse-register

This RPG program, named **BO430R**, is a maintenance application for managing screen/cash register records in the ASSHOP retail system. It is a "green screen" (5250 terminal) program using subfiles, controls, and database files to maintain the mappings and configuration for cash register screens and associated printers/output queues.

---

## 1. **Program Purpose and Overview**

- **System:** ASSHOP (Retail solution)
- **Description:** Maintenance of the screen/cash register register.
- **Functionality:** Allows create, update, display, copy, and delete operations for register/screen definitions, including associations to output queues/printers for various transaction types (order, invoice, payment, etc).
- **Notable features:** 
  - Uses subfiles for record display and maintenance.
  - Integrates with multiple files (master data, status, output queues).
  - Controls printer assignments for different transaction routines.

---

## 2. **Main Files (Databases) Used**

- **VOTYL1:** Order type register (VOTYPFR)
- **BWSDL1:** Screen/Cash register register (BWSDPFR)
- **BSTSL1:** Store status register (BSTSPFR)
- **ANUML1:** Number series register (ANUMPFR)
- **AWSDL1/AWSDLU:** Standard output queue (printer) control register (AWSDPFR)
- **BWSDLU:** Same as above for store-specific data
- **BO430D:** Display file containing screen definitions and subfiles (WORKSTN)

---

## 3. **Key Data Structures and Variables**

- **Indicator usage:** 
  - Function keys (F3=Exit, F5=Renew, F12=Cancel)
  - Subfile control (roll, display, clear, end)
  - Error signaling (indicators 31-59)
  - File operations (60-69)
- **Work variables:** For various keys and temporary fields, including ISO date/time for audit (created/edited stamps).
- **Keys:** Defined for each file lookup (KLIST/KFLD usage).

---

## 4. **Core Logic Outline**

### **Initialization (INZSR)**
- Initializes variables.
- Reads initial store/status/order type info from files.
- Builds keys for use in the rest of the program.
- Primed subfile with existing records.

---

### **Screen/Subfile Handling**

- **Subfile (SFL):** Presents a paginated list of register/screen records.
  - Supports options: Create (1), Change (2), Copy (3), Delete (4), Display (5).
- **Control and Command screens:** Handle user input, including function keys and commands for navigation and actions.

---

### **CRUD Operations**

#### **Create/Change/Display (XC2BLD subroutine)**
- Reads ("chains") the record; populates the detail screen if present.
- If creating a new record, blank fields are used.
- On save, performs validation (e.g., check number series exists for receipt number).
- Updates/creates the record and associated printer/queue assignments.
- Timestamp and user are set on changes (added in later versions).

#### **Delete (XD1WIN subroutine)**
- Prompts user for confirmation.
- Deletes the register/screen record and associated printer/queue assignments.
- Updates subfile to reflect deletion.

#### **Copy (XK1WIN subroutine)**
- Presents screen with source record details.
- Allows creation of a new record based on existing one.
- Handles same validations and subfile update.

---

### **Printer/Output Queue Assignments**

- Each screen/register can be associated with up to 5 output queues/printers for different transaction routines (order, receipt, invoice, etc).
- Assignment handled via subroutine (XUPDAT) reading/writing to the **AWSDLU** file.
- On delete, the corresponding records are removed (XSLETT subroutine).
- Uses transaction-specific routine names and keys for mapping.

---

### **Subroutines of Interest**

- **XCLR01:** Clear subfile (prepares for new display).
- **XCRT01:** Fill subfile (pagination, record enumeration).
- **XDSP01:** Display subfile control record (handles input).
- **XHENTE:** Retrieves assigned output queues/printers for each routine.
- **XUPDAT:** Updates all output queue assignments for current screen/routine.
- **XSLETT:** Deletes output queue assignments for a deleted screen/register.
- **SBLAGR:** Looks up warehouse information via a called program FØ720R.

---

## 5. **Comments and Documentation**

- Extensive comments in Norwegian explaining purpose, indicator usage, key field purposes, subfile and window mechanics.
- Comments document routines for initialization, CRUD, and printing logic.
- There are documented changes over time (version, date, programmer, description).

---

## 6. **Field/Screen/Window Naming Conventions**

- **Subfile fields:** With suffixes indicating subfile/page/line numbers.
- **Screens:** B1SFL (subfile), C1BLD (detail), D1WIN (delete), etc.
- **Windows:** S1WIN (window layout), D1WIN (delete confirm), K1WIN (copy window).

---

## 7. **Notable Details**

- **Audit trail:** Date, time, and user of last update/creation are stored (see versions 3.31 and 6.10).
- **Error checks:** e.g., receipt number must not be blank and must exist in number series register.
- **Integrations:** Warehouse lookup uses a separate program (FØ720R).
- **Subfile management:** Uses standard RPG techniques for paged data entry and navigation.

---

### **Example Workflow**

1. **User launches the maintenance screen (subfile):**
   - Sees current cash register/screen entries.
2. **User selects option (e.g., 1=Create) on a line or via command:**
   - Detail entry screen is displayed.
   - On save, validation and record update occurs, subfile is refreshed.
3. **Printing/output queue assignment:**
   - For different transaction types (sale, invoice, payment), printers are assigned per routine and stored/updated accordingly.

---

## 8. **Summary Table of Main Subroutines**

| Subroutine | Purpose |
|------------|---------|
| XCLR01     | Clear subfile and page variables. |
| XCRT01     | Fill subfile with paginated data. |
| XDSP01     | Display subfile and handle input. |
| XC2BLD     | Process create/change/display of a record. |
| XD1WIN     | Process deletion of a record. |
| XK1WIN     | Process copy of a record. |
| XHENTE     | Retrieve output queue assignments. |
| XUPDAT     | Update output queue assignments. |
| XSLETT     | Delete output queue assignments. |
| SBLAGR     | Lookup and validate warehouse info by calling external program. |
| *INZSR     | Program initialization logic. |

---

## 9. **Onboarding Tips for Developers**

- **Understand the domain:** This code manages retail registers/screens and their printer assignments, so knowledge of the retail workflow will help.
- **Subfile programming:** Familiarity with RPG subfile logic is necessary for maintenance and enhancements.
- **Indicator usage:** Classical RPG uses indicators for flow-control—a modern practice is to refactor to free-format when possible.
- **File chaining and keys:** Ensure you understand how keys (KLIST/KFLD) are defined for efficient file access.
- **Audit fields:** When updating table structures or logic, maintain audit fields (`date`, `time`, `user`).
- **Error handling:** Review error checking and messages, most of which are managed via indicator-driven display logic.

---

## 10. **Typical Program Flow**

1. **Init:** Read supporting files and prepare subfile.
2. **User Input:** Screen presented with options.
3. **Action:** Based on user selection (create, change, display, copy, delete):
    - Display relevant screen/window.
    - Validate input.
    - Update main record and printer mappings if needed.
    - Update audit fields.
    - Refresh subfile.
4. **Exit:** Program ends via F3 or F12, setting LR indicator.

---

This provides a solid base for onboarding, maintenance, or migration of the program. For changes, be cautious with file structures and the integration points with external programs and printer/output queue mapping logic.