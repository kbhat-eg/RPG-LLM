# RPG Program Explanation

## Overview

This program is written in RPG IV (ILE RPG, fixed format) for IBM i (AS/400). Its main function is to **copy records related to a company ("firma") from a set of input files to output files**, likely as part of a company data migration or duplication process. The system seems to handle both customer ("kunde") and supplier ("leverand√∏r") statistics, budgets, and parameters.

Key characteristics:
- The program loops through several files grouped by function (parameters, budgets, statistics, etc.).
- For each input record, it sets a new company number (firm) and writes to a corresponding output file.
- Some auditing info (date/time/user) is set for specific output files.
- The company number to use is passed as a parameter.

---

## Section-by-Section Breakdown

### 1. **Header and Documentation**

- The `/TITLE` directive gives the program name and description ("ASSTAT Opprydding i filer").
- The header comments contain system, program, and change history information in Norwegian.

---

### 2. **File Declarations (`F-Specs`)**

Each pair of files represents an **input** and **output** version of a logical file (e.g. `skpml1` and `skpmlu`). The `rename()` keyword is used to map the format name to a unique format for this program.

Example:

```rpg
fskpml1    if   e           k disk    rename(skpmpfr:skpml1r)
fskpmlu    o    e           k disk    rename(skpmpfr:skpmlur)
```

- `i`/`o` = input/output.
- `e` = externally-described (DDS-described file).
- `k` = keyed access.
- `disk` = database file.
- Input files (ending with `L1`) are read, output files (ending with `LU` or `PF`) are written.

#### Files cover:
- Customer parameter, budget, budget level, accumulation, statistics, and statistics (PC register).
- Supplier parameter, budget, budget level, accumulation, statistics.

---

### 3. **Data and Field Declarations (`D-Specs`)**

```rpg
d                uds
d l_user                911    920
d l_fgrp                931    933
d l_firm                944    946  0
d l_navn                951    980
*
d w_firm          s              3  0
```

- Some fields are mapped to specific byte positions (probably from a user data structure or a program status data structure).
- `w_firm` is a 3-digit (0 decimals) stand-alone variable for company number, used as a parameter.

---

### 4. **Main Logic (`C-Specs`)**

For each file pair (input/output):

1. **Set Key List:** Use `setll` and `reade` to position at the correct key (`l_firm`).
2. **Read Loop:** While records exist for the company, update the company field in the record to the **target company** (`w_firm`), then write to the output file.
3. **Repeat read.**

Sample pattern:

```rpg
c     skpml1_key    setll     skpml1                                 90
c     skpml1_key    reade     skpml1                                 90
c                   dow       *in90 = *off
c                   eval      spfirm = w_firm
c                   write     skpmlur
c     skpml1_key    reade     skpml1                                 90
c                   enddo
```

- This structure is repeated for all relevant file pairs.
- Some fields such as `spfirm`, `sbfirm`, etc., are updated to the new company number for each record.

#### **Special notes:**
- In the supplier statistics section, the program also sets date, time, and user fields for traceability:
    ```rpg
    c                   time                    siodat
    c                   time                    siotim
    c                   eval      siousr = l_user
    ```

---

### 5. **Program End**

```rpg
c                   eval      *inlr = *on
c                   return
```
- `*inlr = *on` closes all files and ends the program.

---

### 6. **Initialization Subroutine (`*INZSR`)**

- The `*inzsr` is an RPG special routine that runs **before main logic**.
- Uses the `plist` and `parm` RPG conventions to receive the company number (`w_firm`) as a program parameter.
- Initializes all key lists, associating them with the company number (`l_firm`).

Sample:

```rpg
c     *entry        plist
c                   parm                    w_firm
...
c     skpml1_key    klist
c                   kfld                    l_firm
...
```

---

## **Summary Table: File Purpose**

| File Pair            | Area          | Function                                      |
|----------------------|--------------|-----------------------------------------------|
| skpml1/skpmlu        | Customer     | Parameter register                            |
| skbul1/skbulu        | Customer     | Budget                                        |
| sknil1/sknilu        | Customer     | Budget level register                         |
| skakl1/skaklu        | Customer     | Accumulation register                         |
| skpcl1/skpclu        | Customer     | Statistics PC register                        |
| sstal1/sstapf        | Customer     | Statistics register                           |
| slpml1/slpmlu        | Supplier     | Parameter register                            |
| slbul1/slbulu        | Supplier     | Budget                                        |
| slnil1/slnilu        | Supplier     | Budget level register                         |
| slakl1/slaklu        | Supplier     | Accumulation register                         |
| sistl1/sistpf        | Supplier     | Statistics                                    |

---

## **Typical Use Case**

- You want to **copy all data for a given company (firma) from one company number to another** (e.g., for a new fiscal year, company split, etc.), possibly purging or preparing the system for a new entity.

---

## **How to Onboard/Modify**

- **Add more file pairs** if more objects need to be copied.
- **Adjust column mapping** if new fields are introduced.
- **Change key logic** in the initialization subroutine if key composition changes.
- **Update auditing** as needed in the write section if additional traceability is required.

---

## **Key RPG Concepts Used**

- Externally-described files (DDS files).
- `setll`, `reade` for keyed access and efficient reads.
- Data movement and parameter passing (`plist`/`parm`).
- Use of subroutine (`*inzsr`) for initialization.
- Control fields for file handling (`*inlr`).

---

**In summary:**  
This RPG program acts as a batch data migrator for company-related transactional and master data across the system, making it easy to duplicate or reorganize company data in a controlled, auditable way.