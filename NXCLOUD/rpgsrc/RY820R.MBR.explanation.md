# RY820R â€“ Matche-Register Update Program

## Purpose

This program, `RY820R`, is designed to update the "matche-register" (matching register) by reading through its records and synchronizing certain fields with the latest information from the item master file ("vareregister"). The program is part of the ASVADM system and was originally created in December 1998.

## Business Logic Overview

- **Matche-register** (`jmatl1`, `jmatlu`): Contains records that reference items and related data, potentially representing links between items and other entities.
- **Vareregister** (`jvarl1`): The master item register, holding authoritative item information.

The program iterates through the matche-register, and for records referencing a valid item, it pulls the latest data from the vareregister. If the data in the matche-register is outdated, it updates it accordingly.

## File Definitions and Relationships

- **jmatl1**: Matche-register (read-only, primary input)
  - Renamed record format: `jmatl1r`
- **jvarl1**: Vareregister (read-only, used for lookup)
  - Renamed record format: `jvarl1r`
- **jmatlu**: Matche-register (update-capable, used for updating)
  - Renamed record format: `jmatlur`

> **Note:** The program uses two logical views or access paths over the matche-register (read and update), which is a common pattern to avoid record lock conflicts or to utilize different key definitions.

## Key Variables and Data Areas

- **l_firm**: Firm identifier, retrieved from the *LDA (Local Data Area). Used as part of the key for all file accesses, ensuring operations are firm-specific.
- **jvarl1_vare**: Temporary variable for item number, used as a key to the vareregister.
- **jmatlu_var1**: Temporary variable for item number, used as a key to the update file.

## Main Processing Flow

### 1. Initialization

- The *INZSR subroutine initializes key lists for file access and retrieves the firm number from the LDA into `w_firm`.
- Key lists are set up for:
  - Reading the matche-register (`jmatl1_key`)
  - Looking up items in the vareregister (`jvarl1_key`)
  - Updating the matche-register (`jmatlu_key`)

### 2. Main Loop

- The program sets the file pointer at the start of the matche-register for the current firm and reads each record in sequence.

#### For each matche-register record:

1. **Skip if Reference Missing:**  
   If the `jovar2` field (item reference in matche-register) is blank, the record is skipped.

2. **Lookup in vareregister:**  
   - The program sets `jvarl1_vare` to `jovar2` and performs a keyed lookup (`CHAIN`) in the vareregister.
   - If the item is found (`*IN91 = *OFF`) and the `joldo2` field (likely a cached field in matche-register) does not match the current value from the vareregister (`jvldor`):

      1. **Prepare for Update:**  
         - Sets `jmatlu_var1` to `jovar1` (item number/key for update).
         - Performs a keyed lookup on the update-capable matche-register file (`jmatlu`).

      2. **Update if Found:**  
         - If the record is found, updates `joldo2` in the matche-register to the latest value from the vareregister (`jvldor`).
         - Writes the change back to the file.

3. **Continue to Next Record:**  
   The loop repeats for the next record in the matche-register.

### 3. Program Termination

- After processing all records, the program sets on the LR indicator (`*INLR = *ON`) and returns, ending the program.

## Notable Design Decisions and Conventions

- **Dual Access Paths:**  
  Use of both `jmatl1` (read) and `jmatlu` (update) over the same physical file is a deliberate design to handle read and update operations cleanly.

- **Key List Initialization:**  
  All keys are set up explicitly in *INZSR, which is the convention in this codebase for clarity and maintainability.

- **LDA Usage:**  
  The firm number is always sourced from the LDA, ensuring that all operations are scoped to the correct business entity and supporting multi-firm environments.

- **Field Synchronization:**  
  Only updates the matche-register when the reference field (`joldo2`) differs from the authoritative value in the vareregister, minimizing unnecessary writes.

- **Error Handling:**  
  The program assumes that missing references or keys (e.g., blank `jovar2` or missing vareregister records) should be skipped without error; this should be kept in mind if adding audit or error reporting.

## External Dependencies and Interactions

- **Files:**
  - `jmatpfr`: Physical file underlying both `jmatl1` and `jmatlu` logicals.
  - `jvarpfr`: Physical file for the vareregister.

- **LDA:**  
  Used to obtain the firm number for all file access.

## Typical Use Case

This program is likely run as a batch job to ensure that the matche-register always reflects the latest item master data, specifically for the `joldo2` field, which is synced from the vareregister's `jvldor` field whenever it changes.

---

**In summary:**  
RY820R is a batch updater for the matche-register, aligning cached fields with the vareregister for the current firm. It is structured for reliability, multi-firm support, and efficient record processing, following conventions typical in this codebase for file access and key management.