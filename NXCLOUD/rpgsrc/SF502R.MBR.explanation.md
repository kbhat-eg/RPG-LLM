# RPG Program SF502R — Sales Statistics Inquiry by Item

## Purpose and Business Context

This program (`SF502R`) is a core inquiry tool within the ASSTAT system, designed for interactive querying and display of sales statistics for a given item (product) over a specified year and company. It supports drill-downs and auxiliary actions such as viewing invoices, printing invoice copies, and exporting data to Excel/XML for further processing or reporting. The program is heavily integrated with both legacy DDS-based subfile screens and modern reporting/export functionality (Jasper/XML/Excel integration).

**Key business functions:**
- List and navigate sales transactions for an item.
- Drill-down to transaction details, invoices, and receipts.
- Export sales data for external analysis (Excel/XML).
- Integrate with archive and document management for historical lookups.

## High-level Structure

- **Display logic:** Uses DDS subfiles (`B1SFL`, `B2CTL`, `B2CMD`) for interactive display and navigation.
- **Database access:** Reads from multiple logical files, all renamed, representing sales, customer, project, invoice, and more.
- **Export logic:** Generates XML/Excel via Jasper integration for reporting.
- **Integration:** Calls several external programs for business processes (invoice viewing, printing, logging, etc.).

## File Declarations and Data Relationships

The program accesses a range of files, each representing key business entities:

- **Sales statistics files:** `sstal9`, `sstala`, `sstalb`, `sstalc`, `sstald` — each provides a different logical view/index for querying sales transactions.
- **Item master:** `vvarl1`, `vvasl1`
- **Customer master:** `rkunl1`
- **Customer project master:** `fkprl1`
- **Invoice/receipt header:** `sohel1`, `bohel1`
- **Company and routine info:** `afirl1`, `aforl1`
- **Order type:** `votyl1`

These files are accessed via keys constructed from parameters and user input, supporting flexible navigation and positioning in the data.

## Key Variables and Parameters

- **Parameters:** Company (`p_firm`), year (`p_paar`), item number (`p_vare`), customer (`p_vkun`), project (`p_kpro`), and document date (`p_bida`) — passed to the program at startup.
- **Work variables:** Used for subfile control (record numbers, counters), navigation, and export logic.
- **Local Data Area (LDA):** Used for session and environment information (user, workstation, company, etc.).
- **Subfile variables:** Control display and navigation within the subfile (first/last record, page size, etc.).

## Indicator Usage

The program uses indicators extensively, following a local convention:
- `LR` for last record (program end)
- 10–15 for subfile navigation and display
- 21–22 for cursor/home key management
- 30 for field protection
- 31–79 for error/warning messages
- 80–99 for work indicators

## Main Processing Flow

### 1. Program Initialization (`*inzsr`)
- Reads input parameters and populates working variables.
- Retrieves item and customer/project names for display.
- Initializes subfile by positioning and loading the first page.
- Determines if Jasper/XML export is enabled and fetches company/department info if required.

### 2. Main Display Loop

#### a. Display and Command Handling
- Uses `B2CTL`/`B2CMD` screens for display and command entry.
- Handles function keys for:
  - Page up/down
  - Drill-down queries
  - Refresh/reload
  - Export to Excel/XML
  - Positioning (by customer, project, date, invoice/order number)
  - Archive lookup (calls external archive program)

#### b. Subfile Management
- **Subroutines for subfile operations:**
  - `clr_subfile`: Clears subfile and resets counters.
  - `crt_subfile`: Loads next page of data into subfile, applies filters from parameters.
  - `bck_subfile`: Loads previous page.
  - `subfile`: Handles user actions on subfile rows (view, print, export, etc.).
  - `dsp_subfile`: Manages display and feedback from subfile.

#### c. Drill-down and Actions
- **View invoice/receipt:** Calls `SO510R` or `BO310R` depending on transaction type.
- **Print invoice copy:** Calls `FO681R`, with logic to handle legacy receipt numbers.
- **Export to Excel/XML:** Generates XML using Jasper templates, writes to IFS, and optionally notifies external systems via data queue.

#### d. Archive Lookup
- For order types with archiving, calls `AP622C` to retrieve historical documents.

### 3. Export to Excel/XML (Jasper Integration)

- **Trigger:** User presses export key (if enabled).
- **Process:**
  - Fetches Jasper XML template.
  - Generates unique batch/job number (via `AS100R`, `AB700R`).
  - Logs export start (via `AB705R`).
  - Writes XML header and environment info.
  - Iterates through all qualifying sales records, writing detail lines.
  - Writes XML footer.
  - Saves XML to IFS.
  - Optionally notifies sniffer/Java process via data queue (`AP629C`).
  - Calls preview program to launch resulting Excel file in browser.

### 4. Query and Positioning Logic

- **Positioning:** Supports direct positioning in the subfile by customer, project, date, invoice, or order number.
- **Query subroutines:** Allow user to search for customer or project via external programs (`RK500R`, `FL500R`), returning selected values.

### 5. Subroutines for XML/Export Integration

- `pdf_batchno`: Generates unique batch/job number for export.
- `xml_envm`, `xml_head`, `xml_head_val`, `xml_detal`, `xml_line_val`, `xml_end`: Build the XML structure for export, including headers, detail lines, and footer.
- `pdf_preview`: Triggers browser launch of the generated Excel file.

## Notable Design Decisions and Patterns

- **Subfile Paging:** Manual management of subfile pages, with explicit counters for first/last/next/previous, supporting large result sets and efficient navigation.
- **Flexible Positioning:** Multiple index paths (logical files) and key lists allow users to position and filter data by different business keys.
- **Modular External Calls:** Business logic (viewing/printing invoices, archive lookup, batch/job management) is delegated to external programs, promoting reuse and separation of concerns.
- **Export Integration:** Uses Jasper/CGIDEV2 for modern export/reporting, with variables and sections managed via helper procedures (`UpdHTMLVar`, `WrtSection`, etc.).
- **Legacy and Modern Coexistence:** The program bridges classic DDS/subfile UI with modern browser-based export/reporting, supporting both legacy and new workflows.
- **Indicator-driven Control:** Heavy use of indicators for state control, following local conventions.

## Interactions with Other Modules and Systems

- **External Programs:**
  - `SO510R`, `BO310R`: View invoice or receipt.
  - `FO681R`: Print invoice copy.
  - `AP622C`: Archive document lookup.
  - `AP613R`: Text translation/encoding for XML.
  - `AB700R`, `AS100R`, `AB705R`: Batch/job number and logging for export.
  - `AP609R`, `AP621R`, `AP629C`: Jasper/XML integration and browser launch.
  - `FØ707R`: Fetch company/department info for document header.
  - `RK500R`, `FL500R`: Customer/project search.

- **Data Queues:** For triggering export/sniffer processes.

- **IFS (Integrated File System):** For storing and serving generated XML/Excel files.

## Conventions and Special Notes

- **File Naming:** Logical files are renamed for clarity and to avoid conflicts.
- **Field Naming:** Prefixes (`w_`, `b1`, `b2`, etc.) denote working, subfile, or screen variables.
- **Commenting:** The program is well-commented (in Norwegian), explaining business logic, indicator usage, and special field purposes.
- **Versioning:** Change history is maintained in the header comments, with references to business-driven enhancements.

## Summary Table — Key Subroutines

| Subroutine      | Purpose                                                        |
|-----------------|----------------------------------------------------------------|
| `forny`         | Refreshes subfile data after navigation/filter change          |
| `posisjoner`    | Positions subfile based on user input (customer, project, etc.)|
| `subfile`       | Handles user actions on subfile rows                           |
| `clr_subfile`   | Clears subfile and resets counters                             |
| `crt_subfile`   | Loads next page of data into subfile                           |
| `bck_subfile`   | Loads previous page of data into subfile                       |
| `dsp_subfile`   | Manages display of subfile and feedback                        |
| `spørring`      | Handles customer/project search pop-ups                        |
| `vise`          | Drill-down to invoice or receipt display                       |
| `skriv`         | Prints invoice copy                                            |
| `exl_eksport`   | Exports data to XML/Excel via Jasper integration               |
| `pdf_batchno`   | Generates batch/job number for export                          |
| `xml_*`         | Build XML structure for export                                 |
| `pdf_preview`   | Launches browser to preview exported file                      |

---

## Onboarding Notes

- **Understanding subfile logic** is crucial, as navigation and display are highly interactive and indicator-driven.
- **External program interfaces** are central to the business process; be familiar with the expected parameter flows.
- **Export/Integration** leverages Jasper and CGIDEV2 routines—review those utilities for deeper understanding.
- **Indicator conventions and local data area** usage are consistent across the codebase; refer to this program as a model for related inquiry/reporting programs.

---

For further details, review the prototypes and copy members included (`prototypeb`, `usec`, `hspecsbnd`), as well as the DDS for subfile definitions. The program is a template for similar inquiry/report modules in the ASSTAT system.