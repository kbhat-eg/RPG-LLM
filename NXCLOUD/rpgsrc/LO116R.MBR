     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASLAGR
      * Program . . . . : LO116R
      * Beskrivelse . . : Oppdatering av fakt.reg, økonomi og stat.
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       080805 HKO  Fjernet oppdatering av nettovekt, bruttovekt og
      *                   volum fra innkjøpsstatistikken
      *       230805 BOF  Oppdatere leveringsdato og uke               og
5.69  * R5.69 261109 AMD  Korrigering for år 2010
5.70  * PRGR  021208 bof  Utvidet med prisgruppe
      * 6.10  220609 BSA  Oppdatert med sporingsinformasjon
6.20  * 6.20  221110 NHO  Proj er nå alfa
6.21  * 6.20  090511 BSA  Hvis valutabeløp på bestilling, må vi regne om
6.21  *                   til NOK.
6.22  * 6.20  120112 BSA  Utvidet VP750R med kampanje
6.23  * 6.20  130112 BSA  Legger ut EDI meldingsnummer på innkjøpsstatistikk
6.24  * 6.20  160512 ASK  Fjerner kreditreferanse (lev.faknr) på h.bok post
6.25  * 6.20  091013 bsa  Må nullstille omregningsfaktorer mellom hver post
6.25  *                   vare                                         post
6.30  * 6.30  060214 bof  Oppdaterer virk.lev.dato og bekref.lev.dato
6.nu  * 6.30  100614 bof  Utvidelse mtp. nummerutvidelse
6.31  * 6.30  020914 bof  Utvidet med div. felter som oppdat. fra bestilling
6.32  * 6.30  160914 bsa  Innført mva postering av linjer
6.33  * 6.30  300515 bsa  Overfører prosjekt til økopostering.
6.34  * 6.30  101115 bsa  Mangler å nullstille overgruppe.
6.35  * 6.30  241116 bsa  Ny mva håndtering.
6.36  * 6.30  210617 bsa  Må nullsttille linjenummer pr bilagsnummer
6.37  * 6.30  080216 bsa  Legge ut GTIN nummer fra bestilling
6.38  * 6.30  101018 bof  Utvidet med trelast sortiment
6.31s * 6.30  131118 sst  Legt på igjen siupro.
6.33s * 6.30  281019 sst  Legt på igjen lgupro. bruke loproj og loakti på linjer
      *
7.00  * K00   150720 ask  Lagt inn timestamp for loggoppfølging og skriv til loggfiler
7.01  * K00   040321 ask  Utvidet teller for logg linjer
7.11  * 7.00  230216 ask  Lagt inn "CLEAR" av vvar og jvar før les for å
7.11  *                   håndtere linjer med ldvare = '00000000'
7.11  *       140116 ask  Henter modulnr fra JVARPF når varen ikke finnes i EVR
7.12  * 6.30  231017 sst  Endringer vedr prosjekt
7.02  * K00   220321 ask  Lagt inn logging på bilagsnummer nivå
      *
8.01  * 800   280521 ask  Lagt inn firma i sql der det manglet
8.02  * 800   040422 sst  Legger ikke ut +/- reskontro postering når fakturautsteder er utfylt
      *                    hvis switch 'INNKJØP_IKKE_DOBBEL_RESKONTROPOST' er på
8.03  * 800   270422 sst  Logge hva som skjer ved reskontroføring ved F2/vlg 16 for test
      *                   Tatt ut igjen 06.05.2022 men finnes i sst_cloud i tilfelle
8.08  * 800   150323 ask  Lagt inn nye felter i utvidet logregister for regnskapstranser
8.09  * 800   170323 ask  Overstyrer funksjon fra 8.02 om switch 'POG_TRANS' er på
      *                   Setter også reskontro leverandør til vare lverandør om switch er på.
8.10  * 800   050523 ask  Funksjon i 8.09 er foreløpig skrudd av
8.11  *PRG2   160622 BOF  Utvidet prisgruppe fra 1 til 2 posisjoner
8.12  * 800   170424 BOF  Endring vedr. hvor man tar leverandør / nobbnr fra.
8.12a * 800   310524 ask  Endret summering på logg hode, samstemt med FO616R
8.13  * 800   040425 ask  Rettet feil i switch test
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flpsol1    ipe  e           k disk    rename(lpsopfr:lpsol1r)
     frlevpf    if   e           k disk    rename(rlevpfr:rlevlnr)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
     fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
     fvkhvl1    if   e           k disk    rename(vkhvpfr:vkhvl1r)
     flohel1    if   e           k disk    rename(lohepfr:lohel1r)
     flodtl1    if   e           k disk    rename(lodtpfr:lodtl1r)
     flotxl1    if   e           k disk    rename(lotxpfr:lotxl1r)
     fsihelu    uf a e           k disk    rename(sihepfr:sihelur)
     fsidtlu    uf a e           k disk    rename(sidtpfr:sidtlur)
6.21 fra16l1    if   e           k disk    rename(ra16pfr:ra16l1r)
     fsistpf    o  a e             disk
4.01 flovfpf    o  a e             disk
7.11 fjvarl3    if   e           k disk    rename(jvarpfr:jvarl3r)
      *
      * Definering av arrays
      *
     d etx             s             10    dim(4) ctdata perrcd(1)
      *
      * Definering av parametere
      *
     d p_parm          s             28
      *
      * Definering av lda
      *
      * Eksternt program
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
7.02 d u_dobbel_resk   s              1    inz(*on)
8.09 d u_pogtr         s              1    inz(*off)
     d                uds
6.10 d l_user                911    920
8.02 d l_filg                931    933
     d l_peri                561    566  0
     d l_fkda                567    576d   datfmt(*iso)
     d l_ruti                871    880
      *
      * Datastruktur for parameter inn
      *
     d                 ds
     d d_parm                        28
     d  d_aarr                        4  0 overlay(d_parm)
     d  d_otyp                        2    overlay(d_parm:5)
     d  d_batc                        6  0 overlay(d_parm:7)
     d  d_prog                       10    overlay(d_parm:19)
      *
      *  Datastruktur for oppdeling av fritekst
      *
     d                 ds
     d d_frix                        70
     d  d_fri1                       30    overlay(d_frix)
     d  d_fri2                       30    overlay(d_frix:31)
     d  d_fri3                       10    overlay(d_frix:61)
      *
      * Datastruktur for kontoinformasjon
      *
     d                 ds
     d d_hele                       128
     d  d_kav1                        4  0 overlay(d_hele)
     d  d_kko1                        6  0 overlay(d_hele:5)
     d  d_ksp1                        4  0 overlay(d_hele:11)
     d  d_kav2                        4  0 overlay(d_hele:15)
     d  d_kko2                        6  0 overlay(d_hele:19)
     d  d_ksp2                        4  0 overlay(d_hele:25)
     d  d_kav3                        4  0 overlay(d_hele:29)
     d  d_kko3                        6  0 overlay(d_hele:33)
     d  d_ksp3                        4  0 overlay(d_hele:39)
     d  d_kav4                        4  0 overlay(d_hele:43)
     d  d_kko4                        6  0 overlay(d_hele:47)
     d  d_ksp4                        4  0 overlay(d_hele:53)
     d  d_kav5                        4  0 overlay(d_hele:57)
     d  d_kko5                        6  0 overlay(d_hele:61)
     d  d_ksp5                        4  0 overlay(d_hele:67)
     d  d_kav6                        4  0 overlay(d_hele:71)
     d  d_kko6                        6  0 overlay(d_hele:75)
     d  d_ksp6                        4  0 overlay(d_hele:81)
     d  d_kav7                        4  0 overlay(d_hele:85)
     d  d_kko7                        6  0 overlay(d_hele:89)
     d  d_ksp7                        4  0 overlay(d_hele:95)
     d  d_khnv                        4    overlay(d_hele:99)
      *
      * Definering av variable i nøkler
      *
     d rlevln_levr     s                   like(rllevr)
     d vvarl1_vare     s                   like(vvvare)
     d vvenl1_vare     s                   like(vevare)
     d vugrl1_uogr     s                   like(vguogr)
     d vugrl1_uhgr     s                   like(vguhgr)
     d vugrl1_uugr     s                   like(vguugr)
     d vkhvl1_kkod     s                   like(vakkod)
     d votyl1_otyp     s                   like(vaotyp)
     d vltyl1_ltyp     s                   like(valtyp)
     d lohel1_numm     s                   like(lonumm)
     d lohel1_suff     s                   like(losuff)
     d lodtl1_numm     s                   like(ldnumm)
     d lodtl1_suff     s                   like(ldsuff)
     d lodtl1_line     s                   like(ldline)
     d lotxl1_numm     s                   like(ltnumm)
     d lotxl1_suff     s                   like(ltsuff)
     d lotxl1_line     s                   like(ltline)
     d sihelu_aarr     s                   like(shaarr)
     d sihelu_binr     s                   like(shbinr)
     d sihelu_numm     s                   like(shnumm)
     d sihelu_suff     s                   like(shsuff)
     d sidtlu_aarr     s                   like(slaarr)
     d sidtlu_binr     s                   like(slbinr)
     d sidtlu_numm     s                   like(slnumm)
     d sidtlu_suff     s                   like(slsuff)
     d sidtlu_ktxt     s                   like(slktxt)
     d sidtlu_line     s                   like(slline)
6.21 d ra16l1_pkod     s                   like(rapkod)
7.11 d jvarl3_nobb     s                   like(jvnobb)
      *
      *
      * Definering av parametre ut
      *
     d p_firm          s                   like(ldfirm)
     d p_vare          s                   like(ldvare)
     d p_anta          s                   like(ldanta)
     d p_ipny          s                   like(ldipny)
     d p_kplj          s                   like(ldkplj)
      *
      * Definering av variable
      *
     d w_firm          s                   like(ldfirm)
     d w_ldor          s                   like(loldor)
     d w_resk          s                   like(loldor)
6.21 d w_valk          s                   like(lovalk)
6.21 d w_pmku          s                   like(rapmku)
     d w_csts          s              1
     d w_ctxt          s             20
     d w_ctx2          s             20
     d w_dato_6        s              6  0
     d w_dato          s               d   datfmt(*iso)
     d w_lety          s              1  0
     d w_enhe          s                   like(ldenh1)
     d w_kopr          s                   like(ldkpny)
     d w_inpr          s                   like(ldipny)
     d w_omrs          s                   like(veomre)
     d w_omrk          s                   like(veomre)
     d w_anta          s             11  3
     d w_stat          s              1    inz(*off)
     d w_saar          s              4  0
     d w_suke          s              2  0
8.11 d w_prgr          s              2
5.70 d w_avde          s              4  0
6.22 d w_kamp          s              5
6.32 d w_mvap          s              6  2
6.32 d w_mvat          s              5  4
6.32 d w_mvaf          s             10  9
6.32 d wlbelx          s             11  2
6.32 d w_msta          s              1
6.32 d w_mvak          s              1
6.32 d w_mvtx          s             30
6.32 d w_bpro          s              5  2
6.32 d t_mvag          s             11  2
6.32 d t_mkod          s              1
6.32 d w_mvag          s             11  2
6.32 d w_mdat          s               d   datfmt(*iso)
6.38 d w_utda          s                   like(vvedat)
6.38 d w_lv_ldor       s                   like(vvldor)
6.38 d w_lv_vtyp       s                   like(vvvtyp)
6.38 d w_lv_nobb       s                   like(vvnobb)
6.38 d w_lv_modn       s                   like(vvnmod)
6.38 d w_lv_lldo       s                   like(vvldor)
6.38 d w_lv_lvar       s                   like(vvlvar)
6.38 d b_inlr          s              1    inz(*off)
      *
      * Definering av variable som
      * ikke er lagt om til ny standard
      *
     d mvafra          s             10  9
     d mvapro          s              6  2
     d mvatil          s              5  4
     d subaar          s              2  0
     d subarb          s              2  0
     d subdag          s              2  0
     d subdam          s              4  0
     d subdat          s              8  0
     d subdmy          s              6  0
     d submnd          s              2  0
     d teller          s              4  0
     d tstaar          s              4  0
     d whlp20          s              2  2
     d wkaaaa          s             11  0
     d wkbbbb          s             11  0
     d wktext          s             20
     d wlanta          s                   like(ldanta)
     d wlbelb          s             11  2
     d wlbeln          s             12  3
     d wlbelo          s             11  2
     d wlbelw          s             11  2
     d wlipny          s                   like(ldipny)
     d wlkost          s             11  2
     d wlrec           s             70
     d wlrkro          s             11  2
     d wlrkr1          s             11  2
     d wlrkr2          s             11  2
     d wofkda          s              6  0
     d woperi          s              4  0
     d wpeaar          s              2  0
     d wpemnd          s              2  0
     d wphele          s            128
     d wphgrp          s              2  0
     d wpogrp          s              2  0
     d wpotyp          s              2
     d wpstat          s              1
     d wpugrp          s              3  0
     d wpvare          s             15
     d wsbatc          s              6  0
     d wsfast          s             10
     d wsfell          s              6
     d wskode          s              1
6.nu d wsnumm          s              8  0
     d wstype          s              2
     d wtakti          s              3
4.01 d wtanta          s              9  2
     d wtavde          s              4  0
     d wtbelh          s             11  2
6.nu d wtbinr          s              8  0
     d wtbili          s              4  0
     d wtbunt          s              5  0
     d wtdate          s              6  0
     d wtffda          s              6  0
     d wtfkda          s              6  0
     d wtkkod          s              1
     d wtkode          s              2  0
     d wtkont          s              6  0
     d wtkref          s              6  0
     d wtllev          s                   like(lolele)
4.01 d wtmkod          s              1
     d wtperi          s              4  0
6.20 d*wtproj          s              6  0
6.20 d wtproj          s              6
6.21 d wtarbo          s              6
7.12 d wtupro          s              6
     d wtspes          s              4  0
     d wtstat          s              1
     d wtsums          s             11  2
     d wttime          s              6  0
     d wtvalg          s              1  0
     d wv002r          s              1
     d wwtest          s              1
     d w2kjof          s             11  2
     d w2kjop          s             11  2
     d w2kstf          s             11  2
     d w2kstp          s             11  2
     d w2rbgf          s             11  2
     d w2rbgp          s             11  2
     d w2rkof          s             11  2
     d w2rkop          s             11  2
     d w2rk1f          s             11  2
     d w2rk1p          s             11  2
     d w2rk2f          s             11  2
     d w2rk2p          s             11  2
6.32 d w2mvgp          s             11  2
6.32 d w2mbel          s             11  2
     d w6fsum          s                   like(lototi)
     d w6hlp1          s                   like(lototi)
     d w6hlp2          s                   like(lototi)
     d w6hlp3          s                   like(lototi)
     d w6hsum          s             11  2
     d w6kjof          s             11  2
     d w6kjop          s             11  2
     d w6rkof          s             11  2
     d w6rkop          s             11  2
     d w6rk1f          s             11  2
     d w6rk1p          s             11  2
     d w6rk2f          s             11  2
     d w6rk2p          s             11  2
6.32 d w6mbel          s             11  2
7.00 d w_logg          s               z
7.01 d w_lintel        s              8  0
7.00 d w_sumbel        s             11  2
8.12ad w_dsum          s             12  2
8.12ad w_ksum          s             12  2
7.00 d w_dumtim        s               z
7.00 d w_dumsum        s             11  2
7.00 d w_dumusr        s             10
7.00 d w_dumerr        s              2
7.00 d w_dumkki        s              8  0
7.00 d w_dumkkk        s              1  0
8.08 d w_dumd20        s              2  0
7.00 d w_dumaki        s             25
7.02 d w_dumant        s              5  0
8.09 d w_faka          s             13
8.09 d w_fakl          s             13  0
8.09 d w_fako          s             13  0
      *
     ilpsol1r       01
     i                                          lkssrt        l6
     i                                          lksonr        l3
     i                                          lkssuf        l2
7.00  *
7.00 C/Exec SQL
7.00 C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR,
7.00 C+             commit=*none
7.00 C/End-Exec
      *
      *  Notater / tips til programmet
      *  -------------------------------
      *  Det er her notert ned en del tips, som dokumentasjon til
      *  hvordan dette programmet fungerer.  Det er en del forut-
      *  setninger som det er viktig å være klar over:
      *
      *  01) Alle beløp som oppdateres i fakturaregister er eks. mva.
      *      (Fakturaregister = SIHEPF og SIDTPF)
      *
      *  02) En faktura kan bestå ev flere ordre, dersom det er åpnet
      *      for dette.
      *      L2 - brudd = Slutt på ordre
      *      L6 - brudd = Slutt på faktura
      *      Det genereres automatiske posteringer på L6 brudd. Dette
      *      kan være frakt / gebyr / påslag.  Ordrehode inneholder
      *      akkumulatorer for ordresummer.  Flere ordre kan derfor
      *      måtte summeres opp til fakturatotaler.
      *      Frakt / gebyr / påslag legges til ordrehode på siste
      *      ordre på faktura.
      *
      *  03) Alle beløp i ordreregister er lagret med positive fortegn
      *      Ordretyper og linjetyper styrer om det er negative ordre
      *      eller negative linjer.  Men i oppdatering av faktura-
      *      register, legges alle poster ut med ferdig fortegn. (+/-)
      *
      *  04) Det er foreløpig noe problemer med beregning av vare-
      *      linjen's andel av ordrerabatt i ordresystemet.  Det er
      *      derfor lagt inn beregning i dette programmet, for å få
      *      riktig oppdatering av fakturaregisteret.  Det er aktuelt
      *      å flytte dette tilbake til ordreprogrammet på sikt, men
      *      det bør tas sammen med en gjennomgang av databasen for å
      *      få tatt alt samtidig.
      *
      *  05) Programmet har tatt høyde for å kunne håndtere varelinjer
      *      som er avgiftsfrie sammen med pliktige på samme faktura.
      *      Det ligger et felt (SOTOTX) som inneholder fritt salg.
      *      Det er viktig å være klar over at dette feltet er redusert
      *      med både linjerabatt og varelinjens andel av eventuell
      *      ordrerabatt.  Dette for å kunne få riktig grunnlag for
      *      merverdiavgift.
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av valg
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Subrutine som kjøres første gang programmet kjøres (Kun en gang)
      *
     c   01*in99         caseq     *off          fcycle
     c                   endcs
      *
     c                   if        *inl6 = *on
     c                   exsr      l6inn
     c                   endif
     c                   if        *inl2 = *on
     c                   exsr      l2inn
     c                   endif
      *
      *  Hopp til rett behandling   (Hode, Linje, Tekst)
      *
     c     lkskod        cabeq     'H'           tag01
     c     lkskod        cabeq     'V'           tag02
     c     lkskod        cabeq     'K'           tag03
     c                   goto      slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av BESTILLING-HODE-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag01         tag
      *
      *  Hent opplysninger fra BESTILLING-HODE-REGISTER
      *
     c                   eval      lohel1_numm = lksonr
     c                   eval      lohel1_suff = lkssuf
     c     lohel1_key    chain     lohel1r                            90
      *
5.70 c                   exsr      hent_prisgr
      *
      *  Henter inn bilagsnummer  (Dersom ikke utfylt)
      *
     c                   if        lobinr = 0
     c                   eval      wsfell = laabin
     c                   eval      wstype = lksoty
     c                   eval      wskode = '0'
     c                   exsr      hntnum
     c                   eval      lobinr = wsnumm
     c                   endif
      *
     c                   eval      sihelu_binr = lobinr
     c                   eval      sidtlu_binr = lobinr
     c                   eval      wtbinr      = lobinr
6.21 c                   eval      w_valk      = lovalk
6.21  * Hvis valutakode er forkjellig fra blank/NOK, må vi finne faktor for omre
6.21 c                   if        lovalk <> *blank or
6.21 c                             lovalk <> 'NOK'
6.21 c                   exsr      val_faktor
6.21 c                   endif
      *
      *  Hent opplysninger fra LEVERANDØR-REGISTER
      *
     c                   eval      rlevln_levr = loldor
     c     rlevln_key    chain     rlevlnr                            90
      *
      *  Fakturaleverandør?
      *
     c                   if        loflev <> 0
     c                   eval      w_ldor = loflev
     c                   eval      w_resk = loflev
     c                   else
     c                   eval      w_ldor = loldor
     c                   eval      w_resk = loldor
     c                   endif
8.09  *
8.09  * Hvis det er sendt fohåndsbetalingstranser til POG skal vareleverandør brukes i reskontro
8.09  *
8.09      if u_pogtr = *on and
8.09         loflev > 0;
8.09        exec sql
8.09          select rleanl
8.09            into :w_fako
8.09          from rlevpf
8.09          where rlfirm = :W_firm and rllevr = :loflev;
8.09        if w_fakl = w_fako;
8.09          w_ldor = loldor;
8.09          w_resk = loldor;
8.09        endif;
8.09      endif;
      *
      *  Legger inn faktura-dato dersom ikke overstyrt
      *
     c                   if        lofkda = *loval
     c                   eval      lofkda = l_fkda
     c                   endif
      *
      *  Beregner forfalls-dato  dersom ikke overstyrt
      *
     c                   if        loffda = *loval
     c                   call      'FÅ703R'
     c                   parm                    lksfir
     c                   parm                    lobetb
     c                   parm                    lofkda
     c                   parm                    w_csts
     c                   parm                    loffda
     c                   parm                    w_ctxt
     c                   parm                    w_ctx2
     c                   endif
      *
      *  Finner hvilken mva-sats som skal benyttes
      *
     c                   call      'FÅ705R'
     c                   parm                    lksfir
3.31 c                   parm                    l_fkda
     c                   parm                    mvapro
     c                   parm                    mvatil
     c                   parm                    mvafra
      *
      *  Legger inn bilagskode fra ordretype i hjelpevariabel
      *
     c                   eval      wtkode = vaobil
      *
      *  Snur faktura/forfalls-dato før utlegging til regnskap
      *
     c                   eval      wtfkda = 0
     c                   eval      wtffda = 0
      *
     c                   if        lofkda <> *loval
     c     *dmy          move      lofkda        wtfkda
     c                   endif
      *
     c                   if        loffda <> *loval
     c     *dmy          move      loffda        wtffda
     c                   endif
      *
      *  Legger over opplysninger i utfeltene
      *
     c                   eval      wtdate = 0
     c                   eval      wtbunt = 0
     c                   eval      wofkda = 0
      *
     c                   if        lodate <> *loval
     c     *ymd          move      lodate        wtdate
     c                   endif
      *
     c                   if        lofkda <> *loval
     c     *ymd          move      lofkda        wofkda
5.69 c                   move      wofkda        wtbunt
     c                   endif
      *
     c     *hms          move      lotime        wttime
      *
      *  Sjekker om dette er en negativ ordre
      *
     c                   if        vaokre = '-'
     c                   eval      wtstat = 'K'
     c                   endif
      *
     c                   goto      slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av BESTILLING-LINJE-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag02         tag
      *
      *  Hent opplysninger fra BESTILLING-LINJE-REGISTER
      *
     c                   eval      lodtl1_numm   = lksonr
     c                   eval      lodtl1_suff   = lkssuf
     c                   eval      lodtl1_line   = lkslin
     c     lodtl1_key    chain     lodtl1r                            90
      *
     c                   eval      wtbili = ldline
      *
      *  Henter opplysninger fra LINJE-TYPE-REGISTER
      *
     c                   eval      vltyl1_ltyp = ldltyp
     c     vltyl1_key    chain     vltyl1r                            90
      *
      ****************************************************************
      *  NB!  Utgangspunktet er at alle beløp i ordreregisteret er   *
      *       lagret med positive fortegn.  Derfor blir disse snudd  *
      *       her i henhold til koder på ordretype og linjetype. Det *
      *       viser seg imidlertid at negative varelinjer på en ordre*
      *       ligger med positivt antall, men negative beløp på      *
      *       sum salg og sum kost.  For ikke å skape problemer      *
      *       for resten av systemet, blir disse snudd her med det   *
      *       samme de hentes inn, for så å følge samme prinsipper   *
      *       videre i programmet.                                   *
      *                                                              *
     c                   if        valkre = '-'
     c                   eval      ldsumi = ldsumi * -1
     c                   eval      ldsumk = ldsumk * -1
     c                   endif
      ****************************************************************
      *
      *  Hopper over økonomi/statistikk, dersom tekstlinje
      *
     c     valktx        cabeq     1             tag025
      *
      *  Skal denne linjetypen oppdatere Økonomi og/eller statistikk
      *
     c                   if        valoko = 0
     c                   if        valsta = 0
     c                   goto      tag025
     c                   endif
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av Oppdatering av økonomi og statistikk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Nullstiller totaler for utskrift
      *
     c                   eval      wlbeln = 0
     c                   eval      wlbelo = 0
     c                   eval      wlbelb = 0
     c                   eval      wlbelw = 0
     c                   eval      wlrkr1 = 0
     c                   eval      wlrkr2 = 0
     c                   eval      wlrkro = 0
     c                   eval      wlkost = 0
      *
      *  Hent opplysninger fra VARE-REGISTER
      *
     c                   if        ldlvre = 0
7.11 c                   clear                   vvarl1r
     c                   eval      vvarl1_vare = ldvare
     c     vvarl1_key    chain     vvarl1r                            90
     c                   if        *in90 = *on
     c                   exsr      sbvare
     c                   endif
     c                   else
7.11 c                   clear                   jvarl3r
7.11 c                   eval      jvarl3_nobb = ldnobb
7.11 c     jvarl3_key    chain     jvarl3r
7.11 c                   if        not %found
7.11 c                   eval      jvmodn = 0
7.11 c                   endif
     c                   exsr      sbvare
     c                   eval      vvogrp = ldogrp
     c                   eval      vvhgrp = ldhgrp
     c                   eval      vvugrp = ldugrp
     c                   eval      vvnobb = ldnobb
     c                   eval      vvvare = ldvare
     c                   eval      vvlvar = ldlvar
     c                   eval      vvenhs = ldenh1
     c                   endif
      * henter info om logistikk-vare
6.38 c                   call      'VL710R'
6.38 c                   parm                    w_firm
6.38 c                   parm                    ldvare
6.38 c                   parm                    ldlage
6.38 c                   parm                    w_lv_vtyp
6.38 c                   parm                    w_utda
6.38 c                   parm                    w_lv_ldor
6.38 c                   parm                    b_inlr
6.38 c                   parm                    w_lv_nobb
6.38 c                   parm                    w_lv_modn
6.38 c                   parm                    w_lv_lldo
6.38 c                   parm                    w_lv_lvar

      *
     c                   eval      w_lety = 0
6.22 c                   eval      w_kamp = lokamp
      *
     c                   call      'VP750R'
     c                   parm                    w_firm
     c                   parm                    ldvare
     c                   parm                    w_prgr
     c                   parm                    w_lety
     c                   parm                    lofkda
     c                   parm                    w_enhe
     c                   parm                    w_kopr
     c                   parm                    w_inpr
6.22 c                   parm                    w_kamp
      *
      *  Hent opplysninger fra UNDERGRUPPE REGISTER
      *
     c                   eval      vugrl1_uogr = vvogrp
     c                   eval      vugrl1_uhgr = vvhgrp
     c                   eval      vugrl1_uugr = vvugrp
     c     vugrl1_key    chain     vugrl1                             90
      *
      *  Finner den kontoen som skal benyttes
      *
     c                   if        ldlvre = 1
     c                   eval      wpogrp = ldogrp
     c                   eval      wphgrp = ldhgrp
     c                   eval      wpugrp = ldugrp
     c                   eval      wpvare = ldvare
     c                   else
     c                   eval      wpogrp = vvogrp
     c                   eval      wphgrp = vvhgrp
     c                   eval      wpugrp = vvugrp
     c                   eval      wpvare = vvvare
     c                   endif
     c                   exsr      hntkon
      *
      *  Beregne beløp og oppdatere
      *  Økonomi og statistikk
      *
     c                   exsr      xbereg
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Oppdaterer INNGÅENDE-FAKTURA-LINJE-REGISTER med nye linjer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag025        tag
      *
     c                   eval      sidtlu_ktxt = 3
     c                   eval      sidtlu_line = ldline
     c     sidtlu_key    chain     sidtlur                            90
      *
     c                   exsr      sbline
      *
     c                   eval      slotyp = lootyp
     c                   eval      slltyp = ldltyp
     c                   eval      slvare = ldvare
     c                   eval      slenh1 = ldenh1
     c                   eval      sllage = ldlage
     c                   eval      sltek1 = ldtek1
     c                   eval      sltek2 = ldtek2
     c                   eval      slkmva = vvkmva
6.32 c                   eval      slomva = ldomva
6.32 c                   eval      slmpro = w_mvap
6.37 c                   eval      sleann = ldeann
      *
     c                   eval      sllvre = ldlvre
      *
     c                   if        ldlvre = 1
     c                   eval      slnobb = ldnobb
     c                   eval      slogrp = ldogrp
     c                   eval      slhgrp = ldhgrp
     c                   eval      slugrp = ldugrp
     c                   else
8.12 c*                   if        w_lv_nobb <> 0
8.12 c*                   eval      slnobb = w_lv_nobb
8.12 c*                   else
     c                   eval      slnobb = ldnobb
8.12 c*                   endif
     c                   eval      slogrp = vvogrp
     c                   eval      slhgrp = vvhgrp
     c                   eval      slugrp = vvugrp
     c                   endif
      *
     c                   eval      slanta = ldanta
6.21 c**                 eval      slipny = ldipny
6.21 c                   eval      slipny = ldipny * w_pmku
     c                   eval      slkpny = ldkpny
     c                   eval      slrab1 = ldrab1
     c                   eval      slrab2 = ldrab2
      *
6.21 c**                 eval      slkjop = ldsumi
6.21 c                   eval      slkjop = ldsumi * w_pmku
     c                   eval      slkost = ldsumk
      *
6.21 c**                 eval      slrkr1 = wlrkr1
6.21 c                   eval      slrkr1 = wlrkr1 * w_pmku
6.21 c**                 eval      slrkr2 = wlrkr2
6.21 c                   eval      slrkr2 = wlrkr2 * w_pmku
6.21 c**                 eval      slrkro = wlrkro
6.21 c                   eval      slrkro = wlrkro * w_pmku
      *
     c                   eval      slornr = ldornu
     c                   eval      slorsu = ldorsu
     c                   eval      slorli = ldorli
      *
      *  Gå forbi dersom tekstlinje
      *
     c     valktx        cabeq     1             xtag23
      *
      *  Legge ut prosjektnummer på varelinjenivå
      *
6.20 c                   eval      slproj = loproj
7.12 c                   eval      slupro = loarbo
     c                   eval      slakti = loakti
6.20 c**                 if        ldproj <> 0
6.20 c                   if        ldproj <> *blank
     c                   eval      slproj = ldproj
7.12 c                   eval      slupro = loarbo
     c                   eval      slakti = ldakti
     c                   endif
      *
      *  Legge ut avd og konto på varelinjenivå
      *
6.32 c**   lomkod        cabne     0             xtag22
6.32 c     lomkod        cabeq     1             xtag22
6.35 c     lomkod        cabeq     2             xtag22
6.32 c**   vvkmva        cabne     0             xtag22
6.32 c     vvkmva        cabeq     1             xtag22
6.32 c     w_mvap        cabeq     0             xtag22
4.03 c                   eval      slavde = d_kav4
4.03 c                   eval      slkont = d_kko4
4.03 c                   eval      slspes = d_ksp4
     c                   goto      xtag23
      *
     c     xtag22        tag
4.03 c                   eval      slavde = d_kav4
4.03 c                   eval      slkont = d_kko4
4.03 c                   eval      slspes = d_ksp4
     c     xtag23        tag
      *
     c                   if        *in90 = *off
6.10 c                   time                    sledat
6.10 c                   time                    sletim
6.10 c                   eval      sleusr = l_user
     c                   update    sidtlur
     c                   else
     c                   eval      slfirm = w_firm
     c                   eval      slaarr = sidtlu_aarr
     c                   eval      slbinr = sidtlu_binr
     c                   eval      slnumm = sidtlu_numm
     c                   eval      slsuff = sidtlu_suff
     c                   eval      slktxt = sidtlu_ktxt
     c                   eval      slline = sidtlu_line
6.10 c                   time                    slodat
6.10 c                   time                    slotim
6.10 c                   eval      slousr = l_user
6.10 c                   time                    sledat
6.10 c                   time                    sletim
6.10 c                   eval      sleusr = l_user
     c                   write     sidtlur
     c                   endif
      *
     c                   goto      slutt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Behandling av BESTILLING-TEKST-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag03         tag
      *
      *  Hent opplysninger fra BESTILLING-TEKST-REGISTER
      *
     c                   eval      lotxl1_numm = lksonr
     c                   eval      lotxl1_suff = lkssuf
     c                   eval      lotxl1_line = lkslin
     c     lotxl1_key    chain     lotxl1r                            90
      *
      *  Beregner linjekode  0-4999 = 1 (Foran) , 5000-5999 = 5 (Etter)
      *
     c                   eval      sidtlu_ktxt = 1
     c                   if        lkslin >= 5000
     c                   eval      sidtlu_ktxt = 5
     c                   endif
      *
      *  Oppdaterer INNGÅENDE-FAKTURA-LINJE-REGISTER med nye linjer
      *
     c                   eval      sidtlu_line = lkslin
     c     sidtlu_key    chain     sidtlur                            90
      *
     c                   exsr      sbline
      *
     c                   eval      d_frix = lttext
     c                   eval      sltek1 = d_fri1
     c                   eval      sltek2 = d_fri2
     c                   movel     d_fri3        sltek3
      *
     c                   if        *in90 = *off
6.10 c                   time                    sledat
6.10 c                   time                    sletim
6.10 c                   eval      sleusr = l_user
     c                   update    sidtlur
     c                   else
     c                   eval      slfirm = w_firm
     c                   eval      slaarr = sidtlu_aarr
     c                   eval      slbinr = sidtlu_binr
     c                   eval      slnumm = sidtlu_numm
     c                   eval      slsuff = sidtlu_suff
     c                   eval      slktxt = sidtlu_ktxt
     c                   eval      slline = sidtlu_line
6.10 c                   time                    slodat
6.10 c                   time                    slotim
6.10 c                   eval      slousr = l_user
6.10 c                   time                    sledat
6.10 c                   time                    sletim
6.10 c                   eval      sleusr = l_user
     c                   write     sidtlur
     c                   endif
      *
     c                   goto      slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     slutt         tag
      *
     cl2                 exsr      l2ut
     cl6                 exsr      l6ut
7.02 clr                 exsr      logg_bilag
7.00 clr                 exsr      logg_hode
     clr                 exsr      lrut
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  L6IN      Behandling av brudd på L6 inn  (Ny faktura)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     l6inn         begsr
      *
      *  Nullstiller hjelpefelter
      *
     c                   eval      wtfkda = 0
     c                   eval      wtffda = 0
     c                   eval      wofkda = 0
     c                   eval      wtdate = 0
     c                   eval      wttime = 0
     c                   eval      wtbunt = 0
      *
     c                   eval      w6hsum = 0
     c                   eval      w6kjop = 0
     c                   eval      w6kjof = 0
     c                   eval      w6rk1p = 0
     c                   eval      w6rk1f = 0
     c                   eval      w6rk2p = 0
     c                   eval      w6rk2f = 0
     c                   eval      w6rkop = 0
     c                   eval      w6rkof = 0
6.32 c                   eval      w6mbel = 0
      *
     c                   eval      wtkode = 0
      *
      *
     c                   eval      wtstat = 'D'
6.21 c                   eval      w_valk = *blank
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  L2IN      Behandling av brudd på L2 inn  (Ny ordre)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     l2inn         begsr
      *
      *  Legger inn ordrenummer og suffix i nøkklene
      *
     c                   eval      sihelu_numm = lksonr
     c                   eval      sidtlu_numm = lksonr
     c                   eval      sihelu_suff = lkssuf
     c                   eval      sidtlu_suff = lkssuf
      *
      *  Nullstilling
      *
     c                   eval      w2kjop = 0
     c                   eval      w2kjof = 0
     c                   eval      w2kstp = 0
     c                   eval      w2kstf = 0
     c                   eval      w2rk1p = 0
     c                   eval      w2rk1f = 0
     c                   eval      w2rk2p = 0
     c                   eval      w2rk2f = 0
     c                   eval      w2rbgp = 0
     c                   eval      w2rbgf = 0
     c                   eval      w2rkop = 0
     c                   eval      w2rkof = 0
6.32 c                   eval      w2mvgp = 0
6.32 c                   eval      w2mbel = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  L2UT      Behandling av brudd på L2 ut   (Ordre slutt)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     l2ut          begsr
      *
     c     sihelu_key    chain     sihelur                            90
      *
     c                   eval      shbatc = wsbatc
     c                   eval      shotyp = lootyp
     c                   eval      shlage = lolage
     c                   eval      shkref = lokref
     c                   eval      shbdat = lobdat
     c                   eval      shldat = loldat
     c                   eval      shbetb = lobetb
     c                   eval      shinnk = loinnk
     c                   eval      shdist = lodist
     c                   eval      shlmat = lolmat
     c                   eval      shlbet = lolbet
6.21 c**                 eval      shvalk = lovalk
6.21 c                   eval      shvalk = *blank
     c                   eval      shrkat = lorkat
     c                   eval      shsped = losped
     c                   eval      shkjor = lokjor
     c                   eval      shmkod = lomkod
     c                   eval      shlele = lolele
      *
     c                   eval      shldor = loldor
     c                   eval      shlena = lolena
     c                   eval      shnavn = lonavn
     c                   eval      shadr1 = loadr1
     c                   eval      shadr2 = loadr2
     c                   eval      shsted = losted
     c                   eval      shavde = loavde
     c                   eval      shkont = lokont
     c                   eval      shspes = lospes
     c                   eval      shproj = loproj
7.12 c                   eval      shupro = loarbo
     c                   eval      shakti = loakti
     c                   eval      shvref = lovref
     c                   eval      shdref = lodref
     c                   movel     lorekv        shrekv
     c                   eval      shlmtx = lolmtx
     c                   eval      shlbtx = lolbtx
     c                   eval      shrabp = lorabp
      *
     c                   eval      shnett = lonett
     c                   eval      shbrut = lobrut
     c                   eval      shkoli = lokoli
     c                   eval      shwsid = lowsid
     c                   eval      shuser = louser
     c                   eval      shdate = lodate
     c                   eval      shtime = lotime
      *
     c                   eval      shfkda = lofkda
     c                   eval      shffda = loffda
     c                   eval      shmoda = lomoda
6.30 c                   eval      shvida = lovida
6.21 c**                 eval      shtotf = lototf
6.21 c                   eval      shtotf = lototf * w_pmku
      *
     c                   eval      shornr = loornr
     c                   eval      shorsu = loorsu
     c                   eval      shflev = loflev
     c                   eval      shlonr = losorn
     c                   eval      shlfnr = losfak
6.23 c                   eval      shmnum = lomnum
      *
      *  NB !  Her er det viktig å være klar over følgende :
      *        Feltene for salg / rabatt / og kost blir ikke
      *        hentet fra ordrehode som tidligere, da det er
      *        behov for å splitte opp på avg fritt/pliktig
      *        både på salg, alle rabatter og på kost. Dette
      *        var ikke tilgjengelig fra ordrehode.  Det er
      *        mulig at all denne beregning burde ligge i
      *        ordre-registreringsprogrammet, men foreløpig
      *        er det lagt inn her.
      *
6.21 c**                 eval      shkjop = w2kjop
6.21 c                   eval      shkjop = w2kjop * w_pmku
6.21 c**                 eval      shkjof = w2kjof
6.21 c                   eval      shkjof = w2kjof * w_pmku
6.21 c**                 eval      shrk1p = w2rk1p
6.21 c                   eval      shrk1p = w2rk1p * w_pmku
6.21 c**                 eval      shrk1f = w2rk1f
6.21 c                   eval      shrk1f = w2rk1f * w_pmku
6.21 c**                 eval      shrk2p = w2rk2p
6.21 c                   eval      shrk2p = w2rk2p * w_pmku
6.21 c**                 eval      shrk2f = w2rk2f
6.21 c                   eval      shrk2f = w2rk2f * w_pmku
6.21 c**                 eval      shrkop = w2rkop
6.21 c                   eval      shrkop = w2rkop * w_pmku
6.21 c**                 eval      shrkof = w2rkof
6.21 c                   eval      shrkof = w2rkof * w_pmku
     c                   eval      shkstp = w2kstp
     c                   eval      shkstf = w2kstf
6.32 c                   eval      shmvgp = w2mvgp
      *
      *  NB !  Ordrerabatten er også summert opp pr varelinje, men
      *        den blir beregnet på nytt for å unngå øredifferanser
      *        da det på linjenivå foretas avrundinger.
      *
     c                   eval(h)   shrkop = w2rbgp * lorabp
     c                   eval      shrkop = shrkop / 100
6.21 c                   eval      shrkop = shrkop * w_pmku
      *
     c                   eval(h)   shrkof = w2rbgf * lorabp
     c                   eval      shrkof = shrkof / 100
6.21 c                   eval      shrkof = shrkof * w_pmku
      *
      * Oppdater
      *
     c                   if        *in90 = *off
6.10 c                   time                    shedat
6.10 c                   time                    shetim
6.10 c                   eval      sheusr = l_user
     c                   update    sihelur
     c                   else
     c                   eval      shfirm = w_firm
     c                   eval      shaarr = sihelu_aarr
     c                   eval      shbinr = sihelu_binr
     c                   eval      shnumm = sihelu_numm
     c                   eval      shsuff = sihelu_suff
6.10 c                   time                    shdate
6.10 c                   time                    shtime
6.10 c                   eval      shuser = l_user
6.10 c                   time                    shedat
6.10 c                   time                    shetim
6.10 c                   eval      sheusr = l_user
     c                   write     sihelur
     c                   endif
      *
      * Sum Faktura (L6)
      *
     c                   eval      w6kjop = w6kjop + w2kjop
     c                   eval      w6kjof = w6kjof + w2kjof
     c                   eval      w6rk1p = w6rk1p + w2rk1p
     c                   eval      w6rk1f = w6rk1f + w2rk1f
     c                   eval      w6rk2p = w6rk2p + w2rk2p
     c                   eval      w6rk2f = w6rk2f + w2rk2f
     c                   eval      w6rkop = w6rkop + w2rkop
     c                   eval      w6rkof = w6rkof + w2rkof
6.32 c                   eval      w6mbel = w6mbel + w2mbel
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  L6UT      Behandling av brudd på L6 ut   (Faktura slutt)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     l6ut          begsr
      *
      *  Legger til mva på totalen
      *
     c                   eval      w6fsum = w6kjop + w6kjof
     c                   eval      w6fsum = w6fsum - w6rk1p
     c                   eval      w6fsum = w6fsum - w6rk1f
     c                   eval      w6fsum = w6fsum - w6rk2p
     c                   eval      w6fsum = w6fsum - w6rk2f
     c                   eval      w6fsum = w6fsum - w6rkop
     c                   eval      w6fsum = w6fsum - w6rkof
      *
     c                   eval      w6hlp1 = w6kjop - w6rk1p
     c                   eval      w6hlp1 = w6hlp1 - w6rk2p
     c                   eval      w6hlp1 = w6hlp1 - w6rkop
6.32 c**                 eval(h)   w6hlp2 = w6hlp1 * mvatil
6.32 c                   eval(h)   w6hlp2 = w6hlp1 + w6mbel
     c                   eval      w6hlp3 = w6hlp2 - w6hlp1
     c                   eval      w6fsum = w6fsum + w6hlp3
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Legger ut transaksjon  (Leverandørreskontro)  (KJØP)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Oppdater siste ordrehode
      * med eksakt fakturasum
      *
     c     sihelu_key    chain     sihelur                            90
6.21 c**                 eval      shfsum = w6fsum
6.21 c                   eval      shfsum = w6fsum * w_pmku
     c                   if        *in90 = *off
6.10 c                   time                    shedat
6.10 c                   time                    shetim
6.10 c                   eval      sheusr = l_user
     c                   update    sihelur
     c                   eval      shfsum = 0
     c                   endif
      *
      * Legger inn inntastet beløp, dersom utfylt
      *
     c                   if        shtotf <> 0
     c                   if        vaokre = '-'
     c                   eval      w6fsum = 0 - shtotf
     c                   else
     c                   eval      w6fsum = shtotf
     c                   endif
     c                   endif
      *
      * Redigerer bilagstekst for fakturaleverandør
      *
     c                   if        loflev <> 0 and
     c                             lobitx = *blank
     c                   eval      lobitx = %subst(rlnavn:1:11) + '  ' +
     c                                      losfak
     c                   endif
6.24  *
6.24  * Legger inn leverandørens faktura referanse på reskontropost
6.24  *
6.24 c                   eval      lgsfak = losfak
      *
      * Klargjør for oppdatering
      * av leverandørtransaksjon
      *
     c                   eval      wtbelh = w6fsum * -1
     c                   eval      wtvalg = 0
      *
     c                   if        loflev <> 0
     c                   eval      wtkode = laabif
     c                   else
     c                   eval      wtkode = vaobil
     c                   endif
      *
4.01 c                   eval      wtmkod = ' '
     c                   eval      wtkont = w_ldor
     c                   eval      wtavde = 0
     c                   eval      wtspes = 0
     c                   eval      wtbili = 0
      *
     c                   if        vaooko = 1
     c                   exsr      exokon
     c                   endif
      *
      * Danne reskontroposteringer på opprinnelig fakturautsteder?
      *
8.02 c                   if        u_dobbel_resk = *on
     c                   if        loflev <> 0
     c                   eval      wtbelh = w6fsum * -1
     c                   eval      wtvalg = 0
     c                   eval      wtkode = vaobil
     c                   eval      wtkont = loldor
     c                   eval      wtavde = 0
     c                   eval      wtspes = 0
     c                   eval      wtkkod = 'K'
     c                   if        vaooko = 1
     c                   exsr      exokon
     c                   endif
      *
     c                   eval      wtbelh = w6fsum
     c                   eval      wtvalg = 0
     c                   eval      wtkode = laabif
     c                   eval      wtkont = loldor
     c                   eval      wtavde = 0
     c                   eval      wtspes = 0
     c                   eval      wtkkod = 'K'
     c                   if        vaooko = 1
     c                   exsr      exokon
     c                   endif
     c                   endif
8.02 c                   endif
8.02  *
6.24  *
6.24  * Nuller ut leverandørens faktura referanse etter reskontropost
6.24  *
6.24 c                   eval      lgsfak = *blank
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Ø R E A V R U N D I N G
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   eval      wtbelh = w6fsum - w6hsum
      *
     c                   if        w6hsum <> 0
     c                   if        wtbelh <> 0
     c                   eval      wtvalg = 2
     c                   eval      wtkode = laabil
      *
      *  Hent opplysninger fra VARE-REGISTER
      *
     c                   eval      vvarl1_vare = laavnr
     c     vvarl1_key    chain     vvarl1r                            90
     c                   if        *in90 = *on
     c                   exsr      sbvare
     c                   endif
      *
      *  Finner den kontoen som skal benyttes
      *
     c                   eval      wpogrp = vvogrp
     c                   eval      wphgrp = vvhgrp
     c                   eval      wpugrp = vvugrp
     c                   eval      wpvare = vvvare
     c                   exsr      hntkon
      *
4.01 c                   eval      wtmkod = '1'
     c                   eval      wtavde = d_kav4
     c                   eval      wtkont = d_kko4
     c                   eval      wtspes = d_ksp4
      *
     c                   if        vaooko = 1
     c                   exsr      exokon
     c                   endif
     c                   endif
     c                   endif
      *
     c                   eval      w6hsum = 0
6.37 c                   eval      teller = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  LRUT      Behandling av brudd på LR ut
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     lrut          begsr
      *
     c                   eval      d_aarr = sihelu_aarr
     c                   eval      d_otyp = shotyp
      *
     c                   eval      p_parm = d_parm
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Beregning av beløp + oppdatering av økonomi / statistikk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xbereg        begsr
      *
      *  Opprinnelig beløp fra vareregister
      *
     c                   eval      wlbelo = w_inpr * ldanta
      *
      *  Bruttobeløp og kostpris
      *
     c                   eval      wlbelb = ldipny * ldanta
     c                   eval      wlkost = ldkpny * ldanta
      *
      *  Linjerabatter
      *
     c                   eval      wlbelw = wlbelb
     c                   eval(h)   wlrkr1 = ldrab1 * wlbelb
     c                   eval      wlrkr1 = wlrkr1 / 100
      *
     c                   eval      wlbelw = wlbelb
     c                   eval      wlbelw = wlbelw - wlrkr1
      *
     c                   eval(h)   wlrkr2 = ldrab2 * wlbelw
     c                   eval      wlrkr2 = wlrkr2 / 100
      *
      *  Trekker ut rabatter
      *
     c                   eval      wlbeln = ldsumi
     c                   eval      wlbeln = wlbeln - wlrkr1
     c                   eval      wlbeln = wlbeln - wlrkr2
      *
      *  Varelinjens andel av ordrerabatt
      *
     c                   eval(h)   wlrkro = wlbeln * lorabp
     c                   eval      wlrkro = wlrkro / 100
6.32  *
6.32  *  Netto netto
6.32  *
6.32 c                   eval(h)   wlbelx = wlbeln - wlrkro
6.32  *
6.32  * Bergener riktig MVA-grunnlag
6.32  *
6.32 c**                 eval      t_belp = 0
6.32 c                   eval      t_mvag = 0
6.32 c                   eval      w_mvag = 0
6.32  *
6.32 c                   if        laasa1 = 0 and
6.32 c                             laasao = 0
6.32 c                   eval      t_mvag = wlbelx
6.32 c                   endif
6.32  *
6.32 c                   if        laasa1 = 1 and
6.32 c                             laasao = 0
6.32 c                   eval      t_mvag = wlbelb - wlrkro
6.32 c                   endif
6.32  *
6.32 c                   if        laasa1 = 0 and
6.32 c                             laasao = 1
6.32 c                   eval      t_mvag = wlbeln
6.32 c                   endif
6.32  *
6.32 c                   if        laasa1 = 1 and
6.32 c                             laasao = 1
6.32 c                   eval      t_mvag = wlbelb
6.32 c                   endif
6.32  *
6.32 c                   eval      w_mvag = wlbelx
6.32  *
6.32  * Henter inn prosentsats på mva kode
6.32  *
6.32 c                   eval      w_mvap = 0
6.32 c                   eval      w_mvat = 0
6.32 c                   eval      w_mvaf = 0
6.32  *
6.32 c                   if        ldomva <> *blank
6.32 c                   eval      w_stat = *blank
6.32 c                   eval      w_mvak = ldomva
6.32 c                   eval      w_mdat = l_fkda
6.32  *
6.32 c                   call      'RS205R'
6.32 c                   parm                    w_stat
6.32 c                   parm                    w_mvak
6.32 c                   parm                    w_mvtx
6.32 c                   parm                    w_mdat
6.32 c                   parm                    w_mvap
6.32 c                   parm                    w_mvat
6.32 c                   parm                    w_mvaf
6.32 c                   parm                    w_bpro
6.32 c                   endif
      *
      *  Sjekker om dette er en negativ ordre
      *
     c                   if        wtstat = 'K'
     c                   eval      ldanta = ldanta * -1
     c                   eval      ldsumi = ldsumi * -1
     c                   eval      ldsumk = ldsumk * -1
     c                   eval      wlbeln = wlbeln * -1
     c                   eval      wlbelb = wlbelb * -1
     c                   eval      wlbelo = wlbelo * -1
     c                   eval      wlkost = wlkost * -1
     c                   eval      wlrkro = wlrkro * -1
     c                   eval      wlrkr1 = wlrkr1 * -1
     c                   eval      wlrkr2 = wlrkr2 * -1
6.32 c                   eval      w_mvag = w_mvag * -1
6.32 c                   eval      t_mvag = t_mvag * -1
     c                   endif
      *
      *  Sjekker om dette er en negativ linje
      *
     c                   if        valkre = '-'
     c                   eval      ldanta = ldanta * -1
     c                   eval      ldsumi = ldsumi * -1
     c                   eval      ldsumk = ldsumk * -1
     c                   eval      wlbeln = wlbeln * -1
     c                   eval      wlbelb = wlbelb * -1
     c                   eval      wlbelo = wlbelo * -1
     c                   eval      wlkost = wlkost * -1
     c                   eval      wlrkro = wlrkro * -1
     c                   eval      wlrkr1 = wlrkr1 * -1
     c                   eval      wlrkr2 = wlrkr2 * -1
6.32 c                   eval      w_mvag = w_mvag * -1
6.32 c                   eval      t_mvag = t_mvag * -1
     c                   endif
      *
6.32 c                   eval      w2mvgp = w2mvgp + w_mvag
      *
      *  Sjekke om fritt / pliktig
      *
6.32 c**   lomkod        cabne     0             xtag10
6.32 c     lomkod        cabeq     1             xtag10
6.35 c     lomkod        cabeq     2             xtag10
6.32 c**   vvkmva        cabne     0             xtag10
6.32 c     vvkmva        cabeq     1             xtag10
6.32 c     w_mvap        cabeq     0             xtag10
      *
      *  Summer opp til brudd ordre (Pliktig)
      *
     c                   eval      w2kjop = w2kjop + ldsumi
     c                   eval      w2kstp = w2kstp + ldsumk
     c                   eval      w2rk1p = w2rk1p + wlrkr1
     c                   eval      w2rk2p = w2rk2p + wlrkr2
     c                   eval      w2rkop = w2rkop + wlrkro
6.32 c                   eval      w2mbel = w2mbel +
6.32 c                                      ((w_mvag * w_mvap)/100)
      *
     c                   if        lorabp <> 0
      *
     c                   eval      w2rbgp = w2rbgp + wlbeln
      *
     c                   endif
      *
     c                   goto      xtag12
      *
      *  Summer opp til brudd ordre (Avg fritt)
      *
     c     xtag10        tag
     c                   eval      w2kjof = w2kjof + ldsumi
     c                   eval      w2kstf = w2kstf + ldsumk
     c                   eval      w2rk1f = w2rk1f + wlrkr1
     c                   eval      w2rk2f = w2rk2f + wlrkr2
     c                   eval      w2rkof = w2rkof + wlrkro
6.32 c                   eval      t_mkod = ldomva
6.32 c                   eval      w2mbel = w2mbel + 0
      *
     c                   if        lorabp <> 0
      *
     c                   eval      w2rbgf = w2rbgf + wlbeln
      *
     c                   endif
      *
     c     xtag12        tag
      *
      *  Legge ut prosjektnummer på varelinjenivå
      *
     c                   eval      wtproj = loproj
     c                   eval      wtakti = loakti
7.12 c                   eval      wtupro = loarbo
6.20 c**                 if        ldproj <> 0
6.20 c                   if        ldproj <> *blank
     c                   eval      wtproj = ldproj
7.12 c                   endif
7.12 c                   if        loarbo <> *blank
7.12 c                   eval      wtupro = loarbo
7.12 c                   endif
7.12 c                   if        ldakti <> *blank
     c                   eval      wtakti = ldakti
     c                   endif
      *
      *  Dersom vareadresseleverandør finnes skal den benyttes
      *
     c                   eval      wtllev = loldor
     c                   if        lolele <> 0
     c                   eval      wtllev = lolele
     c                   endif
      *
      *  Oppdatering av kjøp
      *
     c                   eval      wtbelh = wlbeln
      *
6.32 c*    lomkod        cabne     0             xtag20
6.32 c     lomkod        cabeq     1             xtag20
6.35 c     lomkod        cabeq     2             xtag20
6.32 c*    vvkmva        cabne     0             xtag20
6.32 c     vvkmva        cabeq     1             xtag20
6.32 c     w_mvap        cabeq     0             xtag20
6.32 c**                 eval(h)   wtbelh = wtbelh * mvatil
6.32 c                   eval(h)   wtbelh = wtbelh * w_mvat
     c                   eval      wtvalg = 3
6.32 c**                 eval      wtmkod = '1'
6.32 c                   eval      t_mkod = ldomva
     c                   eval      wtavde = d_kav4
     c                   eval      wtkont = d_kko4
     c                   eval      wtspes = d_ksp4
     c                   goto      xtag21
      *
     c     xtag20        tag
     c                   eval      wtvalg = 4
6.32 c**                 eval      wtmkod = '0'
6.32 c                   eval      t_mkod = ldomva
     c                   eval      wtavde = d_kav4
     c                   eval      wtkont = d_kko4
     c                   eval      wtspes = d_ksp4
     c     xtag21        tag
     c                   eval      w6hsum = w6hsum + wtbelh
6.32 c                   eval      wtmkod = t_mkod
      *
      *  Kaller opp kostprisendring/gjennomsnittsberegning
      *
     c                   if        laalik <> 0
     c                   if        ldipny <> 0
     c                   if        wtstat <> 'K'
      *
     c                   eval      p_firm = ldfirm
     c                   eval      p_vare = ldvare
     c                   eval      p_anta = ldanta
     c                   eval      p_kplj = ldkplj
     c                   eval      wlipny = ldipny
     c                   if        ldrab1 <> 0
     c                   eval(h)   wlipny=wlipny-((wlipny*ldrab1)/100)
     c                   endif
     c                   if        ldrab2 <> 0
     c                   eval(h)   wlipny=wlipny-((wlipny*ldrab2)/100)
     c                   endif
     c                   eval      p_ipny = wlipny
      *
     c                   call      'VL002R'
     c                   parm                    p_firm
     c                   parm                    p_vare
     c                   parm                    p_anta
     c                   parm                    p_ipny
     c                   parm                    p_kplj
      *
     c                   endif
     c                   endif
     c                   endif
      *
      *  Oppdatering av statistikk
      *
     c                   if        vaosta = 1
     c                   if        valsta = 1
     c                   eval      teller = teller + 1
     c                   exsr      instat
     c                   endif
     c                   endif
      *
      *  Oppdatering av økonomi
      *
     c                   if        vaooko = 1
     c                   if        valoko = 1
     c                   if        wtbelh <> 0
     c                   exsr      exokon
     c                   endif
     c                   endif
     c                   endif
      *
6.32 c                   eval      t_mvag = 0
6.32 c                   eval      t_mkod = *blank
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for blanking av alle felter til linjer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sbline        begsr
      *
     c                   eval      slextr = 0
     c                   eval      slkvis = 0
     c                   eval      slavde = 0
     c                   eval      slkont = 0
     c                   eval      slspes = 0
6.20 c**                 eval      slproj = 0
6.20 c                   eval      slproj = *blank
7.12 c                   eval      slupro = *blank
     c                   eval      slakti = *blank
      *
     c                   eval      slotyp = *blank
     c                   eval      slltyp = *blank
     c                   eval      slvare = *blank
     c                   eval      slenh1 = *blank
     c                   eval      sllage = 0
     c                   eval      sltek1 = *blank
     c                   eval      sltek2 = *blank
     c                   eval      sltek3 = *blank
     c                   eval      slanta = 0
     c                   eval      slipny = 0
     c                   eval      slkpny = 0
     c                   eval      slrab1 = 0
     c                   eval      slrab2 = 0
      *
     c                   eval      slkjop = 0
     c                   eval      slrkr1 = 0
     c                   eval      slrkr2 = 0
     c                   eval      slrkro = 0
     c                   eval      slkost = 0
      *
     c                   eval      slkmva = 0
      *
     c                   eval      slornr = 0
     c                   eval      slorsu = 0
     c                   eval      slorli = 0
      *
     c                   eval      sllvre = 0
     c                   eval      slogrp = 0
     c                   eval      slhgrp = 0
     c                   eval      slugrp = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for blanking felter i vareregister
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sbvare        begsr
      *
     c                   eval      vvvare = *blank
     c                   eval      vvtek1 = *blank
     c                   eval      vvlvar = *blank
     c                   eval      vvenhs = *blank
6.34 c                   eval      vvogrp = 0
     c                   eval      vvhgrp = 0
     c                   eval      vvugrp = 0
     c                   eval      vvkmva = 0
     c                   eval      vvldor = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Utlegging av informasjon til konto
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     exokon        begsr
      *
      *  Hent bilagstekst
      *
     c                   call      'RS701R'
     c                   parm                    w_stat
     c                   parm                    wtkode
     c                   parm                    wktext
      *
      *  Legger inn ekstra-bilags-tekst på slutten av bilagstekstfeltet
      *
     c                   if        wtvalg = 2
     c                   eval      wktext = etx(02)
     c                   endif
      *
     c                   if        wtvalg = 3
     c                   eval      wktext = etx(03)
     c                   endif
      *
     c                   if        wtvalg = 4
     c                   eval      wktext = etx(04)
     c                   endif
      *
      *  Bruk bilagstekst fra ordrehode hvis utfylt
      *
     c                   if        wtkode <> laabil
     c                   if        lobitx <> *blank
     c                   movel     lobitx        wktext
     c                   endif
     c                   endif
      *
4.01 c                   eval(h)   wtanta = ldanta
      *
      *  Legger ut transaksjon til ØKONOMI-SYSTEMET
      *
4.01 c                   eval      lgfirm = lksfir
4.01 c                   eval      lgperi = wtperi
4.01 c                   eval      lgbunt = wtbunt
4.01 c                   eval      lgbiln = wtbinr
4.01 c                   eval      lgbill = wtbili
4.01 c                   eval      lgbdat = *loval
4.01 c                   eval      lgfdat = *loval
4.01 c                   eval      lgbilk = wtkode
4.01 c                   eval      lgtext = wktext
4.01 c                   eval      lgdavd = 0
4.01 c                   eval      lgdkto = 0
4.01 c                   eval      lgdsps = 0
4.01 c                   eval      lgdmom = ' '
6.21 c**                 eval      lgbelp = wtbelh
6.21 c                   eval      lgbelp = wtbelh * w_pmku
4.01 c                   eval      lgcavd = 0
4.01 c                   eval      lgckto = 0
4.01 c                   eval      lgcsps = 0
4.01 c                   eval      lgcmom = ' '
6.33sc                   eval      lgproj = loproj
6.33sc                   eval      lgupro = loarbo
6.33sc                   eval      lgakti = loakti
4.01 c                   eval      lgkref = wtkref
4.01 c                   eval      lgkund = w_resk
4.01 c                   eval      lgvalk = *blank
4.01 c                   eval      lgvalb = 0
4.01 c                   eval      lgmngk = 0
4.01 c                   eval      lgmngd = wtanta
4.01 c                   eval      lgautx = wtkkod
4.01  *
4.01  * Legger inn riktig
4.01  * kontobegrep
4.01  *
4.01 c                   if        wtbelh < 0
4.01 c                   eval      lgcavd = wtavde
4.01 c                   eval      lgckto = wtkont
4.01 c                   eval      lgcsps = wtspes
4.01 c                   eval      lgcmom = wtmkod
4.01 c                   eval      wtbelh = wtbelh * -1
4.01 c                   eval      lgbelp = lgbelp * -1
4.01 c                   else
4.01 c                   eval      lgdavd = wtavde
4.01 c                   eval      lgdkto = wtkont
4.01 c                   eval      lgdsps = wtspes
4.01 c                   eval      lgdmom = wtmkod
4.01 c                   endif
4.01  *
4.01  * Legger inn referanser på reskontropostering
4.01  *
     c                   eval      lgkidi = lokidi
6.32 c                   eval      lgmvag = t_mvag
4.01  *
4.01  * Legger inn dato
4.01  * og forfallsdato
4.01  *
4.01 c                   if        wtfkda <> 0
4.01 c     *dmy          move      wtfkda        lgbdat
4.01 c                   endif
4.01  *
4.01 c                   if        wtffda <> 0
4.01 c     *dmy          move      wtffda        lgfdat
4.01 c                   endif
4.01  *
7.00  *
7.00  * Timestamp for logging
7.00  *
7.00 c                   eval      lglogg = w_logg
4.01 c                   write     lovfpfr
7.00  *
7.00  *  Skriv til loggfil
7.00  *
7.00 c                   exsr      logg_linjer
      *
      *  Nullstiller totaler etter oppdatering
      *
     c                   eval      wtvalg = 0
     c                   eval      wtavde = 0
     c                   eval      wtkont = 0
     c                   eval      wtspes = 0
     c                   eval      wtmkod = '0'
     c                   eval      wtbelh = 0
     c                   eval      wtkref = 0
6.20 c**                 eval      wtproj = 0
6.20 c                   eval      wtproj = *blank
7.12 c                   eval      wtupro = *blank
     c                   eval      wtakti = *blank
     c                   eval      wtkkod = *blank
4.01 c                   eval      wtanta = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter avdeling/konto/spesifikasjon
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hntkon        begsr
      *
      *  Legger ut parametere for konto-henvisnings-program
      *
     c                   eval      wpstat = *blank
     c                   eval      wphele = *zero
      *
      * Legger inn leveringstype fra varelinje,
      *
     c                   eval      w_lety = ldlety
      *
      *  Kaller program for å finne konto
      *
     c                   call      'VA720R'
     c                   parm                    wpstat
     c                   parm                    w_lety
     c                   parm                    wpotyp
     c                   parm                    wpogrp
     c                   parm                    wphgrp
     c                   parm                    wpugrp
     c                   parm                    wpvare
     c                   parm                    wphele
     c                   eval      d_hele = wphele
      *
      *  Overstyrer avdeling dersom denne
      *  finnes på ordrehode
      *
     c                   if        loavde > 0
     c                   eval      d_kav1 = loavde
     c                   eval      d_kav2 = loavde
     c                   eval      d_kav3 = loavde
     c                   eval      d_kav4 = loavde
     c                   eval      d_kav5 = loavde
     c                   eval      d_kav6 = loavde
     c                   eval      d_kav7 = loavde
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine som eksekveres når første record leses
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     fcycle        begsr
      *
     c                   eval      *in99 = *on
      *
      *  Legger inn firmanummer i nøkklene
      *
     c                   eval      w_firm = lksfir
      *
      *  Legger inn ordretype i nøkklene
      *
     c                   eval      votyl1_otyp = lksoty
      *
     c                   eval      wpotyp = lksoty
      *
      *  Legger inn årstall i nøkklene
      *
     c                   movel     l_peri        tstaar
      *
      *  Beregner riktig Hundreår
      *
     c                   eval      sihelu_aarr = tstaar
     c                   eval      sidtlu_aarr = tstaar
      *
      *  Hent opplysninger fra LAGER-STATUS-REGISTER
      *
     c     lstsl1_key    chain     lstsl1r                            90
      *
      *  Henter inn sist brukte batchnummer
      *
     c                   eval      wsfell = laabat
     c                   eval      wstype = *blank
     c                   eval      wskode = '0'
     c                   exsr      hntnum
     c                   eval      wsbatc = wsnumm
     c                   eval      d_batc = wsnumm
     c                   eval      d_prog = l_ruti
      *
      *  Hent opplysninger fra KONTOHENVISNINGS-REGISTER
      *
     c                   eval      vkhvl1_kkod = laakhv
     c     vkhvl1_key    chain     vkhvl1                             90
      *
      *  Hent opplysninger fra ORDRE-TYPE-REGISTER
      *
     c     votyl1_key    chain     votyl1r                            90
      *
      *  Snur periode før oppdatering av regnskap
      *
     c                   move      l_peri        woperi
      *
     c                   movel     woperi        wpeaar
     c                   move      woperi        wpemnd
     c                   move      wpeaar        wtperi
     c                   movel     wpemnd        wtperi
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter/Oppdatering av NUMMER-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hntnum        begsr
      *
     c                   eval      wsfast = *blank
      *
      *  Kaller opp subprogram for henting av nummer fra NUMMER-REGISTER
      *
     c                   call      'AS100R'
     c                   parm                    wskode
     c                   parm                    w_firm
     c                   parm                    wsfell
     c                   parm                    wstype
     c                   parm                    wsfast
     c                   parm                    wsnumm
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Oppdaterer nytt statistikkregister (SISTPF)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     instat        begsr
      *
     c                   exsr      omr_antall
      *
     c                   eval      sifirm = lofirm
      *
     c                   eval      w_dato_6 = 010101
     c                   movel     wpeaar        w_dato_6
     c     *ymd          move      w_dato_6      w_dato
     c                   extrct    w_dato:*y     sipaar
     c                   move      wpemnd        sipmnd
      *
     c                   eval      sivaln = loldor
     c                   eval      sifaln = loldor
     c                   eval      siladr = 0
     c                   eval      silkat = rlkatg
     c                   eval      sirkat = rlrabk
     c                   eval      siselg = loinnk
      *
      * NB! Lendge er ikke samsvarende
      *     mellom rlland og siland
      *
     c                   move      rlland        siland
      *
     c                   eval      sidist = lodist
     c                   eval      sifrik = rlfrie
     c                   eval      simvak = lomkod
     c                   eval      sivare = ldvare
     c                   eval      sitek1 = ldtek1
      *
     c                   if        ldlvre = 0
     c                   eval      siogrp = vvogrp
     c                   eval      sihgrp = vvhgrp
     c                   eval      siugrp = vvugrp
8.12 c*                   if        w_lv_nobb <> 0
8.12 c*                   eval      sildor = w_lv_ldor
8.12 c*                   eval      silvar = w_lv_lvar
8.12 c*                   eval      sinobb = w_lv_nobb
8.12 c*                   else
8.12 c                   if        ldldor <> 0
8.12 c                   eval      sildor = ldldor
8.12 c                   else
8.12 c                   eval      sildor = vvldor
8.12 c                   endif
8.12 c                   eval      silvar = ldlvar
8.12 c                   eval      sinobb = ldnobb
8.12 c*                   endif
     c                   else
     c                   eval      siogrp = ldogrp
     c                   eval      sihgrp = ldhgrp
     c                   eval      siugrp = ldugrp
     c                   eval      sildor = ldldor
     c                   eval      silvar = ldlvar
     c                   eval      sinobb = ldnobb
     c                   endif
      *
     c                   eval      siahgr = vvahgr
     c                   eval      siaugr = vvaugr
     c                   eval      simodn = vvnmod
     c                   eval      silage = lolage
     c                   eval      sipran = vgupra
     c                   eval      sibinr = lobinr
     c                   eval      siline = teller
     c                   eval      sibida = lofkda
     c                   eval      siotyp = lootyp
     c                   eval      siornr = lonumm
     c                   eval      siorsu = losuff
     c                   eval      siorli = ldline
     c                   eval      siorda = lobdat
     c                   eval      siordr = ldornu
     c                   eval      siosuf = ldorsu
     c                   eval      siolin = ldorli
     c                   eval      silety = ldlety
     c                   eval      sikavd = wtavde
     c                   eval      sikkon = wtkont
     c                   eval      siksps = wtspes
     c                   eval      sioant = ldanta
     c                   eval      sioenh = ldenh1
     c                   eval      sianta = w_anta
     c                   eval      sivenh = vvenhs
     c                   eval      sifakr = wtstat
6.21 c**                 eval      sisumo = wlbelb
6.21 c                   eval      sisumo = wlbelb * w_pmku
6.21 c**                 eval      sisumb = wlbelb
6.21 c                   eval      sisumb = wlbelb * w_pmku
     c                   eval      sisumk = wlkost
6.21 c**                 eval      sirab1 = wlrkr1
6.21 c                   eval      sirab1 = wlrkr1 * w_pmku
6.21 c**                 eval      sirab2 = wlrkr2
6.21 c                   eval      sirab2 = wlrkr2 * w_pmku
6.21 c**                 eval      sirabo = wlrkro
6.21 c                   eval      sirabo = wlrkro * w_pmku
     c                   eval      simvak = lomkod
     c                   eval      sikres = vvkres
     c                   eval      sikbon = vvkbon
6.30 c                   eval      sivida = lovida
6.30 c                   eval      simoda = lomoda
6.31 c                   eval      sibitx = lobitx
6.31 c                   eval      sikidi = lokidi
6.31 c                   eval      sikref = lokref
6.31 c                   eval      sibetb = lobetb
6.31 c                   eval      silmat = lolmat
6.31 c                   eval      silbet = lolbet
6.31 c                   eval      sivalk = lovalk
6.31 c                   eval      sisped = losped
6.31 c                   eval      sikjor = lokjor
6.31 c                   eval      siproj = loproj
6.31sc                   eval      siupro = loarbo
6.31 c                   eval      siakti = loakti
6.31 c                   eval      sivref = lovref
6.31 c                   eval      sidref = lodref
6.31 c                   eval      silmtx = lolmtx
6.31 c                   eval      silbtx = lolbtx
6.31 c                   eval      sinett = lonett
6.31 c                   eval      sibrut = lobrut
6.31 c                   eval      sikoli = lokoli
6.31 c                   eval      siflow = loflow
6.31 c                   eval      sisorn = losorn
6.31 c                   eval      sisfak = losfak
6.31 c                   eval      sivalb = ldsumi * w_pmku
6.32 c                   eval      siomva = ldomva
     c                   if        loldat <> *loval
     c                   eval      sildat = loldat
     c                   else
     c                   eval      sildat = lobdat
     c                   endif
     c                   eval      w_dato = sildat
      *
     c                   call      'AX711R'
     c                   parm                    w_dato
     c                   parm                    w_saar
     c                   parm                    w_suke
     c                   parm                    w_stat
      *
     c                   if        w_suke > 52
     c                   eval      w_suke = 52
     c                   endif
     c                   eval      sipuke = w_suke
      *
     c                   eval      sitime = lotime
     c                   eval      siwsid = lowsid
      *
6.10 c                   time                    siodat
6.10 c                   time                    siotim
6.10 c                   eval      siousr = l_user
     c                   write     sistpfr
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for omregning av antall i forhold til statistikkenhet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     omr_antall    begsr
      *
6.25 c                   eval      w_omrk = 0
6.25 c                   eval      w_omrs = 0
      *
      * Dersom kjøpt enhet er lik statistikkenhet beholdes antall
      *
     c                   if        ldenh1 = vvenhs
     c                   eval      w_anta = ldanta
     c                   goto      end_omr
     c                   endif
      *
      * Finner omregningsfaktor volum for statistikkenhet og for kjøpt enhet
      * Antall regnes om etter forholdet mellom disse
      *
     c                   eval      vvenl1_vare = ldvare
     c     vvenl1_key    setll     vvenl1
     c     vvenl1_key    reade     vvenl1                                 90
     c                   dow       *in90 = *off
     c                   if        ldenh1 = veenhe
     c                   eval      w_omrk = veomre
     c                   endif
     c                   if        vvenhs = veenhe
     c                   eval      w_omrs = veomre
     c                   endif
     c     vvenl1_key    reade     vvenl1                                 90
     c                   enddo
      *
     c                   if        w_omrk = 0
     c                   eval      w_omrk = 1
     c                   endif
      *
     c                   if        w_omrs = 0
     c                   eval      w_omrs = 1
     c                   endif
      *
     c                   eval      w_anta = ldanta * w_omrk / w_omrs
      *
     c     end_omr       endsr
      *
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.70  *  Subrutine for å hente prisgruppe
5.70  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.70 c     hent_prisgr   begsr
5.70  *
5.70 c                   eval      w_avde = 0
5.70 c                   call      'VL712R'
5.70 c                   parm                    w_firm
5.70 c                   parm                    lolage
5.70 c                   parm                    w_avde
5.70 c                   parm                    w_prgr
5.70  *
5.70 c                   endsr
      *
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  *  Subrutine for å hente valutafaktor
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21 c     val_faktor    begsr
6.21  *
6.21  * Henter inn faktor for omregning til valuta
6.21  *
6.21 c                   eval      w_pmku = 1
6.21 c                   if        lovalk <> *blank and
6.21 c                             lovalk <> 'NOK'
6.21  * Sjekk om vi skal gjøre valutaomregning av beløp/summer
6.21 c                   eval      ra16l1_pkod = lovalk
6.21 c     ra16l1_key    chain     ra16l1r
6.21 c                   if        %found
6.21 c                   eval      w_pmku = rapmku
6.21 c                   endif
6.21 C                   endif
6.21  *
6.21 c                   endsr
7.00  *
7.00  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.00  * Legger ut posteringstrans til loggfil linjer
7.00  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.00  *
7.00  /Free
7.00   begsr logg_linjer;
7.00
7.00     w_lintel = w_lintel + 1;
7.00     w_dumkki = 0;
7.00     w_dumkkk = 0;
8.08     w_dumd20 = 0;
7.00     w_dumaki = '  ';
7.00
7.00        exec sql
7.00        insert into rlodst
7.00          (rldfir,rldtyp,rldts1,rldlin,rldper,
7.00           rldbun,rldbin,rldbli,rldbda,rldfda,
7.00           rldbko,rldbtx,rlddav,rlddko,rlddsp,
7.00           rlddmv,rldbel,rldmvg,rldkav,rldkko,
7.00           rldksp,rldkmv,rldpro,rldpra,rldpru,
7.00           rldpao,rldkrf,rldres,rldlki,rldkki,
7.00           rldkkk,rldaki,rldvko,rldvbe,rldmko,
8.08           rldmen,rldsal,rldsfa,rldtty,rldbet,rldrem)
7.00        values(:lgfirm,'INKJ',:w_logg,:w_lintel,
7.00               :lgperi,:lgbunt,:lgbiln,:lgbill,
7.00               :lgbdat,:lgfdat,:lgbilk,:lgtext,
7.00               :lgdavd,:lgdkto,:lgdsps,:lgdmom,
7.00               :lgbelp,:lgmvag,:lgcavd,:lgckto,
7.00               :lgcsps,:lgcmom,:lgproj,:lgakti,
7.00               :lgupro,:lgarbo,:lgkref,:lgkund,
7.00               :lgkidi,:w_dumkki,:w_dumkkk,:w_dumaki,
7.00               :lgvalk,:lgvalb,:lgmngk,:lgmngd,
8.08               :lgautx,:lgsfak,' ',:w_dumd20,' ');
7.00
7.00   endsr;
7.00  /END-FREE
7.02  *
7.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.02  * Legger ut poster til loggfil bilag
7.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.02  *
7.02  /FREE
7.02   begsr logg_bilag;
7.02
7.02     w_sumbel = 0;
7.02     w_dumtim = *loval;
7.02     w_dumsum = 0;
7.02     w_dumant = 0;
7.02     w_dumusr = '  ';
7.02     w_dumerr = '  ';
7.02
7.02        exec sql
7.02         insert into rlobst
7.02          (RLBFIR, RLBBIL, RLBTS1,RLBAN1,RLBSD1,RLBSK1,RLBBR1,
7.02           RLBTS2,RLBAN2,RLBSD2,RLBSK2,RLBBR2,RLBFF2,RLBFT2,
7.02           RLBTS3,RLBAN3,RLBSD3,RLBSK3,RLBBR3,RLBFF3,RLBFT3,
7.02           RLBTS4,RLBAN4,RLBSD4,RLBSK4,RLBBR4,RLBFF4,RLBFT4,
7.02           RLBTS5, RLBBR5, RLBTS6, RLBBR6)
7.02           select
7.02            lgfirm, lgbiln, :w_logg, count(*) ,
7.02            sum(lgbelp)/2 ,sum(lgbelp)/2, :l_user,
7.02            :w_dumtim, :w_dumant, :w_dumsum, :w_dumsum,
7.02            :w_dumusr, ' ', ' ',
7.02            :w_dumtim, :w_dumant, :w_dumsum, :w_dumsum,
7.02            :w_dumusr, ' ', ' ',
7.02            :w_dumtim, :w_dumant, :w_dumsum, :w_dumsum,
7.02            :w_dumusr, ' ', ' ',
7.02            :w_dumtim, :w_dumusr, :w_dumtim, :w_dumusr
7.02          from lovfpf
8.01          where lgfirm = :w_firm and lglogg = :w_logg
7.02          group by lgfirm,lgbiln
7.02          order by lgbiln ;
7.02
7.02   endsr;
7.00  /END-FREE
7.00  *
7.00  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.00  * Legger ut post til loggfil hode
7.00  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.00  *
7.00  /FREE
7.00   begsr logg_hode;
7.00
7.00     w_sumbel = 0;
7.00     w_dumtim = *loval;
7.00     w_dumsum = 0;
7.00     w_dumusr = '  ';
7.00     w_dumerr = '  ';
7.00
8.12a       exec sql
8.12a         select sum(rlbsd1), sum(rlbsk1)
8.12a           into :w_dsum, :w_ksum
8.12a            from rlobst
8.12a            where rlbts1 = :w_logg;
8.12a
8.12a       w_sumbel = (w_dsum + w_ksum) / 2;
8.12a
7.00        if w_sumbel > 0;
7.00        exec sql
7.00        insert into rlohst
7.00          (rlhfir,rlhtyp,rlhts1,rlhbs1,rlhbr1,
7.00           rlhts2,rlhbs2,rlhbr2,rlhfl2,
7.00           rlhts3,rlhbs3,rlhbr3,rlhfl3,
7.00           rlhts4,rlhbs4,rlhbr4,rlhfl4,
7.00           rlhts5,rlhbr5,
7.00           rlhts6,rlhbr6)
7.00        values(:w_firm,'INKJ',:w_logg,:w_sumbel,:l_user,
7.00               :w_dumtim,:w_dumsum,:w_dumusr,:w_dumerr,
7.00               :w_dumtim,:w_dumsum,:w_dumusr,:w_dumerr,
7.00               :w_dumtim,:w_dumsum,:w_dumusr,:w_dumerr,
7.00               :w_dumtim,:w_dumusr,
7.00               :w_dumtim,:w_dumusr);

7.00        endif;
7.00   endsr;
7.00  /END-FREE
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *  Nullstilling av felter som ikke kan redefineres
      *
     c                   eval      subdat = 0
     c                   eval      subdmy = 0
     c                   eval      subdam = 0
     c                   eval      subdag = 0
     c                   eval      submnd = 0
     c                   eval      subaar = 0
     c                   eval      subarb = 0
      *
     c                   eval      wpeaar = 0
     c                   eval      wpemnd = 0
      *
     c                   eval      teller = 0
     c                   eval      wsbatc = 0
      *
     c                   eval      wwtest = 'X'
      *
     c                   eval      wktext = *blank
     c                   eval      wkaaaa = 0
     c                   eval      wkbbbb = 0
      *
     c                   eval      wtvalg = 0
     c                   eval      wtavde = 0
     c                   eval      wtkont = 0
     c                   eval      wtspes = 0
     c                   eval      wtmkod = '0'
     c                   eval      wtbelh = 0
     c                   eval      wtsums = 0
      *
      * -----------------------------------------------------------
      *
     c                   eval      tstaar = 0
      *
     c                   eval      wskode = *blank
     c                   eval      wsfell = *blank
     c                   eval      wstype = *blank
     c                   eval      wsfast = *blank
     c                   eval      wsnumm = 0
      *
     c                   eval      mvapro = 0
     c                   eval      mvatil = 0
     c                   eval      mvafra = 0
      *
     c                   eval      w2kjop = 0
     c                   eval      w2kjof = 0
     c                   eval      w2kstp = 0
     c                   eval      w2kstf = 0
     c                   eval      w2rk1p = 0
     c                   eval      w2rk1f = 0
     c                   eval      w2rk2p = 0
     c                   eval      w2rk2f = 0
     c                   eval      w2rbgp = 0
     c                   eval      w2rbgf = 0
     c                   eval      w2rkop = 0
     c                   eval      w2rkof = 0
6.32 c                   eval      w2mvgp = 0
      *
     c                   eval      w6hsum = 0
      *
      *
     c                   eval      w6kjop = 0
     c                   eval      w6kjof = 0
     c                   eval      w6rk1p = 0
     c                   eval      w6rk1f = 0
     c                   eval      w6rk2p = 0
     c                   eval      w6rk2f = 0
     c                   eval      w6rkop = 0
     c                   eval      w6rkof = 0
6.32 c                   eval      w6mbel = 0
      *
     c                   eval      wphele = *zero
     c                   eval      wpogrp = 0
     c                   eval      wphgrp = 0
     c                   eval      wpugrp = 0
     c                   eval      whlp20 = 0
     c                   eval      wpvare = *blank
     c                   eval      wpstat = *blank
     c                   eval      wpotyp = *blank
      *
     c                   eval      wv002r = *blank
     c                   eval      wlrec = *blank
      *
      *  Key for file : LEVERANDØR-REGISTER
      *
     c     rlevln_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rlevln_levr
      *
      *  Key for file : VARE-REGISTER
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for oppslag på undergruppe-register
      *
     c     vugrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vugrl1_uogr
     c                   kfld                    vugrl1_uhgr
     c                   kfld                    vugrl1_uugr
      *
      *  Key for file : STATUS-KODER
      *
     c     lstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for file  : KONTOHENVISNINGS-REGISTER
      *
     c     vkhvl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vkhvl1_kkod
      *
      * Key for file : ORDRE-TYPE-REGISTER
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for file : LINJE-TYPE-REGISTER
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      *  Key for file : BESTILLING-HODE-REGISTER
      *
     c     lohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lohel1_numm
     c                   kfld                    lohel1_suff
      *
      *  Key for file : BESTILLING-LINJE-REGISTER
      *
     c     lodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lodtl1_numm
     c                   kfld                    lodtl1_suff
     c                   kfld                    lodtl1_line
      *
      *  Key for file : BESTILLING-TEKST-REGISTER
      *
     c     lotxl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lotxl1_numm
     c                   kfld                    lotxl1_suff
     c                   kfld                    lotxl1_line
      *
      * Key for file : INNGÅENDE-FAKTURA-HODE-REGISTER
      *
     c     sihelu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sihelu_aarr
     c                   kfld                    sihelu_binr
     c                   kfld                    sihelu_numm
     c                   kfld                    sihelu_suff
      *
      * Key for file : INNGÅENDE-FAKTURA-LINJE-REGISTER
      *
     c     sidtlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sidtlu_aarr
     c                   kfld                    sidtlu_binr
     c                   kfld                    sidtlu_numm
     c                   kfld                    sidtlu_suff
     c                   kfld                    sidtlu_ktxt
     c                   kfld                    sidtlu_line
      *
      * Key for les på vare-enhet-register
      *
     c     vvenl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl1_vare
6.21  *
6.21  * Key for oppslag på valutakode
6.21  *
6.21 c     ra16l1_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    ra16l1_pkod
7.11  *
7.11  * Key for les av vare på nobb-nummer (Vareadm.)
7.11  *
7.11 c     jvarl3_key    klist
7.11 c                   kfld                    jvarl3_nobb
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    p_parm
      *
     c                   eval      d_aarr = 0
     c                   eval      d_otyp = *blank
     c                   eval      d_batc = 0
7.00  *
7.00  * Legger inn timestamp for logging
7.00  *
7.00 c                   time                    w_logg
      *
8.02  * Sjekk om dobbel reskontropost skal ut
8.02  *
8.02   CallP CO402R(l_filg:w_firm:0:'INNKJØP_IKKE_DOBBEL_RESKONTROPOST':
8.02                    co402_verdi1:co402_verdi2);
8.02   if co402_verdi1 = '1';
8.02     u_dobbel_resk = *off;
8.02   endif;
8.09  *
8.09  * Sjekker om switch for transer til POG er på - slår av dobbel resk. funksjon
8.09  *
8.09   CallP CO402R(l_filg:w_firm:0:'POG_TRANS':
8.09                    co402_verdi1:co402_verdi2);
8.09   if co402_verdi1 = '1';
8.09     w_faka = %subst(co402_verdi2:1:13);
8.09     w_fakl = %dec(w_faka:13:0);
8.09     u_dobbel_resk = *off;
8.13     u_pogtr = *on;
8.09   endif;
     c                   endsr
      *
**     T Y P E / B I L A G S E K S T R A - T E K S T
 ********
 Avrunding
 Pliktig
 Fritt
