# RS884R – Validation of Subproject Existence and Status

## Overview

This program, RS884R, is part of the ASOKON system and is responsible for validating whether a given subproject (underprosjekt) exists and is active. It checks the presence and status of a subproject in the `RP3AL1` file and returns appropriate status and description texts.

## Business Logic

- **Purpose:**  
  To verify that a given subproject (identified by project, subproject, and activity keys) exists and is not closed.
- **Return Codes:**
    - `N`: Subproject does not exist in the register.
    - `S`: Subproject is closed (though this code is referenced in comments, it is not explicitly set in the current code).
- **Text Return:**  
  If the subproject exists, the program returns up to two text fields describing it.

## File Definitions

- **RP3AL1 (Physical File):**  
  This file is accessed using a keyed read (CHAIN) and is renamed locally as `RP3AL1R`. It holds the subproject records.  
  Key fields:  
  - Firm number (`rp3frm`)
  - Project number (`rp3pro`)
  - Subproject number (`rp3upr`)
  - Activity code (`rp3akt`)

## Parameters

The program is called with the following parameters (in order):

1. `p_retk` (1A): Return code (status)
2. `p_pros` (like `rp3pro`): Project number
3. `p_pupr` (like `rp3upr`): Subproject number
4. `p_pakt` (like `rp3akt`): Activity code
5. `p_txt1` (like `rp3txt`): Description text 1 (output)
6. `p_txt2` (like `rp3tx2`): Description text 2 (output)

## Program Flow

### 1. Initialization

- The firm number (`w_firm`) is set from the user data area field `l_firm` (positions 944–946 in the user data structure).
- The return code (`p_retk`) and both text fields (`p_txt1`, `p_txt2`) are initialized to blanks.

### 2. Key Construction

- The key for the file lookup is composed of:
    - Firm number (`w_firm`)
    - Project number (`rp3al1_pros`)
    - Subproject number (`rp3al1_pupr`)
    - Activity code (`rp3al1_pakt`)

### 3. File Lookup

- The program performs a `CHAIN` operation on `RP3AL1` using the constructed key.
- If a record is found:
    - The text fields from the record (`rp3txt`, `rp3tx2`) are copied into the output parameters (`p_txt1`, `p_txt2`).
- If no record is found:
    - The return code (`p_retk`) is set to `'N'` (not found).

### 4. Program Termination

- The LR indicator is set to `*ON` and the program returns.

## Design Decisions and Conventions

- **Indicator Usage:**  
  Indicators 60–61 are reserved for file operations. Only indicator 60 is used here for the CHAIN operation.
- **Return Code Convention:**  
  The return code is a single character; only `'N'` (not found) is set in this implementation. `'S'` (closed) is referenced in comments but not implemented.
- **Firm Number Source:**  
  The firm number is dynamically retrieved from the user data area (`l_firm`), allowing for multi-firm support without hardcoding.
- **Parameter Passing:**  
  All fields are passed by reference, making the program suitable for use as a subroutine or called program from other modules.
- **Text Data:**  
  Two text fields are returned, supporting multi-line descriptions for the subproject.
- **Localization:**  
  All comments and messages are in Norwegian, reflecting the system’s user base and business context.

## Integration Points

- **User Data Area:**  
  The program expects the user data area (positions 911–980) to be populated, particularly `l_firm`.
- **RP3AL1 File:**  
  This is the authoritative source for subproject data. The program assumes the file is up-to-date and accurate.
- **Calling Programs:**  
  RS884R is designed to be called by other programs or processes that need to validate subprojects before proceeding with business logic.

## Notable Omissions

- **Closed Project Handling:**  
  While the return code `'S'` is documented for closed projects, there is no logic implemented to check or set this status. If such a check is needed, additional logic must be added to interpret a status field from `RP3AL1`.
- **Error Handling:**  
  There is no explicit error handling for file I/O errors or data integrity issues; only the presence or absence of records is considered.

## Example Usage

A calling program would typically:

1. Set up the user data area with the correct firm number.
2. Call RS884R with the project, subproject, and activity codes.
3. Check the return code:
    - Blank: Subproject exists; use the returned text fields.
    - `'N'`: Subproject does not exist; handle accordingly.

## Sample Messages

Two static messages are included at the end of the source (likely for reference or CTDATA import):

- `UNDERPROSJEKT ER UGYLDIG` (Subproject is invalid)
- `PROSJEKTET ER AVSLUTTET` (Project is closed)

These may be used for populating the text fields in future enhancements or for user feedback.

---

**In summary:**  
RS884R encapsulates the logic for validating the existence of subprojects in a multi-firm environment, returning descriptive information if found, and a status code if not. It is a foundational utility for ensuring that downstream business processes only proceed with valid and active subprojects.