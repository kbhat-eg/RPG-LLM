# Documentation: JA200R – Avrundingsnøkkel Vedlikehold

## Overview

**Program:** JA200R  
**System:** ASOFAK  
**Purpose:**  
This program is responsible for the maintenance of "avrundingsnøkkel" (rounding key) master data, including creation, update, deletion, copying, and inquiry of key records. The program is designed to be used with a GUI and supports subfile-based display and manipulation of records.

**Business Domain Context:**  
"Avrundingsnøkkel" is a domain-specific entity, likely related to price rounding, discount matrices, or similar business rules. The program allows users to maintain these keys and their associated metadata.

---

## High-Level Structure

- **Files:**  
  The program works with multiple physical files (`jav3pfr`, `jav2pfr`) and their logical views, each mapped to different record formats for various lookup and update purposes.
- **Display:**  
  The main interface is a workstation file (`ja202d`) utilizing subfiles for record listing and manipulation.
- **Local Data Area (LDA):**  
  Used for session-specific values such as the current user and firm.
- **Indicator Usage:**  
  The program uses a classic indicator scheme (see comments in code) for controlling flow, display, and error handling.

---

## File Relationships

- **jav3pfr:**  
  Main file for rounding key levels, with logical views for read, update, and delete operations.
- **jav2pfr:**  
  Used for retrieving descriptions related to keys.
- **ja202d:**  
  Workstation file for user interaction, with subfile support (`b1sfl`).

---

## Key Data Structures

- **Local Variables:**  
  - `w_firm`, `w_regl`, `w_frpr`: Working variables for firm, rule, and "from price".
  - `w_srrn`, `w_ssrn`, `w_sfrn`, `w_spge`: Subfile navigation and page control.
- **Key Lists:**  
  Defined for efficient file access and positioning, supporting both main and sub-group navigation.

---

## Core Functionalities

### 1. Subfile Handling

#### a. Display and Navigation

- **Subfile is used for listing keys** (`b1sfl`).  
- **Paging:**  
  - `crt_subfile`: Fills the subfile with records, controlling page size and navigation.
  - `bck_subfile`: Handles backward paging.
  - `dsp_subfile`: Manages display logic, including setting indicators for display attributes.
- **Positioning:**  
  - The `posisjoner` subroutine allows fast navigation to a specific group or main group based on the user's input.

#### b. CRUD Operations

- **Create:**  
  - `xc1bld` (Create screen): Handles input for new key creation, including validation and duplicate detection.
- **Update:**  
  - `xc2bld` (Edit/View screen): Handles both update and view operations.  
  - Supports validation, description retrieval, and conditional update or insert, with audit fields (user, date, time).
- **Delete:**  
  - `xd1win`: Presents a delete confirmation window, then deletes the record.
- **Copy:**  
  - `xk1win`: Presents a copy window, validates, and invokes the edit/create subroutine for the new record.

#### c. Filtering

- **Filter functionality** is provided to restrict the subfile listing to records matching user-specified criteria (e.g., a specific rule).
- If a filter is applied, the subfile is cleared and refilled based on the filter.

### 2. Business Logic and Validation

- **Input Validation:**  
  - `sjekk_input`: Placeholder for input validation logic (currently minimal, can be extended).
  - Checks for duplicate records before allowing creation.
- **Description Retrieval:**  
  - `hent_info`: Fetches and populates descriptions for keys from the secondary file (`jav2pfr`).

### 3. User Interaction and Control Flow

- **Function Key Handling:**  
  - The main loop uses a `select` block to dispatch actions based on function key indicators (e.g., F3=Exit, F5=Refresh, F6=Create, F10=Next page, F11=Previous page, Home).
- **Screen Management:**  
  - Multiple screens/windows are used for different operations (list, create, edit, delete, copy, filter, message).
- **Error and Message Handling:**  
  - Uses indicators (31–79) for error/warning display and control.
  - Dedicated message screens for duplicate detection and other user feedback.

### 4. Integration Points

- **External Programs:**  
  - Calls to `JA201R` for additional rule lookup or maintenance, passing firm, rule, and description parameters.
- **Display File Feedback:**  
  - Uses the INFDS data structure to track cursor position and other display attributes.

---

## Notable Design Decisions and Patterns

- **Subfile Paging:**  
  The program uses manual paging logic for the subfile, tracking current, start, and end record numbers to allow efficient navigation even with large datasets.
- **Key List Abstraction:**  
  All file accesses are performed with well-defined key lists, simplifying file positioning and lookup logic.
- **Indicator Convention:**  
  The codebase uses a strict and well-documented indicator scheme for controlling program flow, display logic, and error handling. New developers should familiarize themselves with this convention.
- **Separation of Concerns:**  
  Each user operation (create, update, delete, copy, filter) is encapsulated in its own subroutine, supporting maintainability and modularity.
- **Audit Trail:**  
  All updates and inserts record the user, date, and time for traceability.

---

## Module and Data Source Interactions

- **Main Data Source:**  
  - `jav3pfr` (and logical views): Holds the core rounding key data.
  - `jav2pfr`: Holds descriptions for rules.
- **Display File:**  
  - `ja202d`: Handles all user interaction, including subfile display and modal windows.
- **External Program:**  
  - `JA201R`: Called for rule maintenance or lookup.

---

## Special Considerations

- **GUI Compatibility:**  
  Some comments reference adaptations for a new GUI (see version history). Be aware that certain display file features may only be compatible with the corresponding DDS.
- **Localization:**  
  Variable and comment names are in Norwegian. Familiarity with Norwegian business terms will aid understanding.
- **Legacy Style:**  
  The program uses fixed-format RPG and classic indicators. While robust, this style may differ from modern free-format RPG or OO approaches.

---

## Summary Table: Main Subroutines

| Subroutine    | Purpose                                                 |
|---------------|---------------------------------------------------------|
| forny         | Refreshes subfile after update or navigation            |
| posisjoner    | Positions subfile to a specific group/main group        |
| subfile       | Main subfile processing loop (edit, copy, delete, view) |
| xc1bld        | Create new key (input, validation, duplicate check)     |
| xc1msg        | Display message if record already exists                |
| xc2bld        | Edit/view key details; update or insert as needed       |
| xd1win        | Delete a key (with confirmation)                        |
| xk1win        | Copy an existing key                                    |
| clr_subfile   | Clear subfile and related counters                      |
| crt_subfile   | Populate subfile with records (paging logic)            |
| bck_subfile   | Page subfile backward                                   |
| dsp_subfile   | Display subfile and manage indicators                   |
| spørring      | Handle inquiry/lookup for rules                         |
| filter        | Apply filter to subfile listing                         |
| sjekk_input   | Input validation (placeholder)                          |
| hent_info     | Retrieve key description from secondary file            |

---

## Onboarding Notes

- **Learning Curve:**  
  New developers should pay special attention to the indicator usage and the subfile/paging logic, as these are central to the program’s operation.
- **Testing:**  
  When making changes, thoroughly test all subfile operations (paging, filtering, CRUD) as logic is tightly coupled.
- **Extensibility:**  
  The modular structure of subroutines supports extension, but any new features should maintain the indicator and key list conventions.

---

## References

- **Physical/Logical files:**  
  - `jav3pfr` (main), `jav2pfr` (descriptions)
- **Display file:**  
  - `ja202d` (DDS with subfile, modal windows)
- **External program:**  
  - `JA201R` (rule maintenance)

---

**For further questions or code walkthroughs, contact the senior RPG developer team.**