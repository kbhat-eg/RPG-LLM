# Overview

This RPG program (JP500R) operates on the IBM i (AS/400) platform using the ILE RPG (RPG IV) language. Its purpose is to **display and activate conditions for condition levels**—essentially, to manage price, discount, or other business conditions typically found in wholesale/distribution environments.

It is a classic interactive green-screen program using subfiles to let users review and manage records. The program also integrates SQL for some lookups and leverages multiple database files (physical and logical files), representing different keys/levels in the pricing/condition hierarchy.

Below is an explanation broken down by major sections, with comments on data structures, files, logic, and subroutines.

---

## Header/Comments

The header comments document the purpose, history, and change log of the program.  
**Indicators** are also documented—these are RPG’s logic flags, used for screen and logic control, such as function key handling, subfile display, error notification, and internal working states.

---

## File Declarations

All files are declared in the F-specs. Key points:

- `fjbetl1`, `fjbetlr`, `fjbetlu`, etc.: These are condition-related files for different access modes and keys (with `rename()` for record formats).
- `fjvarl1`, `fjvdtl1`, `fjlevl1`, etc.: Master files for items (products), item details, and suppliers.
- `fjp500d`: Workstation (display) file with a subfile for record display and user interaction.
- `infds(dspfbk)`: An information data structure for the display file is used to capture feedback like cursor positioning.

---

## Data and Variable Definitions

The D-specs define the main working storage, including:

- **Parameters** (`p_*`): Values passed to the program, e.g., company, item, supplier, price group, etc.
- **Key Variables** (`jbetl1_*`, `jbetlu_*`, ...): Used to build keys for lookups/updates in the various DB files.
- **Working Variables** (`w_*`, `b_*`): Used for subfile management, error handling, and temporary states.
- **Constants** (`c_sfil`): Used for managing subfile paging.

---

## Subfile Navigation Fields

Variables such as `w_fcrn`, `w_stel`, `w_spge`, and `w_srrn` are used for subfile paging, record counting, and cursor placement.

---

## Key Points from Comments

- **Screens**: Multiple green-screen formats are described; most work is done via subfiles (`B1SFL`).
- **Function Keys**: Mapped for navigation, refresh, inquiries, activation/deactivation, etc.

---

## Mainline Logic (C-specs)

### Initialization

- **SQL Settings** are established (`Set Option DatFmt=*ISO , commit=*none`).
- The program entry (`*inzsr`) sets up the working environment, fetches parameter data, and loads subfile(s) for display.

### Main Program Loop

- **Tags (`b2taga`, `b2tagb`) and branching**: The program cycles between control (command) screen and the subfile work area.
- **Function key handling**:  
    Uses RPG’s *INxx indicators to branch on F-keys (Exit, Inquiry, Refresh, Rolling, Home, Cursor, etc.).
- **Processing Subfile**:  
    The user can execute actions like View (`b1valg=5`), Discount element (`b1valg=7`), Agreement display (`b1valg=8`), or Activate/Deactivate (`b1valg=9`).

### Subfile Routines

- **Forny**: Reposition and reload the subfile display.
- **Subfile**: Handles user actions in the subfile, including calling other programs (`JP511R` for discount management), updating selections, and chaining to display routines.
- **Display**: Handles subfile display logic, including paging and function key visibility.

### Lookups and Business Logic

- **Hent_nivå**:  
    Finds the applicable condition level for a given item, searching from the most specific (item) to various broader levels (module, subgroup, group, supplier), following a top-down hierarchical structure.
- **Finn_fant**:  
    Calculates net price or discount by iterating through “discount element” records and applying their effects.
- **Aktiviser_bet**:  
    Toggles the activation state of a condition (e.g., sets or unsets ‘active’ flag) and writes the update to the database.

### Viewing Additional Information

- **Vis_nobb**:  
    Optionally (F18 key) displays additional NOBB (Norwegian building product registry) info for an item by calling another program and passing the NOBB number.

---

## Key Lists (KLISTs)

Key lists are grouped sets of fields used for indexed reads and updates on DB files, supporting rapid lookup of records at various business levels (item, module, supplier, group, etc.).

---

## Initialization Subroutine (*inzsr)

- **Reads parameters** and looks up relevant master data (item, supplier, group, price group, etc.).
- **Derives condition levels** by calling `hent_nivå` (which in turn uses different keys for the “betingelse”/condition hierarchy).
- **Fetches item and supplier descriptions** for display.
- **Loads the subfile** with initial records (`crt_subfile`).

---

## Subfile Handling

- **clr_subfile**: Clears the subfile and resets record counters.
- **crt_subfile**: Loads batch of records into the subfile, up to a page at a time, and calculates display fields (activation code, lock code, etc.).
- **dsp_subfile**: Handles the subfile screen display, enabling/disabling function keys as needed.

---

## SQL Integration

From version 6.33, SQL is used directly to:

- Lookup logistical supplier (`w_lv_ldor`)
- Fetch NOBB number and module number for an item (for correct mapping in the hierarchy)

---

## Condition Hierarchy

The program supports a sophisticated hierarchy for applying business conditions. It tries to find the most specific applicable condition, falling back to broader levels as necessary. Levels include, for example:

1. Item + Supplier
2. Module
3. Subgroup
4. Group
5. Supplier only
6. Price group (from version 6.3x)

This is implemented via repeated use of key variables (`jbetlb_key`, `jbetlc_key`, etc.) and the `chain` operation.

---

## Integration with Other Programs

- Calls to `JP511R`: For handling discount elements (detailed rules or components of a condition).
- Calls to `AP633R`: For display of NOBB info.

---

## User Action Flow

1. **User starts program with parameters** (company, item, supplier, etc.).
2. **Initial searches**: Finds applicable condition/price level.
3. **Loads subfile**: Records are shown to the user (one page at a time).
4. **User actions**:  
    - Function keys to refresh, inquire, view, scroll, or manage individual records.
    - Option-select per record to view, manage discount elements, agreements, or activate/deactivate a condition.
5. **Upon changes**:  
    Updates are written back to the relevant files (e.g., activation state).
6. **Optional side-displays**:  
    - NOBB info, price group text, etc., in pop-up windows or via program calls.

---

## Error/Edge Handling

- **Found/not found logic**: Uses `%found` after `chain`/`reade`.
- **EOF**: *in15 is used for end-of-file in subfile reads.
- **Indicators for error/working states**: 80–99.

---

## Summary — What a New Developer Should Know

- The program is an interactive green-screen utility for viewing and managing conditions (e.g., discounts, pricing) at multiple levels of a business hierarchy.
- It uses classic RPG IV and traditional subfile design.
- Business logic relies on searching from specific to general, using multiple keys and files.
- User navigation is managed by RPG indicators and tags.
- SQL is used for specific, modern lookups (NOBB, logistics).
- Integrates with other RPG programs for specialized tasks (discount elements, NOBB).
- Detailed comments and subroutine breakdowns make onboarding easier, but knowledge of subfile logic, RPG indicators, and business hierarchies is essential.

---

**TIP:** For onboarding, focus on understanding the condition levels, subfile interaction, and where/how the program updates the business data. Also, see which versions/features (e.g., SQL, price group, NOBB) are relevant for your business context, as these are denoted with version markers in comments and code (`6.3x`, etc.).