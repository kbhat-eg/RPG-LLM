# LC500R â€“ Batch Number Entry Program

## Overview

This RPG program, **LC500R**, is part of the warehouse management suite (ASLAGR system). Its primary function is to handle the entry and validation of batch numbers for inventory counting processes. The program interacts with user and batch master files, enforces business rules regarding user permissions, and integrates with other modules for batch lookup and further processing.

## Main Purpose

- **User Entry of Batch Numbers:** Presents a workstation screen for users to input a batch number.
- **Validation:** Checks if the batch number exists in the batch register.
- **Permission Checking:** Determines if the current user is authorized to perform specific actions related to inventory counting (e.g., print lists, update counts).
- **Integration:** Allows calling of a batch inquiry module (LC501R) and returns validated batch numbers to the calling process.

## File Dependencies

- **lusrl1 (User Register):** Holds user data and permissions. Renamed to `lusrl1r`.
- **lbchl1 (Batch Register):** Contains batch master data. Renamed to `lbchl1r`.
- **lc500d (Workstation File):** DDS-based display file for user interaction.

## Data Areas and Variables

- **Local Data Area:** Used for session/user context (user ID, firm number, etc.).
- **Parameters:**
  - `p_batc`: Batch number (input/output parameter).
  - `p_retu`: Return code (used for workflow control and permission code).
- **Working Variables:**
  - `w_firm`: Current firm/company code.
  - `w_kode`: Operation code (type of inventory action).
  - `lbchl1_batc`, `lusrl1_user`: Keys for file access.

## Program Flow

### Initialization (`*inzsr`)

- **Key Lists:** Sets up composite keys for user and batch files using firm and user/batch number.
- **Parameter Intake:** Reads `p_retu` (operation code) and `p_batc` (batch number) from the calling program.
- **User Context:** Loads firm and user information from the local data area.
- **User Lookup:** Reads user record from the user register for permission checks.

### Main Loop (Label: `a1taga`)

- **Display:** Shows the batch entry window (`a1win`).
- **Exit Handling:** If F3 or F12 is pressed, sets return code to '9' and exits.
- **Batch Inquiry (F4):** Calls `LC501R` for batch lookup, then returns to entry window.
- **Batch Existence Check:** Verifies that the entered batch exists in the batch register. If not, sets error indicator and returns to entry.
- **Business Rule Enforcement:**
  - Checks if the inventory is already updated (`lcsper <> 0`) and only allows result list printing.
  - Verifies user permissions for each operation (`w_kode`):
    - **T:** Print counting lists (requires at least 1 transaction).
    - **R:** Register/modify counting lists (requires at least 1 transaction).
    - **L:** Print result lists (requires at least 1 transaction).
    - **O:** Update inventory count (requires at least 2 transactions).
    - **D:** Run miscellaneous updates (requires at least 2 transactions).
  - If permission checks fail, sets error indicator and returns to entry.

- **On Success:** Sets the output batch number parameter and proceeds to program end.

### End of Program (`end_pgm`)

- **Cleanup:** Sets last record indicator and returns to the caller.

## Business/Domain Logic

- **Operation Codes (`w_kode`):**
  - **T:** Print counting lists.
  - **R:** Register/modify counting lists.
  - **L:** Print result lists.
  - **O:** Update inventory counts.
  - **D:** Miscellaneous batch-related tasks.

- **User Authorization:** Based on transaction counts in the user record (`lbtans`), the program restricts access to sensitive operations.

- **Batch Register Dependency:** All batch operations require a valid batch number existing in the batch master file.

- **Firm Context:** All file accesses are scoped by the firm/company code.

## Integration Points

- **LC501R:** Called for batch inquiry/search (F4 function key).
- **Calling Program:** Receives validated batch number and return code for further processing.

## Notable Design Decisions & Conventions

- **Error Handling:** Uses indicator variables (e.g., `*in31`, `*in33`, `*in36`, `*in90`) to signal specific errors or user feedback on the display.
- **Key Lists:** Standardizes composite key construction for file access, ensuring consistency across related modules.
- **Parameter Passing:** Utilizes RPG parameter lists for tight integration with calling programs and downstream processes.
- **Local Data Area Use:** Leverages system-wide session/user context for multi-firm, multi-user environments.

## Summary

**LC500R** is a batch entry and validation module central to the inventory counting workflow. It enforces business rules for batch operations, ensures only authorized users can perform critical tasks, and integrates seamlessly with related inquiry and transaction modules. The design prioritizes security, data integrity, and user guidance through error indicators and controlled workflow branching.