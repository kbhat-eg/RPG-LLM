# FO722R â€“ Documentation

## Purpose

This program (FO722R) is part of the ASOFAK system and is responsible for determining whether an order has been placed for procurement ("satt i bestilling"). The main function is to check if there are any order lines associated with a particular order that are ready to be ordered but have not yet been placed.

## High-Level Flow

1. **Initialization**: The program initializes key variables and receives parameters from the calling program.
2. **Order Line Check**: It scans the order line register (`fodtl1`) to see if any lines are not yet ordered.
3. **Result Setting**: If no lines can be ordered, it sets a specific return code (`p_plor = '8'`).
4. **Program End**: Cleans up and returns control to the caller.

---

## File Usage

- **fodtl1** (renamed from `fodtpfr` to `fodtl1r`):  
  This is the Order Line Register file. The program reads this file using a key list (firm number, order number, suffix) to find relevant order lines.

---

## Parameters

- **p_plor** (1 char): Output parameter indicating order status after processing.
- **p_firm** (3,0): The firm number (company identifier).
- **p_numm**: Order number (data type matches `fdnumm` from file).
- **p_suff**: Order suffix (data type matches `fdsuff` from file).

These parameters are passed in from the calling program.

---

## Key Variables

- **fodtl1_numm, fodtl1_suff, fodtl1_line**: Used to build the key for reading the order line file.
- **w_firm**: Local copy of firm number.
- **w_test**: Work flag (1 if there are lines that can be ordered, 0 otherwise).

---

## Main Logic

### 1. Initialization (`*inzsr` subroutine)

- Sets `p_plor` to blank.
- Initializes key fields for reading `fodtl1`:
    - Sets `w_firm`, `fodtl1_numm`, `fodtl1_suff` from input parameters.
    - Initializes `fodtl1_line` to zero.
- Defines the key list (`fodtl1_ke2`) for file access.

### 2. Entry Point (`*entry`)

- Receives parameters from the previous program.
- Calls the initialization subroutine.

### 3. Checking Order Lines (`sjekk_lin` subroutine)

- Sets `w_test` to zero (assumes no lines can be ordered).
- Positions to the first relevant record in `fodtl1` using the key list.
- Iterates through all matching records:
    - If `fdantb` (number ordered) is not zero, skips the line (already ordered).
    - If `fdanta` (number available to order) is not zero, sets `w_test` to 1 (there are lines that can be ordered).
- Ends the loop when no more matching records are found.

### 4. Setting the Result

- After checking all order lines, if `w_test` is still zero (no lines can be ordered), sets `p_plor` to `'8'`. This is likely a business code indicating "no lines can be ordered" or "order is fully placed".

### 5. Program End

- Sets LR indicator to *ON to close files and perform cleanup.
- Returns to the caller.

---

## Business/Domain-Specific Logic

- **Order Line Status**: The core business rule is that an order is considered "fully placed" if all lines have either been ordered (`fdantb <> 0`) or there are no lines available to order (`fdanta = 0`). If any line has `fdanta <> 0` and `fdantb = 0`, it means there are still lines that need to be placed.
- **Return Code (`p_plor`)**: Setting `p_plor` to `'8'` is a domain-specific convention to signal that the order is already fully placed or cannot be placed.

---

## Design Decisions & Conventions

- **Key List Usage**: The program uses a named key list (`fodtl1_ke2`) to consistently access the order line file with the correct keys.
- **Subroutines**: Initialization and line checking are encapsulated in subroutines (`*inzsr`, `sjekk_lin`) for clarity and reuse.
- **Parameter Passing**: The program is designed to be called by another program, with all necessary context passed in via parameters.
- **Minimal Output**: The only output is the status code (`p_plor`), suitable for use in batch or automated processes.

---

## Interactions

- **Data Source**: Reads from the `fodtl1` file (Order Line Register).
- **Calling Program**: Expects to be invoked by another program in the order processing flow, which supplies the firm, order number, and suffix.
- **No External APIs**: The program does not interact with external APIs or modules directly, but relies on the structure and integrity of the order line file.

---

## Notes & Maintenance

- **History & Changes**: The program has been updated for number extensions and price group field expansion (see change log in comments).
- **Extensibility**: If the business rules for "order placed" change, logic in the `sjekk_lin` subroutine should be reviewed.
- **Error Handling**: The program assumes valid input and does not include explicit error handling for missing or invalid records.

---

## Summary Table

| Variable / Field  | Purpose                                 |
|-------------------|-----------------------------------------|
| p_plor            | Return code: order placed status        |
| p_firm            | Firm/company number                     |
| p_numm            | Order number                            |
| p_suff            | Order suffix                            |
| fodtl1            | Order line register (input source)      |
| fdantb            | Number already ordered (file field)     |
| fdanta            | Number available to order (file field)  |
| w_test            | Work flag for orderable lines           |

---

## In Short

This program is a utility to check, for a given order, whether all lines are already placed (ordered) or if there are still lines pending placement. It is intended to be used as a backend check within the order processing workflow, returning a status code for further processing or decision-making.