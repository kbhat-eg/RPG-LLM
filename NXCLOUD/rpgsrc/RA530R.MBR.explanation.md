# RA530R – Mobiloperatør, spørring

## Overview

This program, `RA530R`, is a display file inquiry utility for the ASOKON system, specifically designed for querying "mobiloperatør" (mobile operator) data. It is tailored for use with subfiles and supports interactive navigation, selection, and positioning based on either a code or description. The program is structured around subfile processing with support for paging, searching, and selection.

The code is written in fixed-format RPG IV, and leverages standard IBM i conventions for interactive display file processing.

---

## File and Display Definitions

- **Physical Files:**
  - `ra30l1` and `ra30l2` (renamed from `ra30pfr`): These are likely logical files over a base file, providing access paths for key-based retrieval (by code and by description, respectively).
- **Display File:**
  - `ra530d` (workstn, SFILE): Main display file, with subfile `b1sfl` and control record `b2ctl`.

---

## Parameters and Variables

### Entry Parameters

- `p_firm` – Company identifier (like `redfir`)
- `p_dkod` – Document code (like `redkod`)
- `p_dtxt` – Description text (like `redtxt`)

### Key Variables

- `ra30l1_dkod` – Used for code-based lookups.
- `ra30l2_dtxt` – Used for description-based lookups.

### Subfile Control Variables

- `w_stel` – Subfile counter (number of records processed)
- `w_spge` – Subfile page size (number of records per page)
- `w_srrn` – Relative record number in subfile
- `w_sfrn` – First record number on page
- `w_ssrn` – Last record number on page
- `w_curn` – Current record number on page (cursor position)
- `w_virn` – Page and cursor positioning to display
- `w_seqe` – Sequence indicator: blank for code, 'B' for description
- `b_valg_ok` – Selection flag

### Constants

- `c_sfil` – Subfile page size (initialized to 8)

---

## Screen Layouts

- **B1SFL** – Subfile for records (main listing)
- **B2CTL** – Subfile control record (header, controls)
- **B2CMD** – Command key screen (function key handling)

---

## Indicator Usage

- **LR** – End program
- **10/11** – Roll/Roll-down (paging)
- **12/13/14/15** – Subfile display, control, clear, end
- **21/22** – Home key, cursor placement
- **30** – Field protection
- **31-79** – Error/message indicators
- **80-99** – Work indicators

---

## Main Program Flow

### Initialization (`*inzsr`)

- Receives parameters (`p_firm`, `p_dkod`, `p_dtxt`).
- Sets up key lists for code and description-based access.
- Initializes company variable, sets initial indicators.
- Positions the database to the start (by code).
- Calls `crt_subfile` to fill the subfile for the first page.

### Main Loop

- **Tag `b2taga`**: Writes the command screen (`b2cmd`).
- **Tag `b2tagb`**: Displays the subfile (`exsr dsp_subfile`). If a record is selected, calculates the starting record number for the next page.
- **Function Key Handling**: 
    - `F3/F12` (`*inkc`, `*inkl`): Exit program.
    - `F5` (`*inke`): Refresh subfile.
    - `Roll Up` (`*in10`): Next page.
    - `Roll Down` (`*in11`): Previous page.
    - `Home` (`*in21`): Set cursor placement.
- **Positioning**: If search fields (`b2dkod`, `b2dtxt`) are used, calls `posisjoner` to reposition and refill the subfile.
- **Subfile Processing**: Handles selection logic. If a record is selected, sets flags and exits.

---

## Subroutines

### `forny` (Refresh Subfile)

- If not at the start, chains to the current record in the subfile.
- Sets the file pointer based on current sequence (code or description).
- Clears and refills the subfile.

### `posisjoner` (Position in Subfile)

- If a document code is entered, positions by code.
- If a description is entered, positions by description.
- Clears and refills the subfile.
- Resets search fields after positioning.

### `subfile` (Subfile Processing)

- Toggles the cursor placement indicator.
- Processes each record in the subfile (using `readc`).
- If a selection is made (`b1valg = 1`), sets output parameters and flags, then exits.

### `clr_subfile` (Clear Subfile)

- Sets indicator to clear subfile, writes control record.
- Resets subfile pointers and counters.

### `crt_subfile` (Create/Fill Subfile)

- Increments page size and sets last record number.
- Reads records (by code or description) into the subfile until page is full or end of file/company.
- Writes each record to the subfile.
- Updates page pointers.

### `bck_subfile` (Page Backwards)

- If at end of file, positions to previous page.
- Reads backwards through the file to fill the previous page.
- Repositions to the correct spot if at beginning.
- Clears and refills the subfile.

### `dsp_subfile` (Display Subfile)

- If subfile has records, sets indicator for subfile display.
- Writes control record and displays subfile.
- Resets indicators after display.

---

## Business/Domain-Specific Logic

- The program is designed for browsing and selecting mobile operator records, either by code or by description.
- It handles both code-based and description-based access paths, allowing flexible searching and navigation.
- The subfile supports paging, selection, and direct positioning, typical for inquiry screens in Scandinavian business applications.
- The logic ensures that only records for the current company (`w_firm`) are displayed.

---

## Design and Conventions

- **Subfile Paging**: Uses explicit counters and page size constants for paging logic.
- **Indicator Management**: Follows IBM i standards for display file and subfile control.
- **Separation of Concerns**: Subroutines are used for all major actions (refresh, positioning, subfile handling, display, etc.).
- **Key Lists (`klist`)**: Used for file positioning, abstracting key definitions for code and description searches.
- **Parameter Passing**: Uses standard RPG parameter passing for returning selected values.

---

## Interactions

- **Data Sources**: Interacts with logical files over the operator master file (likely `ra30pfr`, via `ra30l1` and `ra30l2`).
- **Display**: Uses a display file (`ra530d`) with subfile and control records.
- **External Calls**: No external program calls; all logic is internal.

---

## Notable Implementation Details

- **Dual Access Paths**: Supports both code and description lookups, toggled via `w_seqe`.
- **Subfile Record Management**: Carefully tracks first/last/current/virtual record numbers to manage paging and cursor placement.
- **Selection Logic**: Only one record can be selected at a time; selection sets output parameters and exits the program.

---

## Summary

`RA530R` is a robust, interactive subfile inquiry program for the ASOKON system, supporting flexible navigation and selection of mobile operator records by code or description. Its structure and conventions are standard for IBM i subfile programs but tailored to the business requirements of mobile operator inquiries, with careful attention to paging, positioning, and user interaction.