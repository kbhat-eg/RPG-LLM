# RPG Program LO634R — Control List Print for Picking/Order Numbers

This ILE RPG program, named `LO634R`, is designed to print control lists for picked orders, specifically working with order numbers ("best.nr"). The code is written in classic fixed-format RPG IV (RPG/400 style), and is extensively commented (in Norwegian) to help understand its flow. Below is an onboarding-level breakdown of the main components and logic.

---

## 1. **File Declarations**

```rpg
FLOHEL1    IF   E           K DISK    RENAME(LOHEPFR:LOHEL1R)
FLODTL1    IF   E           K DISK    RENAME(LODTPFR:LODTL1R)
FLOTXL1    IF   E           K DISK    RENAME(LOTXPFR:LOTXL1R)
FLPLOL1    IF   E           K DISK    RENAME(LPLOPFR:LPLOL1R)
FLPSOLU    UF A E           K DISK    RENAME(LPSOPFR:LPSOLUR)
6.30 fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
```
- **Input files**: Order headers, order lines, order texts, picking registers, etc.
- **Output/Update file**: `LPSOLUR` is both read and updated.
- Additional files (with conditional version tags) are included for various required data (e.g., assortments, pricing).

---

## 2. **Data Structures (DS)**

Several data structures are defined, for:
- **Sorting criteria** (`SORTER`, `SOR001`-`SOR006`)
- **Input parameters** (parsed from `WWPARM`) for filtering and operation (`DSPREC`, `DSOTYP`, date/number ranges, flags)
- **Pricing transfer fields** (`HIREC`, `HOREC`): used to interact with pricing subroutines/programs

A user data structure (UDS) acquires information from the LDA (Local Data Area): user IDs, firm number, etc.

---

## 3. **Main Logic Flow**

### a. **Initialization (`*INZSR` Subroutine)**
- Fields and flags are initialized to blank/zero.
- LIKE definitions set up for fields and file keys.
- Key lists (`KLIST`) are built for later file access.
- Input parameter from preceding program is received (`*ENTRY PLIST`) via `WWPARM`.
- Firm number (`DSSFIR`) is loaded into all relevant keys.

---

### b. **Main Processing Loop**

#### 1. **Setup**
- Parse input parameters into local DS fields (`DSPREC`, `DSOTYP`, etc.).
- Set file position to first relevant order header (`SETLL`).

#### 2. **Loop Over Order Headers**
- **Read Loop (`TAG START`):**
  - Loop through headers (`READ LOHEL1R`).
  - **Filter checks:**  
    - Order number within given bounds.
    - Order type matches selected type.
    - Supplier number within range.
    - Order date within given bounds.
    - (If requested) User matches input.
  - **Retrieve pricing group** by calling a subroutine (`hent_prisgr`).

- **Further Checks:**
  - If a "picked record" is selected (`DSVAL3=1`): check in pick register (`LPLOL1R`). Further filter by workstation/user as needed.
  - If a "control-code" is selected (`DSVAL3=2`): check header for control code, and filter by workstation/user.

---

#### 3. **Processing Qualified Orders**

If all checks pass, process the order:

- **Set keys for header, lines, text, etc.**
- **Reset sort fields, prepare sort keys** (order number, suffix, etc.)
  - Sort criteria may be based on registration sequence (date/time) or item address (supplier/item).
- **EXSR LINJE**: Retrieve and process order lines (subroutine).
- **If order lines exist**: 
  - **EXSR OHEAD**: Output header.
  - **EXSR FORAN**: Output "front" text (lines ≤ 4999).
  - **EXSR ETTER**: Output "after" text (lines ≥ 5000).

- **Optionally remove pick status** (if `DSVAL6=1`) by calling `LO402R`.

- **Loop to next order** (`GOTO START`).

---

## 4. **Subroutines**

### a. **LINJE (Order Lines Processing)**
- Reads all lines for the current order.
- For each line:
  - Optionally check if the line should be included using `SJEKK` subroutine (e.g., prices/rabattes differ).
  - Writes/updates line info to the sort register.

### b. **SJEKK (Line Inclusion Test)**
- Checks if purchase price/rabattes deviate from standard via the `HNTVAR` subroutine (calls price-program).
- Calculates coverage (margin) and flags lines with margin 100% or lower than a specified percentage.

### c. **OHEAD, FORAN, ETTER (Output Routines)**
- Output the header and text lines to the sort register, updating existing records or writing new.
- Text lines are split into "front" (≤4999) and "after" (≥5000).

### d. **HNTVAR (Get Item Info)**
- Calls external programs (`VL710R`, `VP900R`) to fetch item type and price information.
- Populates the `HIREC`/`HOREC` DS with item and pricing details for use in tests.

### e. **hent_prisgr (Get Price Group)**
- Calls the `VL712R` program with firm/location to fetch the price group for the order/item.

---

## 5. **End of Program**

- When the end condition is reached, sets LR (last record) on, and returns.

---

# **Key Takeaways for New Developers**

- **Extensive Use of Data Structures:** The program parses and overlays fields for input parameters, price fields, and record keys. Understanding these overlays is critical.
- **File Operations:** Use of classic CHAIN, SETLL, READ, and UPDATE/WRITE for database file interaction.
- **External Program Calls:** Several subroutines delegate work (like price calculation, fetching item types or price groups) to external programs, passing parameters using data structures.
- **Parameter-Driven Filtering:** The primary loop heavily filters records based on a rich set of user-supplied parameters for order number, type, date, user, etc.
- **Sorting/Registering for Output:** Data is prepared for output by writing/updating "sort register" files, using composite keys to support different sorting/grouping requirements.
- **Legacy Syntax:** The code is written in older RPG IV (fixed-form) style, with classic C-spec operations and subroutines (`BEGSR`/`ENDSR`), no free-form.

---

# **Onboarding Advice**

- Get familiar with the physical/logical files used (LOHEL1R, LODTL1R, LOTXL1R, etc.) and the structures of records.
- Review the external programs (`VL710R`, `VP900R`, `VL712R`, `LO402R`) to understand what business logic they implement.
- Study how parameters are passed and parsed — a lot of program flexibility is controlled by the input parameter block (`WWPARM`).
- Pay attention to the conditional logic surrounding the filtering and output process, as business rules for inclusion/exclusion are critical.
- If you need to troubleshoot or enhance, focus first on the subroutine section, where the main business logic is located.

---

This program acts as a pivotal report/control "glue" module, coordinating order information, picking status, and pricing by integrating several data files and subcomponents. Understanding its structure provides a strong foundation for enhancing, debugging, or porting its business logic.