# RPG Program: Kontroll av gyldig kundenummer (Customer Number Validation)

## Overview

This RPG (Report Program Generator) program, named `RS750R`, is designed for IBM i (AS/400) systems. Its purpose is to check if a customer number is valid and return a code indicating the status:

- `'N'` if the customer does **not** exist
- `'S'` if the customer is **blocked** ("sperret")
- Else, returns the customer's name

The code is written in fixed-format RPG IV (ILE RPG), and it interacts with a physical file of customers (`rkunl1`) to perform lookups.

---

## Key Components

### File Definition

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
```
- **rkunl1**: Customer master file, keyed, externally described, renamed to `rkunl1r` in this program.

---

### Data Definitions

```rpg
d txt             s             30    dim(2) ctdata perrcd(1)
d p_kund          s                   like(rkkund)
d p_navn          s                   like(rknavn)
d p_retk          s              1
d w_firm          s                   like(rkfirm)
d w_kund          s                   like(rkkund)
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
d rkunl1_kund     s                   like(rkkund)
```
- `txt`: Array for message texts (2 messages loaded from CTDATA at the end of the source).
- `p_kund`, `p_navn`, `p_retk`: Parameters for customer number, name, and return code.
- `w_firm`, `w_kund`, `rkunl1_kund`: Work variables for company and customer numbers.
- `l_user`, `l_firm`, `l_fnav`: Fields extracted from the program's user space (?) - possibly from a parameter area mapped to *UDS.
- Field names like `rkkund`, `rknavn`, `rkfirm`, etc., are assumed to be from file definitions.

---

### Parameter List

```rpg
c     *entry        plist
c                   parm                    p_retk
c***                parm                    p_firm  // Removed according to V5.00 change
c                   parm                    p_kund
c                   parm                    p_navn
```
- Defines the program's input and output parameters:
    - Return code (output)
    - Customer number (input)
    - Customer name (output)
- Originally included company number (`p_firm`), but now removed.

---

### Main Logic

#### Initialization

```rpg
c                   eval      w_firm = l_firm
c                   eval      p_retk = *blank
c                   eval      p_navn = *blank
```
- Set work company number from the user area.
- Initialize return code and name to blank.

#### Customer Lookup

```rpg
c                   eval      rkunl1_kund = p_kund
c     rkunl1_key    chain     rkunl1r                            60
```
- Set local variable for customer number.
- Perform a `CHAIN` operation (keyed read) to locate the customer in the `rkunl1` file using a key list (`rkunl1_key`) specifying company number and customer number.
- If not found, indicator 60 is *on.

##### Customer Not Found

```rpg
c                   if        *in60 = *on
c                   move      'N'           p_retk
c                   move      txt(1)        p_navn
c                   goto      slutt
c                   endif
```
- Return code `'N'` (not found).
- Set name parameter to first message (`txt(1)`): "KUNDENUMMER ER UGYLDIG" ("Customer number is invalid").
- Go to termination.

##### Customer Is Blocked

```rpg
c                   if        rksprk = 'J'
c                   move      'S'           p_retk
c                   move      txt(2)        p_navn
c                   goto      slutt
c                   endif
```
- Check if the customer is blocked (`rksprk = 'J'`).
- Return code `'S'`.
- Set name parameter to second message (`txt(2)`): "KUNDEN ER SPERRET" ("Customer is blocked").
- Go to termination.

##### Customer Is Valid

```rpg
c                   move      rknavn        p_navn
```
- Set name parameter to customer's name from the file.

---

### End of Program

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- Set last record indicator on, ending the program.

---

### Key List Definition

```rpg
c     rkunl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rkunl1_kund
```
- Defines the key fields used for the `CHAIN` operation: company number and customer number.

---

### Message Data

Messages for status responses:
```
**
KUNDENUMMER ER UGYLDIG
KUNDEN ER SPERRET
```

---

## Summary & Usage

This program is called with parameters:

1. **Return code** (`p_retk`): Output, 1 char
2. **Customer number** (`p_kund`): Input
3. **Customer name** (`p_navn`): Output

The program will:

- Check if the customer number exists for the company in the customer file.
    - If not found: Sets code `'N'` and message "Customer number is invalid".
    - If customer is blocked: Sets code `'S'` and message "Customer is blocked".
    - If found and active: Sets code blank and returns the customer's name.

The company number is inferred from user/program data, not passed as a parameter to the program.

---

### Main Variables

| Name      | Use              | Type            | Description                |
|-----------|------------------|-----------------|----------------------------|
| p_kund    | Input param      | Like rkkund     | Customer number to check   |
| p_navn    | Output param     | Like rknavn     | Customer name or message   |
| p_retk    | Output param     | 1A              | Return code ('N', 'S', ' ')|
| w_firm    | Local            | Like rkfirm     | Company number (from UDS)  |
| rkunl1_kund | Local          | Like rkkund     | For file key               |
| txt(1,2)  | Local, messages  | 30A             | Error/status messages      |

---

### Indicators

- `*IN60`: Set when customer record is **not found** in the file.

---

## Conclusion

This RPG program is a helper/validation routine for customer numbers, indicating whether a customer is valid, blocked, or non-existing, and providing a suitable message for each case. It encapsulates standard key-handling RPG file access logic and uses arrays for constant message texts.