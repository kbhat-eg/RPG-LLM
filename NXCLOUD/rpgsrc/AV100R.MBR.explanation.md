## Program Overview

**Program Name:** AV100R  
**System:** ASPGPL  
**Purpose:** Validation and maintenance of a master table, with a hierarchical structure:  
- **Header Level:** Records with only `AVAPGM` filled and `AVAFLT` blank (displayed in this program).
- **Detail Level:** Managed/displayed in program AV110R.

The program provides a subfile-based interface for viewing, adding, editing, copying, and deleting header records in the master table. It includes navigation, positioning, and validation logic, and interacts with related files and programs.

---

## File Usage and Relationships

- **Physical/Logical Files:**
  - `avall1`, `avallr`, `avallu`: Different access paths (read, reference, update) to the same base file (`avalpfr`), each renamed for clarity in use.
- **Display File:**
  - `AV100d`: Main display file, defines subfiles and control records.
- **Subfiles:**
  - `B1SFL`: Subfile for displaying header records.
  - `B2CTL`, `B2CMD`: Control and command screens for subfile operations.

- **External Programs:**
  - `AV110R`: Called to display or manage detail records for a selected header.

---

## Key Data Structures and Variables

- **LDA (Local Data Area):** Used for user, firm, and navigation data (`l_user`, `l_firm`, `l_fnav`).
- **Display Feedback Data Structure (`dspfbk`):** Used to track cursor position and other display-related info.
- **Key Variables:** Used for chaining and updating records in the base file, always include `w_firm` as part of the key.
- **Subfile Navigation:**
  - `w_fcrn`: First record number on the page
  - `w_srrn`: Relative record number in subfile
  - `w_sfrn`, `w_ssrn`, `w_spge`: For page management in subfile display
- **Flags:** `b_oppr`, `b_forn`, `b_anul`, `b_feil` are used as operation and error flags.
- **Constants:** `c_sfil` (subfile page size, default 14)

---

## Screen Layouts

- **B1SFL:** Main subfile for listing header records.
- **B2CTL/B2CMD:** Subfile control and command screens.
- **C1BLD/C1MSG:** Screens for adding new records and displaying add-record messages.
- **C2BLD:** Screen for editing/viewing a record.
- **D1WIN/K1WIN:** Windows for delete and copy operations.

---

## Main Logic Flow

### Initialisation (`*INZSR`)
- Sets up key lists for file access.
- Retrieves firm number from LDA.
- Positions to the start of the file and fills the subfile with header records.

### Main Loop
- Alternates between command screen (`B2CMD`) and subfile display/handling.
- Handles function keys for navigation, add, edit, copy, delete, and detail view.
- Processes position requests and subfile operations.

### Subfile Handling

#### Display (`dsp_subfile`)
- Displays the subfile or command screen depending on whether records exist.

#### Clearing (`clr_subfile`)
- Clears subfile and resets navigation variables.

#### Filling (`crt_subfile`)
- Reads header records from the file, skipping detail-level records (`AVAFLT` not blank).
- Populates subfile up to the page size or until EOF.

#### Backward Paging (`bck_subfile`)
- Navigates backward in the list by a page, using `readp` operations.

#### Subfile Processing (`subfile`)
- Loops through subfile records and processes user-selected actions:
  - **Edit (2):** Calls edit subroutine.
  - **Copy (3):** Calls copy subroutine.
  - **Delete (4):** Calls delete subroutine.
  - **View (5):** Calls view subroutine.
  - **Details (7):** Calls AV110R for detail-level management.

---

## Record Maintenance Subroutines

### Add New (`xc1bld`)
- Prompts for key (`C1BLD`).
- Validates input and checks for duplicates.
- If duplicate found, displays message (`C1MSG`).
- Proceeds to maintenance screen (`xc2bld`) for data entry.

### Edit/View (`xc2bld`)
- Loads record data for editing/viewing (`C2BLD`).
- Handles both update and insert logic.
- Updates timestamp and user info.
- Updates subfile display as needed.

### Delete (`xd1win`)
- Loads and confirms the record to delete (`D1WIN`).
- Deletes record from the file.

### Copy (`xk1win`)
- Prompts for new key (`K1WIN`).
- Validates input and checks for existing record.
- Calls maintenance subroutine to create new record with copied data.

---

## Key Design Patterns and Conventions

- **Header/Detail Table Design:** Only header records (where `AVAFLT` is blank) are handled in this program. Detail records are managed in another program (AV110R).
- **Subfile Paging:** Manual management of subfile pages, with explicit navigation and page size handling.
- **Indicator Usage:** Follows a strict convention for indicator assignment (see initial comments).
- **Operation Flags:** Boolean flags (`b_oppr`, `b_forn`, etc.) are used to control flow and state across subroutines.
- **Key Lists:** Key fields are always constructed with `w_firm` (firm number) as the first field, ensuring multi-firm support.
- **Display Feedback:** Uses a data structure (`dspfbk`) to track and manage display attributes such as cursor position.

---

## Business/Domain-Specific Logic

- **Firm (Company) Filtering:** All file accesses are filtered by the current firm number (`w_firm`), supporting a multi-company environment.
- **Header/Detail Structure:** Only header-level records (with blank `AVAFLT`) are shown/maintained here; details are explicitly separated.
- **User/Date/Time Stamping:** Record updates and inserts track user and date/time for audit purposes.
- **Record Uniqueness:** New record creation checks for existing keys to prevent duplicates.

---

## External Interactions

- **AV110R:** Called for detail-level operations when the user requests "details" for a header record.
- **LDA:** Used to retrieve current user and firm context.

---

## Error Handling and Validation

- **Input Validation:** All input screens validate required fields and display error indicators/messages.
- **Duplicate Checking:** Add and copy operations check for existing records with the same key and handle accordingly.
- **Function Key Handling:** All screens handle cancel/exit keys and return to appropriate points in the workflow.

---

## Summary Table of Subroutines

| Subroutine      | Purpose                                      |
|-----------------|----------------------------------------------|
| forny           | Refreshes and rebuilds the subfile           |
| posisjoner      | Positions and rebuilds subfile based on key  |
| subfile         | Processes subfile row actions                |
| xc1bld          | Add new header record                        |
| xc1msg          | Display message for duplicate add            |
| xc2bld          | Edit/view header record                      |
| xd1win          | Delete header record                         |
| xk1win          | Copy header record                           |
| clr_subfile     | Clear subfile                                |
| crt_subfile     | Fill subfile with records                    |
| bck_subfile     | Page backward in subfile                     |
| dsp_subfile     | Display subfile                              |

---

## Notable Codebase Conventions

- **Norwegian Naming:** Many variable and comment names are in Norwegian; familiarity with key terms (e.g., "apgm" = program, "fl" = field, "firma" = company/firm) will help.
- **Indicator-Driven UI Logic:** Uses classic RPG indicator patterns for screen and subfile management.
- **Explicit State Management:** State is managed through a combination of indicators and one-character flags.

---

## Integration Points

- **Detail Records:** Not handled in this program; users are directed to AV110R for detail-level management.
- **Firm Context:** All operations are firm-specific, ensuring proper data partitioning in multi-company environments.

---

## Summary

This program is the entry point for header-level maintenance of a hierarchical master table. It provides robust subfile navigation, firm-aware filtering, and standard add/edit/copy/delete functionality, with integration to a detail-level maintenance program. The codebase follows well-documented indicator and variable conventions, with explicit control over subfile display and navigation. 

Familiarity with the Norwegian terminology and the indicator-driven UI model will be essential for effective onboarding and maintenance.