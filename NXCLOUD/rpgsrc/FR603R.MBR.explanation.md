# RPG Code Explanation: FR603R

This RPG program, **FR603R**, is designed to handle discount matrices and print a cross-reference, as per the description in the header comments (see: `Rabattmatrise, utskrift av kryssreferanse - param.`). It works in conjunction with DISPLAY FILE `FR603D` (indicated by `fr603d    cf   e             workstn`), likely a workstation file used for user interaction and screen display.

Below, the code is explained section by section for easier onboarding:

---

## 1. **Header Section**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **`option(*nodebugio)`** disables debug I/O.
- **`dateedit(*dmy)`** controls date format as day-month-year.

---

## 2. **File Declaration**

```rpg
ffr603d    cf   e             workstn
```
- Declares `FR603D` as a **workstation (workstn)** file for screen I/O.

---

## 3. **LDA (Local Data Area) Variable**

```rpg
d                uds
d l_firm                944    946  0
```
- Defines an unnamed data structure (`uds` = User Data Structure).
- `l_firm` extracts a 3-digit company code from the LDA at positions 944-946.

---

## 4. **Parameter Structure for Output**

```rpg
d                 ds
d d_list                        16
d  d_firm                        3  0 overlay(d_list: 1)
d  d_rkaf                        3  0 overlay(d_list: 4)
d  d_rkat                        3  0 overlay(d_list: 7)
d  d_dumm                        1    overlay(d_list:16) inz('*')
```
- Declares a 16-byte data structure `d_list`, used as a parameter list.
- Subfields:
  - `d_firm`: 3-digit company code, starts at position 1.
  - `d_rkaf`: 3-digit discount category from field A, starts at position 4.
  - `d_rkat`: 3-digit discount category to field A, starts at position 7.
  - `d_dumm`: 1-byte dummy field (set to `'*'`), used as a marker or end-of-structure.

---

## 5. **Working Variables**

```rpg
d b_feil          s              1    inz(*off)
d w_firm          s              3  0
d w_rtxt          s             30
```
- `b_feil`: Error flag, initialized to 'off'.
- `w_firm`: Working copy of the company code.
- `w_rtxt`: 30-character text field, likely used for query return text.

---

## 6. **Mainline Logic**

### **B1: Handle Opening Screen**

```rpg
c     b1taga        tag

c                   exfmt     b1bld
```
- Label `b1taga` marks the start of the screen-handling loop.
- Uses `EXFMT` to display and accept input from the `b1bld` screen format.

#### **Function Key Handling**

```rpg
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
```
- If F3 (`*INKC`) or F12 (`*INKL`) is pressed, go to label `avslutt` (exit).

#### **F4 Inquiry**

```rpg
c                   if        *inkd = *on
c                   exsr      spørring
c                   goto      b1taga
c                   endif
```
- If F4 (`*INKD`) is pressed, execute subroutine `spørring` ("inquiry"), then redisplay the screen.

#### **Input Validation**

```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   goto      b1taga
c                   endif
```
- Calls `sjekk_input` to validate inputs. If errors, redisplay screen.

#### **Parameter Passing and Program Call**

```rpg
c                   exsr      flytt_par

c                   call      'FR603C'
c                   parm                    d_list
```
- Move input to parameter structure via `flytt_par`.
- Call print program `FR603C` with the parameters.

---

## 7. **Program Exit**

```rpg
c     avslutt       tag

c                   eval      *inlr = *on
c                   return
```
- Tag `avslutt` for program exit. Sets last record indicator (`*INLR`) to `ON` (close files/end program).

---

## 8. **Subroutines**

### **8.1 spørring (Inquiry/Lookup)**

Handles lookups on discount category fields (`B1RKAF`, `B1RKAT`) via another program.

```rpg
c     spørring      begsr

* Rabattkategori
c                   if        w_afld = 'B1RKAF'
c                   call      'RA506R'
c                   parm                    w_firm
c                   parm                    b1rkaf
c                   parm                    w_rtxt
c                   leavesr
c                   endif

c                   if        w_afld = 'B1RKAT'
c                   call      'RA506R'
c                   parm                    w_firm
c                   parm                    b1rkat
c                   parm                    w_rtxt
c                   leavesr
c                   endif

c                   endsr
```
- If the active field (`w_afld`) is either `'B1RKAF'` or `'B1RKAT'`, calls `RA506R` to lookup data, passing `w_firm`, the respective category, and a return text variable. Then exits the subroutine.

---

### **8.2 sjekk_input (Input Validation)**

Checks that the from-to range is logical.

```rpg
c     sjekk_input   begsr

c                   eval      b_feil = *off

* Rabattkategori
c                   if        b1rkaf <> 0 and
c                             b1rkat <> 0 and
c                             b1rkaf > b1rkat
c                   eval      *in31 = *on
c                   eval      b_feil = *on
c                   leavesr
c                   endif

c                   endsr
```
- Resets error flag.
- If both `b1rkaf` and `b1rkat` are nonzero and `b1rkaf` is greater than `b1rkat`, sets an error indicator (`*IN31`) and the error flag. Then exits the subroutine.

---

### **8.3 flytt_par (Move Fields to DS Parameters)**

Moves screen fields into the parameter data structure.

```rpg
c     flytt_par     begsr

c                   eval      d_firm = w_firm

c                   eval      d_rkaf = b1rkaf

c                   if        b1rkat = 0
c                   eval      d_rkat = b1rkaf
c                   else
c                   eval      d_rkat = b1rkat
c                   endif

c                   endsr
```
- Moves company code to parameter DS.
- Moves from-category, and sets to-category to from-category if not provided.

---

### **8.4 *INZSR (Initialization Subroutine)**

```rpg
c     *inzsr        begsr

* Henter firma fra LDA
c                   eval      w_firm = l_firm

c                   endsr
```
- On program start, loads company code from the LDA into working storage.

---

## **Summary/Flow**

1. **Initialization**: Loads company code from LDA.
2. **User Interaction**:
   - Displays screen, handles input, function keys (F3/F12=exit, F4=inquiry).
   - Validates input fields for logical discount category ranges.
   - If valid, populates parameter data structure.
3. **Processing**:
   - Calls the print program with parameters.
4. **Exit**: Cleans up and exits on command.

---

## **Key Concepts/Takeaways**

- **Modularity**: Uses subroutines for inquiry, validation, and field movement.
- **Parameter Passing**: Uses a data structure `d_list` to pass multiple fields as a single parameter.
- **Screen Handling**: Drives logic off user input and function keys via a workstation display file.
- **Input Validation**: Ensures business rules on ranges are enforced before processing.

---

**If you have the DDS source for the display file or need more details on any subroutine or business rules, let me know!**