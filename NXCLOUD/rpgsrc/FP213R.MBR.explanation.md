# RPG Program Explanation: `FP213R` – Printing Price Labels

This RPG/400 (ILE RPG) program is designed to print price labels (prisetiketter) for inventory items, supporting multiple label/price tag printer types. The code is written using classic (fixed format) RPG syntax and includes conditional output logic for different printer models.

Below, the source code is explained section by section for onboarding and maintenance purposes.

---

## 1. Title, Revision History, and Comments

At the top, you see a `/TITLE` directive and a detailed comment block.  
- **System:** ASOFAK  
- **Program:** FP213R  
- **Description:** Prints price labels  
- **Revision Log:** Multiple versions, each entry documents date, author/initials, and change description.  
- **Supported Printers:** Meto (various), Bandit, Eltron, Datamax EX-2, Meto mi-4

---

## 2. File Declarations

```rpg
fvaw1pf    if   f  512        disk
fEtikett   o    f  132        Printer oflind(*inof)
```
- **`vaw1pf`**: Input file, likely inventory or product master data.
- **`Etikett`**: Output printer file, record length 132.

---

## 3. Data Definitions (D-Specs)

These lines define work areas and interface variables that map to particular data positions:

```rpg
D                uds
d l_etpr                112    112  0
d l_hex1                760    779
d l_hex2                780    799
d lcskty                891    891  0
d lcuser                911    920
d lcfirm                944    946  0
d l_fnav                951    980
d w_skty          s                   like(lcskty)
d w_hyle          s                   like(vahyle)
d w_anta_1        s              1  0
d w_anta_2        s              2  0
d w_anta_3        s              3  0
```
- Most of these are overlays or substrings from some larger buffer (often Local Data Area or an input buffer).
- Variables like `w_skty` and `w_hyle` are working copies used in logic.

---

## 4. Input Layout (I-Specs)

These define positions (columns) of fields in the input records (`vaw1pf`):

```rpg
i                                  1    4 0vaanta     // Quantity of labels
i                                  5   19  vattxt     // Item text
i                                 20   25  vatvar     // Variant
i                                 26   30  vatenh     // Unit
i                                 31   37  vatpri     // Price
i                                 38   45  vadato     // Date
i                                 59   66 0vavare     // Item no
i                                 74   86 0vaeann     // EAN/barcode
i                                 87   99  valvar     // Variant value
// ... Additional fields for new label versions ...
```

---

## 5. Main Program Logic (C-Specs)

### Main Loop

```rpg
c                   dow       *in61 = *off           // Loop while not EOF
```
- The program reads one input record at a time until EOF indicator (input file's record 61) is set.

### Price Blanking (Optional)

```rpg
C     l_etpr        ifeq      1
c                   eval      vapri1 = *blank        // Blank out price if a parameter says so
C                   endif
```
- If `l_etpr` equals `1`, the price field will be blanked.

### Printer Type Logic

Depending on the value of `w_skty` (printer type), specific logic and output programs are executed:

```rpg
C     w_skty        ifeq      0
c                   except    �pgm0                  // Twinax printer program
C                   endif

C     w_skty        ifeq      1
c                   except    �pgm1                  // Standard printer program
C                   endif
// ... (other printer types)
```

- Labels are printed differently for each printer type.  
- For Bandit printers (`w_skty=2`), there is additional logic to set print quantities depending on `vaanta`.

### Read and Loop

After processing the label for the current record, the loop advances:
```rpg
c     neste         tag
c                   read      vaw1pf                 61
c                   enddo
```

### Program End

Jumps to the `avslutt` tag:
```rpg
c                   goto      avslutt
```
At the end, for Bandit, a special output record is written and the RPG `*inlr` (last record) indicator is set to end the program.

---

## 6. Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
c                   read      vaw1pf                 61
C                   eval      w_skty = lcskty
C     w_skty        ifeq      2
c                   except    �pgm2
C                   endif
c                   endsr
```
- Reads the first record, initializes the printer type, optionally writes an initialization record for Bandit printer.

---

## 7. Output Specifications (O-Specs)

For each printer type, a named output program and associated label formats are defined using RPG's output specs.

Each output program (e.g. `�pgm0`, `�data0`, etc.) corresponds to a printer language or initialization/data format:

- **Twinax (`�pgm0`, `�data0`):** Utilizes special control codes suitable for Meto 8100 Twinax printers.
- **Standard (`�pgm1`, `�data1`):** Uses another set of control codes (curly-brace notation).
- **Bandit (`�pgm2`, `�data2`, `�end2`):** Special scripting for Bandit printers.
- **Eltron (`�pgm3`, `�data3`):** Eltron (now Zebra) printer scripting.
- **Meto mi-4 / Datamax EX-2 (`�data4`):** Modernized label scripting for these printers.

Data lines (e.g. outputting `vattxt`, `vapri1`, etc.) populate the dynamic fields for each tag based on input data.

---

## 8. Key Features

- **Printer Type Conditionalization:** Handles multiple models with correct initialization, scripting, and data output.
- **Blank Price Support:** Optionally prints tags without price when parameter indicates.
- **Flexible Label Composition:** Output programs are tailored to printer commands, with placeholders inserted for data.
- **Batch/Quantity Handling:** Bandit printer logic ensures the correct number of labels via quantity logic.

---

## 9. Maintenance & Extension

- **To add a new printer type:** Extend `w_skty` logic, add new output program(s) with appropriate scripting in O-specs.
- **To add new data fields:** Update I-specs to extract new columns, define new variables, and include them in output specs.
- **To change label layout:** Adjust O-specs per label printer section.

---

## 10. Summary

This RPG program automates the printing of price labels for different hardware platforms. It reads input records, determines print parameters and target printer type, and emits the correct printer commands and data formatting dynamically.

**Variables names and comments are partially in Norwegian** (e.g. `prisetiketter` = price labels; `Skriver` = printer), which is important for internationalization and maintaining clarity for developers unfamiliar with the language.

---

**Note:** Classic RPG (before RPG IV/free) uses fixed column formatting, so variable alignment and field positions are essential for correct operation. Modernization or conversion to Free Format RPG would increase maintainability.