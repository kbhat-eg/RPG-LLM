```markdown
# RPG Program Explanation: IT018R

## Overview
This RPG program, named `IT018R`, reads contact person records from a physical file, processes them, and calls another program (`IT001R`) to handle each unique contact record. The code comments and variable names are primarily Norwegian, but the overall structure and logic are straightforward.

---

## Header Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: No debug info for input/output operations.
- `*DMY`: Date edit uses day-month-year format.

---

## File Declarations

```rpg
frukpl2    if   e           k disk    rename(rukppfr:rukpl2r)
```
- Declares file `rukpl2` (a contact person file) for input, keyed (random access).
- Renames the record format from `rukppfr` to `rukpl2r`.

---

## Data Area and Variables

### Local Data Area
```rpg
d                uds
d l_firm                944    946  0
```
- Retrieves a 3-digit company number (`l_firm`) from the Local Data Area.

---

### Key Variables

```rpg
d rukpl2_kpnr     s                   like(rukpnr)
```
- Work variable for contact person number, same type as the file field `rukpnr`.

---

### Parameter Data Structure

```rpg
d d_parm          ds
d  d_kpnr                        6
d  d_enav                             like(ruenav)
d  d_fnav                             like(rufnav)
d  d_alfa                             like(rualfa)
d  d_ptlf                             like(ruktlf)
d  d_mtlf                             like(rumtlf)
d  d_mail                             like(rumail)
d  d_kobl                        6
d  d_kpko                        1
```
- `d_parm` collects contact information to be passed as a parameter block to the called program.
    - `d_kpnr`: Contact person number (6 chars)
    - `d_enav`, `d_fnav`: First/last names
    - `d_alfa`: Alpha code or similar
    - `d_ptlf`, `d_mtlf`: Phone numbers
    - `d_mail`: Email address
    - `d_kobl`: Customer/supplier number (6 chars)
    - `d_kpko`: Indicator ('K' for customer, 'L' for supplier)

---

### Working Variables

```rpg
d w_firm          s              3  0
d w_prog          s             40
d w_comd          s             20
d w_parm          s           2048
d w_date          s               d   datfmt(*iso)
d w_time          s               t   timfmt(*iso)
d w_rpgp          s             10
d w_kpnr          s                   like(rukpnr)
```
- `w_firm`: Current company number
- `w_prog`: Program name string (for logging or passing)
- `w_comd`: Command (e.g., operation type)
- `w_parm`: Buffer for passing data structure
- `w_date`, `w_time`: Date/time (not used in current logic)
- `w_rpgp`: Current program’s identifier
- `w_kpnr`: Last processed contact person number

---

## Main Program Logic

### Initialization

- The `*INZSR` subroutine sets up initial values, including positioning key and program identifying data:

```rpg
c     *inzsr        begsr
c     rukpl2_key    klist
c                   kfld                    w_firm
c                   kfld                    rukpl2_kpnr
c                   eval      w_firm = l_firm
c                   eval      w_prog = 'NexstepImportKontaktpersoner'
c                   eval      w_comd = 'Insert'
c                   eval      w_rpgp = 'IT018R'
c                   endsr
```
- The key list `rukpl2_key` is set up for record positioning using the company number and contact person number.
- Program info fields are set for use later during `CALL`.

---

### Main Loop: Reading and Processing Records

```rpg
c                   eval      w_kpnr = 0
c                   eval      rukpl2_kpnr = 0
c     rukpl2_key    setll     rukpl2
c                   read      rukpl2
c                   dow       not %eof and rufirm = w_firm
    -- Process record
c                   read      rukpl2
c                   enddo
```

- **Set Initial Key**: Sets the file pointer to the start (for the active company).
- **Loop**: Reads records from `rukpl2` until the end of file or until the company number no longer matches.
- **Inside Loop**:
    - Move field values from the record to the parameter data structure (`d_parm`).
    - Figure out if the contact is tied to a customer (`rukund <> 0`) or supplier (`rulevr <> 0`):
        - Set `d_kpko` ('K' for customer, 'L' for supplier) and assign the respective number (customer/supplier) to `d_kobl`.
    - If the contact person number (`rukpnr`) changes (i.e., a new contact person record):
        - Call external program `IT001R`, passing the parameter data.
        - Update `w_kpnr` to the current `rukpnr`.

---

### Program Termination

```rpg
c                   eval      *inlr = *on
c                   return
```
- Set the last record indicator on to ensure files are closed and memory is released.
- Return from the program.

---

## Subroutines

### *INZSR - Initialization Subroutine

- Prepares key fields and assigns static values to program/command/parameter fields for use during the job.

---

## Summary

- **Purpose**: Reads all contact persons for the current company from `RUKPL2`, for each unique contact runs an integration routine (calls `IT001R`), passing all relevant data.
- **Key Features**:
    - Extracts and packages contact data into a parameter structure.
    - Distinguishes between customer and supplier links.
    - Skips duplicate processing for the same contact number.
    - Designed for batch integration/import tasks.

---

## Noteworthy RPG Techniques

- **Data structures** (`d_parm`) are used for parameter passing.
- **Keyed I/O**: Uses `setll` and `klist` for efficient file positioning.
- **External Program Calls**: Inline `call` with multiple parameters for integration.

---

## Onboarding Tips

- Familiarize yourself with the structure of the `rukpl2` file and associated fields.
- The called program `IT001R` likely handles the database write/integration logic.
- The company number (`w_firm`) is loaded from the Local Data Area, making the program company-specific.
- The Norwegian comments/variables translate as follows (examples):  
    - `leser` = reads, `skriver` = writes, `kunde` = customer, `leverandør` = supplier, `kontaktpersoner` = contact persons.

---
```