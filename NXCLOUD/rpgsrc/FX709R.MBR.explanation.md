# Program FX709R — Documentation

## Overview

**Program:** FX709R  
**System:** ASOFAK  
**Purpose:**  
This program is a fix utility designed to correct VAT (moms) codes on order lines in the order and invoice line file. It is specifically used for customers where order lines have been assigned incorrect VAT codes. The program updates only order lines, not offer or invoice lines.

**Special Version:**  
- Only updates order lines.
- Intended for customers with erroneous VAT codes on order lines.

**Change History:**  
- Initial version: 29.10.2004 (HKO)
- 26.09.2007 (AMD): Restricted to updating only order lines.
- 24.06.2009 (BSA): Added tracking information (user, date, time).

---

## File Definitions

- **fodtlu (fodtpfr → fodtlur):**  
  Main order/invoice line file (update capable, keyed).
- **vvarl1 (vvarpfr → vvarl1r):**  
  Primary item master file (input, keyed).
- **vvasl1 (vvaspfr → vvasl1r):**  
  Alternative item master file (input, keyed).

All files use `RENAME` to map external file names to internal record formats.

---

## Local Data Area (LDA) Usage

- The program reads the user ID from the LDA (positions 911–920) into the variable `l_user`. This is used for tracking which user performed updates.

---

## Key Variables

- `vvarl1_firm`: Firm number for item lookup (same type as `vvfirm`).
- `vvarl1_vare`: Item number for lookup (same type as `vvvare`).

---

## Main Logic

The core of the program processes all records in the order/invoice line file (`fodtlur`). The logic is as follows:

1. **Read Loop:**  
   Iterates through each record in `fodtlur`.

2. **Selection Criteria:**  
   For each record, checks:
   - `fdvare` (item number) is not blank
   - `fdomva` (VAT code) is blank  
   Only records meeting these criteria will be updated.

3. **Initial VAT Code Assignment:**  
   Sets `fdomva` to `'3'` as a default placeholder.

4. **Item Lookup:**  
   - Sets key fields (`vvarl1_firm`, `vvarl1_vare`) from the current order line.
   - Attempts to find the item in `vvarl1` (primary item master).
   - If not found, attempts lookup in `vvasl1` (alternate item master).

5. **VAT Code Correction:**  
   If an item record is found and `vvkmva` (item VAT group) is not zero:
   - If `vvkmva = 1`, set `fdomva` to `'4'`.
   - Else, set `fdomva` to `'H'`.

6. **Tracking Information:**  
   - Updates `fdedat` (edit date) and `fdetim` (edit time) with the current time.
   - Sets `fdeusr` (edit user) with the value from `l_user`.

7. **Record Update:**  
   Updates the current `fodtlur` record with the new VAT code and tracking info.

8. **Continue Loop:**  
   Reads the next record and repeats until end of file.

---

## Program Termination

- The program sets on LR (`*inlr = *on`) and returns, closing files and exiting cleanly.

---

## Subroutine: *INZSR (Initialization)

- Sets up the key list for item lookups:
  - `vvarl1_key` consists of `vvarl1_firm` and `vvarl1_vare`.
- No other initialization logic is present.

---

## Business/Domain Logic Notes

- **VAT Code Assignment:**  
  The VAT code (`fdomva`) is initially set to `'3'` for records with a valid item number and blank VAT code. If the item is found and has a non-zero VAT group (`vvkmva`), the code is further refined:
  - `'4'` for VAT group 1 (domestic, standard VAT)
  - `'H'` for other non-zero VAT groups (possibly special/exempt codes)

- **Tracking:**  
  Every update logs the user, date, and time. This is critical for traceability, especially since this is a correction program.

- **File Relationships:**  
  - `fodtlur` is the main transactional file for order/invoice lines.
  - `vvarl1` and `vvasl1` are item master files, used to determine the correct VAT group for an item.

- **Conventions:**  
  - Use of LDA for user tracking is a system-wide convention.
  - Key lists (`klist`) are used for item master lookups.
  - Only records with blank VAT codes are considered—this prevents overwriting any previously set/corrected VAT codes.

---

## Integration Points

- **Upstream:**  
  Assumes order lines have been created by another process, possibly with missing or incorrect VAT codes.

- **Downstream:**  
  Corrected VAT codes will be used by invoicing, reporting, and accounting processes.

---

## Summary Table

| File      | Purpose                  | Usage         |
|-----------|--------------------------|---------------|
| fodtlur   | Order/invoice lines      | Update        |
| vvarl1r   | Primary item master      | Lookup        |
| vvasl1r   | Alternate item master    | Fallback      |

---

## Key Fields

| Field     | Description                       |
|-----------|-----------------------------------|
| fdvare    | Item number (order line)          |
| fdomva    | VAT code (order line)             |
| fdfirm    | Firm number (order line)          |
| vvkmva    | VAT group (item master)           |
| fdeusr    | Last edit user                    |
| fdedat    | Last edit date                    |
| fdetim    | Last edit time                    |

---

## Notable Design Decisions

- **Fallback Lookup:**  
  If the item is not found in the primary item master, the program attempts a lookup in an alternate master. This increases robustness in environments with multiple item repositories.

- **Minimal Updates:**  
  Only lines with blank VAT codes are updated, minimizing the risk of overwriting valid data.

- **No Debug I/O:**  
  The program runs with `*NODEBUGIO` for performance and to avoid unnecessary debug logs in production.

---

## Summary

FX709R is a targeted correction program for order line VAT codes. It cross-references item masters to assign the correct VAT code, updates tracking fields, and is designed for safe, minimal-impact batch correction. This utility is essential for ensuring VAT compliance in downstream processes.