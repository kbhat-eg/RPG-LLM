# RPG Source Code Explanation: FO415R

---

## **Program Purpose**

This program (FO415R) is part of the ASOFAK system. Its main function is to check for and remove order-related records associated with a given order number across several physical files:

- **LWPLPF** — Picking lines (Plukk RT)
- **FODTPF** — Order details (Ordre detaljer)
- **FOTXPF** — Order text (Ordre tekst)
- **FVLSPF** — Length specifications (Lengde spesifikasjoner)

If records exist for a given order number in any of these files, they are deleted.

---

## **File Declarations**

```rpg
flwpllu    uf   e           k disk    rename(lwplpfr:lwpllur)
ffodtlu    uf   e           k disk    rename(fodtpfr:fodtlur)
ffotxlu    uf   e           k disk    rename(fotxpfr:fotxlur)
ffvlslu    uf   e           k disk    rename(fvlspfr:fvlslur)
```
- Each file (LWPL, FODT, FOTX, FVLS) is declared for update (`uf`), external description (`e`), keyed access (`k`), and with record format rename.
- These files store order-related data that may need to be deleted.

---

## **Parameter & Variable Declarations**

- **Parameters:**  
  - `p_firm` (Firm number)
  - `p_numm` (Order number, format based on FDNUMM field)
- **Key Variables:**  
  - Separate variables for the order number in each file's key (e.g., `lwpllu_numm`, `fodtlu_numm`, etc.), so each file can be referenced by its own key fields.
- **Other Variables:**  
  - `w_firm` for the working firm number
  - `w_test` (purpose not shown in code)

---

## **Main Logic**

### **1. Delete Picking Line Records (LWPLPF)**
```rpg
c     lwpllu_key    setll     lwpllu
c     lwpllu_key    reade     lwpllu
c                   dow       not %eof(lwpllu)
c                   delete    lwpllur
c     lwpllu_key    reade     lwpllu
c                   enddo
```
- Position to the start of matching keys (`setll`)
- Read the first matching record (`reade`)
- While not end of file:
    - Delete the record
    - Read the next record with the same key
- Loop ends when all matching records have been deleted.

### **2. Delete Order Detail Records (FODTPF)**
- Same logic as above for the FODT file.

### **3. Delete Order Text Records (FOTXPF)**
- Same logic as above for the FOTX file.

### **4. Delete Length Specification Records (FVLSPF)**
- Same logic as above for the FVLS file.
- This part was added in revision 6.31.

---

## **Ending the Program**

```rpg
c     eval      *inlr = *on
c     return
```
- Sets the last record indicator and exits the program.

---

## **Initialization Subroutine (`*inzsr`)**

- Builds key lists for each file, pairing the firm number (`w_firm`) and order number (`..._numm`) for each file.
    - KLIST/KFLD are used for keyed CHAIN/RETRIEVE operations.

```rpg
c     *inzsr        begsr
...
c     fodtlu_key    klist
c                   kfld    w_firm
c                   kfld    fodtlu_numm
...
c     endsr
```

---

## **Parameter Passing**

```rpg
c     *entry        plist
c                   parm    p_firm
c                   parm    p_numm
```
- Receives firm number and order number as parameters from the calling program.

---

## **Loading Working Variables**

```rpg
c                   eval      w_firm = p_firm
c                   eval      fotxlu_numm = p_numm
c                   eval      fodtlu_numm = p_numm
c                   eval      lwpllu_numm = p_numm
c                   eval      fvlslu_numm = p_numm
```
- Sets up working key fields for use in the key lists and record deletion.

---

## **Historical Comments / Change Log**

- The commented header documents the evolution of the program, including:
    - Expansion for new files (FVLS in 6.31)
    - Changes to order number field size (R6.30 for number extensions)
    - Price group size updates (8.01)

---

## **Summary**

**FO415R** is a utility program for cleaning up records related to a specific order in various order processing files. When given a firm number and an order number, it will systematically delete all related records from picking, detail, text, and length specification files. This helps ensure data integrity when an order is cancelled or purged.

**Key Techniques Used:**
- Keyed file access (`setll`, `reade`)
- Looping through and deleting all records for a given key
- Use of parameter lists and key lists for generalization
- Modular variable setup to handle files with differing key field names

---

**Use Case:**  
This program would typically be called by an order maintenance or cleanup routine, either interactively or in batch, when there is a need to remove all traces of a specific order from related physical files.