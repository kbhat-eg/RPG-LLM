# RPG Program Explanation: VE711R

This program is written in ILE RPG (Report Program Generator) and is designed to retrieve a GTIN/EAN number (European Article Number, also known as GTIN) for a given item number and unit, primarily using data from the `VVEPPF` file. The program is tailored for a specific business system. Below is a detailed walkthrough and explanation for onboarding developers:

---

## Header Section

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **option(*nodebugio)**: Disables debug I/O for better performance.
- **datedit(*dmy)**: Sets the date format for editing (day-month-year).

---

## Program Description and Version History

The comments describe the program’s purpose and notes relevant changes (with dates and author initials).  
- **Input:** company (firma), item number (varenr), unit (enhet)
- **Output:** EAN number (ean.nr), status (1 = OK)
- **Files:** Uses `VVARPF` (item register) and `VVEPPF` (item-unit register)

---

## File Declarations

```rpg
fvvarlr    if   e           k disk    rename(vvarpfr:vvarlrr)
fvveplr    if   e           k disk    rename(vveppfr:vveplrr)
```
- **fvvarlr**: Item register file, externally described, keyed access.
- **fvveplr**: Item-unit register, externally described, keyed access.
- **rename**: Renames external record formats for internal use.

---

## Variable Declarations

Key fields for file access:
```rpg
d vvarlr_firm     s                   like(vvfirm)
d vvarlr_vare     s                   like(vvvare)
d vveplr_pfir     s                   like(vepfir)
d vveplr_pvar     s                   like(vepvar)
d vveplr_penh     s                   like(vepenh)
d vveplr_pldo     s                   like(vepldo)
d vvepl1_pfir     s                   like(vepfir)
d vvepl1_pvar     s                   like(vepvar)
d vvepl1_penh     s                   like(vepenh)
```
Parameters (for program input/output):
```rpg
d p_firm          s                   like(vepfir)
d p_eann          s                   like(vepgti)
d p_vare          s                   like(vepvar)
d p_enhe          s                   like(vepenh)
d p_stat          s              1
```

---

## Main Program Logic

### 1. **Initialize Output Parameters**
```rpg
c                   eval      p_eann = 0
c                   eval      p_stat = *blank
```

### 2. **Check if Item Exists**
Look for the item in `VVARPF` based on company and item number:
```rpg
c                   eval      vvarlr_firm = p_firm
c                   eval      vvarlr_vare = p_vare
c     vvarlr_key    chain     vvarlr
c                   if        not %found(vvarlr)
c                   goto      avslutt
c                   endif
```
- If the item does **not** exist, the program exits (status remains blank).

### 3. **Retrieve EAN from VVEPPF**
Look for item + unit + company in `VVEPPF`:
```rpg
c                   eval      vveplr_pfir = p_firm
c                   eval      vveplr_pvar = p_vare
c                   eval      vveplr_penh = p_enhe
c                   eval      vveplr_pldo = vvldor
c     vveplr_key    chain     vveplr
c                   if        %found(vveplr) and
c                             vepgti <> 0
c                   eval      p_eann = vepgti
c                   eval      p_stat = '1'
c                   goto      avslutt
c                   endif
```
- **If found and GTIN exists**: Output GTIN, set status to '1' (OK), exit program.

### 4. **Fallback: Check for GTIN Regardless of Supplier**
If the above lookup fails, search `VVEPPF` for any matching company, item, and unit (ignoring supplier):
```rpg
c                   eval      vvepl1_pfir = p_firm
c                   eval      vvepl1_pvar = p_vare
c                   eval      vvepl1_penh = p_enhe
c     vvepl1_key    setll     vveplr
c     vvepl1_key    reade     vveplr                                 91
c                   dow       *in91 = *off
c                   if        p_enhe = vepenh and
c                             vepgti <> 0
c                   eval      p_eann = vepgti
c                   eval      p_stat = '1'
c                   goto      avslutt
c                   endif
c     vvepl1_key    reade     vveplr                                 91
c                   enddo
```
- Reads through potential records for the given company, item, and unit, and if a GTIN exists, returns it.

### 5. **Program Exit**
```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- `*inlr = *on` ensures the program closes files and ends properly.

---

## Subroutines

### *INZSR (Initialization Subroutine)
Handles parameter list and key lists at program start.
```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_vare
c                   parm                    p_enhe
c                   parm                    p_eann
c                   parm                    p_stat
```
Key lists for indexed file access:
```rpg
c     vveplr_key    klist
c                   kfld                    vveplr_pfir
c                   kfld                    vveplr_pvar
c                   kfld                    vveplr_penh
c                   kfld                    vveplr_pldo

c     vvepl1_key    klist
c                   kfld                    vvepl1_pfir
c                   kfld                    vvepl1_pvar
c                   kfld                    vvepl1_penh

c     vvarlr_key    klist
c                   kfld                    vvarlr_firm
c                   kfld                    vvarlr_vare
c                   endsr
```

---

## In Summary

- **Purpose:** Fetch the EAN/GTIN for a given item and unit, using the current supplier if possible, but fallback to any GTIN for that item+unit if necessary.
- **Files Read:**
  - `VVARPF`: Checks if the item exists.
  - `VVEPPF`: Gets GTIN for the item+unit (with/without supplier).
- **Return:**
  - `p_eann`: The EAN/GTIN number (or 0 if not found).
  - `p_stat`: Status ('1' if GTIN found, blank otherwise).

---

## Key Points for Developers

- Understand the flow: item existence check → GTIN lookup (supplier first, then any).
- Uses `CHAIN` for direct access, and `READE` for reading multiple records with the same key.
- Uses parameter passing for I/O between programs.
- Modular: could be called from other RPG or CL programs.

---

Let me know if you want to dive deeper into any part of the code or its business logic!