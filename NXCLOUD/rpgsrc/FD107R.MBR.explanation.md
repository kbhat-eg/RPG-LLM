# RPG Program FD106R - Explanation

## Overview

This RPG (ILE) program, named `FD106R`, is from a Norwegian ERP system and handles **quick creation of order lines** ("ordre-linje, hurtigoppretting av varelinje"). The code has a long history with many revisions and comments, reflecting continuous system enhancements.

At its core, the program takes a set of parameters describing an order line (item, quantity, unit, etc.), validates the inputs, retrieves item and price information, calculates totals and discounts, writes the new order line to the database, and updates inventory.

---

## Program Structure

### 1. File Declarations (`F-spec`)

The program interacts with multiple database files, each mapped to a logical file or table:

- **fstsl1 / fstspfr**: Status code register
- **vvarl1 / vvarpfr**: Item master
- **vvenl1 / vvenpfr**: Item unit details
- **fohel1 / fohepfr**: Order header
- **fodtl1 / fodtpfr**: Order line (main)
- **fodtlu / fodtpfr**: Order line (update)
- **vvlel1 / vvlepfr**: (Optional, appears related to wood products)

Each file is defined for keyed input (`IF`) or update (`UF`), with a data structure `rename` to map fields.

---

### 2. Data Definitions (`D-spec`)

#### **Parameters**

- `p_kode`, `p_firm`, `p_numm`, `p_suff`, `p_line`, etc.: Passed to the program as input parameters (company, order, item, etc.).

#### **Local Data Area**
- `l_user`: Extracts the user from the program's user space.

#### **Structures for External Program Calls**

- **Price Calculation Structures**:
  - `hirec` (input) and `horec` (output): For communicating with the price calculation program `VP900R`.
- **Inventory Update Structure**:
  - `hlrec`: For communication with the inventory update program `VL001R`.

#### **Working Variables and Constants**

- `w_firm`, `w_numm`, etc.: Local copies of parameters.
- `lo`/`up`: Lowercase/uppercase conversion strings for Norwegian/Scandinavian characters.

---

### 3. Initialization and Main Logic (`C-spec`)

#### **Program Initialization**

- **Parameter Intake (`*inzsr`)**: Receives CLI parameters (item, quantity, etc.), sets up primary key lists for file access.
- **Setup for Inventory Update**: Sets registration type to blank (`hltype = ' '`).

#### **Validation Logic**

- If the item or quantity is missing (`p_vare = *blank or p_anta = 0`), abort.
- If the unit is not valid for the given item (`chain vvenl1`), abort.
- If the order line already exists (`chain fodtl1`), abort.
- If the item is not found in the item master (`chain vvarl1`), abort.

#### **Order Line Creation**

- **Field Assignment**: Populates the order line fields from parameters and item master fields.
- **Pricing Call**: Calls `VP900R` to fetch prices and discounts.
- **Totals Calculation**:
  - Calculates gross sum (`w_sums`), applies sequential discounts (`forabp`, `fdrab1`, `fdrab2`, `fdbrr1`, `fdbrr2`), and computes net sum.
  - If cost price (`fdkopr`) is zero, it is set as a proportion of the sales price.
- **Writes New Order Line**: Uses the `fodtlur` record format.
- **Inventory Update**: Calls subroutine to update inventory via `VL001R`.

#### **Post-Processing**

- Sets `p_kode = *on` to indicate that at least one line has been recorded.

---

### 4. Subroutines

#### **hent_pris (Fetch Price)**

- Prepares a structure with all relevant information.
- Calls price program `VP900R`.
- Extracts price and discount data from the output structure.

#### **oppdat_lager (Update Inventory)**

- Calls `VL710R` to determine the item type from the warehouse/item tables.
- If item is a stock item (type 'L'), proceeds:
  - Prepares an inventory movement record.
  - Builds a reference string based on order and line numbers.
  - Calls inventory update program `VL001R`.

---

### 5. Key Lists

Key lists (`klist`/`kfld`) are used to simplify record access:

- `fstsl1_key`: For status lookup.
- `vvarl1_key`: For item lookup.
- `vvenl1_key`: For item-unit lookup.
- `fohel1_key`: For order header lookup.
- `fodtl1_key`: For order line lookup.
- `fodtlu_key`: For order line update.

---

## Key Logic Flows

### **Order Line Creation**

1. **Validation**: Checks that all critical values exist and that the order line does not already exist.
2. **Item and Unit Validation**: Ensures the item and its unit are valid.
3. **Retrieval**: Fetches item and price information.
4. **Calculation**: Computes totals and applies multiple discounts in order.
5. **Writing**: Records the new order line and triggers inventory update if applicable.
6. **Finalization**: Updates indicator to signal success; exits program gracefully.

---

## External Calls

- **VP900R**: Pricing and discount calculation.
- **VL001R**: Inventory posting.
- **VL710R**: Gets item type from the warehouse.

---

## Notable Features

- **Sequential Discount Handling**: Applies multiple types of discounts in a controlled sequence.
- **Dynamic Price and Inventory Integration**: Uses external programs to obtain and update real-time pricing and inventory information.
- **Flexible Key Handling**: Uses dynamic key fields to access database files efficiently.
- **Extensive Norwegian Localization**: Handles Scandinavian characters and field naming, designed for Norwegian business processes.

---

## Change History

The header comments document numerous enhancements over two decades, reflecting changes such as field expansions, special handling for project codes, support for lumber assortment, additional pricing fields, and more robust inventory references.

---

## Conclusion

### **In summary:**
This program is a modular, parameter-driven utility for creating and updating order lines in a Norwegian business system. It validates input, fetches item data, handles complex discount schemes, posts the order line, and updates stockâ€”integrating with several external modules for prices and inventory operations. Extensive use of data structures and external calls allows for flexibility and maintainability in a complex ERP environment.