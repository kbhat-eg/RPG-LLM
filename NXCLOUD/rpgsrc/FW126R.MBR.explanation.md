# RPG Program FW126R â€“ Item/Price Update Processing

## Overview

This program (`FW126R`) is a core part of the ASOFAK system, responsible for processing and updating supplier items and their prices. It provides a green-screen subfile interface for viewing, filtering, maintaining, and controlling the transfer status of supplier item records. The program supports advanced positioning/searching, group filtering, and integrates with several other modules for extended item management.

## Business/Domain Context

- **Supplier Items**: The program centers on managing supplier-specific item data, including supplier item numbers, EANs, and NOBB numbers (a common Norwegian building products classification).
- **Price Control**: Users can view, update, and release/hold items for transfer, with logic to calculate price changes and indicate status.
- **Group Management**: Items can be filtered and processed by groupings (main group, sub group, etc.), reflecting business hierarchies.

## File Usage and Relationships

- **flval2/flval3/flval4/flval5**: Logical files over the supplier item register, keyed differently for flexible positioning (by supplier item no, text, EAN, NOBB).
- **vvarl5**: Supplier item master, used for lookups and filtering.
- **rlevl1**: Supplier register, used for displaying supplier names.
- **flvalr/flvalur**: Used for updating and maintaining supplier item records.
- **fw126d**: Display file with subfiles for user interaction.

## Key Program Structure and Flow

### 1. **Initialization (`*inzsr`)**

- Loads parameters (supplier, group, date, price info, etc.).
- Builds all necessary key lists for file access.
- Initializes working variables and display fields.
- Fetches and displays supplier name.
- Sets default subfile position and loads the initial page with `crt_subfile`.
- Calls external program `VL711R` to determine price group.

### 2. **Main Display Loop**

- Alternates between command and subfile display modes.
- Responds to function keys:
  - **F3/F12**: Exit.
  - **F5**: Refresh/reload subfile.
  - **F10**: Page down in subfile.
  - **F13**: Status codes (calls `FW110R`).
  - **F14**: Group management (calls `FW127R`).
  - **F20**: Start transfer (calls `FW128R`).
  - **F23**: Toggle positioning mode (by supplier item no, EAN, NOBB).
- Handles positioning requests using search fields (item text, supplier item, EAN, NOBB).

### 3. **Subfile Processing**

- **Subfile Display/Navigation**: Supports paging, cursor placement, and selection.
- **Row Actions**: For each subfile row, the user can:
  - **2**: Change item (calls `FW112R`, then refreshes row data).
  - **3**: Hold item from transfer.
  - **5**: View item (calls `FW112R` in inquiry mode).
  - **6**: Release item for transfer.
  - **7**: Item maintenance (calls `VV101R`).
  - **8**: Maintain search texts (calls `VS100R`).
  - **9**: (Commented out) EAN maintenance.
- After each action, the subfile row is updated to reflect changes.

### 4. **Subroutines**

- **forny**: Refreshes subfile based on current position/mode.
- **posisjoner**: Locates the starting point in the subfile based on user input (text, supplier item no, EAN, NOBB).
- **subfile**: Loops through visible subfile rows, handling user actions.
- **xc2bld, vedl_vare**: Handles item change and maintenance, updating subfile row data as needed.
- **hold_vare / frigi_vare**: Sets/clears the hold flag on an item for transfer, records user/time info.
- **clr_subfile / crt_subfile**: Clears and (re)builds subfile contents based on filters and positioning.
- **fyll_subfile**: Populates a subfile row with all relevant item data, including price calculations and status codes (calls `VP701R`, `FW113R` for external data).

### 5. **Positioning and Filtering**

- Users can position the subfile using:
  - Item text
  - Supplier item number
  - EAN number
  - NOBB number
- Filtering by group (main, sub, under group) and item number ranges is supported.
- Only items matching the current firm, supplier, and filters are shown.

### 6. **External Program Calls**

- **FW110R**: Status code information.
- **FW112R**: Item detail display/change.
- **FW113R**: Status code lookup.
- **FW127R**: Group management.
- **FW128R**: Start transfer process.
- **VS100R**: Search text maintenance.
- **VL711R**: Price group lookup.
- **VP701R**: Price history lookup.
- **VV101R**: Item master maintenance.

## Notable Design Decisions and Conventions

- **Subfile Paging**: Uses custom logic to manage subfile paging, cursor placement, and page size (see `w_spge`, `w_srrn`, `w_ssrn`).
- **Positioning Modes**: Uses indicators *in80, *in81, *in82 to track current positioning mode (supplier item, EAN, NOBB).
- **Indicator Usage**: Extensively uses RPG indicators for UI state, error handling, and subfile control (see comments at top).
- **Flexible Key Lists**: Multiple logical files and key lists allow for fast positioning and searching on different fields.
- **Audit Trail**: When holding/releasing items, user and timestamp info are recorded for traceability.
- **Modular Integration**: Heavy use of external program calls for price, status, and group logic, enabling reuse and separation of concerns.

## Relationships and Interactions

- **Data Model**: Relies on a normalized supplier/item/price data model, with cross-references for various item identifiers.
- **UI Layer**: All user interaction is via green-screen subfiles, with command and subfile control records.
- **Other Modules**: Acts as a hub for supplier item maintenance, feeding into transfer, price, and group management workflows.

## Special Notes

- **Language/Localization**: Some field names and comments are in Norwegian, reflecting the domain and user base.
- **History and Maintenance**: The code includes detailed change history and has evolved to support additional fields (e.g., price group expansion, tracking info, number range extensions).
- **Extensibility**: The program is designed to be extended with new maintenance actions (see commented-out code for EAN maintenance).

---

**In summary:**  
FW126R is the main workbench for supplier item and price maintenance in ASOFAK, supporting advanced searching, filtering, and workflow integration with price, group, and transfer modules. It uses subfiles for user interaction, modularizes business logic via external calls, and maintains a strong focus on traceability and flexible data access.