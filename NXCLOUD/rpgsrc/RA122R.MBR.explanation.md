```markdown
# RA121R (Speditører Vedlikehold) – Program Overview

## 1. Header & Metadata
- `H OPTION(*NODEBUGIO) DATEDIT(*DMY)`  
  ­ Disables debug I/O, uses DD/MM/YYYY date format.  
- Comments provide system/program names, version history, and change log.

## 2. File Declarations & Data Areas
- **Database Files**  
  - `RA22PFR` keyed files renamed to `RA22L1R, L2R, LRR, LUR` for lookups and updates.  
  - `B1SFL` work station file mapped to subfile record format `W_SRRN`.
- **Local Data Area (LDA)**  
  - Fields extracted from LDA: user ID (`l_user`), firm number (`l_firm`), user name (`l_fnav`).
- **Key Variables**  
  - `ra22l1_vkod`, `ra22l2_vtxt`, `ra22lr_vkod`, `ra22lu_vkod` mirror record keys for reads/updates.
- **Working Variables**  
  - Subfile controls:  
    - `w_stel` (current subfile row),  
    - `w_spge` (page size),  
    - `w_srrn` (relative record no.),  
    - `w_sfrn`/`w_ssrn` (first/last on page),  
    - `w_virn` (row to position cursor on).  
  - Control flags: `b_oppr` (creating), `b_forn` (refresh), `b_anul` (allow cancel), `b_feil` (error).
  - Temporary fields: `w_firm` (firm no), `s_vkod` (saved code).
- **Constants**  
  - `c_sfil = 14` defines subfile page length.

## 3. Indicator Usage
- LR = program end  
- 10/11 = page‐up/down subfile  
- 12–15 = subfile format controls  
- 21("Home"), 22(cursor pos)  
- 31–79 = error messaging  
- 80–99 = processing indicators  

## 4. Main Processing Flow (B2CTL Screen)
1. **Initialization**  
   - `*INZSR` sets `w_firm` from LDA, positions file to first record, calls `crt_subfile`.
2. **Display & Command**  
   - `B2CMD` format written, then `dsp_subfile` displays the subfile (`B1SFL` inside `B2CTL`).
3. **Function-Key Handling**  
   - F3 (Exit) → `avslutt` sets `*INLR = *ON` returns.  
   - F5 (Refresh) → subroutine `forny`.  
   - F6 (Create) → `xc1bld` (C1BLD screen), loop back.  
   - F10/F11 (Page up/down) → `crt_subfile`/`bck_subfile`.  
   - Home (F21) → set indicator 22, redisplay.  
4. **Positioning**  
   - If user entered a code or text in the position fields (`b2vkod`, `b2vtxt`), `posisjoner` resets and fills subfile accordingly.
5. **Subfile Processing**  
   - `subfile` subroutine loops through displayed rows, handles row‐level actions: Edit (2), Copy (3), Delete (4), Display (5), calling respective windows.
6. **Loop** back to display until exit.

## 5. Key Subroutines

### 5.1 forny (Refresh Subfile)
- If not first page, chain to current row in `B1SFL`.  
- Uses current sequence (`w_seqe`) to choose key (code/text).  
- Clears current subfile (`clr_subfile`), rebuilds page (`crt_subfile`).

### 5.2 posisjoner (Position by Key/Text)
- If a key or description is entered, chains to that record.  
- Clears and rebuilds subfile at the found position.  
- Resets position entry fields.

### 5.3 subfile (Process User Actions on Rows)
- Toggles indicator 22 for cursor presence.  
- On each displayed row (`DO w_ssrn` / `READC B1SFL`):  
  - Based on `b1valg` value:
    - 2 = Edit → calls `xc2bld` (C2BLD).  
    - 3 = Copy → calls `xk1win`.  
    - 4 = Delete → calls `xd1win`.  
    - 5 = Display → calls `xc2bld` in display mode.  
  - Updates subfile record to clear selection.  
- If any copy/create occurred, sets `b_forn` to refresh subfile.

### 5.4 xc1bld (Create New Record – C1BLD)
- Displays entry screen for new code.  
- On Enter, validates non‐zero code, checks for existing record (`ra22lr_key / CHAIN`).  
- If exists, calls `xc1msg` to warn; else calls `xc2bld` to do actual maintenance.

### 5.5 xc1msg (Duplicate Creation Warning)
- Shows message screen (C1MSG).  
- If user cancels, returns to C1BLD.

### 5.6 xc2bld (Maintain Record – Create/Edit/Display – C2BLD)
- Preloads existing values if record found.  
- In Copy or Display mode, sets indicators accordingly.  
- Displays C2BLD format, validates description field.  
- Updates or writes new record in `RA22LUR`.  
- Updates the subfile buffer if editing existing row or marking for refresh if copy/create.

### 5.7 xd1win (Delete Window – D1WIN)
- Chains to record, displays D1WIN confirmation, deletes record, marks for subfile refresh.

### 5.8 xk1win (Copy Window – K1WIN)
- Chains to source record, displays K1WIN to input new code.  
- Validates code, ensures no duplicate, then calls `xc2bld` to build copied record.

### 5.9 clr_subfile (Clear Subfile)
- Sets indicator 14 to clear display, writes control record `B2CTL`, resets counters.

### 5.10 crt_subfile (Populate Subfile)
- Increments page end marker (`w_spge`), reads sequential records (by code or text),  
  writes up to `c_sfil` (14) rows into `B1SFL`.  
- Stops on EOF or firm mismatch.

### 5.11 bck_subfile (Page Back)
- Positions file to just above current page, reads backward then clears & re‐builds with `clr_subfile`/`crt_subfile`.

### 5.12 dsp_subfile (Display Subfile)
- Controls indicators 12/13, issues `EXFMT B2CTL` to show subfile with command line.

## 6. Initialization (`*INZSR`)
- Defines key lists (`RA22L1_KEY`, `RA22L2_KEY`, `RA22LR_KEY`, `RA22LU_KEY`).  
- Loads `w_firm` from LDA, sets indicator 22, positions to first record code=0, builds initial subfile.

---
This structure supports typical 5250 subfile maintenance with Create/Edit/Copy/Delete/Display functions for “Speditører” (freight forwarders) keyed by code or description.