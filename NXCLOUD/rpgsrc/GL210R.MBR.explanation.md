# GL320R Program Documentation

## Overview

This program, **GL320R**, is part of the ASTELE system. Its primary responsibility is to fetch and validate file names for transactions to/from the bank, focusing on controlling whether a TF2 (bank file) has already been received and processed. The logic ensures that duplicate processing is avoided and provides user feedback or warnings in such cases.

The program interacts with several physical files and data structures, and contains business logic specific to payment file handling, especially for different BETFOR (payment format) types, including domestic and international payments.

## Key Business Logic

- **Duplicate Control for TF2 Files:**  
  The main function is to verify if a TF2 file (payment return file) has already been received for a given transaction. If so, the user is warned, and the duplicate is not processed automatically; instead, manual intervention may be required.
- **Special Handling by Payment Format:**  
  The logic is tailored for different BETFOR types (e.g., BETFOR01, BETFOR04, BETFOR21, BETFOR23), each requiring a specific number of record reads and additional checks.
- **International Payment Detection:**  
  Special logic is triggered if BETFOR04 (international payments) is detected, influencing both processing flow and user feedback.

## File Dependencies

- **GL210D** (WORKSTN): Workstation file for user interaction.
- **GUBFLU**: Keyed disk file, likely containing batch/payment control information.
- **GATRLU**: Keyed disk file, the main transaction log or lookup table for payment records.

## Data Structures

- **LDA**: Local Data Area, used for session or job-specific context.
- **Overlay Structures:**  
  - `d_00a`, `d_00b`: Used to map and extract specific fields from GATRLU records, with overlays for payment format, batch number, line number, vendor info, and amounts.
  - Business fields are overlaid at specific positions, reflecting the fixed-format nature of the underlying data.

## Indicators and Conventions

- **Indicators:**
  - `*IN33`: Used to denote international payments (BETFOR04).
  - `*INLR`: End-of-program indicator.
- **Key Lists:**
  - `key01`: Used for accessing GATRLU, built from giro number, løpenummer (serial number), and type.
  - `key02`: Used for accessing GUBFLU, built from firm number, batch number, and line number.

## Main Processing Flow

1. **Initialization:**
   - Parameters are passed in via a PLIST, populating key variables for further processing.
   - LDA is loaded for session context.
   - Key lists are built for file access.

2. **GATRLU Record Processing:**
   - Sequentially reads records from GATRLU using `key01`.
   - For each record, overlays are used to extract relevant fields.

3. **Payment Format Handling:**
   - **BETFOR21:** Reads an additional record to fetch vendor number and name.
   - **BETFOR01:** Reads an additional record to fetch vendor number; vendor name is blanked.
   - **BETFOR23/BETFOR04:** Reads additional records for proposal and line numbers, and checks for previous TF2 processing. If not found, a warning is issued.
   - **BETFOR04:** Sets `*IN33` to indicate international payment, alters further processing.

4. **Amount Handling:**
   - If the transaction is a credit (`d_belk = 'K'`), the amount is negated.

5. **International Payment Branch:**
   - If `*IN33` is set, additional reads and field moves are performed to handle the specifics of international transactions.

6. **Duplicate Check in GUBFLU:**
   - Attempts to chain into GUBFLU using `key02`.
   - If not found (indicating a duplicate or missing batch), a warning window is displayed to the user with transaction details.
   - Sets `wxfeil` to 'F' to indicate an error state.

7. **Loop Continuation:**
   - Continues reading GATRLU records until EOF.

8. **Program Termination:**
   - Sets `*INLR` to end the program.

## Subroutine: Initialization (`*INZSR`)

- Loads parameters from the PLIST.
- Loads the LDA.
- Builds key lists for GATRLU and GUBFLU access.

## User Feedback

- If a duplicate or problematic condition is detected, a window (`e1win`) is displayed to the user, populated with contextual information (giro, løpenummer, batch, line, vendor, amount).
- The user is expected to resolve certain issues manually (e.g., duplicate returns), especially after the 2012 change where the batch is not rejected outright.

## Business/Domain-Specific Notes

- **BETFORxx Codes:** These represent different file formats or transaction types used in the payment system. Each type has unique data layout and business rules.
- **Manual Correction:** From 2012, the system no longer rejects entire batches for duplicate returns; users must correct such issues via a separate adjustment ("Jusering") process.
- **International (UTLAND) Handling:** Detected via BETFOR04 and indicator *IN33, with custom error messaging and processing logic.

## Notable Design Decisions

- **Overlay Usage:** Heavy use of overlays for field extraction reflects a need to parse variable-format records from GATRLU efficiently.
- **Indicator-Driven Flow:** The program uses classic RPG indicators to control flow, especially for distinguishing domestic/international and error conditions.
- **Non-Sequential Record Access:** The logic for BETFORxx types requires non-linear reading of records to assemble all relevant transaction data.
- **User Interaction:** Error conditions result in interactive windows rather than hard stops, aligning with the business process of allowing manual intervention.

## Module Interactions

- **GATRLU**: Central transaction lookup, provides all core payment and batch data.
- **GUBFLU**: Used to verify batch status and detect duplicates.
- **LDA**: May be used for user/session context, but specifics depend on the broader system.
- **Screen Formats (e1win)**: Used for error/warning display.

---

**In summary:**  
GL320R is a specialized control program that validates incoming payment files, handling domestic and international payments differently, and provides user feedback for duplicate or problematic transactions, leveraging overlays and indicators for efficient file processing. The business rules are tightly coupled to the payment file formats and the operational procedures for batch handling and error resolution.