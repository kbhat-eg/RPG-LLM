```markdown
# RPG Program `VV951R` Overview & Walkthrough

This IBM ILE RPG program is used to create an item "query file" (`VVAQPF`) containing information about products/items (varer), including their latest EAN number, discount group, unit information, and the latest price/offered price per unit and delivery type. The program pulls data from several master and related files and builds a consolidated file for query/reporting purposes.

The program is heavily commented in Norwegian, but the logic is straightforward and typical for RPG batch utilities.

---

## 1. **High-Level Operation**

- **Main Purpose:**  
  Build a consolidated item query file (`VVAQPF`) for quick reporting/querying, including various reference and descriptive fields from master files, plus prices and EAN codes.

- **Invoked by:**  
  The program is called from another program (`VV951C`) which first empties the `VVAQPF` file, then this program repopulates it.

- **Key Activities:**  
  - For each item, collect base item data and supporting group/description info.
  - For each unit of measure for an item, determine price(s) and calculate offer price(s).
  - For each combination, retrieve and store the latest EAN code.
  - Write that consolidated data into the query file.

---

## 2. **File Declarations**

- **Input Files:**
    - Various master and lookup files for items (`vvarl1`), EANs, units, prices, group codes, VAT, suppliers, etc.
    - Files are renamed on input (e.g., `vvarpfr:vvarl1r`) to use record format names matching the program's expectations.

- **Output File:**
    - `vvaqpf` (the consolidated query file).

---

## 3. **Key Variables**

- **From LDA:**  
  - `l_firm`, `l_lage`: Firm and warehouse values fetched from the Local Data Area.

- **Key Work Fields:**  
  - Variables to build keys for chaining (lookups) into the different files.
  - Flags: e.g., `b_oppr` (has the item been output), `b_vopr` (has the item/unit/price combination been output this pass).
  - Price work fields: `w_mvap`, `w_mvat`, etc.

- **Major Record-Level Fields:**  
  - For each file, there are "like()" variables to hold key fields or values needed for lookups.

---

## 4. **Main Logic Flow**

### a) **Initialization**

- The *INZSR subroutine* initializes key lists for all files, fetches the company (`w_firm`) and warehouse (`w_lage`) from the LDA, and calls external programs to retrieve VAT rates and price group.

---

### b) **Main Processing Loop**

1. **Read item master table (`vvarl1`):**
    - Position to first item, then loop until EOF.

2. **For each item:**
    - Reset flags (`b_oppr`).
    - Collect supporting group/description info by chaining into group and supplier files.
    - Find the account reference using a fallback chain (under group → main group → over group → item default).
    - Get default supplier for item/warehouse by a program call.
    - Loop through every **unit of measure** for this item (`vvenl1`).

3. **For each unit:**  
    - Reset flags (`b_vopr`).
    - Try to retrieve and process price information via the `pr_prgr` subroutine:
        - Try in order:
          - Price for the supplier found above.
          - Price for the item’s default supplier.
          - Price for `ldor = 0` (catch-all).
        - For each, handle per price group ("prisgruppe").
    - After processing units, fetch the latest EAN for the item/unit/warehouse.
    - **If not already output, write to the consolidated file.**
    - Clear work fields, read the next item.

---

### c) **Subroutines**

#### **pr_prgr (Per Price Group)**

- For a given combination, process prices:
    - Once for blank price group (default), and once for a filled-in group (if available).
    - Calls `behandling` for each.

#### **behandling (Unit-Level Processing)**

- For each unit, loops through price file for that item/unit/price group/supplier:
    - Marks flags for output.
    - Calculates price with VAT (`vpsaim = vpsapr * w_mvat`), limiting value to 9,999,999.99.
    - If there’s a price, calls an external program (`FA909R`).
    - Calculates "discount percentage" (`vpdekn`) for reports.
    - Clears out offer/campaign price fields to defaults.
    - Looks for a matching offer/discount in the `vtill1` file, updating offer fields if found.
    - If found, applies VAT to offer price, and (if nonzero) calls `FA909R`.
    - Gets the latest EAN for the combination by another program call (`VE713R`).
    - Writes the consolidated record to `VVAQPF`.
    - Proceeds to next unit/price.

---

#### **Key List Definitions**

- At the end of the code, *key lists* are defined for each file, matching the RPG `SETLL/READE/CHAIN` operations.

---

## 5. **Interaction with Other Programs**

- **Program Calls:**
    - `VE713R`: Fetches latest EAN for combination.
    - `FA909R`: Possibly updates something or validates price (unknown without source).
    - `VL711R`, `VL721R`: Fetch price group and supplier.
    - `FØ705R` (probably `FO705R`): Fetches VAT factors.

---

## 6. **Notable Logic Features**

- **Fallbacks:**  
  The program tries multiple fallback keys for prices and groupings to maximize the chance of finding valid data.

- **Data Lineage:**  
  Every output line in `VVAQPF` is the result of a dense cascade of lookups, calculations, and (sometimes) external program calls.

- **Field Resets:**  
  Before writing output and between major loops, all key and work fields are cleared out to avoid contamination between records.

- **Norwegian Comments:**  
  The inline comments are mostly Norwegian (but readable to Scandinavian speakers).

- **Date Handling:**  
  Uses *ISO* date format universally.

- **Versioning:**  
  The header includes a clear change log ("Endringsbeskrivelse"). Some code is commented out at various version increments.

---

## 7. **Summary Table of Major Files/Records**

| Name      | Type       | Purpose                            |
|-----------|------------|------------------------------------|
| VVARL1    | Input      | Item master                        |
| VEANL2    | Input      | EAN numbers                        |
| VVENL1    | Input      | Item/unit relationships            |
| VVPRL1    | Input      | Price register                     |
| VTILL1    | Input      | Offer/campaign prices              |
| VVAQPF    | Output     | Query file to be built             |
| ...       | ...        | Various group and supplier files   |

---

## 8. **Onboarding Notes**

- **This is a batch/master data utility.**  
  No user interface: it is called (probably nightly) to refresh a "query cache" file.
- **Adding new fields**: 
    - If you expand item info, you must update key lists and the output file, and possibly add new chain operations.
- **Debugging**:  
  The program can be debugged by checking which flags are set and which records are output (look for flags like `b_oppr` and `b_vopr`). Most calculations are straightforward, but you should study the external programs if pricing logic seems odd.
- **Language:**  
  Many comments are Norwegian, so be prepared for that while working with the code.

---

## 9. **Typical Control Flow Diagram**

```plaintext
for each item in VVARL1:
    fetch group, description, supplier info
    for each unit in VVENL1:
        for each fallback combo of supplier/price group:
            fetch price, offer price, calculate VAT
            fetch latest EAN
            write to output file
```

---

## 10. **Summary**

This program is a central batch job for maintaining an efficient, denormalized item/pricing file for reporting. Its main tasks are to gather, cleanse, and calculate item/unit/price data from various, possibly loosely normalized source tables and programs, and output them in a ready-to-query register.
```
