# RPG Program Explanation: BU920R

This program, named **BU920R**, is part of the IBM i (AS/400) shop system (`ASSHOP`). Its purpose is to retrieve the calculated price and discount for an item for a given customer in a store ("butikk, henter kalkulert pris og rabatt"). The code is written in traditional (fixed-format) ILE RPG.

## High-Level Process

1. **Receives a set of input parameters (customer, item, etc.)**
2. **Initializes and fetches supplementary data by calling subprograms**
3. **Fills a data structure for price calculation**
4. **Calls external program `VP900R` to calculate price & discount**
5. **Returns the result back to the caller via output parameters**

---

## Key Code Sections

### 1. **Header and Maintenance Comments**

- Contains program info, version history, authors/contributors, and brief descriptions of enhancements or fixes.

---

### 2. **Parameter Definitions**

Defines all the parameters the program expects on entry. These variables represent firm, customer, item, warehouse, etc.

Example:
```rpg
d p_firm          s              3
d p_kund          s              6  0
d p_kpro          s              6  0
d p_vare          s             15
... etc.
```
- **Input parameters:** Info such as firm, customer number, item code, warehouse, etc.
- **Output parameters:** Calculated prices, discounts, campaign, etc.

---

### 3. **Data Structures (`DS`)**

The program uses two main data structures: one for input to `VP900R` (`hirec`) and one for output from `VP900R` (`horec`). These are overlays on character fields, mapping various subfields to specific offsets.

#### *Input Data Structure (hirec)*

```rpg
d                 ds
d hirec                        120
d  hifirm                        3  0 overlay(hirec)
d  hirkat                        3  0 overlay(hirec:4)
d  hikund                        6  0 overlay(hirec:7)
...
```
- `hirec` is a 120-byte field with various overlays such as `hifirm` (firm), `hikund` (customer), `hivare` (item), etc.
- These map parameter values to the positions expected by `VP900R`.

#### *Output Data Structure (horec)*

Similar to above, maps fields to returned result positions.

---

### 4. **Working Variables**

Variables such as `w_firm`, `w_prgr`, `w_ldor` are used to hold intermediate values, e.g., price group, prioritized supplier, etc.

---

### 5. **Main Line Code**

#### **Parameter Preparation**

Assigns input variables to the appropriate data structure fields to prepare for the price calculation call.

```rpg
c                   eval      hifirm = w_firm
c                   eval      hirkat = 0
c                   eval      hikund = p_kund
c                   eval      hikpro = p_kpro
...
```
- Values for fields in `hirec` are set from the parameters and working variables.

#### **Timestamping**

Sets the date and time for the calculation (used for time-sensitive price logic).

```rpg
c                   time                    hidato
c                   time                    hitime
```

#### **Call to Price Calculation Program (`VP900R`)**

```rpg
c                   call      'VP900R'
c                   parm                    hirec
c                   parm                    horec
```
- Sends the input structure, receives results in the output structure.

#### **Output Mapping**

Maps results from `horec` back to output parameters to be returned to the caller.

```rpg
c                   eval      p_olet = holety
c                   eval      p_kpri = hokpri
...
```

#### **End / Clean-up**

```rpg
c                   eval      *inlr = *on
c                   return
```
- Ensures program closes properly after completion (`*inlr` is RPG's "last record" indicator).

---

### 6. **Initialization Subroutine (`*inzsr`)**

This subroutine runs at program startup and initializes parameters and supplementary data.

#### **Parameter List**

```rpg
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_kund
...
```
- Lists all parameters provided to the program when called by another program or from CL.

#### **Special Data Fetches**

##### a) **Get Price Group (calls `VL712R`)**
```rpg
c                   call      'VL712R   '
c                   parm                    w_firm
c                   parm                    p_lagr
c                   parm                    p_avde
c                   parm                    w_prgr
```
- Retrieves the price group for the current context (store/department).

##### b) **Get Item Type & Supplier Info (calls `VL710R`)**
```rpg
c                   call      'VL710R'
c                   parm                    w_firm
c                   parm                    p_vare
c                   parm                    p_lagr
c                   parm                    w_vtyp
... etc.
```
- Retrieves the item type and prioritized supplier, which can influence pricing logic.

---

## Data Flow Summary

1. **Initialization (`*inzsr`)**: Receives extensive parameter list, calls subprograms to get price group and item type.
2. **Main Logic**:
   - Fills input DS for price calculation.
   - Calls `VP900R` to get calculated price and discounts.
   - Outputs results through parameters.
3. **Exit**: Returns to caller.

---

## Use Cases

- This program is likely invoked by other applications or scripts that need to fetch the calculated price and applicable discounts for a customer-item-warehouse combination, perhaps for POS systems, order entry, or pricing inquiries.

---

## Extensibility

The code contains several version notes showing enhancements over many years. New parameters (e.g., price group, customer club, prioritized supplier) have been added as needs evolved.

---

## Key Takeaways

- **Parameter-driven**: All context is provided via parameters, making it reusable and modular.
- **Structure Mapping**: Uses overlays for efficient packing/unpacking for program calls.
- **Inter-program Calls**: Leverages existing logic in VL712R, VL710R, VP900R.
- **Output mapping**: Clean extraction of all result values back into output parameters.

---

## Onboarding Hints

- **Understand the data structures**: Know how fields are packed/unpacked in `hirec` and `horec`.
- **Become familiar with called programs** (`VL712R`, `VL710R`, `VP900R`): These encapsulate important business logic.
- **Parameter order is critical**: Both for internal subroutines and for external calls.
- **Watch for ongoing extensions**: This program is frequently enhanced to accommodate new pricing features.

---

For further development, always check interface definitions for called programs and make sure parameter overlays are up to date with any changes in those interfaces.