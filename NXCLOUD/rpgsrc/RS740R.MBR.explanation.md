# RPG Source Code Explanation: RS740R - Kontroll av gyldig konto ("Validation of Valid Account")

This RPG (Report Program Generator) program is written for the IBM i platform (AS/400 / iSeries) and is concerned with validating account information (kontonummer), checking its existence and status in the database, and providing appropriate messages (text).

---

## 1. Program Overview

- **Program Name:** RS740R
- **Main Function/Purpose:** To check/validate if a given account (konto), specification (spesifikasjon), and department (avdeling) combination is valid. It also verifies that the department and specification are properly entered with the account and checks for account blocking.
- **Language:** RPG/400 (ILE), fixed format.
- **Files Used:** 
  - `rhovl1` (Kontoplan - chart of accounts)
  - `ra07l1` (Koderegister - code register, for departments)
- **Field Naming:** Prefixes like `rh` (relates to kontoplan), `ra` (koderegister).

---

## 2. File Declarations

```rpg
frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
fra07l1    if   e           k disk    rename(ra07pfr:ra07l1r)
```
- Two files are used, each renamed for local record formats. Both are accessed by keyed access.

---

## 3. Data Definitions

- Several standalone fields (`s`) are declared for parameters and working storage, all based on fields from the database files for type safety.

```rpg
d p_stat          s              1
d p_firm          s                   like(rhfirm)
d p_kont          s                   like(rhkont)
d p_spes          s                   like(rhspes)
d p_avde          s                   like(rhavde)
d p_text          s                   like(rhtext)
...
d ra07l1_gkod     s                   like(ragkod)
d rhovl1_kont     s                   like(rhkont)
d rhovl1_avde     s                   like(rhavde)
d rhovl1_spes     s                   like(rhspes)
```

---

## 4. Initialization - `*INZSR` Subroutine

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    p_stat
S500 c***           parm                    p_firm
c                   parm                    p_kont
c                   parm                    p_spes
c                   parm                    p_avde
c                   parm                    p_text
...
c                   eval      w_firm = l_firm
c                   eval      p_stat = *blank
c                   eval      p_text = *blank
...
c     ra07l1_key    klist
c                   kfld                    w_firm
c                   kfld                    ra07l1_gkod
...
c     rhovl1_key    klist
c                   kfld                    w_firm
c                   kfld                    rhovl1_kont
c                   kfld                    rhovl1_spes
c                   kfld                    rhovl1_avde
...
c                   endsr
```
- **Parameter list for calling program:** takes status (`p_stat`), account, specification, department, and message text. The firm parameter is commented out.
- **Key lists:** Prepare for chained access into data files.

---

## 5. Main Logic

### Department Validation

```rpg
c                   if        p_avde <> *zero
c                   move      p_avde        ra07l1_gkod
c     ra07l1_key    chain     ra07l1                             61
c                   if        *in61 = *on
c                   move      'A'           p_stat
c                   eval      p_text = 'Avdeling ikke i koderegisteret'
c                   endif
c                   endif
```

- If a department is specified (`p_avde` not zero), it must exist in the koderegister (`ra07l1`). 
- If not found (indicator 61 is on), status is set to 'A' and a message is returned.

---

### Consistency Checks

**If only department is specified but no account:**
```rpg
c                   if        p_avde <> *zero and
c                             p_kont = *zero
c                   move      'M'           p_stat
c                   eval      p_text = 'Bare avdeling utfylt'
c                   goto      slutt
c                   endif
```
- Not allowed to specify a department without an account.

**If only specification is specified but no account:**
```rpg
c                   if        p_spes <> *zero and
c                             p_kont = *zero
c                   move      'K'           p_stat
c                   eval      p_text = 'Bare spesifikasjon utfylt'
c                   goto      slutt
c                   endif
```
- Not allowed to specify a specification without an account.

---

### Account Lookup - Hierarchical Search

- **Account + Specification + Department**
- **Account + Specification (department zeroed)**
- **Account only (specification and department zeroed)**

```rpg
c                   eval      rhovl1_kont = p_kont
c                   eval      rhovl1_spes = p_spes
c                   eval      rhovl1_avde = p_avde
c     rhovl1_key    chain     rhovl1r                            60

c                   if        *in60 = *on
c                   eval      rhovl1_avde = *zeros
c     rhovl1_key    chain     rhovl1r                            60
c                   endif

c                   if        *in60 = *on
c                   eval      rhovl1_spes = *zeros
c     rhovl1_key    chain     rhovl1r                            60
c                   endif

c                   if        *in60 = *on
c                   move      'N'           p_stat
c                   eval      p_text = 'Kontonummer er ugyldig'
c                   goto      slutt
c                   endif
```

- Tries to find the most specific match (account+spec+dept).
- If not found, tries without department.
- If still not found, tries account only.
- If still not found, sets status 'N' (not found) and message.

---

### Account Blocked Check

```rpg
c                   if        rhsprk = 'J'
c                   move      'S'           p_stat
c                   eval      p_text = 'Konto er sperret'
c                   goto      slutt
c                   endif
```
- If the account is found but flagged as blocked (`rhsprk` = 'J'), set status 'S' and message.

---

### Return Text

- If no error/stop reason so far, return the text description from the account (`rhtext`).

---

## 6. End-of-Program Logic

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- Marks end of program with tag `slutt`, sets LR indicator (end of program), and returns.

---

## 7. Status Codes

- `'A'` : Department not found in code register
- `'M'` : Only department entered, no account
- `'K'` : Only specification entered, no account
- `'N'` : Account number invalid (not found)
- `'S'` : Account is blocked
- blank : Account is valid

---

## 8. Indicators

- `*IN60/61` : File access result indicators for chain (record not found = on)
    - 60: kontoplan
    - 61: koderegister

---

## 9. Comments & Documentation

- The header block documents the program, its history, and usage of indicators and status codes.
- Norwegian is used extensively in comments and messages.

---

## 10. Summary

In practice, this program is used as a subroutine or called by another process to verify that a combination of account, specification, and department is valid, and to return a status code and a message explaining any failures. The hierarchical key check ensures flexibility for users entering less-specific information, and the program also enforces logical completeness in data entry (e.g., cannot specify a department or specification without an account).

---

### **Key Takeaways for New Developers**

- The program employs classic RPG fixed format with multiple file chains and careful status checking.
- File error indicators (`*IN60`, `*IN61`) drive the main validation logic.
- Key lists (`klist`) streamline chained access to files with composite keys.
- All result and error feedback is managed via status code (`p_stat`) and message (`p_text`).
- The business logic is tailored for Norwegian accounting and organizational concepts (kontoplan, koderegister, avdeling). 

**If you are modifying or extending:**  
- Any new rules should integrate into the hierarchical search and status/message paradigm.
- All new status codes/messages should be documented in the header block.