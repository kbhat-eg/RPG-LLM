```markdown
# RPG Program RA128R - Maintenance of Cost Carriers

This RPG/400 (ILE RPG) program is a maintenance application for "kostnadsbærere" (cost carriers, or cost centers). It uses display files, subfiles, and various database files to allow the user to maintain a list of cost carriers and their associated attributes.

## Overview

- **Program Name**: RA128R
- **Purpose**: Maintenance of cost carriers (add, display, change, copy, delete)
- **Files Used**:
  - Multiple logical and update files (`ra28pfr`) with various record formats (`ra28l1r`, `ra28l2r`, `ra28lrr`, `ra28lur`)
  - Workstation (display) file (`fra128d`) using a subfile (`b1sfl`)
- **User Interface**: Uses subfiles for list display and record manipulation; supports typical function keys (F3, F12, etc.)

## Key Concepts/Terminology

- **Subfile**: Used to display and scroll through a list of records on the display.
- **Indicators**: Control display options, function keys, and errors.
- **DDS Screens**: Includes several defined for various actions (B1SFL, B2CTL, C1BLD, etc.)
- **Main Operations Supported**: Add, change, copy, delete, display; navigation via function keys.

---

## Structural Breakdown

### 1. File Declarations

- **Database Files** (`if`, `uf` specs): Read with keys, update, and renamed record formats for clarity.
- **Workstation File** (`cf` spec): Handles the interactive display, including subfiles (`sfile(b1sfl:w_srrn)`).

### 2. Data Definitions

- **Local Data Area (LDA)**: Used to store user, company, and program info extracted from LDA.
- **Key and Working Variables**: Handles cost carrier codes, descriptions, subfile counters, page sizes, etc.
- **Constants**: Define subfile page size and indicator usage.

### 3. Indicator Usage

- Well-documented mapping of indicators to their purposes (e.g., *IN10: Rollup, *IN11: Rolldown, etc.)

### 4. Main Processing Loop

#### Display File Control Flow

- The program uses a loop structure based on display file input/output (WRITE, EXFMT).
- It shows command screens, lists (subfiles), and reacts to function key usage.
- Each key (F3/Exit, F12/Cancel, F5/Refresh, F6/Create, F10/Page Down, F11/Page Up, F21/Home, etc.) invokes subroutines.

#### Main Subroutines

- **dsp_subfile**: Handles display of subfile list.
- **forny**: Refreshes subfile and repositions pointer if necessary.
- **posisjoner**: Handles positioning (search) logic, either by code or description.
- **subfile**: Iterates through subfile records for user actions: change, copy, delete, display.
- **xc1bld**: Handles the creation screen for new cost carrier.
- **xc1msg**: Shows a message if user tries to create an already existing carrier.
- **xc2bld**: Handles view/change/create of cost carrier details; validates input and updates database.
- **xd1win**: Handles delete window—confirms and deletes selected cost carrier.
- **xk1win**: Handles copy window—checks for conflicts and calls create/change subroutines.
- **clr_subfile**: Clears out the subfile and associated working variables.
- **crt_subfile**: Fills subfile with records from the database, based on positioning.
- **bck_subfile**: Scrolls subfile “backwards,” i.e., up a page.
- **dsp_subfile**: Formats and displays subfile (list) or commands.

### 5. Initialization

- In the *INZSR (initialization subroutine), keys are set up for various record types.
- Program fetches company id (`firm`) from LDA, sets indicators, positions to start of cost carriers, and loads the initial subfile page.

---

## Key Subfile Mechanics

**Subfile variables explained:**
- `w_stel`: Subfile counter
- `w_spge`: Subfile page size (number of rows per page)
- `w_srrn`: Subfile relative record number
- `w_sfrn`: First record in subfile page
- `w_ssrn`: Last record in subfile page

**Subfile Paging:**
- `crt_subfile` fills the subfile with up to `c_sfil` records per page.
- Paging forward (F10) and backward (F11) handled by `crt_subfile` and `bck_subfile`.
- Positioning in the list (search) uses entered code or description and resets the subfile.

---

## Functional Details

### Add (Create)
- User presses F6 (in screen logic), enters a new cost carrier code.
- If carrier exists, message shown (`xc1msg`).
- If OK, record is created (`xc2bld`).

### Change / Display / Copy
- The option is selected from the subfile list (see `b1valg` values: 2=Change, 3=Copy, 5=Display).
- Relevant logic is called: `xc2bld` for change/display; `xk1win` for copy.

### Delete
- The option is selected (b1valg=4) and handled via `xd1win`, confirming and performing delete.

### Search/Position
- User can enter cost carrier code or description to position to the corresponding place in the list.

### External Calls
- **RA527R**: Lookup for cost carrier group (`rebgrp`).
- **RS727R**: Validation of cost carrier group.

---

## Validation and Error Handling

- Required fields are validated after EXFMTs (e.g., description cannot be blank).
- If invalid, error indicators set (e.g., *IN31), focus returns to field.
- Validation for cost carrier group involves external program call; error shown if group is not found.

---

## Indicators (Common Usage)

- **LR**: End of program.
- **10, 11**: Paging.
- **12–15**: Subfile display/clear/end.
- **21–22**: Cursor placement.
- **30**: Field protection (display-only).
- **31–79**: Error messages/warnings.
- **80–99**: Working variables.

---

## Summary

This program implements a typical maintenance list/detail UI pattern on the IBM i, using RPG IV, subfiles, and multiple display formats. The code is well-structured into subroutines for each user action, with clear separation of concerns: display, paging, record creation/update/deletion, validation, and error handling. The use of indicators and working variables is well-documented and follows IBM i practices. 

#### New developers should focus on:

- Understanding subfile mechanics and indicator usage.
- The role of each subroutine in the main program loop.
- How display file records (screens) map to subroutine logic.
- How database access and external program calls are coordinated for validation and lookup.

Most logic is driven either by user action on the subfile (list) or via modal screens for create, change, copy, delete, and validation steps.
```
