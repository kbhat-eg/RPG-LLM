# RPG Program FO585R - Onboarding Guide

---

## Overview

This program is a classic ILE RPG (RPG IV) application for IBM i (AS/400) systems. It manages follow-up orders for a company and provides a subfile-based user interface for order handling, selection, viewing, and status management.

The code is well documented and follows typical RPG/400 development standards, with enhancements over time (e.g., support for new GUI, deposit handling, multiple database files). It utilizes display files, subfiles, and calls to other RPG programs for specialized tasks.

---

## Key Components

### 1. Header and Documentation

- **h-specs**: Set compilation options like `*nodebugio` and `datedit(*dmy)` for date formatting.
- **Change log**: Chronological comments mark the purpose, enhancements, and developers responsible for each version.

### 2. File Definitions (f-specs)

- **Database Files**: Many logical files for order headers (`fohelr`, `fohel1`...), details, customer, user, product, type, deposit, etc. Files are renamed in RPG so the record format names are simpler to use.
- **Workstation File**: `fo585d` is the display file with a subfile `b1sfl`.
- **Other Files**: Used for DDS-driven screens, feedback data structures (infds), etc.

### 3. Data Structures (d-specs)

- **LDA (Local Data Area)**: Variables for firm, user, etc., are extracted from system LDA.
- **Display Feedback Structure**: Used to retrieve cursor position, etc., after displaying the screen.
- **Key variable definitions**: Used for database lookups and chain operations.
- **Subfile and Control Variables**: For subfile RRN, record count, display flags, current page, etc.
- **Constants and Flags**: For subfile page size, subfile actions, error tracking, etc.

### 4. Main Program Control

#### The main logic is a tag-driven loop:

- **`b2taga` / `b2tagb` tags**: The main control flow alternates between displaying the menu, showing the subfile, and acting on function keys.
- **Function Key Handling**: Uses indicator fields (e.g., `*inka`, `*in10`, etc.) to identify user actions and trigger corresponding subroutines (e.g., renew subfile, update view, handle filtering).
- **Exit Processing**: Controlled via `*inkc`, `*inkl`, and `*inlr`.

---

## Major Subroutines

### A. Subfile Management

- **`forny`** (Renew): Re-executes positioning and refreshes the subfile content according to the current sort/filter.
- **`posisjoner`**: Positions the subfile view based on user-entered criteria (order number, customer, type, etc.).
- **`subfile`**: Core loop for handling user actions on the subfile: update, view, print, process order, show history, etc.
- **`ajo_subfile`**: Updates the subfile line after returning from an external maintenance or processing program.

### B. Subfile Content

- **`clr_subfile`**: Clears out all records and resets page indicators.
- **`crt_subfile`**: Fills the subfile with records from the appropriate logical file, handling page size, filtering, record status, formatting, and special info like deposit or alternative info.

### C. Selection and Filtering

- **`chk_subfile`**: Determines if a record qualifies for the subfile view based on order type, user, customer, seller, department, warehouse, etc.
- **`xsjekk_ord1`**: Checks if the selected order is already being processed.
- **`xsjekk_inp`**: Validates user input, such as date fields.

### D. Deposit Handling (7.fb)

- **`filt_depo`**: Advanced filtering to show/hide records based on prepayment or partial payment status, using the deposit file.
- **`sjekk_depo`**: Checks if the entry has unpaid deposit requirements.

### E. Subfile Navigation

- **`bck_subfile`**: Scrolls the subfile view backwards one page.

### F. Display Logic

- **`dsp_subfile`**: Controls the showing of the subfile and associated control records.
- **`xfarge`**: Sets color indicators in the subfile based on order's info code.

### G. Helper Functions

- **`xh1win`**: Manages the filter pop-up window (alternative browse options).
- **`spørring`**: Handles user inquiry for customer, seller, department reference data (calls other programs).
- **`lagring`**: Saves user filter preferences.
- **`xsjekk_lag`**: Checks if a given warehouse exists on any order line.

---

## Display and User Interface

- **Subfile (B1SFL)**: Used to display a list of orders to be followed up.
- **Control Record (B2CTL)**: Main screen with filter/search inputs.
- **Command Window (B2CMD)**: For showing available function keys/commands.
- **Popup Window (H1WIN)**: For advanced filters.

**Indicators** are used throughout to control display attributes, input modes, protect fields, error highlighting, etc.

---

## Program Calls

The program frequently calls other programs to:
- View or maintain an order (`FO150R`, `FO505R`, `FO500R`)
- Print orders (`FO600R`, `FO710R`)
- View order history (`FU500R`)
- Get deposit information (`FU706R`)
- Lookup reference text (customer, seller, department)

---

## Advanced Features

- **Alternative Info Columns**: User can toggle columns to show order value, inclusive VAT, deposit required, deposit paid, etc. This is handled with a cycle of function keys and indicator variables.
- **Deposit Filtering**: Additional subfile filters and column logic for pre-paid or partial payment orders.
- **Dynamic Subfile Refill**: The subfile is cleared and filled as needed, with local logic for each filter, sort, or command.
- **Color Flags**: Visual cues (indicators) in the subfile based on info codes.

---

## Initialization (`*inzsr`)

At startup:
- Reads LDA for firm/user info.
- Gets current date, VAT rates.
- Loads user and code register for defaults.
- Initializes subfile and filter defaults.
- Populates subfile with default dataset.

---

## Key Variables & Indicators

**Order info fields**: `b1numm`, `b1suff`, `b1otyp`, `b1info`, etc.

**Indicator Usage**:
- `*in10`, `*in11`, etc.: Function keys.
- `*in12`, `*in13`, etc.: Subfile control.
- `*in14`, `*in15`: Subfile clear/end.
- `*in21`, `*in22`: Cursor/home.
- `*in70`-`*in73`: Alternative info columns.
- `*in41`-`*in44`: Color indicators.

---

## Conclusion

**This program is a classic RPG subfile-based order follow-up and management system.** It is modular, with clear separation of UI, data access, and logic. Most screens/actions are driven by subfiles, function keys, and dynamic filters, with helper programs handling the detail work for related domains.

If you are onboarding:
- Focus on understanding subfile programming in RPG.
- Learn how indicators control the display and input flow.
- Follow how database access is implemented with SETLL/READ/CHAIN/READE/READP, and key lists.
- Trace the flow from the main loop through subroutines.
- Pay special attention to function key handling, filtering, and display-cycle logic for smooth user interaction.

**Pro tip**: Keep a reference for all logical file names and their key fields handy—this program switches between many alternate logical views for performance and user flexibility.

---