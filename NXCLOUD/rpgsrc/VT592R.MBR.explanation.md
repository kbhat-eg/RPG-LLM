# RPG Program VT592R – Explanation

## Overview

This RPG (Report Program Generator) ILE program (`VT592R`) is used on the IBM i (AS/400) platform. Its purpose is to determine the **purchase price** for an item by searching for a valid offer period in files (`VTILPF`, `VTI2PF`), primarily using SQL. It selects the offer that is *closest* (i.e., most current) based on the "from" and "to" dates (`fra dato`/`til dato` in Norwegian).

It has been extended and maintained over time, with notable updates including handling a two-character price group and fetching purchase price periods from an additional table.

---

## Main Sections

### 1. Header and Options

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Sets debugging and date handling options.  
- `*nodebugio` disables debug for file I/O.
- `datedit(*dmy)` sets default date edit formats.

---

### 2. File Declarations

```rpg
fvtillr    if   e           k disk    rename(vtilpfr:vtillrr)
fvti2lr    if   e           k disk    rename(vti2pfr:vti2lrr)
```
- Declares two database files as keyed files:
  - `vtilpfr`/`vtilpf` (`vtillrr`): Main offers file.
  - `vti2pfr`/`vti2pf` (`vti2lrr`): Secondary offers file (possibly an extension).

---

### 3. Data Definitions

#### Parameters

```rpg
d p_firm          s                   like(vtfirm)
d p_vare          s                   like(vtvare)
d p_enhe          s                   like(vtenh1)
d p_inpr          s                   like(vtinp1)
d p_inlr          s              1
```
- Variables for *company* (`firm`), *item* (`vare`), *unit* (`enhe`), *purchase price* (`inpr`), and a logical return flag (`inlr`).

#### Work Variables

Variables such as `w_firm`, `w_vare`, `w_dato`, etc., are used as local working variables throughout the program, mainly as key fields and for date/time handling.

#### Subfile Handling

```rpg
* w_fcrn - First record number on the page
* w_stel - Subfile counter
* ...
```
- Comments explain special fields used with subfile processing for screen/database lists.

#### SQL Environment

```rpg
C/Exec SQL
C+  Set Option DatFmt=*ISO
C/End-Exec
```
- Sets SQL session to use ISO date format.

---

### 4. Initialization / Mainline

```rpg
* Entrypoint - *inzsr
* Parameter receiving – *entry plist, parm ...
```

- On program start, receives parameters (company, item, unit, etc.).
- Calls an external program (`CO402R`) to determine if 6.31 extensions should be used (`u_631` flag).

---

### 5. Main Program flow

#### Open Files / Check Version

```rpg
if u_631 = *on
    open vti2lr
endif
if u_631 = *off
    goto avslutt
endif
```
- Opens the additional file if needed, depending on configuration.

#### Set Up Search

- Sets up work variables with input parameters and initializes date/time values.
- If the logical return parameter is *not* set, ends.

#### Find Purchase Price (`finn_inpr` subroutine)

- Calls the subroutine to fetch the purchase price using SQL (details in the next section).

#### Program End

- Closes files if opened.
- Ensures the last record indicator (`*inlr`) is set if appropriate.
- Cleanly returns.

---

### 6. Subroutine: `finn_inpr` — Find Purchase Price

#### a. Set Up Variables

- Sets current date/time for search.
- Resets found flag and tracking variables.

#### b. Open SQL Cursor and Fetch Offers

```rpg
DECLARE kamp2 CURSOR FOR
    SELECT [fields]
    FROM vti2pf
    WHERE vtfirm = :p_firm
      AND vtvare = :p_vare
      AND vtvidf/t NOT NULL/LOVAL
      AND vtvidf <= :w_dato
      AND vtvidt >= :w_dato
    FOR READ ONLY
OPEN kamp2
```

- Selects all matching offers for the given company and item, where the offer period includes the current date.

#### c. Loop Through Results

Within a loop:
- Fetches each row.
- Tracks the offer with the *greatest* (closest, but not future) start date.
- Sets the `b_funn` (found) flag if a suitable offer is found.

#### d. After Loop

- Closes the cursor.
- If no suitable offer was found, exits the subroutine.

#### e. Lookup Purchase Price

- Builds a key (using selected fields) and uses CHAIN to locate the record in the offers file.
- Depending on the unit (`p_enhe`), picks the appropriate purchase price field (`vtinp1`, `vtinp2`, or `vtinp3`).

---

### 7. Key List Definition

```rpg
vtillr_key    klist
    kfld vtillr_firm
    ...
    kfld vtillr_ttim
```
- Defines which fields constitute the primary key for the offer lookup.

---

### 8. External Program Call

```rpg
DCL-PR CO402R EXTPGM('CO402R');
...
CallP CO402R(l_filg:w_firm:0:'TILB_INNKJ_PERIOD':co402_verdi1:co402_verdi2);
if co402_verdi1 = '1';
    u_631 = *on;
endif;
```
- Calls an external RPG program to determine if the function for purchase period in offers should be used.
- Sets a flag (`u_631`) if this extended logic is active.

---

## Summary of Business Logic

1. **Receives input parameters**: company, item, unit, etc.
2. **Checks if extended offer period logic is active** (via external program).
3. **Searches (via SQL) the secondary offer table** for valid offers covering the current date, picking the one with the nearest start date.
4. **Uses the result as a key** to look up the specific offer in the main offers file.
5. **Returns the correct purchase price**, depending on the unit required.
6. **Cleanly closes files and exits**.

---

## Additional Notes

- **Indicator Usage**: Various program and display/file indicators are documented in comments for clarity.
- **SQL Integration**: Shows how embedded SQL is used inside RPG for flexible offer lookup.
- **Extensibility**: Handles both legacy and extended (post-6.31) logic paths.

---

## Conclusion

This program is a well-commented and maintained legacy RPG III/IV+SQL program whose main goal is to fetch the most relevant purchase price for a given item and company, considering complex offer periods, with some logic toggled by configuration or version. It leverages both native record-level I/O and modern embedded SQL, uses indicator variables for control, and is built to be extensible for evolving business requirements.