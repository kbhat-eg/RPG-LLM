# Onboarding Explanation: RPG Program VT510R

## Overview

This RPG/400 (ILE RPG in fixed-format) program, VT510R, is used to display special offer prices ("tilbudspriser") for items/products ("vare") in a subfile display. The application is designed for interactive (workstation) display, and offers various filtering and navigation options, such as filtering by delivery type, date span, campaign, and price group. The comments and variable names contain significant Norwegian, but the program is straightforward in function.

The main I/O is to database files (logical/physical, with several RENAMED record formats) and to a workstation display file with subfile and multiple control formats. The program is navigated by function keys.

## Key Program Areas

### 1. **File Declarations**

```rpg
fvtillr    if   e           k disk    rename(vtilpfr:vtillrr)
...
fvt510d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- `vtillr`, `vtill1`, ..., `vtill6` are variations on a main "offer price" file, possibly for different access paths.
- `vvarl1`, `vltpl1`, `ra30l1` are supporting files for item and descriptive information.
- `vt510d`: Workstation display file, with subfile support (`sfile` keyword) and display feedback via `infds`.

### 2. **Parameter and Data Definitions**

```rpg
d p_firm          s                   like(vtfirm)
d p_vare          s                   like(vtvare)
```
- `p_firm`, `p_vare`: Program receives these as parameters (firm/company and item number).

Variables like `w_fcrn`, `w_stel`, etc. are counters and pointers for subfile processing.

### 3. **Subfile-Related Variables**

Explanation (in comments):
- **w_fcrn**: First record number on page.
- **w_srrn**: Relative record number in subfile (current record).
- **w_ssrn**: Last record number in the subfile.
- **w_spge**: Page size in the subfile.

### 4. **Indicators Usage**

```rpg
*       LR = Program end
*       10 = Roll
*       11 = Rolldown
*       12 = Sfldsp (Subfile display)
*       13 = Sfldspctl (Subfile display control)
*       14 = Sflclr (Clear subfile)
*       15 = Sflend (End of subfile/page)
```
- *in12, *in13, etc. are used for controlling display logic and subfile management.

### 5. **Main Program Flow (Logic Cycle)**

- **Initialization**: In `*inzsr` (initialize subroutine).
  - Receives parameters.
  - Looks up item description for the display (`vvarl1`).
  - Primes the database cursor and fills the subfile for the item.
- **Main Display Loop**: Utilizes `B2CTL` (subfile control record format) as the main hub for user interaction.
  - Handles function keys:
    - Page up/down (*in10 and *in11).
    - Refresh (*inke).
    - Positioning/filtering (by delivery type, date, campaign, price group).
    - Exit.
- **Subfile Management**: Via `clr_subfile` (clear), `crt_subfile` (fill), and `bck_subfile` (page backwards).

### 6. **Subroutines**

#### - **forny** (refresh)
- Positions and fills the subfile again based on the last-used criteria.

#### - **posisjoner** (positioning)
- Used to set the current filter context (e.g., by price group, delivery type, etc.) and fills the subfile accordingly.

#### - **subfile**
- Reads through entered/filtered subfile, processes selections, and displays further details if required.

#### - **xc2bld**
- Populates the display detail screen with record data for a selected line from the subfile.

#### - **clr_subfile**
- Signals to the display file that the subfile records should be cleared.

#### - **crt_subfile**
- Reads records from the main file using the current filter and fills the subfile, respecting page size (`c_sfil`).

#### - **bck_subfile**
- Handles the logic for moving backward in the subfile (page up), by reading previous records and repopulating the subfile.

#### - **dsp_subfile**
- Controls subfile display, activating the appropriate indicators before calling the display file.

#### - **hent_info**
- Fetches and fills descriptions/details for the current context (e.g., gets price group and delivery type descriptions).

### 7. **Key Lists (KLISTs) and Key Fields**

- Used for database positioning (SETLL, CHAIN, READE/READP).
- Key lists are defined for each access method/context, matching file index structure.

### 8. **Data Flow for Display**

1. **Initialization**:
    - Receive firm and item.
    - Fetch item descriptive data.
    - Fill subfile with offers for the item.

2. **Display Loop**:
    - Wait for user actions (filter, page, refresh, select, exit).
    - Respond by re-filling or navigating subfile or showing detail displays.

3. **Exit**:
    - Set *INLR on, program ends.

---

## Typical Usage

- A user calls the program with a firm and item number.
- Sees a list of special offers for the item (one per row in a subfile).
- Can page up/down, filter by criteria, position to a certain date/campaign, etc.
- Can select a row for detail display (see all fields).
- Can exit the display at any time.

---

## Key RPG Patterns Used

- **Subfile Paging**: The program uses counters to manage which part of the file is shown in the subfile, using indicators to clear/fill as the view changes.
- **Multiple Access Paths**: The file declarations and key lists enable fast filtering/positioning by different criteria (delivery type, date, campaign, etc.) using logical files or indexed access.
- **Interactive Display**: Status and input indicators are used to control the DSPF for a responsive UI.
- **Parameter-Driven**: The program receives its main context via parameters, making it usable as a "lookup" or "drill-down" from a parent screen.

---

## Additional Notes

- Some data movement (`move`, `movel`) is used for format conversions (e.g., dates, time fields), which is common in fixed-format RPG.
- Error handling is primarily via indicators; e.g. *in90, *in91 for errors on CHAIN.
- Display feedback (`infds`) is used to track the cursor and other display attributes.

---

## Conclusion

This program is a classic ILE RPG interactive application for displaying and navigating item price offers, with a rich set of subfile paging and filtering features. It is highly modular, with many subroutines for single-purpose subfile and display tasks, making it reasonably easy to onboard new developers once familiar with RPG fixed-format conventions and the Norwegian domain terms. 

If you are new to RPG, focus on understanding:
- How the subfile mechanism works (records per page, clearing, filling).
- How different key lists are constructed and used to position in files.
- How indicators control the display file and the program flow.
- The naming conventions for variables and field movement to/from display formats.

You will likely find the program logic straightforward as soon as you get comfortable with the RPG fixed-format and the indicator flags.