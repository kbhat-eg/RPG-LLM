# RPG Program JL500R – Explanation

This RPG (Report Program Generator) source code is for an IBM i (AS/400) application, specifically a supplier (leverandør) inquiry and selection program. The code uses a combination of native database access and embedded SQL, and is structured around subfile processing—a common pattern in green-screen (workstation) applications.

Below, the program’s main elements and logic flow are explained.

---

## Program Purpose

- **Description**: Supplier Inquiry ("Leverandør, spørring")
- **Context**: Runs on the ASVARE system, program name JL500R
- **Functionality**: Allows users to browse, search, and select suppliers using a subfile/paged list, with various navigation and search options.

---

## High Level Structure

- **File Declarations (`F-specs`)**: Defines the files and display file used, including subfile usage and feedback data structures.
- **Data Structures & Variables (`D-specs`)**: Defines parameters, subfile control variables, and subroutine work variables/constants.
- **Mainline Logic**: Implements the main screen loop, function key handling, and invokes various subroutines.
- **Subroutines**: Handle display logic, subfile creation/clearing, searching, and paging.
- **Initialization**: Processes incoming parameters and prepares the screen and subfile on program entry.

---

## Detailed Elements

### 1. **File and Display Definitions**

```rpg
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
fjlevl2    if   e           k disk    rename(jlevpfr:jlevl2r)
fjl500d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **fjlevl1/fjlevl2**: Logical files over the supplier master, used for keyed access (by different key sequences).
- **fjl500d**: The display file. Uses a subfile (`b1sfl`) for listing records, with relative record number tracking, and a display feedback data structure (`dspfbk`).

---

### 2. **Work Fields and Data Structures**

- **Parameters**: `p_ldor` (supplier id), `p_navn` (supplier name) – these drive the initial position/search.
- **Subfile Management**:
    - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Manage subfile record range, page size, current, first & last record numbers, etc.
    - **Constants**: `c_sfil` (subfile page size), set to 8.
- **Indicators**: Comments explain how function and screen indicators (`*inxx`) are used for various display and action states.
- **Search Texts**: `w_ste1` to `w_ste5`: Used to hold parsed search terms.
- **Flags**: `b_open_sok` (open search cursor flag), `b_valg_ok` (selection ok flag), etc.

---

### 3. **Mainline Logic**

(Pseudocode overview)

```rpg
Write b2cmd               // Show command key screen

b2tagb:
  exsr dsp_subfile        // Display subfile

  // Function key handling
  select
    case F3/F12: goto avslutt  // Exit
    case F5: exsr forny; goto b2tagb // Refresh
    case F10: exsr crt_subfile; goto b2tagb // Next page
    case F11: exsr bck_subfile; goto b2tagb // Previous page
    case F21: set cursor placement; goto b2taga
  endsl

  // F9: repeat search
  if F9: set search text and cursor; goto b2tagb

  // Any search to perform?
  if searchText: exsr søk; goto b2tagb

  // Position requested?
  if positionFields: exsr posisjoner; goto b2tagb

  // Handle subfile selection
  exsr subfile
  if selectionMade: goto avslutt

  goto b2taga

avslutt:
  Set LR indicator; return // End program
```

---

### 4. **Subroutines Key Points**

#### a. `forny` — Refresh subfile (F5 key etc.)

- Repositions file, clears, and reloads subfile per current search/positioning mode.

#### b. `søk` — Perform search

- Calls external program `AS701R` to parse search terms into `w_ste1`..`w_ste5`.
- Clears and refills the subfile with matching records using an SQL SELECT with multi-field LIKEs.

#### c. `posisjoner` — Position subfile

- Positions on supplier name or number, loads corresponding records into subfile.

#### d. `subfile` — Process subfile for selection

- Loops through visible subfile records, checks if a selection was made, and sets up return values if so.

#### e. `clr_subfile` — Clear subfile

- Sets indicator for subfile clear, writes control record, and resets paging variables.

#### f. `crt_subfile` — Create/Fill subfile

- Initializes or advances page size tracking.
- Opens a SQL cursor if in search mode.
- Fills the subfile up to the page size, either by fetching next records or by keyed reads, and writes records to subfile.

#### g. `bck_subfile` — Page back

- Handles going back a page in the subfile (backward paging), including special handling for SQL search mode and normal keyed access.

#### h. `dsp_subfile` — Display subfile

- Displays the subfile and control (header) records, handles cursor placement.

#### i. `*inzsr` — Initialization

- Processes entry parameters, initializes file positioning, and loads the first subfile page.

---

### 5. **Embedded SQL Usage**

- The program uses embedded SQL for searching, constructing a complex LIKE query over multiple fields concatenated into a single searchable string.
- The query is parameterized for up to five search terms.
- Cursor is managed (declare, open, close, fetch) based on the search state.

---

### 6. **Function Key and Indicator Map**

*(As explained in comments)*

- `LR` = End program
- `10` = Roll (next page)
- `11` = Rolldown (previous page)
- `12/13` = Subfile display/control
- `14` = Subfile clear
- `15` = Subfile end
- `21,22` = Home key, cursor placement
- `30` = Field protection
- `31-79` = Error/warning indicators
- `80-99` = Work indicators

---

### 7. **Interaction Flow**

1. **Initial Screen**: Program starts, loads initial subfile page (parameter-driven positioning if requested).
2. **Navigation**: User pages, searches, or positions using function keys or input fields.
3. **Selection**: User can select a supplier from the subfile list; selection details are returned via parameters.
4. **Exit**: User can exit with F3/F12.

---

### 8. **Subfile Management Pattern**

- Typical Page-at-a-time model for green-screen workstations.
- Uses subfile control indicators and variables to manage page size, current record ranges, and rolling back/forward.
- Both SQL and native keyed logic are supported for subfile fill, depending on search or position mode.

---

### 9. **External Dependencies**

- **AS701R**: External program for parsing/expanding free-format search text.

---

## Summary

This program is a well-annotated example of classical ILE RPG and green-screen application design on IBM i, showcasing subfile handling, mixed SQL/native DB access, advanced search logic, and multi-key navigation/positioning. Comments and indicator maps are comprehensive, and the codebase is designed for extensibility and maintainability in a heavy data-entry context.

New developers should focus on understanding the subfile variables and paging logic, as well as the function key handling branching, to extend or troubleshoot the program.