# RPG Program JM740R Explained

This program is written in ILE RPG and is used for updating campaign articles from a file (likely NOBB format) into a set of campaign and article files on an IBM i/AS400 system. Below is a breakdown of each section and the overall program logic.

---

## 1. **Header and Description**

The header contains standard information:
- **System:** ASVADM
- **Program:** JM740R
- **Description:** "Kampanje-vare, oppdater fra NOBB" (Campaign article, update from NOBB)
- **Change log:** Lists program versions and description of changes/updates (in Norwegian).

---

## 2. **File Declarations**

```rpg
fpcintpf   if   e           k disk
fjvarl3    if   e           k disk    rename(jvarpfr:jvarl3r)
fjkahlu    uf a e           k disk    rename(jkahpfr:jkahlur)
fjkavlu    uf a e           k disk    rename(jkavpfr:jkavlur)
```
- **pcintpf**: Input campaign file (probably NOBB import file).
- **jvarl3**: Master item file (renamed record format).
- **jkahlu**: Campaign header file (renamed record format).
- **jkavlu**: Campaign line file (renamed record format).

---

## 3. **Local Data Area & Variables**

- **LDA Fields**: Used to fetch system/user info.
- **l_user, l_firm**: User and firm identification from LDA.

### Key Variables

- **w_rect**: Record type indicator (1 = header, 3 = line).
- **w_dato_6, w_fdat, w_tdat**: Date work fields.
- **b_nobb, b_peri, b_ny**: Boolean flags used for logic flow.
- **jkahlu_key, jkavlu_key**: Key lists for database operations.

### Data Structures

#### NOBB Campaign Header Layout

```rpg
d d_nrec  ds      256
d_n_htyp                overlay(d_nrec:1)   = '1,'
d_n_nobb                overlay(d_nrec:3)
... (fields for header data in imported record)
```

#### NOBB Campaign Line Layout

```rpg
d d_vrec  ds      256
d_v_vtyp                overlay(d_vrec:1) = '3,'
d_v_vldo                overlay(d_vrec:22)
...
```

Fields are overlaid at specific positions according to the incoming data file's format.

---

## 4. **Mainline Logic**

```rpg
c                   exsr      hode
c                   read      pcintpf
c                   dow       not %eof
    c               eval      w_rect = %subst(pcint:1:1)
    c               select
    c               when      w_rect = '1'
    c               exsr      nobb
    c               when      w_rect = '3'
    c               if        b_nobb = *on
    c               exsr      varelinje
    c               endif
    c               eval      b_nobb = *off
    c               endsl
    c               read      pcintpf
c                   enddo
```
- **Read records from the input file (`pcintpf`).**
- **Record's first character determines the type:** '1' = header, triggers `nobb` subroutine; '3' = line, triggers `varelinje` subroutine if a header was found.
- **b_nobb**: Acts as a context flag between header and line.

---

## 5. **Subroutines**

### a. `*inzsr` Initialization Subroutine

- Sets up PLIST (entry parameter `p_kamp`) and all KLIST (key fields).
- Retrieves company/firm id (`w_firm`) from LDA.

### b. `hode` (Header Processing)

- Checks if campaign header exists; if so, updates, else creates a new one.
- If existing, marks as new and updates metadata (user/time).
- New header: fills in details and writes to JKAHLU file.

### c. `nobb` (Import Header Processing)

- Maps NOBB header record into data structure.
- Checks if article exists in master file by NOBB number, fetches article number if present.
- Sets **b_nobb** flag to signal valid processing state for following line records.

### d. `varelinje` (Line Processing)

- Maps NOBB line record into data structure.
- Calls `upd_kamp` subroutine if date range period not already set.
- Builds key fields, checks if campaign/article already exists:
    - If exists and not locked, calls `opd_vare` to update.
    - Else, calls `skr_vare` to insert.
- Only updates if record is "not locked" (`jmvlas = 0`).

### e. `skr_vare` (Write Campaign-Article Line)

- Clears campaign-line record and sets fields from input and work variables.
- Inserts (writes) a new record in `jkavlur` (campaign article line file).

### f. `opd_vare` (Update Campaign-Article Line)

- Updates fields for existing campaign-article line in `jkavlur`.

### g. `upd_kamp` (Update Campaign Header with Date Range)

- Reads "from" and "to" dates from the line item, validates as dates.
- Updates campaign header (`jkahlu`) with these dates if the key is found.
- Sets **b_peri** flag on successful update to prevent further modifications.

---

## 6. **Key Lists**
Defined for database/file operations:
- **jvarl3_key**: Key for item master lookup (by NOBB-number).
- **jkahlu_key**: Key for campaign-header (firm, campaign).
- **jkavlu_key**: Key for campaign-line (firm, campaign, price group, item).

---

## 7. **Program Flow Summary**

1. **Initialization:** Set up parameters, key fields, get firm ID.
2. **Input Loop:** For each record in the NOBB input, determine if it's a header or line.
3. **Header Record:** Process header, possibly set up to receive lines.
4. **Line Record:** For each line, validate, update campaign date (on first line), update or insert campaign-article records.
5. **Exit:** Set LR (last record indicator) and return.

---

## 8. **Notable Program Features**

- **Overlaying Input:** Uses data structures to parse incoming positional records cleanly.
- **Conditional Update/Insert:** Updates records if possible, else inserts new.
- **Date Checks:** Validates and updates date fields from input.
- **Flags:** `b_nobb`, `b_peri`, `b_ny` manage program context/flow.
- **File Format Renaming:** Ensures consistent record formats across multiple files.

---

## 9. **Customization Notes**

- Some logic commented out (e.g., mass deletion of campaign lines), indicating either performance or business logic changes.
- Changes for support of expanded price group and adaptation for Mestergruppen shown in version comments.

---

## 10. **Purpose**

This program automates updating/creation of campaign header and article detail records based on input from an external (NOBB) file, handling master data verification, date range setting, and proper state management for repeated runs and incremental updates.

---

**Overall**, this is a robust, batch-style import/update program common in ERP systems, with clear Norwegian business terminology and comments, and structured to make maintenance and extension straightforward for RPG developers.