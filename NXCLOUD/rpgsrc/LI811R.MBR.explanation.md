# RPG Program LI811R - Documentation & Explanation

This RPG program, named `LI811R`, processes information regarding orders ("bestilling") derived from EDI packing slips ("pakkseddel"). The source code contains extensive history and comments in Norwegian. Below, you'll find a structured explanation to help new developers to this ILE RPG codebase understand the logic and purpose.

## 1. **Header & History**

- The program is part of the `ASLAGR` system.
- It builds info around orders from EDI packing slips.
- The modification history includes numerous functional and bug fixes; the comments are rich in context (in Norwegian).

## 2. **File Declarations**

The program uses multiple physical files, most accessed for input/update (`if/uf`) with various dataset renames. 
- Example: `flphoir    if   e ... rename(lphost:lphoirr)`  
  This means the file `lphost` is being renamed to `lphoirr` within the program.

Files relate to:
- EDI packing slip headers and lines (`lphoir`, `lpkliu`, `lpkoi1`)
- Bestilling/order headers and lines (`lbhoiu`, `lbliiu`)
- Reference and supplement information about orders and partners
- Additional files for carrier info, shipping office, etc. (versioned with 7.x/8.x changes)

## 3. **Data Structure & Field Definitions**

- Local Data Area (`d uds`): used for user and company/firma fields.
- Data structures for unpacking bestillingsnummer (order number) into different lengths for right-justification with leading zeros.
- Variables are defined for fields needed as keys and for processing (many use `like()` to ensure they match related file fields).

**Important data:**
- `w_firm`: The current company number (loaded from LDA)
- `b_best`, `b_pakk`: Boolean flags for order and packing-slip logic
- `w_numm`, `w_anum`: Numeric/Alphanumeric representation of the order number for processing

## 4. **Constants**

- `c_digi`: String constant '0123456789', used to check if a string contains only digits

## 5. **Main Program Logic**

Main logic is simple:
```rpg
c                   exsr      bygg_Best
c                   eval      *inlr = *on
c                   return
```
- Calls the `bygg_Best` subroutine, then ends the program.

---

## 6. **Subroutine bygg_Best ("Build Order")**

This is the core of the program.

### **Loop: EDI Packing Slip Header**
- Iterates through all packing slip headers (`lphoir`).
- Skips fully processed orders (`phstat >= '90'`).

#### **Inner Loop: Packing Slip Lines**
- For each header, reads all related packing slip lines (`lpkliu`).
- Attempts to find an associated Bestilling/order (`plbnum`) and processes it:
  - Right-justifies and zero-fills the order number to 8 digits.
  - If numeric and matches an order header (`lohel1`), sets `b_best = *on`.
- Updates the packing slip line with the processed order number (`plnumm`).

#### **If Valid Bestilling Found**
- Updates or adds EDI bestillingsnummer references in header/line tables (`lbhoiu`, `lbliiu`).
- If not found, it initializes (clears and fills) the record, timestamps it, and writes it.
- If found, it unlocks the existing record (for proper concurrency).

#### **Automatic Packing Slip Update Logic**
- After processing lines, checks if the packing slip should be auto-updated (exsr `upd_pakk`).
  - Various conditions are checked, including supplier settings, distribution warehouse, and connected order shipping office.

---

## 7. **Subroutine upd_pakk ("Update Packing Slip")**

Handles logic related to automatically triggering an update process on a packing slip if certain criteria are met:

- Checks supplier flags (`lnapak`), distribution warehouse, special carriers, and connected SO ("Sales Orders").
- If automatic update is warranted, prepares parameters and calls program `LI320R` to perform the update.

---

## 8. **Initialization Subroutine (\*inzsr)**

- Defines all key lists used for chains/reads on the files.
- Loads current company code from LDA into `w_firm`.

---

## 9. **Key Lists**

Key lists (`klist` + `kfld`) are defined for all major file accesses:
- Packing slip header/lines
- Order header/lines
- Supplementary and cross-reference tables
- Carrier/partner logic for advanced lookups (as of versions 8.04/8.05)

---

## 10. **Notable Logic Details**

- **Bestilling Number (Order Number) Formatting:** 
  - The code right-justifies and fills order numbers from 1 to 8 digits with leading zeros, ensuring parsing robustness.
  - Checks that the string is numeric before casting.

- **Record Initialization:** 
  - If a reference is missing, clears and fills all the relevant fields before writing.

- **Concurrency:** 
  - If updating an existing reference (not writing new), unlocks the record after the operation.

- **Automated Update Call:** 
  - If the flag checks pass, prepares parameters and calls another RPG program to process the update (`LI320R`).

---

## 11. **Versioned Enhancements**

Several enhancements are version-tagged (e.g. 7.01, 8.01, etc.), indicating progressive feature evolution:
- Improved validation and formatting.
- More robust auto-update control and override mechanisms.
- Expanded to cover new situations (e.g. distribution warehouse, connected sales order office).

---

## 12. **Takeaway**

This program acts as the bridge between received EDI packing slip data and the internal order-tracking system, ensuring references are built, validated, and, if necessary, passed forward for automatic updating. It is robust, handling both "new" and "existing" records, and has grown over time to handle edge cases, including complex distribution and sales office logic.

---

### **For New Developers**

- Most of the "action" happens inside the `bygg_Best` subroutine, which tightly loops through packing slip data and applies business logic.
- The code is careful with key processing and data validation, especially for order numbers.
- File and record locks/concurrency are handled properly with `unlock`.
- If you're troubleshooting or extending logic, start in the subroutines and follow the data flow (especially key fields).
- Make sure to follow the documentation and history commentsâ€”many changes are tied to specific business or integration requirements.

---

**Tip:** Understanding the business rules around packing slip and order integration will help greatly when working with this code, as much of the complexity is around these "edge cases" and special conditions tracked in the comments.