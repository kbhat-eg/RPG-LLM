# RPG Program Explanation: RF812R - GE Capital Transactions

This ILE RPG program, `RF812R`, is a business-batch program designed to process, format, and output transaction data for GE Capital (associated with XL Bygg/byggeriet) in a specific layout. The output is tailored to generate interchange files for financial processing, reporting, or reconciliation, based on transaction data from historical invoices and sales receipts (bongs). 

Below you'll find a detailed walkthrough of the core structure, logic, and subroutines. The code is typical for business applications on IBM i, using native RPG III/IV (fixed-format) constructs, heavy use of data structures, and subfile processing.

---

## 1. **File Declarations**

### Input Files (Disk, Keyed)
- **rukrl5**: Customer/card register (`if`, input, keyed)
- **bokkl5**: Card transaction posting register
- **rukrlu**, **ruksl1**: Lookup files for various keys
- **bcdtir, bcdtll**: Sales receipt (bong) detail and log
- **bchei1**: Sales receipt header
- **sodtlr, sohelr**: Historical invoice line and header
- **bohel1, ra09l1**: (from v6.21) New files for extended invoice and seller code lookups

### Output Files
- **fgemonbpf**: Main output file (the formatted export)
- **fxmllogpf**: XML log file for auditing

---

## 2. **Data Structure and Variable Declarations**

### Parameters (`p_prec`)
A main parameter string is deconstructed into:
- `p_ktyp`: Card type
- `p_frda/p_tida`: Date range (from/to)
- `p_omkj`: Flag for forced reposting (omkjøring)
- `p_lage`: Warehouse/store number
- `p_ftxt`: Store text

### Working Variables
- Several numeric and alphanumeric work fields for accumulated amounts, intermediate fields for prices, text fields, dates, etc.
- Buffers (`w_tmp1`/`w_tmp2`) for string manipulation (removing leading zeros/blanks)
- LDA (`l_user`, etc.) used for audit/user tracking.

### Output Record Structures
- Complex string structures with overlays for building output records.
- **h0_**, **s1_**, **s2_**, **s3_**: Constants and variables for header, sub-header, detail line, and trailer record fields.

---

## 3. **Main Program Flow**

1. **Write Initial Header**
   - Calls `skriv_init` to write file header record.
   - If header writing successful (`b_genf`), continues.

2. **Process Transactions**
   - Calls `les_kort`, the main subroutine, which loops through the card/customer register, and for each, reads associated transactions (invoices and bongs), then outputs formatted records.

3. **Write Trailer Record**
   - Calls `avsl_melding` to write a file summary/trailer record.

4. **Set Return Parameters**
   - Sets status (`p_post`) depending on whether any records were written.

5. **Program End**
   - Sets LR on (`*inlr = *on`) and returns.

---

## 4. **Subroutine: les_kort (Read Card/Customer Register)**

- Loops through all eligible cards/customers.
- For each, sets keys and reads through associated postings (`bokkl5`).
- Checks posting date is within given range (`w_frda`/`w_tida`).
- Handles reposting logic (`p_omkj`) and previously processed flags.
- For each posting, determines whether an invoice or bong transaction and calls corresponding subroutines:
    - `les_hfakt` for historical invoice postings.
    - `les_bong` for sales receipt ("bong") postings.
- After processing, marks transaction as posted if required.
- Continues for all card/customer records.

---

## 5. **Subroutine: les_hfakt (Fetch Invoice Details)**

- Looks up invoice lines and header using keys derived from customer and posting.
- If invoice found, loads header info (date, number, amounts, VAT, sales rep).
- Writes "fakturaheadder" (header) record to output file.
- Then reads invoice lines:
    - Ignores text-only ("TX") lines.
    - For each valid line, extracts details (item number, qty, price, discount, description, unit, etc.), calculates amounts and taxes, writes detail records.

---

## 6. **Subroutine: les_bong (Fetch Receipt ("Bong") Details)**

- Similar to `les_hfakt` but for sales receipts:
    - Reads bong header for date, number, total, etc.
    - Looks up extended info (VAT breakdown, sales rep).
    - Writes header record.
    - Reads and writes each receipt line (sales lines, not text lines).

---

## 7. **Subroutines for Writing Records**

### `write_outp`
- Handles actual writing of the assembled string record to output file, after converting special Norwegian characters (commented-out, but left for reference).

### `skriv_fhspec` (Write Header/Subheader)
- Assembles and writes the header or subheader with all required fields.
- Handles negative/positive amount formatting.
- Writes record, increments record count.

### `skriv_flspec` (Write Detail Line)
- Composes a detail line with all item, amount, and discount info.
- Handles rounding, negative amounts, empty/null fields, VAT adjustments, etc.
- Includes calculation of discount percentage, total line amount, unit price, and more.
- Writes record, increments count.

### `skriv_logg`
- Composes an XML log line for auditing.

---

## 8. **Utility Subroutines**

- `rmv_char`: Trims leading zeros and blanks from keys/fields, used when formatting card/customer numbers or other identifiers for output compliance.

---

## 9. **Initialization (`*inzsr` Subroutine)**

- Receives input parameter(s), unpacks them into the work structures.
- Sets up RPG Key Lists for all file access patterns.
- Loads values from LDA for company, user, etc.
- Sets processing dates.

---

## 10. **Key Features & Business Rules**

- Handles *reposting* logic (flag for reposting already-posted transactions).
- Skips records outside date range or that don't match the selected warehouse.
- Ignores "text lines" (not real transactions, since they don't represent sales).
- Ensures compliance with file layout specification from GE Moneybank/Capital.
- Applies rounding, formatting (+/-), and limits (e.g., discount % max 99.99).
- Writes both human-log and machine-formatted records.
- Logs processing steps via XML-capable output file for traceability.

---

## 11. **Special Comments and Change History**

- In-code comments (with version numbers e.g., *6.21*) and change logs at the top are invaluable for tracking the evolution of requirements (especially file layout changes, field length changes, bug fixes, compliance with bank specifications, etc.).

---

# **Summary Table of Main Components**

| Component         | Purpose                                                                                           |
|-------------------|---------------------------------------------------------------------------------------------------|
| Input files       | Customer/cards, card postings, sales, invoices, receipts, seller, store info                      |
| Output files      | Export file in GE-specific format (`fgemonbpf`), log file (`fxmllogpf`)                           |
| Parameters        | Control which card type, period, store, etc. to process                                           |
| Main loop         | For each eligible card/customer, processes related transactions within date/store restrictions     |
| Header writing    | Sets up file and batch header with overall info                                                   |
| Invoice handling  | Fetches and formats each invoice and its detail lines                                             |
| Bong handling     | Fetches and formats each sale receipt and its lines                                               |
| String cleanup    | Routines for removing leading zeros/blanks for compliance                                         |
| Logging           | Writes parallel log entries for each item processed                                               |

---

## ## **Tips for New Developers**

- **File Layouts**: The output files are very format-specific; every field position and length matters.
- **Change Management**: Pay attention to the versioned comments—many lines are version-guarded.
- **Subroutine Structure**: The program is modular, each key function is wrapped in an `begsr ... endsr` subroutine.
- **Key Management**: RPG key lists (`klist`) are used for fast/efficient access to DB2 tables/files.
- **Data Conversions**: Use of `move`/`movel`/`movea` for field assignments and overlays is prevalent—be precise with types and lengths.
- **Internationalization**: Special character handling (e.g., Norwegian alphabets) is critical if output is for EDI/file exchange.
- **Testing**: Simulate both invoice and bong flows with different flags and parameters to ensure all paths work as intended.

---

# **Conclusion**

This program is a mature, feature-rich RPG batch export routine for financial transactions. Its modular structure and detailed change history make it easier to maintain, but developers must pay attention to legacy coding styles, field overlays, and file layout specs. Understanding the business requirements (what the export file is for, and how the fields must be formatted) is just as important as understanding the code.