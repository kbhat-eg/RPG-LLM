## Overview

This program (FP252R) is part of the “ASOFAK” system and is responsible for generating item labels after scanning a product using a radio terminal. The workflow involves:

1. Reading input parameters (including the firm and item number).
2. Reconstructing an item number if the terminal has stripped any leading zeros.
3. Retrieving various product, pricing, and VAT data from multiple database files and external routines.
4. Calculating and applying different prices and VAT configuration according to business rules.
5. Generating a print record (via the “etikett” file) for the actual label.

The program interacts with several other modules (e.g., VP716R, FA910R, VE716R, VL711R) to perform specialized lookups and calculations, and also updates or reads from administrative files such as VETIPF (for label parameters).

---

## Key Files and External Dependencies

- **File Definitions**  
  - VVARL1 (Product master / “vare”-register)  
  - VLAGL1 (Warehouse / “lager”-register)  
  - VTILL5 (Discount or campaign data, keyed by campaign number)  
  - VVPRL1 (Price register)  
  - VFASPF (Configuration or central parameter file)  
  - VPKOL1 (Price code lookups)  
  - RLEVL1 (Supplier information)  
  - VETILU / VETIL1 (Label parameter register)  
  - VVLEL1 (Extended product data, used for specialized lookups)

- **External Programs**  
  - **VP716R**: Fetches three different price/discount sets for an item (including campaign handling, price date checks, etc.).  
  - **FA910R**: Applies rounding rules to prices (örerounding in Norwegian).  
  - **VE716R** (previously VE712R): Retrieves the EAN (GTIN) for a given item if one exists.  
  - **VL711R**: Retrieves or updates price group information.  
  - **VL710R**: Fetches additional item-specific data (e.g., potential end-of-life date, extended supplier data) from the warehouse.  
  - **FØ705R / FØ706R**: Retrieves VAT rates (mva-sats) depending on product classification (normal, exempt, or half VAT).

---

## Structure and Business-Specific Logic

### 1. Main Flow

1. **Parameter Input**  
   The program receives parameters (firm number, product number, and quantity, among others) via the `param` file. It stores them in local data structures and variables.

2. **Item Handling (beh_vare Subroutine)**  
   - Ensures that any leading zeros removed by the radio terminal are restored. This is critical for matching the correct 8-digit product number in internal files.  
   - Performs a key lookup in the VVARL1 file to confirm that the item is valid and to retrieve associated base data.

3. **Price Retrieval (hent_pris Subroutine)**  
   - Calls VP716R to retrieve multi-level pricing data (for up to three different units).  
   - Determines whether the scanned label request should use regular or promotional pricing, factoring in date/time windows.

4. **Price Preparation (klar_pris Subroutine)**  
   - Skips printing if the label configuration indicates “no price.”  
   - Otherwise, decides which price(s) to use for up to two price fields on the label (e.g., base price on one line and a second unit price on another).  
   - Applies time-limited promotional pricing if time/date criteria are met.  
   - Fetches the correct VAT rate (via FØ705R or FØ706R), calculates the final price including VAT, and then calls FA910R to apply rounding rules (“øreavrunding”).

5. **Additional Data (klar_rest Subroutine)**  
   - Retrieves the EAN code by calling VE716R. If the EAN is missing, the code can fall back to some constructed logic (though the code now typically sets a zero if none is found).  
   - Reads supplier information (RLEVL1) if the item references a specific supplier.  
   - Fetches any specialized price code text (VPKOL1).  
   - Looks up warehouse data (VLAGL1) for storage location and reorder quantities.  
   - Calls VL710R to determine if the item is flagged with a future end-of-life date or extended data.  
   - Updates label-tracking file VETIPF (via the VETILU record) to record when a label was last printed.

6. **Printing**  
   - The final data is written to the `etikett` file via an EXCPT operation. This record format “skriv” includes all the fields displayed on the physical label.

### 2. Non-Obvious Details

- **Leading Zero Restoration**:  
  The subroutine checks how many characters are in the scanned item number (`wpvare`). If fewer than eight, it pads with zeros on the left. This is crucial in systems where certain terminals omit leading zeros.

- **Time-Limited Promotion**:  
  Bargain or promotional pricing is enabled by checking the current date/time against the “from–to” promotional window (w_fdat / w_tdat, w_ftid / w_ttid). If the label is marked as time-limited, the system picks the promotional price fields (w_tipX) instead of the regular price (w_sapX / w_bupX).

- **VAT Calculation**:  
  The program determines whether the item is exempt, normal, or half VAT (vvkmva variable) and calls the relevant module (FØ705R or FØ706R). Then it multiplies the baseline prices by the VAT factor before rounding.

- **Rounding Rules**:  
  After VAT is applied, the code calls FA910R for rounding. This ensures consistent öre rounding across the system (e.g., rounding to .00 or .50).

- **Label Output Customization**:  
  Several indicators (like `*in71`, `*in72`, `*in73`) control which prices to display and how. The label layout in O-spec lines includes a wide variety of fields such as the item text, NOBB number, EAN code, two optional prices, a comparison price, storage location, and more.

- **Updating VETIPF**:  
  Each time a label is printed or information changes, the VETIPF / VETILU entry is updated with the latest print date/time and relevant pricing fields. This allows the system to track the most recent label print run.

---

## Noteworthy Design Decisions

1. **Single-Item Focus**  
   The program processes only one item at a time, reflecting its usage with scanners in a live environment where items are frequently brought in one by one.

2. **Extensive Use of External Programs**  
   Instead of computing everything in one place, the system relies on specialized routines (e.g., for retrieving VAT rates, EAN codes, and adjusting prices). This design promotes reuse and consistency but requires close attention to interface parameters.

3. **Selective Print of Prices**  
   The label can either show no prices, standard prices, or promotional prices depending on local configuration values (l_fen1, l_fen2) and date/time checks. This flexible design suits multiple label types with minimal changes.

4. **Dynamic EAN Logic**  
   The code tries to look up the EAN code, but if none is found, it can set a placeholder or zero, protecting downstream systems and preventing errors with missing barcodes.

5. **Placed “End-of-Life” Handling**  
   The warehouse-based calls (VL710R) can set an internal flag to “U” (utgått/expired) if the item is marked with a future end-of-life date, ensuring labels reflect current stock status.

---

## Interaction with Other Modules

- **VP716R**: Main price fetch, supporting multiple units.  
- **FA910R**: Price rounding.  
- **VE716R**: EAN (GTIN) retrieval for barcodes.  
- **VL711R**: Determination of the item’s price group or classification.  
- **VL710R**: Additional item data from the warehouse; handles end-of-life or advanced statuses.  
- **VETIPF / VETILU**: Label parameter file updated each time a label prints, storing last print date/time and the printed EAN/price.  
- **FØ705R / FØ706R**: Normal or half VAT lookups.

Beyond direct lookups, the system leverages standard data structures (e.g., for storing leading zeros in item numbers) and business rules (e.g., promotional or discount logic) that are spread across these various modules.

---

## Conclusion

FP252R serves as the single-item label printer for the ASOFAK system, integrating multiple data sources and applying internal business rules for pricing and inventory. By orchestrating calls to specialized routines for VAT, EAN codes, and warehouse data, it ensures accurate and up-to-date information on each printed label.