# RPG Program RH969R (General Ledger - Journals with Difference)

This program is written in ILE RPG IV and is designed to process journal entries for a general ledger system, specifically producing a report of journals with differences and handling reporting and archiving, including integration with XML and PDF outputs.

Below you'll find a section-by-section explanation to help you quickly understand and onboard onto this codebase.

---

## 1. Program Configuration and Documentation

### Header specifications (`H-spec`)
```rpg
h datedit(*dmy.) option(*nodebugio)
```
- **datedit(*dmy.)**: Dates are edited as day-month-year.
- **option(*nodebugio)**: Disables debug I/O.

### Program documentation (`*` comments)
- Describes the system, program, purpose, version history, and change log.
- Documents how indicators are used in the program.

---

## 2. File Declarations (`F-spec`)

```rpg
frhwapf    if   e           k disk
fraa1l1    if   e           k disk    rename(raa1pfr:raa1l1r)
frh969p    o    e             printer oflind(*in30)
6.30 f                                     usropn
```
- **rhwapf**: Input, keyed file (main transaction file).
- **raa1l1**: Input, keyed file, **renamed** to local format `raa1l1r`.
- **rh969p**: Output, printer file, end-of-file indicator *in30, opened by user.

---

## 3. Data Definitions (`D-spec`)

### Parameters read from the LDA (Local Data Area)
Sections like:
```rpg
d                uds
d rhpkda                300    305  0
d rhpr�r                         4  0
...
```
Define fields at specific LDA positions, corresponding to business data (years, periods, flags, etc).

### Local Variables
- **l_wsid, l_user, ...**: User/job info.
- **w_firm, w_jour, w_first**: Work variables for current firm, journal, first entry flag.
- **rhwapf_kkey**: Work variable for keyed access.

### Print Management / Spooler Integration
- **splfname2, ... splfnbr3**: Fields for spool file and job identity, for archiving/reporting.
- **p_taggN/p_taggNval**: Key-value pairs for passing report meta-data (for XML, Jasper integration).

### QSPRILSP API
Used to query spool file attributes.

```rpg
d qsprilsp        pr                  extpgm('QSPRILSP')
...
d sprl0100        ds
...
```

---

## 4. Main Processing Section (`C-spec`)

### Reading Transactions

```rpg
c     les           tag
c     rhwapf_key    setll     rhwapf
c                   read      rhwapf
c                   dow       *in15 = *off
```
- Sets file position and starts reading the `rhwapf` file.
- Loop ends if *in15 is set (done when EOF or set in code).

#### Journal Difference Logic

- When the journal number (`rbjour`) changes:
  - If it's not the first, and differences exist or reporting all, output previous totals.
  - Reset work variables for new journal.
- Summing logic:
  - Credits and debits are accumulated.
  - Net difference (`l1diff`) is calculated.

#### Sample Breakdown
```rpg
c                   if        rbneto < 0
c                   eval      l1kred = l1kred - rbneto
c                   else
c                   eval      l1debe = l1debe + rbneto
c                   endif
c                   eval      l1diff = l1diff + rbneto
```
- Negative net amounts are treated as credits, positive as debits.

#### Output

- Writes a report line for each journal with a difference or all entries, depending on parameters.

#### End of Processing
At the end:
- Outputs a line for the last journal if needed.
- Handles archiving, XML, PDF, and job ending if archive flag set.

---

## 5. Subroutines

### `spoolnbr`
- Calls QSPRILSP API to get the current job's spool file information for further processing/archiving.

### `xml_create`
- Prepares meta-data (like tags, reference info) and calls program `AP627R` to generate an XML file for the report, passing all relevant IDs and tags.

### `pdf_preview`
- If requested (l_skje = 1), calls `AP621R` to launch PDF preview (likely in a browser context).

### `*inzsr` (Initialization Subroutine)
- Initializes work variables, opens printer file, gets current year/date, sets up keys for subsequent lookups.

---

## 6. Indicator Conventions

As per the documentation comments:
- **KA (F1)**: Firm selection.
- **KC (F3)**: Exit.
- **LR**: Program termination.
- **Indicators 30-99**: Used for I/O, file status, error signaling, working, and subroutine control.

---

## 7. Integration and Extension Points

The program integrates with:
- **QSPRILSP**: IBM API to get spool file attributes.
- **AP627R**: External program for XML file creation (report archiving).
- **AP621R**: External program to preview PDFs.
- **Job ending programs** (e.g., AB710R).

---

## 8. Version/Change Management

The source shows a versioned change log, with major enhancements for:
- Archiving support and PDF output (v6.30).
- Increased field sizes for amounts (v6.32).
- Changed order of printer file close, etc.

---

## Summary Table

| Section  | Purpose                                  |
|----------|------------------------------------------|
| H/F/D-spec | Configuration and file/data declaration|
| Main     | Reads transactions, groups by journal, sums, prints/report differences |
| Subroutines | Spool file query, XML creation, PDF handling, Initialization |
| Indicators | Standardized usage for program control |
| Integration | IBM APIs and external business logic  |

---

## Key Takeaways for Onboarding

- **Main logic**: Grouping and reporting journals with differences, with options for archiving and digital formats.
- **Output**: Report to printer, optional XML/PDF creation.
- **Integration**: Calls external programs for archiving and output, interacts with IBM i spool files.
- **Indicators**: Used intensively for control logic—familiarize yourself with the usage table.
- **Extensions**: Easily extendable for more meta-data, output types, or error handling.

---

**If you need to work on this program:**  
- Focus first on understanding the file structures and indicator usage.
- Pay attention to how journal differences are detected and reported.
- Review external programs (AP627R, AP621R) if you need to modify archiving/PDF output.  
- The subroutine structure keeps output and integration logic modular.

---

**For any specific area (e.g., XML creation, spool file handling), dive into the corresponding subroutine.**