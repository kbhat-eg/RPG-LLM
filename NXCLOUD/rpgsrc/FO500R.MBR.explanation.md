# RPG Program FO500R – Comprehensive Code Explanation

This RPG (Report Program Generator) code is a classic IBM i (AS/400, iSeries) ILE RPG program, used for customer order inquiry, search, and management. The code includes features for handling orders (spørring/søking etter ordre), using subfiles for display, integrated user access control, order status management, and multiple filtering/sorting/searching options.

This explanation is structured to help both new and experienced developers quickly understand the architecture and logic.

---

## 1. **Program Purpose and Metadata**

- **Program:** FO500R
- **System:** ASOFAK
- **Description:** Inquiry and search for orders, allowing users to display, update, copy, delete, and otherwise manage orders.
- **Development History:** The extensive comment header provides a detailed change log indicating regular enhancements, bug fixes, and new requirements over many years.

---

## 2. **File Declarations**

The `F` specs declare files (physical/logical) the program uses, primarily order and customer files, most of which are renamed for local use:

```rpg
ffohelr    if   e           k disk    rename(fohepfr:fohelrr)    // Order header file (main)
ffohel1    if   e           k disk    rename(fohepfr:fohel1r)    // Order header (logical)
...
ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)    // User register
...
ffo500d    cf   e             workstn sfile(b1sfl:w_srrn)       // Display file, subfile
...
```

Files have different purposes:
- **Order files:** Hold headers, details, types, statuses, etc.
- **Customer files:** Store customer master data.
- **User files:** Store user permissions, control settings.
- **Deposit files:** Used for deposit/prepayment management.
- **Display/workstation file:** For screen I/O and subfile handling.

---

## 3. **Indicator Usage**

The program assigns special meanings to RPG indicators (`*INxx`):

- LR: Last record, end of program
- 10–15: Subfile paging, clear, end, cursor control
- 30: Protect fields
- 31–79: Error, warning, or local logic indicators
- 80–99: Work indicators

---

## 4. **Key Data Structures and Variables**

### **Local Data Area / SDS / Feedback**

- **LDA Variables:** Hold current session user, firm, etc.
- **SDS (Program Status Data Structure):** Used for program and library identification.
- **Display Feedback:** For cursor positioning.

### **Working Variables**

- **w_firm:** Current company/firm code from LDA.
- **w_numm, w_suff:** Current order number and suffix.
- **b1numm, b1suff:** Subfile fields for orders.

### **Indicators:**
- `b_forn, b_anul, b_feil, b_stop, b_exit, b_depo, etc.`: Logical flags for controlling flow, status, errors, etc.

---

## 5. **Subfile Logic (Display File Controls)**

The program makes extensive use of subfile (screen list) techniques, including:
- **Display, build, clear, page, and manage multiple subfile records.**
- **w_fcrn, w_srrn, w_spge, etc.:** Variables for subfile page management and record navigation.

---

## 6. **Main Processing Loop**

The code’s main control structure is a loop continually displaying the subfile and handling user input/actions.

### **Key Steps:**
1. **Display subfile (exsr dsp_subfile)**
2. **Respond to function keys (F1=Inquire, F2=Range, F6=Create, etc.)**
3. **Parse user actions per subfile row (select/case on b1valg):**
   - Edit, copy, delete, print, view order, select for picking, see history, etc.
4. **Call subroutines or external programs as required for each action.**
5. **Rebuild or update the subfile as needed.**

---

## 7. **Filtering, Search, and Positioning**

### **Positioning Logic (`posisjoner`):**
- Allows the user to position the subfile view by order number, order type, customer name, order date, etc.
- Supports free-text search and advanced SQL search filters (since v7.x).

### **Search Routine (`crt_subfile`):**
- Builds the subfile by reading from order files, with possible filtering by SQL queries (including fuzzy/free-text search).
- Handles "next page" (forward) and "previous page" (backward) logic for scrolling subfile pages.

---

## 8. **Subfile Options: Actions per Order**

Users may select actions for each order in the subfile:
- **Edit (2):** Opens maintain order program.
- **Copy (3):** Calls logic to copy order, checks for various business rules (deposits, credit, order type, etc.).
- **Delete (4):** Handles both regular and conditional deletion, checks for dependencies (e.g., deposits).
- **View (5):** Shows detail.
- **Print (6):** Printing logic, with checks for required data.
- **History (10):** Calls order history inquiry program.
- **Special (16, 18, 26, etc.):** Handling picking/bestilling, flag management, advanced options.
- **Information code management (98, 99):** Set/release "hold" on order, manage info codes.

---

## 9. **Business Rules and Validations**

The code enforces complex rules:
- **User Access:** Per user, per order type, per action (edit/print/delete/copy, etc.)
- **Order Status:** Orders may be locked, held, picked, etc.; some actions are blocked accordingly.
- **Credit Checking:** Prevents copying/creating/printing for customers over credit limit.
- **Deposit/Prepayment:** Orders with unpaid deposits may not be deleted.
- **Order Dependencies:** Orders with links to deliveries, bestilling (purchase orders) or suggestions cannot be deleted without further checks.

---

## 10. **Supporting Subroutines**

### **Most important routines:**
- **forny:** Refresh/rebuild subfile.
- **subfile:** Main loop for subfile line processing.
- **xsjekk_inp:** Input field validations.
- **apo_subfile / ajo_subfile:** Update subfile row after external program call.
- **xfarge:** Assign colors to order info based on code/status.
- **finn_best:** Finds associated purchase order number from order lines.
- **lagring:** Save user filter/sort selections.

### **Exit/Return:**
- **Program exits cleanly by setting *INLR = *ON.**

---

## 11. **External Program Calls**

The program delegates actions to external programs for major business functions:
- **FO100R:** Order maintenance/create/edit
- **FO310R:** Order copy
- **FO410R:** Order delete
- **FO600R, FO604R, FO505R:** Printing, viewing, reports
- **FO710R, FO720C, FO736R, FU500R, etc.:** Specialized business logic (handling picking, history, logging, etc.)
- **CO402R:** Properties/configuration (feature switches)
- **AA005R, AA007R:** Message display and confirmation dialogs.
- **SQL procedures:** For dynamic subfile search.

---

## 12. **Configurable Features**

The program loads several feature switches at startup using CO402R, enabling/disabling features (like extended memosaldo, GUI compatibility, Excel export, logging, advanced picking, etc.) on a per-company/firm basis.

---

## 13. **User Experience: Screen Functionality**

- **Subfile navigation:** Next/previous page, search, filter, and positioning by type, number, customer, etc.
- **Function keys and options:** Allow for efficient navigation, filtering, and action without mouse.
- **Safety checks and messages:** User is always warned about actions with impact (delete, override credit limits, override holds, etc.) and sometimes required to confirm.

---

## 14. **Modernization Additions**

- **SQL-based free-text search:** For better searching/filtering.
- **Excel export:** Allows exporting subfile lists or order lines.
- **GUI adaptation / Newlook compatibility:** Cleanses output for modern display clients.

---

## 15. **Summary Table of Important Subroutines / Actions**

| Subroutine        | Purpose                                                      |
|-------------------|--------------------------------------------------------------|
| forny             | Refresh current subfile page                                 |
| posisjoner        | Position subfile to selection/filter                         |
| subfile           | Main loop for subfile row actions                            |
| xsjekk_inp        | Validate input fields                                        |
| xsjekk_ord1       | Check if order is already active/locked                      |
| xsjekk_paks       | Check if user may edit packing slip/invoice                  |
| ajo_subfile       | Update/refresh subfile row after action                      |
| xb3win            | Handles copy action (w/credit, deposit, user checks)         |
| xb4win/xb4wint    | Handles deletion (w/deposit, bestillingsforslag checks)      |
| xb6win/xb16wi     | Handles printing/picking options                             |
| sjekk_depo        | Calculates deposit requirements/flags                        |
| newlo_vask        | Cleanses output for modern GUI clients (Newlook)             |

---

## 16. **Key Takeaways for New Developers**

- **Complexity:** The code is large and detailed due to decades of enhancements and an extensive ruleset.
- **Structure:** Main loop processes user actions per subfile row, subroutines organize business logic, and subfiles are the central display mechanism.
- **Externalization:** All real business work is delegated to external programs, making this program a controller/coordinator.
- **Customization:** User, firm, order type, and property-based configurability is built-in.
- **Error/Warning Handling:** Frequent use of message subroutines and indicators for validation, error reporting, and coloring.
- **Documentation:** The header and inline comments are very descriptive—use these often when onboarding.

---

## 17. **Onboarding Tips**

- **Understand Subfiles:** Learn how subfile paging, positioning, and refresh logic works in RPG.
- **Study External Code:** You must also reference external programs (e.g., FO100R, FO310R, FO410R) for business rules.
- **Test Filters:** Practice various sorts/filters/positionings to see how user input affects the subfile display.
- **Trace Indicators:** Know which indicators (INxx) are for which conditions—this is essential for debugging.
- **Review Feature Switches:** CO402R settings alter program behavior significantly.

---

## 18. **Conclusion**

This program is a robust order management front-end for IBM i, built with flexibility, user safety, access control, and extensibility in mind. The code structure, logic, and documentation practices are classic RPG, but with clear strategies to modularize, externalize, and modernize wherever feasible.

---

This explanation should provide a solid foundation to begin working with FO500R. Consult the header change log and embedded comments for detailed business context and rationale for each enhancement.