# RPG Program Explanation: FP409R

---

## Overview

This RPG program, named `FP409R`, is designed for the IBM i (AS/400) platform. Its purpose is to **delete special prices** (spesialpriser) from the system, specifically for a given **discount category** (rabattkategori) or **customer** (kunde). The program also deletes related "special price notes" (spesialpris notat) where relevant.

The code uses old-style fixed-format RPG with a number of disk files declared, and it accepts parameters to specify the scope of its deletions.

---

## Header and Meta Information

- `h option(*nodebugio) datedit(*dmy)`  
  Specifies compile options: disables debug IO, sets date format.

- The commented section at the top lists the system, program name, description, version history, and modification log.  
  **Main Points:**  
  - Deletes special prices for discount categories and customers.
  - Also deletes related notes.
  - Written/enhanced by "HKO".

---

## File Declarations

These `F`-specs declare the database tables used by the program:

- `fprilu` - Main file for discount category special prices.
- `fpril3` - Special prices by customer.
- `fprnlu` - Special price notes.
- `ra30l1` - Holds discount category (price group) keys.

Each has `uf` (user open), `e` (external description), `k` (keyed), and `rename()` as appropriate to rename the record format.

---

## Parameter and Variable Definitions

- Program parameters:
    - `p_firm` (Company code)
    - `p_rkat` (Discount category)
    - `p_kund` (Customer)
- Variables for keys/fields, matching file structures, e.g. `fprilu_prgr`, `fprilu_rkat`, etc.
- `w_firm`: working variable for the company, set from input.

---

## Main Logic

### 1. Delete Special Prices for Discount Category

```rpg
     c                   if        p_rkat <> 0
         * Loop over all price groups for the given discount category
         * For each, delete all matching special prices in fprilu
     c     ra30l1_key    setll     ra30l1
     c     ra30l1_key    reade     ra30l1
     c                   dow       not %eof(ra30l1)
     c                   eval      fprilu_prgr = redkod
     c                   eval      fprilu_rkat = p_rkat
     c     fprilu_key    setll     fprilu
     c     fprilu_key    reade     fprilur
     c                   dow       not %eof(fprilu)
     c                   delete    fprilur
     c     fprilu_key    reade     fprilur
     c                   enddo
     c     ra30l1_key    reade     ra30l1
     c                   enddo
     c                   endif
```

- **What it does:**  
  If a discount category (`p_rkat`) is specified, for each price group (`ra30l1`), delete all special price records in `fprilu` that match the price group and discount category.

---

### 2. Delete Special Prices for Customer

```rpg
     c                   if        p_kund <> 0
     c                   eval      fpril3_kund = p_kund
     c     fpril3_key    setll     fpril3
     c     fpril3_key    reade     fpril3r
     c                   dow       not %eof
     c                   if        fpkpro = 0
     c                   delete    fpril3r
     c                   eval      fprnlu_nkun = fpkund
     c                   eval      fprnlu_nkpr = fpkpro
     c                   eval      fprnlu_nvar = fpvare
     c     fprnlu_key    chain     fprnlur
     c                   if        %found
     c                   delete    fprnlur
     c                   endif
     c                   endif
     c     fpril3_key    reade     fpril3r
     c                   enddo
     c                   endif
```

- **What it does:**  
  If a customer (`p_kund`) is specified, for all special prices for that customer in `fpril3`, if `fpkpro` (probably "price group") is zero (which seems to indicate a special-price-by-customer, not by group), delete:
    - The `fpril3r` record (special price for customer)
    - The note record (`fprnlur`) if found (using fields from the just-read record)

---

### 3. Program End

```rpg
     c     avslutt       tag
     c                   eval      *inlr = *on
     c                   return
```

- **What it does:**  
  Set the last record indicator (`*inlr`) to end the program and `return` to caller.

---

## Initialization Subroutine (`*inzsr`)

- Defines the incoming parameters with the `plist` (parameter list) and associates them (`parm`) to the working variables.
- Builds key lists (`klist`/`kfld`) for the files to enable keyed operations throughout the program.
- Transfers the input company code into the working variable `w_firm` for later use.

---

## Detailed Workflow Summary

1. **At program start:**  
   - *Initialization subroutine* runs, reading input parameters and defining file keys.

2. **Delete by Discount Category:**  
   - If a discount category is passed in, for all groups in `ra30l1`, delete all `fprilu` records for that category/group.

3. **Delete by Customer:**  
   - If a customer is passed in, for all special prices for that customer in `fpril3`:
       - If the price group is zero (i.e., not to a specific group), delete both the price and any associated note (`fprnlu`).

4. **Finish:**  
   - Set last record indicator to close files and exit program.

---

## Business Context

- **Main Purpose:** Housekeeping utility that allows *removal of all special pricing* for a given discount category and/or a customer.
- **Typical Scenarios:** When a customer or category contract is expiring, or cleanup is required.

---

## Key Points for New Developers

- All file accesses are keyed and handled with explicit setll/reade or chain/delete cycles.
- The program can be run for either or both types of deletion depending on input parameters.
- Be cautious with mass delete logic; ensure proper backup/authorization before use.
- All relevant keys are set up in the *inzsr section.
- Code is written in legacy (fixed-format) RPG IV.

---

## File/Field Legend

| File      | Purpose                                   | Aliased Format |
|-----------|-------------------------------------------|---------------|
| fprilu    | Special prices (by category/group)        | fprilur       |
| fpril3    | Special prices (by customer)              | fpril3r       |
| fprnlu    | Special price notes                       | fprnlur       |
| ra30l1    | Lookup for price groups/categories        | ra30l1r       |

---

**In summary:**  
This is a batch housekeeping program to delete special prices and related notes for either a given discount category or customer, accepting company, category, and customer as parameters. Logic is centered on keyed reads and deletes over 3-4 linked files.