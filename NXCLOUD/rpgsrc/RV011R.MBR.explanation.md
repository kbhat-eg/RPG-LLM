# RPG Program Explanation

This RPG program (RV001R) is a traditional ILE RPG (RPG IV, pre-free format) batch program for IBM i (AS/400). It processes records from an invoice line file (`FOVF`/`lovfl1`), gathers related information from various master files, and formats the results as CSV (comma-separated values) records to be written to an output file.

The code is widely commented in Norwegian, with variable names and logic reflecting accounting and invoicing concepts. Below, the code is explained section by section.

---

## Header Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
h decedit('0.')
```
- `*nodebugio`: Excludes input/output operations from debug information.
- `datedit(*dmy)`, `decedit('0.')`: Sets date and decimal editing.

---

## File Declarations

```rpg
flovfl1    ip   e           k disk
fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
faforl1    if   e           k disk    rename(aforpfr:aforl1r)
frb10l1    if   e           k disk    rename(rb10pfr:rb10l1r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
frb00l1    if   e           k disk    rename(rb00pfr:rb00l1r)
frv01pf    o    e           k disk
```
- Input files: `lovfl1`, `sohel1`, `votyl1`, `aforl1`, `rb10l1`, `rlevl1`, `rb00l1` (all probably master/transaction files).
- Output file: `rv01pf`.
- Several input files are renamed for local data structure referencing.

---

## Data Declarations

### Local Data Area and Work Variables

```rpg
d                uds
d l_firm                944    946  0
...
d w_pste          s             30
d xxbilk          s              5  0
...
d w_dato_alf      s              6
d w_dato_al1      s              6
d w_dato_al2      s              6
```
- `l_firm` is loaded from the User Data Space (local data area) - contains the company number.
- Many work fields for constructing output and holding intermediate values:
    - Dates (`w_dato_*`)
    - Numbers, names, codes, etc.

### Data Structures

- Several data structures for date handling (`d_fdat`, `d_fdati`, `d_date`, `d_dati`) split dates into components.
- Data structure for "poststed" (post location): `d_pste`.
- Key fields for record lookups in other files.

---

## Input Validation and Field Initialization

```rpg
c                   if        l_firm <> lgfirm
c                   goto      slutt
c                   endif
c* Blanker felt
c                   eval      d_dati  = *blanks
...
```
- Checks if the `lgfirm` (current recordâ€™s company) matches the company number this run is for (`l_firm`). If not, ends processing with `goto slutt`.
- Initializes all work fields to blanks/zeros for each record.

---

## VAT Code (Moms kode) and Conversion

```rpg
c                   if        lgdmom = *blank
c                   eval      w_mkod = lgcmom
c                   else
c                   eval      w_mkod = lgdmom
c                   endif
c                   move      w_mkod        w_mkodn
...
c     rb00l1_key    chain     rb00l1
c                   if        %found
c                   move      r00nko        w_mkodn
c                   endif
```
- Determines VAT code: if the line VAT code (`lgdmom`) is blank, uses the header VAT code (`lgcmom`).
- Attempts to convert VAT code to another code using the `rb00l1` file (code conversion table).

---

## Date Handling

```rpg
c                   move      lgbdat        d_dati
...
c                   move      d_date        w_dato_al1
...
c                   move      lgfdat        d_fdati
...
c                   move      d_fdat        w_dato_alf
c                   move      udate         w_dato_al2
```
- Parses and moves dates between fields and data structures for output formatting purposes.

---

## Lookup and Data Enrichment

```rpg
c                   exsr      control_init
```
- Calls subroutine `control_init` which retrieves and parses related information (mainly about the supplier) from other master files.

---

## Voucher (Bilagstype) Code Conversion

```rpg
c                   eval      xxbilk = lgbilk
c                   eval      rb10l1_gkod = lgbilk
c     rb10l1_key    chain     rb10l1
c                   if        %found
c                   eval      xxbilk = rankod
7.04 c                   else
7.04 c                   eval      w_firm = *zeros
7.04 c     rb10l1_key    chain     rb10l1
7.04 c                   if        %found
7.04 c                   eval      xxbilk = rankod
7.04 c                   endif
c                   endif
```
- Converts the voucher type using the `rb10l1` file (probably a mapping table), with special logic for company "000".

---

## Output Construction

```rpg
c                   eval      rvdata = *blank
...
c                   eval      rvdata =  %char(1)        + ',' +
     ...
c                   write     rv01pfr
```
- Builds the output CSV line in `rvdata` using the gathered and calculated information, taking care to wrap textual fields in quotes and format as required.
- Calls `write` to output the assembled record to the output file.

---

## Subroutine: control_init

```rpg
c     control_init  begsr
...
c                   eval      rlevl1_levr = lgkund
c     rlevl1_key    chain     rlevl1
...
```
- Fetches supplier (levre) information from the `rlevl1` file using the supplier number from the invoice line.
- If the name fields contain a comma, splits the string into two parts (surname and firstname) for better formatting.
- Handles similar logic for the "alfa" field (alphabetic search name).
- Reads "routine" and "kid" (customer ID) information from order type and routine master files.
- For certain types, calls an external program (`AK710R`) to generate or retrieve an alternate KID number.

---

## Subroutine: *inzsr ("initialization")

```rpg
c     *inzsr        begsr
...
```
- Defines key lists for file lookups (i.e., composite keys for record lookup using `chain`).
- Sets initial value for the company number.

---

## Key Points / Takeaways

- **File I/O**: Reads data from a main transaction file and various master data files, enriching invoice line info.
- **Data Conversion**: Converts codes and fields using mapping files.
- **CSV Output**: Assembles a comma-separated output record with many fields, handling dates, text, and numeric fields.
- **Subroutines**: Uses subroutines for code lookup logic and for extracting/formatting related data.
- **Legacy Style**: The program uses fixed-format RPG and old-style subroutine/call/field handling. The business logic is tailored to Norwegian accounting/invoicing standards, with specific attention to field mapping and code translation.

---

## Typical Flow

1. **Input Validation**: Only process records for the correct company.
2. **Initialization**: Blank out work fields.
3. **Field Calculation/Preparation**: Parse dates, set VAT codes, etc.
4. **File Lookups**: Enrich data by looking up master files for supplier names, addresses, etc.
5. **Output Construction**: Format all fields into a CSV line, taking care of field specifics (quotes, special conversions).
6. **Write Output**: Write the assembled line to the output file.

---

## Comments

- The program has many "commented out" sections (`*` at line start), showing prior logic for handling alternate addresses, etc.
- Some code was added in version 7.04 to handle certificate code lookups for company '000'.
- All logic is heavily dependent on correct file relationships and data definitions.
- Extensive use of substring/scan logic to split names and fields for proper output formatting.

---

## Onboarding Tips

- Familiarize yourself with the master files and their keys, as most lookups are composite (company + code/number).
- Understand the external subprograms (e.g., `AK710R`) and their roles in KID generation.
- Pay careful attention to field lengths and numeric/textual conversions, as legacy RPG is strict about buffer overruns.
- This program would benefit from refactoring into /free-format RPG or even SQL-RPGLE for maintainability and modern best practices.