# Explanation of IBM ILE RPG Source Code: RH621R

This RPG program generates a balance summary report (Norwegian: "Hovedbok - saldobalanse - utskrift") with categorizations per account, department, and cost bearer, with support for comparison against budget, prior year, alternative budget, and averages. The program can output to PDF/XML and contains advanced break processing and subtotaling at several levels.

Below is a structured walkthrough of the program's main logic, file handling, data structures, and key processing routines.

---

## 1. Program Structure and Purpose

- **Purpose**: Produces a balance summary report for the general ledger ("saldobalanse") with options for sorting and subtotaling by account, department, or cost-bearer. Compares current year results against budget, previous year, alternative budget, or averages. Handles both standard spool print and (optionally) triggers PDF/XML output.
- **Comments/History**: Extensive change history is recorded in the header, showing feature and field additions/layout changes over many years.

---

## 2. File Declarations

### Input Files:

- **rhsal1, rhsal2, rhsal3**: Input files representing the balance register, each sorted differently (by account, department, cost-bearer).
  - These are declared with `rename()` to local record formats (rhsal1r, rhsal2r, rhsal3r).
- **rhovlr**: The chart of accounts (kontoplan) register.
- **ra28lr**: The cost-bearer register.

### Output File:

- **rh621p**: The printer file for report output. Optionally opened (usropn), with overflow indicator.

### Special Handling:

- *pdf* labeled blocks and fields handle PDF/XML innovations and output integration.

---

## 3. Data Structures and Variables

The program uses a mix of standalone fields, arrays, and overlayed data structures for managing break keys and subtotals.

### Break Structures:

- **nybrd, gmbrd**: DS fields holding current/new and previous break combinations for department (avd), account (kto), group (grp), class (kla), cost-bearer (sps).
- *Overlays* allow breaking down combined keys into subfields for hierarchical subtotaling.

### Totals:

- Arrays for holding period and year-to-date totals across 13 periods, for various subtotaling levels (L1 through L5).
- Many fields for holding subtotals (l1beår, l2bevp, l3samp, etc).

### Auxiliaries:

- Arrays and fields for managing department selection, cost-bearer selection, report headings, and comparisons.
- Report texts are retrieved from related tables or registers dynamically.

### PDF/XML Integration:

- Variables for spool file management, job/user names, and meta tags are declared for PDF/XML output.

---

## 4. Main Logic

### a. Initial Setup (`*inzsr` Subroutine)

- Opens output file (for PDF).
- Initializes counters and totals.
- Sets up control indicators based on parameters, such as comparison mode, output format, and sorting.
- Loads department selection into work arrays for filtering.
- Retrieves initial texts for departments and cost bearers for headings.

### b. Main Processing Loop

- **Step 1**: Select appropriate input file (sorted by account, department, or cost-bearer).
- **Step 2**: Loop through records, for each:
  - Extract/control the break values.
  - Apply year/account/cost-bearer filters.
  - Filter on department selection (either a range or explicit table).
  - On a detected break (change in break key between records), invoke relevant subtotal/break subroutines: 
    - `brhel` (whole key), then possibly `brkto` (account), `brgrp` (group), `brkla` (class), `bravd` (department), `brsps` (cost-bearer).
  - Compute and accumulate period and YTD totals at the lowest level via `rsum`.
  - Move current break keys to 'previous break' fields for next iteration.

- **After loop ends**: Process remaining totals at all break levels and produce final summaries (footer, last page).

### c. Break and Subtotal Handling Subroutines

At each break level, the corresponding routine:
- Computes subtotals for that level.
- If enabled, writes out subtotal lines.
- Rolls subtotals up to the next higher level.
- Nullifies the lower-level subtotal work fields for reuse.

Break levels proceed from most detailed (account) upward:
- `brkto` (account)
- `brgrp` (group)
- `brkla` (class)
- `bravd` (department)
- `brsps` (cost-bearer)

### d. Special Routines

#### `rsum` / `hsum`
- Calculate sums for the present record, for both the current period and YTD, and accumulate in subtotal fields.

#### `brhel`
- Handles 'whole key' break, determines which comparison logic to use (budget, alt. budget, last year), sets up differences, triggers possible "used/achieved" calculation, retrieves descriptive text.

#### `brkto`, `brgrp`, `brkla`, `bravd`, `brsps`
- Handle break processing at account, group, class, department, and cost-bearer level, respectively.
- Each calls a code-register retrieval program (e.g., RS707R for department, RS728R for cost-bearer) to get display texts for headings.

#### `sr_forst`
- One-time initialization per report/run to fetch initial department or cost-bearer texts and write the heading.

#### `brukt`
- Calculates percentage "used/achieved" (differential against target), with protection against division by zero, capping at defined min/max values.

#### PDF/XML Subroutines
- `spoolnbr`: Finds the spool file generated by the job.
- `xml_create`: Invokes external program to generate XML from the spool, passing meta tags.
- `pdf_preview`: Launches PDF browser for preview.

---

## 5. Key Algorithmic Features

- **Break/Control Processing**: Uses overlay fields and composite keys to manage multi-level breaks for subtotaling at various aggregation levels. Logic resets and accumulates subtotals as breaks are detected.
- **Dynamic Filtering**: Handles both range-based and table-based (explicit list) filtering for departments/cost-bearers.
- **Comparison Flexibility**: Compares against different targets (budget, previous year, average, alt. budget), set by parameter and enforced throughout break logic.
- **Internationalization/Integration**: Texts pulled dynamically from various code tables for accounts, departments, classes, groups, and cost-bearers.
- **PDF/XML Output**: Modern features allow for integration with PDF/Jasper output and web browser preview.
- **Parameterization**: Extensive use of runtime parameters to alter sort order, selection, break logic, output mode, and comparison basis.

---

## 6. Special Notes

- **Code Page Stuff**: Some variables (e.g., field names with "å", "ø", "æ") show up as corrupted (e.g., `rhpb�f`, `rhpspa`) — these are likely originally Scandinavian field names for cost-bearer, etc.
- **Labels**: Lines with tags like `T5.50`, `pdf`, `6.20` denote changes for release/history tracking.
- **Subroutine Markers**: Classic fixed-format RPG subroutine usage — `begsr`/`endsr`.

---

## 7. High-Level Flowchart

1. **Initialize**: Setflags, read parameters, open files.
2. **Select Input Source**: By account, department, or cost-bearer.
3. **Read Record → Apply Filters → Detect Breaks**:
   * If passes filters:
     * If first record: initialize
     * If break detected: subtotal, print, roll up, reset
     * Always: accumulate in lowest-level subtotal fields
   * Advance to next record
4. **End-of-File**: Flush last breaks, print trailer.
5. **PDF/XML Output**: If enabled, generate files and preview.
6. **End**: Set LR on, exit.

---

## 8. For New Developers

- **Domain Knowledge**: Familiarity with accounting terms (saldo, debet/kredit, budsjett, kostnadsbærer) and Norwegian terminology will help.
- **File Structures**: Understand the logical structure of input files (accounts, departments, cost-bearers) and their key fields.
- **RPG Syntax**: This is classic RPG IV (ILE RPG), with some /Free blocks for special routines.
- **Break Handling**: The "break logic" (grouping/subtotals on field change) is central — overlays and move/eval/chain statements are key.
- **Integration Points**: Note calls to external programs (RS707R, RS719R, etc.) for retrieving text, and AP627R for XML export.
- **PDF/XML**: Modern features are handled in labeled blocks, segregated by `pdf` tags.

---

## 9. Summary Table of Key Subroutines

| Subroutine  | Level/Function                         | Details                                                   |
|-------------|---------------------------------------|-----------------------------------------------------------|
| `rsum`      | Lowest-level subtotal                 | Accumulates period and YTD for current record             |
| `brhel`     | All-key break                         | Computes high-level subtotal, triggers comparison logic    |
| `brkto`     | Account break                         | Subtotal and output for each account                      |
| `brgrp`     | Account group break                   | Group subtotal/output                                     |
| `brkla`     | Class break                           | Class subtotal/output                                     |
| `bravd`     | Department break                      | Department subtotal/output                                |
| `brsps`     | Cost-bearer break                     | Cost-bearer subtotal/output                               |
| `skriv`     | Output heading                        | Writes report headers                                     |
| `sr_forst`  | First-record setup                    | Gets department/cost-bearer text, prints first heading    |
| `brukt`     | "Used/Achieved" percent calculation   | Handles division-by-zero and capping                      |
| `spoolnbr`  | PDF integration                       | Finds spool file information for PDF/XML export           |
| `xml_create`| PDF/XML integration                   | Calls external report export program                      |
| `pdf_preview`| PDF integration                      | Launches browser-based PDF preview                        |

---

## 10. Closing Remarks

This is a mature and sophisticated RPG reporting program, well-suited for financial reporting and with extensive customization and output options. Onboarding will be greatly eased by:
- Studying the data model (file layouts, record keys).
- Practicing break and subtotal logic in RPG.
- Reviewing the various comparison and filtering parameters.
- Understanding integration with external code tables and tools for output enhancement.

**Tip:** When enhancing or troubleshooting, pay close attention to how break fields are compared and handled, as well as how parameters steer the logic (comparison mode, sorting, PDF/XML output, etc.).