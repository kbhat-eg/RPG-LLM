# RPG Program JM700R – Campaign Price Maintenance

This program is written in RPG IV (ILE RPG) and is used for maintaining special campaign prices for products (varer). It either creates or updates campaign price records based on given parameters, which can include discounts and various price types. The program handles the calculation of prices based on input discounts and/or explicit prices.

---

## Header and Metadata

- **H Spec:**  
  `H OPTION(*NODEBUGIO) DATEDIT(*DMY)`  
  - Disables debug I/O.
  - Sets date edit to Day/Month/Year format.

- **Comments/Changelog:**  
  The comment block at the top lists the history of the program, author, and change descriptions (in Norwegian).

---

## File Declarations

- `FJKAVLU`  
  - Update, full procedural, disk file (likely campaign items).
  - External data structure, renamed as `JKAVLUR`.
- `FJVPRL1`  
  - Input-only, external, disk file (likely product price list).
  - Renamed as `JVPRL1R`.

---

## Data Declarations

### Parameter Variables

Variables declared from the parameter list (with `D` spec), for campaign/price calculations:

- **User and discount fields:**  
  `P_USER`, `P_RABA`, `P_RAB1`, `P_RAB2`, `P_PSLK`, `P_PSLS`
- **Fields for campaign context:**  
  `P_FIRM`, `P_KAMP`, `P_PRGR`, `P_LDOR`, `P_PLDO`, `P_VKAI`, `P_VKPR`, `P_VKAA`, `P_VARE`

### Key and Temporary Variables

- Used for keys and work fields in the logic:
  - `JKAVLU_VKAM`, `JKAVLU_VPRG`, `JKAVLU_VVAR`
  - `JVPRL1_LDOR`, `JVPRL1_VARE`
  - `W_FIRM`, `W_PRIS`, `W_UDAT`
- `B_PRIS` - Boolean for price existence (`INZ(*OFF)`).

---

## Main Program (Hovedprogram)

### Flow

1. **Initialize campaign item record**:
   - `RESET JKAVLUR`

2. **Setup key fields and attempt to chain (read) the campaign item**:
   - Set key fields from parameters (`P_KAMP`, `P_VARE`).
   - `CHAIN` using `JKAVLUR` (if found, indicator 90 is OFF; if not, it's ON).

3. **Initialize campaign price fields**:
   - Set base and calculated price fields (e.g., `JMVKAI`, `JMVKPR`, `JMVKAA`) to 0.

4. **Price calculation based on input parameters**:
   - If any of the discount params (`P_RAB1`, `P_RAB2`, `P_PSLK`, `P_RABA`, `P_PSLS`) are non-zero, call subroutine `OPPD_RAB`.
   - Else, if an explicit price (`P_VKAI`) is provided, call subroutine `OPPD_PRIS`.

5. **Set audit/user fields**:
   - Set audit fields (`JMVKAU`, `JMVLDO`, `JMVKAU`, `JMVETI`, `JMVEDA`).
   - Audit date/time fields are set with `TIME`.

6. **Update or add record**:
   - If found (`*IN90 = *OFF`), `UPDATE JKAVLUR`;
   - If not found, fill out key fields and `WRITE JKAVLUR`.

7. **End the program gracefully.**

---

## Subroutines

### 1. `OPPD_RAB` – Calculate Campaign Prices Based on Discount

- **Find base price ("Nobb"-pris)** by calling `HENT_PRIS`.
- If price not found (`B_PRIS = *OFF` or `JXPRIS = 0`), exit subroutine.
- If the found price is expired (`JXTDAT > W_UDAT` or is initial value), exit subroutine.

- **Apply discounts:**
  - If `P_RAB1` is provided, reduce base price by discount 1 (percent).
    - If `P_RAB2` is also provided, apply discount 2 to the already discounted price.
- **Cost price (`JMVKPR`):**
  - If `P_PSLK` is provided, increase `JMVKAI` by this percent. Else, set to `JMVKAI`.
- **Campaign sale price (`JMVKAA`):**
  - If `P_RABA` is provided, calculate as base price minus `P_RABA` percent.
  - If `P_PSLS` is provided, increase `JMVKPR` by this percent.

### 2. `OPPD_PRIS` – Set Campaign Price Directly from Parameters

- Set campaign price (`JMVKAI`) from input.
- Set cost price (`JMVKPR`) from input if provided, else use campaign price.
- Set sale price (`JMVKAA`) from input.

### 3. `HENT_PRIS` – Fetch Last Valid Price

- Tries to find the latest valid price for the product and date.
- Sets a flag (`B_PRIS`) to indicate if a valid price was found.
- Reads through price records in `JVPRL1` with matching key (product, date) until a valid one is found (date check with `W_UDAT >= JXGDAT`).

### 4. `*INZSR` – Initialization Subroutine

- Parameter list setup (`*ENTRY PLIST`), loads parameters to local variables.
- Builds keys for campaign and price lookups.

---

## Parameter List (`*ENTRY`)

Defines the order of the parameters passed into the program (via external call):

| Parameter | Description                       |
|-----------|-----------------------------------|
| `P_FIRM`  | Company code                      |
| `P_KAMP`  | Campaign code                     |
| `P_PRGR`  | Campaign price group              |
| `P_USER`  | Username                          |
| `P_LDOR`  | Some date (likely from parameter) |
| `P_PLDO`  | Another date (to parameter)       |
| `P_RAB1`  | Discount 1                        |
| `P_RAB2`  | Discount 2                        |
| `P_PSLK`  | Additional cost price percentage  |
| `P_RABA`  | Additional discount               |
| `P_PSLS`  | Additional sales price percentage |
| `P_VKAI`  | Campaign price (input form)       |
| `P_VKPR`  | Cost price (input form)           |
| `P_VKAA`  | Sale price (input form)           |
| `P_VARE`  | Product/item code                 |

---

## Key Lists

- **`JKAVLU_KEY`**: For campaign item lookup (firm, campaign, price group, item).
- **`JVPRL1_KEY`**: For price lookup (item, date).

---

## Business Rules & Comments

- The program is designed for maintenance of campaign prices, incorporating both discount-based and direct price-based input.
- Norwegian comments highlight business logic and change history.
- Uses both "calculated" (discount) and "manual" (direct) price input scenarios.
- Price fetching skips items with expired dates.

---

## Summary

- The program creates or updates records for campaign prices for items, based on a variety of input parameters that specify discounts or explicit prices.
- It handles all necessary calculations for discounts, cost prices, and sale prices, pulling in the current base price from the product price file.
- The program is extensible and has been modified over time to support new business needs like additional price groups and more detailed discounting logic.
- Modular and well-commented, making it maintainable and suitable for future enhancements. 

---

**Onboarding Note**:  
Familiarity with the business rules for campaign pricing and the structure of the underlying data files (`JKAVLU`, `JVPRL1`) will be essential. The program expects to be called with a full parameter list (either from a CL program or another RPG program). Calculations use percentage discounts, and care should be taken to ensure input values are appropriate and valid to avoid calculation errors.