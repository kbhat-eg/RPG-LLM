# LH601R – Purchase Suggestion Report (RPG IV)

This program reads “bestilling‐forslag” (purchase suggestion) records, formats them as a printed report or as an XML/Jasper‐driven PDF, and optionally emails or archives the output.

---

## 1. Program Header & Imports  
- H-Specs define no debug I/O, DMY date format, *No default activation group, and bind directory.  
- `/COPY hspecsbnd`, `prototypeb`, `usec` pull in shared constants, prototypes and micro‐services.

---

## 2. File Declarations (F-Specs)  
- Multiple keyed files (`IF   E   K DISK`) are defined and renamed locally.  
  - Example: `FRLEVL1` ⇒ supplier master, `FVAGL1` ⇒ stock master, `FLFDTL1` ⇒ suggestion header/detail.  
- `FLH601P` is the output printer file.

---

## 3. Data Definitions (D-Specs)  
1. **Program Parameters** (`d` DS)  
   - `d_prec` holds the range start/end and sort criteria passed in.  
2. **User Data Area** (`uds`)  
   - Local job/user parameters: output queue, archive flag, mail flag, printer form, routine code, batch number, user, company, etc.  
3. **Data Structures & Variables**  
   - Many `LIKE(file.field)` variables to hold record fields.  
   - Local numeric, date, time, control flags (`b_pdfp`, `b_topt`, `b_bott`) for switching between spool vs. XML/PDF.  
   - Varying‐length strings for XML template, path, logo.  
   - `crlf` constant for line breaks in mail body.

---

## 4. Key List Initialization (`*INZSR`)  
- Builds key lists for each file:  
  - Supplier, stock, suggestion header, line items, company info, routine info.  
- Chains to routine register (`AFORL1R`) to fetch report text.

---

## 5. Entry Point & Parameter Loading  
- Receives `w_parm` (19-char parameter string).  
- Parses `d_prec`, extracts start `d_fbes`, end `d_tbes` suggestion numbers, and sort flag.  
- Loads company, initial suggestion number into file keys.  
- Reads suggestion‐header record (`LFHELR`) to get weight/amount limits, then parameter record (`MPPALR`) for group limits.  
- Chains to status code register (`LSTSL1R`) for status texts.

---

## 6. Jasper / PDF / XML Mode Setup  
- If `l_poff = '1'`, calls `AP609R` to check report‐definition:  
  - Retrieves whether to generate PDF, which XML template (`d_xmlm`), and dataset name.  
- If valid, sets `b_pdfp = *ON` and runs `xml_envm` subroutine to emit opening XML/Jasper environment tags.  
- Otherwise defaults to printer‐spool output (`b_pdfp = *OFF`).

---

## 7. Main Processing Loop  
1. **Heading Subroutine**  
   - Called once per new suggestion number.  
   - Chains supplier record to fetch name, sets header fields, then either:  
     - `WRITE A1HDR` (printer)  
     - or `xml_head` (XML/Jasper setup).  
2. **Detail Loop**  
   - `DOW *IN90 = *OFF` – loop until end of file.  
   - For each `LFDTL1` (suggestion line) record whose suggestion number is within the start/end range:  
     - Calls `det_sub`.
3. **det_sub Subroutine**  
   - Chains `VAGL1` (stock master) to get min/max/pack/ABC code.  
   - Calculates available quantity, optional manual flag.  
   - Calls `les_lagr` to sum on‐hand across all bins of same item.  
   - Optionally calls `les_oms` (commented out) to compute 3-month turnover.  
   - Moves fields into detail format `D1DET` and either:  
     - `WRITE D1DET` (printer)  
     - or `xml_deta` (XML/Jasper line).  
   - Increments `T1POST` (detail count).  
4. **Total & End**  
   - After loop, writes `T1TOT` (printer) or `xml_total`.  
   - If XML/PDF mode: calls `xml_endsuggl`, `xml_end`, writes XML to IFS, may call mail or archive tags, then `pdf_preview` for browser preview, and finalizes with `AB710R`.

---

## 8. Inventory & Statistics Subroutines  
- **les_lagr**  
  - Reads all `VAGL1` records matching item, sums `VLBEHL` into `D1TOTL`.  
- **les_oms** (version 6.10, commented)  
  - Computes `D1OMS3` turnover over last 3 months via call to `AX711R` + reading `SSTALI`.

---

## 9. XML / Jasper Integration Subroutines  
- **xml_envm** – emits `<Environment>` section, sets batch no, credentials, template, logo, spool, etc.  
- **xml_head**, **xml_deta**, **xml_total**, **xml_endsuggl**, **xml_end**  
  - Use `UpdHTMLVar()` to bind variables, then `WrtSection()` to output XML fragments for heading, detail lines, totals, and closing tags.  
- **pdf_preview** – calls `AP621R` to launch PDF in browser.  
- **Archive tags**  
  - In `xml_end`, if `l_arch=1`, outputs `<ArchiveCommand>` with meta‐tags for user, date, supplier, routine, company, reference no, etc.

---

## 10. Exit & Cleanup  
- Sets `*INLR = *ON` to close files, deallocate storage, and end the job.

---

### Key Takeaways for Onboarding  
- **Mode switch** based on a “Jasper” flag in routine‐register: either legacy spool or modern XML→PDF pipeline.  
- **Data access** via keyed file reads (`READ`, `CHAIN`), in a procedural, subroutine‐driven style.  
- **Extensible**: many enhancements tagged by version (6.10, 6.20, etc.), especially around XML, mail handling, and extra fields.  
- **Separation of concerns**:  
  - I/O and record selection in main loop.  
  - Calculation (availability, totals) in small subroutines.  
  - Output formatting split between printer datalayouts and XML/Jasper sections.