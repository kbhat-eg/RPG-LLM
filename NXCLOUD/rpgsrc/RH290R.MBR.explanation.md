# Program RH290R Documentation

## Overview

**Program Name:** RH290R  
**System:** ASOKON  
**Description:**  
This program handles the update of a balance matrix parameter. It is primarily a screen-based interactive program designed to validate and store period (year) and date parameters for subsequent batch or reporting processes. The program ensures that the accounting year entered is valid and provides user confirmation if the year exceeds the current system year.

---

## Key Files and Data Structures

- **AUSRL1** (DISK): User master file, accessed by key to retrieve user-related information.
- **RH290D** (WORKSTN): Display file for user interaction (screens A2BLD and M1WIN).

### Key Variables

- **a2pkda**: Date parameter (presumably the current or selected date).
- **a2prår**: Year parameter (accounting year).
- **l_user, l_firm, l_fnav**: User ID, firm number, and firm name from the user record.
- **w_user, w_firm**: Local working copies of user and firm.
- **p_in03**: Parameter indicating if the user exited via F3.
- **var**: Warning message texts (2 lines, loaded from compile-time data).
- **wsavli, wsavpo**: Window row/column for message display.

---

## Indicator Usage

- **KC (F3)**: Exit key (user cancels or exits).
- **LR**: Last record (program end).
- **30**: Protect fields during display.
- **31-59**: Warnings, error messages, screen indicators.
- **60-69**: File indicators (e.g. CHAIN result).
- **70-79**: Working indicators in subroutines.
- **80-89**: Regular working indicators.
- **90-99**: Reserved for standard subroutines.

---

## Main Program Flow

### 1. Initialization (`*INZSR`)

- Resets working variables (wpakod, wpdat1).
- Copies user and firm info from input parameters.
- Initializes date and year fields with system values (`UDATE`, `*YEAR`).
- Blanks the exit parameter (`p_in03`).
- Retrieves user record from AUSRL1 using the user key.
- Receives external parameter `p_in03` via parameter list.

### 2. Main Screen (`A2BLD`)

- Displays the main selection screen for the user to enter or confirm parameters.
- If the user presses F3 (KC), sets `p_in03` to '1' and exits.

### 3. Date Validation

- If the date (`a2pkda`) is zero, it sets it to the current system date.
- Converts date to year for further checks.
- Validates the date format (`TEST(D)`); if invalid, redisplays the screen.

### 4. Accounting Year Validation

- If the entered accounting year (`a2prår`) is greater than the current year (`*YEAR`), displays a warning window (`M1WIN`) with a confirmation prompt.
- If user answers 'N' or the year is zero, sets error indicator and redisplays the main screen.

### 5. Parameter Write-back

- If all validations pass, copies the entered date and year to output parameters (`rhpkda`, `rhprår`).

### 6. Program End

- Sets LR indicator and returns, ending the program.

---

## Subroutines

### `XM1WIN` - Message Window

- Prepares and displays a warning window (M1WIN) centered at a specific position.
- If user presses F3 (KC), sets the answer to 'N'.

### `*INZSR` - Initialization

- Handles all variable initialization, parameter retrieval, and user record lookup.

---

## Business/Domain Logic Highlights

- **Year Validation:**  
  The program enforces that the accounting year cannot be zero and warns if it is greater than the current year. This is a common control in financial systems to prevent data entry mistakes that could impact reporting or processing.

- **User/Firm Context:**  
  The program operates in the context of a specific user and firm, which are passed in as parameters and validated against the user master file (AUSRL1).

- **Interactive Confirmation:**  
  When an unusual accounting year is entered, the user must explicitly confirm via a modal window. This reduces the risk of accidental future-dated transactions.

---

## Design Patterns and Conventions

- **Indicator Usage:**  
  The program follows a strict indicator allocation convention, as documented in the header, to avoid overlap and confusion.
- **Centralized Initialization:**  
  All setup and parameter retrieval are handled in the `*INZSR` subroutine.
- **Screen Handling:**  
  Uses EXFMT for screen display/interaction, with separate screens for main input and modal warnings.
- **Parameter Passing:**  
  Parameters are passed in and out via the PLIST, a common pattern for modular RPG programs.
- **Compile-time Data:**  
  Warning messages are loaded from CTDATA arrays, allowing easy localization or modification.

---

## External Relationships

- **AUSRL1**: Used for user validation and to fetch firm/user context.
- **RH290D**: Display file providing main and modal screens.
- **Other Modules:**  
  None referenced directly, but this program is likely called as part of a larger batch or reporting process where correct period parameters are critical.

---

## Special Version Notes

- **V5.30 (April 2009):**  
  Added support for accounting years greater than the current system year, with appropriate user warnings and confirmations.

---

## User Interaction Summary

1. User enters or confirms date and accounting year.
2. System validates the date and year, prompting for confirmation if the year is unusually high.
3. On confirmation, parameters are stored and the program ends.
4. If the user exits (F3), the exit flag is set for the caller.

---

## Messages

The following warning (in Norwegian) is shown if the year is greater than the current year:

> Valgt år er større enn inneværende år.  
> Bekreft dersom dette er riktig.

("Selected year is greater than the current year. Please confirm if this is correct.")

---

## Summary

This program is a parameter entry and validation module for accounting/reporting periods, with robust controls to prevent invalid or potentially erroneous entries. It is critical for ensuring data integrity in downstream financial processes. The code follows established RPG and business conventions for indicator usage, parameter passing, and user interaction.