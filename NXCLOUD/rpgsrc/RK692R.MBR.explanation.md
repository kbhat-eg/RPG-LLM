<html>
<head>
  <title>RK692R RPG Program Explanation</title>
</head>
<body>

<h1>Program Overview</h1>
<p>RK692R is an IBM ILE RPG program that prints “generalnota” (customer statements or interest notes). It supports both traditional spool‐file output and PDF generation via Jasper/XML, and can optionally e-mail the generated documents or archive them for later retrieval.</p>

<h2>1. File Declarations</h2>
<ul>
  <li><strong>Input Files</strong>
    <ul>
      <li><code>FRKW2PF</code>, <code>FRKUNL1</code>, <code>FRKTRLU</code>: Customer master &amp; posting files, chained by keys</li>
      <li><code>FAFIRL1</code>, <code>FAFORL1</code>: Routine and form registers (select formatting &amp; company info)</li>
      <li><code>RAA4L1</code>, <code>RAA4LU</code>: Reference number registers (track last generalnota number)</li>
    </ul>
  </li>
  <li><strong>Output Files</strong>
    <ul>
      <li><code>FRGIRPF</code>: Bank‐giro transfer file</li>
      <li><code>FRK692P</code>: Print file for legacy listing (`printer`), with associated INFDS</li>
    </ul>
  </li>
</ul>

<h2>2. Data Structures &amp; Variables</h2>
<ul>
  <li><strong>Work Records</strong>
    <ul>
      <li><code>WKWREC</code>: Holds firm‐number, customer‐number, name for sorting and chaining</li>
      <li><code>WKSORT</code>, <code>WGKKEY</code>: Sort and key work areas for file operations</li>
    </ul>
  </li>
  <li><strong>Local Scalars</strong>
    <ul>
      <li>Dates, amounts and counters: <code>W_DATE</code>, <code>W_BELØ</code>, <code>W_TBEL</code>, <code>PAGE</code></li>
      <li>Flags for PDF/XML flow: <code>B_PDFP</code>, <code>B_FIRST</code>, <code>B_XMLG</code></li>
      <li>Parameters loaded from form register: <code>L_POFF</code> (PDF on/off), <code>L_BACH</code> (batch no), <code>L_ARCH</code>, <code>L_SKJE</code> (preview), <code>L_MAIL</code></li>
      <li>Fields for Jasper/XML: <code>XML_Output</code>, <code>XML_path</code>, template paths, data structures to buffer HTML/XML</li>
    </ul>
  </li>
  <li><strong>KID Structure</strong>
    <ul>
      <li>Data structure <code>D_KKID</code> overlays firm, customer, code, check‐digit, sequence number to build the Norwegian “KID” payment reference</li>
    </ul>
  </li>
</ul>

<h2>3. Main Processing Logic</h2>
<ol>
  <li><strong>Initialization</strong>
    <ul>
      <li>Key‐lists and chain file pointers set up in <code>*INZSR</code> subroutine</li>
      <li>Fetch form &amp; routine settings for the given routine code</li>
      <li>Optionally call <code>AP609R</code> to detect whether XML/PDF generation via Jasper is enabled</li>
      <li>Load last used generalnota number from <code>RAA4L1</code>, increment in loop for each note</li>
    </ul>
  </li>
  <li><strong>Loop Through Postings</strong>
    <ul>
      <li>Chain <code>FRKW2PF</code> or <code>FRKUNL1</code> to get the next customer with outstanding entries</li>
      <li>For each <em>new customer</em>:
        <ul>
          <li>Optionally start PDF batch logging (<code>pdf_batchno</code>) and log progress (<code>pdf_logg</code>)</li>
          <li>Initialize totals, calculate due‐date via <code>RS203R</code> or simplified logic</li>
          <li>Fetch company &amp; department headings with <code>R707R</code> if required by form settings</li>
          <li>Print header: legacy (<code>WRITE A1HDR</code>) or XML/PDF (<code>xml_firm</code> + <code>xml_head</code>)</li>
        </ul>
      </li>
      <li><strong>Detail Lines</strong>
        <ul>
          <li>Chain <code>FRKTRLU</code> to fetch each posting for that customer</li>
          <li>Skip running‐balance or negative‐balance entries (<code>RKSAMM='S'</code>)</li>
          <li>Print each line: legacy (<code>WRITE LINJE</code>) or XML (<code>xml_deta</code>)</li>
          <li>Accumulate amounts (<code>W_BELØ</code> and <code>W_TBEL</code>)</li>
          <li>Update posting file with processed flags and timestamps</li>
        </ul>
      </li>
      <li><strong>End of Customer (“Break”)</strong>
        <ul>
          <li>Subroutine <code>BRD_KUNDE</code>:
            <ul>
              <li>Build KID reference (<code>XKIDD</code>)</li>
              <li>Write bank‐giro record (<code>skr_giro</code>) if required</li>
              <li>Print the total line: legacy (<code>WRITE TOTAL</code>) or XML (<code>xml_totaler</code>)</li>
              <li>Finish XML envelope (<code>xml_end</code>) – writes archive tags, meta‐tags</li>
              <li>Optional PDF preview (<code>pdf_preview</code>) or final spool‐job close (<code>AB710R</code>)</li>
            </ul>
          </li>
        </ul>
      </li>
  </ol>

<h2>4. Key Subroutines</h2>

<h3>4.1 skr_giro</h3>
<p>Collects customer &amp; posting data into the bank‐giro output record and writes <code>RGIRPFR</code>. This file can be used by bank interfaces to process payments automatically.</p>

<h3>4.2 xkidd</h3>
<p>Builds the payment reference (“KID”) by concatenating firm number, fixed code (<code>1</code> for generalnota), customer number, and the sequential note number, then computes the check‐digit via <code>AK720R</code>. Supports optional shorter version via <code>AK700R</code>.</p>

<h3>4.3 PDF / XML / Jasper Integration</h3>
<ul>
  <li><strong>xml_envm</strong>: Opens the XML envelope, writes environment sections (batch no, credentials, report‐command)</li>
  <li><strong>xml_head</strong>: Emits the header section for customer data (partner info, dates)</li>
  <li><strong>xml_firm</strong>: Emits the company info section (company name, address, department) with proper XML escaping</li>
  <li><strong>xml_deta</strong>: Emits each detail line in XML, converting text to safe XML characters</li>
  <li><strong>xml_totaler</strong>: Emits the summary section (total amount, KID reference, print‐giro flag)</li>
  <li><strong>xml_end</strong>: Closes the envelope, adds archive tags &amp; metadata (note no, customer no, amounts, user, date, routine code, etc.), and writes the XML to disk via WS routines (<code>WrtHtmlToStmf</code>)</li>
  <li><strong>pdf_preview</strong>: Launches a preview of the generated PDF in a browser via <code>AP621R</code></li>
  <li><strong>pdf_batchno</strong>: Creates a unique job‐ID/batch number for PDF runs by calling logging services (<code>AS100R</code> &amp; <code>AB700R</code>)</li>
  <li><strong>pdf_logg</strong>: Logs progress status into the job log (<code>AB705R</code>)</li>
</ul>

<h2>5. Error Handling &amp; Indicators</h2>
<ul>
  <li>Indicator &lt;91&gt; used to detect missing records after chain operations</li>
  <li>Error checks on print overflow (<code>%ERROR</code>) cause page headers to repeat</li>
  <li>Validation of printer output queue and drawer settings via APIs (<code>AP612R</code>, <code>AP611R</code>, <code>AP614R</code>) when printing legacy spool</li>
  <li>Conditional flags (<code>L_SKJE</code>, <code>L_MAIL</code>) control whether PDF preview, mail, or archive occurs</li>
</ul>

<h2>6. Configuration &amp; Extensibility</h2>
<ul>
  <li>Form settings from <code>FAFORL1</code> determine whether to include company info, department info, KID‐printing options, PDF vs. legacy layout.</li>
  <li>Routine register (<code>FAFIRL1</code>) controls default text, routine codes, due-date logic.</li>
  <li>Jasper templates and logo paths are driven by environment variables read via <code>GetHTMLIFS</code> at initialization.</li>
  <li>Mail setup uses <code>FO798R</code> to fetch e-mail addresses, message text, and then writes mail commands in the XML envelope for an external mail‐sniffer to process.</li>
  <li>Metadata tags in the archive section allow a repository client to search &amp; display the archived statements by key fields (note number, customer, date, amount, etc.).</li>
</ul>

</body>
</html>