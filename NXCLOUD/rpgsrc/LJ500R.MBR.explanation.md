# Program LJ500R – Fixed Order Texts, Inquiry

## Overview

This program (LJ500R) is part of the ASLAGR system and is responsible for providing an inquiry interface for "fixed order texts" (faste bestillingstekster). It is a display file program using subfiles to present and allow selection of order texts, with search and positioning capabilities.

The code is written in RPG IV (fixed-form) and is designed to run in an interactive session (workstation file). It interacts with two physical files (`lftxl1`, `lftxl2`) representing different logical views or access paths to the fixed texts, and a display file (`flj500d`) that implements the subfile interface.

---

## Business Logic and Domain-Specifics

- **Fixed Order Texts**: The business domain involves "fixed texts" that are used in ordering processes. Users can search for these texts by number or by description/reference, and select one for further processing.
- **Inquiry Only**: The program is strictly for inquiry/selection—there is no logic for updating or deleting records.
- **Firm Context**: All queries and selections are scoped to a specific firm (`w_firm`), passed in as a parameter.

---

## File Definitions

- **lftxl1**: Logical file keyed by firm and text number, used for direct number lookup.
- **lftxl2**: Logical file keyed by firm, reference, and number, used for lookup by description/reference.
- **flj500d**: Display file with subfile support. Implements the main user interface.

---

## Key Data Structures

- **Subfile Control Variables**:
    - `w_srrn`: Relative record number in subfile.
    - `w_spge`: Subfile page size.
    - `w_sfrn`, `w_ssrn`: First and last record numbers on the current page.
    - `wvisrn`: Used to position the display to a specific record.

- **Selection and Positioning Fields**:
    - `w_seqe`: Indicates which access path is active (`' '` = by number, `'A'` = by reference).
    - `b_valg_ok`: Indicates if a selection has been made.

- **Parameters**:
    - `p_firm`, `p_numm`: Input parameters for firm and (optionally) text number.

---

## Program Flow

### Initialization (`*inzsr`)

- Receives `p_firm` and `p_numm` as parameters.
- Sets up key lists for both file access paths.
- Initializes subfile by positioning to the first record for the given firm and filling the subfile buffer.

### Main Loop

The main logic is implemented as a loop with display and response handling:

1. **Display Subfile Control Screen** (`write b2cmd`)
2. **Display Subfile** (`exsr dsp_subfile`)
3. **Function Key Handling**:
    - Exit keys (`*INKC`, `*INKL`): End program.
    - Refresh (`*INKE`): Rebuild subfile (via `forny` subroutine).
    - Roll (`*IN10`): Page the subfile (via `crt_subfile`).
4. **Positioning**: If search fields (`b2numm`, `b2refx`) are entered, the `posisjoner` subroutine is called to reposition the subfile to the desired record.
5. **Subfile Processing**: The `subfile` subroutine processes user selection from the subfile. If a selection is made, the program exits, returning the chosen number in `p_numm`.

### Subroutines

#### `forny`
- Repositions the database cursor based on the current access path (`w_seqe`).
- Clears and rebuilds the subfile.

#### `posisjoner`
- Handles user-initiated positioning by either number or reference.
- Sets the appropriate key, repositions the database, and rebuilds the subfile.
- Clears the search fields after use.

#### `subfile`
- Reads selected records from the subfile (using `READC`).
- If a selection is made (`b1valg = 1`), sets `b_valg_ok` and stores the selected number in `p_numm`.

#### `clr_subfile`
- Clears the subfile (sets *IN14, writes control record, resets counters).

#### `crt_subfile`
- Fills the subfile with up to `c_sfil` (8) records per page.
- Reads from either `lftxl1` or `lftxl2` depending on `w_seqe`.
- Stops on end of file or if the firm changes.
- Updates subfile page and record counters.

#### `dsp_subfile`
- Displays the subfile control screen.
- If there are subfile records, enables the display of the subfile; otherwise, shows the command screen.

---

## Special Conventions and Patterns

- **Indicator Usage**: The program follows a documented indicator convention for subfile control, error signaling, and file status.
- **Subfile Paging**: Paging is handled manually, with explicit variables tracking page and record numbers.
- **Access Path Switching**: The program supports two search modes (by number or by reference), toggled by `w_seqe`, and uses different logical files and key lists for each.
- **Screen Management**: Uses explicit indicators to control field protection, cursor placement, and subfile clearing.

---

## Relationships to Other Modules

- **Data Source**: The program depends on the `lftxl1` and `lftxl2` logical files, which must be properly defined to support the required access paths for firm, number, and reference.
- **Integration**: Typically called from other order processing modules, passing the firm (and optionally a starting number) as parameters. Returns the selected number in the parameter list.

---

## Notable Design Decisions

- **No Status Parameter**: The code comments note that a status parameter was removed, simplifying the interface.
- **Explicit Subfile Management**: Instead of relying on built-in subfile paging, the code explicitly manages subfile buffers, allowing for flexible positioning and partial loading.
- **Key List Usage**: Key lists (`klist`) are used for both access paths, improving maintainability and clarity for file positioning.

---

## Error and Edge Case Handling

- **End of File**: Subfile loading stops on EOF or if the firm changes (ensures only relevant records are shown).
- **Selection Handling**: Only allows one selection at a time; exits main loop if a selection is made.

---

## Summary

This program is a robust, inquiry-only subfile selection utility for fixed order texts, supporting flexible search and paging. It is designed for integration into larger order management workflows and is built for maintainability, with clear separation of concerns between display, file access, and user interaction. Its explicit handling of subfile buffers, key lists, and indicator conventions is consistent with established practices in this codebase.