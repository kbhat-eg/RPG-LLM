# Program LH100R – Documentation

## Overview

**Program:** LH100R  
**System:** ASLAGR  
**Description:**  
This program is responsible for handling and processing "Bestillingsforslag" (purchase order proposals), a central component in the purchasing workflow. It provides functionality for displaying, editing, approving, merging, splitting, and transferring proposals into actual purchase orders. The program is highly interactive, using subfiles and various display formats, and integrates with several other modules and files in the purchasing and logistics solution.

---

## Business Domain Context

A "Bestillingsforslag" is a suggested purchase order, typically generated based on stock levels, sales, or other triggers. These proposals are reviewed, possibly edited, and then either deleted, merged, split, or converted into real purchase orders. LH100R manages this process, ensuring business rules are enforced (status, supplier validation, deposit checks, etc.) and that all actions are logged and properly reflected in the underlying database.

---

## High-level Structure

- **Main Loop:** Handles display and user interaction via subfiles (B1SFL/B2CTL etc.), processing function keys and user selections.
- **Subroutines:** Modular subroutines for each business operation (edit, delete, approve, merge, split, transfer, etc.).
- **Database Integration:** Extensive use of keyed logical files for proposals, proposal lines, suppliers, order types, users, etc.
- **Validation/Business Rules:** Multiple layers of validation for status, supplier activity, deposit requirements, and more.
- **Display/UX:** Uses subfiles with paging, filtering, and cursor management. Special handling for modern GUI clients (e.g., Newlook).

---

## Key Files and Data Structures

- **lfhel1/2/3/4/5, lfhelr, lfhelu:** Logical files over the proposal header file (FORSLAGSHODE), supporting different access paths (by number, date, supplier, seller, etc.).
- **lfdtl1, lfdtl4, lfdtlu:** Logical files over proposal lines (FORSLAG-LINJE), for both reading and updating.
- **frlevl1:** Supplier master data.
- **fvotyl1:** Order type master.
- **flusrl1, flusrlu:** User preferences/history.
- **fmppalr:** Parameters for supplier/order type combinations.
- **fohel1, sdepl1:** Order header and deposit info (for deposit checks).
- **Other:** Region, warehouse, customer, and validation files.

---

## Main Flow and User Interaction

### 1. **Initial Display and User Input**

- Subfile (B1SFL) is populated based on filter criteria (status, supplier, warehouse, order type, etc.).
- User can position by proposal number, date, supplier, or seller.
- Function keys allow for actions such as create new proposal, edit, delete, approve, print, merge, split, transfer, and more.

### 2. **Processing User Actions**

- **Edit (valg=2):** Opens header for editing, with validation and update logic.
- **Delete (valg=4):** Calls delete subprogram (LH400R) after confirmation.
- **Approve (valg=5):** Changes status if all lines are valid.
- **Print (valg=6):** Calls print subprogram (LH600C).
- **Edit Lines (valg=7):** Opens lines for editing in LH102R.
- **Transfer (valg=8/18):** Converts proposal to purchase order, with deposit and status checks.
- **Change Supplier (valg=9/10/11):** Supports changing supplier, merging, or splitting proposals.
- **View Order (valg=15):** Calls FO505R to display linked order.

### 3. **Subfile Paging and Filtering**

- Supports roll-up, roll-down, and direct page navigation.
- Filtering is based on user preferences and can include region logic (warehouses in the same region).

---

## Notable Business/Domain Logic

### Status and Validation

- Only proposals with status '0' (open) can be processed for ordering.
- Status is updated both at header and line level, with checks for logical inconsistencies (e.g., missing order number, invalid line types).

### Supplier and Warehouse Validation

- Suppliers must be active and not blocked.
- Warehouses must be valid and, depending on configuration, within the same region as the filter.
- Region logic is implemented for filtering proposals by warehouse region.

### Deposit Handling

- If deposit is required and not paid (checked via order and deposit files), the proposal cannot be transferred to an order.
- Visual indicators and messages are provided for unpaid deposits.

### Merging/Splitting Proposals

- Proposals can be merged if they share key properties (supplier, warehouse, order type).
- Splitting supports both by item-supplier and cross-docking scenarios.
- Merging/splitting updates all relevant lines and headers, recalculating totals and statuses.

### User Preferences

- Last-used filters (status, supplier, seller, order type) are stored per user and reloaded on entry.

### GUI/Client Adaptations

- There is specific handling for Newlook and other GUI clients, e.g., character cleaning in display fields.

---

## Key Subroutines and Their Roles

| Subroutine      | Purpose                                                                                           |
|-----------------|---------------------------------------------------------------------------------------------------|
| forny           | Refreshes subfile after changes or actions.                                                       |
| posisjoner      | Positions the subfile based on user input (number, date, supplier, seller).                       |
| subfile         | Main loop for processing user actions on subfile records.                                          |
| xc1bld          | Calls MP100R to generate a new proposal.                                                          |
| xc2bld          | Calls LH102R to edit proposal lines.                                                              |
| xc3bld          | Calls LH705R for hand terminal input.                                                             |
| xc4bld          | Calls LH600C to print a proposal.                                                                 |
| xb4win          | Delete confirmation and call to LH400R for deletion.                                              |
| xb5win          | Approve proposal, update status if all lines are valid.                                           |
| xb7win          | Edit proposal header, including validation and updating lines if warehouse changes.                |
| xb8win/xb18wi   | Transfer proposal to order, with full validation and deposit checks.                              |
| xb9win          | Change supplier for a proposal and its lines.                                                     |
| xb10win         | Merge proposals, including line renumbering and header/line updates.                              |
| xb11win         | Split proposal (cross-docking or by item-supplier).                                               |
| xb15win         | Bulk transfer of multiple proposals for a supplier.                                               |
| sjekk_lager     | Validates warehouse via FØ720R.                                                                   |
| sjekk_avd       | Validates department via RS707R.                                                                  |
| ovf_bestill     | Handles the transfer of a proposal to an order, including deletion of the proposal and its lines. |
| sjekk_det       | Checks for logical errors on proposal lines (esp. for order-originated proposals).                |
| sjekk_feil      | Comprehensive validation before order transfer (status, deposit, supplier activity, etc.).        |
| finn_region     | Determines region for warehouse for filtering.                                                    |
| sjekk_region    | Checks if a proposal's warehouse matches the filter region.                                       |
| newlo_vask      | Cleans display fields for GUI compatibility.                                                      |
| sjekk_depo      | Checks if deposit requirement is met for a proposal/order.                                        |
| depo_meld       | Displays message for unpaid deposit.                                                              |
| hntnum          | Calls AS100R to fetch new proposal/order numbers.                                                 |
| spørring        | Lookup subroutine for supplier, warehouse, etc.                                                   |
| clr_subfile     | Clears the subfile.                                                                               |
| crt_subfile     | Populates the subfile with proposals matching current filters.                                    |
| bck_subfile     | Handles paging backwards in the subfile.                                                          |
| dsp_subfile     | Handles display of the subfile and control record.                                                |

---

## Design Patterns and Conventions

- **Subfile-based UI:** Standard for interactive RPG applications, with subfile control for paging, selection, and direct record actions.
- **Extensive Use of Subroutines:** Each business function is modularized for maintainability and clarity.
- **Key Lists (KLIST/KFLD):** Used for all file positioning and access, supporting both single and composite keys.
- **Indicator Usage:** Standard indicators for program flow and error handling, with clear separation for function keys, errors, and work indicators.
- **Parameter Passing:** Calls to external programs are parameterized, often passing packed or overlayed data structures for efficiency.
- **Overlayed Data Structures:** Used for compact parameter passing, especially for print and transfer routines.

---

## Integration Points

- **External Programs:**
  - `MP100R`: Proposal generation.
  - `LH102R`: Line editing.
  - `LH705R`: Hand terminal input.
  - `LH600C`: Printing.
  - `LH400R`: Deletion.
  - `LO110R`, `LO740R`: Order handling.
  - `RS760R`, `RS707R`, `RL500R`, `RA510R`: Validation and lookup routines.
  - `AS100R`: Number series handling.
  - `AA005R`: Message display.
  - `FO505R`, `FO704R`: Order display and deposit calculation.

- **Configuration/Feature Switches:**
  - `CO402R`: Used to read system switches for GUI features and filtering logic.

- **Parameter Tables:**
  - `fmppalr`: Supplier/order type parameters, including weight and amount limits.
  - `avall1`: Company-controlled field validation.

---

## Special Considerations

- **Region Filtering:** Filtering proposals by warehouse region is configurable and can be toggled by system switches.
- **Deposit Handling:** The logic is intricate, handling both system-wide deposit solutions and order-specific requirements, with overrides for credit customers.
- **Merge/Split Logic:** Careful handling of line numbers, keys, and header/line relationships when merging or splitting proposals.
- **GUI Compatibility:** Data cleansing routines ensure compatibility with modern GUI clients, removing problematic characters and formatting issues.
- **Error Handling:** All critical operations include validation and user feedback, with early exits (`leavesr`) on errors.

---

## Key Indicators

| Indicator | Purpose                                                      |
|-----------|--------------------------------------------------------------|
| LR        | End of program                                               |
| 10–15     | Paging and subfile control                                   |
| 21–22     | Cursor and positioning                                       |
| 30        | Field protection                                             |
| 31–79     | Error/warning indicators                                     |
| 80–99     | Work indicators                                              |

---

## Maintenance Notes

- **Versions and Change Log:** The program is heavily maintained, with many business rules added or adjusted over time. Always review the change log for context on recent changes.
- **External Dependencies:** Many business rules are enforced by external programs; understanding their interfaces is critical for any changes.
- **Testing:** Due to the complex, interactive nature and heavy business logic, thorough testing is essential for any modification.

---

## Summary

**LH100R** is a core business program for managing the lifecycle of purchase order proposals, enforcing business rules, and integrating with the broader purchasing and logistics system. It is a typical example of a highly interactive, business-rule-heavy RPG application, leveraging subfile UI, modular subroutines, and extensive database integration. Understanding the business context, key files, and subroutines is essential for effective onboarding and maintenance.