# Program RH967R Documentation

## Overview

**Program Name:** RH967R  
**System:** ASOKON  
**Description:**  
This program facilitates the selection and validation of journal parameters for reports that display journals with differences. It includes logic for user input validation, parameter initialization, and limited business rule enforcement for period and year selection. The program is designed to be run interactively, using a workstation display file for user interface.

## Business/Domain Logic

- **Purpose:**  
  The main function is to collect and validate user input for accounting period and year, and to set parameters for subsequent journal report generation. It ensures correct period ranges and validates the accounting year against the current system year.

- **Special Version:**  
  As of version V5.40 (2023-08-05), a parameter was added to allow output of all journals.

- **User/Company Context:**  
  The program is tailored for environments where users may be restricted by company or department, and where journal report criteria may need to be restricted or validated based on business rules.

## File Interactions

- **AUSRL1 (Input File):**  
  A keyed disk file, likely containing user or authorization records. Used to retrieve user information and department restrictions.

- **RH967D (Workstation File):**  
  A display file providing the user interface (screen A2BLD) for input of report criteria.

## Data Structure and Variables

- **Input/Output Fields:**  
  Variables prefixed with `rh` (e.g., `rhprår`, `rhppef`, `rhpett`) are used for parameter passing and output.

- **Work Fields:**  
  Various temporary and work variables (e.g., `waar`, `wmnd`, `wpakod`, `p_in03`) are used for calculations and status.

- **User/Company Fields:**  
  `l_user`, `l_firm`, `l_fnav` are loaded from parameters and copied to work fields for processing.

## Indicator Usage

The codebase uses a standardized indicator convention:

- **KA/KC:** Function key indicators for company selection (F1) and exit (F3).
- **LR:** Program end.
- **30:** Protect fields on display.
- **31-59:** Error/warning indicators.
- **60-69:** File I/O indicators.
- **70-79:** Subroutine work indicators.
- **80-89:** General work indicators.
- **90-99:** Standard subroutine indicators.

## Program Flow

### Initialization (`*INZSR`)

- Sets initial values for work fields (`wpakod`, `p_in03`).
- Copies user and company number from input parameters to work variables.
- Calculates default period/year values based on the current date:
  - Previous month is default period.
  - If the month is January, period is set to December of the previous year.
- Initializes period range (`a2ppef`, `a2ppet`).
- Clears report type selector (`a2pall`).
- Reads user record from AUSRL1; if the user is restricted to a department (`abbavd = '1'`), sets indicator 30.
- Sets up the parameter list for entry (`p_in03`).

### Main Loop

- **Display Screen:**  
  Presents the A2BLD screen for user input (`EXFMT a2bld`).

- **Exit Handling:**  
  If the user presses F3 (`*INKC`), sets return code and exits.

- **Year Validation:**  
  Ensures the selected accounting year (`a2prår`) is not in the future. If invalid, sets error indicator 34 and redisplays the screen.

- **Period Validation:**  
  Ensures the "from" period is not after the "to" period. If invalid, sets error indicator 35 and redisplays the screen.

- **Default Periods:**  
  If both period-from and period-to are zero, defaults to full year (periods 1 to 13).

- **Parameter Assignment:**  
  Moves validated screen input into the parameter variables for use by downstream processes.

### Program Exit

- **Normal Exit:**  
  Sets LR indicator and returns.

## Screen Handling

- **A2BLD:**  
  The only referenced display screen, used for entering and validating report criteria. The program expects certain field names (`a2prår`, `a2ppef`, `a2ppet`, `a2pall`).

## Notable Design Decisions

- **Indicator Conventions:**  
  The program follows a strict indicator usage pattern, which is common in this codebase for clarity and maintainability.

- **Parameter Passing:**  
  Uses a parameter list with at least one parameter (`p_in03`) for communication with calling programs or CL.

- **Year/Period Logic:**  
  Defaulting to the previous month and handling of year rollover is handled explicitly, reducing user input errors.

- **File Keying:**  
  User records are retrieved using a composite key (`ausrl1_key`) constructed from the user field.

- **Error Handling:**  
  Uses indicators to manage screen-level error messaging and protect fields as needed.

## Relationships with Other Modules

- **User/Authorization:**  
  Relies on AUSRL1 for user and department restriction logic.

- **Downstream Reporting:**  
  The parameters set by this program are intended for use by subsequent report generation programs, which are not shown here.

## Business Rules and Restrictions

- **Department Restriction:**  
  If the user is limited to a department, this is detected and enforced via screen indicator.

- **Period/Year Validation:**  
  Prevents selection of future years and invalid period ranges.

- **Full Year Default:**  
  If no period is specified, defaults to a full fiscal year (period 1-13).

## Summary Table

| Component          | Purpose/Usage                                    |
|--------------------|--------------------------------------------------|
| AUSRL1             | User authorization and restriction lookups        |
| RH967D             | Workstation display file for user interaction     |
| Indicators         | Standardized for function, error, and I/O control|
| Parameter Passing  | For integration with calling programs             |
| Year/Period Logic  | Validates and defaults input for business rules   |

## Key Points for New Developers

- Adhere to the indicator usage conventions when modifying or extending logic.
- Parameter and field names are tightly coupled to business concepts (year, period, report type).
- Screen logic is closely linked to error indicator handling—ensure any new validation follows this pattern.
- Changes to user or company logic likely require corresponding updates in AUSRL1 or related modules.
- This program is typically invoked as part of a larger reporting or journal-processing workflow. Ensure parameter changes are coordinated with downstream consumers.

---

For any enhancements or troubleshooting, consult the referenced screen definitions, AUSRL1 file structure, and downstream report modules for full context.