# RPG Program Explanation: RT020R

This program is written in ILE RPG (Report Program Generator) for the IBM i (AS/400) system. It is designed to update a total chart of accounts (kontoplan) by adding a "bearer name" (kbærernavn) to each record in a file. Below is a breakdown and explanation of the key elements in the source code.

---

## 1. **Header and Metadata**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **H-spec:** Sets program options.
  - `*nodebugio`: Prevents debug for database I/O for performance.
  - `*dmy`: Dates are in DD/MM/YY format.

```rpg
* System  . . . . : ASOKON
* Program . . . . : RT020R
* Beskrivelse . . : Danne total kontoplan
*                   Legger på kbærernavn
* Ref.   Dato  Sign Endringsbeskrivelse
* ----- ------ ---- -------------------------------------------------
*       060804 HFL  Nytt program
```
- Documentation about system, program, purpose, and change history.

---

## 2. **File Declarations**

```rpg
fra28l1    if   e           k disk    rename(ra28pfr:ra28l1r)
Frtotl3    uf   e           k disk    rename(rtotpfr:rtotl3r)
```
- Two files are defined:
  - **fra28l1** (input, keyed, external) renamed as **ra28l1r**
  - **Frtotl3** (update, keyed, external) renamed as **rtotl3r**

---

## 3. **Variables Definition**

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- **l_user** and **l_firm** are data structure subfields, holding user and firm data.

```rpg
d ra28l1_bkod     s                   like(rebkod)
d w_firm          s                   like(rebfir)
d wkbare          s                   like(rebkod)
```
- Local variables defined based on types in the file (e.g., `rebkod`, `rebfir`).

---

## 4. **Input Field Mapping (I-Spec)**

```rpg
IRTOTL3R
I              FIRMA                       TOFIRM
```
- In the **rtotl3r** record, field **FIRMA** is mapped to local field **TOFIRM**.

---

## 5. **Main Logic**

### a. Main Loop

```rpg
C     *IN50         DOWEQ     *OFF
C                   READ      RTOTL3R                                50
C     *IN50         IFEQ      *OFF
```
- Loops through **rtotl3r** records until end-of-file (`*IN50` is set to `*ON` when EOF).

### b. Key Change Detection & Chain

```rpg
C     KBARER        IFNE      WKBARE
c                   MOVE      KBARER        ra28l1_bkod
c     ra28l1_key    chain     ra28l1                             90
C                   MOVE      KBARER        WKBARE
C                   END                                                    TOFIRM
```
- If the KBARER (bearer code) has changed, it:
  - Moves current KBARER to `ra28l1_bkod`
  - Uses a key list (created in the subroutine) to *CHAIN* (randomly read) from **ra28l1** file to find the related record
  - Stores KBARER to `WKBARE` so that subsequent records with same KBARER do not repeat the CHAIN

### c. Update With Bearer Name

```rpg
C                   MOVE      rebtxt        KBNAVN
C                   UPDATE    RTOTL3R
```
- Updates the current **rtotl3r** record:
  - Moves the text field (`rebtxt`, likely the name of the bearer) from **ra28l1** to **KBNAVN** (bearer name) in the current **rtotl3r** record
  - Updates (**UPDATE**) the **rtotl3r** record with this new info

---

## 6. **Ending the Program**

```rpg
C                   MOVE      '1'           *INLR
```
- Ends the program and releases resources.

---

## 7. **Subroutine for Initialization**

```rpg
c     *inzsr        begsr
      ...
c                   eval      w_firm = l_firm
c                   endsr
```
- **Initialization subroutine** (`*inzsr`):
  - Sets up the key list (`ra28l1_key`) for CHAIN operation, including fields for **w_firm** and **ra28l1_bkod**
  - Sets **w_firm** from **l_firm** (likely session/company context)

---

## 8. **Key List Setup**

```rpg
c     ra28l1_key    klist
c                   kfld                    w_firm
c                   kfld                    ra28l1_bkod
```
- Defines the composite key used for lookups in **ra28l1**.

---

## **Summary of Logic**

- The program reads through records in **rtotl3r** (total chart of accounts).
- For each record, it checks if the cost bearer code (**KBARER**) has changed from the last processed one.
- If changed, it retrieves (`CHAIN`) the corresponding name from **ra28l1** using a composite key (firm + bearer code).
- The bearer name (`rebtxt`) is moved into the current **rtotl3r** record's **KBNAVN** field.
- The record is then updated.
- This continues for all records.

---

## **Onboarding Notes**

- Understanding the file layouts for **ra28l1** (bearer master) and **rtotl3r** (chart of accounts) is important.
- The program optimizes by only reading the bearer master when the bearer code changes, reducing I/O.
- The subroutine initializes key fields for efficient lookups.
- Error handling is minimal; missing chains or update failures are not explicitly handled.
- This code uses older RPG syntax (fixed-format), but the logic is still relevant for maintenance or migration to free-format RPG.