      /TITLE  Utskrift av Faktura
     h decedit('0.') datedit(*dmy.) option(*nodebugio)
pdf  h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
pdf   /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Program . . . . : FO946R
      * Beskrivelse . . : Utskrift av Faktura (Byggmester-faktura)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      * R3.10 010200 AMD  Skille mellom år var ikke lagt på plass
3.12  * R3.12 310800 AMD  Lagt inn mulighet for utprint av avdelingsnavn
3.12  *                   i stedet for firmanavn dersom ønskelig
3.13  * R3.13 110900 AMD  Dersom vare er hentet fra LVR settes det inn
3.13  *                   2 desimaler som standard (finnes jo ikke i EVR)
3.31  * R3.31 181200 AMD  Lagt inn betalingsmåte og antall kopier for å
3.31  *                   kunne benytte dette i Optra forms
3.32  * R3.31 040101 AMD  Dato for mva er endret fra ordre- til fakturadato.
3.33  * R3.33 280301 AMD  Lagt inn mulighet for å styre om rabatter skal
      *                   vises med prosent, eller som bare et nettobeløp.
3.34  * R3.34 080601 AMD  Differensiert moms, 24 og 12 %
3.35  * R3.35 150801 AMD  Differensiert moms, 24 og 12 % (Byggmesterløsn.)
3.36  * R3.36 170602 AMD  Lagt inn ny logikk for håndtering av printer-
      *                   styringen via INFDS.  Variabler for linjetelling
      *                   w_tell og w_test er fjernet
5.04  * R5.04 161002 AMD  Kiddnummer hentes nå fra hist fakt reg.
5.04  *                   Rutineregister styrer om kort eller lang kidd
5.22  * R5.22 010903 AMD  Skriver tekstlinje 2, dersom utfyllt
5.22  *                   + lagt inn utskrift av leveringstype
5.22  *                   + lagt inn skråstrek mellom telefon / telefax
5.31  * R5.31 140205 GRO  Ikke skriv ut fakt. av typen eFaktura o.l.
5.45  * R5.45 300605 AMD  Lagt inn dummy-parameter for å hindre
5.45  *                   forurensning av parameter-lister
5.46  * R5.46 010905 AMD  Korrigering av leveringsmåtetekst som ble
5.46  *                   dratt med fra første ordre til de etterfølgende
5.47  * R5.47 150306 AMD  Utskrift av leveringsbetingelse dersom utfylt
5.48  * R5.48 150306 AMD  Fjernet Regns. prosjekt og lagt inn lev.dato
5.49  * R5.49 040107 BOF  Styrer slik at kopi kommer ut hvis e-faktura
5.60  * R5.60 040408 AMD  Lagt inn utskrift av eksternt prosjektnummer
5.60  *                   + utprint av IBAN og SWIFT fra firmaregister
5.62  * R5.62 230508 AMD  Lagt inn løsning for depositum
6.10  * R6.10 070909 BSA  Utskriften endret pga utvidelse av referansefelter.
6.11  * R6.11 140909 AMD  Endring for å løse problemet dersom siste
      *                   ordre ikke har noen varelinjer (Fakt.sum=0)
6.12  * R6.12 180909 AMD  Lagt inn spesifisering av flere mva-satser
6.13  * R6.13 251009 AMD  Samme som 6.12 men gjelder Byggm. fakturaen
6.14  * R6.14 100310 AMD  Linjejustering for å slippe endr. i Interform
6.14  *                   (Bare i printfilen)
6.15  * R6.15 160310 AMD  Mvagrunnlag akkumulerte seg på faktura
pdf   * R5.60 260410 bsa  Lagt inn funksjonalitet for eksport til XML
pdf   *                   format for videre arkivering og utskrift.
pdf2  * R6.10 130910 bsa  Klientendringer.
6.16  * R6.10 280910 bsa  Tillegg av faste tagger. Display tag + ordrenummer
6.16  *                   hvis den finnes.
6.17  * R6.10 300910 bsa  Hvis konvtertering av spesialtegn, legges til flere tegn
6.17  *                   som kan gjøre at noen av disse faller utenfor pga av felt-
6.17  *                   lengde.
6.19  * R6.10 211010 bsa  Kaller eget program for scann av tegn til xml.
6.21  *  6.21 051110 bsa  Bruksrettsrabatt for Eidsvoll, xml håndtering
9.01  *  9.01 051110 Amd  Bruksrettsrabatt for Eidsvoll
6.22  * R6.10 070213 nho  Mulighet til kort kid,faktnr + kontrollsiffer
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     fvpkol1    if   e           k disk    rename(vpkopfr:vpkol1r)
     fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
6.11 fsohelr    if   e           k disk    rename(sohepfr:sohelrr)
     fsodtl1    if   e           k disk    rename(sodtpfr:sodtl1r)
6.11 fsodtlr    if   e           k disk    rename(sodtpfr:sodtlrr)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
5.60 ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
5.31 ffnufl1    if   e           k disk    rename(fnufpfr:fnufl1r)
5.31 ffmftl1    if   e           k disk    rename(fmftpfr:fmftl1r)
pdf  fafpslr    if   e           k disk    rename(afpspfr:afpslrr)
3.36 ffo946p    o    e             printer infds(d_infds)
      *
6.12  *
6.12  * Definering av array's
6.12  *
6.12 d mko             s              1    dim(9)
6.12 d msa             s              5  2 dim(9)
6.12 d mgr             s             11  2 dim(9)
6.12 d mbe             s             11  2 dim(9)
6.12 d mog             s             11  2 dim(9)
6.12 d mor             s             11  2 dim(9)
6.13 d ngr             s             11  2 dim(9)
6.13 d nbe             s             11  2 dim(9)
      *
      * Modulus 10 utregninger.
      *
     d a10             s              1    dim(24)
     d m10             s              1  0 dim(24)
     d u10             s              1  0 dim(12)
      *
      * Datastruktur parameter-inn
      *
     d                 ds
     d d_parm                        30
     d  d_aarr                        4  0 overlay(d_parm)
     d  d_otyp                        2    overlay(d_parm:5)
     d  d_ffnr                        6  0 overlay(d_parm:7)
     d  d_tfnr                        6  0 overlay(d_parm:13)
     d  d_prog                       10    overlay(d_parm:19)
     d  d_kopi                        1    overlay(d_parm:29)
5.45 d  d_dumy                        1    overlay(d_parm:30)
3.36  *
3.36  * Informasjon fra printer-file
3.36  *
3.36 d d_infds         ds
3.36 d  d_linnbr             367    368B 0
3.36 d  d_pagnbr             369    372B 0
      *
      * Definering av local data area
      *
     d                uds
pdf  d l_poff                584    584
pdf  d l_bach                595    635
pdf  d l_arch                636    636  0
pdf  d l_skje                637    637  0
pdf  d l_land                638    638  0
pdf  d l_exlp                639    639  0
pdf  d l_mail                640    640  0
pdf  d l_ruti                800    809
pdf  d l_outq                810    819
pdf  d l_akop                838    843  0
     d d_alin                856    858  0
pdf  d l_bgir                881    881  0
     d d_kidk                883    883  0
     d d_ocrk                885    885  0
pdf  d l_user                911    920
pdf  d l_filg                931    933
pdf  d l_firm                944    946  0
      *
      * Definering av parametere
      *
     d p_parm          s             30
pdf  d p_mail          s              1
pdf  d p_kund          s              6  0
pdf  d p_kpro          s              6  0
pdf  d p_numm          s              6  0
pdf  d p_selg          s              4  0
pdf  d p_serv          s             35
pdf  d p_stat          s              1
pdf  d p_kule          s              1
pdf  d p_navn          s             30
pdf  d p_emal          s             50
pdf  d p_ema2          s             50
pdf  d p_emne          s             50
pdf  d p_txt1          s             50
pdf  d p_txt2          s             50
pdf  d p_txt3          s             50
pdf  d p_txt4          s             50
pdf  d p_pers          s             50
pdf  d p_inif          s             40
pdf  d p_in03          s              1
pdf2 d p_jkey          s             41
6.19 d p_lr            s              1
6.19 d p_str_in        s            512
6.19 d p_str_out       s            512

      * Definering av variable i nøkler
      *
     d w_firm          s                   like(sofirm)
     d sohel1_aarr     s                   like(soaarr)
     d sohel1_binr     s                   like(sobinr)
     d sohel1_numm     s                   like(sonumm)
     d sohel1_suff     s                   like(sosuff)
6.11 d sohelr_aarr     s                   like(soaarr)
6.11 d sohelr_binr     s                   like(sobinr)
6.11 d sohelr_numm     s                   like(sonumm)
6.11 d sohelr_suff     s                   like(sosuff)
     d sodtl1_aarr     s                   like(sdaarr)
     d sodtl1_binr     s                   like(sdbinr)
     d sodtl1_numm     s                   like(sdnumm)
     d sodtl1_suff     s                   like(sdsuff)
     d sodtl1_ktxt     s                   like(sdktxt)
     d sodtl1_line     s                   like(sdline)
6.11 d sodtlr_aarr     s                   like(sdaarr)
6.11 d sodtlr_binr     s                   like(sdbinr)
6.11 d sodtlr_numm     s                   like(sdnumm)
6.11 d sodtlr_suff     s                   like(sdsuff)
     d rkunl1_kund     s                   like(sokund)
5.60 d fkprl1_kund     s                   like(flkund)
5.60 d fkprl1_kpro     s                   like(flkpro)
     d votyl1_otyp     s                   like(vaotyp)
     d vltyl1_ltyp     s                   like(sdltyp)
     d vpkol1_pkod     s                   like(vapkod)
     d vvarl1_vare     s                   like(vvvare)
5.31 d fnufl1_aarr     s                   like(fnuaar)
5.31 d fnufl1_binr     s                   like(fnubin)
5.31 d fmftl1_faty     s                   like(fmtfat)
     d aforl1_ruti     s             10
pdf2 d afpslr_ufil     s                   like(afufil)
pdf2 d afpslr_uide     s                   like(afuide)
      *
      * Definering av variable
      *
3.12 d w_prfi          s              1  0
3.12 d w_ffir          s              3  0
3.12 d w_avde          s              4  0
3.12 d w_fnav          s             30
3.12 d w_fad1          s             30
3.12 d w_fad2          s             30
3.12 d w_fste          s             30
3.12 d w_fftx          s             30
3.12 d w_tfax          s              8
3.12 d w_ftlf          s             11
3.12 d w_ffax          s             11
     d w_csts          s              1
     d w_ctx2          s             20
     d w_tell          s              4  0
     d w_krab          s              4  2
     d w_mvaf          s             10  9
3.34 d w_mv2f          s             10  9
     d w_mvas          s              6  2
3.34 d w_mv2s          s              6  2
     d w_mvat          s              5  4
3.34 d w_mv2t          s              5  4
     d w_mvax          s             30
     d w_qmva          s              1
     d w_retk          s              1
     d w_txt2          s             20
5.47 d w_rtx1          s             25
5.47 d w_rtx2          s             25
5.47 d w_rtx3          s             25
     d w_ffda          s               d   datfmt(*iso)
     d w_binr          s                   like(sobinr)
     d w_totb          s                   like(sorkop)
     d w_kund          s                   like(faakun)
5.31 d b_nopr          s              1    inz(*off)
      *
     d w1rab1          s                   like(sdsapr)
     d fa10            s              1  0
     d fcycle          s              1  0
     d kidd10          s             24
     d ksif10          s              1  0
     d modr10          s              1  0
     d mods10          s              3  0
     d n               s              2  0
     d xx              s              2  0
     d yy              s              2  0
6.22 d w_kidd          s             24
6.22 d w_kid2          s             24
6.22 d w_kidr          s              6  0
3.34 d w_mvag          s                   like(sosalp)
6.12 d m               s              2  0
6.12  *
6.12 d w_stat          s              1
6.12 d w_mvak          s              1
6.12 d w_mvtx          s             30
6.12 d w_bpro          s              5  2
6.12 d w_orab          s             13  2
9.01  *
9.01 d d1bgr1          s                   like(sosalp)
9.01 d d1bgr2          s                   like(sosalp)
9.01 d d1brb1          s                   like(sosalp)
9.01 d d1brb2          s                   like(sosalp)
9.01 d d3bgr2          s                   like(sosalp)
9.01 d d3brb2          s                   like(sosalp)
9.01 d t1bgr1          s                   like(sosalp)
9.01 d t1bgr2          s                   like(sosalp)
9.01 d t1brb1          s                   like(sosalp)
9.01 d t1brb2          s                   like(sosalp)
pdf  d b_pdfp          s              1    inz(*off)
pdf  d b_pdfp_first    s              1    inz(*off)
pdf  d b_topt          s              1    inz(*off)
pdf  d b_bott          s              1    inz(*off)
pdf  d b_ordr          s              1    inz(*off)
pdf  d x_numm          s             15
pdf  d x_vref          s             25
pdf  d x_betb          s             42
pdf  d w_bdat          s               d   datfmt(*iso)
pdf  d w_date          s               d   datfmt(*iso)
pdf  d w_kode          s              1
pdf  d w_fell          s              6
pdf  d w_type          s              2
pdf  d w_fast          s             10
pdf  d w_ruti          s             10
pdf  d w_numm          s              6  0
pdf  d w_pdf           s              1  0
pdf  d w_jnav          s             15
pdf  d w_jkey          s             41
pdf  d w_jtxt          s             35
pdf  d w_pdf_ds        s            512
pdf  d w_mtxt          s            200
pdf  d w_jstat         s              2  0
pdf  d w_jtext         s            200
pdf  d w_mark          s              5
pdf  d w_spol          s              5
pdf  d w_land          s              9
pdf  d w_copy          s             15
pdf  d w_time          s              6  0
pdf  d w_str_in        s            512
pdf  d w_str_out       s            512
pdf  d w_x             s              3  0
pdf  d w_bgir          s              5
pdf  d w_path          s            256
pdf  d w_bach          s                   like(l_bach)
pdf  d w_draw1         s             10
pdf  d w_draw2         s             10
6.16 d w_dspl          s            100
6.19 d w_tek1          s            512
6.19 d w_tek2          s            512
6.17 d w_1fnav         s             50
6.17 d w_1fad1         s             50
6.17 d w_1fad2         s             50
6.17 d w_1navn         s             50
6.17 d w_1gate         s             50
6.17 d w_1adr2         s             50
6.17 d w_2navn         s             50
6.17 d w_2adr1         s             50
6.17 d w_2adr2         s             50
pdf   *
pdf  d XML_Output      s            256a   Varying
pdf  d XML_path        s            256a   Varying
pdf  d                                     Inz('/home/asp/print/adb')
pdf  d jasper_mal      s            256a   inz('file:/home/asp/print/maler/+
pdf  d                                     faktura/faktura.jasper')
pdf  d jasper_logo     s            256a   Varying
pdf  d tmpdate         s               D
pdf  d tmptime         s               T
pdf   *
pdf  d d_pdf_ds        ds
pdf  d  d_xmlm                       75
pdf  d  d_jasm                       75
pdf  d  d_logo                       75
pdf  d  d_path                      100
pdf  d  d_emal                       50
pdf   /copy prototypeb
pdf   /copy usec
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Definering av formater
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Benyttede formater
      * - - - - - - - - - -
      *
      * A1HDR  - Heading A1 på rapport
      * A2HDR  - Heading A2 på rapport
      * A3HDR  - Heading A3 på rapport, Ordrehode over varelinje
      * D1DET  - Detail  D1 på rapport, Varelinje
      * D2DET  - Detail  D2 på rapport, Tekstlinje
      * O1DET  - Detail  O1 på rapport, Overføring til/fra neste side
      * R1TOT  - Total   R1 på rapport, ordrerabatt
      * T1TOT  - Total   T1 på rapport
      *
      *
      * Forklaring på variabler
      * - - - - - - - - - - - -
      *
      * D1ANT0 - Antall med 0 desimaler
      * D1ANT1 - Antall med 1 desimaler
      * D1ANT2 - Antall med 2 desimaler
      * D1ANT3 - Antall med 3 desimaler
      * D1BPRI - Brutto pris
      * D1NBEL - Netto  beløp
      * D1RABP - Rabatt i prosent (Sum prosent 1 og 2)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Styre-rutine
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Initierings-rutine
      *
     c     fcycle        caseq     *zero         xstrsr
     c                   endcs
      *
      * Behandle ordrehode
      *
     c     htag01        tag
     c     *in61         cabeq     *on           xslutt
     c     sofirm        cabne     w_firm        xslutt
3.10 c     soaarr        cabne     d_aarr        xslutt
     c     sobinr        cabgt     d_tfnr        xslutt
     c     sootyp        cabne     d_otyp        ntag03
5.31  *
5.31  * Sjekk utg. fakt.logg - sjekk om faktura evt ikke skal printes
5.31  *
5.31 c                   exsr      sjk_uf_log
5.31 c                   if        b_nopr = *on
5.31 c                   read      sohel1                                 61
5.31 c                   goto      htag01
5.31 c                   endif
5.31  *
6.11  *
6.11  * Sjekk om ordren har noen varelinjer
6.11  *
6.11 c                   exsr      sjk_varlin
6.11 c                   if        b_nopr = *on
6.11 c                   read      sohel1                                 61
6.11 c                   goto      htag01
6.11 c                   endif
6.11  *
     c                   if        sobinr <> w_binr
     c                   exsr      xhode1
     c                   else
     c                   exsr      xhode2
     c                   endif
     c                   eval      w_binr = sobinr
      *
      * Behandle varelinje
      *
     c                   eval      sodtl1_binr = sobinr
     c                   eval      sodtl1_numm = sonumm
     c                   eval      sodtl1_suff = sosuff
     c                   eval      sodtl1_ktxt = *zero
     c                   eval      sodtl1_line = *zero
      *
     c     sodtl1_key    setll     sodtl1
     c                   read      sodtl1                                 62
      *
     c     vtag01        tag
     c     *in62         cabeq     *on           ntag02
     c     sdfirm        cabne     sofirm        ntag02
     c     sdbinr        cabne     sobinr        ntag02
     c     sdnumm        cabne     sonumm        ntag03
     c     sdsuff        cabne     sosuff        ntag03
      *
     c                   exsr      xvare1
     c                   read      sodtl1                                 62
     c                   goto      vtag01
      *
      * Ny faktura
      *
     c     ntag02        tag
     c                   eval      a1side = 1
     c                   exsr      xorrab
     c                   exsr      xtotal
     c                   read      sohel1                                 61
     c                   goto      htag01
      *
      * Ny ordre
      *
     c     ntag03        tag
     c                   exsr      xorrab
     c                   read      sohel1                                 61
     c                   goto      htag01
      *
      * Ferdig
      *
     c     xslutt        tag
pdf   * PDF print er aktivert
pdf  c                   if        b_pdfp = *on
pdf   * Vi har skrevet en faktura som ikke er e-print etc.
pdf  c                   if        b_pdfp_first = *on
pdf   * Skriv xml fila på disk
pdf  c                   exsr      xml_end
pdf   * Hvis forhåndvisning må vi kjøre linken
pdf2 c                   if        1 = 2
pdf  c                   if        l_skje = 1 and
pdf  c                             l_bach = w_bach
pdf  c                   exsr      pdf_preview
pdf  c                   endif
pdf2 c                   endif
pdf   * Avslutt jobbiden
pdf  c                   call      'AB710R'
pdf  c                   parm                    l_bach
pdf   *
pdf  c                   endif
pdf  c                   endif
pdf   *
     c                   eval      *inlr = *on
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * A1HDR Behandle heading A1 + A2
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xhode1        begsr
      *
pdf   * Skriv ut forrige PDF, lager ny batch
pdf  c                   if        w_binr <> 0 and
pdf  c                             b_pdfp = *on
pdf   * Skriv xml fila på disk
pdf  c                   exsr      xml_end
pdf   * Avslutt jobbiden
pdf  c                   call      'AB710R'
pdf  c                   parm                    w_bach
pdf   * Lager nytt batchnummer
pdf  c                   eval      w_kode = '0'
pdf  c                   eval      w_firm = l_firm
pdf  c                   eval      w_fell = 'NXTKLI'
pdf  c                   eval      w_type = *blank
pdf  c                   eval      w_fast = *blank
pdf  c                   eval      w_numm = *zero
pdf   *
pdf  c                   call      'AS100R'
pdf  c                   parm                    w_kode
pdf  c                   parm                    w_firm
pdf  c                   parm                    w_fell
pdf  c                   parm                    w_type
pdf  c                   parm                    w_fast
pdf  c                   parm                    w_numm
pdf   *
pdf  c                   eval      w_jnav = 'PDF' + %char(w_numm)
pdf  c                   eval      w_jtxt = 'Utskrift av tilbud via Jasper'
pdf  c                   call      'AB700R'
pdf  c                   parm                    w_jnav
pdf  c                   parm                    w_jkey
pdf  c                   parm                    w_jtxt
pdf   *
pdf  c                   eval      w_bach = w_jkey
pdf   * Vi logger at utskriftprogrammet har startet
pdf  c                   eval      w_jstat = 10
pdf  c                   eval      w_jtext = 'Utskrift av tilbud har startet'
pdf  c                   call      'AB705R'
pdf  c                   parm                    w_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf   * Vi skriver xml for miljø formater
pdf  c                   exsr      xml_envm
pdf  c                   endif
      * Null-stilling av
      * variabler
      *
     c                   eval      t3tell = 0
     c                   eval      o3trsp = 0
     c                   eval      o1trsp = 0
      *
     c                   exsr      xhodef
      *
      * Snu fakturadato
      *
     c                   if        sofkda <> *loval
     c     *dmy          move      sofkda        a1fkda
     c                   endif
      *
      * Snu forfallsdato
      *
     c                   if        soffda <> *loval
     c     *dmy          move      soffda        a1ffda
     c                   endif
      *
      * Legg inn ordrenummer
      *
     c                   move      sonumm        a1numm
     c                   movel     '/'           a1suff
     c                   move      sosuff        a1suff
      *
      * Hente inn kunderegister
      *
     c                   eval      rkunl1_kund = sokund
     c     rkunl1_key    chain     rkunl1r                            64
     c                   eval      a1kund = sokund
     c                   eval      a1navn = rknavn
     c                   eval      a1gate = rkgate
     c                   eval      a1adr2 = rkadr2
     c                   eval      a1sted = rksted
Till c                   eval      a2betm = rkbetm
Till c                   eval      a2fcop = rkfcop
      *
      * Sjekke tilbuds-kunden
      *
     c                   if        sokund = w_kund
     c                   eval      sokund = solkun
     c                   eval      a1navn = sonavn
     c                   eval      a1gate = soadr1
     c                   eval      a1adr2 = soadr2
     c                   eval      a1sted = sosted
     c                   eval      solkun = *zero
     c                   eval      sonavn = *blank
     c                   eval      soadr1 = *blank
     c                   eval      soadr2 = *blank
     c                   eval      sosted = *blank
     c                   endif
      *
      * Finner hvilken mva-sats
      * som skal benyttes
      *
     c                   call      'FÅ705R'
     c                   parm                    w_firm
3.32 c                   parm                    sofkda
     c                   parm                    w_mvas
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
3.34  *
3.34  * Finner hvilken mva-sats
3.34  * som skal benyttes (for halv sats)
3.34  *
3.34 c                   call      'FÅ706R'
3.34 c                   parm                    w_firm
3.34 c                   parm                    sofkda
3.34 c                   parm                    w_mv2s
3.34 c                   parm                    w_mv2t
3.34 c                   parm                    w_mv2f
      *
      * Hente inn betalings-
      * betingelser
      *
     c                   call      'FÅ703R'
     c                   parm                    w_firm
     c                   parm                    sobetb
     c                   parm                    sofkda
     c                   parm                    w_csts
     c                   parm                    w_ffda
     c                   parm                    a1ctxt
     c                   parm                    w_ctx2
      *
      * Er det registrert
      * leveringsadresse?
      *
     c                   eval      *in31 = *off
     c                   if        sonavn <> *blank
     c                   eval      *in31 = *on
     c                   eval      a2navn = sonavn
     c                   eval      a2adr1 = soadr1
     c                   eval      a2adr2 = soadr2
     c                   eval      a2sted = sosted
     c                   endif
      *
      * Flytte øvrige felter
      *
     c                   eval      a1binr = sobinr
3.12  *
3.12  *  Hent inn firma/avd. opplysninger dersom
3.12  *  kode for det er satt i rutineregister
3.12  *
3.12 c                   if        afprfi = 1 or
3.12 c                             afprfi = 2
3.12 c                   eval      w_prfi = afprfi
3.12 c                   eval      w_ffir = w_firm
3.12 c                   eval      w_avde = soavde
3.12  *
3.12 c                   call      'FÅ707R'
3.12 c                   parm                    w_prfi
3.12 c                   parm                    w_ffir
3.12 c                   parm                    w_avde
3.12 c                   parm                    w_fnav
3.12 c                   parm                    w_fad1
3.12 c                   parm                    w_fad2
3.12 c                   parm                    w_fste
3.12 c                   parm                    w_fftx
3.12 c                   parm                    w_tfax
3.12 c                   parm                    w_ftlf
3.12 c                   parm                    w_ffax
3.12  *
3.12 c                   eval      a1fnav = w_fnav
3.12 c                   eval      a1fad1 = w_fad1
3.12 c                   eval      a1fad2 = w_fad2
3.12 c                   eval      a1fste = w_fste
3.12 c                   eval      a1fftx = w_fftx
3.12 c                   eval      a1tfax = w_tfax
3.12 c                   eval      a1ftlf = w_ftlf
3.12 c                   eval      a1ffax = w_ffax
3.12 c                   endif
5.22  *
5.22  * Legger inn '/' mellom
5.22  * telefon og telefax
5.22  *
5.22 c                   eval      a1skra =  ' '
5.22 c                   if        a1ftlf <> *blank and
5.22 c                             a1ffax <> *blank
5.22 c                   eval      a1skra =  '/'
5.22 c                   endif
      *
      * Skrive heading
      *
     c                   eval      w_tell = 0
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  a1hdr
3.36 c                   write(e)  a2hdr
pdf  c                   else
pdf   * Vi skriver til XML taggene for heading faktura
pdf  c                   if        b_pdfp_first = *off
pdf  c                   exsr      xml_envm
pdf  c                   eval      b_pdfp_first = *on
pdf  c                   endif
pdf  c                   exsr      xml_head_inv
pdf  c                   endif
      *
      * Dersom prosjekt lager og lev.måte
      * ikke er oppgitt, la vær å skrive
      *
     c                   eval      *in34  = *off
5.48 c                   if        a1ldat = 0 and
     c                             a1lage = 0 and
     c                             a1lmtx = *blank
     c                   eval      *in34  = *on
     c                   endif
      *
      * Skriv heading
      * over varelinjer
      *
     c                   eval      a3numm = a1numm
     c                   eval      a3suff = a1suff
     c                   eval      a3avde = a1avde
     c                   eval      a3vref = a1vref
     c                   eval      a3bdat = a1bdat
     c                   eval      a3lage = a1lage
     c                   eval      a3dref = a1dref
5.48 c                   eval      a3ldat = a1ldat
     c                   eval      a3selg = a1selg
     c                   eval      a3lmtx = a1lmtx
     c                   eval      a3rekv = a1rekv
5.47 c                   eval      a3lbet = a1lbet
5.60 c                   eval      a3kpro = a1kpro
5.60 c                   eval      a3epro = a1epro
      *
     c                   eval      w_tell = w_tell + 3
      *
     c                   if        *in34  = *off
     c                   eval      w_tell = w_tell + 1
     c                   endif
      *
     c                   if        *in35  = *on
     c                   eval      w_tell = w_tell + 1
     c                   endif
5.60  *
5.60 c                   if        *in37  = *on
5.60 c                   eval      w_tell = w_tell + 1
5.60 c                   endif
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  a3hdr
pdf   * Vi skriver til XML taggene for heading ordre
pdf  c                   else
pdf  c                   exsr      xml_head_ord
pdf  c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Flere ordre pr.faktura
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xhode2        begsr
      *
     c                   exsr      xhodef
      *
      * Legge inn ordrenr
      * og suffix
      *
     c                   move      sonumm        a1numm
     c                   movel     '/'           a1suff
     c                   move      sosuff        a1suff
      *
      * Dersom prosjekt lager og lev.måte
      * ikke er oppgitt, la vær å skrive
      *
     c                   eval      *in34  = *off
5.48 c                   if        a1ldat = 0 and
     c                             a1lage = 0 and
     c                             a1lmtx = *blank
     c                   eval      *in34  = *on
     c                   endif
      *
      * Skriv heading
      * over varelinjer
      *
     c                   eval      a3numm = a1numm
     c                   eval      a3suff = a1suff
     c                   eval      a3avde = a1avde
     c                   eval      a3vref = a1vref
     c                   eval      a3bdat = a1bdat
     c                   eval      a3lage = a1lage
     c                   eval      a3dref = a1dref
5.48 c                   eval      a3ldat = a1ldat
     c                   eval      a3selg = a1selg
     c                   eval      a3lmtx = a1lmtx
     c                   eval      a3rekv = a1rekv
      *
     c                   eval      w_tell = w_tell + 3
      *
     c                   if        *in34  = *off
     c                   eval      w_tell = w_tell + 1
     c                   endif
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  a3hdr
pdf   * Vi skriver til XML taggene for heading ordre
pdf  c                   else
pdf   * Sørg for at vi har skrevet avsluttende tagger fra forrige ordre
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
pdf  c                   eval      b_ordr = *off
pdf  c                   endif
pdf  c                   exsr      xml_head_ord
pdf  c                   endif
      *
      * Er det overflow ?
      *
3.36 c                   if        %error = '1'
3.36 c                   exsr      xovrfl
3.36 c                   endif
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Felles rutine for XHODE1 og XHODE2
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xhodef        begsr
      *
      * Summere salg og
      * rabatter
      *
     c                   eval      a1vref = *blank
     c                   eval      a1dref = *blank
     c                   eval      a1rekv = *blank
      *
      * Snu ordredato
      *
     c                   if        sobdat <> *loval
     c     *dmy          move      sobdat        a1bdat
     c                   endif
5.48  *
5.48  * Snu leveringsdato
5.48  *
5.48 c                   if        soldat <> *loval
5.48 c     *dmy          move      soldat        a1ldat
5.48 c                   endif
      *
      * Er det registrert
      * rekvisisjon?
      *
     c                   eval      *in35 = *off
     c                   if        sorekv <> *blank
     c                   eval      *in35 = *on
     c                   eval      a1rekv = sorekv
     c                   endif
5.47  *
5.47  * Er det registrert
5.47  * leveringsbetingelser
5.47  *
5.47 c                   eval      w_retk = *blank
5.47 c                   eval      w_rtx1 = *blank
5.47 c                   eval      w_rtx2 = *blank
5.47 c                   eval      w_rtx3 = *blank
5.47 c                   if        solbet <> 0
5.47 c                   eval      *in35  = *on
5.47 c                   call      'RS718R'
5.47 c                   parm                    w_retk
5.47 c                   parm                    solbet
5.47 c                   parm                    w_rtx1
5.47 c                   parm                    w_rtx2
5.47 c                   parm                    w_rtx3
5.47 c                   eval      a1lbet = w_rtx1
5.47 c                   endif
5.60  *
5.60  * Er det kundeprosjekt på
5.60  * denne ordre
5.60  *
5.60 c                   eval      *in37 = *off
5.60 c                   if        sokpro <> 0
5.60 c                   eval      *in37 = *on
5.60 c                   eval      a1kpro = sokpro
5.60 c                   endif
5.60  *
5.60  * Hent over eksternt prosjektnr
5.60  * dersom dette finnes
5.60  *
5.60 c                   if        *in37  = *on
5.60 c                   eval      fkprl1_kund = sokund
5.60 c                   eval      fkprl1_kpro = sokpro
5.60 c     fkprl1_key    chain     fkprl1r
5.60 c                   if        %found
5.60 c                   eval      a1epro = flepro
5.60 c                   endif
5.60 c                   endif
      *
     c                   eval      a1dref = sodref
     c                   eval      a1vref = sovref
     c                   eval      a1avde = soavde
     c                   eval      a1lage = solage
     c                   eval      a1selg = soselg
5.46 c                   eval      a1lmtx = solmtx
3.33  *
3.33  * Skal faktura skrives uten rabatter,
3.33  * kun med nettobeløp ?
3.33  *
3.33 c                   eval      *in39  = *off
3.33 c                   if        soneto = 1
3.33 c                   eval      *in39  = *on
3.33 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * D1DET Behandle detail D1
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xvare1        begsr
      *
      * Nullstilling av variabler
      *
     c                   eval      d1vare = *blank
     c                   eval      d1tek1 = *blank
     c                   eval      d1tek2 = *blank
     c                   eval      d1enh1 = *blank
     c                   eval      d1tine = *blank
     c                   eval      d1info = *blank
5.22 c                   eval      d1lety = *zero
5.22 c                   eval      d3lety = *zero
     c                   eval      d1ant0 = *zero
     c                   eval      d1ant1 = *zero
     c                   eval      d1ant2 = *zero
     c                   eval      d1ant3 = *zero
     c                   eval      *in44 = *off
     c                   eval      *in46 = *off
      *
      * Sjekker om tekstlinjer
      * fra F11
      *
     c     sdktxt        cabeq     1             tag02a
     c     sdktxt        cabeq     5             tag02a
      *
      * Hent linje-type
      *
     c                   eval      vltyl1_ltyp = sdltyp
     c     vltyl1_key    chain     vltyl1r                            68
      *
      * Sjekker om linjen ikke skrives på ordretypen
      *
     c     sdotyp        cabeq     valo01        vslutt
      *
     c     sdotyp        cabeq     valo02        vslutt
      *
     c     sdotyp        cabeq     valo03        vslutt
      *
     c     sdotyp        cabeq     valo04        vslutt
      *
      * Tekstlinjer på
      * varelinjenivå ? (F2)
      *
     c     valktx        cabeq     1             tag02a
      *
      * Oppslag mot vareregister
      *
     c                   eval      vvarl1_vare = sdvare
     c     vvarl1_key    chain     vvarl1r                            69
      *
      * Sjekk om tilbud/netto-pris
      *
     c                   if        sdrab1 = *zero
     c                   eval      *in46 = *on
     c                   eval      d1tine = *blank
     c                   eval      vpkol1_pkod = sdkpri
     c     vpkol1_key    chain     vpkol1r                            69
     c                   if        *in69 = *off
     c                   eval      d1tine = vaptxt
     c                   endif
     c                   endif
      *
      * Sjekk om beløp ikke skal
      * inngå i ordrerabattgrl.
      *
     c                   if        sdkord = 1
     c                   eval      d1info = '*'
     c                   endif
3.13  *
3.13  * Dersom vare er hentet fra LVR,
3.13  * sett inn  2 desimaler som std.
3.13  *
3.13 c                   if        sdlvre = 1
3.13 c                   eval      vvdesi = 2
3.13 c                   endif
      *
      * Test på antall desimaler
      *
     c                   eval      *in40 = vvdesi = 0
     c                   eval      *in41 = vvdesi = 1
     c                   eval      *in42 = vvdesi = 2
     c                   eval      *in43 = vvdesi = 3
     c                   if        *in40 = *on
     c                   eval      d1ant0 = sdanta
     c                   endif
     c                   if        *in41 = *on
     c                   eval      d1ant1 = sdanta
     c                   endif
     c                   if        *in42 = *on
     c                   eval      d1ant2 = sdanta
     c                   endif
     c                   if        *in43 = *on
     c                   eval      d1ant3 = sdanta
     c                   endif
      *
      * Varelinje
      *
     c                   eval      d1vare = sdvare
     c                   eval      d1tek1 = sdtek1
     c                   eval      d1enh1 = sdenh1
5.22 c                   eval      d1lety = sdlety
5.22 c                   eval      d3lety = sdlety
9.01  *
9.01 c                   if        sdbrr1 > 99,99
9.01 c                   eval      d1brr1 = 99,99
9.01 c                   else
9.01 c                   eval      d1brr1 = sdbrr1
9.01 c                   endif
9.01  *
9.01 c                   if        sdbrr2 > 99,99
9.01 c                   eval      d1brr2 = 99,99
9.01 c                   else
9.01 c                   eval      d1brr2 = sdbrr2
9.01 c                   endif
9.01  *
9.01 c                   eval      d1rtxt = *blank
9.01 c                   if        d1brr1 <> 0 or
9.01 c                             d1brr2 <> 0
9.01 c                   eval      d1rtxt = 'Brrab.'
9.01 c                   endif
      *
      * Brutto pris
      *
     c                   eval      d1bpri = sdsapr
3.33 c                   eval      d3bpri = sdsapr
      *
      * Beregne snittrabatt
      *
     c                   eval      w1rab1 = 100 - sdrab1
     c                   eval      w1rab1 = w1rab1 * sdrab2
     c                   eval      w1rab1 = w1rab1 / 100
     c                   eval      w1rab1 = w1rab1 + sdrab1
     c                   eval      d1rabp = w1rab1
Bygm  *
Bygm  * Brutto beløp
Bygm  *
Bygm c                   eval      d1bbel = sdsalg
3.33  *
3.33  * Skal rabatter vises som nettobeløp
3.33  * uten prosentsatser ?
3.33  *
3.33 c                   if        *in39  = *on
3.33 c                   eval      d1bpri = d1bpri -
3.33 c                                     (d1bpri * d1rabp / 100)
3.33 c                   endif
      *
      * Netto beløp
      *
     c                   eval      d1nbel = sdsalg
     c                   eval      d1nbel = d1nbel - sdrkr1
     c                   eval      d1nbel = d1nbel - sdrkr2
9.01  *
9.01  * Bruksrettsrabatter
9.01  *
9.01 c                   eval      d1bgr1 = 0
9.01 c                   eval      d1brb1 = 0
9.01 c                   if        sdbrr1 <> 0
9.01 c                   eval      d1bgr1 = d1nbel
9.01 c                   eval      d1brb1 = (d1bgr1 * sdbrr1) / 100
9.01 c                   endif
9.01  *
9.01 c                   eval      d1bgr2 = 0
9.01 c                   eval      d1brb2 = 0
9.01 c                   if        sdbrr1 <> 0 and
9.01 c                             sdbrr2 <> 0
9.01 c                   eval      d1bgr2 = d1bgr1 - d1brb1
9.01 c                   eval      d1brb2 = (d1bgr2 * sdbrr2) / 100
9.01 c                   endif
6.12  *
6.12  * Akkumuler til fakturatotaler
6.12  *
9.01 c                   eval      t1bgr1 = t1bgr1 + d1bgr1
9.01 c                   eval      t1bgr2 = t1bgr2 + d1bgr2
9.01 c                   eval      t1brb1 = t1brb1 + d1brb1
9.01 c                   eval      t1brb2 = t1brb2 + d1brb2
6.12 c                   eval      t1tnet = t1tnet + d1nbel
6.13 c                   eval      t5tnet = t5tnet + d1bbel
9.01 c                   eval      t1tnet = t1tnet - d1brb1
9.01 c                   eval      t1tnet = t1tnet - d1brb2
6.12  *
6.12  * Henter mva-kode, beregn mva
6.12  * + legger ut riktig sats på varlinje
6.12  *
6.12 c***>               eval      d1mvap = 0
6.12 c                   eval      w_mvas = 0
6.12  *
6.12 c                   if        sdomva <> *blank
6.12 c                   eval      w_stat = *blank
6.12 c                   eval      w_mvak = sdomva
6.12  *
6.12 c                   call      'RS205R'
6.12 c                   parm                    w_stat
6.12 c                   parm                    w_mvak
6.12 c                   parm                    w_mvtx
6.12 c                   parm                    sofkda
6.12 c                   parm                    w_mvas
6.12 c                   parm                    w_mvat
6.12 c                   parm                    w_mvaf
6.12 c                   parm                    w_bpro
6.12  *
6.12 c                   if        w_mvas > 0
6.12 c***>               eval(h)   d1mvap = w_mvas
6.12 c                   exsr      xarray
6.12 c                   endif
6.12 c                   endif
      *
      * Akkumuler til overføringssum
      *
Bygm c                   eval      o1trsp = o1trsp + d1nbel
Bygm c                   eval      o3trsp = o3trsp + sdsalg
      *
      * Skriv varelinjer/
      * tekstlinjer
      *
     c     tag02a        tag
      *
      * Skriv tekstlinjer
      * fra F11
      *
     c                   if        sdktxt = 1
     c                             or sdktxt = 5
     c                   eval      w_tell = w_tell + 1
     c                   eval      d1tek1 = sdtek1
     c                   eval      d1tek2 = sdtek2
     c                   eval      d3tek1 = d1tek1
     c                   eval      d3tek2 = d1tek2
     c                   eval      *in44 = *on
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  d2det
pdf   * Skriver XML tagger for detaljer
pdf  c                   else
pdf  c                   if        sdktxt = 1
pdf  c                   if        b_topt = *off
pdf  c                   exsr      xml_topt_str
pdf  c                   eval      b_topt = *on
pdf  c                   endif
pdf  c                   exsr      xml_topptxt
pdf  c                   else
pdf  c                   if        sdktxt = 5
pdf  c                   if        b_bott = *off
pdf  c                   exsr      xml_bott_str
pdf  c                   eval      b_bott = *on
pdf  c                   endif
pdf  c                   exsr      xml_bunntxt
pdf  c                   endif
pdf  c                   endif
pdf  c                   endif
     c                   goto      tag03a
     c                   endif
      *
      * Skriv varelinjer
      * ordinær/tekst
      *
     c                   eval      d3vare = d1vare
     c                   eval      d3tek1 = d1tek1
     c                   eval      d3ant0 = d1ant0
     c                   eval      d3ant1 = d1ant1
     c                   eval      d3ant2 = d1ant2
     c                   eval      d3ant3 = d1ant3
     c                   eval      d3enh1 = d1enh1
3.33 c***                eval      d3bpri = d1bpri
     c                   eval      d3info = d1info
      *
     c                   if        valktx <> 1
     c                   eval      w_tell = w_tell + 1
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  d1det
pdf  c                   endif
     c                   else
     c                   eval      w_tell = w_tell + 1
     c                   eval      d1tek1 = sdtek1
     c                   eval      d1tek2 = sdtek2
     c                   eval      d3tek1 = d1tek1
     c                   eval      d3tek2 = d1tek2
     c                   eval      *in44 = *on
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  d2det
pdf  c                   endif
     c                   endif
5.22  *
5.22  * Er det overflow ?
5.22  *
5.22 c                   if        %error = '1'
5.22 c                   exsr      xovrfl
5.22 c                   endif
5.22  *
5.22  * Skrive tekst 2,
5.22  * dersom den er oppgitt
5.22  *
5.22 c                   if        valktx <> 1
9.01 c                   if        sdtek2 <> *blank or
9.01 c                             d1rtxt <> *blank
5.22 c                   eval      d1tek2 = sdtek2
5.22 c                   eval      d3tek2 = sdtek2
5.22 c                   eval      w_tell = w_tell + 1
pdf  c                   if        b_pdfp = *off
5.22 c                   write(e)  d1det2
pdf  c                   endif
5.22 c                   endif
5.22 c                   endif
pdf   * Skriver XML tagger for detaljer
pdf  c                   if        b_pdfp = *on
pdf  c                   exsr      xml_deta
6.21  * Finnes det allmenningsrabatt ?
6.21 c                   if        d1rtxt <> *blank
6.21 c                   exsr      xml_usrdisc
6.21 c                   endif
pdf  c                   endif
      *
     c     tag03a        tag
      *
      * Er det overflow ?
      *
3.36 c                   if        %error = '1'
3.36 c                   exsr      xovrfl
3.36 c                   endif
      *
     c     vslutt        endsr
6.12  *
6.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.12  * Subrutine for array-håndtering av mva
6.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.12  *
6.12 c     xarray        begsr
6.12  *
6.12 c     1             do        9             m
6.12 c                   if        mko(m) = w_mvak or
6.12 c                             mko(m) = ' '
6.12 c                   eval      mko(m) = w_mvak
6.12 c                   eval      msa(m) = w_mvas
6.12 c                   eval      mgr(m) = mgr(m) + d1nbel
6.13 c                   eval      ngr(m) = ngr(m) + d1bbel
6.12  *
6.12 c                   if        sorabp > 0
6.12 c                   if        vvkord = 0
6.12 c                   eval      mog(m) = mog(m) + d1nbel
6.12 c                   eval      w_orab = d1nbel * sorabp / 100
6.12 c                   eval      mor(m) = mor(m) + w_orab
6.12 c                   endif
6.12 c                   endif
6.12  *
6.12 c                   leave
6.12 c                   endif
6.12 c                   enddo
6.12  *
6.12 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for ordre-rabatt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xorrab        begsr
      *
     c                   if        sorabp <> *zero
     c                   eval      w_tell = w_tell + 1
     c                   eval      r1rabp = sorabp
     c                   eval      r1rabg = sorbgp + sorbgf
3.34 c                   eval      r1rabg = r1rabg + sorbgh
     c                   eval      r1rabb = sorkop + sorkof
3.34 c                   eval      r1rabb = r1rabb + sorkoh
     c                   eval      r1rabb = r1rabb * -1
6.12 c                   eval      t1tnet = t1tnet + r1rabb
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  r1tot
pdf  c                   else
pdf  c                   exsr      xml_rabatt
pdf  c                   endif
     c                   endif
3.36  *
3.36  * Er det overflow ?
3.36  *
3.36 c                   if        %error = '1'
3.36 c                   exsr      xovrfl
3.36 c                   endif
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * T1TOT Behandle total T1
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xtotal        begsr
6.11  *
6.11  * Henter inn siste post fra fakturahode
6.11  *
6.11 c                   eval      sohelr_binr = sobinr
6.11 c                   eval      sohelr_numm = 999999
6.11 c                   eval      sohelr_suff = 99
6.11 c     sohelr_key    setll     sohelrr
6.11 c                   readp     sohelrr                                63
      *
      * Legg ut eksakt fakturabeløp
      *
6.12 c                   eval      t1fsum = sofsum
5.62  *
5.62  * Sjekke om det er depositum
5.62  *
5.62 c                   if        sodept <> 0
5.62 c                   eval      r2totb = sofsum
5.62 c                   eval      r2dept = sodept
6.12 c                   eval      t1fsum = t1fsum - sodept
5.62 c                   eval      w_tell = w_tell + 1
pdf  c                   if        b_pdfp = *off
5.62 c                   write(e)  r2tot
pdf  c                   else
pdf  c                   exsr      xml_depositum
pdf  c                   endif
5.62 c                   endif
9.01  *
9.01  * Legg inn en blank linje før utskrift
9.01  * av almenningsrabatter dersom de finnes
9.01  *
9.01 c                   if        t1brb1 <> 0 or
9.01 c                             t1brb2 <> 0
9.01 c                   eval      w_tell = w_tell + 1
6.21 c                   if        b_pdfp = *off
9.01 c                   write(e)  d3det0
6.21 c                   endif
9.01 c                   endif
9.01  *
9.01  * Er det overflow ?
9.01  *
9.01 c                   if        %error = '1'
9.01 c                   exsr      xovrfl
9.01 c                   endif
9.01  *
9.01  * Skrive ut almenningsrabatter
9.01  * dersom de finnes
9.01  *
9.01  * Bruksrettrabatt 1
9.01  *
9.01 c                   if        t1brb1 <> 0                                  Mva. grunnl.
9.01 c                   eval      d3tek1 = 'Bruksrettrabatt 1 (Grunnl/Rab)'
9.01 c                   eval      d3bgr1 = t1bgr1
9.01 c                   eval      d3brb1 = t1brb1 * -1
9.01 c                   eval      w_tell = w_tell + 1
6.21 c                   if        b_pdfp = *off
9.01 c                   write(e)  d3det1
6.21 c                   else
6.21 c                   exsr      xml_usrsum1
6.21 c                   endif                                                  Mva. grunnl.
9.01 c                   endif                                                  Mva. grunnl.
9.01  *
9.01  * Er det overflow ?
9.01  *
9.01 c                   if        %error = '1'
9.01 c                   exsr      xovrfl
9.01 c                   endif
9.01  *
9.01  * Bruksrettrabatt 2
9.01  *
9.01 c                   if        t1brb2 <> 0                                  Mva. grunnl.
9.01 c                   eval      d3tek2 = 'Bruksrettrabatt 2 (Grunnl/Rab)'
9.01 c                   eval      d3bgr2 = t1bgr2
9.01 c                   eval      d3brb2 = t1brb2 * -1
9.01 c                   eval      w_tell = w_tell + 1
6.21 c                   if        b_pdfp = *off
9.01 c                   write(e)  d3det2
6.21 c                   else
6.21 c                   exsr      xml_usrsum2
6.21 c                   endif                                                  Mva. grunnl.
9.01 c                   endif                                                  Mva. grunnl.
9.01  *
9.01  * Er det overflow ?
9.01  *
9.01 c                   if        %error = '1'
9.01 c                   exsr      xovrfl
9.01 c                   endif
5.62  *
5.62  * Oppdater antall linjer pr. faktura
5.62  *
5.62 c                   eval      t3tell = t3tell + w_tell
pdf   * Skriver netto for faktura
pdf  c                   if        b_pdfp = *on
pdf  c                   exsr      xml_netto
pdf  c                   endif
6.12  *
6.12  * Beregner mva for de forskjellige satser
6.12  *
6.12 c                   eval      mbe = (mgr - mor) * msa / 100
6.12 c                   xfoot     mbe           t1tmva
6.13 c                   eval      nbe =  ngr        * msa / 100
6.13 c                   xfoot     nbe           t5tmva
6.12  *
6.12 c     1             do        9             m
6.12 c                   if        mko(m) <> ' '
6.12 c                   eval      t1mvas = msa(m)
6.12 c                   eval      t1mvag = mgr(m) - mor(m)
6.12 c                   eval      t1mvab = mbe(m)
6.13 c                   eval      t5mvas = msa(m)
6.13 c                   eval      t5mvag = ngr(m)
6.13 c                   eval      t5mvab = nbe(m)
pdf  c                   if        b_pdfp = *off
6.12 c                   write     t1tot2                               30
pdf  c                   else
pdf  c                   exsr      xml_vat
pdf  c                   endif
6.12 c                   endif
6.12 c                   enddo
      *
      * Finne ut om det er
      * plass til å skrive
      * avslutning uten å
      * skifte til ny side
      * først.
      *
      * Skrive ny heading ?
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   if        (d_linnbr + 2) > 86
3.36 c                   eval      a1side = a1side + 1
3.36 c                   write(e)  a1hdr
3.36 c                   write(e)  a2hdr
     c                   eval      w_tell = 0
     c                   endif
pdf  c                   endif
      *
5.04  * Klargjøring av kidd-nummer
5.04  *
5.04 c                   if        d_kidk <> 0
5.04 c                   eval      t1hkid = 'KID-nummer'
5.04 c                   endif
5.04  *
5.04 c                   if        d_kidk = 1
5.04 c                   movel     sokidd        t1kkid
5.04 c                   endif
5.04  *
5.04 c                   if        d_kidk = 2
5.04 c                   movel     sokidr        t1kkid
5.04 c                   endif
6.22  *
6.22 c                   if        d_kidk = 3
6.22 c                   movel     sokidr        w_kidr
6.22 c                   call      'AK710R'
6.22 c                   parm                    w_firm
6.22 c                   parm                    w_kidr
6.22 c                   parm                    w_kidd
6.22 c                   parm                    w_kid2
6.22 c                   movel     w_kid2        t1kkid
6.22 c                   endif
      *
      *
      * Beregne modulus 10
      * på beløpsfeltet
      *
     c                   move      *blank        kidd10
6.12 c                   move      t1fsum        kidd10
     c                   exsr      mod10
     c                   move      ksif10        t1bsif
6.13 c                   eval      t5fsum = t5tnet + t5tmva
      *
      * Skrive totalsum
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  t1tot
pdf  c                   else
pdf  c                   exsr      xml_totaler
pdf  c                   endif
6.15  *
6.15  * Null-stilling av array's
6.15  *
6.15 c                   eval      mko = *blank
6.15 c                   eval      msa = *zero
6.15 c                   eval      mgr = *zero
6.15 c                   eval      mbe = *zero
6.15 c                   eval      mog = *zero
6.15 c                   eval      mor = *zero
6.15 c                   eval      ngr = *zero
6.15 c                   eval      nbe = *zero
6.15  *
6.15 c                   eval      t1tnet = 0
6.15 c                   eval      t5tnet = 0
9.01 c                   eval      t1bgr1 = 0
9.01 c                   eval      t1bgr2 = 0
9.01 c                   eval      t1brb1 = 0
9.01 c                   eval      t1brb2 = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xovrfl        begsr
      *
     c                   eval      a1side = a1side + 1
pdf  c                   if        b_pdfp = *off
     c                   eval      *in45 = *on
3.36 c                   write(e)  o1det
3.36 c                   write(e)  a1hdr
3.36 c                   write(e)  a2hdr
     c                   eval      *in45 = *off
3.36 c                   write(e)  o1det
pdf  c                   endif
     c                   eval      t3tell = t3tell + w_tell
     c                   eval      w_tell = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * MDMEMBER *** Kopiert inn fra MODUS10 copy-member. ***
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Husk!! inn før /COPY av MODUS10 i ditt program følgende
      * statmemnt:
      *                    MOVE *BLANK    KIDD10 24
      *                    MOVE 'felt'    KIDD10
      *  'felt' må byttes ut med det felt som det i hvert tilfelle
      *         skal beregnes MODULUS 10 av.
      *
      *     Kall av subrutine MOD10 for modulus-10 utregning.
      *
      *                    EXSR MOD10
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Husk!! Felt KSIF10, KIDD10 inneholder h.h.v. sjekksiffer/
      *        utregningssiffer (beløp-kundeident.felt e.l.).
      *        Dersom det i programmet er flere modulus 10 sjekker
      *        må disse feltene bevares i egne opprettede felt, fordi
      *        de vil endres ved hver modulus 10 sjekk da de brukes
      *        omigjen.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     CSR   MOD10         BEGSR
      *
      * MDMEMBER *** Kopiert inn fra MODUS10 copy-member. ***
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *        Start subrutinen for modulus-10 utregning.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
     C                   Z-ADD     1             XX                2 0
     C                   Z-ADD     2             YY                2 0
     C                   Z-ADD     2             FA10              1 0
     C                   Z-ADD     0             MODS10            3 0
     C                   Z-ADD     0             MODR10            1 0
     C                   Z-ADD     0             KSIF10            1 0
      *
      * På grunn av forskjeller mellom S/36 og AS400
      * må MOVEA gå via et alfa-array før det legges
      * over i et nummerisk array.
      *
     C                   MOVEA     KIDD10        A10
     C                   MOVE      A10           M10
      *
     C     UTR10         TAG
      *
     C     XX            IFGT      12
     C                   Z-ADD     1             XX
     C                   Z-ADD     1             YY
     C                   GOTO      ADD10
     C                   ELSE
     C     M10(YY)       MULT      FA10          U10(XX)
     C     M10(YY)       IFGT      4
     C                   ADD       1             MODS10
     C                   END
     C                   ADD       1             XX
     C                   ADD       2             YY
     C                   GOTO      UTR10
     C                   END
      *
     C     ADD10         TAG
      *
     C     XX            IFGT      12
     C                   GOTO      SIF10
     C                   END
     C                   ADD       U10(XX)       MODS10
     C                   ADD       M10(YY)       MODS10
     C                   ADD       1             XX
     C                   ADD       2             YY
      *
     C                   GOTO      ADD10
      *
     C     SIF10         TAG
     C                   MOVE      MODS10        MODR10
     C     10            SUB       MODR10        KSIF10
      *
     C                   ENDSR
5.31  *
5.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.31  * Subrutine for kontroll av utgående fakturalogg / fakturatype
5.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.31  *
5.31 c     sjk_uf_log    begsr
5.31  *
5.31 c                   eval      b_nopr = *off
5.31  *
5.31 c                   eval      fnufl1_aarr = soaarr
5.31 c                   eval      fnufl1_binr = sobinr
5.31 c     fnufl1_key    chain     fnufl1
5.31 c                   if        not %found
5.31 c                   leavesr
5.31 c                   endif
5.31  *
5.31 c                   eval      fmftl1_faty = fnufat
5.31 c     fmftl1_key    chain     fmftl1
5.31 c                   if        not %found
5.31 c                   leavesr
5.31 c                   endif
5.31  *
5.31  * Sjekk indikatorer :Undertrykk utskrift=Ja(1) og Test=Nei(0)
5.31  *
5.49 c                   if        d_kopi = *blank
5.31 c                   if        fmtuts = 1
5.31 c                   if        fmttes = 0
5.31 c                   eval      b_nopr = *on
5.31 c                   endif
5.31 c                   endif
5.49 c                   endif
5.31  *
5.31 c                   endsr
6.11  *
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  * Subrutine for å sjekke om ordre har varelinjer
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  *
6.11 c     sjk_varlin    begsr
6.11  *
6.11 c                   eval      b_nopr = *off
6.11  *
6.11 c                   eval      sodtlr_aarr = soaarr
6.11 c                   eval      sodtlr_binr = sobinr
6.11 c                   eval      sodtlr_numm = sonumm
6.11 c                   eval      sodtlr_suff = sosuff
6.11 c     sodtlr_key    setll     sodtlrr
6.11 c                   read      sodtlrr
6.11 c                   if        sdaarr <> soaarr or
6.11 c                             sdbinr <> sobinr or
6.11 c                             sdnumm <> sonumm or
6.11 c                             sdsuff <> sosuff
6.11 c                   eval      b_nopr = *on
6.11 c                   endif
6.11  *
6.11 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for oppstart
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xstrsr        begsr
      *
     c                   eval      a1side = 1
     c                   eval      fcycle = 1
      *
      * Legger inn firma i nøkkel
      *
     c                   eval      w_firm = l_firm
      *
      * Legger inn år i nøkkel
      *
     c                   eval      sohel1_aarr = d_aarr
6.11 c                   eval      sohelr_aarr = d_aarr
     c                   eval      sodtl1_aarr = d_aarr
6.11 c                   eval      sodtlr_aarr = d_aarr
      *
      * Klargjøre resterende
      * nøkkelbegrep
      *
     c                   eval      sohel1_binr = d_ffnr
     c                   eval      sohel1_numm = *zero
     c                   eval      sohel1_suff = *zero
     c                   eval      sodtl1_ktxt = *zero
     c                   eval      sodtl1_line = *zero
      *
     c     sohel1_key    setll     sohel1
     c                   read      sohel1                                 61
     c                   eval      sodtl1_ktxt = *zero
     c                   eval      sodtl1_line = *zero
      *
      * Klargjøring dersom firma -
      * opplysninger skal printes ut
      *
5.60 c                   eval      a1ibah = *blank
5.60 c                   eval      a1ibat = *blank
5.60 c                   eval      a1swih = *blank
5.60 c                   eval      a1swit = *blank
5.60  *
     c                   if        afprfi = 1 or
     c                             afprfi = 2
     c     afirl1_key    chain     afirl1r                            66
      *
      * Bankgironummer må
      * redigeres inn i et
      * alfafelt p.g.a. OCR
      *
     c                   eval      a1fbgi = aafbgi
     c                   eval      t1fbgi = aafbgi
5.60  *
5.60  * Klargjør IBAN og SWIFT
5.60  * dersom dette er lagt inn
5.60  *
5.60 c                   if        aaiban <> *blank
5.60 c                   eval      a1ibah =  'IBAN :'
5.60 c                   eval      a1ibat =  aaiban
5.60 c                   endif
5.60  *
5.60 c                   if        aaswif <> *blank
5.60 c                   eval      a1swih =  'SWIFT:'
5.60 c                   eval      a1swit =  aaswif
5.60 c                   endif
5.60  *
     c                   endif
      *
      * Hente Kunde-tilbuds-nummer
      *
     c     fstsl1_key    chain     fstsl1r                            69
      *
     c                   if        *in69 = *off
     c                   eval      w_kund = faakun
     c                   endif
      *
      * Slår opp ordretype
      *
     c                   eval      votyl1_otyp = d_otyp
     c     votyl1_key    chain     votyl1r                            67
      *
      * Er ordretype negativ ?
      *
     c                   if        vaokre = '-'
     c                   eval      *in36 = *on
     c                   endif
      *
      * Sjekke om dette er en
      * faktura-kopi
      *
pdf  c                   eval      w_copy = *blanks
     c                   if        d_kopi = 'K'
     c                   eval      *in50 = *on
pdf  c                   if        *in36 = *off
pdf  c                   eval      w_copy = 'FAKTURAKOPI'
pdf  c                   else
pdf  c                   eval      w_copy = 'KREDITNOTAKOPI'
pdf  c                   endif
pdf  c                   else
pdf  c                   if        *in36 = *off
pdf  c                   eval      w_copy = 'FAKTURA'
pdf  c                   else
pdf  c                   eval      w_copy = 'KREDITNOTA'
pdf  c                   endif
     c                   endif
6.12  *
6.12  * Nullstilling av array's
6.12  *
6.12 c                   eval      mko = *blank
6.12 c                   eval      msa = *zero
6.12 c                   eval      mgr = *zero
6.12 c                   eval      mbe = *zero
6.12 c                   eval      mog = *zero
6.12 c                   eval      mor = *zero
6.13 c                   eval      ngr = *zero
6.13 c                   eval      nbe = *zero
6.12  *
6.12 c                   eval      t1tnet = 0
6.13 c                   eval      t5tnet = 0
      *
     c                   endsr
      *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_envm      begsr
pdf   * Hvis skjermvisning skal vi ikke lagre i spoolfile
pdf2 c*                  if        l_skje = 1
pdf  c                   eval      w_spol = 'true'
pdf2 c*                  else
pdf2 c*                  eval      w_spol = 'false'
pdf2 c*                  endif
pdf   *
pdf   /Free
pdf        // Finne nytt batch nummer
pdf            UpdHTMLVar('BatchNo':             w_jkey);
pdf            UpdHTMLVar('Batchtype':        'FAKTURA');
pdf            UpdHTMLVar('Username':            l_user);
pdf            WrtSection('Topp');
pdf        // Finn credential variabler
pdf            UpdHTMLVar('IPAdr':                  ' ');
pdf            UpdHTMLVar('User':                l_user);
pdf            UpdHTMLVar('PW':                     ' ');
pdf            UpdHTMLVar('Schema':        'ADB'+l_filg);
pdf            UpdHTMLVar('Companyno':    %char(l_firm));
pdf            WrtSection('Credential');
pdf        // Finn report command variabler
pdf            UpdHTMLVar('Jaspertemplate':      d_jasm);
pdf            UpdHTMLVar('Logo':           jasper_logo);
pdf            UpdHTMLVar('Keepspool':           w_spol);
pdf            WrtSection('ReportCommand');
pdf   /End-free
pdf   *
pdf   * Hvis skjermvisning skal ikke PDF skrives
pdf   *
pdf  c                   if        l_skje = 0
pdf   *
pdf  c                   if        l_land = 1
pdf  c                   eval      w_land = 'LANDSCAPE'
pdf  c                   else
pdf  c                   eval      w_land = 'PORTRAIT'
pdf  c                   endif
pdf   * Hent inn skuffinformasjon for skriveren
pdf  c                   eval      w_draw1 = *blank
pdf  c                   eval      w_draw2 = *blank
pdf  c                   call      'AP611R'
pdf  c                   parm                    l_filg
pdf  c                   parm                    l_outq
pdf  c                   parm                    w_draw1
pdf  c                   parm                    w_draw2
pdf   *
pdf   /Free
pdf        // Finn print informasjon
pdf            UpdHTMLVar('Printername':         l_outq);
pdf            UpdHTMLVar('Copies':       %char(l_akop));
pdf            UpdHTMLVar('Papersource':        w_draw1);
pdf            UpdHTMLVar('Lastpagedrawer':     w_draw2);
pdf            UpdHTMLVar('Duplex':             'false');
pdf            UpdHTMLVar('Quality':                ' ');
pdf            UpdHTMLVar('Sorting':                ' ');
pdf            UpdHTMLVar('Staple':              'true');
pdf            UPDHTMLVar('Alignment':           w_land);
pdf            WrtSection('PrintCommand');
pdf   /End-free
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading faktura         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_head_inv  begsr
pdf   *
pdf  c                   eval      w_mtxt = *blanks
pdf  c                   eval      x_numm = %char(a1numm)+a1suff
pdf  c                   eval      x_vref = %char(a1selg)+' '+a1vref
pdf  c     *hms          move      sotime        w_time
pdf  c**                 eval      x_betb = a1btx1 + ' ' + a1btx2
pdf   *
pdf   * Hvis mail skal skrives, må vi hente mail informasjon
pdf   *
pdf  c                   if        l_mail = 1
pdf  c                   eval      p_kule = *blank
pdf  c                   eval      p_kund = a1kund
pdf  c                   eval      p_kpro = a1kpro
pdf  c                   eval      p_numm = sonumm
pdf  c                   eval      p_selg = soselg
pdf   * Henter tilbake mailserver
pdf  c                   eval      p_serv = *blank
pdf  c                   eval      p_stat = *blank
pdf  c                   call      'AM705C'
pdf  c                   parm                    p_serv
pdf  c                   parm                    p_stat
pdf   *
pdf  c                   call      'FO798R'
pdf  c                   parm                    p_kule
pdf  c                   parm                    p_kund
pdf  c                   parm                    p_kpro
pdf  c                   parm                    p_numm
pdf  c                   parm                    p_selg
pdf  c                   parm                    p_navn
pdf  c                   parm                    p_emal
pdf  c                   parm                    p_emne
pdf  c                   parm                    p_txt1
pdf  c                   parm                    p_txt2
pdf  c                   parm                    p_txt3
pdf  c                   parm                    p_txt4
pdf  c                   parm                    p_pers
pdf  c                   parm                    p_ema2
pdf  c                   parm                    p_inif
pdf  c                   parm                    p_in03
pdf  c                   eval      w_mtxt = p_txt1+p_txt2+p_txt3+p_txt4
pdf   *
pdf  c                   if        p_ema2 = *blanks
pdf  c                   eval      p_ema2 = d_emal
pdf  c                   endif
pdf   *
pdf  c                   if        p_in03 = *off
pdf   *
pdf   /Free
pdf        // Skriv mailinformasjon
pdf            UpdHTMLVar('Receivers':           p_emal);
pdf            UpdHTMLVar('CC':                     ' ');
pdf            UpdHTMLVar('BCC':                 p_ema2);
pdf            UpdHTMLVar('Sender':              p_ema2);
pdf            UpdHTMLVar('Subject':             p_emne);
pdf            UpdHTMLVar('Message':             w_mtxt);
pdf            UpdHTMLVar('SMTPServer':          p_serv);
pdf            UPDHTMLVar('SMTPUser':               ' ');
pdf            UPDHTMLVar('SMTPPw':                 ' ');
pdf            WrtSection('MailCommand');
pdf   /End-free
pdf  c                   endif
pdf  c                   endif
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Firma
6.17 c                   eval      w_1fnav = *blank
6.17 c                   eval      w_1fad1 = *blank
6.17 c                   eval      w_1fad2 = *blank
6.17 c                   eval      w_1navn = *blank
6.17 c                   eval      w_1gate = *blank
6.17 c                   eval      w_1adr2 = *blank
6.17 c                   eval      w_2navn = *blank
6.17 c                   eval      w_2adr1 = *blank
6.17 c                   eval      w_2adr2 = *blank
      *
6.19 c**                 movel     a1fnav        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1fnav        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_1fnav
6.19 c                   movel     p_str_out     w_1fnav
      *
6.19 c**                 movel     a1fad1        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1fad1        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_1fad1
6.19 c                   movel     p_str_out     w_1fad1
      *
6.19 c**                 movel     a1fad2        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1fad2        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     a1fad2
6.19 c                   movel     p_str_out     w_1fad2
      *
      * Vi må oversette aktuelle tekster til "xml" tegn - Partner
      *
6.19 c**                 movel     a1navn        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1navn        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.17 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_1navn
6.19 c                   movel     p_str_out     w_1navn
      *
6.19 c**                 movel     a1gate        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1gate        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_1gate
6.19 c                   movel     p_str_out     w_1gate
      *
6.19 c**                 movel     a1adr2        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1adr2        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_1adr2
6.19 c                   movel     p_str_out     w_1adr2
pdf   /Free
pdf
pdf        // Skriv firmavariabler
6.17      //   UpdHTMLVar('CompanyName':           a1fnav);
6.17           UpdHTMLVar('CompanyName':          w_1fnav);
6.17      //   UpdHTMLVar('Companyadress1':        a1fad1);
6.17           UpdHTMLVar('Companyadress1':       w_1fad1);
6.17      //   UpdHTMLVar('Companyadress2':        a1fad2);
6.17           UpdHTMLVar('Companyadress2':       w_1fad2);
pdf            UpdHTMLVar('Companypostalcode':        ' ');
pdf            UpdHTMLVar('Companypostoffice':     a1fste);
pdf            UpdHTMLVar('Companyphone':          a1ftlf);
pdf            UpdHTMLVar('Companyfax':            a1ffax);
pdf            UpdHTMLVar('Companyorgno':          a1fftx);
pdf            UpdHTMLVar('Companygiro':    %char(a1fbgi));
pdf            UpdHTMLVar('Companyemail':          aamail);
pdf            UpdHTMLVar('Companywebpage':           ' ');
pdf            WrtSection('Company');
pdf
pdf            test(de) *dmy a1fkda;
pdf            if %error;
pdf            tmpdate = *loval;
pdf            else;
pdf            tmpdate = %date(a1fkda : *dmy);
pdf            endif;
pdf            UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
pdf
pdf            test(te) *hms w_time;
pdf            if %error;
pdf            tmptime = *loval;
pdf            else;
pdf            tmptime = %time(w_time : *hms);
pdf            endif;
pdf            UpdHTMLVar('Creationtime': %char(tmptime : *hms));
pdf            WrtSection('Creation');
pdf
pdf        // Skriv partnerinfo (kunde)
pdf            UpdHTMLVar('Partnerno':       %char(a1kund));
pdf            UpdHTMLVar('Partnercategory': %char(rkkatg));
6.17       //  UpdHTMLVar('Partnername':           a1navn);
6.17           UpdHTMLVar('Partnername':          w_1navn);
6.17       //  UpdHTMLVar('Partneradress1':        a1gate);
6.17           UpdHTMLVar('Partneradress1':       w_1gate);
6.17       //  UpdHTMLVar('Partneradress2':        a1adr2);
6.17           UpdHTMLVar('Partneradress2':       w_1adr2);
pdf            UpdHTMLVar('Partnerpostalcode':         ' ');
pdf            UpdHTMLVar('Partnerpostoffice':      a1sted);
pdf            UpdHTMLVar('Partnerphone':           rktlfn);
pdf            UpdHTMLVar('Partnercellphone':       somobi);
pdf            UpdHTMLVar('Partnerfax':                ' ');
pdf        //  UpdHTMLVar('Salesdocumentno':        x_numm);
pdf            UpdHTMLVar('Salesdocumentno': %char(a1binr));
pdf        //  UpdHTMLVar('Invoiceno':       %char(a1binr));
pdf            UpdHTMLVar('Partnerrefname':         a1dref);
pdf            UpdHTMLVar('Partnerrefphone':           ' ');
pdf            UpdHTMLVar('Partnerrefmail':            ' ');
pdf            WrtSection('Partner');
pdf
pdf        // Selger informasjon
pdf            UpdHTMLVar('Salesrefno':     %char(a1selg));
pdf            UpdHTMLVar('Salesrefname':          a1vref);
pdf            WrtSection('SalesRef');
pdf   /End-free
pdf   *
pdf  c                   if        %trim(a2navn) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Prosjekt
pdf   *
6.19 c**                 movel     a2navn        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a2navn        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_2navn
6.19 c                   movel     p_str_out     w_2navn
      *
6.19 c**                 movel     a2adr1        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a2adr1        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_2adr1
6.19 c                   movel     p_str_out     w_2adr1
      *
6.19 c**                 movel     a2adr2        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a2adr2        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_2adr2
6.19 c                   movel     p_str_out     w_2adr2
pdf   *
pdf   /Free
pdf        // Prosjekt informasjon
pdf            UpdHTMLVar('Projectno':      %char(a1kpro));
6.17       //  UpdHTMLVar('Projectname':           a2navn);
6.17           UpdHTMLVar('Projectname':          w_2navn);
6.17       //  UpdHTMLVar('Projectadress1':        a2adr1);
6.17           UpdHTMLVar('Projectadress1':       w_2adr1);
6.17       //  UpdHTMLVar('Projectadress2':        a2adr2);
6.17           UpdHTMLVar('Projectadress2':       w_2adr2);
pdf            UpdHTMLVar('Projectpostalcode':        ' ');
pdf            UpdHTMLVar('Projectpostoffice':     a2sted);
pdf            WrtSection('Project');
pdf   /End-free
pdf  c                   endif
pdf   /Free
pdf
pdf            test(de) *dmy a1ffda;
pdf            if %error;
pdf            tmpdate = *loval;
pdf            else;
pdf            tmpdate = %date(a1ffda : *dmy);
pdf            endif;
pdf            UpdHTMLVar('Duedate':   %char(tmpdate : *iso));
pdf            UpdHTMLVar('Paymentcondition':         a1ctxt);
pdf            UpdHTMLVar('Deliverymethod':              ' ');
pdf            UpdHTMLVar('Discountcategory':  %char(sorkat));
pdf            WrtSection('DueDate');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading ordre           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_head_ord  begsr
pdf   *
pdf  c                   eval      x_numm = %char(a1numm)+a1suff
pdf  c                   eval      b_ordr = *on
pdf   *
pdf   /Free
pdf        // Ordreheading informasjon
pdf            UpdHTMLVar('Orderno':                  x_numm);
pdf            test(de) *dmy a1bdat;
pdf            if %error;
pdf            tmpdate = *loval;
pdf            else;
pdf            tmpdate = %date(a1bdat : *dmy);
pdf            endif;
pdf            UpdHTMLVar('Orderdate': %char(tmpdate : *iso));
pdf
pdf            test(de) *dmy a1ldat;
pdf            if %error;
pdf            tmpdate = *loval;
pdf            else;
pdf            tmpdate = %date(a1ldat : *dmy);
pdf            endif;
pdf            UpdHTMLVar('Deliverydate': %char(tmpdate : *iso));
pdf            UpdHTMLVar('Salespersonno':        %char(a1selg));
pdf            UpdHTMLVar('Salespersonname':             a1vref);
pdf            UpdHTMLVar('Customerreference':           a1dref);
pdf            UpdHTMLVar('Department':           %char(a1avde));
pdf            UpdHTMLVar('Wharehouse':           %char(a1lage));
pdf            UpdHTMLVar('Deliverytype':                a1lmtx);
pdf            UpdHTMLVar('Deliverycondition':           a1lbet);
pdf            UpdHTMLVar('Customerproject':      %char(a1kpro));
pdf            UpdHTMLVar('Externalproject':             a1epro);
pdf            UpdHTMLVar('Requisitionno':               a1rekv);
pdf            WrtSection('OrderStart');
pdf
pdf        //  Legg ut 'heading' på linje
pdf            WrtSection('InvoiceLines');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Detaljer                *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_deta      begsr
pdf   * Sørg for at vi har skrevet siste tag for topptext før vi begynner
pdf   * med detaljer.
pdf  c                   if        b_topt = *on
pdf  c                   exsr      xml_topt_end
pdf  c                   eval      b_topt = *off
pdf  c                   endif
pdf   *
pdf  c                   if        valktx <> 1
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Varetekster
6.17 c                   eval      w_tek1 = *blank
6.17 c                   eval      w_tek2 = *blank
      *
6.19 c**                 movel     d1tek1        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_tek1
6.19 c                   movel     p_str_out     w_tek1
pdf   *
pdf  c                   if        d1tek2 <> *blank
6.19 c**                 movel     d1tek2        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_tek2
6.19 c                   movel     p_str_out     w_tek2
pdf  c                   endif
pdf   *
pdf  c                   eval      w_mark = 'false'
pdf  c                   if        d1info = '*'
pdf  c                   eval      w_mark = 'true '
pdf  c                   endif
pdf   * Håndtere riktig antall desimaler
pdf  c                   if        *in40 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant0))
pdf  c                   callp     updHTMLVar('NoDecimals':        '0')
pdf  c                   elseif    *in41 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant1))
pdf  c                   callp     updHTMLVar('NoDecimals':        '1')
pdf  c                   elseif    *in42 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant2))
pdf  c                   callp     updHTMLVar('NoDecimals':        '2')
pdf  c                   elseif    *in43 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant3))
pdf  c                   callp     updHTMLVar('NoDecimals':        '3')
pdf  c                   endif
pdf   *
pdf   /Free
pdf        // Skriv detaljer
pdf            UpdHTMLVar('Itemno':             d1vare);
6.17       //  UpdHTMLVar('Text1':              d1tek1);
6.17           UpdHTMLVar('Text1':              w_tek1);
6.17       //  UpdHTMLVar('Text2':              d1tek2);
6.17           UpdHTMLVar('Text2':              w_tek2);
pdf        //  UpdHTMLVar('Quantity':     %char(d1ant2));
pdf            UpdHTMLVar('Unit':                d1enh1);
pdf            UpdHTMLVar('VAT':          %char(w_mvas));
pdf        //  UpdHTMLVar('Vat':       %xlate(',':'.':%char(d1mvap)));
pdf            UpdHTMLVar('Bookingno':   %char(sdbenr));
pdf            UpdHTMLVar('Bookingno':             '0');
pdf            UpdHTMLVar('Linetype':           sdltyp);
pdf            UpdHTMLVar('Priceexvat':   %char(d1bpri));
pdf            UpdHTMLVar('Discount1':     %char(d1rabp));
pdf            UpdHTMLVar('Discount2':            '0.00');
pdf            UpdHTMLVar('Netamount':    %char(d1nbel));
pdf            UpdHTMLVar('Additionalfee':        '0.00');
pdf            UpdHTMLVar('Totalsum':     %char(d1nbel));
pdf            UpdHTMLVar('DiscountAccounting': %trim(w_mark));
pdf            WrtSection('Line');
pdf
pdf   /End-free
pdf   *
pdf  c                   else
6.17 c                   eval      w_tek1 = *blank
6.17 c                   eval      w_tek2 = *blank
pdf  c                   movel     sdtek1        d1tek1
pdf  c                   movel     sdtek2        d1tek2
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Tekstlinjer
pdf   *
6.19 c**                 movel     d1tek1        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_tek1
6.19 c                   movel     p_str_out     w_tek1
pdf   *
6.19 c**                 movel     d1tek2        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_tek2
6.19 c                   movel     p_str_out     w_tek2
pdf   /Free
6.17      //   UpdHTMLVar('Text1':              d1tek1);
6.17           UpdHTMLVar('Text1':              w_tek1);
6.17     //    UpdHTMLVar('Text2':              d1tek2);
6.17           UpdHTMLVar('Text2':              w_tek2);
pdf            WrtSection('TextLine');
pdf
pdf   /End-free
pdf   *
pdf  c                   endif
pdf   *
pdf  c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21  * Subrutiner for XML/jasper integrasjon - bruksrabatt             *
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21 c     xml_usrdisc   begsr
6.21  *
6.21 c*                  eval      p_str_in = *blank
6.21 c*                  eval      p_lr = '0'
6.21 c*                  movel     d1tek2        p_str_in
6.21 c*                  call      'AP613R'
6.21 c*                  parm                    p_str_in
6.21 c*                  parm                    p_str_out
6.21 c*                  parm                    p_lr
6.21 c*                  movel     p_str_out     w_tek2
6.21  *
6.21  /Free
6.21           UpdHTMLVar('Text1':     'Bruksrettrabatt');
6.21           UpdHTMLVar('Userdiscount1': %char(d1brr1));
6.21           UpdHTMLVar('Userdiscount2': %char(d1brr2));
6.21           WrtSection('LineUserDiscount');
6.21
6.21  /End-free
6.21  *
6.21 c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21  * Subrutiner for XML/jasper integrasjon - bruksrabatt oppsummering*
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21 c     xml_usrsum1   begsr
6.21  *
6.21 c*                  eval      p_str_in = *blank
6.21 c*                  eval      p_lr = '0'
6.21 c*                  movel     d1tek2        p_str_in
6.21 c*                  call      'AP613R'
6.21 c*                  parm                    p_str_in
6.21 c*                  parm                    p_str_out
6.21 c*                  parm                    p_lr
6.21 c*                  movel     p_str_out     w_tek2
6.21  *
6.21  /Free
6.21           UpdHTMLVar('Usersummarytext':          d3tek1);
6.21           UpdHTMLVar('Usersummarybasis':  %char(d3bgr1));
6.21           UpdHTMLVar('Usersummaryamount': %char(d3brb1));
6.21           WrtSection('UserDiscountSummary');
6.21
6.21  /End-free
6.21  *
6.21 c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21  * Subrutiner for XML/jasper integrasjon - bruksrabatt oppsummering*
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21 c     xml_usrsum2   begsr
6.21  *
6.21 c*                  eval      p_str_in = *blank
6.21 c*                  eval      p_lr = '0'
6.21 c*                  movel     d1tek2        p_str_in
6.21 c*                  call      'AP613R'
6.21 c*                  parm                    p_str_in
6.21 c*                  parm                    p_str_out
6.21 c*                  parm                    p_lr
6.21 c*                  movel     p_str_out     w_tek2
6.21  *
6.21  /Free
6.21           UpdHTMLVar('Usersummarytext':          d3tek2);
6.21           UpdHTMLVar('Usersummarybasis':  %char(d3bgr2));
6.21           UpdHTMLVar('Usersummaryamount': %char(d3brb2));
6.21           WrtSection('UserDiscountSummary');
6.21
6.21  /End-free
6.21  *
6.21 c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Sluttagg for ordren     *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_ordr_end  begsr
pdf   *
pdf   /Free
pdf        // Avslutt ordren
pdf            WrtSection('OrderEnd');
pdf
pdf   /End-free
pdf  c                   eval      b_ordr = *off
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Rabatt                  *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_rabatt    begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Sørg for at vi har skrevet siste tag for ordren før vi begynner
pdf   * avslutter.
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
pdf  c                   eval      b_ordr = *off
pdf  c                   endif
pdf   *
pdf   /Free
pdf        // Skriv rabattlinjer
pdf            UpdHTMLVar('Discountinpercent':   %char(r1rabp));
pdf            UpdHTMLVar('Discountbasis':       %char(r1rabg));
pdf            UpdHTMLVar('Sumdiscount':         %char(r1rabb));
pdf            WrtSection('DiscountLine');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Depositum               *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_depositum begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Sørg for at vi har skrevet siste tag for ordren før vi begynner
pdf   * avslutter.
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
pdf  c                   eval      b_ordr = *off
pdf  c                   endif
pdf   *
pdf   /Free
pdf        // Netto
pdf            UpdHTMLVar('DepositTotal':         %char(r2totb));
pdf            UpdHTMLVar('DepositAmount':        %char(r2dept));
pdf            WrtSection('Depositum');
pdf   /End-free
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Netto                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_netto     begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Sørg for at vi har skrevet siste tag for ordren før vi begynner
pdf   * avslutter.
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
pdf  c                   eval      b_ordr = *off
pdf  c                   endif
pdf   *
pdf   /Free
pdf        // Netto
pdf            UpdHTMLVar('Sumnettoexcvat':       %char(t1tnet));
pdf            WrtSection('NettoLine');
pdf   /End-free
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Vat                     *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_vat       begsr
pdf   *
pdf   /Free
pdf        // Skriv mva grunnlag 1
pdf            UpdHTMLVar('Vatpercent':           %char(t1mvas));
pdf            UpdHTMLVar('Vatbasis':             %char(t1mvag));
pdf            UpdHTMLVar('Sumvat':               %char(t1mvab));
pdf            WrtSection('VatLine');
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Totaler                 *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_totaler   begsr
pdf   *
pdf   /Free
pdf        // Skriv totallinje
pdf            UpdHTMLVar('Sumtotal':             %char(t1fsum));
pdf            UpdHTMLVar('Sumvattotal':          %char(t1tmva));
pdf            UpdHTMLVar('Sumvatbasistotal':     %char(t1tnet));
pdf            WrtSection('TotalLine');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Topptekst start         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_topt_str  begsr
pdf   *
pdf   /Free
pdf        // Skriv tekstlinjer
pdf            WrtSection('TopTextStart');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Topptekst               *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_topptxt   begsr
pdf   *
pdf  c                   if        %trim(d1tek1) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
6.19 c**                 movel     d1tek1        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     d1tek1
6.19 c                   movel     p_str_out     d1tek1
pdf   /Free
pdf        // Skriv tekstlinjer 1
pdf            UpdHTMLVar('Toptext':     d1tek1);
pdf            WrtSection('TopTextLine');
pdf   /End-free
pdf  c                   endif
pdf   *
pdf  c                   if        %trim(d1tek2) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
6.19 c**                 movel     d1tek2        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     d1tek2
6.19 c                   movel     p_str_out     d1tek2
pdf   /Free
pdf        // Skriv tekstlinjer 2
pdf            UpdHTMLVar('Toptext':     d1tek2);
pdf            WrtSection('TopTextLine');
pdf   /End-free
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Topptekst slutt         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_topt_end  begsr
pdf   *
pdf   /Free
pdf        // Skriv tekstlinjer
pdf            WrtSection('TopTextEnd');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Bunntekst start         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_bott_str  begsr
pdf   *
pdf   /Free
pdf        // Skriv tekstlinjer
pdf            WrtSection('BottomTextStart');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Bunntekst               *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_bunntxt   begsr
pdf   *
pdf  c                   if        %trim(d1tek1) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
6.19 c**                 movel     d1tek1        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     d1tek1
6.19 c                   movel     p_str_out     d1tek1
pdf   /Free
pdf        // Skriv bunntekst
pdf            UpdHTMLVar('Bottomtext':  d1tek1);
pdf            WrtSection('BottomTextLine');
pdf
pdf   /End-free
pdf  c                   endif
pdf   *
pdf  c                   if        %trim(d1tek2) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
6.19 c**                 movel     d1tek2        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     d1tek2
6.19 c                   movel     p_str_out     d1tek2
pdf   /Free
pdf        // Skriv bunntekst
pdf            UpdHTMLVar('Bottomtext':  d1tek2);
pdf            WrtSection('BottomTextLine');
pdf
pdf   /End-free
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Bunntekst slutt         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_bott_end  begsr
pdf   *
pdf   /Free
pdf        // Skriv slutt på bunntext
pdf            WrtSection('BottomTextEnd');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Slutt                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_end       begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Giroinfo
pdf  c                   eval      w_bgir = *blanks
pdf  c                   if        l_bgir = 0
pdf  c                   eval      w_bgir = 'false'
pdf  c                   else
pdf  c                   eval      w_bgir = 'true'
pdf  c                   endif
pdf   * Faktura/kreditnota
pdf  c                   eval      w_type = *blanks
pdf  c                   if        *in36 = *on
pdf  c                   eval      w_type = 'false'
pdf  c                   else
pdf  c                   eval      w_bgir = 'true'
pdf  c                   endif
pdf   /Free
pdf        // Skriv kid og giroinfo for alle ordre
pdf            UpdHTMLVar('Kidno':              t1kkid);
pdf            UpdHTMLVar('Bankaccount': %char(t1fbgi));
pdf            UpdHTMLVar('Invoicetype':        w_copy);
pdf            UpdHTMLVar('Printgiro':          w_bgir);
pdf            UpdHTMLVar('Swift':              aaswif);
pdf            UpdHTMLVar('Iban':               aaiban);
pdf            WrtSection('InvoiceEnd');
pdf   /End-free
pdf   *
pdf   * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
pdf   *
pdf  c                   if        l_arch = 1
6.16  * Lag tag for visning i arkivklienten
6.16 c                   eval      w_dspl = *blank
6.16 c                   eval      w_dspl = 'Faktura: ' + %char(a1binr) +
6.16 c                             ' Kunde: ' +  %trim(%char(a1kund) + ' - ' +
6.16 c                             %trim(a1navn) + '  Beløp ' + %char(t1fsum))
6.17  *
6.19 c**                 movel     w_dspl        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '1'
6.19 c                   movel     w_dspl        p_str_in
6.19 c**                 exsr      xml_konv
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_dspl
6.19 c                   movel     p_str_out     w_dspl
pdf   /Free
pdf
pdf        // Skriv metattags
6.16
6.16           UpdHTMLVar('Displaytag':     %trim(w_dspl));
pdf            WrtSection('ArchiveCommandStart');
6.16
pdf            UpdHTMLVar('Metavalue':      %char(a1binr));
pdf            UpdHTMLVar('Metakey':      'FAKTURANUMMER');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue':             l_user);
pdf            UpdHTMLVar('Metakey':             'BRUKER');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue':      %char(a1kund));
pdf            UpdHTMLVar('Metakey':         'KUNDENUMMER');
pdf            WrtSection('MetaTag');
pdf
6.17           UpdHTMLVar('Metavalue':            w_1navn);
pdf            UpdHTMLVar('Metakey':          'KUNDENAVN');
pdf            WrtSection('MetaTag');
pdf
pdf            UpdHTMLVar('Metavalue':      %char(t1fsum));
pdf            UpdHTMLVar('Metakey':              'BELOP');
pdf            WrtSection('MetaTag');
pdf
pdf
pdf            UpdHTMLVar('Metavalue': %char(w_date:*iso));
pdf            UpdHTMLVar('Metakey':               'DATO');
pdf            WrtSection('MetaTag');
6.16
6.16           UpdHTMLVar('Metavalue':      %char(sonumm));
6.16           UpdHTMLVar('Metakey':        'ORDRENUMMER');
6.16           WrtSection('MetaTag');
pdf
pdf            WrtSection('ArchiveCommandEnd');
pdf   /End-free
pdf  c                   endif
pdf   *
pdf   /Free
pdf            WrtSection('Footer');
pdf   /End-free
pdf   *
pdf   * Skriv xmlfila til disk
pdf  c                   eval      XML_Output = XML_path + l_filg +'/'+
pdf  c                             'Fakt_'+ %trim(w_jkey) + '.xml'
pdf   *
pdf  c                   callp     WrtHtmlToStmf(XML_Output: 819)
pdf   *
pdf  c                   endsr
pdf   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     pdf_preview   begsr
pdf   *
pdf   * Vi kaller program for launch av PDF i browser
pdf  c                   call      'AP621R'
pdf  c                   parm                    w_jkey
pdf   *
pdf  c                   endsr
pdf   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Konv. til xml tegn      *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_konv      begsr
pdf   *
pdf  c                   eval      w_str_out = *blanks
pdf   *
pdf   /Free
pdf
pdf        // '&':'&amp;'
pdf        w_x = %scan('&':w_str_in);
pdf        if w_x > 0;
pdf        w_str_in = %subst(w_str_in:1:w_x-1)
pdf                  + '&amp;'
pdf                  + %subst(w_str_in:w_x+1);
pdf        endif;
pdf
pdf        // '''':'&apos;'
pdf        w_x = %scan('''':w_str_in);
pdf        if w_x > 0;
pdf        w_str_in = %subst(w_str_in:1:w_x-1)
pdf                  + '&apos;'
pdf                  + %subst(w_str_in:w_x+1);
pdf        endif;
pdf
pdf        // '"':'&quot;'
pdf        w_x = %scan('"':w_str_in);
pdf        if w_x > 0;
pdf        w_str_in = %subst(w_str_in:1:w_x-1)
pdf                  + '&quot;'
pdf                  + %subst(w_str_in:w_x+1);
pdf        endif;
pdf
pdf        // '<':'&lt;'
pdf        w_x = %scan('<':w_str_in);
pdf        if w_x > 0;
pdf        w_str_in = %subst(w_str_in:1:w_x-1)
pdf                  + '&lt;'
pdf                  + %subst(w_str_in:w_x+1);
pdf        endif;
pdf
pdf        // '>':'&gt;'
pdf        w_x = %scan('>':w_str_in);
pdf        if w_x > 0;
pdf        w_str_in = %subst(w_str_in:1:w_x-1)
pdf                  + '&gt;'
pdf                  + %subst(w_str_in:w_x+1);
pdf        endif;
pdf
pdf   /End-Free
pdf   *
pdf  c                   eval      w_str_out = w_str_in
pdf  c                   eval      w_str_in = *blanks
pdf   *
pdf  c                   endsr
pdf   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *  Nullstilling av felter som ikke kan redefineres
      *
     c                   eval      w_retk = *blank
     c                   eval      w_txt2 = *blank
     c                   eval      w_krab = *zero
      *
     c                   eval      w_qmva = *blank
     c                   eval      w_mvax = *blank
     c                   eval      w_mvas = *zero
     c                   eval      w_mvat = *zero
     c                   eval      w_mvaf = *zero
3.34 c                   eval      w_mv2s = *zero
3.34 c                   eval      w_mv2t = *zero
3.34 c                   eval      w_mv2f = *zero
      *
     c                   eval      aforl1_ruti = *blank
     c                   eval      w_tell = *zero
     c                   eval      n = *zero
      *
      * Key for Heading-file
      *
     c     sohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sohel1_aarr
     c                   kfld                    sohel1_binr
     c                   kfld                    sohel1_numm
     c                   kfld                    sohel1_suff
6.11  *
6.11  * Key for Heading-file les siste post
6.11  *
6.11 c     sohelr_key    klist
6.11 c                   kfld                    w_firm
6.11 c                   kfld                    sohelr_aarr
6.11 c                   kfld                    sohelr_binr
6.11 c                   kfld                    sohelr_numm
6.11 c                   kfld                    sohelr_suff
      *
      * Key for Detalj-file
      *
     c     sodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sodtl1_aarr
     c                   kfld                    sodtl1_binr
     c                   kfld                    sodtl1_numm
     c                   kfld                    sodtl1_suff
     c                   kfld                    sodtl1_ktxt
     c                   kfld                    sodtl1_line
6.11  *
6.11  * Key for Detalj-file (sjekking om det finnes linjer)
6.11  *
6.11 c     sodtlr_key    klist
6.11 c                   kfld                    w_firm
6.11 c                   kfld                    sodtlr_aarr
6.11 c                   kfld                    sodtlr_binr
6.11 c                   kfld                    sodtlr_numm
6.11 c                   kfld                    sodtlr_suff
      *
      * Key for kunderegister
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
5.60  *
5.60  * Key for oppslag på kundeprosjekt
5.60  *
5.60 c     fkprl1_key    klist
5.60 c                   kfld                    w_firm
5.60 c                   kfld                    fkprl1_kund
5.60 c                   kfld                    fkprl1_kpro
      *
      * Key for firmaregister
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for ordretyper
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for linjetyper
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for statusregister
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for formular-register
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      * Key for vare-register
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for priskode-register
      *
     c     vpkol1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vpkol1_pkod
5.31  *
5.31  * Key for oppslag av fakturalogg
5.31  *
5.31 c     fnufl1_key    klist
5.31 c                   kfld                    w_firm
5.31 c                   kfld                    fnufl1_aarr
5.31 c                   kfld                    fnufl1_binr
5.31  *
5.31  * Key for les av fakturatype
5.31  *
5.31 c     fmftl1_key    klist
5.31 c                   kfld                    w_firm
5.31 c                   kfld                    fmftl1_faty
pdf2  *
pdf2  * Key for les av status PROA
pdf2  *
pdf2 c     afpslr_key    klist
pdf2 c                   kfld                    afpslr_ufil
pdf2 c                   kfld                    afpslr_uide
      *
      * Hente inn rutinenavn
      * og meldingstekst
      *
pdf2 c                   eval      l_ruti = 'FFAKT   '
     c                   eval      aforl1_ruti = l_ruti
      *
     c     aforl1_key    chain     aforl1r                            69
     c                   if        *in69 = *off
     c                   eval      a1txt1 = aftxt1
     c                   eval      t1mld1 = afmld1
     c                   eval      t1mld3 = afmld3
     c                   eval      t3mld1 = afmld1
     c                   eval      t3mld3 = afmld3
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     *entry        plist
     c                   parm                    p_parm
pdf2 c                   parm                    p_jkey
      *
     c                   eval      d_aarr = *zero
     c                   eval      d_otyp = *blank
     c                   eval      d_ffnr = *zero
     c                   eval      d_tfnr = *zero
     c                   eval      d_kopi = *blank
     c                   eval      d_parm = p_parm
pdf2  * Pga at dette er et klientprogram setter vi forhåndsvisning på.
pdf2  * Alle andre statuser er av !
pdf2 c                   eval      l_bach = p_jkey
pdf2 c                   eval      l_arch = 0
pdf2 c                   eval      l_skje = 1
pdf2 c                   eval      l_mail = 0
pdf2 c                   eval      d_kidk = 0
pdf2 c                   eval      l_bgir = 0
pdf2  *
pdf2  * Sjekk om PDF aktivering er på/av (klient)
pdf2  *
pdf2 c                   eval      afpslr_ufil = l_filg
pdf2 c                   eval      afpslr_uide = 'STATUS    '
pdf2 c     afpslr_key    chain     afpslrr
pdf2 c                   if        not %found
pdf2 c                   eval      l_poff = '0'
pdf2 c                   else
pdf2 c                   movel     afudss        l_poff
pdf2 c                   endif
pdf2  *
pdf   * Sjekk om vi skal bruke JASPER og XML generering av dokumenter
pdf  c                   if        l_poff = '1'
pdf  c                   eval      b_pdfp = *off
pdf  c                   eval      b_topt = *off
pdf  c                   eval      b_bott = *off
pdf  c                   eval      w_pdf = 0
pdf  c                   eval      w_pdf_ds = *blanks
pdf2 c**                 eval      w_ruti = l_ruti
pdf2 c                   eval      w_ruti = 'FFAKT   '
pdf   *
pdf  c                   call      'AP609R'
pdf  c                   parm                    w_ruti
pdf  c                   parm                    w_pdf
pdf  c                   parm                    w_pdf_ds
pdf  c                   eval      d_pdf_ds = w_pdf_ds
pdf   * Vi skal kjøre med jasper
pdf  c                   if        w_pdf = 1 and
pdf  c                             %trim(d_xmlm) <> *blanks
pdf  c                   eval      p_mail = '0'
pdf  c                   eval      w_jkey = l_bach
pdf   *
pdf   * Hent inn xml templaten
pdf   *
pdf  c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
pdf   *
pdf   * Finn hvor xml'en skal legges
pdf   *
pdf  c                   eval      XML_path = *blanks
pdf  c                   eval      XML_path = %trim(d_path)
pdf   *
pdf   * Finn path til logo
pdf   *
pdf  c                   eval      jasper_logo = *blanks
pdf  c                   eval      jasper_logo = %trim(d_logo)
pdf   *
pdf   * Jobbnummer er allerede generert.
pdf   *
pdf  c                   time                    w_date
pdf   * Vi logger ar utskriftprogrammet har startet
pdf  c                   eval      w_jstat = 10
pdf  c                   eval      w_jtext = 'Utskrift av faktura har startet'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf   *
pdf  c                   eval      w_bach = w_jkey
pdf   * Vi skriver xml for miljø formater
pdf  c** flyttet         exsr      xml_envm
pdf  c                   eval      b_pdfp = *on
pdf  c                   eval      b_pdfp_first = *off
pdf   *
pdf  c                   endif
pdf   * Hvis et eller annet er galt med parametrene, logges og kjør uten PROA
pdf  c                   if        %trim(d_xmlm) = *blanks
pdf  c                   eval      b_pdfp = *off
pdf   * Vi logger at noe er galt med parametrene
pdf  c                   eval      w_jstat = 20
pdf  c                   eval      w_jtext = 'Finner ikke path til xml !!! +
pdf  c                             Sjekk rutineregister !'
pdf  c                   call      'AB705R'
pdf  c                   parm                    l_bach
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf  c                   endif
pdf   *
pdf  c                   else
pdf  c                   eval      b_pdfp = *off
pdf  c                   endif
      *
     c                   endsr
      *
