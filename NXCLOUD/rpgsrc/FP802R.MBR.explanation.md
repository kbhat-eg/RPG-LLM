# Overview  
This RPG IV program (FP802R) runs under ASOFAK and reads order headers from file **FOHEL9**, applies various selection criteria, and writes matching records to **WOHEPFR**. Typical usage is “ordreinngang, hente ordre fra Ofak” (incoming orders, fetch orders from Ofak).

---

## 1. File Definitions  
- **FOHEL9**  
  - Input disk file, keyed  
  - Renamed fields from `FOHEPFR` (`like(fohepfr:fohel9r)`)  
- **WOHEPFR**  
  - Output file, externally described  

---

## 2. Data Areas & Parameter List  

### 2.1 Local Data Area  
Stored by the ILE runtime, contains environment info like user, date/time, job.  

### 2.2 Parameter Data Structure (`d_list`)  
A 128-byte structure overlaid by fields used to drive selection:  

| Field   | Offset | Length | Description                             |
|---------|--------|--------|-----------------------------------------|
| d_firm  | 0      | 3      | Company code                            |
| d_hist  | 4      | 1      | Historical flag (include billed orders) |
| d_oiar  | 5      | 1      | Detail flag: `1` → fetch full detail    |
| d_bong  | 6      | 1      | Voucher type selection                  |
| d_selg  | 7      | 4      | Seller number (0 = all)                 |
| d_avde  | 11     | 4      | Department   (0 = all)                  |
| …       | …      | …      | Various order-type selections (hot1-6, oot1-6, bot1-6)  |
| d_ovlg  | 40     | 1      | Order-type selection mode               |
| d_inf1-6| 54-64  | 2×6    | Infocode selections                     |
| d_ivlg  | 66     | 1      | Infocode selection mode                 |
| d_fdat  | 67     | 10     | From date (*ISO*)                       |
| d_tdat  | 77     | 10     | To   date (*ISO*)                       |
| d_dvlg  | 87     | 1      | Use delivery date instead of order date |
| d_sort  |103     | 1      | Sort indicator                          |
| d_ityp  |104     | 2      | Specific info type                      |

---

## 3. Key Variables  
- **d_\<…\>** correspond to overlay fields in `d_list`.  
- **fohel9_…**, **wohepf_…**, **dra09pf_…**, etc. mirror external file field formats.  
- **gml_selg**, **w_firm**, **w_timestamp**: working storage copies.  

---

## 4. Program Flow  

1. **ENTRY / Main Logic**  
   - Checks `d_oiar`.  
     - If `'1'`, call subroutine **DETALJE_FOHE** to fetch and process orders.  
   - Sets on **\*INLR** to end program.  

2. **Subroutine DETALJE_FOHE**  
   - Perform `READ FOHEL9` keyed start (60 = end-of-file indicator).  
   - If first record found, store initial seller in `gml_selg`.  
   - **DO WHILE** records remain (`*IN60 = *off`):  
     - **Selection Tests (in order):**  
       1. **Company**  
       2. **Seller** (if `d_selg ≠ 0`)  
       3. **Department** (if `d_avde ≠ 0`)  
       4. **Info-type** (if `d_ityp ≠ *blank`)  
       5. **Order-type** based on `d_ovlg` and the six `d_ootx`/`d_botx` fields  
       6. **Infocode** filtering (`d_ivlg`, `foityp`, `d_inf1-6`)  
       7. **Date selection**  
          - Optionally use delivery date (`d_dvlg = '1'`)  
          - Match exact (`d_fdat = d_tdat = *LOVAL`) or range (`d_fdat` ≤ order date ≤ `d_tdat`)  
     - If a record fails any test → go to **NY_LES** (next read)  
     - **PASS** all tests → `WRITE WOHEPFR`  
     - **NY_LES** label: `READ FOHEL9` for next record  
   - **ENDDO** when `*IN60 = *on`  
   - **ENDSR** return to caller  

3. **Initialization Subroutine (*INZSR)**  
   - Bound via **PARM** (128-byte parameter list)  
   - Builds **FOHEL9** key (`fohel9_key`) using `d_firm`, `d_selg`, `d_fdat`  
   - Positions file with `SETLL FOHEL9`  
   - Returns to main  

---

## 5. Key Points & Pedagogy  

- **Overlay Technique**  
  - A single 128-byte DS (`d_list`) overlays all selection fields, simplifying parameter passing.  
- **End-of-File Handling**  
  - RPG uses indicators (`*INxx`) set by I/O opcodes (`READ … 60`).  
- **Structured Selection**  
  - Early exits (GOTO) for non-matches keep the core processing path lean.  
- **Modularity**  
  - Main simply dispatches to a subroutine when detail retrieval (`d_oiar`) is requested.  
  - Initialization (`*INZSR`) cleanly separates setup from processing.  

This structure supports flexible filtering on company, seller, department, order types, infocodes, and dates, enabling reuse in multiple contexts.