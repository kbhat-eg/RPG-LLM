# RPG Program MP710R – Vendor Selection and Order Proposal Processing

This ILE RPG (RPG IV) source code is a batch program for selecting suppliers/vendors (leverandører) to check against order proposals, typically run as a nightly or scheduled job on IBM i (AS/400).

Below is a detailed, section-by-section explanation suitable for onboarding developers.

---

## 1. Program Structure and Intent

- **Purpose:** Select eligible suppliers for order proposal checks based on scheduling parameters (daily, weekly, biweekly, monthly, etc.), and trigger subsequent order processing for those suppliers.
- **Main Operations:**
  - Iterate over the `mppalr` file (supplier scheduling parameters).
  - For each eligible supplier, determine if it's time for an order proposal check.
  - If so, call program `MP713R` to process the order proposal.

---

## 2. Key Definitions and Declarations

### Header

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: No debug I/O.
- `datedit(*dmy)`: Date format day-month-year.

### File Definition

```rpg
fmppalr    if   e           k disk    rename(mppapfr:mppalrr)
```
- Input file `mppalr`, keyed, external, renamed record format.

### Data Definitions

- **Parameters:** Dates, numbers (e.g., `p_dato`, `p_ndat`, `p_dgnr`), supplier keys.
- **LDA (Local Data Area):** For passing session/user/firm info (e.g., `l_user`, `l_firm`).
- **Flags for days of week:** (e.g., `b_mon` for Monday, `b_tue` for Tuesday, etc.)
- **Subfile and screenwork variables:** For subfile-based display logic (not actively used in this batch program, but kept for context/compatibility).

---

## 3. Indicator Usage

Commented section details standard RPG indicator usage (LR for last record, 10/11 for rollup/rolldown, etc.), but in modern RPG IV, these are less important unless tied directly to display files.

---

## 4. Mainline Logic

### Initial Setup

```rpg
c                   time                    p_dato
c                   eval      p_dgnr = 0
c                   call      'MP701R  '
c                   parm                    p_dato
c                   parm                    p_dgnr
```
- Get current date/time into `p_dato`.
- Call external program `MP701R` with date and a day-number parameter (likely to set up or validate current processing context).

### Main Loop – Process Supplier Parameters

```rpg
c     mppalr_key    setll     mppalr
c                   read      mppalr
c                   dow       not %eof(mppalr)
    ... logic ...
c                   read      mppalr
c                   enddo
```

#### For Each Record

- **Eligibility Check 1:** If the last run date (`mpsdat`) is before today's date (`p_dato`), continue.
- **Eligibility Check 2:** If supplier is flagged for proposal processing (`mprapp = '1'`), process further.
- **Processing:** Call subroutine `behandling`.

### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Set LR (last record indicator) and return, ending the program.

---

## 5. Subroutines

### behandling (Main Processing Logic for Each Supplier)

```rpg
c     behandling    begsr
    ...
c                   call      'MP713R  '
    ...
c                   endsr
```

- Determines if, and when, the supplier should have their order proposal generated, according to their scheduling pattern (`mphypp`):
  - `'MD'` = Monthly: If at least a month since last run, schedule next.
  - `'DG'` = Daily: If at least a day since last run, schedule next.
  - `'14'` = Every 14 days: Call `beh_14d` to determine next run.
  - `'UK'` = Weekly: Call `beh_uke` to determine next run.

- After determining next run date, calls `MP713R` (the order proposal generation program) with supplier and scheduling information.

### beh_14d (Fourteen-Day Scheduling Logic)

- Sets day-of-week flags according to which days the supplier is scheduled for (`mpdag1`..`mpdag7`).
- Determines the next scheduled day after today using a `select` block and day-number (`p_dgnr`).
- Adds 7 to skip to next week, if needed.
- Sets `p_ndat` as the next scheduled date.

### beh_uke (Weekly Scheduling Logic)

- Similar to `beh_14d`, but processes weekly scheduling.

### sjk_sunday ... sjk_saturday (Find Next Scheduled Day Subroutines)

- For each weekday subroutine:
  - Checks flag for each day-of-week in scheduled order, to determine how many days until the next scheduled day. Sets `w_dag` accordingly.

---

## 6. Initialization Subroutine (`*inzsr`)

- Builds the key for the supplier parameter file.
- Retrieves current firm from LDA.
- Sets a screen indicator (likely legacy, not used in batch mode).

---

## 7. Comments & Field Usage

- **mp...**: Most variables prefixed with `mp` refer to fields from the vendor parameter file.
- **LDA**: Used for getting user and firm context (standard IBM i technique).
- **Screen/subfile variables**: Present for compatibility, but not actively manipulated.

---

## 8. External Programs Used

- `MP701R`: Initial setup/utility.
- `MP713R`: Generates the order proposals for the given supplier and date.

---

## 9. Summary of Flow

1. **Initialize date/time.**
2. **Loop all suppliers:** For each, if eligible and active, process scheduling logic.
3. **For eligible suppliers, determine the next required order proposal date.**
4. **Call order proposal process (MP713R) for these suppliers.**
5. **Exit.**

---

## 10. Key Points for Onboarded Developers

- **Main file is `mppalr`**: Scheduling parameters for suppliers.
- **Scheduling handled flexibly**: Can accommodate daily, weekly, every 14 days, monthly scheduling.
- **External programs handle date calculation and order proposal creation.**
- **The program is designed in classic RPG IV (fixed format, subroutines, heavy use of indicators).**
- **Day-of-week logic**: Easily extensible if new patterns are needed.

---

**See the comments in the code (“*”) for further business context and field/indicator explanation in Norwegian.**