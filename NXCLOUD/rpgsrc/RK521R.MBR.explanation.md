## Overview and Purpose

This RPG program, `RK521R`, is a customer maintenance extraction utility in the ASOKON system. It is designed to facilitate the maintenance, search, and display of customer records using subfiles on an interactive workstation (workstn). The program implements a subfile-based display, allowing end users to page, search, position, view, and delete customer records, as well as to drill down to postings for each customer.

The business domain is customer master data management, with integration to postings (likely financial transactions or invoices) per customer. The program is tailored for a Norwegian environment (e.g., language and date formats).

---

## File and Data Structure Relationships

### Physical and Logical Files

- `rkunlr`, `rkunl1`, `rkunl2`: Customer master files (physical/logical variations for different access paths).
- `rkwbl1`, `rkwblu`: Customer postings (likely invoices or transactions).
- `rksopf`: Used for search operations (possibly an optimized file for search/index).

### Display Files

- `rk521d`: Workstation file with subfiles (`b1sfl`), control records (`b2ctl`), and various pop-up windows for delete and copy operations.

### Local Data Area (LDA)

- Used to retrieve session/user-specific values such as user ID, firm (company) number, and user name.

---

## Key Business Logic and Flow

### 1. Initialization (`*inzsr`)

- Retrieves the system parameter (`p_syst`) and company number from the LDA.
- Sets up key lists for file access.
- Initializes the subfile by positioning to the start and calling `crt_subfile` to populate the first page.

### 2. Main Loop

- Controlled using tags (`b2taga`, `b2tagb`) and a select-case structure for function key handling.
- Handles function keys for:
  - Exit (`F3`, `F12`)
  - Refresh (`F5`)
  - Paging (`F10`/Rollup, `F11`/Rolldown)
  - Home/positioning (`F21`)
  - Repeating search (`F9`)
- Processing alternates between displaying the subfile and responding to user actions.

### 3. Subfile Handling

- **Display (`dsp_subfile`)**: Shows the current page of the subfile. If there are records, enables display indicators.
- **Clear (`clr_subfile`)**: Blanks the subfile and resets counters.
- **Create (`crt_subfile`)**: Populates the subfile with customer records according to the current mode (normal, search, or alpha-based).
  - Handles SQL-based search with dynamic cursor declaration and fetch.
  - Supports both keyed and sequential access patterns.
  - Applies additional search filters, including multi-word search (up to five search terms).
  - Marks customers with a special code (`inkassokode = 'J'`) for special display treatment (e.g., red line).
  - Sums up postings per customer for display.

### 4. Search and Positioning

- **Search (`s√∏k`)**: Calls an external program (`AS700R`) to parse the search text into up to five search terms, then repopulates the subfile using SQL.
- **Positioning (`posisjoner`)**: Allows the user to jump to a specific customer by number or by alpha key, then reloads the subfile from that position.

### 5. Paging

- **Forward (`crt_subfile`)**: Loads the next page of records.
- **Backward (`bck_subfile`)**: Steps back one page, using `readp` and `setgt` for reverse navigation.

### 6. Record Actions

- **Delete (`xslett`)**: Prompts for confirmation, then deletes all postings for the selected customer.
- **View (`xc2bld`)**: Calls another program (`RK502R`) to display or edit customer details.
- **Postings (`posteringer`)**: Calls program (`RK120R`) to display postings for the selected customer.

### 7. Summing Postings (`sum_poster`)

- Totals the open amount (`rnrest`) for all postings of a customer, used for the balance display in the subfile.

---

## Design and Coding Conventions

- **Indicator Usage**: The code uses a detailed indicator convention, with specific ranges for display, error, and work indicators.
- **Subfile Paging**: Implements page-up/page-down with careful tracking of relative record numbers (`w_srrn`, `w_ssrn`, etc.).
- **Search**: Multi-term search is implemented via external parsing, then filtered in the RPG program after the initial SQL fetch.
- **External Calls**: Business rules for search parsing, customer detail display, and postings display are encapsulated in separate programs, promoting modularity.
- **SQL Integration**: Uses embedded SQL for efficient search operations, with dynamic cursor management to support flexible search criteria.
- **Localization**: Norwegian language and date formats are hardcoded, reflecting the system's user base.

---

## User Interface and Workflow

- **Subfile Control**: Users interact with a subfile list of customers, with options to search, position, page, delete, and drill down.
- **Pop-up Windows**: Used for delete confirmation and other modal actions.
- **Color Coding**: Certain customer records are visually highlighted based on business rules (e.g., collections code).

---

## Integration Points

- **AS700R**: Parses user search input into up to five search terms.
- **RK502R**: Handles customer detail display and editing.
- **RK120R**: Displays postings (invoices/transactions) for a customer.

---

## Notable Design Decisions

- **Separation of Concerns**: The program delegates complex or business-critical logic (search parsing, detail display) to external programs.
- **Subfile Efficiency**: Uses SQL for large searches but falls back to keyed access for positioning and paging.
- **Indicator Management**: Carefully manages display and work indicators to avoid conflicts, a common requirement in legacy RPG systems.
- **Resilience to Data Changes**: Handles record deletion and subfile refresh robustly, ensuring UI consistency after data changes.

---

## Summary

This program is a robust, interactive customer maintenance tool with advanced search, paging, and record management capabilities. It is tightly integrated with the broader ASOKON system, adhering to established business rules and interface conventions, and is designed for efficiency and usability in a high-volume, transaction-oriented environment. The codebase demonstrates careful attention to subfile management, user interaction, and modular business logic.