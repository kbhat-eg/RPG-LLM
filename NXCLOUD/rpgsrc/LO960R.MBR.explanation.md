# RPG Program Explanation: LO960R (Document Scanning, Label Printing)

This RPG III/IV program is designed for IBM iSeries (AS/400) systems, specifically handling **document scanning** and the **printing of product labels**. Below, we break down the code sections, data structures, logic, and purpose.

---

## 1. Program Header & Documentation

The top comments describe:
- **System**: ASLAGR
- **Program Name**: LO960R
- **Purpose**: Document scanning and label printing ("Dokumentscanning, Utskrift av etikett")
- **Change Log**: The latest modification (R6.30, 2003-06-14) mentions expanding number series for labels.

---

## 2. File Declaration

```rpg
flo960p    o    e             printer
```
- **lo960p**: Output file (presumably the label print file).
- **Type**: `o`utput, `e`nd-of-file indicator enabled.
- **Device**: `printer`.

---

## 3. Data Structures

### a. Parameter Input Data Structure

```rpg
d                 ds
d d_prec                        35
d  d_firm                        3  0 overlay(d_prec)
d  d_numm                        8  0 overlay(d_prec:4)
d  d_suff                        2  0 overlay(d_prec:12)
d  d_ldat                         d   overlay(d_prec:14)
d  d_lage                        2  0 overlay(d_prec:24)
d  d_innk                        4  0 overlay(d_prec:26)
d  d_rest                        1  0 overlay(d_prec:30)
d  d_etik                        1  0 overlay(d_prec:31)
d  d_leti                        1  0 overlay(d_prec:32)
d  d_seti                        1  0 overlay(d_prec:33)
d  d_dumm                        1    overlay(d_prec:34)
```
- **d_prec**: Primary parameter area (35 bytes), with various overlays for accessing specific fields:
    - **d_firm**: Firm/company code (3 digits)
    - **d_numm**: Document/serial number (8 digits)
    - **d_suff**: Suffix (2 digits)
    - **d_ldat**: Date field (starts at pos 14)
    - **d_lage**: Warehouse/location (2 digits)
    - **d_innk**: Inbound number? (4 digits)
    - **d_rest**: Remainder flag (1 digit)
    - **d_etik**: Label flag (1 digit)
    - **d_leti, d_seti, d_dumm**: Additional control flags/fields

#### Note

- Subfields use the `overlay` keyword to map onto the main parameter area.
- This structure is used for parameter passing between programs (free-format RPG: all overlays).

### b. Temporary Field

```rpg
d w_prec          s             32
```
- **w_prec**: Work variable for parameter passing (32 characters, to match most of `d_prec`).

### c. Print Number Data Structure

```rpg
d                 ds
d utparm                        16
d  utfirm                       03  0 overlay(utparm:01)
d  utaarr                       04  0 overlay(utparm:04)
d  utbinr                       06  0 overlay(utparm:08)
```
- **utparm**: Work area (16 bytes), with fields:
    - **utfirm**: Company code (3 digits)
    - **utaarr**: Year or similar information (4 digits starting at byte 4)
    - **utbinr**: Some kind of bin or item number (6 digits starting at byte 8)

### d. Local Data Area (LDA) Field

```rpg
d                uds
d  l_sfir               944    946  0
```
- **l_sfir**: Extracts bytes 944-946 from the LDA (system-wide data area for job/session/session communication).
    - Likely used for company/firm code.

---

## 4. Main Program Logic

### a. Move Information to Helper Fields

```rpg
c                   move      l_sfir        utfirm
c                   movel     2006          utaarr
c                   move      d_numm        utbinr
c                   movel     utparm        p1bila
```

- **l_sfir → utfirm**: Gets current firm code from LDA.
- **2006 → utaarr**: Puts "2006" (magic value or year) into `utaarr`.
- **d_numm → utbinr**: Puts the input document/serial number into print area.
- **utparm → p1bila**: Moves the whole structure into a print field (likely an externally-described data structure for printing).

### b. Prepare Label Data

```rpg
c                   move      d_numm        p1binr
c                   movel     'SCANPAKK'    p1doct
```
- **d_numm → p1binr**: Sets the bin/item number for the label.
- **'SCANPAKK' → p1doct**: Hardcodes the document type value ("SCANPAKK", possibly for scanning package).

### c. Write Label

```rpg
c                   write     label                                99
```
- **write label**: Triggers printing the label record layout (`label` likely defined externally).
- **99**: (may be a print control code, or could be a page number or other parameter).

---

## 5. Program Termination

```rpg
c     xslutt        tag
c                   move      *on           *inlr
c                   return
```
- **xslutt tag**: Label for end-of-program (used with GOTO in classic RPG; here for structure).
- **move *on *inlr**: Closes files, signals last record, ends the program.
- **return**: Exit the program.

---

## 6. Subroutine: Initialization

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    w_prec
c                   eval      d_prec = w_prec
c                   endsr
```
- **Initialization Subroutine** (`*inzsr`):
    - Handles program initialization.
    - **Parameter Handling**:
        - **plist**: Defines parameter list for entry.
        - **parm w_prec**: Receives parameter into `w_prec`.
        - **eval d_prec = w_prec**: Loads parameter structure for use in main logic.

---

## 7. Miscellaneous

- **/eject**: Directive for source page breaks (organizational).
- **Extensive commenting and change log**: Clear intent and history.
- **Classic RPG (fixed-format)**: Uses columns for operation codes and operands.

---

## 8. Summary of Workflow

1. **Input parameters** (from previous program) are received and mapped.
2. **Firm/company code** is pulled from the LDA.
3. **Helper data structures** are populated with key information (firm, year, document number).
4. **Label print fields** are composed.
5. **Label record** is written out to the printer file.
6. **Program ends**, releasing resources.

---

## 9. Key Business Logic

- This program is typically called by another program, receives a parameter block with product information, then prints a standardized label for the product, including company, document number, and document type ("SCANPAKK").
- It leverages overlays and the LDA to extract the required info.

---

## 10. Typical Use Case

- Part of a document scanning or warehouse system where each scanned document triggers a printed label for attaching to an item, box, or pallet, capturing firm, number, and type.

---

### If you have follow-up questions about particular code sections, please ask!