# JP720R – Discount Element Calculation  

**Library:** ASVADM  
**Object:** Program (RPGLE)  
**Function:** Calculates a cumulative discount factor (`p_fakt`) and a net price adjustment (`p_ntpr`) for a given set of business‐key parameters by reading “rabattelement” (discount element) definitions.

---

## 1. Business Context  
- **Rabattelement**: A pricing mechanism where multiple discount rules can apply to an order, item group, price group, etc.  
- **Goal**: Given a customer/order context (firm, order type, item group, etc.), determine (a) the multiplicative discount factor and (b) any additive net‐price adjustments.  

---

## 2. Entry Parameters  

| Parameter | Description                                | Format / Length   | Output |
|-----------|--------------------------------------------|-------------------|--------|
| p_firm    | Company/firm identifier                    | Char 3            | In     |
| p_eldo    | Order or customer key                      | Like `JPEELDO`    | In     |
| p_eprg    | Price group                                | Like `JPEPRG`     | In     |
| p_eogr    | Order group                                | Like `JPEOGR`     | In     |
| p_ehgr    | Item (head) group                          | Like `JPEHGR`     | In     |
| p_eugr    | Usage/user group                           | Like `JPEUGR`     | In     |
| p_emod    | Model                                      | Like `JPEMOD`     | In     |
| p_evar    | Variant                                    | Like `JPEVAR`     | In     |
| p_evty    | Variant type                               | Like `JPEVTY`     | In     |
| p_elet    | Element type                               | Like `JPELET`     | In     |
| p_ebrs    | Business region                            | Like `JPEBRS`     | In     |
| p_ebli    | Delivery type                              | Like `JPEBLI`     | In     |
| p_fakt    | Computed discount factor (1 = no discount) | Packed 8,5        | Out    |
| p_ntpr    | Computed net price addition/subtraction    | Packed 9,2        | Out    |

> **Note**: Over time the price‐group field was widened from 1 to 2 positions, and the internal working factor `w_fakt` was extended to Packed(15,5) to prevent overflow.

---

## 3. Data Layout & File Interfaces  

1. **JRAEL4 (alias `JRAEPFR` → `JRAEL4R`)**  
   - Used to detect if *any* discount elements are marked “active” for the passed keyset.  
   - Key fields:  
     - `w_firm` ← `p_firm`  
     - `eldo, eprg, eogr, ehgr, eugr, emod, evar, evty, elet, ebrs, ebli`  
     - `eakt` (activation flag; 1=active)  

2. **JRAEL1 (alias `JRAEPFR` → `JRAEL1R`)**  
   - Holds individual discount element definitions.  
   - Key fields same as JRAEL4 except for `eakt`.  
   - Data fields:  
     - `jpereg` – Discount rule type (`1`, `2`, or `N`)  
     - `jpever` – Discount value (percent or absolute amount)  

---

## 4. High‐Level Logic  

1. **Detect Active Elements**  
   - Populate `JRAEL4` key with all incoming parameters + `eakt=1`  
   - `CHAIN JRAEL4`: if found, set `b_akti = *ON`  
   - **Impact**: If any active elements exist, only those with `jpeakt=1` will be used. Otherwise, all matching records are applied.

2. **Initialize Accumulators**  
   - `w_fakt` (Packed 15,5) ← 1.00000  
   - `p_ntpr` (Packed 9,2) ← 0.00  

3. **Scan Discount Elements**  
   - `SETLL`/`READE` on `JRAEL1` using the same keyset (without `eakt`).  
   - Loop through all matching records:  
     - If `b_akti = *OFF` **OR** (`b_akti = *ON` AND record’s `jpeakt = 1`), then apply rule:  
       - **Type '1'** (Percent on remainder):  
         `w_fakt = w_fakt - (jpever / 100.0 * w_fakt)`  
       - **Type '2'** (Absolute on factor):  
         `w_fakt = w_fakt - (jpever / 100.0)`  
       - **Type 'N'** (Net price override):  
         `p_ntpr += jpever`  

4. **Finalize Discount Factor**  
   - If `w_fakt <> 0`:  
     - If `abs(w_fakt) < 1000`, then `p_fakt = w_fakt`  
     - Else cap: `p_fakt = 999.99999`  
   - Else assign directly: `p_fakt = w_fakt`  

5. **Return & Clean Up**  
   - `*INLR = *ON` → Release resources  

---

## 5. Key Design Notes  

- **Two‐Phase Table Access**  
  - **Phase 1** (`JRAEL4`): Quickly check if *any* activated records exist → Controls whether to filter by activation flag in Phase 2.  
  - **Phase 2** (`JRAEL1`): Read all matching elements, applying activation logic and discount formulas.

- **Capping the Factor**  
  - Prevents overflow or unreasonable discount levels by bounding the final factor to < 1000.

- **Working Field (`w_fakt`)**  
  - Introduced in v6.10 to avoid intermediate overflow when chaining multiple percent discounts.

- **Extensibility**  
  - New discount types can be added by extending the `SELECT/WHEN jpereg = …` block and appending to accumulators.

- **Key‐List Initialization**  
  - Encapsulated in an *INZSR* subroutine: sets up the key lists for both files using the same incoming parameters.

---

## 6. Change History Highlights  

- **14 Aug 1998** – Initial release  
- **11 Feb 2002** – Honor activation flag (`eakt`)  
- **13 Jun 2005** – Extended key to include price‐group and delivery‐type  
- **11 Feb 2004** – Added cap logic when factor > 999  
- **15 Jun 2010** – Switched to 2‐digit price‐group, introduced `w_fakt`  

---

**End of Documentation**