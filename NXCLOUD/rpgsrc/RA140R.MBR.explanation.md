# RA140R – Maintenance of Form Letter Texts

## Overview

This program (RA140R) is responsible for maintaining the textual content of various form letters (formulars) used in our ASOKON system, such as payment reminders, customer account statements, supplier account statements, and interest notes. It provides a workstation-based user interface for editing these texts, validates user input, loads existing texts from the formular register, and updates the register with changes.

## Key Business Concepts

- **Formularregister (Form Letter Register):** Central table (file `RA70L1`) storing the customizable text lines for each type of form letter, per company, report type, language, and line number.
- **Report Types (`a1rapp`):**
    - 70: Betalingsvarsel (Payment Reminder)
    - 71: Kontoutdrag Kunde (Customer Statement)
    - 72: Kontoutdrag Leverandør (Supplier Statement)
    - 73: Rentenota (Interest Note)
- **Languages (`a1sprk`):** Supports up to 5 language codes.

## Program Structure

### File Declarations

- `fra140d`: Workstation file for the user interface.
- `fra70l1`: Formularregister file (RA70L1), renamed as `ra70l1r` for record format reference.

### Key Data Structures

- `fm(5)`: Array for error messages.
- `lin(15)`: Array for the editable lines of the form letter.
- `err(4)`, `btab(16)`, `ktab(10)`, `ltab(10)`, `rtab(10)`: Arrays initialized with constant data for default texts for each report type.
- `key4`, `key5`: Key fields for file access.
- `ra70l1_kod`, `ra70l1_spr`, `ra70l1_lin`: Work variables matching key fields in `RA70L1`.
- `w_firm`: Work variable for company number.
- `l`, `n`: Loop counters.
- `tekst`: Work variable for a line of text.

### Main Processing Flow

#### 1. Program Initialization

- The `*inzsr` subroutine initializes the company number (`w_firm`) and defines the key list (`ra70l1_key`) for accessing the formularregister.

#### 2. Main User Interaction Loop

- The program displays the main screen (`a1bld`) for the user to select the report type and language.
- Handles user exit requests (`*inkc` or `*inkl`) and exits gracefully.
- Validates the report number (`a1rapp`) and language code (`a1sprk`). If invalid, appropriate error messages are loaded and the screen is redisplayed.
- Calls `subles` to load existing text lines from the formularregister into the `lin` array. If not found, loads default texts from the constant arrays (`btab`, `ktab`, etc.).

#### 3. Editing and Updating Texts

- Depending on the report type, the program branches to the corresponding subroutine to display and allow editing of the text lines:
    - `xb1bld` and `xe1bld`: Payment Reminder (split into two parts for up to 15 lines).
    - `xc1bld`: Customer Statement (10 lines).
    - `xd1bld`: Supplier Statement (10 lines).
    - `xf1bld`: Interest Note (10 lines).
- After editing, updates the `lin` array with any changes.
- Calls `subskr` to write changes back to the formularregister file (`RA70L1`), either updating existing records or creating new ones as necessary.

#### 4. Subroutines

- **`subles`**: Reads the formularregister for the selected report and language, populating the `lin` array. If no entry exists, loads the default text for that report type.
- **`subskr`**: Writes the contents of the `lin` array back to the formularregister, updating or creating records per line as needed.
- **`xb1bld`, `xe1bld`, `xc1bld`, `xd1bld`, `xf1bld`**: Handle display and editing for each report type.

### Error Handling

- Error messages are managed via the `fm` array, populated from the `err` array as needed. These are displayed to the user when invalid input is detected.

### Data Relationships

- The program is tightly coupled to the `RA70L1` file, which stores the per-company, per-report, per-language, per-line texts.
- The company number (`w_firm`), report number (`a1rapp`), language code (`a1sprk`), and line number (`l`) form the composite key for accessing and updating `RA70L1`.

### User Interface

- The program uses multiple display formats (`a1bld`, `b170a`, `b170b`, `c171a`, `d172a`, `e173a`) for editing the various form letter types.
- The user can edit the text lines directly, which are then validated and saved.

### Special Conventions and Patterns

- **Default Text Fallback:** If no entry exists in `RA70L1` for the selected report/language, the program loads hardcoded default texts from the corresponding arrays (`btab`, `ktab`, etc.).
- **Dynamic Line Handling:** Payment reminders can have up to 15 lines, others up to 10, controlled by logic in `subles` and `subskr`.
- **Error Messaging:** Uses indexed arrays for error messages, simplifying multilingual or context-sensitive error display.
- **Subroutine Structure:** Code is modularized into subroutines for reading/writing the register and for each report type's UI.

### Integration Points

- **`RA70L1` File:** Central repository for all form letter texts, shared with other modules that generate or print these letters.
- **Workstation File (`fra140d`):** Assumes integration with a display file for interactive editing.

### Domain-Specific Notes

- The program is designed for Norwegian business context, as evident from the language and report types.
- The constants at the end of the source are the default texts for each form letter, in Norwegian, with business-specific phrasing for payment reminders, statements, and interest notes.
- The code contains some legacy conventions (e.g., use of MOVE, tagged GOTO, indicator variables) typical for older RPG III/IV codebases.

## Summary Table: Report Types and Default Text Sources

| Report | Code | Lines | Default Array | Display Formats   |
|--------|------|-------|---------------|-------------------|
| Betalingsvarsel (Payment Reminder) | 70   | 15    | btab          | b170a, b170b       |
| Kontoutdrag Kunde (Customer Statement) | 71   | 10    | ktab          | c171a              |
| Kontoutdrag Leverandør (Supplier Statement) | 72   | 10    | ltab          | d172a              |
| Rentenota (Interest Note) | 73   | 10    | rtab          | e173a              |

## Key Takeaways for New Developers

- This program is the central maintenance tool for customizing the texts of key financial form letters.
- All changes are persisted in the `RA70L1` table, which is referenced by other modules for document generation.
- The structure is modular, with clear separation between loading, editing, and saving logic.
- Pay close attention to the handling of report types and language codes, as these determine both the UI flow and the data storage/retrieval logic.
- The codebase uses some legacy RPG idioms; modernization may be possible but should be coordinated with downstream consumers of `RA70L1`.

## References

- **RA70L1:** Formularregister (Form Letter Register) file.
- **Display File:** `fra140d` (not included, but required for UI).
- **Default Texts:** Provided in source as CTDATA arrays.

---

For further details on data structures or integration with document generation modules, consult the technical documentation for `RA70L1` and related reporting programs.