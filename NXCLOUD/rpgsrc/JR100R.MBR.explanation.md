# ILE RPG Source Code Onboarding Guide: Program JR100R

## Overview

This source code is for the IBM i (AS/400) RPG program `JR100R`. The program is a **report maintenance application** (rapportør, vedlikehold in Norwegian), managing a master file using subfile operations on a display. It allows display, search, add, edit, copy, and delete of records (rapportører) through a subfile interface.

**Key Features**
- Subfile presentation and navigation
- Record add, update, copy, delete
- Field validation and lookup
- Workstation display file handling
- Use of local data area (LDA) for contextual data

---

## File Declarations

```rpg
fjrapl1    if   e           k disk    rename(jrappfr:jrapl1r)
fjrapl2    if   e           k disk    rename(jrappfr:jrapl2r)
fjrapl3    if   e           k disk    rename(jrappfr:jrapl3r)
fjraplr    if   e           k disk    rename(jrappfr:jraplrr)
fjraplu    uf a e           k disk    rename(jrappfr:jraplur)
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
fjvrcl1    if   e           k disk    rename(jvrcpfr:jvrcl1r)
fjr100d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **fjrapl1/2/3/rl/lu:** Logical files over master files (`jrappfr`) for index/search by different keys (rapportør, name, format, etc.).
- **fjlevl1, fjvrcl1:** Files for lookup (supplier, format descriptions).
- **fjr100d:** Display file, uses subfile (`b1sfl`) and information data structure (`dspfbk`).

---

## Data Structures and Variables

### Local Data Area (LDA)
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- **l_user, l_firm, l_fnav**: User number, company/firm number, and navigation string.

### Display Feedback
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Used for cursor positioning.

### Keys and Working Variables

- `jrapl1_rapp`, `jrapl2_navn`, `jrapl3_rfmt` etc: Key fields for different logical file searches.
- `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc: Subfile page/record counters.
- `b_oppr`, `b_forn`, `b_anul`, `b_feil`: Work indicators (booleans).
- `c_sfil`: Subfile page size (constant, 14).

### Subfile State Explanations

- `w_fcrn`: First record number on the page
- `w_srrn`: Current relative record number in the subfile
- `w_ssrn`: Last relative record number displayed
- `w_spge`: Current page size of subfile

---

## Indicator Usage

As documented in the header comments:

- `*IN10` = Roll Up, `*IN11` = Roll Down, `*IN14` = SFLCLR (clear), `*IN15` = SFLEND (end of subfile)
- `*IN12`, `*IN13` = Display subfile and subfile control
- `*IN21`/`*IN22` = Home/position cursor
- `*IN30` = Field protection/Display only for view
- `*IN31`-`*IN39` = Field error/warning messaging
- `*IN80`-`*IN99` = Reserved as working indicators

---

## Main Flow

### Program Initialization (`*INZSR`)
- Sets up key lists for all logical files.
- Retrieves values from LDA, initializes workspace variables.
- Sets up initial subfile positioning and contents.

### Display Loop
Starts at tag `b2taga` and loops through:
- Displaying command screen (`write b2cmd`)
- Displaying/refreshing the subfile (`exsr dsp_subfile`)
- Handling function keys (Select/When with FN indicators):
  - Exit, refresh, create, page up/down, position, etc.

### Subfile Management

#### Subfile Operations

- **clr_subfile**
  - Clears subfile with SFLCLR/SFLEND.
- **crt_subfile**
  - Fills subfile page, reading records and writing to SFL.
- **bck_subfile**
  - Loads the previous page of the subfile.

#### Subfile Interaction
- Main processing (`subfile` subroutine) loops through subfile records for:
  - Change (valg=2), Copy (valg=3), Delete (valg=4), View (valg=5),
  - Field-specific actions such as group reference and filter calls.

### Add/Edit/Delete Operations

#### Add (`xc1bld`)
- Handles creation, validation, and duplicate checks.
- Invokes edit screen (`xc2bld`) if valid.
- Calls message screen (`xc1msg`) on duplicate.

#### Edit/View (`xc2bld`)
- Loads data for selected record.
- Allows editing, validation of required fields, lookup for supplier/format.
- Updates, inserts, or flags errors.

#### Delete (`xd1win`)
- Loads selected record, confirms, then deletes.

#### Copy (`xk1win`)
- Loads source record, verifies target key, and invokes maintenance.

---

## Subfile Paging and Positioning

- Paging forward (CRT_SUBFILE) and backward (BCK_SUBFILE)
- Searching/positioning by report number, name, or record format (POSISJONER subroutine)
- Handles wraparound and end-of-file logic

---

## Other Calls and Lookups

- Supplier lookup: `call 'JL500R'`
- Record format lookup: `call 'JF500R'`
- Group reference and filter: `call 'JR120R'`/`'JR130R'`

---

## Error Handling and Messaging

- Field validation sets error indicators (`*IN31`-`*IN39`)
- Messaging for duplicate add attempts (XC1MSG)
- Validation for required fields, proper format, and lookup existence

---

## Display Files and Screens Used

- `B1SFL`: Main subfile for rows/records
- `B2CTL`: Subfile control (header, function keys)
- `B2CMD`: Command area
- `C1BLD`: Create key entry screen
- `C1MSG`: Messaging for duplicate keys
- `C2BLD`: Add/Edit/View details
- `D1WIN`: Delete confirmation window
- `K1WIN`: Copy window

---

## Summary Table of Subroutines

| Subroutine      | Purpose                                  |
|-----------------|------------------------------------------|
| *INZSR          | Program initialization                   |
| forny           | Refresh subfile from current pos         |
| posisjoner      | Reposition subfile (by key, name, format)|
| subfile         | Loop/process subfile lines/actions       |
| xc1bld          | Handle new record key input              |
| xc1msg          | Message on duplicate add attempt         |
| xc2bld          | Edit/View record                         |
| xd1win          | Handle delete record                     |
| xk1win          | Handle copy record                       |
| clr_subfile     | Clear subfile and counters               |
| crt_subfile     | Fill subfile (page)                      |
| bck_subfile     | Page backward in subfile                 |
| dsp_subfile     | Show subfile on screen                   |

---

## Conclusion

This program is a classic ILE RPG subfile maintenance application. It demonstrates best practices for subfile control, logical file usage for flexible searching, and screen-driven business logic with clear separation of actions, validation, and error messaging. The structure is modular, with one subroutine per action/workflow, and uses display indicators and field-level indicators to control the UI and input validation.

---

**If you are onboarding to this program**:  
- Start by understanding the file and key definitions, then the main display loop.
- Focus on how subfile records are loaded, navigated, and processed.
- Review how indicators control the user interface and validation.
- Use the summary table above to locate subroutines as you work through enhancements or troubleshooting.  

_This guide covers all the main flows and structures — refer to comments in the code for further detail on each step._