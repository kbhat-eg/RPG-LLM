# Program Overview

This IBM ILE RPG code implements a routine for calculating the ISO week number and year for a given date. The code is modular, using subroutines, and uses a service program (AX710R) to do the actual week/year calculation for a given year and week number.

The program returns:
- The ISO week number and year for the supplied date.
- A status code indicating success (`p_stat = ' '`) or failure (`p_stat = '1'` if something went wrong, e.g., invalid date).

---

## Data Structures and Parameters

- **Input parameter:**
  - `p_dato` (Date): The date to be checked.

- **Output parameters:**
  - `p_aarr` (Year, 4 digits, packed): The ISO week year for `p_dato`.
  - `p_week` (Week number, 2 digits, packed): The ISO week number for `p_dato`.
  - `p_stat` (Char, length 1): Return status ('1' means error, blank means success).

- **Working variables:**  
  Variables like `w_firm`, `w_aarr`, `w_paar`, `w_puke`, `w_pfda`, `w_ptda`, etc., are used for working storage during calculations.

- **Indicator flags:**
  - `b_Ok`: Set to *on if the correct week/year is found for the input date.
  - `b_feil`: Set to *on if there's an error in the called service (e.g., invalid week/year combination).

---

## Program Flow

### 1. Initialization (`*inzsr`)
- **Entry List**: Binds the input/output parameters on entry.
- **Variable Init**: Sets status (`p_stat`) to blank, week and year outputs to zero.

### 2. Mainline Code

#### a. Date Validation
- Checks that `p_dato` is filled/valid.
- If date format is not correct, sets `p_stat = '1'` and exits.

#### b. Prior Year, Week 52/53
- Determines current year from input date.
- Tries to see if the date falls into week 52 or 53 of the previous year by calling the week/year calculation subroutine (`finn_uke`).
- If found, exits with results.

#### c. Current Year, All Weeks
- Loops through all weeks (up to 52) of the current year.
- Calls week/year calculation subroutine for each week.
- If matching week/year is found, exits with results.

#### d. Next Year, Week 1
- If not found so far, checks week 1 of next year.

#### e. Set Status and Exit
- If no match is found or error occurred in the subroutine call, sets `p_stat = '1'` (error).
- Ends the program.

### 3. Week/Year Calculation Subroutine (`finn_uke`)
- Calls external program `AX710R` with year and week parameters, gets from-date (`w_pfda`) and to-date (`w_ptda`) for that week.
- Compares input date to from/to date. If date is within bounds, sets `b_Ok = *on`, updates output week/year.
- If error status returned, sets `b_feil = *on`.
- Returns control to caller.

---

## AX710R External Call

- Program AX710R is expected to take:
  - Year (input)
  - Week number (input)
  - From-date (output)
  - To-date (output)
  - Status (output)

AX710R is responsible for telling for a specific year/week number what that week's date range is, and whether that week/year is valid.

---

## Key Algorithmic Points

- The logic is anchored around knowing, for a given year/week number, what the corresponding start and end dates are (ISO weeks).
- It checks special edge cases: does the date fall into the tail (week 52/53) of the prior year, or the head (week 1) of the next?
- Iteratively, it checks through all possible weeks of the current year.
- The status code is set to signal if the calculation succeeded or failed.

---

## Common Error Handling

- Date validation: If the date is missing or invalid, returns error.
- If the external subroutine signals an invalid week/year, error is returned.

---

## Noteworthy Comments

- The comments give thorough explanations, including indicator usage (e.g., what indicator 31-79 are reserved for).

---

## Summary Table

| Routine       | Purpose                                 |
|---------------|-----------------------------------------|
| *inzsr        | Initialize parameters/variables         |
| Mainline      | Control flow, looping, calls subroutine |
| finn_uke      | Calls AX710R to get from/to date for a week/year; checks if date matches |
| AX710R        | External: Maps year/week no. â†’ date range (not part of this code) |

---

## Typical Usage Pattern

1. Supply a date.
2. Program finds which ISO week/year the date falls in.
3. Returns week number, year, and a status code.

---

## Example

Suppose `p_dato` is '2024-01-02'.  
The code will:
- Ensure the date is valid.
- Try prior year's week 52/53, then all weeks in 2024.
- When it finds a week/year whose date range includes '2024-01-02', it returns that week and year.

---

This modular design, with externalized week logic, helps keep the code maintainable and adaptable for various calendar rules.