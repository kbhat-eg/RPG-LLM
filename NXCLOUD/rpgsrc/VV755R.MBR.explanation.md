# Program VV755R – Change of Unit Name for Items

## Overview

This program, `VV755R`, is responsible for updating the name/code of a unit (`enhet`) for a specific item (`vare`) across multiple tables in the ASOFAK system. The update is performed consistently in all relevant tables to maintain data integrity and avoid mismatches in the business domain. The program is designed to be called with four parameters:

- Company (`firm`)
- Item number (`vare`)
- Old unit (`enhg`)
- New unit (`enhn`)

The program updates all occurrences of the old unit with the new unit for the specified item and company in a collection of master and transaction tables, including price, offer, discount, order, invoice, and label tables. It also calls subprograms to handle updates in warehouse, store, and statistics modules.

---

## Business Context

- **Unit codes** are used throughout the system to represent packaging, measurement, or sales units for items.
- Changing a unit code is a rare but critical operation, often required when standardizing codes or correcting errors.
- The program ensures the change is propagated to all relevant tables, preventing data inconsistencies.
- The program is part of a suite; other jobs may override or process related tables.

---

## File/Table Relationships

The program works with the following files (physical or logical tables), often using renamed or prefixed record formats for clarity and to avoid naming conflicts:

- **Item Master:** `vvarlu` (logical over `vvarpfr`)
- **Item-Unit:** `vvenlu`, `vvenl1` (logical over `vvenpfr`)
- **Item-Unit-Pricegiver:** `vveplu`, `vvepl1` (logical over `vveppfr`)
- **Item-Price:** `vvprlu`, `vvprl1`, `vvprlr` (logical over `vvprpfr`)
- **Offer:** `vtill9` (logical over `vtilpfr`)
- **Label:** `vetilu` (logical over `vetipfr`)
- **Discount Matrix:** `frabla` (logical over `frabpfr`)
- **Special Prices:** `fpril5` (logical over `fpripfr`)
- **Order Line:** `fodtlv` (logical over `fodtpfr`)
- **External Order Line:** `nodtl4` (logical over `nodtpfr`)
- **Invoice Line:** `sodtlv` (logical over `sodtpfr`)

Other modules are called via program calls:
- Warehouse/Purchasing: `LL755R`
- Store: `BD755R`
- Statistics: `SF755R`

---

## Program Structure

### Parameter Handling and Initialization

- Parameters are received for company, item, old unit, and new unit.
- Keys for updating and reading records are constructed using these parameters.
- The current user is fetched from the user data area for audit fields.

### Main Logic

#### 1. **Item Master Update**

- If any of the unit fields (`vvenhe`, `vvenhl`, `vvenhs`) match the old unit, they are updated to the new unit.
- Audit fields (`vvedat`, `vvetim`, `vveusr`) are updated.

#### 2. **Item-Unit Table Update**

- All records for the item and old unit are processed.
- If a record for the new unit does not already exist (to avoid duplicate key errors), the unit code is updated and audit fields set.
- If a duplicate would occur, the old record is unlocked and skipped.

#### 3. **Item-Unit-Pricegiver Table Update**

- Similar logic as above, for pricegiver relationships.

#### 4. **Item-Price Table Update**

- For each price record for the item, if the unit matches the old unit:
    - Check if a record for the new unit already exists with the same price group, date, etc.
    - If not, update the unit and audit fields.
    - If a duplicate would occur, skip update.

#### 5. **Offer Table Update**

- Update unit codes in up to three unit fields (`vtenh1`, `vtenh2`, `vtenh3`) if they match the old unit.
- Audit fields are updated.

#### 6. **Label Table Update**

- Update the unit field if it matches the old unit.

#### 7. **Discount Matrix Update**

- Update the unit field if it matches the old unit.

#### 8. **Special Prices Update**

- Update the unit field if it matches the old unit.
- Audit fields are updated.

#### 9. **Order, External Order, and Invoice Line Updates**

- For each, update the unit field if it matches the old unit, and update audit fields.

#### 10. **Call to Other Modules**

- After updating all local tables, the program calls:
    - `LL755R` for warehouse/purchasing tables
    - `BD755R` for store-related tables
    - `SF755R` for statistics tables
  Passing the same parameters to ensure all related data is updated.

#### 11. **Program End**

- Sets LR indicator to end the program.

---

## Design Considerations and Conventions

- **Audit Trail:** All updates set the change date, time, and user fields to ensure traceability.
- **Duplicate Key Avoidance:** Before updating unit codes, the program checks if a record with the new key already exists to prevent duplicate key errors, particularly important in price and item-unit tables.
- **Modularization:** Updates for warehouse, store, and statistics are delegated to separate programs, keeping this program focused on the main commercial tables.
- **Extensibility:** The program has a history of enhancements to support new tables, keys, and business logic, as documented in the header comments.
- **Field Naming:** Variables and keys are named according to business conventions (e.g., `vvenhe` for unit in item master, `vpprgr` for price group).
- **Parameterization:** The program is parameter-driven, allowing it to be reused for any item/unit change scenario.

---

## Notable Business/Domain Logic

- **Price Group Handling:** Price group (`prgr`) logic was extended to support two positions; all references are externally defined.
- **Offer Price by Group/Supplier:** Extensions allow offers to be grouped by item group or supplier number.
- **Dupkey Handling:** Several enhancements (8.01–8.03) were made to explicitly check for and avoid duplicate key situations in various tables.
- **Batch Consistency:** The program must be run in coordination with other jobs that may override or update similar tables, as noted in the comments.

---

## Interactions with Other Modules

- **Warehouse/Purchasing (`LL755R`):** Ensures unit code changes are reflected in inventory and purchasing records.
- **Store (`BD755R`):** Updates store-specific tables.
- **Statistics (`SF755R`):** Updates statistical data to reflect the unit change.

---

## Summary

`VV755R` is a batch maintenance utility that ensures a unit code change for an item is propagated across all relevant tables in the commercial, pricing, offer, discount, order, and invoice domains. It uses defensive programming to avoid data corruption (duplicate keys), maintains a clear audit trail, and coordinates with other modules for a comprehensive and consistent update across the system. 

This program should be used with caution, as improper use or partial updates can lead to data inconsistencies across the business system. Always ensure that all related jobs and overrides are coordinated as per the system's operational procedures.