# RPG Program SP116R – Explanation and Onboarding Guide

## Purpose and Context

This RPG (Report Program Generator) program, `SP116R`, is part of the `ASSTAT` system and is described as "Utvalg undergruppe" (Selection sub-group). It handles the display, maintenance (create, update, delete), and navigation of a subfile (record list) of undergroups, using a display file and several physical files for data persistence. The code is written in traditional fixed-format ILE RPG, typical of IBM i-Series (AS/400) environments.

---

## High-Level Structure

1. **File Declarations** (`f-specs`): 
   - Associates disk and display files, often with internal names for easier reference.
   - The primary display file uses a subfile (`b1sfl`).

2. **Data Definitions** (`d-specs`): 
   - Declares variables, data structures, constants, and maps fields from the files for processing keys.

3. **Procedural Logic** (`c-specs`):
   - Contains the mainline logic, which is largely subroutine-driven.
   - Handles screen interactions, function keys, and core CRUD operations.

4. **Subroutines**:
   - Modularizes program functionality into re-usable routines for subfile manipulation, key building, record maintenance, etc.

---

## File Specifications

### Display & Subfile
- `sp116d`: Display file (workstation), uses `b1sfl` as a subfile with a relative record number.

### Database Files
- `skpml1`, `skpmlr`, `skpmlu`: Physical files with different usage modes (input/output/update), each renamed for clarity.
- `vugrl1`: Ancillary lookup file, e.g., for verifying existence.

---

## Data Structures and Main Variables

### Keys for Files
Variables prefixed with file names (`skpml1_type`, `skpml1_kode`, etc.) are used to build keys for access and search operations in the files.

### Subfile Control
- `w_spge`: Current page of subfile records.
- `w_srrn`, `w_sfrn`, `w_ssrn`: Relative record numbers and subfile range management.
- `w_seqe`, `b_forn`, `b_anul`, `b_feil`: State and flag fields for display and logic control.

### Work and Session Variables
- `w_firm`, `wptype`, `wpkode`, `wptext`, `wputxt`: Track current firm, type, code, and description.
- `w_uogr`, `w_uhgr`, `w_uugr`: Hold group numbers for underlying hierarchy navigation.

### Constants
- `c_sfil`: Number of subfile records per page (default 12).

---

## Mainline Logic

### Initial Display Flow

- **Entry:** Program starts via `*inzsr` (initialization subroutine), setting up keys, receiving parameters, and prepping the subfile.
- **Screen Display Loop:** 
  - The main loop alternates between displaying screens (with or without subfiles) and handling user input via function keys.
  - Function keys support exit, refresh, addition, and navigation commands.

### Subfile and CRUD Processing

- **Display Subfile:** `dsp_subfile` shows the subfile list or a prompt if empty.
- **Create Subfile:** `crt_subfile` reads records from the database, fills the subfile up to a page size.
- **Clear Subfile:** `clr_subfile` empties the subfile and resets counters.
- **Subfile Record Processing:** 
  - `subfile` processes input entered against displayed records, such as delete commands.

### Function Key Handling

- Function keys (`*inkc`, `*inkl`, etc.) are mapped to logic handling (exit, refresh, add, delete, position, etc.).
- Each supported key is routed to its corresponding subroutine or directly executes logic.

---

## Key Subroutines

### forny (Renew Subfile)
- Repositions and reloads the subfile starting from the current key (records) for a fresh display, typically after add/delete.

### posisjoner (Position Subfile)
- Sets the subfile display starting from specified group values (for jumping to a particular sub-group).

### control (Subfile Control Handler)
- Handles commands from the subfile control record:
  - `'1'`: Add new entry.
  - `'4'`: Delete entry.
  - Also validates key input, sets error flags, and triggers corresponding routines.

### xc1bld (New/Update Screen for Entry)
- Handles input for adding or updating entries.
- Allows selection of group values, checks existence, prompts messages if the entry exists, and cascades to the next screen for detail entry.

### xc2bld (New/Change/Display Entry Detail)
- Handles the entry/maintenance of detail fields for an undergroup.
- Reads/writes/updates the back-end file as needed.

### xd1win (Delete Window)
- Loads the record for delete confirmation, presents delete window, and deletes after confirmation.

---

## Additional Subroutines

- `xc1msg`: Handles the display of an informational message if a duplicate entry is found.
- `clr_subfile`: Clears (empties) the subfile.
- `crt_subfile`: Fills the subfile with the next set of records.
- `dsp_subfile`: Displays the subfile control and the subfile screen.
- `*inzsr`: Initializes keys, receives parameters, resets working variables, and loads the first page of the subfile.

---

## Data Flow and Screen Flow

1. **Initialization**: Parameters from the caller are used to set up context (type, description, etc.).
2. **Display Loop**: User interacts with a subfile list (add, update, delete, position), with function keys governing flow.
3. **Processing Subroutines**: Each user command is handled via a subroutine, updating files and redisplaying as needed.

---

## Error Handling

- Error conditions (missing keys, duplicates, invalid input) are flagged with variables like `b_feil` and set indicators (`*in31`, `*in32`), which likely display messages on the screen.
- Existence checks for adding/updating are done with `chain` and corresponding file read/lookup.

---

## Best Practices and Tips for Onboarding

- **Subfile Basics**: Become familiar with how subfiles work in RPG display files, including page management and RRN (relative record number) logic.
- **Indicators**: The code uses many numbered indicators (`*in12`, `*in14`, etc.) for screen and state control; refer to the display DDS for precise mappings.
- **File Keys**: Understanding how each file key is built (via `klist`/`kfld` and work variables) is crucial for tracking program flow.
- **Function Keys**: Mapping function key indicators to user actions is key to understanding navigation and command handling.
- **Modularity**: The heavy use of subroutines helps reuse code, but “goto” constructs are used for flow control, which can make tracking branching a bit tricky.

---

## Summary Table of Main Subroutines

| Subroutine      | Purpose                                                         |
| --------------- | --------------------------------------------------------------- |
| `forny`         | Refresh subfile display from current key/position               |
| `posisjoner`    | Move/position subfile according to input values                 |
| `control`       | Handles add/delete/validation from subfile control record       |
| `subfile`       | Loops through subfile entries for selection and deletion        |
| `xc1bld`        | New/update entry—handles add screen and selection logic         |
| `xc1msg`        | Message display for duplicate entry handling                    |
| `xc2bld`        | Detail entry/update screen and file update/insert logic         |
| `xd1win`        | Delete screen, confirmation and file deletion                   |
| `clr_subfile`   | Clear (empty) the subfile                                       |
| `crt_subfile`   | Load and fill the subfile with records from DB                  |
| `dsp_subfile`   | Display subfile (and handle empty)                              |
| `*inzsr`        | Program initialization (setup, parameter reception, first load) |

---

## Conclusion

This program is a classic ILE RPG subfile maintenance application, supporting paged display, CRUD operations, and efficient navigation via subroutine-driven logic and function keys. To get comfortable with the code:
- Reference the DDS (display file definitions) for indicator usage.
- Understand the relation between display actions and database file access.
- Familiarize yourself with the file layouts and key structures.

If you have any specific questions about any subroutine, data structure, or area of the code, feel free to ask for a deeper dive!