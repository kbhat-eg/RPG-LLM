     H decedit('0.') datedit(*dmy-) option(*nodebugio)
     h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
      /copy hspecsbnd
      /title  ASOFAK Gen. XML faktura
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : FO195R
      * Beskrivelse . . : Fakturabeh., gen. faktura i XML format
      *                   - Håndtering av elektronisk utg.fakt.
      *                   Tatt utgangspunkt i FO181R den 11.12.2013
      *                   Endringer i det programmet bør vurderes
      *                   overført.
      *
      * Spesialversjon. : Spesialprogram
      * Tilpasset for . : Per Strand
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       111213 Bsa  Nytt program
6.20  *       170114 Bsa  Endringer relatert til kassebong
6.21  *       240114 Bsa  Avgifter må også inn i mva grunnlag
6.22  *       030214 Bsa  Leveringsadresse legges ut som DP i partner
6.23  *       050214 Bsa  Skal ikke skrive ut hverken topp eller
6.23  *                   bunntekster.
6.24  *       130214 Bsa  Skal skrive alt i samme xml fil.
6.25  *       130214 Bsa  Pga spesialkid, brukes verdien i lang kid
6.25  *                   uansett.
6.26  *       180214 Bsa  Sjekker ikke mot aktivering av proa
6.27  *       250214 Bsa  Legger ut default NO som landkode.
6.28  *       190314 Bsa  Legger ut lagernummer og ikke beskrivelse
6.28  *                   i XML'en.
6.29  *       250314 Bsa  Legger ut 'ARCHIVE' for alle fakturaer med
6.29  *                   fakturatype 11. Kun til arkiv hos SG.
6.2A  *       190314 Bsa  Sjekker mot kode om det skal lages tagg som
6.2A  *                   indikerer at det skal være med PDF
6.2B  *       070414 Bsa  Tar tak i spoolfilen, og sender denne på mail
6.2B  *                   og ikke via manuell utsendelse på faktura-
6.2B  *                   journal.
6.2C  *       070414 Bsa  Legger ut totaler for lista
6.2D  *       110414 Bsa  Hvis det ikke er laget noen fakturaer, ikke
6.2D  *                   forsøk å sende logg.
6.2E  *       210514 Bsa  Nullstiller totalvariabler
6.2F  *       280514 Bsa  PDF vedlegg skal ikke sendes hvis
6.2F  *                   faktura kun skal til arkiv.
6.2G  *       170614 Bsa  Skal ikke legge ut faktura, hvis den ikke
6.2G  *                   inneholder varelinjer.
6.2H  *       040714 Bsa  Trekker ut betalt depositum fra fakturasum
6.2I  *       250315 Bsa  Legger ordretotal ut som varelinje
6.2J  *       290615 Bsa  Legger ut mvaprosent på avgifter
6.2K  *       300915 Bsa  Rekalkulerer mva beløp pga øreavrunding.
6.2L  *       300915 Bsa  Nullstiller minne før utlegg av XML
6.2M  *       051115 Bsa  Omregning av pris for nettovisning. Må bruke
6.2M  *                   flere desimaler.
6.3nu *       110416 bof  Utvidet ihht. nummerutvidelse
6.30  * 6.30  280115 bsa  Skriver til datakø for å trigge java sniffer
6.31  *       110416 bof  Endret maler til 630
6.32  *       130217 bsa  Innført ny mva kode.
6.33  *       020617 bsa  Antallet er 0 !! - må takles så programmet går videre.
6.34  *       231117 bsa  Endret logikk ved beregning av mva sats
6.35  *       131217 bsa  Bruker feil beløp for depositum
6.36  * 6.30  161018 bof  Utvidet med trelast sortiment
      *                                                                 - -
8.01  *PRG2   220622 BOF  Utvidet prisgruppe fra 1 til 2 posisjoner - COMP
      *                                                                 - -
      *                                                                 - -
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
     fsohelr    if   e           k disk    rename(sohepfr:sohelrr)
     f                                     prefix(xx:2)
     fsodtl1    if   e           k disk    rename(sodtpfr:sodtl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     fveanl2    if   e           k disk    rename(veanpfr:veanl2r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     fra10l1    if   e           k disk    rename(ra10pfr:ra10l1r)
     fra18l1    if   e           k disk    rename(ra18pfr:ra18l1r)
     fra17l1    if   e           k disk    rename(ra17pfr:ra17l1r)
     fraa8l1    if   e           k disk    rename(raa8pfr:raa8l1r)
     ffmftl1    if   e           k disk    rename(fmftpfr:fmftl1r)
     ffnufl1    if   e           k disk    rename(fnufpfr:fnufl1r)
     ffnufl2    if   e           k disk    rename(fnufpfr:fnufl2r)
     fra07l1    if   e           k disk    rename(ra07pfr:ra07l1r)
     fra09l1    if   e           k disk    rename(ra09pfr:ra09l1r)
     fra08l1    if   e           k disk    rename(ra08pfr:ra08l1r)
     fra25l1    if   e           k disk    rename(ra25pfr:ra25l1r)
     fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
     fvpkol1    if   e           k disk    rename(vpkopfr:vpkol1r)
     ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
     ffnuflu    uf a e           k disk    rename(fnufpfr:fnuflur)
     ffo195p    o    e             printer
6.2B f                                     usropn
      *
      * Definering av Local data area
      *
     d                uds
     d l_ruti                800    809
     d d_kidk                883    883  0
     d l_wsid                901    910
     d l_user                911    920
     d l_filg                931    933
     d l_firm                944    946  0
     d l_fnav                951    980
      *
      * Definering av variabler i nøkler
      *
     d sohel1_aarr     s                   like(soaarr)
     d sohel1_binr     s                   like(sobinr)
     d sohelr_aarr     s                   like(soaarr)
     d sohelr_binr     s                   like(sobinr)
     d sohelr_numm     s                   like(sonumm)
     d sohelr_suff     s                   like(sosuff)
     d sodtl1_aarr     s                   like(sdaarr)
     d sodtl1_binr     s                   like(sdbinr)
     d sodtl1_numm     s                   like(sdnumm)
     d sodtl1_suff     s                   like(sdsuff)
     d rkunl1_kund     s                   like(rkkund)
     d vvarl1_vare     s                   like(vvvare)
     d vltyl1_ltyp     s                   like(sdltyp)
     d veanl2_vare     s                   like(vxvare)
     d votyl1_otyp     s                   like(vaotyp)
     d ra10l1_jkod     s                   like(rajkod)
     d ra18l1_rkod     s                   like(rarkod)
     d ra17l1_qkod     s                   like(raqkod)
     d fmftl1_faty     s                   like(fmtfat)
     d fnufl1_aarr     s                   like(fnuaar)
     d fnufl1_binr     s                   like(fnubin)
     d fnufl2_ufat     s                   like(fnufat)
     d fnufl2_ukda     s                   like(fnukda)
     d fnuflu_aarr     s                   like(fnuaar)
     d fnuflu_binr     s                   like(fnubin)
     d ra07l1_gkod     s                   like(ragkod)
     d ra08l1_hkod     s                   like(rahkod)
     d ra09l1_ikod     s                   like(raikod)
     d ra25l1_yrut     s                   like(rayrut)
     d jvarl1_vare     s                   like(jvvare)
     d vpkol1_pkod     s                   like(vapkod)
     d fkprl1_kund     s                   like(flkund)
     d fkprl1_kpro     s                   like(flkpro)
      *
      * Definering av variable
      *
     d w_firm          s                   like(rkfirm)
     d w_raba          s              5  2
     d w_tnto          s             13  2
     d w_tmva          s             13  2
     d w_tmva_m        s             15  5
     d w_tmvg          s             13  2
     d w_mtim          s              6  0
     d w_mref          s              6  0
     d w_ftnr          s              9
     d w_ftex          s             14
     d w_npri          s             13  2
     d w_tbto          s             13  2
     d w_cbda          s               d   datfmt(*iso)
     d w_cfda          s               d   datfmt(*iso)
     d w_retk          s              1
     d w_ctx1          s             20
     d w_ctx2          s             20
     d w_btxt          s             75
     d w_posm          s              4  0
     d w_numf          s             20
     d w_antx          s             11  2
     d w_anta          s             14
     d w_ntpe          s             15
     d w_ntpf          s             15
     d w_mvap          s              8
     d w_dnto          s             20
     d w_dbto          s             20
     d w_drab          s             20
     d w_antf          s              6  0
     d w_antl          s              6  0
     d w_anto          s              6  0
     d w_enhp          s             11  2
     d w_enhx          s             13
     d w_avru          s             11  2
     d w_avrx          s             13
     d w_rkrx          s             13
     d w_rabx          s              7
     d w_dmva          s             11  2
     d w_teid          s              1
     d w_binr          s                   like(sobinr)
     d w_kidd          s                   like(sokidd)
     d w_kidr          s                   like(sokidr)
     d w_kidrx         s              7
     d w_wlin          s              6  0
     d w_vare          s                   like(vvvare)
     d w_nobb          s                   like(vvnobb)
     d w_lvar          s                   like(vvlvar)
6.2C d w_totf          s                   like(sofsum)
     d w_eanx          s             14
     d w_leng          s              2  0
     d w_udat          s               d   datfmt(*iso)
      *
     d w_krol          s             20
     d w_maip          s             50
     d w_mail          s            100
     d w_besk          s             35
     d w_faku          s                   like(rkfaku)
     d w_kund          s                   like(rkkund)
     d w_kunx          s              6
     d w_rb1p          s             11  2
     d w_rb1h          s             11  2
     d w_rb1f          s             11  2
     d w_gr1p          s             11  2
     d w_gr1h          s             11  2
     d w_gr1f          s             11  2
     d w_gr2p          s             11  2
     d w_gr2h          s             11  2
     d w_gr2f          s             11  2
     d w_rb2p          s             11  2
     d w_rb2h          s             11  2
     d w_rb2f          s             11  2
     d w_rbsu          s             11  2
     d w1rab1          s                   like(sdsapr)
     d w_testv         s              5
     d w_akvl          s              5
     d w_mkvl          s              5
     d w_saml          s              5
     d w_btyp          s             10
     d w_fakd          s              6  0
     d w_fofd          s              6  0
     d w_ldat          s              6  0
     d w_ldal          s              6  0
     d w_odat          s              6  0
     d w_ftyp          s             10
     d w_valk          s              3
     d w_pnavn         s             75
     d w_padr1         s             75
     d w_padr2         s             75
     d w_padr3         s             75
     d w_ppost         s             75
     d w_psted         s             75
     d w_pkper         s             75
     d w_ponr          s              4
     d w_post          s             75
     d w_rekv          s             75
     d w_lbet          s             75
     d w_lmat          s             75
     d w_dref          s             75
     d w_vref          s             75
     d w_ltxt          s             75
     d w_prtx          s             75
     d w_pra1          s             75
     d w_pra2          s             75
     d w_atxt          s             75
     d w_aadr1         s             75
     d w_aadr2         s             75
     d w_asted         s             75
     d w_dist          s             75
     d w_kjor          s             75
     d w_ttxt          s            200
     d w_ttx1          s            100
     d w_ttx2          s            100
     d w_tek0          s            256
     d w_gtin          s                   like(sdeann)
     d w_stat          s              1
     d w_desi          s              1  0
     d w_nsap          s                   like(sdsapr)
     d w_rab1          s                   like(sdrab1)
     d w_rab2          s                   like(sdrab2)
     d w_tine          s              5
     d w_nbel          s                   like(sdsalg)
     d w_bbel          s                   like(sdsalg)
     d w_tnet          s                   like(sdsalg)
     d w_tbrt          s                   like(sdsalg)
     d w_brr1          s                   like(sdbrr1)
     d w_brr2          s                   like(sdbrr2)
     d w_rabp          s                   like(sorabp)
     d w_rabg          s                   like(sorbgp)
     d w_rabb          s                   like(sorkop)
     d w_kode          s              1
     d w_fell          s              6
     d w_type          s              2
     d w_fast          s             10
     d w_ruti          s             10
6.nu d w_numm          s              8  0
     d w_jnav          s             15
     d w_jkey          s             41
     d w_jstat         s              2  0
     d w_jtxt          s            200
     d w_kopi          s              5
     d w_bfak          s              5
     d w_test          s              5
     d w_aatxt         s             75
     d w_avrd          s             11  2
     d w_pdf           s              1  0
     d w_pdf_ds        s            512
     d w_epro          s             75
     d w_stxt          s             75
     d w_ptyp          s              2
     d w_mtid          s             13
     d w_mtyp          s             10
     d w_ant0          s             13  0
     d w_ant1          s             13  1
     d w_ant2          s             13  2
     d w_ant3          s             13  3
6.20 d w_pnum          s              6  0
6.20 d w_onum          s             12
6.22 d w_dpnvn         s             75
6.22 d w_dpad1         s             75
6.22 d w_dpad2         s             75
6.22 d w_dpstd         s             75
6.26 d w_land          s              2
6.2A d w_pdfv          s              5
6.2i d w_line          s                   like(sdline)
6.2K d w_mber          s             13  4
6.2m d w_nprd          s             13  4
6.36 d w_lv_nobb       s                   like(vvnobb)
6.36 d w_lv_modn       s                   like(vvnmod)
6.36 d w_lv_lldo       s                   like(vvldor)
6.36 d w_lv_llva       s                   like(vvlvar)
6.36 d w_lv_vtyp       s                   like(vvvtyp)
6.36 d w_lv_udat       s                   like(vvedat)
6.36 d w_lv_ldor       s                   like(vvldor)
6.36 d b_inlr          s              1    inz(*off)
      *
     d s_fsum          s             11  2
     d s_salp          s             11  2
     d s_salh          s             11  2
     d s_salf          s             11  2
     d s_rk1p          s             11  2
     d s_rk2p          s             11  2
     d s_rkop          s             11  2
     d s_rk1h          s             11  2
     d s_rk2h          s             11  2
     d s_rkoh          s             11  2
     d s_rk1f          s             11  2
     d s_rk2f          s             11  2
     d s_rkof          s             11  2
     d s_fnet          s             11  2
     d s_fbru          s             11  2
     d s_fmva          s             15  5
     d s_fmvg          s             11  2
     d s_frab          s             11  2
     d s_ltyp          s              2
     d s_mvp1          s              6  2
     d s_mvg1          s             11  2
     d s_mvb1          s             15  5
     d s_mvp2          s              6  2
     d s_mvg2          s             11  2
     d s_mvb2          s             15  5
     d s_mvp3          s              6  2
     d s_mvg3          s             11  2
     d t1tmva          s                   like(sosalp)
     d t1mvas          s              6  2
     d t1mvag          s                   like(sosalp)
     d t1mvab          s                   like(sosalp)
     d t5tmva          s                   like(sosalp)
     d t5mvas          s              6  2
     d t5mvag          s                   like(sosalp)
     d t5mvab          s                   like(sosalp)
     d t1fsum          s                   like(sosalp)
     d t1bsif          s              1
      *
     d a10             s              1    dim(24)
     d m10             s              1  0 dim(24)
     d u10             s              1  0 dim(12)
     d kidd10          s             24
      *
     d b_init          s              1    inz(*off)
     d b_binr          s              1    inz(*off)
     d b_numm          s              1    inz(*off)
     d b_logf          s              1    inz(*off)
     d b_saml          s              1    inz(*off)
     d b_kred          s              1    inz(*off)
     d b_skfl          s              1    inz(*off)
     d b_eof           s              1    inz(*off)
     d b_uskr          s              1    inz(*off)
     d b_topp          s              1    inz(*off)
     d b_bunn          s              1    inz(*off)
     d b_vare          s              1    inz(*off)
     d b_pdfp          s              1    inz(*off)
6.24 d b_fist          s              1    inz(*off)
6.2A d b_pdfv          s              1    inz(*off)
6.21 d b_orab          s              1    inz(*off)
      *
     d s_binr          s                   like(sobinr)
     d s_numm          s                   like(sonumm)
     d s_lbin          s                   like(sobinr)
     d s_lnum          s                   like(sonumm)
     d s_lsuf          s                   like(sosuff)
     d s_suff          s                   like(sosuff)
     d s_aarr          s                   like(soaarr)
      *
      * Definering av parametre
      *
     d p_aarr          s                   like(soaarr)
     d p_faty          s                   like(sofaty)
     d p_fnum          s                   like(sobinr)
     d p_tnum          s                   like(sobinr)
     d p_omkj          s              1
     d p_rapp          s              1
     d p_anta          s              4  0
     d p_feil          s              1
     d p_lr            s              1
      *
     d p_stat          s              1
     d p_ekod          s              1
     d p_etxt          s             30
     d p_dato          s               d   datfmt(*iso)
     d p_mvap          s              6  2
     d p_mvat          s              5  4
     d p_mvaf          s             10  9
      *
     d p_str_in        s            512
     d p_str_out       s            512
     d p_xmlf          s            256
     d p_filg          s             10
     d w_refn          s             50
     d w_selgn         s             16
      *
     d w_str_in        s            512
     d w_str_out       s            512
     d w_path          s            256
     d w_tek1          s            256
     d w_tek2          s            256
     d XML_Output      s            256a   Varying
     d XML_path        s            256a   Varying
     d                                     Inz('/home/asp/print/adb')
6.31 d jasper_mal      s            256a   inz('file:/home/asp/print/630/maler/+
     d                                     Faktura/Faktura.jasper')
     d jasper_logo     s            256a   Varying
     d tmpdate         s               D
     d tmptime         s               T
     d timestmp        s               Z
     d crlf            c                   const(X'0d25')
      *
     d d_pdf_ds        ds
     d  d_xmlm                       75
     d  d_jasm                       75
     d  d_logo                       75
     d  d_path                      100
     d  d_emal                       50
     d  d_fifo                       75
     d  d_kopi                        1
     d  d_dtaq                        1
6.30 d  d_sign                        1
      /copy prototypeb
      /copy usec
      *
      *
      * Definering av array's
      *
     d mko             s              1    dim(9)
     d msa             s              5  2 dim(9)
     d mgr             s             11  2 dim(9)
6.2k d*mbe             s             11  2 dim(9)
6.2k d mbe             s             13  4 dim(9)
     d mog             s             11  2 dim(9)
     d mor             s             11  2 dim(9)
     d ngr             s             11  2 dim(9)
6.2K d*nbe             s             11  2 dim(9)
6.2K d nbe             s             13  4 dim(9)
     d m               s              2  0
      *
     d w_mvak          s              1
     d w_mvtx          s             30
     d w_bpro          s              5  2
     d w_orab          s             13  2
      *
6.2B d p_btyp          s            100
      *
6.2B d p_tagg0         s             20
6.2B d p_tagg0val      s             50
6.2B d p_tagg1         s             20
6.2B d p_tagg1val      s             50
6.2B d p_tagg2         s             20
6.2B d p_tagg2val      s             50
6.2B d p_tagg3         s             20
6.2B d p_tagg3val      s             50
6.2B d p_tagg4         s             20
6.2B d p_tagg4val      s             50
6.2B d p_refn          s             50
6.2B d p_dspl          s            100
6.2B  *
6.2B d qsprilsp        pr                  extpgm('QSPRILSP')
6.2B d rcvvar                     32767a   options(*varsize)
6.2B d rcvvarlen                     10i 0 const
6.2B d format                         8a   const
6.2B d errorcode                  32767a   options(*varsize)
6.2B  *
6.2B d sprl0100        ds
6.2B d  bytesrtn                     10i 0
6.2B d  bytesavl                     10i 0
6.2B d  splfname                     10a
6.2B d  jobname                      10a
6.2B d  username                     10a
6.2B d  jobnbr                        6a
6.2B d  splfnbr                      10i 0
6.2B d  systemname                    8a
6.2B d  createdate                    7a
6.2B d                                1a
6.2B d  createtime                    6a
6.2B  *
6.2B d errorcode       ds
6.2B d  bytesprov                    10i 0 inz(0)
6.2B d  byteavail                    10i 0 inz(0)
6.2B  *
6.36 C/Exec SQL
6.36 C+  Set Option DatFmt=*ISO
6.36 C/End-Exec
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Leser firmadata ifm avsenderinformasjon
      *
     c     afir_key      chain     afirl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      * Henter OFAK informasjon
      *
     c     fstsl1_key    chain     fstsl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      * Hent statuskode 8
      *
     c     raa8l1_key    chain     raa8l1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      * Henter fakturatype info
      *
     c                   eval      fmftl1_faty = p_faty
     c     fmftl1_key    chain     fmftl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      *
     c                   select
     c                   when      p_omkj = *blank
     c                   eval      fnufl2_ufat = p_faty
     c                   eval      fnufl2_ukda = *loval
     c     fnufl2_key    setll     fnufl2
     c                   read      fnufl2                                 90
     c                   when      p_omkj = '1'
     c                   eval      fnufl1_aarr = p_aarr
     c                   eval      fnufl1_binr = p_fnum
     c     fnufl1_key    setll     fnufl1
     c                   read      fnufl1                                 90
     c                   endsl
      *
     c                   dow       *in90 = *off
      *
      * hvis vanlig kjøring - og kjørt dato <> *loval da kan man avslutte
     c                   if        p_omkj = *blank and
     c                             fnukda <> *loval
     c                   goto      siste
     c                   endif
      * hvis omkjøring  - og til faktnr. er passert kan man avslutte
     c                   if        p_omkj = '1' and
     c                             fnubin > p_tnum
     c                   goto      siste
     c                   endif
      *
     c                   if        fnuaar = p_aarr and
     c                             fnufat = p_faty
      *
     c                   exsr      sjk_uf_log
      *
     c                   if        b_logf = *on
      *
6.24 c                   if        b_pdfp = *on and
6.24 c                             b_fist = *on
     c                   exsr      xml_start
     c                   endif
      *
     c                   if        b_uskr = *off and
     c                             p_rapp = '1'
     c                   exsr      skr_rapph
     c                   endif
      *
     c                   eval      sohel1_aarr = p_aarr
     c                   eval      sohel1_binr = fnubin
     c     sohel1_key    setll     sohel1
     c     sohel1_key    reade     sohel1
     c                   exsr      sjk_bruksrett
     c                   exsr      sub_saml
     c                   exsr      sub_fakthod
     c                   exsr      sub_fakpart
      *
     c                   dow       not %eof(sohel1)
      * Ordrehode
     c                   exsr      sub_ordrehod
      *
      * Iterasjon på fakturahode
      *
     c                   eval      sodtl1_aarr = soaarr
     c                   eval      sodtl1_binr = sobinr
     c                   eval      sodtl1_numm = sonumm
     c                   eval      sodtl1_suff = sosuff
     c                   eval      w_tbto = w_tbto + sofsum
      *
     c     sodtl1_key    setll     sodtl1
     c     sodtl1_key    reade     sodtl1
      *
      * Iterasjon på fakturalinje
      *
     c                   eval      b_topp = *off
     c                   eval      b_bunn = *off
     c                   eval      b_vare = *off
      *
     c                   dow       not %eof(sodtl1)
      *
     c     sdktxt        caseq     1             sub_toppt
     c     sdktxt        caseq     3             sub_varel
     c     sdktxt        caseq     5             sub_bunnt
     c                   cas                     sub_what
     c                   endcs
      *
     c     sodtl1_key    reade     sodtl1
      *
     c                   eval      s_aarr = sdaarr
     c                   eval      s_numm = sdnumm
     c                   eval      s_suff = sdsuff
     c                   eval      s_binr = sdbinr
     c                   enddo
      * Skriv nødvendige ordretagger
6.2i  * NB Disse har byttet plass pga EHF faktura. Vi skriver
6.2i  * ordrerabatter som varelinjer pga EHF måten å sjekke faktura
6.2i  * på.
6.2i c                   exsr      sub_orabatt
6.21 c                   exsr      sub_olslutt
     c                   exsr      sub_oslutt
     c                   exsr      save_fsum
      *
     c     sohel1_key    reade     sohel1
     c                   if        %eof(sohel1) or
     c                             sobinr <> fnubin
     c                   exsr      skriv_fslut
     c                   endif
      *
     c                   enddo
      *
     c                   endif
      *
     c                   endif
      *
     c                   select
     c                   when      p_omkj = *blank
     c                   read      fnufl2                                 90
     c                   when      p_omkj = '1'
     c                   read      fnufl1                                 90
     c                   endsl
      *
     c                   enddo
      *
     c     siste         tag
      *
      * Skriv xml fila på disk
      *
     c                   if        w_antf > 0
     c                   exsr      xml_end
     c                   endif
6.2C  * Legg ut totaler, hvis det er funnet noen fakturaer.
6.2C c                   if        w_totf <> 0
6.2C c                   eval      t1fsum = w_totf
6.2C c                   eval      t1fftn = aafftn
6.2C c                   write     t1tot                                30
6.2C c                   endif
6.2B  * Generer xml for PDF på mail.
6.2D c                   if        w_antf > 0
6.2B c                   exsr      spoolnbr
6.2B c                   exsr      xml_create
6.2D c                   endif
6.2B c                   close     fo195p
      * Avslutt jobbiden
     c                   call      'AB710R'
     c                   parm                    w_jkey
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     avslutt       tag
      *
     c                   eval      p_anta = w_antf
      *
     c                   eval      *inlr = *on
     c                   return
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_start     begsr
      *
      * - Meldingstidspunkt / versjon / testindikator
      *
     c                   if        fmttes = 1
     c                   eval      w_test = 'true'
     c                   else
     c                   eval      w_test = 'false'
     c                   endif
      * Type nr på avsender
     c                   eval      w_akvl = 'GLN  '
      *
      /Free
           // Legg ut start på XML fil
               UpdHTMLVar('Batchnummer':                w_jkey);
               WrtSection('Start');

           // Legg inn avsenderinfo
               UpdHTMLVar('Avsender':            %char(ra8ean));
               UpdHTMLVar('Avsenderkvalifikator':%trim(w_akvl));
               UpdHTMLVar('Testindikator':       %trim(w_test));
               UpdHTMLVar('Versjon':                     '1.0');
               UpdHTMLVar('Meldingstidspunkt': %char(timestmp));
               WrtSection('Avsender');
      /End-free
      *
     c                   eval      b_pdfp = *off
6.24 c                   eval      b_fist = *off
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Slutt                   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_end       begsr
      *
      /Free
           // Avslutt XML fil før den skrives til disk
               WrtSection('Avslutt');
      /End-free
      *
     c                   eval      XML_Output = XML_path + 'sgf/'+
     c                             'FAKT_'+ %trim(w_jkey) + '.xml'
      *
     c                   callp     WrtHtmlToStmf(XML_Output: 819)
6.30  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
6.30 c                   if        d_dtaq = '1'
6.30 c                   eval      p_xmlf = xml_output
6.30 c                   eval      p_filg = 'ADB'+l_filg
6.30 c                   call      'AP629C'
6.30 c                   parm                    p_filg
6.30 c                   parm                    p_xmlf
6.30 c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av faktura-hode
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_fakthod   begsr
6.2G  * Må være samme fakturanr som fra FNUF. Blir feil hvis faktura
6.2G  * uten linjer.
6.2G c                   if        sobinr <> fnubin
6.2G c                   leavesr
6.2G c                   endif
      *
     c                   if        s_lbin <> 0 and
     c                             s_lbin = sobinr
     c                   leavesr
     c                   endif
      *
     c                   eval      w_btyp = *blank
     c                   eval      w_mtyp = *blank
     c                   eval      w_akvl = *blank
     c                   eval      w_mkvl = *blank
     c                   eval      w_ftyp = *blank
     c                   eval      w_mtid = *blank
      *
      * Hent inn info fra ordretypereg
      *
     c                   eval      votyl1_otyp = sootyp
     c     votyl1_key    chain     votyl1r
      *
      * Leser kunde for å finne evt. byggm.faktura
      *
     c                   eval      rkunl1_kund = sokund
     c     rkunl1_key    chain     rkunl1
      *
      * - Recordtype / faktura eller kreditnota
      *
     c                   if        vaokre = '-'
     c                   eval      w_ftyp = 'KREDITNOTA'
     c                   eval      b_kred = *on
     c                   else
     c                   eval      w_ftyp = 'FAKTURA   '
     c                   eval      b_kred = *off
     c                   endif
      *
      * - Mottakers-id eller behandlingstype / kvalifikator
      *
     c                   if        p_faty = 10
     c                   eval      w_btyp = 'EFAKTURA'
     c                   endif
      *
     c                   if        p_faty = 11
6.29 c**                 eval      w_btyp = 'PRINT'
6.29 c                   eval      w_btyp = 'ARCHIVE'
     c                   endif
      *
     c                   if        p_faty = 12
     c                   eval      w_btyp = 'EMAILSPLIT'
     c                   endif
      *
     c                   if        p_faty = 15
     c                   eval      w_btyp = 'EMAIL'
     c                   endif
6.20  * Hvis den kommer fra butikk
6.20 c                   if        soshop = 1
6.20 c                   eval      w_btyp = 'ARCHIVE'
6.20 c                   endif
      *
      * - Meldingstype
      *
     c                   eval      w_mtyp = 'INVOICE'
     c                   eval      b_init = *on
      * Hvilken info har vi på kunde ?
     c                   if        rkeank > 0
     c                   movel     rkeank        w_mtid
     c                   eval      w_mkvl = 'GLN  '
     c                   else
     c                   movel     rkftnr        w_mtid
     c                   eval      w_mkvl = 'ORGNR'
     c                   endif
      *
      /Free
           // Legg ut fakturastart
               UpdHTMLVar('Mottakerid':         %trim(w_mtid));
               UpdHTMLVar('Mottakerkvalifikator':      w_mkvl);
               UpdHTMLVar('Meldingstype':       %trim(w_mtyp));
               UpdHTMLVar('Behandlingstype':    %trim(w_btyp));
               UpdHTMLVar('Bankkontonummer':    %char(aafbgi));
               UpdHTMLVar('Kidnummer':          %trim(w_kidd));
               UpdHTMLVar('Swift':              %trim(aaswif));
               UpdHTMLVar('Iban':               %trim(aaswif));
               WrtSection('Fakturastart');

      /End-free
      *
     c                   eval      w_saml = *blank
     c                   eval      w_valk = *blank
     c                   eval      w_kopi = *blank
      *
      * - Fakturadato / forfallsdato
      *
     c                   eval      w_fakd = 0
     c                   if        sofkda <> *loval
     c     *dmy          move      sofkda        w_fakd
     c                   endif
      *
     c                   eval      w_fofd = 0
     c                   if        soffda <> *loval
     c     *dmy          move      soffda        w_fofd
     c                   endif
      * Samlefaktura
     c                   if        b_saml = *on
     c                   eval      w_saml = 'true'
     c                   else
     c                   eval      w_saml = 'false'
     c                   endif
      *
      * - Valuta
      *
     c                   if        sovalk <> *blank
     c                   eval      w_valk = sovalk
     c                   else
     c                   eval      w_valk = 'NOK'
     c                   endif
      *
      * - Fakturakopi (ja, hvis den er overført tidligere)
      *
     c                   if        fnutel > 0
     c                   eval      w_kopi = 'true'
     c                   else
     c                   eval      w_kopi = 'false'
     c                   endif
      *
      * - Byggmesterfaktura
      *
     c                   if        rkfcop = 2 or
     c                             rkfcop = 3
     c                   eval      w_bfak = 'true'
     c                   else
     c                   eval      w_bfak = 'false'
     c                   endif
      *
      * - Betalingsbet.tekst / rabatt / straffegebyr
      *
     c                   eval      w_btxt = *blank
     c                   if        sobetb <> *zero
     c                   eval      w_cbda = *loval
     c                   eval      w_cfda = *loval
     c                   eval      w_ctx1 = *blank
     c                   eval      w_ctx2 = *blank
      *
     c                   call      'FÅ703R'
     c                   parm                    w_firm
     c                   parm                    sobetb
     c                   parm                    w_cbda
     c                   parm                    w_retk
     c                   parm                    w_cfda
     c                   parm                    w_ctx1
     c                   parm                    w_ctx2
      *
     c                   eval      w_btxt = w_ctx1 + w_ctx2
      * Scan etter ugyldige tegn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_btxt        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   eval      w_btxt = *blanks
     c                   movel     p_str_out     w_btxt
     c                   endif
6.2A  * Legg ut kode for pdf vedlegg
6.2A c                   eval      w_pdfv = 'false'
6.2A c                   if        b_pdfv = *on
6.2A c                   eval      w_pdfv = 'true'
6.2A c                   endif
      *
      /Free
           // Legg ut fakturahodet
               UpdHTMLVar('Fakturatype':         %trim(w_ftyp));
               UpdHTMLVar('Fakturanummer':       %char(sobinr));
               UpdHTMLVar('Fakturakopi':         %trim(w_kopi));
          //  Fakturadato
               test(de) *dmy w_fakd;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_fakd : *dmy);
               endif;
               UpdHTMLVar('Fakturadato':    %char(tmpdate : *iso));
          //  Forfallsdato
               test(de) *dmy w_fofd;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_fofd : *dmy);
               endif;
               UpdHTMLVar('Forfallsdato':   %char(tmpdate : *iso));
               UpdHTMLVar('Betalingsbetingelser':   %trim(w_btxt));
               UpdHTMLVar('Valutakode':                    w_valk);
               UpdHTMLVar('Samlefaktura':           %trim(w_saml));
               UpdHTMLVar('Byggmesterfaktura':      %trim(w_bfak));
6.2A           UpdHTMLVar('PDFVedlegg':             %trim(w_pdfv));
               WrtSection('Fakturahode');

      /End-free
      *
      *
      * Skriv info til liste
      *
     c                   eval      a1binr = sobinr
     c                   eval      a1numm = sonumm
     c                   move      sosuff        a1suff
     c                   eval      a1otyp = sootyp
     c     *dmy          move      sofkda        a1fkda
     c     *dmy          move      soffda        a1ffda
     c                   eval      a1kund = sokund
     c                   eval      a1navn = rknavn
     c                   eval      a2navn = sonavn
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av faktura-hode/partsinfo.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_fakpart   begsr
6.2G  * Må være samme fakturanr som fra FNUF. Blir feil hvis faktura
6.2G  * uten linjer.
6.2G c                   if        sobinr <> fnubin
6.2G c                   leavesr
6.2G c                   endif
      *
     c*                  if        s_ltyp <> '10' and
     c*                            s_ltyp <> '11'
     c*                  leavesr
     c*                  endif
      *
      * Partsinformasjon
      *
      *
      * > Kjøperinfo. (BY)
      *
     c                   eval      w_pnavn = *blanks
     c                   eval      w_padr1 = *blanks
     c                   eval      w_padr2 = *blanks
     c                   eval      w_padr3 = *blanks
     c                   eval      w_ppost = *blanks
     c                   eval      w_psted = *blanks
     c                   eval      w_pkper = *blanks
      *
     c                   eval      w_ptyp = 'BY'
      *
     c                   eval      rkunl1_kund = sokund
     c     rkunl1_key    chain     rkunl1
      * Gjemmer unna fakturakunde, hvis den finnes
     c                   eval      w_faku = rkfaku
      *
      * Partsinformasjon består for alle parter av :
      * - EAN-nr./foretaksnr/kundenr.
      * - Navn/adresse 1+2/postnr./poststed/landkode
      * - Kont.pers./e-mail/webadresse/Tlf.nr
      *
      * Navn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rknavn        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pnavn
      * Adresse 1
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rkgate        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_padr1
      * Adresse 2
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rkadr2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_padr2
      * Poststed
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rksted        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_psted
      * Kontaktperson
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rkpers        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pkper
      * Foretaksnummer
     c                   eval      w_ftex = *blank
     c                   if        rkftnr <> *zero
     c                   move      rkftnr        w_ftnr
     c                   eval      w_ftex = 'NO' + w_ftnr + 'MVA'
     c                   endif
      *
     c                   eval      w_mail = *blank
      * prøver først å finne mail på kontaktperson - rolle EMAIL
     c                   eval      w_krol = 'EMAIL1'
     c                   call      'RS752R  '
     c                   parm                    w_firm
     c                   parm                    sokund
     c                   parm                    w_krol
     c                   parm                    w_maip
      *
     c                   movel     w_maip        w_mail
     c                   if        w_mail = *blank
     c                   movel     rkemal        w_mail
     c                   else
      * prøver å finne mailadresse 2
     c                   eval      w_krol = 'EMAIL2'
     c                   call      'RS752R  '
     c                   parm                    w_firm
     c                   parm                    sokund
     c                   parm                    w_krol
     c                   parm                    w_maip
     c                   if        w_maip <> *blank
     c                   eval      w_mail = %trim(w_mail) +',' +
     c                                      %trim(w_maip)
     c                   endif
     c                   endif
      *
6.26 c                   eval      w_land = 'NO'
6.26 c                   if        rkland <> *blanks
6.26 c                   eval      w_land = rkland
6.26 c                   endif
      *
      /Free
           // Legg ut kjøper
               UpdHTMLVar('Partnertype':            %trim(w_ptyp));
               UpdHTMLVar('Partnernummer':          %char(sokund));
               UpdHTMLVar('Partnernavn':           %trim(w_pnavn));
               UpdHTMLVar('Partneradresse1':       %trim(w_padr1));
               UpdHTMLVar('Partneradresse2':       %trim(w_padr2));
               UpdHTMLVar('Partneradresse3':       %trim(w_padr3));
               UpdHTMLVar('Partnerpostnummer':      %char(rkponr));
               UpdHTMLVar('Partnerpoststed':       %trim(w_psted));
6.26           UpdHTMLVar('Partnerlandkode':               w_land);
               UpdHTMLVar('Partnerforetaksnummer':  %trim(w_ftex));
               UpdHTMLVar('PartnerGLN':             %char(rkeank));
               UpdHTMLVar('Partnerkontakt':        %trim(w_pkper));
               UpdHTMLVar('Partnermail':            %trim(w_mail));
               UpdHTMLVar('Partnermobil':           %trim(somobi));
               UpdHTMLVar('Partnertelefon':         %trim(rktlfn));
               UpdHTMLVar('Partnerwebadresse':      %trim(rkweba));
               WrtSection('Partner');

      /End-free
      *
      * > Selger (SU)
      *
     c                   eval      w_pnavn = *blanks
     c                   eval      w_padr1 = *blanks
     c                   eval      w_padr2 = *blanks
     c                   eval      w_padr3 = *blanks
     c                   eval      w_ppost = *blanks
     c                   eval      w_psted = *blanks
     c                   eval      w_pkper = *blanks
     c                   eval      w_ponr = *blanks
     c                   eval      w_post = *blanks
      *
     c                   eval      w_ptyp = 'SU'
      * Navn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     aafnav        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pnavn
      * Adresse 1
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     aafad1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_padr1
      * Adresse 2
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     aafad2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_padr2
      * Poststed
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sosted        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_psted
      * Foretaksnummer
     c                   eval      w_ftex = *blank
     c                   if        aafftn <> *zero
     c                   move      aafftn        w_ftnr
     c                   eval      w_ftex = 'NO' + w_ftnr + 'MVA'
     c                   endif
      *
     c                   eval      w_ponr = %subst(aafste:1:4)
     c                   eval      w_post = %trim(%subst(aafste:5))
      *
      *
      /Free
           // Legg ut selger
               UpdHTMLVar('Partnertype':            %trim(w_ptyp));
               UpdHTMLVar('Partnernummer':                    '0');
               UpdHTMLVar('Partnernavn':           %trim(w_pnavn));
               UpdHTMLVar('Partneradresse1':       %trim(w_padr1));
               UpdHTMLVar('Partneradresse2':       %trim(w_padr2));
               UpdHTMLVar('Partneradresse3':       %trim(w_padr3));
               UpdHTMLVar('Partnerpostnummer':      %trim(w_ponr));
               UpdHTMLVar('Partnerpoststed':        %trim(w_post));
               UpdHTMLVar('Partnerlandkode':                 'NO');
               UpdHTMLVar('Partnerforetaksnummer':  %trim(w_ftex));
               UpdHTMLVar('PartnerGLN':             %char(ra8ean));
               UpdHTMLVar('Partnerkontakt':        %trim(w_pkper));
               UpdHTMLVar('Partnermail':            %trim(aamail));
               UpdHTMLVar('Partnermobil':                     ' ');
               UpdHTMLVar('Partnertelefon':         %trim(aaftlf));
               UpdHTMLVar('Partnerwebadresse':      %trim(aaweba));
               WrtSection('Partner');

      /End-free
      *
      *
      * > Fakturamottager (IV)(hvis finnes)
      *
     c                   if        w_faku <> 0
      *
     c                   eval      w_ptyp = 'IV'
      *
     c                   eval      rkunl1_kund = w_faku
     c     rkunl1_key    chain     rkunl1
      *
      * Partsinformasjon består for alle parter av :
      * - EAN-nr./foretaksnr/kundenr.
      * - Navn/adresse 1+2/postnr./poststed/landkode
      * - Kont.pers./e-mail/webadresse/Tlf.nr
      *
      * Navn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rknavn        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pnavn
      * Adresse 1
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rkgate        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_padr1
      * Adresse 2
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rkadr2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_padr2
      * Poststed
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rksted        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_psted
      * Kontaktperson
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rkpers        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pkper
      * Foretaksnummer
     c                   eval      w_ftex = *blank
     c                   if        rkftnr <> *zero
     c                   move      rkftnr        w_ftnr
     c                   eval      w_ftex = 'NO' + w_ftnr + 'MVA'
     c                   endif
      *
     c                   eval      w_mail = *blank
      * prøver først å finne mail på kontaktperson - rolle EMAIL
     c                   eval      w_krol = 'EMAIL1'
     c                   call      'RS752R  '
     c                   parm                    w_firm
     c                   parm                    rkkund
     c                   parm                    w_krol
     c                   parm                    w_maip
      *
     c                   movel     w_maip        w_mail
     c                   if        w_mail = *blank
     c                   movel     rkemal        w_mail
     c                   else
      * prøver å finne mailadresse 2
     c                   eval      w_krol = 'EMAIL2'
     c                   call      'RS752R  '
     c                   parm                    w_firm
     c                   parm                    rkkund
     c                   parm                    w_krol
     c                   parm                    w_maip
     c                   if        w_maip <> *blank
     c                   eval      w_mail = %trim(w_mail) +',' +
     c                                      %trim(w_maip)
     c                   endif
     c                   endif
      *
6.26 c                   eval      w_land = 'NO'
6.26 c                   if        rkland <> *blanks
6.26 c                   eval      w_land = rkland
6.26 c                   endif
      *
      /Free
           // Legg ut fakturamottaker
               UpdHTMLVar('Partnertype':            %trim(w_ptyp));
               UpdHTMLVar('Partnernummer':          %char(w_faku));
               UpdHTMLVar('Partnernavn':           %trim(w_pnavn));
               UpdHTMLVar('Partneradresse1':       %trim(w_padr1));
               UpdHTMLVar('Partneradresse2':       %trim(w_padr2));
               UpdHTMLVar('Partneradresse3':       %trim(w_padr3));
               UpdHTMLVar('Partnerpostnummer':      %char(rkponr));
               UpdHTMLVar('Partnerpoststed':       %trim(w_psted));
6.26           UpdHTMLVar('Partnerlandkode':               w_land);
               UpdHTMLVar('Partnerforetaksnummer':  %trim(w_ftex));
               UpdHTMLVar('PartnerGLN':             %char(rkeank));
               UpdHTMLVar('Partnerkontakt':        %trim(w_pkper));
               UpdHTMLVar('Partnermail':            %trim(w_mail));
               UpdHTMLVar('Partnermobil':           %trim(rkmobn));
               UpdHTMLVar('Partnertelefon':         %trim(rktlfn));
               UpdHTMLVar('Partnerwebadresse':      %trim(rkweba));
               WrtSection('Partner');

      /End-free
      *
      * henter riktig kundeinfo igjen
     c                   eval      rkunl1_kund = sokund
     c     rkunl1_key    chain     rkunl1
      *
     c                   eval      s_lbin = sobinr
      *
     c                   endif
6.22  *
6.22  * > Levertingsadresse(hvis finnes)
6.22  *
6.22 c                   if        sonavn <> *blanks
6.22  *
6.22 c                   eval      w_dpnvn = *blanks
6.22 c                   eval      w_dpad1 = *blanks
6.22 c                   eval      w_dpad2 = *blanks
6.22 c                   eval      w_dpstd = *blanks
6.22  *
6.22 c                   eval      w_ptyp = 'DP'
6.22  *
6.22  * Navn
6.22  *
6.22 c                   eval      p_str_in = *blank
6.22 c                   eval      p_lr = '0'
6.22 c                   movel     sonavn        p_str_in
6.22 c                   call      'AP613R'
6.22 c                   parm                    p_str_in
6.22 c                   parm                    p_str_out
6.22 c                   parm                    p_lr
6.22 c                   movel     p_str_out     w_dpnvn
6.22  * Adresse 1
6.22 c                   eval      p_str_in = *blank
6.22 c                   eval      p_lr = '0'
6.22 c                   movel     soadr1        p_str_in
6.22 c                   call      'AP613R'
6.22 c                   parm                    p_str_in
6.22 c                   parm                    p_str_out
6.22 c                   parm                    p_lr
6.22 c                   movel     p_str_out     w_dpad1
6.22  * Adresse 2
6.22 c                   eval      p_str_in = *blank
6.22 c                   eval      p_lr = '0'
6.22 c                   movel     soadr2        p_str_in
6.22 c                   call      'AP613R'
6.22 c                   parm                    p_str_in
6.22 c                   parm                    p_str_out
6.22 c                   parm                    p_lr
6.22 c                   movel     p_str_out     w_dpad2
6.22  * Poststed
6.22 c                   eval      p_str_in = *blank
6.22 c                   eval      p_lr = '0'
6.22 c                   movel     sosted        p_str_in
6.22 c                   call      'AP613R'
6.22 c                   parm                    p_str_in
6.22 c                   parm                    p_str_out
6.22 c                   parm                    p_lr
6.22 c                   movel     p_str_out     w_dpstd
6.22  *
6.22  /Free
6.22       // Legg ut fakturamottaker
6.22           UpdHTMLVar('Partnertype':            %trim(w_ptyp));
6.22           UpdHTMLVar('Partnernummer':                    '0');
6.22           UpdHTMLVar('Partnernavn':           %trim(w_dpnvn));
6.22           UpdHTMLVar('Partneradresse1':       %trim(w_dpad1));
6.22           UpdHTMLVar('Partneradresse2':       %trim(w_dpad2));
6.22           UpdHTMLVar('Partneradresse3':                  ' ');
6.22           UpdHTMLVar('Partnerpostnummer':                ' ');
6.22           UpdHTMLVar('Partnerpoststed':       %trim(w_psted));
6.26           UpdHTMLVar('Partnerlandkode':                 'NO');
6.22           UpdHTMLVar('Partnerforetaksnummer':            ' ');
6.22           UpdHTMLVar('PartnerGLN':                       ' ');
6.22           UpdHTMLVar('Partnerkontakt':                   ' ');
6.22           UpdHTMLVar('Partnermail':                      ' ');
6.22           UpdHTMLVar('Partnermobil':                     ' ');
6.22           UpdHTMLVar('Partnertelefon':                   ' ');
6.22           UpdHTMLVar('Partnerwebadresse':                ' ');
6.22           WrtSection('Partner');
6.22
6.22  /End-free
6.22  *
6.22 c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av ordrehodet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     sub_ordrehod  begsr
      *
      /Free
           // Legg ut Ordre
               WrtSection('OrdreStart');

      /End-free
      *
      * - Kjøpers best.nr. (eller rekvisisjonsnr)
      *
     c                   eval      w_rekv = *blanks
     c                   if        sokbnr <> *blank
     c                   eval      w_rekv = sokbnr
     c                   else
     c                   eval      w_rekv = sorekv
     c                   endif
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_rekv        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   eval      w_rekv = *blanks
     c                   movel     p_str_out     w_rekv
      *
      * - Leveringsbet. (tekst/kode/sted)
      *
     c                   eval      w_lbet = *blanks
     c                   if        solbet <> *zero
     c                   eval      ra18l1_rkod = solbet
     c     ra18l1_key    chain     ra18l1r
     c                   eval      w_lbet = %trim(rartx1)
     c                   else
     c                   eval      w_lbet = 'Etter avtale'
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_lbet        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   eval      w_lbet = *blanks
     c                   movel     p_str_out     w_lbet
     c                   endif
      *
      * - Transportmåte/transportør
      *
     c                   eval      w_lmat = *blanks
     c                   if        solmat <> *zero
     c                   eval      ra17l1_qkod = solmat
     c     ra17l1_key    chain     ra17l1r
     c                   eval      w_lmat = %char(raqkod) + ' ' +
     c                                      %trim(raqtxt)
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_lmat        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   eval      w_lmat = *blanks
     c                   movel     p_str_out     w_lmat
     c                   endif
      * - Ordredato
     c                   eval      w_odat = 0
     c                   if        sobdat <> *loval
     c     *dmy          move      sobdat        w_odat
     c                   endif
      * Leveringsdato
     c                   eval      w_ldat = 0
     c                   if        soldat <> *loval
     c     *dmy          move      soldat        w_ldat
     c                   endif
      *
      * - Kundereferansenr (deres ref)
      *
     c                   eval      w_dref = *blanks
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sodref        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dref
      *
      * - Vår referanse
      *
     c                   eval      w_vref = *blanks
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sovref        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_vref
      * Lager
     c                   eval      w_ltxt = *blanks
     c                   if        solage <> 0
     c                   eval      ra10l1_jkod = solage
     c     ra10l1_key    chain     ra10l1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rajtxt        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ltxt
     c                   endif
      *
      * - Selger
      *
     c                   eval      w_stxt = *blanks
     c                   if        soselg <> 0
     c                   eval      ra09l1_ikod = soselg
     c     ra09l1_key    chain     ra09l1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     raitxt        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_stxt
     c                   endif
      * Hent over eksternt prosjektnr
      * dersom dette finnes
     c                   eval      w_epro = *blanks
     c                   eval      w_prtx = *blanks
     c                   eval      w_pra1 = *blanks
     c                   eval      w_pra2 = *blanks
6.20 c                   eval      w_onum = *blanks
6.20 c                   eval      w_pnum = *zero
      *
     c                   eval      fkprl1_kund = sokund
     c                   eval      fkprl1_kpro = sokpro
     c     fkprl1_key    chain     fkprl1r
     c                   if        %found
     c                   if        flepro <> *blank
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     flepro        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_epro
     c                   endif
      * Prosjektinfo
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     flnavn        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_prtx
      * Adresse 1
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     fladr1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pra1
      * Adresse 2
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     fladr2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pra2
      *
     c                   endif
6.20  * Er dette fra kassa
6.20 c                   if        soshop = 1
6.20 c                   eval      w_onum = sobong
6.20 c                   eval      w_pnum = 0
6.20 c                   else
6.20 c                   movel     sonumm        w_onum
6.20 c                   eval      w_pnum = sonumm
6.20 c                   endif
      *
      /Free
           // Legg ut ordrehodet
6.20           UpdHTMLVar('Ordrenummer':                   w_onum);
6.20           UpdHTMLVar('Pakkseddelnummer':       %char(w_pnum));
               UpdHTMLVar('Rekvisisjonsnummer':     %trim(w_rekv));
               UpdHTMLVar('Leveringsmate':          %trim(w_lmat));
               UpdHTMLVar('Leveringsbetingelse':    %trim(w_lbet));
          //  Ordredato
               test(de) *dmy w_odat;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_odat : *dmy);
               endif;
               UpdHTMLVar('Ordredato':      %char(tmpdate : *iso));
          //  Leveringsdato
               test(de) *dmy w_ldat;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_ldat : *dmy);
               endif;
               UpdHTMLVar('Leveringsdato':  %char(tmpdate : *iso));

               UpdHTMLVar('Deresref':               %trim(w_dref));
               UpdHTMLVar('Varref':                 %trim(w_vref));
6.28     //    UpdHTMLVar('Lager':                  %trim(w_ltxt));
6.28           UpdHTMLVar('Lager':                  %char(solage));
               UpdHTMLVar('Selger':                 %trim(w_stxt));
               UpdHTMLVar('Selgerinfo':             %trim(raimob));
               UpdHTMLVar('Eksterntprosjektnummer': %trim(w_epro));
               UpdHTMLVar('Partnermail':            %trim(w_mail));
               UpdHTMLVar('Partnermobil':           %trim(rkmobn));
               UpdHTMLVar('Partnertelefon':         %trim(rktlfn));
               UpdHTMLVar('Partnerwebadresse':      %trim(rkweba));
               WrtSection('OrdrehodeStart');

           // Legg ut Prosjekt
               UpdHTMLVar('Prosjektnummer':         %char(sokpro));
               UpdHTMLVar('Prosjektnavn':           %trim(w_prtx));
               UpdHTMLVar('Prosjektadresse1':       %trim(w_pra1));
               UpdHTMLVar('Prosjektadresse2':       %trim(w_pra2));
               UpdHTMLVar('Prosjektpostnummer':               '0');
               UpdHTMLVar('Prosjektpoststed':                 ' ');
               WrtSection('Prosjekt');

      /End-free
      *
      * Avdeling
      *
     c                   eval      w_atxt = *blanks
     c                   eval      w_aadr1 = *blanks
     c                   eval      w_aadr2 = *blanks
     c                   eval      w_asted = *blanks
      *
     c                   if        soavde <> *zero
     c                   eval      ra07l1_gkod = soavde
     c     ra07l1_key    chain     ra07l1
      * Navn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ragtxt        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_aatxt
      * Adresse 1
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ragadr        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_aadr1
      * Adresse 2
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ragad2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_aadr2
      * Poststed
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     ragste        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_asted
      *
     c                   endif
      * Distrikt
     c                   eval      w_dist = *blanks
     c                   if        sodist <> *zero
     c                   eval      ra08l1_hkod = sodist
     c     ra08l1_key    chain     ra08l1
      * Navn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rahtxt        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dist
      *
     c                   endif
      * Kjørerute
     c                   eval      w_kjor = *blanks
     c                   if        sokjor <> *zero
     c                   eval      ra25l1_yrut = sokjor
     c     ra25l1_key    chain     ra25l1
      * Navn
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     raytxt        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_kjor
      *
     c                   endif
      *
      *
      /Free
           // Legg ut Avdelingsinformasjon
               UpdHTMLVar('Avdelingsnummer':        %char(soavde));
               UpdHTMLVar('Avdelingsnavn':         %trim(w_aatxt));
               UpdHTMLVar('Avdelingsadresse1':     %trim(w_aadr1));
               UpdHTMLVar('Avdelingsadresse2':     %trim(w_aadr2));
               UpdHTMLVar('Avdelingspostnummer':    %char(ragpnr));
               UpdHTMLVar('Avdelingspoststed':     %trim(w_asted));
               UpdHTMLVar('Distrikt':               %trim(w_dist));
               UpdHTMLVar('Kjorerute':              %trim(w_kjor));
               WrtSection('Avdeling');

           // Legg ut slutten på ordrehodet (Setter start på linjer)
               WrtSection('Ordrehodeslutt');

      /End-free
      *
     c                   eval      s_lnum = sonumm
     c                   eval      s_lsuf = sosuff
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av fakturalinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_varel     begsr
      * Sørg for at vi har skrevet siste tag for topptext før vi begynner
      * med detaljer.
     c                   if        b_topp = *on
     c                   exsr      sub_topp_end
     c                   eval      b_topp = *off
     c                   endif
      * Er dette tekstlinje ?
     c                   if        sdltyp <> 'TX'
      * Vanlig varelinje ........
      *
      * - Hvis ikke vare funnet eller skaffevare (sdlvre = 1)-sjekk jvarpf
      *
     c                   eval      w_vare = sdvare
     c                   eval      w_nobb = 0
     c                   eval      w_lvar = *blanks
     c                   eval      w_desi = 0
      *
      * Oppslag mot vareregister
      *
     c                   eval      vvarl1_vare = sdvare
     c     vvarl1_key    chain     vvarl1r
      *
     c                   if        %found(vvarl1)
     c                   eval      w_vare = vvvare
     c                   eval      w_nobb = vvnobb
     c                   eval      w_lvar = vvlvar
     c                   eval      w_desi = vvdesi
     c                   else
     c                   eval      jvarl1_vare = sdvare
     c     jvarl1_key    chain     jvarl1
     c                   if        %found(jvarl1)
     c                   eval      w_vare  = jvvare
     c                   eval      w_nobb  = jvnobb
     c                   eval      w_lvar  = jvlvar
     c                   endif
     c                   endif
6.36  * sjekker om logistikk-vare
6.36 c                   if        %found(vvarl1)
6.36  *
6.36  * Kaller program for henting av prisgruppe
6.36  *
6.36 c                   call      'VL710R'
6.36 c                   parm                    w_firm
6.36 c                   parm                    sdvare
6.36 c                   parm                    sdlage
6.36 c                   parm                    w_lv_vtyp
6.36 c                   parm                    w_lv_udat
6.36 c                   parm                    w_lv_ldor
6.36 c                   parm                    b_inlr
6.36 c                   parm                    w_lv_nobb
6.36 c                   parm                    w_lv_modn
6.36 c                   parm                    w_lv_lldo
6.36 c                   parm                    w_lv_llva
6.36 c                   if        w_lv_nobb <> 0
6.36 c                   eval      w_nobb = w_lv_nobb
6.36 c                   eval      w_lvar = w_lv_llva
6.36 c                   endif
6.36 c                   endif
      *
      * - GTIN nummer
      *
     c                   eval      w_gtin = 0
     c                   call      'VE711R'
     c                   parm                    w_firm
     c                   parm                    w_vare
     c                   parm                    sdenh1
     c                   parm                    w_gtin
     c                   parm                    w_stat
      *
      * - Leverandørs varenr (Hentet fra vvar eller jvar)
      *
     c                   eval      w_tek1 = *blank
     c                   eval      w_tek2 = *blank
      * Vi må oversette aktuelle tekster til "xml" tegn - Tekstlinjer
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek2
      *
     c                   if        %subst(sdtek1:35:1) = ' ' or
     c                             %subst(sdtek2:1:1) = ' '
     c                   eval      w_tek0 = %trim(w_tek1) + ' ' + %trim(w_tek2)
     c                   else
     c                   eval      w_tek0 = %trim(w_tek1) + %trimr(w_tek2)
     c                   endif
      *
      * hvis nettopris skal rabatt trekkes ut
      *
     c                   eval      w_rab1 = sdrab1
     c                   eval      w_rab2 = sdrab2
     c                   eval      w_nsap = sdsapr
      *
      * Beregne snittrabatt
      *
     c                   if        soneto = 1
     c                   eval      w1rab1 = 100 - sdrab1
     c                   eval      w1rab1 = w1rab1 * sdrab2
     c                   eval      w1rab1 = w1rab1 / 100
     c                   eval      w1rab1 = w1rab1 + sdrab1
     c                   eval      w_nsap = w_nsap -
     c                                     (w_nsap * w1rab1 / 100)
     c                   eval      w_rab1 = 0
     c                   eval      w_rab2 = 0
     c                   endif
      *
      * Sjekk om tilbud/netto-pris
      *
     c                   eval      w_tine = *blank
     c                   if        sdrab1 = *zero
     c                   eval      vpkol1_pkod = sdkpri
     c     vpkol1_key    chain     vpkol1r                            69
     c                   if        *in69 = *off
     c                   eval      w_tine = vaptxt
     c                   endif
     c                   endif
      *
      * Netto beløp
      *
     c                   eval      w_nbel = sdsalg
     c                   eval      w_nbel = w_nbel - sdrkr1
     c                   eval      w_nbel = w_nbel - sdrkr2
6.2m  * Hvis rabatt ikke skal vises, regner vi om igjen prisen med flere desimaler.
6.2m c                   if        soneto = 1
6.33 c                   if        sdanta <> 0
6.2m c                   eval(h)   w_nprd = w_nbel / sdanta
6.33 c                   else
6.33 c                   eval(h)   w_nprd = w_nbel / 1
6.33 c                   endif
6.2m c                   endif
6.2m  *
      *
      * Bruttobeløp
      *
     c                   eval      w_bbel = sdsalg
      * Leveringsdato linje
     c                   eval      w_ldal = 0
     c                   if        sdldat <> *loval
     c     *dmy          move      sdldat        w_ldal
     c                   endif
      * Lager
     c                   eval      w_ltxt = *blanks
     c                   if        sdlage <> 0
     c                   eval      ra10l1_jkod = sdlage
     c     ra10l1_key    chain     ra10l1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     rajtxt        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ltxt
     c                   endif
      *
      * Kaller program i økonomisystemet / MVA-oppslag
      *
6.32 c                   if        somkod = 1  or
6.32 c                             somkod = 2
     c                   eval      p_ekod = '4'
6.34 c                   elseif    sdomva <> *blanks
6.34 c                   eval      p_ekod = sdomva
6.34 c                   else
     c                   select
     c                   when      sdkmva = 1
     c                   eval      p_ekod = '4'
     c                   when      sdkmva = 2
     c                   eval      p_ekod = 'H'
     c                   other
     c                   eval      p_ekod = '3'
     c                   endsl
     c                   endif
      *
     c                   eval      p_dato = sofkda
      *
     c                   call      'RS755R'
     c                   parm                    p_stat
     c                   parm                    p_ekod
     c                   parm                    p_etxt
     c                   parm                    p_dato
     c                   parm                    p_mvap
     c                   parm                    p_mvat
     c                   parm                    p_mvaf
      *
      * MVA koden legges i tabell
      *
     c                   if        p_ekod <> *blanks
     c                   exsr      xarray
     c                   endif
      *
      * Håndtere riktig antall desimaler
      *
     c                   if        vvdesi = 0
     c                   eval      w_ant0 = sdanta
     c                   callp     updHTMLVar('Antalldesimaler':          '0')
     c                   callp     updHTMLVar('Antall':         %char(w_ant0))
     c                   elseif    vvdesi = 1
     c                   eval      w_ant1 = sdanta
     c                   callp     updHTMLVar('Antalldesimaler':          '1')
     c                   callp     updHTMLVar('Antall':         %char(w_ant1))
     c                   elseif    vvdesi = 2
     c                   eval      w_ant2 = sdanta
     c                   callp     updHTMLVar('Antalldesimaler':          '2')
     c                   callp     updHTMLVar('Antall':         %char(w_ant2))
     c                   elseif    vvdesi = 3
     c                   eval      w_ant3 = sdanta
     c                   callp     updHTMLVar('Antalldesimaler':          '3')
     c                   callp     updHTMLVar('Antall':         %char(w_ant3))
     c                   endif
6.2m  * "Riktig" nettopris
6.2m c                   if        soneto = 1
6.2m c                   callp     updHTMLVar('Priseksmva':     %char(w_nprd))
6.2m c                   else
6.2m c                   callp     updHTMLVar('Priseksmva':     %char(w_nsap))
6.2m c                   endif
      *
      /Free
               UpdHTMLVar('Linjenummer':           %char(sdline));
               UpdHTMLVar('Varetekst1':            %trim(w_tek1));
               UpdHTMLVar('Varetekst2':            %trim(w_tek2));
               UpdHTMLVar('Varenummer':            %trim(w_vare));
               UpdHTMLVar('GTINnummer':            %char(w_gtin));
               UpdHTMLVar('Nobbnummer':            %char(w_nobb));
               UpdHTMLVar('Alternativtvarenummer': %trim(w_lvar));
               UpdHTMLVar('Bestillingsref':        %trim(sdkbnr));
         //    UpdHTMLVar('Antalldesimaler':       %char(w_desi));
         //    UpdHTMLVar('Antall':                %char(sdanta));
               UpdHTMLVar('Enhet':                        sdenh1);
               UpdHTMLVar('Linjetype':             %char(sdlety));
               UpdHTMLVar('Mvaprosent':            %char(p_mvap));
6.2m    //     UpdHTMLVar('Priseksmva':            %char(w_nsap));
               UpdHTMLVar('Bruttopriseksmva':      %char(sdsapr));
               UpdHTMLVar('Rabatt1':               %char(w_rab1));
               UpdHTMLVar('Rabatt2':               %char(w_rab2));
               UpdHTMLVar('Priskode':              %trim(w_tine));
               UpdHTMLVar('Nettobelop':            %char(w_nbel));
               UpdHTMLVar('Totalsum':              %char(w_nbel));
               UpdHTMLVar('Bruttobelop':           %char(w_bbel));
               UpdHTMLVar('Lager':                 %trim(w_ltxt));
          //  Leveringsdato linje
               test(de) *dmy w_ldal;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_ldal : *dmy);
               endif;
               UpdHTMLVar('Levdatolinje':  %char(tmpdate : *iso));
               UpdHTMLVar('Kampanje':                        ' ');
               WrtSection('Ordrelinje');

      /End-free
      *
      * Akkumulatorer
     c                   eval      w_tnet = w_tnet + w_nbel
     c                   eval      w_tbrt = w_tbrt + w_bbel
      *
      * Er det gitt alm.rabatt ??
      *
     c                   if        sdbrr1 <> 0 or
     c                             sdbrr2 <> 0
      *
     c                   if        sdbrr1 > 99,99
     c                   eval      w_brr1 = 99,99
     c                   else
     c                   eval      w_brr1 = sdbrr1
     c                   endif
      *
     c                   if        sdbrr2 > 99,99
     c                   eval      w_brr2 = 99,99
     c                   else
     c                   eval      w_brr2 = sdbrr2
     c                   endif
      *
      /Free
               UpdHTMLVar('Spesialrabtetekst':     'Bruksrettrabatt');
               UpdHTMLVar('Spesialrabatt1':            %char(w_brr1));
               UpdHTMLVar('Spesialrabatt2':            %Char(w_brr2));
               WrtSection('Spesialrabatt');

      /End-free
      *
     c                   endif
      *
      * Tekstlinje
      *
     c                   else
     c                   eval      w_tek1 = *blank
     c                   eval      w_tek2 = *blank
      * Vi må oversette aktuelle tekster til "xml" tegn - Tekstlinjer
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek2
      *
     c                   if        %subst(sdtek1:35:1) = ' ' or
     c                             %subst(sdtek2:1:1) = ' '
     c                   eval      w_tek0 = %trim(w_tek1) + ' ' + %trim(w_tek2)
     c                   else
     c                   eval      w_tek0 = %trim(w_tek1) + %trimr(w_tek2)
     c                   endif
      *
      /Free
               UpdHTMLVar('Ordrelinjetekst':   %trim(w_tek0));
               UpdHTMLVar('Ordrelinjetekst2':            ' ');
               WrtSection('Ordrelinjetekst');

      /End-free
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for array-håndtering av mva
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xarray        begsr
      *
     c     1             do        9             m
     c                   if        mko(m) = p_ekod or
     c                             mko(m) = ' '
     c                   eval      mko(m) = p_ekod
     c                   eval      msa(m) = p_mvap
     c                   eval      mgr(m) = mgr(m) + w_nbel
     c                   eval      ngr(m) = ngr(m) + w_bbel
      *
     c                   if        sorabp > 0
     c                   if        vvkord = 0
     c                   eval      mog(m) = mog(m) + w_nbel
     c                   eval      w_orab = w_nbel * sorabp / 100
     c                   eval      mor(m) = mor(m) + w_orab
     c                   endif
     c                   endif
      *
     c                   leave
     c                   endif
     c                   enddo
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for les av linjer som ikke skal skrives på tidspkt   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     sub_what      begsr
      *
      * - Tom subrutine for å ha en handle
      *
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML - Topptekst                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     sub_toppt     begsr
      *
6.23 c                   if        1 = 2
      *
     c                   if        b_topp = *off
     c                   exsr      sub_topp_str
     c                   eval      b_topp = *on
     c                   endif
      *
     c                   eval      w_ttxt = *blank
     c                   eval      w_ttx1 = *blank
     c                   eval      w_ttx2 = *blank
      *
     c                   if        %trim(sdtek1) <> *blank
      * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ttx1
     c                   endif
      *
      * Flyttet for å slå sammen begge linjene da de hører sammen
      *
     c                   if        %trim(sdtek2) <> *blank
      * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ttx2
     c                   endif
      * Så slår vi sammen linjene
     c                   eval      w_ttxt = %trim(w_ttx1) + %trim(w_ttx2)
      *
     c                   if        %trim(w_ttxt) <> *blank
      /Free
           // Skriv tekstlinjer 1
               UpdHTMLVar('Topptekst':          w_ttxt);
               WrtSection('Topptekstlinje');
      /End-free
     c                   endif
      *
6.23 c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML - Topptekst start                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     sub_topp_str  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('TopptekstStart');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML - Topptekst slutt                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     sub_topp_end  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('TopptekstSlutt');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for skriv bunntekster
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_bunnt     begsr
      *
6.23 c                   if        1 = 2
      *
     c                   if        b_bunn = *off
     c                   exsr      sub_bunn_str
     c                   eval      b_bunn = *on
     c                   endif
      *
     c                   eval      w_ttxt = *blanks
     c                   eval      w_ttx1 = *blanks
     c                   eval      w_ttx2 = *blanks
      *
     c                   if        %trim(sdtek1) <> *blank
      * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ttx1
     c                   endif
      *
      * Flyttet for å slå sammen begge linjene da de hører sammen
      *
     c                   if        %trim(sdtek2) <> *blank
      * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ttx2
     c                   endif
      * Så slår vi sammen linjene
     c                   eval      w_ttxt = %trim(w_ttx1) + %trim(w_ttx2)
      *
     c                   if        %trim(w_ttxt) <> *blank
      /Free
           // Skriv bunntekst
               UpdHTMLVar('Bunntekst':     %trim(w_ttxt));
               WrtSection('BunntekstLinje');

      /End-free
     c                   endif
      *
6.23 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML - Bunntekst start                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     sub_bunn_str  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('BunntekstStart');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML - Bunntekst slutt                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     sub_bunn_end  begsr
      *
      /Free
           // Skriv tekstlinjer
               WrtSection('BunntekstSlutt');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for gen. av avsluttende fakturadata
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skriv_fslut   begsr
      *
      * Har vi noen avgifter som  skal leses ?
      *
     c                   exsr      sub_avgifter
      *
      * Skal det legges ut depositum ?
      *
     c                   exsr      sub_depos
      *
      * Spesialrabatter (alm.rabatt)
      *
     c                   exsr      sub_spsrab
      *
      * Nettolinje
      *
     c                   exsr      sub_netto
      *
      * MVA linjer
      *
     c                   exsr      sub_MVAlin
      *
      * Fakturatotaler
      *
     c                   exsr      sub_total
      *
     c                   eval      w_antf = w_antf + 1
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for gen. av avsluttende fakturadata
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_avgifter  begsr
      *
     c                   eval      sodtl1_aarr = s_aarr
     c                   eval      sodtl1_binr = s_binr
     c                   eval      sodtl1_numm = s_numm
     c                   eval      sodtl1_suff = s_suff
      *
     c     sodtl1_key    setll     sodtl1
     c     sodtl1_key    reade     sodtl1
      *
     c                   dow       not %eof(sodtl1)
      * Kun avgifter skal behandles - legges ut som
     c     sdktxt        caseq     9             sub_avgl
     c                   cas                     sub_what
     c                   endcs
      *
     c     sodtl1_key    reade     sodtl1
      *
     c                   enddo
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av avgiftlinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_avgl      begsr
      * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
      * med detaljer.
     c                   if        b_bunn = *on
     c                   exsr      sub_bunn_end
     c                   eval      b_bunn = *off
     c                   endif
      *
      * Oppslag mot vareregister
      *
     c                   eval      vvarl1_vare = sdvare
     c     vvarl1_key    chain     vvarl1r
      *
     c                   if        %found(vvarl1)
     c                   eval      w_vare = vvvare
     c                   endif
      *
     c                   eval      w_tek1 = *blank
     c                   eval      w_tek2 = *blank
      * Vi må oversette aktuelle tekster til "xml" tegn - Tekstlinjer
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     sdtek1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_tek1
      *
      * Netto beløp
      *
     c                   eval      w_nbel = sdsalg
     c                   eval      w_nbel = w_nbel - sdrkr1
     c                   eval      w_nbel = w_nbel - sdrkr2
      *
      * Bruttobeløp
      *
     c                   eval      w_bbel = sdsalg
6.21  *
6.21  * Kaller program i økonomisystemet / MVA-oppslag
6.21  *
6.21 c                   if        somkod = 1 or
6.34 c                             somkod = 2
6.21 c                   eval      p_ekod = '4'
6.34 c                   elseif    sdomva <> *blanks
6.34 c                   eval      p_ekod = sdomva
6.34 c                   else
6.21 c                   select
6.21 c                   when      sdkmva = 1
6.21 c                   eval      p_ekod = '4'
6.21 c                   when      sdkmva = 2
6.21 c                   eval      p_ekod = 'H'
6.21 c                   other
6.21 c                   eval      p_ekod = '3'
6.21 c                   endsl
6.21 c                   endif
6.21  *
6.21 c                   eval      p_dato = sofkda
6.21  *
6.21 c                   call      'RS755R'
6.21 c                   parm                    p_stat
6.21 c                   parm                    p_ekod
6.21 c                   parm                    p_etxt
6.21 c                   parm                    p_dato
6.21 c                   parm                    p_mvap
6.21 c                   parm                    p_mvat
6.21 c                   parm                    p_mvaf
6.21  *
6.21  * MVA koden legges i tabell
6.21  *
6.21 c                   if        p_ekod <> *blanks
6.21 c                   exsr      xarray
6.21 c                   endif
6.21  *
      /Free
               UpdHTMLVar('Avgvarenummer':         %trim(w_vare));
               UpdHTMLVar('Avgtekst':              %trim(w_tek1));
               UpdHTMLVar('Avgantall':             %char(sdanta));
               UpdHTMLVar('Avgbruttobelop':        %char(w_bbel));
6.2J     //    UpdHTMLVar('Avgprosent':                      '0');
6.2J           UpdHTMLVar('Avgprosent':            %char(p_mvap));
               UpdHTMLVar('Avgavgiftsbelop':       %char(w_bbel));
               UpdHTMLVar('Avgnettobelop':         %char(w_nbel));
               WrtSection('Avgifter');

      /End-free
      *
      * Akkumulatorer
     c                   eval      w_tnet = w_tnet + w_nbel
     c                   eval      w_tbrt = w_tbrt + w_bbel
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for utlegg av evnt depositum
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_depos     begsr
      *
      * - Depositum (Fradrag)
      *
     c                   if        sodept <> 0
      *
      /Free
               UpdHTMLVar('Depositumtotal':        %char(sofsum));
               UpdHTMLVar('Depositumbelop':        %char(sodept));
               WrtSection('Depositum');

      /End-free
      *
     c                   endif
      *
     c                   endsr
      *
      *--------------------------------------------------------------
      * Spesialrabatt - (alm.rabatt)                                *
      *--------------------------------------------------------------
      *
     c     sub_spsrab    begsr
      *
     c                   eval      w_rbsu = w_rb1p +
     c                                      w_rb1f +
     c                                      w_rb2p +
     c                                      w_rb2f
      *
      * - Spesialrabatter (alm.rabatt)
      *
     c                   if        w_gr1p <> 0
      *
      /Free
               UpdHTMLVar('Spesrabtekst':    'Bruksrettsrabatt 1');
               UpdHTMLVar('Spesrabgrunnlag':        %char(w_gr1p));
               UpdHTMLVar('Spesrabbelop':           %char(w_rb1p));
               WrtSection('Spesialrabatt');

      /End-free
      *
     c                   endif
      *
     c                   if        w_gr2p <> 0
      *
      /Free
               UpdHTMLVar('Spesrabtekst':    'Bruksrettsrabatt 2');
               UpdHTMLVar('Spesrabgrunnlag':        %char(w_gr2p));
               UpdHTMLVar('Spesrabbelop':           %char(w_rb2p));
               WrtSection('Spesialrabatt');

      /End-free
      *
     c                   endif
      *
     c                   if        w_gr1f <> 0
      *
      /Free
               UpdHTMLVar('Spesrabtekst':    'Bruksrettsrabatt 1');
               UpdHTMLVar('Spesrabgrunnlag':        %char(w_gr1f));
               UpdHTMLVar('Spesrabbelop':           %char(w_rb1f));
               WrtSection('Spesialrabatt');

      /End-free
      *
     c                   endif
      *
     c                   if        w_gr2f <> 0
      *
      /Free
               UpdHTMLVar('Spesrabtekst':    'Bruksrettsrabatt 1');
               UpdHTMLVar('Spesrabgrunnlag':        %char(w_gr2f));
               UpdHTMLVar('Spesrabbelop':           %char(w_rb2f));
               WrtSection('Spesialrabatt');

      /End-free
      *
     c                   endif
      *
     c                   endsr
      *
      *--------------------------------------------------------------
      * Subrutine for generering av nettolinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_netto     begsr
      * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
      * med nettodetaljer
     c                   if        b_bunn = *on
     c                   exsr      sub_bunn_end
     c                   eval      b_bunn = *off
     c                   endif
      *
     c                   eval      w_tnet = w_tnet - w_rbsu
      *
      /Free
               UpdHTMLVar('Sumnettoeksmva':        %char(w_tnet));
               UpdHTMLVar('Sumnettoeksmvaeksrab':  %char(w_tbrt));
               WrtSection('Nettolinje');

      /End-free
      *
     c                   endsr
      *
      *--------------------------------------------------------------
      * Subrutine for generering av mva linjer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_MVAlin    begsr
      *
      * Beregner mva for de forskjellige satser
      *
     c                   eval      mbe = (mgr - mor) * msa / 100
6.2k c**                 xfoot     mbe           t1tmva
6.2k c                   xfoot     mbe           w_mber
6.2k c                   eval(h)   t1tmva = w_mber
     c                   eval      nbe =  ngr        * msa / 100
6.2k c**                 xfoot     nbe           t5tmva
6.2k c                   xfoot     nbe           w_mber
6.2k c                   eval(h)   t5tmva = w_mber
      *
     c     1             do        9             m
     c                   if        mko(m) <> ' '
     c                   eval      t1mvas = msa(m)
     c                   eval      t1mvag = mgr(m) - mor(m)
6.2k c                   eval(h)   t1mvab = mbe(m)
     c                   eval      t5mvas = msa(m)
     c                   eval      t5mvag = ngr(m)
6.2k c                   eval(h)   t5mvab = nbe(m)
      *
      /Free
               UpdHTMLVar('Mvaprosent':            %char(t1mvas));
               UpdHTMLVar('Mvagrunnlag':           %char(t1mvag));
               UpdHTMLVar('Summva':                %char(t1mvab));
               UpdHTMLVar('Mvaprosenteksrabatt':   %char(t5mvas));
               UpdHTMLVar('Mvagrunnlageksrabatt':  %char(t5mvag));
               UpdHTMLVar('Summvaeksrabatt':       %char(t5mvab));
               WrtSection('MVALinje');

      /End-free
      *
     c                   endif
      *
     c                   enddo
      *
      * Null-stilling av array's
      *
     c                   eval      mko = *blank
     c                   eval      msa = *zero
     c                   eval      mgr = *zero
     c                   eval      mbe = *zero
     c                   eval      mog = *zero
     c                   eval      mor = *zero
     c                   eval      ngr = *zero
     c                   eval      nbe = *zero
      *
     c                   endsr
      *--------------------------------------------------------------
      * Subrutine for generering av totallinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_total     begsr
      *
      * Henter inn siste post fra fakturahode
      *
     c                   eval      sohelr_binr = s_binr
     c                   eval      sohelr_numm = 999999
     c                   eval      sohelr_suff = 99
     c     sohelr_key2   setll     sohelrr
     c                   readp     sohelrr                                63
      *
      * Legg ut eksakt fakturabeløp
      *
     c                   eval      t1fsum = xxfsum
      *
      * Beregne modulus 10
      * på beløpsfeltet
      *
     c                   move      *blank        kidd10
     c                   move      t1fsum        kidd10
     c                   exsr      mod10
     c                   move      ksif10        t1bsif
      *
      * Sjekke om det er depositum
      *
     c                   if        xxdept <> 0
     c                   eval      t1fsum = t1fsum - xxdept
     c                   endif
     c                   eval      w_avrd=0
     c                   eval      w_avrd=t1fsum-t1tmva-w_tnet+xxdept
      *
      /Free
               UpdHTMLVar('Sumtotal':              %char(t1fsum));
               UpdHTMLVar('Summvatotal':           %char(t1tmva));
               UpdHTMLVar('Summvagrltotal':        %char(w_tnet));
               UpdHTMLVar('Sumtotaleksrabatt':     %char(w_tbrt));
               UpdHTMLVar('Summvatotaleksrab':     %char(t5tmva));
               UpdHTMLVar('Summvagrltotaleksrab':  %char(w_tbrt));
               UpdHTMLVar('Sjekknummer':                  t1bsif);
               UpdHTMLVar('Avrunding':             %char(w_avrd));
               WrtSection('Totallinje');

      /End-free
      *
     c                   if        p_rapp = '1'
     c                   exsr      skr_rappl
     c                   endif
      *
     c                   exsr      upd_uf_log
      *
     c                   eval      s_binr = *zero
     c                   eval      s_aarr = *zero
     c                   eval      s_numm = *zero
     c                   eval      s_suff = *zero
     c                   eval      s_fbru = *zero
     c                   eval      s_fnet = *zero
     c                   eval      s_fmva = *zero
     c                   eval      s_fmvg = *zero
     c                   eval      s_frab = *zero
     c                   eval      w_tnet = *zero
     c                   eval      w_tbrt = *zero
6.2E c                   eval      t1fsum = *zero
6.2E c                   eval      t1bsif = *zero
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for avslutte ordrelinjetagger
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_olslutt   begsr
      * Sørg for at vi har skrevet siste tag for topptext før vi begynner
      * med detaljer.
     c                   if        b_bunn = *on
     c                   exsr      sub_bunn_end
     c                   eval      b_bunn = *off
     c                   endif
      *
      /Free
           // Skriv Slutt på ordren
               WrtSection('OrdrelinjerSlutt');

      /End-free
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for ordre-rabatt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_orabatt   begsr
      *
6.2i c                   if        b_orab = *off
     c                   if        sorabp <> *zero
     c                   eval      w_rabp = sorabp
     c                   eval      w_rabg = sorbgp + sorbgf
     c                   eval      w_rabg = w_rabg + sorbgh
     c                   eval      w_rabb = sorkop + sorkof
     c                   eval      w_rabb = w_rabb + sorkoh
     c                   eval      w_rabb = w_rabb * -1
     c                   eval      w_tnet = w_tnet + w_rabb
6.2i c                   eval      w_line = 999
6.2i c                   eval      w_tek1 = 'Ordrerabatt'
6.2i c                   eval      w_tek2 = *blanks
6.2i c                   eval      w_vare = '00150000'
6.2i c                   eval      w_gtin = *zeros
6.2i c                   eval      w_nobb = *zeros
6.2i c                   eval      w_lvar = *blanks
6.2i c                   eval      w_tine = *blanks
      *
      /Free
           // Skriv rabattlinjer
6.2i       //  UpdHTMLVar('Rabattprosent':       %char(w_rabp));
6.2i       //  UpdHTMLVar('Rabattgrunnlag':      %char(w_rabg));
6.2i       //  UpdHTMLVar('Rabattbelop':         %char(w_rabb));
6.2i       //  WrtSection('Rabattlinje');
6.2i
6.2i           UpdHTMLVar('Linjenummer':           %char(w_line));
6.2i           UpdHTMLVar('Varetekst1':            %trim(w_tek1));
6.2i           UpdHTMLVar('Varetekst2':            %trim(w_tek2));
6.2i           UpdHTMLVar('Varenummer':            %trim(w_vare));
6.2i           UpdHTMLVar('GTINnummer':            %char(w_gtin));
6.2i           UpdHTMLVar('Nobbnummer':            %char(w_nobb));
6.2i           UpdHTMLVar('Alternativtvarenummer': %trim(w_lvar));
6.2i           UpdHTMLVar('Bestillingsref':                 ' ');
6.2i           UpdHTMLVar('Antalldesimaler':                '2');
6.2i           UpdHTMLVar('Antall':                      '1.00');
6.2i           UpdHTMLVar('Enhet':                        'STK');
6.2i           UpdHTMLVar('Linjetype':                      '0');
               UpdHTMLVar('Mvaprosent':            %char(p_mvap));
6.2i           UpdHTMLVar('Priseksmva':            %char(w_rabb));
6.2i           UpdHTMLVar('Bruttopriseksmva':      %char(w_rabb));
6.2i           UpdHTMLVar('Rabatt1':                     '0.00');
6.2i           UpdHTMLVar('Rabatt2':                     '0.00');
6.2i           UpdHTMLVar('Priskode':              %trim(w_tine));
6.2i           UpdHTMLVar('Nettobelop':            %char(w_rabb));
6.2i           UpdHTMLVar('Totalsum':              %char(w_rabb));
6.2i           UpdHTMLVar('Bruttobelop':           %char(w_rabb));
6.2i           UpdHTMLVar('Lager':                 %trim(w_ltxt));
6.2i      //  Leveringsdato linje
6.2i           test(de) *dmy w_ldal;
6.2i           if %error;
6.2i           tmpdate = *loval;
6.2i           else;
6.2i           tmpdate = %date(w_ldal : *dmy);
6.2i           endif;
6.2i           UpdHTMLVar('Levdatolinje':  %char(tmpdate : *iso));
6.2i           UpdHTMLVar('Kampanje':                        ' ');
6.2i           WrtSection('Ordrelinje');
6.2i  /End-free
6.2i  *
6.2i c                   eval      b_orab = *on
     c                   endif
6.2i c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for avslutte ordren
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_oslutt    begsr
      *
      /Free
           // Skriv Slutt på ordren
               WrtSection('OrdreSlutt');

      /End-free
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for mellomlagring av hodesummer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     save_fsum     begsr
      *
6.2H c**                 eval      s_fsum = sofsum
6.35 c**                 eval      s_fsum = sofsum - sodepb
6.35 c                   eval      s_fsum = sofsum - sodept
     c                   eval      s_salp = sosalp
     c                   eval      s_salh = sosalh
     c                   eval      s_salf = sosalf
     c                   eval      s_rk1p = sork1p
     c                   eval      s_rk2p = sork2p
     c                   eval      s_rkop = sorkop
     c                   eval      s_rk1f = sork1f
     c                   eval      s_rk2f = sork2f
     c                   eval      s_rkof = sorkof
6.2i c                   eval      b_orab = *off
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Modulus 10 beregning av beløpsfelt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     mod10         Begsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *        Start subrutinen for modulus-10 utregning.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c                   z-add     1             xx                2 0
     c                   z-add     2             yy                2 0
     c                   z-add     2             fa10              1 0
     c                   z-add     0             mods10            3 0
     c                   z-add     0             modr10            1 0
     C                   Z-ADD     0             ksif10            1 0
      *
      * På grunn av forskjeller mellom S/36 og AS400
      * må MOVEA gå via et alfa-array før det legges
      * over i et nummerisk array.
      *
     c                   movea     kidd10        a10
     c                   move      a10           m10
      *
     c     utr10         tag
      *
     c     xx            ifgt      12
     c                   z-add     1             xx
     c                   z-add     1             yy
     c                   goto      add10
     c                   else
     c     m10(yy)       mult      fa10          u10(xx)
     c     m10(yy)       ifgt      4
     c                   add       1             mods10
     c                   end
     c                   add       1             xx
     c                   add       2             yy
     c                   goto      utr10
     c                   end
      *
     c     add10         tag
      *
     c     xx            ifgt      12
     c                   goto      sif10
     c                   end
     c                   add       u10(XX)       mods10
     c                   add       m10(YY)       mods10
     c                   add       1             xx
     c                   add       2             yy
      *
     c                   goto      add10
      *
     c     sif10         tag
     c                   move      mods10        modr10
     c     10            sub       modr10        ksif10
      *
     c                   Endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for kontroll av utgående fakturalogg
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjk_uf_log    begsr
      *
     c                   eval      b_logf = *off
     c                   eval      w_binr = fnubin
      *
      * Sjekk omkjøring og kjøredato
      *
     c                   if        p_omkj = *blank
     c                   if        fnukda <> *loval
     c                   leavesr
     c                   endif
     c                   endif
      *
     c                   if        p_omkj = '1'
     c                   if        fnukda = *loval
     c                   leavesr
     c                   endif
     c                   if        p_fnum <= 1 or
     c                             p_tnum = 999999
     c                   leavesr
     c                   endif
     c                   if        fnubin < p_fnum or
     c                             fnubin > p_tnum
     c                   leavesr
     c                   endif
     c                   endif
6.2G  * Sjekk at det er ordrelinjer på fakturaen som skal skrives.
6.2G c                   eval      sohel1_binr = fnubin
6.2G c                   eval      sohel1_aarr = fnuaar
6.2G c                   eval      w_antl = 0
6.2G c     sohel1_key    setll     sodtl1
6.2G c     sohel1_key    reade     sodtl1
6.2G c                   dow       not %eof
6.2G c                   eval      w_antl = w_antl + 1
6.2G c     sohel1_key    reade     sodtl1
6.2G c                   enddo
6.2G  *
6.2G c                   if        w_antl < 1
6.2G c                   leavesr
6.2G c                   endif
6.2G  *
     c                   eval      b_logf = *on
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for oppdat. av utgående fakturalogg
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     upd_uf_log    begsr
      *
     c                   eval      fnuflu_aarr = p_aarr
     c                   eval      fnuflu_binr = s_binr
     c     fnuflu_key    chain     fnuflur
     c                   if        %found
     c                   time                    fnukda
     c                   time                    fnukti
     c                   eval      fnukws = l_wsid
     c                   eval      fnutel = fnutel + 1
     c                   time                    fnueda
     c                   time                    fnueti
     c                   eval      fnueus = l_user
     c                   update    fnuflur
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for manipulering til ledende minustegn
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_minus   begsr
      *
     c                   eval      w_posm = 0
     c                   eval      w_posm = %scan('-':w_numf)
      *
     c                   if        w_posm > 0
     c                   eval      w_numf = %subst(w_numf:1:w_posm - 1)
     c                   eval      w_numf = '-' + %trim(w_numf)
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for sjekk om samlefaktura
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sub_saml      begsr
6.2G  * Må være samme fakturanr som fra FNUF. Blir feil hvis faktura
6.2G  * uten linjer.
6.2G c                   if        sobinr <> fnubin
6.2G c                   leavesr
6.2G c                   endif
      *
     c                   eval      b_saml = *off
6.2A c                   eval      b_pdfv = *off
     c                   eval      w_anto = *zero
     c                   eval      w_kidr = *zero
     c                   eval      w_kidd = *blank
      *
     c                   eval      sohelr_aarr = soaarr
     c                   eval      sohelr_binr = sobinr
      *
     c     sohelr_key    setll     sohelr
     c     sohelr_key    reade     sohelr
      *
     c                   dow       not %eof
      *
     c                   eval      w_anto = w_anto + 1
6.2A c                   if        soutsk = 1
6.2A c                   eval      b_pdfv = *on
6.2A c                   endif
6.2F  * Kun for fakturatype 10
6.2F c                   if        sofaty <> 10
6.2F c                   eval      b_pdfv = *off
6.2F c                   endif
      *
     c                   eval      w_kidd = xxkidd
6.25 c*                  if        d_kidk <> 0
6.25 c*                  if        d_kidk = 1
6.25 c*                  eval      w_kidd = xxkidd
6.25 c*                  else
6.25 c*                  eval      w_kidd = %char(xxkidr)
6.25 c*                  endif
6.25 c*                  else
6.25 c*                  eval      w_kidd = %char(xxkidr)
6.25 c*                  endif
      *
     c     sohelr_key    reade     sohelr
     c                   enddo
      *
     c                   if        w_anto > 1
     c                   eval      b_saml = *on
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for sjekk og evt. summerer bruksrett rabatt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjk_bruksrett begsr
6.2G  * Må være samme fakturanr som fra FNUF. Blir feil hvis faktura
6.2G  * uten linjer.
6.2G c                   if        sobinr <> fnubin
6.2G c                   leavesr
6.2G c                   endif
      *
     c                   eval      w_rb1p = 0
     c                   eval      w_gr1p = 0
     c                   eval      w_rb1f = 0
     c                   eval      w_gr1f = 0
     c                   eval      w_rb2p = 0
     c                   eval      w_gr2p = 0
     c                   eval      w_gr2f = 0
     c                   eval      w_rb2f = 0
     c**                 eval      w_gr1h = 0
     c**                 eval      w_rb1h = 0
     c**                 eval      w_rb2h = 0
     c**                 eval      w_gr2h = 0
      *
     c                   eval      sohelr_aarr = soaarr
     c                   eval      sohelr_binr = sobinr
      *
     c     sohelr_key    setll     sohelr
     c     sohelr_key    reade     sohelr
     c                   dow       not %eof(sohelr)
     c                   eval      w_rb1p = w_rb1p + xxrb1p
     c                   eval      w_gr1p = w_gr1p + xxgr1p
     c                   eval      w_rb1f = w_rb1f + xxrb1f
     c                   eval      w_gr1f = w_gr1f + xxgr1f
     c                   eval      w_rb2p = w_rb2p + xxrb2p
     c                   eval      w_gr2p = w_gr2p + xxgr2p
     c                   eval      w_rb2f = w_rb2f + xxrb2f
     c                   eval      w_gr2f = w_gr2f + xxgr2f
     c**                 eval      w_gr1h = w_gr1h + xxgr1h
     c**                 eval      w_rb1h = w_rb1h + xxrb1h
     c**                 eval      w_rb2h = w_rb2h + xxrb2h
     c**                 eval      w_gr2h = w_gr2h + xxgr2h
     c     sohelr_key    reade     sohelr
     c                   enddo
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for skriving av rapportheader v/ utskrift valgt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skr_rapph     begsr
      *
     c                   eval      a1firm = l_firm
     c                   eval      a1fnav = l_fnav
     c                   eval      a1wsid = l_wsid
     c                   time                    a1time
     c     *dmy          move      w_udat        a1date
     c                   eval      a1user = l_user
      *
     c                   eval      a1ftyp = fmtbes
      *
     c                   if        p_omkj = '1'
     c                   eval      a1omkj = 'Omkjøring'
     c                   else
     c                   eval      a1omkj = *blank
     c                   endif
      *
     c                   write     a1hdr                                30
      *
     c                   eval      b_uskr = *on
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for skriving av rapportlinje v/ utskrift valgt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skr_rappl     begsr
      *
     c                   eval      a1fsum = s_fsum
6.2C c                   eval      w_totf = w_totf + s_fsum
      *
     c                   write     a1det                                30
      *
      * Er det overflow ?
      *
     c                   select
     c                   when      *in30 = *on
     c                   exsr      xovrfl
     c                   endsl
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for overflow                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xovrfl        begsr
      *
     c                   write     a1hdr                                30
      *
     c                   endsr
      *
6.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2B  * Finner spool som er generert av jobben
6.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2B c     spoolnbr      begsr
6.2B  /Free
6.2B
6.2B           QSPRILSP( SPRL0100
6.2B                   : %size(SPRL0100)
6.2B                   : 'SPRL0100'
6.2B                   : errorcode );
6.2B  /End-free
6.2B c*
6.2B  *
6.2B c                   endsr
6.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2B  * Kaller eget program for generering av xml fil. Eget pgm         *
6.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2B c     xml_create    begsr
6.2B  *
6.2B c                   eval      p_btyp = 'FAKTURALOGG'
6.2B c                   eval      p_dspl = *blanks
6.2B c                   eval      p_refn = 'FAKTURALOGG ' + %char(a1date)
6.2B c                   eval      p_tagg0 = *blanks
6.2B c                   eval      p_tagg0val = *blanks
6.2B c                   eval      p_tagg1 = *blanks
6.2B c                   eval      p_tagg1val = *blanks
6.2B c                   eval      p_tagg2 = *blanks
6.2B c                   eval      p_tagg2val = *blanks
6.2B c                   eval      p_tagg3 = *blanks
6.2B c                   eval      p_tagg3val = *blanks
6.2B c                   eval      p_tagg4 = *blanks
6.2B c                   eval      p_tagg4val = *blanks
6.2B  *
6.2B c                   call      'AX627R'
6.2B c                   parm                    splfname
6.2B c                   parm                    jobname
6.2B c                   parm                    username
6.2B c                   parm                    jobnbr
6.2B c                   parm                    splfnbr
6.2B c                   parm                    p_tagg0
6.2B c                   parm                    p_tagg0val
6.2B c                   parm                    p_tagg1
6.2B c                   parm                    p_tagg1val
6.2B c                   parm                    p_tagg2
6.2B c                   parm                    p_tagg2val
6.2B c                   parm                    p_tagg3
6.2B c                   parm                    p_tagg3val
6.2B c                   parm                    p_tagg4
6.2B c                   parm                    p_tagg4val
6.2B c                   parm                    w_jkey
6.2B c                   parm                    p_btyp
6.2B c                   parm                    p_refn
6.2B c                   parm                    p_dspl
6.2B  *
6.2B c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    p_aarr
     c                   parm                    p_faty
     c                   parm                    p_fnum
     c                   parm                    p_tnum
     c                   parm                    p_omkj
     c                   parm                    p_rapp
     c                   parm                    p_anta
     c                   parm                    p_feil
      *
     c                   eval      p_anta = *zero
     c                   eval      p_feil = *blank
      *
     c                   eval      w_antf = *zero
     c                   eval      w_antl = *zero
      *
     c                   eval      w_firm = l_firm
      *
      * Key for les av kunde
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Key for oppslag på faktura-hode-register
      *
     c     sohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sohel1_aarr
     c                   kfld                    sohel1_binr
      *
      * Key for oppslag på faktura-hode-register (les ant. ordre)
      *
     c     sohelr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sohelr_aarr
     c                   kfld                    sohelr_binr
      *
      * Key for oppslag på faktura-hode-register (les ant. ordre)
      *
     c     sohelr_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    sohelr_aarr
     c                   kfld                    sohelr_binr
     c                   kfld                    sohelr_numm
     c                   kfld                    sohelr_suff
      *
      * Key for les av fakturalinjer
      *
     c     sodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sodtl1_aarr
     c                   kfld                    sodtl1_binr
     c                   kfld                    sodtl1_numm
     c                   kfld                    sodtl1_suff
      *
      * Key for firma
      *
     c     afir_key      klist
     c                   kfld                    w_firm
      *
      * Key for linjetyper
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for ordretyper
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for oppslag på ofak-koderegister (statuskoder)
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for les på lager
      *
     c     ra10l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra10l1_jkod
      *
      * Key for kode
      *
     c     ra18l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra18l1_rkod
      *
      * Key for transportmåte
      *
     c     ra17l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra17l1_qkod
      *
      * Key for kjørerute
      *
     c     ra25l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra25l1_yrut
      *
      * Key for statuskode 8
      *
     c     raa8l1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag på vareregister
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for oppslag på EAN-nummer
      *
     c     veanl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    veanl2_vare
      *
      * Key for les av fakturatype
      *
     c     fmftl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fmftl1_faty
      *
      * Key for oppslag av fakturalogg
      *
     c     fnufl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fnufl1_aarr
     c                   kfld                    fnufl1_binr
      *
      * Key for oppslag av fakturalogg (type/dato)
      *
     c     fnufl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fnufl2_ufat
     c                   kfld                    fnufl2_ukda
      *
      * Key for oppdat. av fakturalogg
      *
     c     fnuflu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fnuflu_aarr
     c                   kfld                    fnuflu_binr
      *
      * Key for oppslag på avdeling
      *
     c     ra07l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra07l1_gkod
      *
      * Key for oppslag på distrikt
      *
     c     ra08l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra08l1_hkod
      *
      * Key for oppslag på selger
      *
     c     ra09l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra09l1_ikod
      *
      * Key for oppslag på vare (VA)
      *
     c     jvarl1_key    klist
     c                   kfld                    jvarl1_vare
      *
      * Key for priskode-register
      *
     c     vpkol1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vpkol1_pkod
      *
      * Key for oppslag på kundeprosjekt
      *
     c     fkprl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fkprl1_kund
     c                   kfld                    fkprl1_kpro
      *
     c                   time                    w_udat
      *
      * XML generering av dokumenter
      *
     c                   eval      w_pdf = 0
     c                   eval      w_pdf_ds = *blanks
     c                   eval      w_ruti = l_ruti
      *
     c                   call      'AP609R'
     c                   parm                    w_ruti
     c                   parm                    w_pdf
     c                   parm                    w_pdf_ds
     c                   eval      d_pdf_ds = w_pdf_ds
      * Vi skal kjøre med jasper
6.21 c                   eval      d_xmlm='/HOME/ASP/PRINT/630/MALER/FAKTURA_SG-
6.26 c                             .XML'
6.26 c**                 if        w_pdf = 1 and
6.26 c**                           %trim(d_xmlm) <> *blanks
      *
     c                   eval      w_kode = '0'
     c                   eval      w_firm = l_firm
     c                   eval      w_fell = 'NXTKLI'
     c                   eval      w_type = *blank
     c                   eval      w_fast = *blank
     c                   eval      w_numm = *zero
      *
     c                   call      'AS100R'
     c                   parm                    w_kode
     c                   parm                    w_firm
     c                   parm                    w_fell
     c                   parm                    w_type
     c                   parm                    w_fast
     c                   parm                    w_numm
      *
     c                   eval      w_jnav = 'PDF' + %char(w_numm)
     c                   eval      w_jtxt = 'Genererer XML til SG finans  '
     c                   call      'AB700R'
     c                   parm                    w_jnav
     c                   parm                    w_jkey
     c                   parm                    w_jtxt
      *
      * Hent inn xml templaten
      *
     c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
6.2L c                   callp     ClrHtmlBuffer
      *
      * Finn hvor xml'en skal legges
      *
     c                   eval      XML_path = *blanks
     c                   eval      XML_path = %trim(d_path)
      *
      * Jobbnummer er allerede generert i AP600R. Overføres i *lda
      *
      * Vi logger at utskriftprogrammet har startet
     c                   eval      w_jstat = 10
     c                   eval      w_jtxt = 'Utlegg av faktura til SG Finans +
     c                                      har startet'
     c                   call      'AB705R'
     c                   parm                    w_jkey
     c                   parm                    w_jstat
     c                   parm                    w_jtxt
      * Vi skriver xml for miljø formater
     c                   eval      b_pdfp = *on
      *
6.26 c**                 endif
      * Hvis et eller annet er galt med parametrene, logges og kjør uten PROA
     c                   if        %trim(d_xmlm) = *blanks
     c                   eval      b_pdfp = *off
      * Vi logger at noe er galt med parametrene
     c                   eval      w_jstat = 20
     c                   eval      w_jtxt = 'Finner ikke path til xml  !!! +
     c                             Sjekk rutineregister !'
     c                   call      'AB705R'
     c                   parm                    w_jkey
     c                   parm                    w_jstat
     c                   parm                    w_jtxt
     c                   endif
      *
     c                   time                    timestmp
6.24 c                   eval      b_fist = *on
6.2B c                   open      fo195p
6.2C c                   eval      w_totf = 0
      *
     c                   endsr
      *
