# RPG Program SF560R – Detailed Explanation

This program is written in IBM ILE RPG, and is used in the "ASSTAT" system to register sales statistics from orders, based on various parameters. It's designed for interactive use, probably with a display file (workstn). Below is a breakdown and explanation of the key sections and logic.

---

## 1. Program Header and Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
* System  . . . . : ASSTAT
* Program . . . . : SF560R
* Beskrivelse . . : Salgsstatistikk, registrering fra ordre - param.
...
```
- `h option(*nodebugio)`: Disables debug I/O for performance, typical in production.
- `datedit(*dmy)`: Date format is Day/Month/Year for all *dmy data.

---

## 2. File Declarations

```rpg
fsstapf    if   e           k disk
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
fsf160d    cf   e             workstn
```
- `sstapf`, `rkunl1`, `fkprl1`: Physical or logical files accessed by the program (K = keyed access, E = externally described).
- `rename`: Renames the record format for clearer references.
- `sf160d`: Workstation file for user interaction (the display file).

---

## 3. Data Definitions

### Parameters (from *ENTRY, i.e., called program)

```rpg
d p_kode          s              1
d p_firm          s                   like(sffirm)
d p_vkun          s                   like(sfvkun)
d p_kpro          s                   like(sfkpro)
...
```
- `p_kode`, `p_firm`, `p_vkun`, etc.: Variables that receive values from the calling program (parameters).

### Variables for Lookup Keys

```rpg
d rkunl1_kund     s                   like(rkkund)
d fkprl1_kund     s                   like(flkund)
d fkprl1_kpro     s                   like(flkpro)
```
- Used to hold values for key fields when chaining (doing a keyed read) in customer and customer-project files.

### Other Working Variables

```rpg
d b_feil          s              1    inz(*off)
d w_dato          s               d   datfmt(*iso)
d w_dato_alf      s             10
d w_firm          s                   like(sffirm)
```
- `b_feil`: Error flag.
- `w_dato`: Work field for dates.
- `w_dato_alf`: Alpha version of date, likely for display.
- `w_firm`: Working variable for firm/company number.

---

## 4. Main Program Logic

### a. Initializing the Screen ("B1 Behandle åpningsbildet")

```rpg
c                   time                    w_dato
c                   move      w_dato        w_dato_alf
c                   movel     w_dato_alf    b1paar
```
- Gets the current system time into `w_dato`.
- Converts the date to an alphanumeric format for display (`w_dato_alf`) and into display/input field (`b1paar`).

#### Main Processing Loop

```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- `exfmt b1bld`: Shows and receives input from the "b1bld" format (screen).

#### Function Key Handling

```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inkd
c                   exsr      spørring
c                   goto      b1taga
c                   endsl
```
- If function key C or L pressed -> exit.
- If function key D pressed -> run inquiry subroutine (`spørring`) and redisplay.

#### Validate Input Fields

```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   eval      b_feil = *off
c                   goto      b1taga
c                   endif
```
- Subroutine validates all input fields. If errors, reset error flag and redisplay screen.

#### Call Inquiry Program

```rpg
c                   call      'SF161R'
c                   parm                    p_kode
...
c                   parm                    p_kost
```
- Calls another program `SF161R` with all the relevant parameters (code, firm, customer, project, date, etc).

#### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Proper program exit (setting *INLR resets resources).

---

## 5. Subroutines

### a. Inquiry Subroutine (`spørring`)
Handles pop-up lookups for customer or customer-project fields.

```rpg
c     spørring      begsr
c                   if        wactfe = 'B1VKUN'
c                   call      'RK500R'
c                   parm                    w_firm
c                   parm                    b1vkun
c                   parm                    b1knav
c                   leavesr
c                   endif
...
c                   endsr
```
- If the field in focus is `B1VKUN` (customer), calls customer lookup program `RK500R`.
- If the field is `B1KPRO` (customer project), calls `FL500R`.
- Results are returned in navigation/display variables.

### b. Input Validation Subroutine (`sjekk_input`)
Validates all user inputs, typical per Norwegian/Scandinavian naming conventions.

```rpg
c     sjekk_input   begsr
c                   eval      b_feil = *off
c                   eval      b1knav = *blank
c                   eval      b1pnav = *blank
```
- Initializes: clears error and navigation fields.
- Checks for valid year and date inputs, validates their formats, and marks error indicators (such as `*in31`, `*in32`, etc.) for the screen.
- Checks if customer is present (if not, tries to default from input parameters).
- Performs record lookups (`chain`) in customer and project files; if not found, sets error flags.

---

### c. Initialization Subroutine (`*inzsr`)
Handles parameter reception and initializes keys and variables.

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_kode
...
c                   parm                    p_kost
```
- Parameter list matches that of the main call.
- Keylists set up for later use (chaining on the customer and project files).
- Initializes display fields and customer/project name fields if found.

---

## 6. Key Takeaways

- **User Flow:** Program displays a screen, accepts user input, validates it, allows for lookups (customer, project), and calls another program for further processing.
- **Data Integrity:** Validates all inputs via subroutines before processing, shows errors via indicator lights on the screen.
- **Reusability:** Uses subroutines for input validation and inquiry handling.
- **File Handling:** Uses keyed access for efficient record lookups.
- **Parameterization:** Relies on parameters for firm, customer, project, etc., meaning it's meant to be called from another program or as a part of a process.

---

## 7. File and Variable Naming

- File and field names (RKNAVN, FLNAVN, B1VKUN, etc.) are abbreviations based on the business's data dictionary; you may want to reference the DDS or database schema for full context.

---

## 8. Error Handling and User Feedback

- Error flags (`b_feil`, indicator variables like `*in31`, `*in32`, etc.) are used to control user feedback and screen highlighting (display file DDS will use these for error messages).

---

## Summary

This program is a robust interactive front end for sales statistics registration, providing input validation, inquiry support, and clean parameter handling. It is well-structured for maintainability, with logical separation between screen handling, input checking, and data lookups. 

**If you are onboarding:**  
- Familiarize yourself with the database files (`sstapf`, `rkunl1`, `fkprl1`) and their key fields.
- Study the display file (SF160D) for field-to-variable mappings.
- Review the external programs `SF161R`, `RK500R`, and `FL500R` for additional business logic.
- Understand the context and expected values for the main parameters.  

This positions you to modify, troubleshoot, or extend the program as needed.