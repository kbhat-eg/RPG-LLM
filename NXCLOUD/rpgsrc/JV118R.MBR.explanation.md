# RPG Program JV118R – Code Explanation

This RPG program, named `JV118R`, is designed for IBM i (AS/400) systems using ILE RPG/400 and is centered around displaying and managing supplier information for products (“Vare - leverandør, spørring” translates to “Item - Supplier, Inquiry”). The code makes heavy use of subfiles for interactive display and update purposes.

## High-Level Structure

- **File Declarations**: Logical and physical files are declared for item, supplier, and item-supplier relationships.
- **Display File**: A workstation file with several subfile records and control records is used to present and manage data.
- **Data Structures**: For local data, display feedback, and file keys.
- **Main Logic**: Utilizes subroutines (subrs) for handling display, subfile loading, paging, and user input.
- **Indicators**: Standard RPG indicators are used for function key management, display control, and internal logic.
- **Comments** (in Norwegian): Explain purpose and use of structures and indicators.

---

## Detailed Components

### 1. **Header & File Declarations**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debug I/O and sets date editing to day-month-year.

**File Declarations (`F-specs`)**:

- `jvarl1`, `jlevl1`, `jvlel1`: Logical/physical database files for items, suppliers, and item-supplier relationships, respectively. The `rename` keyword changes the record format names for clarity.
- `JV118d`: Workstation display file using multiple subfile (SFILE) screens and information data structure.

### 2. **Data Declarations (`D-specs`)**

- **Local Data Area Variables** (`l_user`, `l_firm`, etc.): Used for retrieving job-level user/session info.
- **Display Feedback Data Structure** (`dspfbk`): To fetch the current cursor position etc. from the display file.
- **Key Variables**: For building keys to chain/setll/read database records.
- **Working Variables**: Subfile counters, page numbers, selection fields, indicators, etc.
- **Constants**: Subfile page size, etc.

### 3. **Indicator Usage**

Documented in comments:
- `LR`: Last record indicator - end the program.
- `10-15, 21-22, 30, 31-99`: Function keys and work indicators.

### 4. **Subroutine Breakdown**

#### a. **Main Loop**

Handles the display and user interaction:

- Writes a command screen (`b2cmd`).
- Calls a subroutine (`dsp_subfile`) to display subfile contents.
- Uses a `SELECT` block to process function key indicators:
    - `*inkc` or `*inkl`: Exit program.
    - `*inke`: Refresh subfile.
    - `*in10`: Next page.
    - `*in11`: Previous page.
    - `*in21`: Home key—sets indicator for cursor placement.

Also, handles subfile positioning if user navigates to a certain item.

#### b. **Subfile Management**

- `forny`: Refreshes (renews) the subfile, possibly after an update.
- `posisjoner`: Positions the subfile to a particular key.
- `subfile`: Processes subfile line selection:
    - Reads each subfile line.
    - On selection codes (e.g., 5=Display, 7=Contact persons), launches the appropriate screens/calls.
    - Handles update and refresh logic.

#### c. **Display/Inquiry Handling**

- `xc2bld`: Handles the in-depth display of a record for view/change; shows the C2BLD screen and handles navigation and exit.

#### d. **Subfile Utility Routines**

- `clr_subfile`: Clears subfile records, resets counters.
- `crt_subfile`: Populates the subfile with records based on keys and page size.
- `bck_subfile`: Handles back-paging the subfile.
- `dsp_subfile`: Displays the subfile and reads/display field states and position.

#### e. **Initialization (`*inzsr`)**

- Sets up parameter lists, keys for file access.
- Reads values from Local Data Area (LDA).
- Initializes display structures and populates the first page of the subfile.

---

## **Main Workflow**

1. **Program Start / Initialization**

    - Parameters passed in, fields and keys set.
    - Subfile loaded with first page of data.
    - Display screen presented to user.

2. **User Interaction Loop**

    - User navigates through records using function keys (Page Up/Down, Home, etc.).
    - Can request to display more details or show related contact persons.
    - Subfile is refreshed/paged as needed, based on actions (forward, back, or change).
    - All data access uses keyed logic for efficient retrieval and positioning.

3. **Program End**

    - On user exit, sets LR (`*inlr`) to end the program and returns.

---

## **Notes on Special Routines & Fields**

- Subfile fields like `w_fcrn`, `w_spge`, and `w_srrn` are used to manage relative and absolute record numbers and paging within the subfile, enabling efficient navigation.
- The code structure allows for easy expansion to add more functionality (other selection codes, more detail screens).
- The use of direct database reads (`readc`, `readp`, `chain`, `setll`) with keys and indicators allows RPG to present a responsive, interactive screen even on green-screen terminals.

---

## **Customizations / Extensibility Points**

- The program is heavily commented and versioned: lines like `6.32` or `7.xx` indicate updates/new features and are referenced throughout, making future maintenance easier.
- Subfile logic is separated from display logic, permitting adaptation to new GUIs (as noted for version 7.xx).

---

## **Conclusion**

This program is a classic example of interactive RPG subfile processing in IBM i, structured for both usability and maintainability, and is well-documented for future developers to onboard quickly. Its modular construction, thorough use of RPG indicators, and clear separation of display, processing, and data access routines make it a robust application foundation for item-supplier inquiries on AS/400 systems.