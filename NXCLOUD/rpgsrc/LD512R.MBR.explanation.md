# Program LD512R Documentation

## Overview

**LD512R** is an interactive RPG program within the ASLAGR system, primarily used for inquiry and limited maintenance of order and purchase order data, with a particular focus on date validation and control. The program presents order lines in a subfile, allows navigation, and provides drill-down to order or purchase order details depending on user selection. It enforces business rules regarding user permissions and validates date relationships for orders/purchase orders.

---

## Main Business Purpose

- **Inquiry on Orders/Purchase Orders**: Presents order lines (with associated header data) for a given customer/order/suffix combination.
- **Date Control**: Highlights orders/purchase orders where delivery or modification dates are inconsistent or require attention.
- **User Permission Enforcement**: Checks if the logged-in user has permission to modify orders.
- **Navigation/Drill-down**: Allows the user to select an order/purchase order line and branch to detailed maintenance programs.

---

## File Dependencies

The program interacts with several physical files, renamed for local clarity:

| File Name | Renamed As | Purpose |
|-----------|------------|---------|
| FOHEPFR   | FOHEL1R    | Order header (Sales order) |
| FODTPFR   | FODTLLR    | Order line (Sales order) |
| LODTPFR   | LODTLCR    | Purchase order line |
| LOHEPFR   | LOHEL1R    | Purchase order header |
| RKUNPFR   | RKUNL1R    | Customer master |
| FUSRPFR   | FUSRL1R    | User authorization (controls order modification rights) |
| LD512D    |            | Display file (subfile B1SFL, control B2CTL, command B2CMD) |

---

## Key Data Structures & Variables

- **Subfile Management**: Uses B1SFL for main subfile, B2CTL for control, and B2CMD for command screen.
- **Indicators**: The program uses traditional indicator ranges for controlling display, error, and work states. See inline comments for mapping.
- **Local Data Area**: Used to fetch firm number (`l_firm`), user, and other session data.
- **Parameter Area**: Receives customer, order number, and suffix as input parameters.

---

## Main Flow

### Initialization (`*inzsr`)

- **Parameter Setup**: Receives customer, order, and suffix.
- **Key Construction**: Builds key lists for all major files.
- **Firm/User/Customer Data**: Loads firm number from LDA, fetches user and customer details.
- **User Authorization**: Checks if the user is allowed to modify orders by chaining to the user register (`FUSRL1`).
- **Subfile Positioning**: Sets up the order line file for reading and populates the subfile.

### Main Loop

- **Display Subfile**: The user is presented with a subfile of order lines.
- **Function Key Handling**: The program responds to function keys for roll, refresh, drill-down, and exit.
- **Subfile Navigation**: Handles paging and cursor positioning.
- **Subfile Processing**: Reads changed records in the subfile, checks for selection (e.g., drill-down to order or purchase order), and invokes corresponding maintenance programs.

### Drill-down (`bestil`)

- If the user selects an order or purchase order line:
  - Calls `LO110R` for purchase order maintenance if selection is '2'.
    - Checks user authorization before allowing modification.
  - Calls `LO505R` for order maintenance if selection is '5'.

### Subfile Management

- **Clear Subfile (`clr_subfile`)**: Resets subfile and related counters.
- **Create Subfile (`crt_subfile`)**: Reads order lines from file, joins with order header, and writes records to the subfile. Handles page size and subfile record numbering.
- **Display Subfile (`dsp_subfile`)**: Displays the subfile or command screen, manages display indicators, and updates the current record number.
- **Subfile Processing (`subfile`)**: Handles user selection and triggers drill-down or subfile refresh as needed.

### Date Validation

- **Order Date Checks**: Highlights lines in the subfile where:
  - The delivery date is before the order date.
  - The modification date is after the delivery date.
- **Visual Indication**: Uses specific indicators (31, 32, 33) to flag these conditions for the user.

### Purchase Order Lookup (`hent_best`)

- For each order line, attempts to find a matching purchase order line and header.
- If found, populates subfile fields with purchase order data.
- Checks for consistency between order and purchase order numbers.

---

## Special Business Logic & Conventions

- **User Authorization**: Only users with a specific code in the user register (`fbko15 = 0`) are allowed to modify purchase orders. Otherwise, a message is shown ("Bruker har ikke lov til å endre bestilling").
- **Subfile Paging**: The subfile page size is controlled by constant `c_sfil` (12 records per page).
- **Date Format Handling**: Dates are stored in *ISO format and converted to *DMY for display.
- **Error/Warning Indicators**: 
  - 31: Delivery date before order date
  - 32: Modification date after delivery date
  - 33: Purchase order number mismatch
- **Field Expansion**: Over time, reference fields and price groups have been expanded to meet business needs (see change log at top).

---

## Interactions with Other Programs

- **LO110R**: Purchase order maintenance, called when user selects drill-down on purchase order lines.
- **LO505R**: Order maintenance, called when user selects drill-down on order lines.
- **AA005R**: Message display program, invoked if a user attempts an unauthorized modification.

---

## Key Design Patterns

- **Subfile Navigation**: Classic RPG subfile pattern with page-at-a-time display, roll keys, and cursor positioning.
- **Separation of Concerns**: File access, subfile management, and business logic are separated into subroutines.
- **Indicator-driven UI**: Uses RPG indicators to manage display state, field protection, and error highlighting.
- **Data Integrity**: Multiple checks ensure that only valid and authorized data can be modified or drilled into.

---

## Notable Conventions

- **Norwegian Field/Comment Names**: Many field names and comments are in Norwegian, reflecting the system’s origin.
- **Field Naming**: Suffixes like `_b` and `_o` distinguish between purchase order, order, and display fields.
- **Error Handling**: Uses indicators and a message array for error/authorization feedback.

---

## Summary Table: Main Subroutines

| Subroutine      | Purpose                                                                 |
|-----------------|------------------------------------------------------------------------|
| bestil          | Drill-down to order or purchase order maintenance                       |
| forny           | Refreshes subfile after changes or navigation                           |
| subfile         | Handles subfile processing and user interactions                        |
| clr_subfile     | Clears the subfile and resets counters                                  |
| crt_subfile     | Reads and populates the subfile with order lines and header data        |
| dsp_subfile     | Manages subfile display and user input                                  |
| hent_best       | Fetches associated purchase order data for an order line                |
| *inzsr          | Program initialization and setup                                        |

---

## Change History (Extract)

- **R6.10**: Expanded reference fields from 20 to 30 positions.
- **R6.20**: Added user authorization check for order modification.
- **R6.30**: Adjusted for increased number range.
- **8.01**: Expanded price group field from 1 to 2 positions.

---

## Conclusion

**LD512R** is a robust and mature order inquiry program, central to the ASLAGR system’s order management workflow. Its design ensures both usability (via subfile navigation and drill-down) and control (via user authorization and date validation). When onboarding, pay particular attention to the indicator usage, subfile processing patterns, and the business rules enforced around order and purchase order relationships.