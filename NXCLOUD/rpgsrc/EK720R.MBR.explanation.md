# Explanation of RPG Source Code

This RPG (Report Program Generator) source code is for an IBM i (AS/400) system. The program, named `EK720R`, is designed to calculate and update customer bonuses for **all customers**—likely as part of a scheduled batch job. Below you'll find a detailed line-by-line walkthrough and explanation for onboarding purposes.

---

## Header Section

```rpg
h option(*nodebugio) datedit(*dmy)
```

- **`h` spec:** Set program-level options.
    - `*nodebugio` disables debug I/O, making file I/O faster.
    - `datedit(*dmy)` sets the date format to day/month/year.

---

### Documentation (Comments)

The initial block of comments documents program metadata (system, program name, description, history, etc.).  
- Example: "Beskrivelse" (Description in Norwegian) explains this program computes and updates customer bonus agreements, typically run as a batch job.
- Special notes: Hardcoded year for one-time execution, company-specific adaptation (Degernes).

---

## File Declarations

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
fekboi1    if   e           k disk    rename(ekbost:ekboi1r)
```

- **File rkunl1:** Customer master file, keyed access, external description, renamed as `rkunl1r`.
- **File ekboi1:** Customer bonus master file, keyed access, external description, renamed as `ekboi1r`.

---

## Data Area and Variable Definitions

### Local Data Area (LDA)

```rpg
d                uds
d l_firm                944    946  0
```

- Declares access to the user data space (LDA)—`l_firm` field at positions 944-946.

### Key and Parameter Variables

```rpg
d ekboi1_bkun     s                   like(ekbkun)
```
- Defines a variable for bonus customer keys, matching the type of `ekbkun`.

### Working Variables

```rpg
d w_firm          s                   like(ekfirm)
d w_udat          s               d   datfmt(*iso)
d w_udat_8        s              8
d w_firm_alf      s              3
d w_bkun_alf      s              6
d w_paar_alf      s              4
```

- `w_firm` holds the current firm number.
- `w_udat` is the current date (ISO format).
- `w_udat_8` is the date as an 8-character string.
- `w_firm_alf`, `w_bkun_alf`, `w_paar_alf` are alphanumeric variants for firm, customer, and year, used in called program parameters.

---

## Main Logic

### Year Derivation

```rpg
c                   time                    w_udat
c     *iso0         move      w_udat        w_udat_8
c****               movel     w_udat_8      w_paar_alf
c                   movel     '2007'        w_paar_alf
```

- `time` populates `w_udat` with the current system date.
- `move`/`movel` convert/move the date to a string form.
- **Special note:** The year is hardcoded as '2007' in `w_paar_alf` (for a one-time run).

```rpg
c                   movel     w_firm        w_firm_alf
```
- Converts/left-justifies `w_firm` into the alphanumeric variant.

---

### Main Processing Loop

#### Loop over All Customers with Bonus Agreements

```rpg
c     rkunl1_key    setll     rkunl1
c     rkunl1_key    reade     rkunl1
c                   dow       not %eof
    ...
c     rkunl1_key    reade     rkunl1
c                   enddo
```

- `setll` positions at the start of customer records for this key.
- Reads each customer (`reade`) and loops until end-of-file.

#### For Each Customer

```rpg
c                   eval      ekboi1_bkun = rkkund
c     ekboi1_key    chain     ekboi1
c                   if        %found
c                   movel     ekbkun        w_bkun_alf
c                   call      'EK711R'
c                   parm                    w_firm_alf
c                   parm                    w_bkun_alf
c                   parm                    w_paar_alf
c                   endif
```
For each customer:
- Set `ekboi1_bkun` to the customer number (`rkkund` field).
- `chain` attempts to locate a bonus agreement for the customer.
    - If found, moves the bonus customer number into `w_bkun_alf`.
    - Calls program `EK711R` passing firm, customer, and year (as alphanumeric fields).  
      **This external program does the actual bonus calculation/updating.**

---

### Program End

```rpg
c                   eval      *inlr = *on
c                   return
```
- Turns on the last record indicator (ends the program/clean up).
- Returns control.

---

## Subroutine: *INZSR (Initialization)

```rpg
c     *inzsr        begsr
...
c                   endsr
```

- Runs automatically at program start for setup.

#### Key list for Customer File

```rpg
c     rkunl1_key    klist
c                   kfld                    w_firm
```
- Key list for reading customer file (`rkunl1`) for the current firm.

#### Key list for Bonus File

```rpg
c     ekboi1_key    klist
c                   kfld                    w_firm
c                   kfld                    ekboi1_bkun
```
- Key for customer bonus file: firm and customer number.

#### Retrieve Company Number from LDA

```rpg
c                   eval      w_firm = l_firm
```
- Loads the firm number from the user data area into working variable.

---

## Summary

**Purpose:**  
Batch process for calculating/updating bonuses for all customers in a given firm/year, driven by file data and calling an external program (`EK711R`) for each applicable customer.

**Data Flow Overview:**
- **Initialization:** Get firm number, set up keys.
- **Processing Loop:** For each customer with a bonus agreement, call the calculation program for the hardcoded year.
- **End:** Cleanup and exit.

**Customization/One-time Note:**  
- The year is hardcoded to '2007' (see comment and code).

---

**Onboarding Tip:**  
If you want to run this for a different year, update the assignment to `w_paar_alf` in the year derivation section.  
To modify for other companies, LDA's `l_firm` value must be set appropriately before running.

---

**Related files/programs:**  
- `rkunl1` (customer file)
- `ekboi1` (bonus agreement file)
- Program `EK711R` (does the actual bonus calculation)