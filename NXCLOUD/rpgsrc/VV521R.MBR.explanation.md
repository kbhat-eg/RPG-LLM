# RPG Program Explanation: VV521R (Alternative Item List Display)

This IBM ILE RPG program displays alternative items in a subfile (list format) on a 5250 display, allowing user interaction via function keys. The program handles database I/O, subfile maintenance, and user navigation.

---

## 1. Header and Metadata

- `h option(*nodebugio) datedit(*dmy)`
  - Sets compile options: no debug I/O and DD/MM/YY date format.
- Program Name: **VV521R**, System: **ASPNIB**
- Purpose: Display alternative items ("Alternativ vare, vise").
- Change log and indicator usage are documented in comments for maintenance.

---

## 2. Indicator Usage

The program heavily uses numbered indicators (*INxx*) for various purposes (see comments in code):

- LR: End program
- 10/11: Paging (RollUp/RollDown)
- 12/13/14/15: Subfile display control (display, control, clear, end)
- 21/22: Home key, cursor placement
- 30+: Field protection, error/warning/display indicators

---

## 3. File Declarations

```rpg
fvvaal1    if   e           k disk    rename(vvaapfr:vvaal1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvv521d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **vvaal1**: Alternate items physical file.
- **vvarl1**: Items master data file.
- **vv521d**: Workstation file (display file), uses a subfile record format (`b1sfl`) with relative record number (`w_srrn`). `infds(dspfbk)` is for display feedback (e.g., cursor pos).

---

## 4. Data Structure and Variables

### A. Parameters and Work Fields

```rpg
d p_firm          s                   like(vvfirm)
d p_nobb          s                   like(vvnobb)
```
- Parameters for the program: Firm code and item (NOBB) number.

```rpg
d l_user                911    920
```
- Local data area for user id.

#### Subfile Control Variables

- **w_fcrn**: First record number on the page
- **w_stel**: Subfile counter
- **w_spge**: Subfile page size
- **w_srrn**: Relative record number in subfile
- **w_sfrn**: First record number on last page
- **w_ssrn**: Last record number on last page

```rpg
d c_sfil          s              2  0 inz(7)
```
- Constant for subfile page size (7 records).

---

## 5. Display File Screens

Refer to display file record formats:
- **B1SFL**: Subfile record
- **B2CTL**: Subfile control record
- **B2CMD**: Command key help/display

---

## 6. Main Program Logic

### Main Sequence

#### a. Program Startup

- `*inzsr` subroutine is run at program start:
    - Receives parameters: p_firm, p_nobb.
    - Builds key lists for file access.
    - Assigns parameters to work variables.
    - Positions and populates the subfile via `crt_subfile`.

#### b. Main Loop

```rpg
c     b2taga        tag
c                   write     b2cmd
c     b2tagb        tag
c                   exsr      dsp_subfile
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inke
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   endsl
```
- Shows command keys screen (B2CMD), then displays the subfile.
- User input triggers different actions:
    - **Exit Keys (F3/F12)**: Exit program.
    - **Enter Key**: Refresh (renews) subfile.
    - **RollUp**: Add more records to the subfile/page.
    - Error/End keys handled via indicators.

#### c. Program End

- Sets LR to *ON and returns, ending the program.

---

## 7. Subroutines

### a. `forny` - Refresh Subfile

1. Positions file cursor at key.
2. Clears subfile (calls `clr_subfile`).
3. Refills subfile (calls `crt_subfile`).

### b. `clr_subfile` - Clear Subfile

1. Sets indicator for clear (IN14), writes control record to clear.
2. Resets paging and subfile variables (w_srrn, w_sfrn, w_ssrn, w_spge).

### c. `crt_subfile` - Fill Subfile

1. Increases page size by 7 records.
2. For each record:
    - Reads next alternative item (`vvaal1`).
    - Checks for end of file.
    - Moves data into subfile fields.
    - Optionally chains to item master (`vvarl1`) for extra info.
    - Writes subfile record.
3. Updates paging variables.

### d. `dsp_subfile` - Display Subfile

1. If subfile has records, sets indicator to show subfile.
2. Otherwise, shows command screen (`b2cmd`).
3. Activates indicators for control, then displays (`exfmt`) the control record.
4. Updates cursor position feedback.

---

## 8. Key Lists

```rpg
c     vvaal1_key    klist
c                   kfld                    w_firm
c                   kfld                    w_nobb
c     vvarl1_key    klist
c                   kfld                    w_firm
c                   kfld                    vvarl1_vare
```
- For key field access on alternate items and item master files.

---

## 9. Summary: What does this program do?

- Accepts parameters: firm and NOBB item number.
- Displays a list (subfile) of alternative items for a given item.
- Allows user to scroll (roll up/down), refresh, or exit.
- Subfile is populated from two database files:
    - **vvaal1**: alternative items
    - **vvarl1**: item master (for description/extra data)
- Uses standard RPG subfile and indicator techniques for display, paging, and user interaction.

---

## 10. Key RPG Techniques Demonstrated

- Subfile processing with paging
- Using indicators for subfile control and user interaction
- File I/O: `setll`, `reade`, `chain`
- Structured `select/when` for action routing
- Use of feedback data structure for cursor management

---

> **In essence:**  
This is a classic RPG program for displaying a paged list (subfile) of related/alternative items, with user control and dynamic data loading from indexed files. Itâ€™s well-commented, making it a good learning example of RPG/400 subfile programming.