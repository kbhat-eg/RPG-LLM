# RPG Program FO784R – Explanation

This program processes sales statistics and generates export files for "ByggDok" or "Cobuilder" systems, based on selected year, customer, and customer project. It includes logic to check system/module activation and customer/project-specific settings.

---

## 1. Header and Documentation

- **`h option(*nodebugio) datedit(*dmy)`**: H-spec continues the tradition of setting program options. Here, `*nodebugio` disables debug for I/O fields, and dates are expected in day-month-year format (`*dmy`).
- The long block of comments describes program purpose, history, and change log.
- Purpose: "Leser salgsstatistikk og legger ut byggdok for ønsket år/kunde/kundeprosjekt"—Reads sales statistics and exports building documentation for the selected year/customer/customer project.

---

## 2. File Declarations (`F`-specs)

- Each file is defined for input (`I`), output (`O`), update (`U`), keyed (`K`) or not, externally described (`E`), and may be renamed for internal use.
- Examples:
    - `fsstal5`: Sales statistics file, renamed to `sstal5r`.
    - `frkunl1`: Customer master file, renamed to `rkunl1r`.
    - `ffkprl1`: Customer project file, renamed to `fkprl1r`.
    - `fafpslr`, `frukpl6`, `famodl1`: Other master files for contacts, modules, etc.
    - `ffbdopf`: The export (output) file for ByggDok.
- The file names imply integration with customer, project, and module data.

---

## 3. Data Definitions (`D`-specs)

### Parameters

- `d p_list s 40` — Placeholder for parameter PLIST.
- Local Data Area fields, e.g., `l_fnav`, `l_user`, `l_filg`, `l_firm`.

### Key Variables

- Variables corresponding to file keys, e.g., `sstal5_paar`, `sstal5_vkun`, `sstal5_kpro` for year, customer, and project.
- These are typed as "LIKE" fields from file definitions (ensures same type/size as DB field).

### Working Variables

- Date/time fields, temporary string and number fields, flags.

### Flags and Activation Bits

- Multiple 1-byte flags initialized to *OFF or *ON, e.g., `b_bdo1`, `b_bdo2` (ByggDok), `b_cobu`, etc., indicating activation state for modules/processing steps.

### Constants

- Lowercase (`lo`) and uppercase (`up`) alphabets including special Norwegian characters, used for uppercase conversion (e.g., role names).

### External Program Declaration

- Defines call interface for external program `CO402R` (to check "no NOBB number" requirement for Cobuilder).

---

## 4. Mainline Logic

### ByggDok/Cobuilder Activation Check

- **Determine if processing is needed:**
    - If either ByggDok (`b_bdo1`) or Cobuilder (`b_cob1`) module is active:
        - It fetches the customer project (`fkprl1`) record.
        - If found and either ByggDok/Cobuilder export is enabled for the project, set corresponding process flag (`b_bdo2`, `b_cob2`) and record the current time.
    - If neither is enabled, program skips to end (`goto avslutt`).

### Sales Statistics Processing

- Sets up keys for sales statistics.
- Reads all statistics records for the year, customer, and project.
- For each record:
    - If a valid NOBB number exists or "no NOBB requirement" is active with a non-blank article, call subroutine `oppdater` (writes export record).

---

## 5. Export File Creation: Subroutine `oppdater`

- For each sales statistics record to export:
    - Looks up customer and contact for building documentation (looks for role `BYGGDOK` or `COBUILDER`).
    - Initializes the export file record (`fbdopfr`), populates it with relevant data from customer and project, including contact person/email fields.
        - Preference is given to project-specific email/contact if available.
    - Dates/times and user IDs are set.
    - Product identifier copied (NOBB number or article number).
    - Writes the constructed record to the export file.

---

## 6. Initialization (`*inzsr`)

- Loads parameters (year, customer, project, and flags to indicate which export is requested).
- Sets up key lists for use in file lookups.
- Checks if ByggDok or Cobuilder modules are present and activated in the system:
    - Looks for module in `amodl1` and checks a properties file (`afpslrr`) to verify PDF activation.
    - Sets flags accordingly (`b_bdo1`, `b_cob1`).
- Calls external program `CO402R` for Cobuilder, to check whether NOBB number is a required field. Sets `u_s701` flag based on response.

---

## 7. Keylists

- Defined for system-wide use to simplify keyed reads/chains.

---

## 8. Parameters

- At program entry, parameters are loaded into working variables and used throughout the code.

---

## 9. Termination (`avslutt` label)

- Releases resources and ends the program normally (`*inlr = *on`).

---

# Summary

- **Purpose**: Export sales statistics for selected year/customer/project to the ByggDok or Cobuilder system, considering module activation and customer/project-specific flags and settings.
- **Highlights**:
    - Checks system modules and properties to determine operation mode.
    - Gathers data from multiple sources (customer, project, contacts).
    - Handles business rules—e.g., project-specific overrides and NOBB number requirements.
    - Writes export file with properly populated fields, handling contacts and emails according to hierarchy: project → contact → customer.
    - Modular, with clear separation of initialization, processing, export creation, and shutdown.

---

This program exemplifies a robust pattern for data integration tasks on IBM i, using traditional RPG/400 constructs with modern enhancements (e.g., DCL-PR, DCL-S). It is well-structured for maintainability, with detailed documentation and commentary.