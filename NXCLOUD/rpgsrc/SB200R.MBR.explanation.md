# IBM ILE RPG Program SB200R – Budget Level Register Maintenance

This RPG/400 program provides a "green screen" maintenance interface for the budget level register ("budsjett-nivå-register") in the ASSTAT system. It manages records via subfiles and provides functions such as viewing, updating, and initializing budget levels. Below is a breakdown by section and function.

---

## 1. **Header and Documentation**

- The `/title` and header comments describe the program's purpose, versioning, and change log.
- It is used for the maintenance of budget levels (budsjett-nivå-register).
- Documented changes show code maintenance and enhancements.

---

## 2. **Program Options and Files**

```rpg
h datedit(*dmy.) option(*nodebugio)
```
- Specifies date format and disables debug I/O.

### File Declarations
```rpg
fSB200d    cf   e             workstn sfile(b1sfl:srrn01)
fsknil1    if   e           k disk    rename(sknipfr:sknil1r)
fsknilu    uf a e           k disk    rename(sknipfr:sknilur)
```
- `SB200d`: Workstation file (DDS display file), subfile `b1sfl` with relative record number `srrn01`.
- `sknil1`: Input file for budget levels, renamed record format.
- `sknilu`: Update file for budget levels, renamed record format.

---

## 3. **Data Structures and Variables**

- **Message and Report Arrays**
  ```rpg
  d mld             s             11    dim(4) ctdata perrcd(1)
  d rpt             s             15    dim(60) ctdata perrcd(1)
  ```
  Message/report texts loaded at compile time.

- **User Information**
  ```rpg
  d                uds
  d l_user                911    920
  d l_firm                944    946  0
  d l_fnav                951    980
  ```

- **Budget Level Keys (w_kode)**
  ```rpg
  d w_kode          ds            12
  d w_kode_11                      1  0
  ...
  d w_kode_34                      1  0
  ```
  Holds various budget level codes for subfield/key manipulation.

- **Subfile and control variables**
  Subfile record, page, and control variables—track subfile navigation and keys.

---

## 4. **Mainline Processing**

### Subfile Controller

#### Tag: `b2taga`
- Displays the base command screen (`write b2cmd`).

#### Tag: `b2tagb`
- Calls subroutine `xdsp01` to process subfile display and navigation.

#### Exit Handling
- If function key *INKC (F3/Exit) is pressed, branches to program end (`xslutt`).

#### Refresh/Forny
- Handles function key *INKE for refresh; reloads selected subfile record if needed.

#### Roll/Page Down
- Handles *IN10 (Page Down); calls subroutine to fill the next page of the subfile.

#### Home/Top
- Handles *IN21 for Home, sets *IN22 and returns to the top of the subfile.

#### Positioning
- If a specific code (`b2kode`) is entered for positioning, it sets key values, clears and fills the subfile to the correct position.

---

## 5. **Subfile Handling**

### Selection Check Loop
- Loops through subfile entries to find if a selection has been made for action (using `readc`).
- If a view action (value 5) is detected, loads keys and calls the display subroutine `xf0win`.

---

## 6. **End Program**

#### Tag: `xslutt`
- Sets LR indicator (`*INLR`) to mark program for finalization and stops execution.

---

## 7. **Subroutines**

### `xf0win` – Process Budget Level Window
- Loads selected budget register record.
- Sets default values for display fields.
- Calls another program (`SB210R`) for further processing.
- Updates subfile entry after display or update.

### `xclr01` – Clear Subfile
- Resets subfile control indicators and clears counters for a fresh load.

### `xcrt01` – Fill Subfile
- Loads up to 10 subfile records starting from the current subfile position.
- For each loaded record, fetches description text and fills subfile display fields (`b1vis1`, `b1vis2`, `b1vis3`) appropriately.
- After loading, updates navigation variables.

### `xdsp01` – Display Subfile
- Prepares and displays the subfile control record, turns off relevant indicators after display.

### `hntarr` – Get Number Values from Array
- Determines which descriptive texts to load into subfile fields by mapping budget level code segments to text array indices (`r1`, `r2`, `r3`).

### `*inzsr` – Initialization
- Sets key lists for accessing the budget level file.
- Loads initial records into subfile and initializes display indicators.

---

## 8. **Data Table (Tabeller)**

The commented table at the end lists budget level sort order/names for codes used in the application, like Avdeling (Department), Lager (Stock), Leveringstype (Delivery type), Land (Country), etc.

---

## 9. **Summary of User Experience**

- User is presented with a list of budget levels via a subfile. 
- They can scroll (Page Down/Roll), refresh, home, or position the list to a code.
- Selection (e.g., option 5) allows further drill-down or maintenance.
- All information and navigation are managed via subfiles with standard green screen conventions.
- The program is modular, with subroutines for clearing, filling, and displaying subfiles, as well as handling initialization and text lookups.

---

## 10. **Key Variables and Indicators**

- **Subfile**: `b1sfl`, with control record `b2ctl`.
- **Function Keys**: 
    - `*INKC`: Exit
    - `*INKE`: Refresh
    - `*IN10`: Roll/Page Down
    - `*IN21`: Home
- **User context and Firm**: Populated at startup from the user area.

---

## 11. **Additional Notes**

- Uses "traditional" RPG (fixed-format C-specs), not RPG IV/free-form.
- Uses subfiles for user selection and paging.
- Multiple subroutine blocks manage reusability and maintainability.

---

This summary should enable a developer to understand the program flow, file access, and usage of subfiles for maintaining the budget level register. The naming conventions and comments (in Norwegian) also assist in understanding specific business terminology.