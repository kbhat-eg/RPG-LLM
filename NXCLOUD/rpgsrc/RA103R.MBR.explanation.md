# Overview

This ILE RPG program, named `RA103R`, is a classic green-screen application for IBM i (AS/400). It is focused on the maintenance of "Betalingsbetingelser" (Payment Terms), allowing the user to view, create, update, copy, or delete payment terms records through subfiles (scrollable lists) and dedicated maintenance screens.

It utilizes a mixture of native database file access, subfile handling, function key logic, and access control (adgangskontroll) enhancements (as of version 7.01).

## Structure

- **File Definitions**: Multiple logical files over the main payment terms file are defined for searching/sorting.
- **Workstation File**: Used for the main user interface with subfile support.
- **Data Definitions**: Subfile control variables, local data area fields, indicator usage.
- **Subroutines**: All core functions (display, maintain, copy, delete, etc.) are organized as named subroutines.
- **Access Control Enhancements**: Starting from version 7.01, the program checks user permissions before allowing certain actions.

---

## Indicators

- **LR**: End of program.
- **10-15, 21-22, 30**: Function key and subfile management.
- **31-79**: Warning and error indicators.
- **80-99**: Work indicators.

---

## File Definitions

```rpg
fra03l1 if e k disk rename(ra03pfr:ra03l1r)
fra03l2 if e k disk rename(ra03pfr:ra03l2r)
fra03lr if e k disk rename(ra03pfr:ra03lrr)
fra03lu uf a e k disk rename(ra03pfr:ra03lur)
fra103d cf e workstn sfile(b1sfl:w_srrn)
```
- The main file (`ra03pfr`) is accessed through 4 logical files (by different keys/use cases).
- The display file (`fra103d`) supports a subfile called `b1sfl`.

---

## Key Variables

**Subfile Management Variables:**
- `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Subfile and screen navigation.
- `w_seqe`: Selector for search by code or description.
- `b_oppr`, `b_forn`, `b_cnul`, `b_feil`: Flags for operational context.

**Access Control Variables (7.01+):**
- `w_tilgko`: User code for access control
- `w_rutine`: Name of the current routine/program ("RA103R")
- `w_adv`: Function key/action code
- `w_status`: Access status ("Sperret" = Blocked)

---

## Access Control (Version 7.01+)

- Calls external program `CO402R` to check if access control should be enabled.
- If enabled (`u_s701 = *on`), checks user rights for both general routine access and per-function key.
- Calls `AD005R` with user/routine/action; if response is "Sperret", access is denied.

---

## Main Loop

The program follows a **screen-prompt / function-key / subfile-cycle**:

1. **b2taga / b2tagb**: Entry points for the main menu or returning after an operation.
2. **Display subfile** (`dsp_subfile`), allow function keys to navigate, add, copy, delete, etc.
3. **Process function keys**:
   - F03/F12 (exit), F05 (refresh), F06 (new), F10/F11 (subfile navigation), etc.
4. **Support for position-based searching**: By code or description.
5. **Subfile item processing**: For each selected subfile row, process chosen operation (edit, copy, delete, view).
6. **Exit via `avslutt`**.

---

## Subroutines

### 1. `forny`
- Re-reads subfile starting at a selected record.
- Calls `clr_subfile` and `crt_subfile` to refresh the subfile display.

### 2. `posisjoner`
- Handles positioning in subfile by code or description.
- Clears and recreates the subfile after positioning.
- Clears search fields after positioning.

### 3. `subfile`
- Iterates through displayed subfile records, processes chosen actions (edit, copy, delete, view), updating the display as needed.
- Includes access check for actions (7.01+).

### 4. `xc1bld` (New Row Screen)
- Presents the screen to create a new payment term.
- Checks for existing entries to prevent duplicates.
- Calls edit/view subroutine after creation.

### 5. `xc1msg`
- Show an information message if trying to add a duplicate entry.
- Sets flag to return to the New Row screen.

### 6. `xc2bld`
- Handles the main maintenance screen for add/edit/view.
- Loads data if found, or blanks for new entry.
- Validates input (e.g., description cannot be blank).
- Writes or updates the entry in the file.
- Updates subfile if editing an existing record.

### 7. `xd1win`
- Handles the delete confirmation screen.
- Deletes the record if confirmed.

### 8. `xk1win`
- Shows the copy screen.
- Loads data to be copied and allows entering a new key.
- Checks for duplicate destination key before copying.

### 9. `clr_subfile`
- Clears the subfile display.

### 10. `crt_subfile`
- Fills up the subfile, reading from the file (by code or description).
- Stops when page is full or no more records.

### 11. `bck_subfile`
- Allows page-back navigation in the subfile.

### 12. `dsp_subfile`
- Controls the display of the subfile and related indicators.

### 13. `*inzsr`
- Initialization subroutine.
- Sets up keys, loads firm from LDA, initial positioning, and performs initial access check (7.01+).
- Fills the subfile with data.

---

## Notes on Subfile Handling

- Uses typical subfile pattern for green-screen applications: fetches records, populates subfile, monitors scrolling, supports actions per row.
- Supports both forward and backward paging.
- Can position on either code or description fields.

---

## Function Key Management

- Common keys: F03/F12 (exit), F05 (refresh), F06 (add new), F10/F11 (page up/down), F21 (home).
- Managed via indicators (`*inKC`, etc.) and select blocks.
- Per-key access can be restricted if access control is enabled.

---

## Error Handling & Validation

- Duplicate checks when creating new entries.
- Description is mandatory.
- Visual feedback via indicators (turning on relevant error indicators).

---

## External Calls

- `CO402R` and `AD005R`: Used for access control logic.

---

## Summary

This RPG program provides a robust, interactive interface for maintaining payment terms, balancing classic AS/400 subfile patterns with newer access control features. Subroutines are well-structured for each user interaction, and there's clear support for extensibility and adaptation for GUI/DDS changes. It is a good example of mid-to-late period RPG III/IV before full modernization.

---

### **Onboarding Tips**

- **Understand the subfile cycle**: The program's logic is tightly bound to subfile I/O â€” spend time on how records are fetched and updated in the subfile.
- **Monitor indicator usage**: Indicators control much of the program's flow.
- **Review access control logic**: Especially if you are modifying or integrating with new security modules.
- **Navigation and maintenance screens**: Know which subroutines handle which screen or file operations.
- **Data sources**: All operations are performed via logical files over the core payment terms file.
- **Diagnostics**: Look for error messages and warnings managed by indicators 31-79.

For changes, follow the pattern of checking, validating, and updating subfile and database as seen in the existing subroutines.