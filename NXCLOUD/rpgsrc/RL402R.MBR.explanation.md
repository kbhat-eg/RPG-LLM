# RPG Program Explanation: RL402R

This RPG (Report Program Generator) program runs on IBM i (AS/400, iSeries) systems. The purpose of this program is to allow for deletion ("sletting") of records ("posteringer") for suppliers ("leverandører") based on a user-supplied parameter (most likely the accounting year, "Regnskapsår").

Below is a walk-through and explanation section by section.

---

## Header and File Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Program options: disables debug I/O; sets date edit to day/month/year.

```rpg
fraa1pf    if   e           k disk    rename(raa1pfr:raa1pfr)
frl402d    cf   e             workstn
```
- **fraa1pf**: Input full procedural file, keyed, external, disk file renamed to internal name `raa1pfr`.
- **frl402d**: Display file to interact with the user at the workstation (`workstn`).

---

## Data Definitions

### Local Data Area (LDA) Definitions

```rpg
d                uds
d l_firm                944    946  0
d l_fnav                951    980
```
- Accesses system LDA (User Data Space).
- Picks out `l_firm` (company number) and `l_fnav` (company name).

### Parameter Data Structure

```rpg
d                 ds
d d_list                        64
d  d_raar                        4  0 overlay(d_list)
```
- `d_list`: 64-byte data structure (used for parameter passing).
- `d_raar`: 4-digit accounting year overlaid on `d_list`’s first 4 bytes.

### Variables

- `b_feil`: Error flag (*OFF/*ON).
- `w_firm`: 3-digit company number (work variable).
- `w_mld1`, `w_mld2`: Constant message texts (Norwegian).
- `wactli`, `wactpo`, `wmld01`, `wmld02`: Miscellaneous variables for messaging or screen display.

---

## Mainline Logic

### Opening Screen

```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- Displays initial screen layout (`b1bld`) for user input.

### Function Key Processing

```rpg
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
```
- If the user presses F3 (exit), jumps to program end.

### Input Validation

```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   goto      b1taga
c                   endif
```
- Calls subroutine `sjekk_input` to validate user input.
- If an error is found, redisplays the screen for correction.

### Prepare Parameters & Messages

```rpg
c                   exsr      flytt_par
c                   eval      wactli = 4
c                   eval      wactpo = 44
c                   eval      wmld01 = w_mld1
c                   eval      wmld02 = w_mld2
```
- Moves screen input fields to the parameter data structure.
- Prepare messaging variables.

### Call Message and Delete Programs

```rpg
c                   call      'AA006C'
c                   parm                    wactli
c                   parm                    wactpo
c                   parm                    wmld01
c                   parm                    wmld02

c                   call      'RL403R'
c                   parm                    d_list
```
- Calls `AA006C` to show a "please wait" message.
- Calls `RL403R` to perform the actual deletion, passing the parameter list.

### End Program

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks program for last record and returns (ends the program).

---

## Subroutines

### sjekk_input (Input Validation)

```rpg
c     sjekk_input   begsr
c                   eval      b_feil = *off
c                   eval      *in31 = *off
c                   eval      *in32 = *off
c                   eval      *in33 = *off
...
```
- Turns off error flags.
- Checks if the `b1raar` (accounting year) is zero, in the future, or invalid compared to database value, and sets error indicators accordingly.
- Returns if there is a problem (so errors can be highlighted on the screen).

### flytt_par (Move Parameters)

```rpg
c     flytt_par     begsr
c                   eval      d_raar = b1raar
c                   endsr
```
- Copies input field (`b1raar`) to the parameter data structure (`d_raar`) for passing to the called delete program.

### *inzsr (Initialization Subroutine)

```rpg
c     *inzsr        begsr
c                   eval      w_firm = l_firm
c                   eval      b1firm = l_firm
c                   eval      b1navn = l_fnav
c                   eval      wactli = 3
c                   eval      wactpo = 2
...
c     raa1pf_key    chain     raa1pfr                            61
...
c     raa1pf_key    klist
C                   kfld                    l_firm
c                   endsr
```
- On program start, initializes firm and display variables from LDA (current user's session).
- Sets up for status lookup in the company file.

---

## Summary

- **Purpose**: Lets a user delete supplier records for a specified year, with input validation and user messaging.
- **Main Flow**: Show input screen → validate input → display "please wait" message → call deletion program.
- **Error Handling**: Validates input on year, signals errors to screen, and loops until user inputs valid data or exits.
- **Parameterization**: Uses a data structure to pass parameters to the delete program.
- **Subroutines**: Modular code for input validation, parameter setup, and initialization.

---

### Notes

- Norwegian language is used in messages and comments.
- Status lights/indicators (e.g., *in31, *in32, *in33) correspond to specific input errors shown on-screen.
- Design follows standard RPG/IBM i user interaction patterns: validation, error signaling, batch call-outs.
- This is written in "traditional" RPG with fixed-format `C` and `D` specs, rather than newer free-form RPG.

---

**If you have specific questions on any section of the code or need to see the display file structure, let me know!**