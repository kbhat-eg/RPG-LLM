# RPG Program FR510R – Onboarding/Code Explanation

## Overview

This program, `FR510R`, is an **interactive inquiry and browsing program** for a *rabattmatrise* (discount or price matrix) for customer/customer projects. It supports multi-level discount/price structures, such as customer categories, product groups, supplier, item, unit, delivery type, and more.

It features:
- Retrieval and display of discounts and prices in a matrix, segmented by multiple levels.
- Subfile presentation (paging and navigation).
- Search, positioning and drill-down on various matrix levels.
- Display of related descriptive data.
- Function key navigation and field-level lookups.


---

## 1. **Header and Documentation**

The header describes:
- System, program name, and purpose.
- Revision history and enhancements. (e.g. adding supplier as matrix level, rollback feature, price group expansion, etc.)
- Indicator usages (including which indicators are used for subfile handling, function keys, etc.).


---

## 2. **File Declarations (`F-specs`)**

There are several logical files (`IF`), all renamed upon load to avoid conflicts and to reference record formats using unique names. The key files handle different sub-levels of the discount matrix. Files include:
- `frabl*` series: Variants of the discount matrix file for different keying/views.
- Reference files for customers, products, groups, suppliers, etc.
- `fr510d`: The display file, including subfile and control records, display feedback, etc.

#### **Display File**
- `fr510d` is used interactively with a subfile (`b1sfl`) for list/browse functionality.


---

## 3. **Data Definitions (`D-specs`)**

**Parameters:**  
- `p_firm`, `p_kund`, `p_kpro`: Input parameters for company, customer, customer project.

**UDS Area & Info**:  
- Local data area, fields for name, etc.

**Display Feedback DS:**  
- For display file information, e.g. cursor position (`d_fcrn`).

**Key Variables for Each Level**:  
- Series of variables to build keys for the various logical files (*e.g.,* `frabl1_prgr, frabl1_kkat, frabl1_kund, ...`).

**Working Fields:**  
- For subfile navigation (`w_fcrn`, `w_srrn`, etc.), descriptive texts (`w_rtxt`, `w_ktxt`, ...), indicator constants (e.g. `c_sfil` is the subfile page size), etc.

---

## 4. **Main Program Flow (C-specs)**

### **Startup & Initiation**

- **`*inzsr`**: Handles initializations:
    - Loads parameters, sets up initial display fields, loads overrides from customer or project, performs initial positioning on the matrix, and fills the subfile.

### **Main Loop & Display**

- **Top-level Tags** (`b2taga`, `b2tagb`):  
    - Loop to process screen commands, function keys, and update the subfile.
    - Handles function key branching for exit, search, refresh, paging, repositioning, etc.

### **Subroutines**

#### Subfile Handling

- **`crt_subfile`**: Populates subfile page by reading logical file(s) as per current position (`w_seqe`).
- **`clr_subfile`**: Clears the subfile.
- **`dsp_subfile`**: Handles interaction with the subfile, including user input and feedback fields.
- **`subfile`**: Main subfile processing routine (navigation, handle selection to drill-down/view).

#### Positioning and Drilling

- **`forny`/`posisjoner`**: Repositions and reloads data at selected matrix level (customer, category, group, etc.) by building the right keys and calling `clr_subfile`/`crt_subfile` as needed.

- **`bck_subfile`**: Handles back-page navigation in the subfile.

#### Inquiry and Lookup

- **`spørring`**: Calls external programs for lookups on the field in focus (e.g. customer, item, group, etc.), updating text/display variables.

- **`xc2bld`**: Builds and displays detail view for a selected subfile entry, fetching the record, moving and formatting values for display, fetching descriptions, and showing the detail screen.

- **`hent_info`**: Retrieves and sets descriptive texts for category/group/item/etc. fields, using logical file chains or calling external programs as needed.

---

## 5. **Key Construction**

Throughout the program, various `klist` (key lists) are defined for:
- Positioning and chaining (locating) logical files at the correct record.
- Each klist matches specific levels (e.g. by customer, group, item, etc.) and are used in `chain`, `setll`, `setgt` operations for record navigation.

---

## 6. **Function Key and Indicator Usage**

- Multiple indicators (`*INxx`) are used for navigation, subfile reset, field-protect, function key detection, etc.
- Each function key (roll, home, F-keys) is mapped to appropriate branches and subroutine calls in the main loop.

---

## 7. **Paging and Subfile Navigation**

- Implements a paged subfile view (`w_srrn`, `w_spge`, etc. control page/record numbers).
- Next/Previous page logic is handled in `crt_subfile` and `bck_subfile`.
- Subfile is filled up to a maximum page size; navigation indicators are reset as needed.

---

## 8. **Inquiry/Drilldown Handling**

- User can select a row or use a function key to "drill down" on a particular record.
- Calls subroutine (`xc2bld`) to fetch and display the detail data for the selected record, along with related descriptions.

---

## 9. **Field-Level Contextual Lookup**

- When the user is positioned in a specific field (customer, item, etc.), F4/lookup triggers the `spørring` subroutine.
- This routine calls relevant external programs to perform selection/inquiry and updates the text/description fields.

---

## 10. **Data Integrity & Filtering**

- When filling subfiles, additional filters are applied based on the current context (e.g., only show relevant records for the current customer/category).
- Ensures that only applicable records are displayed, filtering by key-level fields.

---

## 11. **Matrix Hierarchy**

- The program can navigate and display the matrix at any level—price group, discount category, customer category, customer, project, group, etc.
- This is facilitated by variables (e.g. `w_seqe`) that determine the current "level" and select the correct logical file and key structure.

---

## 12. **Program Extensibility & Comments**

- The program is well annotated (in Norwegian) with block comments showing purpose, indicator usage, and links to revisions/expansions.
- Extending the matrix with new levels or logic is facilitated by the modular subroutine and key structures.

---

## 13. **Best Practices and RPG-Specifics**

- Uses `setll`, `setgt`, `read`, `readp`, `chain` for indexed access/paging.
- Subfiles for browse/paging.
- Indicator-driven logic for screen handling, field protection, etc.
- Modular subroutine structure (using `begsr`/`endsr`).

---

## 14. **Summary of Matrix Levels Supported**

- **Prisgruppe (Price group)**
- **Rabattkategori (Discount category)**
- **Kundekategori (Customer category)**
- **Kunde (Customer)**
- **Kundeprosjekt (Customer project)**
- **Varegrupper:**
    - Overgruppe (super group)
    - Hovedgruppe (main group)
    - Undergruppe (subgroup)
- **Leverandør (Supplier)**
- **Modulnr (Module number)**
- **Varenummer (Item number)**
- **Enhet (Unit)**
- **Leveringstype (Delivery type)**

---

## 15. **External Programs Used**

Programs such as `RA506R`, `RA511R`, `VG510R` etc. are used for performing lookups of specific entities (customers, products, categories, etc.).
They all follow the pattern of taking the company code and the entity key as parameters and returning a description.

---

## 16. **Usage Flow (in simplified steps)**

1. **Startup:** Loads parameters, initializes display, fills subfile to first page.
2. **Display/Browse:** User sees matrix records in the subfile, can page, search, or reposition.
3. **Lookup:** At any field, F4/lookups can be performed to select/fill field values.
4. **Drill Down:** User can select entry to view detailed matrix information.
5. **Paging:** Forward/backward paging supported.
6. **Exit:** F3/F12 to exit program.

---

## 17. **Key Takeaways for Onboarding**

- **Understand the matrix hierarchy:** Familiarize with how each level is represented and how key fields map to logical files.
- **Subfile Handling:** Study how subfile is used for paged browsing and how its navigation works.
- **Field Lookups:** Know that external programs (*.R) fetch descriptions and validate field contents.
- **Adding new levels or expanding:** You'll need to add new logical files, keylists, and likely extend the lookup/descriptive logic accordingly.
- **Indicator usage:** Essential to navigation, paging, subfile update, and function key logic.
- **Modular logic:** Each subroutine is focused on a particular aspect (display, subfile, lookup, etc.).
- **Internationalization/localization:** All comments are in Norwegian; field names reflect the business context.

---

# **In Short:**

This is a robust RPG program for hierarchical discount/price matrix browsing in an IBM i environment, using subfile paging, extensive key-based logical file browsing, indicator-driven screen logic, and modular subroutines for clean, focused logic for each "matrix level." External programs are used for field validation and description retrieval. 

Understanding its architecture will help you quickly onboard to extending or maintaining it!