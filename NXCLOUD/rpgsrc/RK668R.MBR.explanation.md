# Program Documentation: RK668R

## Overview

**Program Name:** RK668R  
**System:** ASOKON  
**Description:**  
This program checks customer postings against an interest threshold (rentegrense). It processes posting records, sums up interest amounts per customer, and deletes postings for customers whose total interest is below a configured threshold.

---

## Files and Data Structures

### Physical Files Used

- **RKWBL2**  
  - Input file, keyed, renamed as `rkwbl2r`
  - Contains posting records to be processed

- **RKWBLU**  
  - Update file, keyed, renamed as `rkwblur`
  - Contains posting records that can be deleted

- **RAA6L1**  
  - Input file, keyed, renamed as `raa6l1r`
  - Contains configuration, specifically the interest threshold (`ra6pgr`)

### Key Data Fields

- **l_user, l_firm, l_navn:**  
  User, firm, and name fields from the program’s user data structure

- **w_firm:**  
  Working variable for the firm, initialized from `l_firm`

- **w_rdat, w_renk, w_rsum, w_rgrn:**  
  Working variables for date, interest amount, interest sum, and interest threshold, respectively

- **g_kund:**  
  Tracks the current customer being processed

---

## Program Flow

### 1. Initialization (`*inzsr` Subroutine)

- **Firm Setup:**  
  `w_firm` is set from the user-provided `l_firm`.

- **Key Lists:**  
  Key lists are set up for the three files, using `w_firm` and customer number as required.

- **Interest Threshold Retrieval:**  
  Uses `chain` to retrieve the interest threshold (`ra6pgr`) for the current firm from `RAA6L1`.  
  If found, sets `w_rgrn` (interest threshold) accordingly.

---

### 2. Main Processing Loop

- **Sequential Read:**  
  Reads through all records in `RKWBL2` for the current firm using the key list.

- **Customer Grouping:**  
  For each record, sums the interest amount (`rwrent`) into `w_rsum` for the current customer (`g_kund`).

- **Customer Change Detection:**  
  When the customer number changes (`g_kund <> rnkund`), checks if the accumulated interest (`w_rsum`) is below the threshold (`w_rgrn`).

- **Conditional Deletion:**  
  If below threshold, calls the `slett_post` subroutine to delete all postings for that customer from `RKWBLU`.

- **Reset:**  
  After processing each customer, resets `w_rsum` and updates `g_kund` to the new customer.

- **Loop Exit:**  
  Continues until all postings have been processed.

---

### 3. Deletion Subroutine (`slett_post`)

- **Purpose:**  
  Deletes all postings in `RKWBLU` for the specified customer (`g_kund`) and firm.

- **Process:**  
  - Sets the key to the first matching record in `RKWBLU`.
  - Loops through all matching records using the key list.
  - Deletes each record found.

---

## Key Business Logic

- **Interest Threshold:**  
  The threshold (`rentegrense`) is firm-specific and retrieved from `RAA6L1`. Only customers whose total interest postings for the period are below this threshold are affected.

- **Posting Deletion:**  
  For customers below the threshold, all their postings are deleted from the update file (`RKWBLU`). This is likely part of a data cleanup or pre-processing step before further financial processing.

---

## Design Notes and Conventions

- **Separation of Read and Update Files:**  
  The program reads from `RKWBL2` (posting source) and deletes from `RKWBLU` (posting update). This separation helps maintain data integrity and allows for different locking strategies.

- **Key List Usage:**  
  Key lists (`klist`) are used to abstract key composition for file operations, supporting maintainability if key structures change.

- **Subroutines:**  
  - `*inzsr` for initialization
  - `slett_post` for encapsulating the deletion logic

- **Error Handling:**  
  The code uses RPG’s indicator-based control (e.g., `*in61`, `*in92`, `*in99`) for end-of-file and found/not found logic. There is no explicit error logging, which is typical in legacy batch programs.

- **Field Naming:**  
  Field and variable names follow a pattern reflecting their business meaning (e.g., `rwrent` for interest amount, `ra6pgr` for interest threshold).

---

## Interactions and Dependencies

- **File Relationships:**  
  - `RKWBL2` and `RKWBLU` are logically related; both contain postings for customers by firm.
  - `RAA6L1` provides configuration data (interest threshold) per firm.

- **Upstream/Downstream:**  
  This program is likely run as a batch process, either as part of end-of-day or end-of-period routines, preparing data for reporting or further processing.

---

## Summary

RK668R is a batch utility for enforcing minimum interest thresholds on customer postings. It scans all postings for a firm, groups by customer, and deletes postings for those who do not meet the minimum interest requirement. The threshold is configurable per firm and maintained in a separate configuration file. The business logic is encapsulated in clear subroutines and follows standard file-processing conventions in IBM RPG. This program is a critical data hygiene step in the interest calculation or reporting workflow.