# Explanation of RPG Source Code (ASOFAK: Utskrift/Utplukk fra ordre-register)

---

## Overview

This program, `FO602R`, is a classic ILE RPG application that handles extraction and printing of orders from an order register. It supports multiple extraction and selection methods, as well as integration with related files such as order lines, customer, and info registers.

The code contains extensive versioning with comments outlining changes and enhancements over many years. It is a well-maintained program with modular structure, using subroutines (`begsr/endsr`) and tags for flow control.

---

## Major Components

### 1. **File Declarations**

- **Database and Workstation Files:**  
  Files are defined for reading/writing orders, customers, order types, parameters, and other related info. Some files are renamed on input for clarity (e.g., `frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)`).

- **Workstation File:**  
  `fo602d` is the interactive workstation file (`workstn`), handling user input screens.

### 2. **Data Structures and Variables**

- **Local Data Area:**  
  Fields `l_wsid`, `l_user`, `l_filg`, and `l_sfir` hold session-specific details, such as workstation/user IDs.

- **Order Key Structures:**  
  Data structures like `d_kkey_til` and `d_kkey_les` are overlays for firm, order type, order number, and suffix, simplifying key management for sequential reads.

- **Working Variables:**  
  Many fields are defined for temporary storage and parameter passing, e.g., `w_firm`, `w_otyp`, `w_palt`, `w_bdat` (dates), amounts, segment codes, and flags for business logic.

### 3. **Parameter Handling**

- **Input Parameters:**  
  `p_firm` and `p_ftor` are received from a previous program, setting the main firm number and a flow-control flag.

### 4. **Screen Handling and Flow Control**

- **Main Loop with Tags:**  
  Tags (e.g., `d0taga`, `d1taga`, etc.) are used to segment the user interaction logic; each tag represents a "screen" or logical function, with EXFMT/WRITE for display.

- **Function Keys:**  
  Detection of keypresses like F3 (exit) allows users to interrupt or exit at any time.

### 5. **Extraction/Selection Methods**

The program supports several ways to select orders for extraction:

- **By Range:**  
  `d1taga` handles from/to order number selection.

- **By Sequence:**  
  `d2taga` allows selection based on customer sequence codes, with checks for date/amount ranges and department.

- **By List:**  
  `d3taga` implements selection by entering specific order numbers.

- **By Other Criteria:**  
  `d4taga` (and further) allows selection by department, customer, customer project, info code, etc.

- **Alternative Factoring (Card Transactions):**  
  `d5taga` provides extraction for orders linked to special payment methods.

- **Automatic Invoicing from External File:**  
  `d6taga` handles batch invoicing from an external source.

### 6. **Order Update Logic**

The `oppord` subroutine encapsulates most of the business logic for validating and marking an order as selected for processing, including:

- **Checks:**  
  - If the order is already handled.
  - If the order type is correct.
  - If order lines exist (otherwise, auto-deletes the order).
  - Info code restrictions (can block invoicing).
  - Permission checks for user and order type.
  - Prevention of duplicate selection for special card transactions.
  - Deposit status (orders with unpaid deposit may be skipped).

- **Order/Parameter Register Updates:**  
  Includes marking the order as picked for treatment and writing a record to the selection parameter file.

### 7. **Subroutines**

Several utility subroutines help with repeated tasks:

- **Screen Handling:**  
  `xe2win`, `xe3win` for custom screen flows.

- **Selection Logic:**  
  `oppord` for updating records after selection.

- **Inquiry Support:**  
  `sp√∏rring` calls external programs for field lookups (department, customer, project, etc.).

- **Card Transaction Initialization:**  
  `d5init` clears option fields for the alternate factoring screen.

- **Deposit Check:**  
  `sjekk_depo` verifies if an order has an outstanding deposit requirement.

- **Program Initialization:**  
  `*inzsr` defines keys for all used files, initializes fields, and retrieves user info.

---

## Key Business Rules and Features

- **User/Order Type Validation:**  
  Validates that the user and order types are allowed for invoicing and other processing.

- **Comprehensive Selection:**  
  Users can extract orders via a variety of methods (range, sequence, list, department, project, info code, card type, etc.), making this tool very flexible.

- **Data Integrity:**  
  Prevents processing of orders that are already handled, have invalid types/status, lack order lines, or are blocked by business rules.

- **Integration:**  
  Supports lookup against multiple associated files and registers, including customer info, project, and info codes.

- **Special Cases:**  
  Includes options for batch/automatic processing, such as alternative invoicing or external input files.

- **Audit and Tracking:**  
  Updates tracking fields (timestamp, user ID) when orders are marked as selected.

---

## Notable Code Constructs

- **Overlayed Data Structures:**  
  Used to manage composite keys efficiently, e.g., `d_kkey_til` overlays for key fields.

- **Chain/SetLL/Read:**  
  Standard RPG file access patterns for random and sequential record access.

- **Tags and GOTO:**  
  Handled in old-style RPG for mainline flow instead of structured blocks; each logical screen/function is a tag.

- **Conditional Logic for Fields/Flags:**  
  Widespread use of flags and field tests to control program behavior (e.g., `u_saml`, `b_slet`, `b_depo`).

---

## Example Flow

1. **User selects extraction method** (by order type, number, or other criteria).
2. **User fills in selection parameters** (date range, amounts, customer, etc.).
3. **Program validates input**, including checking database for existing/invalid data.
4. **For each order meeting the selection**:
    - If OK, marks it as selected and writes to parameter file.
    - If not, skips (or deletes in the case of empty orders).
5. **Special features/extended logic** for card processing, external invoicing, and deposit checks.
6. **Exit**: User can leave at any time (F3), or program stops at completion.

---

## Modern Considerations

- **Old-style RPG:**  
  Uses RPG/400 (fixed-form C specs), with some newer ILE features and embedded free-form (DCL-S, etc.) appearing for recent changes.

- **Refactoring Opportunity:**  
  Could be rewritten in fully free-form RPG for better maintainability, with procedures and service programs instead of subroutines and tags.

- **Extensibility:**  
  The program is designed to be easily extended for new selection or processing criteria as business needs develop.

---

## Getting Started

- **Familiarize with the files** (order header, line, type, customer, etc.) and their keys.
- **Understand the extraction logic**, especially as it relates to business requirements (what "picking" an order means in your organization).
- **Note the business rules** scattered throughout, as these dictate what orders are allowed to be processed in various contexts.
- **Run/Debug** with sample data to follow the flow for each extraction/selection method.

---

## Conclusion

The program is a central tool for batch/order selection in a sales, logistics, or manufacturing ERP system, with robust business rule enforcement and deep file integration. While the code is complex due to its business needs and longevity, its modular design and comprehensive commenting make it approachable for seasoned RPG developers.