# RPG Program Explanation (AA010R)

This program, written in ILE RPG (also known as RPG IV), is used for **maintenance of output queues/devices** (utk√∏er/enheter) within a system, possibly related to print queue or printer device management. It is a classic green-screen, subfile-driven application, supporting add, change, delete, view, copy, and start/stop operations for entities.

---

## 1. **Header and Program Setup**
- **H-Spec**: `option(*nodebugio)` disables debug I/O; `datedit(*dmy)` sets date editing to day/month/year format.
- **Comment Block**: Outlines program revisions, version history, and usage instructions, especially about indicator usage.

---

## 2. **File Declarations (F-Specs)**
- **faenhl1, faenhl2, faenhlr, faenhlu**: Four database files (with record-level access), each accessing the same physical file (`aenhpfr`) but using different record formats (for different purposes).
- **faa010d**: Display file for user interface, uses a subfile (`b1sfl`) and an info data structure (`dspfbk`) for display feedback.

---

## 3. **Data Definitions (D-Specs)**
- **Arrays/Constants**
  - `a_meld`: Message array.
  - `c_sfil`: Constant for subfile page size (14).

- **User Data Structure / LDA**
  - `l_user`, `l_sbib`: Offsets for values retrieved from the local data area (LDA).

- **Display Feedback DS**
  - `dspfbk`: Holds feedback from display (such as cursor position).

- **Key Variables**
  - For each database file access, variables are created to store key values, simplifying SETLL/CHAIN.

- **Working Variables**
  - Variables for subfile management (first/last record, page size, etc.), and fields for batch operations.

- **Flags and State**
  - `w_seqe`, `b_oppr`, `b_forn`, `b_anul`, `b_feil`, etc.: Various operational flags.

---

## 4. **Indicator Usage**
- RPG indicators (`*INnn`) are classic RPG's boolean variables, widely used for function key status, error states, display attributes, etc.

---

## 5. **Main Logic (C-Specs)**

### **Main Tag Loop**
- **b2taga**: Main entry point after writing the command screen.
- **b2tagb**: Main user interaction loop with subfile.
- Handles display of subfile, processes function key actions, and manages subfile navigation and positioning.

### **Function Key Handling in Main Loop**
Handles different function keys:
- **Exit (F3/F12):** Go to `avslutt` to end the program.
- **F5:** Refresh subfile (`forny` subroutine).
- **F9:** Start all queues/printers.
- **F6:** Add new entry (`xc1bld` subroutine).
- **Page Up/Down (F10/F11):** Subfile paging.
- **Home key (F21):** Cursor positioning.

### **Subfile Operations**
- **forny**: Refreshes subfile based on current position; preserves paging state.
- **posisjoner**: Repositions subfile based on user input (by key or description).
- **subfile**: Iterates over subfile records for user actions: change, copy, delete, view, start.

---

## 6. **Subroutines for CRUD and UI Logic**

### **Add New Row (`xc1bld`)**
- Initiates add mode, displays entry screen (`c1bld`).
- Checks for existing record; if found, shows message (`xc1msg`).
- If not found, invokes edit logic (`xc2bld`) to add new record.

### **Edit/View Row (`xc2bld`)**
- Loads data for editing/viewing (`c2bld`).
- On save, updates or adds the relevant database record.

### **Delete Row (`xd1win`)**
- Displays delete confirmation window.
- On confirm, deletes the selected record from the database.

### **Copy Row (`xk1win`)**
- Displays copy window.
- Ensures target key is not blank or duplicate, then invokes edit logic to add the copied entry.

### **Additional Info (`xc3win`)**
- Shows window for additional information.

---

## 7. **Subfile Maintenance**

### **clr_subfile**
- Clears ("empties") the subfile.

### **crt_subfile**
- Reads records from the database and fills the subfile to display a page of data.

### **bck_subfile**
- Handles paging backward (Page Up).

### **dsp_subfile**
- Manages display and feedback for the subfile.

---

## 8. **Program Calls**
- **call_pgm**: Calls a program (`AE702C`) to start/stop printer/device with provided parameters.
- **start_alle**: Calls `AA007R` (confirmation window), and if confirmed, calls `AE700R` to start all queues/printers.

---

## 9. **Initialization (`*inzsr`)**
- Sets up key lists for database access.
- Initializes default screen state and positions database for initial subfile fill.

---

## 10. **UX/Screen Handling**
- Several display file (DSPF) formats are referenced: `b1sfl` (subfile), `b2ctl` (subfile control), `b2cmd` (command keys), plus various windows (`c1bld`, `c1msg`, `c2bld`, `d1win`, `k1win`, `c3win`) for different operations or data entry.

---

## 11. **Noteworthy Features**
- **Subfile paging**: Handles view/page up/down, refresh, and position.
- **Comprehensive keyboard handling**: Function keys, cursor position, error/message indicators.
- **Supports add, change, copy, view, delete, and batch start functions**.
- **Database access**: SETLL, CHAIN, READE, READP, DELETE, and UPDATE are used for row navigation and manipulation.

---

## 12. **Summary Table**:

| Function        | Subroutine/Label | Description                                |
|-----------------|------------------|--------------------------------------------|
| Add new entry   | `xc1bld`         | Displays add window, creates if unique     |
| Edit/view entry | `xc2bld`         | Displays edit/view window, updates record  |
| Delete entry    | `xd1win`         | Displays delete confirmation, deletes      |
| Copy entry      | `xk1win`         | Displays copy window, validates uniqueness |
| Batch start     | `start_alle`     | User confirms; starts all via program call |
| Subfile paging  | `crt_subfile`, `bck_subfile` | Next/previous page                |
| Refresh         | `forny`          | Refreshes the subfile page                |
| Position        | `posisjoner`     | Repositions subfile to a key or desc      |

---

## 13. **Typical User Flow**
1. **Program starts**: Subfile page displays with current output queues/devices.
2. **User navigates** (page up/down, position by key/description).
3. **User chooses action**: Add (F6), Change, Copy, Delete, View, or Start (via row options or function keys).
4. **Subroutines handle all validations, database updates, and UI feedback.**
5. **User exits (F3/F12)**: Program ends.

---

## 14. **Indicator Legend (from comment)**
- LR  = End program
- 10  = Rollup (PageDown)
- 11  = Rolldown (PageUp)
- 12  = Sfldsp (Display subfile)
- 13  = Sfldspctl (Display subfile control)
- 14  = Sflclr (Clear subfile)
- 15  = Sflend (End of subfile)
- 21  = Home-key
- 22  = Cursor placement
- 30  = Field protect (view mode)
- 31-79 = Error/message indicators
- 80-99 = Work indicators

---

# **Summary**

This RPG program exemplifies classic subfile-driven maintenance on IBM i (AS/400) using procedural RPG IV. It demonstrates robust management of a list of entities (output queues/printers/devices) with paging, search/position, add/change/delete/copy/view, and batch operations, using heavy indicator-based screen and logic control and database key management. All critical UX and database flows are handled via modular subroutines, with strong attention to validation and workflow.

This structure is very common in administrative applications on IBM i, and new developers should familiarize themselves with:
- Subfile mechanics (paging/filtering)
- Indicator-driven screen logic
- Key list (KLIST/KFLD) usage for indexed access
- Function key and option handling
- Classic C-spec subroutines and control flow (`goto`, `leave`, `iter`, etc.)

**Tip:** For onboarding, start by understanding the subfile lifecycle (`clr_subfile`, `crt_subfile`, paging), then follow how the edit/copy/delete subroutines interact with the database and UI. The rest of the code leverages these patterns consistently for robust administrative data maintenance.