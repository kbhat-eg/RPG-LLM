# RPG Program Explanation: SB210R - Budget Register Maintenance

## Overview

This RPG/400 (ILE RPG) program, SB210R, is part of the ASSTAT system and is designed for maintenance of the budget register (Norwegian: "Vedlikehold av budsjett-register"). It is a classic green-screen IBM i (AS/400) interactive program with subfile handling and multiple database accesses.

#### Key Functions:
- Display and maintenance of budget records in a subfile
- Filtering/query capabilities by various key fields (department, warehouse, order type, etc.)
- Drill-down to view and compare yearly balances/budget figures in a matrix display
- Dynamic headers and column definitions depending on user actions
- Integration with other master data tables for texts/descriptions (e.g., customer, group, item)

---

## Program Structure and Main Sections

### Control and Header

```rpg
h datedit(*dmy.) option(*nodebugio)
```
- Date fields are edited as day-month-year.
- Debug I/O is not generated for this program.

### File Declarations

**Workstation file (green-screen):**
```rpg
fSB210d    cf   e             workstn sfile(b1sfl:srrn01)
```
- Uses a workstation display file with a subfile (`b1sfl`) and subfile record number (`srrn01`).

**Physical and Logical Files for Master Data:**
```rpg
fskakl1    if   e           k disk    rename(skakpfr:skakl1r)
...
```
- Multiple input files, each representing different master data (customers, item groups, order types, etc.), with record format renaming.
- Example: `skakl1` could be budget register lines, `skbul1` budget balances, etc.

### Variables and Arrays

**Text/Message/Command Arrays:**
```rpg
d mld             s             11    dim(4) ctdata perrcd(1)
d txt             s             25    dim(8) ctdata perrcd(1)
d cmd             S             18    dim(14) ctdata perrcd(1)
d rpt             s             15    dim(60) ctdata perrcd(1)
```
- Used for messages, column headers, commands, and sort order descriptions.

**Budget Matrices:**
```rpg
d isa             s              9  0 dim(12)
d ssa             s             11  2 dim(12)
d san             s             11  2 dim(12)
```
- Arrays for holding balances/budget figures per month (12 months).

**Key Structures and Working Fields:**
- Numerous `like()` and field structures for keys to provide type safety and avoid hardcoding field lengths.
- Fields such as `w_...` are working fields for keys, filtering, and display.

---

## Main Logic and Functionality

### Subfile Control Flow

The program is primarily a subfile (paged list) display with options for drill-down and maintenance.

- **b2taga:** (Main loop/tag) Handles display and navigation.
- **Write b2cmd:** Initially display command keys.
- **b2tagb:** Main data handling (exsr xdsp01).
- **Exit/Return:** Handles program ending and return to menu.

#### Key PF-keys ("Function keys") Handling

- PF3 (F3): Exit (sets *INLR = *ON; program return).
- PF5/PF6 (F5/F6): Previous/Next year navigation.
- PF9: Edit columns.
- PF24: More command keys.

### Subfile Filling and Paging

- **xclr01:** Clear subfile, reinitialize page.
- **xcrt01:** Read through relevant master file (`skakl1`) and fill subfile up to one "page" (10 records at a time).
- **xdsp01:** Display the subfile (exfmt b2ctl) and set relevant indicator lights.

### Drilldown/Details View

- Subfile contains options (5=Display/Post view) for the user to view/edit a detailed yearly matrix for the selected record.
- **xc5bld:** Build and display detail image for a selected record, including:
  - Dynamic column setup (headers, years)
  - Column content population from budget matrices
  - Percent deviation calculation between two column values (e.g., actual/budget comparison).

### Dynamic Column/Matrix Display

- Users can dynamically choose what each of the four columns in the matrix represents (balance/budget/sales/other).
- Year navigation is handled by incrementing/decrementing year variables.

### Headings and Texts

- Dynamic header assignments for columns and field descriptions using text arrays (`txt`, `rpt`, etc.)
- Data for columns is picked up from master data files or via called programs (for descriptions).

### Filtering and Key Building

- The user can filter the subfile and matrix by various keys (department, order type, customer, etc.).
- Key lists (`klist`) are defined for easily building/chaining records in underlying physical/logical files.

### Master Data Lookups

- For text/descriptions, the program reads from or calls out to other tables or *programs* (like `RS707R`, `RS710R`, etc.) for value lookups (e.g., get department name from code).

---

## Detailed Subroutines

### hnttxt

- Given a key code, fetches and composes a descriptive text for the corresponding entity (department, customer, group, etc.) for display in the subfile.

### hntarr

- Based on working code variables, assigns the code numbers to r1, r2, r3 (used for determining which fields are active/displayed).

### xclr01

- Resets subfile page controls and clears page fields.

### xcrt01

- Fills the subfile with records from the main file, applying current filters and filling in associated texts.

### xdsp01

- Handles the display of the subfile page and relevant indicators.

### xc5bld

- Handles detailed view/edit screen logic, including navigation by year and column assignment.

### xc5les

- Reads the relevant files and "loads" the detail screen with the values of up to 4 columns (typically years), including populating headings, values, and totals.

---

## Initialization

- The program receives its filtering parameters from the calling program via a parameter list (`*ENTRY PLIST`).
- Sets up all configuration: years, display headers, key values, and default selections for columns, filters, and commands.

---

## Tables

The last section of the source contains data tables (embedded in source, for compile time), for:
- Action codes (New, Change, View, etc.)
- Column headings (Balance, Budget, Sales, etc.)
- Command key descriptions (F3=Exit, F5=Prev Year, F9=Edit, etc.)
- Sort order labels (Department, Warehouse, Order type, etc.)

---

## Data Flow Summary

1. **Startup:** Receives initial key values and configuration (department, version, type of value, etc.).
2. **Subfile Display:** Lists filtered budget lines with dynamic texts.
3. **User Interaction:** User may select a record for drill-down, navigate, or change columns/years.
4. **Drill-down:** Loads matrix (months x years/columns) and compares values, including calculating percent deviations.
5. **Text Integration:** For every key type (department, group, customer...), program fetches description for display.

---

## Legacy Notes

- Uses classic RPG/400 cycle and fixed-form syntax.
- Heavy use of subfiles, program-to-program calls for text lookups, and key field structures.
- Uses indicator variables (`*INxx`) for flow control, function key processing, and screen state.

---

## Onboarding Tips

- **Understand the model:** The program is record-oriented (subfiles) with master file integration typical of IBM i systems.
- **Pay attention to indicators:** Much of the flow is controlled using indicator variables (`*INxx`), which may impact understanding for those new to RPG.
- **Master data integration:** Integrates with several master files using `CHAIN` and key fields for lookups.
- **Drilldown and navigation:** Users may navigate years, assign data columns, and view detailed matrices.
- **Tables/arrays:** Array data is loaded at compile time and used for labels, command descriptions, and header texts.

---

## Conclusion

This program is a robust, if traditional, green-screen application for multi-dimensional budget analysis and maintenance, relying on RPG/400 features such as subfiles, indicators, and key lists. It is highly dynamic in display and navigation, with significant code dedicated to user-friendly presentation and integration with master data. It is an excellent example of legacy business application logic on the IBM i platform.