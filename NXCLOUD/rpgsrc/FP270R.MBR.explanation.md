# FP270R Program Documentation

## Overview

**Program Name:** FP270R  
**System:** ASLAGR  
**Description:**  
This program handles the maintenance of parameters and the printing of package (kolli) labels. It is primarily concerned with managing order-related package information, updating order lines, and integrating with transport/logistics systems when necessary.

The business domain is order management for a warehouse/distribution environment, with specific attention to how items are packed and shipped (e.g., pallets, timber, others). The program supports integration with external transport management systems.

---

## File Dependencies

The program uses several physical and logical files, renamed for local use:

- **fohel1** (Order header, renamed from `fohepfr:fohel1r`)
- **fodtlr** (Order lines, renamed from `fodtpfr:fodtlrr`)
- **fodtl1** (Order lines, renamed from `fodtpfr:fodtl1r`)
- **fodtlu** (Order lines update, renamed from `fodtpfr:fodtlur`)
- **rkunl1** (Customer master, renamed from `rkunpfr:rkunl1r`)
- **ftrpi2, raf2l1, ftrli1** (Transport/flow control, only used if transport integration is enabled)
- **fp270d** (Display file for workstation interaction)

---

## Data Structures and Key Variables

- **Local Data Area**: Used for session/user context (user, firm, etc.).
- **Key Variables**: For accessing order headers, lines, and customer data.
- **d_line DS**: Used to parse and handle label line information (type, count, text).
- **Work Variables**: For handling current firm, line, quantities, types, etc.
- **Integration Flags**: `u_802` indicates if external transport/flow integration is active.

---

## External Program Interfaces

- **CO402R**: Checks if external flow control (flåtestyring) is enabled.
- **FO500R**: Used to search for an order number.
- **FP270C**: Handles the actual printing of package labels.
- **AP058R**: Sends updates to the transport/logistics integration (if enabled).

---

## Main Processing Flow

### 1. Initialization (`*inzsr`)
- Receives order number and suffix as parameters.
- Initializes key lists for file access.
- Sets current firm from LDA.
- Checks if external flow control is enabled by calling `CO402R`.
  - If enabled, sets `u_802` flag.

### 2. Main Loop (Screen Handling)

#### a. Data Retrieval
- Resets display/input fields.
- Chains to order header (`fohel1`) and retrieves customer and order details.
- If customer exists, fetches customer address from `rkunl1`.
- **Special Rule (8.01):** If multiple customer roles are present (item customer, invoice customer, project customer), ensures item customer is shown on the screen.

#### b. Existing Package Info
- Reads all lines (from `fodtlr`) with special line numbers (9000 – timber, 9001 – pallet, 9002 – other) to retrieve existing package label info.

#### c. Screen Display
- Presents the screen (`exfmt a1bld`).
- Handles function keys:
  - **F3**: Exit program.
  - **F4**: (Commented out) Would call another program to get order number.
  - **F10**: Calls `FO500R` to search for order number.

#### d. Validation
- Checks for incomplete input (e.g., text entered but no quantity).
- Sets error indicators for missing required fields.

#### e. Label Printing (F6)
- For each package type (timber, pallet, other), updates or creates the corresponding order line in `fodtlu` (line numbers 9000, 9001, 9002).
- Calls `FP270C` to print labels.

##### Transport Integration (if enabled)
- If external transport/flow control is active:
  - Calculates total number of packages (`w_akol`).
  - If new packages have been added, calls `AP058R` to update the transport system.

---

## Subroutines

### `ny_linje`
- Creates a new order line in `fodtlu` for the given package type and quantity.
- Formats the label text according to business rules (quantity formatting varies for single vs. double digits).
- Sets audit fields (date, time, user).

### `opd_linje`
- Updates an existing order line with new quantity or text.
- Updates audit fields.

---

## Business/Domain-Specific Logic

- **Special Line Numbers:**  
  - 9000: Timber (Trelast)  
  - 9001: Pallet (Pall)  
  - 9002: Other (Andre)  
  These are reserved in the order line file for storing package label info.

- **Customer Role Display Logic (8.01):**  
  If an order has multiple customer roles, the item customer (varekunde) is prioritized for display.

- **Label Text Formatting:**  
  The label text for each package type is carefully formatted to align with PDA output and ensure consistency.

- **Flow Control/Transport Integration (from 8.02 onwards):**  
  The program can interact with an external system to manage transport requests. This is enabled based on a value retrieved from `CO402R` and only triggers if package quantities have increased.

- **Audit/Logging:**  
  All changes to order lines are timestamped and attributed to the current user.

---

## Design Patterns & Conventions

- **Use of Data Structures:**  
  The program uses a data structure (`d_line`) for parsing and constructing label lines, which helps with consistent formatting and parsing.

- **Key Lists:**  
  RPG key lists are used extensively for file access, ensuring clear, maintainable file I/O.

- **Conditional Integration:**  
  All transport/logistics integration logic is guarded by a flag (`u_802`), allowing the program to run in environments both with and without external transport integration.

- **Screen Handling Loop:**  
  The main logic is structured around a screen-handling loop, typical for interactive RPG programs.

- **Version Tracking:**  
  The program is heavily commented with change logs, version numbers, and references to business requirements.

---

## Relationships with Other Modules

- **Order Header/Line Files:**  
  This program assumes the existence and structure of standard order header and line files, and it both reads and updates these as part of its workflow.

- **Customer Master:**  
  Used for retrieving display information about customers related to an order.

- **Transport/Flow Control Files:**  
  If transport integration is enabled, additional files are used to manage flow control and transport status.

- **External Programs:**  
  Interacts with several other programs for validation, order searching, label printing, and transport integration.

---

## Noteworthy Implementation Details

- **Handling of Numeric Input:**  
  The program checks that certain fields (like the package count) contain only digits before processing.

- **Overlay/Parsing Techniques:**  
  Uses RPG overlays and string manipulation to extract numeric values from fixed-format fields.

- **Internationalization:**  
  Some comments and business descriptions are in Norwegian, reflecting the original business context.

- **Backward Compatibility:**  
  Several code sections are commented out but retained for reference, showing careful management of evolving requirements.

---

## Summary

**FP270R** is a specialized order management utility for handling package label printing and (optionally) integrating with external transport/flow control systems. It is tightly coupled to the order entry and fulfillment process, with a focus on accurate tracking and communication of how goods are packed for shipment. The program is extensible and designed for environments where both manual and automated logistics processes may be in use.