# RF105R – Splitting of Registered Transactions

## Purpose

This program, **RF105R**, is responsible for splitting and transforming registered financial transactions (posteringer) from an input file into detailed accounting postings, distributing them into the appropriate accounts (general ledger, customer, supplier) and outputting them to a journal file. It also handles related business logic such as currency conversion, due date calculation, and special handling for cash discounts (kontantrabatt).

The program is part of the ASOKON system and is a core component in the financial transaction processing pipeline. It is typically invoked as a batch job after transactions are registered and before final ledger updates.

---

## High-Level Structure

- **Input Files**: Reads from a set of master and transaction files (e.g., rtripf, rhovl1, rkunl1, rlevl1, etc.), each representing different aspects of the company’s chart of accounts, customers, suppliers, and configuration.
- **Output File**: Writes to `rjoupf` (the journal output file).
- **Subroutines**: The program is structured with subroutines (BEHSR) for account handling, due date calculation, moving data to output, and special handling for cash discounts and text retrieval.
- **Control Flow**: The main loop reads each transaction, determines the nature of the posting (debit/credit, account type), applies business rules, and writes the appropriate output records.

---

## Domain-Specific and Business Logic

### 1. **Transaction Splitting**

- Each input transaction (`rtripf`) may result in multiple output postings, depending on whether it has both debit and credit entries, and whether cash discounts apply.
- The program distinguishes between:
    - **General Ledger (Hovedbok) postings**
    - **Customer (Kunde) postings**
    - **Supplier (Leverandør) postings**

### 2. **Account Type Determination**

- The account number range determines the posting type:
    - `<= ra1hkt`: General Ledger
    - `> ra1hkt and <= ra1hrs`: Customer
    - `> ra1hrs`: Supplier

### 3. **Currency Handling**

- If a posting is in a foreign currency, the program looks up the relevant currency rate (`ra16l1`) and calculates the local amount accordingly.
- Both the value in foreign currency and the calculated local currency amount are written to the output.

### 4. **Due Date Calculation**

- For customer and supplier postings, if the due date is not set, the program calls an external program (`RÅ703R`) to calculate it based on company rules and payment terms.
- Special handling is implemented for "general note" customers (Mestergruppen), ensuring credit notes have the same due date calculation as invoices.

### 5. **Cash Discount (Kontantrabatt) Handling**

- Accumulates cash discounts for both customers (`wkkrab`) and suppliers (`wlkrab`).
- At period or company break, writes out a separate posting for the accumulated discount using specific accounts from configuration (`radk07` for customers, `radk16` for suppliers).

### 6. **Project and Department Control**

- If the account does not allow project or department assignment (as per master data), the corresponding fields in the output are blanked.

### 7. **Logging and Special Features**

- Logging can be enabled via a configuration flag (checked by calling `CO402R`).
- Special handling for specific clients or scenarios, toggled via flags also set by `CO402R`.

---

## Key Design Decisions and Patterns

- **Use of Subroutines**: All business logic is encapsulated in subroutines, making the code modular and easier to maintain.
- **Key Lists**: Keys for file access are defined and reused, ensuring consistent and efficient data retrieval.
- **Break Handling**: The program detects changes (breaks) in company or period and executes the necessary closing logic (e.g., writing out accumulated discounts).
- **Conditional Processing**: Many business rules are conditional on account type, transaction type, or configuration flags.
- **External Program Calls**: For due dates and configuration, the program relies on external programs, allowing business rules to be maintained outside the core logic.
- **Versioned Enhancements**: The codebase is annotated with version tags (e.g., `T5.30`, `7.01`) documenting enhancements and bug fixes, which is important for traceability and maintenance.

---

## Data File Relationships

- **rtripf**: Input transaction file (posteringer).
- **rjoupf**: Output journal file (split transactions).
- **rhovl1**: General ledger account master.
- **rkunl1**: Customer master.
- **rlevl1**: Supplier master.
- **raa1l1, raa4l1, ra04l1, ra05l1, ra11l1, ra14l1, ra16l1, ra01l1**: Various configuration and code registers (e.g., account ranges, currency rates, fixed accounts, VAT codes, posting text).

---

## Notable Subroutines

### `flytt_ut`
- Moves fields from the input record to the output structure, applies currency conversion if necessary, and sets up sorting fields.

### `beh_debet` / `beh_kredit`
- Handles the logic for debit and credit postings, respectively, including account type determination and sign adjustments for credits.

### `beh_kunde` / `beh_lever`
- Handles postings to customer and supplier accounts, including due date calculation and writing postings to the output.

### `beh_hovbok`
- Handles general ledger postings, including VAT logic and project/department validation.

### `beh_krab`
- Writes out accumulated cash discount postings for both customers and suppliers at period/company break.

### `hnt_konto`
- Looks up the general ledger account master, with fallback logic if specialized account/department combinations are not found.

### `hbiltxt`
- Retrieves posting text from the code register for a given voucher code.

---

## Integration with Other Modules

- **External Programs**:
    - `RÅ703R`: Calculates due dates for invoices/credit notes.
    - `CO402R`: Reads configuration flags for logging and special business logic.
    - `AB700R` / `AB705R`: Handles job logging if enabled.
- **Master Data**: Relies on up-to-date configuration and master data files for accurate processing (e.g., account ranges, currency rates, payment terms).

---

## Conventions and Non-Obvious Aspects

- **Break Handling**: The program is sensitive to changes in company or accounting period, ensuring that cash discounts and other period-end logic are handled correctly.
- **Field Naming**: Many fields are abbreviated and reflect Norwegian business terminology (e.g., `rjmvak` for VAT code, `rjpros` for project, `rjavde` for department).
- **Zeroing and Blanking**: The system uses both zero and blank values for field resets, depending on field type and business meaning.
- **Sorting**: Output records are sorted using a composite key built from company, year, period, type, batch, line, etc., to ensure correct journal order.
- **Version Control in Code**: Inline comments and code blocks are versioned, reflecting a long-lived and actively maintained codebase.

---

## Change History and Commentary

- The program has evolved to handle multiple companies, currency enhancements, project/department validation, improved logging, and customer-specific rules.
- All changes are documented in the header, with references to the responsible developer and a brief description.

---

## Onboarding Recommendations

- **Familiarize yourself with the master and configuration files**: Understanding their structure and content is crucial, as much of the program’s logic depends on accurate master data.
- **Review external programs (`RÅ703R`, `CO402R`)**: These encapsulate important business rules for due date calculation and configuration.
- **Pay attention to versioned code**: When modifying or debugging, check which enhancements or bug fixes are relevant to your task.
- **Understand the batching and break logic**: Many errors can arise if period or company breaks are not handled as intended.

---

## Summary

RF105R is a critical batch program for transforming registered transactions into detailed journal postings, with comprehensive business logic for account splitting, currency, due dates, cash discounts, and integration with master data and external configuration. The code is modular, well-annotated, and designed for maintainability in a multi-company, multi-currency environment.