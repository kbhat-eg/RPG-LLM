     H/TITLE  Faktura-journal til Ikas Kreditsystemer
     H DECEDIT('0,') DATEDIT(*DMY.) option(*nodebugio : *srcstmt)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Program . . . . : FO678R
      * Beskrivelse . . : Faktura-journal til Ikas Kreditsystemer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
6.nu  *  6.nu 160316 BKV  Programmet gjennomgått mtp nummerutvidelser.
6.n2  *  6.nu 290917 BKV  Nummerutvidelser fix
6.01  *  6.00 220218 BKV  Utivdet med 12 siffer faktnr og 6 siffer kundekat
9.01  *  9.01 311008 AMD  Det er et ønske om å kunne få ut kort kid i
      *                   filen som de mottar.  Styrer dette ved hjelp
      *                   av koden i rutineregisteret
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     FSOHEL1    IF   E           K DISK    RENAME(SOHEPFR:SOHEL1R)
     FSOHELU    IF   E           K DISK    RENAME(SOHEPFR:SOHELUR)
     Frkunl1    IF   E           K DISK    rename(rkunpfr:rkunl1r)
     FAFORL1    IF   E           K DISK    RENAME(AFORPFR:AFORL1R)
      *
     FRE0IPF    O  A E           K DISK
      *
      * Definering av array
      *
     DTLFI             S              1    dim(11) ctdata perrcd(1)
     DTLFU             S              1    dim(11) ctdata perrcd(1)
      * - - - - - - - - - - - - - -
      * Datastruktur parameter-inn
      * - - - - - - - - - - - - - -
      *
     D                 DS
6.nu D  DSPARM                 1     32
     D  DSAARR                 1      4  0
     D  DSOTYP                 5      6
6.nu D  DSFFNR                 7     14  0
6.nu D  DSTFNR                15     22  0
6.nu D  DSPROG                23     32
     D                 DS
     D  WPCIN1                 1    256
     D  WPCIN2               257    512
     D  IKKUND                 1      6  0
     D  IKFAKT                 7     12  0
     D  IKREFR                13     27
     D  IKNAVN                28     57
     D  IKADR1                58     87
     D  IKADR2                88    117
     D  IKPONR               118    121
     D  IKSTPN               122    125
     D  IKSTED               122    151
     D  IKSTUP               126    151
     D  IKORGN               152    162
     D  IKTLFP               163    172
     D  IKTLFA               173    182
     D  IKFKDA               183    188  0
     D  IKFFDA               189    194  0
     D  IKRNTE               195    198  0
     D  IKFTGN               199    199
     D  IKBELØ               199    208  2
     D  IKTEXT               209    238
     D  IKMOTP               239    244
     D  IKSLGR               245    247
     D  IKKPRS               248    277
     D  IKKKID               278    302
6.01 D  IKTOM1               303    357
6.01 D  IKTOM2               358    361  0 INZ(*ZEROS)
6.01 D  IKFAK2               362    369  0
6.01 D  IKTOM3               370    371  0 INZ(*ZEROS)
6.01 D  IKKUNK               372    375  0
     D                 DS
     D  DSKKID                 1     21
     D  DSKFIR                 1      3  0
     D  DSKKUN                 9     14  0
     D  DSKFAK                15     20  0
     D  DSKKUS                 1     20
     D  DSKMOD                21     21  0
      *
      * - - - - - - - - - - - - - -
      * Henter inn data fra LDA
      * - - - - - - - - - - - - - -
      *
     D                UDS
     D  DSRUTI               800    809
     D  DSALIN               856    858  0
9.01 D  DSKIDK               883    883  0
     D  DSWSID               901    910
     D  DSUSER               911    920
     D  DSFIRM               944    946  0
     D  l_fnav               951    980
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Definering av formater                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      * Benyttede formater
      * - - - - - - - - - -
      *
      * A1HDR  - Heading på rapporten
      * A1DET  - Linjer  på rapporten
      * T1TOT  - Totaler på rapporten
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Styre-rutine                                                    *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      * Initierings-rutine
      *
     C     FCYCLE        CASEQ     *ZERO         XSTRSR
     C                   ENDCS
      *
      * Behandle ordrehode
      *
     C     *IN61         DOWEQ     *OFF
     C     SOFIRM        CABNE     WWFIRM        XFERDI                         Nytt firma
     C     SOAARR        CABNE     DSAARR        XFERDI                         Nytt år
      *
     C     DSFFNR        IFEQ      *ZERO
     C     DSTFNR        IFEQ      *ZERO
     C     SOJOUR        IFEQ      1
     C                   GOTO      XTAG02
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
      *
     C     DSFFNR        IFEQ      *ZERO
     C     DSTFNR        IFEQ      *ZERO
     C     SOJOUR        IFEQ      0
     C                   GOTO      XTAG01
     C                   ENDIF
     C                   ENDIF
     C                   ENDIF
      *
     C     SOBINR        CABGT     DSTFNR        XFERDI                         Tilnr. passert
      *
     C     XTAG01        TAG
      *
     C                   EXSR      XAJOUR
     C**                 EXSR      XPRINT
     C                   MOVE      WPCIN1        RPCIN1
     C                   MOVE      WPCIN2        RPCIN2
     c     IKBELØ        IFNE      *ZEROS
     C                   WRITE     RE0IPFR
     c                   ENDIF
      *
     C     XTAG02        TAG
      *
     C                   READ      SOHEL1                                 61
     C                   ENDDO
      *
     C     XFERDI        TAG
     C**                 WRITE     T1TOT                                30
      *
      * Ferdig
      *
     C     XSLUTT        TAG
     C                   SETON                                        LR
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Henter/Oppdatering av NUMMER-REGISTER                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     HNTNUM        BEGSR
      *
     C                   MOVE      'FJOURN'      WPFELL
     C                   MOVE      *BLANK        WPTYPE
     C                   MOVE      *BLANK        WPFAST
      *
      *  Kaller opp subprogram for henting av nummer fra NUMMER-REGISTER
      *
     C                   CALL      'AS100R'
     C                   PARM                    WPKODE
     C                   PARM                    WWFIRM
     C                   PARM                    WPFELL
     C                   PARM                    WPTYPE
     C                   PARM                    WPFAST
     C                   PARM                    WPNUMM
      *
     C                   ENDSR
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * XAJOUR Klargjør data for print                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XAJOUR        BEGSR
      *
     c                   eval      ikfkda = *zeros
     c                   eval      ikffda = *zeros
      *
      * Snu fakturadato
      *
     c                   if        sofkda <> *loval
     c     *dmy          move      sofkda        ikfkda
     c                   endif
      *
      * Snu forfallsdato
      *
     c                   if        soffda <> *loval
     c     *dmy          move      soffda        ikffda
     c                   endif
      *
      * Hente inn kunderegister
      *
     C                   MOVE      SOKUND        WWKUND
     C     KEY04         CHAIN     rkunl1r                            64
     C                   MOVE      RKNAVN        IKNAVN
     C                   MOVE      RKGATE        IKADR1
     C                   MOVE      RKADR2        IKADR2
     C                   MOVE      RKPONR        IKPONR
     C                   MOVE      RKSTED        IKSTED
     C     IKPONR        IFEQ      IKSTPN
     C                   MOVE      *BLANK        WKSTED
     C                   MOVEL     IKSTUP        WKSTED
     C                   MOVE      WKSTED        IKSTED
     C                   ENDIF
     C                   MOVEL     RKFTNR        IKORGN
     C     RKFTNR        IFEQ      *ZEROS
     C                   MOVE      *BLANK        IKORGN
     C                   ENDIF
     C**                 MOVE      RKTLFX        IKTLFP
     C                   MOVEA     RKTLFN        TLFI
     C                   MOVE      *BLANK        TLFU
     C                   Z-ADD     1             X
     C                   Z-ADD     1             Y
     C     X             DOUEQ     11
     C     TLFI(X)       IFNE      *BLANK
     C                   MOVE      TLFI(X)       TLFU(Y)
     C                   ADD       1             Y
     C                   ENDIF
     C                   ADD       1             X
     C                   ENDDO
     C                   MOVEA     TLFU          WTLFU
     C                   MOVEL     WTLFU         IKTLFA
     C                   MOVE      1200          IKRNTE
     C                   MOVEL     RKSLGR        IKSLGR
     C     RKSLGR        IFEQ      *ZEROS
     C                   MOVE      *BLANK        IKSLGR
     C                   ENDIF
     C                   MOVE      RKPERS        IKKPRS
      *
      * Øvrige felter
      *
     C                   MOVE      SOBINR        IKFAKT
6.01 C                   MOVE      SOBINR        IKFAK2
6.01 C                   MOVE      RKKATG        IKKUNK
     C**                 MOVE      SONUMM        A1NUMM
     C**                 MOVE      SOSUFF        A1SUFF
     C**                 MOVE      SOOTYP        A1OTYP
     C                   MOVE      SOKUND        IKKUND
     C                   MOVEL     SODREF        IKREFR
     C**                 MOVE      SONAVN        A2NAVN
      *
     C                   Z-ADD     SOFSUM        IKBELØ
     C**                 ADD       SOFSUM        T1FSUM
     C     IKBELØ        IFLT      *ZEROS
     C                   Z-SUB     IKBELØ        IKBELØ
     C                   MOVE      '-'           IKFTGN
     C                   ENDIF
      *
      * Oppdater historisk faktura-register dersom
      * fra - til - nummer ikke er oppgitt og posten
      * ikke har vært med på journal tidligere.
      *
     C**   DSFFNR        IFEQ      *ZERO
     C**   DSTFNR        IFEQ      *ZERO
     C**   SOJOUR        IFEQ      *ZERO
     C**                 MOVE      SOBINR        WWBINR
     C**                 MOVE      SONUMM        WWNUMM
     C**                 MOVE      SOSUFF        WWSUFF
     C**   KEY01         CHAIN     SOHELUR                            61
     C**   *IN61         IFEQ      *OFF
     C**                 MOVE      1             SOJOUR
     C**                 UPDATE    SOHELUR
     C**                 ENDIF
     C**                 ENDIF
     C**                 ENDIF
     C**                 ENDIF
9.01  *  BEREGN KID
9.01  **                 MOVE      *ZEROS        DSKKID
9.01  **                 MOVE      DSFIRM        DSKFIR
9.01  **                 MOVE      IKKUND        DSKKUN
9.01  **                 MOVE      IKFAKT        DSKFAK
9.01  **                 MOVE      DSKKID        WPKID            25
9.01  **                 CALL      'ASMD10'
9.01  **                 PARM                    WPKID
9.01  **                 MOVE      WPKID         IKKKID
9.01  *
9.01  *  Legger ut KID fra historisk fakturaregister,
9.01  *  kort eller lang avhengig av kode i rutineregister
9.01  *
9.01 c                   move      *blank        IKKKID
9.01  *
9.01 c                   if        dskidk = 1
9.01 c                   movel     sokidd        WRKKID           21
9.01 c                   move      wrkkid        IKKKID
9.01 c                   endif
9.01  *
9.01 c                   if        dskidk = 2
9.01 c                   move      sokidr        IKKKID
9.01 c                   endif
      *
     C                   ENDSR
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for oppstart                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     XSTRSR        BEGSR
      *
     C                   Z-ADD     1             FCYCLE            1 0
      *
      * Legger inn firma i nøkkel
      *
     C                   MOVE      DSFIRM        WWFIRM
     C**                 MOVE      DSFIRM        A1FIRM
      *
      * Legger inn år i nøkkel
      *
     C                   MOVE      DSAARR        WWAARR
      *
      * Klargjøre resterende
      * nøkkelbegrep
      *
     C                   MOVE      DSFFNR        WWBINR
     C                   MOVE      *ZERO         WWNUMM
     C                   MOVE      *ZERO         WWSUFF
      *
      * Hent neste ledige nummer fra nummer-register
      *
     C     DSFFNR        IFEQ      *ZERO
     C     DSTFNR        IFEQ      *ZERO
     C                   MOVE      *ZERO         WPNUMM
     C                   MOVE      '0'           WPKODE
     C                   EXSR      HNTNUM
     C**                 MOVE      WPNUMM        A1LIST
     C                   ENDIF
     C                   ENDIF
      *
      * Les første post
      *
     C     KEY01         SETLL     SOHEL1
     C                   READ      SOHEL1                                 61
      *
      * Skriv første heading
      *
     C**                 WRITE     A1HDR                                30
      *
     C                   ENDSR
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     *INZSR        BEGSR
      *
     C     *LIKE         DEFINE    SOKUND        WWKUND
     C     *LIKE         DEFINE    SOFIRM        WWFIRM
     C     *LIKE         DEFINE    SOAARR        WWAARR
     C     *LIKE         DEFINE    SOBINR        WWBINR
     C     *LIKE         DEFINE    SOWSID        WWWSID
     C     *LIKE         DEFINE    SONUMM        WWNUMM
     C     *LIKE         DEFINE    SOSUFF        WWSUFF
      *
      *  Nullstilling av felter som ikke kan redefineres
      *
     C                   MOVE      *BLANK        WWRUTI           10
     C                   MOVE      *BLANK        WPKODE            1
     C                   MOVE      *BLANK        WPFELL            6
     C                   MOVE      *BLANK        WPTYPE            2
     C                   MOVE      *BLANK        WPFAST           10
     C                   MOVE      *ZERO         WPNUMM            6 0
     C                   MOVE      *ZERO         X                 2 0
     C     *LIKE         DEFINE    X             Y
     C     *LIKE         DEFINE    RKTLFN        WTLFU
     C     *LIKE         DEFINE    RKSTED        WKSTED
      *
      * Key for Heading-file
      *
     C     KEY01         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWAARR
     C                   KFLD                    WWBINR
     C                   KFLD                    WWNUMM
     C                   KFLD                    WWSUFF
      *
      * Key for kunderegister
      *
     C     KEY04         KLIST
     C                   KFLD                    WWFIRM
     C                   KFLD                    WWKUND
      *
      * Key for formular-register
      *
     C     KEY10         KLIST
     C                   KFLD                    WWRUTI
      *
      * Hente inn formular-register
      *
     C                   MOVE      DSRUTI        WWRUTI
      *
     C     KEY10         CHAIN     AFORL1R                            69
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Tar inn parameter fra forrige program                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     *ENTRY        PLIST
6.n2 C                   PARM                    WPPARM           32
      *
     C                   MOVE      *ZERO         DSAARR
     C                   MOVE      *BLANK        DSOTYP
     C                   MOVE      *ZERO         DSFFNR
     C                   MOVE      *ZERO         DSTFNR
     C                   MOVE      WPPARM        DSPARM
      *
      * Legger inn skjermid. og bruker i faste felter
      *
     C**                 MOVE      DSUSER        A1USER
     C**                 MOVE      DSWSID        A1WSID
     C**                 MOVE      UDATE         A1DATE
     C                   TIME                    UTIME             6 0
     C**                 MOVE      UTIME         A1TIME
     C**                 MOVEL     l_fnav        A1FNAV
      *
      *
     C                   ENDSR
