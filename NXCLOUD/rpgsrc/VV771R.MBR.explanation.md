# Explanation of RPG Program: VV771R

This program is written in RPG IV (ILE RPG) and is used for **updating product types after a stock count**. The program processes items in a product register, updates their status to "in stock" or "to be ordered" based on a physical count, and optionally updates associated inventory and audit records.

Below, you'll find organized explanations for the main components and logic of the code.

---

## High-Level Program Purpose

**VV771R** handles products in the specified batch, setting their type to:
- **"Lager" (in stock)** if their count is not zero
- **"Skaffe" (to be ordered)** otherwise

The program updates several files/tables, including inventory and product master, with support for logging and calling inventory update routines.

---

## Key File Declarations

```rpg
fvlagl2    if   e           k disk    rename(vlagpfr:vlagl2r)
fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
fvvarlr    if   e           k disk    rename(vvarpfr:vvarlrr)
fvvarlu    uf   e           k disk    rename(vvarpfr:vvarlur)
flwexpf    uf a e           k disk    rename(lexcpfr:lwexpfr)
```
- **vlagl2, vlaglu**: Inventory registers used for reading/updating stock balances.
- **vvarlr, vvarlu**: Product master registers, for reading/updating product data.
- **lwexpf**: List (report) file for output.
- All files are duplicated/referenced via `rename()` to use local record formats.

---

## Data Structures and Variables

### Parameters
```rpg
d p_firm          s                   like(vvfirm)    // Firm ID
d p_batc          s             10                    // Batch number
d p_numm          s              6  0                 // Number
d p_lage          s              2  0                 // Inventory location
d p_oppd          s              1                    // Update flag ('1'=update)
d p_antl          s              2  0                 // Number of warehouses
d p_list          s              1                    // Output list flag
```
These map to parameters supplied when the program is called.

### Inventory Update Data Structure
A set of fields in a DS (`hlrec`) overlays for passing data to the logging program (`VL001R`).

---

## Main Program Flow

### 1. Initialization

- Receives parameters via *entry PLIST*
- Prepares key lists for file operations

### 2. Processing Main Loop

```rpg
c     vlagl2_key    setll     vlagl2r                  // Position to key in vlagl2r
c     vlagl2_key    reade     vlagl2r                  // Read first record
c                   dow       not %eof                 // Main loop
```
Iterates over inventory items for the given firm and warehouse.

#### For each item:
1. **Save current value type** (`vlvtyp`) for comparison.
2. **Skip items with activity** (fields `vlbehl`, `vloord`, `vlbbes` not zero).
3. **Look up product in master file** (`vvarlr`). If not found, skip.
4. **Check if the item exists in the count batch** (`lbdtpf`):
   - Using an SQL SELECT to count entries for the product/batch/location.
   - If count (`w_anta`) > 0, set value type to 'L' (stock); else 'S'.
5. **If updating is active** (`p_oppd = '1'`):
   - Call `oppd_lager` subroutine to update inventory.
   - Update product master (`vvarlu`), if only one warehouse.
6. **Call `skriv_liste`** to write to output list if value type was changed.

#### Continue loop until end of file.

---

## Subroutine: `oppd_lager`

This subroutine updates the inventory file (`vlaglu`) for the product/location, setting all "year-to-date" counters to zero and updating audit fields (date, time, user, etc.).

Further, it prepares an audit/log data structure (`hlrec`) and calls an external program (`VL001R`) to register the change for audit purposes.

---

## Subroutine: `skriv_liste`

If the product's type was changed, writes a line to the output list (`lwexpfr`) indicating the change ("Settes til L" or "Settes til S") along with item number and description.

---

## Subroutine: `*inzsr`

Initialization subroutine:
- Receives all incoming parameters
- Initializes keylists for file access
- Sets local firm variable

---

## Additional Notes

### Use of SQL
- The code uses embedded SQL to count records in `lbdtpf`, a table containing count results (tellebunt).

### Comments and Versions
- Comments are in Norwegian, and a change log is maintained at the top.
- Many enhancements/bug fixes are documented in the header.

### Special RPG Features
- Uses data structures with overlays for flexible data passing/logging.
- Uses named keylists for file operations.
- Employs embedded SQL for efficient data lookup.

---

## Key Takeaways

- **Goal:** Update product types after stocktaking, manage inventory records, and generate an audit trail/listing of changes.
- **Files:** Reads/writes to both product and inventory master tables, and logs actions.
- **Logic:** If a product was counted, itâ€™s set as "in stock"; if not, "to be ordered".
- **Maintainability:** Modularized through subroutines for updating inventory and writing list entries.
- **Audit:** Calls an external program to log changes in a standardized way.

---

### Useful for:

- Onboarding new developers to stock management and inventory update procedures.
- Understanding the batch-processing logic for product status updates after stockcheck.
- Adapting or maintaining the system for changing business rules regarding inventory classification.