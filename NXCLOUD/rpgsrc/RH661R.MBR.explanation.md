# RPG Program RH661R — Explanation and Onboarding Notes

## Overview

This RPG program, *RH661R*, is a core part of an accounting (hovedbok) system related to Norwegian VAT ("mva-oppgjør" = VAT settlement). The program processes posting records, aggregates VAT figures by VAT code, and produces reports and journal entries. It also integrates with a PDF/XML reporting system for archiving and external distribution.

The source is classic ILE RPG (fixed-format), with many data structure, file, and business rule details. Below you'll find a detailed walkthrough of key sections.

---

## 1. **Header and Revision History**

- **Program:** RH661R  
- **Description:** Main ledger — VAT settlement and printout
- **Extensive change log**: Shows long lived business maintenance.
- **Notes on Indicators:** Extensive documentation for indicator use, which is key in classic RPG.

---

## 2. **File Declarations (`F-Specs`)**

- Multiple disk files, all renamed to local record formats.
- Files are referenced by logical names (e.g., *rhtrl6*, *rhsal1*, etc.).
- Output printer file (*rh661p*), with option to conditionally open for PDF integration.

**Example:**

```rpg
frhtrl6    if   e           k disk    rename(rhtrpfr:rhtrl6r)
...
frh661p    o    e             printer oflind(*in30)
pdf  f                                     usropn
```

- `usropn` (user open): file only opened programmatically.
- `oflind(*in30)`: Printer file overflow handled by indicator 30.

---

## 3. **Data Declarations (`D-Specs`)**

### 3.1. **Work Arrays**

- `mk(99)`: MVA-codes by index.
- `bto(99)`, `nto(99)`, `grl(99)`, `imv(99)`, `imu(99)`, `umv(99)`: Amount arrays, holding totals per VAT code.

### 3.2. **Fields for Posting Metadata**

- Many working variables used for key fields, dates, state tracking etc.

### 3.3. **VAT Totals and Reporting Fields**

- Variables like `oms01g`, `oms04a`, ..., `wmva01g`, ..., store calculated VAT amounts in various categories, matching lines on the VAT report.
- These are important for both calculation and generated reports.

### 3.4. **PDF/XML Integration Variables**

- Fields dedicated to spool file and job tracking for archiving, reporting, XML/PDF export.

---

## 4. **Input Records (`I-Specs`)**

- Input record structure for *rhsal1r*.
- Indicates how the month-to-month account balances (sal(01)-sal(13), sal(14)=saldo) are mapped.

---

## 5. **Main Control Logic**

### 5.1. **Initialization**

- Handled in `*inzsr` subroutine.
- Opens printer file, initializes working variables and keys, fetches the next voucher number, loads account register settings, and writes the heading.

### 5.2. **Main Processing Loop**

- Sets the primary key for *rhtrl6* (VAT postings).
- Loops through posting records (using `reade`), processes each according to period and status.

#### **For Each Record:**

- Sets blank VAT codes to '0'.
- Calls `brudd` subroutine if there's a break in VAT code (new code encountered).
- If the period is valid and not previously processed, process the posting via `beh_post`.

### 5.3. **Posting Processing (`beh_post` subroutine)**

- **Extracts and normalizes key posting fields.**
- Calculates gross amount (`brto`) and VAT base, applies business rules by VAT code.
- Updates running totals *per VAT code* in the work arrays.
- Records, by VAT code, the relevant inbound/outbound VAT.
- Writes detail lines and, if in update mode, marks postings as processed in the update file.
- Updates audit fields (user, timestamp).

### 5.4. **VAT Code Change Handler (`brudd` subroutine)**

- Advances to the next work array index (`x`).
- Maps VAT code to internal processing code (from code table), loads rates/dates.
- Ensures that reporting and posting rules are correctly applied for each VAT code.

---

## 6. **VAT Report and Journal Update (`mvatot` and `mvapos` subroutines)**

### 6.1. **`mvatot` Subroutine**

- Aggregates all per-VAT code totals into overall figures.
- Prints totals and summary VAT report lines.
- Gets final account balances from *rhsal1* (for the tax authority account).
- Prepares figures for the final posting/journal.

### 6.2. **`mvapos` Subroutine**

- Creates the actual output postings (journal entries) for:
    - Transferred inbound VAT
    - Outbound VAT on foreign services
    - Outbound VAT
    - The final balance on the tax office account
- Each output is written to the *rjoupf* journal.

---

## 7. **PDF/XML Output Integration**

### 7.1. **Spool File Handling**

- Subroutines for integrating with output management and archiving systems.
- Extracts spool file info and calls external programs (`AP627R`, `AP621R`) for PDF, XML, or browser-based preview.

---

## 8. **Indicators**

- **Extensively documented indicator strategy:**
    - File and record control, screen and error control, subroutine working indicators
    - Typical for classic RPG, but all clearly listed in the header for onboarding

---

## 9. **Key Business Rules and Special Cases**

- Extensive rules for processing VAT codes:
    - Handles standard, reduced, and special rates (e.g., foreign services, direct postings).
    - Safeguards against division by zero.
    - Applies proper aggregation and sign reversal for debits/credits according to Norwegian VAT accounting rules.
- Some lines are marked with version comments (e.g., `V5.40`, `6.12`), indicating release-specific logic or bugfixes.

---

## 10. **Getting Started Notes**

- **Essential knowledge:**
    - Understand the company's VAT handling practices.
    - Familiarize with the meaning and structure of MVA codes (`rbmvak`), code-registers, and account mappings.
    - Know which subroutines update files, print reports, or make journals.

- **To debug/extend:**
    - Pay attention to `beh_post` for posting rules and per-code handling.
    - Update or add VAT codes through the code-register logic in `brudd`.
    - For reporting or archival changes, inspect the PDF/XML-integration subroutines.

- **General Tips:**
    - Use the indicator documentation to avoid conflicts.
    - The versioned comments are essential for understanding why some conditional rules are present.
    - PDF/XML integration is "bolted-on" (not part of core tax logic), so can be traced in dedicated sections.

---

## 11. **Summary Flow**

1. **Read Posting Files:** Loop through *rhtrl6* postings.
2. **Group By and Process VAT Codes:** Aggregate per-code using arrays.
3. **For Each Posting:** Validate, classify, totalize, and (optionally) write detail.
4. **After All Postings:** Tabulate VAT report, balance, and generate journal entries.
5. **Archive & Report:** If PDF/XML archive requested, trigger integration routines.

---

## 12. **References**

- **Account and Code Table Files:** Used throughout for mapping and key generation.
- **Field lists, array indices, and logic flow:** All depend on strict data discipline and indicator use.

---

### **Onboarding Recommendation**

- Spend time reading the comments, especially the indicator usage and business rule notes.
- Use the version comments as historical context for why certain blocks exist.
- Trace through a simple run with a small batch using debugging or print statements to see the data flow.
- Consult with a business analyst or senior developer for details on VAT code mapping.

---

**The program is a comprehensive, well-commented, and business-critical piece of RPG code. Proper understanding of Norwegian tax/accounting and the company's VAT processes, as well as experience with classic RPG, is essential for effective maintenance or extension.**