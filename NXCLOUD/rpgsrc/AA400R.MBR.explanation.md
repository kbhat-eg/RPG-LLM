# Program Overview

This RPG/400 (ILE RPG, fixed-format) program is called **AA400R** and is part of the **ASPGPL** system. The purpose (per the comments) is "opprydding i filer" (i.e., cleaning/updating files), specifically for "endre firma" (changing the company number/ID in several files). It receives a company number and updates a field in several files for all records with that company number.

## Program Flow

1. **Program Entry**
   - Receives the company number (`w_firm`) as a parameter.
   - Sets up key lists for reading records in four physical files based on the company number.

2. **Processing Files**
   - For each of four files, loops through all matching records and updates the company field to the new company number provided (`w_firm`).
   - The files are:
     - `afirlu`
     - `anotlu`
     - `anumlu`
     - `akidlu`

3. **End Program**
   - Sets `*INLR = *ON` to end the program and release resources.

---

## Detailed Walk-through

### File Declarations

```rpg
fafirlu    uf   e           k disk    rename(afirpfr:afirlur)
fanotlu    uf   e           k disk    rename(anotpfr:anotlur)
fanumlu    uf   e           k disk    rename(anumpfr:anumlur)
fakidlu    uf   e           k disk    rename(akidpfr:akidlur)
```
- Declares four user-controlled, keyed disk files for update (`uf`).
- Each physical file (`*pfr`) is renamed to a logical record format (`*lur`).

### Data and Working Storage

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_navn                951    980

d w_firm          s              3  0
```
- Declares a data structure (unnamed UDS) with fields at fixed record positions, probably for externally-described data (not used in logic shown).
- `w_firm` is the input company number (parameter).

---

### Main Logic (C-specs)

#### Update "Firma" (`afirlu`)

```rpg
c     afirlu_key    setll     afirlu
c     afirlu_key    reade     afirlu                                 90
c                   dow       *in90 = *off
c                   eval      aaffir = w_firm
c                   update    afirlur
c     afirlu_key    reade     afirlu                                 90
c                   enddo
```
- *Set start position in file* using keyed lookup (`setll`).
- *Read* by key (`reade`). If record exists, indicator `*IN90` is off.
- *Loop* through all matching records, *update* field `aaffir` (presumably the company number) to the new value `w_firm`.
- *Update* the record, then advance to next keyed record.

#### Update "Notat" (`anotlu`)

Identical processing logic, updating field `aufirm`.

#### Update "Nummer" (`anumlu`)

Identical, updating field `anfirm`.

#### Update "KID-referanse" (`akidlu`)

Identical, updating field `akfirm`.

---

### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets the last-record indicator to release resources and ends the program.

---

### Initialization Routine (`*inzsr`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    w_firm
...
c                   endsr
```
- Standard RPG initialization subroutine.
- Receives a parameter with the new company number (`w_firm`).
- Sets up key lists (`klist`, `kfld`) for each file to use `l_firm` as the key for reading records.

---

## Summary

- This program receives a new company number as a parameter and updates that value for **all records** matching that company in four different files.
- The update is performed by reading with a key (the old company number), changing the field to the new value, and updating the record.
- This is a typical "data cleanup" utility, e.g., for when a company number changes due to mergers, reorganizations, or corrections.
- The program uses fixed-format RPG, with user-controlled file access, and is designed to be run in batch mode or as a utility.

---

## Key RPG Concepts Illustrated

- **File processing** with keyed access (`setll`/`reade`).
- **Record updating** with user-controlled files.
- **Parameter passing** via the `*inzsr` subroutine and `plist`.
- **Key lists** for matching on specific fields.

---

## Onboarding Tips

- Get familiar with the structure/names of the files and record formats involved (`afirpfr`, `afirlur`, etc.).
- Understand what fields correspond to company number in each file (`aaffir`, `aufirm`, etc.).
- Know how to compile and run this program with the correct parameter (company number).
- Test with a backup, as this utility directly overwrites data for all matching records!