# Documentation: AP627R â€“ XML Generation for Standard Printouts

## Overview

**Program Name:** AP627R  
**Purpose:**  
Generates XML files with metadata tags for standard printouts, supporting archiving, email integration, and advanced print handling. The XML output is used by downstream Java-based services for further processing (printing, archiving, mailing, etc.).

**Domain Context:**  
This program is a core part of the print/archival/mailing workflow within the business system. It is responsible for transforming print job information into a structured XML format, including metadata for archiving and mail delivery, and writing the result to the IFS (Integrated File System). The workflow is tightly coupled with the CGIDEV2 toolkit for HTML/XML templating, and interacts with several other RPG and Java modules.

**Key Features:**
- Handles up to three spool files per job.
- Dynamically includes metadata and mail information.
- Supports archiving logic, controlled by system parameters.
- Integrates with external routines for job tracking, mail, and print device configuration.
- Supports triggering of Java-based "sniffer" processes via data queues.

---

## Structure and Flow

### 1. Initialization (`*inzsr`)

- **Parameter Intake:**  
  The program receives a comprehensive parameter list, including spool file identifiers, job info, up to 10 custom meta tags, business keys, and archiving display info.
- **System Configuration:**  
  Reads configuration from the `afpslrr` file (properties repository), including:
  - XML template path (`DFTXMLSPL`)
  - Output directory for XML files (`XMLPATH`)
  - Logo path (`LOGO`)
  - Data queue activation flag (`DATAQ`)
- **Variable Initialization:**  
  Prepares job metadata, date/time, and resets various working variables.

### 2. Main Logic

#### a. Job Number Assignment

- If no job key is provided, a new job number is generated by calling `AS100R`.
- Job start is logged via `AB700R`.
- Initiates logging for XML generation via `AB705R`.

#### b. Mail Information (Conditional)

- If email output is required (`l_mail = 1`), the `xml_mail` subroutine is called to fetch and prepare mail-related data.

#### c. XML Generation (`xml_print` subroutine)

- **Screen Preview Handling:**  
  Adjusts logic if the output is for preview only (affecting spool file handling).
- **Spool File Sections:**  
  For each provided spool file (up to three), writes XML sections containing all relevant job/spool info.
- **Print Command Section:**  
  If not a screen preview, fetches printer drawer info (via `AP611R`) and includes print command metadata.
- **Mail Command Section:**  
  If mailing is enabled, writes mail recipient and message data, supporting CC/BCC and multiple receivers.
- **Archiving Section (Conditional):**  
  If archiving is enabled (`l_arch = 1`), includes archive commands and meta tags. This includes both system-generated and up to 10 caller-supplied meta tags.
- **Footer:**  
  Writes a footer section to the XML.

- **XML Output:**  
  The XML is written to the IFS at a dynamically constructed path.
- **Data Queue Trigger (Conditional):**  
  If data queue integration is enabled, calls `AP629C` to notify the Java "sniffer" process of new XML.

#### d. Job Completion

- Calls `AB710R` to mark the job as completed.

---

## Key Interactions

- **CGIDEV2 Toolkit:**  
  Used extensively for variable substitution and XML section handling (`UpdHTMLVar`, `WrtSection`, `GetHTMLIFS`, `ClrHtmlBuffer`, `WrtHtmlToStmf`).
- **afpslrr / aforlr files:**  
  Used for retrieving configuration and routine descriptions.
- **External RPG Programs:**  
  - `AS100R`: Job number generation.
  - `AB700R`, `AB705R`, `AB710R`: Job status logging.
  - `AP611R`: Printer drawer information.
  - `AP613R`: String scanning/conversion (for mail/archiving).
  - `AM705C`, `FO798R`: Mail server and recipient info.
  - `AP629C`: Data queue notification for Java integration.
- **Java Services:**  
  The downstream consumer of the XML output, responsible for actual printing, archiving, and email delivery.

---

## Business/Domain-Specific Logic

- **Archiving:**  
  The program conditionally generates an archive XML section based on a parameter (`l_arch`). If archiving is not enabled, this section is omitted.
- **Mail Handling:**  
  Supports up to three recipients and BCC/sender fields, reflecting business requirements for flexible email notification.
- **Meta Tagging:**  
  Allows for up to 10 custom metadata tags per print job, enabling rich indexing and search capabilities in the archive system.
- **Screen Preview vs. Actual Print:**  
  If the output is for preview, certain spool file operations (release/removal) are suppressed to avoid unintended print actions.

---

## Codebase Conventions and Patterns

- **Sectioned XML Generation:**  
  Uses a template-driven approach (CGIDEV2) for both standard and custom XML sections.
- **Parameter-Driven Behavior:**  
  Most logic is controlled by parameters, allowing for high configurability and reuse.
- **Separation of Concerns:**  
  Distinct subroutines for XML generation (`xml_print`), mail handling (`xml_mail`), and initialization (`*inzsr`).
- **Conditional Processing:**  
  Many features (archiving, email, data queue integration) are enabled or disabled based on runtime parameters or configuration, reflecting a modular and adaptable design.

---

## Noteworthy Design Decisions

- **Template-Based Output:**  
  The use of CGIDEV2 sections allows business users or administrators to change the XML format without modifying program logic.
- **Dynamic Configuration:**  
  System-wide settings (paths, templates, logo, data queue usage) are stored in a central properties file, making the system adaptable to different environments.
- **Backward Compatibility:**  
  The code includes several version-specific enhancements (noted by version comments), indicating careful evolution to support new business requirements without breaking existing workflows.
- **Data Queue Notification:**  
  The integration with a data queue and external Java "sniffer" process enables asynchronous processing and decouples XML generation from its consumption.

---

## Summary Table: Key Parameters

| Parameter       | Purpose/Usage                                 |
| --------------- | --------------------------------------------- |
| p_spfnam, ...   | Spool file identifiers (up to three)          |
| p_jobnam, ...   | Job metadata                                  |
| p_jkey          | Unique job key (optional, can be generated)   |
| p_btyp          | Batch type                                    |
| p_tagg0-9       | Caller-supplied meta tag names (up to 10)     |
| p_tagg0val-9val | Caller-supplied meta tag values               |
| p_refn, p_dspl  | Reference number and display tag for archive  |

---

## Module Relationships

- **Reads from:**  
  - `afpslrr` (configuration/properties)
  - `aforlr` (routine descriptions)
- **Writes to:**  
  - IFS XML output directory (configurable)
  - Data queue (optional, for Java integration)
- **Calls:**  
  - Several RPG service programs for job control, mail, and printer config
  - CGIDEV2 APIs for XML generation

---

## Maintenance Notes

- **Adding New Meta Tags:**  
  Increase the number of `p_taggX` and `p_taggXval` parameters and replicate the meta tag writing logic.
- **Changing XML Structure:**  
  Update the XML templates (not the RPG code) for most changes.
- **New Output Destinations:**  
  Extend the configuration in `afpslrr` and update the initialization logic as needed.

---

## Conclusion

AP627R is a highly configurable and extensible program that forms the backbone of the print, archive, and mail integration layer. Its design leverages template-driven XML generation, dynamic configuration, and modular subroutine structure to support evolving business requirements with minimal code changes. Understanding its parameter-driven logic and key external dependencies is essential for effective maintenance and extension.