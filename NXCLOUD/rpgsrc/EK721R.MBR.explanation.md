# RPG Program EK721R - Bonus Calculation and Update

This RPG source code is for an IBM i (AS/400, iSeries) program named **EK721R**, which handles customer bonus agreements: calculating and updating bonuses for all customers with a bonus contract.

Below is a section-by-section explanation, aimed at onboarding developers new to this codebase.

---

## 1. **Header & Documentation**

- **Purpose**: Calculates and updates bonus for all customers linked to a bonus agreement.
- **History**: The modification log at the top shows continuous development, notably around bonus period checking and parameter handling.

---

## 2. **File Declarations**

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
fekboi1    if   e           k disk    rename(ekbost:ekboi1r)
```
- **rkunl1**: Customer master file, renamed from record format `rkunpfr` to `rkunl1r`.
- **ekboi1**: Bonus agreement master file, renamed from `ekbost` to `ekboi1r`.
- Both files are defined for keyed input processing.

---

## 3. **Data Area and Variable Definitions**

### Local Data Area (LDA) - `uds`
```rpg
d                uds
d l_firm                944    946  0
```
- The local data area is accessed, and the company code is extracted (positions 944–946).

### Key Variables and Working Storage
- `ekboi1_bkun`: Temporary variable to hold bonus customer number, typed like `ekbkun`.
- Several working variables (`w_firm`, `w_paar`, `w_pfir`, etc.) store company/period info and are used for data passing and parameter handling.
- Alpha versions of key fields for parameter passing (`w_firm_alf`, etc.).
- `w_inlr`: Flag for last record operation.

---

## 4. **Main Program Flow**

### Parameter Preparation
```rpg
c                   eval      w_paar_alf = w_paar
c                   eval      w_firm_alf = w_pfir
c                   eval      w_inlr = ' '
```
- Converts period/company from numeric to alphanumeric for parameter passing.

### Process All Customers With a Bonus Agreement

#### File Processing Loop
```rpg
c     rkunl1_key    setll     rkunl1
c     rkunl1_key    reade     rkunl1
c                   dow       not %eof
...
c     rkunl1_key    reade     rkunl1
c                   enddo
```
- **Loop**: Reads all customers (`rkunl1`) for the given key (`rkunl1_key`), i.e., for the selected company.
- For each customer:
  - Sets the customer key for the bonus file.
  - Tries to fetch a matching bonus agreement (`ekboi1`).
  - If found:
    - Moves the found customer number to an alphanumeric variable.
    - Calls calculation program **EK711R** with relevant parameters:
      - Company code
      - Customer number
      - Period
      - [Optionally] bonus type, from-period, to-period (depending on program version)
      - `w_inlr` (last record indicator, initially blank)

### Program Finalization Call

```rpg
c                   eval      w_inlr = '1'
c                   eval      w_bkun_alf = *blank
c                   call      'EK711R'
...
c                   parm                    w_inlr
```
- After all customers processed, makes a "final" call to `EK711R` with a blank customer number and `w_inlr = '1'`.
- This likely closes files or triggers any finalization logic in `EK711R`.

---

## 5. **Program Termination**

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Program ends cleanly by setting the last record indicator (`*inlr`) on and returning.

---

## 6. **Initialization Subroutine (`*inzsr`)**

### Entry Parameters

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    w_pfir
c                   parm                    w_paar
c                   parm                    w_palt
6.10 c                   parm                    w_tbot
6.21 c                   parm                    w_fper
6.20 c                   parm                    w_peri
```
- Receives parameters into working variables:
  - Company, period, possibly bonus type and period range.

### Key Lists

- Sets up key lists for file operations:
  - For customers: keyed by company (`w_firm`)
  - For bonus agreements: keyed by company + customer (`w_firm`, `ekboi1_bkun`)

### Company Code Conversion

```rpg
6.22 c                   eval      w_firm = %int(w_pfir)
```
- Converts the alphanumeric company parameter to integer for use as file key.

---

## 7. **Summary of Program Structure**

- **Input**: Company, period, and optional bonus type/range via parameters.
- **Reads**: All customers for the company; for each, tries to find a bonus agreement.
- **Calls**: For each matching customer, calls EK711R to perform bonus calculation.
- **Finalizes**: After processing, makes one more call to EK711R to close files.
- **Ends**: Sets *INLR and returns.

---

# Key Points for Onboarding

- **File Relationships**: Customers in `rkunl1`, bonus agreements in `ekboi1`. Both keyed by company.
- **External Calculation**: All actual bonus calculations are offloaded to the program `EK711R`, which is called for each relevant customer and once more for wrap-up.
- **Parameter Handling**: Several fields have both numeric and alpha representations for file access and procedure calls.
- **Version Numbers**: Comments and extra parameters (`w_tbot`, `w_fper`, `w_peri`) added for various versions—important when maintaining or extending.
- **No Outputs**: This program’s only output is side-effects from calling `EK711R`.

---

## **Key RPG Constructs Used**

- **File specs & re-naming**: Facilitates usage of external file definitions.
- **PLIST/PARM**: Old-style program entry parameters and calls.
- **KLIST/KFLD**: Build composite keys for indexed file access.
- **SETLL/READE/CHAIN**: Indexed file navigation and lookups.
- **%EOF/%FOUND**: Modern built-in functions for end-of-file and successful lookups.
- **MOVEL**: Moves and pads data, used for parameter formatting.
- **Subroutines**: `*inzsr` for initialization logic.

---

## **Best Practices & Next Steps**

- Modernize parameter handling and file access if possible (embedded SQL, new-style prototypes).
- Carefully coordinate maintenance between this program and the calculation program (`EK711R`), since parameters must match.
- When onboarding, focus on understanding the company/customer/period logic and the mapping between numeric and alpha variables for interoperability.

---

**Summary:**  
EK721R loops through all customers for a given company, finds those with bonus agreements, and triggers calculation/updating via EK711R. Entry parameters control the company/period selection and, depending on version, the bonus type and period range. The program design isolates the actual bonus logic in a separate called program, making EK721R primarily a driver/controller for batch processing.