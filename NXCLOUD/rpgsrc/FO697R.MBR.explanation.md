# RPG Program FO697R: Printing Planned Delivery List (Picking Orders)

## Overview

This ILE RPG program (`FO697R`) processes and outputs a planned delivery ("leveringsplan") report, including order picking ("plukker ordrer"). It reads from multiple files, filters and sorts order records according to provided criteria, and writes results to a sorting register file. The code is written in RPG/400 fixed-format style with enhancements over several years.

---

## Key Objects and Files

- `FOHEL1` – Order header master
- `FODTL1` – Order detail/lines
- `FOTXL1` – Order texts
- `FPSOLU` – Picking line register (**output** file)

Files are renamed from physical file resource names (`fohepfr`, etc.) for use in the program.

---

## Data Structures

### Sorting Structure

```rpg
d d_sort          114
d  d_sor1           8    overlay(d_sort)
d  d_sor2          30    overlay(d_sort:9)
d  d_sor3          16    overlay(d_sort:39)
d  d_sor4           3    overlay(d_sort:55)
d  d_sor5          17    overlay(d_sort:58)
d  d_sor6           8    overlay(d_sort:75)
d  d_sor7           2    overlay(d_sort:83)
```
* `d_sort` is a 114-byte area, overlaid with segment fields used for building sort keys.

### Parameter Input Structure

```rpg
d d_prec           64
d  d_otyp           2    overlay(d_prec)
d  d_fonr           8 0  overlay(d_prec:5)
d  d_tonr           8 0  overlay(d_prec:13)
d  d_fkun           6 0  overlay(d_prec:21)
d  d_tkun           6 0  overlay(d_prec:27)
d  d_fdat          10d   datfmt(*iso) overlay(d_prec:33)
d  d_tdat          10d   datfmt(*iso) overlay(d_prec:43)
d  d_val1           1 0  overlay(d_prec:53)
d  d_val2           1 0  overlay(d_prec:54)
d  d_lmat           2 0  overlay(d_prec:55)
```
* Passed-in parameters: order type, from/to order number, from/to customer, from/to date, delivery mode, etc.

### Local Data Area Variables
```rpg
d l_wsid          901 910
d l_user          10
d l_sfir          944 946 0
```
* Firm ID, user, etc.

---

## Main Flow

### 1. Initialization

- Receives parameters via the PLIST.
- Sets up key values for file access.
- Assigns input parameters to work variables.

### 2. Main Processing Loop

#### a. Set the file pointer

```rpg
setll fohel1_key fohel1r
```
Starts reading `fohel1r` (order header) at the calculated key.

#### b. Loop through Order Headers

```rpg
read fohel1r 90
cabeq *on slutt
cabgt w_tnum slutt
```
Loops through orders, terminating when out of range or EOF.

#### c. Filter Orders

Applies criteria:
- **Order type** (`footyp`) matches parameter
- **Delivery mode** (if specified) matches (`folmat`)
- **Customer number** within bounds
- **Delivery date** within bounds

If not matching:
```rpg
goto neste
```
Skips to next order.

#### d. For Matched Orders – Process Related Data

For each qualifying order:
- **Init sort key:** `d_sort = *blank`
- **Call subroutines** for processing:
  - `ohead` – Order Header
  - `foran` – Pre-text ("FORAN")
  - `linje` – Order Lines
  - `etter` – Post-text ("ETTER")

Each subroutine handles reading from associated files, building records, and writing or updating to the sorting register file.

---

## Subroutines

### ohead – Order Header

- Chains to `fpsolur` (picking line register) to update header info.
- Builds sort keys based on input sort option (`d_val1`).
- If no record exists, writes a new one.

### linje – Order Lines

- Loops through all lines for the order.
- For each line:
  - Chain to `fpsolur` with line indicators.
  - Updates or writes picking register with type 'V' for lines.

### foran – Pre-text

- Reads all text lines before line 5000 ("FORAN").
- For each line, updates/writes to picking register as type 'K'.

### etter – Post-text

- Reads all text lines from line 5000 onwards ("ETTER").
- For each line, updates/writes to picking register as type 'K'.

---

## Key Lists for Files

Defined in the `*inzsr` subroutine. Each file gets a composite key list for indexed access.

---

## Parameter Interface

The program expects one 64-byte parameter (probably from a calling CL program or another RPG):

```rpg
*entry plist
parm p_parm
```

---

## Special Notes

- **Sorting**: Uses the `d_sort` structure to enable complex sorting, influenced by passed parameters.
- **Conditional Updates**: Decides between update and write to avoid duplicates in the picking register.
- **Filtering**: The program logic is filter-driven; only desired orders/lines/texts go to output.

---

## Versioning and Comments

- Code is extensively commented and contains a changelog at the top, showing features like extended sorting, additional filtering (delivery mode), numeric expansion, and field size increases.

---

## Summary Table

| Section              | Purpose                                           |
|----------------------|--------------------------------------------------|
| File Declarations    | Input/output files for headers, lines, texts     |
| Data Structures      | Sorting, parameter passing, LDA representation   |
| Initialization       | Parameter unpacking, setup keys                  |
| Main Loop            | Filter and process orders                        |
| ohead                | Process header, build sort fields, update/write  |
| linje                | Process order lines, update/write                |
| foran                | Process pre-text lines, update/write             |
| etter                | Process post-text lines, update/write            |
| *inzsr               | Build file key structures                        |
| PLIST                | Entry point, receive parameter                   |

---

## Onboarding Notes

- **To filter or sort differently**, modify the relevant logic around the parameter unpacking and the `d_sort` overlays.
- **To add more criteria**, extend the filter section in the main loop.
- Most changes (new fields, sorting, etc.) can be made by modifying the respective overlays and processing sections. 

**Caution:** This is legacy, positional RPG, so field definitions, file relations, and key orders are all highly positional and tightly coupled to the database schema and parameter block layout.

---

## Typical Flow Diagram

```text
Receive Parameters → Loop Orders → Filter Orders → For Each Order:
    ↓
  ohead (header) 
    ↓
  foran (pre-text)
    ↓
  linje (lines)
    ↓
  etter (post-text)
    ↓
  Write/Update Picking Register (fpsolu)
    ↓
Next Order → ... → End
```

---

This program is typical of AS/400 ERP/reporting code, focused on robust filtering, complex sort key creation, and batch processing.