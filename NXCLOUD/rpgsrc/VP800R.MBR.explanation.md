# RPG Source Code Explanation

## Overview

This RPG program is designed for **product price adjustment** (`Prisjustering` in Norwegian) within an IBM i (AS/400) system. It manages price records for products in a database file, either updating existing prices or creating new ones based on given parameters, such as firm, product, date, and various price adjustment percentages.

The source code is primarily written in RPG/400 (fixed-format), with enhancements over time for handling price groups, tracking information, and additional keys.

---

## Key Sections & Logic

### 1. **Program Header and Metadata**

- The `h` spec sets program options, including no debug I/O and date editing in day/month/year format.
- The extensive comments describe the program purpose and change history. This is a good place for onboarding to understand the business context and recent modifications.

---

### 2. **File Declarations**

```rpg
fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
fvvprlu    uf a e           k disk    rename(vvprpfr:vvprlur)
```
- `vvprl1` and `vvprlu` are logical file interfaces to the product price file, with different record formats for reading and updating.
- `vvprl1` is for reading price records (`if` input, keyed).
- `vvprlu` is for updating price records (`uf` update, keyed, externally described).

---

### 3. **Data Definitions**

#### **Parameters (Inputs to the Program)**
```rpg
d p_firm          s         like(vpfirm)
d p_vare          s         like(vpvare)
d p_dato          s         d   datfmt(*iso)
d p_spro          s        7  4
d p_kpro          s        7  4
d p_ipro          s        7  4
d p_bpro          s        7  4
d p_dekn          s        5  2
d p_inlr          s        1
```
- Inputs such as the firm (`p_firm`), product/player (`p_vare`), price date (`p_dato`), price adjustment percentages (`p_spro`, `p_kpro`, etc.), coverage (`p_dekn`), and a flag for last record (`p_inlr`).

#### **Local Data Area and Other Variables**

- Variables for user, working values, and keys for file access are declared and used throughout the program.

---

### 4. **Main Program Logic**

#### **Initialization**
```rpg
c                   eval      w_firm = p_firm
c                   time                    w_udat
```
- Copies input firm parameter to working variable.
- Gets the current system date into `w_udat`.

#### **Main Processing**
```rpg
c                   exsr      behandling
```
- Calls the main processing subroutine `behandling` (which means "handling" or "processing").

#### **Program Termination**
```rpg
c                   if        p_inlr <> *on
c                   eval      *inlr = *on
c                   endif
c                   return
```
- If the last record flag (`p_inlr`) is not set, sets the internal last record indicator (`*inlr`), which signals RPG to close files and end the program.

---

### 5. **Subroutines**

#### **behandling (Processing Each Product's Prices)**
- Loops over all price records for a given product.
- For each, if the record's price date is <= today, and it is either the first record or there's a change in unit/type, calls `oppdater` (the update subroutine).
- Updates working variables to keep track of last processed unit/type to avoid redundant updates.

#### **oppdater (Update/Create Product Price)**
- Fetches current price values.
- Calculates new prices based on adjustment percentages if their corresponding parameter is non-zero.
- Special logic for margin coverage (`p_dekn`): If given, recalculates the sales price from cost price and margin.
- If prices haven't changed, the update is skipped.
- Otherwise, attempts to chain (look up) the price record by full key.
    - If found, **updates** the existing record.
    - If not found, **writes** a new record with the new price and audit info (user, date, time).

#### **Initialization Subroutine (`*inzsr`)**
- Handles parameter entry and key lists for file access.
- Sets up `plist` for input parameters, key lists for the logical files.
- No logic beyond initial setup.

---

### 6. **File Key Lists**

- `vvprl1_key`: Used for reading product price records by firm + product.
- `vvprlu_key`: Used for updating/creating product price records by firm, product, various other attributes (delivery type, price group, unit, price date, etc.).

---

## Main Flow Summary

1. **Program starts** and parameters are loaded.
2. It **initializes working variables** and gets the current date.
3. Calls the `behandling` (processing) subroutine:
   - Loops through all price records for the product.
   - **Updates or creates** new price records for a given date if adjustments are needed.
4. **Terminates** properly, setting the last record indicator if necessary.

---

## Business Rules Encoded

- If there are prices for the product/delivery/unit/type with a price date **on or after** the given price date, **update** those with the calculated change.
- If not, **create** a new price record for the requested price date.
- All adjustments can be based on percentage increases for sales, cost, internal, or base prices, or on a target margin coverage.

---

## Key RPG Concepts Used

- **Fixed-format RPG/400** style.
- **Externally described files** and field referencing (`like(...)`).
- Use of **subroutines** for modular logic.
- **Indicators** (`*in91`, `*in92`, `*inlr`) for I/O and program control.
- **`eval`** and **`eval(h)`** for assignment and half-adjust precision arithmetic.
- **Audit fields** (`l_user`, `vpeusr`, `vpedat`, `vpetim`) for tracking who/when changes are made.

---

## Onboarding Tips

- **Strongly understand the file design** (field names like `vpsapr`, `vpkopr`, etc. are field names in the price file, often cryptic—review DDS or file layout).
- **Parameter list order matters**—must match what calls this program.
- **Adjustments are percentage-based.** Watch for zero values (no change).
- **Key lists** are crucial for proper database access and updates.
- **Audit fields** (date/time/user) are set on both update and insert.

---

### If you are new to this code, you will want to:

- Review the file layouts for `vvprl1` and `vvprlu` (and their base physical file `vvprpfr`).
- Confirm the business logic for price calculation with your users or analysts.
- Understand how this program is invoked (batch, interactive, or from another program).

---

## Summary Table

| Section           | Purpose/Action                                                       |
|-------------------|---------------------------------------------------------------------|
| File Declarations | Define logical/physical price files for read/update                 |
| Data Definitions  | Declare parameters, working variables, keys                        |
| Main Logic        | Initialize, get system date, call main subroutine, end program      |
| behandling        | Loop over price records, decide if update needed, call oppdater     |
| oppdater          | Calculate adjusted prices, update or insert price record, audit     |
| *inzsr            | Parameter entry and key list setup                                 |

---

**This program is a batch utility to bulk-update or insert product price records based on adjustment factors, suitable for regular price changes or margin corrections.**