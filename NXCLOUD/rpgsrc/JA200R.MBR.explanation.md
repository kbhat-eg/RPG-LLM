# RPG Program JA200R – Maintenance of Rounding Keys

## Overview

This RPG program is a maintenance utility for "rounding keys" (avrundingsnøkkel) on an IBM i/AS400 system. It allows users to view, add, update, delete, copy, and filter rounding key records using interactive screens and subfiles. The program makes heavy use of display files (workstation I/O with subfiles), indicator handling, and structured programming with subroutines (`begsr`/`endsr`).

The logic guides users through typical master-file maintenance, governed by a set of indicators and user actions (Function Keys/command keys), managing different group levels (overgruppe, hovedgruppe, undergruppe, leverandør, modulnr, varenr).

Field and comment names are in Norwegian.

---

## Main Components

### 1. File Declarations & Display Files

- Several physical/logical files (`F-spec`) are declared for reading/writing rounding key data, code/desc lookup, etc.
- The main display file (`ja200d`) uses subfiles (`sfile(b1sfl:w_srrn)`) and an information data structure (`infds(dspfbk)`) for feedback.

### 2. Data Structures

- Local Data Area (LDA) fields are mapped: user, firm, name, etc.
- Display feedback DS: stores current record for display control.

### 3. Working Variables

- Key fields for each data structure (used to build keys for file access).
- Various working fields for subfile/paging control (`w_fcrn`, `w_srrn`, etc.), screen navigation, and control flags (e.g. `b_forn`, `b_oppr`, etc.).
- Constants (e.g., `c_sfil` for subfile page size).
- Many field names relate to "groups" and hierarchy: overgruppe (main group), hovedgruppe (head group), undergruppe (sub group), leverandør (supplier), modulnr (module number), varenr (item number).

---

## Indicator Usage

- Indicators (e.g. `*IN10` to `*IN15`, `*IN21`, `*IN22`, `*IN30`, etc.) control program execution (paging, protection, display, etc.).
- Indicators 31–79 = error/warning signals for screen display.
- Indicators 80–99 = working indicators.

---

## Program Flow

### Main Loop (`b2taga`/`b2tagb` labels)

- **Writes command keys screen** (`write b2cmd`)
- **Displays subfile** or executes relevant subroutines based on user input (Function keys).
- Handles function key actions (add, edit, copy, delete, filter, paging, etc.).
- Handles filter and search functionality.
- Changes viewing mode (e.g. switching between ordinary and date-controlled prices).
- Handles subfile positioning (jump to a specific group/item on request).
- Calls subfile handler for processing of the current subfile.

### Exit (`avslutt`)

- Sets LR (last record indicator), causes RPG program to end.

---

## Subroutines

### 1. `forny` – Refresh Subfile
- Based on current sequence (`w_seqe`), positions the appropriate logical file.
- Calls `clr_subfile` to clear and `crt_subfile` to fill the subfile.

### 2. `posisjoner` – Position Subfile
- Sets sequence and keys according to provided criteria (overgruppe, hgrp, ugr, leverandør, modul, varenr).
- Calls clear and create subfile routines.

### 3. `subfile` – Process Subfile Records
- Reads each record in the subfile (`readc b1sfl`), checks the action selected:
  - **2:** edit
  - **3:** copy
  - **4:** delete
  - **5:** view
- Executes the corresponding subroutine (edit, copy, delete, view).

### 4. `xc1bld` – Handle New Row (Add)
- Clears input fields, gets information, presents the entry screen.
- If row exists, displays an "already exists" message (`xc1msg`).
- If new, calls edit (maintain) subroutine (`xc2bld`).

### 5. `xc1msg` – Show Row Exists Message
- User is informed that the record already exists (prevents duplicate add).

### 6. `xc2bld` – Add/Edit/View Record
- If record exists, loads existing data.
- Validates rule (`c2regl`), ensures links to rule table exist.
- Updates record if editing; adds new record if not found.
- Refreshes subfile if needed.

### 7. `xd1win` – Delete Record
- Reads existing row, displays confirmation window, then deletes it from file.

### 8. `xk1win` – Copy Record
- Lets user select source and destination keys, validates, and then copies.

### 9. `clr_subfile`/`crt_subfile`
- Clears and then fills the subfile page by reading from the logical file, writing display records.
- Handles paging, sequence, filtering.

### 10. `bck_subfile` – Page Backwards
- Handles logic to page backwards in the subfile view.

### 11. `dsp_subfile` – Display Subfile
- Handles display of the subfile and related control/feedback indicators.

### 12. `spørring` – F4 Lookup Handler
- Handles lookups (F4) for related fields by calling external programs (e.g., rule, group, supplier, module, product lookups).

### 13. `filter`
- Handles filtering the list using rules and suppliers.

### 14. `sjekk_input` – Input Validation
- Ensures keys entered are valid and not conflicting.
- Looks up descriptions for groups, supplier, item, etc.
- Sets error indicators if not valid.

### 15. `hent_info` – Get Descriptions for Keys
- Looks up and fills in text/description fields for current keys.

### 16. `*inzsr` – Initialization
- Sets up all key lists (klist), positions files, and initializes primary display/subfile.

---

## Key and Database Access

- **KLIST/KFLD** definitions in `*inzsr` and scattered in logic for setting up keys for CHAIN, SETLL, SETGT, etc.
- Logical files (`jav1l1`, `jav1l2`, etc.) correspond to various group and search combinations.
- Additional files (rule, group, supplier, item master, etc.) used for lookups and validations.

---

## Special Features

- **Subfile Paging:** Supports paging forward/backward, display control, and cursor positioning.
- **Lookup Windows:** For selecting rules, items, groups, suppliers via external programs (F4 key).
- **Filtering:** List can be filtered by rule and supplier.
- **Copy, View, Edit, Delete:** All basic CRUD operations via subfile.
- **Error Handling:** Uses indicators to signal invalid input or conflicts (e.g. duplicate records).
- **Multi-level Key Management:** Handles hierarchy of groupings for detailed record selection.

---

## Notable Norwegian Terms

- **Avrundingsnøkkel:** Rounding key
- **Vedlikehold:** Maintenance
- **Overgruppe (ogrp):** Main group
- **Hovedgruppe (hgrp):** Head group
- **Undergruppe (ugrp):** Sub group
- **Leverandør (ldor):** Supplier
- **Modulnr (modn):** Module number
- **Varenr (vare):** Item number
- **Regel:** Rule
- **Beskrivelse:** Description
- **Forny:** Refresh
- **Slett:** Delete
- **Kopier:** Copy

---

## Summary

This program is a classic AS/400 style master data maintenance module, built for usability with subfiles, F-key navigation, lookup popups, paging, and robust error handling, all tailored for a Norwegian business application context.

New developers onboarding to this program should:

- Understand the subfile-based UI flow.
- Study indicator usage and their meanings.
- Get familiar with key structures and logical file access patterns.
- Recognize how hierarchical key structures are used for navigation and filtering.
- Know how to trace actions back to subroutines based on subfile action columns (`b1valg`).
- Recognize the interaction with external lookup programs for field validation (F4 help).

It is a foundational RPG maintenance program, with clear separation of concerns and a strong focus on user interaction and record integrity.