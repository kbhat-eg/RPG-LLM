## Program Overview

This program (`FD118R`) is part of the ASOFAK system, designed for fast creation of order lines with product data originating from a system referred to as "Winner." It has been tailored to optimize the creation of new order lines, likely in an order entry or sales order fulfillment context.

The code’s logic is closely tied to domain processes: validating item/existence, checking unit validity, avoiding duplicate order lines, fetching additional product data (such as GTIN), populating required fields from item/order master records, and writing the completed order line to disk. This version also includes extensions for handling a two-position price group and retrieving GTINs (Global Trade Item Numbers) for items/units.

### High-level Structure

1. **File Declarations**: The program opens multiple files, each renamed to a local format record for clarity. These include files for status codes, items, item units, order headers, order lines, order line updates, and customer data.

2. **Parameter and Variable Definitions**: Extensive use of “like()” ensures that parameter data types exactly match those in the relevant files. Local data area and "working" storage are defined for process control.

3. **Initialization**: Via the `*inzsr` subroutine, parameters are set, keys are built, and master record data (status/order head/customer) are pulled in.

4. **Main Business Logic**:
    - **Early Exits**: The program aborts and returns early if:
        - Required parameters (item code or quantity) are missing.
        - The specified unit does not exist for the item.
        - The order line already exists.
        - The item does not exist.
    - **Item/Unit Check**: Validates item/unit on the vvenl1 file (item-units).
    - **Item Existence & Data Retrieval**: Checks the item file (vvarl1) for the product.
    - **GTIN Population**: Optionally (version 8.02), the program calls an external routine (VE713R) to retrieve and store the GTIN for the item/unit.
    - **Data Population**: Constructs the order line work record by merging:
        - Parameter values.
        - Master data from item and order master files.
        - Hard-coded and default values for fields set by business convention.
    - **Calculation**: 
        - Net price × quantity (amounts, totals).
        - Discount logic exists but is commented out (domain logic may have shifted responsibility elsewhere).
    - **Writing**: Writes the constructed order line record to the appropriate file.
    - **Success Indication**: Sets a flag (`p_kode = *on`) indicating at least one line was registered.

5. **Subroutines**:
    - `*inzsr`: Handles initialization, parameter unpacking, key building, customer status retrieval.
    - `hent_GTIN`: Handling of GTIN retrieval for an item/unit pair, integrates result into order line.

6. **Business/Domain Conventions**:
    - Prices and discounts come from Winner (external system), not derived here.
    - Many hardcoded or defaulted field values indicate standard business process (e.g., "3" for VAT code, zero values for accounting/project/department, etc.).
    - Order/customer master files are referenced for contextually dependent fields (customer numbers being overridden if local values are set, etc.).

---
## Key Points for New Developers

### 1. **File Interfaces**
- **fstsl1/fstsl1r**: Status codes (generic code register, used for lookup in `*inzsr`).
- **vvarl1/vvarl1r**: Item master – critical for pulling in additional product info.
- **vvenl1/vvenl1r**: Item/unit cross-reference – ensures validity of unit for item.
- **fohel1/fohel1r**: Order header – for fetching order-level defaults (customer, delivery method, etc.).
- **fodtl1/fodtl1r**: Order line (read/exists check).
- **fodtlu/fodtlur**: Order line (write/update target).
- **rkunl1/rkunl1r**: Customer detail – for checking if this is a cash customer.

### 2. **Error/Exit Path Handling**
All error conditions result in a simple `goto avslutt`, which returns without setting the "success" flag (`p_kode`), effectively signaling the line create was not carried out.

### 3. **Parameter/Field Handling**
The program receives its primary inputs as parameters: order header identifiers, line number, product and quantity, unit, texts, price, etc., mapping them externally to the writing order line.

`like()` usage throughout for variable declarations ensures data type alignment with file definitions—critical for integration with validation, update, and downstream interfaces.

### 4. **GTIN Integration**
The subroutine `hent_GTIN` connects to program `VE713R` to fetch GTIN based on firm, supplier (levr), item, and unit. The results are written directly into the order line field `fdeann`. This supports newer requirements for barcode/EDI transactions.

### 5. **Key and KLIST Construction**
Key field lists (`klist`) are built in the `*inzsr` routine, one per logical lookup. These are essential for the correctness and maintainability of `CHAIN` operations, which are widely used for record existence checks and data fetches.

### 6. **Upper-case Conversion**
Product texts can be automatically converted to uppercase if the flag `faahoy` is set, using the `XLATE` function and the Norwegian special characters (ÆØÅ).

---

## Design Decisions & Conventions

- **Hard exit for error conditions**: This approach, rather than elaborate error handling, is consistent with fast-path data creation programs.
- **No direct calculation of price or discounts**: All price/discount calculation logic is either left blank or commented out, emphasizing Winner as the single source of price/rabatt information.
- **Data integrity via staged validation**: Every record is validated before proceeding—this prevents "dirty" or incomplete order lines from being created.
- **Minimal side effects**: The only persistent change made is the `fodtlur` write – no other files are updated (except for whatever happens in the VE713R program).
- **Selective field defaults**: A number of optional or header-derived fields are defaulted to zero or blank, per business logic.

---

## Interfaces & Dependencies

- **External Program Calls**:
    - `VE713R`: Must be available and provide GTIN/Status return as expected; failure here only results in a blank or defaulted GTIN in the order line.
- **File Relationships**: Item/unit and customer/line existence checks depend on other master data being consistent and up to date.
- **Parameter Integrity**: The calling program must ensure that all expected parameters are supplied and correctly typed/mapped.

---

## Summary

This is a robust, focused high-throughput RPG program enabling order line entry driven by data from external product/pricing systems. Its central responsibility is—given correct candidate data—create an order line with proper references, totals, and master-data links, while preventing duplicates or data errors. Every major business object involved—item, item unit, order header, customer—has its status validated before a line is written.

When onboarding, familiarize yourself with the file layouts (RECORD defs), pay attention to the like() conventions, and be aware that pricing/discounting is handled upstream. Flexible details such as GTIN fetching and case conversion for texts may be added or switched off/on per version/requirement.

Modifications to this module should be done with care, especially regarding any business rules related to validation, as silent rejection (via goto avslutt) has no user-visible error messages. Always verify the impact of field defaulting and external routine integration (e.g., VE713R) with business and IT stakeholders.