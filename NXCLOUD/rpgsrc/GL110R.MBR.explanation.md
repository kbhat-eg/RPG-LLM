# RPG Program Explanation: GL110R – Remittance File Receipt Processing

---

## Overview

This IBM ILE RPG program (`GL110R`) processes remittance files (retur/mottaksbehandling av remitteringsfile) for the system `ASOKON`. The program manages the receipt and validation of batch transactions with various financial record types ("BETFORxx"), performs business logic based on transaction type and return codes, and updates/inserts entries into the relevant files for further processing and reporting.

The code has a long maintenance history, with many enhancements related to currency handling, batch processing, error handling, and more.

---

## Main Data Flow

1. **Reads records from a transaction file (`GTRTPF`/`gtrtlu`).**
2. **Maps each record into a corresponding data structure**, depending on record type (`BETFOR00`, `BETFOR01`, etc.).
3. **Processes the transaction** according to business rules. This involves:
   - Validating the transaction
   - Calculating or correcting currency/exchange rates
   - Handling return codes (success, error, or intermediate status)
   - Writing receipt records, updating logs, and handling errors.
4. **Deletes the processed transaction from the input file.**
5. **Generates and prints receipts**, and optionally produces XML/PDF outputs for archiving or further processing.

---

## Key Constructs

### 1. **File Declarations**

- `gtrtlu`: Main input file (transaction log)
- `gubfl8`, `gurml1`, `gurmpf`: Lookup and update files for batch, remittance group, and receipt
- `gl110p`: Printer file for output (opened conditionally)

### 2. **Data Structures**

Multiple *overlay* data structures map the same record buffer to different logical views, depending on the BETFOR type (e.g. `BETFOR01`, `BETFOR04`, `BETFOR21`). This efficient mapping lets the program refer to fields by name depending on the context.

Examples:
- `dsa00a`, `dsb00a`, `dsc00a`, `dsd00a`, `dsg00a`, `dse00a`, `dsf00a` – specialized layouts for each transaction type.
- `dsdat1` / `dsdat2` – structures used to manipulate and reformat dates.
- Standalone fields for all major buffer and calculation needs (amounts, codes, status flags, etc.).

### 3. **Tables**

At the end of the source, `vk` and `vf` arrays map currency codes (e.g., `USD`, `DEM`) to values for currency conversion factors. This is used for currency-specific calculation logic.

---

## Program Flow

### **Initialization (`*inzsr`)**

- Clears and resets all working variables.
- Prepares parameter lists and opens the printer file if needed.
- Sets up keys for all relevant access paths.

---

### **Main Processing Loop**

```rpg
c     dow       *in60 = *off
    exsr      xoverf             // Map record to data structures
    exsr      xteste             // Process transaction logic
    delete    gtrtpfr            // Remove processed record
    key02     reade     gtrtlu   // Read next record (file indicator 60 for EOF)
c     enddo
```

#### 1. **Record Overlay (`xoverf` subroutine)**
   - Moves the current input buffer into the general structure and the correct overlay structures for this record’s BETFOR type.
   - Sets status variables for return code and batch status.

#### 2. **Transaction Evaluation (`xteste` subroutine)**
   - **BETFOR00 Handling**: Validates the batch header. If return code is not '01' or '02', marks the entire batch as failed.
   - **BETFOR01/BETFOR21 Handling**: Finds header info for pay/run group and firm, determines type (payroll or general ledger).
   - **BETFOR04, BETFOR22, BETFOR23 Handling**: Extracts group/firm/number, writes receipt record if not already present.
   - **Main Logic**:
     - Checks/clears currency and commission fields if blanks.
     - Processes specific handling for 2nd-return transactions and calculates exchange rates accordingly.
     - Handles conversion of due dates (adds year if needed).
     - Calculates payment amount with currency factor, handles domestic/foreign payments differently.
     - Calls appropriate subroutines to update receipt files and handle errors.

#### 3. **Receipt Writing (`xgodpo` and `xerrpo` subroutines)**
   - **xgodpo**: For valid (accepted) posts. Updates main receipt file, populates all required fields, and calls `GL112C` (another program) to update ledger/payroll.
   - **xerrpo**: For rejected posts. Writes error entry, calls same external program for error handling.
   - **xmkvit**: Prints the receipt (used by xgodpo).

#### 4. **Support Routines**
   - **Date Reformatting**: Via overlays, splits and rearranges date fields for output.
   - **Currency/Commission Normalization**: Ensures fields aren't blank; substitutes zero where needed.
   - **XML/PDF Output Generation**: Conditional logic at end of program runs routines for archiving and visualizing receipts via XML or PDF.

---

## Key Business Rules

- **Batch Rejection**: If a `BETFOR00` record’s return code is not '01' or '02', the whole batch is rejected.
- **Return Types**: Return code 1 = first time; 2 = second time; other = error.
- **Exchange Rate Handling**:
  - Handles currencies with a 1:100 relationship to NOK differently.
  - Some currencies are always "by 1", others "by 100". This is maintained in the `vf` lookup array.
- **Commissions/Provisions**:
  - For `BETFOR04`, the commission is only booked once per proposal, then zeroed.
- **Date Handling**:
  - Due dates are mapped from two-digit years to full years (pre-80 means 2000+, otherwise 1900+).

---

## Indicators/Flags Used

- `*in60` – File EOF for `gtrtlu`
- `*in61`, `*in62` – Used for checking existence of certain records in other files
- `*in31-*in34`, `*in30` – Used for reporting/printing flags

---

## Conditional Archiving and PDF Preview

- If variable `l_poff` is set, the program generates an XML file (calls external program `AP627R`) and launches a PDF preview (via `AP621R`). All parameters for these calls (job name, user, spool file, etc.) are prepared just before the call.

---

## Maintenance Notes

- The code is annotated with chronological comments for every change, often referencing issue numbers and initials.
- Modifications referenced include new currency (EUR), changes in decimal handling, branching logic for commission, and introduction of XML/PDF outputs.

---

## Onboarding/Usage Tips

- **To add new currency logic**: Update the `vk` and `vf` arrays, and review all places where currency relationships are calculated.
- **To change error handling**: Review the `xteste`, `xerrpo`, and the main processing loop; ensure batch status variables are correctly set and checked.
- **File definitions**: The logical files used (`gtrtlu`, etc.) must match the overlays used in the data structures.
- **Date logic**: The program expects dates in old formats and normalizes them; adding support for new date formats may require extending the overlay routines.
- **Subprogram/External Calls**: The interface to `GL112C`, `AP627R`, and `AP621R` is via parameter lists; any change to their API will need to be reflected here.

---

## Code Evolution Markers

Version and change markers (e.g., `6.10`, `6.30`, `21014`) refer to change management and maintenance history. When modifying code, maintain this system for traceability.

---

## Final Words

This program is a robust, thoroughly maintained transactional handler for remittance receipt processing, highly dependent on external file layouts and business rules regarding currency and batch returns. The code is modularized with subroutines for clarity and maintainability, but due to the age and style, new developers should familiarize themselves closely with the overlay data structure technique and file indicator handling typical of legacy RPG code. 

**For any extension, focus on:**
- Correct buffer/data structure overlays
- Consistent use of file indicators and keys
- Alignment with external call parameter lists
- Adherence to batch and transaction status conventions

---

**When in doubt, read both the comments and the logic—they are dense but highly informative about business intent!**