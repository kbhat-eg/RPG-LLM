# RPG Program BO700R Documentation

## Overview

**Program:** BO700R  
**System:** ASSHOP  
**Description:**  
This program is responsible for transferring a "bong" (receipt or sales slip) header and its associated lines into the order system. It creates both order headers and order lines based on the bong data, performs various business-specific validations and enrichments, and triggers recalculation and updates of the order as needed.

The program is heavily tailored for the Norwegian retail domain, with specific references to "pakkseddel" (delivery note), "kort" (cards, e.g., BM/Maxbo/GE cards), and campaign/project/customer-specific logic.

## Key Business Logic and Flow

### 1. Entry and Initialization

- **Parameters:**  
  - Company (firm), year, workstation ID, bong number, bong type, offline flag, and commit flag.
- **Initialization:**  
  - Sets up local variables from parameters.
  - Builds key lists for record access in various files (bong header/lines, card registers, customer/project tables, etc.).
  - Checks if special logic applies for "pakkseddel" dates (version 7.02, for customer Gipling).
  - Loads hold code for negative delivery notes from a properties file.

### 2. Main Processing

#### a. Bong Header Lookup

- The program chains (looks up) the bong header using the provided key.
- If not found, it exits immediately.

#### b. Order Line Creation

- For each bong line:
  - Calls external program `VL710R` to retrieve item type and related data.
  - Maps bong line fields to order line fields.
  - Applies specific logic:
    - If an overridden cost price exists and the item type is not 'D', uses the selected cost price.
    - Delivery date logic: uses either the bong line's delivery date or a calculated one.
    - Accumulates the order discount from the line if present.
  - Writes the order line record.

#### c. Order Header Creation

- Maps bong header fields to order header fields.
- Applies customer/project-specific logic:
  - If the order is linked to a project, retrieves override values for fees from the customer project file.
- Determines order system type (`RT` or `KAS`) based on whether bong number is numeric.
- For delivery notes ("pakkseddel"), sets delivery dates and marks the order as a delivery note.
- Calls external program `VA750R` to determine if the warehouse has been updated, and sets the corresponding order flag.
- Checks if the customer has any special cards (BM, Maxbo, GE), and if so, sets the order suffix and possibly an info code.
- For negative delivery notes, applies a hold code if configured.
- Writes the order header record.

#### d. Order Recalculation

- Calls external program `FO730R` to recalculate the order, unless the order is a delivery note and not offline (special handling for offline sales).

### 3. Subroutines

#### a. `ordre_linje`

- Handles reading bong lines and writing them as order lines, including item type lookups and discount accumulation.

#### b. `ordre_hode`

- Handles mapping bong header to order header, customer/project logic, card checks, info code handling, and writing the order header.

#### c. `sjk_kort`

- Checks if the customer has BM, Maxbo, or GE card by chaining the card register with different card types in priority order.
- Sets the order suffix accordingly.

#### d. `*inzsr`

- Handles program initialization, parameter unpacking, key list setup, special logic for delivery note dates, and hold code retrieval.

## File Usage and Relationships

- **bohel1 / bodtl1:** Bong header/line files (source of data).
- **fohelu / fodtlu:** Order header/line files (target of data).
- **rukrl5 / ruksl1:** Card registers for checking special customer cards and info codes.
- **fkprl1 / rkunl1:** Customer project and customer master for fee and override logic.
- **vvlel1:** Used for item type/sortiment lookup (e.g., "trelast", lumber).
- **afpslr / votyl1:** Properties and order type lookup, including hold code logic.
- **External Programs:**  
  - `VL710R`: Item type lookup.
  - `VA750R`: Determines if warehouse update is required.
  - `FO730R`: Order recalculation.
  - `CO402R`: Configuration for delivery note date logic.

## Notable Business/Domain-Specific Logic

- **Card Handling:**  
  The program checks if the customer has special cards (BM, Maxbo, GE). If so, it marks the order and may set an info code based on the card type and warehouse.
- **Campaigns and Projects:**  
  Campaign and project numbers can override standard customer fee information on orders.
- **Delivery Notes ("Pakkseddel"):**  
  Special handling for orders that are delivery notes, including date logic and automatic hold code application for negative delivery notes.
- **Offline Sales:**  
  For offline sales, order recalculation is always triggered to ensure correct discounts.
- **Fee Information:**  
  Fee fields on the order header can be overridden by customer project or customer master data.
- **Order System Type:**  
  Orders are marked as `RT` or `KAS` based on the bong number format.
- **Lumber/Trelast Extension:**  
  Extended item type and sortiment logic for lumber items.

## Design Decisions and Patterns

- **File Renaming:**  
  Logical file names are renamed for clarity and to prevent conflicts.
- **Transaction Control:**  
  Commit flag (`COMFLAG`) is used for files that participate in transaction processing.
- **Key Lists:**  
  Extensive use of named key lists for chaining, aligning with the business's multi-field key structures.
- **Extensive Versioning/Change Tracking:**  
  The code is annotated with detailed change history, indicating a long-lived and carefully maintained codebase.
- **Subroutine Structure:**  
  The program uses subroutines (`begsr`/`endsr`) for modularization, with clear separation between line/header handling and initialization.

## Interactions with Other Modules

- **Order Calculation (`FO730R`):**  
  After writing order lines and header, the program calls this to recalculate totals, discounts, etc.
- **Item Information (`VL710R`):**  
  Used for each order line to retrieve item type and related attributes.
- **Warehouse Update (`VA750R`):**  
  Determines if the order should be flagged as having updated the warehouse.
- **Configuration (`CO402R`):**  
  Used for customer-specific logic, e.g., delivery note date rules.

## Conventions

- **Field Naming:**  
  Fields are mapped between source (bong) and target (order) with consistent prefixes (`bo` for bong, `fo` for order header, `fd` for order line, etc.).
- **Version Labels:**  
  Comments and code are annotated with version numbers and developer initials for traceability.
- **Handling of Special Cases:**  
  Many branches for handling special cases (e.g., negative delivery notes, offline sales, campaign/project overrides) are clearly marked with comments and version tags.

## Summary

BO700R is a central program in the order intake flow, responsible for transforming sales slips into system orders, applying a variety of business rules, and ensuring data integrity across multiple related files and modules. The codebase is mature, highly customized for the business, and integrates with several supporting modules for item, customer, project, and card handling. 

New developers should pay particular attention to the business-specific logic around cards, campaigns/projects, delivery notes, and the flow of data from bong to order, as these are critical to correct operation and compliance with business processes.