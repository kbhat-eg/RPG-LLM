# RPG Program LA400R (ASLAGR) — File Cleanup and Company Change

## Overview

This RPG III (ILE RPG) program, **LA400R**, appears to perform a *mass update* of several files related to warehouse management, orders, and invoicing records. Its primary function is to update the company number (`w_firm`) and tracking information (user, date, time) in a comprehensive set of files, as part of a process to "change company" or reorganize file data for a particular company (firma in Norwegian).

The program takes a company number as input and updates all records in the relevant files to reflect this new company number and related audit fields.

---

## Key Sections

### 1. File Definitions (F-Specs)
```rpg
flbchlu  uf e disk    rename(lbchpfr:lbchlur)
...
fsihelu  uf e disk    rename(sihepfr:sihelur)
```
- **Files are defined as update-capable (`uf`) and externally described (`e`) disk files.**
- `rename()` is used so the program uses an internal name for records (e.g., `lbchlur`) instead of the external description (`lbchpfr`), likely to support different record formats or overlays.

---

### 2. Data Definitions (D-Specs)
```rpg
d                uds
d l_user     911  920
d l_fgrp     931  933
d l_firm     944  946 0
d l_navn     951  980

d w_firm     s      3 0
```
- *Indicators* and *fields* from the user space are defined, including `l_firm` (company number) and `l_user` (user).
- `w_firm` is the working (new) company number parameter.

---

### 3. Main Logic — Mass Update Per File

For each major logical file (e.g., `lbchlu`, `lbdtlu`, etc.):
1. **Set a file pointer to the first record with the relevant key (`setll`).**
2. **Read the record.**
3. **Loop through all records with that key:**
   - Set the company field to the new company number (`w_firm`).
   - Update user and timestamp fields (if applicable).
   - Write (`update`) the record back to the file.
   - Read next matching record.
4. **Repeat for all files.**

**Example:**
```rpg
c     lbchlu_key    setll     lbchlu                            90
c     lbchlu_key    reade     lbchlu                            90
c                   dow       *in90 = *off
c                   eval      lcfirm = w_firm
c                   eval      lceusr = l_user
c                   time                    lceeda
c                   time                    lceeti
c                   update    lbchlur
c     lbchlu_key    reade     lbchlu                            90
c                   enddo
```
- The above code block processes each record in `lbchlu`, setting the company to `w_firm`, user to `l_user`, and timestamps to the current time.

---

### 4. Program Ending

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- *Routine for program exit*; `*inlr = *on` closes files and ends the program.

---

### 5. Initialization Subroutine (`*inzsr`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    w_firm
...
c     lbchlu_key    klist
c                   kfld                    l_firm
...
c                   endsr
```
- **This initializes the program, receives the company number as input, and defines key lists (`klist`) for each file based on the company number field.**
- This syncs sequential reads and updates per company.

---

## Audit Trail/Tracking

- **Tracking updates** (user, edit date, edit time) were added in version 6.10 (see comments and lines with `6.10`).  
- All records have audit fields updated with current user and time.

---

## Key Points for Onboarding

- **Purpose:** Update all company-related records to new company number, with user and timestamp for auditing.
- **How it works:** Loops through all records for each relevant file, changes the company field (possibly as part of a company split/merge), and updates tracking fields.
- **Inputs:** Company number received as a parameter.
- **Files impacted:** Multiple files central to warehouse, order, and invoicing — see file list in the code.
- **Audit Integrity:** User and timestamp fields are set on each update for traceability.

---

## When/Why Used

- **During a company reorganization, data migration, or correcting/realigning company assignment across all operational data tables.**
- **Ensures consistency, traceability, and up-to-date tracking information.**

---

## Program Flow Summary

```plaintext
START
  ↓
INIT: Receive company number, set up key lists for all files.
  ↓
FOR EACH FILE
    For all records matching current company number:
        Update to new company number (w_firm)
        Update user, date, and time fields (if applicable)
        Write back
  ↓
END: Set LR indicator, exit program.
```

---

## Common Customization Points

- You may need to adapt which user field is filled, or which tracking fields exist, depending on file structure.
- If new files are added to the system, ensure they're included with proper KLIST and update logic.

---

## Final Notes

- This program is a **utility for administrators** or system jobs, not for end users.
- **Testing in a controlled environment is critical** before running on production data, as all relevant records are updated in bulk.

---

**If you need to extend or debug this program, familiarize yourself with the individual file layouts and ensure the key and field mappings match actual data layouts and business rules.**