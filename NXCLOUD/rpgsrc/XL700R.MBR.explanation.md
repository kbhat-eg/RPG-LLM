# RPG Source Code Explanation

## Overview

This RPG program (XL700R) is written for the IBM i (AS/400) platform using the ILE RPG (RPG IV) language. Its main purpose is to **log activities related to quotations/offers** ("tilbudsaktiviteter"), including details such as the user, customer, sales representative, and relevant dates.

### Program Details

- **System:** Nexstep
- **Description:** Logging of offer activities, especially for offer follow-up ("tilbudsoppfølging")
- **Development History:** Basic change log, e.g., program created 28-Nov-2016 (date format is DMY).
- **Indicators:** 
  - `LR` indicates program end.
  - 80-99 are available for work indicators.

---

## File Declarations (`f-specs`)

Multiple files are declared for input/output and record access. All files are renamed for local record formats for clarity.

| File      | Mode    | Type | Keyed | Purpose                                           | Local Record Format |
|-----------|---------|------|-------|---------------------------------------------------|-------------------|
| xtlolu    | UF A E  | Disk | Yes   | Logging file (target of log writes)               | xtlolur           |
| fohel1    | IF E    | Disk | Yes   | Order header (lookup for offer info)              | fohel1r           |
| rkunl1    | IF E    | Disk | Yes   | Customer master (lookup customer name)            | rkunl1r           |
| ra09l1    | IF E    | Disk | Yes   | Code table (lookup sales representative name)     | ra09l1r           |

---

## Data Declarations (`d-specs`)

### Parameters

These variables are used to receive parameters from the caller:

- `p_tiln`: Offer number
- `p_aktp`: Activity type
- `p_slet`: Deleted flag/indicator
- `p_konk`: Competition info (likely)
- `p_sgru`: Sales group

### Local Data Area (LDA) Fields

These are mapped fields from the LDA:

- `l_user` (positions 911-920): User ID
- `l_firm` (positions 944-946): Firm/company number
- `l_fnav`  (positions 951-980): User's full name

### Key and Variable Fields

Used for database file keys and working storage:

- `xtlolu_aarr`: Year for xtlolu key
- `xtlolu_tiln`: Offer number for xtlolu key
- `fohel1_numm`: Order number for fohel1 key
- `fohel1_suff`: Order suffix for fohel1 key
- `rkunl1_kund`: Customer number for rkunl1 key
- `ra09l1_ikod`: Seller code for ra09l1 key

**Variables:**

- `w_firm`: Firm (company) code (from LDA)
- `w_date`: Current date (ISO format)
- `w_time`: Current time (ISO format)
- `w_dato`: Work field for date (length 10)

---

## Main Logic (`c-specs`)

The main logic performs several lookups and logs the activity:

### 1. Lookup Order/Offer Header (`fohel1`)

- Sets up the key for the order header.
- Performs a `CHAIN` (random access) to look up the offer/order.
- If not found and the activity type is not 'SLETTET' (deleted), the program exits early.

### 2. Lookup Customer Name (`rkunl1`)

- Sets up key using the found customer number.
- Looks up the customer name in the customer register.
- If not found, sets name to 'Ikke funnet kunde' ("Customer not found").

### 3. Lookup Sales Rep Name (`ra09l1`)

- Prepares key using seller code from order header.
- Looks up the sales rep in the code register.
- If not found, sets name to 'Ikke funnet selger' ("Sales rep not found").

### 4. Update Log File (`xtlolu`)

- Clears the log record buffer.
- Populates all relevant fields (firm, year, offer number, activity type, entry date/time, user, customer data, sales rep data, and various details).
- Writes the new record to the log file.

### 5. Program End

- Sets the LR (Last Record) indicator to signal end-of-program.
- Returns to caller.

---

## Initialization Subroutine (`*inzsr`)

Executed at program start, this subroutine:

- Receives and assigns parameters (`plist`).
- Defines KLISTs (key lists) for file access.
- Initializes `w_firm` from the LDA.
- Stores the current date and time in `w_date` and `w_time`.

---

## Summary of Workflow

1. **Startup:** Receives all parameters, initializes main variables and keys from the LDA and system date/time.
2. **Order Lookup:** Tries to find an offer/order header; exits early if not found unless deleting.
3. **Customer Lookup:** Finds the customer name, substitutes a default if not found.
4. **Sales Rep Lookup:** Finds the sales rep name, substitutes a default if not found.
5. **Log Write:** Fills out the log record with all gathered info and writes it to the `xtlolu` (log) file.
6. **Exit:** Ends the program gracefully.

---

## Key RPG Techniques Used

- **KLIST/KFLD**: For multi-field keyed access to DB files.
- **CHAIN**: Random-access database file lookup.
- **%FOUND**: Checks if the previous file access succeeded.
- **LDA Reference**: Uses specific positions to read shared data.
- **PLIST/PARM**: Parameter passing between programs/calls.
- **Indicator LR**: Proper program shutdown and resource release.
- **Subroutines**: Modularizes initialization using `*inzsr`.

---

## Typical Use Case

This program is likely called whenever an action is performed on an offer/quotation—such as creation, modification, or deletion—to record the event, who performed it, on which offer, which customer is involved, and optionally which sales rep. The log can then be used for audit trails, reporting, or process tracking.

---

**Tip for New RPG Developers:**  
This kind of program is a good example of traditional RPG-IV style with explicit record-level I/O, manual parameter parsing, and reliance on key lists. Modern RPG may use more free-format code and service programs, but the concepts remain similar. Understanding file access and parameter handling is crucial when working with legacy ILE RPG applications.