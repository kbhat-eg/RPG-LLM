# Documentation: AS100R â€“ Calculation and Update of Number Series

## Overview

This program, **AS100R**, manages the calculation and updating of number series (nummerserier) within the ASPGPL system. It is responsible for allocating, validating, and returning numbers from configurable number ranges, supporting both automatic and manual allocation modes. The number series are typically used for documents or records (e.g., orders, invoices) that require unique sequential numbering.

The program interfaces with two physical files:
- **ANUML1** (primary number series register)
- **ANUMLU** (number series usage/update register)

Both files use the record format **ANUMPFR**, renamed locally for clarity.

## Key Business Logic

- **Number Series Identification:** Number series are identified by a combination of company, field, type, and an optional fixed term (fast begrep).
- **Allocation Modes:** Supports both automatic (`A` or blank) and manual (`M`) number allocation, with logic to validate and process each accordingly.
- **Number Range Handling:** Enforces number range boundaries, supports optional wrapping (recycling numbers when the upper bound is reached), and provides status codes for various outcomes (e.g., out of range, series not found).

## Parameters

The program is called with a parameter list:
- `p_kode` (1A): Operation code (see below)
- `p_firm` (3P0): Company number
- `p_fell` (6A): Field/identifier
- `p_type` (2A): Type
- `p_fast` (10A): Fixed term (optional)
- `p_numm` (8P0): Number (in/out)

### `p_kode` Values (Input)
- `'0'`: Get next available number (automatic allocation)
- `'1'`: Return last used number (rollback)
- `'2'`: Validate manually entered number

### `p_kode` Values (Output)
- `'0'`: Success
- `'7'`: Manual number out of range
- `'8'`: All numbers used (no available numbers)
- `'9'`: Number series not found

## File Relationships

- **ANUML1**: Used to look up the number series definition based on the provided keys.
- **ANUMLU**: Used to update the current state of the number series (e.g., last used number).

Both files are accessed via keyed I/O, using a composite key of company, field, type, and fixed term.

## Main Processing Flow

1. **Parameter Initialization (`*entry`):**
   - Receives parameters and initializes key fields.
2. **Number Series Lookup:**
   - Attempts to find the most specific number series (all keys).
   - If not found, progressively relaxes the key (drops `fast`, then `type`) to find a less specific match.
   - If no series is found, returns code `'9'`.
3. **Operation Dispatch (`xstart`):**
   - Depending on `p_kode`, routes to the appropriate subroutine:
     - `'2'`: Manual number validation (`mannnr`)
     - `'0'`: Allocate next number (`nyttnr`)
     - `'1'`: Return last number (`gammnr`)
   - Updates the number series register if a new number is allocated or returned.
4. **Subroutines:**
   - **nyttnr**: Allocates the next available number, handles wrapping, and range checks.
   - **gammnr**: Returns (rolls back) the last used number if possible.
   - **mannnr**: Validates that a manually entered number is within the allowed range.

## Notable Design Decisions

- **Progressive Key Matching:** The lookup logic attempts to find the most specific number series first, then falls back to less specific definitions. This supports flexible configuration.
- **Auto/Manual Switch:** The `anauto` field in the number series definition controls whether allocation is automatic or manual, and the code branches accordingly.
- **Error Codes:** Instead of raising exceptions, the program communicates status via `p_kode` and `p_numm`, allowing the caller to react appropriately.
- **Wrapping Support:** If enabled (`anwrap = '1'`), the number series wraps around to the starting number when the upper bound is exceeded.
- **Rollback Logic:** Only allows rolling back the very last used number, to maintain sequence integrity.

## Conventions & Patterns

- **Tag and GOTO Usage:** The program uses classic RPG tags and `GOTO` for flow control, which is typical for legacy RPG but should be noted for maintainability.
- **Subroutines for Operations:** Each main operation (`nyttnr`, `gammnr`, `mannnr`) is encapsulated in a subroutine for clarity and reuse.
- **Record Format Renaming:** Both files use the same record format, renamed locally to avoid ambiguity.

## Integration Points

- **Upstream Callers:** This program is typically called by transaction or document entry programs that need to allocate or validate document numbers.
- **Downstream Effects:** Updates to the number series are persisted in `ANUMLU`, ensuring that subsequent calls see the updated state.

## Error Handling

- **Series Not Found:** Returns code `'9'` and zeroes the number.
- **Out of Range (Manual):** Returns code `'7'` and zeroes the number.
- **All Numbers Used:** Returns code `'8'` and zeroes the number.

## Key Fields (from ANUMPFR, assumed)

- `ansist`: Last used number
- `annfom`: Start of number range
- `anntom`: End of number range
- `anwrap`: Wrapping flag
- `anauto`: Allocation mode (`A`=Auto, `M`=Manual)
- `anfirm`, `anfell`, `antype`, `anfast`: Key fields

## Summary Table

| Operation (`p_kode`) | Description                | Subroutine Called | Key Logic/Checks                   |
|----------------------|----------------------------|-------------------|-------------------------------------|
| `'0'`                | Get next available number  | `nyttnr`          | Range check, wrapping, update file  |
| `'1'`                | Return last used number    | `gammnr`          | Only if number matches last used    |
| `'2'`                | Validate manual number     | `mannnr`          | Range check only                    |

---

**Note:** For any extension or modification, ensure that new business rules are reflected in the key matching and number range logic, and that the error/status codes remain consistent for the calling programs.