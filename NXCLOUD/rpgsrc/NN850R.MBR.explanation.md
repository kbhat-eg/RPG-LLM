# RPG Program NN830R: "Nettbutikk, ordreinngang" (Webshop, Order Entry)

This program implements the back-end for receiving and processing web orders (order header and lines) into an IBM i ERP system, and notifies order handlers via message/notification.

---

## File Declarations

- **nohel6**: Order header file, input, external, renamed as "nohel6r"
- **nohelu**: Order header update file, output, renamed as "nohelur"
- **nodtlu**: Order line update file, output, renamed as "nodtlur"
- **fusrl1**: User file, used for notification, renamed as "fusrl1r"
- **nkeol1**: Order number file, used for next order number, renamed as "nkeol1r"
- **rkunl1, ausrl1** (6.20+): Customer and user departments, for filtering notifications

---

## Data & Parameters

### Parameters (passed to program):

- Identifiers for queues, libraries, error flag, firm, warehouse, department, queue details, etc.
- Used to identify source, control flow, and context for queue operations.

### LDA (Local Data Area):

- Used for retrieving current user and firm (6.10+), typically for audit and notification purposes.

### Data Structures:

- **d_inpu**: Input data queue buffer (1024 bytes).
- **d_hode**: Order header structure.
- **d_linj**: Order line structure.
- **Various overlays**: Break down the header and line structure into individual fields (reference, customer, addresses, etc.).

### Working Variables:

- For packing/unpacking data, date conversion, number logic, and state tracking during processing.

---

## Main Program Logic

1. **Main Loop**
   - Repeatedly receives input from a data queue (`QRCVDTAQ` API).
   - Each queue entry (`d_inpu`) is processed by subroutine `behandling`.

2. **Processing Orders (`behandling`)**
   - Deciphers the type of record by `d_rect`:
     - `'1'`: Order header (`behandl_hode`)
     - `'2'`: Order line (`behandl_linje`)

3. **Order Header Processing (`behandl_hode`)**
   - Loads input into the order header structure.
   - Defaults "from system" (`d_fsys`) to `'NBU'` if not provided.
   - Checks if the incoming order's reference already exists—if so, signals error and exits.
   - Initializes line numbering.
   - Maps data from input structure to the order header record, converting and defaulting as necessary.
   - Handles date conversions, particularly for delivery date, with format checking (6.30+).
   - Retrieves the next available order number from the order number table (`nkeol1`/`AS100R`).
   - Optionally, determines the customer's department, used for notification logic.
   - Writes the assembled order header record to the output file.

4. **Order Line Processing (`behandl_linje`)**
   - Loads input into the order line structure.
   - Increments line number.
   - Maps and converts data from the input; detects negatives, normalizes numeric fields, handles decimal markers.
   - Writes order line, including user/time stamping.
   - If a message/comment is part of the line, it gets logged as a separate line.

5. **Notification (`send_melding`)**
   - Loops through order handlers (users) in `fusrl1`.
   - (6.20+) Only notifies those with the same department as the customer, unless no department is set.
   - Calls external program `NN821C` to send notification.

6. **Error Handling (`*pssr`)**
   - Sets error flag and exits program if an unhandled error occurs.

7. **Initialization (`*inzsr`)**
   - Entry parameter mapping.
   - Prepares key lists for file access.

---

## Key Points by Section

### File and Data Structure Definitions

- **Renaming**: Enables working with multiple logical views on the same physical file.
- **Overlays**: Allows byte slicing into structured fields—very common in legacy RPG data queue handling.

### Main Loop

- Uses a "DO UNTIL queue is empty" pattern.
- Waits for and processes each data queue entry.

### Subroutines

#### `behandl_hode`
- Ensures idempotency (no double-processing of same order ref).
- Initializes all relevant fields, handling both direct mapping and defaulting.
- Advanced handling for department-based notification logic (6.20+).

#### `behandl_linje`
- Handles numeric conversion for both quantity and price, dealing with potential negative values and decimal/place markers (European decimal comma).
- Handles message lines as secondary info records.

#### `send_melding`
- Sends a message to each relevant user's message queue or email.
- Conditions who gets notifications based on department (introduced in release 6.20).

#### Error/Initialization

- Catches any unhandled program exceptions for safe shutdown.
- Sets up file keys and internal variables with program parameters.

---

## Notable Features and Changes

- **Release Tracking**: The code is annotated with change logs by version and developer.
- **Localization**: Norwegian field names and comments; uses DMY date formats.
- **Extensibility**: The program is modular, supporting header/line/message processing and external notifications.

---

## Summary Table

| Section             | Purpose                                                      |
|---------------------|-------------------------------------------------------------|
| Files (F-specs)     | I/O for order/header/line/user/number files                 |
| Input Params        | Context for queue & run                                      |
| Data Structures     | Map queue data to structured fields                         |
| Main Loop           | Receive queue data, process until empty                     |
| behandl_hode        | Process headers; ensure unique ref; create new order header |
| behandl_linje       | Process order lines; convert/scale numerics; message lines  |
| send_melding        | Notify relevant users (by department)                       |
| Error & Init        | Safe exit, setup                                            |

---

## Onboarding Tips

- **Queue Processing**: RPG programs using data queues are event-driven, processing as records arrive.
- **Overlay Structures**: Look up how overlays and substringing work in RPG—this is vital for understanding how fields are extracted from "blobs" of data.
- **Date and Number Conversion**: Special handling for European formats and RPG's string-to-numeric quirks.
- **Multi-Release Code**: Sections starting with numbers (e.g., 6.20) denote changes or features by software version.
- **Integration Points**: Calls to `AS100R` (get next order number) and `NN821C` (send notification) are handled outside this program.
- **Notifications**: Department-matching for notifications is key for larger organizations—users only get notified for the departments they are responsible for.

---

This should get new developers quickly oriented to both the business logic and RPG idioms in use!