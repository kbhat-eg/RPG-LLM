# FP600R – Special Price Print Parameter Program

## Overview

**FP600R** is a workstation-based RPG program used in the ASOFAK system for handling parameters related to special pricing printouts. It facilitates user input validation, parameter preparation, and interaction with several master data inquiry programs. The program is primarily driven by a display file and interacts with multiple database files and external inquiry programs.

### Key Business Concepts

- **Special Price Printout**: The program collects and validates parameters for special price reports.
- **Parameterization**: Supports filtering by price group, discount/customer categories, customer/project, and item ranges.
- **Inquiry Support**: Integrates with master data inquiry programs for lookup and validation directly from the UI.

## File and Data Structure Relationships

### Database Files

- **rkunl1 (Customer Master)**: Used for customer lookups (`rkunpfr` renamed to `rkunl1r`).
- **ra30l1 (Price Group Master)**: Used for price group validation (`ra30pfr` renamed to `ra30l1r`).
- **fkprl1 (Customer Project Master)**: Used for customer project validation (`fkprpfr` renamed to `fkprl1r`).

### Display File

- **fp600d**: The workstation file for user interaction.

### External Inquiry Programs

- **RA530R**: Price group inquiry.
- **RA506R**: Discount category inquiry.
- **RA511R**: Customer category inquiry.
- **RK500R**: Customer inquiry.
- **FL500R**: Customer project inquiry.
- **VV500R**: Item inquiry.
- **FP600C**: The printout program, called with the validated and assembled parameter list.

## Main Program Flow

### 1. Initialization (`*INZSR`)

- Sets up key lists for chained file access (customer, customer project, price group).
- Initializes the company (firm) number from the LDA (Local Data Area).

### 2. Main Loop

- **Display Input Screen**: Presents the parameter entry screen to the user.
- **Function Key Handling**:
  - **F3**: Exit program.
  - **F4**: Field inquiry (subroutine `spørring`).
- **Input Validation**: Subroutine `sjekk_input` checks for consistency and existence of entered values.
- **Parameter Packing**: Subroutine `flytt_par` transfers and formats screen fields into a parameter data structure for the printout program.
- **Printout Call**: Calls `FP600C` with the packed parameters.
- **Loop**: Returns to the input screen after printout until user exits.

### 3. Subroutines

#### `spørring` (Inquiry)

Handles F4 inquiries for the field currently in focus (`w_afld`). Depending on the field, it calls the appropriate master data inquiry program, passing relevant parameters and capturing return values for display.

- **B1PRGR** (Price Group): Calls `RA530R`.
- **B1RKAF/B1RKAT** (Discount Category From/To): Calls `RA506R`.
- **B1KKAF/B1KKAT** (Customer Category From/To): Calls `RA511R`.
- **B1KUND** (Customer): Calls `RK500R`.
- **B1KPRO** (Customer Project): Calls `FL500R`.
- **B1VARF/B1VART** (Item From/To): Calls `VV500R`.

#### `sjekk_input` (Input Validation)

Validates the logical consistency and existence of input parameters:

- **Price Group**: If entered, must exist in `ra30l1`.
- **Discount Category**: "From" cannot be higher than "To".
- **Customer Category**: Same as above.
- **Customer vs. Categories**: Cannot specify both a customer and category ranges.
- **Customer**: If entered, must exist in `rkunl1`.
- **Customer Project**: Must be specified with a customer and must exist in `fkprl1`.
- **Item Range**: "From" cannot be higher than "To".

Validation errors are signaled by setting indicator variables (`*in31`–`*in38`) for the display file to highlight the erroneous fields.

#### `flytt_par` (Parameter Transfer)

Packs validated screen fields into a 64-byte data structure (`d_list`) for passing to the printout program. Handles logic for defaulting "To" fields to "From" values if not specified. Builds a unique member name (`w_memb`) for the printout based on the current timestamp.

## Data Structures

### Parameter List (`d_list`)

A 64-byte structure overlaid with individual fields:

- **d_firm**: Company number.
- **d_rkaf/d_rkat**: Discount category range.
- **d_kkaf/d_kkat**: Customer category range.
- **d_kund**: Customer number.
- **d_kpro**: Customer project number.
- **d_varf/d_vart**: Item number range.
- **d_prgr**: Price group (added in version 8.01).
- **d_dumm**: Dummy field, initialized to '*'.

## Business and Domain-Specific Logic

- **Field Ranges**: The program supports both "from" and "to" fields for categories and items, allowing for flexible range selection.
- **Mutual Exclusivity**: Business logic enforces that a specific customer cannot be combined with category ranges.
- **Price Group Expansion**: The price group field was expanded from 1 to 2 positions in version 8.01, reflecting a business requirement for more granular grouping.
- **Member Name Convention**: Output member names are built from a 'W' prefix and a timestamp, likely to ensure uniqueness for each report run.

## Codebase Conventions and Patterns

- **File Renaming**: Logical file names are mapped to short internal names via `RENAME` for clarity and to avoid naming collisions.
- **Field Overlays**: The parameter list is constructed as a single structure with overlays for individual fields, simplifying parameter passing to called programs.
- **Indicator Usage**: Display file indicators (`*in31`–`*in38`) are used for field-level error signaling.
- **Inquiry Subroutines**: All master data lookups are encapsulated in a single subroutine, keyed by the active field, supporting maintainability and extensibility.
- **Versioning Comments**: The code is annotated with version history and change logs, which is important for understanding business evolution.

## Interactions with Other Modules

- **Inquiry Programs**: The program relies on a suite of external inquiry programs for validation and user assistance.
- **Printout Program (FP600C)**: After validation and parameter packing, the main output is delegated to `FP600C`, which performs the actual printout based on the prepared parameters.

## Summary

FP600R is a robust parameter entry and validation utility for special price printouts, tightly integrated with master data and designed for flexible, user-driven report generation. Its structure and logic reflect both technical and business requirements, including strict input validation, support for range-based filtering, and seamless integration with inquiry utilities. The codebase uses overlays, field indicators, and subroutine-driven inquiry/validation as standard patterns.