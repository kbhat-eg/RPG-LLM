# RPG Program LO530R: Explanation

## General Overview

This RPG program, named LO530R, is used for querying orders (bestilling) in an IBM i/AS400 environment. It employs subfiles to present order lists and allows for filtering by user, order date, stock location, and supplier. The program has been maintained and updated to support new requirements over time, including enhanced subfile sizing, filtering options, and improved validation logic.

---

## Main Components

### 1. File Declarations

- **LOHEL1, LOHELD:** Order header files (potentially by different access paths).
- **RLEVL1:** Supplier master file.
- **VOTYL1:** Order type file.
- **LO530D:** Display file, with subfile (B1SFL) and control (B2CTL).

Each file maps to its respective record format for easier field referencing.

### 2. Data Structures

- **LDA Fields:** Extracts information from the Local Data Area (user, company, warehouse).
- **Display Feedback:** Keeps track of cursor position for the display file.

### 3. Working Variables

Includes counters for subfile, record number, current page, user keys, filters, status indicators, etc.

### 4. Indicators

Describes RPG indicator usage for user interface (roll, field protection, errors, etc.), file handling, and status.

---

## Program Flow

### Initialization

In the special *INZSR subroutine, the program:

- Sets up the key lists for file access.
- Gets company/user/warehouse from LDA.
- Initializes filter variables (warehouse, supplier) and order date (defaults to two days ago).

---

### Main Logic

#### 1. Initial Display and Filter Handling

- Assigns initial filter values (user from LDA, date).
- Runs SR XA1WIN to display and validate entry of filter screen.
- Positions the database pointer and fills the subfile with matching order records.

#### 2. Displaying and Browsing the Subfile

- Shows the subfile control and subfile records.
- Handles function key logic:
  - **F3/F12:** Exit.
  - **F5:** Refresh subfile/filter.
  - **RollUp/RollDown:** Paging.
  - **Function keys** for navigation, subfile renewal, and filter calls.

#### 3. Subfile Record Handling

Within the SUBFILE subroutine, iterates over subfile records:

- **Option 5:** View order details (calls LO505R).
- **Option 2:** Transition to order maintenance (calls LO500R).

Handles return to the subfile after these actions.

#### 4. Filter Validation (XA1WIN)

- Validates date entry, warehouse (calls RS710R), and supplier (chains RLEVL1).
- Displays error indicators if invalid.
- Updates filter variables to working storage.

#### 5. Subfile Maintenance

- **Forny (Refresh):** Repositions records and refills the subfile.
- **CRT_SUBFILE:** Reads matching orders and writes them to the subfile, considering all filter criteria.
- **CLR_SUBFILE:** Clears the subfile.

#### 6. Paging Support

- **BCK_SUBFILE:** Handles "roll back" (page up), reads previous page and repopulates the subfile.

#### 7. Supporting Routines

- **Dsp_Subfile:** Manages the display/exfmt of the subfile screen and sets relevant indicators.
- **Sp√∏rring:** (6.10) Allows supplier lookup using a popup routine (RL500R).
- **Vis_Best / Ovg_Best:** Calls appropriate programs to view or edit an order in detail.

---

## Filtering and Validation Details

The program supports dynamic filtering by:

- **Order date**.
- **User**.
- **Warehouse** and **Supplier** (with validation and lookup).
- It ensures only orders with specific characteristics are shown, e.g., only those with behavior code 1 (check via VOTYL1/VAOAKK).

---

## Subfile Management

- Designed for multi-page display and navigation.
- Maintains state for which records/page are currently displayed.
- Supports "subfile renewal" (forny) on changes in filter or position.
- Ensures subfile reflects current filter settings at all times.

---

## Error Handling and User Interface

- Uses indicators to manage error notification (e.g., invalid warehouse/supplier/date).
- Protects fields or disables input as required by context.
- Allows for popup lookups and validation of entry fields.

---

## Integration Points

- Calls out to other programs for detailed order viewing (LO505R), order maintenance (LO500R), stock validation (RS710R), and supplier inquiry (RL500R).

---

## Maintenance Notes

- Comment blocks in the header describe program modifications by version/date and responsible developer.
- Indicator usage is well-documented, aiding in understanding program logic and UI behaviors.

---

## Summary

This RPG program is a robust order inquiry application for IBM i, designed for user flexibility and efficient browsing via subfiles. Key features include sophisticated filter validation, seamless navigation, subfile paging, and integration with related programs for further order handling. The source code is well-commented, providing insight into indicator usage, maintenance history, and the intent behind each subroutine.