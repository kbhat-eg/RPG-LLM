# Explanation of RPG Program NO125R

This RPG (ILE RPG/400) program is designed to process external (imported) order headers and transfer them into the main order system. It specifically supports integration with electronic drawing/order systems, as noted in the comments, and handles various edge cases such as customer credit checks, project information, top/bottom text line management, etc.

## Main Program Structure

**File Declarations**
- The `F` specs declare all the physical and logical files the program will use.
- Files like `nohel1`, `nodtl1`, `fohelur`, etc., are used for reading and updating order headers and lines – both external and internal.
- Display file `no120d` is used for interaction.

**Data Declarations (`D` specs)**
- Parameters (`p_firm`, `p_fsys`, `p_tell`) for company, system, and sequence number.
- Local Data Area: User ID and workstation ID extracted from the LDA.
- Variables for keys, working fields, and values used throughout the program.

---

## Key Logic Sections

### 1. Initial Checks and Data Loading

- The program begins by looking up the external order header (via `nohel1`).
- If not found, it attempts to clean up any partial data in `nohelur` and exits.
- Loads order type, defaulting between fields as required.

### 2. Customer Credit Check

- Retrieves customer record (`rkunl1`) for credit status and credit limit.
- If credit blocked (`rkkres = 1`), sets an error indicator and aborts the process.
- Checks both standard and "almenning" (shared?) credit limits, possibly calling another program (`FO106R`) if the latter is not set on the customer.
- Compares current balance+memo items to the limits, setting error indicators if thresholds are breached.

### 3. Display Entry Screen

- Presents a workstation screen with `exfmt b1bld`.
- Allows F3 (exit), F4 (inquiry), as well as proceeding if validation passes.

### 4. Order Type Validation

- Ensures the selected order type is valid by cross-checking in `votyl1`.
- If not valid, loops back to the entry screen.

### 5. Order Header Creation (`ordre_hode` subroutine)

- Calls `hent_nummer` to obtain the next available order number.
- Initializes a new internal order header (`fohelur`), copying in details from the external header and customer record.
- Handles special EDI fields and additional lookup for invoice-to-customer if set.
- Attempts to fetch user and seller references, prioritizing user- or seller-linked info over customer defaults.
- Handles customer project information and assigns as appropriate.
- Writes the new order header to file.

### 6. Order Line Creation (`ordre_linje` subroutine)

- Determines the highest current line number for the order.
- Handles splitting an external message (`nomeld`) field into multiple text lines (up to 4, 70/70/70/46 chars), calling `FD111R` or, if EDI, writes as top text.
- Reads all external order lines, processes each, and either calls a routine to create a product line (`FD118R`) or a text line (`FD111R`). Handles both product and non-product lines.

### 7. Update Order Header (`oppdat_ordre` subroutine)

- Loops through all order lines to sum amounts:
    - Separate totals for sales, cost, discounts (multiple levels), etc.
    - Applies discounts stepwise (1,2, and bonus rows), updating the running totals.
- Calls `FA922R` to adjust order's memo totals.
- Updates the order header with calculated totals.

### 8. Final Update and Workflow Integration

- Updates the external order header (`nohelur`) to link it to the new internal order number and update audit fields (date, time, user).
- Calls the main order processing program (`FO100R`) to process the new order.
- If the originating system is a web shop (`NBU`), calls `NN750C` to send an order confirmation.

---

## Supporting Subroutines

### `hent_nummer` – Fetching the Next Order Number

- Handles possible overrides to number series by order type.
- Calls an external number series program (`AS100R`).
- Post-processing check removes previously existing order number relations (`FO415R`).

### `hent_linjenr` – Fetch Highest Existing Line Number

- Finds the highest current line number on the order to continue incrementally.

### Initialization (`*inzsr`)

- Handles parameter loading, company initialization.
- Looks up the order status for further processing.
- Retrieves VAT (moms/mva) rates by calling `RS205R`.
- Loads user-related configuration for department/branch assignment.

---

## Data Integrity and Business Logic

The program includes many safeguards:
- Validations for order type, customer credit and balance.
- Ensuring references (seller, user, project) are valid and prioritized.
- Handles both product and non-product (text/memo) lines elegantly.
- Clean-up logic for external data to avoid orphaned references.

---

## Comments

- Norwegian variable names and comments point to a Scandinavian customer base.
- Program has extensive version management and maintenance history in the comments.
- Handles both manual key-in and automated (EDI, web shop) orders.

---

## Conclusion

This program acts as a bridge between external order capture systems and the main order management system, ensuring:
- Full validation,
- Data correctness,
- Robust error handling,
- And proper integration with the rest of the order processing workflow.

Ideal for onboarding: focus on understanding the handling of external orders, customer credit checks, text/product line logic, and the way subfiles/program calls abstract complex business rules. The modular use of external programs for key business logic (e.g., number series, memo updates) keeps the main program readable and adaptable.