# RH190R – Parameter Selection for Budget Distribution

## Overview

This program, **RH190R**, is part of the ASOKON system and is responsible for managing user input and parameter validation for budget distribution operations. Its main function is to collect, validate, and initialize parameters that will be used in subsequent budget distribution processing. The program is typically invoked as a front-end parameter entry screen, likely prior to running reports or batch jobs related to budget allocations.

## Key Business Logic

- **Parameter Entry:** Presents a workstation screen (`A2BLD`) to the user for entering selection criteria such as company, fiscal year, period, department, and account ranges.
- **Validation:** Performs a series of business rule checks on the entered parameters (e.g., valid ranges, valid dates).
- **Initialization:** Initializes parameter defaults based on system date, user, and company information.
- **User Restrictions:** If the user is limited to a specific department, the valid range is automatically set to that department.

## File and Display Interactions

- **AUSRL1:** User master file, keyed by user ID, used to retrieve user-specific restrictions (notably department access).
- **RH195D:** Workstation display file, used for the interactive parameter screen (record format `A2BLD`).

## Program Structure

### Data Definitions

- **Work Fields:** Includes working variables for year, month, user, company, and various parameter fields.
- **Parameter Fields:** Variables prefixed with `a2` (e.g., `a2pavf`, `a2pavt`) are used for screen input and validation.
- **Result Fields:** Variables prefixed with `rhp` (e.g., `rhpkda`, `rhprår`) are used to store validated parameters for downstream processes.

### Indicator Usage

The codebase follows a documented indicator convention:

- **KA/KC:** Function keys (F1=Select company, F3=Exit)
- **LR:** End of program
- **30:** Field protection on display
- **31-59:** Error/warning indicators
- **60-69:** File I/O
- **70-99:** Various working and subroutine indicators

### Main Logic Flow

1. **Initialization (`*INZSR` subroutine):**
   - Sets up default values for parameter fields based on the current date and user/company context.
   - If the user is restricted to a department, sets the department range accordingly.
   - Reads the user master file (`AUSRL1`) for user-specific settings.
   - Sets up the entry parameter list (`plist`).

2. **Parameter Entry Screen:**
   - Displays the `A2BLD` screen for user input.
   - Handles F3 (Exit) by setting a return code and terminating.

3. **Validation:**
   - **Department Range:** Ensures `from` is not greater than `to`.
   - **Account Range:** Ensures `from` is not greater than `to`.
   - **Run Date:** If not provided, defaults to system date. Validates date format.
   - **Fiscal Year:** Cannot be greater than the current year.
   - **Period Range:** Ensures `from` is not greater than `to`.
   - On validation failure, sets the corresponding indicator and redisplays the entry screen.

4. **Parameter Assignment:**
   - Upon successful validation, moves input fields to output parameter fields for use by subsequent processes.

5. **Exit:**
   - Sets LR indicator to end the program.

### Notable Design Decisions & Conventions

- **Indicator Management:** The program relies heavily on RPG indicators for flow control, validation feedback, and UI management, following a documented range allocation to avoid conflicts.
- **Separation of Input/Output:** There is a clear separation between screen fields (`a2*`) and output parameters (`rhp*`), which helps maintain data integrity and simplifies downstream processing.
- **User Restrictions:** The system supports user-level access control at the department level, automatically applying restrictions based on the user master file.
- **Error Handling:** Validation failures are handled by setting specific indicators and looping back to the entry screen, providing immediate feedback to the user.

### External Dependencies

- **AUSRL1:** User information file. If the user record indicates department restriction (`abbavd='1'`), department selection is limited.
- **RH195D (A2BLD):** The display file for parameter entry. The program expects specific fields and indicators to be mapped in the display file.

## Key Variables

- **Input Fields (from display):**
  - `a2pkda` – Run date
  - `a2prår` – Fiscal year
  - `a2pper` – Period
  - `a2ppef`/`a2ppet` – Period from/to
  - `a2pavf`/`a2pavt` – Department from/to
  - `a2pktf`/`a2pktt` – Account from/to

- **Output Parameters:**
  - `rhpkda`, `rhprår`, `rhpper`, `rhppef`, `rhppet`, `rhpavf`, `rhpavt`, `rhpktf`, `rhpktt`

- **User/Company Context:**
  - `l_user`, `l_firm`, `w_user`, `w_firm` – Used for user and company identification and access control.

## Integration Points

- The parameters validated and assigned in this program are intended for use by subsequent programs or batch jobs that perform budget distribution, reporting, or similar financial operations.
- User and department restrictions are enforced centrally via the `AUSRL1` file.

## Summary

**RH190R** is a parameter entry and validation program for budget distribution processes. It ensures that only valid, authorized, and context-appropriate data is passed forward, leveraging user master data for access control and enforcing business rules for financial periods, departments, and accounts. The program is structured for robust error handling and clear separation of concerns, and it follows a documented indicator convention for maintainability.