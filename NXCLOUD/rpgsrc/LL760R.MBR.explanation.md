# RPG Program: ASLAGR - Creating a New Inventory Item

## Overview

This RPG (ILE RPG) program, `LL760R`, manages the creation of a new inventory item (“lagervare”) and performs related updates in inventory and historical stock records. It is intended for use in the ASLAGR system, and has been modified several times to support different requirements—such as always assigning the same item type to inventory as to the item itself, and to support parameter-driven customization (e.g., for the XLNETT client/environment).

## Key Features

- **Initializes and creates a new inventory item in the inventory register.**
- **Removes any existing inventory records for the item.**
- **Creates an entry in the historical inventory book.**
- **Updates order and supply accumulators for the inventory.**
- **Has customer-specific and system-parameter-driven behavior.**

## File Declarations

The program operates over several physical files, representing different aspects of inventory management. All files are declared with external descriptions and often using `RENAME` to change the record format used in the program:

- `vhislu`: Historical inventory book
- `vlagl1`, `vlaglu`: Inventory registers (logical/physical)
- `fstsl1`: Status register
- `vvarl1`: Item master register
- `ra10l1`: Contains all warehouses (added in v5.70)

## Data Structures and Variables

### Parameters

- `p_firm`, `p_vare`: Input parameters representing the firm/company and the item number, respectively.

### Keys and Work Fields

- Various key fields (e.g., `vhislu_lage`, `vhislu_vare`, etc.) are used to access and update the different files.
- `w_firm` is a local work field for the company.

### Control Flags

- `b_skaf`: Indicates if the item is a “skaffe” (procurement only) type, default *off.
- `u_vtyp`: Controls whether item type should always follow the item record (based on a parameter, default *off).

### API for Parameter Control

- **`CO402R`**: External program used to retrieve configuration parameters. The result controls if inventory item type must follow item type.

## Main Program Flow

### Initialization (`*inzsr`)

- Loads input parameters.
- Sets up all key lists for file accesses.
- Fetches the main warehouse from the status register.
- Determines if the item is a procurement (non-stocked) item.
- Calls `CO402R` to check if inventory item type should always match the item base type.

### Main Logic

1. **If item is not procurement-only:**
   - Calls subroutine `lagerbok` to log creation in the historical inventory book.

2. **Deletes all existing inventory records** for this item (`slett_lager`).

3. **Creates new inventory records** for this item in the main warehouse (`nytt_lager`).

4. **Updates order and supply accumulators** by calling programs `FO761R` (order accumulators) and `LA921R` (supply accumulators), passing company and item parameters.

5. **Ends the program** (`*inlr = *on`).

## Subroutine Descriptions

### 1. `lagerbok` - Create Historical Inventory Entry

- Fills in data fields for the historical record, mostly from local variables and parameters.
- Sets the type to `'I'` (indicating "inserted"/"created").
- Writes a record to the historical inventory book (`vhislu`).

### 2. `slett_lager` - Delete Existing Inventory Records

- Iterates through all inventory records (`vlagl1`) for this item and company.
- For each, attempts to `chain` the corresponding inventory record in `vlaglu` and deletes it if found.

### 3. `nytt_lager` - Create Inventory Record in Main Warehouse

- Retrieves the item record to get its default unit, etc.
- Iterates through all warehouses (from `ra10l1`).
- For each, attempts to `chain` the inventory record, and if not found, creates and writes a new, blank-initialized inventory record.
- Handles determination of the inventory item type (`vlvtyp`) based on the following logic:
    - If parameter (`u_vtyp`) is set, always use the item’s master type.
    - Otherwise, use item stock type (`faavty`) if present, else 'S' or master type.
- Sets created/changed timestamp and user for auditing.
- Optionally logs the "fixed data change date" (from v6.20).

## Parameter Handling & Version Control

- The program logs extensive version and change history in comments.
- Customer-specific and system feature flags are managed using fields like `u_vtyp` and the external parameter file/program `CO402R`.

## Key Points for Onboarding

- **All data updates are keyed by company and item.**
- **Inventory type assignment is highly parameterized and configurable.**
- **Integration with external accumulator-updating programs is central.**
- **Program is written in fixed-format RPG with some free-format procedures and declarations (notably for `CO402R`).**
- **Historical and audit information is recorded on every relevant update.**
- **All logic is wrapped in subroutines for modularity.**

---

## Quick Reference: Main Program Steps

1. Initialize (setup keys, parameters, fetch configuration, timestamps).
2. [If not procurement-only]: Log item creation in historical inventory.
3. Remove any existing inventory records for the item.
4. Insert new inventory records for the item in all warehouses.
5. Call external programs to update order and supply accumulators.
6. End program.

---

## Useful to Remember

- **File access and record handling**: Uses RPG's traditional `chain`, `setll`, `reade` for indexed file access and updates.
- **Version-adapted logic**: Many features are controlled by customer and version flags.
- **Parameterization is powerful**: Many behaviors (such as item type synchronization) are controlled by external parameters, allowing for flexible adaptation to client requirements without code changes.
- **Auditing**: Created/changed information is written on every new record.

---

## For Further Exploration

- Review definitions of record formats (`vhispfr`, `vlagpfr`, etc.) for exact file layout.
- Understand how `CO402R` externalizes configuration—this affects the main logic (e.g., `u_vtyp`).
- Explore programs `FO761R` and `LA921R` to see exactly how order and purchase accumulators are handled.

---

**Summary:**  
This program is a systematic, parameter-driven tool for maintaining inventory data integrity and compliance with customer or system requirements when adding new items to inventory, complete with historical, audit, and accumulator update features.