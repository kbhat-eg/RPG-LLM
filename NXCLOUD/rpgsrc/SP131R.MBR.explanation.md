# RPG Program SP131R - Explanation

## Overview

This RPG/400 program is designed for the ASSTAT system. Its primary function is to let users select (utvalg) ranges of item numbers ("varenummer") which are stored and maintained in a parameter file. The code handles both displaying the selection screen and reading/updating/deleting the relevant records in the database.

It consists of the following main logical elements:
- File definitions (display file and database files)
- Data definitions, including working storage and data structures
- Main program logic for loading, displaying, and updating item number ranges
- Subroutines for initialization and for handling item lookup

---

## File Specifications

```rpg
fsp131d    cf   e             workstn    // Display file
fskpml1    if   e           k disk    rename(skpmpfr:skpml1r) // Input file
fskpmlu    uf a e           k disk    rename(skpmpfr:skpmlur) // Update file
```

- `SP131D`: Display (workstn) device file for user interface.
- `SKPML1`: Input file (read only, keyed access) for parameter master (hold initial settings).
- `SKPMLU`: Update file (read/write, keyed access) for user parameter maintenance.

---

## Data Definitions

### Standalone Fields and Data Structures

- **Working fields**:
    - `wptype`, `wptext`, `wpfirm`, `wpvare`, `wptek1`: Temporary fields used during lookups and parameter transfer.
- **Key Fields**:
    - `wwfirm`, `wwtype`, `wwkode`: Used to build the primary key for file access.

- **Data Structure `wwrest`**: Holds parameter text and arrays for the "from" and "to" item numbers:
    - `wwtext`: Description
    - `wwfvar(10)`, `wwtvar(10)`: Arrays for up to 10 'from' and 'to' item numbers.

- **Data Structure `dsuser`** and related fields extract values from user profile data for context.

---

## Program Logic

### Initialization (`*inzsr` subroutine)

- Receives parameters `wptype` and `wptext` (type and description).
- Builds the file key (`wwfirm`, `wwtype`, `wwkode`, `wwvalg`), filling them with company number, type, and a hardcoded code 31.
- Copies parameters into display and working fields.

---

### Main Loop and Display Handling

1. **Tag `b2tagb`: Load Existing Settings**

    - Uses the key built in `*inzsr` to chain into SKPML1 (master parameter) to see if a selection already exists.
    - If found (`*in60 = *off`): Loads stored item number ranges from the record into display fields.
    - If not found: Clears the 'from' and 'to' values (sets to zero).

2. **Tag `b2taga`: Interactive Screen**

    - Displays the selection screen with `exfmt b2bld`.
    - Provides exit options (`*inkc`, `*inkl`).
    - Handles inquiry requests (`*inkd`) by calling the `xspstr` subroutine for item lookup.

    - Validates that each entered 'from' value does not exceed its corresponding 'to' value. If invalid, returns to screen.

3. **Update or Delete Parameter File**

    - Chains into `SKPMLU` to see if a record already exists.
    - Always writes updated item numbers from screen back into the arrays for writing.
    - If the record exists:
        - If both 'from' and 'to' values are zero: deletes the record.
        - Otherwise, updates the record with new ranges.
    - If record does not exist and at least the first 'to' value is non-zero: writes a new record.

---

### Utility Subroutines

#### `xspstr` (Item Lookup)

- Called when the user wants to search for an item number.
- Depending on the field (`wactfe`) the user is searching in, calls another program (`VV500R`) to lookup an item:
    - Passes firm, vare (item) and tek1 (item desc) as parameters.
    - If an item is found, moves its value back into the corresponding 'from' or 'to' field.
- Sets a status indicator (`*in80`) to signal if an item was found and loaded.

---

### Program Exit

- Tag `xslutt` marks program end, sets LR flag (`*inlr = *on`) and returns.

---

## In Practice

### General Workflow

1. When called, the program receives the type and description of the parameter to be maintained.
2. Loads any previous selections for the item ranges.
3. Displays the screen, allowing users to view/update ranges.
4. Validates and writes updates back to the file, or deletes the record if cleared.

---

## Key Variables Cheat Sheet

- **`b2fva1-10` / `b2tva1-10`**: 10 sets of "Fra" (from) / "Til" (to) item numbers the user is maintaining.
- **`wwfvar(1-10)` / `wwtvar(1-10)`**: Arrays mapped to the parameter file structure for storage/retrieval.
- **`key01`**: The composed key for file access (company, type, code, selection value).
- **`wactfe`**: Field identifier for which item is being looked up during search.

---

## Comments on Design

- The code is written in classic RPG/400 (fixed-format), using indicator-based UI control and file I/O.
- Heavy use of MOVEL and EVAL for assignment, and CHAIN/UPDATE/DELETE for database manipulation.
- Minimal error handling; it expects the user to enter sensible data.
- Item range validation is performed field-by-field: each 'from' value must not exceed its corresponding 'to'.

---

## Summary

This program is a classic RPG solution to a common maintenance screen: allowing ranges of item numbers to be selected, validated, and stored in a parameter file. It supports search assistance by calling an external program for item lookup. The code is fairly modular, with clear initialization, lookup, and maintenance logic. The user interface is managed via the display file and controlled through indicators.

For onboarding, focus on understanding:
- The structure of the parameter files,
- How the arrays map to item number inputs,
- The flow of control between main tags and subroutines,
- How to test the interactive item lookup.