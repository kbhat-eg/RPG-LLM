# RPG Source Code Explanation

## General Overview

This RPG program is a batch data conversion or reporting program that reads accounting/transaction lines from multiple files (primarily FOVF) and formats them into a comma-separated (CSV) output for an external system called Uni Micro. It performs lookups and mappings (accounts, VAT codes, departments, etc.), and aggregates per-invoice totals in so-called "record type 80" lines.

### Major Features

- Reads detail lines, transforms, and writes CSV records.
- Performs mapping/conversion of codes via lookup files (e.g., account/group, VAT code).
- Calculates and outputs both detail (type 60) and header/total (type 80) records.
- Handles Norwegian date and decimal formats.
- Makes heavy use of data structure overlays and code lists for keys.
- Uses subroutines for modular logic (control_init, rec80, etc).

---

## Source Structure

### Header Specs

```rpg
h option(*nodebugio) datedit(*dmy)
h decedit('0.')
```
- Sets program options: No debug IO, date input as Day/Month/Year, decimal edit for numeric output.

---

### File Specifications

#### Input ("f") Files

- **fovupf**: Main input file, detail lines.
- **sohel1, votyl1, aforl1, rkunl1, rb10l1, rb00l1**: Lookup files for additional information (customer, order type, routines, account, VAT code mapping). Each is renamed for record name clarity.

#### Output ("o") File

- **rv01pf**: Output file for formatted (CSV) data.

---

### Data Definitions (`d-specs`)

- A variety of working fields, structure overlays for date manipulation, and lookup keys.
- Fields such as `w_biln` (voucher number), `w_bdat` (voucher date), `w_peri` (period), `w_totbel` (total amount) etc.
- Data structures break dates (10 chars) into year, month, day subfields for flexible formatting.

---

### Key Lists

For indexed file access, keys are defined for efficient lookup:
- **rb10l1_key / rb00l1_key**: For account and VAT code mapping
- **sohel1_key**: For facturad-header lookup (company, year, and document number)
- **votyl1_key / aforl1_key**: For order type and routine lookup
- **rkunl1_key**: For customer record lookup

---

## Main Program Logic

### Start/Initialization

- Validates the local data area firm against the input record’s firm.
- Initializes working variables.

### Main Processing Loop (`C` spec code)

1. **Record 80 Handling**  
   When processing a new voucher (`ffbiln`), writes out an '80' record for the previous voucher (invoice header/total).

2. **Field Preparation / Mapping**
   - **Dates:** Formats for output and field alignment, e.g., `w_fx` as DD.MM.YYYY.
   - **Amounts:** Converts base amounts for detail and summary lines.
   - **Code Lookups:**
     - Bilagstype (voucher type), VAT codes (for both debit/credit), account mappings.
     - Handles both 'debet' (debit) and 'kredit' (credit) posting logic.

3. **Write Detail Records (Record Type 60)**
   - For each debit or credit line, constructs a CSV string using the current field values and writes to output.

4. **Post-Loop: Final Record 80**
   - On last record/EOF, checks if any "open" voucher needs a header written.

---

### Subroutines

#### `control_init`
- Fetches header (invoice) information from **sohel1** for the current voucher.
- Sets total amounts and other header-level fields.
- Looks up routine code (for KID-number assignment).

#### `rec80`
- Writes a type '80' (summary) record to the output using currently accumulated totals and header info.
- Resets relevant accumulator fields afterward.

#### `*inzsr`
- Initializes key lists for lookups.

---

## Example Data Flow

1. Reads each transaction line from `fovupf`.
2. Gathers mapping/lookup data as needed from the auxiliary files.
3. Prepares formatted fields: especially dates and amounts.
4. Writes a type '60' detail record per eligible posting (both debit and credit, if present).
5. When voucher/bilagsnr (`ffbiln`) changes, or at EOF:
    - Writes type '80' record summarizing the voucher.

---

## Norwegian/Scandinavian Context

- Fields like `ffkund`, `ffbiln`, `ffmom`, etc. use Norwegian financial/accounting terminology.
- Comments and variable names are mostly Norwegian.
- Date and number formatting follow Norwegian conventions.

---

## Key Takeaways

- The program is data-driven, using lookups for translation and mapping.
- Output is highly structured, designed for import to another accounting system.
- Uses subroutines for code reuse (lookups, formatting, record output).
- Handles both detail lines (60) and summary lines (80).
- Extensively uses data structures for date manipulation and formatting.

---

## Onboarding Notes

- **Understand the input files and their layouts**: The program is tightly coupled to the underlying database schema.
- **Lookup tables are crucial**: VAT, accounts, routines are all externally mapped—make sure those files are available and populated.
- **CSV output is constructed manually**: All field formatting and delimiter logic is handled in string concatenation, so modifying output format means patching these sections.
- **Be aware of old-style RPG constructs**: The code uses fixed-format RPG with explicit `C` specs, not the more modern free-format RPGLE.
- **Test with representative data**: To see interactions and output across typical and boundary cases (e.g., unusual date values, code mismatches).

---

### For More Detailed Onboarding

- Review and map the physical files (`FOVF`, `SOHE`, etc.) to what your business/data expects.
- Walk through one full voucher/bilag cycle in test data, tracing from input detail through all lookups to output.
- Pay attention to the record-numbering and CSV record construction logic.
- Check for any recent changes (see the `*K00` change logs in the comments, e.g., version 7.00, 7.01, 7.02).

---

**In summary:**  
This is a batch RPG program for translating accounting/posting records (from FOVF) to a specific CSV format required by Uni Micro, using multiple mapping files for code conversion, and writing both detail and summary records on a per-invoice basis.