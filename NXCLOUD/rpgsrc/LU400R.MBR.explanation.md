# RPG Program LU400R: "Sletting av lagertelle-bunt" (Inventory Count Batch Deletion)

This program is written in IBM ILE RPG and is used to delete an inventory counting batch in an AS/400 (IBM i) environment. Below, you'll find a step-by-step explanation of its structure and logic.

---

## 1. **Program and File Declarations**

- **Program Name:** LU400R  
- **Purpose:** Delete an inventory counting batch ("lagertelle-bunt") and associated lines.
- **Files Used:**
    - `lbhelu`: Inventory count batch header (LAGER-TELLEBUNT-HODE), update file (`uf`, `k disk`)
    - `lbdtl1`: Inventory count batch lines, input file (`if`, `k disk`)
    - `lbdtlu`: Inventory count batch lines (update), update file (`uf`, `k disk`)
- **File Renames:** Filenames are renamed at program level for internal use.

---

## 2. **Data Area and Variables**

- **LDA (Local Data Area) Usage:**
    - Extracts a firm/company number from the LDA (`l_firm`).
- **Key Variables:** 
    - Variables with the `_batc`, `_numm`, `_line` suffixes represent batch number, number, and line number portions of composite keys for file access.
- **Parameter Variables:**
    - `p_batc`, `p_deor`, `p_firm`, `p_numm`: Incoming parameters from the calling program.
- **Working Variables:**
    - `w_firm`: Holds the active company/firm value.

---

## 3. **Key Lists (KLIST) Setup**

Key lists (`klist`) define the composite keys used for file operations.

- **lbhel1_key/lbhelu_key:** Used to access and update "header" records.
- **lbdtl1_key/lbdtlu_key:** Used to access and update "line" records.

Each key comprises company, batch number, and (where applicable) line number.

---

## 4. **Parameter List and Initialization (*INZSR)**

### *ENTRY PLIST

- Receives four parameters:
    1. `p_deor`: Operation code (1 character)
    2. `p_firm`: Company/firm code
    3. `p_batc`: Batch number
    4. `p_numm`: Number

### *INZSR (Initialization Subroutine)

- Copies parameters into working variables and key variables for subsequent file access.

---

## 5. **Program Logic (Mainline)**

### **A. Checking Inventory Count Batch Header**

```rpg
c     lbhel1_key    chain     lbhelur                            92
c                   if        *in92 = *off
c                   unlock    lbhelu
c                   endif
```

- **Purpose:** Tries to read the batch header record (`lbhelur`) using the composite key. If found (`*in92 = *off`), unlocks the record for processing.

---

### **B. Deleting Inventory Count Batch Lines**

```rpg
c     lbdtl1_key    setll     lbdtl1r
c     lbdtl1_key    reade     lbdtl1r                                90
c                   dow       *in90 = *off
    ... // (see below)
c     lbdtl1_key    reade     lbdtl1r                                90
c                   enddo
```

- **Purpose:** Loops through all line records for the batch.
  - Uses `setll` (Set Lower Limit) and `reade` to iterate through matching detail records.
  - For each line:
    - Copies the line number (`lvline`) to the key variable.
    - Tries to chain (fetch by key) the update file (`lbdtlur`).
    - If the record exists, deletes it.

---

### **C. Deleting Inventory Count Batch Header**

```rpg
c     lbhelu_key    chain     lbhelur                            92
c                   if        *in92 = *off
c                   delete    lbhelur
c                   endif
```

- **Purpose:** Chains (positions by key) to the header record. If it exists, deletes it.

---

### **D. End Program**

```rpg
c     end_pgm       tag
c                   eval      *inlr = *on
c                   return
```

- **Purpose:** 
    - Sets the *LR (Last Record) indicator to signal program termination and resource cleanup.
    - Returns control to the calling program.

---

## 6. **Subroutines**

### **INIZSR (Initialization Subroutine)**
- Sets up key lists and working variables using parameter input.

---

## 7. **Comments and Documentation**

- The program is well-commented in Norwegian:
    - "Sletting av lagertelle-bunt": Deletion of inventory count batch.
    - "tellebunt - hode": batch header.
    - "tellebunt - linje": batch line.
    - "Tar inn parameter fra forrige program": Receives parameters from previous program.
    - "Legger inn startverdier": Sets initial values.

---

## 8. **Summary of Workflow**

1. **Initialization:** Load parameters, set up keys.
2. **Check Header:** Ensure the batch header exists.
3. **Delete Lines:** For each line in the batch, delete it from the update file.
4. **Delete Header:** After all lines are deleted, delete the batch header.
5. **Cleanup and Return.**

---

## 9. **Error Handling**

- Uses RPG indicators (e.g., `*in90`, `*in92`) to check the result of file operations (not found, end of file, etc.).
- No explicit error reporting (logging or messaging) is implemented—processing is silent unless enhanced elsewhere.

---

## 10. **Typical Usage**

- **When to Run:** Called from another program after a user requests deletion of an inventory counting batch.
- **Effects:** Removes all data associated with a selected batch from both the header and line-level files.

---

## 11. **Key Concepts for Onboarding**

- **File Access:** Strong use of composite keys and key lists for efficient indexed file operations.
- **Batch Structure:** Each batch ("bunt") has a header and multiple lines; deletion is hierarchical.
- **Indicators:** Crucial for control flow—check and interpret their values after each file operation.
- **Subroutine Organization:** `*INZSR` is used for all startup logic; mainline code performs the actual deletions.

---

If you have questions about specific file field names or need further details, consult the associated DDS (physical file definitions) for `lbhelu`, `lbdtl1`, and `lbdtlu`.