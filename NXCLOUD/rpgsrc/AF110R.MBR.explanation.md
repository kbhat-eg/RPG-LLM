# Explanation of AF110R RPG Program

This RPG program (AF110R) is designed for IBM i (AS/400) systems using ILE RPG (RPG IV, also known as RPGLE). The main purpose of this program is to serve as a log viewer and manager for FTP activity, providing functions to display, scroll, delete, and view details of FTP log entries in an interactive subfile display.

Below is a detailed breakdown to help developers get onboarded:

---

## 1. **Header and Options**

```rpg
h option(*nodebugio) datedit(*dmy)
```

- **option(*nodebugio):** Disables I/O debugging.
- **datedit(*dmy):** Dates will default to Day-Month-Year format when edited.

---

## 2. **File Declarations**

### Log File Access

```rpg
fafthl1 if   e           k disk    rename(afthpfr:afthl1r)
fafthlr if   e           k disk    rename(afthpfr:afthlrr)
fafthlu uf a e           k disk    rename(afthpfr:afthlur)
faftllu uf a e           k disk    rename(aftlpfr:aftllur)
```
- Defines main log header and detail files, renamed for use in this program.
- **f**: File name as referenced in RPG code.
- **if/uf**: Input/Update file.
- **e**: External (record format defined externally).
- **k**: Keyed access.
- **disk**: Disk file.

### Display File (Workstation / Subfile)

```rpg
faf110d cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **faf110d**: Main display file.
- **sfile(b1sfl:w_srrn)**: Declares a subfile control, connects record format `b1sfl` to subfile relative record number `w_srrn`.
- **infds(dspfbk)**: Associates an information data structure (`dspfbk`) for display feedback.

---

## 3. **Data Structures & Variables**

### LDA (Local Data Area) Access

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- **uds**: User Data Space access (LDA).
- Used to retrieve the user's firm number and other info.

### Feedback & Positioning

```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0   // First record number on page
```
- Display file feedback for subfile positioning.

### Key and Working Variables

- Multiple variables like `afthl1_navn`, `afthlr_uidn`, etc., hold keys for different log files.
- Numeric variables keep track of subfile paging (`w_fcrn`, `w_srrn`, `w_spge`, etc.).
- Flags (`b_oppr`, `b_forn`, etc.) for control flow and screen logic.

---

## 4. **Indicator Usage**

- Indicators (*IN..) are used for UI and program state management.
- E.g., *IN12 = show subfile, *IN14 = clear subfile, *IN15 = subfile ending, etc.

---

## 5. **Screen Layout & Subfile Control**

- Subfiles are used to display lists of log records, supporting page-wise navigation, selection, and commands (delete/view).
- B1SFL: Subfile record.
- B2CTL: Subfile control record (page control, buttons).
- C2BLD: For create/change/view details.
- D1WIN: Popup window for delete confirmation.

---

## 6. **Main Program Flow**

### 6.1 Initial Display Loop

1. **Write Command Line (b2cmd).**
2. **Display Subfile (exsr dsp_subfile).**
3. **Process Function Keys:** A `select` block handles common navigation and actions:
   - *INKC / *INKL: Exit program.
   - *INKE: Refresh subfile.
   - *IN10 (Roll): Next page.
   - *IN11 (Rolldown): Previous page.
   - *IN21: Home - Reposition.
   - *IN22: Cursor placement.

### 6.2 Subfile Handling

- **exsr subfile**: Reads through the loaded subfile and processes "actions" (like delete/view log entry) by checking the value of selection fields (e.g., b1valg).

---

## 7. **Core Subroutines**

### **forny** - Refresh Subfile

- Positions file, clears, and rebuilds subfile based on current context/keys.

### **posisjoner** - Reposition in Subfile

- Allows user to jump directly to a record using a code (partly commented out), clears and refills subfile as needed.

### **subfile** - Process Subfile Records

- Loops through displayed subfile records:
    - If user selects **delete** (valg=4), opens delete window and processes deletion.
    - If **view log** (valg=7), calls another program (AF111R) to show details.

### **xd1win** - Delete Window Processing

- Confirm and process the deletion of selected header and associated log lines.

### **clr_subfile** - Clear Subfile

- Sets indicators for subfile clear, zeros paging variables.

### **crt_subfile** - Build Subfile Page

- Fill subfile page by reading database records, formatting display fields, and writing to subfile.

### **bck_subfile** - Back Up One Subfile Page

- Logic for rolling back (previous page) in subfile.

### **dsp_subfile** - Display Subfile

- Presents the subfile or command screen to the user and updates feedback variables.

### **\*inzsr** - *INIT Subroutine

- Handles program initialization:
    - Reads parameters (like user, firm, navigation name) from LDA and input.
    - Prepares key lists for file access.
    - Prepares screen and subfile for first display.

---

## 8. **Key List Declarations**

- Key lists (klist/kfld) are defined for efficient SETLL/CHAIN/READE/READPE operations on log files.

---

## 9. **File Control & Error Handling**

- Consistent use of EOF indicators and key fields ensure robust paging and record handling.
- Logical separation of update, delete, and display operations.

---

## 10. **Comments and Documentation**

- Good in-code comments clarify:
    - Indicator usages.
    - Field roles in subfile and screen management.
    - Overall flow and intent of each major subroutine.

---

## 11. **Localization**

- Comments and variable names are in Norwegian (ex: "Beskrivelse", "Forny", "Bla tilbake").
- Field names (navn, uidn, dato, etc.) are consistent with their usage: "navn"=name, "dato"=date, "uidn"=unique id.

---

## 12. **Typical User Actions**

- When the user runs this program, they see a paged list of FTP log entries for their firm.
- They can scroll, search, delete, or view individual logs.
- All state is preserved across interactions through global variables and indicators.

---

## 13. **Inter-Program Calls**

- Calls external program AF111R to view additional log details for a given log record.

---

# **Summary Table**

| Section             | Responsible For                                           |
|---------------------|----------------------------------------------------------|
| File Declarations   | Defining log, detail, and display files                  |
| Variables/DS        | Holding keys, paging counters, subfile state, LDA fields |
| Indicators          | Managing UI state, subfile state, etc.                   |
| Main Loop           | Handling display loop and function keys                  |
| Subroutines         | Operations: fill, clear, scroll, display, delete, etc.   |
| Initialization      | Setup keys, variables, initial subfile fill              |

---

## **Onboarding Tips**

- Familiarize yourself with subfile programming in RPGLE.
- Understand the Norwegian comments â€“ they follow the code structure closely.
- Trace indicator meanings in the comment block for quick debugging.
- Use the key lists and file format declarations as reference for data structure mapping.
- Remember that display file (DSPF) fields must match program variable names/definitions.

---