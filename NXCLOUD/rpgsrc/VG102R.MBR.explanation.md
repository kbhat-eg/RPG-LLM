# RPG Program Explanation: VG102R - Undergruppe Vedlikehold (Subgroup Maintenance)

This RPG program is designed for "Undergruppe vedlikehold" (Subgroup maintenance), typically part of a product master data management system on IBM i (AS/400). The code is written in traditional (fixed-format) ILE RPG.

---

## 1. **High-Level Overview**

The program manages subgroups related to products by providing a subfile-based interface (interactive display with record lists), supporting CRUD operations (Create, Read, Update, Delete), and lookup functions for related entities (accounts, units, responsible persons, etc).

**Main features:**
- Display, add, copy, update, and delete subgroup records.
- Navigate the subfile pages (paging, lookup).
- Validate related fields (account codes, responsible persons, units, item numbers).

---

## 2. **File Definitions (`F-specs`)**

All relevant physical files are defined for keyed access, sometimes with specific record format renaming:
- **vugrl1, vugrl2, vugrlr, vugrlu**: Variants of the subgroup file (presumably for different access paths).
- **vogrl1, vhgrl1, vkhvl1, venhl1, vvarl1, ra26l1**: Lookup files for overgroups, main groups, account references, units, item numbers, and responsible persons.
- **vg102d**: The display file, using the workstation device. Subfile `b1sfl` is used for the main list.

---

## 3. **Key Data Structures and Variables**

- **Parameters**: `p_firm`, `p_ogrp`, `p_hgrp` — firm (company), overgroup, main group; passed at program start.
- **User-space fields**: `l_user`, `l_fnav` — user IDs, navigation aids.
- **Subfile paging variables**: `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc., manage paging and record numbers for the subfile.

---

## 4. **Indicator Usage**

- Indicators like `*IN10`, `*IN11`, `*IN12` etc. are used for typical DSPF actions (Roll, Rolldown, Subfile display, Clear, End, Home, cursor positioning, field protection, error notification).

---

## 5. **Major Processing Flow**

### **Entry Point / Initialization**

- Parameters are fetched (`*ENTRY` plist).
- Lookup keys are established (`KLIST`).
- The display file is primed with initial records and details for the selected overgroup and main group are loaded for display.
- The subfile (list of subgroups) is positioned and filled accordingly.

### **Main Loop (Display and Function Handling)**

- **Tags `b2taga` and `b2tagb`** mark the main interactive loop.
- The primary screen (`b2ctl`) is written and awaits user input.
- Depending on which function key is pressed, the program:
  - Exits (`*INKC`, `*INKL`)
  - Refreshes the subfile (`*INKE`)
  - Opens the new entry screen (`*INKF`)
  - Pages forward/back (`*IN10`, `*IN11`)
  - Handles cursor positioning/home (`*IN21`, `*IN22`)
- Subfile maintenance (`subfile` subroutine) checks which records are selected for action (edit, copy, delete, view), and invokes the relevant maintenance subroutine.

---

## 6. **Key Subroutines**

### 1. **`forny`**: Refresh Subfile
- Refreshes the subfile; re-positions based on the current or previously selected record.

### 2. **`posisjoner`**: Position Subfile
- Positions the list to a certain subgroup or description provided by the user.

### 3. **`subfile`**: Handles Subfile Record Actions
- Loops through subfile entries, acting on user selections (edit/copy/delete/view).

### 4. **`xc1bld`**: Handle New Row Entry
- Handles creation of new subgroups, checking if a record exists before allowing the operation.

### 5. **`xc1msg`**: Show Already Exists Message
- Displays a warning if a subgroup is being created that already exists.

### 6. **`xc2bld`**: Edit/Copy/View Entry
- Handles editing, copying, and viewing with full field validation and external lookup calls as needed.
- Validates all reference fields (account, units, responsible, item, etc.) by chaining to respective files or calling other programs.

### 7. **`xd1win`**: Delete Entry
- Processes the delete confirmation window and removes the subgroup.

### 8. **`xk1win`**: Copy Entry
- Handles copying from an existing subgroup to a new one with key existence checks.

### 9. **`clr_subfile`**: Clear Subfile
- Clears subfile contents and resets paging controls.

### 10. **`crt_subfile`**: Fill Subfile
- Populates subfile with subgroup records, applying the appropriate key path and filter.

### 11. **`bck_subfile`**: Page Back
- Handles subfile page back logic.

### 12. **`dsp_subfile`**: Display Subfile Window
- Manages subfile display; sets indicators for display/update.

### 13. **`*INZSR`**: Program Initialization
- Sets up the environment; runs at program load.

---

## 7. **Program Structure/Navigation**

- The code uses a traditional RPG tag/goto structure to manage main logic loops.
- There is heavy reliance on *indicator arrays* for function keys, subfile control, and error management.
- External programs are called for lookups (e.g., `VA510R`, `VV500R`), common for RPG applications integrating with master data.

---

## 8. **Screen Layouts**

- Multiple screens are referenced in comments and code:
  - Main subfile list (B1SFL/B2CTL)
  - Command key window (B2CMD)
  - New entry (C1BLD), message (C1MSG)
  - Edit/view (C2BLD)
  - Delete window (D1WIN)
  - Copy window (K1WIN)

---

## 9. **Validation and External Lookup**

- When entering or editing fields like units, account codes, or responsible persons, the user can press a function key to lookup from other files. Validation subroutines chain against these files and set indicators if codes are invalid.

---

## 10. **Field and Variable Naming**

- Most field names are patterned after the logical database fields (e.g., `vgufir` for firm, `vguogr` for overgroup).
- Work variables (`w_`), buffer fields for keys (`vugrl1_uugr`), etc., follow a consistent prefixing convention.

---

## 11. **Additional Notes**

- Comments are in Norwegian, aligning with the code's origins.
- The program is modular, with subfiles and pop-up windows supporting a good user experience for maintaining hierarchical data.
- The code is written for stability and transactional integrity, always validating before updating or deleting.

---

## 12. **Summary for Developers**

- This code supports complete interactive management of product subgroups, including lookup and validation for all related reference fields.
- Subfile and window techniques are leveraged for efficient data entry and navigation.
- Function keys (indicators) drive user actions and screen flows.
- The program is easy to extend with new reference lookups or subgroup attributes, as all validations and user flows are encapsulated in clear subroutines.
- For new team members, understanding the subfile mechanism, indicator handling, and "CHAIN"/"SETLL"/"READ" file operations will be key to maintaining or extending the program.

---

### **If you are onboarding:**
- Familiarize yourself with the referenced physical files and their layouts.
- Understand subfile mechanics in RPG, as much of the UI depends on this.
- Review the called programs (e.g., `VA510R`, `VV500R`) and how their parameters map to fields in this program.
- Pay attention to how indicators map to screen fields, error handling, and paging.
- The code is well-commented in Norwegian; use translation if needed, but naming is consistent and logical.

---

**This program is a good example of classic AS/400 interactive RPG development, mixing subfiles, external validation, and data-integrity controls.**