# RPG Program RA512R – Program for List Display and Selection of Country Codes

This program is written in RPG/400 (also known as RPG III/IV with ILE features), for the IBM i (AS/400) platform. The primary function is to display country codes in a subfile, allow the user to scroll pages, and select a record. Below is a detailed breakdown by section:

---

## Header and Comments

- **`h option(*nodebugio) datedit(*dmy)`**  
  Sets program options: no debug for I/O routines, and date format is day/month/year.

- Comments outline:
  - System: ASOKON
  - Program: RA512R
  - Description: Country codes, inquiry
  - Version/Change history
  - Indicator usage for program flow and screen handling
  - Subfile and screen layout explanation

---

## File Declarations

```rpg
fra12l1    if   e           k disk    rename(ra12pfr:ra12l1r)
fra12l2    if   e           k disk    rename(ra12pfr:ra12l2r)
fra512d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- `fra12l1` and `fra12l2`: Input files, externally described, renamed record formats. Likely refer to master files of country codes.
- `fra512d`: Workstation file for display, with subfile `b1sfl` controlled by subfile record number `w_srrn`.

---

## Data and Parameter Definitions

### Parameters (Entry)

```rpg
d p_firm          s                   like(ralfir)
d p_lkod          s                   like(ralkod)
d p_ltxt          s                   like(raltxt)
```
- Parameters passed to the program: company (firm), country code (lkod), country description/text (ltxt).

### Key Variables

```rpg
d ra12l1_lkod     s                   like(ralkod)
d ra12l2_ltxt     s                   like(raltxt)
```
- Used for keying into files for record positioning/searching.

### Working Variables

```rpg
d w_stel          s              4  0
d w_spge          s              4  0
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
d w_seqe          s              1
d b_valg_ok       s              1    inz(*off)
d w_firm          s                   like(ralfir)
d c_sfil          s              2  0 inz(8)
```
- Variables for subfile control (counter, page size, first/last record on page etc.)
- `w_seqe`: Mode for sequencing by code (`' '` – default) or description (`'B'`)
- `b_valg_ok`: Flag to indicate selection made

---

## Subfile Handling and Explanation

- Subfile is used for displaying records, page by page, with scroll and select.
- Several subroutines exist for subfile maintenance:
  - `clr_subfile`: Clears the subfile display.
  - `crt_subfile`: Creates/fills the subfile page, reading from the appropriate file.
  - `subfile`: Handles user selection in the subfile.
  - `dsp_subfile`: Displays the subfile and control screens.
  - `bck_subfile`: Scrolls the subfile page backward.
  - `forny`: Refreshes the subfile based on the current position/key.
  - `posisjoner`: Repositions subfile to a given country code or description.

---

## Main Program Cycle

### Tags and Screen Operations

```rpg
c     b2taga        tag
c                   write     b2cmd
```
- Display initial command screen.

### Main Display Loop

```rpg
c     b2tagb        tag
c                   exsr      dsp_subfile
c                   if        w_curn > 0
c                   ...
```
- Show subfile (table of country codes)
- If the cursor is positioned (`w_curn > 0`), recalculate the top record for paging.

### Handling Function Keys

```rpg
c                   select
c                   when      *inkc or *inkl  // F3 or F12 (exit keys)
c                   goto      avslutt
c                   when      *inke           // F5 (refresh)
c                   exsr      forny
c                   goto      b2tagb
c                   when      *in10           // Page down/subfile page
c                   exsr      crt_subfile
c                   goto      b2tagb
c                   when      *in11           // Page up
c                   exsr      bck_subfile
c                   goto      b2tagb
c                   when      *in21           // Home-key
c                   eval      *in22 = *on
c                   goto      b2taga
c                   endsl
```
- Standard AS/400 function keys for paging, refresh, exit, etc.
- *in22 used for cursor positioning on screen.

### Position By Code or Description

```rpg
c                   if        b2lkod <> *blank or
c                             b2ltxt <> *blank
c                   exsr      posisjoner
c                   goto      b2tagb
c                   endif
```
- If the user enters a code or description, reposition the subfile.

### Subfile Processing

```rpg
c                   exsr      subfile
c                   if        b_valg_ok = *on
c                   goto      avslutt
c                   endif

c                   goto      b2taga
```
- Process selection from subfile; if a selection is made, exit the program.

### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Set LR for clean program end.

---

## Subroutines

### forny (Refresh Subfile by Position)

- If `w_sfrn` is set, positions the file by key (either code or description).
- Calls `clr_subfile` and `crt_subfile` to rebuild the visible subfile.

### posisjoner

- Repositions subfile according to entered code (`b2lkod`) or description (`b2ltxt`)
- Blanks out position input fields after use.
- Calls subfile create/clear routines.

### subfile

- Toggles *in22 on/off for cursor placement.
- Loops through visible subfile records (`do w_ssrn` ... `readc b1sfl`)
- Checks for user select (`b1valg = 1`), sets output parameters and flag.

### clr_subfile

- Sets *in14 to clear subfile, writes control record, resets subfile pointers.

### crt_subfile

- Fills subfile page by reading from the appropriate file (by code or description, based on `w_seqe`)
- Adds each record to the subfile up to the page size.
- Sets end-of-file indicator and last record number.

### bck_subfile

- Used to scroll back a page in the subfile.
- Reads backward (using `readp`) to the start of the page, then refills the subfile.

### dsp_subfile

- Formats and displays the subfile screen.
- Handles display indicators *in12/*in13 for SFLDSP/SFLDSPCTL.

### *inzsr (Initialization Subroutine)

- Sets up parameters and working variables.
- Sets up keys for both code and description-based searches.
- Sets initial position and fills the first subfile page.

---

## Key Data Structures

- **KLIST (`ra12l1_key`, `ra12l2_key`)** – Key lists for file positioning, by company+code or company+description.
- **Subfile (b1sfl), Subfile Control (b2ctl), Command (b2cmd)** – Display file records, possibly *DSPF* source, to handle the user interface.

---

## Indicator Usage

Indicators (`*inxx`) are vital for controlling:
- Program flow (`*inlr`)
- Subfile operations (roll up/down, SFLDSP/SFLDSPCTL, SFLCLR, SFLEND)
- Field protection and cursor handling
- User action feedback

Refer to the comment block at the top for a mapped reference of indicators.

---

## Overall Logic Flow

1. **Initialization:** Reads parameters and sets up the display.
2. **Display loop:** Shows the subfile, handles paging and function keys.
3. **Selection:** Lets the user position by code/description, page in subfile, and select a record.
4. **Termination:** Returns selected values (via parameters) and ends the program.

---

# Summary

This program provides a standard subfile display and selection interface for country codes, integrates typical AS/400 function key handling, and allows user repositioning within the data set. It applies familiar RPG/400 techniques for subfile management, including page navigation, search/reposition, and selection, all controlled with indicators and subroutines.