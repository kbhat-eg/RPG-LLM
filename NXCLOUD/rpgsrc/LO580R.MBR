     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASLAGR
      * Program . . . . : LO580R
      * Beskrivelse . . : Vise bestilling - matche mot ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       251005 BØ   Nytt program
5.60  * R5.60 061107 AMD  Lagt inn løsning for kontroll av grense for
      *                   almenningsrabatter
      *
      * R6.10 240609 BSA  Oppdatert med sporingsinformasjon
6.10  * R6.10 250809 BSA  Utvidet ref. felter fra 20 til 30 posisjoner
6.11  * R6.10 301209 BSA  Kaller FD105R m/utvidet parameterliste
6.20  * R6.20 060411 BSA  Utvidet fuksjonalitet med synkronisere best og ordre
6.21  * R6.20 071111 BSA  Hvis avvikende enheter kan vi ikke synkronisere antall
6.22  * R6.20 081111 BSA  F14 måten for masseendring fungerer ikke i jacada
6.23  * R6.20 260312 BSA  Utvidet parameterliste til FO701R
6.24  * R6.20 231012 BSA  Bruker feil pris ved logging av endringer
6.25  * R6.20 210113 BSA  Initierer subfile med større side
6.26  * R6.20 230113 BSA  Bruker feil linjenummer ved synkronisering
6.27  * R6.20 190213 BSA  Sjekker om vi finner ordre før oppdatering.
6.28  * R6.20 301013 BSA  Endrer felt for håndtering av kostpris.(Ref
6.28  *                   felter)
6.29  * R6.20 211113 BSA  Bruker feil linjereferanse
6.2A  * R6.20 210214 BSA  Oppdatering via F14 klarer ikke fange opp
6.2A  *                   alle endringer.
6.2B  * R6.20 071015 BSA  Feil linjenummer sendes over til program for
6.2B  *                   opprettelse.
6.2C  * R6.20 081015 BSA  Sjekker på feil status ved F3 fra mail.
6.2d  * R6.20 211015 BSA  Problemer med scroll
6.2e  * R6.20 221215 BSA  Finn siste linjenummer fra ordren, hvis ny linje
6.nu  *       250514 bof  Utvidet mtp. nummerutvidelse
6.30  * R6.30 120914 bsa  Utvidet parameterliste til FO798R. Håndtering av
6.30  *                   flere mailfelter.
6.31  * R6.30 220416 bsa  Kaller cl for å overstyre printerfile LO581P
6.31  *                   Virker som den kommer ut på skriver.
6.32  * 6.30  170918 bkv  Utvidet med trelast sortiment
6.33  * R6.30 270717 bsa  Bruker verdier fra bestilllingen og ikke fra subfilen
      *
7.xx  *       170917 BKV  Endringer relatert til ny GUI
7.01  * 7.00  090519 bsa  Hvis utfylt bekreftet leveringsdato,
7.01  *                   oppdateres tilhørende ordre.
7.02  * R6.30 111017 BSA  Legger ut varetypen i skjermbildet
7.03  * R6.30 011019 NHO  Varetype skal være blank dersom alle = S
7.04  * K000  050221 bsa  Justert skjermbilde pga cloud
7.05  * K000  050221 bsa  Styre om innkjøpspris sjekkes mot kostpris
7.05  * K000              på ordren.
7.06  * K000  050321 bsa  Justert endringer på switch u_705
7.07  * K000  030521 bsa  Justert endringer på switch u_705 - fortsetter
7.12  * MGR   151216 sst  Styre oppdat memosaldo avhenig av dato/dager
7.12  *       170117 sst  Hente parameter meosaldo fra AFPSPF
      *
7.fb  * K000  220318 bof  Sjekk om ordre er forhåndsbetalt,ikke mulig m/till.
      *
8.01  * K000  291121 bsa  Utvidet til bredt skjermbilde og til å takle
8.01  * K000              forskjellige enheter.
8.02  * K000  240122 bsa  Skal akseptere å oppdatere linje, selv om det
8.02  * K000              forskjell på enheter.
8.03  * K000  231122 sst  Flyttet ant memo-dager og utv.kreditgrense til  UTVIDET_MEMOSALDO (nx)
8.04  * K000  201222 bsa  Endret flagging av avvik
8.05  * K000  060123 bsa  Omregner så lenge det er avvikende enheter.
8.06  * K000  090123 bsa  Program feiler hvis indikator står på under
8.06  * K000              under CLR_SUBFILE.
8.07  * K000  100123 bsa  Flagger feil på antall/pris hvis enheter er like.
8.08  * K000  250123 bsa  Hvis tilknyttet SO og det er flåtestyring, send
8.08  * K000              oppdatering.
8.09  *K000   060223 bsa  Flagg om sjekk på loggkode i transportlogging
8.10  *PRG2   210622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner
8.11  * K000  270625 bsa  Bruker feil referenaser for å finne siste linjenummer.
      *
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Bruk av indikatorer:
      *
      *       LR = Avslutt program
      *       10 = Roll
      *       12 = Sfldsp
      *       13 = Sfldspctl
      *       14 = Sflclr
      *       15 = Sflend
      *       16 = Readc 16 on, no more records
      *       21 = Home-key
      *       22 = Plassering av cursor
      *       30 = Protect av felter ved vise
      *    31-59 = Varsle m/feilmeldinger/skjermindikatorer
      *    60-69 = Fileindikatorer chain etc.
      *    70-79 = Arbeidsindikatorer i sub-rutiner
      *    80-89 = Arbeidsindikatorer ordinære
      *    90-99 = Benyttes ved std. sub-rutiner
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flohel1    if   e           k disk    rename(lohepfr:lohel1r)
     frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
     flodtl1    if   e           k disk    rename(lodtpfr:lodtl1r)
6.20 flodtlr    if   e           k disk    rename(lodtpfr:lodtlrr)
     ffodtlr    if   e           k disk    rename(fodtpfr:fodtlrr)
6.2e ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
6.2e f                                     prefix(fx:2)
7.01 ffodtlu    uf   e           k disk    rename(fodtpfr:fodtlur)
7.01 f                                     prefix(xx:2)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffohelu    uf   e           k disk    rename(fohepfr:fohelur)
7.01 f                                     prefix(yy:2)
6.20 ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
6.20 ffwbolu    uf a e           k disk    rename(fwbopfr:fwbolur)
6.20 fra09lr    if   e           k disk    rename(ra09pfr:ra09lrr)
6.32 fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
7.03 fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
8.03 f*afpslr    if   e           k disk    rename(afpspfr:afpslrr)
7.fb fsdepl1    if   e           k disk    rename(sdeppfr:sdepl1r)
      *
     flo580d    cf   e             workstn sfile(b1sfl:w_srrn)
      *
      * Definering av parametre
      *
     d p_firm          s                   like(lofirm)
     d p_numm          s                   like(lonumm)
     d p_suff          s                   like(losuff)
      *
      * Definering av Local data area
      *
6.22 dlda             uds
6.20 d l_arch                636    636  0
6.20 d l_skje                637    637  0
6.20 d l_mail                640    640  0
6.10 d l_user                911    920
7.00 d l_filg                931    933
     d l_fnav                951    980
      *
7.03 d vtyp            s              1    dim(500)
      * Definering av datastrukturer
      *
      * Definering av variabler i nøkler
      *
     d rlevl1_levr     s                   like(rllevr)
     d fodtlr_numm     s                   like(fdnumm)
     d fodtlr_suff     s                   like(fdsuff)
     d fodtlr_line     s                   like(fdline)
     d fohel1_numm     s                   like(fonumm)
     d fohel1_suff     s                   like(fosuff)
     d fohelu_numm     s                   like(fonumm)
     d fohelu_suff     s                   like(fosuff)
6.20 d fwbolu_numm     s                   like(wfnumm)
6.20 d fwbolu_suff     s                   like(wfsuff)
6.20 d fwbolu_line     s                   like(wfline)
6.20 d fwbolu_type     s                   like(wftype)
6.20 d ra09lr_ikod     s                   like(raikod)
6.20 d lodtlr_numm     s                   like(ldnumm)
6.20 d lodtlr_suff     s                   like(ldsuff)
6.20 d lodtlr_line     s                   like(ldline)
6.2e d fodtl1_numm     s                   like(fdnumm)
6.2e d fodtl1_suff     s                   like(fdsuff)
6.2e d fodtl1_line     s                   like(fdline)
7.01 d fodtlu_numm     s                   like(fdnumm)
7.01 d fodtlu_suff     s                   like(fdsuff)
7.01 d fodtlu_line     s                   like(fdline)
7.03 d vlagl1_lage     s                   like(vllage)
8.03 d*afpslr_ufil     s                   like(afufil)
8.03 d*afpslr_uide     s                   like(afuide)
7.fb d sdepl1_numm     s                   like(sknumm)
7.fb d sdepl1_kund     s                   like(skkund)
7.fb d sdepl1_tell     s                   like(sktell)
      *
      * Definering av variable
      *
     d w_spge          s              4  0
     d w_srrn          s              4  0
     d w_sfrn          s                   like(w_srrn)
     d w_ssrn          s                   like(w_srrn)
      *
     d w_dato          s               d   datfmt(*iso)
7.02 d w_udat          s               d   datfmt(*iso)
7.03 d w_vare          s                   like(vlvare)
7.03 d want            s                   like(w_srrn)
7.03 d x_ant           s                   like(w_srrn)
     d w_raba          s              5  2
     d w_csts          s              1
     d w_ctx2          s             20
      *
     d w_firm          s                   like(lofirm)
     d w_ldor          s                   like(loldor)
     d w_numm          s                   like(lonumm)
     d w_suff          s                   like(losuff)
     d w_rkr1          s                   like(ldsumi)
     d w_net1          s                   like(ldsumi)
     d w_rkr2          s                   like(ldsumi)
     d w_totk          s             11  2
     d w_tots          s             11  2
     d w_totr          s             11  2
5.60 d w_tota          s             11  2
5.60 d w_totn          s             11  2
5.60 d w_tot1          s             11  2
5.60 d w_tot2          s             11  2
     d w_sald          s             11  2
5.60 d w_sal2          s             11  2
6.20 d w_anta          s                   like(ldanta)
6.20 d w_inkp          s                   like(ldipny)
6.23 d w_kopr          s                   like(ldipny)
6.20 d w_csta          s              1
6.2e d w_line          s                   like(fdline)
6.33 d w_cant          s                   like(ldanta)
6.33 d w_cenh          s                   like(ldenh1)
6.32 d w_lv_nobb       s                   like(vvlnob)
6.32 d w_lv_modn       s                   like(vvlmod)
6.32 d w_lv_lldo       s                   like(vvlnle)
6.32 d w_lv_llva       s                   like(vvllva)
7.02 d w_vtyp          s              1
7.fb d w_mld1          s             50
7.fb d w_mld2          s             50
8.01 d w_diff          s             13  3
8.02 d w_dant          s                   like(fdanta)
8.02 d w_dnet          s                   like(fdkopr)
8.02 d w_dinp          s                   like(fdkopr)
8.08 d w_reqs          s              5
8.08 d w_skaf          s              1  0
8.09 d w_logg          s              1  0
7.12  *
7.12 d w_date          s               d   datfmt(*iso)
7.12  *w_utvgrns = utvidelse av memosaldo(Mestergruppen)
7.12 d w_utvgrns       s              2  0
7.12  *w_memodagr = antall dager ordre skal med i memosaldo
7.12 d w_memodagr      s              3  0
7.12 d w_3x            s              3
      *
     d b_forn          s              1    inz(*off)
     d b_kost          s              1    inz(*off)
     d b_oppr          s              1    inz(*off)
6.11 d b_type          s              1    inz(*off)
6.11 d b_mass          s              1    inz(*off)
6.20 d b_chgf          s              1    inz(*off)
6.20 d b_prtl          s              1    inz(*off)
6.20 d b_newl          s              1    inz(*off)
7.02 d b_inlr          s              1    inz(*off)
7.fb d b_depo          s              1    inz(*off)
      *
     d p_stat          s              1
6.20 d p_kode          s              1
6.20 d p_emne          s             50
6.20 d p_txt1          s             50
6.20 d p_txt2          s             50
6.20 d p_txt3          s             50
6.20 d p_txt4          s             50
6.20 d p_pers          s             50
6.20 d p_ema2          s             50
6.30 d p_ema3          s             50
6.30 d p_kopi          s             50
6.20 d p_inif          s             40
6.20 d p_in03          s              1
6.20 d p_kule          s              1
6.20 d p_kpro          s              6  0
6.20 d p_kund          s              6  0
6.20 d p_navn          s             30
6.20 d p_selg          s              4  0
8.01 d p_antu          s             11  3
8.01 d p_anti          s             11  3
      *
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
7.01 d u_701           s              1    inz(*off)
7.03 d u_703           s              1    inz(*off)
7.05 d u_705           s              1    inz(*off)
7.12 d u_s702          s              1    inz(*off)
8.08 d u_flat          s              1    inz(*off)                            Flåtestyring
      *
      * Definering av konstanter
      *
8.01 d c_sfil          s              2  0 inz(16)
      *
      *
      * Forklaring på spesielle felter
      * som benyttes ved sub-files.
      * - - - - - - - - - - - - - - - - -
      * w_srrn - Relativt recordnummer i subfile
      * w_spge - Sidestørrelse i subfile (page)
      * w_sfrn - Første recordnummer på siden
      * w_ssrn - Siste  recordnummer på siden
      * wvisrn - Vis den side som inneholder denne record.
      *
      * Benyttede skjermbilder.
      * - - - - - - - - - - - - - - - - -
      * B1SFL  - B1 Subfile - record
      * B2CTL  - B2 Subfile - control record
      * B2CMD  - B2 Eget skjermbilde for CMD-taster
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * B2CTL Behandle åpningsbildet med subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Fyller control-bildet
      *
     c                   exsr      control_init
      *
      * Fyller subfile
      *
     c     lodtl1_key    setll     lodtl1
6.11 c                   eval      b_mass = *off
     c                   exsr      crt_subfile
      *
      * Send Alt
      *
     c     b2taga        tag
     c                   write     b2cmd
      *
      * Bare data
      *
     c     b2tagb        tag
     c                   exsr      dsp_subfile
      *
      * Behandling av standard funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   goto      avslutt
     c                   when      *inke
     c                   exsr      forny
     c                   goto      b2tagb
     c                   when      *in10
     c                   exsr      crt_subfile
6.2d c                   goto      b2tagb
6.11 c                   when      *inkn
6.11 c                   exsr      xb14win
     c                   goto      b2taga
     c                   when      *in21
     c                   eval      *in22 = *on
     c                   goto      b2taga
     c                   endsl
      *
      * Behandling av subfile
      *
     c                   exsr      subfile
      *
8.06 c**                 if        *in31 = *on
8.06 c**                 exfmt     x1win
8.06 c**                 eval      *in31 = *off
8.06 c**                 goto      b2tagb
8.06 c**                 endif
      *
     c                   goto      b2taga
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
6.20 c                   if        b_prtl = *on
6.20 c                   exsr      logg_handle
6.20 c                   endif
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å initierer/fylle opp control-bildet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     control_init  begsr
      *
      * Finner ordre-hode
      *
     c     lohel1_key    setll     lohel1
     c     lohel1_key    reade     lohel1                                 60
     c                   if        *in60 = *on
     c                   goto      avslutt
     c                   endif
      *
     c                   dow       *in60 = *off
     c     lohel1_key    reade     lohel1                                 60
     c                   enddo
      *
     c                   eval      b2numm = lonumm
     c                   eval      b2suff = losuff
     c                   eval      b2ornr = loornr
6.28 c**                 eval      b2vref = lovref
6.28 c**                 eval      b2dref = lodref
      *
     c                   if        lobdat <> *loval
     c     *dmy          move      lobdat        b2bdat
     c                   endif
      *
     c                   if        loldat <> *loval
     c     *dmy          move      loldat        b2ldat
     c                   endif
6.20  *
6.20 c                   eval      b_chgf = *off
6.20 c                   eval      b_prtl = *off
6.20 c                   if        b2ornr <> 0
6.20  * Slår opp i ordrehodet, slik at vi har verdiene tilgjengelig
6.20  *
6.20 c                   eval      fohel1_numm = b2ornr
6.20 c                   eval      fohel1_suff = loorsu
6.20 c     fohel1_key    chain     fohel1
6.20 c                   if        %found
6.28 c                   eval      b2dref = fodref
6.28 c                   eval      b2vref = fovref
6.20  * Finn emailadresse fra selger, som skal varsles
6.20 c                   if        foselg <> 0
6.20 c                   eval      ra09lr_ikod = foselg
6.20 c     ra09lr_key    chain     ra09lr
6.20 c                   if        %found and
6.20 c                             raiema <> *blank
6.20 c                   eval      b_chgf = *on
6.20 c**                 eval      raiema = 'bard.sather@asp-as.no'
6.20 c                   endif
6.20 c                   endif
7.01  * Hvis avvikende verdier mellom leveringsdato på hode, oppdateres
7.01  * ordrehodet basert på verdi på bestilling.
7.01 c                   if        u_701 = *on
7.01 c                   if        lomoda <> *loval and
7.01 c                             lomoda <> foldat
7.01 c     fohel1_key    chain     fohelu
7.01 c                   if        %found
7.01 c                   eval      yyldat = lomoda
7.01 c                   update    fohelur
7.01 c                   endif
7.01 c                   endif
7.01 c                   endif
7.01  *
6.20 c                   endif
6.20 c                   endif
      *
     c                   endsr
      *
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  * Subrutine for masseendring
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  *
6.11 c     xb14win       begsr
6.11  *
8.06 c**                 eval      *in32 = *off
6.22  * Vi skal oppdatere hele ordren
6.22  *
6.22 c                   eval      lodtlr_numm = b2numm
6.22 c                   eval      lodtlr_suff = b2suff
6.2A c                   eval      lodtlr_line = 0
6.22 c     lodtlr_key    setll     lodtlrr
6.22 c     lodtlr_key2   reade     lodtlr                                 60
6.22  *
6.22 c                   dow       *in60 = *off
6.22 c                   eval      fodtlr_numm = ldornu
6.22 c                   eval      fodtlr_suff = ldorsu
6.22 c                   eval      fodtlr_line = ldorli
6.12 c     fodtlr_key    chain     fodtlrr
6.22 c                   if        %found
7.01  * Oppdater med leveringsdato
7.01 c                   if        u_701 = *on
7.01 c                   if        ldldat <> fdldat
7.01 c                   exsr      opd_oline
7.01 c                   endif
7.01 c                   endif
6.22  * Hvis enhetene ikke stemmer overens, kan vi ikke opdatere antall eller pris
8.02  * Det skal være mulig, men vi omregner hvis avvikende enhet.
8.02 c                   eval      w_dnet = ldkpny
8.02 c                   eval      w_dinp = ldipny
8.02 c                   eval      w_dant = ldanta
6.22 c                   if        ldenh1 <> fdenh1
8.02 c**                 eval      *in32 = *on
8.02 c**                 goto      les_next
8.02 c                   exsr      omr_enh14
6.22 c                   endif
6.2A  * Sjekk om det er gjort endringer ?
7.05 c                   if        u_705 = *off
8.02 c**                 if        fdanta = ldanta and
8.02 c                   if        fdanta = w_dant and
8.02 c                             fdkopr = w_dnet and
8.02 c                             fdinpr = w_dinp
8.02 c**                           fdkopr = ldkpny
6.2A c                   goto      les_next
6.2A c                   endif
7.05 c                   else
8.02 c**                 if        fdanta = ldanta and
8.02 c                   if        fdanta = w_dant and
8.02 c                             fdkopr = w_dinp
8.02 c**                           fdkopr = ldipny
7.05 c                   goto      les_next
7.05 c                   endif
7.05 c                   endif
6.22  * Oppdater
6.22 c                   if        fdvare <> *blank
6.22  * Begge
7.05 c                   if        u_705 = *off
8.02 c**                 eval      w_kopr = ldkpny
8.02 c                   eval      w_kopr = w_dnet
7.06 c                   else
8.02 c**                 eval      w_kopr = ldipny
8.02 c                   eval      w_kopr = w_dinp
7.05 c                   endif
8.02 c**                 eval      w_inkp = ldipny
8.02 c                   eval      w_inkp = w_dinp
8.02 c**                 eval      w_anta = ldanta
8.02 c                   eval      w_anta = w_dant
6.22 c                   eval      w_csta = *blank
6.22  * Logg endringer før
6.22 c                   eval      fwbolu_type = 'FRA'
6.2A c                   eval      b1olin = fdline
6.22 c                   exsr      oppd_logg
6.22  *
6.22 c                   call      'FO701R'
6.22 c                   parm                    w_firm
6.22 c                   parm                    ldornu
6.22 c                   parm                    ldorsu
6.22 c                   parm                    ldorli
6.22 c                   parm                    w_anta
6.22 c                   parm                    w_inkp
6.23 c                   parm                    w_kopr
6.22 c                   parm                    w_csta
6.22  * Logg endringer etter
6.22 c                   eval      fwbolu_type = 'TIL'
6.22 c                   exsr      oppd_logg
6.22  *
6.22 c                   exsr      oppdat_ordre
6.22 c                   endif
6.22  * fdvare <> *blank
6.22 c                   else
6.22  * Linja finnes ikke fra før - må opprettes
6.2A c**                 eval      b1line = ldline
6.2e c**                 eval      b1olin = ldline
6.2e c                   exsr      last_line
6.2e c                   eval      b1olin = w_line
6.33 c                   eval      w_cant = ldanta
6.33 c                   eval      w_cenh = ldenh1
6.22 c                   exsr      crt_line
6.22 c                   endif
6.22  * %found
6.22 c     les_next      tag
6.22  *
6.22 c     lodtlr_key2   reade     lodtlr                                 60
6.22 c                   enddo
8.02  * Skal nå aldri slå til pga endringer 8.02
6.06 c**                 if        *in32 = *on
8.06 c**                 exfmt     x1win
8.06 c**                 eval      *in32 = *off
8.06 c**                 endif
6.22  *
6.22 c                   exsr      oppdat_ordre
8.08  *
8.08  * Hvis flåtestyring send, request for nytt suffiks
8.08  * Alle sjekker på okm ordren tilfredsstiller krav, ligger i AP058.
8.08  *
8.08 c                   if        u_flat = *on
8.08  *
8.08 c                   eval      w_reqs = *blanks
8.08 c                   eval      w_skaf = 1
8.09 c                   eval      w_logg = 1
8.08 c                   call      'AP058R '
8.08 c                   parm                    w_firm
8.08 c                   parm                    b2ornr
8.08 c                   parm                    loorsu
8.08 c                   parm                    w_skaf
8.09 c                   parm                    w_logg
8.08 c                   parm                    w_reqs
8.08  *
8.08 c                   endif
6.22  *
6.22 c                   if        b_forn = *on
6.22 c                   exsr      forny
6.22 c                   endif
6.22  *
6.22 c     end_xb14win   endsr
6.22  *
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  * Henter siste linjenummer på ordren.
6.2e  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2e  *
6.2e c     last_line     begsr
6.2e  *
8.11 c*                  eval      fodtl1_numm = ldornu
8.11 c                   eval      fodtl1_numm = loornr
8.11 c*                  eval      fodtl1_suff = ldorsu
8.11 c                   eval      fodtl1_suff = loorsu
6.2e c                   eval      fodtl1_line = 9999
6.2e c     fodtl1_key    setgt     fodtl1
6.2e c     fodtl1_key2   readpe    fodtl1
6.2e  *
6.2e c                   dow       not %eof
6.2e c                   eval      w_line = fxline + 10
6.2e c                   leave
6.2e c                   enddo
6.2e  *
6.2e c                   endsr
6.2e  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for fornying av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     forny         begsr
      *
     c     lodtl1_key    setll     lodtl1
      *
6.11 c**6.20             eval      b_mass = *on
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c     end_forny     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     subfile       begsr
      *
     c                   eval      b_forn = *off
      *
      * Beholder eksisterende posisjonering i subfilen
      *
     c                   if        wcurrn > 0
     c                   eval      wvisrn = wcurrn
     c                   endif
      *
      * Leser og behandler subfile
      *
     c                   do        w_ssrn
     c                   readc     b1sfl                                  16
      *
     c                   if        *in16
     c                   leave
     c                   endif
      *
     c                   eval      wvisrn = w_srrn
      *
      * Endre ordrelinje
      *
     c                   if        b1valg = '2'
      *
     c                   eval      fodtlr_numm = b1onum
     c                   eval      fodtlr_suff = b1osuf
     c                   eval      fodtlr_line = b1olin
     c     fodtlr_key    chain     fodtlrr
     c                   if        not %found
     c                   leavesr
     c                   endif
      *
7.fb c                   exsr      sjekk_depo
7.fb c                   if        b_depo = *on
7.fb c                   leavesr
7.fb c                   endif
      *
     c                   select
     c                   when      fdvare <> *blank and
     c                             fdlvre = 0
     c                   call      'FD105R'
     c                   parm                    b_oppr
     c                   parm                    w_firm
     c                   parm                    b1onum
     c                   parm                    b1osuf
     c                   parm                    b1olin
     c                   parm                    fdltyp
     c                   parm                    fdlety
     c                   parm                    fdvare
     c                   parm                    fdanta
     c                   parm                    fdenh1
     c                   parm                    b_kost
6.11 c                   parm                    fdeann
6.11  *
     c                   eval      *in49 = b_kost
     c                   when      fdvare <> *blank and
     c                             fdlvre = 1
     c                   call      'FD120R'
     c                   parm                    b_oppr
     c                   parm                    w_firm
     c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    fdline
     c                   parm                    fdltyp
     c                   parm                    fdlety
     c                   parm                    fdvare
     c                   parm                    fdanta
     c                   other
     c                   call      'FD110R'
     c                   parm                    p_stat
     c                   parm                    w_firm
     c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    fdline
     c                   parm                    fdltyp
     c                   endsl
      *
     c                   exsr      oppdat_ordre
      *
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c*                  iter
     c                   eval      b_forn = *on
      *
     c                   endif
      *
      * Vise
      *
     c                   if        b1valg = '5'
     c                   call      'LD505R'
     c                   parm                    w_firm
     c                   parm                    b1numm
     c                   parm                    b1suff
     c                   parm                    b1line
     c                   eval      b1valg = *blank
     c                   update    b1sfl
     c                   iter
     c                   endif
6.11  *
6.11  * Oppdater varelinje med antall eller pris eller begge
6.11  *
6.11 c                   if        b1valg = '6' or
6.11 c                             b1valg = '7' or
6.11 c                             b1valg = '8'
6.20  * Hent inn informasjon fra bestillingslinje(skaff ?)
6.20 c                   eval      lodtlr_numm = b1numm
6.20 c                   eval      lodtlr_suff = b1suff
6.20 c                   eval      lodtlr_line = b1line
6.20 c     lodtlr_key    chain     lodtlrr
6.20 c                   if        not %found
6.20 c                   leavesr
6.20 c                   endif
6.11  *
7.fb c                   exsr      sjekk_depo
7.fb c                   if        b_depo = *on
7.fb c                   leavesr
7.fb c                   endif
6.11  *
6.11 c                   eval      fodtlr_numm = b2ornr
6.11 c                   eval      fodtlr_suff = loorsu
6.26 c**                 eval      fodtlr_line = b1line
6.26 c                   eval      fodtlr_line = b1olin
6.11 c     fodtlr_key    chain     fodtlrr
6.11 c                   if        not %found
6.20  * Hvis linja ikke finnes, skal den oppdateres hvis valg 8
6.20 c                   if        b1valg = '8'
6.22  * Opprett linje som ikke finnes fra før
8.01 c                   if        b1dant <> 0
8.01 c                   eval      w_cant = b1dant
8.01 c                   else
6.33 c                   eval      w_cant = b1anta
8.01 c                   endif
6.33 c                   eval      w_cenh = b1enh1
6.22 c                   exsr      crt_line
6.20  *
6.20 c                   exsr      oppdat_ordre
8.08  *
8.08  * Hvis flåtestyring send, request for nytt suffiks
8.08  * Alle sjekker på okm ordren tilfredsstiller krav, ligger i AP058.
8.08  *
8.08 c                   if        u_flat = *on
8.08  *
8.08 c                   eval      w_reqs = *blanks
8.08 c                   eval      w_skaf = 1
8.09 c                   eval      w_logg = 1
8.08 c                   call      'AP058R '
8.08 c                   parm                    w_firm
8.08 c                   parm                    b2ornr
8.08 c                   parm                    loorsu
8.08 c                   parm                    w_skaf
8.09 c                   parm                    w_logg
8.08 c                   parm                    w_reqs
8.08  *
8.08 c                   endif
8.08  *
6.20 c                   eval      b1valg = *blank
6.20 c                   update    b1sfl
6.20 c                   eval      b_forn = *on
6.20 c                   exsr      forny
6.20 c                   endif
6.11 c                   leavesr
6.11 c                   endif
7.01  * Oppdater med leveringsdato
7.01 c                   if        u_701 = *on
7.01 c                   if        ldldat <> fdldat
7.01 c                   exsr      opd_oline
7.01 c                   endif
7.01 c                   endif
6.21  * Hvis enhetene ikke stemmer overens, kan vi ikke opdatere antall eller pris
8.06 c**                 eval      *in31 = *off
8.06 c**                 if        b1enh1 <> b1oenh
8.06 c**                 eval      *in31 = *on
8.06 c**                 leavesr
8.06 c**                 endif
6.11  * Oppdater
6.11 c                   if        fdvare <> *blank
6.20  * Kvantum
6.20 c                   if        b1valg = '6'
8.01 c                   if        b1dant <> 0
8.01 c                   eval      w_cant = b1dant
8.01 c                   else
6.20 c                   eval      w_anta = b1anta
8.01 c                   endif
6.20 c                   eval      w_inkp = 0
6.28 c                   eval      w_kopr = 0
6.20 c                   endif
6.20  * Pris
6.20 c                   if        b1valg = '7'
7.05 c                   if        u_705 = *on
8.01 c                   if        b1dnet <> 0
8.01 c                   eval      w_inkp = b1dnet
8.01 c                   eval      w_kopr = b1dnet
8.01 c                   else
7.05 c                   eval      w_inkp = b1nett
7.07 c**                 eval      w_kopr = b1kpri
7.07 c                   eval      w_kopr = b1nett
8.01 c                   endif
7.05 c                   else
6.28 c**                 eval      w_inkp = b1nett
6.28 c                   eval      w_inkp = ldipny
8.01 c                   if        b1dnet <> 0
8.01 c                   eval      w_kopr = b1dnet
8.01 c                   else
6.28 c                   eval      w_kopr = b1nett
8.01 c                   endif
6.28 c**                 eval      w_kopr = b1kpri
7.05 c                   endif
6.20 c                   eval      w_anta = 0
6.20 c                   endif
6.20  * Begge
6.20 c                   if        b1valg = '8'
7.05 c                   if        u_705 = *on
8.01 c                   if        b1dnet <> 0
8.01 c                   eval      w_inkp = b1dnet
8.01 c                   eval      w_kopr = b1dnet
8.01 c                   else
7.05 c                   eval      w_inkp = b1nett
7.07 c**                 eval      w_kopr = b1kpri
7.07 c                   eval      w_kopr = b1nett
8.01 c                   endif
7.05 c                   else
8.01 c                   if        b1dnet <> 0
8.01 c                   eval      w_kopr = b1dnet
8.01 c                   else
6.28 c**                 eval      w_inkp = b1nett
6.28 c                   eval      w_kopr = b1nett
6.28 c**                 eval      w_kopr = b1kpri
8.01 c                   endif
6.28 c                   eval      w_inkp = ldipny
7.05 c                   endif
8.01 c                   if        b1dnet <> 0
8.01 c                   eval      w_anta = b1dant
8.01 c                   else
6.20 c                   eval      w_anta = b1anta
8.01 c                   endif
6.20 c                   endif
6.20 c                   eval      w_csta = *blank
6.20  * Logg endringer før
6.20 c                   if        b_chgf = *on
6.20 c                   eval      fwbolu_type = 'FRA'
6.20 c                   exsr      oppd_logg
6.20 c                   endif
6.11  *
6.20 c                   call      'FO701R'
6.20 c                   parm                    w_firm
6.20 c                   parm                    b2ornr
6.20 c                   parm                    loorsu
6.26 c**                 parm                    b1line
6.26 c                   parm                    b1olin
6.20 c                   parm                    w_anta
6.20 c                   parm                    w_inkp
6.23 c                   parm                    w_kopr
6.20 c                   parm                    w_csta
6.20  * Logg endringer etter
6.20 c                   if        b_chgf = *on
6.20 c                   eval      fwbolu_type = 'TIL'
6.20 c                   exsr      oppd_logg
6.20 c                   endif
6.11  *
6.11 c                   exsr      oppdat_ordre
8.08  *
8.08  * Hvis flåtestyring send, request for nytt suffiks
8.08  * Alle sjekker på om ordren tilfredsstiller krav, ligger i AP058.
8.08  *
8.08 c                   if        u_flat = *on
8.08  *
8.08 c                   eval      w_reqs = *blanks
8.08 c                   eval      w_skaf = 1
8.09 c                   eval      w_logg = 1
8.08 c                   call      'AP058R '
8.08 c                   parm                    w_firm
8.08 c                   parm                    b2ornr
8.08 c                   parm                    loorsu
8.08 c                   parm                    w_skaf
8.09 c                   parm                    w_logg
8.08 c                   parm                    w_reqs
8.08  *
8.08 c                   endif
8.08  *
6.20 c                   endif
6.11  *
6.11 c                   eval      b1valg = *blank
6.11 c                   update    b1sfl
6.11 c*                  iter
6.11 c                   eval      b_forn = *on
6.11  *
6.11 c                   endif
      *
     c                   enddo
      *
     c                   if        b_forn = *on
     c                   exsr      forny
     c                   endif
      *
     c     end_subfile   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for tømming av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     clr_subfile   begsr
      *
     c                   eval      *in14 = *on
     c                   write     b2ctl
     c                   eval      *in14 = *off
      *
     c                   eval      *in15 = *off
     c                   eval      w_srrn = 0
     c                   eval      w_sfrn = 0
     c                   eval      w_ssrn = 0
     c                   eval      w_spge = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å fylle opp subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     crt_subfile   begsr
      *
     c                   eval      w_spge = w_spge + c_sfil
     c                   eval      w_srrn = w_ssrn
      *
     c                   dou       w_srrn = w_spge
      *
     c     lodtl1_key    reade     lodtl1                                 15
      *
     c                   if        *in15
     c                   goto      end_crt
     c                   endif
      *
     c                   eval      w_srrn = w_srrn + 1
8.07 c                   eval      *in51  = *off
8.07 c                   eval      *in52  = *off
7.02  *
7.02  * Hent varetype
7.02  *
7.02 c                   call      'VL710R'
7.02 c                   parm                    w_firm
7.02 c                   parm                    ldvare
7.02 c                   parm                    ldlage
7.02 c                   parm                    w_vtyp
7.02 c                   parm                    w_udat
7.02 c                   parm                    ldldor
7.02 c                   parm                    b_inlr
6.32 c                   parm                    w_lv_nobb
6.32 c                   parm                    w_lv_modn
6.32 c                   parm                    w_lv_lldo
6.32 c                   parm                    w_lv_llva
7.02 c                   eval      b1vtyp = w_vtyp
7.03  * Sjekk om vare har 'S' på alle lagere
7.03 c                   if        u_703 = *on
7.03 c                   eval      w_vare = ldvare
7.03 c                   eval      vlagl1_lage = *zeros
7.03 c     vlagl1_key    setll     vlagl1
7.03  *
7.03 c                   eval      *in77 = '0'
7.03 c                   eval      want = *zeros
7.03 c     nyles         tag
7.03 c                   read      vlagl1
7.03 c                   if        %eof or
7.03 c                             vlfirm <> w_firm or
7.03 c                             vlvare <> ldvare
7.03 c                   eval      x_ant = want
7.03 c     1             do        x_ant         want
7.03 c                   if        vtyp(want) <> 'S'
7.03 c                   eval      *in77 = '1'
7.03 c                   endif
7.03 c                   enddo
7.03 c                   goto      vtyput
7.03 c                   endif
7.03  *
7.03 c                   eval      want = want + 1
7.03 c                   movea     vlvtyp        vtyp(want)
7.03 c                   goto      nyles
7.03  *
7.03 c     vtyput        tag
7.03  *
7.03 c                   if        *in77 = '0'
7.03 c                   eval      b1vtyp = *blank
7.03 c                   endif
7.03 c                   endif
      *
     c                   eval      b1numm = ldnumm
     c                   eval      b1suff = ldsuff
     c                   eval      b1line = ldline
      *
     c                   movel     ldtek1        b1tek1
     c                   eval      b1anta = ldanta
     c                   eval      b1enh1 = ldenh1
     c                   eval(h)   w_rkr1 = ldipny * ldrab1 / 100
     c                   eval(h)   w_net1 = ldipny - w_rkr1
     c                   eval(h)   w_rkr2 = w_net1 * ldrab2 / 100
7.05 c                   if        u_705 = *off
6.28 c**                 eval      b1nett = ldipny - w_rkr1 - w_rkr2
6.28 c                   eval      b1nett = ldkpny
7.05 c                   else
7.05 c                   eval      b1nett = ldipny - w_rkr1 - w_rkr2
7.05 c                   endif
      * finner ordrelinje
     c                   eval      fodtlr_numm = ldornu
     c                   eval      fodtlr_suff = ldorsu
     c                   eval      fodtlr_line = ldorli
     c     fodtlr_key    chain     fodtlr
     c                   if        %found(fodtlr)
     c                   eval      b1oant = fdanta
     c                   eval      b1oenh = fdenh1
     c                   eval      b1kpri = fdkopr
     c                   eval      b1onum = fdnumm
     c                   eval      b1osuf = fdsuff
     c                   eval      b1olin = fdline
      *
8.07 c                   if        b1oenh = b1enh1
8.07 c                   if        b1nett <> fdkopr
8.07 c                   eval      *in51  = *on
8.07 c                   endif
8.07 c                   if        ldanta <> fdanta
8.07 c                   eval      *in52  = *on
8.07 c                   endif
8.07 c                   endif
      *
8.04 c**                 eval      *in55 = *off
8.01 c                   if        b1oenh <> b1enh1
8.04 c**                 eval      *in55 = *on
8.01 c                   exsr      omr_enh
8.01 c                   else
8.01 c                   eval      b1dant = 0
8.01 c                   eval      b1denh = *blanks
8.01 c                   eval      b1dnet = 0
8.01 c                   endif
     c                   else
     c                   eval      b1oant = 0
     c                   eval      b1oenh = *blank
     c                   eval      b1kpri = 0
     c                   eval      b1onum = 0
     c                   eval      b1osuf = 0
     c                   eval      b1olin = 0
8.01 c                   eval      b1dant = 0
8.01 c                   eval      b1denh = *blanks
8.01 c                   eval      b1dnet = 0
     c                   endif
      *
6.22 c**                 if        b_mass = *on
6.22 c**                 eval      b1valg = '8'
6.22 c**                 endif
      *
     c                   write     b1sfl
      *
     c                   enddo
      *
     c     end_crt       tag
      *
     c                   if        w_srrn > w_ssrn
     c                   eval      w_sfrn = w_ssrn + 1
     c                   endif
      *
     c                   eval      w_ssrn = w_srrn
     c                   eval      wvisrn = w_sfrn
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for display av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dsp_subfile   begsr
      *
     c                   if        w_srrn <> 0
     c                   eval      *in12 = *on
     c                   else
     c                   write     b2cmd
     c                   endif
      *
     c                   eval      *in13 = *on
     c                   exfmt     b2ctl
      *
     c                   eval      *in12 = *off
     c                   eval      *in13 = *off
     c                   eval      *in22 = *off
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppdaterer ordre og memosaldo
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppdat_ordre  begsr
      *
      * Henter ny ordretotal
      *
     c                   exsr      hent_total
      *
      * Beregner justeringsbeløp, og oppdaterer memosaldo
      *
6.20 c**                 eval      fohel1_numm = b1onum
6.20 c                   eval      fohel1_numm = b2ornr
6.20 c**                 eval      fohel1_suff = b1osuf
6.20 c                   eval      fohel1_suff = loorsu
     c     fohel1_key    chain     fohel1
      *
7.12  *
7.12  * Sjekker mot utvidet saldo
7.12  *
7.12 c                   if        u_s702 = *on
7.12 c                   if        w_memodagr = 0 or
7.12 c                             foldat < w_date
     c                   eval      w_sald = (w_tots - w_totr) -
     c                                      (fotots - fototr)
5.60  *
5.60 c                   eval      w_sal2 = (w_tota - fobrra)
      *
     c                   call      'FA922R'
     c                   parm                    w_firm
     c                   parm                    footyp
     c                   parm                    fokund
     c                   parm                    w_sald
5.60 c                   parm                    w_sal2
7.12 c                   endif
7.12 c                   else
7.12 c                   eval      w_sald = (w_tots - w_totr) -
7.12 c                                      (fotots - fototr)
7.12  *
7.12 c                   eval      w_sal2 = (w_tota - fobrra)
7.12  *
7.12 c                   call      'FA922R'
7.12 c                   parm                    w_firm
7.12 c                   parm                    footyp
7.12 c                   parm                    fokund
7.12 c                   parm                    w_sald
7.12 c                   parm                    w_sal2
7.12 c                   endif
      *
      * Oppdaterer ordre-hode med ny saldo
      *
     c                   eval      fohelu_numm = b2ornr
     c                   eval      fohelu_suff = loorsu
     c     fohelu_key    chain     fohelur
      *
6.27 c                   if        %found
      *
7.01 c                   eval      yytots = w_tots
7.01 c                   eval      yytotr = w_totr
7.01 c                   eval      yytotk = w_totk
7.01 c                   eval      yybrra = w_tota
      *
7.01 c                   time                    yyedat
7.01 c                   time                    yyetim
7.01 c                   eval      yyeusr = l_user
     c                   update    fohelur
      *
6.27 c                   endif
      *
6.22 c                   eval      b_forn = *on
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for henting av ordretotal
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_total    begsr
      *
     c                   eval      w_totk = 0
     c                   eval      w_tots = 0
     c                   eval      w_totr = 0
5.60 c                   eval      w_tota = 0
5.60 c                   eval      w_totn = 0
5.60 c                   eval      w_tot1 = 0
5.60 c                   eval      w_tot2 = 0
      *
6.20 c**                 eval      fodtlr_numm = b1onum
6.20 c                   eval      fodtlr_numm = b2ornr
6.20 c**                 eval      fodtlr_suff = b1osuf
6.20 c                   eval      fodtlr_suff = loorsu
     c     fodtlr_key2   setll     fodtlr
     c     fodtlr_key2   reade     fodtlr
     c                   dow       not %eof
     c                   eval      w_totk = w_totk + fdsumk
     c                   eval      w_tots = w_tots + fdsums
     c                   eval      w_totr = w_totr + fdsumr
5.60  *
5.60 c                   eval      w_totn = fdsums
5.60 c                   eval      w_tot1 = 0
5.60 c                   eval      w_tot2 = 0
5.60  *
5.60 c                   if        fdrab1 <> 0
5.60 c                   eval      w_tot1 = w_totn * fdrab1 / 100
5.60 c                   eval      w_totn = w_totn - w_tot1
5.60 c                   endif
5.60  *
5.60 c                   if        fdrab2 <> 0
5.60 c                   eval      w_tot2 = w_totn * fdrab2 / 100
5.60 c                   eval      w_totn = w_totn - w_tot2
5.60 c                   endif
5.60  *
5.60  * NB!  w_tot1
5.60  * og   w_tot2 brukes om
5.60  * igjen og null-stilles
5.60  *
5.60 c                   eval      w_tot1 = 0
5.60 c                   eval      w_tot2 = 0
5.60  *
5.60 c                   if        fdbrr1 <> 0
5.60 c                   eval      w_tot1 = w_totn * fdbrr1 / 100
5.60 c                   eval      w_totn = w_totn - w_tot1
5.60 c                   endif
5.60  *
5.60 c                   if        fdbrr2 <> 0
5.60 c                   eval      w_tot2 = w_totn * fdbrr2 / 100
5.60 c                   eval      w_totn = w_totn - w_tot2
5.60 c                   endif
5.60  *
5.60 c                   eval      w_tota = w_tota + w_tot1
5.60 c                   eval      w_tota = w_tota + w_tot2
5.60  *
     c     fodtlr_key2   reade     fodtlr
     c                   enddo
      *
     c                   endsr
      *
6.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  * Subrutine for logg av endringer
6.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  *
6.20 c     oppd_logg     begsr
6.20  * Sjekk om varelinjen finnes fra før
6.20 c                   eval      b_newl = *off
6.20  *
6.20 c                   eval      fodtlr_numm = b2ornr
6.20 c                   eval      fodtlr_suff = loorsu
6.29 c**                 eval      fodtlr_line = b1line
6.29 c                   eval      fodtlr_line = b1olin
6.20 c     fodtlr_key    chain     fodtlrr
6.20 c                   if        not %found
6.20 c                   eval      b_newl = *on
6.20 c                   endif
6.20  *
6.20 c                   eval      fwbolu_numm = b2ornr
6.20 c                   eval      fwbolu_suff = loorsu
6.29 c**                 eval      fwbolu_line = b1line
6.29 c                   eval      fwbolu_line = b1olin
6.20 c     fwbolu_key    chain     fwbolur
6.20 c                   if        %found
6.20 c                   if        fwbolu_type = 'TIL'
6.20 c                   eval      wfvare = fdvare
6.20 c                   eval      wftek1 = fdtek1
6.20 c                   eval      wfanta = fdanta
6.24 c**                 eval      wfsapr = fdsapr
6.24 c                   eval      wfsapr = fdkopr
6.24 c**                 eval      wfsums = fdsums
6.24 c                   eval      wfsums = fdsumk
6.20 c                   eval      wfbnum = ldnumm
6.20 c                   eval      wfenhe = fdenh1
6.20  *
6.20 c                   time                    wfedat
6.20 c                   time                    wfetim
6.20 c                   eval      wfeusr = l_user
6.20 c                   update    fwbolur
6.20 c                   endif
6.20 c                   else
6.20  *
6.20 c                   clear                   fwbolur
6.20  *
6.20 c                   eval      wffirm = w_firm
6.20 c                   eval      wfnumm = fwbolu_numm
6.20 c                   eval      wfsuff = fwbolu_suff
6.20 c                   eval      wfline = fwbolu_line
6.20 c                   eval      wftype = fwbolu_type
6.20 c                   eval      wfbnum = ldnumm
6.20 c                   if        b_newl = *on
6.20 c                   eval      wftek1 = 'Linje finnes ikke !!!'
6.20 c                   else
6.20 c                   eval      wfvare = fdvare
6.20 c                   eval      wftek1 = fdtek1
6.20 c                   eval      wfanta = fdanta
6.24 c**                 eval      wfsapr = fdsapr
6.24 c                   eval      wfsapr = fdkopr
6.24 c**                 eval      wfsums = fdsums
6.24 c                   eval      wfsums = fdsumk
6.20 c                   eval      wfenhe = fdenh1
6.20 c                   endif
6.20  *
6.20 c                   time                    wfedat
6.20 c                   time                    wfetim
6.20 c                   eval      wfeusr = l_user
6.20 c                   time                    wfodat
6.20 c                   time                    wfotim
6.20 c                   eval      wfousr = l_user
6.20  *
6.20 c                   write     fwbolur
6.20  *
6.20 c                   endif
6.20  *
6.20 c                   eval      b_prtl = *on
6.20  *
6.20 c                   endsr
6.20  *
6.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  * Subrutine for skrive logg og sende denne på email
6.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  *
6.20 c     logg_handle   begsr
6.20  *
6.20  *
6.20  * Legg inn beskrivelser, og mottaker av mailadresse
6.20  *
6.20 c                   eval      p_kund = fokund
6.20 c                   eval      p_selg = foselg
6.20 c                   eval      p_navn = raitxt
6.22 c                   eval      p_emne = 'Endringer i best: '+ %char(lonumm)+
6.22 c                             '. Ref. ordre: ' + %char(loornr)
6.20  *
6.20 c                   call      'FO798R'
6.20 c                   parm                    p_kule
6.20 c                   parm                    p_kund
6.20 c                   parm                    p_kpro
6.20 c                   parm                    p_numm
6.30 c                   parm                    p_suff
6.20 c                   parm                    p_selg
6.20 c                   parm                    p_navn
6.20 c                   parm                    raiema
6.30 c                   parm                    p_ema2
6.30 c                   parm                    p_ema3
6.20 c                   parm                    p_emne
6.20 c                   parm                    p_txt1
6.20 c                   parm                    p_txt2
6.20 c                   parm                    p_txt3
6.20 c                   parm                    p_txt4
6.20 c                   parm                    p_pers
6.30 c                   parm                    p_kopi
6.20 c                   parm                    p_inif
6.20 c                   parm                    p_in03
6.20  * Hvis F3-skriv ikke mail. Slett arbeidsregister
6.20 c                   eval      l_mail = 1
6.20 c                   eval      l_arch = 0
6.20 c                   eval      l_skje = 0
6.20  *
6.2c c                   if        p_in03 = *on
6.20 c                   eval      l_mail = 0
6.20 c                   endif
6.20  *
6.22 c                   out       lda
6.20  *
6.31 c**                 call      'LO581R'
6.31 c                   call      'LO581C'
6.20 c                   parm                    b2ornr
6.20 c                   parm                    loorsu
6.20 c                   parm                    raiema
6.20 c                   parm                    p_emne
6.20 c                   parm                    p_txt1
6.20 c                   parm                    p_txt2
6.20 c                   parm                    p_txt3
6.20 c                   parm                    p_txt4
6.20 c                   parm                    p_pers
6.30 c                   parm                    p_kopi
6.20  *
6.20 c                   endsr
6.20  *
6.22  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.22  * Subrutine for opprette linjer som ikke finnes fra før
6.22  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.22  *
6.22 c     crt_line      begsr
7.fb  *
7.fb  * Forskuddsbetalt ?
7.fb  *
7.fb c                   exsr      sjekk_depo
7.fb c                   if        b_depo = *on
7.fb c                   leavesr
7.fb c                   endif
6.22  *
6.22  * Logg endringer før
6.22  *
6.22 c                   if        b_chgf = *on
6.22 c                   eval      fwbolu_type = 'FRA'
6.22 c                   exsr      oppd_logg
6.22 c                   endif
6.22  *
6.22 c                   select
6.22 c                   when      ldvare <> *blank and
6.22 c                             ldlvre = 1
6.22 c                   call      'FD120R'
6.22 c                   parm                    b_oppr
6.22 c                   parm                    w_firm
6.22 c                   parm                    b2ornr
6.22 c                   parm                    loorsu
6.2b c*                  parm                    b1line
6.2b c                   parm                    b1olin
6.22 c                   parm                    faalty
6.22 c                   parm                    folety
6.22 c                   parm                    ldvare
6.33 c**                 parm                    b1anta
6.33 c                   parm                    w_cant
6.22 c                   other
6.22  *
6.22 c                   call      'FD108R'
6.22 c                   parm                    p_kode
6.22 c                   parm                    w_firm
6.22 c                   parm                    b2ornr
6.22 c                   parm                    loorsu
6.2b c*                  parm                    b1line
6.2b c                   parm                    b1olin
6.22 c                   parm                    faalty
6.22 c                   parm                    folety
6.22 c                   parm                    ldvare
6.33 c**                 parm                    b1anta
6.33 c                   parm                    w_cant
6.33 c**                 parm                    b1enh1
6.33 c                   parm                    w_cenh
6.22 c                   parm                    foldat
6.22 c                   parm                    lonumm
6.22 c                   parm                    losuff
6.33 c**                 parm                    b1line
6.33 c                   parm                    ldline
6.22 c                   endsl
6.22  * Logg endringer etter
6.22 c                   if        b_chgf = *on
6.22 c                   eval      fwbolu_type = 'TIL'
6.22 c                   exsr      oppd_logg
6.22 c                   endif
6.22  *
6.22 c                   endsr
6.22  *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.01  * Oppdaterer leveringsdato på ordrelinjene
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.01  *
7.01 c     opd_oline     begsr
7.01  *
7.01 c                   eval      fodtlu_numm = ldornu
7.01 c                   eval      fodtlu_suff = ldorsu
7.01 c                   eval      fodtlu_line = ldorli
7.01 c     fodtlu_key    chain     fodtlu
7.01  *
7.01 c                   if        %found(fodtlu)
7.01 c                   eval      xxldat = ldldat
7.01 c                   update    fodtlur
7.01 c                   endif
7.01  *
7.01 c                   endsr
7.01  *
7.fb  * - - - - - - - - - - - - - - - - - - - -- - - - - - - - - - - - - -
7.fb  * Subrutine for å ordre er 100% forhåndsbetalt. Skal ikke få registrere
7.fb  * mer herfra. Det må gjøres av selger via ordre.
7.fb  * Gir melding og sender mail til selger.
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  *
7.fb c     sjekk_depo    begsr
7.fb c                   eval      b_depo = *off
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
7.fb c     sdepl1_key    chain     sdepl1
7.fb c                   if        %found(sdepl1) and
7.fb c                             sk100p = 1
7.fb c                   eval      b_depo = *on
7.fb c                   endif
7.fb  *
7.fb c                   if        b_depo = *off
7.fb c                   leavesr
7.fb c                   endif
7.fb  * gir melding
7.fb c                   eval      w_mld1 = 'Ordre er 100% betalt og +
7.fb c                             må behandles av selger'
7.fb c                   call      'AA005R'
7.fb c                   parm                    w_mld1
7.fb  * sender mail
7.fb  *
7.fb  * Legg inn beskrivelser, og mottaker av mailadresse
7.fb  *
7.fb c                   eval      p_kund = fokund
7.fb c                   eval      p_selg = foselg
7.fb c                   eval      p_navn = raitxt
7.fb c                   eval      p_emne = 'Forsk.bet ordre :' +
7.fb c                             %char(loornr) + 'må endres av selger'
7.fb  *
7.fb c                   call      'FO798R'
7.fb c                   parm                    p_kule
7.fb c                   parm                    p_kund
7.fb c                   parm                    p_kpro
7.fb c                   parm                    p_numm
7.fb c                   parm                    p_suff
7.fb c                   parm                    p_selg
7.fb c                   parm                    p_navn
7.fb c                   parm                    raiema
7.fb c                   parm                    p_ema2
7.fb c                   parm                    p_ema3
7.fb c                   parm                    p_emne
7.fb c                   parm                    p_txt1
7.fb c                   parm                    p_txt2
7.fb c                   parm                    p_txt3
7.fb c                   parm                    p_txt4
7.fb c                   parm                    p_pers
7.fb c                   parm                    p_kopi
7.fb c                   parm                    p_inif
7.fb c                   parm                    p_in03
7.fb  * Hvis F3-skriv ikke mail. Slett arbeidsregister
7.fb c                   eval      l_mail = 1
7.fb c                   eval      l_arch = 0
7.fb c                   eval      l_skje = 0
7.fb  *
7.fb c                   if        p_in03 = *on
7.fb c                   eval      l_mail = 0
7.fb c                   endif
7.fb  *
7.fb c                   out       lda
7.fb  *
7.fb c                   endsr
7.fb  *
8.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.01  * Regner om antall/pris hvsi det er avvike mellom enheter
8.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.01  *
8.01 c     omr_enh       begsr
8.01  *
8.01  * Regn om til bestilt enhet hvis det avvikende enheter
8.01  *
8.01 c                   eval      *in53 = *off
8.01 c                   eval      *in54 = *off
8.01 c                   eval      p_anti = b1anta
8.01 c                   eval      p_antu = 0
8.01  *
8.01 c                   call      'VA770R'
8.01 c                   parm                    w_firm
8.01 c                   parm                    ldvare
8.01 c                   parm                    b1enh1
8.01 c                   parm                    p_anti
8.01 c                   parm                    b1oenh
8.01 c                   parm                    p_antu
8.01  *
8.01 c                   eval      b1dant = p_antu
8.01 c                   eval      b1denh = b1oenh
8.01 c                   eval      b1dnet = b1kpri
8.01  *
8.01  * Sjekk om avvik i pris
8.01  * Kaller like gjerne samme program, da dette finner omregnings-
8.01  * faktor mellom to enheter, og beregner hva denne hadde vært i den
8.01  * andre enheten.
8.01  * Om det er antall eller pris skiller ikke programmet på.
8.01  *
8.04 c**                 eval      w_diff = b1nett - b1kpri
8.05 c**                 eval      w_diff = b1dant - b1oant
8.05 c**                 if        w_diff <> 0
8.05 c**                 eval      *in53 = *on
8.01 c                   eval      p_anti = b1nett
8.01 c                   eval      p_antu = 0
8.01  *
8.01 c                   call      'VA770R'
8.01 c                   parm                    w_firm
8.01 c                   parm                    ldvare
8.01 c*                  parm                    b1enh1
8.01 c                   parm                    b1oenh
8.01 c                   parm                    p_anti
8.01 c*                  parm                    b1oenh
8.01 c                   parm                    b1enh1
8.01 c                   parm                    p_antu
8.01  *
8.01 c                   eval      b1dnet = p_antu
8.04 c**                 eval      w_diff = b1nett - p_antu
8.04 c                   eval      w_diff = b1dnet - b1kpri
8.01 c                   if        w_diff <> 0
8.01 c                   eval      *in54 = *on
8.01 c                   endif
8.01  *
8.05 c**                 endif
8.01  *
8.01 c                   endsr
8.01  *
8.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.02  * Regner om antall/pris hvsi det er avvike mellom enheter  F14
8.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.02  *
8.02 c     omr_enh14     begsr
8.02  *
8.02  * Regn om til bestilt enhet hvis det avvikende enheter
8.02  *
8.02 c                   eval      w_dant = 0
8.02 c                   eval      w_dnet = 0
8.02 c                   eval      w_dinp = 0
8.02 c                   eval      p_anti = ldanta
8.02 c                   eval      p_antu = 0
8.02  *
8.02 c                   call      'VA770R'
8.02 c                   parm                    w_firm
8.02 c                   parm                    ldvare
8.02 c                   parm                    ldenh1
8.02 c                   parm                    p_anti
8.02 c                   parm                    fdenh1
8.02 c                   parm                    p_antu
8.02  *
8.02 c                   eval      w_dant = p_antu
8.02  *
8.02  * Sjekk om avvik i pris
8.02  * Kaller like gjerne samme program, da dette finner omregnings-
8.02  * faktor mellom to enheter, og beregner hva denne hadde vært i den
8.02  * andre enheten.
8.02  * Om det er antall eller pris skiller ikke programmet på.
8.02  *
8.02 c                   eval      w_diff = ldkpny - fdkopr
8.02 c                   if        w_diff <> 0
8.02 c                   eval      p_anti = ldkpny
8.02 c                   eval      p_antu = 0
8.02  * Kostpris
8.02 c                   call      'VA770R'
8.02 c                   parm                    w_firm
8.02 c                   parm                    ldvare
8.02 c                   parm                    fdenh1
8.02 c                   parm                    p_anti
8.02 c                   parm                    ldenh1
8.02 c                   parm                    p_antu
8.02  *
8.02 c                   eval      w_dnet = p_antu
8.02  * Innkjøpspris
8.02 c                   eval      p_anti = ldipny
8.02 c                   eval      p_antu = 0
8.02  *
8.02 c                   call      'VA770R'
8.02 c                   parm                    w_firm
8.02 c                   parm                    ldvare
8.02 c                   parm                    fdenh1
8.02 c                   parm                    p_anti
8.02 c                   parm                    ldenh1
8.02 c                   parm                    p_antu
8.02  *
8.02 c                   eval      w_dinp = p_antu
8.02  *
8.02 c                   endif
8.02  *
8.02 c                   endsr
8.02  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
6.22 c     *dtaara       define    *lda          lda
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_firm
     c                   parm                    p_numm
     c                   parm                    p_suff
      *
      * Key for oppslag på ordre-hode-register
      *
     c     lohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
      *
      * Key for oppslag på leverandør
      *
     c     rlevl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rlevl1_levr
      *
      * Key for les på bestillings - linjer
      *
     c     lodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
      *
      * Key for les på ordre-linje-register
      *
     c     fodtlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fodtlr_numm
     c                   kfld                    fodtlr_suff
     c                   kfld                    fodtlr_line
      *
     c     fodtlr_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    fodtlr_numm
     c                   kfld                    fodtlr_suff
6.2e  *
6.2e  * Key for oppslag på ordre-linje
6.2e  *
6.2e c     fodtl1_key    klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    fodtl1_numm
6.2e c                   kfld                    fodtl1_suff
6.2e c                   kfld                    fodtl1_line
6.2e  *
6.2e  * Key for oppslag på ordre-linje
6.2e  *
6.2e c     fodtl1_key2   klist
6.2e c                   kfld                    w_firm
6.2e c                   kfld                    fodtl1_numm
6.2e c                   kfld                    fodtl1_suff
7.01  *
7.01  * Key for oppslag på ordre-linje
7.01  *
7.01 c     fodtlu_key    klist
7.01 c                   kfld                    w_firm
7.01 c                   kfld                    fodtlu_numm
7.01 c                   kfld                    fodtlu_suff
      *
      * Key for les av ordre-hode
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohel1_numm
     c                   kfld                    fohel1_suff
      *
      * Key for oppdatering av ordre-hode
      *
     c     fohelu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohelu_numm
     c                   kfld                    fohelu_suff
6.20  *
6.20  * Key for oppslag på status-register
6.20  *
6.20 c     fstsl1_key    klist
6.20 c                   kfld                    w_firm
6.20  *
6.20  * Key for arbeidsregister for endringer
6.20  *
6.20 c     fwbolu_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    fwbolu_numm
6.20 c                   kfld                    fwbolu_suff
6.20 c                   kfld                    fwbolu_line
6.20 c                   kfld                    fwbolu_type
6.20  *
6.20  * Key for oppslag på selger-register
6.20  *
6.20 c     ra09lr_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    ra09lr_ikod
6.20  *
6.20  * Key for les på ordre-linje-register
6.20  *
6.20 c     lodtlr_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    lodtlr_numm
6.20 c                   kfld                    lodtlr_suff
6.20 c                   kfld                    lodtlr_line
6.22  *
6.22  * Key for les på ordre-linje-register
6.22  *
6.22 c     lodtlr_key2   klist
6.22 c                   kfld                    w_firm
6.22 c                   kfld                    lodtlr_numm
6.22 c                   kfld                    lodtlr_suff
7.12  *
7.12  * Key for propertiesfil
7.12  *
8.03 c*    afpslr_key    klist
8.03 c*                  kfld                    afpslr_ufil
8.03 c*                  kfld                    afpslr_uide
7.03  *
7.03  * Key for les på lager
7.03  *
7.03 c     vlagl1_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    w_vare
7.03 c                   kfld                    vlagl1_lage
7.fb  *
7.fb  * Key for oppslag på depositum-fil
7.fb  *
7.fb c     sdepl1_key    klist
7.fb c                   kfld                    w_firm
7.fb c                   kfld                    sdepl1_numm
7.fb c                   kfld                    sdepl1_kund
7.fb c                   kfld                    sdepl1_tell
      *
      * Henter parameter-verdier
      *
     c                   eval      w_firm = p_firm
     c                   eval      w_numm = p_numm
     c                   eval      w_suff = p_suff
7.01  *
7.01  * Endring 7.01 Hvis utfylt bekreftet leveringsdato,
7.01  * oppdateres tilhørende ordre.
7.01  *
7.01   CallP CO402R(l_filg:w_firm:0:'LO580R_701':
7.01                    co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     u_701 = *on;
7.01   endif;
7.12  *
7.12  * Utvidet memosaldo
7.12  *
7.12   CallP CO402R(l_filg:w_firm:0:'UTVIDET_MEMOSALDO':
7.12                    co402_verdi1:co402_verdi2);
7.12   if co402_verdi1 = '1';
7.12     u_s702 = *on;
7.12   endif;
7.03  *
7.03  * Endring 7.03 Varetype skal være blank dersom alle = S
7.03  *
7.03   CallP CO402R(l_filg:w_firm:0:'LO580R_703':
7.03                    co402_verdi1:co402_verdi2);
7.03   if co402_verdi1 = '1';
7.03     u_703 = *on;
7.03   endif;
7.05  *
7.05  * Endring 7.05 Styre om innkjøpspris sjekker mot kostpris på ordren.
7.05  *
7.05   CallP CO402R(l_filg:w_firm:0:'LO580R_705':
7.05                    co402_verdi1:co402_verdi2);
7.05   if co402_verdi1 = '1';
7.05     u_705 = *on;
7.05   endif;
      *
     c                   eval      *in22 = *on
6.20  *
6.20  * Hent opplysninger fra ofak koderegister
6.20  *
6.20 c     fstsl1_key    chain     fstsl1r                            90
      *
8.03  * Utvidet memosaldo
8.03  *   Hent inn % utvidelse av kreditgrense
8.03  *   Hent inn ant dager fram ordre skal med i memosaldo
8.03  *
8.03 c                   eval      w_memodagr = 999
8.03 c                   eval      w_utvgrns  = 0
8.03  *
8.03   CallP CO402R(l_filg:w_firm:0:'UTVIDET_MEMOSALDO':
8.03                    co402_verdi1:co402_verdi2);
8.03   if co402_verdi1 = '1';
8.03     u_s702 = *on;
8.03     if  %subst(co402_verdi2:1:3) <> *blank;
8.03       w_memodagr = %dec(%subst(co402_verdi2:1:3):3:0);
8.03     endif;
8.03     if  %subst(co402_verdi2:133:2) <> *blank;
8.03       w_utvgrns = %dec(%subst(co402_verdi2:133:2):2:0);
8.03     endif;
8.03   endif;
8.08  *
8.08  * Endring 8.03 - Koblet til ekstern flåtestyring
8.08  *
8.08   CallP CO402R(l_filg:w_firm:0:'EKSTERN_FLATESTYRING':
8.08                    co402_verdi1:co402_verdi2);
8.08   if co402_verdi1 = '1';
8.08     u_flat = *on;
8.08   endif;
8.08  *
8.03 c*                  eval      afpslr_ufil = l_filg
8.03 c*                  eval      afpslr_uide = 'KRGRNSUTV'
8.03 c*    afpslr_key    chain     afpslrr
8.03 c*                  if        %found(afpslr)
8.03 c*                  movel     afudss        w_utvgrns
8.03 c*                  endif
8.03  *
8.03  *   Hent inn ant dager fram ordre skal med i memosaldo
8.03 c*                  eval      afpslr_uide = 'MEMODAGER'
8.03 c*    afpslr_key    chain     afpslrr
8.02 c*                  if        %found(afpslr)
8.03 c*                  movel     afudss        w_3x
8.03 c*                  move      w_3x          w_memodagr
8.03 c*                  endif
      *
     c                   endsr
      *
