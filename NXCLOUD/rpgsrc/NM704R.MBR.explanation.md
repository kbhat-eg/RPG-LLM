## Program Overview

This RPG IV (ILE RPG) program (NM704R) is intended for the "ehandel MGR" system and is used to export warehouse (lager) data for e-commerce integration. The code is geared towards a special version for "Mestergruppen" with custom adjustments for chain code, store ID, and organization number in the output.

The primary tasks of the program are:
- Read setup and organization information.
- Output a structured file containing message headers, organization data, and a list of warehouse records.
- Each output record follows a specific segment format, separated by semicolons (`;`).

### High-level Structure

- **File Declarations**: Reads from several input files (fra91l1, fanbll3, fanbhl1) and outputs to `netlager`.
- **Field and Data Structure Declarations**: Data structures model the logical segments of the output file (message header, organization, warehouse, tail).
- **Main Program**: Handles:
  - Initialization and data checking.
  - Segment output in a prescribed sequence.
  - Iterates over warehouse records and writes them out.
  - Output a summary (tail) segment.

---

## Header Specifications

```rpg
h option(*nodebugio) datedit(*dmy)
h alwnull(*usrctl)
```

- Disables debug for data I/O and sets date format to DMY.
- Allows null values under user control.

---

## File Declarations

```rpg
fra91l1    if   e           k disk    rename(ra91pfr:ra91l1r)
fanbll3    if   e           k disk    rename(anblpfr:anbll3r)
fanbhl1    if   e           k disk    rename(anbhpfr:anbhl1r)
fnetlager  uf a e           k disk
```

- **fra91l1**, **fanbll3**, **fanbhl1**: Input files, renamed record formats for clarity.
- **fnetlager**: Output file, user-opened, additive, keyed, for writing the export records.

---

## Local Data Area (LDA) and Variables

```rpg
d l_firm                944    946  0
d l_fgr                 931    933
```
- Extracts company/group numbers from LDA.

---

## Data Structures for Output Segments

### 1. Message Header (`UNH`)

```rpg
d d_unh                         41
d  d_unhrcd                      3    overlay(d_unh: 1) inz('UNH')
...
d  d_unhtypeid                   6    overlay(d_unh:32) inz('IMLIMP')
...
d  d_unhversion                  3    overlay(d_unh:39) inz('1.0')
```
- Positions and overlays are used to populate a single structure (`d_unh`) with required segment fields, using `;` as delimiters.

### 2. Message Start (`BGM`)

```rpg
d d_bgm                         20
d  d_bgmrcd                      3    overlay(d_bgm: 1) inz('BGM')
d  d_bgmetypekod                10    overlay(d_bgm: 5) inz('IMLDATAWHS')
...
d  d_bgmfunction                 1    overlay(d_bgm:17) inz('1')
```
- Contains the message type and function code.

### 3. Organization (`ORG`)

```rpg
d d_org                        126
d  d_orgrcd                      3    overlay(d_org: 1) inz('ORG')
d  d_orgid                      30    overlay(d_org: 5)
d  d_orgstoreid                 30    overlay(d_org:36)
d  d_orgname                    60    overlay(d_org:67)
```
- Holds sender organization, store, and descriptive name.

### 4. Warehouse (`WHS`)

```rpg
d d_whs                        100
d  d_whsrcd                      3    overlay(d_whs:  1) inz('WHS')
d  d_whslage                     2  0 overlay(d_whs:  5)
d  d_whslnav                    20    overlay(d_whs:  8)
d  d_whsregion                   2  0 overlay(d_whs: 29)
d  d_whskjede                    2    overlay(d_whs: 32)
d  d_whsorgid                   25    overlay(d_whs: 35)
d  d_whsorgno                    9    overlay(d_whs: 61)
```
- Outputs warehouse number, name, region, chain code, organization ID, and organization number.

### 5. Message Tail (`UNT`)

```rpg
d d_unt                         43
d  d_untrcd                      3    overlay(d_unt: 1) inz('UNT')
d  d_untnosegmen                12  0 overlay(d_unt: 5)
d  d_untrefno                   26    overlay(d_unt:18)
```
- Outputs the segment count and reference, finalizing the message.

---

## Variable Declarations

Defines working variables for keys, counters, date/time, and status.

---

## Main Control Flow

### 1. Initialization

```rpg
c                   eval      p_stat = *blank
```

- Status parameter cleared.

### 2. Read E-commerce Setup

```rpg
c                   eval      anbll3_fgr = l_fgr
c                   eval      anbll3_fir = l_firm
c     anbll3_key    chain     anbll3r
c                   if        not %found
c                   eval      p_stat = 'E'
c                   goto      avslutt
...
```

- Loads group and company keys from LDA and checks if setup exists. If not, sets error status and exits the program.
- Similarly, looks up owner record.

### 3. Write UNH (Message Header) Segment

```rpg
c                   time                    w_tmst
c                   time                    w_dato
c                   move      w_tmst        d_unhrefno
c                   eval      data = d_unh
c                   write     netlagerr
```

- Timestamp retrieved and placed into the reference number field.
- Header segment written to output.

### 4. Write BGM (Message Start) Segment

```rpg
c                   eval      data = d_bgm
c                   write     netlagerr
```

### 5. Write ORG (Organization) Segment

```rpg
c                   eval      d_orgid = aoheie
c                   eval      d_orgstoreid = aolbut
c                   eval      d_orgname = aohnav
c                   eval      data = d_org
c                   write     netlagerr
```

- Populates the organization segment with data from the found owner record.

### 6. Write WHS (Warehouse) Segments

```rpg
c     ra91l1_key    setll     ra91l1
c     ra91l1_key    reade     ra91l1r
c                   dow       %eof = *off
...
9.01 c                   if        rrlage <> 0  and
9.01 c                             rrebiz <> 1
c                   eval      d_whslage = rrlage
c                   eval      d_whslnav = rrltek
c                   eval      d_whsregion = rrregi
9.02 c                   eval      d_whskjede = rrkjed
9.02 c                   eval      d_whsorgid = aoheie
9.03 c                   eval      d_whsorgno = aoheie
c                   eval      data = d_whs
c                   write     netlagerr
c                   eval      w_tell = w_tell + 1
c                   endif
...
c     ra91l1_key    reade     ra91l1r
c                   enddo
```

- Loops through warehouse records for the company.
- Warehouse is output only if the warehouse number is not zero and it's not marked as "e-biz excluded".
- Fills in various fields (warehouse number, name, region, chain, org id/number).
- Each valid record increments the segment count.

### 7. Write UNT (Message Tail) Segment

```rpg
c                   eval      d_untnosegmen = w_tell
c                   eval      d_untrefno = d_unhrefno
c                   eval      data = d_unt
c                   write     netlagerr
```

- Outputs the segment count and finalizes the message.

### 8. Exit Routine

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```

- Conventional RPG exit for cleanup.

---

## Initialization Subroutine (`*INZSR`)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_stat
...
c     ra91l1_key    klist
c                   kfld                    w_firm
...
c     anbll3_key    klist
c                   kfld                    anbll3_fgr
c                   kfld                    anbll3_fir
...
c                   eval      w_firm = l_firm
c                   endsr
```

- Linkes subroutine for startup.
- Sets up parameter list, key lists for file processing, and initializes the company number from LDA.

---

## Summary

- This program exports a structured set of data for e-commerce integration.
- It reads organization and warehouse data, formats it into a predefined, delimited layout, and writes to an output file.
- Segment structures (header, start, org, warehouse, tail) are clearly defined and populated.
- There are built-in controls to skip warehouses that shouldn't be included and to signal errors if required configuration is missing.
- Code modifications are logged as version comments at the top, indicating ongoing adaptation to changing requirements.

---

### Keywords

- **Segment**: A logical row in the output file corresponding to a message part.
- **Overlay**: RPG technique to allow different fields in a data structure to refer to specific byte offsets, for precise data formatting.
- **LDA**: Local Data Area, used for passing control data between jobs/programs.
- **Chain**, **Setll**, **Reade**: RPG file processing opcodes for keyed access/reads.

---

### Onboarding Tips

- Understand the file layout and segment definitions.
- Be aware of which fields are sourced from which database records.
- Note use of overlays for precise segment formatting.
- Changing the data protocol (segment structure/order) requires updating both the data structures and write logic.
- All key business rules for filtering/exclusion are in the warehouse output loop. 

---

**For further development:**
- Ensure all files are correctly defined in the program's file section/DFDs.
- If altering segment definitions, update both the data structures and output logic.
- Test with realistic LDA and input file data to ensure correct output.