```markdown
# Program Overview

This RPG program (RE110R) is designed to **update customer records** (kunder) in a database, integrating data from external systems into the local customer master files on an IBM i (AS/400, iSeries). The program enforces data integrity and business rules about customer ranges, company (firm) selection, and provides a means to add new customers if they do not exist.

The code is a mixture of classic fixed-format RPG with some enhancements added in later versions, and extensive in-line documentation (some in Norwegian).

---

## File Declarations

### Input/Output Files

- `re0kpf` – (Primary file, keyed, disk)
- `raa1l1` – (Keyed Input, renamed record format as `raa1l1r`)
- `rkmelu` – (Update file, keyed, renamed as `rkmelur` with prefix `rx`: Memo balance file, added in v6.20)
- `rkunlu` – (Update file, keyed, renamed as `rkunlur`: Customer master file)

---

## Constants

- `lo` and `uh` are two constants containing lower and upper case alphabets, used for upper-case conversion of fields.

---

## Local Data Areas (LDA) and Working Variables

- The *user space* (`uds`) is being mapped to pick up:
  - `l_user` (positions 911–920): User ID
  - `l_firm` (944–946): Firm number
  - `l_navn` (951–980): Name

- Numerous working variables defined (as `w_*`), each with the same type as the corresponding field of the customer file (e.g., `w_navn` is like `rknavn`). These act as work buffers to facilitate data handling and assignments.

---

## Key Business Logic

### 1. **Company Check**

```rpg
if rkfirm <> l_firm
   goto slutt
endif
```
- The program first checks that the selected record (`rkfirm`) matches the local firm number (`l_firm`). If not, processing ends.

---

### 2. **Customer Number Range Validation**

```rpg
if rkkund <= ra1hkt or rkkund > ra1hrs
   goto slutt
endif
```
- Validates the customer number (`rkkund`) is within the allowed range from the `raa1l1` record (fields `ra1hkt` to `ra1hrs`). If outside, processing ends.

---

### 3. **Field Assignment**

- Loads various fields from the customer file into corresponding work variables (`w_*`).
- If the field for alpha-search (`w_alfa`) is blank, assigns it from the customer name, and converts it to upper-case using `XLATE`.

---

### 4. **Customer Lookup and Update/Add**

```rpg
rkunlu_kund = rkkund
chain rkunlu
```
- Searches for the customer in `rkunlu` (customer master).

**If found:**
- Updates existing customer fields with new values from the work variables, applying checks (only non-blank or non-zero values overwrite).

**If not found:**
- Initializes certain fields (like balance, purchase stats) to zero.
- Writes a new customer record to `rkunlu` (customer master).

---

### 5. **Memosaldo/Memo Balance Handling** (v6.20+)

- Adds a related memo balance record in `rkmelu` if it does not exist. Initializes its fields to zero and stamps with current date/time and user.

---

### 6. **Alpha-Search Register Update**

```rpg
call 'RK750R'
parm rkfirm
parm rkkund
```
- Calls an external program to update the alpha-search registry for the given customer.

---

## Subroutine: `*inzsr` (Initialization)

- Builds keys for file access using the firm and customer number.
- Chains to `raa1l1` (status code file) to load company parameters.

---

## Key RPG Patterns and Techniques Used

- **XLATE**: Used to upper-case the `rkalfa` field for case-insensitive searching.
- **CHAIN & UPDATE/WRITE**: Reads and updates (or creates) customer and memo records.
- **Conditional Assignment**: Only updates fields if the work variable is non-blank/non-zero, to avoid overwriting with blanks/defaults.
- **Use of LDA**: For initialization parameters and user info.
- **Prefix and Rename**: To avoid field name conflicts when working with multiple files having similar structures.

---

## Business Context & Comments

- The code is well commented, contains change history, and most field names are Norwegian abbreviations (e.g., `navn` = name, `kunde` = customer, `salgo` = balance, etc.).
- The program is sensitive to customer and firm ranges, preventing accidental updates outside of the designated company/customer segment.
- The approach separates updating of the customer master from the memo balance file, highlighting data normalization best practices.

---

## Onboarding Notes

- **To add new fields**, mimic the `w_*` variable pattern and update the update/add logic.
- **To change business rules** (e.g., customer range, alpha conversion), modify relevant conditional blocks.
- **External program `RK750R`** should be maintained in tandem for proper alpha-search register functionality.
- **Data area layout** (LDA) must remain consistent for proper initialization.

---
```