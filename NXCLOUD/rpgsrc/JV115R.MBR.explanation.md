# RPG Program Explanation

This document describes an RPG (Report Program Generator) program designed for IBM i (AS/400, iSeries) systems, originally written in Norwegian. The program appears to be a maintenance application for “NRF codes”—likely some kind of registry or code set.

The code uses traditional fixed-format RPG/400 (ILE RPG IV). The code is structured around handling subfiles (lists displayed and maintained on-screen), and allows CRUD (Create, Read, Update, Delete) operations, as well as navigation and validation.

---

## Key Concepts

### High-Level Program Description

- **Purpose:** Maintenance of NRF codes, with subfile (scrollable list) display and standard editing, adding, copying, and deleting.
- **UI:** Uses multiple display screens (DSPFs): main subfile, control records, command screens, new/edit screens, message windows, etc.
- **Files:** Operates on several physical/logical files, likely representing master data or registry entries.
- **Interaction:** The user interacts through a workstation display file, which includes subfile records and controls.

---

## Main Areas of the Code

### File Specifications (`F` specs)

```rpg
fjvarl3    if   e           k disk    rename(jvarpfr:jvarl3r)
fjvnrl1    if   e           k disk    rename(jvnrpfr:jvnrl1r)
fjvnrlr    if   e           k disk    rename(jvnrpfr:jvnrlrr)
fjvnrlu    uf a e           k disk    rename(jvnrpfr:jvnrlur)
fjv115d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **Logical/physical files**: `jvarl3`, `jvnrl1`, `jvnrlr`, `jvnrlu`
  - All are keyed (`k disk`), and renamed to local record formats.
- **Display file**: `jv115d` (workstn), using subfile `b1sfl` with relative record number `w_srrn`.
- **Display feedback**: Information Data Structure (`infds(dspfbk)`), allowing feedback from screen.

---

### Data/Field Definitions (`D` specs)

- **Local Data Area:** Picks up user (`l_user`), firm number (`l_firm`), etc.
- **Display feedback structure:** Holds cursor position, etc.
- **Key fields and working variables:** (e.g. `jvnrl1_nnrf`, `w_fcrn`, `w_srrn`, etc.)
- **Flags:** (e.g. `b_oppr` for create, `b_forn` for refresh, etc.)
- **Constants:** e.g. `c_sfil` is the subfile page size (default 13).

---

### Indicator Usage

The code makes heavy use of RPG indicators:

- ***INLR**: End program.
- **10, 11, 12, 13, 14, 15, etc.**: Roll up/down, subfile logic, field protection, errors, etc.

---

## Mainline Logic

The program is highly modularized with tags and subroutines (`begsr`/`endsr`). Here is the mainline's structure:

1. **b2taga:** Entry point after display of command screen.
    - Writes a command screen.
2. **b2tagb:** Calls display subfile logic.
3. **Function Key Handling:** Selects action based on function key pressed.
    - `*INKC`, `*INKL`: Exit; set LR and return.
    - `*INKE`: Refresh subfile.
    - `*INKF`: Call "create new" screen.
    - `*IN10`: Page down (next subfile page).
    - `*IN11`: Page up (prev subfile page).
    - `*IN21`: "Home" key; set cursor.
4. **Positioning:** If a positioning field (`b2nnrf`) is provided, calls position logic.
5. **Subfile Handling:** Performs CRUD on subfile entries.
6. **Loop back:** Returns to main tag to await further input.

---

## Subroutines

### forny

- Refreshes the subfile (after add, edit, or delete).
- Positions on the first record as necessary.

### posisjoner

- Positions on a provided key value.
- Rebuilds the subfile starting at the right spot.

### subfile

- Loops through subfile entries:
    - Detects which entries are marked for action (edit, copy, delete, view).
    - Executes respective subroutines for each.

### xc1bld

- Handles creating a new entry (shows new-entry screen).
- Validates data, prevents duplicate keys, and calls edit logic.

### xc1msg

- Shows a message if trying to create a record with a duplicate key.

### xc2bld

- Handles both edit and display of existing entries (shows edit/view screen).
- Loads relevant fields, allows update or insert.
- Updates subfile and database as necessary.

### xd1win

- Handles deletion confirmation and performs delete from database.

### xk1win

- Handles copying an entry by showing a copy window and managing duplicate key validation.

### clr_subfile

- Clears the subfile, resets counters.

### crt_subfile

- Loads up to a full subfile page from the file, filling the screen.

### bck_subfile

- Scrolls the subfile back one page, rebuilds the subfile for the previous records.

### dsp_subfile

- Displays the subfile screen.
- Handles subfile control for display.

### *inzsr

- The *INZSR (initialization) subroutine.
- Handles parameter input, sets up keys, populates static fields, primes the subfile.

---

## Subfile-Specific Variables (explained in comments)

- **w_fcrn**: First record number on the page.
- **w_stel**: Subfile counter.
- **w_spge**: Page size in subfile.
- **w_srrn**: Relative record number.
- **w_sfrn**: First record number on last page.
- **w_ssrn**: Last record number on last page.

---

## Key Handling

The program responds to various function keys mapped to RPG indicators. Here are some mappings from the program comment:

- **10** = Page Up (Roll up)
- **11** = Page Down (Roll down)
- **12** = Display subfile
- **13** = Subfile control display
- **14** = Clear subfile
- **15** = End subfile
- **21** = Home key
- **22** = Set cursor position
- **30** = Protect fields on display
- **31-79** = Error/warning alerts
- **80-99** = Internal working indicators

---

## Screen/Record Formats

- **B1SFL**: Subfile entry (main list)
- **B2CTL**: Subfile control record
- **B2CMD**: Command screen
- **C1BLD**: Create new key screen
- **C1MSG**: Message screen for create
- **C2BLD**: Edit/view screen
- **D1WIN**: Delete confirm window
- **K1WIN**: Copy window

---

## Typical Workflow

1. User enters program with parameters for which registry (NRF) codes to work on.
2. The subfile is filled with current entries.
3. User can:
    - Page up/down to see more entries
    - Select a line to edit, copy, view, or delete
    - Create a new entry
    - Position to a code value
4. For each action, the respective subroutine is called, the database is updated, and the subfile is refreshed.

---

## Error and Validation

- The code checks for data validity (e.g., blank group code, duplicate entries).
- Before insert/update/delete, it validates against existing data.
- If duplicate, displays a message and prompts user.
- Subfile indicators are used to trigger error displays or protect fields.

---

## Initialization

- Receives parameters (likely external call):
    - Key to position on (`p_bnob`)
    - Function code (`p_valg`)
- Reads data from LDA (Local Data Area) to pick up user/environmental info.
- Fills subfile for the provided key.

---

## Notes

- The code is written in a style common before /free-format RPG, using numeric tags and heavy use of indicators.
- Modern RPG would use /free, named variables, and less reliance on global indicators.
- The logic is well documented with Norwegian inline comments for each section.
- Many routines use `chain` (random access by key), `read`, `readc` (read changed), `write`, `update`, `delete` to manipulate data and subfiles.

---

## Summary Table

| Functionality      | Subroutine / Tag | Description |
|--------------------|------------------|-------------|
| Initialize         | `*inzsr`         | Prepares environment, keys, fills subfile |
| Display subfile    | `dsp_subfile`    | Shows subfile screen |
| Page forward       | `crt_subfile`    | Loads next set of records into the subfile |
| Page backward      | `bck_subfile`    | Loads previous records into subfile |
| Refresh            | `forny`          | Refreshes display/subfile |
| Position           | `posisjoner`     | Positions subfile at given key |
| Add new            | `xc1bld`         | Add a new NRF code |
| Edit/View entry    | `xc2bld`         | Edit or view an entry |
| Copy entry         | `xk1win`         | Copy an entry |
| Delete entry       | `xd1win`         | Delete an entry |
| Validation message | `xc1msg`         | Show error message to user |

---

### Takeaway

The program is a classic RPG/400 subfile maintenance utility, robustly handling all CRUD operations and navigation within the IBM i green screen context, using best practices for its time. It’s suitable for a developer familiar with classic RPG and IBM i user interface patterns, and can be readily extended or modernized to RPGLE free-format with little effort once business context is understood.