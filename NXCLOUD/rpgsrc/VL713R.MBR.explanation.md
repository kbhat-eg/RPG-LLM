# RPG Source Code Explanation

## Overview

This RPG program, named **VL713R**, is used to check and determine the applicable price group (`prisgruppe`) for a given product (`vare`) in relation to its associated supplier, warehouse, and other attributes. It is designed to be called by other programs, typically supplying a warehouse or department as input. The code is highly modular, using subroutines and keyed file access, and heavily interacts with database files.

---

## Header and Documentation

- `h option(*nodebugio) datedit(*dmy)`  
  - Sets up compiler options: no debug I/O, date format as day/month/year.

- The initial comments provide metadata:
  - System and Program names (`ASOFAK` and `VL713R`).
  - Brief description: checks if the given price group exists for the selected product.
  - Details on input/output parameters.
  - Audit trail for changes, with dates and descriptions.

---

## File Definitions

- **Physical Files Used:**
  - `vpgrl1` – Price group master file (renamed to `vpgrl1r`).
  - `vvprl1` – Product price registration file (renamed to `vvprl1r`).
  - `vvarl1` – Product master file (renamed to `vvarl1r`, version 6.20+).

- `if   e           k disk    rename(...)`  
  These are externally described, keyed, disk files for reading relevant data.

---

## Variable Declarations

- Variables mirror physical fields for easy file access and key construction.
  - E.g., `vvprl1_vare` is defined as `like(vpvare)` (inherits type/length from the file field).

- **Parameters for Subroutine Entry:**
  - Input: `p_iprg` (input price group), `p_vare` (product), `p_enhe` (unit), `p_lety` (delivery type), `p_firm` (company)
  - Output: `p_oprg` (output price group)

- **Other Control Fields:**
  - `b_pris` and `b_inlr` as state flags (indicator variables).
  - Fields for company (`w_firm`), date (`w_dato`), warehouse (`w_lage`), and supplier (`w_ldor`).

---

## Main Processing Logic

### Program Entry

- The `*inzsr` subroutine is called automatically to initialize:
  - Sets up parameter list and keys for file reads.
  - Initializes working variables (`w_firm`, etc.).
  - Gets the system time (`time w_dato`), used for date comparison.

### Main Routine

1. **Read Product Master Record:**  
   - Fetches product record for the given input.
   - Prepares warehouse number from user info.

2. **Fetch Supplier for Product & Warehouse:**  
   - Calls another program (`VL721R`) to get the supplier (`w_ldor`) for the product and warehouse.

3. **Initialize Output & State:**  
   - Output price group (`p_oprg`) is blank; price found flag (`b_pris`) is off.

4. **Search for Price by Priority:**  
   Price lookup is performed with decreasing priority:
   - **First:** By supplier for the specific warehouse.
   - **Second:** By the main/default supplier (if different from above).
   - **Third:** With supplier key set to zero (fallback).

5. **Finish:**  
   - Program ends by setting `*inlr` (last record indicator) on, which releases resources.
   - Returns to caller.

---

## Subroutine: `hent_pris` (Get Price)

- Sets up all relevant fields for price lookup, including product, price group, unit, and delivery type.
- Positions to the correct record in the product price file (`vvprl1`) via the key list (`setll` / `reade`).
- If a price is found:
  - Sets `b_pris` flag to on.
  - Sets output price group to the value from the file (`vpprgr`).
- If date (`w_dato`) >= price validity date (`vppdat`), record is valid and loop exits.
- Otherwise, continues reading next record with the same key.
- Subroutine ends.

---

## Key Lists

Key lists (`klist`) are used to build composite keys for exact file access:
- `vvprl1_key`: company, product, supplier, price group, unit, delivery type.
- `vvarl1_key`: company, product.

---

## Summary Flow

1. **Initialize:** Set up all working variables and keys.
2. **Get supplier for product & warehouse.**
3. **Attempt to find a matching price record (in order of supplier specificity).**
4. **If found, set output price group.**
5. **Return to caller.**

---

## Usage and Extension

- **Parameters:** Designed for easy invocation by other RPG programs.
- **Extensible:** New fields (e.g. supplier, 2-character price group) added in versioned comments.
- **Modular:** Relies on subroutines and external programs for specialized logic.

---

## Comments & Best Practices

- The code is well-commented (in Norwegian), with clear history tracking and logic organization.
- Externalization of business logic (e.g. supplier lookup) allows for easier changes and testing.
- Use of named subroutines and key lists helps clarity and maintainability.

---

## Key Concepts

- **Chain/Setll/Reade:** Efficient keyed access to DB2 for i tables/files.
- **Parameter passing:** Standard RPG subroutine with a parameter list for I/O.
- **State flags:** RPG's 1-byte indicators are used as booleans.
- **Date handling:** System date is fetched at runtime for price validity checks.

---

## Typical Usage Scenario

Another program calls `VL713R` with a company, product, unit, delivery type, and desired price group. This program finds the effective price group for the product based on its supplier and warehouse, then returns the appropriate price group code, or blank if none matches current conditions.

---

**In short, this program is a specialized price group validator and retriever, looking up effective prices for a product for a given organizational and logistical context, ensuring callers get the best-match price group for the input parameters provided.**