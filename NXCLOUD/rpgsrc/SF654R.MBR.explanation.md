# RPG Program Walkthrough and Explanation

This ILE RPG program (SF654R) processes and prints usage rights payments ("bruksrettytelser"), reading from multiple database files and producing a report. It’s tailored for an IBM i (AS/400) environment, using classic Fixed Format RPG (RPG/400, not Free Format).

Below is a structured explanation:

---

## Header & Program Information

```rpg
h datedit(*dmy) option(*nodebugio)
```
- `h datedit(*dmy)`: Dates default to day-month-year format.
- `option(*nodebugio)`: Disables debug for file I/O operations.

### Comments

The initial comments document purpose, usage of indicators, and program history (signatures, version, change log).

#### Indicator Usage (From Comments)
- `*INLR`: End of program.
- `*IN30`: Printer overflow.
- `*IN90`, `*IN91`: End-of-file or not found indicators for various file operations.
- Ranges for program logic (warnings, file ops, work indicators, etc.).

---

## File Declarations

```rpg
frmknl1  if  e  k disk  rename(rmknpfr:rmknl1r)
frmknl2  if  e  k disk  rename(rmknpfr:rmknl2r)
fsstal7  if  e  k disk  rename(sstapfr:sstal7r)
frkunl1  if  e  k disk  rename(rkunpfr:rkunl1r)
fvotyl1  if  e  k disk  rename(votypfr:votyl1r)
fralml1  if  e  k disk  rename(ralmpfr:ralml1r)
fsf654p  o   e  printer oflind(*in30)
```
- Input (`i`) files: Various logical files, most likely referencing property linkages, statistics, customer master, order types, commons registry.
- Output (`o`) file: Printer file, sets overflow indicator to `*IN30`.

---

## Data Definitions

### Key and Work Variables

```rpg
d rmknl1_xalm  s    like(rmxalm)
d rmknl2_xknr  s    like(rmxknr)
d sstal7_paar  s    like(sfpaar)
d sstal7_vkun  s    like(sfvkun)
d rkunl1_kund  s    like(rkkund)
d votyl1_otyp  s    like(sfotyp)
d ralml1_alme  s    like(rmalme)
```
- Variables to hold key field values, heavily used in keyed file operations and lookups.

### Data Structure: Parameter and LDA

```rpg
d             ds
d ldprec              64
d  ldalme              4  0 overlay(ldprec)
d  ldpaar              4  0 overlay(ldprec:5)
d  ldfdat             10d   datfmt(*iso) overlay(ldprec:09)
d  ldtdat             10d   datfmt(*iso) overlay(ldprec:19)
d  ldvari              1  0 overlay(ldprec:35)
```
- `ldprec`: External parameter block (64 bytes).
- Overlaid subfields extract specific values (property, period, date ranges, variant) from the parameter.

```rpg
d             uds
d l_wsid            901    910
d l_user            911    920
d l_file            931    933
d l_firm            944    946  0
d l_fnav            951    980
```
- UDS: User space or Local Data Area parameters (workstation ID, user, file, firm, etc.).

### Other Variables

```rpg
d wwparm      s     64
d w_firm      s     like(rkfirm)
d w_kund_gml  s     like(rkkund)
d w_funnet    s      1  0
d w_tell      s      3  0
```
- `wwparm`: Input parameter.
- `w_firm`: Current firm (company) code.
- `w_kund_gml`: "Old customer"—previously processed customer number.
- `w_funnet`: "Found" flag.
- `w_tell`: Counter, e.g., for number of properties.

---

## Main Logic

### 1. Initialization (`*INZSR`)

Reads parameters (entry parameter, LDA), sets up key lists for all files, fetches the name of the commons area (`almenning`) for reporting.

### 2. Main Loop—Processing Properties

Processes the property linkage file (rmknl1), filtered by area (almenning).

```rpg
c eval rmknl1_xalm = ldalme
c rmknl1_key setll rmknl1
c rmknl1_key reade rmknl1 90
dow *in90 = *off
    if w_kund_gml = rmxknr
        goto neste_knr
    endif
    exsr hent_gbr
    eval w_funnet = 0
    eval t1brk1 = 0
    eval t1brk2 = 0
    eval rkunl1_kund = rmxknr
    rkunl1_key chain rkunl1
    eval a1kund = rmxknr
    eval a1navn = rknavn
    eval a1adr1 = rkgate
    eval a1adr2 = rkadr2
    eval a1sted = rksted
    exsr les_stat
    if w_funnet = 1
        write(e) t1tot
    endif
    eval a1gnr1 = 0 etc...
    eval w_tell = 0
neste_knr tag
    eval w_kund_gml = rmxknr
    rmknl1_key reade rmknl1 90
enddo
```
- For each property record:
    - Skips if customer number is same as the last (already processed).
    - Calls subroutine `hent_gbr` ("fetch properties") to get property details.
    - Initializes sums/flags.
    - Fetches customer info (rkunl1).
    - Calls `les_stat` subroutine to process statistics.
    - If any valid records found, writes totals.
    - Clears out property info for next customer.

### 3. Subroutine: `les_stat` (Read Statistics)

Processes statistics file (sstal7), aggregates sums, outputs details.

#### Flow

- Loops over statistics records for the current customer and period.
    - Skips records outside the date range (`sfbida`).
    - Skips if both usage right rebates (`sfbrk1` and `sfbrk2`) are zero.
    - Skips private purchases (`sfpriv = 1`).
    - On first valid record, writes report header and marks as "found".
    - Fills in detail fields (`d1binr`, `d1otyp`, `d1brk1`, etc.).
    - Looks up order type text.
    - Writes detail line.
    - Checks for printer overflow; if so, writes header again.
    - Updates customer/total sums.

### 4. Subroutine: `hent_gbr` (Fetch Properties)

```rpg
c eval rmknl2_xknr = rmxknr
c rmknl2_key setll rmknl2
c rmknl2_key reade rmknl2 91
dow *in91 = *off
    eval w_tell = w_tell + 1
    select
        when w_tell = 1
          eval a1gnr1 = rmxgnr
          eval a1bnr1 = rmxbnr
        when w_tell = 2...
        ...
    endsl
    rmknl2_key reade rmknl2 91
enddo
```
- Loops through and saves up to 4 property numbers (`g.nr.`/`b.nr.`) per customer.

---

## Key Lists

Key lists (`klist`) are used for file access with multiple key fields. Each file has a matching key list for `CHAIN`, `SETLL`, `READE` operations.

---

## Reporting

- Data is accumulated and written using indicator-controlled output (e.g., `write(e)`).
- Handles printer overflow (`*IN30`).

---

## Program End

- Sets LR indicator to end program (`*INLR = *ON`).
- Finalizes/write summary lines.

---

## Summary of the Logic

1. **Reads parameter block & LDA to set up initial criteria (company, period, date range, area, etc.).**
2. **Loops through all properties in the selected area:**
    - For each unique customer, gathers their linked properties.
    - Collects customer info.
    - Reads their usage right statistics for the selected period/dates.
    - Prints detailed and summary lines per customer.
    - At the end, prints totals.
3. **Handles multiple files, key field logic, and uses indicators for flow control and output formatting.**

---

## Conclusion

This RPG program processes complex, multi-file business data, using classic RPG idioms: overlays, indicators, subroutines, and keyed file I/O. The code emphasizes modularity (subroutines for key operations), robust reporting (handling overflow and summaries), and is tailored for property/usage-based payment reporting within a firm.

If you need detail on a particular section or variable, let me know!