# RPG Program RL500R - Source Code Explanation

This is an ILE RPG (RPG IV) source for a subprogram named `RL500R`, used to display and search suppliers (“leverandører” in Norwegian) in a subfile interface, typically as part of an AS/400 (IBM i) application. Comments (in Norwegian) and structured code provide a clear picture of its behavior and logic.

## 1. **Header and Metadata**
- **`h option(*nodebugio) datedit(*dmy)`**  
  Compiler options: suppress debug I/O, use DD/MM/YY date edit.
- **History, description, and standards documentation**  
  At the top, the program name, system, description, and change logs provide context.

## 2. **Files and Workstation Definitions**
- **Physical and Logical Files**  
    ```rpg
    frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
    frlevl2    if   e           k disk    rename(rlevpfr:rlevl2r)
    frlsopf    if   e           k disk
    ```
    - `rlevl1`, `rlevl2`: Logical files over vendor master data, allowing keyed access.
    - `rlsopf`: Physical or logical file (likely supplier search support).

- **Workstation File for Subfile Display**
    ```rpg
    frl500d    cf   e             workstn sfile(b1sfl:w_srrn)
    ```
    - Reference to display file with subfile `b1sfl` tracked by relative record number `w_srrn`.

## 3. **Definitions**
- **LDA (Local Data Area)**
    - Used to fetch user-specific or environment info: user, company, etc.
- **Key and Work Variables**
    - Variables for subfile counters, keys, flags (inclusion/exclusion, active/inactive supplier, error flags).
    - Variables relating to screen position, cursor, etc.
- **Parameters**
    - `p_firm`, `p_levr`, `p_navn`: Input/output parameter interface for company, supplier, and name.
- **Constants**
    - For subfile paging (`c_sfil = 9`), etc.

## 4. **Comments on Indicators and Subfile Structure**
- Indicators (10-99) have dedicated meanings for subfile/GUI control.
- List and explanation of subfile-related work fields and the subfiles themselves (`B1SFL`, `B2CTL`, `B2CMD`).

## 5. **Program Flow & Main Logic**

### A. **Main Tag/Control Section**
- **`b2taga` (Main Loop Start):**
    - Write initial command screen.
- **`b2tagb` (Enter Subfile Display Logic):**
    - Calls subroutine to display subfile (`dsp_subfile`).

### B. **Function Key Handling**
- Uses a `SELECT` with various `WHEN` conditions for IBM i function key indicators:
    - F3/F12 (KC/KL): Exit.
    - F5 (KF): Toggle showing inactive suppliers (`*in55`).
    - F10/F11 (10/11): Page forward/backward (calls `crt_subfile` or `bck_subfile`).
    - F9 (KI): Repeat search.
    - Søk (search) and posisjonering.

### C. **Search, Positioning, and Subfile Control**
- If in search mode, subroutine `søk` is called.
- If positioned by alpha, subroutine `posisjoner` is called.
- Otherwise, subfile handling (`subfile`), which reads entries, handles selects, view requests, or repeats.

### D. **Exit Tag**
- Sets LR indicator (`*inlr = *on`) to end the program and returns.

## 6. **Key Subroutines** (All are classic RPG subroutine blocks with `begsr`/`endsr`)

### **forny**  
"Renew" – reposition and refill the subfile based on current key/sort:
- Chains back to correct record if working from within a page.
- Resets or sets keys for the logical files (`rlevl1`, `rlevl2`) for positioning.
- Clears and recreates the subfile.

### **søk**  
"Search" – perform a search with the entered text:
- Calls external program `AS700R` to process search text into up to 5 search strings.
- Resets and refills the subfile with matching entries.

### **posisjoner**  
"Position" – go to a given key (alpha position or supplier number).
- Sets up the key, finds the place in the file, then refreshes the subfile to match that position.

### **subfile**  
Handles subfile paging, record selection, and user interaction:
- Toggles the subfile indicator.
- For each visible subfile record, reads user input and performs actions: select (set output parameter), view (call `xc2bld`), etc.
- If a record is selected, sets output and exits.

### **clr_subfile**  
Clears the subfile and its counters.

### **crt_subfile**  
Creates/fills the subfile with supplier data:
- Can use an SQL cursor for search mode, otherwise reads directly from logical files.
- Applies filters (e.g., active/inactive).
- Fills the subfile for up to `c_sfil` entries (pagesize = 9).
- Manages subfile record numbers, paging, and controls EOF.

### **bck_subfile**  
Handles paging backward in the subfile:
- Uses RPG backward read (`readp`) to move to the previous subfile page.

### **dsp_subfile**  
Manages subfile display, controls indicators for subfile control/format, and does the display/exfmt.

### **xc2bld**  
Calls another program to display more detail for a supplier.

### **\*inzsr** (Initialization Subroutine)  
Called at program start:
- Loads entry parameters.
- Builds key lists for positioning.
- Gets current date.
- Loads company from LDA.
- Initializes the subfile contents.

---

## 7. **General Flow Chart**

1. **Initialize program and subfile.**
2. **Main loop:**
    - Display command screen or subfile.
    - Wait for user input (function key, search, select, etc).
    - Branch accordingly: page, search, re-query, select, exit.
3. **On select/exit:** set return parameters and close.

---

## 8. **SQL Integration**
- Searches use embedded SQL to find suppliers matching given text.
- Only runs when needed (`w_seqe = 'S'`, search mode), otherwise relies on native RPG file I/O.

---

## 9. **Indicator Usage and Subfile Paging**
- Classic IBM RPG indicator variables control screen and subfile behavior (e.g., *in14=clear, *in15=end-of-file, etc).
- Subfile is paginated using counters and constants.

---

## 10. **External Dependencies**
- **AS700R:** Used to parse and split search text.
- **RL502R:** Called to display/view detailed supplier info.

---

## 11. **Conclusion & Onboarding Notes**

- This is a robust, relatively standard RPG program for subfile-based list display and search, with integrated SQL and traditional RPG file I/O.
- **Main tasks:** Search, display, select, and page through supplier records.
- **Indicators:** Crucial for understanding program flow and screen/subfile behavior.
- **Subfile structure:** Central to the program, with well-defined routines for clearing, creating, paging, and displaying.
- **External calls:** Used for input parsing and detail display.

**For onboarding:**  
- Familiarize yourself with subfile logic, indicator handling, and the application’s display files.
- Understand the data model for suppliers in `rlevl1`, `rlevl2`, and `rlsopf`.
- Identify how this program fits into the overall workflow (called from menus, other programs, as a detail window, etc).
- Note: Some business logic and screen layouts will be defined in the referenced display files and external routines.

---

**If you have the display file DDS and external program definitions, reviewing them will help complete the picture.**