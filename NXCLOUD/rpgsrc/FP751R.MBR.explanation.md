# RPG Program FP751R â€“ Overview and Explanation

This RPG program, named `FP751R`, is intended for importing special prices from a price data file in "Nobb" format into various special price registers on IBM i/AS400. It processes by loading (and optionally deleting) special pricing for given rebate categories, customers, or customer projects, based on a work file input.

The code is a traditional (fixed format) ILE RPG program, with clear separation of file specifications, data structures, variables, keys, and logic in mainline and subroutines.

Below is a structured breakdown and explanation:

---

## 1. **Header and Comments**

- **Header options**:  
  `h option(*nodebugio) datedit(*dmy)`
  - `*nodebugio` disables I/O debugging.
  - `datedit(*dmy)` sets default date format (day, month, year).

- **Initial comments describe**:
  - Purpose: Importing special prices for a selected rebate category, customer, or customer project.
  - General workflow: Reads a selected file (must be Nobb price format), creates special prices for the selected key (category/customer/etc.).
  - Maintenance log with changes and enhancements over time.

---

## 2. **File Declarations**

- **Database and Work files**:
  - `flvwpf`: Work file with Nobb price format entries, input only.
  - `vvarl3`, `vvenl2`: Product and unit master files, input only.
  - `fpril3`, `fprilu`, `fprnlu`: Special price files, update-capable.
- `rename()` allows using record formats under new names within the program.

---

## 3. **Data Areas and Data Structures**

- **Local Data Area (LDA)**
  - Used to read the user's ID into `l_user` (positions 911-920).

- **Nobb Price Format Structure**
  - Data structure overlays the work file input line:  
    - `d_list`: Raw line from price file.
    - Various overlays to extract fields: participant number, product number, Nobb number, package code, price, from/to dates, price code, change date.

---

## 4. **Parameter Definitions (from program call)**

- `p_firm`, `p_prgr`, `p_rkat`, `p_kund`, `p_kpro`, `p_slet`  
  - Company number, price group, rebate category, customer, customer project, delete flag.
- These are read in the `*INZSR` initialization subroutine.

---

## 5. **Working Variables & Key Variables**

- Variables for keys and matching (e.g., for chains/reads on DB files).
- Working storage for various intermediate values (units, areas, prices, etc.).

---

## 6. **Constants**

- `c_form = '1'`: Used when calling another program after processing.

---

## 7. **Main Program Logic**

### **Initialization**

- Executes embedded SQL to ensure date format is *ISO for DB operations.

### **Optional Deletion of Existing Special Prices**

- **If `p_slet = 1`**: Existing special price entries are deleted for the specified key.
  - If a rebate category (`p_rkat`) is provided, deletes based on that.
  - Else, deletes for given customer/project key.
  - Iteratively reads, deletes each matching record in `fprilur`, `fpril3r`, and `fprnlur`.

### **Importing New Special Prices**

- Reads each record from the work file (`flvwpfr`).
- For each, calls subroutine `oppdater` to process and update the special prices.

### **Post-Processing**

- Calls program `'FO719C'` to report on materials not loaded to the special price register.
- Ends the program, setting the LR (Last Record) indicator to close files and return.

---

## 8. **Subroutine: `oppdater` (Update/Create Special Prices)**

**Purpose**: For each price entry in the work file, try to create or update up to three special price records (for up to three sale units).

### Steps in `oppdater`:

1. **Load Input Fields**
   - Assigns the input line to the Nobb data structure for overlayed access.

2. **Input Validation**
   - Skips if Nobb number or price is zero (not filled).

3. **Product Existence Check**
   - Looks for logistics product ID via SQL (in `vvlepf`).
   - If not found, looks up product in the master file `vvarl3` by Nobb number.
   - If not found, abort processing this record.

4. **Find Sale Unit**
   - Attempts to get the sales unit for the product using two external programs: `'FO712C'` (by product number), `'FO713C'` (by Nobb number).
   - Skips record if unable to find a valid sales unit.

5. **Read Three Sales Units**
   - Initializes up to three sales units (`w_enh1`, `w_enh2`, `w_enh3`), and corresponding area factors (`w_omr1`, etc.).
   - Reads unit data from `vvenl2` file and fills in the three units (if available).

6. **Sale Unit Crosscheck**
   - Skips record if none of the found sales units matches the one from the input file.

7. **Calculate Prices for Each Sale Unit**
   - Converts the price to all three sales units, using area ratios if necessary.

8. **Create/Update Special Price Records**
   - For each of the three sales units, if available:
     - Prepares a special price record.
     - If one exists: Update with new values, stamp with user/date/time.
     - If not: Write new record.
   - Sets common fields (from parameters/input line).
   - Uses `chain`/`update`/`write` for DB operations.

9. **Delete the input work file record**
   - Removes processed line from the work file.

---

## 9. **Subroutine: `*inzsr` (Initialization)**

- Loads program parameters into local variables.
- Builds keys for file operations:
  - `vvarl3_key`: For product lookup.
  - `fpril3_key`, `fprilu_key`, `fprilu_key2`, `fprnlu_key`: For various special price DB operations.
  - `vvenl2_key`, `vvenl2_key2`: For fetching sales units.

---

## 10. **Key Takeaways**

- **File-driven**: The program is organized around processing file records, maintaining a clean separation of responsibilities.
- **Parameterization**: Behavior is influenced by passed parameters (e.g., company, pricing, customer, delete mode).
- **SQL Integration**: Selectively uses embedded SQL for modern flexibility.
- **Modularity**: Uses subroutines extensively (`oppdater`, `*inzsr`), and external programs for certain tasks (finding unit).
- **Robustness**: Validates existence of keys and necessary data at each step, aborting sub-process as needed.
- **Multi-unit Handling**: Handles up to three sales units for each product/pricing entry.

---

## 11. **Potential Enhancements or Modernization**

- Refactor to use fully free-format RPG for clarity.
- Replace `eval`, `clear`, `time` and fixed-format `C` specs with free-form equivalents.
- Use service programs or procedures rather than subroutines for modular logic.

---

## 12. **Summary Table**

| Section             | Purpose/Action                                              |
|---------------------|------------------------------------------------------------|
| File specs          | Declares physical and logical files (input/output/update)  |
| Data structures     | Defines layout for input records, parameters, keys         |
| Main logic          | Handles deletion (if requested), reads and processes input |
| oppdater subroutine | Creates/updates special price records for up to 3 units    |
| *inzsr subroutine   | Loads parameters, builds keylists for file access          |
| External calls      | Invokes other programs for unit lookup and post-processing |

---

## 13. **Getting Started**

To work with this program:
- Understand the Nobb price format used in the work file.
- Know the database file structures for products, units, and special prices.
- Familiarize yourself with the conventions for key structures and parameter passing in older RPG.
- Check the external programs (`FO712C`, `FO713C`, `FO719C`) as they are integral to complete processing.

---

### **In summary:**
This program is a classic batch loader for special pricing, combining file I/O, SQL, and program calls to handle product/pricing updates efficiently with data integrity and audit. It can be a good candidate for RPG modernization projects or as a template for similar automation tasks.