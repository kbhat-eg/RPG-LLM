# Overview

This RPG source code implements a program named **ASOFAK** designed for printing customer label list ("Kunde distr.liste, utskrift av navnetiketter"). The code is structured into main routines and subroutines to manage data processing and output formatting. Below is an explanation of its key components and flow.

---

# Program Metadata

- **TITLE**: "ASOFAK: Kunde distr.liste, utskrift av navnetiketter" indicates the program's purpose.
- **Program Info**: System `ASOFAK`, program `FH601R`.
- **Description**: Prints customer labels, likely for mailing or delivery purposes.
- **History**: Created in 1999, recompiled in 2006 for tab extension support.

---

# File and Data Definitions

### External Files and Renaming

- Several external files are opened (`if` indicates input files, `o` indicates output).  
- Files such as `fkdil3`, `fkdil4`, `rkunl1`, `fkprl1`, `apospf` are opened with record name aliases.

```rpgle
ffkdil3    if   e           k disk    rename(fkdipfr:fkdil3r)
ffkdil4    if   e           k disk    rename(fkdipfr:fkdil4r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
fapospf    if   e           k disk    rename(apospfr:apospfr)
```

### Printer File

```rpgle
ffh601p    o    e             printer infds(d_infds)
```

- `ffh601p` is a printer file, used for output, with an associated data structure `d_infds` for printer info.

---

# Data Structures and Variables

### Arrays for Customer Data

- Arrays `a_kund`, `a_navn`, `a_adr1`, `a_adr2`, `a_padr` each hold nine entries of 100 characters.  
- These arrays temporarily store customer data (name, address, etc.), for batching labels.

```rpgle
d a_kund          s            100    dim(9) ctdata perrcd(1)
d a_navn          s            100    dim(9) ctdata perrcd(1)
d a_adr1          s            100    dim(9) ctdata perrcd(1)
d a_adr2          s            100    dim(9) ctdata perrcd(1)
d a_padr          s            100    dim(9) ctdata perrcd(1)
```

### Local Data Area (UDA)

- Contains storage for routing info, user info, and file positions.

```rpgle
d                uds
d l_ruti                800    809
d l_alin                856    858  0
d l_wsid                901    910
d l_user                911    920
```

### Parameter and Info Structures

- `d_list`: a parameter data structure with `d_firm`, `d_valg` (choice), `d_ante`, `d_bred`, `d_hoyd`.
- `d_infds`: holds line and page numbers from printer output.

```rpgle
d d_list                        16
d  d_firm                        3  0 overlay(d_list)
d  d_valg                        1    overlay(d_list:4)   (*F or other)
d  d_ante                        1  0 overlay(d_list:5)
d  d_bred                        2  0 overlay(d_list:6)
d  d_hoyd                        2  0 overlay(d_list:8)
```

---

# Main Program Flow

### Initialization and Setup

- The program starts by setting up key fields for reading customer and price list files.
- It uses `setll` (set lower limit) and `reade` to sequentially process records from files `fkdil3`, `fkdil4`, `rkunl1`, `fkprl1`.

### Handling Input Data

- Depending on the input parameter `d_valg` ('F' for last shipment), it reads from either `fkdil3` (price file) or `fkdil4` (price book).
- It loads customer address data accordingly.

### Label Printing Loop

- The main loop reads customer addresses, calls the subroutine `behandling` (processing), which gathers data and formats labels.
- Once the data is prepared, `detalj` subroutine is called for each label to print it.

---

# Subroutines

### `behandling` (Processing)

- Adds customer info to the arrays.
- Increments label counter `w_etik`.
- Fetches customer info (`fhkund`, `fhkpro`) and, if available, retrieves detailed customer info from relevant files.
- Prepares address lines and customer name for label printing.

### `detalj` (Detail Line)

- Concatenates customer data into label lines, ensuring the total fits the label width.
- Checks if current line exceeds page layout height, prints header if needed.
- Outputs the label (`write` operation), then fills the remaining space with blank lines for height expansion.
- Clears arrays after printing to prepare for next batch.

### `*inzsr` (Initialization)

- Sets up key fields for reading files based on the input parameters.
- Transforms the parameter list into usable variables.
- Opens files with proper keys for customer, address, and price data.

---

# Program Termination

- After processing all customer data, the program sets `*inlr = *on` to close all files and clean up.
- Returns control to the calling program.

---

# Summary

This RPG program is designed to generate customer address labels in batches. It reads data from several files, organizes customer info into arrays for batching labels, formats each label with customer details, and handles page layout concerns such as header printing and spacing. It is structured into main routines for setup, data processing, label printing, and cleanup, allowing for flexible batch label generation.