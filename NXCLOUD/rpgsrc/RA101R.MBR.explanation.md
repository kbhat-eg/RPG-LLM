# Program RA101R – Bilagskoder Vedlikehold (Voucher Code Maintenance)

## Overview

This program manages the maintenance of voucher codes ("bilagskoder") within the ASOKON system. It provides a subfile-based user interface for searching, creating, updating, copying, and deleting voucher code records. The program interacts with several logical files for voucher codes and number series, and relies on a set of display files (screens) for user interaction.

The program is structured around a main processing loop with subroutines handling specific operations such as subfile management, record maintenance, and screen interactions. Special attention is given to subfile paging and positioning, validation of number series, and user feedback.

## Key Business Logic and Domain Concepts

- **Voucher Codes (Bilagskoder):** Central to the program. Each code has associated metadata such as description, type, series, debit/credit info, etc.
- **Subfile Paging:** The program uses subfiles for browsing and managing voucher codes, with support for paging, roll-up, and roll-down.
- **Number Series Validation:** Integration with number series (anumlur) to ensure valid series are used for voucher numbers.
- **Record Copy/Delete:** Users can copy or delete voucher code records via dedicated screens.
- **User Feedback:** The program uses message screens and indicators extensively to guide user actions and handle errors.

## File Usage and Relationships

- **RA01L1, RA01L2, RA01LR, RA01LU:** Logical files over the voucher code physical file, used for different access paths (by code, by description, for reading/updating).
- **FANUMLU:** Logical file over the number series, used to validate and increment series numbers.
- **FRA101D:** Display file containing all the screens (subfiles, control, messages, etc.).

## Display Screens

- **B1SFL:** Subfile record format for listing voucher codes.
- **B2CTL:** Subfile control record (header/footer).
- **B2CMD:** Command screen for function keys.
- **C1BLD/C2BLD:** Entry/update/view screens for voucher code details.
- **C1MSG:** Message screen for duplicate key warning.
- **D1WIN/K1WIN:** Windows for delete and copy operations.

## Indicators

- **LR:** End of program.
- **10/11:** Rollup/rolldown (paging).
- **12/13/14/15:** Subfile display/clear/end.
- **21/22:** Cursor/home key.
- **30:** Field protection in view mode.
- **31–79:** Error/warning indicators.
- **80–99:** Work indicators.

## Main Program Flow

### Initialization (`*INZSR`)

- Set up key lists for various access paths.
- Load firm number from LDA.
- Initialize subfile with records positioned at the beginning.

### Main Loop

- **Display command screen (`b2cmd`).**
- **Display subfile (`dsp_subfile`):** Show current page of voucher codes.
- **Function Key Handling:** 
    - Exit (`*INKC`, `*INKL`)
    - Refresh (`*INKE`)
    - Create (`*INKF`)
    - Page up/down (`*IN10`, `*IN11`)
    - Positioning (`*IN21`)
    - Cursor handling (`*IN22`)
- **Positioning:** If search fields are entered, reposition subfile accordingly.
- **Subfile Processing (`subfile`):** Handle user actions on subfile rows (edit, copy, delete, view).

### Subfile Management

- **Clear Subfile (`clr_subfile`):** Clears the subfile and resets counters.
- **Create Subfile (`crt_subfile`):** Loads the next page of records into the subfile.
- **Back Page (`bck_subfile`):** Loads the previous page.
- **Display Subfile (`dsp_subfile`):** Handles display logic and subfile indicators.

### Record Maintenance

- **Create New (`xc1bld`):** Handles entry of a new voucher code. Checks for duplicates, then calls the detail maintenance screen.
- **Edit/View (`xc2bld`):** Loads record details for editing or viewing. Handles validation, number series checks, and updates.
- **Delete (`xd1win`):** Confirms and deletes a voucher code.
- **Copy (`xk1win`):** Allows copying an existing voucher code to a new code, with duplicate checking.

### Number Series Handling

- **Validation:** When a number series is entered, the program validates its existence using `anumlur`.
- **Increment:** If valid, the series counter is incremented.

### Error and Message Handling

- **Duplicate Key (`xc1msg`):** Displays a message if attempting to create a voucher code that already exists.
- **Field Validation:** Various indicators are set for missing or invalid fields, and the user is prompted accordingly.

## Notable Design Decisions and Conventions

- **Subfile Paging Logic:** The program uses explicit counters and indicators to manage paging in the subfile, rather than relying on built-in subfile paging features. This gives precise control over the user experience.
- **Key Lists:** Key lists (`klist`) are used extensively for database access, improving code clarity and maintainability.
- **Indicator Usage:** The program follows a documented convention for indicator usage, separating display logic, error handling, and work variables.
- **Screen Navigation:** All screen transitions and user actions are managed via tags and `goto` statements, which is typical in legacy RPG, but may be unfamiliar to those used to more structured control flow.
- **Business Logic Encapsulation:** Subroutines are used to encapsulate business logic for each operation, making the code modular and easier to follow.

## Integration Points

- **Number Series Program (`RA531R`):** Called to handle selection of number series when editing voucher codes.
- **Logical Files:** The program interacts with multiple logical files for efficient access paths, supporting both code and description-based searches.
- **Local Data Area (LDA):** Used to retrieve user and firm context for the session.

## Special Notes

- **Norwegian Naming:** Many variables, comments, and screens use Norwegian terms (e.g., "bilagskode", "beskrivelse", "vedlikehold"), which are domain-specific.
- **GUI Adaptation:** Some changes are noted as related to GUI adaptation, though the core logic remains subfile-based.

## Summary Table of Key Subroutines

| Subroutine      | Purpose                                         |
|-----------------|-------------------------------------------------|
| `forny`         | Refreshes the subfile after changes             |
| `posisjoner`    | Positions subfile based on search criteria      |
| `subfile`       | Processes user actions on subfile rows          |
| `xc1bld`        | Handles new voucher code entry                  |
| `xc1msg`        | Displays duplicate key warning                  |
| `xc2bld`        | Handles edit/view of voucher code details       |
| `xd1win`        | Handles voucher code deletion                   |
| `xk1win`        | Handles voucher code copying                    |
| `clr_subfile`   | Clears subfile and resets counters              |
| `crt_subfile`   | Loads records into subfile (paging)             |
| `bck_subfile`   | Loads previous page of subfile                  |
| `dsp_subfile`   | Displays subfile with current indicators        |
| `*inzsr`        | Initialization logic                            |

## Summary

This program is a comprehensive, subfile-driven maintenance utility for voucher codes, with robust support for paging, searching, validation, and user feedback. It is tightly integrated with the ASOKON system's file structure and business rules, and follows well-documented conventions for indicator and subroutine usage. New developers should pay particular attention to the subfile management patterns, indicator conventions, and the business logic around number series validation.