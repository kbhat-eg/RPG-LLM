# Documentation for Program LO775R

## Overview

**LO775R** is an RPG program used for generating supplier purchase orders in the EFO/NELFO format. This format is a standardized electronic message structure used in the Norwegian electrical wholesale industry. The program extracts order headers, order lines, and free-text lines from internal order files and transforms them into the EFO/NELFO format, writing the result to an output file.

## Business Context

- **Purpose:** Export purchase orders from the ASLAGR system to suppliers, formatted according to EFO/NELFO specifications.
- **Domain:** Electrical wholesale, Norwegian market.
- **Usage:** Typically called as part of an order processing workflow, receiving order number, suffix, and output filename as parameters.

## Key Features

- **Dynamic Record Construction:** Builds output records dynamically for headers, lines, and text, adhering to maximum field lengths per EFO/NELFO specs.
- **Flexible Item Number Resolution:** Determines the correct item number to use (EAN, supplier number, or NOBB) via database lookups and external program calls.
- **Data Integrity:** Includes error checks and exits gracefully if required data is missing.
- **Separation of Concerns:** Uses subroutines for constructing each record type and for resolving item numbers.

---

## File Definitions and Relationships

| File      | Purpose                                    | Renamed Record Format | Notes                  |
|-----------|--------------------------------------------|----------------------|------------------------|
| afirl1    | Company information (FIRMA)                | afirl1r              | Used for company lookups |
| lstsl1    | Warehouse codes                            | lstsl1r              | Used for warehouse info  |
| lohel1    | Order header                               | lohel1r              | Core order header        |
| lodtl1    | Order line                                 | lodtl1r              | Core order lines         |
| lldilr    | Supplier distribution info                 | lldilrr              | Used for delivery info   |
| vvarl1    | Item master                                | vvarl1r              | Used for item lookups    |
| rlevlr    | Supplier master                            | rlevlrr              | Used for supplier info   |
| lwnepf    | Output EFO/NELFO file                      |                      | Output file              |

All input files are keyed and read as needed. The output file is written sequentially.

---

## Data Structures

- **Output Buffers:**  
  - `d_hrec` (961): Order header record  
  - `d_lrec` (167): Order line record  
  - `d_trec` (32): Free-text line

- **Work Variables:**  
  - Various fields for intermediate values, counters, and flags.
  - Business-specific fields for EFO/NELFO export (e.g., `w_bhcd`, `w_form`, `w_vers`, etc.).

- **Keys:**  
  - Defined for each file as per the business logic. All keys include the company number (`w_firm`).

---

## Main Processing Flow

1. **Initialization (`*inzsr`):**
   - Reads parameters: order number, suffix, and output filename.
   - Sets up all necessary keys and loads company/warehouse data.

2. **Header Processing:**
   - Chains to the order header (`lohel1r`).
   - If found, proceeds to process order lines.

3. **Order Line Processing:**
   - Reads each order line for the order.
   - For each line:
     - If line type is text (`ldltyp = laatty`), builds a text record.
     - Else, builds a line record.
   - Before writing the first line/text, ensures the header record is written.

4. **Record Construction:**
   - **Header:** Uses `bygg_hrec` subroutine, performing lookups for supplier/distribution and formatting all header fields as per EFO/NELFO.
   - **Line:** Uses `bygg_lrec`, resolving item number via `finn_vnr`, formatting line details.
   - **Text:** Uses `bygg_trec`, formatting the free-text line.

5. **Item Number Resolution (`finn_vnr`):**
   - Looks up item in the item master (`vvarl1r`).
   - Preference order:
     1. Supplier item number (`vvlvar`)
     2. EAN number (via external program `VE711R`)
     3. NOBB number (`vvnobb`)
   - Sets marker (`w_vmrk`) indicating which number was used.

6. **Output Writing:**
   - Writes constructed records to the output file (`lwnepfr`).

7. **Termination:**
   - Sets LR indicator and returns.

---

## Subroutines

### `bygg_hrec` - Build Order Header
- Performs lookups for supplier/distribution information.
- Formats all header fields into a semicolon-separated string per EFO/NELFO spec.
- Handles missing data with error flags.

### `bygg_lrec` - Build Order Line
- Calls `finn_vnr` to resolve the correct item number.
- Formats order line fields, including quantity and units.
- Handles unit codes and formats quantities accordingly.

### `bygg_trec` - Build Free-text Line
- Formats free-text from the order line into a text record.

### `finn_vnr` - Find Item Number
- Looks up item in `vvarl1r`.
- Calls external program `VE711R` for EAN lookup if necessary.
- Sets the item number and marker for the line record.

---

## Special Considerations and Conventions

- **Indicator Usage:**  
  - 80-89: Work indicators  
  - 90-99: File indicators (e.g., for CHAIN operations)
  - LR: Program end

- **Field Lengths:**  
  - Output field lengths are strictly enforced to match EFO/NELFO maximums.

- **External Program Call:**  
  - `VE711R` is called to retrieve EAN numbers. This is a standard in the codebase for item number resolution.

- **Commenting and Versioning:**  
  - Header includes change history and business context.
  - Unused or unknown fields are commented out but left in place for future development or documentation.

- **Error Handling:**  
  - If required data is missing, sets `b_feil` and skips further processing for the current record.

---

## Interactions with Other Modules

- **External EAN Lookup (`VE711R`):**  
  - Called to fetch EAN numbers for items when not available directly in the item master.

- **Downstream Consumption:**  
  - The output file (`lwnepfr`) is presumably picked up by another process for transmission to suppliers.

---

## Domain-Specific Notes

- **EFO/NELFO Format:**  
  - The EFO/NELFO record structure is a Norwegian industry standard for electronic ordering.
  - Each record type (header, line, text) has a specific set of fields and maximum lengths.

- **Item Numbering:**  
  - Items may be identified by EAN, supplier part number, or NOBB (Norwegian Building Number), depending on availability and supplier.

- **Organization Numbers:**  
  - Organization numbers are formatted with Norwegian prefixes/suffixes (e.g., "NO", "MVA").

---

## Summary

This program is a key part of the order export process, ensuring that purchase orders are formatted correctly for automated supplier processing. It demonstrates standard patterns in this codebase for file handling, key management, and record construction, with special attention to business rules around item identification and message formatting. 

When onboarding, focus on understanding:
- The EFO/NELFO format requirements,
- The item number resolution logic,
- The conventions for file and key handling,
- The importance of error handling and data integrity in the export process.