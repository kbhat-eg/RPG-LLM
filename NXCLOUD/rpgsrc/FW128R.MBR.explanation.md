# Explanation of the RPG Program (FW128R)

## Overview

This is an IBM ILE RPG (Report Program Generator) source code for a program named **FW128R**, part of the **ASOFAK** system. Its purpose is to update item/products and prices, and to trigger a transfer/start an update process (the term _overføring_ means "transfer" in Norwegian).

The program interacts with display files (`workstn`), receives parameters, prepares a structure for the called transfer program, allows user interaction, and then calls another program (`FW625C`) to handle the transfer.

---

## Main Elements

### File Definition

```rpg
ffw128d    cf   e             workstn
```
- Defines an externally described display file `fw128d` as a workstation file.

---

### Data Structure for Outgoing Parameters

```rpg
d                 ds
d d_list                        96
d  d_firm                        3  0 overlay(d_list)
...
d  d_ltyo                        1  0 overlay(d_list:87)
d  d_oppd                        1  0 overlay(d_list:88)
```

- `d_list` is a 96-byte data structure holding a block of parameters that will be sent to the called (transfer) program.
- Each field (like `d_firm`, `d_otyp`, etc.) overlays a specific position within `d_list`.
- Fields represent company, type, dates, groupings, values, flags, etc.

---

### Stand-alone Variables for Parameters

```rpg
d p_firm          s              3  0
d p_otyp          s              1  0
d p_ldor          s              6  0
...
d p_ltyo          s              1  0
```

- These variables are used to receive the parameters when the program is called, and are copied into the data structure for transmission.

---

## Main Program Logic

### Initialization (*INZSR subroutine)

- Receives parameters via the *ENTRY PLIST.
- Moves these parameters into the corresponding fields in the `d_list` data structure.
- Initializes the display field `b1valg` (presumably a variable used in the display screen).

#### Excerpt:

```rpg
c     *inzsr        begsr
...
c     *entry        plist
c                   parm                    p_firm
...
c                   parm                    p_ltyo
...
c                   eval      d_firm = p_firm
...
c                   eval      d_ltyo = p_ltyo
c                   eval      b1valg = 1
c                   endsr
```

---

### Main Processing Loop

#### Display and User Interaction

```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- Sets a tag (`b1taga`) and displays a screen (format `b1bld`) to the user for input.

#### Function Key Handling

```rpg
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
```
- If function key C or L are pressed (`*INKC` or `*INKL`), skip to program end.

#### Prepare Data for Transfer

```rpg
c                   eval      d_oppd = b1valg
```
- Sets a field in the outgoing structure based on display input (`b1valg`).

#### Call the Transfer Program

```rpg
c                   call      'FW625C'
c                   parm                    d_list
```
- Calls program `FW625C`, passing the full block (`d_list`) of parameters.

---

### Program End (`avslutt` tag)

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Marks the program for end-of-job cleanup (`*INLR = *ON`) and exits.

---

## Summary of Flow

1. **Initialization**: Receives and stores input parameters in a structure for use in the session.
2. **Display**: Presents a screen to the user for possible updates.
3. **User Input & Processing**:
    - If the user requests exit with function keys, the program ends.
    - Otherwise, it captures the user's choices and attaches them to the outgoing data structure.
4. **Trigger Transfer**: Calls the transfer/update program and passes all parameters in a single block.
5. **End**: Closes out the program.

---

## Notable Style/Language Points

- **Overlay**: The use of `overlay()` on subfields allows tightly packed parameter passing—efficient for inter-program calls.
- **Norwegian Comments**: The comments and some variable names are in Norwegian, so terms like `oppdatering` (updating), `overføring` (transfer), and various `grp` ("group") abbreviations refer to business logic from the context.
- **6.30 Markings**: Comments like `6.30` indicate version/maintenance history, e.g., when fields were expanded from 15 to 20 characters.

---

## Onboarding Tips

- **Display File**: Understanding the screens and fields defined in `fw128d` will help clarify user interactions.
- **`FW625C`**: To see the effect of this program, review `FW625C` for how it uses the passed parameter block.
- **Field Mapping**: The mapping between the parameter structure and the fields is central to understanding what information is handed over for transfer.
- **Extension**: Adding more fields for future needs typically involves extending the data structure and updating both programs (caller and callee).

---

## In Summary

This program is an interactive wrapper that gathers parameters, allows for some user modification or confirmation on a display, and then passes all relevant data to a lower-level "worker" program to perform the actual update/transfer of item/product and price data in the ASOFAK system.