# MC110R Program Documentation

## Overview

**Program:** MC110R  
**System:** ASLOGI  
**Purpose:** Maintenance of replacement items ("Erstatningsvare, vedlikehold")  
**Business Domain:** Inventory/Product management, specifically handling relationships between products and their replacements in the system.

This program provides a maintenance interface for managing "replacement item" relationships. It enables users to create, update, view, and delete links between an original product and its replacement(s).

---

## Core Concepts

### Business Logic

- **Replacement Relationships:** The program maintains a mapping between old (original) items and new (replacement) items. It enforces rules to prevent circular or duplicate relationships.
- **Inheritance of ABC Codes:** When a new item replaces an old one, certain codes (e.g., ABC classification) may be inherited if not already set.
- **Warehouse Specificity:** As of version 7.03, replacement relationships can be limited to specific warehouses ("lager").
- **Access Control:** Some fields and actions are only available if the user has access to the BM module, as checked via a call to AX700R.

### User Interface

- **Subfile Display:** The main interface is a subfile showing existing replacement relationships, with options to add, edit, copy, or delete entries.
- **Screen Images:** The program uses several display formats (DDS):
  - **B1SFL:** Subfile record
  - **B2CTL:** Subfile control record
  - **C1BLD:** Entry screen for new relationships
  - **C2BLD:** Edit/view screen for relationships
  - **D1WIN/K1WIN/M1WIN:** Windows for delete/copy/merge operations

### Data Model

- **Physical Files:** The program interacts with several files, most notably:
  - `VVERPFR` (replacement relationships, multiple logical views)
  - `VVARPFR` (item master)
  - `VLAGPFR` (warehouse/item relationships)
  - `VVE2PFR` (side register for warehouse-specific relationships)
  - `RA10PFR` (warehouse master)
- **Key Structures:** Multiple logical files (`vverl1`, `vverl2`, etc.) provide different access paths (by new item, by old item, by text, etc.).

---

## Program Structure

### File Declarations

- Multiple logical and update-capable files are declared for efficient access and update of relationships, item, and warehouse data.
- The subfile (B1SFL) is used for displaying and updating the relationship list.

### Data Structures

- **Local Data Area (LDA):** Used to retrieve user and company info at startup.
- **Display Feedback:** Used for subfile positioning and cursor placement.

### Indicator Usage

- Indicators (10-99) are used for screen control, error display, and working flags. Comments at the top explain the convention.

---

## Main Processing Flow

### Initialization (`*INZSR`)

- Loads user and company info from LDA.
- Determines access level to BM module via `AX700R`.
- Positions database to start of replacement relationships and populates the subfile.

### Main Loop

- Displays the subfile and processes user function keys (add, edit, copy, delete, scroll, position, etc.).
- Handles subfile paging and positioning based on user input.

### Subfile Management

- **`clr_subfile`**: Clears the subfile for a fresh load.
- **`crt_subfile`**: Reads and writes records into the subfile, handling paging.
- **`bck_subfile`**: Handles paging backward in the subfile.
- **`dsp_subfile`**: Displays the subfile, managing cursor and page positioning.

### Relationship Maintenance

- **Add (`xc1bld`)**: Validates new relationship, ensures business rules (no circular or duplicate relationships), and invokes edit screen.
- **Edit/View (`xc2bld`)**: Loads data for the selected relationship, enforces business rules (date logic, field validations), and updates or creates records as needed.
- **Copy (`xk1win`)**: Allows copying an existing relationship to a new one, with validation.
- **Delete (`xd1win`)**: Deletes the selected relationship from both the primary and side register files.

### Business Rule Enforcement

- **No duplicate or circular relationships:** Several checks ensure that a product cannot simultaneously be both a replacement and be replaced, and that no duplicate relationships are created.
- **Date logic:** The last purchase date must be after the first purchase date.
- **Warehouse validation:** If a warehouse is specified, it must exist in the warehouse master.
- **BM Module Access:** Certain fields are only enabled if the user has access to the BM module.

### ABC Code Inheritance (`upd_kabc`)

- When a new item is linked as a replacement, if it lacks an ABC code, it inherits it from the old item.
- Also updates the warehouse-level ABC code if necessary.

### External Program Calls

- **`VV500R`**: Item lookup/validation (used in inquiry screens).
- **`RA510R`**: Warehouse lookup/validation.
- **`AX700R`**: BM module access check.

---

## Notable Design Decisions & Patterns

- **Logical File Usage:** Multiple logical files for the same physical data allow efficient access and business rule enforcement from different perspectives (by new item, by old item, by text, etc.).
- **Subfile Paging:** Manual management of subfile record numbers and pages for flexible user navigation.
- **Indicator Pattern:** Heavy use of indicators for screen and error management, with clear conventions.
- **Versioning and Change Log:** The source contains a detailed change log, with version numbers and comments for each significant business or technical change.
- **Side Register (`VVE2PFR`):** Introduced for warehouse-specific replacement relationships.

---

## Module & Data Relationships

- **Replacement Relationships:** Primary data is in `VVERPFR` (logical files: `vverl1`, `vverl2`, etc.).
- **Item Master:** `VVARPFR` is used for validating items and retrieving descriptions and ABC codes.
- **Warehouse Master:** `RA10PFR` is used for validating warehouse codes.
- **Warehouse-Item Relationship:** `VLAGPFR` is used for warehouse-specific ABC code inheritance.
- **BM Module Integration:** Access and field enablement are checked via `AX700R`.

---

## Business Rules & Validations

- **No item can be both a replacement and be replaced by another item at the same time.**
- **No duplicate relationships:** A new item can't already be a replacement for another, and vice versa.
- **Date checks:** The last purchase date must be after the first purchase date.
- **Warehouse validation:** Only valid warehouses can be specified.
- **ABC code inheritance:** If the new item lacks an ABC code, it is inherited from the replaced item (both at item and warehouse level).
- **BM module access:** Some fields are hidden or set to zero if the user lacks BM module access.

---

## Error Handling & Messaging

- **Error indicators (31-41):** Used to trigger error messages or highlight invalid fields on the display.
- **Informational windows:** Shown when attempting to create a duplicate or invalid relationship.
- **ABC code update notification:** User is informed if ABC code inheritance occurs.

---

## Summary Table: Key Subroutines

| Subroutine    | Purpose                                                                                 |
|---------------|-----------------------------------------------------------------------------------------|
| `forny`       | Refreshes the subfile based on current positioning                                      |
| `posisjoner`  | Positions subfile to a specific item, old item, or text                                 |
| `subfile`     | Main subfile processing loop (edit, copy, delete, view)                                 |
| `xc1bld`      | Handles the entry of a new replacement relationship                                     |
| `xc2bld`      | Handles edit/view of a replacement relationship                                         |
| `xd1win`      | Handles deletion of a relationship                                                      |
| `xk1win`      | Handles copying a relationship                                                          |
| `xm1win`      | Handles merging/deleting old links when a new link is created                           |
| `clr_subfile` | Clears the subfile                                                                      |
| `crt_subfile` | Loads subfile records                                                                   |
| `bck_subfile` | Handles subfile page back                                                               |
| `dsp_subfile` | Displays the subfile                                                                    |
| `sp√∏rring`    | Handles item and warehouse lookups via external programs                                |
| `upd_kabc`    | Handles inheritance of ABC code from old to new item (and at warehouse level)           |
| `*INZSR`      | Initialization: loads LDA, sets up keys, checks access, fills initial subfile           |

---

## Version History Highlights

- **5.60:** ABC code inheritance introduced.
- **6.10:** Added tracking information (audit fields).
- **6.30:** Expanded with fields for BM package.
- **6.31:** Updates to VVAR/VLAG trigger program, change flags required.
- **6.32:** Enforced no duplicate/circular relationships.
- **6.33:** Date validation logic improved.
- **6.34:** BM module access check added.
- **7.01:** Added UNLOCK to VVARLU.
- **7.02:** Logic for unset end date (0 = not set).
- **7.03:** Warehouse-specific relationships, warehouse validation.

---

## Integration Points

- **External Programs:** `VV500R` (item lookup), `RA510R` (warehouse lookup), `AX700R` (access check).
- **Triggered Updates:** Changes to replacement relationships can activate triggers in the item and warehouse master files.
- **BM Module:** Field access and editability are controlled based on module access.

---

## Non-Obvious Conventions & Patterns

- **Indicator 40:** Used to represent BM module access (set/off).
- **Field Naming:** Prefixes like `c1`, `c2`, `b1`, etc., correspond to screen images and their associated fields.
- **Side Register (`VVE2PFR`):** Used for warehouse-limited relationships, with logic to keep this in sync with the main relationship file.
- **ABC Code Inheritance:** Only occurs if the new item lacks the code, and is applied at both item and warehouse levels.

---

## Key Takeaways for New Developers

- **Understand the business rules:** Preventing duplicates, enforcing one-way relationships, and maintaining data integrity are central.
- **Familiarize with the subfile navigation and paging logic.**
- **Be aware of the BM module access logic:** Some fields are only available if the user has access.
- **Review the indicator usage and screen management patterns.**
- **Pay attention to the integration with external programs for lookups and access checks.**
- **Maintain consistency between main and side register files when relationships are added, changed, or deleted.**

---

For further details, consult the in-code comments, especially around business logic and error handling, and refer to the referenced physical/logical file layouts for field definitions.