# Documentation: RF406R – Company Data Migration / File Cleanup

## Overview

**Program:** RF406R  
**System:** ASOKON  
**Purpose:**  
This program is designed to migrate (move) all records associated with a specific company (firm) from a set of primary (L1) files to corresponding "cleanup" (LU) files. This is part of a company data migration, archiving, or cleanup operation within the ASOKON system.

The process ensures that all relevant records for the selected company are copied, with certain fields (such as tracking/audit fields) updated as appropriate. The original files remain untouched; this is a copy operation, not a delete/move.

## Key Concepts

- **Company/Firm Migration:** All records for a given company (identified by `w_firm`) are processed.
- **File Pairs:** For each logical file (e.g., RFOSL1), there is a corresponding output/cleanup file (e.g., RFOSLU).
- **Audit Fields:** For select files, audit/tracking fields such as user, date, and time are updated during the copy.
- **Batch Processing:** Each file is read sequentially for the selected company, and records are written to the LU file.
- **Keyed Access:** All files are accessed via keyed lists, with the company number as the key.

## Structure

### File Declarations

- **Input Files:**  
  Files ending with `L1` or similar (e.g., `rfobl1`, `rforl1`, `rfosl1`, etc.) are input files.  
  These are read using a key (typically the company number).
- **Output Files:**  
  Files ending with `LU` (e.g., `rfoblur`, `rforlur`, etc.) are output/cleanup files.  
  These receive the migrated data.

- **File Renaming:**  
  Each file is renamed to a local record format to avoid naming conflicts.

### Data Definitions

- **l_user:** User ID (from input parameter, positions 911–920).
- **l_firm:** Company number (from input parameter, positions 944–946).
- **l_navn:** Company name (positions 951–980, not used in logic).
- **w_firm:** Local variable holding the company number for processing.

### Initialization

- **Entry Parameters:**  
  The program receives `w_firm` as an entry parameter, which is used as the company key.
- **Key Lists:**  
  Each file pair has a key list (`klist`) with the company number as the key field.

### Main Processing Logic

For each file pair:

1. **Set Key:**  
   Use `SETLL` to position to the first record for the company.
2. **Read Loop:**  
   Use `READE` to read records matching the company.
3. **Copy and Update:**  
   - Copy the record to the output file.
   - For selected files (see below), update audit fields (date, time, user, program).
4. **Repeat:**  
   Continue until all matching records are processed.

### Audit/Tracking Fields

For certain files (as of version 6.10 and later), additional tracking fields are updated:

- **User fields:** e.g., `rfeusr`, `rfousr`, etc., set to `l_user`.
- **Date/time fields:** e.g., `rfedat`, `rfetim`, etc., set to current date/time via `TIME`.
- **Program fields:** e.g., `rkepgm`, set to program name (`RF406R`).
- **Additional fields in later versions:** e.g., `rk2dpt`, `rl2dpt`.

The fields and files updated are dictated by business requirements for auditability and traceability.

### End of Program

- After all file pairs are processed, the program sets the LR indicator (`*INLR = *ON`) and returns.

## Business/Domain-Specific Logic

- **Company-Centric:**  
  The migration is always performed for a single company at a time, as identified by the input parameter.
- **File Coverage:**  
  The files cover a broad spectrum of accounting and business data, including:
  - Budget distributions
  - Distribution parameters and balances
  - Chart of accounts
  - General ledger balances and postings
  - Draft blocks
  - Customer and supplier data, special agreements, postings, and search texts
  - Result reports and their headings
  - Collection (inkasso) cases and static data
  - General ledger summary postings

- **Version Control:**  
  Comments indicate changes per version, e.g., addition of tracking fields (V6.10), changes in file access (V5.40).

- **No Deletion:**  
  The original files are not altered or cleared. This is strictly a copy operation.

## Design Decisions and Conventions

- **Explicit File Pairing:**  
  Each logical file has a corresponding output file, and all are processed in a uniform way.
- **Hardcoded Audit Logic:**  
  Rather than using a generic copy routine, audit field updates are hardcoded per file, in line with domain and regulatory requirements.
- **Key List Usage:**  
  All file access is via keyed lists, using the company number as the key. This ensures only relevant records are processed.
- **Legacy RPG III/IV Style:**  
  The code uses fixed-format RPG and follows conventions typical of older AS/400 RPG codebases.

## Interactions with Other Modules

- **Data Integration:**  
  The program interacts only with physical/logical files. There are no external APIs or subprogram calls.
- **Downstream Dependencies:**  
  The output/cleanup files may be used by subsequent archiving, reporting, or company removal processes.

## Notable Patterns

- **Migration Template:**  
  The code follows a repeatable template for each file pair: set key, read, update fields, write, repeat.
- **Conditional Logic:**  
  For certain files and versions, additional fields are updated (guarded by version comments).
- **No Error Handling:**  
  The code assumes all file operations succeed; there is no explicit error handling.

## Summary Table: File Pairs and Purpose

| Input File   | Output File   | Business Purpose                       | Audit Fields Updated? |
|--------------|---------------|----------------------------------------|----------------------|
| rfobl1       | rfoblur       | Budget distribution                    | No                   |
| rforl1       | rforlur       | Distribution parameters                | Yes                  |
| rfosl1       | rfoslur       | Distribution balances                  | No                   |
| rhovl1       | rhovlur       | Chart of accounts                      | Yes                  |
| rhsal1       | rhsalur       | GL balances                            | Yes                  |
| rhtrl1       | rhtrlur       | GL postings                            | Yes                  |
| rklal1       | rklalur       | Draft block                            | Yes                  |
| rksal1       | rksalur       | Customer special agreement             | Yes                  |
| rksol1       | rksolur       | Customer search text                   | No                   |
| rktrl1       | rktrlur       | Customer postings                      | Yes                  |
| rkunl1       | rkunlur       | Customer master                        | Yes                  |
| rlbapf       | rlbalur       | Supplier bank                          | Yes                  |
| rlsol1       | rlsolur       | Supplier search text                   | No                   |
| rltrl1       | rltrlur       | Supplier postings                      | Yes                  |
| rlevl1       | rlevlur       | Supplier master                        | Yes                  |
| rrf0l1       | rrf0lur       | Result report heading                  | No                   |
| rrf5l1       | rrf5lur       | Result report                          | No                   |
| rrf8l1       | rrf8lur       | Result report                          | No                   |
| rrf9l1       | rrf9lur       | Result report balances                 | No                   |
| rzuml1       | rzumlur       | GL summary postings                    | Yes                  |
| rca0l1       | rca0lur       | Collection static data                 | No                   |
| rcnfl1       | rcnflur       | Collection case register               | No                   |

## Version/Change Log Highlights

- **V5.40:** Switched to reading `RKLAL1` instead of `RKLAPF`.
- **V6.10:** Added tracking fields for select files.
- **V6.11:** Adjusted tracking functionality, including program name and department date fields.

## Onboarding Notes

- **Extending Migration:**  
  To add new files to the migration, follow the existing pattern: declare both files, add keyed lists, and implement the copy loop.
- **Audit Fields:**  
  Ensure audit/tracking fields are updated as per business and regulatory requirements.
- **Testing:**  
  Test with a variety of company numbers and ensure all relevant records are migrated and audit fields are set correctly.

## Conclusion

RF406R is a robust, template-driven migration utility for company-specific data in the ASOKON system. It is designed for maintainability and auditability, with explicit handling for each file and clear separation of concerns. All logic is company-centric, and the code is easily extensible for future file additions or audit requirements.