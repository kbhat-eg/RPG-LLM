# Program Documentation: re142R – Visma Payroll Integration

## Overview

**Program Name:** `re142R`  
**System:** ASOKON  
**Purpose:**  
This program is part of the ASOKON system and is responsible for integrating data from Visma Payroll (and potentially H&L payroll exports) into the ASOKON database. Specifically, it reads a flat file export from Visma (or H&L), parses the data, applies business logic, and writes the processed records into an output database file (`reutpf`). Each record is enriched with client-specific information and normalized for downstream processing.

## High-Level Flow

1. **Initialization:**  
   The program receives initialization parameters (likely client/firm identifiers) and sets up internal fields accordingly.

2. **File Processing:**  
   It reads each record from the input file (`revipf`), parses the record into its constituent fields, performs business logic transformations, and writes the result to the output file (`reutpf`).

3. **Record Transformation:**  
   Each input record is mapped to a structured data layout, with overlays used to extract subfields. Business rules are applied to normalize and conditionally transform values before output.

---

## Key Components and Data Flow

### Files

- **revipf**: Input file (Visma/H&L export), keyed, disk-resident.
- **reutpf**: Output file, keyed, disk-resident, written with processed records.

### Standalone Fields

- **p_flgr, p_firmx**: Program parameters, likely representing client or firm group and firm code.
- **w_firm**: Working variable for firm, initialized from `p_firmx`.

### Data Structures

#### Input Record Layout (`d_inpu`)

- **256-byte character field** representing a flat-file export line.
- **Overlays** extract specific fields:
    - `d_kont`/`d_kontn`: Account number.
    - `d_mvak`: VAT code.
    - `d_avde`/`d_avden`: Department code.
    - `d_pros`: Project code.
    - `d_spes`/`d_spesn`: Carrier code (cost center or similar).
    - `d_bdat`, `d_bdag`, `d_bmnd`, `d_baar`: Posting date (with components).
    - `d_ants`, `d_sats`, `d_sign`, `d_bel`: Amounts, sign, and value fields.

#### Bilagsdato (Voucher Date) Structure

- Used to extract year, month, and day components for posting date.

---

## Main Processing Loop

1. **Initialization (`*INZSR`):**
    - Receives `p_flgr` and `p_firmx` as parameters.
    - Sets up working variable `w_firm`.

2. **File Read Loop:**
    - Reads each record from `revipf`.
    - For each record:
        - Loads the raw input into `d_inpu`.
        - Calls subroutine `oppr_lpos` to process and write the record.
    - Continues until end-of-file.

3. **Program Termination:**
    - Sets LR indicator to *ON, ending the program.

---

## Subroutine: `oppr_lpos` (Process Payroll Posting)

This is the core logic for transforming and writing each record.

### Steps

1. **Clear Output Record Buffer:**  
   Ensures no residual data from previous processing.

2. **Field Normalization:**
    - **Department, Project, Carrier Codes:**  
      Spaces replaced with zeros for normalization (`%xlate(' ':'0':field)`).
      - Project normalization is commented out, indicating possible business rule changes.
    - **Special Handling:**  
      - There are commented-out sections for activity code (`d_akt`), indicating prior logic for handling "no activity" cases.

3. **Field Mapping:**
    - Maps normalized and parsed fields to output record structure:
        - `reflgr`, `refirm`: From program parameters.
        - `rekont`: Account number.
        - `remvak`: Hardcoded to '0' (VAT code logic may be handled elsewhere).
        - `reavde`: Department.
        - `repros`: Project (set to blank if value is '     0').
        - `respes`: Carrier.
        - `remngd`: Set to 0 (possibly a placeholder for amount/quantity).
        - `rerper`, `reraar`: Posting month and year.
        - `rebdat`: Full posting date.
        - `rebel�`: Amount, with sign handling.

4. **Amount Handling:**
    - If `d_sign` is '-', the amount is negated using `z-sub`.
    - Otherwise, the amount is used as-is.

5. **Output Record Write:**
    - Only writes the record if the amount is non-zero (`rebel� <> 0`).

---

## Business/Domain-Specific Logic

- **Field Normalization:**  
  Department, project, and carrier codes are normalized by replacing spaces with zeros. This ensures consistent downstream processing and aligns with ASOKON's master data requirements.

- **Project Code Zero Handling:**  
  If the project code is all zeros ('     0'), it is set to blank in the output. This likely reflects a business rule where a zero project code is considered as "no project".

- **Amount Sign Logic:**  
  The sign field is explicitly checked, and the amount is negated if necessary, ensuring correct debit/credit representation in the output.

- **Legacy/Commented Logic:**  
  There are several commented lines related to activity codes and field translations. These may reflect prior integration requirements with H&L exports or changes in how free fields are handled (see change note 8.01).

---

## Design Patterns and Conventions

- **Overlay Data Structures:**  
  Heavily used to parse fixed-position fields from flat-file exports, a common pattern in legacy integration.

- **Parameterization:**  
  The program is parameter-driven, supporting multi-client or multi-firm processing.

- **Conditional Output:**  
  Only writes records with non-zero amounts, reducing noise and aligning with accounting best practices.

- **Change Management:**  
  The header includes a detailed change log, and commented code is retained for context, aiding maintainability and traceability.

---

## Interactions with Other Modules

- **Input/Output Files:**  
  The program is likely called as part of a batch integration job, either standalone or from a controlling process that manages file handoff between Visma Payroll (or H&L) and ASOKON's accounting modules.

- **Downstream Consumption:**  
  The output file (`reutpf`) is structured for further processing within ASOKON, possibly for posting to the general ledger or for reporting.

---

## Notable Version/Change Notes

- **R8.00 (231121):** Initial version for Visma integration.
- **R8.00 (130922):** Changed "free fields" to department, project, and carrier, reflecting a shift in business requirements for field mapping.

---

## Summary

This program is a robust, parameter-driven integration utility designed to transform payroll export data from Visma (and potentially H&L) into a normalized ASOKON database format. It enforces business rules for field normalization, handles sign and value logic, and ensures only relevant records are processed. The codebase reflects careful change management and is structured for maintainability and adaptability to evolving business needs.