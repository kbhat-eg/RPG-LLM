# Explanation of RPG Source Code: LO802R (Varemottak, linjebehandling)

This source code is a classic IBM ILE RPG application for handling goods receipt (varemottak) and line processing in a warehouse/order environment. It is a large, business-critical transaction program interacting with numerous database files and handling subfiles (work-with lists) on the display. The program contains many enhancements over the years and is written in a mixture of fixed-format and free-format RPG, with comments in Norwegian.

Below, I explain the key sections and logic of the program to help new developers understand its structure and responsibilities.

---

## 1. **Control and File Specifications**

### - Header Specification (`H spec`)
```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debug for IO operations
- Sets date format to day-month-year

### - File Declarations (`F spec`)
Many files declared, most as `DISK` (database files), including:
- `lohelr`, `lohelu` – Bestilling (Purchase Order) Header/Update
- `lodtl1`, `lodtlr`, `lodtlu`, `lodtlv` – Bestillingslinjer (Order lines, various access paths)
- `rlevl1` – Supplier
- `vvarl1`, `vvarl3`, `vvarl4` – Item master, by own item number, NOBB, supplier item number
- `lstsl1`, `fstsl1` – Status codes
- `lwvalr`, `lwvalu` – Work register (for input/updates)
- Plus many others for related info (SMS, logging, etc.)

The `WORKSTN` file (workstation) is for display, with subfile `b1sfl`.

---

## 2. **Data Structures and Variables**

- **Parameter Block** (`d_prec`): Used for passing inbound parameters (e.g., firm, number, suffix, dates, warehouse, etc.).
- **LDA (Local Data Area)**: Used to retrieve user/session info.
- **Feedback Data Structure (`dspfbk`)**: For display feedback like cursor location.
- **Loads of Local Variables** for keys, working fields (dates, numbers, flags, text, etc.), subfile/page handling variables (`w_stel`, `w_spge`, `w_srrn`, etc.), status indicators, and flags for controlling flow.
- **Flags for SMS, error, rest handling, etc.**

---

## 3. **Indicator Usage**

The comments explain standard indicator usage:
- `LR`: End program
- `10-21, 22, 30, 31-99`: Subfile, error, and working indicators

---

## 4. **Initialization and SQL Environment**

- RPG `*inzsr` subroutine initializes the program
- Sets up keylists for all files and moves parameter/LDA data to working variables
- Makes authority check for BM module
- Calls an external program for configuration switches (gift card, external flow control)

---

## 5. **Main Program Logic**

### **A. Start and Data Load**
- Reads selected order (bestilling) and supplier; exits if not found.
- Calls subroutine to check if the order is locked (sperret). If so, ends.
- Calls another routine to physically lock the order for update.
- Prepares data for entry screens.

### **B. Subfile Handling**
- Positions on the order line file and fills up the subfile (list of lines displayed).
- Handles correction of lines input by radio terminal (rest quantities corrections).
- Subfile operations for browse/edit (paging, updating, back page, refresh).

### **C. Main Display Loop**
- Writes initial display records, enters a loop to handle function keys
- Key handling includes:
    - Exit/cancel
    - Refresh (`forny`)
    - Add new line (calls `xc1win`)
    - End/complete (calls `xd8win`)
    - Toggle display of deviations (`b_avik`)
    - Show log (calls `vis_logg`)
    - Subfile navigation (page up/down)
    - Home/cursor positioning

### **D. Subfile Record Processing (`subfile`)**
- Reads subfile, checks for selected/edited lines, and calls edit routines as appropriate.

---

## 6. **Line Edit and Entry Subroutines**

### **`xc1win` (Edit/Add New Line via C1WIN)**
- Clears inputs, sets defaults, shows entry window for scanning/item entry.
- Depending on input, looks up item by EAN, NOBB, or supplier item number.
- Calls `finn_vare` and `finn_linje` to resolve item/line.

### **`xc2win` (Edit Existing Line via C2WIN)**
- Loads line data, checks for substitutes (erstatningsvare), reads item and price info, shows edit window.
- Validates entry, updates work register (`lwvalur`), handles unit conversion if needed.
- Marks line for update in subfile.

---

## 7. **Data Queries and Calculations**

- **Item Lookup (`finn_vare`)**: Tries EAN, then NOBB, then supplier number, else uses manual input as item code.
- **Line Lookup (`finn_linje`)**: Finds the line number for an item.
- **Write Picking and Label Files (`skriv_plukk`)**: Creates picking records, updates work register, triggers label and SMS if appropriate.
- **Read Item (`les_vare`)** and **Read Price (`les_pris`)**: Retrieves item and price, including tax calculations.

---

## 8. **Supporting Functions**

- **Subfile Management**: Filling (`crt_subfile`), clearing (`clr_subfile`), paging (`bck_subfile`).
- **Unit Conversion**: If entered unit is different than ordered, runs conversion (`omr_enhet`).
- **SMS Handling**: Checks if SMS should be sent, finds mobile numbers, sets up and sends message (`sjekk_sms`, `finn_mobnr`, `send_sms`).

---

## 9. **Additional Logic**

- **Substitute Item Checking (`sjk_erst`)**: Verifies if the current item is replaced by another.
- **Locking/Unlocking Orders**: Prevents concurrent edits.
- **Status and Codes Lookup**: Various supporting queries for order status codes, etc.
- **External Program Calls**: For price group lookup, SMS, transport request, etc.

---

## 10. **Handling of Special Scenarios**

- Handles radio-terminal (handheld scanner) corrections.
- Supports external flow control (transport requests).
- Supports Newlook screen-scraping quirks (removal of forbidden characters).

---

## 11. **Key Data Flow**

1. Program called with parameters (order to process).
2. Loads order header and supplier, locks order.
3. Loads order lines, fills work subfile for display.
4. User can browse/edit lines, add new lines, correct quantities, print labels, etc.
5. On completion, updates records, prints labels and pick lists, sends SMS if applicable.
6. Handles paging, validation, unit conversion, and substitute item logic.

---

## 12. **Key Enhancements and Comments**

- Extensive version history in comments (each change, purpose, and developer documented).
- SMS support for customer/seller notification.
- Handling for substitute/replacement items.
- Support for different label types and new item numbering schemes.
- Extended to work with external transport (flow) systems.
- Robust subfile handling for large sets of order lines.

---

## 13. **Onboarding Advice**

- **Know the Database**: Familiarize yourself with the physical files (LOHEPF, LODTPF, VVARPF, etc.).
- **Understand Subfile Programming**: Much of the logic is around subfile paging, edit, and refresh cycles.
- **Review External Programs**: Many routines are supported by or rely on external RPG programs (e.g., for SMS, price, conversion, etc.).
- **Indicator Usage**: Classic RPG uses numbered indicators for control flow—see the comment block for the mapping.
- **Business Flow**: This program is central in goods receipt processes—use test environments and real scenarios to follow the flow.
- **Norwegian Terms**: Some variables and comments are in Norwegian. Get comfortable with business vocabulary (bestilling, varemottak, etikett, etc.).

---

## 14. **Summary Table of Key Subroutines**

| Subroutine       | Purpose                                           |
|------------------|---------------------------------------------------|
| forny           | Refresh/renew subfile view/data                    |
| subfile         | Process user edits in subfile list                 |
| xc1win          | Add new order line (window)                        |
| xc2win          | Edit order line (window)                           |
| xb13win         | Show status code window                            |
| xd1win          | Handle completion/finalization (window)            |
| xd8win          | Quick registration for all lines                   |
| clr_subfile     | Clear subfile before refill                        |
| crt_subfile     | Populate subfile with lines                        |
| bck_subfile     | Page backwards in subfile                          |
| dsp_subfile     | Manage display transitions for subfile             |
| sjekk_lager     | Check warehouse validity                           |
| sjekk_selger    | Check/validate buyer/seller                        |
| etikett         | Set label text by type                             |
| finn_vare       | Lookup item by EAN, NOBB, supplier number          |
| finn_linje      | Find order line for item                           |
| skriv_plukk     | Write picking lines and labels                     |
| les_vare        | Read item master info                              |
| les_pris        | Retrieve item price and calculate tax              |
| velg_etikett    | Select label type                                  |
| sjekk_sperr     | Check if order is locked                           |
| best_sperr      | Lock the order for update                          |
| hent_prisgr     | Get price group for item/location                  |
| upd_htlines     | Update radio terminal input lines                   |
| spørring        | Handle windowed lookup/selection                   |
| omr_enhet       | Perform unit conversion                            |
| vis_logg        | Show log of order/line changes                     |
| sjekk_sms       | Check if customer/seller should get SMS            |
| send_sms        | Prepare and send SMS notifications                 |
| sjk_erst        | Check for substitute item                          |
| sjk_fors        | Check if shipping method triggers SMS              |
| finn_mobnr      | Find mobile number for SMS                         |
| newlo_vask      | Remove Newlook-unsafe characters                   |

---

## 15. **Key Points for Troubleshooting**

- Check `%found` after all database operations; processing usually aborts or skips if not found.
- Always watch flags and indicators—incorrect settings may cause user interface oddities or data integrity issues.
- When adding fields/files, update key lists and parameter blocks accordingly.
- For issues with external systems (SMS, flow control), check communication with those programs first.

---

**In summary**, this is a mature, complex, and robust inventory/order line entry program—central in a Norwegian business system. It leverages many RPG idioms for subfile and batch processing, with modern additions like SMS, label types, and external integrations. Understanding its data flow, indicator usage, and subfile logic is key to working effectively with it.