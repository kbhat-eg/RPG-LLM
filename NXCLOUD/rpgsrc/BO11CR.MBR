     H/TITLE  ASSHOP: Arbeide med kundeopplysninger
     H DATEDIT(*DMY)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASSHOP
      * Program . . . . : BO11CR
      * Beskrivelse . . : Arbeide med kundeopplysninger
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      * R3.10 030500 AMD  Lagt inn visning av mobilnummer
3.11  * R3.11 200900 AMD  Lagt inn varsling på om kundeprosjekt finnes
3.31  * R3.31 270301 AMD  Det er lagt inn varsling dersom rekvisisjons-
      *                   nummer ikke er oppgitt, og det på kunden er
      *                   satt krav om at dette skal utfylles.
3.32  * R3.32 290301 AMD  Lagt inn mulighet for å styre om rabatter skal
      *                   vises med prosent, eller som bare et nettobeløp.
3.33  * R3.33 040401 AMD  Avtaletekst er utvidet til 3 linjer, og hentes nå
      *                   fra et eget avtale-register i økonomisystemet.
3.34  * R3.34 301001 AMD  Henter inn ordrerabatt fra kunderegister
5.01  * R5.01 231002 AMD  Skiftet til nytt program for hurtigoppretting
      *                   av kunder i butikksystemet.
5.02  *       290403 AMD  Oppdatering av alfafelt i ordrehode (korrigering)
5.41  *       240805 AMD  Distrikt er utvidet fra 2.0 til 4.0
5.60  *       170708 AMD  Det er gjort endringer i FL501R i parameter-
      *                   liste som påvirker BO11CR
6.20  *  6.20 140611 bsa  Memosaldo er flyttet ut på eget register
6.NU  *  6.30 190614 nho  utvidelse ihht. nummerutvidelse
6.30  * 6.30  061014 BKV  Henter overstyrt info fra kundeprosjekt
7.01  * MGR   151216 sst  Utvidet memosaldo vedr ant dager ordre
7.01  *       170117 sst  Hente parameter meosaldo fra AFPSPF
8.00  *       231122 sst  Flyttet ant memo-dager og utv.kreditgrense til  UTVIDET_MEMOSALDO (nx)
      *                   Memosaldo ligger inkl mva
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     Frkunl1    IF   E           K DISK    RENAME(RKUNPFR:rkunl1r)
6.20 Frkmel1    if   e           k disk    rename(rkmepfr:rkmel1r)
     FFUSRL1    IF   E           K DISK    RENAME(FUSRPFR:FUSRL1R)
     FBSTSL1    IF   E           K DISK    RENAME(BSTSPFR:BSTSL1R)
     FBMHEL1    IF   E           K DISK    RENAME(BMHEPFR:BMHEL1R)
     FBMHELU    UF A E           K DISK    RENAME(BMHEPFR:BMHELUR)
     Ffkprl1    IF   E           K DISK    RENAME(fkprpfr:fkprl1r)
8.00 f*afpslr    if   e           k disk    rename(afpspfr:afpslrr)
      *
     FBO11CD    CF   E             WORKSTN
3.11  *
3.11  * Definering av array
3.11  *
3.11 d a_mld1          s             36    dim(1) ctdata perrcd(1)
      *
      * Definering av nøkler
      *
     d w_firm          s                   like(baafir)
     d fusrl1_user     s                   like(fbuser)
     d rkunl1_kund     s                   like(rkkund)
     d bmhel1_aarr     s                   like(bnaarr)
     d bmhel1_wsid     s                   like(bnwsid)
     d bmhel1_numm     s                   like(bnnumm)
     d fkprl1_kund     s                   like(bnkund)
     d fkprl1_kpro     s                   like(bnkund)
8.00 d*afpslr_ufil     s                   like(l_filg)
8.00 d*afpslr_uide     s                   like(afuide)
      *
      * Definering av variable
      *
     d w_dato          s                   like(flfdat)
     d w_kprs          s                   like(flkprs)
     d w_tlfa          s                   like(fltlfa)
     d w_tlfp          s                   like(fltlfp)
     d w_tlfm          s                   like(fltlfm)
     d w_mail          s                   like(flmail)
     d w_orka          s                   like(florka)
     d w_okun          s                   like(flokun)
     d w_okpr          s                   like(flokpr)
     d w_opda          s                   like(flopda)
     d w_kpro          s                   like(flkpro)
5.60 d w_kjor          s                   like(flkjor)
5.60 d w_kjnr          s                   like(flkjnr)
3.33  *
3.33 d w_sat1          s                   like(bnnavn)
3.33 d w_sat2          s                   like(bnnavn)
3.33 d w_sat3          s                   like(bnnavn)
3.33  *
3.32  *
3.32  * Definering av save-variable
3.32  *
3.32 d s_neto          s                   like(bnneto)
3.34 d s_orab          s                   like(rkorab)
      *
     D                 DS
     D  LDSPER                 1      1  0
     D  LDGREN                 2     12  2
     D  LDSALD                13     23  2
      *
6.NU D  LDPORD                41     48  0
6.NU D  LDPSUF                49     49  0
      *
     D  LDKUNA               101    112
     D  LDBETB               169    170  0
      * LDKKAT               171    172  0
     D  LDLMAT               175    176  0
     D  LDLBET               177    178  0
     D  LDVALK               179    181
     D  LDRKAT               182    184  0
     D  LDSPED               185    187  0
     D  LDKJOR               188    189  0
     D  LDMKOD               190    190  0
5.41 D  LDDIST               191    194  0
     D  LDKGFA               211    211  0
     D  LDVREF               212    231
     D  LDKKAT               232    235  0
      *
     D                UDS
     D  DSUSER               911    920
7.01 d  l_filg               931    933
     D  DSFNAK               951    970
      *
      * Konstanter
      *
     d Lo              c                   'abcdefghijklmnopqrstuvwxyzæøå'
     d Up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅ'
      *
7.01  *
7.01  * Parametre til RS205R - hent mva %
7.01  *
7.01 d w_stat          s              1
7.01 d w_mvak          s              1
7.01 d w_mvtx          s             30
7.01 d w_mvas          s              6  2
7.01 d w_mvat          s              5  4
7.01 d w_mvaf          s             10  9
7.01 d w_bpro          s              5  2
7.01 d w_date          s               d   datfmt(*iso)
      *
7.01  *w_utvgrns = utvidelse av memosaldo(Mestergruppen)
7.01 d w_utvgrns       s              2  0
7.01  *w_memodagr = antall dager ordre skal med i memosaldo
7.01 d w_memodagr      s              3  0
7.01 d w_3x            s              3
7.01 d p_fir           s              3
7.01 d p_kun           s              6
7.01 d w_kgrn          s             11  2
      *
7.01 d u_kmem          s              1    inz(*off)                            Kredit og memodager
      *
7.01   dcl-s co402_verdi1  char(1);
7.01   dcl-s co402_verdi2  char(2048);
7.01   DCL-PR CO402R EXTPGM('CO402R');
7.01     p_filgrp            char(3)     const;
7.01     p_firm              packed(3:0) const;
7.01     p_lager             packed(2:0) const;
7.01     p_nokkel            char(50)    const;
7.01     p_verdi1            char(1);
7.01     p_verdi2            char(2048);
7.01   END-PR;
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Behandling av inngangsopplysninger                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
      *  Forklaring til statuskoder
      *
      *       WRETUR  Benyttes ved retur fra ett annet program
      *       WSTATA  Dersom bong finnes =1, ellers =0
      *       WC1KOD  A=Feil fakturakunde, B=Feil varekunde
      *
      *
      *
      *  Hent inn fra BONG-HODE-REGISTER
      *
     C                   EXSR      HNTORD
      *
      *  Legger inn verider, nullstiller felter i bildet
      *
     C                   MOVE      *BLANK        C1VALG
     C                   MOVE      *ZERO         C1RABF
      *
      *  Hopper til behandling av kundeinformasjon
      *
     C     *IN94         IFEQ      *OFF
     C                   MOVE      C1KUND        WWKUND
     C                   GOTO      C1TAGA
     C                   END
      *
      *  Direkte til kundespørring dersom bong ikke finnes
      *
     C                   EXSR      SPKUN
      *
     C     WRETUR        IFEQ      '9'
     C                   MOVE      '9'           p_retu
     C                   GOTO      XSLUTT
     C                   END
     C     WRETUR        IFNE      '8'
     C                   GOTO      C1TAG0
     C                   END
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  C1 Behandler åpningsbildet samt funksjonstaster                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     C1TAG         TAG
      *
      *  Legger inn faste felter som gjentaes for neste bilde
      *
     C                   MOVE      LDVREF        C1VREF
      *
      *  Nullstiller/Blanker felter som skal benyttes
      *
     C                   MOVE      *ZERO         C1LKUN
     C                   MOVE      *ZERO         C1KUND
     C                   MOVE      *BLANK        C1NAVN
     C                   MOVE      *BLANK        C1ADR1
     C                   MOVE      *BLANK        C1ADR2
     C                   MOVE      *BLANK        C1STED
     C                   MOVE      *BLANK        C1DREF
     C                   MOVE      *BLANK        C1REKV
     C                   MOVE      *BLANK        C1TLFN
3.10 C                   MOVE      *BLANK        C1MOBN
     C                   MOVE      *ZERO         C1LDAT
      *
     C                   MOVE      *BLANK        C2NAVN
     C                   MOVE      *BLANK        C2GATE
     C                   MOVE      *BLANK        C2ADR2
     C                   MOVE      *BLANK        C2STED
3.33 c                   move      *blank        c2sat1
3.33 c                   move      *blank        c2sat2
3.33 c                   move      *blank        c2sat3
      *
     C                   MOVE      *ZERO         WWKUND
     C                   MOVE      *ZERO         SAkpro
     C                   MOVE      *ZERO         SARKAT
     C                   MOVE      *ZERO         SAPROJ
3.32 c                   move      *zero         s_neto
      *
     C     C1TAGA        TAG
     C                   MOVE      *BLANK        WRETUR
     C                   MOVE      *ZERO         SWTCH1
      *
     C     C1TAGB        TAG
      *
     C                   MOVE      LDBETB        C1BETB
     C                   MOVE      LDKKAT        C1KKAT
     C                   MOVE      LDKGFA        C1KGFA
      *
     C     WKspav        IFNE      0
     C                   MOVE      *ON           *IN28
     C                   END
3.11  *
3.11  *  Dersom det finnes kundeprosjekt på kunden
3.11  *  skal dette varsles i bildet.
3.11  *
3.11 c                   eval      *in29  = *off
3.11 c                   eval      c1text = *blank
3.11  *
3.11 c     c1lkun        ifne      *zero
3.11 c                   move      c1lkun        fkprl1_kund
3.11 c                   move      *zero         fkprl1_kpro
3.11 c                   else
3.11 c                   move      c1kund        fkprl1_kund
3.11 c                   move      *zero         fkprl1_kpro
3.11 c                   endif
3.11 c     fkprl1_key    setll     fkprl1
3.11  *
3.11  *  Leser leverings-adresse-register
3.11  *
3.11 c                   read      fkprl1                                 90
3.11 c     *in90         cabeq     *on           c1tagf
3.11 c     flfirm        cabne     w_firm        c1tagf
3.11 c     flkund        cabne     fkprl1_kund   c1tagf
3.11 c     c1navn        cabne     *blank        c1tagf
3.11 c     swtch1        cabeq     1             c1tagf
3.11  *
3.11 c                   eval      *in29  = *on
3.11 c                   eval      c1text = a_mld1(1)
3.11 c     c1tagf        tag
      *
      *  Send Alt
      *
     C                   EXFMT     C1BLD
     C                   MOVE      *OFF          *IN27
     C                   MOVE      *OFF          *IN28
      *
      *  F1=Hente inn kundeprosjekt
      *
     C     *INKA         IFEQ      *ON
      *
     C     C1LKUN        IFNE      *ZERO
     C                   MOVE      C1LKUN        w_kund
     C                   ELSE
     C                   MOVE      C1KUND        w_kund
     C                   ENDIF
      *
     C                   MOVE      udate         w_dato
     C                   MOVE      *ZERO         w_kpro
     C                   MOVE      *BLANK        w_navn
     C                   MOVE      *BLANK        w_adr1
     C                   MOVE      *BLANK        w_adr2
     C                   MOVE      *BLANK        w_sted
     C                   move      *blank        w_kprs
     C                   move      *blank        w_tlfa
     C                   move      *blank        w_tlfp
     C                   move      *blank        w_tlfm
     C                   move      *blank        w_mail
     C                   move      *zero         w_orka
     C                   move      *zero         w_okun
     C                   move      *zero         w_okpr
     C                   MOVE      *ZERO         w_proj
5.60 C                   move      *zero         w_kjor
5.60 C                   move      *zero         w_kjnr
     C                   CALL      'FL501R'
     C                   PARM                    w_firm
     C                   PARM                    w_kund
     C                   PARM                    w_dato
     C                   PARM                    w_kpro
     C                   PARM                    w_navn
     C                   PARM                    w_adr1
     C                   PARM                    w_adr2
     C                   PARM                    w_sted
     C                   PARM                    w_kprs
     C                   PARM                    w_tlfa
     C                   PARM                    w_tlfp
     C                   PARM                    w_tlfm
     C                   PARM                    w_mail
     C                   PARM                    w_orka
     C                   PARM                    w_okun
     C                   PARM                    w_okpr
     C                   PARM                    w_opda
     C                   PARM                    w_proj
5.60 C                   PARM                    w_kjor
5.60 C                   PARM                    w_kjnr
     C     w_navn        IFNE      *BLANK
     C                   MOVEL     w_navn        C1NAVN
     C                   MOVEL     w_adr1        C1ADR1
     C                   MOVEL     w_adr2        C1ADR2
     C                   MOVEL     w_sted        C1STED
     C                   MOVE      w_orka        SARKAT
     C                   MOVE      w_proj        SAPROJ
     C                   MOVE      w_kpro        SAkpro
     C                   ENDIF
     C                   MOVE      1             SWTCH1
     C                   GOTO      C1TAGB
     C                   END
      *
      *  F3=Avslutt program
      *
     C     *INKC         IFEQ      *ON
     C                   MOVE      '9'           p_retu
     C                   GOTO      XSLUTT
     C                   END
      *
      *  F4=Spørring i kunde-register
      *
     C     *INKD         IFEQ      *ON
     C                   EXSR      SPKUN
      *
     C     WRETUR        IFNE      '9'
     C                   GOTO      C1TAG0
     C                   END
     C                   END
      *
      *  F6=Opprett ny kunde i kunde-register
      *
     C     *INKF         IFEQ      *ON
     C     C1NAVN        IFNE      *BLANK
     C                   EXSR      OPKUN
     C     WRETUR        IFEQ      *BLANK
     C                   GOTO      C1TAG0
     C                   END
     C                   END
     C                   END
      *
     C     WRETUR        IFEQ      '9'
     C                   GOTO      C1TAGA
     C                   END
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Sjekker de innslåtte opplysninger                              *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
      *  Sjekk,  Er leveringsdato en gyldig dato
      *
     C     C1LDAT        IFNE      *ZERO
     c     *dmy          test(d)                 c1ldat                 33
     C     *IN33         IFEQ      *on
     C                   GOTO      C1TAGB
     C                   END
     C                   END
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Behandler opplsyninger for registrering/vedlikehold av ordre   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     C1TAG0        TAG
      *
      *  Sjekk  Kundenummer / Hent kundeopplysninger
      *
     C                   EXSR      HNTKUN
      *
      *  Leveringskunde finnes ikke i kunde-register
      *
     C     WC1KOD        IFEQ      'A'
     C                   MOVE      *ON           *IN39
     C                   GOTO      C1TAGB
     C                   END
      *
      *  Fakturakunde finnes ikke i kunde-register
      *
     C     WC1KOD        IFEQ      'B'
     C                   MOVE      *ON           *IN40
     C                   GOTO      C1TAGB
     C                   END
      *
      *  Sjekk,  Er kunde sperret for registrering
      *
     c                   if        rksprk = 'J'
     c                   eval      *in43  = *on
     c                   goto      c1tagb
     c                   endif
3.31  *
3.31  *  Sjekk,  Har denne kunde krav til rekvisisjon ?
3.31  *
3.31 c                   if        rkrekv = 1
3.31 c                   if        c1rekv = *blank
3.31 c                   eval      *in49  = *on
3.31 c                   goto      c1tagb
3.31 c                   endif
3.31 c                   endif
      *
      *  Dersom forrige kunde ikke er lik nyregistrert send bilde pånytt
      *
     C     C1KUND        IFNE      WWKUND
     C     WWKUND        IFNE      *ZERO
     C                   MOVE      *ZERO         LDPORD
     C                   MOVE      *ZERO         LDPSUF
     C                   END
      *
     C                   MOVE      *ON           *IN27
     C                   MOVE      C1KUND        WWKUND
     C                   GOTO      C1TAGB
     C                   END
      *
      *  Dersom det finnes kundeprosjekt på kunden
      *  skal vindu for valg komme opp automatisk
      *
     C     C1LKUN        IFNE      *ZERO
     C                   MOVE      C1LKUN        fkprl1_kund
     C                   MOVE      *ZERO         fkprl1_kpro
     C                   ELSE
     C                   MOVE      C1KUND        fkprl1_kund
     C                   MOVE      *ZERO         fkprl1_kpro
     C                   ENDIF
     C     fkprl1_key    SETLL     fkprl1
      *
      *  Leser leverings-adresse-register
      *
     C                   READ      fkprl1                                 90
     C     *IN90         CABEQ     *ON           C1TAGE
     C     FLFIRM        CABNE     w_firm        C1TAGE
     C     FLKUND        CABNE     fkprl1_kund   C1TAGE
     C     C1NAVN        CABNE     *BLANK        C1TAGE
     C     SWTCH1        CABEQ     1             C1TAGE
      *
     C                   MOVE      fkprl1_kund   w_kund
     C                   move      udate         w_dato
     C                   MOVE      *ZERO         w_kpro
     C                   MOVE      *BLANK        w_navn
     C                   MOVE      *BLANK        w_adr1
     C                   MOVE      *BLANK        w_adr2
     C                   MOVE      *BLANK        w_sted
     C                   move      *blank        w_kprs
     C                   move      *blank        w_tlfa
     C                   move      *blank        w_tlfp
     C                   move      *blank        w_tlfm
     C                   move      *blank        w_mail
     C                   move      *zero         w_orka
     C                   move      *zero         w_okun
     C                   move      *zero         w_okpr
     C                   MOVE      *ZERO         w_proj
5.60 C                   move      *zero         w_kjor
5.60 C                   move      *zero         w_kjnr
     C                   CALL      'FL501R'
     C                   PARM                    w_firm
     C                   PARM                    w_kund
     C                   PARM                    w_dato
     C                   PARM                    w_kpro
     C                   PARM                    w_navn
     C                   PARM                    w_adr1
     C                   PARM                    w_adr2
     C                   PARM                    w_sted
     C                   PARM                    w_kprs
     C                   PARM                    w_tlfa
     C                   PARM                    w_tlfp
     C                   PARM                    w_tlfm
     C                   PARM                    w_mail
     C                   PARM                    w_orka
     C                   PARM                    w_okun
     C                   PARM                    w_okpr
     C                   PARM                    w_opda
     C                   PARM                    w_proj
5.60 C                   PARM                    w_kjor
5.60 C                   PARM                    w_kjnr
     C     w_navn        IFNE      *BLANK
     C                   MOVEL     w_navn        C1NAVN
     C                   MOVEL     w_adr1        C1ADR1
     C                   MOVEL     w_adr2        C1ADR2
     C                   MOVEL     w_sted        C1STED
     C                   MOVE      w_orka        SARKAT
     C                   MOVE      w_proj        SAPROJ
     C                   MOVE      w_kpro        SAkpro
     C                   ENDIF
     C                   MOVE      1             SWTCH1
     C                   GOTO      C1TAGB
      *
     C     C1TAGE        TAG
      *
      *  Sjekk,  Skal rabattkategori hentes fra
      *          leverings-adresse-register ?
      *
     C     SARKAT        IFNE      0
     C                   MOVE      SARKAT        LDRKAT
     C                   END
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Sjekker diverse overstyringer                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
      *  Sjekk,  Har kunden overskredet kredittgrensen
      *          (Kan overstyre vha F10)
      *
     C     *INKJ         IFEQ      *OFF
     C     LDGREN        IFNE      *ZERO
7.01  *   Utvide kreditgrense   (Mestergruppen løsning 2017_01)  sst
7.01 c                   if        u_kmem = *on
7.01 c                   if        ldsald < ldgren
7.01 c                   eval      w_kgrn = ldgren *
7.01 c                                      (1+w_utvgrns/100)
7.01 c                   else
     c                   eval      w_kgrn = ldgren
7.01 c                   endif
7.01 c                   else
7.01 c                   eval      w_kgrn = ldgren
7.01 c                   endif
7.01  *
7.01 c                   if        u_kmem = *on
7.01 C                   IF        ldsald > w_kgrn
     C                   MOVE      *ON           *IN42
     C                   GOTO      C1TAGB
     C                   END
7.01 C                   else
7.01 C     LDSALD        IFGT      LDGREN
7.01 C                   MOVE      *ON           *IN42
7.01 C                   goto      c1tagb
7.01 C                   endif
7.01 C                   endif
      *
     C                   END
     C                   END
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Behandler registrete ordreverdier                              *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
      *  Tar vare på de sist brukte opplysninger for noen utvalgte felter
      *  Disse verdiene blir lagt ut neste gang ny ordre skal registres
      *
     C                   MOVE      C1VREF        LDVREF
      *
      *  Kaller opp subrutine for oppdatering av BUTIKK-BONG-HODE-REGISTER
      *
     C                   EXSR      OPPORD
      *
      *  Flytter verdiene i i Parameterfeltene før retur til hovedprogram
      *
     C                   MOVE      C1VALG        p_retu
     C                   MOVE      C1RABF        p_rabf
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Avslutt program                                                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     XSLUTT        TAG
      *
     C                   SETON                                        LR
     C                   RETURN
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Hent inn kundeopplysninger                                     *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     HNTKUN        BEGSR
      *
      *  Nullstiller/Blanker variable
      *
3.34 c                   move      *zero         s_orab
     C                   MOVE      *ZERO         LDSPER
     C                   MOVE      *ZERO         LDGREN
     C                   MOVE      *ZERO         LDSALD
     C                   MOVE      *BLANK        WC1KOD
      *
      *  Sjekk,  Finnes varekundenummer i KUNDE-REGISTER
      *
     C     C1LKUN        IFNE      *ZERO
     C                   MOVE      C1LKUN        rkunl1_kund
     C     rkunl1_key    CHAIN     rkunl1r                            90
     C     *IN90         IFEQ      *ON
     C                   MOVE      'A'           WC1KOD
     C                   GOTO      HNTK99
     C                   ENDIF
      *
      *  Hent fakt.kundenummer fra varekundenummer dersom finnes
      *
     C     C1KUND        IFEQ      *ZERO
     C     RKFAKU        IFNE      *ZERO
     C                   MOVE      RKFAKU        C1KUND
     C                   ELSE
     C                   MOVE      C1LKUN        C1KUND
     C                   MOVE      *ZERO         C1LKUN
     C                   END
     C                   END
      *
     C                   END
3.34  *
3.34  *  Ta vare på ordrerabatt fra varekunde
3.34  *
3.34 c                   move      rkorab        s_orab
      *
      *  Sjekk,  Finnes fakturakundenummer i KUNDE-REGISTER
      *
     C                   MOVE      C1KUND        rkunl1_kund
     C     rkunl1_key    CHAIN     rkunl1r                            90
     C     *IN90         IFEQ      *ON
     C                   MOVE      'B'           WC1KOD
     C                   GOTO      HNTK99
     C                   END
7.01  * Beregne memosaldo pr dato, Mestergruppen
7.01 c                   if        u_kmem = *on
7.01 c                   if        w_memodagr > 0
7.01 c                   move      w_firm        p_fir
7.01 c                   move      rkunl1_kund   p_kun
7.01 c                   call      'FO763R'
7.01 c                   parm                    p_fir
7.01 c                   parm                    p_kun
7.01 c                   endif
7.01 c                   endif
6.20  * Henter inn memosaldo
6.20 C     rkunl1_key    chain     rkmel1r                            90
      *
      *  Legger inn informasjon fra kunde-register
      *
     C                   Z-ADD     RKKRES        LDSPER
     C     RKGRNS        MULT      1000          LDGREN
7.01 C                   if        u_kmem = *off
7.01 C                   Z-ADD     RKSALD        LDSALD
7.01 C                   ADD       RKMEMS        LDSALD
7.01 C                   endif
7.01  *
7.01  * Hent mva % for beregning av memosaldo inkl. mva
8.00  *  Rkmems ligger nå inkl mva
8.00 c**                 eval      w_stat = *blank
8.00 c**                 eval      w_mvak = '3'
8.00 c**                 time                    w_date
7.00  *
8.00 c**                 call      'RS205R'
8.00 c**                 parm                    w_stat
8.00 c**                 parm                    w_mvak
8.00 c**                 parm                    w_mvtx
8.00 c**                 parm                    w_date
8.00 c**                 parm                    w_mvas
8.00 c**                 parm                    w_mvat
8.00 c**                 parm                    w_mvaf
8.00 c**                 parm                    w_bpro
8.00 c*                  eval      ldsald = rksald + rkmems * w_mvat
8.00 c                   eval      ldsald = rksald + rkmems
      *
     C                   MOVE      RKTLFN        C1TLFN
3.10 C                   MOVE      RKMOBN        C1MOBN
     C                   MOVE      RKNAVN        C2NAVN
     C                   MOVE      RKGATE        C2GATE
     C                   MOVE      RKADR2        C2ADR2
     C                   MOVE      RKSTED        C2STED
      *
5.01 C                   MOVEL     RKALFA        LDKUNA
     C                   MOVE      RKBETB        LDBETB
     C                   MOVE      RKKATG        LDKKAT
     C                   MOVE      RKDIST        LDDIST
     C                   MOVE      RKFORM        LDLMAT
     C                   MOVE      RKLBET        LDLBET
     C                   MOVE      RKVALK        LDVALK
     C                   MOVE      RKRABK        LDRKAT
     C                   MOVE      RKSPED        LDSPED
     C                   MOVE      RKKJØR        LDKJOR
     C                   MOVE      RKMKOD        LDMKOD
     C                   MOVE      RKFAGB        LDKGFA
3.34 c                   move      s_orab        c1rabf

6.30  * Slå opp på kundeprosjekt for å finne om prosjekt er
6.30  * overstyrer verdi på kunde
6.30 c                   if        bnkpro > 0
6.30 c                   eval      fkprl1_kund = c1kund
6.30 c                   eval      fkprl1_kpro = bnkpro
6.30 c     fkprl1_key    chain     fkprl1
6.30 c                   if        %found(fkprl1)
6.30 C                   MOVE      FLFAGB        LDKGFA
6.30 c                   endif
6.30 c                   endif


3.33  *
3.33  *  Henter inn tekst fra avtalespesifikasjon
3.33  *
3.33 c                   call      'FÅ709R'
3.33 c                   parm                    w_firm
3.33 c                   parm                    c1kund
3.33 c                   parm                    w_sat1
3.33 c                   parm                    w_sat2
3.33 c                   parm                    w_sat3
3.33  *
3.33 c                   if        w_sat1 <> *blank
3.33 c                   eval      c2sat1 =  w_sat1
3.33 c                   eval      c2sat2 =  w_sat2
3.33 c                   eval      c2sat3 =  w_sat3
3.33 c                   endif
      *
     C     LDKGFA        IFEQ      *ZERO
     C                   MOVE      RKEKGB        LDKGFA
     C                   END
3.32  *
3.32  * Tar vare på kode for nettofaktura
3.32  *
3.32 c                   eval      s_neto = rkneto
      *
      *  Henter inn kundeopplysninger fra vareadressekundenummer
      *
     C     C1LKUN        IFNE      *ZERO
     C                   MOVE      C1LKUN        rkunl1_kund
     C     rkunl1_key    CHAIN     rkunl1r                            90
      *
     C     WSTATA        IFEQ      *ZERO
     C                   MOVE      RKNAVN        C1NAVN
     C                   MOVE      RKGATE        C1ADR1
     C                   MOVE      RKADR2        C1ADR2
     C                   MOVE      RKSTED        C1STED
     C                   END
      *
     C                   MOVE      RKDIST        LDDIST
     C                   MOVE      RKFORM        LDLMAT
     C                   MOVE      RKLBET        LDLBET
     C                   MOVE      RKRABK        LDRKAT
     C                   MOVE      RKSPED        LDSPED
     C                   MOVE      RKKJØR        LDKJOR
      *
     C                   END
      *
     C     HNTK99        ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Hent opplysninger fra BUTIKK-BONG-HODE-REGISTER                *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     HNTORD        BEGSR
      *
     C     bmhel1_key    CHAIN     BMHEL1R                            94
      *
      *  Det finnes ingen BONG fra før, nullstiller statuskode
      *
     C     *IN94         IFEQ      *ON
     C                   MOVE      *ZERO         WSTATA
     C                   ENDIF
      *
      *  BONG finnes fra før, Hent inn opplysninger
      *
     C     *IN94         IFEQ      *OFF
     C                   MOVE      1             WSTATA
     C                   MOVE      BNLKUN        C1LKUN
     C                   MOVE      BNKUND        C1KUND
     C                   MOVE      BNNAVN        C1NAVN
     C                   MOVE      BNADR1        C1ADR1
     C                   MOVE      BNADR2        C1ADR2
     C                   MOVE      BNSTED        C1STED
     C                   MOVE      BNVREF        C1VREF
     C                   MOVE      BNDREF        C1DREF
     C                   MOVE      BNREKV        C1REKV
     C                   MOVE      *zeros        C1LDAT
     C                   MOVE      BNLMTX        C1LMTX
     C                   MOVE      BNKGFA        C1KGFA
      *
     c                   if        bnldat <> *loval
     c     *dmy          move      bnldat        c1ldat
     c                   endif
      *
     C                   MOVE      BNKUND        rkunl1_kund
      *
     C                   MOVE      BNPORD        LDPORD
     C                   MOVE      BNPSUF        LDPSUF
      *
      *  Hent kundeopplysninger
      *
     C                   EXSR      HNTKUN
     C                   ENDIF
      *
     C                   ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Oppdatering av BUTIKK-BONG-HODE-REGISTER                       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     OPPORD        BEGSR
      *
     C     bmhel1_key    CHAIN     BMHELUR                            94
      *
      *  Legger inn opplysninger i som IKKE er vedlikeholdt i bildet
      *
     C                   MOVE      LDBETB        BNBETB
     C                   MOVE      LDDIST        BNDIST
     C                   MOVE      LDLMAT        BNLMAT
     C                   MOVE      LDLBET        BNLBET
     C                   MOVE      LDVALK        BNVALK
     C                   MOVE      LDRKAT        BNRKAT
     C                   MOVE      LDSPED        BNSPED
     C                   MOVE      LDKJOR        BNKJOR
     C                   MOVE      LDMKOD        BNMKOD
     C                   MOVE      LDKGFA        BNKGFA
3.32  *
3.32  * Her er det lagt klart for henting av kode
3.32  * fra kunderegister for nettofaktura
3.32  *
3.32 c                   eval      bnneto = s_neto
      *
      *  Legger inn opplysninger for ny bong
      *
     C     *IN94         IFEQ      *ON
     C                   MOVE      *ZERO         BNSELG
     C                   MOVE      *BLANK        BNOTYP
     C                   MOVE      *ZERO         BNLAGE
     C                   MOVE      *ZERO         BNKREF
     C                   MOVE      *loval        BNFKDA
     C                   MOVE      *loval        BNFFDA
     C                   MOVE      *ZERO         BNAVDE
     C                   MOVE      *ZERO         BNKONT
     C                   MOVE      *ZERO         BNSPES
     C                   MOVE      *ZERO         BNPROJ
     C                   MOVE      *BLANK        BNAKTI
     C                   MOVE      *BLANK        BNLBTX
     C                   MOVE      *ZERO         BNRABP
      *
     C                   MOVE      *ZERO         BNTOTS
      *
      *  Legger inn dagens dato
      *
     c                   time                    bnbdat
     c                   time                    bndate
     c                   time                    bntime
      *
     C                   END
      *
      *  Legger inn opplysninger i som ER vedlikeholdt i bildet
      *
      * Konvertere alfafelt
      * til store bokataver
      *
     C     BAAHOY        IFEQ      1
     c     Lo:Up         xlate     c1navn        c1navn
     c     Lo:Up         xlate     c1adr1        c1adr1
     c     Lo:Up         xlate     c1adr2        c1adr2
     c     Lo:Up         xlate     c1sted        c1sted
     c     Lo:Up         xlate     c1vref        c1vref
     c     Lo:Up         xlate     c1dref        c1dref
     c     Lo:Up         xlate     c1rekv        c1rekv
     c     Lo:Up         xlate     c1lmtx        c1lmtx
     C                   END
      *
     C                   MOVE      C1LKUN        BNLKUN
     C                   MOVE      C1KUND        BNKUND
     C                   MOVEL     LDKUNA        BNKUNA
     C                   MOVE      C1NAVN        BNNAVN
     C                   MOVE      C1ADR1        BNADR1
     C                   MOVE      C1ADR2        BNADR2
     C                   MOVE      C1STED        BNSTED
     C                   MOVE      C1VREF        BNVREF
     C                   MOVE      C1DREF        BNDREF
     C                   MOVE      C1REKV        BNREKV
     C                   MOVE      C1LMTX        BNLMTX
     C                   MOVE      C1KGFA        BNKGFA
      *
      * Er leveringsadresse endret ?
      *
     C     SAkpro        IFNE      *ZERO
     C                   MOVE      SAkpro        BNkpro
     C     SARKAT        IFNE      *ZERO
     C                   MOVE      SARKAT        BNRKAT
     C                   ENDIF
     C     SAPROJ        IFNE      *ZERO
     C                   MOVE      SAPROJ        BNPROJ
     C                   ENDIF
     C                   ENDIF
      *
     c                   eval      bnldat = *loval
     c                   if        c1ldat <> 0
     c     *dmy          move      c1ldat        bnldat
     c                   endif
      *
      *  Legger inn opplysninger om prisordre
      *
     C                   MOVE      LDPORD        BNPORD
     C                   MOVE      LDPSUF        BNPSUF
      *
     C     *IN94         IFEQ      *OFF
     C                   UPDATE    BMHELUR
     C                   ELSE
     C                   MOVE      w_firm        BNFIRM
     C                   MOVE      bmhel1_aarr   BNAARR
     C                   MOVE      bmhel1_wsid   BNWSID
     C                   MOVE      bmhel1_numm   BNNUMM
     C                   WRITE     BMHELUR
     C                   END
      *
     C                   ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Spørring mot KUNDE-REGISTER                                    *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     SPKUN         BEGSR
      *
      *  Kaller opp subprogram for spørring mot KUNDE-REGISTER
      *
     C                   move      *blank        w_navn
     C                   CALL      'RK500R'
     C                   PARM                    w_firm
     C                   PARM                    C1LKUN
     C                   PARM                    w_navn
      *
      *
      *  Gammel kode skal slettes når den nye er klarert
      *  ------------------------------------------------
      *  Kaller opp subprogram for spørring mot KUNDE-REGISTER
      *
     C*                  CALL      'FSSPKR'
     C*                  PARM                    WRETUR
     C*                  PARM                    w_firm
     C*                  PARM                    C1LKUN
     C*                  PARM                    WPNUMM
     C*                  PARM                    WPSUFF
      *
      *  Henting
      *
     C*    WRETUR        IFNE      '9'
     C*    WPNUMM        IFNE      *ZERO
     C*                  MOVE      2             WRETUR
     C*                  CALL      'BOHNOR'
     C*                  PARM                    WRETUR
     C*                  PARM                    w_firm
     C*                  PARM                    bmhel1_aarr
     C*                  PARM                    bmhel1_wsid
     C*                  PARM                    WPNUMM
     C*                  PARM                    WPSUFF
      *
     C*                  EXSR      HNTORD
      *
     C*                  END
      *
      *  Blanker kundopplysninger dersom kundenummer funnet
      *  Fordi varekundeopplysninger bør hentes på nytt
      *
     C*                  MOVE      WPNUMM        LDPORD
     C*                  MOVE      WPSUFF        LDPSUF
     C*                  MOVE      *ZERO         WWKUND
      *
     C*    WPNUMM        IFEQ      *ZERO
     C*                  MOVE      *ZERO         C1KUND
     C*                  MOVE      *BLANK        C1NAVN
     C*                  MOVE      *BLANK        C1ADR1
     C*                  MOVE      *BLANK        C1ADR2
     C*                  MOVE      *BLANK        C1STED
     C*                  END
      *
     C*                  END
      *
     C                   ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Oppretter Kunde i KUNDE-REGISTER                               *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     OPKUN         BEGSR
      *
      *  Kaller opp subprogram for oppretting av ny kunde
      *
5.01 C                   CALL      'FA930R'
     C                   PARM                    WRETUR
     C                   PARM                    w_firm
     C                   PARM                    C1NAVN
     C                   PARM                    C1ADR1
     C                   PARM                    C1ADR2
     C                   PARM                    C1STED
     C                   PARM                    C1LKUN
      *
      *  Blanker kundopplysninger dersom kundenummer funnet
      *
     C     WRETUR        IFEQ      *BLANK
     C                   MOVE      *ZERO         C1KUND
     C                   MOVE      *BLANK        C1NAVN
     C                   MOVE      *BLANK        C1ADR1
     C                   MOVE      *BLANK        C1ADR2
     C                   MOVE      *BLANK        C1STED
     C                   MOVE      *ZERO         WWKUND
     C                   END
      *
     C                   ENDSR
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Subrutine for initiering av program                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     C     *INZSR        BEGSR
      *
      *  Nullstilling av felter som ikke kan redefineres
      *
     C                   MOVE      *BLANK        WC1KOD            1
     C                   MOVE      *ZERO         WSTATA            1 0
     C                   move      *blank        w_alf1            1
      *
     C                   MOVE      *ZERO         SWTCH1            1 0
      *
      *  Redefinering av felter
      *
     C     *LIKE         DEFINE    p_retu        WRETUR
      *
     C     *LIKE         DEFINE    RKspav        WKspav
      *
     C     *LIKE         DEFINE    C1KUND        WWKUND
      *
     C     *LIKE         DEFINE    BNPORD        WPNUMM
     C     *LIKE         DEFINE    BNPSUF        WPSUFF
      *
      *  Redefinering av parameterfeltene
      *
     C     *LIKE         DEFINE    w_alf1        p_retu
     C     *LIKE         DEFINE    BNFIRM        p_firm
     C     *LIKE         DEFINE    BNAARR        p_aarr
     C     *LIKE         DEFINE    BNWSID        p_wsid
     C     *LIKE         DEFINE    BNRABP        p_rabf
      *
     C     *LIKE         DEFINE    BNKUND        w_kund
     C     *LIKE         DEFINE    BNNAVN        w_navn
     C     *LIKE         DEFINE    BNADR1        w_adr1
     C     *LIKE         DEFINE    BNADR2        w_adr2
     C     *LIKE         DEFINE    BNSTED        w_sted
     C     *LIKE         DEFINE    BNPROJ        w_proj
     C     *LIKE         DEFINE    BNkpro        SAkpro
     C     *LIKE         DEFINE    BNRKAT        SARKAT
     C     *LIKE         DEFINE    BNPROJ        SAPROJ
      *
      *  Key for file : OFAK-BRUKER-REGISTER
      *
     C     fusrl1_key    KLIST
     C                   KFLD                    w_firm
     C                   KFLD                    fusrl1_user
      *
      *  Key for file : KUNDE-REGISTER
      *
     C     rkunl1_key    KLIST
     C                   KFLD                    w_firm
     C                   KFLD                    rkunl1_kund
      *
      *  Key for file : BUTIKK-STATUS-KODER
      *
     C     bstsl1_key    KLIST
     C                   KFLD                    w_firm
      *
      *  Key for file : BUTIKK-HODE-REGISTER
      *
     C     bmhel1_key    KLIST
     C                   KFLD                    w_firm
     C                   KFLD                    bmhel1_aarr
     C                   KFLD                    bmhel1_wsid
     C                   KFLD                    bmhel1_numm
      *
      *  Key for file : KUNDE-LEVERINGSADRESSE-REGISTER
      *
     C     fkprl1_key    KLIST
     C                   KFLD                    w_firm
     C                   KFLD                    fkprl1_kund
     C                   KFLD                    fkprl1_kpro
7.01  *
7.01  * Key for propertiesfil
7.01  *
8.00 c*    afpslr_key    klist
8.00 c*                  kfld                    afpslr_ufil
8.00 c*                  kfld                    afpslr_uide
      *
     C/EJECT
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *  Tar inn parameter fra forrige program                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
      *
     C     *ENTRY        PLIST
     C                   PARM                    p_retu
     C                   PARM                    p_firm
     C                   PARM                    p_aarr
     C                   PARM                    p_wsid
     C                   PARM                    p_rabf
      *
     C                   MOVE      *BLANK        p_retu
      *
      *  Legger inn firmanummer i nøkkel
      *
     C                   MOVE      p_firm        w_firm
      *
      *  Legger inn år, arb.stasjon i nøkklene
      *
     C                   MOVE      p_aarr        bmhel1_aarr
     C                   MOVE      p_wsid        bmhel1_wsid
     C                   MOVE      *ZERO         bmhel1_numm
      *
      *  Nullstiller/blanker hjelpe-felter
      *
     C                   MOVE      *ZERO         LDPORD
     C                   MOVE      *ZERO         LDPSUF
      *
     C                   MOVE      *ZERO         LDBETB
     C                   MOVE      *ZERO         LDKKAT
     C                   MOVE      *ZERO         LDDIST
     C                   MOVE      *ZERO         LDLMAT
     C                   MOVE      *ZERO         LDLBET
     C                   MOVE      *BLANK        LDVALK
     C                   MOVE      *ZERO         LDRKAT
     C                   MOVE      *ZERO         LDSPED
     C                   MOVE      *ZERO         LDKJOR
     C                   MOVE      *ZERO         LDMKOD
     C                   MOVE      *ZERO         LDKGFA
      *
      *  Hent opplysninger fra SHOP-KODE-REGISTER
      *
     C     bstsl1_key    CHAIN     BSTSL1R                            90
      *
      *  Hent opplysninger fra OFAK-BRUKER-REGISTER
      *
     C                   MOVE      DSUSER        fusrl1_user
     C     fusrl1_key    CHAIN     FUSRL1                             90
     C     *IN90         IFEQ      *OFF
     C                   MOVEL     FBVREF        LDVREF
     C                   ELSE
     C                   MOVE      *BLANK        LDVREF
     C                   END
      *
7.01  *
7.01  *   Hent inn % utvidelse av kreditgrense
7.01 c*                  eval      afpslr_ufil = l_filg
7.01 c*                  eval      afpslr_uide = 'KRGRNSUTV'
7.01 c*    afpslr_key    chain     afpslrr
7.01 c*                  if        %found(afpslr)
7.01 c*                  movel     afudss        w_utvgrns
7.01 c*                  endif
7.01  *
7.01  *   Hent inn ant dager fram ordre skal med i memosaldo
7.01 c*                  eval      afpslr_uide = 'MEMODAGER'
7.01 c*    afpslr_key    chain     afpslrr
7.01 c*                  if        %found(afpslr)
7.01 c*                  movel     afudss        w_3x
7.01 c*                  move      w_3x          w_memodagr
7.01 c*                  endif
7.01 c                   eval      w_memodagr = 999
7.01 c                   eval      w_utvgrns  = 0
7.01  *
7.01  *
7.01  * NOBB frakt på direkte leverte ordre
7.01  *
7.01   CallP CO402R(l_filg:w_firm:0:'UTVIDET_MEMOSALDO':
7.01                    co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     u_kmem = *on;
         if  %subst(co402_verdi2:1:3) <> *blank;
           w_memodagr = %dec(%subst(co402_verdi2:1:3):3:0);
7.01     endif;
         if  %subst(co402_verdi2:133:2) <> *blank;
           w_utvgrns = %dec(%subst(co402_verdi2:133:2):2:0);
7.01     endif;
7.01   endif;
7.01  *
     C                   ENDSR
**      M e l d i n g e r
Kundeprosjekt finnes, trykk enter...
