# Explanation of RPG Program JX100R

This is an ILE RPG (RPG IV) program for IBM i (AS/400) systems. The program is a maintenance interface for item prices (“Vare-pris, vedlikehold”), letting users view, create, update, copy, and delete item price records, using subfiles for display and selection. It is a transaction-style interactive program with a workstation display.

Let's walk through and explain the main sections and logic:

---

## 1. Program Structure and Comments

- **Header Comments:**  
  The extensive initial header documents the history of the program, changes across versions, and conventions used for indicators.
- **Indicator Usage:**  
  Details which indicators (LR, 10, 11, ..., 99) are used for which functions (e.g., screen rolls, errors, protections).
- **File Declarations:**  
  Many physical and logical files are declared as input/output, some renamed for clarity.  
  Example:
  ```rpg
  fjvprlr    if   e           k disk    rename(jvprpfr:jvprlrr)
  fjx100d    cf   e             workstn sfile(b1sfl:w_srrn)
  ```
- **Data Structure Definitions:**  
  Data structures are defined for display file feedback, LDA (local data area), etc.

---

## 2. Variable and Field Definitions

- **Variables for Subfile Control:**  
  Fields like `w_fcrn`, `w_srrn`, `w_ssrn` manage the subfile scrolling and record counts.
- **Program State Variables:**  
  Flags like `b_oppr`, `b_forn`, `b_feil`, etc. manage whether the program is in create, refresh, or error state.
- **"Like(xxxx)" variables:**  
  Many variables are defined "like" a database field, ensuring identical type/length.
- **Constants:**  
  Used for subfile size (`c_sfil` = 10), indicator initializations, etc.

---

## 3. Main Program Flow (`*inzsr` and Main Loop)

- **Initialization (`*inzsr`):**
  - Set up parameter lists and key lists.
  - Read initial item and company information from the database and LDA.
  - Set up subfile and display control variables.

- **Main Menu Processing:**
  - The main loop displays the subfile (list of prices); user function keys (F-keys) route to maintenance actions.
  - Supported functions include:  
    - Open filter window (F1)
    - Exit (F3/F12)
    - Inquiry (F4)
    - Refresh (F5)
    - Create new (F6)
    - Page up/down (F10/F11)
    - Home key positioning (F21)
  - User actions are processed using `select`/`when`.

---

## 4. Subfile Handling

- **Subfile Workflows:**
  - `dsp_subfile` - Display the subfile to the user.
  - `crt_subfile` - Create/fill the subfile for the current item/filter.
  - `clr_subfile` - Clear the subfile.
  - `bck_subfile` - Page backwards in the subfile.
  - `forny` - Rebuild subfile after updates.

- **Processing Subfile Records (`subfile` subroutine):**
  - Handle user actions per line: Edit (2), Copy (3), Delete (4), View (5).
  - Each command triggers its respective subroutine, updates the subfile as needed.

---

## 5. Maintenance Screens and Subroutines

- **Creating a Row (`xc1bld`):**
  - Presents a data entry screen for a new price record.
  - Validates required fields: supplier, date, etc.
  - Checks if the record already exists. If so, shows a message (`xc1msg`).
  - If valid, launches the edit/maintenance screen (`xc2bld`).

- **Editing/Viewing a Row (`xc2bld`):**
  - If the record exists, loads its values into the edit/view screen.
  - Supports field-level write protection, dynamic per-company (`skrb_c2`).
  - Validates mandatory fields, date ranges.
  - Calls update logic, writes changes to relevant files. Also updates search texts (`JV790R`), handles logistic item updates (`JK101R`), and manages linked supplier records.

- **Copy Row (`xk1win`):**
  - Loads source values, presents the copy screen, validates input, then writes as a new record.

- **Delete Row (`xd1win`):**
  - Presents a confirmation window and deletes the selected record from the database.

- **Filter Window (`xf1win`):**
  - Allows the user to filter the subfile display (e.g., by supplier).

---

## 6. Validation and Data Assistance

- **Inquiry/Assistance (`spørring`):**
  - Calls out to inquiry programs (e.g., `JL500R`) for supplier information as needed.
- **Input Validation (`sjekk_input`):**
  - Checks, for example, that a supplier code is filled in and exists in the supplier table.
- **Write Protection Setup (`skrb_c2`):**
  - Determines (per company and program settings) which fields should be protected against editing.

---

## 7. Filtering and Row Inclusion (`chk_subfile`)

- Controls which price records are shown in the subfile, based on:
  - Filter criteria (e.g., selected supplier).
  - Whether expired or inactive prices are shown by default.
  - Current date and validity periods.

---

## 8. Color Coding and Field Highlighting (`farge`)

- Uses SQL to check if all price givers for an item are expired.
- Sets an indicator (`*in50`) to visually differentiate expired prices.

---

## 9. Database and Key Management

- Uses RPG KLIST (key lists) to efficiently read, chain, update, and delete records using composite keys.
- Sets up keys for all major files: items, prices, suppliers, company validation tables, etc.

---

## 10. External Program Calls

- Calls to external programs for:
  - Logistic item updates (`JK101R`)
  - Search text updates (`JV790R`)
  - Supplier lookup (`JL500R`)

---

## 11. Summary Table

| Section              | Purpose                                                                |
|----------------------|------------------------------------------------------------------------|
| File Declarations    | Link RPG to physical/logical database and display files                |
| Data Structures      | Hold LDA, feedback, and various key and working variables              |
| Main Loop            | Handles user navigation and function key triggers                      |
| Subfile Processing   | Display, scroll, and manipulate lists of price records                 |
| Maintenance Screens  | Add/Edit/Copy/Delete/View single price records                        |
| Validation           | Ensure supplier/date fields are valid before updates                   |
| Color Coding         | Visually marks expired prices using indicators                         |
| External Calls       | Invoke programs for auxiliary functions (logistics, supplier, etc.)    |

---

## 12. Key Points for Onboarding

- **Subfile-centric:** Program is built around a subfile (paged list) paradigm. Almost all actions are based on subfile display and selection.
- **Indicators:** Heavy use of indicators to manage state, screen protection, and error signaling.
- **SQL:** A little embedded SQL is used for special queries (e.g., for color coding).
- **Extensibility:** Program is modular, with many subroutines for various workflow steps.
- **Company-specific logic:** Write-protection and field validations can be driven per company/program via the `AVALPF` file.
- **Norwegian variable names:** Most fields and comments are in Norwegian; familiarize yourself with domain-specific terms like "vare" (item), "pris" (price), "leverandør" (supplier).

---

## 13. Common Workflow Example

1. **User views list of item prices (subfile).**
2. **User selects an action:**
    - Presses F6 to add a new price.
    - Fills in supplier, date, and price.
    - Program validates inputs and checks for duplicates.
    - If valid, record is added and subfile is refreshed.
3. **User can copy, delete, or edit existing prices via line commands.**
4. **Program maintains audit fields (user, timestamp) and updates auxiliary information as needed.**

---

## 14. Tips for Maintenance

- Always check indicator usage before adding new logic, to avoid collisions.
- When adding new fields, ensure they're handled in both display files and logic.
- For changes in filtering or protection, look into `chk_subfile` and `skrb_c2`.
- Use the existing modular subroutine structure for new features.

---

If you need clarification on a particular routine, indicator, or workflow, let me know!