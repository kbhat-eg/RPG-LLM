# Explanation of RPG Program `LO550R`

This RPG (Report Program Generator) code is for an IBM i (AS/400) system, written in ILE RPG (RPG IV, with mostly *fixed-format* statements). The program is designed to search for orders by item number ("Søking på bestilling via varenummer"). Below, the code is explained in structured sections for onboarding new developers.

---

## 1. Header Section

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Sets program options: no debug I/O, date edit = day/month/year.

---

## 2. Files Declaration

```rpg
flodtlv    if   e           k disk    rename(lodtpfr:lodtlvr)
flohelr    if   e           k disk    rename(lohepfr:lohelrr)
flo550d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **lodtlv**: Input file, keyed, external, renamed record format (`lodtpfr` → `lodtlvr`).
- **lohelr**: Input file, keyed, external, renamed record format (`lohepfr` → `lohelrr`).
- **lo550d**: Display file, subfile `b1sfl` tied to variable `w_srrn`.

---

## 3. Special Indicators

Documented as comments:
- `*inLR` ends program
- Function keys are mapped to indicators (e.g., Roll=10, Home=21, etc.)
- Indicators in the ranges 31-79 (~errors, screen indicators), 80-99 (work indicators)

---

## 4. Variables & Parameters

### Parameters

```rpg
d p_firm          s                   like(ldfirm)
d p_vare          s                   like(ldvare)
d p_numm          s                   like(ldnumm)
d p_suff          s                   like(ldsuff)
```
- Parameters passed to program: firm, item, number, suffix.

### Key Variables

Used for building keys to chain/read order/item records.

---

### Working Variables

- **w_stel, w_spge, w_srrn, w_sfrn, w_ssrn**: Counters for subfile rows, pages, record numbers.
- **w_seqe, b_eof, b_valg_ok**: Status flags.
- **w_firm**: Working firm code.

### Constants

```rpg
d c_sfil          s              2  0 inz(10)
```
- `c_sfil`: subfile page size (10 records per page).

---

## 5. Subfile Screen Field Explanations

Describes fields for handling subfiles:
- **w_stel**: Subfile count
- **w_spge**: Subfile page size
- **w_srrn**: Relative record number
- Etc.

---

## 6. Main Program Logic

### Entry and Initialization (`*inzsr`)

- Receives parameters (`*entry`/`plist`).
- Sets up search keys.
- Initializes the display.
- Positions DB to correct item, fills subfile.

### Main Loop

A loop structure is managed by the tags `b2taga`, `b2tagb`, and function key handling.

#### User Interaction

- Write initial command screen (`write b2cmd`)
- Enter subfile loop (`exsr dsp_subfile`)
- Function key handling (`select ... endsl`)
    - Exit (e.g., F3/F12): `goto avslutt`
    - Refresh subfile: `exsr forny`
    - Page down: `exsr crt_subfile`
    - Home Key handling, etc.

#### Subfile Interaction

- Handles selection from subfile (`exsr subfile`)
- If a selection is made (`b_valg_ok = *on`), the program finishes.

#### Exit Logic

- Sets last record indicator (`*inlr`), returns.

---

## 7. Subroutines

### `forny` (Refresh Subfile)

- If a page is visible, chains to first record on page.
- Resets key variables.
- Clears and re-creates the subfile.

### `subfile` (Process Subfile Records)

- Manages the subfile selection indicator/toggles
- Loops through the subfile (`do w_ssrn`), `readc` (read changed records).
- If selection field (`b1valg`) is set, updates parameters and sets selection flag.

### `clr_subfile` (Clear Subfile)

- Activates indicator 14 for subfile clear
- Writes control record
- Resets relevant counters and indicators.

### `crt_subfile` (Create/Fill Subfile)

- Increments page counters.
- Reads up to a page worth of records from `lodtlv`.
- For each, sets output fields, chains to order header for additional info, and writes to the subfile.
- Updates bounds for first and last record shown.

### `dsp_subfile` (Display Subfile)

- If subfile has records, uses indicator 12; otherwise writes the command screen.
- Shows subfile control record (`exfmt`).

---

## 8. Key Lists (`klist`)

Used for keyed file access (setll/read/chain):
- **lodtlv_key**: For item lookup.
- **lohelr_key**: For order header lookup.

---

## 9. Notes

- The code is in Norwegian and contains special characters (e.g., "Beskrivelse" means "Description").
- RPG indicators and their use are essential for control flow and UI.
- The program is structured with tags (`tag`, `goto`) and subroutines (`begsr`/`endsr`).
- Subfile processing is central: the program pages through records, displays them, and processes user selection.

---

## Summary

This RPG program is an interactive display program for searching and selecting orders by item number. It leverages subfiles for paged display, processes user input through function keys, and maintains and navigates state between the database and the user via RPG's indicator and subroutine mechanisms.

**Key skills for onboarding:**
- Understanding RPG fixed format, indicator-driven logic.
- Subfile and display file operations on IBM i.
- Data structure navigation using CHAIN/SETLL/READE, etc.
- The use of key lists for efficient database access.
- Tag/goto based program flow (legacy RPG style).