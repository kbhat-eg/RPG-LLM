# RPG Program VA120R – Maintenance of Account Reference

This program (VA120R) is an interactive green-screen application, likely used for maintaining "account references" (kontohenvisning) and related data on an IBM i (AS/400) system. It is written in legacy ILE RPG, with a focus on subfile techniques for interactive display and update.

Below is a structured explanation, section by section, to help developers understand its mechanics and logic.

---

## 1. **Program Setup and Documentation**

- **Header (`h`) Spec:**  
  - `option(*nodebugio)` – disables I/O debugging.  
  - `datedit(*dmy)` – date edit in DD.MM.YYYY format.
- **Documentation:**  
  - Describes purpose ("Kontohenvisning, vedlikehold"), maintenance history, and indicator usage conventions.

---

## 2. **File Definitions**

Several logical files are used. They provide access paths for maintaining and displaying account reference data:

- `vkhvl1`, `vkhvla`, `vkhvlr`, `vkhvlu`:  
  - All are defined as *input, external, keyed disk* files over `vkhvpfr`, each with its own record format via the `rename()` keyword.
    - The suffixes indicate different access paths or purposes (`l1`, `la`, `lr`, `lu`)
- `va120d`:  
  - *Combined input/output, workstation* display file.
  - Uses a subfile (`sfile` keyword, `b1sfl` format and `w_srrn` as relative record number).
  - Info DS: `dspfbk` captures screen feedback info.

---

## 3. **Data Structures and Variables**

### **Local Data Area (LDA) Usage**
- Variables such as `l_user`, `l_firm`, `l_fnav` are mapped to LDA locations.  
  - Example: `l_firm` (Company) from positions 944–946.

### **Display Feedback Data Structure**  
- `dspfbk` has at least one subfield, `d_fcrn` (first record on page).

### **Key and Work Variables**
- Key variables for file access, e.g. `vkhvl1_kkod`, `vkhvla_ktxt`, etc.
- Work variables for row and paging logic in subfiles:  
  - E.g., `w_fcrn` (first record number on page), `w_stel` (subfile counter), `w_srrn` (subfile relative record number), etc.
- Control/status variables for UI and data manipulation.

---

## 4. **Indicator Usage**

- Standard RPG indicators are used extensively for flow control, subfile processing, and field protection.
- The documentation block gives a clear mapping (e.g., *in10 = Rollup, *in11 = Rolldown, *in30 = Field protection, *in31-*in79 = messages/status).

---

## 5. **Program Flow & Main Logic**

The program operates in a loop, presenting the subfile interface and handling user interaction:

### **Entry Point (`b2taga` / `b2tagb`):**

1. **Show Control Screen:**  
   - `write b2cmd`
2. **Show Subfile:**  
   - `exsr dsp_subfile`

3. **Process Function Keys:**  
   Using `select/when` statements to branch:
   - *F3/F12*: Exit program.
   - *F5*: Refresh subfile.
   - *F6*: Add new entry.
   - *F10/F11*: Page navigation (next/previous page).
   - *F21*: Home key logic (set pos, restart loop).
   - *Others*: Subfile processing.

4. **Positioning and Filtering:**  
   - If search/positioning fields are not blank, run the `posisjoner` subroutine to position the subfile to a relevant entry.

---

### **Subfile Maintenance Subroutines**

#### **forny** (Refresh subfile)
- Re-positions the subfile and reloads its contents.

#### **posisjoner** (Position subfile)
- Positions subfile to a specific key or description provided by the user.
- Calls relevant `setll` based on search criteria, then rebuilds the subfile.

#### **subfile** (Process subfile rows)
- Loops through visible subfile rows using `readc`.
- Handles user actions:
  - `b1valg` values:
    - 2: Edit
    - 3: Copy
    - 4: Delete
    - 5: View
  - Calls the appropriate subroutine, updates subfile as necessary.
- Requests a subfile refresh if `b_forn = *on`.

#### **Subfile Paging**
- `clr_subfile`: Clears the subfile (set *in14, write control record, reset counters).
- `crt_subfile`: Loads subfile entries up to the page size.
- `bck_subfile`: Loads the previous page’s records into the subfile.

#### **dsp_subfile**
- Displays the subfile control and data (sets *in12/13, uses `exfmt`, updates current selection).

---

### **Entry/Edit/Delete/Copy Routines**

- **xc1bld**: Handles "new entry" screen (C1BLD).
  - If an entry already exists, shows a message (xc1msg), otherwise calls the edit screen (xc2bld).
- **xc1msg**: Message screen when attempting to create a duplicate.
- **xc2bld**: Edit/view screen for a selected row.
  - Loads existing data, or clears fields for new entry.
  - Validates up to 7 accounts (kav/kko/ksp fields) by calling an external program (`RS740R`) in `sjekk_konto`.
  - Updates or writes records as needed.
- **xd1win**: Delete confirmation (D1WIN), then deletes the entry.
- **xk1win**: Copy logic (K1WIN). Checks if duplicate exists, then populates fields for a new entry.

---

### **Account Validation (`sjekk_konto`)**

- Calls another program (`RS740R`) to validate an account, department, and special code.
- Sets status indicators based on the returned status character (`w_stat`).

---

### **Inquiry/Prompt Routine (`spørring`)**
- Handles user-initiated inquiry (prompt) for order type fields, using another program (`VA550R`).

---

### **Initialization (`*inzsr`)**

- Defines key lists for file access.
- Initializes company from LDA.
- Positions to the start of the file and initially loads the subfile.

---

## 6. **Key Lists**

- Key lists are defined for efficient database positioning and access (e.g., by firm, code, type, etc.).

---

## 7. **General Concepts**

- **Subfiles:** Central to the UI. Allows paged lists, selection, actions on entries.
- **Indicators:** Standard for legacy RPG but critical for display/file/logic flow.
- **External Program Calls:** Used both for validation and inquiry assistance.

---

## 8. **User Workflow**

1. User is presented with a paged subfile of account references.
2. User can:
    - Page up/down, refresh, exit.
    - Select rows to edit, copy, delete, or view.
    - Position the subfile on a specific account (by key or description).
    - Add new entries.
3. Entries are validated before saving.
4. All data maintenance (add, change, delete) is reflected immediately in the subfile.

---

## 9. **Functional Highlights**

- **Extensive Subfile Logic:** Supports paging, dynamic reload, positioning, and real-time editing.
- **Comprehensive Error/Status Handling:** Multiple indicators and feedback fields to inform user of issues.
- **Multi-level Keying:** Supports advanced positioning and searching by different keys.
- **Modularity:** Segregates logic into subroutines for clarity and reusability.
- **Integration:** Calls out to other programs for validation and inquiry, showing a modular enterprise setup.

---

## 10. **Special Notes**

- This code is written in fixed-format RPG IV (ILE RPG), which differs from modern free-format RPG.
- Heavy reliance on traditional RPG idioms (indicators, subfiles, KLIST/KFLD).
- Norwegian language in comments and some variable names (e.g., "Beskrivelse" means "description", "konto" = account, "avdeling" = department).
- The program is meant for legacy IBM i environments, maintaining a "reference data" file with advanced interactive capabilities.

---

### **Summary Table of Key Files and Records**

| Logical File | Record Format | Purpose                        |
|--------------|--------------|--------------------------------|
| vkhvl1       | vkhvl1r      | Access by account code         |
| vkhvla       | vkhvlar      | Access by account description  |
| vkhvlr       | vkhvlrr      | Read existing entries (by key) |
| vkhvlu       | vkhvlur      | Update/create entries          |
| va120d       | -            | Display file with subfile      |

---

## **Onboarding Advice**

- **First Step:** Familiarize yourself with the subfile and indicator handling if new to classic RPG.
- **Debugging:** Use display file (DSPF) layouts to understand what the user sees on each screen.
- **Validation Logic:** Review the validation external program (`RS740R`) for deeper understanding.
- **Enhancement:** To modernize, consider converting to free-form RPG and modularizing file/data access, especially if further maintenance is required.

---

If you need further drill-down into any of the subroutines or logic flows, let me know!