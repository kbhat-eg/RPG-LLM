# Explanation of the RPG Source Code

This RPG (Report Program Generator) source code (ILE RPG, sometimes called RPG IV) is for an IBM i (AS/400) system. Its purpose is to provide a parameter interface for "deleting customers" (`Sletting av kunder`). Below, each key section is explained to help a developer become familiar with its structure and logic.

---

## 1. Metadata & Documentation

The beginning of the code contains a large comment block, which documents:
- **System/Program Names**: System `ASOKON`, Program `RK400R`
- **Purpose**: "Deleting customers - parameters"
- **Modification History**: Lists past changes and reference codes
- **Indicator Usage**: Explains the purpose of indicator variables (`KA`, `KC`, etc.)

---

## 2. File Definitions

```rpg
fausrl1    if   e           k disk
frk400d    cf   e             workstn
```

- **`fausrl1`**: Input full-procedural file, keyed, disk type. (User file)
- **`frk400d`**: Combined file (input/output), workstation file (used for screen display and interaction).

---

## 3. D-Specs (Definitions / Variables)

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
d s               s              1  0
d w_firm          s              3  0
d w_in03          s              1
d w_type          s              1
d w_edat          s               d   datfmt(*iso)
T5.00d w_ndat          s               d   datfmt(*iso)
```
- **`uds`**: Defines the user data structure (local data area).
- **`l_user`, `l_firm`, `l_fnav`**: Fields in the local data area for user, firm, and firm name.
- **Other variables**:
    - `w_firm`: Work variable for firm number (3 digits)
    - `w_in03`: Work variable, 1 character, for status/indicator
    - `w_type`: Type of operation (1 character)
    - `w_edat`, `w_ndat`: Dates in ISO format (e.g., used for date criteria in deletion logic)

---

## 4. Main Logic Flow

### a. Start & Parameter Screen

```rpg
c     a2taga        tag
c                   exfmt     a2bld
c                   eval      *in31 = *off
c                   eval      *in32 = *off
```
- **Tag `a2taga`**: Label for control flow.
- **`exfmt a2bld`**: Displays and reads the screen format `A2BLD` (for entering deletion criteria).
- **Reset indicators**: `*in31` and `*in32` are reset (off). These will be used for errors or warnings.

### b. Exit Option

```rpg
c                   if        *inkc = *on
c                   move      '1'           w_in03
c                   goto      xslutt
c                   endif
```
- **Exit (KC/F3)**: If the Exit indicator is on (F3 pressed on the screen), sets `w_in03` to '1' and branches to program ending.

### c. Validation: "Eldre enn dato" (Older Than Date)

```rpg
c     *dmy          test(d)                 a2edat                 31
c                   if        *in31 = *on
c                   goto      a2taga
c                   endif
c     *dmy          move      a2edat        w_edat
```
- **`test(d)`**: Tests if the input date field `a2edat` is a valid date (in DMY format).
- **Error Indicator (31)**: If invalid, sets indicator 31 and returns to parameter screen.
- **Move valid date**: Otherwise, moves entered date to the work variable `w_edat`.

### d. Validation: "Kunder lagt inn etter" ("Customers entered after...")

```rpg
T5.00c                   eval      *in33 = *off
T5.00c                   if        a2ndat = *zeros
T5.00c                   move      *hival        w_ndat
T5.00c                   else
T5.00c     *dmy          test(d)                 a2ndat                 33
T5.00c                   if        *in33 = *on
T5.00c                   goto      a2taga
T5.00c                   endif
T5.00c     *dmy          move      a2ndat        w_ndat
T5.00c                   endif
```
- **Reset indicator (33)**
- **If no date entered (`*zeros`)**: Set `w_ndat` to high value (`*hival`)—means no restriction.
- **Otherwise**: Validate the entered date (`a2ndat`). If invalid, set indicator 33 and return to screen. If valid, move to `w_ndat`.

### e. Validate Output Type

```rpg
c                   if        a2type <> 'J'
c                             and a2type <> 'N'
c                   move      *on           *in32
c                   goto      a2taga
c                   endif
```
- **Output type must be 'J' or 'N'**: If not, set indicator 32 (error) and return to screen.

### f. Prepare for Deletion Routine

```rpg
c                   move      a2type        w_type
c                   call      'RK400C'
c                   parm                    w_in03
c                   parm                    w_type
c                   parm                    w_edat
T5.00c                   parm                    w_ndat
```
- **Copy operation type from screen**
- **Call the customer deletion routine (`RK400C`)** with the four parameters:
    - Exit/status indicator
    - Type
    - “Older than” date
    - “Entered after” date

---

## 5. Program End

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- **Tag `xslutt`**: End of program.
- **Set last record indicator (`*inlr`)**: Tells the program to close down properly and return.

---

## 6. Initialization Subroutine

```rpg
c     *inzsr        begsr
c                   move      l_firm        w_firm
c                   move      'J'           a2type
E5.00c                   eval      w_in03 = '0'
c                   endsr
```
- **Initializes variables at program start**:
    - Firm number from local area to work variable
    - Default operation type to 'J'
    - Clear `w_in03` (set to '0')

---

## 7. Summary of Key Indicators

- **F1/Firma selection = KA**
- **F3/Exit = KC**
- **Field protection = 30**
- **Error flags = 31 (invalid date), 32 (invalid type), 33 (invalid second date)**

---

## 8. Screen Format: `A2BLD`

All user input for selection criteria is handled via a display file format named `A2BLD`.

---

## **Overall Flow**

1. **Initialization**: Set default values.
2. **User Input**: Show screen for entry of deletion criteria.
3. **Validate**: Check for exit, validate dates and types.
4. **Call Deletion Program**: If valid, invoke customer deletion logic with supplied criteria.
5. **Exit**: End program cleanly when required.

---

## **Conclusion**

The program is a robust, well-documented parameter entry module for a customer deletion process. It carefully validates user inputs, provides error feedback if necessary, and then invokes the core processing program (`RK400C`). The use of indicators and tags reflects classic RPG programming style, especially suited for IBM i environments.