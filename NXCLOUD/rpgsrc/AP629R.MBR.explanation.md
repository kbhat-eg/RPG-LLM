# RPG Source Code Explanation: AP629R

This RPG program, **AP629R**, is written for IBM i systems (AS/400) in RPG IV/ILE. Its main function is to write content to a data queue, depending on the version of a system called "PROA". Below is a line-by-line explanation of the components and logic, focusing on what each section does and why.

---

## 1. Program Header

```rpg
/TITLE  Oppslag mot rutine-register
* Program . . . . : AP629R
* Beskrivelse . . : Skriver til datak�
* Ref.   Dato  Sign Endringsbeskrivelse
* ----- ------ ---- --------------------------------------------------
*       270913 BSA  Nytt program
*K000   141122 bsa  Sjekk hvilken PROA versjon som kj�res. Hvis
*K000               versjon 2, skal det ikke skrives til datak�.
```
**Explanation:**  
General program info and revision history (in Norwegian). Notably, since version 8.01, there’s logic to check the "PROA" version; if it's version 2, the program will **not** write to the data queue.

---

## 2. D-Specs (Definitions)

```rpg
d                uds
8.01 d l_filg                937    939
d l_firm                944    946  0
d l_avde                947    950  0

d p_filg          s             10
d p_xmlf          s            256

8.01 d w_vers          s              5

d DataQ           s             10a   inz('PROADTAQ')
d Library         s             10a   inz('*libl')
d Text            s            200a
d Datalen         s              5  0 inz(200)
```

- `l_filg`, `l_firm`, `l_avde` are probably fields from input parameters or data structure, mapped via positions in a larger parameter block.
- `p_filg`, `p_xmlf`: Local variables for input parameters (file/library and an XML-formatted string).
- `w_vers`: Will hold the version string fetched from the database.
- `DataQ`, `Library`: Data queue and library names (defaults to 'PROADTAQ' in *LIBL).
- `Text`: The text (payload) to send to the data queue (max 200 characters).
- `Datalen`: The length of the data being sent.

---

## 3. Main Program Logic

### a. Write to Data Queue (Conditional)

```rpg
8.01 c                   if        %trim(w_vers) <> '2'
     c                   eval      text = %trim(p_xmlf)
     c                   eval      Datalen = %len(%trim(text))
     c                   eval      Library = %trim(p_filg)
     c                   call      'QSNDDTAQ'
     c                   parm                    DataQ
     c                   parm                    Library
     c                   parm                    DataLen
     c                   parm                    text
8.01 c                   endif
```
**Explanation:**
- Checks if the value of `w_vers` (PROA version fetched earlier) is **not** '2'.
- If true:
    - `text` gets the trimmed value of `p_xmlf`.
    - `Datalen` is set to the length of the trimmed text.
    - `Library` is set from `p_filg` (possibly the library name).
    - Calls IBM API `QSNDDTAQ` to send data to the queue, passing `DataQ`, `Library`, `Datalen` and `Text`.
- If `w_vers` is '2', nothing is sent.

---

### b. Program End

```rpg
     c                   eval      *inlr = *on
     c                   return
```
- Sets LR indicator on (last record) so program will clean up resources after run.
- Returns from the program.

---

## 4. Subroutine for Program Initialization

### a. *INZSR – Initialization Subroutine

```rpg
     c     *inzsr        begsr
     c     *entry        plist
     c                   parm                    p_filg
     c                   parm                    p_xmlf
```
- `*INZSR` is the initialization subroutine that runs on program start.
- Defines the parameter list for the entry point:  
  - `p_filg` (likely a library/file identifier)
  - `p_xmlf` (XML string payload)

### b. Fetching PROA Version (Embedded SQL)

```rpg
8.01  /Free
8.01  * Henter inn verdier for å bygge opp streng til json
8.01   exec sql
8.01    select afudss
8.01    into   :w_vers
8.01    from   afpspf
8.01    where  afufil = :l_filg and
8.01           afuide = 'PROA_VER';
8.01  /End-free
```
- Embedded SQL is used to **fetch the PROA version**:
    - Selects `afudss` from table `afpspf` where:
        - `afufil` = value in `l_filg`
        - `afuide` = 'PROA_VER'
    - Places the result in `w_vers`.
    - The version determines if data is sent to the queue.

### c. End of Subroutine

```rpg
     c                   endsr
```

---

## 5. High-Level Summary

**What this program does:**
- Receives two parameters: a file/library identifier and an XML-formatted string.
- On initialization, fetches the "PROA" system version from a control/database table.
- If the version **is not** 2, sends the XML string as a message to the data queue "PROADTAQ".
- If the version **is** 2, skips sending to the data queue.

**Main Use Case:**
- Allows different processing depending on the version of the PROA system—a data integration pattern useful for staged application upgrades or conditional messaging.

---

## 6. Key Concepts for Onboarding

- **Data Queues:** A method for inter-program communication on IBM i. This program enqueues messages to 'PROADTAQ'.
- **Embedded SQL:** Used to fetch control/configuration information from a DB2 table at runtime.
- **Parameter Handling:** Parameters are processed in the *INZSR subroutine, commonly used to initialize variables.
- **Conditional Processing:** Business logic is adapted by checking a runtime configuration value.

---

### **Onboarding Tips**

- Understand the IBM i data queue system & the QSNDDTAQ API.
- Be aware of how RPG handles parameters via entry lists.
- Familiarize yourself with embedded SQL in RPG.
- Note that control values (like PROA version) are often stored in parameter/configuration tables and drive program logic.
- When modifying, always ensure changes to parameters and SQL mappings are reflected both in the RPG code and any calling programs.

---