# RPG Program VP611R – Explanation

This program, written in ILE RPG (also called RPG IV), is designed to process a CSV input file, parsing specific columns, and deleting items (varer) from an inventory assortment based on the data. Below is a guided walkthrough of the main components and logic.

---

## **Header Options**

```rpg
h option(*nodebugio) datedit(*dmy)
h decedit('0,')
```
- Sets program options:
  - `*nodebugio` disables debug data for file I/O operations.
  - `datedit(*dmy)` and `decedit('0,')` set date and decimal edit codes suitable for European data formats.

---

## **File Declarations**

```rpg
flwexpf    uf   e           k disk
fvvprlu    uf   e           k disk    rename(vvprpfr:vvprlur)
```
- **lwexpf**: User file (input CSV), keyed, external file, disk.
- **vvprlu**: User file, external, disk, renamed record format to `vvprlur`. This file stores item/price records to be deleted.

---

## **Data Structure and Variables**

### **Single fields for database operations**
Lines like:
```rpg
d vvprlu_vare     s                   like(vpvare)
```
Create working storage fields `vvprlu_*`, matching fields (by type/length) in the database file.

### **Input Data Structure**

```rpg
d                 ds
d d_inpu                       300
d  d_ldor                        6    overlay(d_inpu:1)
d  d_enhe                        3    overlay(d_inpu:7)
d  d_vare                       15    overlay(d_inpu:10)
d  d_prgr                        1    overlay(d_inpu:25)
d  d_pdat                       10    overlay(d_inpu:26)
```
- Flat 300-byte buffer `d_inpu` overlays fields for parsing CSV columns:
  - `d_ldor`: Supplier code (column F)
  - `d_enhe`: Unit (column E)
  - `d_vare`: Item number (column A)
  - `d_prgr`: Price group (column I)
  - `d_pdat`: Price date (column M)

### **Other Variables**

- `b_ok`: Boolean, signals a successful parse for deletion.
- `w_posi`: Used to find column separators.
- `w_*`: Working variables for various data elements.
- Constants for character case conversion (`Lo`, `Up`) and digit checking.

---

## **Initialization of SQL (If Used)**

```rpg
C/Exec SQL
C+  Set Option DatFmt=*ISO , commit=*none
C/End-Exec
```
Ensures embedded SQL (if used) will use ISO date format and no commit control. (No SQL code in this program, possibly a standard header.)

---

## **Main Processing Logic**

### **Startup and Logging**

```rpg
c                   eval      w_jnav = 'SLETTE_VP411R'
c                   call      'AB700R  '
c                   parm                    w_jnav
c                   parm                    w_jkey
c                   parm                    w_jtxt

c                   eval      w_jtxt = 'Starter sletting  '
c                   eval      w_jsta = 10
c                   call      'AB705R  '
c                   parm                    w_jkey
c                   parm                    w_jsta
c                   parm                    w_jtxt
```
- Calls external programs for logging/auditing (likely standard in this environment) to note the deletion process has started.

---

### **Main Loop: Process Each Line in Input File**

```rpg
c                   read      lwexpf
c                   dow       not %eof
    ...
    c                   read      lwexpf
c                   enddo
```
- Reads records from the CSV file (`lwexpf`).
- For each line:
  - Resets flags and structure.
  - Calls subroutine `utled_ds` to parse and validate line.
  - If valid (`b_ok = *on`), calls `slett_pris` to delete corresponding record.

---

### **Subroutine: utled_ds (Parse CSV Line)**

This subroutine parses a CSV line, extracts relevant fields, and validates them for further processing.

#### **Parsing Approach**
- Uses `;` as field separator.
- Skips unused columns by repeatedly extracting substrings and scanning for the next separator.
- Extracts and trims relevant fields:
  - A: varenr (item)
  - E: enhet (unit)
  - F: leverandør (supplier)
  - I: prisgruppe (price group)
  - M: prisdato (price date)
- Performs case normalization (using `xlate` with `Lo:Up`).
- Validates numeric fields (supplier code must be digits).
- Sets flag `b_ok` if all fields are valid.

---

### **Subroutine: slett_pris (Delete Item/Price Record)**

```rpg
c                   eval      vvprlu_vare = d_vare
c                   eval      vvprlu_ldor = w_ldor
c                   eval      vvprlu_prgr = d_prgr
c                   eval      vvprlu_enhe = d_enhe
c                   eval      vvprlu_lety = 0
c                   eval      vvprlu_pdat = w_pdat
c     vvprlu_key    chain     vvprlu
c                   if        %found(vvprlu)
c                   delete    vvprlur
c                   endif
```
- Populates search fields from parsed data.
- Reads (`chain`) the pricing file (`vvprlu`) using composite key.
- If found, deletes (`delete`) the related record.

---

### **Key List for Deletion**

```rpg
c     vvprlu_key    klist
c                   kfld                    w_firm
c                   kfld                    vvprlu_vare
c                   kfld                    vvprlu_ldor
c                   kfld                    vvprlu_prgr
c                   kfld                    vvprlu_enhe
c                   kfld                    vvprlu_lety
c                   kfld                    vvprlu_pdat
```
- Defines the composite key for record deletion in the `vvprlu` file.

---

## **Program Termination**

```rpg
c                   eval      *inlr = *on
c                   return
```
- Sets the last record indicator, signaling program end and resource cleanup.

---

## **General Comments**

- **Language/Region**: Norwegian field and comment names.
- **Purpose**: Automates mass deletion of item pricing info based on a structured CSV file.
- **Field Mapping**: Specific CSV columns map to database fields for key-based deletion.
- **Error Handling**: Lines with invalid format or data are silently skipped.
- **Logging**: Calls to external logging/notification programs for process tracking.

---

## **Summary Table of CSV Columns Used**

| Column | Meaning         | RPG reference       |
|--------|----------------|---------------------|
| A      | varenr (item)  | d_vare              |
| E      | enhet (unit)   | d_enhe              |
| F      | leverandør     | d_ldor              |
| I      | prisgruppe     | d_prgr              |
| M      | prisdato       | d_pdat              |

---

## **Typical Use Case**

The program reads an export file (CSV), extracts relevant item and price info, and for each row, attempts to find and delete the corresponding record in the price list file, thus removing these items from the 'assortment'.

---

## **What to Check When Onboarding**

- Understand the input CSV structure (column order!).
- Confirm file and field definitions (databases and overlays).
- Know external file and program dependencies.
- Be familiar with Norwegian business/field terminology as used in code.
- Review other referenced programs if you need auditing or logging details (`AB700R`, `AB705R`).

---

**In essence**:  
This is a batch utility for cleaning up item-price records in the database, driven by CSV data, with robust parsing and key-based deletion logic.