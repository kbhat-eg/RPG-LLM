6.30 h option(*nodebugio) datedit(*dmy-) decedit('0.')
6.30 h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
6.30  /copy hspecsbnd
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RH631R                                              *
      * Beskrivelse . . : Hovedbok - utskrift                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                                     *
      * Tilpasset for . :                                                     *
      *                                                                       *
      * Referanse  Dato   Endringsbeskrivelse                            Sign *
      * --------- ------  ---------------------------------------------- ---- *
      * V5.20     300104  Programmet skrevet om - leser arbeidsfil       KOB  *
T5.30 * V5.30     270704  Skriver avd/bærer-tekst                        HFL  *
T5.30 * V5.30     200904  Siste linje på sida ikke med i transportsum.   HFL  *
T5.40 * V5.40     230106  Tekstfeltet ble ikke blanket før utskrift av   HFL  *
      *                   sum avdeling                                        *
6.10  * V6.10     210909  Lagt inn sporingsfelter                        BSA  *
6.11  * V6.11     041109  Lev.fakt nr skal legges ut i tekstfeltet.      HFL  *
pdf   * R6.10     120710  Innført PDF utskrift. Innebærer primært å finne BSA *
pdf   *                   generert spool, og kall av AP620R med dette som     *
pdf   *                   parametre.                                          *
6.11  * R6.10 071010 BSA  Overfører bacthtype som en del parameterlista. Viser
6.11  *                   hva slags rutine som kjøres. Legges med i arkivet.
6.20  * 6.20  061212 bsa  Tillegg for å berike metataggger
6.30  * 6.30  190814 bsa  Mulighet for å legge resultat ut på excel.
6.31  * R6.30 150914 bsa  Utvidet parameterliste til FO798R. Håndterer flere
6.31  *                   mailadresser.
6.32  * 6.30  280115 bsa  Skriver til datakø for å trigge java sniffer
6.33  * 6.30  050615 bsa  Nullstill minne og suplering av xml
6.34  * R6.30 180816 bsa  Rokkert på rekkefølge av close printerfile
      *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *                                                                 *
      *  BRUK AV INDIKATORER                                            *
      *       KA = F1  = Valg av firma                                  *
      *       KC = F3  = Exit                                           *
      *       LR = Avslutt program                                      *
      *       30 = Protect av felter ved vise                           *
      *    31-59 = Varsle m/feilmeldinger/skjermindikatorer             *
      *    60-69 = Fileindikatorer chain etc.                           *
      *    70-79 = Arbeidsindikatorer i sub-rutiner                     *
      *    80-89 = Arbeidsindikatorer ordinære                          *
      *    90-99 = Benyttes ved std. sub-rutiner                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     frhw1pf    if   e           k disk    rename(rhw1pfr:rhw1pfr)
6.30 faforl1    if   e           k disk    rename(aforpfr:aforl1r)
6.30 fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     frhtrlu    uf   e           k disk    rename(rhtrpfr:rhtrlur)
     fraa1lu    uf a e           k disk    rename(raa1pfr:raa1lur)
      *
     frh631p    o    e             printer infds(d_infds)
pdf  f                                     usropn
      *
      *  Parameter i LDA
      *
     d                uds
     d rhpkda                300    305  0
     d rhprÅr                         4  0
     d rhpper                         2  0
     d rhppef                         2  0
     d rhppet                         2  0
     d rhpavf                         4  0
     d rhpavt                         4  0
     d rhpspf                         4  0
     d rhpspt                         4  0
     d rhpktf                         5  0
     d rhpktt                         5  0
     d rhpsrt                         1
     d rhpsml                         1
     d rhpavv                         1
     d rhpkgs                         1
     d rhpkks                         1
     d rhpsps                         1
     d rhpktu                         1
     d rhpk01                         5  0
     d rhpk02                         5  0
     d rhpk03                         5  0
     d rhpk04                         5  0
     d rhpk05                         5  0
     d rhpk06                         5  0
     d rhpk07                         5  0
     d rhpk08                         5  0
     d rhpk09                         5  0
     d rhpk10                         5  0
     d rhpk11                         5  0
     d rhpk12                         5  0
     d rhpk13                         5  0
     d rhpk14                         5  0
     d rhpk15                         5  0
     d rhpk16                         5  0
     d rhpk17                         5  0
     d rhpk18                         5  0
     d rhpk19                         5  0
     d rhpk20                         5  0
     d rhpk21                         5  0
     d rhpk22                         5  0
     d rhpk23                         5  0
     d rhpk24                         5  0
     d rhpk25                         5  0
     d rhpk26                         5  0
     d rhpk27                         5  0
     d rhpk28                         5  0
     d rhpk29                         5  0
     d rhpk30                         5  0
     d rhpk31                         5  0
     d rhpk32                         5  0
     d rhpk33                         5  0
     d rhpk34                         5  0
     d rhpk35                         5  0
     d rhpk36                         5  0
     d rhpk37                         5  0
     d rhpk38                         5  0
     d rhpk39                         5  0
     d rhpk40                         5  0
      *
pdf  d l_poff                584    584
6.30 d l_utqm                585    594
pdf  d l_bach                595    635
6.30 d l_arch                636    636  0
pdf  d l_skje                637    637  0
6.30 d l_exlp                639    639  0
6.30 d l_mail                640    640  0
6.30 d l_prfi                750    750  0
6.30 d l_outq                810    819
6.30 d l_copy                838    843  0
6.30 d l_ruti                800    809
     d l_wsid                901    910
     d l_user                911    920
6.30 d l_filg                931    933
     d l_firm                944    946  0
6.30 d l_avde                947    950  0
     d l_fnav                951    980
      *
      * Informasjon fra printer-file
      *
     d d_infds         ds
     d  d_linnbr             367    368B 0
     d  d_pagnbr             369    372B 0
      *
     d antskr          s              7  0
     d anttra          s              7  0
     d antib           s              7  0
     d a07txt          s             30
     d a28txt          s             30
     d lrbevd          s             +2    like(rbneto)
     d lrbevk          s             +2    like(rbneto)
     d lrgkre          s             +2    like(rbneto)
     d lrgsal          s             +2    like(rbneto)
     d lrkred          s             +2    like(rbneto)
     d lrndeb          s             +2    like(rbneto)
     d lrnkre          s             +2    like(rbneto)
     d lrnsal          s             +2    like(rbneto)
     d l1bevd          s             +2    like(rbneto)
     d l1bevk          s             +2    like(rbneto)
     d l1gsal          s             +2    like(rbneto)
     d l1nsal          s             +2    like(rbneto)
     d l2bevd          s             +2    like(rbneto)
     d l2bevk          s             +2    like(rbneto)
     d l2gsal          s             +2    like(rbneto)
     d l2nsal          s             +2    like(rbneto)
      *
     d w_kont_gml      s                   like(rbkont)
     d w_avde_gml      s                   like(rbavde)
     d w_spes_gml      s                   like(rbspes)
      *
     d w_avde          s                   like(rbavde)
     d w_spes          s                   like(rbspes)
     d w_firm          s                   like(rbfirm)
     d w_raar          s                   like(rbraar)
      *
     d p_stat          s              1
     d p_gkod          s                   like(rbavde)
     d p_Økod          s                   like(rbspes)
     d p_tx30          s             30
6.30 d p_mail          s              1
6.30 d p_kund          s              6  0
6.30 d p_kpro          s              6  0
6.nu d p_numm          s              8  0
6.31 d p_suff          s              2  0
6.30 d p_selg          s              4  0
6.30 d p_serv          s             35
6.30 d p_kule          s              1
6.30 d p_navn          s             30
6.30 d p_emal          s             50
6.30 d p_ema2          s             50
6.31 d p_ema3          s             50
6.31 d p_kopi          s             50
6.30 d p_emne          s             50
6.30 d p_txt1          s             50
6.30 d p_txt2          s             50
6.30 d p_txt3          s             50
6.30 d p_txt4          s             50
6.30 d p_pers          s             50
6.30 d p_inif          s             40
6.30 d p_in03          s              1
6.11 d p_btyp          s            100
6.30 d p_ok            s              1
6.30 d p_lr            s              1
6.30 d p_str_in        s            512
6.30 d p_str_out       s            512
6.32 d p_filg          s             10
6.32 d p_xmlf          s            256
6.30 d w_text          s             50
6.30 d w_mvak          s              3
6.30 d w_dspl          s            100
6.30 d w_jkey          s             41
6.30 d w_jstat         s              2  0
6.30 d w_jtext         s            200
6.30 d w_pdf           s              1  0
6.30 d w_pdf_ds        s            512
6.30 d w_rtyp          s             50
6.30 d w_dato2         s             12  0
6.30 d w_ddmy          s              6  0
6.30 d w_tids          s              6  0
6.30 d w_ruti          s             10
6.30 d w_txt1          s             75
6.30 d w_date          s               d   datfmt(*iso)
6.30 d w_1fnav         s             50
6.30 d w_1fad1         s             50
6.30 d w_1fad2         s             50
6.30 d w_fste          s             30
6.30 d w_fftx          s             30
6.30 d w_tfax          s              8
6.30 d w_ftlf          s             11
6.30 d w_ffax          s             11
6.30 d w_pemne         s             75
6.30 d w_ptxt1         s             75
6.30 d w_ptxt2         s             75
6.30 d w_ptxt3         s             75
6.30 d w_ptxt4         s             75
6.30 d w_ppers         s             75
6.30 d w_mtxt          s            300
6.30 d h_valu          s             15
6.30 d d_valu          s             50
6.30 d d_type          s             10
6.33 d w_mime          s             24
      *
6.30 d b_excl          s              1    inz(*off)
      *
     d rhtrlu_raar     s                   like(rbraar)
     d rhtrlu_kont     s                   like(rbkont)
     d rhtrlu_avde     s                   like(rbavde)
     d rhtrlu_spes     s                   like(rbspes)
     d rhtrlu_rper     s                   like(rbrper)
     d rhtrlu_bdat     s                   like(rbbdat)
     d rhtrlu_tist     s                   like(rbtist)
6.30 d aforl1_ruti     s                   like(afruti)
pdf   *
pdf  d splfname2       s             10a
pdf  d jobname2        s             10a
pdf  d username2       s             10a
pdf  d jobnbr2         s              6a
pdf  d splfnbr2        s             10i 0
pdf  d splfname3       s             10a
pdf  d jobname3        s             10a
pdf  d username3       s             10a
pdf  d jobnbr3         s              6a
pdf  d splfnbr3        s             10i 0
6.20 d p_tagg0         s             20
6.20 d p_tagg0val      s             50
6.20 d p_tagg1         s             20
6.20 d p_tagg1val      s             50
6.20 d p_tagg2         s             20
6.20 d p_tagg2val      s             50
6.20 d p_tagg3         s             20
6.20 d p_tagg3val      s             50
6.20 d p_tagg4         s             20
6.20 d p_tagg4val      s             50
6.20 d p_tagg5         s             20
6.20 d p_tagg5val      s             50
6.20 d p_tagg6         s             20
6.20 d p_tagg6val      s             50
6.20 d p_tagg7         s             20
6.20 d p_tagg7val      s             50
6.20 d p_tagg8         s             20
6.20 d p_tagg8val      s             50
6.20 d p_tagg9         s             20
6.20 d p_tagg9val      s             50
6.20 d p_refn          s             50
6.20 d p_dspl          s            100
pdf   *
pdf  d qsprilsp        pr                  extpgm('QSPRILSP')
pdf  d rcvvar                     32767a   options(*varsize)
pdf  d rcvvarlen                     10i 0 const
pdf  d format                         8a   const
pdf  d errorcode                  32767a   options(*varsize)
pdf   *
pdf  d sprl0100        ds
pdf  d  bytesrtn                     10i 0
pdf  d  bytesavl                     10i 0
pdf  d  splfname                     10a
pdf  d  jobname                      10a
pdf  d  username                     10a
pdf  d  jobnbr                        6a
pdf  d  splfnbr                      10i 0
pdf  d  systemname                    8a
pdf  d  createdate                    7a
pdf  d                                1a
pdf  d  createtime                    6a
pdf   *
pdf  d errorcode       ds
pdf  d  bytesprov                    10i 0 inz(0)
pdf  d  byteavail                    10i 0 inz(0)
      *
6.30  *
6.30 d XML_Output      s            256a   Varying
6.30 d XML_path        s            256a   Varying
6.30 d                                     Inz('/home/asp/print/adb')
6.30 d jasper_mal      s            256a
6.30 d jasper_logo     s            256a   varying
6.30 d tmpdate         s               D
6.30 d tmptime         s               T
6.30 d crlf            c                   const(X'0d25')
6.30  *
6.30 d d_pdf_ds        ds
6.30 d  d_xmlm                       75
6.30 d  d_jasm                       75
6.30 d  d_logo                       75
6.30 d  d_path                      100
6.30 d  d_emal                       50
6.30 d  d_fifo                       75
6.30 d  d_fkop                        1
6.32 d  d_dtaq                        1
6.32 d  d_sign                        1
6.30  /copy prototypeb
6.30  /copy usec
6.30  *
      *
      /eject
      *
      * Les hovedboks-transaksjoner
      *
     c     dummy         tag
      *
     c                   read      rhw1pfr                                61
      *
      * Hent avdelingstekst fra koderegister
      *
     c                   if        rhpsrt = 'A'
     c                   eval      a07txt = *blank
T5.40c                   eval      p_tx30 = *blank
      *
     c                   if        rbavde > 0
     c                   move      rbavde        p_gkod
      *
     c                   call      'RS707R'
     c                   parm                    p_stat
     c                   parm                    p_gkod
     c                   parm                    p_tx30
      *
     c                   move      rbavde        a07avd
     c                   move      p_tx30        a07txt
     c                   endif
     c                   endif
      *
      * Hent kostnadsbærertekst fra koderegister
      *
     c                   if        rhpsrt = 'B'
     c                   eval      a28txt = *blank
T5.40c                   eval      p_tx30 = *blank
      *
     c                   if        rbspes > 0
     c                   move      rbspes        p_Økod
      *
     c                   call      'RS728R'
     c                   parm                    p_stat
     c                   parm                    p_Økod
     c                   parm                    p_tx30
      *
     c                   move      rbspes        a28sps
     c                   move      p_tx30        a28txt
     c                   endif
     c                   endif
      *
      * Skriv heading på første side
      *
6.30 c                   if        b_excl = *off
     c                   write     head1
6.30 c                   endif
      *
     c/eject
      *
     c                   dow       *in61 = *off
      *
     c                   if        w_kont_gml > *zeros
      *
      * Brudd på konto
      *
     c                   if        rbkont <> w_kont_gml
     c                   exsr      brkto
     c                   endif
      *
     c                   select
      *
      * Brudd på avdeling -
      * kun hvis sortert på avdeling
      *
     c                   when      rhpsrt = 'A'
     c                   if        rbavde <> w_avde_gml
     c                   exsr      brkto
     c                   exsr      bravd
     c                   endif
      *
      * Brudd på kostnadsbærer
      * kun hvis sortert på kostnadsbærer
      *
     c                   when      rhpsrt = 'B'
     c                   if        rbspes <> w_spes_gml
     c                   exsr      brkto
     c                   exsr      brsps
     c                   endif
      *
     c                   endsl
      *
     c                   endif
      *
      * Summer til inngående saldo (Hovedbok)
      *
     c                   if        *in15 = *off and
     c                             rbrper < rhppef
     c                   eval      l1gsal = l1gsal + rbneto
     c                   eval      antib  = antib + 1
     c                   goto      neste
     c                   endif
      *
      * Summer til inngående saldo (Spesifisert Hovedbok)
      *
     c                   if        *in15 = *on and
     c                             rbhmrk = '1'
     c                   eval      l1gsal = l1gsal + rbneto
     c                   eval      antib  = antib + 1
     c                   goto      neste
     c                   endif
      *
      * Summer antall poster
      *
     c                   eval      anttra = anttra + 1
      *
      * Skriv kontonavn + IB ved først postering
      *
     c                   if        anttra = 1 or
     c                             antib  > 0 and
     c                             anttra = 0 and
     c                             w_kont_gml = rbkont
      *
      * Hent tekst fra kontoplan
      *
     c                   eval      l1text = *blank
T5.40c                   eval      p_tx30 = *blank
      *
     c                   eval      w_avde = rbavde
     c                   eval      w_kont = rbkont
     c                   eval      w_spes = rbspes
      *
     c                   call      'RS740R'
     c                   parm                    p_stat
     c                   parm                    w_kont
     c                   parm                    w_spes
     c                   parm                    w_avde
     c                   parm                    p_tx30
      *
     c                   eval      l1text = p_tx30
      *
6.30 c                   if        b_excl = *off
     c                   write(e)  ktotxt
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
      *
     c                   endif
      *
5.60 c                   if        rblfak <> *blank
5.60 c                   eval      rbtext = %trim(rblfak)+'/'+%trim(rbtext)
5.60 c                   else
5.60 c                   eval      rbtext = rbtext
5.60 c                   endif
      * Legg ut detalj-linje
      *
     c                   if        rbneto > 0
     c                   eval      d1debe = rbneto
     c                   eval      d1kred = 0
     c                   eval      *in32 = *on
     c                   else
     c                   eval      d1kred = rbneto
     c                   eval      d1debe = 0
     c                   eval      *in32 = *off
     c                   endif
      *
     c     *dmy          move      rbbdat        d1bdat
      *
      * Summer bevegelse
      *
     c                   if        rbneto > 0
     c                   eval      l1bevd = l1bevd + rbneto
     c                   else
     c                   eval      l1bevk = l1bevk + rbneto
     c                   endif
      *
      * Skriv linje
      *
     c                   eval      antskr = antskr + 1
6.30 c                   if        b_excl = *on
6.30 c                   exsr      xml_detal
6.30 c                   else
     c                   write(e)  d1linj
6.30 c                   endif
      *
      * Overflow
      *
6.30 c                   if        b_excl = *off
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
      *
      * Hvis spesifisert hovedbok
      * oppdater postering med kode
      * for med på spes. hovedbok
      *
     c                   if        *in15 = *on
     c                   eval      rhtrlu_raar = rbraar
     c                   eval      rhtrlu_kont = rbkont
     c                   eval      rhtrlu_spes = rbspes
     c                   eval      rhtrlu_avde = rbavde
     c                   eval      rhtrlu_rper = rbrper
     c                   eval      rhtrlu_bdat = rbbdat
     c                   eval      rhtrlu_tist = rbtist
     c     rhtrlu_key    chain     rhtrlur
      *
     c                   if        %found
     c                   move      '1'           rbhmrk
6.10 c                   time                    rbedat
6.10 c                   time                    rbetim
6.10 c                   eval      rbeusr = l_user
     c                   update    rhtrlur
     c                   endif
      *
     c                   endif
      *
     c     neste         tag
      *
     c                   eval      w_kont_gml = rbkont
     c                   eval      w_avde_gml = rbavde
     c                   eval      w_spes_gml = rbspes
      *
     c                   read      rhw1pfr                                61
      *
     c                   enddo
      *
      /eject
      *
      * Behandle siste konto
      *
      *
      * Hent tekst fra kontoplan
      *
     c                   eval      w_avde = rbavde
     c                   eval      w_kont = rbkont
     c                   eval      w_spes = rbspes
      *
     c                   eval      l1text = *blank
T5.40c                   eval      p_tx30 = *blank
      *
     c                   call      'RS740R'
     c                   parm                    p_stat
     c                   parm                    w_kont
     c                   parm                    w_spes
     c                   parm                    w_avde
     c                   parm                    p_tx30
      *
     c                   eval      l1kont = w_kont
     c                   eval      l1text = p_tx30
      *
      * Skriv kontoinformasjon
      *
     c                   if        antib  > *zero
      *
6.30 c                   if        b_excl = *off
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
     c                   endif
      *
     c                   select
      *
     c                   when      rhpsrt = 'K'
      *
      * Beregn differanser
      *
     c                   eval      l1nsal = l1gsal + l1bevd + l1bevk
      *
6.30 c                   if        b_excl = *off
     c                   if        antskr > *zero or
     c                             antib  > *zero
     c                   write(e)  ktosum
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
     c                   endif
6.30 c                   endif
      *
      * Adder til neste nivå
      *
     c                   eval      l2gsal = l2gsal + l1gsal
     c                   eval      l2nsal = l2nsal + l1nsal
     c                   eval      l2bevd = l2bevd + l1bevd
     c                   eval      l2bevk = l2bevk + l1bevk
      *
      * Summer for siste side
      *
     c                   eval      lrgsal = lrgsal + l1gsal
     c                   eval      lrnsal = lrnsal + l1nsal
     c                   eval      lrbevd = lrbevd + l1bevd
     c                   eval      lrbevk = lrbevk + l1bevk
      *
      /eject
      *
     c                   when      rhpsrt = 'A'
      *
      * Beregn differanser
      *
     c                   eval      l1nsal = l1gsal + l1bevd + l1bevk
      *
     c                   eval      l1kont = w_kont_gml
      *
6.30 c                   if        b_excl = *off
     c                   if        antskr > *zero or
     c                             antib  > *zero
     c                   write(e)  ktosum
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
     c                   endif
6.30 c                   endif
      *
      * Adder til neste nivå
      *
     c                   eval      l2gsal = l2gsal + l1gsal
     c                   eval      l2nsal = l2nsal + l1nsal
     c                   eval      l2bevd = l2bevd + l1bevd
     c                   eval      l2bevk = l2bevk + l1bevk
      *
      * Summer for siste side
      *
     c                   eval      lrgsal = lrgsal + l1gsal
     c                   eval      lrnsal = lrnsal + l1nsal
     c                   eval      lrbevd = lrbevd + l1bevd
     c                   eval      lrbevk = lrbevk + l1bevk
      *
T5.30 * Hent avdelingstekst fra koderegister
      *
     c                   eval      l2avde = w_avde_gml
     c                   eval      a07txt = *blank
T5.30c                   eval      l2text = *blank
T5.40c                   eval      p_tx30 = *blank
      *
T5.30c                   if        w_avde_gml > 0
     c                   eval      p_gkod = w_avde_gml
      *
     c                   call      'RS707R'
     c                   parm                    p_stat
     c                   parm                    p_gkod
     c                   parm                    p_tx30
      *
     c                   move      rbavde        a07avd
     c                   move      p_tx30        a07txt
T5.30c                   move      p_tx30        l2text
T5.30c                   endif
      *
6.30 c                   if        b_excl = *off
     c                   write(e)  avdsum
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
      *
     c                   when      rhpsrt = 'B'
      *
      * Beregn differanser
      *
     c                   eval      l1nsal = l1gsal + l1bevd + l1bevk
      *
     c                   eval      l1kont = w_kont_gml
      *
6.30 c                   if        b_excl = *off
     c                   if        antskr > *zero or
     c                             antib  > *zero
     c                   write(e)  ktosum
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
     c                   endif
6.30 c                   endif
      *
      * Adder til neste nivå
      *
     c                   eval      l2gsal = l2gsal + l1gsal
     c                   eval      l2nsal = l2nsal + l1nsal
     c                   eval      l2bevd = l2bevd + l1bevd
     c                   eval      l2bevk = l2bevk + l1bevk
      *
      * Summer for siste side
      *
     c                   eval      lrgsal = lrgsal + l1gsal
     c                   eval      lrnsal = lrnsal + l1nsal
     c                   eval      lrbevd = lrbevd + l1bevd
     c                   eval      lrbevk = lrbevk + l1bevk
      *
      * Hent kostnadsbærertekst fra koderegister
      *
     c                   eval      l2spes = rbspes
     c                   eval      a28txt = *blank
T5.30c                   eval      l2text = *blank
T5.40c                   eval      p_tx30 = *blank
T5.30c                   if        rbspes > 0
     c                   eval      p_Økod = rbspes
      *
     c                   call      'RS728R'
     c                   parm                    p_stat
     c                   parm                    p_Økod
     c                   parm                    p_tx30
      *
     c                   move      rbspes        a28sps
     c                   move      p_tx30        a28txt
T5.30c                   move      p_tx30        l2text
T5.30c                   endif
      *
6.30 c                   if        b_excl = *off
     c                   write(e)  spssum
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
     c                   endsl
      *
      * Skriv sum på firma
      *
6.30 c                   if        b_excl = *off
     c                   write(e)  firsum
6.30 c                   endif
      *
      *  15=Spesifisert hovedbok
      *
     c                   if        *in15 = *on
     c     raa1lu_key    chain     raa1lur                            60
      *
     c                   move      rhppef        ra1per
     c                   move      rhprÅr        ra1aar
      *
     c                   if        *in60
     c                   write     raa1lur
     c                   else
     c                   update    raa1lur
     c                   endif
     c                   endif
pdf   * Generer xml for videre utskrift
6.30 c                   if        l_poff = '1' and
6.30 c                             b_excl = *off
pdf  c                   exsr      spoolnbr
6.34 c                   close     rh631p
6.34 c                   exsr      xml_create
pdf  c                   exsr      pdf_preview
6.30 c                   endif
6.30  * Excel rapport
6.30 c                   if        l_poff = '1' and
6.30 c                             b_excl = *on
6.30 c                   exsr      xml_end
6.30  * Hvis EXCEL må vi forhåndsvise linken, slik at vi får den opp i browser
6.30 c                   exsr      pdf_preview
6.30 c                   endif
pdf   * Avslutt jobbiden
6.30 c                   if        l_poff = '1'
pdf  c                   call      'AB710R'
pdf  c                   parm                    l_bach
pdf  c                   endif
      *
     c                   eval      *inlr = *on
      *
      /eject
      *
      * Subrutine for beregning ved brudd på konto
      *
     c     brkto         begsr
      *
      * Beregn differanser
      *
     c                   eval      l1nsal = l1gsal + l1bevd + l1bevk
      *
      * Skriv kontonavn + IB hvis det ikke er bevegelse
      *
     c                   if        antib  <> 0 and
     c                             antskr =  0 and
     c                             anttra =  0
      *
      * Hent tekst fra kontoplan
      *
     c                   eval      l1text = *blank
T5.40c                   eval      p_tx30 = *blank
      *
     c                   eval      w_kont = w_kont_gml
     c                   eval      w_spes = w_spes_gml
     c                   eval      w_avde = w_avde_gml
      *
     c                   call      'RS740R'
     c                   parm                    p_stat
     c                   parm                    w_kont
     c                   parm                    w_spes
     c                   parm                    w_avde
     c                   parm                    p_tx30
      *
     c                   eval      l1text = p_tx30
      *
6.30 c                   if        b_excl = *off
     c                   write(e)  ktotxt
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
     c                   endif
      *
      * Skriv sumlinje hvis det er bevegelse
      *
     c                   eval      l1kont = w_kont_gml
      *
6.30 c                   if        b_excl = *off
     c                   if        antskr > *zero or
     c                             antib  <> 0
     c                   write(e)  ktosum
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
     c                   endif
6.30 c                   endif
      *
      * Adder til neste nivå
      *
     c                   eval      l2gsal = l2gsal + l1gsal
     c                   eval      l2nsal = l2nsal + l1nsal
     c                   eval      l2bevd = l2bevd + l1bevd
     c                   eval      l2bevk = l2bevk + l1bevk
      *
      * Summer for siste side
      *
     c                   eval      lrgsal = lrgsal + l1gsal
     c                   eval      lrnsal = lrnsal + l1nsal
     c                   eval      lrbevd = lrbevd + l1bevd
     c                   eval      lrbevk = lrbevk + l1bevk
      *
      * Nullstill arbeidsfelt
      * på L1-nivå
      *
     c                   eval      antib  = 0
     c                   eval      anttra = 0
     c                   eval      antskr = 0
      *
     c                   eval      l1gsal = 0
     c                   eval      l1nsal = 0
     c                   eval      l1bevd = 0
     c                   eval      l1bevk = 0
      *
     c                   endsr
      /eject
      *
      * Subrutine for beregning ved brudd på avdeling
      *
     c     bravd         begsr
      *
      * Beregn differanser
      *
     c                   eval      l2nsal = l2gsal + l2bevd + l2bevk
      *
      * Hent avdelingstekst fra koderegister
      *
     c                   eval      l2avde = w_avde_gml
     c                   eval      a07txt = *blank
T5.30c                   eval      l2text = *blank
T5.40c                   eval      p_tx30 = *blank
      *
T5.30c                   if        w_avde_gml > 0
     c                   eval      p_gkod = w_avde_gml
      *
     c                   call      'RS707R'
     c                   parm                    p_stat
     c                   parm                    p_gkod
     c                   parm                    p_tx30
      *
     c                   move      w_avde_gml    a07avd
     c                   move      p_tx30        a07txt
T5.30c                   move      p_tx30        l2text
T5.30c                   endif
      *
      * Skriv linje
      *
6.30 c                   if        b_excl = *off
     c                   write(e)  avdsum
      *
      * Overflow
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
      *
      * Hent ny avdelingstekst
      * fra koderegisteret
      * og skriv ny heading
      *
     c  n60              do
      *
     c                   eval      a07txt = *blank
T5.40c                   eval      p_tx30 = *blank
     c                   eval      p_gkod = rbavde
      *
     c                   call      'RS707R'
     c                   parm                    p_stat
     c                   parm                    p_gkod
     c                   parm                    p_tx30
      *
     c                   move      rbavde        a07avd
     c                   move      p_tx30        a07txt
      *
6.30 c                   if        b_excl = *off
     c                   exsr      skriv
6.30 c                   endif
      *
     c                   enddo
      *
      * Nullstill arbeidsfelt
      * på L2-nivå
      *
     c                   eval      l2gsal = 0
     c                   eval      l2nsal = 0
     c                   eval      l2bevd = 0
     c                   eval      l2bevk = 0
      *
     c                   endsr
      /eject
      *
      * Subrutine for beregning ved brudd på kostnadsbærer
      *
     c     brsps         begsr
      *
      * Beregn differanser
      *
     c                   eval      l2nsal = l2gsal + l2bevd + l2bevk
      *
      * Hent kostnadsbærertekst fra koderegister
      *
     c                   eval      l2spes = w_spes_gml
     c                   eval      a28txt = *blank
T5.30c                   eval      l2text = *blank
T5.40c                   eval      p_tx30 = *blank
      *
T5.30c                   if        w_spes_gml > 0
     c                   eval      p_Økod = w_spes_gml
      *
     c                   call      'RS728R'
     c                   parm                    p_stat
     c                   parm                    p_Økod
     c                   parm                    p_tx30
      *
     c                   move      w_spes_gml    a28sps
     c                   move      p_tx30        a28txt
T5.30c                   move      p_tx30        l2text
T5.30c                   endif
      *
      * Skriv linje
      *
6.30 c                   if        b_excl = *off
     c                   write(e)  spssum
      *
      * Overflow
      *
     c                   if        %error = '1'
     c                   exsr      skriv
     c                   endif
6.30 c                   endif
      *
      * Hent ny kostnadsbærertekst
      * fra koderegisteret
      * og skriv ny heading
      *
     c  n60              do
      *
     c                   eval      a28txt = *blank
T5.40c                   eval      p_tx30 = *blank
     c                   eval      p_Økod = rbspes
      *
     c                   call      'RS728R'
     c                   parm                    p_stat
     c                   parm                    p_Økod
     c                   parm                    p_tx30
      *
     c                   move      rbspes        a28sps
     c                   move      p_tx30        a28txt
      *
     c                   eval      antskr = 0
      *
6.30 c                   if        b_excl = *off
     c                   exsr      skriv
6.30 c                   endif
      *
     c                   enddo
      *
      * Nullstill arbeidsfelt
      * på L2-nivå
      *
     c                   eval      l2gsal = 0
     c                   eval      l2nsal = 0
     c                   eval      l2bevd = 0
     c                   eval      l2bevk = 0
      *
      * Nullstill arbeidsfelt
      * på L1-nivå
      *
     c                   eval      antskr = 0
      *
     c                   eval      l1gsal = 0
     c                   eval      l1nsal = 0
     c                   eval      l1bevd = 0
     c                   eval      l1bevk = 0
      *
     c                   endsr
      /eject
      *
      * Subrutine for å skrive heading
      *
     c     skriv         begsr
      *
     c                   write(e)  head1
      *
     c                   if        anttra > *zero
     c                   write(e)  ktotxt
     c                   endif
      *
     c                   if        antskr > *zero
     c                   write(e)  transp
     c                   endif
      *
     c                   endsr
      *
      *
      /eject
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Finner spool som er generert av jobben
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     spoolnbr      begsr
pdf   /Free
pdf
pdf            QSPRILSP( SPRL0100
pdf                    : %size(SPRL0100)
pdf                    : 'SPRL0100'
pdf                    : errorcode );
pdf   /End-free
pdf  c*
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Kaller eget program for generering av xml fil. Eget pgm         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_create    begsr
pdf   *
pdf  c                   eval      splfname2 = *blanks
pdf  c                   eval      splfname3 = *blanks
pdf  c                   eval      jobname2 = *blanks
pdf  c                   eval      jobname3 = *blanks
pdf  c                   eval      username2 = *blanks
pdf  c                   eval      username3 = *blanks
pdf  c                   eval      jobnbr2 = *blanks
pdf  c                   eval      jobnbr3 = *blanks
pdf  c                   eval      splfnbr2 = *zeros
pdf  c                   eval      splfnbr3 = *zeros
6.11 c                   eval      p_btyp = 'HOVEDBOK'
6.20 c                   if        *in15 = *on
6.20 c                   eval      p_dspl = 'Spesifisert hovedbok, kjørt '+
6.20 c                                      'dato: '+ %char(udate)
6.20 c                   else
6.20 c                   eval      p_dspl = 'Hovedbok, kjørt '+
6.20 c                                      'dato: '+ %char(udate)
6.20 c                   endif
6.20 c                   eval      p_refn = 'HOB-' + %char(udate)
6.20 c                   eval      p_tagg0 = *blanks
6.20 c                   eval      p_tagg0val = *blanks
6.20 c                   eval      p_tagg1 = *blanks
6.20 c                   eval      p_tagg1val = *blanks
6.20 c                   eval      p_tagg2 = *blanks
6.20 c                   eval      p_tagg2val = *blanks
6.20 c                   eval      p_tagg3 = *blanks
6.20 c                   eval      p_tagg3val = *blanks
6.20 c                   eval      p_tagg4 = *blanks
6.20 c                   eval      p_tagg4val = *blanks
6.20 c                   eval      p_tagg5 = *blanks
6.20 c                   eval      p_tagg5val = *blanks
6.20 c                   eval      p_tagg6 = *blanks
6.20 c                   eval      p_tagg6val = *blanks
6.20 c                   eval      p_tagg7 = *blanks
6.20 c                   eval      p_tagg7val = *blanks
6.20 c                   eval      p_tagg8 = *blanks
6.20 c                   eval      p_tagg8val = *blanks
6.20 c                   eval      p_tagg9 = *blanks
6.20 c                   eval      p_tagg9val = *blanks
pdf   *
6.20 c                   call      'AP627R'
pdf  c                   PARM                    splfname
pdf  c                   PARM                    jobname
pdf  c                   PARM                    username
pdf  c                   PARM                    jobnbr
pdf  c                   PARM                    splfnbr
pdf  c                   PARM                    splfname2
pdf  c                   PARM                    jobname2
pdf  c                   PARM                    username2
pdf  c                   PARM                    jobnbr2
pdf  c                   PARM                    splfnbr2
pdf  c                   PARM                    splfname3
pdf  c                   PARM                    jobname3
pdf  c                   PARM                    username3
pdf  c                   PARM                    jobnbr3
pdf  c                   PARM                    splfnbr3
6.20 c                   parm                    p_tagg0
6.20 c                   parm                    p_tagg0val
6.20 c                   parm                    p_tagg1
6.20 c                   parm                    p_tagg1val
6.20 c                   parm                    p_tagg2
6.20 c                   parm                    p_tagg2val
6.20 c                   parm                    p_tagg3
6.20 c                   parm                    p_tagg3val
6.20 c                   parm                    p_tagg4
6.20 c                   parm                    p_tagg4val
6.20 c                   parm                    p_tagg5
6.20 c                   parm                    p_tagg5val
6.20 c                   parm                    p_tagg6
6.20 c                   parm                    p_tagg6val
6.20 c                   parm                    p_tagg7
6.20 c                   parm                    p_tagg7val
6.20 c                   parm                    p_tagg8
6.20 c                   parm                    p_tagg8val
6.20 c                   parm                    p_tagg9
6.20 c                   parm                    p_tagg9val
pdf  c                   PARM                    l_bach
6.11 c                   PARM                    p_btyp
6.20 c                   PARM                    p_refn
6.20 c                   PARM                    p_dspl
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     pdf_preview   begsr
6.30 c                   if        l_skje = 1 or
6.30 c                             b_excl = *on
pdf   * Vi kaller program for launch av PDF i browser
pdf  c                   call      'AP621R'
pdf  c                   parm                    l_bach
pdf   *
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_envm      begsr
6.30  *
6.33 c**                 eval      w_rtyp = 'XmlExcelDocumentReportCommand'
6.33 c                   eval      w_rtyp = 'XsltCommand'
6.33 c                   eval      w_mime = 'application/vnd.ms-excel'
6.30 c                   eval      d_jasm = *blank
6.30  *
6.30  /Free
6.30       // Finne nytt batch nummer
6.30           UpdHTMLVar('BatchNo':               w_jkey);
6.30           UpdHTMLVar('Batchtype':         'HOVEDBOK');
6.30           UpdHTMLVar('Username':              l_user);
6.30           WrtSection('Topp');
6.30       // Finn report command variabler
6.30           UpdHTMLVar('User':                l_user);
6.30           UpdHTMLVar('PW':                     ' ');
6.30           UpdHTMLVar('IPAdr':                  ' ');
6.30           UpdHTMLVar('Schema':        'ADB'+l_filg);
6.30           UpdHTMLVar('Companyno':    %char(l_firm));
6.30           WrtSection('Credential');
6.30       // Finn report command variabler
6.30           UpdHTMLVar('Reportcommandtype':   w_rtyp);
6.30           UpdHTMLVar('Jaspertemplate':      d_jasm);
6.30           UpdHTMLVar('Logo':                   ' ');
6.30           UpdHTMLVar('Keepspool':           'true');
6.33           UpdHTMLVar('Xsltschemapath':         ' ');
6.33           UpdHTMLVar('Mimetype':            w_mime);
6.30           WrtSection('ReportCommand');
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Heading                        *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_head      begsr
6.30  *
6.30 c                   eval      aforl1_ruti = l_ruti
6.30 c     aforl1_key    chain     aforl1r
6.30  *
6.30  * Hvis mail skal skrives, må vi hente mail informasjon
6.30  *
6.30 c                   if        l_mail = 1
6.30 c                   eval      p_kule = ' '
6.30 c                   eval      p_kund = *zeros
6.30 c                   eval      p_kpro = *zeros
6.30 c                   eval      p_numm = *zeros
6.31 c                   eval      p_suff = *zeros
6.30 c                   eval      p_selg = *zeros
6.30 c                   eval      p_in03 = *off
6.30  * Henter ut mailserver
6.30 c                   eval      p_serv = *blank
6.30 c                   eval      p_stat = *blank
6.30 c                   call      'AM705C'
6.30 c                   parm                    p_serv
6.30 c                   parm                    p_stat
6.30  *
6.30 c                   call      'FO798R'
6.30 c                   parm                    p_kule
6.30 c                   parm                    p_kund
6.30 c                   parm                    p_kpro
6.30 c                   parm                    p_numm
6.31 c                   parm                    p_suff
6.30 c                   parm                    p_selg
6.30 c                   parm                    p_navn
6.30 c                   parm                    p_emal
6.31 c                   parm                    p_ema2
6.31 c                   parm                    p_ema3
6.30 c                   parm                    p_emne
6.30 c                   parm                    p_txt1
6.30 c                   parm                    p_txt2
6.30 c                   parm                    p_txt3
6.30 c                   parm                    p_txt4
6.30 c                   parm                    p_pers
6.31 c                   parm                    p_kopi
6.30 c                   parm                    p_inif
6.30 c                   parm                    p_in03
6.30  * Scann av strenger
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_emne        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_pemne
6.30  * Scann av strenger
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt1
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt2        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt2
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt3        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt3
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_txt4        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ptxt4
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     p_pers        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_ppers
6.30  *
6.30 c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
6.30 c                                      %trim(w_ptxt2) + crlf +
6.30 c                                      %trim(w_ptxt3) + crlf +
6.30 c                                      %trim(w_ptxt4) + crlf +
6.30 c                                      %trim(w_ppers)
6.30  *
6.31 c                   if        p_kopi = *blanks
6.31 c                   eval      p_kopi = d_emal
6.30 c                   endif
6.30  *
6.30 c                   if        p_in03 = *off
6.30  *
6.30  /Free
6.30       // Skriv mailinformasjon
6.31           WrtSection('MailCommandStart');
6.31      //   UpdHTMLVar('Receivers':           p_emal);
6.31           if %Trim(p_emal)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_emal);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema2)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema2);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.31           if %Trim(p_ema3)<> *blanks;
6.31           UpdHTMLVar('Receivers':           p_ema3);
6.31           WrtSection('MailReceiver');
6.31           endif;
6.30           UpdHTMLVar('CC':                     ' ');
6.31           UpdHTMLVar('BCC':                 p_kopi);
6.31           UpdHTMLVar('Sender':              p_kopi);
6.30           UpdHTMLVar('Subject':             w_pemne);
6.30           UpdHTMLVar('Message':             w_mtxt);
6.30           UpdHTMLVar('SMTPServer':          p_serv);
6.30           UPDHTMLVar('SMTPUser':               ' ');
6.30           UPDHTMLVar('SMTPPw':                 ' ');
6.31      //   WrtSection('MailCommand');
6.31           WrtSection('MailCommandEnd');
6.30  /End-free
6.30 c                   endif
6.30 c                   endif
6.30  * Scann av strenger
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     aftxt1        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_txt1
6.30  *
6.30  /Free
6.30
6.30       // Skriv firmavariabler
6.30           UpdHTMLVar('Reporttext':            w_txt1);
6.30           UpdHTMLVar('Subheader':                ' ');
6.30           UpdHTMLVar('CompanyName':          w_1fnav);
6.30           UpdHTMLVar('Companyadress1':       w_1fad1);
6.30           UpdHTMLVar('Companyadress2':       w_1fad2);
6.30           UpdHTMLVar('Companypostalcode':        ' ');
6.30           UpdHTMLVar('Companypostoffice':     w_fste);
6.30           UpdHTMLVar('Companyphone':          w_ftlf);
6.30           UpdHTMLVar('Companyfax':            w_ffax);
6.30           UpdHTMLVar('Companyorgno':   %char(aafftn));
6.30           UpdHTMLVar('Companygiro':    %char(aafbgi));
6.30           UpdHTMLVar('Companyemail':          aamail);
6.30           UpdHTMLVar('Companywebpage': %trim(aaweba));
6.30
6.30           test(de) *dmy w_ddmy;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(w_ddmy : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
6.30
6.30           test(te) *hms w_tids;
6.30           if %error;
6.30           tmptime = *loval;
6.30           else;
6.30           tmptime = %time(w_tids : *hms);
6.30           endif;
6.30           UpdHTMLVar('Creationtime': %char(tmptime : *hms));
6.30           WrtSection('DocumentInformation');
6.30
6.30           WrtSection('FreedefHeader');
6.30
6.30  /End-free
6.30  *
6.30 c                   eval      h_valu='Konto'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Avdeling'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Bærer'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Nummer'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Dato'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Periode'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Bilagskode'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Tekst'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Prosjekt'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Aktivitet'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Mvakode'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Debet'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Kredit'
6.30 c                   exsr      xml_head_val
6.30 c                   eval      h_valu='Journalnr'
6.30 c                   exsr      xml_head_val
6.30  *
6.30  /Free
6.30
6.30       // Avslutt headervalues
6.30           WrtSection('HeaderLineEnd');
6.30
6.30  /End-free
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Heading                        *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_head_val  begsr
6.30  *
6.30  /Free
6.30
6.30       // Skriv headervalue
6.30           UpdHTMLVar('Headervalue':  %trim(h_valu));
6.30           WrtSection('HeaderLineValue');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - detaljlinjer                   *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_detal     begsr
6.30  *
6.30  /Free
6.30
6.30       // Skriv detaljer
6.30           WrtSection('DetailLineStart');
6.30
6.30           WrtSection('FreedefLine');
6.30
6.30  /End-free
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     rbtext        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_text
6.30  * Mva kode
6.30 c                   eval      w_mvak = rbmvao + '/'+ rbmvak
6.30  *
6.30  * Så skriver vi de foskjellige linjene
6.30  *
6.30  * Konto
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(w_kont)
6.30 c                   exsr      xml_line_val
6.30  * Avdeling
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(rbavde)
6.30 c                   exsr      xml_line_val
6.30  * Bærer
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(rbspes)
6.30 c                   exsr      xml_line_val
6.30  * Bilagsnummer
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(rbbiln)
6.30 c                   exsr      xml_line_val
6.30  * Dato
6.30 c                   eval      d_type='Date'
6.30  /Free
6.30
6.30           UpdHTMLVar('type':         %trim(d_type));
6.30           test(de) *dmy d1bdat;
6.30           if %error;
6.30           tmpdate = *loval;
6.30           else;
6.30           tmpdate = %date(d1bdat : *dmy);
6.30           endif;
6.30           UpdHTMLVar('Linevalue':   %char(tmpdate : *iso));
6.30           WrtSection('DetailLineValue');
6.30
6.30  /End-free
6.30  *
6.30  * Periode
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(rbrper)
6.30 c                   exsr      xml_line_val
6.30  * Bilagskode
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(rbbilk)
6.30 c                   exsr      xml_line_val
6.30  * Bilagskode
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(w_text)
6.30 c                   exsr      xml_line_val
6.30  * Prosjekt
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(rbpros)
6.30 c                   exsr      xml_line_val
6.30  * Aktivitet
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(rbakti)
6.30 c                   exsr      xml_line_val
6.30  * Momskode
6.30 c                   eval      d_type='Char'
6.30 c                   eval      d_valu=%trim(w_mvak)
6.30 c                   exsr      xml_line_val
6.30  * Debet
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1debe)
6.30 c                   exsr      xml_line_val
6.30  * Kredit
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(d1kred)
6.30 c                   exsr      xml_line_val
6.30  * Journal
6.30 c                   eval      d_type='Numeric'
6.30 c                   eval      d_valu=%char(rbjour)
6.30 c                   exsr      xml_line_val
6.30  *
6.30  /Free
6.30
6.30       // Skriv avslutning
6.30
6.30           WrtSection('DetailLineEnd');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Linjer                         *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_line_val  begsr
6.30  *
6.30  /Free
6.30
6.30       // Skriv linevalue
6.30           UpdHTMLVar('type':         %trim(d_type));
6.30           UpdHTMLVar('Linevalue':    %trim(d_valu));
6.30           WrtSection('DetailLineValue');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML integrasjon - Slutt                          *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_end       begsr
6.30  *
6.30  /Free
6.30           WrtSection('EndExcelLines');
6.30  /End-free
6.30  *
6.30  * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
6.30  *
6.30 c                   if        l_arch = 1
6.30  * Lag tag for vising i arkivklienten
6.30 c                   eval      w_dspl = *blank
6.30 c                   if        *in15 = *on
6.30 c                   eval      w_dspl = 'Spesifisert hovedbok'
6.30 c                   else
6.30 c                   eval      w_dspl = 'Hovedbok'
6.30 c                   endif
6.30  *
6.30 c                   eval      p_str_in = *blank
6.30 c                   eval      p_lr = '0'
6.30 c                   movel     w_dspl        p_str_in
6.30 c                   call      'AP613R'
6.30 c                   parm                    p_str_in
6.30 c                   parm                    p_str_out
6.30 c                   parm                    p_lr
6.30 c                   movel     p_str_out     w_dspl
6.30  /Free
6.30       // Skriv metattags
6.30
6.30           UpdHTMLVar('Displaytag':     %trim(w_dspl));
6.30           WrtSection('ArchiveCommandStart');
6.30
6.30           UpdHTMLVar('Metavalue':                ' ');
6.30           UpdHTMLVar('Metakey':             'HOVEDBOK');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             l_user);
6.30           UpdHTMLVar('Metakey':             'BRUKER');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue': %char(w_date:*iso));
6.30           UpdHTMLVar('Metakey':               'DATO');
6.30           WrtSection('MetaTag');
6.30
6.30           UpdHTMLVar('Metavalue':             w_txt1);
6.30           UpdHTMLVar('Metakey':         'RUTINETEKST');
6.30           WrtSection('MetaTag');
6.30
6.30           WrtSection('ArchiveCommandEnd');
6.30  /End-free
6.30  *
6.30 c                   endif
6.30  *
6.30  /Free
6.30           WrtSection('Footer');
6.30  /End-free
6.30  *
6.30 c                   eval      XML_Output = XML_path + l_filg +'/'+
6.30 c                             'HBok_'+ %trim(w_jkey) + '.xml'
6.30  *
6.30 c                   callp     WrtHtmlToStmf(XML_Output: 819)
6.32  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
6.32 c                   if        d_dtaq = '1'
6.32 c                   eval      p_xmlf = xml_output
6.32 c                   eval      p_filg = 'ADB'+l_filg
6.32 c                   call      'AP629C'
6.32 c                   parm                    p_filg
6.32 c                   parm                    p_xmlf
6.32 c                   endif
6.30  *
6.30 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
6.30  * Sjekk om vi skal bruke XML generering av dokumenter
6.30  * NB KUN hvis EXCEL rapport. Hvis ikke skal det dannes PDF av spoolfile
6.30  *
6.30 c                   if        l_poff = '1' and
6.30 c                             l_exlp = 1
6.30 c                   eval      b_excl = *off
6.30 c                   eval      w_pdf = 0
6.30 c                   eval      w_pdf_ds = *blanks
6.30 c                   eval      w_ruti = l_ruti
6.30  *
6.30 c                   call      'AP609R'
6.30 c                   parm                    w_ruti
6.30 c                   parm                    w_pdf
6.30 c                   parm                    w_pdf_ds
6.30 c                   eval      d_pdf_ds = w_pdf_ds
6.30  * PROA er aktivert
6.30 c                   if        w_pdf = 1 and
6.30 c                             %trim(d_xmlm) <> *blanks
6.30 c                   eval      w_jkey = l_bach
6.30  *
6.30  * Hent inn xml templaten
6.30  *
6.30 c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
6.33 c                   callp     ClrHtmlBuffer
6.30  *
6.30  * Finn hvor xml'en skal legges
6.30  *
6.30 c                   eval      XML_path = *blanks
6.30 c                   eval      XML_path = %trim(d_path)
6.30  *
6.30  * Jobbnummer er allerede generert i AP600R. Overføres i *lda
6.30  *
6.30 c                   time                    w_date
6.30 c                   time                    w_dato2
6.30 c                   movel     w_dato2       w_tids
6.30 c                   move      w_dato2       w_ddmy
6.30  * Vi logger at utskriftprogrammet har startet
6.30 c                   eval      w_jstat = 10
6.30 c                   eval      w_jtext = 'Excel av hovedbok+
6.30 c                                        har startet'
6.30 c                   call      'AB705R'
6.30 c                   parm                    l_bach
6.30 c                   parm                    w_jstat
6.30 c                   parm                    w_jtext
6.30  * Vi skriver xml for miljø formater
6.30 c                   exsr      xml_envm
6.30 c                   exsr      xml_head
6.30 c                   eval      b_excl = *on
6.30 c                   else
6.30  * Vi logger at noe er galt med parametrene
6.30 c                   eval      w_jstat = 20
6.30 c                   eval      w_jtext = 'Finner ikke path til xml !!! +
6.30 c                             Sjekk rutineregister !'
6.30 c                   call      'AB705R'
6.30 c                   parm                    l_bach
6.30 c                   parm                    w_jstat
6.30 c                   parm                    w_jtext
6.30 c                   endif
6.30  *
6.30 c                   else
6.30 c                   eval      b_excl = *off
6.30 c                   endif
6.30  *
6.30 c                   if        b_excl = *off
pdf  c                   open      rh631p
6.30 c                   endif
      *
     c                   if        rhpsrt = 'A'
     c                   move      *on           *in18
     c                   move      rhpavf        rbavde
     c                   endif
      *
     c                   if        rhpsrt = 'B'
     c                   move      *on           *in20
     c                   endif
      *
      * Hvis flere perioder valgt, skrives periode på lista
      *
     c                   if        rhppef <> rhppet
     c                   move      *on           *in31
     c                   endif
      *
      * Sett startverdier
      *
     c                   move      l_firm        w_firm
     c                   move      rhprÅr        rbraar
      *
     c                   if        rhpsrt = 'K'
      *
     c                   if        rhpktu = ' '
     c                   move      rhpktf        rbkont
     c                   else
     c                   eval      rbkont = 0
     c                   endif
      *
     c                   endif
      *
      * Test om spesifisert hovedbok
      *
     c                   if        rhpsps = 'S'
     c                   move      *on           *in15
     c                   else
     c                   move      *off          *in15
     c                   endif
      *
     c                   eval      anttra = 0
     c                   eval      antskr = 0
      *
      * Key for oppdatering av
      * poster ved spes. hovedbok
      *
     c     rhtrlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhtrlu_raar
     c                   kfld                    rhtrlu_kont
     c                   kfld                    rhtrlu_spes
     c                   kfld                    rhtrlu_avde
     c                   kfld                    rhtrlu_rper
     c                   kfld                    rhtrlu_bdat
     c                   kfld                    rhtrlu_tist
      *
      * Key for statuskode - 1
      *
     c     raa1lu_key    klist
     c                   kfld                    w_firm
6.30  *
6.30  * Key for oppslag på firma
6.30  *
6.30 c     afirl1_key    klist
6.30 c                   kfld                    w_firm
6.30  *
6.30  * Key for rutineregisteret
6.30  *
6.30 c     aforl1_key    klist
6.30 c                   kfld                    aforl1_ruti
6.30  *
6.30  * Henter firmaopplysninger
6.30  *
6.30 c     afirl1_key    chain     afirl1r                            90
      *
     c                   endsr
