```markdown
## Overview

This RPG IV (ILE RPG, "Original" syntax) program is named `SH411R`, part of the ASLAGR system. Its purpose is to display the details of an invoice line ("fakturalinje" in Norwegian). It retrieves and presents both invoice header and line detail data, handles some basic calculations, and interacts with a display file for user interaction.

---

### 1. File Declarations

```rpg
fsihel1    if   e           k disk    rename(sihepfr:sihel1r)
fsidtl1    if   e           k disk    rename(sidtpfr:sidtl1r)
fsh411d    cf   e             workstn
```
- **sihel1**: Invoice header file (renamed record format) for read.
- **sidtl1**: Invoice detail file (renamed record format) for read.
- **sh411d**: Workstation file – the display to the user.

---

### 2. Data Definitions

#### Parameters

Variables starting with `p_` are used to transfer values into the program via the parameter list, such as company (firm), year, document numbers, etc. These are defined as the same type/length as their respective database fields (using `like()` on field names).

#### Local Data Area

```rpg
d                uds
d l_fnav                951    980
```
Defines access to the local data area (LDA), with a field overlay (`l_fnav`) for bytes 951-980.

#### Key Fields

Variables prefixed with `sihel1_` and `sidtl1_` are used to hold keys for accessing the header and detail files.

#### Working Variables

`w_firm`, `w_raba` are working variables.

---

### 3. Initialization (Subroutine *inzsr)

- **Parameter List (`*entry plist`)**: Loads values passed to the program into the variables `p_firm`, `p_aarr`, etc.
- **Key Lists**: Defines composite keys (`klist`) for header and detail file lookups using both parameter and working variables.
- **Firm Code**: Sets `w_firm` from the incoming firm parameter.

---

### 4. Main Logic

#### a) Fetching Header Record

The keys are populated from the parameters, then used to chain (randomly fetch) the invoice header record:
```rpg
c     sihel1_key    chain     sihel1                             60
c                   if        *in60 = *on
c                   goto      avslutt
c                   endif
```
- If the record is not found (`*in60`=on), the program exits.

#### b) Fetching Detail Record

Similarly, the detail keys are populated and used to chain to the detail file.
- Again, if not found, exit.

#### c) Move Detail Fields to Screen Variables

A block of `eval` statements assigns values from the detail record fields (e.g., `slbinr`, `slnumm`, `slvyre`, etc.) to screen variables used by the display file. This prepares the data for display.

#### d) Calculating Net Purchase Price

```rpg
c                   eval      b1kjop = slkjop - slrkr1 - slrkr2 - slrkro
```
This computes the net purchase price, subtracting various discounts/allowances from the base price.

#### e) Handling Special Field

```rpg
c                   if        shfkda <> *loval
c     *dmy          move      shfkda        b1fkda
c                   endif
```
If the header's fkda field is not blank/zero (not low value), it is moved to the display variable.

#### f) Display the Screen

```rpg
c                   exfmt     b1bld
```
Displays the screen format `b1bld` and waits for user input.

#### g) Function Key Processing

```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   endsl
```
If either F12 (Cancel) or F3 (Exit) is pressed, exit the program.

---

### 5. Exit Logic

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
Sets last record indicator (`*INLR`) to signal end of program and returns control.

---

## Key Concepts

- **Separation of Header and Detail Lookups**: The program expects complete key values to be provided for both files.
- **All Data Preparation is for Display**: No update of data occurs; this is a pure "inquiry" program.
- **Norwegian Field Names**: Field names and comments are in Norwegian, e.g., "kjøpspris" (purchase price), "rabatt" (discount).
- **"Option(*nodebugio)"**: Suppresses some debug info about file I/O.

---

## Typical Usage

This program would be called from another RPG program, passing all necessary keys for a specific invoice and line. It retrieves the header and detail, computes net prices, and presents the info to the user, who can then exit with standard function keys.

---

## Notes

- Marked changes (e.g., "6.nu") show ongoing maintenance and adaptations for field expansions.
- Commented lines or legacy code are left for reference (e.g., `***` lines).
- The design is typical for legacy ERP-style inquiry programs on IBM i.
```