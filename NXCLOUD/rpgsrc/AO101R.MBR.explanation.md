# RPG Program AO101R - Explanation

## Overview

This ILE RPG program is titled "AO101R" and is part of an application for managing an online shop or "nettbutikk". Its main function is to provide maintenance (vedlikehold) routines, including displaying, adding, updating, copying, and deleting records associated with shops, warehouses, and shipping methods.  

The code appears to be a classic style RPG application running on IBM i, complete with display file (subfile) handling, physical file lookups, and various subroutines for user actions from the display.

### Key Features

- Uses a subfile-based user interface.
- Manages shop records (with fields such as name, group, warehouse, delivery method).
- Integrates with supporting tables for delivery and warehouse validation.
- Implements standard CRUD operations with additional copy and delete logic.
- Supports function key handling, cursor positioning, and error notifications on the display.

---

## Structure and Components

### 1. File Declarations

At the start, the program declares several database files (`anbll1`, `anbll2`, `anbllr`, `anbllu`, `anbhl1`, `ra17l1`, `ra10l1`) which correspond to various logical and physical records for the shop owner, shop, delivery method, etc.
- Files are renamed locally for convenience.
- The display file (`ao101d`) is used for the user interface, with a subfile (B1SFL).

### 2. Data Structure & Field Definitions

- **Parameters:** `p_eier` (shop owner), `p_firm` (company).
- **User Data Area:** Used for user identification, company, and name.
- **Display Feedback (INFDS):** Used to get feedback from the display file, e.g., cursor position.
- **Work Fields:** For subfile processing (`w_srrn`, `w_ssrn`, etc.), flags, temporary storage, keys, and error indicators.

### 3. Indicators and Their Use

Special indicators (`*IN10`, `*IN11`, etc.) are mapped to function keys and processing controls, e.g.:
- 10: Roll (page down)
- 11: Rolldown (page up)
- 12: Subfile display
- 14: Subfile clear
- 15: End of subfile
- 30: Protect fields
- 31–79: Error and notification indicators
- 80–99: Work indicators

---

## Main Control Flow

The program uses a tag-and-GOTO structure for main screen processing:

1. **Entry / Init:**  
   The `*inzsr` subroutine initializes key fields, shop owner, and subfile display. It fills the subfile with shop data for the owner.

2. **Main Loop:**  
   - The main processing loop alternates between displaying the command screen (`b2cmd`), refreshing/creating the subfile, and waiting for user action.
   - Depending on the key pressed (F-keys, Roll, Home), the program runs the appropriate subroutine or repositions the subfile.

3. **Function Key Handling:**  
   - `*INKC/*INKL`: Exit program.
   - `*INKE`: Refresh subfile.
   - `*INKF`: Create new entry.
   - `*IN10`/`*IN11`: Page down/up the subfile.
   - `*IN21`: Home key.
   - Also detects if user enters a new position criteria (by key or name), and calls the relevant positioning routine.

---

### Subfile Handling and CRUD Operations

#### Subfile Display and Paging

- The subfile is cleared (`clr_subfile`), created (`crt_subfile`), and displayed (`dsp_subfile`) using respective subroutines.
- Paging up/down is handled by `crt_subfile` and `bck_subfile`.

#### Record Selection Handling

- On subfile row selection, different actions are triggered:
    - 2: Edit (calls `xc2bld`)
    - 3: Copy (calls `xk1win`)
    - 4: Delete (calls `xd1win`)
    - 5: View (calls `xc2bld` in view mode)

#### Create / Edit / View Record

- The `xc1bld` subroutine handles creation of a new shop record.
- The `xc2bld` subroutine handles edit/view (fill fields, validate, write changes).
- Validation routines for required fields, warehouse, and delivery methods are included.

#### Copy and Delete

- Copy uses `xk1win`, gathering source and prompting for destination key. It checks for existence before proceeding.
- Delete (`xd1win`): Confirms with user and deletes the record.

---

### Validations

- Before saving, required fields (e.g., shop name, group, warehouse, delivery method) are validated.
- Delivery and warehouse codes are validated by calling external programs/files or subroutines (`ra17l1`/`ra10l1`).
- Error indicators are set if validation fails, to inform the user via the interface.

---

### External Programs / Procedures

- **RA510R:** Query/lookup for warehouse.
- **RA517R:** Query/lookup for delivery method (hentes, leveres, fabrikk).
- **Subroutines:** `sjk_kode` (delivery method check), `sjk_lagk` (warehouse check).

---

### Subroutines Summary

- **forny:** Refresh subfile based on current selection.
- **posisjoner:** Position subfile according to either key or name.
- **subfile:** Handles changes from subfile rows (edit/copy/delete actions).
- **xc1bld:** Create new shop entry.
- **xc1msg:** Show message for duplicate key on creation.
- **xc2bld:** Edit/view shop details, including validation and saving.
- **xd1win:** Handle deletion with confirmation.
- **xk1win:** Handle copy, including destination key and duplicate checking.
- **clr_subfile:** Clear the subfile area.
- **crt_subfile:** Write one page of records to subfile.
- **bck_subfile:** Page up/backward in the subfile.
- **dsp_subfile:** Present the subfile to the user.
- **sjk_kode:** Lookup description of a delivery method from `ra17l1`.
- **sjk_lagk:** Validate warehouse code by lookup in `ra10l1`.
- **\*inzsr:** Program initialization, parameter population, and initial subfile fill.

---

## Special Notes

- The program uses heavy Norwegian comments and labels; variable names like "butikk" (shop), "lager" (warehouse), "levering" (delivery), "navn" (name), etc.
- Extensive use of indicators and classic RPG patterns (GOTO, tags, subroutines).
- It is coded to support extensions: new delivery methods, more fields, etc., as shown in versions 6.20, 6.21, etc.
- Function keys and error handling provide robust interaction for users.

---

## Onboarding Takeaways

- **Display File (DSPF):** Study the screen definitions (B1SFL, B2CTL, etc.) to understand user interaction, field mappings, and indicator usage.
- **Subfile Logic:** Review subfile routines to get familiar with classic RPG subfile paging and cursor techniques.
- **Validation:** Note the validation points—these enforce data integrity before updates/writes.
- **Error Handling:** Error flags and indicator ranges (31–36) are set for field errors.
- **Extendibility:** To add new validation or screen fields, follow the same pattern of subroutine calls, display handling, and indicator management.

---

## Useful References

- IBM RPG IV Language Reference
- IBM Subfiles Programming Guide
- Supporting programs (RA510R, RA517R) and physical/logical file layouts (`anblpfr`, `anbhpfr`, etc.)

---

**If you're onboarding:**
- Begin by understanding the subfile loop and record processing.
- Map the display file fields to their database file origins.
- Understand the indicator flow, especially for error processing and function key handling.
- Step through the subroutines for creating, editing, copying, and deleting entries to fully grasp the CRUD workflow in this RPG application.