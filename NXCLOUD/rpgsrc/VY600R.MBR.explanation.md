# RPG Program VY600R - Explanation

This RPG (Report Program Generator) program is written in the ILE/400 environment (AS400/iSeries) using the traditional "fixed format" syntax. The program implements a subfile-based inquiry screen (for return codes, based on the comments) with various navigation and search features.

Below, you’ll find explanations for the key components and logic.

---

## 1. Header & Documentation

- `h option(*nodebugio) datedit(*dmy)`: Program options. Disables debug I/O and sets date editing to day-month-year.
- Extensive comments, including change log and indicator usage.

---

## 2. File Declarations (`F-specs`)

```rpg
fRA50l1    if   e           k disk    rename(RA50pfr:RA50l1r)
fRA50l2    if   e           k disk    rename(RA50pfr:RA50l2r)
```
- Physical files/tables, both keyed, for master data lookup, with record format rename.

```rpg
fVY600d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Display file, with subfile support (`b1sfl`) and display feedback structure (`dspfbk`).

---

## 3. Data Structures & Variables (`D-specs`)

- **Parameters:** `p_firm`, `p_dkod`, `p_dtxt` input values for firm, code, and text.
- **Display Feedback:** `dspfbk` DS, with `d_fcrn` for (sub)file cursor row.
- **Work fields:** Subfile navigation and selection (e.g., `w_fcrn`, `w_srrn`, `w_ssrn`).
- **Constants:** `c_sfil = 8` — subfile page size.

---

## 4. Indicator Usage (from comment block)

- Indicators (e.g., *IN10, *IN14, *IN15) control UI and logic:
    - *IN10, *IN11: Page navigation (Roll, Rolldown)
    - *IN14: Subfile clear
    - *IN15: Subfile end
    - *IN21, *IN22: Home key, cursor positioning
    - *IN31-*IN79: Errors/warnings
    - *IN80-*IN99: Work indicators

---

## 5. Main Program Flow

### Entry Point & Initialization

- **Program parameters** are loaded (`*entry` PLIST).
- **Key lists** (`klist`) are defined for both main files, for positioning by code or description.
- The program:
    - Sets up file position
    - Initializes subfile by calling `crt_subfile`

---

### Main Processing Loop

- **Tag-driven control** (old RPG style with `goto` and tags `b2taga`, `b2tagb`).
- Repeatedly displays/writes subfile screen (`write b2cmd`, `exsr dsp_subfile`), then waits for user input and acts accordingly:
    - **Function keys:** Roll up/down, reposition, refresh screen, exit.
    - **Subfile navigation:** Move to next/previous page (`crt_subfile`, `bck_subfile`).
    - **Selection:** If a row is selected (`b1valg=1`), extracts values and prepares to exit.

---

## 6. Subroutines

### `forny` – Refresh subfile

- Repositions DB cursor according to the current subfile state, clears & repopulates subfile.

### `posisjoner` – Position in subfile

- Moves to the first record that matches specified code or description, then repopulates subfile accordingly.

### `subfile` – Handle subfile interaction

- Alternates a cursor indicator.
- Loops through (readc) visible subfile records.
- Checks for selection; if found, sets output parameters and flags ready for exit.

### `clr_subfile` – Clear subfile

- Activates subfile clear indicator, writes a control record to clear, restores indicators and resets counters.

### `crt_subfile` – Populate subfile

- Fills the subfile with up to one "page" (`c_sfil`, default 8) records from the database. Handles selection between two different file sources (by code or description).

### `bck_subfile` – Page back in subfile

- Moves the file pointer back, skips one page, and then reconstructs the subfile.

### `dsp_subfile` – Display subfile

- If subfile is not empty, sets display control indicators and formats control record for user interaction.

---

## 7. Program Exit (`avslutt`)

- Sets *INLR to *ON to end the program and return to caller.

---

## 8. General Flow Summary

1. **Initialization:** Prepares subfile.
2. **User Interaction Loop:**
    - Waits for user input (function key, selection).
    - Handles paging, search, and selection.
    - Refreshes or repopulates the subfile when needed.
    - Exits when a selection is made or user presses exit keys.

---

## 9. Domain/Field Mapping

- **b1sfl, b2ctl, b2cmd:** Subfile records, control record, and command record for display file.
- **regfir, regkod, regtxt:** Fields from database records for firm, code, and text.
- **b1valg, b1dkod, b1dtxt:** Subfile fields corresponding to selection, code, and description.

---

## 10. Key Points

- **Subfile processing:** Classic AS/400 approach, including paging, search, and selection.
- **Navigation:** By code (default), or by description (if specified).
- **Indicators:** Heavily used for display and logic state.
- **Control structure:** Traditional, with tags and `goto`, as was common in legacy RPG.

---

## 11. Typical Usage

- User views a subfile (list) of codes and descriptions.
- User can page up/down, position by code/description, select a row.
- Selected values are returned to the caller.

---

**In summary:**  
This program is a robust, traditional RPG subfile handler, facilitating user-friendly selection of return codes with support for searching and paging, following best practices for green-screen applications on IBM i (AS/400/iSeries).