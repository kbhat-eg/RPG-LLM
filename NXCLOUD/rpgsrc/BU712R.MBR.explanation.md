## Program Overview

**System:** ASSHOP  
**Program:** BU712R  
**Description:** Store – Export of Price Code  
**Initial Release:** 2022-03-04 by HKO

This program is designed to export price code information for a specific company (firm) from the `vpkol1` file and write it to the `bopkst` file. It is part of the ASSHOP system and primarily handles the extraction and transformation of price code records for downstream processing or export.

---

## File Definitions and Relationships

- **vpkol1**  
  - Physical file, keyed, renamed as `vpkol1r` in this program.
  - Source of price code data (`vpkopfr` → `vpkol1r`).
  - Keyed read based on company/firm.

- **bopkst**  
  - Output file, update/add mode, renamed as `bopkstr` in this program.
  - Receives transformed price code records.

The program reads records from `vpkol1` for a specific firm (passed as a parameter) and writes selected fields to `bopkst`.

---

## Parameter Handling

- **p_firm**:  
  - Input parameter (from *ENTRY PLIST*).
  - Represents the company/firm code to filter price codes on.
  - Assigned to working variable `w_firm` during initialization.

---

## Key Variables

- **w_firm**:  
  - Working variable holding the firm code for processing.
  - Used in keyed access to `vpkol1`.

---

## Program Flow

### 1. Initialization (*INZSR)

- Receives the firm code via program parameter (`p_firm`).
- Assigns the parameter to working storage (`w_firm`).
- Sets up a key list (`vpkol1_key`) using `w_firm` for keyed access to `vpkol1`.

### 2. Main Processing

1. **Clear Output Record Format:**  
   - Clears the output record buffer (`bopkstr`) to ensure no residual data is written.

2. **Set Firm Code:**  
   - Assigns `w_firm` to `firm` (possibly a redundant or legacy step, but maintains convention).

3. **Read and Process Price Code Records:**  
   - Positions to the first price code record for the given firm using `SETLL` on `vpkol1`.
   - Reads the first matching record using `READE`.
   - Processes all price code records for the firm in a loop (`DOW %EOF = *OFF`):
     - Maps fields from `vpkol1` to output fields:
       - `kpri` = `vapkod` (price code)
       - `besk` = `vaptxt` (description)
       - `odat` = `vapeda` (date)
       - `edat` = `vapeda` (date, possibly for both original and effective date)
       - `etim` = `vapeti` (time)
       - `eusr` = `vapusr` (user)
     - Writes the output record to `bopkst`.
     - Reads the next record for the same firm using `READE`.

4. **Program Termination:**  
   - Sets LR indicator (`*INLR`) to `*ON` for program end.
   - Returns control.

---

## Business/Domain Logic

- **Exporting Price Codes:**  
  The main business logic is to export all price codes for a specific firm. Only records matching the firm code provided are processed.
- **Field Mapping:**  
  The program directly maps fields from the source file to the output file, with minimal transformation (e.g., both `odat` and `edat` are set to the same value from `vapeda`).

---

## Design Considerations and Conventions

- **Parameter Passing:**  
  The firm code is passed as a parameter, allowing the program to be reused for different firms without code changes.
- **Keyed Access:**  
  Uses a key list for efficient retrieval of relevant records from the source file.
- **File Renaming:**  
  Files are renamed in the F-specs to avoid naming conflicts and clarify which record formats are being used.
- **Record Buffer Clearing:**  
  The output record buffer is explicitly cleared before use, a common convention to prevent data leakage between records.

---

## Interactions with Other Modules

- **Downstream Consumers:**  
  The `bopkst` output file is likely used by other processes or systems for reporting, export, or integration purposes.
- **No External APIs:**  
  This program does not interact with APIs or external services; it is file-to-file processing within the IBM i environment.

---

## Notable Patterns

- **Initialization Subroutine:**  
  Uses *INZSR for setup, including parameter handling and key list initialization.
- **Legacy C-specs:**  
  The code uses traditional fixed-format RPG (C-specs), consistent with legacy IBM i coding standards.
- **Minimal Error Handling:**  
  The program assumes that input parameters and file states are always valid; there is no explicit error handling.

---

## Summary Table: Field Mapping

| Output Field (`bopkstr`) | Source Field (`vpkol1`) |
|--------------------------|-------------------------|
| kpri                     | vapkod                  |
| besk                     | vaptxt                  |
| odat                     | vapeda                  |
| edat                     | vapeda                  |
| etim                     | vapeti                  |
| eusr                     | vapusr                  |

---

## Customization and Extension

- **Adding More Fields:**  
  To export additional fields, extend the field mapping section and update the output record format.
- **Filtering Logic:**  
  If further filtering (e.g., by date or price code) is needed, enhance the loop condition or add additional logic before writing records.

---

## Summary

This program is a straightforward utility for exporting price code data for a specific firm from `vpkol1` to `bopkst`. It is designed for batch processing within the ASSHOP system, follows established IBM i conventions, and is structured for maintainability and reuse across firms.