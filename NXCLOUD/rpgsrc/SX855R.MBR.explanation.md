# SX855R â€“ Statistics Update Program Documentation

## Overview

**Program Name:** SX855R  
**System:** ASSTAT  
**Description:**  
This program is responsible for updating the statistics database with new fields and calculations. It processes statistical records (`sstal1`), enriches them with additional data from related files, invokes a pricing API, calculates various sales/cost metrics, and updates the statistics with these extended values.

**Business Context:**  
The program is part of the statistical subsystem, likely supporting sales, inventory, and financial reporting. It is intended to be run as a batch process, updating historical and current statistics with new business logic and calculated fields, reflecting changes in pricing, discounts, and product categorization.

---

## File Relationships and Data Flow

### Physical Files Used

- **sstal1**: Main statistics file (input), renamed from `sstapfr` to `sstal1r`.
- **rkunl1**: Customer master, renamed from `rkunpfr` to `rkunl1r`.
- **vvarl1**: Product master, renamed from `vvarpfr` to `vvarl1r`.
- **votyl1**: Order type master, renamed from `votypfr` to `votyl1r`.
- **bokkl1**: Card transaction file, renamed from `bokkpfr` to `bokkl1r`.
- **sstalu**: Statistics update file (output), renamed from `sstapfr` to `sstalur`.

### External Program/API Calls

- **VP905R**: Pricing and discount calculation API. Passed structured parameter lists (`hirec` for input, `horec` for output) to retrieve pricing, discount, and related codes.

---

## Key Data Structures

### Arrays

- `a_ordr` and `a_suff`: Arrays for order numbers and suffixes, dimensioned to 1000. Not directly used in the shown logic, possibly for future extensions or legacy compatibility.

### Local Data Area

- Used for workspace/user/firm context (`l_wsid`, `l_user`, `l_firm`).

### Key Variables

- Variables like `sstal1_paar`, `rkunl1_kund`, etc., are used to build keys for file access.

### Structured Parameter Lists

- **hirec/horec**: Data structures for passing complex parameter lists to/from the VP905R API. Carefully overlaid fields map to specific byte offsets, reflecting a fixed-format API contract.
- **d_hele**: Data structure for account information, with overlays for various account segments.

---

## Program Flow

### Initialization (`*inzsr`)

- Sets up key lists for each file based on the firm and relevant key fields.
- Retrieves the firm number from the local data area.

### Mainline

1. **Timestamp and Date Initialization**
    - Sets current time and a fixed date (`w_dato = 161214`).
    - Converts date to internal format.

2. **Processing**
    - Calls the `dann_total` subroutine to process all statistics for a given year.

3. **Program End**
    - Sets LR indicator and returns.

---

## Core Logic

### dann_total (Main Processing Loop)

- **Purpose:** Iterates through all statistics records for a given year (`sstal1_paar`), processes only those with a date before the reference date and blank price code (`sfpkon`).
- **For each qualifying record:**
    - Fetches related customer, product, and order type data via keyed access.
    - Invokes `utvid_stat` to perform extended statistics calculation and update.

---

### utvid_stat (Extended Statistics Calculation)

- **Purpose:** Enriches a statistics record with additional calculated fields and codes.

**Key Steps:**

1. **Reset Calculation Variables**
    - Calls `stat_null` to clear all working variables.

2. **Determine Transaction Date/Time**
    - Prefers cash register date/time; falls back to order date if unavailable.

3. **Prepare API Call to VP905R**
    - Populates the `hirec` structure with relevant data (firm, customer, product, etc.).
    - Calls VP905R to retrieve pricing, discounts, and codes into `horec`.

4. **Extract and Assign API Results**
    - Copies returned codes (e.g., price group, discount codes) from `horec` to local variables.

5. **Net Sales Price Calculation**
    - Starts with base price (`hosapr`).
    - Applies up to two discounts (`horab1`, `horab2`), reducing the net price accordingly.
    - If a line-level order discount applies, calculates and subtracts it per unit.

6. **Order Type Sign Adjustment**
    - If the order type indicates reversal (`vaokre = '-'`), negates the net sales amount.

7. **Net Sales and Cost Price Calculations**
    - Calculates both net and original sales/cost prices, including handling for special product types (e.g., "diverse" items).

8. **Price Code Assignment**
    - If differences between calculated and stored values exceed a threshold, marks price source as manual (`'MAN'`).

9. **Source and Contact Codes**
    - Determines source (`w_kild`) and contact/facturation (`w_kofa`) codes based on order type and system fields.

10. **Special Handling**
    - For certain product types (e.g., "diverse" or special card transactions), sets related fields to default or blank values.

11. **BM Card Processing**
    - If a card transaction is present (`sfbong`), loops through `bokkl1` to set card type codes as appropriate.

12. **Final Update**
    - Reads all matching statistics update records (`sstalu`) and updates them with the newly calculated fields.

---

### stat_null (Reset Working Variables)

- Zeroes all calculation and code variables prior to each statistics calculation. Ensures no carry-over between records.

---

### beregn_rabatt (Discount Calculation)

- Calculates total discounts for the transaction line.
- Sums up base and up to two additional discounts, updating the `w_sumr` variable.

---

## Design Details and Conventions

- **Field Naming:**  
  - Prefixes like `sf`, `rk`, `vv`, `br`, etc., denote source files or business entities (e.g., statistics file, customer, product, card).
  - Working variables use `w_` prefix, while parameter structure fields use `hi`/`ho` (for input/output).

- **Key Lists:**  
  - All file access is performed via explicit key lists, with `setll`/`reade` or `chain` instructions.

- **API Integration:**  
  - The program integrates with VP905R via explicit parameter lists, using overlays for precise field mapping (legacy convention for performance and fixed-format compatibility).

- **Conditional Logic:**  
  - Many business rules are conditional on product type, order type, or data source, reflecting complex real-world pricing and discount scenarios.

- **Commenting and Change History:**  
  - The source is heavily annotated with both business logic explanations and change history, indicating a codebase with significant legacy and ongoing maintenance.

---

## Notable Business/Domain-Specific Logic

- **Discount Handling:**  
  - Discounts may be applied at multiple levels (line, order, etc.), and the logic ensures correct stacking and application order.

- **Price Code Assignment:**  
  - If calculated and stored values diverge significantly, the system marks the price source as manual, signaling potential data issues or manual intervention.

- **Product Type Handling:**  
  - "Diverse" products and special card transactions are treated distinctly, often bypassing standard calculations.

- **Order Type Sign Adjustment:**  
  - Some order types (e.g., returns or credit notes) require negation of sales/cost values.

---

## Interactions with Other Modules

- **VP905R:**  
  - Central to pricing and discount calculation. Any changes to the API contract or logic in VP905R will directly impact SX855R.

- **Master Files:**  
  - Accurate and up-to-date customer, product, and order type data are essential for correct statistics calculations.

---

## Summary

SX855R is a core batch utility for extending and recalculating statistics records with new business logic around pricing, discounts, and categorization. It is tightly integrated with the pricing API (VP905R) and several master data files. The program is designed for robustness and traceability, reflecting years of incremental business-driven enhancements. Any onboarding developer should familiarize themselves with the parameter structures, key list conventions, and the external pricing API to effectively maintain and extend this code.