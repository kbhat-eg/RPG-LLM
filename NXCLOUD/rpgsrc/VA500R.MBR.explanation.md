# RPG Program Explanation: VA500R

This ILE RPG program, named `VA500R`, is designed for querying bonus templates (Bonussmaler, spørring). It uses subfiles to display and interact with lists of bonus information, allowing the user to page through, position to, and select entries.

---

## Structure Overview

- **Header (`H`) Spec**:  
  `option(*nodebugio) datedit(*dmy)`  
  Indicates no debug I/O and that dates are in day-month-year format.

- **File Definitions (`F`)**:
    - `embhir` and `vbotl1`: Database files, externally described, with key access. Used for reading bonus data.
    - `va500d`: Workstation file (display file) with a subfile (`b1sfl`), controlled by the `w_srrn` variable.

---

## Data Definitions (`D` Spec)

- **Parameters**:
    - Variables such as `p_firm`, `p_tbot`, `p_hmnr`, `p_mbes`, `p_tbes` are set up to receive/pass parameters (likely from a calling program).

- **Key/Index Variables**:
    - `vbotl1_tbot`, `embhir_tbot`: Used as keys for positioning in the associated database files.

- **Work Variables**:
    - Subfile navigation: `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`
    - Others: `w_seqe`, `b_valg_ok`, `w_firm`, etc.
    - `c_sfil`: Constant, subfile page-size (`8`).

---

## Indicator Usage

The comments document system-wide usage for indicators:
- 10: Roll
- 11: Rolldown
- 12-15: Subfile control (display, clear, end, etc.)
- 21-22: Home key, cursor position
- 30: Field protection
- 31-99: Various warnings, error messages, work indicators

---

## Program Flow

### Initialization (`*inzsr`)

- Entry parameters are assigned to working variables.
- Key-lists (`klist`) set up for database positioning.
- Clears and positions the main file (`embhir`) and creates the initial page of the subfile.

---

### Main Processing Loop

The main body is formed by a loop using two tags:  
- `b2taga` (Display command screen)
- `b2tagb` (Display data, handle actions)

Each iteration does the following:
1. **Display Command Screen (`b2taga`)**:  
   - Writes the command screen (`b2cmd`) to the display.

2. **Display Subfile and Page Logic (`b2tagb`)**:  
   - Calls `dsp_subfile` to display the subfile.
   - Calculates the current subfile page (`w_sfrn`) if a record is selected.
   - Handles function keys via SELECT/WHEN:
     - Exit (`F3/F12`)
     - Refresh (`F5`)
     - Paging up/down (`F10/F11`)
     - Home/positioning (`F21`)
   - Uses field `b2tbot` for direct positioning.
   - Calls `subfile` routine for subfile processing (see below).
   - On valid selection (`b_valg_ok`), ends the program.

---

### Subroutines

#### 1. `forny` – Refresh Subfile
- Chain (positions to) the first subfile record if present.
- Clears and refills the subfile for refreshed data.

#### 2. `posisjoner` – Position in Subfile
- If a bonus type (`b2tbot`) is entered, positions the file pointer.
- Clears and recreates the subfile based on the new position.

#### 3. `subfile` – Subfile Handling
- Toggles the subfile display indicator.
- Loops through subfile records:
    - Reads changed records (`readc b1sfl`).
    - If "select" (`b1valg=1`) is detected, sets parameters for return and ends routine.

#### 4. `clr_subfile` – Clear Subfile
- Sets subfile-clear indicator, writes control record.
- Resets subfile navigation variables.

#### 5. `crt_subfile` – Create/Fill Subfile
- Increments the subfile page.
- Reads main record file and writes subfile records up to page size.
- For each, tries to look up a description in the related file (`vbotl1`).
- Sets `*in15` (end-of-subfile/page) if file ends or no more data for the firm.

#### 6. `bck_subfile` – Page Up in Subfile
- If end-of-subfile, positions to the start of previous page.
- Reads back through the file by one page worth of records.
- Once positioned, clears and refills the subfile.

#### 7. `dsp_subfile` – Display Subfile
- If the subfile has records, activates subfile display indicator (`*in12`).
- Formats the control screen for display (`exfmt b2ctl`).
- Turns off display indicators afterward.

---

## Subfile Design Explanation

- Subfiles are used for efficient management of list display, paging, and selection.
- `w_srrn`, `w_sfrn`, `w_ssrn` are used for managing the range of subfile records displayed per page.
- Subfile indicators control screen refresh, clearing, end-of-list, etc.
- User can move forward/backward a page, re-position, and select entries.

---

## Summary Table

| Function           | Routine / Key   | Main Actions                                                |
|--------------------|-----------------|-------------------------------------------------------------|
| Initialization     | *inzsr          | Sets up variables, positions DB, creates 1st subfile page   |
| Query loop         | b2taga/b2tagb   | Displays subfiles, handles keys, processes user actions     |
| Subfile Handling   | subfile         | Reads user selection, sets parameters for output            |
| Paging Forward     | crt_subfile     | Reads/creates next page in subfile                          |
| Paging Backward    | bck_subfile     | Reads previous page, refills subfile                        |
| Position to Entry  | posisjoner      | Positions DB file based on input, resets subfile            |
| Clear Subfile      | clr_subfile     | Resets subfile and navigation variables                     |
| Display Subfile    | dsp_subfile     | Shows subfile on-screen, manages display indicators         |

---

## Key Takeaways

- **Subfiles** are central to displaying lists and handling user selection efficiently in RPG display programs.
- **Indicators** (`*INxx`) manage display and navigation logic with specific meanings for navigation, display, warnings, etc.
- The program **accepts parameters**, displays a list of bonus templates, provides navigation via function keys, supports direct positioning, and allows the user to select an item from the list for processing or return.

---

This code demonstrates classic subfile handling and user navigation in a green-screen IBM i (AS/400) environment, providing a solid template for screen-based list processing and selection.