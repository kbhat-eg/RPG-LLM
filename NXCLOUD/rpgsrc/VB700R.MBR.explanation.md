```markdown
# Program VB700R Overview
This ILE RPG program retrieves “bruksrett” (usage right) and discount information for a given product (`p_vare`) within a specified “almenning” (`p_alme`).

---

## 1. Control Options
- `option(*nodebugio)`  
- `datedit(*dmy)`

---

## 2. File Specifications
(Files are all keyed disk files; some are “rename”d to avoid name clashes.)

- FVARL1  → renamed to VVARL1R  
- FJVARL1 → renamed to JVARL1R  
- FVBRKL1 → renamed to VBRKL1R  
- FVBRKL5 → renamed to VBRKL5R  
- FRMBTL1 → renamed to RMBTL1R  

Each file provides lookup tables for:
  - Product master (`VVARL1R`, `JVARL1R`)
  - Usage‐right links at module/variant group levels (`VBRKL1R`, `VBRKL5R`)
  - Bruksrett type details (`RMBTL1R`)

---

## 3. Parameter Definitions
IN/OUT parameters passed to the program:
- `p_firm`  (Company)      – like `VB_FIRM`
- `p_alme`  (Almenning)    – like `VB_ALME`
- `p_vare`  (Product)      – like `VB_VARE`
- `p_brty`  (Bruksrett type) – like `VB_BRTY`
- `p_brr1`  (Discount 1)   – like `RM_TRA1`
- `p_brr2`  (Discount 2)   – like `RM_TRA2`
- `p_omva`  (Other MVA info) – like `RM_TMVA`

---

## 4. Work Fields for Key Lookups
- Product lookups:  
  - `vvarl1_vare`, `jvarl1_vare`
- Bruksrett link lookups:  
  - `vbrkl1_ogrp` (operating group),  
  - `vbrkl1_hgrp` (head group),  
  - `vbrkl1_ugrp` (user group),  
  - `vbrkl1_modn` (module number),  
  - `vbrkl1_vare`
- Alternate bruksrett link (level 5):  
  - `vbrkl5_vare`
- Bruksrett type lookup field:  
  - `rmbtl1_tbrt`

---

## 5. Additional Work Variables
- `w_firm`, `w_alme`  – copies of input parameters for key lists

---

## 6. Main Logic Flow

### 6.1. Early Exit Conditions
If no `p_alme` or blank `p_vare`, jump to **avslutt** (cleanup/return).

### 6.2. Retrieve Product Master
1. Set `vvarl1_vare = p_vare`  
2. `CHAIN` on `VVARL1`  
   – If found, product data is in `VB…` fields.  
   – If not found, try `JVARL1`:  
     - Set `jvarl1_vare = p_vare`, `CHAIN` on `JVARL1`.  
     - If found, map `jvogrp→vvogrp`, `jvhgrp→vvhgrp`, `jvugrp→vvugrp`, `jvmodn→vvnmod`.  
     - If still not found, exit.

### 6.3. Find Bruksrett Link (Usage Right)
1. **Level 5**:  
   - `vbrkl5_vare = p_vare`, `CHAIN` on `VBRKL5`.  
2. If not found, try **Level 1** cascading key reduction:  
   - Initialize key fields from product groups/module.  
   - Attempt `CHAIN` on `VBRKL1`.  
   - If not found, zero‐out `modn` and retry.  
   - If still not found, zero‐out `ugrp` and retry.  
   - If still not found, zero‐out `hgrp` and retry.  
   - If still not found, exit.

### 6.4. Capture Bruksrett Type
- `p_brty = VBBRTY` (from the found bruksrett record)

### 6.5. Retrieve Discount Details
- `rmbtl1_tbrt = p_brty`, `CHAIN` on `RMBTL1`.  
- If found, map:  
  - `p_brr1 = RMTRA1`  
  - `p_brr2 = RMTRA2`  
  - `p_omva = RMTMVA`

### 6.6. Cleanup & Return (`avslutt`)
- `*INLR = *ON`  
- `RETURN`

---

## 7. Initialization Subroutine (*INZSR)
Called automatically at program start.

### 7.1. Parameter List
- Receives all `p_firm, p_alme, p_vare, p_brty, p_brr1, p_brr2, p_omva`

### 7.2. Key Lists Definitions
- **VVARL1_KEY**: `w_firm`, `vvarl1_vare`  
- **JVARL1_KEY**: `jvarl1_vare`  
- **VBRKL1_KEY**: `w_firm`, `w_alme`, `vbrkl1_ogrp`, `vbrkl1_hgrp`, `vbrkl1_ugrp`, `vbrkl1_modn`, `vbrkl1_vare`  
- **VBRKL5_KEY**: `w_firm`, `w_alme`, `vbrkl5_vare`  
- **RMBTL1_KEY**: `w_firm`, `w_alme`, `rmbtl1_tbrt`

### 7.3. Initial Assignments
- `w_firm = p_firm`  
- `w_alme = p_alme`  
- Clear output parameters:  
  - `p_brty = 0`  
  - `p_brr1 = 0`  
  - `p_brr2 = 0`  
  - `p_omva = *BLANK`  

_End of program explanation._  
```