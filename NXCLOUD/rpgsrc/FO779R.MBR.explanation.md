# FO779R â€“ Sales Statistics Reader and ByggDok Exporter

## Overview

**Program:** FO779R  
**System:** ASOFAK  
**Description:**  
This program reads sales statistics within a specified date range and exports entries to the ByggDok (construction documentation) and/or Cobuilder systems. The process is controlled by module activations and customer/project settings. The program ensures that exports are not duplicated for the same order or receipt.

## Business Context

- **ByggDok** and **Cobuilder** are third-party systems used for construction documentation and compliance.
- The program is designed to automate the export of sales data to these systems, based on configuration and presence of relevant modules.
- Only new or unexported orders/receipts are processed, to prevent duplicate exports.

## File Usage and Relationships

- **sstal5**: Main sales statistics file (aliased as `sstal5r`).
- **rkunl1**: Customer master (aliased as `rkunl1r`).
- **fkprl1**: Customer-project linkage (aliased as `fkprl1r`).
- **afpslr**: Module properties, for feature toggling (aliased as `afpslrr`).
- **rukpl6**: Customer roles (aliased as `rukpl6r`).
- **amodl1**: Module master, determines if ByggDok or Cobuilder modules are active (aliased as `amodl1r`).
- **fbdol1**: ByggDok export log, used to check if an order/receipt has already been exported (aliased as `fbdol1r`).
- **fbdopf**: ByggDok export file (output).

## Key Program Flow

### Initialization (`*inzsr`)

- Receives parameters: from-date, to-date, ByggDok flag, Cobuilder flag.
- Reads the local data area for company and user info.
- Checks if ByggDok and/or Cobuilder modules are active by looking up `amodl1` and verifying PDF activation in `afpslr`.
- Calls an external program (`CO402R`) to check if NOBB number is required for Cobuilder exports (sets `u_s701` flag).

### Main Processing

- If either ByggDok or Cobuilder is enabled, the `oppdater` (update) subroutine is called.
- The main subroutine does the following:
  1. **SQL Cursor**: Selects sales records (`sstapf`) joined with customer (`rkunpf`) and customer role (`rukppf`) tables, filtered by date and presence of either NOBB number or product code.
     - Note: The code previously filtered on `rukrol` (role), but this is commented out as of version 8.01.
  2. **For Each Record**:
     - Checks if the customer-project combo is configured for ByggDok or Cobuilder export via `fkprl1`.
     - If so, sets flags (`b_bdo2` for ByggDok, `b_cob2` for Cobuilder).
     - Checks if the order/receipt has already been exported by looking up `fbdol1` (prevents duplicates).
     - If not previously exported, prepares an export record:
       - Copies relevant customer, project, order, and contact info.
       - Handles special cases for contact person and email, using project overrides if present.
       - Sets timestamps and user info.
       - Writes the record to the ByggDok export file (`fbdopf`).
  3. **End of Data**: Closes the cursor and exits.

### Exit

- Sets LR indicator and returns.

## Notable Design Decisions and Conventions

- **Module Activation:**  
  Activation of ByggDok and Cobuilder is controlled by presence of records in `amodl1` and corresponding PDF activation in `afpslr`. This allows for dynamic feature toggling per company/installation.
- **Idempotency:**  
  The program checks for existing exports in `fbdol1` using order or receipt numbers as keys, ensuring that exports are not duplicated even if the program is run multiple times for the same period.
- **Role Filtering:**  
  Originally, only records with customer role `BYGGDOK` or `COUBUILDER` were selected, but this check has been disabled (see version 8.01 comment). Now, the presence of NOBB number or product code is sufficient for inclusion.
- **Contact Info Resolution:**  
  If customer-project specific contact info (`flmail`, `flkprs`) is available, it overrides customer-level info.
- **External Configuration:**  
  The use of external program `CO402R` allows for customer-specific business rules (e.g., whether NOBB number is required for Cobuilder).
- **Parameterization:**  
  The program is parameter-driven, making it suitable for batch or scheduled execution.

## Key Variables and Structures

- **Parameters:**
  - `p_fdat`, `p_tdat`: Date range for sales selection.
  - `p_bdok`, `p_cobu`: Flags for ByggDok/Cobuilder export.
- **Flags:**
  - `b_bdo1`, `b_bdo2`, ...: ByggDok activation and processing states.
  - `b_cob1`, `b_cob2`, ...: Cobuilder activation and processing states.
  - `b_eof`: End-of-file indicator for cursor processing.
- **User/Company Info:**  
  Retrieved from the local data area (LDA) at startup.

## Integration Points

- **Database:**  
  Heavy use of native I/O and embedded SQL for data retrieval and joins.
- **External Program:**  
  Calls `CO402R` for business rule evaluation (Cobuilder NOBB requirement).
- **Output:**  
  Writes to ByggDok export file, which is presumably picked up by downstream processes or integrations.

## Version Notes

- **8.01:**  
  Removed filtering on customer role (`RUKROL`).
- **8.02:**  
  Added logic to prevent duplicate exports by checking for existing order/receipt in `fbdol1`.

## Summary Table: Main Process Steps

| Step | Action                                  | File(s) Involved     | Purpose/Notes                                   |
|------|-----------------------------------------|----------------------|-------------------------------------------------|
| 1    | Initialize, read parameters & LDA       | LDA, amodl1, afpslr | Setup, feature activation                       |
| 2    | Call CO402R for Cobuilder NOBB check    | CO402R               | Business rule for Cobuilder export              |
| 3    | If ByggDok/Cobuilder active, process    | sstal5, rkunl1, ...  | Main loop, fetch sales data                     |
| 4    | For each record:                        |                      |                                                 |
| 4.1  |   - Check customer-project settings     | fkprl1               | Determine if export is needed                   |
| 4.2  |   - Check for existing export           | fbdol1               | Prevent duplicate export                        |
| 4.3  |   - Prepare and write export record     | fbdopf               | Export to ByggDok/Cobuilder                     |
| 5    | Exit                                    |                      | Set LR, return                                  |

## Maintenance and Extension

- **Adding new export types**: Extend module checks and export logic, following the existing pattern.
- **Changing business rules**: Update SQL selection, module activation, or external program logic as needed.
- **Performance**: The use of cursors and chained lookups is efficient for the expected data volumes, but review if scaling up.

---

**Contact:**  
For further details on business logic or integration points, consult the functional specification or contact the system architect.