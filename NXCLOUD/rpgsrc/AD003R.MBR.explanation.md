# Program AD003R – “Spærring på Rutiner” (Order‐type Blocking)

## Overview
AD003R presents an interactive subfile screen of routines (from file IADRPF) so the user can select one by code or description for downstream “blocking” logic. It returns the chosen routine code (`p_drut`) and text (`p_drtx`) to the caller.

## Interfaces & Parameters
- Entry parameters (via PLIST/INZSR):
  - `p_firm` – Company code (IADFRM)
  - `p_drut` – Routine code (IADRUT) – OUT parm
  - `p_drtx` – Routine text (IADRTX) – OUT parm
  - `p_stat` – Status flag (not used in this module)

## Files & Keys
- **IADRL1** and **IADRL2** – two logical views of the same physical file `IADRPF`:
  - IADRL1 keyed on `(firm, routine-code)`
  - IADRL2 keyed on `(firm, routine-text)`
- By renaming the same PF twice, the program can position/read by either key without resetting the file context.

## Subfile Design
- Control record: **B2CTL**
- Command-only screen: **B2CMD**
- Detail record: **B1SFL**
- Page size constant: `c_sfil = 7`
- Paging variables:
  - `w_spge` – last page’s max record number
  - `w_sfrn` – first record on current page
  - `w_ssrn` – last record on current page
  - `wvisrn` (through DSP logic) – record to position cursor on

## Main Processing Loop
1. **Initialize** (`*INZSR`):
   - Load `w_firm` from `p_firm`.
   - Position `IADRL1` at blank key to start at top.
   - Call `crt_subfile` to load the first page.

2. **Display Control** (`B2CTL`):
   - First, show the function‐key help via `write B2CMD`.
   - Then execute subfile display (`dsp_subfile`).

3. **Handle PF‐keys**:
   - PF3/PF12 (`*INKC`/`*INKL`): exit (sets `*INLR`).
   - PF5 (`*INKE`): refresh search – calls `forny` (which `SETLL` by the last search key, clears & rebuilds subfile).
   - PF10 (`*IN10`): page down – calls `crt_subfile`, then re‐display.

4. **Positioning Search**:
   - If either search field (`b2drut` or `b2drtx`) is entered:
     - `posisjoner` sets `w_seqe` to blank (code) or ‘B’ (beskrivelse/description), loads the appropriate key fields, does `SETLL` on IADRL1 or IADRL2, then clears & rebuilds subfile from that point.
     - Clears the input search fields afterward.

5. **Record Selection**:
   - Calls `subfile` to scan the displayed page:
     - Uses `READC B1SFL 16` to read through subfile records.
     - On user‐mark (`b1valg = '1'`), captures `b1drut`/`b1drtx` into OUT parms and sets `w_valg_ok = *ON` to exit.

6. **Loop** back to control display or exit if `w_valg_ok` is set.

## Key Subroutines
- **forny**  
  Chooses last search mode (`w_seqe`), does `SETLL` on correct key, then calls `clr_subfile`/`crt_subfile`.

- **posisjoner**  
  If a search value is entered, set up the corresponding key (code or text), `SETLL`, then clear & rebuild.

- **clr_subfile**  
  Clears the subfile control (sets `*IN14`/`*IN15` to clear & reset page counters to 0).

- **crt_subfile**  
  - Increments page marker `w_spge` by 7.
  - Reads up to that new limit from the selected file logical view.
  - Stops when EOF (`*IN15`) or firm code mismatch.
  - Writes each record into **B1SFL**, resets page counters `w_sfrn`, `w_ssrn`, and positions cursor on first record of page.

- **subfile**  
  Scans the populated records with `READC` to catch the user’s selection flag.

- **dsp_subfile**  
  Sets indicators for presence of data, displays **B2CTL** via `EXFMT` and preserves cursor positioning.

## Conventions & Notes
- The program uses indicators 60–69 on file operations (e.g. `READ 15`, `READC 16`).
- `w_seqe` = blank ⇒ search by routine code; = ‘B’ ⇒ by description.
- Page size is fixed at 7; logic for page‐down only (no explicit page‐up).
- `p_stat` is defined but unused here – may be a placeholder for future “status‐based” filtering.