## Program BL710R Documentation

### Overview

**Program Name:** BL710R  
**System:** ASOFAK  
**Purpose:**  
This program retrieves product type (`varetype`), outgoing date (`utg.dato`), and supplier number (`lev.nr`) from warehouse and product master files, based on company, item, and warehouse input.

**Inputs:**  
- Company (`firma`)
- Product (`vare`)
- Warehouse (`lager`)

**Outputs:**  
- Product type (`varetype`)
- Outgoing date (`utg.dato`)
- Supplier number (`lev.nr`)

### Business/Domain Context

This program supports inventory and product master lookups for the ASOFAK system. It is designed to handle both environments with and without warehouse management, adapting its logic accordingly. The main use case is to determine the product type and related data for a given item in a specific warehouse and company context, which is critical for downstream logistics, pricing, and reporting processes.

### File Usage

- **VLAGL1** (Warehouse Master, renamed from VLAGPFR): Used for warehouse-specific information.
- **VVARL1** (Product Master, renamed from VVARPFR): Used for general product information.
- **FSTSL1** (Company Settings, renamed from FSTSPFR): Used to determine if warehouse management is active (`faalag` flag).

### Key Variables

- `p_firm`, `p_vare`, `p_lage`: Input parameters (company, product, warehouse).
- `p_vtyp`: Output parameter for product type.
- `p_udat`: Output parameter for outgoing date.
- `p_ldor`: Output parameter for supplier number.
- `p_inlr`: Output parameter, determines whether to set LR indicator.
- `faalag`: Flag from FSTSL1 determining if warehouse management is active.

### Main Logic Flow

1. **Initialize Output Parameters**
   - `p_vtyp` is set to blank.
   - `p_udat` is set to *loval (lowest value, i.e., blank date).
   - `p_ldor` is set to 0.

2. **Check Warehouse Management Flag**
   - If `faalag = 1`, warehouse management is active:
     - Attempt to retrieve data from the warehouse master (VLAGL1) using company, product, and warehouse as keys.
     - If found:
       - Set `p_vtyp` to the product type from VLAGL1 if available.
       - Set `p_udat` and `p_ldor` if present.

3. **Fallback to Product Master**
   - If `p_vtyp` is still blank, retrieve from product master (VVARL1) using company and product as keys.
   - If found, set `p_vtyp`.

   - If `p_udat` is still *loval, retrieve from VVARL1:
     - If `vvudat` is not set, attempt to use `vvnuda` (special field for outgoing date).
   - If `p_ldor` is still 0, retrieve from VVARL1.

4. **Program Termination**
   - If `p_inlr` is not set to *on, set LR indicator to *on (end job).

### Special/Non-Obvious Logic

- **Warehouse Management Handling:**  
  The flag `faalag` (from FSTSL1) determines if warehouse-level logic should be used. If not, the program only uses the product master file.

- **Date Fallback:**  
  If the outgoing date is not found in the primary field, the code checks an alternative field (`vvnuda`). This is a business-specific extension for handling NOBB (Norwegian Building Products Database) outgoing dates.

- **Supplier Number Logic:**  
  The supplier number (`ldor`) is fetched from both warehouse and product master, depending on what is available.

- **Parameter Passing:**  
  All input/output parameters are passed via the program parameter list, allowing for use as a callable subroutine or service program.

- **INLR Handling:**  
  The `p_inlr` parameter is used to control whether the program sets the LR (Last Record) indicator, which is important for resource management when called as a subprocedure.

### Patterns and Conventions

- **File Renaming:**  
  Files are renamed for clarity and isolation of record formats.

- **Key Lists:**  
  KLIST/KFLD are used for key management, standardizing access patterns for file operations.

- **Change Log:**  
  Extensive in-code change log documents business-driven enhancements, such as handling for NOBB outgoing dates and changes in warehouse management logic.

- **Parameter Initialization:**  
  All output parameters are explicitly initialized at the start of the main logic to ensure predictable behavior.

### External Relationships

- **VLAGL1 (Warehouse Master):** Primary source for warehouse-specific product data.
- **VVARL1 (Product Master):** Fallback source for product data when warehouse data is missing or not applicable.
- **FSTSL1 (Company Settings):** Determines if warehouse management logic applies for the current company.

### Summary

BL710R is a utility program for retrieving product classification and related logistics data, designed to flexibly support both warehouse-managed and non-warehouse-managed environments. It prioritizes warehouse-specific data but reliably falls back to product master data, and contains business-specific date logic for the Norwegian market. The program is robustly parameterized and maintains clear separation of concerns through its use of key lists, file renaming, and explicit control flow.