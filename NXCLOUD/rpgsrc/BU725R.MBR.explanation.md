# Documentation for Program BU725R (ASSHOP)

## Overview

**Program:** BU725R  
**System:** ASSHOP  
**Purpose:** Export product (item) information for stores ("Butikk, eksport av vareinformasjon").  
**Domain:** Retail, Inventory, and Pricing  
**Summary:**  
This program collects and exports detailed product information, including associated units, prices, and EAN numbers, from the central inventory and pricing system. It supports incremental export based on change dates/times and handles complex business rules for units, prices, and supplier relationships.

---

## High-Level Flow

1. **Initialization:**  
   - Sets up parameters, keys, and working variables.
   - Reads input parameters: company, date, time, and optionally POS (cash register).
   - Determines which warehouse and price group to use.

2. **Main Processing:**  
   - Iterates over all items (`vvarl1`), exporting full information for each.
   - If a change date/time is specified, also exports items with changed units, prices, or EAN numbers since that point.

3. **Subroutines:**  
   - `vareinfo`: Gathers and exports all main product data.
   - `enheter`: Exports all units and their prices for the current item.
   - `priser`: Exports all relevant prices for a given item/unit.
   - `ean`: Exports all EAN numbers for the item.

---

## File Usage and Relationships

### Input Files

- **vvarl1**: Master item file (renamed from vvarpfr).
- **vvsol1**: Item search text (renamed from vvsopfr).
- **vvenl1/vvenl2**: Item unit definitions (renamed from vvenpfr).
- **vvepl1**: Item unit per supplier (renamed from vveppfr).
- **vvprl1/vvprlr**: Item price files (renamed from vvprpfr).
- **veanl1/veanl2**: EAN number files (renamed from veanpfr).
- **rlevl1**: Supplier master (renamed from rlevpfr).
- **ra26l1**: Product manager/owner (renamed from ra26pfr).
- **vmvalr**: VAT code master (renamed from vmvapfr).
- **bkasi1**: POS/warehouse relationship (renamed from bkasst) â€“ used if POS is specified.
- **vvlel1**: Timber assortment (for special product types).

### Output Files

- **bovast**: Main product export.
- **bovest**: Product unit export.
- **bovpst**: Product price export.
- **boeast**: EAN number export.

---

## Key Business Logic and Design Decisions

### Incremental Export

- If a change date/time is given, only exports items (and related units, prices, EANs) changed since then.
- Otherwise, exports all items.

### Price and Unit Resolution

- Handles complex rules for selecting prices:
  - Tries to find price for the relevant group and supplier.
  - Falls back to main supplier or no supplier if not found.
  - Handles both with and without price group.
- Exports all units for each item, including conversion factors and physical dimensions.

### EAN Export

- Exports all EANs related to the item, both via item-unit-supplier relationship and generic EAN records.

### Extensibility

- The program is versioned and regularly updated for new requirements (e.g., timber assortment, price group extension, POS integration).
- New fields and logic are clearly marked with version comments.

### External Program Calls

- Calls `VL710R` to fetch item type and associated warehouse/supplier/assortment data.
- Calls `VL711R` to fetch price group.

---

## Detailed Structure

### Initialization (`*inzsr`)

- Receives parameters: company, date, time, and optionally POS.
- Sets up all key lists for file access.
- Determines warehouse (`w_lage`) based on POS if given.
- Fetches price group via `VL711R`.

### Main Loop

#### Export All Items

- Loops over all items in `vvarl1`.
- For each item:
  - If no change date/time is specified, always exports.
  - If change date/time is specified, only exports if the item was changed since then.

#### Export Incremental Changes

- If change date/time is specified, also scans:
  - **Units (`vvenl1`)**: Exports items with changed units.
  - **Prices (`vvprl1`)**: Exports items with changed prices.
  - **EANs (`veanl1`)**: Exports items with changed EANs.
- For each, checks if the change date/time is after the given parameter.

### Subroutines

#### `vareinfo`

- Calls `VL710R` to gather extended item info (type, assortment, etc.).
- Collects and writes all main item fields to `bovast`.
- Looks up supplier name and product manager name.
- Retrieves search text.
- Calls `enheter` and `ean` subroutines for related data.

#### `enheter`

- Loops through all units for the item in `vvenl2`.
- Writes each unit to `bovest`.
- For each unit, attempts to export all prices via the `priser` subroutine:
  - Tries various combinations of price group and supplier, as described above.

#### `priser`

- Loops through all price records for the item/unit/supplier/price group.
- Exports both current and future prices.
- Writes each price to `bovpst`.

#### `ean`

- Exports EAN numbers from two sources:
  - Item-unit-supplier EANs (`vvepl1`), if present.
  - Generic item EANs (`veanl2`).

---

## Notable Implementation Details

- **Key Management:**  
  All file access is via dynamic key lists, built in the initialization subroutine for maintainability.
- **Change Tracking:**  
  The program supports both full and incremental exports, using date/time logic to identify changed records.
- **Multi-Level Price Resolution:**  
  The price lookup logic is robust, trying multiple fallback options to ensure a price is always exported if possible.
- **Extensive Use of External Reference Data:**  
  Supplier names, VAT codes, product manager names, and warehouse assignments are all resolved via reference files.
- **Version Control in Comments:**  
  All major changes are annotated with version numbers and brief descriptions, aiding maintainability.

---

## Interactions with Other Modules

- **VL710R:**  
  Called to retrieve extended item and assortment information, including warehouse and supplier for the item.
- **VL711R:**  
  Called to retrieve the price group for the current context (e.g., store or POS).

---

## Naming Conventions and Patterns

- **File Renaming:**  
  All files are renamed to local record formats for clarity.
- **Subroutine Naming:**  
  All business logic is modularized into subroutines (`vareinfo`, `enheter`, `priser`, `ean`).
- **Variable Prefixing:**  
  Working variables and key variables are consistently prefixed for readability.

---

## Summary

This program is central to the export of item master data for the retail system. It is designed to be robust and maintainable, supporting both full and incremental exports, with comprehensive logic for units, prices, and supplier relationships. The codebase is well-annotated with version history and follows clear naming and modularization conventions, making it approachable for experienced RPG developers. 

For further onboarding, new developers should familiarize themselves with the data model (especially the files listed above), the external programs called, and the business rules around price and unit selection.