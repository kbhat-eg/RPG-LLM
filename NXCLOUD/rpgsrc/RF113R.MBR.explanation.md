# RF113R â€“ Label Printing per Voucher

## Overview

**Program:** RF113R  
**System:** ASOKON  
**Purpose:** Prints labels per voucher ("etiketter pr bilag").  
**Domain:** Likely financial or logistics, handling voucher-based transactions and inventory labels.  
**Notes:**  
- The program has evolved to handle label printing for warehouse transactions and is switch-controlled for logging and integration with other modules.
- Norwegian comments and variable names are used throughout; familiarity with the business terminology is beneficial.

---

## Structure and Flow

### File Definitions

- **frjoupf**: Main input file (likely voucher journal), keyed access.
- **fraa1l1**: Another input file, renamed to `raa1l1r` in the program, keyed access.

### Key Variables

- **l_user / wpuser**: Current user.
- **l_firm / w_firm**: Current company/firm code.
- **w_mem3 / w_memb**: Member or group identifier.
- **w_nivo, w_sort**: Key components for file access.
- **w_rjfirm, w_rjraar, w_rjrper, w_rjtype, w_rjbunt, w_rjbiln**: Current record's key fields (company, year, period, type, batch, voucher number).
- **u_logg**: Logging switch, set based on configuration.

### External Program Calls

- **AB700R, AB705R**: Logging/auditing programs, called at start and end if logging is enabled.
- **RF011C**: Label printing program, called when specific conditions are met.
- **CO402R**: Configuration program, used to determine if logging should be enabled.

---

## Main Processing Logic

### Initialization (`*inzsr` subroutine)

- Receives `wpuser` and `w_mem3` as parameters.
- Sets up firm code and warehouse code.
- Builds key lists for file access.
- Calls **CO402R** with parameters to check if logging should be enabled; sets `u_logg` accordingly.

### Main Loop

1. **Logging Start (if enabled):**  
   Calls AB700R and AB705R to log the start of the program.

2. **Prepare for Processing:**  
   - Clears `w_nivo`.
   - Sets `w_memb` from input.
   - Positions to the first relevant record in `rjoupf`.

3. **Main Read Loop (`dummy` tag):**  
   - Reads next record from `rjoupf`.
   - If EOF, logs end (if logging enabled), sets LR, and exits.
   - If member (`rjmemb`) changes, logs end and exits.
   - Skips records not belonging to the current user or not from warehouse 'LA'.

4. **Firm Break Logic:**  
   - When the firm changes, updates the current firm, fetches additional data from `raa1l1r`.

5. **Voucher Break Logic:**  
   - When the voucher number changes, checks posting type and project code:
     - Skips if posting type is 2 or 3.
     - Skips if project code (`rjreid`) is 'P' (project postings are not handled).
   - If the `ra1skd` flag is 'J', calls **RF011C** to print the label.

6. **End-of-Loop:**  
   - Returns to `dummy` tag to process the next record.

7. **End-of-Program (`end1` tag):**  
   - Sets LR (last record indicator).
   - Logs end (if logging enabled).
   - Returns.

---

## Business/Domain-Specific Logic

- **Label Printing Conditions:**  
  Only prints labels for vouchers meeting specific criteria:
  - Not project postings.
  - Not certain posting types.
  - Only when the `ra1skd` flag is set ('J').
  - Restricted to current user and specific warehouse.

- **Logging:**  
  Controlled by configuration (via CO402R). If enabled, logs program start and end, and records status via AB700R/AB705R.

- **Firm and Voucher Breaks:**  
  The program groups processing by firm and voucher number, ensuring correct context for label printing and data retrieval.

---

## Design Decisions & Patterns

- **Tag/GOTO Control Flow:**  
  Uses `tag` and `goto` for main loop and exit points, a common pattern in legacy RPG code for clarity in sequential processing.

- **Switch-Controlled Logging:**  
  Logging is dynamically enabled based on configuration, allowing for flexible auditing without code changes.

- **Externalized Business Logic:**  
  Actual label printing and logging are delegated to external programs (RF011C, AB700R, AB705R), supporting modularity and reuse.

- **Key Lists for File Access:**  
  Uses RPG key lists (`klist`, `kfld`) for file positioning and random access, enabling efficient record retrieval.

- **Overlay/Redefinition:**  
  Some variables are overlays of others (e.g., `lcwwus` overlays `l_user`), reflecting legacy data structures or external data requirements.

---

## Integration Points

- **CO402R**: Configuration management, determines if logging is active.
- **AB700R/AB705R**: Logging/auditing, records program activity.
- **RF011C**: Label printing, invoked per qualifying voucher.
- **Files**:
  - **rjoupf**: Main voucher journal or transaction file.
  - **raa1l1r**: Firm/company master or status file.

---

## Conventions & Notable Practices

- **Norwegian Naming/Comments:**  
  Variable and field names, as well as comments, are in Norwegian. Familiarity with domain terms (e.g., bilag = voucher, etikett = label) is helpful.

- **Versioning and Change Log:**  
  Header contains a detailed change log with version, date, description, and initials.

- **Conditional Compilation:**  
  Code sections are marked with version identifiers (e.g., `7.01`, `610`) for tracking changes and conditional logic.

---

## Summary

RF113R is a specialized batch program for printing labels per voucher, tightly integrated with the ASOKON system. It processes records from a voucher journal, applies business rules to determine eligibility for label printing, and coordinates with external modules for logging and printing. The design emphasizes modularity, configurability, and adherence to established business processes. Understanding the external modules and the business context around vouchers and labels is key for effective maintenance and enhancement.