# RPG Program Overview (VA570R)

This ILE RPG program, named `VA570R`, is a classic application for IBM i (AS/400) and is responsible for querying item types ("Varetype, spørring" in Norwegian). The main purpose is to present item types in a subfile list, allow navigation (paging up/down), and selection from the list, with search/positioning aids on "Varetype" (item type) or "Beskrivelse" (description). It's tightly connected to display files (workstn with subfiles) and database files.

Below, you’ll find a detailed breakdown of how the program works, key variable usages, and the program flow.

---

## File Declarations

```rpg
fvvtyl1    if   e           k disk    rename(vvtypfr:vvtyl1r)
fvvtyl2    if   e           k disk    rename(vvtypfr:vvtyl2r)
fva570d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **vvtyl1/vvtyl2:** Two physical files referenced, both with keys. Used for accessing item type data via different sort orders (likely, vvtyl1 by item type, vvtyl2 by description).
- **va570d:** The display (DSPF) with a subfile (`b1sfl`) and a control record. The `infds(dspfbk)` clause is used to capture display feedback info (like cursor position, function key, etc).

## Key Data Structure and Parameter Definitions

- **Parameters (`p_firm`, `p_vtyp`, `p_vtxt`):** For the calling program to specify company, item type, and description to preposition/initialize the subfile.
- **Display Feedback DS (`dspfbk`):** Used to get info about which record the cursor is on, etc.
- **Key Variables:** Used to set keys when accessing the two version of the item type file.
- **Subfile Control and State:** Many variables track the position, page, and status within the subfile—`w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`, etc. These are all used for paging and navigation.

## Indicator Usage

Special indicators (`*INnn`) are extensively used to control subfile actions, error reporting, field protection, and navigation.

## Program Flow

### 1. Initialization (`*inzsr`)
- Reads input parameters
- Sets up key lists for positioning
- Prepares the display by positioning to the beginning of the file and filling the subfile with initial data

### 2. Main Loop

The code enters a sequence of tags (`b2taga`, `b2tagb`) to display the subfile, accept user actions, and process navigation or selection logic.

#### - b2taga
- Writes the command screen (`b2cmd`)

#### - b2tagb
- Calls `dsp_subfile` to display the subfile or control screen
- Enters a `select` group to process user function keys:
  - **`*INKC` or `*INKL`:** Exit program
  - **`*INKE`:** Refresh subfile (`forny`)
  - **`*IN10`:** Page down (`crt_subfile`)
  - **`*IN11`:** Page up (`bck_subfile`)
  - **`*IN21`:** Home key (set `*IN22` to ON, to reposition the cursor)
- If search fields (`b2vtyp`, `b2vtxt`) are filled, calls `posisjoner` to reposition the file and subfile to the search value.
- Otherwise, calls `subfile` to process any selection made in the list.

#### - avslutt
- Sets LR indicator to ON and returns (ends the program).

### 3. Subroutines

#### **forny** - Refresh Subfile
Repositions the file to the record under the cursor and refreshes the subfile/page with latest data.

#### **posisjoner** - Positioning
Handles direct repositioning to a given item type or description by user input and refreshes the subfile accordingly.

#### **subfile** - Subfile Selection Logic
Handles row selection. If a row is selected (e.g., `b1valg = 1`), stores the selected values and signals program exit.

#### **clr_subfile** - Clear Subfile
Prepares the subfile for new data by setting the clear indicator and resetting counters.

#### **crt_subfile** - Create/Fill Subfile
Reads the item type file and fills the subfile with the next page of items. Keeps track of whether the end of file is reached and sets status accordingly.

#### **bck_subfile** - Page Up
Reads the file backwards to fill the subfile with the previous page of items.

#### **dsp_subfile** - Display Subfile
Handles the display and interaction with the subfile; sets the right indicators and writes the control record.

---

## Subfile Paging and Navigation

- **w_srrn:** Current relative subfile record number.
- **w_ssrn:** Highest record written to the subfile so far (last record).
- **w_sfrn:** First record on last page.
- **w_spge:** Current subfile page number.
- **c_sfil:** Constant (likely page size, e.g., 8 per page).
- **b_valg_ok:** Set to *ON when a user has picked a row.

When paging up and down, the program reads the appropriate number of records either forward (`read`) or backward (`readp`), depending on user action, and refreshes the subfile window.

---

## User Interaction Summary

- **Positioning:** Users can input an item type or description to jump to items starting with that value.
- **Paging:** F10 / F11 (or corresponding keys) for next/previous page.
- **Selection:** User can select an item; the program returns selected item type and description as parameters.
- **Exit:** User can exit at any time using the appropriate function key.

---

## Error Handling

Limited explicit error handling; most state is managed using indicators and the logic for subfile limits (EOF, etc.).

---

## Code Structure

- **Modular:** Uses subroutines (with `begsr`/`endsr`) for each logical operation: subfile maintenance, display, key handling.
- **Tag-based Flow:** Uses labels (`tag` statements) and `goto` for main display/action loop, which is old-school but typical of classic RPG before subprocedures.

---

## Conclusion

This RPG program is a good illustration of subfile-based display interaction for lookup/pick lists on IBM i. It deals with two alternate sort orders (item type and description), supports navigation, search/positioning, and selection, and manages all subfile cursoring/paging logic manually. 

If you're onboarding:
- **Understand subfile logic**: paging, filling, clearing, and positioning are all managed with indicators and manual counters.
- **Pay attention to indicators:** They control all display and logic branches.
- **Entry/Exit Parameters:** Used for two-way communication with the caller (input/output).
- **Two access paths:** Be aware of the two files/views for alternate sort orders.
- **Main Routine:** Loops through display/subfile/selection logic until an exit or selection occurs.

This program is a solid candidate for modernizing (e.g., free format RPG, subprocedures, better modularization), but its structure is a good example of classic, robust iSeries development.