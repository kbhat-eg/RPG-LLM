# Program VP711R – Documentation

## Purpose

This program retrieves the sales unit and sales price for a given product from the main supplier, based on a set of input parameters. It is designed to support complex price lookups, including fallback logic for missing price records by delivery type and price group.

**Business Context:**  
- **Domain:** Inventory/Pricing
- **System:** ASOFAK
- **Function:** Given company, product, price group, delivery type, date/time, the program returns the sales unit, sales price, and a return code.
- **Special Handling:** It implements fallback logic to ensure a price is found even if the most specific combination is not available.

---

## File Dependencies

- **vvprl1** (Product Price Register): Main file for price lookup, renamed as vvprl1r.
- **vvenl2** (Product Unit Register): Used to retrieve sales units, renamed as vvenl2r.
- **vvarl1** (Product Register): Used to retrieve product information, renamed as vvarl1r.

All files are accessed by key, and the keys are constructed dynamically based on parameters and logic.

---

## Input/Output Parameters

### Input
- **p_firm:** Company identifier
- **p_vare:** Product identifier
- **p_prgr:** Price group (expanded from 1 to 2 positions)
- **p_lety:** Delivery type
- **p_dato:** Date/time for price validity

### Output
- **p_enhe:** Sales unit
- **p_sapr:** Sales price
- **p_retk:** Return code (F = Failure, otherwise success)

---

## Main Logic Overview

1. **Initialization (`*inzsr`):**
   - Loads parameters.
   - Initializes working variables and key lists for file access.
   - Handles defaulting of date/time if not provided.
   - Clears output parameters.

2. **Product Lookup:**
   - Reads product information from `vvarl1` based on input product.

3. **Sales Unit and Price Retrieval:**
   - Iterates over sales units for the product in `vvenl2` (starting with sales unit 1).
   - For each, attempts to retrieve price information via the `hent_pris` subroutine.
   - Stops when a valid price is found or all units are checked.

4. **Fallback Logic:**
   - If no price found after all units, sets return code to 'F' (failure).

5. **Program Termination:**
   - Sets LR indicator and returns.

---

## Price Lookup Subroutine (`hent_pris`)

This is the core of the business logic. For a given combination of product, price group, sales unit, and delivery type, the subroutine attempts to find a valid price in several steps:

1. **Exact Match Attempt:**
   - Tries to find a price for the exact input combination.

2. **Delivery Type Fallback:**
   - If not found and delivery type is not zero, tries delivery type 0 (generic).

3. **Price Group Fallback:**
   - If still not found and price group is not blank, tries with blank price group.

4. **Combined Fallback:**
   - If still not found, tries both blank price group and delivery type 0.

**For each attempt:**
- Reads records in order of decreasing date (`vppdat`).
- If a record is found with a validity date less than or equal to the input date, it is selected.

**Output:**
- On success, sets output sales unit and sales price.
- Updates working variables for delivery type, price group, and order.

---

## Key Design and Patterns

- **Key Lists:**  
  Keys for file access are defined in the initialization subroutine, making it easier to maintain and update key structures in one place.
- **Fallback Logic:**  
  The program implements a multi-step fallback mechanism, typical for business pricing logic, ensuring the most relevant price is found.
- **Parameter Passing:**  
  Uses parameter lists for both input and output, supporting use as a subroutine or called program.
- **Indicator Usage:**  
  Uses indicators (e.g., *in90, *in91) for end-of-file and record-not-found handling.

---

## Relationships to Other Modules

- **vvprl1, vvenl2, vvarl1** are central master files in the pricing and product modules of the system.  
- This program is likely called by order entry, pricing modules, or batch price update routines.

---

## Special Considerations

- **Date Handling:**  
  If input date is not provided, the current system time is used.
- **Sales Unit Loop:**  
  The program only attempts to find the price for sales unit 1, but the code is structured to allow for future expansion to multiple units.
- **Return Code:**  
  Only set to 'F' on total failure; otherwise, output parameters are populated.

---

## Versioning and Change Notes

- **5.70:** Price group expanded from 1 to 2 positions.  
- **6.20:** Added logic for using the product register (`vvarl1`).  
- **6.21:** Working variables for delivery type, price group, and order enhanced.

---

## Summary Table

| Step                | File      | Key Components              | Purpose                                      | Fallback?         |
|---------------------|-----------|-----------------------------|----------------------------------------------|-------------------|
| Product Info        | vvarl1    | Firm, Product               | Ensures product exists, gets warehouse/order | No                |
| Sales Unit Lookup   | vvenl2    | Firm, Product, Sales Unit   | Iterates over sales units                    | No                |
| Price Lookup        | vvprl1    | Firm, Product, etc.         | Finds price for unit/delivery type/price grp | Yes (multi-level) |

---

## Noteworthy Aspects

- **Norwegian Comments:**  
  The code and comments are in Norwegian, reflecting the business domain and user base.
- **Structured Fallbacks:**  
  The price lookup logic is robust, covering all reasonable cases for missing data.
- **Legacy Style:**  
  The program uses classic RPG IV constructs and conventions, with clear separation of main logic and subroutines.

---

## Maintenance Tips

- When adding new sales units or delivery types, ensure fallback logic is updated accordingly.
- If new price group structures are introduced, review the fallback order.
- Key lists are centralized in the initialization subroutine for easier updates.

---

## Example Usage Scenario

A calling program needs to determine the correct sales price for a product, given a specific customer, date, and delivery scenario. It passes the required parameters to VP711R, which returns the best-matching price and unit, or indicates failure if no price is available.

---

**For further details on file structures or integration points, consult the system’s data dictionary or the functional specification for module ASOFAK.**