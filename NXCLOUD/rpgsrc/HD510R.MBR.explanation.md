# Documentation: HD510R – Hand Terminal Order Line Display

## Overview

**System:** ASLAGR  
**Program:** HD510R  
**Purpose:**  
This program is used for displaying order lines on a hand terminal within the ASLAGR system. It presents order line details in a subfile, along with associated customer, item, and project information. The display is interactive, supporting paging and function key handling.

## Business/Domain Context

- **Order Handling:**  
  The program is part of the order management flow, focusing on the order line (ordre-linje) display for hand terminals (likely portable barcode terminals or similar).
- **Data Sources:**  
  It interacts with several master and transaction files: order header, order line, item, customer, and customer project.
- **User Interface:**  
  Utilizes subfiles for paging through order lines, with control and command screens to guide the user.

## File Definitions and Relationships

- **hodtl1** (Order Line):  
  Main file for order line records, keyed by company and order reference.
- **vvarl1** (Item):  
  Provides item text/description, keyed by company and item number.
- **hohel1** (Order Header):  
  Contains order header details (customer, project, dates).
- **rkunl1** (Customer):  
  Customer master file for name and related info.
- **fkprl1** (Customer Project):  
  Project data linked to customer and project number.
- **hd510d** (Display File):  
  Workstation file with subfile (B1SFL), control (B2CTL), and command (B2CMD) records.

## Indicator Usage

- **LR:** End of program
- **10:** Roll (paging)
- **12:** Subfile display
- **13:** Subfile display control
- **14:** Subfile clear
- **15:** Subfile end (no more records)
- **16:** Readc (no more records)
- **21:** Home key
- **22:** Cursor placement
- **30:** Field protection (on display)
- **31-79:** Error/warning messages
- **80-89:** Work indicators
- **90-99:** File indicators (chain, etc.)

## Key Variables

- **w_srrn:** Relative record number in subfile (current line)
- **w_spge:** Page size (number of lines per page)
- **w_sfrn:** First record number on current page
- **w_ssrn:** Last record number on current page
- **w_virn:** Used to display the page containing a given record

## Program Flow

### 1. Initialization (`*inzsr`)

- Receives parameters: company (`p_firm`) and order reference (`p_refn`).
- Builds keys for all relevant files.
- Fetches order header data, customer, and project info, populating the control screen fields.
- Sets up the order line file for reading (positioning with `setll`).
- Calls `crt_subfile` to load the first page of order lines into the subfile.

### 2. Main Display Loop

- **b2taga:** Writes the command screen (B2CMD).
- **b2tagb:** Calls `dsp_subfile` to display the subfile contents.
- **Function Key Handling:**
  - **F3/F12:** Exit program.
  - **F10 (Roll):** Load next page of subfile (`crt_subfile`).
  - **F21 (Home):** Set cursor placement and return to command screen.

### 3. Subfile Management

#### a. Clearing Subfile (`clr_subfile`)

- Sets indicator 14 to clear the subfile.
- Resets page and record counters.

#### b. Creating Subfile (`crt_subfile`)

- Increments page size.
- Reads order line records (`hodtl1`) up to the page size.
- For each order line:
  - Populates subfile fields with order line data.
  - Looks up item text in `vvarl1` (item master) and adds description if found.
  - Writes record to subfile (B1SFL).
- Updates page navigation variables.

#### c. Displaying Subfile (`dsp_subfile`)

- If subfile contains records, sets indicator 12 to display.
- Otherwise, shows the command screen.
- Sets indicator 13 for subfile control record and uses `exfmt` for display.
- Resets display-related indicators after display.

## Notable Design Decisions

- **Subfile Paging:**  
  Implements manual paging using a fixed page size (constant `c_sfil`), allowing users to roll through order lines.
- **Indicator-Driven UI:**  
  Heavily leverages indicators for UI state (display, clear, field protection, etc.), following classic RPG/400 subfile patterns.
- **Separation of Data Fetch and Display:**  
  Data retrieval (file I/O) and display logic are kept in separate subroutines, enabling modular updates and maintenance.
- **Business Field Population:**  
  Control record fields are populated from multiple sources (order header, customer, project), ensuring all relevant context is visible on screen.

## Interactions with Other Modules

- **File I/O:**  
  This program does not update data; it is read-only, focusing on display. All file interactions are for lookup and display purposes.
- **Display File (`hd510d`):**  
  The display file defines the subfile (B1SFL), control (B2CTL), and command (B2CMD) records, which are written/exfmt’d as needed.

## Naming and Coding Conventions

- **Prefixes:**  
  - `b1`, `b2`: Subfile and control screen fields.
  - `w_`: Working variables (paging, navigation).
  - `c_`: Constants.
- **Key Lists:**  
  RPG key lists (`klist`) are used to define composite keys for file access.
- **Indicators:**  
  Traditional RPG indicator usage for UI and file state.

## Summary Table: Subroutines

| Subroutine      | Purpose                                         |
|-----------------|-------------------------------------------------|
| *inzsr          | Initialization, parameter handling, setup        |
| clr_subfile     | Clear subfile and reset navigation variables     |
| crt_subfile     | Load next page of order lines into subfile       |
| dsp_subfile     | Display subfile or command screen as appropriate |

## Typical User Flow

1. **Program is called** with company and order reference.
2. **Order header, customer, and project info** are fetched and shown.
3. **Order lines** are loaded into a subfile and displayed.
4. User may **page through order lines** (F10), return to home (F21), or exit (F3/F12).

## Maintenance Notes

- **Adding fields:**  
  To add new fields to the subfile or control screen, update both the display file (`hd510d`) and corresponding RPG field assignments.
- **Changing page size:**  
  Adjust the constant `c_sfil` as needed.
- **Error handling:**  
  Uses file indicators (90-99) for detecting not found/chain failures; adjust as needed for new files or logic.

---

**This program is a classic RPG/400 subfile display module for order line inquiry on hand terminals, integrating data from multiple master files and providing a paged, interactive user experience.**