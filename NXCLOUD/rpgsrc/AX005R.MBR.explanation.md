## Program Overview

This RPG program, named `AX005R`, is designed to extract customer (`KUNDER`) data from several physical files, transform and sanitize it, and then output it as XML according to the SAF-T (Standard Audit File for Tax) format. The program processes customer data and related information, including contact persons, addresses, balances, etc., and writes structured XML output.

The code is classic "Cycle" (fixed-format) RPG IV (ILE), with comprehensive use of files, key-lists, and subroutines for editing and I/O.

---

## Structure and Components

### 1. File Declarations

Several files are declared for input (`disk`) and output:
- **Input:** `ra04l1`, `ra11l1`, `rkunl1`, `rktrl1`, `rukpl1`, `rxmll1` (all renamed from their base physical files)
- **Output:** `faxmlut` (presumably for the final XML output)

These files correspond to various data domains such as customers, customer categories, addresses, contact persons, and XML templates.

### 2. Constants and Variables

- **dig1, dig2, dig3:** Used for character sanitation (e.g., allowed letters/numbers/symbols).
- **Work variables:** For customer number, text fields, formatting, balance calculations, and key structures.
- **XML line variables:** For managing what part of the XML template is being processed.

### 3. Initialization (`*inzsr`)

- **Keylists:** Define how to position and access records for each physical file by keys (firm, customer number, etc).
- **Parameters:** Reads from a data area (`ax000par`) to get date/period-related configuration used for filtering balances.
- **Positions at the first customer (`rkunl1_key setll rkunl1`) and outputs an opening `<KUNDE>` XML node.**

---

## Main Loop

### Entry Point (`start` tag)
- **Reads through all customer records** in the customer master file (`rkunl1`).
- **Processes only records for the current firm**, skipping those with certain "passive" flags.

### For Each Customer
The program:
1. **Writes `<KUNDE>` node** (XML header for the customer).
2. **Extracts and outputs various attributes in order:**  
    - Company number
    - Organization numbers
    - Name
    - Address fields (address, address 2, postal place, postal code, country code, address type, etc.).
3. **Handles postal code formats** (splits out postal code if embedded in `rksted`).
4. **Contact person information:**
    - Finds the main or "active" contact person (`rustat = 'X'`) or the first one.
    - Outputs contact person's info (first name, last name, phone, fax, email, web address).
5. **Customer and account IDs:**  
    - Outputs customer number and account number (from either a category or a fallback account).
6. **Opening and closing balances:**  
    - Iterates over transactions (from `rktrl1`) to calculate balances, both at period start and end according to parameter settings.
    - Formats these as strings suitable for XML (removing leading zeros).
7. **Closes the customer node** (`</KUNDE>` or equivalent).
8. **Repeats for each customer** until end of file.

---

## Subroutines

### `redut` – Edit and Write XML Line

- **Sanitizes the current text using `spstgn`.**
- **Replaces template placeholders (?V? or ?F?) in the XML template (`axxmlt`) with the actual text or fast values.**
- **Writes out to the XML output file.**
- Clears the work variable `text`.

### `spstgn` – Special Character Handling

- **Sanitizes text for XML compatibility:**
    - Replaces &, <, >, ' and " with XML entities.
    - Applies character translation for certain special/extended Latin characters (fixes encoding issues).
    - Replaces unknown/unacceptable characters with '%' (or '$' as a fallback).
- **Ensures output is "safe" for XML and for the SAF-T compliance.**

### `*inzsr` – Initialization

- **Initializes key lists and parameter variables.**
- **Positions all file pointers to the correct starting point.**
- **Outputs the root `<KUNDE>` node.**

---

## Program End

- **After processing all customers, outputs the closing tag for the root node (line 900 in XML).**
- **Sets on LR (`*inlr = *on`) and returns (ends the program).**

---

## Notable Logic Details

- **Norwegian field names:**  
    - For example: `Gate` (street), `Poststed` (place/city), `Postnummer` (postal code), `Landkode` (country code), `Navn` (name), etc.
- **Handling of multiple contact persons:**  
    - Special handling to report one contact, prioritizing by status.
- **Balance calculations:**  
    - Carefully sums all relevant journal entries/transactions up to the reporting period.
- **XML Templates:**  
    - Uses a template mechanism (`rxmll1` and `axxmlt`), with placeholders replaced for each field.

---

## Summary

**The program iterates over all customers for a given firm, retrieves and sanitizes a variety of related data, and outputs it as valid, safe XML for SAF-T compliance. Heavy use is made of keylist-based file access, string manipulation, and custom rules for Norwegian data formats and character encodings.** 

### For onboarding:

- **Familiarity with classic RPG IV syntax is required** (fixed-format, KLIST, MOVE, MOVEL, etc.).
- **Pay attention to Norwegian business field terminology and data structure.**
- **The main logic is in the big loop between `start` and `slutt` tags, with editing and output abstracted into subroutines.**
- **Understanding the XML template mechanism (`rxmll1`, `axxmlt`, placeholders) is crucial for maintaining or extending the output format.**
- **Balance calculation logic is sensitive to the reporting period and is controlled by values loaded from the data area, so any changes to reporting periods require a full understanding of this initialization.**
- **All data is sanitized for XML compatibility and character set consistency, which is vital for file exchanges, especially important for SAF-T purposes.**

> This code is typical of SAF-T or similar regulatory reporting solutions in environments where tight integration with specialized business applications and legacy data is required.