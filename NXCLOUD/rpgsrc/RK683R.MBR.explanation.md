# RPG Source Code Walkthrough

This ILE RPG code (RK683R) is a classic style, parameter-driven interactive program to process factoring records.

---

## **Header Section**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `h` spec sets program options:  
  - `*nodebugio`: disables debug I/O.
  - `datedit(*dmy)`: default date format is "day/month/year".

---

### **Documentation Block**

The asterisked comments give:
- **System**: ASOKON
- **Program**: RK683R
- **Description**: Processing of factoring records via parameters (original Norwegian).
- **Instructions**: List of indicator usages for UI and processing.

Example indicators:
- `*INKA = F1` (Choose company)
- `*INKC = F3` (Exit)
- `*INLR`: End program  
- 30: Field protect
- 31-59: Warnings/errors
- 60-99: File/subroutine indicators

---

## **File Declarations**

```rpg
fraa9l1    if   e           k disk    rename(raa9pfr:raa9l1r)
frk683d    cf   e             workstn
```
- `fraa9l1`: Input file (external, keyed disk); record format renamed.
- `frk683d`: Display file (workstn device).

---

## **Data Structure Definitions**

```rpg
d                uds                   // User Data Space
d  pfirm                300    302  0
d  pnavn                303    332
... etc ...
d  l_user               911    920
d  l_firm               944    946  0
```
- UDS (User Data Space): overlay fields at specific positions.
- `pfirm`, `pnavn`, `pkdat`, `praar`, etc.: company, name, date, year, period, etc.
- `l_user`, `l_firm`, `l_fnav`: local user/company info.

```rpg
d w_in03          s              1
d w_firm          s                   like(l_firm)
```
- Work variables.

---

## **Mainline Code**

### **Dummy TAG**

```rpg
c     dummy         tag
```
- Label, not used further (likely a template artifact).

---

### **Display Interaction (Screen Image)**

```rpg
c     a2taga        tag
c     a2tagb        tag
c                   exfmt     a2bld
```
- Main screen logic:  
- Tag labels for “A2BLD” panel processing (parameter selection screen).
- `exfmt a2bld`: Display and receive input for screen `a2bld`.

---

### **Indicator Reset**
```rpg
c                   eval      *in20 = *off
c                   eval      *in31 = *off
...
c                   eval      *in40 = *off
```
- Turn off indicators 20, 31-40 (reset warnings/state).

---

### **Exit Logic (F3)**
```rpg
c                   if        *inkc = *on
c                   eval      w_in03 = '1'
c                   goto      xslutt
c                   endif
```
- If F3 (indicator KC) is pressed:
  - Set `w_in03` to `'1'`
  - Go to program end (`xslutt`).

---

### **Date Validation**
```rpg
c                   if        a2pkda = *zero
c                   move      udate         a2pkda
c                   endif
c     *dmy          test(d)                 a2pkda                 31
c                   if        *in31 = *on
c                   goto      a2taga
c                   endif
```
- If processing date not entered, default to current system date (`udate`).
- `test(d)` validates date in day/month/year format; if invalid, turns on indicator 31 (error) and returns to screen entry (`a2taga`).

---

### **Ajour (Update) Control**
```rpg
c                   if        a2areg <> 'J' and
c                             a2areg <> ' '
c                   move      *on           *in35
c                   goto      a2taga
c                   endif
```
- If update status (`a2areg`) is not `'J'` or blank,
  - Turn on indicator 35 (warning/error).
  - Return to screen.

---

### **Parameter Write-back**

```rpg
c                   eval      pkdat = a2pkda
c                   eval      pajor = a2areg
c                   eval      praar = a2pr�r
c                   eval      prper = a2prpe
c                   eval      pform = a2form
```
- Save parameters from screen to UDS fields for later use.

---

### **End Program Section**

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Label marks logical end.
- Turn on LR (Last Record, causes program to end).
- `return`: exit.

---

## **Initialization Subroutine**

```rpg
c     *inzsr        begsr
c                   move      l_firm        w_firm
c                   move      udate         a2pkda
c                   move      *month        a2prpe
c                   move      *year         a2pr�r
```
- Startup logic:
  - Copy company number (`l_firm`) into work variable.
  - Default the date to today, period to current month/year.

```rpg
c     raa9l1_key    chain     raa9l1
c                   eval      a2areg = ra9reg
c                   eval      a2form = ra9fmt
```
- Chain (lookup) company factoring status record in `raa9l1`.
- Retrieve update status (`ra9reg`) and format (`ra9fmt`) into screen fields.

---

### **Parameter List (for call/return)**

```rpg
c     *entry        plist
c                   parm                    w_in03
```
- Defines entry parameter list (input parameter `w_in03`).

---

### **Key List for Lookup**

```rpg
c     raa9l1_key    klist
c                   kfld                    w_firm
```
- Defines key for record lookup in subroutine.

---

### **Subroutine End**

```rpg
c                   endsr
```
- End of subroutine.

---

## **Summary**

**RK683R** is a parameter selection/validation program for factoring, built with classic RPG III/IV style.  
- It interacts with a workstation screen, validating input (especially dates and update status).
- Uses indicators for screen and logic control.
- Reads factoring status from database.
- Stores parameters for subsequent processing.
- Designed for integration with a larger accounting system.

**Key skill areas**: Legacy RPG, UI via DDS screens, indicator-based flow, file I/O, subroutine initialization.  
**Next steps for onboarding**: 
- Understand DDS file `frk683d` (the interactive screen).
- Understand layout and logic of file `raa9l1`.
- Familiarize with indicator conventions.