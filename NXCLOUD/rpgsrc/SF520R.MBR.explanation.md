# RPG Program Overview: SF520R (ASSTAT System)

This RPG program is named `SF520R` and is part of the `ASSTAT` system. Its main function is to provide maintenance and query routines for sales statistics (`salgsstatistikk`). It's a classic ILE RPG program using subfiles for interactive maintenance via a green-screen display file. The comments and variable names are in Norwegian, but you’ll also find English technical terms sprinkled throughout.

---

## 1. **Header and Documentation**

- There is a detailed comment header describing the program, its purpose, history, and change log.
- Special attention is paid to how indicators are used for screen logic, error handling, and workflow control.

---

## 2. **File Declarations**

```rpg
fsstal2    if   e           k disk    rename(sstapfr:sstal2r)
fsstal1    if   e           k disk    rename(sstapfr:sstal1r)
fsf520d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **sstal2** and **sstal1**: Input full-procedural (I) files with external descriptions, both renamed from a base format (`sstapfr`) to their own record formats.
- **sf520d**: Display file for the workstation (interactive screen) with a subfile (`b1sfl`) controlled by the field `w_srrn`.

---

## 3. **Local Data Area and Key Variables**

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- These fields map to positions in the user data space (LDA), used for things like retrieving the firm code, current user, etc.

There are also many variable definitions for keys and work variables, often with `like()` to base their types on the file fields (ensures alignment and safety for data file keys).

---

## 4. **Indicator Usage**

Detailed comments spell out the meaning of all 100 indicators (`*IN01` to `*IN99`), including:
- *inlr*: End job (Last record indicator)
- *in14*: Clear subfile
- *in15*: Subfile end
- *in16*: No more records in subfile
- *in12*, *in13*: Display logic for screens/subfiles

---

## 5. **Subfile Navigation and Main Control Loop**

- **Tag/Branch Structure**: The program is organized with `tag` statements and `goto`, which is classic for old RPG code.
- **Main workflow**:
  - Display command screen (`b2cmd`)
  - Handle function keys (F3, F12, etc.), navigation, queries (`spørring` subroutine), refresh (`forny` subroutine), creating and clearing the subfile, and explicit positioning (`posisjoner` subroutine)
  - End program with indicator LR

---

## 6. **Key Subroutines**

### a. **spørring (Query)**
Handles lookup for the item number (`vare`). Uses a `CALL` to another program (`VV500R`), passing in current firm and item, and populates description/lookup result.

### b. **forny (Refresh)**
Positions file pointers (with `setll`), clears the subfile, and refills it using the relevant read order (`sstal1` or `sstal2`).

### c. **posisjoner (Positioning)**
Allows the user to position the subfile focus based on either item number or invoice number, using the appropriate indexed key.

### d. **subfile (Subfile Handling)**
Processes the records in the subfile:
- Loops through the subfile, reading changed records (`readc`)
- Handles any edits to sales details by calling another program (`SF521R`), updates local subfile fields, and writes changes back.

### e. **clr_subfile (Clear Subfile)**
Turns on indicator 14, writes control record to clear subfile, and resets navigation counters.

### f. **crt_subfile (Create/Fill Subfile)**
Reads records from the main sales files to populate the subfile. Observes page and record counters, and only brings in those records relevant to the current session/firm/year.

### g. **dsp_subfile (Display Subfile)**
Handles showing the subfile page or command screen to the user, depending on current state.

### h. **\*INZSR (Initialization)**
Initializes program state, sets the keys for both access paths, retrieves firm code, sets up defaults, and loads the first page of the subfile.

---

## 7. **Other Notable Points**

- **Field Names:** `b1`, `b2`, `sf` prefixes indicate subfile/work display fields and file fields.
- **Control Flow:** Heavy usage of subroutines (`begsr`/`endsr`) and tagged code blocks for clarity and to minimize repeated code.
- **External Programs:** Calls are made to other programs (`VV500R`, `SF521R`) for lookups and updates, indicating this is part of a larger, modular application.
- **Comments:** Extensive and helpful, especially regarding indicator logic and field use.

---

## 8. **Summary**

This program is a classic RPG interactive maintenance and lookup routine for sales statistics, with:
- Rich subfile usage for paging and editing.
- File navigation and positioning logic for precise access.
- Encapsulated logic in well-commented subroutines.
- Screen, key, and state logic managed through indicators and page/record counters.

If you need to onboard to or maintain this code:
- Study the indicator usage carefully, as it's the backbone of UI and flow control.
- The subfile routines (`clr_subfile`, `crt_subfile`, `dsp_subfile`, etc.) will be central to any changes in display or record navigation.
- External program interaction suggests you need familiarity with related programs to understand data flow thoroughly.
- Most variables for keys or data fields are defined using the `like()` keyword, ensuring consistency with file layouts (minimizes mapping bugs).

**Tip:** RPG III/400 experience will help, as this is pre-RPG IV free-format style code. The business logic mixes Norwegian terms for business concepts (vare = item, firma = company, fakturanr = invoice number, etc.).