# RPG Program Explanation: MB601R

## Purpose

This program, **MB601R**, is designed to print a detailed report (ABC analysis details) for item movement (`Utskrift av varebevegelsesliste`). It allows filtering based on various parameters such as ABC codes, item groups, supplier, assortment, and warehouse (lager).

---

## High-Level Flow

1. **Initialization**
   - Set up keys, parameters, and heading data for the report.
2. **Main Loop**
   - Read through the main item movement file (`mabdl5`); for each record:
     - Validate against selection parameters.
     - Lookup item and detail records in associated files.
     - Accumulate count/behold (stock) if filtering by these.
     - Write detail line to report.
   - Handle page overflow by rewriting the header.
3. **Subroutines**
   - Calculate counted/beheld items.
   - Initialize program and keys.

---

## Detailed Sections

### 1. File Declarations

```rpg
fmabdl5    if   e           k disk    rename(mabdpfr:mabdl5r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvsdtl1    if   e           k disk    rename(vsdtpfr:vsdtl1r)
fmb601p    o    e             printer
```

- **mabdl5**: Main item movement file (input).
- **vvarl1**: Item master file (input).
- **vlagl1**: Warehouse/item balance file (input).
- **vsdtl1**: Item assortment details (input).
- **mb601p**: Output to printer.

---

### 2. Parameter and Data Structures

#### Parameter Structure

```rpg
d                 ds
d p_prec                       128
d  p_fabc                        2    overlay(p_prec)
d  p_tabc                        2    overlay(p_prec:3)
d  p_fogr                        2  0 overlay(p_prec:5)
...
d  p_lagk                        2    overlay(p_prec:37)
```

- Parameters are passed as a single 128-character structure, overlaying fields for each parameter.
- Includes: ABC code range, group ranges, supplier, assortment, warehouse code, report options, etc.

#### Group Structures

Used for easy group range checks:

```rpg
d                 ds
d f_vgrp                         7
d  f_ogrp                        2  0 overlay(f_vgrp)
d  f_hgrp                        2  0 overlay(f_vgrp:3)
d  f_ugrp                        3  0 overlay(f_vgrp:5)
...
```

---

### 3. Main Processing Logic

#### Heading

```rpg
c                   write     a1hdr                                30
```
- Write the main report heading (`A1HDR`).

#### Main Loop

```rpg
readec                   read      mabdl5
readec                   dow       not %eof(mabdl5)
...
c     neste         tag
readec                   read      mabdl5
c                   enddo
```

- Loop reads each record from item movement file (`mabdl5`).

#### Processing Each Record

- **Item Lookup**: Fetches item description from `vvarl1`. If not found, uses "Ukjent vare" (Unknown item).
- **ABC Code Filtering**: Skips records whose ABC code is outside the requested range.
- **Group Filtering**:
  - Checks if item belongs to the specified overgroup, main group, or subgroup (if filtering is active).
- **Supplier Filtering**: Skips record if supplier does not match (if filtering).
- **Warehouse Filtering**: Skips record if warehouse code does not match (if filtering).
- **Assortment Filtering**:
  - Builds a key for `vsdtl1` and tries to find a matching record, relaxing key fields step by step if not found.
  - If no match after all attempts, skips the record.
- **Counted/Behold Calculation**:
  - If requested, call subroutine `ant_tellet` to sum up counted (`atel`) or behold (`behl`) fields from warehouse file.
- **Print Detail**: Writes a detail line to the report (`D1DET`).
- **Page Overflow Handling**: If page overflow (`*in30=on`), call `overflow` subroutine to print headings again.

---

### 4. Subroutines

#### `overflow`

Handles page overflow by rewriting the header.

```rpg
c     overflow      begsr
c                   write     a1hdr                                30
c                   endsr
```

#### `ant_tellet`

Calculates the total counted (`atel`) and behold (`behl`) quantities for the item across warehouses.

```rpg
c     ant_tellet    begsr
c                   eval      d1atel = 0
c                   eval      vlagl1_vare = d1vare
c     vlagl1_key    setll     vlagl1
c     vlagl1_key    reade     vlagl1
c                   dow       *in90 = *off
c                   if        p_tell = 1
c                   eval      d1atel = d1atel + vlatel
c                   endif
c                   if        p_mbeh = 1
c                   eval      d1behl = d1behl + vlbehl
c                   endif
c     vlagl1_key    reade     vlagl1
c                   enddo
c                   endsr
```

#### `*inzsr`

Initialization subroutine; sets up keys, loads parameters, and fills report heading variables from the parameters and local data area.

- Defines key lists for file access.
- Loads parameters to working variables.
- Prepares heading information.

---

### 5. Key Lists

Key lists are defined for each file access, combining various fields according to file definitions. This enables keyed reads (CHAIN, READE, SETLL) for rapid access.

---

### 6. Comments and Versioning

- The source has good versioning history and inline comments for program changes and descriptions in Norwegian.

---

## Filtering and Parameterization

- **ABC Codes**: Range, possibly A/B/C classification.
- **Groups**: Over, Main, Subgroup, with range support.
- **Assortment**: Optional, matches by various combinations of group and item fields.
- **Warehouse**: Optional.
- **Supplier**: Optional.

---

## Typical Use Case

When called (with parameters), this program prints a report of item movement details including description, counts, classification, etc., but only for those items that match the given criteria (ABC code, groups, assortment, warehouse, supplier, etc.).

---

## Key Takeaways

- **Efficient Legacy RPG**: Uses classic RPG/400 cycle and structure.
- **Parametric Filtering**: All filtering is parameter driven, supporting flexible report generation.
- **Keyed Access**: Maximizes performance by using key lists to directly access detail records.
- **Extendable**: Modular code with clear boundaries for subroutines and filtering logic, facilitating maintenance and extension.

---

## Recommendations for New Developers

- **Understand Data**: Knowing the data layout in files like `mabdl5`, `vvarl1`, etc., is crucial.
- **Debugging**: Use test parameters to see how filtering impacts output.
- **Refactoring**: This program would be a good candidate for modernization, possibly to free-format RPG or SQL-based reporting for easier maintenance.