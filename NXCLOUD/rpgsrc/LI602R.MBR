     h option(*nodebugio) datedit(*dmy) decedit('0,')
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Program . . . . : LI602R
      * Beskrivelse . . : Utskrift av EDI-Ordrebekreftelse
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      * 5.60  221207 TSV  Utvides med mer informasjon i hodet og på linjer.
      *    -  030108 TSV  Linje: LEDIPF lovetdato (C507, 2005=69, dato:2380)
      *    -  030108 TSV  Hode:  LEDIPF bel.tot (C516, 5025= 86 & NET)
      *    -  030108 TSV  Hode:  LEDIPF Obekr.nr og status-tekst.
      *    -  030108 TSV  Part:  LEDIPF Mottager (fra NAD DP eller UD)
      *    -  040108 TSV  Hode/linjer: beregner linjetotal til utskr.hode
      *    -  070108 TSV  Venstrestiller noen felt for bedre lesbarhet
      *    -  080108 TSV  Rettet i rabatter og avrunding/summering.
      *    -  110208 TSV  Tilføyer avviksliste ordrebekr mot bestilling
      *    -  150208 TSV  Rutiner for avvikslinjer tilsvarende faktura
      *    -  200208 TSV  Feilretter etter siste endringer.
      *    -  260208 TSV  Små justeringer feilmeldinger avviksliste.
6.10  * R6.10 070909 BSA  Utskriften endret pga utvidelse av referansefelter.
6.11  * R6.10 100311 BSA  Miks av formater på linjer pga av GTIN nr
6.nu  * r6.30 100614 bof  Gjennomgått mtp. nummerutvidelse
6.30  * R6.20 310315 BSA  Skriver ut ordre og vare tekstlinjer
6.31  * R6.30 251016 BSA  Fortsetter test av miks av formater
6.31  *                   Fortsatt muligheter for at det feiler.
6.32  * 6.30  081018 bof  Utvidet med trelast sortiment
6.33  * 6.30  190219 bsa  Kan ikke operere med NOBB nummer hvis ikke utfylt.
7.01  * 7.00  160819 bsa  Innført PDF utskrift av dokumentet
      *
8.01  *K0000  220621 BSA  Utvidet meldingsnummer fra 6-8 siffer
      *
      *
      * Bruk av linjenummersekvenser (2 første siffer i linjenr LIMLIN)
      *
      *    10 : Hodeinformasjon
      *    20 : Partsinformasjon
      *    30 : Referanser
      *    40 : Transportinformasjon
      *    50 : Linjer
      *    55 : Linjer fra best. (ikke match i EDI-melding)
      *    60 : Tillegg/fradrag hodenivå
      *    65 : Fritkstlinjer på hodenivå
      *    90 : Totaler
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     flohel1    if   e           k disk    rename(lohepfr:lohel1r)
     flodtl1    if   e           k disk    rename(lodtpfr:lodtl1r)
     fledil1    if   e           k disk    rename(ledipfr:ledil1r)
     fledilr    if   e           k disk    rename(ledipfr:ledilrr)
6.30 fledilu    if   e           k disk    rename(ledipfr:ledilur)
6.30 f                                     prefix(xx:2)
     frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
     fvvenlr    if   e           k disk    rename(vvenpfr:vvenlrr)
     fvvarl3    if   e           k disk    rename(vvarpfr:vvarl3r)
5.60 fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
5.60 fltoel1    if   e           k disk    rename(ltoepfr:ltoel1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
      *
TEST fli602p    o    e             printer usropn
      *
      * Parameter-inn
      *
     d                 ds
8.01 d d_prec                        22
     d  d_firm                        3  0 overlay(d_prec)
     d  d_type                        4    overlay(d_prec:4)
8.01 d  d_mnum                        8  0 overlay(d_prec:8)
8.01 d  d_mlin                        6  0 overlay(d_prec:16)
8.01 d  d_kode                        1    overlay(d_prec:22)
      *
      * ORDREBEKREFTELSE Hode
      *
     d                 ds
     d d_obkh                       400
     d  d_oh_obnr                    35    overlay(d_obkh)
5.60 d  d_oh_obnr1                   12    overlay(d_obkh)
5.60 d  d_oh_obnr2                   23    overlay(d_obkh:13)
     d  d_oh_olda                      d   datfmt(*iso)
     d                                     overlay(d_obkh:36)
     d  d_oh_llda                      d   datfmt(*iso)
     d                                     overlay(d_obkh:46)
     d  d_oh_sean                    13  0 overlay(d_obkh:56)
     d  d_oh_bean                    13  0 overlay(d_obkh:69)
     d  d_oh_fean                    13  0 overlay(d_obkh:56)
     d  d_oh_kref                    30    overlay(d_obkh:82)
5.60 d  d_oh_kref1                   13    overlay(d_obkh:82)
5.60 d  d_oh_kref2                   30    overlay(d_obkh:95)
     d  d_oh_aksp                     3    overlay(d_obkh:112)
     d  d_oh_valk                     3    overlay(d_obkh:115)
     d  d_oh_ttyp                     3    overlay(d_obkh:118)
     d  d_oh_fmat                     3    overlay(d_obkh:121)
     d  d_oh_lbet                     3    overlay(d_obkh:124)
     d  d_oh_lste                    13  0 overlay(d_obkh:127)
     d  d_oh_txt1                    70    overlay(d_obkh:191)
     d  d_oh_txt2                    70    overlay(d_obkh:261)
     d  d_oh_txt3                    70    overlay(d_obkh:331)
      *
      * ORDREBEKREFTELSE Tilegg/fradragslinjer
      *
     d                 ds
     d d_obkh2                      400
     d  d_oh_ftkv                     3    overlay(d_obkh2)
     d  d_oh_tsek                     3    overlay(d_obkh2:4)
     d  d_oh_ftty                     3    overlay(d_obkh2:7)
     d  d_oh_fttx                    30    overlay(d_obkh2:10)
     d  d_oh_tbel                    17  2 overlay(d_obkh2:40)
      *
      * Fritekst/hodelinje
      *
     d                 ds
     d d_obkh3                      400
     d  d_oh_ftxq                     3    overlay(d_obkh3)
     d  d_oh_ftxt                    70    overlay(d_obkh3:4)
      *
      * Ordrebekr.referanser/hode
      *
     d                 ds
     d d_obkh4                      400
     d  d_oh_bstn                    35    overlay(d_obkh4)
     d  d_oh_proj                    35    overlay(d_obkh4:36)
     d  d_oh_kunr                    35    overlay(d_obkh4:71)
     d  d_oh_konr                    35    overlay(d_obkh4:106)
      *
      * Ordrebekr. partsinfo./hode
      *
     d                 ds
     d d_obkh5                      400
     d  d_oh_part                     3    overlay(d_obkh5)
     d  d_oh_pean                    13  0 overlay(d_obkh5:4)
     d  d_oh_pnav                    30    overlay(d_obkh5:17)
     d  d_oh_pad1                    30    overlay(d_obkh5:47)
     d  d_oh_pad2                    30    overlay(d_obkh5:77)
     d  d_oh_pste                    30    overlay(d_obkh5:107)
     d  d_oh_porg                    20    overlay(d_obkh5:137)
5.60 d  d_oh_peanC                   13    overlay(d_obkh5:4)
      *
      * Ordrebekr. transport/lev. - hode
      *
     d                 ds
     d d_obkh6                      400
     d  d_oh_trmo                     3    overlay(d_obkh6)
     d  d_oh_trna                    35    overlay(d_obkh6:4)
     d  d_oh_lebe                     3    overlay(d_obkh6:39)
6.30  *
6.30  * Fritekst varelinje
6.30  *
6.30 d                 ds
6.30 d d_obkl15                     400
6.30 d  d_ol_ftxq                     3    overlay(d_obkl15)
6.30 d  d_ol_ftxt                    70    overlay(d_obkl15:4)
6.30 d  d_ol_lref                     6  0 overlay(d_obkl15:74)
      *
      * ORDREBEKREFTELSE Linje
      *
     d                 ds
     d d_obkl                       400
     d  d_ol_llin                     6  0 overlay(d_obkl)
     d  d_ol_laks                     3    overlay(d_obkl:7)
6.11 d  d_ol_vean                    14  0 overlay(d_obkl:10)
6.11 d  d_ol_vnob                     8  0 overlay(d_obkl:24)
6.11 d  d_ol_vlev                    15    overlay(d_obkl:32)
6.11 d  d_ol_bkva                    15  3 overlay(d_obkl:47)
6.11 d  d_ol_benh                     3    overlay(d_obkl:62)
6.11 d  d_ol_lkva                    15  3 overlay(d_obkl:65)
6.11 d  d_ol_lenh                     3    overlay(d_obkl:80)
6.11 d  d_ol_llda                      d   datfmt(*iso)
6.11 d                                     overlay(d_obkl:83)
6.11  *
6.11 d  d_yy                          2    overlay(d_obkl:85)
6.11 d  d_mm                          2    overlay(d_obkl:88)
6.11 d  d_dd                          2    overlay(d_obkl:91)
6.11  *
6.11 d  d_ol_pris                    15  3 overlay(d_obkl:93)
6.11 d  d_ol_penh                     3    overlay(d_obkl:108)
6.11 d  d_ol_prpr                     9  0 overlay(d_obkl:111)
6.11 d  d_ol_prkv                     3    overlay(d_obkl:120)
6.11 d  d_ol_epri                    15  3 overlay(d_obkl:123)
6.11 d  d_ol_evar                     8  0 overlay(d_obkl:138)
6.11 d  d_ol_linr                     6  0 overlay(d_obkl:146)
6.11 d  d_ol_linb                    15  3 overlay(d_obkl:152)
6.11 d  d_ol_mvap                     4  2 overlay(d_obkl:167)
6.11 d  d_ol_tkv1                     3    overlay(d_obkl:171)
6.11 d  d_ol_tty1                     3    overlay(d_obkl:174)
6.11 d  d_ol_ttx1                    35    overlay(d_obkl:177)
6.11 d  d_ol_tse1                     3    overlay(d_obkl:212)
6.11 d  d_ol_tme1                    11  3 overlay(d_obkl:215)
6.11 d  d_ol_ten1                     3    overlay(d_obkl:226)
6.11 d  d_ol_tpr1                     5  2 overlay(d_obkl:229)
6.11 d  d_ol_tbe1                    15  2 overlay(d_obkl:234)
6.11 d  d_ol_tkv2                     3    overlay(d_obkl:250)
6.11 d  d_ol_tty2                     3    overlay(d_obkl:252)
6.11 d  d_ol_ttx2                    35    overlay(d_obkl:255)
6.11 d  d_ol_tse2                     3    overlay(d_obkl:290)
6.11 d  d_ol_tme2                    11  3 overlay(d_obkl:293)
6.11 d  d_ol_ten2                     3    overlay(d_obkl:304)
6.11 d  d_ol_tpr2                     5  2 overlay(d_obkl:307)
6.11 d  d_ol_tbe2                    15  2 overlay(d_obkl:312)
6.11 d  d_ol_txt1                    35    overlay(d_obkl:327)
6.11 d  d_ol_txt2                    35    overlay(d_obkl:362)
6.11  *
6.11  * ORDREBEKREFTELSE Linje
6.11  *
6.11 d                 ds
6.11 d x_obkl                       400
6.11 d  x_ol_llin                     6  0 overlay(x_obkl)
6.11 d  x_ol_laks                     3    overlay(x_obkl:7)
6.11 d  x_ol_vean                    13  0 overlay(x_obkl:10)
6.11 d  x_ol_vnob                     8  0 overlay(x_obkl:23)
6.11 d  x_ol_vlev                    15    overlay(x_obkl:31)
6.11 d  x_ol_bkva                    15  3 overlay(x_obkl:46)
6.11 d  x_ol_benh                     3    overlay(x_obkl:61)
6.11 d  x_ol_lkva                    15  3 overlay(x_obkl:64)
6.11 d  x_ol_lenh                     3    overlay(x_obkl:79)
6.11 d  x_ol_llda                      d   datfmt(*iso)
6.11 d                                     overlay(x_obkl:82)
6.11  *
6.11 d  x_yy                          2    overlay(x_obkl:84)
6.11 d  x_mm                          2    overlay(x_obkl:87)
6.11 d  x_dd                          2    overlay(x_obkl:90)
6.11  *
6.11 d  x_ol_pris                    15  3 overlay(x_obkl:92)
6.11 d  x_ol_penh                     3    overlay(x_obkl:107)
6.11 d  x_ol_prpr                     9  0 overlay(x_obkl:110)
6.11 d  x_ol_prkv                     3    overlay(x_obkl:119)
6.11 d  x_ol_epri                    15  3 overlay(x_obkl:122)
6.11 d  x_ol_evar                     8  0 overlay(x_obkl:137)
6.11 d  x_ol_linr                     6  0 overlay(x_obkl:145)
6.11 d  x_ol_linb                    15  3 overlay(x_obkl:151)
6.11 d  x_ol_mvap                     4  2 overlay(x_obkl:166)
6.11 d  x_ol_tkv1                     3    overlay(x_obkl:170)
6.11 d  x_ol_tty1                     3    overlay(x_obkl:173)
6.11 d  x_ol_ttx1                    35    overlay(x_obkl:176)
6.11 d  x_ol_tse1                     3    overlay(x_obkl:211)
6.11 d  x_ol_tme1                    11  3 overlay(x_obkl:214)
6.11 d  x_ol_ten1                     3    overlay(x_obkl:225)
6.11 d  x_ol_tpr1                     5  2 overlay(x_obkl:228)
6.11 d  x_ol_tbe1                    15  2 overlay(x_obkl:233)
6.11 d  x_ol_tkv2                     3    overlay(x_obkl:249)
6.11 d  x_ol_tty2                     3    overlay(x_obkl:251)
6.11 d  x_ol_ttx2                    35    overlay(x_obkl:254)
6.11 d  x_ol_tse2                     3    overlay(x_obkl:289)
6.11 d  x_ol_tme2                    11  3 overlay(x_obkl:292)
6.11 d  x_ol_ten2                     3    overlay(x_obkl:303)
6.11 d  x_ol_tpr2                     5  2 overlay(x_obkl:306)
6.11 d  x_ol_tbe2                    15  2 overlay(x_obkl:311)
6.11 d  x_ol_txt1                    35    overlay(x_obkl:326)
6.11 d  x_ol_txt2                    35    overlay(x_obkl:361)
      *
      * ORDREBEKREFTELSE Ordretotaler
      *
     d                 ds
     d d_obks                       400
     d  d_os_suml                    17  2 overlay(d_obks)     inz(0)
     d  d_os_ntot                    17  2 overlay(d_obks:18)  inz(0)
     d  d_os_mvag                    17  2 overlay(d_obks:35)  inz(0)
     d  d_os_mvat                    17  2 overlay(d_obks:52)  inz(0)
     d  d_os_btot                    17  2 overlay(d_obks:69)  inz(0)
     d  d_os_tilt                    17  2 overlay(d_obks:86)  inz(0)
     d  d_os_frat                    17  2 overlay(d_obks:103) inz(0)
      *
      * Local Data Area LDA
      *
     d                uds
7.01 d l_poff                584    584
7.01 d l_bach                595    635
7.01 d l_skje                637    637  0
     d l_ruti                800    809
     d l_alin                856    858  0
     d l_firm                944    946  0
      *
7.01 d splfname2       s             10a
7.01 d jobname2        s             10a
7.01 d username2       s             10a
7.01 d jobnbr2         s              6a
7.01 d splfnbr2        s             10i 0
7.01 d splfname3       s             10a
7.01 d jobname3        s             10a
7.01 d username3       s             10a
7.01 d jobnbr3         s              6a
7.01 d splfnbr3        s             10i 0
      *
      * Definering av variable i nøkler
      *
     d ledilr_type     s                   like(litype)
     d ledilr_mnum     s                   like(limnum)
     d ledilr_mlin     s                   like(limlin)
     d ledil1_type     s                   like(litype)
     d ledil1_mnum     s                   like(limnum)
5.60 d ledil1_mlin     s                   like(limlin)
     d lodtl1_line     s                   like(ldline)
     d lodtl1_numm     s                   like(ldnumm)
     d lodtl1_suff     s                   like(ldsuff)
     d lohel1_numm     s                   like(lonumm)
     d lohel1_suff     s                   like(losuff)
     d rlevl1_levr     s                   like(rllevr)
     d vvenlr_vare     s                   like(vevare)
     d vvenlr_enhe     s                   like(veenhe)
     d vvarl3_nobb     s                   like(vvnobb)
     d aforl1_ruti     s                   like(afruti)
6.30 d ledilu_type     s                   like(litype)
6.30 d ledilu_mnum     s                   like(limnum)
6.30 d ledilu_mlin     s                   like(limlin)
      *
      * Definering av variable i parametre
      *
     d p_prec          s             45
      *
      * Definering av øvrige variable
      *
     d w_firm          s                   like(lofirm)
      *
5.60 dw_pris           s             10  3
5.60 dw_rabb           s             10  3
5.60 dw_anta           s             10  3
5.60 dw_suml           s             15  3
      *
     d w_omr1          s                   like(veomre)
     d w_omr2          s                   like(veomre)
      *
5.60 d                 ds
 .   d w_dmy                          6
 .   d  w_yy                          2    overlay(w_dmy:5)
 .   d  w_mm                          2    overlay(w_dmy:3)
 .   d  w_dd                          2    overlay(w_dmy:1)
5.60 d  w_dmyN                        6  0 overlay(w_dmy:1)
      *
5.60  * Venstrestiller 6 siffer tall (sr_left6)
 .   d                 ds
6.nu d w_num8                         8S 0
6.nu d  w_a8                          8    overlay(w_num8:1)
6.nu d  w_a7                          7    overlay(w_num8:2)
6.nu d  w_a6                          6    overlay(w_num8:3)
6.nu d  w_a5                          5    overlay(w_num8:4)
6.nu d  w_a4                          4    overlay(w_num8:5)
6.nu d  w_a3                          3    overlay(w_num8:6)
6.nu d  w_a2                          2    overlay(w_num8:7)
6.nu d  w_a1                          1    overlay(w_num8:8)
6.nu d w_left8         s              8A
5.60 d w_lines         s              6S 0 inz(*zero)
6.32 d w_lv_vare       s                   like(vvvare)
      *
5.60  * Ekstra felter i forb med avviksliste
 .   d b_feil          s              1    inz(*off)
 .   d b_diff          s              1    inz(*off)
 .   d w_bbest         s             15  2
 .   d w_bfakt         s             15  2
 .   d w_nobb          s              8
 .   d d_ol_bnet       s             15  2
 .   d vvarl1_vare     s                   like(vvvare)
 .    *
 .    * Bestillingslinjer brukt i edi-bekreftelse
 .   d eb_lin          s              4  0 dim(1000)
 .   d eb_max          s              4  0 inz(*zero)
 .   d eb_ptr          s              4  0 inz(*zero)
 .    *
 .   d                 ds
 .   d eb_nobbN                       8  0
5.60 d eb_nobbC                       8    overlay(eb_nobbN)
6.11  *
6.11  * Ordrebekreftelse Linje
6.11  *
6.11 d w_obkl          ds           400
6.31 d  w_test2                       1    overlay(w_obkl:10)
6.11 d  w_test                        1    overlay(w_obkl:46)
      *
      * Setter på usropn, trenger et flagg
     dw_flagg          s              1    inz('0')
      *
      * Definering av Konstanter
      *
     d c_01            c                   'Ordrebekreftelsenr:'
     d c_02            c                   'Ordrebekreftelse:'
      *
7.01 d qsprilsp        pr                  extpgm('QSPRILSP')
7.01 d rcvvar                     32767a   options(*varsize)
7.01 d rcvvarlen                     10i 0 const
7.01 d format                         8a   const
7.01 d errorcode                  32767a   options(*varsize)
7.01  *
7.01 d sprl0100        ds
7.01 d  bytesrtn                     10i 0
7.01 d  bytesavl                     10i 0
7.01 d  splfname                     10a
7.01 d  jobname                      10a
7.01 d  username                     10a
7.01 d  jobnbr                        6a
7.01 d  splfnbr                      10i 0
7.01 d  systemname                    8a
7.01 d  createdate                    7a
7.01 d                                1a
7.01 d  createtime                    6a
7.01  *
7.01 d errorcode       ds
7.01 d  bytesprov                    10i 0 inz(0)
7.01 d  byteavail                    10i 0 inz(0)
      *
7.01 d p_btyp          s            100
      *
7.01 d p_tagg0         s             20
7.01 d p_tagg0val      s             50
7.01 d p_tagg1         s             20
7.01 d p_tagg1val      s             50
7.01 d p_tagg2         s             20
7.01 d p_tagg2val      s             50
7.01 d p_tagg3         s             20
7.01 d p_tagg3val      s             50
7.01 d p_tagg4         s             20
7.01 d p_tagg4val      s             50
7.01 d p_tagg5         s             20
7.01 d p_tagg5val      s             50
7.01 d p_tagg6         s             20
7.01 d p_tagg6val      s             50
7.01 d p_tagg7         s             20
7.01 d p_tagg7val      s             50
7.01 d p_tagg8         s             20
7.01 d p_tagg8val      s             50
7.01 d p_tagg9         s             20
7.01 d p_tagg9val      s             50
7.01 d p_refn          s             50
7.01 d w_date          s               d   datfmt(*iso)
7.01 d p_dspl          s            100
7.01 d p_lr            s              1
7.01 d p_str_in        s            512
7.01 d p_str_out       s            512
7.01 d w_1lnav         s             50
7.01 d w_lvfa          s             35
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Definering av formater
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * A1HDR  - Heading A1 på rapport
      * D1DET  - Detail  D1 på rapport, Varelinje
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Styre-rutine
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
6.32 c/Exec SQL
6.32 c+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
6.32 c/End-Exec
      * Hent EDI meldings-hode
      *
     c                   eval      ledilr_type = d_type
     c                   eval      ledilr_mnum = d_mnum
     c                   eval      ledilr_mlin = d_mlin
     c     ledilr_key    chain     ledilr
     c                   if        not %found or
     c                             limlin <> 100001
     c                   goto      end_pgm
     c                   endif
     c                   eval      d_obkh = limeld
      *
     c                   if        linumm = 0
     c                   eval      a1fnav = *blank
     c                   eval      a1fad1 = *blank
     c                   eval      a1fad2 = *blank
     c                   eval      a1fste = *blank
     c                   eval      a1dref = *blank
     c                   eval      a1vref = *blank
     c                   eval      a1eanr = *blank
     c                   eval      a1besn = *blank
     c                   goto      skriv_head
     c                   endif
      *
     c                   eval      d_obkh = limeld
      *
5.60  * Behandler felter fra ordrehode flatfila
 .    *
 .   c                   if        d_oh_obnr2 <> *blanks
 .   c                   eval      a1tx1 = c_01
 .   c                   eval      a1bknr = %subst(d_oh_obnr:1:22)
 .   c                   else
 .   c                   eval      a1tx1 = c_02
 .   c                   eval      a1bknr = 'Bekr.nr: ' + d_oh_obnr1
 .   c                   endif
 .    *
 .   c                   eval      a1bmsg = *blanks
 .   c                   eval      a1bmsg = 'Akseptert uten endring'
 .    *
 .   c                   if        d_oh_aksp = '4  '
 .   c                   eval      a1bmsg = 'Akseptert med endring '
 .   c                   endif
 .   c                   if        d_oh_aksp = '12 '
 .   c                   eval      a1bmsg = 'Ikke behandlet        '
 .   c                   endif
 .   c                   if        d_oh_aksp = '27 '
 .   c                   eval      a1bmsg = 'Ikke akseptert        '
 .   c                   endif
 .   c                   if        d_oh_aksp = '29 '
 .   c                   eval      a1bmsg = 'Akseptert uten endring'
5.60 c                   endif
      *
      * Hent bestillings-hode
      *
     c                   eval      lohel1_numm = linumm
     c                   eval      lohel1_suff = lisuff
     c     lohel1_key    chain     lohel1r
     c                   if        not %found
     c                   goto      end_pgm
     c                   endif
      *
     c                   eval      a1dref = lovref
      *
6.nu c                   eval      w_num8 = lonumm
 .   c                   exsr      sr_left6
6.nu c                   eval      a1besn = w_left8
6.nu c                   eval      w_num8 = loornr
 .   c                   exsr      sr_left6
6.nu c                   eval      a1ornr = w_left8
      *
      * Hent informasjon fra leverandør
      *
     c                   eval      rlevl1_levr = loldor
     c     rlevl1_key    chain     rlevl1r
     c                   if        not %found
     c                   eval      a1fnav = *blank
     c                   eval      a1fad1 = *blank
     c                   eval      a1fad2 = *blank
     c                   eval      a1fste = *blank
     c                   eval      a1vref = *blank
     c                   eval      a1eanr = *blank
     c                   else
     c                   eval      a1fnav = rlnavn
     c                   eval      a1fad1 = rlgate
     c                   eval      a1fad2 = rladr2
     c                   eval      a1fste = rlsted
5.60  * Kjøp ref kan være fakt.mottagers ean + vår ref.
 .   c                   testn                   d_oh_kref1           23
 .   c                   if        *in23 = *on
 .   c                   eval      a1vref = d_oh_kref2
 .   c                   eval      a1eanr = d_oh_kref1
 .   c                   else
 .    * Nei, bare vår ref.
 .   c                   eval      a1vref = d_oh_kref
 .   c                   endif
 .    * Fjern 0'er
 .   c                   if        a1eanr = '0000000000000'
 .   c                   eval      a1eanr = *blanks
 .   c                   endif
5.60  *
     c                   endif
      *
5.60  * Hent totalpost bekreftelse (hører sammen med hode)
 .   c                   eval      ledil1_type = d_type
 .   c                   eval      ledil1_mnum = d_mnum
 .   c                   eval      ledil1_mlin = 900001
 .   c     ledil1_key2   chain     ledil1r                            91
 .   c                   if        *in91 = *on
 .   c                   eval      a1btot = 0
 .   c                   eval      a1ntot = 0
 .   c                   else
 .   c                   eval      d_obks = limeld
 .   c                   eval      a1btot = d_os_btot
 .    *
 .    * Sett inn nettototal, hvis mangler forutsett "total"=nettototal
 .   c                   if        d_os_ntot = 0
 .   c                   eval      a1ntot = d_os_suml
 .   c                   else
 .   c                   eval      a1ntot = d_os_ntot
 .   c                   endif
 .    *
5.60 c                   endif
      *
5.60  * Sjekker for mottager / sluttmottager; NAD DP eller NAD UD
 .   c                   eval      *in88 = *off
 .   c                   eval      a1eanm = *blanks
 .   c                   eval      a1mnav = *blanks
 .   c                   eval      a1mad1 = *blanks
 .   c                   eval      a1mad2 = *blanks
 .   c                   eval      a1mste = *blanks
 .    *
 .   c                   eval      ledil1_type = d_type
 .   c                   eval      ledil1_mnum = d_mnum
 .   c     ledil1_key    setll     ledil1r
 .   c     sok_nad       tag
 .   c     ledil1_key    reade     ledil1r
 .    *
 .   c                   dow       not %eof
 .   c                   if        *in88 = *on
 .   c                   goto      sok_end
 .   c                   endif
 .    *
 .    * Bare NAD linjer
 .   c                   if        limlin < 200001 or
 .   c                             limlin > 200009
 .   c                   goto      sok_nad
 .   c                   endif
 .    *
 .    * Sjekk om DP eller UD
 .   c                   eval      d_obkh5 = limeld
 .   c                   if        d_oh_part <> 'DP '
 .   c                             and d_oh_part <> 'UD '
 .   c                   goto      sok_nad
 .   c                   endif
 .   c                   if        d_oh_part <> 'UD '
 .   c                   eval      *in88 = *on
 .   c                   eval      a1eanm =  *blanks
 .   c                   else
 .   c                   if        d_oh_pean <> 0
 .   c                   eval      a1eanm =  d_oh_peanC
 .   c                   endif
 .   c                   endif
 .    *
 .    * Sett inn verdier
 .   c                   eval      a1mnav = d_oh_pnav
 .   c                   eval      a1mad1 = d_oh_pad1
 .   c                   eval      a1mad2 = d_oh_pad2
 .   c                   eval      a1mste = d_oh_pste
 .    *
 .   c                   goto      sok_nad
 .   c                   enddo
 .   c     sok_end       tag
 .   c                   if        a1mnav <> *blanks
 .   c                   eval      *in35 = *on
 .   c                   else
 .   c                   eval      *in35 = *off
5.60 c                   endif
      *
      * Skrive heading
      *
     c     skriv_head    tag
      *
5.60  * Summerer linjer u.utskrift for linje-total til utskriftshodet.
 .   c     calc_ltot     tag
 .   c                   eval      *in38 = *on
 .   c                   eval      w_suml = 0
 .   c                   goto      beh_det
 .    *
 .    * Ferdig summering, skal printe hode og så behandle linjer.
 .   c     calc_ltot_E   tag
 .   c                   eval      *in38 = *off
 .    * Sjekker avvik mot netto og setter bare "pris" hvis for mye.
 .   c                   if        w_suml > (a1ntot * 1,01)
 .   c                   eval      a1tx2 = '    Pris'
 .   c                   else
 .   c                   eval      a1tx2 = 'Nto.pris'
 .   c                   endif
 .    *
5.60  * Printer utskriftshode
      *
     c                   eval      a1eanl = d_oh_sean
     c     *dmy          move      limdat        a1dato
     c     *hms          move      limtid        a1time
      *
      * åpner printer 1.ste gang det er noe å skrive
     c                   if        w_flagg = *off
     c                   eval      w_flagg = *on
     c                   open      LI602P
     c                   endif
     c                   write     a1hdr
6.30  * Sjekk om det generell topptekst. Bruker LU nindeksen for å slippe
6.30  * gjøre store endringer med prefiksing av eksisterende felter.
6.30 c                   eval      ledilu_type = d_type
6.30 c                   eval      ledilu_mnum = d_mnum
6.30 c                   eval      ledilu_mlin = 350000
6.30 c     ledilu_key    setll     ledilur
6.30 c     ledilu_key2   reade     ledilur
6.30  *
6.30 c                   dow       not %eof
6.30  *
6.30 c                   if        xxmlin < 350000 or
6.30 c                             xxmlin > 359999
6.30 c                   goto      beh_det
6.30 c                   endif
6.30  *
6.30 c                   eval      d_obkh3 = xxmeld
6.30 c                   eval      h1text = d_oh_ftxt
6.30 c                   write     h1txt                                30
6.30 c   30              write     a1hdr
6.30  *
6.30 c     ledilu_key2   reade     ledilur
6.30  *
6.30 c                   enddo
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * D1DET Behandle detail D1
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Les varelinjer, finn tilleggsinformasjon og skriv ut.
      *
5.60 c     beh_det       tag
     c                   eval      ledil1_type = d_type
     c                   eval      ledil1_mnum = d_mnum
     c     ledil1_key    setll     ledil1r
     c     ledil1_key    reade     ledil1r
      *
     c                   dow       not %eof
      *
     c                   if        limlin < 500000 or
     c                             limlin > 649999
     c                   goto      les_forbi
     c                   endif
      *
det1 c                   if        limlin < 549999
      *
6.11 c**                 eval      d_obkl = limeld
6.11 c                   eval      w_obkl = limeld
6.11 c                   exsr      obkl_konv
6.33 c                   if        d_ol_vnob <> 0
6.32  * sjekker om logistikk-vare
6.32 c                   eval      w_lv_vare = *blank
6.32 c/exec sql
6.32 c+ select vvlvnr
6.32 i+ into   :w_lv_vare
6.32 c+ from   vvlepf
6.32 c+ where  vvlnob = :d_ol_vnob and
6.32 c+        vvlldo = :loldor
6.32 c+ fetch first 1 rows only
6.32 c/end-exec
6.32 c                   if        w_lv_vare <> *blank
6.33 c**                 move      w_lv_vare     d1vare
6.33 c                   movel     w_lv_vare     d1vare
6.32 c                   else
     c                   eval      d1vare = d_ol_vnob
6.32 c                   endif
6.33 c                   else
6.33 c                   eval      d1vare = d_ol_vnob
6.33 c                   endif
     c                   eval(h)   d1anta = d_ol_lkva
5.60 c                   eval      w_anta = d_ol_lkva
     c                   eval      d1enh1 = d_ol_lenh
5.60  *
 .    * Finn og sett inn lovetdato
 .   c  N38              eval      w_dd = d_dd
 .   c  N38              eval      w_mm = d_mm
 .   c  N38              eval      w_yy = d_yy
 .   c  N38              eval      d1dato = w_dmyN
 .   c  N38w_dmyN        comp      010101                               8787
5.60  *
      *
      * Finn nettopris
      *
     c                   exsr      beregn_pris
      *
     c                   if        d_ol_penh <> *blank and
     c                             d_ol_benh <> d_ol_penh
     c                   exsr      omregn_pris
     c                   endif
5.60 c                   eval(h)   d1npri = w_pris
      *
      * Oppslag mot vareregister
      *
6.32  * sjekker om logistikk-vare
6.32 c                   eval      w_lv_vare = *blank
6.32 c/exec sql
6.32 c+ select vvlvnr
6.32 c+ into   :w_lv_vare
6.32 c+ from   vvlepf
6.32 c+ where  vvlnob = :d_ol_vnob
6.32 c+ fetch first 1 rows only
6.32 c/end-exec
6.32 c                   if        w_lv_vare <> *blank
6.32 c                   eval      vvvare = w_lv_vare
6.32 c                   else
     c                   eval      vvarl3_nobb = d_ol_vnob
     c     vvarl3_key    chain     vvarl3r
6.32 c                   endif
     c                   eval      d1tek1 = d_ol_txt1
      *
      * Avviksliste?
     c                   if        *in38 = *off
     c                   if        limlin > 500000 and
     c                             limlin < 550000
     c   39              exsr      sr_avvik50
     c                   endif
     c                   endif
      *
5.60 c                   if        *in38 = *off
 .   c                   write     d1det                                30
5.60 c   30              write     a1hdr
 .   c                   if        d1sts1 <> 'U' and *in39=*on
 .   c                   write     d2det                                30
5.60 c   30              write     a1hdr
 .   c                   endif
 .   c                   else
5.60 c                   eval      w_lines = w_lines + 1
 .   c                   eval      w_suml = w_suml + (w_anta * d1npri)
5.60 c                   endif
      *
det1 c                   endif
      *
      * Avviksliste?
     c                   if        *in38 = *off and *in39=*on
     c                   if        limlin >= 600000 and
     c                             limlin <  650000
     c                   exsr      sr_avvik60
     c                   endif
      *
     c**                 endif
      *
     c                   endif
6.30  * Sjekk om det varelinjetekst. Bruker LU nindeksen for å slippe
6.30  * gjøre store endringer med prefiksing av eksisterende felter.
6.30 c                   if        w_flagg = *on
6.30 c                   eval      ledilu_type = d_type
6.30 c                   eval      ledilu_mnum = d_mnum
6.30 c                   eval      ledilu_mlin = 700000
6.30 c     ledilu_key    setll     ledilur
6.30 c     ledilu_key2   reade     ledilur
6.30  *
6.30 c                   dow       not %eof
6.30  *
6.30 c                   if        xxmlin < 700000 or
6.30 c                             xxmlin > 749999
6.30 c                   goto      les_forbi
6.30 c                   endif
6.30  *
6.30 c                   eval      d_obkl15 = xxmeld
6.30 c                   if        d_ol_lref = limlin
6.30 c                   eval      h1text = d_ol_ftxt
6.30 c                   write     h1txt                                30
6.30 c   30              write     a1hdr
6.30 c                   endif
6.30  *
6.30 c     ledilu_key2   reade     ledilur
6.30  *
6.30 c                   enddo
6.30 c                   endif
      *
     c     les_forbi     tag
      *
      *
     c     ledil1_key    reade     ledil1r
      *
     c                   enddo
5.60 c   38              eval(H)   a1ltot = w_suml
      *
5.60  * En runde til hvis dette var summering til utskriftshodet
 .    *
5.60 c   38              goto      calc_ltot_E
      *
      * Skriver evt også best.linjer uten edi-linjer
     c                   if        *in39=*on
     c                   exsr      sr_avvik55
     c                   endif
      *
      * Avslutt program
      *
     c     end_pgm       tag
     c                   if        w_flagg = *on
7.01  * Generer xml for videre utskrift
7.01 c                   if        l_poff = '1'
7.01 c                   exsr      spoolnbr
7.01 c                   exsr      xml_create
7.01 c                   close     LI602P
7.01 c                   exsr      pdf_preview
7.01  * Avslutt jobbiden
7.01 c                   call      'AB710R'
7.01 c                   parm                    l_bach
7.01 c                   endif
     c                   endif
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.60  * Subrutine for avviksliste 500.000 - 549.999
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avvik sts1-3:  UN = Finner ikke b.linje   ... avslutter ktrl
      * rapporterer    N  = Nobbnr (ulikt nobbnr) ... avslutter ktrl
      * maks 3 feil.   M  = Mengde (ulikt antall)  1-3
      *                E  = Enhet  (ulik enhet  )  1-3
      *                P  = Pris   (priskontroll)  1-3
      *
     c     sr_avvik50    begsr
     c                   clear                   d1sts1
     c                   clear                   d1sts2
     c                   clear                   d1sts3
      *
     c                   exsr      sjekk_stat
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.60  * Subrutine for avviksliste 550.000 - 599.999
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sr_avvik55    begsr
     c                   eval      lodtl1_numm = linumm
     c                   eval      lodtl1_suff = lisuff
     c                   eval      lodtl1_line = 0
     c     lodtl1_key    setll     lodtl1
     c     lodtl1_tagE   tag
     c     lodtl1_keyE   reade     lodtl1                               5656
     c                   if        *in56 = *off
     c     1             do        eb_max        eb_ptr
     c                   if        ldline = eb_lin(eb_ptr)
     c                   goto      lodtl1_tagE
     c                   endif
     c                   enddo
      * Skriv best.linje, evt overflow først?
     c                   if        *in30 = *on
     c                   write     a1hdr
     c                   endif
      *
     c                   clear                   d2vare
     c                   clear                   d2npri
     c                   if        ldnobb = 0
     c                   eval      d2vare = '00000000'
     c                   else
     c                   eval      eb_nobbN = ldnobb
     c                   eval      d2vare = eb_nobbC
     c                   endif
     c                   eval      d2tek1 = ldtek1
     c                   eval      d2anta = ldanta
     c                   eval      d2enh1 = ldenh1
     c                   eval      d2npri = ldipny
      *
     c                   write     d2det                                30
     c                   goto      lodtl1_tagE
     c                   endif
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.60  * Subrutine for avviksliste 600.000 - 649.999
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     sr_avvik60    begsr
     c                   clear                   d1sts1
     c                   clear                   d1sts2
     c                   clear                   d1sts3
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.60  * Subrutine for å sjekke tolleranse
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     sjk_toleranse begsr
      *
     c                   eval      b_diff = *off
      *
      * Leser toleransetabell
      *
     c     ltoel1_key    chain     ltoel1
     c                   if        not %found
      *
5.60  * Viser avviksmarkering bare hvis avvikskontroll er enablet.
5.60 c*                  eval      b_diff = *on
5.60 c                   eval      b_diff = *off
     c                   leavesr
     c                   endif
      *
      * Sjekk om fakt.beløp lavere enn beløp under minste toleransegrense
      *
     c                   if        w_bfakt < laetg0
     c                   eval      b_diff = *on
     c                   leavesr
     c                   endif
      *
      * Sjekk om fakt.beløp lavere enn avviksgrense 1
      *
     c                   if        w_bfakt < laetg1
     c                   if        %abs(w_bfakt - w_bbest) > laeav1
     c                   eval      b_diff = *on
     c                   endif
     c                   leavesr
     c                   endif
      *
      * Sjekk om fakt.beløp lavere enn avviksgrense 2
      *
     c                   if        w_bfakt < laetg2
     c                   if        %abs(w_bfakt - w_bbest) > laeav2
     c                   eval      b_diff = *on
     c                   endif
     c                   leavesr
     c                   endif
      *
      * Sjekk om fakt.beløp lavere enn avviksgrense 3
      *
     c                   if        w_bfakt < laetg3
     c                   if        %abs(w_bfakt - w_bbest) > laeav3
     c                   eval      b_diff = *on
     c                   endif
     c                   leavesr
     c                   endif
      *
      * Sjekk om fakt.beløp lavere enn avviksgrense 4
      *
     c                   if        w_bfakt < laetg4
     c                   if        %abs(w_bfakt - w_bbest) > laeav4
     c                   eval      b_diff = *on
     c                   endif
     c                   leavesr
     c                   endif
      *
      * Sjekk om fakt.beløp høyere enn avviksgrense 4
      *
     c                   if        w_bfakt >= laetg4
     c                   if        %abs(w_bfakt - w_bbest) > laeav5
     c                   eval      b_diff = *on
     c                   endif
     c                   leavesr
     c                   endif
      *
     c     end_sjk       endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.60  * Subrutine for les av bestillingslinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     les_best      begsr
      *
     c                   eval      b_feil = *off
     c                   eval      lodtl1_numm = linumm
     c                   eval      lodtl1_suff = lisuff
     c                   eval      lodtl1_line = liline
     c     lodtl1_key    chain     lodtl1
     c                   if        not %found
     c                   eval      b_feil = *on
     c                   else
5.60 c                   eval      eb_max = eb_max + 1
5.60 c                   eval      eb_lin(eb_max) = liline
     c                   endif
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.60  * Subrutine for setting av kontrollstatus
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     sjekk_stat    begsr
      *
      * Nullstill statusfelter
      *
     c                   eval      d1sts1 = *blank
     c                   eval      d1sts2 = *blank
     c                   eval      d1sts3 = *blank
      *
      * Les bestilling og sjekk nobbnr
      *
     c                   exsr      les_best
      *
     c                   if        b_feil = *on
     c                   eval      d2vare = *blank
     c                   eval      d2anta = 0
     c                   eval      d2enh1 = *blank
     c                   eval      d2npri = 0
     c                   eval      d2tek1 = *blank
     c                   eval      d1sts1 = 'U'
     c                   eval      d1sts2 = 'N'
     c                   goto      end_stat
     c                   endif
      *
     c                   movel     ldvare        d2vare
     c                   eval      d2anta = ldanta
     c                   eval      d2enh1 = ldenh1
     c                   eval      d2npri = ldipny
     c                   eval      d2tek1 = ldtek1
      *
     c                   if        ldlvre = 0
     c                   eval      vvarl1_vare = ldvare
     c     vvarl1_key    chain     vvarl1
     c                   if        not %found
     c                   eval      d1sts1 = 'N'
     c                   endif
     c                   if        %found
5.60 c                   move      d_ol_vnob     w_nobb
5.60 c                   if        vvnobb <> d_ol_vnob or
     c                             %subst(vvvare:1:8) <> w_nobb
     c                   eval      d1sts1 = 'N'
     c                   endif
     c                   endif
     c                   endif
      *
      * Sjekker pris og mengde
      *
     c                   if        b_feil = *off
5.60 c                   if        d_ol_lkva <> ldanta
     c                   if        d1sts1 = *blank
     c                   eval      d1sts1 = 'M'
     c                   else
     c                   eval      d1sts2 = 'M'
     c                   endif
     c                   endif
      *
5.60 c                   if        d_ol_benh <> ldenh1 and
5.60 c                             d_ol_benh <> *blank
     c                   if        d1sts1 = *blank
     c                   eval      d1sts1 = 'E'
     c                   else
     c                   if        d1sts2 = *blank
     c                   eval      d1sts2 = 'E'
     c                   else
     c                   eval      d1sts3 = 'E'
     c                   endif
     c                   endif
     c                   endif
      *
5.60 c                   eval      d_ol_bnet = d_ol_lkva * d1npri
5.60 c                   if        d_ol_bnet <> 0 and
5.60 c                             d_ol_bnet <> (ldipny * ldanta)
      *
TSV;  * Ønsker ikke følgefeil pris på feil i mengde:
TSV;  * Hvis ulikhet bruk faktisk (edi-kv.levert) for smlgnbare priser
5.60 c                   if        d_ol_lkva <> ldanta
 .   c                   eval(h)   w_bbest = ldipny * d_ol_lkva
 .   c                   else
 .   c                   eval(h)   w_bbest = ldipny * ldanta
5.60 c                   endif
      *
5.60 c                   eval      w_bfakt = d_ol_bnet
     c                   exsr      sjk_toleranse
      *
     c                   if        b_diff = *on
     c                   if        d1sts1 = *blank
     c                   eval      d1sts1 = 'P'
     c                   else
     c                   if        d1sts2 = *blank
     c                   eval      d1sts2 = 'P'
     c                   else
     c                   if        d1sts3 = *blank
     c                   eval      d1sts3 = 'P'
     c                   else
5.60 c**                 eval      d1sts4 = 'P'
     c                   endif
     c                   endif
     c                   endif
     c                   endif
     c                   endif
     c                   endif
      *
     c     end_stat      endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for bergning av pris med tanke på rabatter mm.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     beregn_pris   begsr
      *
      * Rabatt?
      *
     c                   eval      w_rabb = 0
5.60 c*                  if        d_ol_tty1 = 'DI '
     c                   if        d_ol_prkv = 'AAB'
     c                   if        d_ol_tpr1 <> 0
     c                   eval      w_rabb = (d_ol_pris * d_ol_tpr1) / 100
     c                   else
     c                   eval      w_rabb = d_ol_tbe1
     c                   endif
     c                   endif
5.60 c*                  endif
      *
      * Nobb pris?
      *
     c                   if        d_ol_prkv = 'AAB'
     c                   eval      w_pris = d_ol_pris - w_rabb
     c                   else
     c                   eval      w_pris = d_ol_pris
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for omregning av pris hvis avvikende prisenhet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     omregn_pris   begsr
      *
     c                   eval      vvenlr_vare = vvvare
     c                   eval      vvenlr_enhe = d_ol_benh
     c     vvenlr_key    chain     vvenlr
     c                   if        not %found
     c                   eval      w_omr1 = 1
     c                   else
     c                   eval      w_omr1 = veomre
     c                   endif
      *
     c                   eval      vvenlr_enhe = d_ol_penh
     c     vvenlr_key    chain     vvenlr
     c                   if        not %found
     c                   eval      w_omr2 = 1
     c                   else
     c                   eval      w_omr2 = veomre
     c                   endif
      *
     c                   eval(h)   w_pris = (w_omr1 / w_omr2) * w_pris
      *
     c                   endsr
      *
5.60  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.nu  * Subrutine lager venstrestillt alfafelt av numerisk felt 8.0
 .    * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sr_left6      begsr
6.nu c                   eval      w_left8 = *blanks
      *
6.nu c                   if        w_num8 > 9999999
6.nu c                   movel     w_a8          w_left8
6.nu c                   goto      sr_left6_e
6.nu c                   endif
6.nu c                   if        w_num8 > 999999
6.nu c                   movel     w_a7          w_left8
6.nu c                   goto      sr_left6_e
6.nu c                   endif
6.nu c                   if        w_num8 > 99999
6.nu c                   movel     w_a6          w_left8
     c                   goto      sr_left6_e
     c                   endif
6.nu c                   if        w_num8 > 9999
6.nu c                   movel     w_a5          w_left8
     c                   goto      sr_left6_e
     c                   endif
6.nu c                   if        w_num8 > 999
6.nu c                   movel     w_a4          w_left8
     c                   goto      sr_left6_e
     c                   endif
6.nu c                   if        w_num8 > 99
6.nu c                   movel     w_a3          w_left8
     c                   goto      sr_left6_e
     c                   endif
6.nu c                   if        w_num8 > 9
6.nu c                   movel     w_a2          w_left8
     c                   goto      sr_left6_e
     c                   endif
6.nu c                   if        w_num8 > 0
6.nu c                   movel     w_a1          w_left8
     c                   goto      sr_left6_e
     c                   endif
 .    *
5.60 c     sr_left6_e    endsr
      *
      *
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  * Subrutine for plassere ordrelinje inn i riktig ds struktur
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  *
6.11 c     obkl_konv     begsr
6.11  *
6.31  * 13 siffers GTIN, men i ny struktur
6.31 c                   if        w_test2 = '0'
6.31 c                   eval      d_obkl = limeld
6.31 c                   else
6.11 c                   if        w_test <> '0'
6.11 c                   eval      d_obkl = limeld
6.11 c                   else
6.11  * GTIN nr er lagt ut med 13 siffers struktur (gammel)
6.11 c                   eval      x_obkl = limeld
6.11 c                   eval      d_ol_llin = x_ol_llin
6.11 c                   eval      d_ol_laks = x_ol_laks
6.11 c                   eval      d_ol_vean = x_ol_vean
6.11 c                   eval      d_ol_vnob = x_ol_vnob
6.11 c                   eval      d_ol_vlev = x_ol_vlev
6.11 c                   eval      d_ol_bkva = x_ol_bkva
6.11 c                   eval      d_ol_benh = x_ol_benh
6.11 c                   eval      d_ol_lkva = x_ol_lkva
6.11 c                   eval      d_ol_lenh = x_ol_lenh
6.11 c                   eval      d_ol_llda = x_ol_llda
6.11 c                   eval      d_ol_pris = x_ol_pris
6.11 c                   eval      d_ol_penh = x_ol_penh
6.11 c                   eval      d_ol_prpr = x_ol_prpr
6.11 c                   eval      d_ol_prkv = x_ol_prkv
6.11 c                   eval      d_ol_epri = x_ol_epri
6.11 c                   eval      d_ol_evar = x_ol_evar
6.11 c                   eval      d_ol_linr = x_ol_linr
6.11 c                   eval      d_ol_linb = x_ol_linb
6.11 c                   eval      d_ol_mvap = x_ol_mvap
6.11 c                   eval      d_ol_tkv1 = x_ol_tkv1
6.11 c                   eval      d_ol_tty1 = x_ol_tty1
6.11 c                   eval      d_ol_ttx1 = x_ol_ttx1
6.11 c                   eval      d_ol_tse1 = x_ol_tse1
6.11 c                   eval      d_ol_tme1 = x_ol_tme1
6.11 c                   eval      d_ol_ten1 = x_ol_ten1
6.11 c                   eval      d_ol_tpr1 = x_ol_tpr1
6.11 c                   eval      d_ol_tbe1 = x_ol_tbe1
6.11 c                   eval      d_ol_tkv2 = x_ol_tkv2
6.11 c                   eval      d_ol_tty2 = x_ol_tty2
6.11 c                   eval      d_ol_ttx2 = x_ol_ttx2
6.11 c                   eval      d_ol_tse2 = x_ol_tse2
6.11 c                   eval      d_ol_tme2 = x_ol_tme2
6.11 c                   eval      d_ol_ten2 = x_ol_ten2
6.11 c                   eval      d_ol_tpr2 = x_ol_tpr2
6.11 c                   eval      d_ol_tbe2 = x_ol_tbe2
6.11 c                   eval      d_ol_txt1 = x_ol_txt1
6.11 c                   eval      d_ol_txt2 = x_ol_txt2
6.11 c                   endif
6.31 c                   endif
6.11  *
6.11 c                   endsr
6.11  *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Finner spool som er generert av jobben
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     spoolnbr      begsr
7.01  /Free
7.01
7.01           QSPRILSP( SPRL0100
7.01                   : %size(SPRL0100)
7.01                   : 'SPRL0100'
7.01                   : errorcode );
7.01  /End-free
7.01 c*
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Kaller eget program for generering av xml fil. Eget pgm         *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     xml_create    begsr
7.01  *
7.01 c                   eval      splfname2 = *blanks
7.01 c                   eval      splfname3 = *blanks
7.01 c                   eval      jobname2 = *blanks
7.01 c                   eval      jobname3 = *blanks
7.01 c                   eval      username2 = *blanks
7.01 c                   eval      username3 = *blanks
7.01 c                   eval      jobnbr2 = *blanks
7.01 c                   eval      jobnbr3 = *blanks
7.01 c                   eval      splfnbr2 = *zeros
7.01 c                   eval      splfnbr3 = *zeros
7.01 c                   eval      p_btyp = 'EDI Oprdrebekreftelse'
7.01 c                   eval      p_refn = %char(%subdt(w_date:*years)) +
7.01 c                             a1bknr
7.01  * Sender med metatagger for bedre gjenfinning
7.01  * Leverandørnavn
7.01 c                   eval      p_tagg0 = 'LEVERANDØRNAVN'
7.01 c                   eval      p_str_in = *blank
7.01 c                   eval      p_lr = '0'
7.01 c                   movel     a1mnav        p_str_in
7.01 c                   call      'AP613R'
9.11 c                   parm                    p_str_in
7.01 c                   parm                    p_str_out
7.01 c                   parm                    p_lr
7.01 c                   movel     p_str_out     w_1lnav
7.01 c                   eval      p_tagg0val = w_1lnav
7.01  *
7.01 c                   eval      p_dspl = 'EDI Ordrebek: ' + a1bknr +
7.01 c                             'Lev: ' +
7.01 c                             %trim(w_1lnav) + '  Beløp ' + %char(a1btot)
7.01  * Fakturanummer
7.01 c                   eval      p_tagg1 = 'ORDREBEKREFTELSE'
7.01 c                   eval      p_tagg1val = %trim(a1bknr)
7.01  * Varelev. ordrebekreftelsesnummer
7.01 c                   eval      p_tagg2 = 'LEVFAKTURANR'
7.01 c                   eval      p_tagg2val = %trim(w_lvfa)
7.01  * Fakturadato
7.01 c                   eval      p_tagg3 = 'ORDREBEKREFTELSESDATO'
7.01 c                   eval      p_tagg3val = %char(a1dato)
7.01  * Fakturatotal
7.01 c                   eval      p_tagg4 = 'BELOP'
7.01 c                   eval      p_tagg4val = %char(a1btot)
7.01 c                   eval      p_tagg5 = *blanks
7.01 c                   eval      p_tagg5val = *blanks
7.01 c                   eval      p_tagg6 = *blanks
7.01 c                   eval      p_tagg6val = *blanks
7.01 c                   eval      p_tagg7 = *blanks
7.01 c                   eval      p_tagg7val = *blanks
7.01 c                   eval      p_tagg8 = *blanks
7.01 c                   eval      p_tagg8val = *blanks
7.01 c                   eval      p_tagg9 = *blanks
7.01 c                   eval      p_tagg9val = *blanks
7.01  *
7.01 c                   call      'AP627R'
7.01 c                   PARM                    splfname
7.01 c                   PARM                    jobname
7.01 c                   PARM                    username
7.01 c                   PARM                    jobnbr
7.01 c                   PARM                    splfnbr
7.01 c                   PARM                    splfname2
7.01 c                   PARM                    jobname2
7.01 c                   PARM                    username2
7.01 c                   PARM                    jobnbr2
7.01 c                   PARM                    splfnbr2
7.01 c                   PARM                    splfname3
7.01 c                   PARM                    jobname3
7.01 c                   PARM                    username3
7.01 c                   PARM                    jobnbr3
7.01 c                   PARM                    splfnbr3
7.01 c                   PARM                    p_tagg0
7.01 c                   PARM                    p_tagg0val
7.01 c                   PARM                    p_tagg1
7.01 c                   PARM                    p_tagg1val
7.01 c                   PARM                    p_tagg2
7.01 c                   PARM                    p_tagg2val
7.01 c                   PARM                    p_tagg3
7.01 c                   PARM                    p_tagg3val
7.01 c                   PARM                    p_tagg4
7.01 c                   PARM                    p_tagg4val
7.01 c                   PARM                    p_tagg5
7.01 c                   PARM                    p_tagg5val
7.01 c                   PARM                    p_tagg6
7.01 c                   PARM                    p_tagg6val
7.01 c                   PARM                    p_tagg7
7.01 c                   PARM                    p_tagg7val
7.01 c                   PARM                    p_tagg8
7.01 c                   PARM                    p_tagg8val
7.01 c                   PARM                    p_tagg9
7.01 c                   PARM                    p_tagg9val
7.01 c                   PARM                    l_bach
7.01 c                   PARM                    p_btyp
7.01 c                   parm                    p_refn
7.01 c                   parm                    p_dspl
7.01  *
7.01 c                   endsr
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01  * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
7.01 c     pdf_preview   begsr
7.01 c                   if        l_skje = 1
7.01  * Vi kaller program for launch av PDF i browser
7.01 c                   call      'AP621R'
7.01 c                   parm                    l_bach
7.01  *
7.01 c                   endif
7.01  *
7.01 c                   endsr
7.01  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_prec
     c                   eval      d_prec = p_prec
      *
     c                   eval      *in39 = *off
     c                   if        d_kode = 'A'
     c                   eval      *in39 = *on
     c                   eval      d_kode = *blank
     c                   endif
      *
      *  Key for les av MELDINGSLINJER
      *
     c     ledilr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ledilr_type
     c                   kfld                    ledilr_mnum
     c                   kfld                    ledilr_mlin
      *
      *  Key for posisjnering på MELDINGSLINJER
      *
     c     ledil1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ledil1_type
     c                   kfld                    ledil1_mnum
      *
5.60  *  Key for oppslag på MELDINGSLINJE
 .    *
 .   c     ledil1_key2   klist
 .   c                   kfld                    w_firm
 .   c                   kfld                    ledil1_type
 .   c                   kfld                    ledil1_mnum
5.60 c                   kfld                    ledil1_mlin
      *
      * Key for les av BESTILLINGSHODE
      *
     c     lohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lohel1_numm
     c                   kfld                    lohel1_suff
      *
      * Key for les av BESTILLINGSLINJE
      *
     c     lodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    lodtl1_numm
     c                   kfld                    lodtl1_suff
     c                   kfld                    lodtl1_line
      * ditto for READE samma
     c     lodtl1_keyE   klist
     c                   kfld                    w_firm
     c                   kfld                    lodtl1_numm
     c                   kfld                    lodtl1_suff
      *
      * Key for les av LEVERANDØR
      *
     c     rlevl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rlevl1_levr
      *
      * Key for les av vare-enhet
      *
     c     vvenlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenlr_vare
     c                   kfld                    vvenlr_enhe
      *
      * Key for les av vare
      *
     c     vvarl3_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl3_nobb
      *
      * Key for les av vare
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for les av FIRMA
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for les av FORMULAR
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      * Key for oppslag på toleranse/EDI
      *
     c     ltoel1_key    klist
     c                   kfld                    w_firm
6.30  *
6.30  *  Key for les av MELDINGSLINJER
6.30  *
6.30 c     ledilu_key    klist
6.30 c                   kfld                    w_firm
6.30 c                   kfld                    ledilu_type
6.30 c                   kfld                    ledilu_mnum
6.30 c                   kfld                    ledilu_mlin
6.30  *
6.30  *  Key for les av MELDINGSLINJER
6.30  *
6.30 c     ledilu_key2   klist
6.30 c                   kfld                    w_firm
6.30 c                   kfld                    ledilu_type
6.30 c                   kfld                    ledilu_mnum
      *
      * Hente inn rutine informasjon
      *
     c                   eval      w_firm = d_firm
     c                   eval      aforl1_ruti = l_ruti
      *
     c     aforl1_key    chain     aforl1r
     c                   if        %found
     c                   eval      a1txt1 = aftxt1
     c                   endif
      *
      * Hent firma-opplysninger dersom de skal printes ut
      *
     c     afirl1_key    chain     afirl1r
     c                   if        %found
     c                   eval      a1navn = aafnav
     c                   eval      a1adr1 = aafad1
     c                   eval      a1adr2 = aafad2
     c                   eval      a1sted = aafste
     c                   endif
      *
     c                   endsr
