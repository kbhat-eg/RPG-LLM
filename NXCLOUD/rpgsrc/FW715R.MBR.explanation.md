## Overview

This program (FW715R) is part of the **ASOFAK** system at Felleskjøpet Maskin. Its main task is to read an item data stream (from file FLVWPF), process and potentially transform this item information, and then write it into a supplier (vendor) item register (file FLVAPF). The flow involves:

1. Reading raw data from the input file (FLVWPF).
2. Converting, adjusting, and overlaying fields into a working data structure.
3. Optionally adjusting the unit of measure through a lookup in FENKL1 (an auxiliary table or file holding unit conversion data).
4. Setting timestamps and user information for audit purposes.
5. Writing processed records to the vendor item register (FLVAPF).

This program is typically called with parameters:
- p_firm (firm number)
- p_ldor (an additional, possibly date-related parameter representing a load- or run-control field)

It was originally introduced to populate a vendor item registry for Felleskjøpet Maskin, with later modifications to add tracking information.

---

## File Relationships

1. **FLVWPF** (Input File)
   - The program reads records from this file. Each record is mapped into the `d_inpu` data structure for parsing.

2. **FLVAPF** (Output File)
   - After processing each record, a new record is written to FLVAPF with the format FLVAPFR.

3. **FENKL1 (Renamed FENKPFR → FENKL1R)** (Lookup File)
   - Used for unit-of-measure conversions. If the unit code from the input exists in FENKL1, the program replaces the input unit code with a standardized value (`feenht`).

---

## Key Data Structures and Fields

### d_inpu
A single 662-byte data structure that is overlaid to extract relevant fields such as:
- d_ekod (change code)
- d_vare (item number)
- d_tek1, d_tek2 (item descriptions)
- d_eann (EAN number)
- d_enhe (unit of measure)
- d_dato (date field broken into day, month, year)
- d_inpr (purchase price)
- d_sapr (sales price)

The date is handled as separate components (d_dag, d_mnd, d_aar) to construct a six-digit value (w_dato).

### Unit Conversion
- The program sets `fenkl1_enhf` to the input unit code (`d_enhe`).
- It chains to FENKL1 (keyed by firm and unit code).  
- If found, it replaces `fwenhe` with the standardized unit code in `feenht`.

### Trimming and Character Replacement
- Trailing/leading spaces in item texts (d_tek1, d_tek2) are removed with `%trim`.
- Certain characters (represented by X'xx') are translated into local characters (æ, ø, å, or similar) because of legacy or EBCDIC/ASCII differences. This ensures consistent text in the final register.

---

## Processing Logic

1. **Reading Records**  
   The program reads records from FLVWPF in a loop until an end-of-file condition (indicator 90).

2. **Mapping Input to Data Structure**  
   Each read record is placed in the data structure `d_inpu` (via `eval d_inpu = fwirad`).

3. **Preparing Fields**  
   Several fields in the FLVAPF record (prefixed by `fw...`) are set:
   - `fwfirm`, `fwldor` are set from the parameters p_firm, p_ldor.  
   - `fwekod` (change code) is taken from `d_ekod`, with special handling if it equals `'X'` (it becomes blank).
   - `fwtek1`, `fwtek2` are trimmed versions of the item descriptions.
   - `fwlvar` is set to the item number (`d_vare`).
   - `fweann` (EAN), `fwinpr` (purchase price), `fwsapr` (sales price) are moved from their corresponding fields in `d_inpu`.
   - The date (`fwdato`) is built from the day, month, and year segments in `d_dato`, if present.

4. **Character Translations**  
   For both `fwtek1` and `fwtek2`, the code replaces frequent legacy characters with the correct local letters or symbols.

5. **Suppression of Duplicate Descriptions**  
   If `fwtek2` matches `fwtek1` exactly, the second description is cleared (set to blank).

6. **Unit of Measure Conversion**  
   The program constructs a lookup key (klist fenkl1_key) containing the firm and input unit code, then chains to FENKL1. If found, it replaces `fwenhe` with `feenht` from that record.

7. **Write to the Vendor Item Register**  
   After all transformations, the program writes a new record to FLVAPF (format FLVAPFR).

8. **Audit and Time Stamp**  
   At each iteration, the current time is retrieved and stored in:  
   - fwodat, fwotim, fwousr (for one set of time stamps)  
   - fwedat, fwetim, fweusr (for another set of recorded changes)  
   These fields reflect the user (l_user) and current time.  

9. **Loop Continuation**  
   The program reads the next record from FLVWPF and repeats until no more records exist (ind90 = *ON).

10. **Program End**  
   When the loop finishes, control is set to return and the program ends by setting *INLR = *ON.

---

## Noteworthy Details

- **Parameter Handling**: The program entry point uses a parameter list (plist) to retrieve `p_firm` and `p_ldor`. This is typical for batch programs: the caller sets these values, which then become part of each output record for auditing or identification.
- **Translation Table Usage**: Special translations (`xlate`) ensure that older character encodings are correctly mapped to local text. This is particularly important in Nordic character sets.
- **Data Overlaying**: The input structure `d_inpu` overlays specific bytes to parse each field. This is a common pattern in RPG for reading fixed-format files.
- **Unit Conversion Lookup**: By chaining to FENKL1 with the firm number and unit code, the program ensures consistency in unit designations across the application.
- **Date Construction**: Though the “endringsdato” is stored in multiple segments, the program consolidates it into a single numeric field `w_dato` (DDMMYY) that can be moved into `fwdato`.

---

## Conclusion

FW715R coordinates the creation and maintenance of a supplier item register in the Felleskjøpet Maskin system by reading records from FLVWPF, applying transformations and unit conversions, and writing the standardized data to FLVAPF. Its domain-specific focus is on ensuring correct item texts, unit of measure, and date fields, along with accurate audit timestamps and user tracking.