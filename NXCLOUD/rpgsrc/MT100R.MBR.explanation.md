# MT100R – Package Register Management

## Overview

This program, `MT100R`, is a core maintenance and inquiry utility for managing the package register ("pakkeregister") in the ASLAGR system. It provides a subfile-based user interface for viewing, adding, updating, and deleting package records, as well as for displaying package details, length distributions, history, and stock information. The program is tailored for the timber/lumber (trelast) industry, with various business-specific fields and logic.

## Key Concepts and Structure

### Main Responsibilities

- **Display and interact with package register records** via subfiles (paged lists).
- **Add new packages**, update or delete existing ones, with corresponding updates to package history and warehouse stock.
- **Support for filtering and positioning** within the register by various keys (package number, item number, warehouse, etc.).
- **Display of related information**: package details, length distribution, historical changes, and stock status.
- **Integration with security/access control** and other business modules.

### Files and Data Sources

The program interacts with several physical and logical files:

- `MTPAPFR` (and logicals): Main package register (various logical views for different access paths).
- `MUPAPFR`: Package history.
- `VVARPFR`: Article/item master data.
- `VVLEPF`: Supplier item cross-reference.
- Display files: Subfile (`B1SFL`), control (`B2CTL`), command (`B2CMD`), windows (`B4WIN`, `H2WIN`), detail screens (`C1BLD`, `C2BLD`, `D1BLD`).

### Indicators and Conventions

- Uses a well-documented indicator scheme:
  - 10–16: Subfile navigation and control.
  - 21–22: Cursor/home key.
  - 30–31: Field protection, error/warning display.
  - 80–99: Work and file indicators.

- Subfile navigation and state are managed via work variables (`w_srrn`, `w_spge`, etc.).
- Business logic is heavily reliant on status codes (`mtstat` for package status: active, deleted, etc.).

### Initialization

- Company number (`w_firm`) is loaded from LDA.
- The subfile is initially populated with all packages (`b2funk = 'ALLE'`).

---

## Main Program Flow

### 1. **Access Control**

- Calls `AX700R` to verify the user's access rights to the module.
- If denied (`w_stat = '1'`), the program exits.

### 2. **Main Display Loop**

- Presents the command window (`B2CMD`), then enters the main subfile display and processing loop (`exsr dsp_subfile`).
- Handles function keys for:
  - Exit (`*INKC`, `*INKL`)
  - Refresh (`*INKE`)
  - New package (`*INKF`)
  - Show all (`*INKG`), only shared (`*INKH`), or only deleted (`*INKI`) packages
  - Fetch new packages (`*INKJ`)
  - Show status codes (`*INKM`)
  - Subfile navigation (roll forward/backward: `*IN10`, `*IN11`)

- Positioning logic allows quick navigation to a specific package or item.

### 3. **Subfile Handling**

- **Subfile routines** manage display, navigation, and user actions (edit, delete, view details, etc.).
- **Subfile population** is filtered by package status and optional item/warehouse restrictions.

---

## Key Subroutines

### `forny` – Refresh Subfile

- Repositions the subfile based on the current cursor/record.
- Clears and repopulates the subfile.

### `posisjoner` – Positioning

- Positions the subfile to a specific package number or item number, depending on user input.
- Resets positioning fields after use.

### `subfile` – Main Subfile Processing

- Loops through visible subfile records.
- Handles user actions on each record:
  - Edit (`valg=2`): Calls `pakkedet`.
  - Delete (`valg=4`): Calls `slett_pakke`.
  - View details (`valg=5`): Calls `pakkedet` (view mode).
  - View length distribution (`valg=7`): Calls `vis_lengde`.
  - View history (`valg=8`): Calls `vis_historikk`.
  - View warehouse info (`valg=9`): Calls `vis_lager`.

### `ny_pakke` – Add New Package

- Presents a blank detail screen for input.
- Checks for duplicate package numbers before proceeding.
- Calls `pakkedet` to handle the new record.

### `pakkedet` – Package Details

- In "add" or "edit" mode, enables input fields; otherwise, view-only.
- Loads package details from the register for edit/view.
- Validates item numbers via `les_artikkel`.
- Handles function key navigation for length distribution, etc.

### `slett_pakke` – Delete Package

- Prompts for confirmation via a window.
- Marks the package as deleted (`mtstat = 'S'`), zeroes the quantity, and logs the user and timestamp.
- Writes an entry to package history and updates warehouse stock accordingly.

### `vis_lengde` – Show Length Distribution

- Loads and displays length distribution fields for the selected package.

### `vis_historikk`, `vis_lager`, `vis_status`

- Calls external programs or displays windows for package history, warehouse info, or status codes.

### `clr_subfile`, `crt_subfile`, `bck_subfile`

- Manage subfile clearing, population, and page-backward navigation.

### `dsp_subfile` – Display Subfile

- Handles display logic for the subfile and control record, including cursor positioning.

### `vis_alle`, `vis_delte`, `vis_slettede`

- Set the filter for subfile population by package status.

### `hent_pakke`

- Calls external program (`MT700C`) to fetch new packages from an external system (PLS).

### `les_artikkel` – Article Lookup

- Looks up item description and unit of measure.
- First attempts to resolve as a logistics item via SQL join (to handle supplier-specific item numbers).
- Falls back to a standard lookup; if not found, sets error flags and default values.

### `oppd_hist` – Update Package History

- Writes an entry to the package history file (`MUPALUR`) with all relevant fields and timestamps.

### `oppd_lager` – Update Warehouse

- Prepares a warehouse update record and calls `VL001R` to apply stock changes, e.g., after deletion.

---

## Integration Points

- **Security:** `AX700R` for access control.
- **Warehouse Update:** `VL001R` for reflecting package changes in inventory.
- **Package History:** `MUPAPFR` for audit trail of package changes.
- **External Data:** `MT700C` for importing packages.
- **Article Master:** `VVARPFR` and `VVLEPF` for item validation and description.
- **Other UI/Inquiry programs:** `MU500R`, `LL502R` for history and stock display.

---

## Notable Design Decisions and Patterns

- **Subfile Paging:** Uses manual page size and navigation indicators, allowing efficient handling of large datasets.
- **Strong Indicator Usage:** Follows a strict indicator convention for clarity and maintainability.
- **Overlay Data Structures:** For warehouse updates, overlays are used for field alignment and compatibility.
- **Flexible Keying:** Multiple logical views and key lists allow for efficient positioning and filtering.
- **Business Logic Encapsulation:** Status filtering, deletion marking, and history logging are all encapsulated, ensuring consistency.
- **SQL Integration:** Modern SQL is used for complex lookups (logistics item resolution), showing gradual modernization of the codebase.

---

## Business/Domain-Specific Logic

- **Package Status (`mtstat`):** Drives much of the filtering and available actions (active, shared, deleted).
- **Length Distribution:** Specific to the timber/lumber industry, with up to 62 length bins per package.
- **Supplier Item Cross-Reference:** Handles cases where items are referenced by supplier-specific numbers.
- **Audit Trail:** All changes to packages (including deletions) are logged in detail, reflecting regulatory or business requirements for traceability.
- **Warehouse Update:** Package deletions and changes are propagated to inventory, ensuring stock accuracy.

---

## Relationships to Other Modules

- **AX700R:** Security/access control.
- **VL001R:** Warehouse/inventory management.
- **MU500R:** Package history display.
- **LL502R:** Stock inquiry.
- **MT700C:** External package import.
- **Article Master (VVARPFR/VVLEPF):** Item validation and enrichment.

---

## Summary

`MT100R` is a comprehensive, business-critical RPG program for managing the package register in ASLAGR, supporting full CRUD operations, robust navigation/filtering, and integration with inventory and audit systems. It is designed for operational efficiency and regulatory compliance in a complex, high-volume domain. The codebase is mature, with clear conventions and encapsulation of business logic, and is gradually integrating more modern SQL-based data access patterns.