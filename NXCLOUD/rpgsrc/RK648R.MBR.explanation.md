# Program RK648R – Customer Receivables Printout (Kundefordringer – Kunder)

## Overview

This RPG program (`RK648R`) is responsible for generating a printout (and optionally a PDF/XML export) of customer receivables ("kundefordringer") per customer. It is part of the ASOKON system and interacts with several master and transaction files to collect, filter, and display receivables data for customers, supporting both traditional spool output and integration with PDF/XML tools.

The program is tailored for periodic reporting and supports parameters for selection by period, customer, department, category, and salesperson. It also provides integration with external programs for PDF generation and browser preview.

---

## File Usage and Relationships

- **rkw1l1**: Main driver file, customer selection.
- **rkunl1**: Customer master data.
- **rktrl1**: Customer transaction ledger.
- **afirl1**: Company master data.
- **ra01l1**: Code tables (e.g., activity codes).
- **rk648p**: Printer file for report output (with overflow handling).

The program reads from these files in a sequence to accumulate and report open receivables per customer, using various keys and overlays to manage data.

---

## Main Data Structures

- **wkwrec**: Overlayed structure for customer selection record.
- **w_sald, w_gsal, w_gval, w_kjøp, bkjøp, etc.**: Accumulators for financial values.
- **pavdsx, pkatsx, pselsx, psvalx, psortx**: Text representations for selection parameters.
- **kna**: Array holding customer names for reporting.

PDF/XML-specific fields are defined for integration with spool file and metadata handling.

---

## High-Level Program Flow

1. **Initialization (`*inzsr`)**
   - Sets up keys for file access.
   - Opens the printer file.
   - Loads company information and sets selection flags.
   - Resolves customer names for any directly specified customers.
   - Sets up reporting parameters for department, category, salesperson, currency, and sorting.

2. **Main Processing Loop**
   - Reads each record from the driver file (`rkw1l1`).
   - Loads customer master data.
   - Calls subroutine `les_kuntr` to process customer transactions.
   - Accumulates counts and totals for reporting.
   - Writes report lines for each customer as appropriate.
   - Loops until end of file.

3. **Transaction Processing (`les_kuntr`)**
   - Reads all transactions for a customer within the specified period.
   - Filters out settled (paid) transactions.
   - Accumulates open balances.
   - Handles printing of customer headers and detail lines.
   - Manages page overflow.

4. **Finalization**
   - If any valid records were found, writes summary headers and parameters.
   - For PDF/XML output: finds the generated spool file, closes the printer file, and calls routines to create XML and potentially launch a PDF preview in the browser.
   - Calls external program `AB710R` to finalize the batch if required.

---

## Key Business Logic and Domain-Specific Features

- **Period Selection**: Transactions are filtered based on a start and end year/period (`paarf`, `pperf`, `paart`, `ppert`).
- **Open Items Only**: Only transactions with a non-zero residual amount (`rnrest`) are included.
- **Enkeltkunder (Individual Customers)**: Supports selection and reporting for up to 10 specific customers.
- **Bruddsum (Break Sums)**: If department, category, or salesperson parameters are set, the report will include subtotals by these dimensions.
- **Currency Handling**: Optionally includes currency values in the report, controlled by the `pvalu` parameter.
- **Sorting**: Supports both numeric and alphabetic sorting, reflected in the report headers.

---

## PDF/XML Export Integration

- **Spool File Discovery**: Uses the IBM API `QSPRILSP` to retrieve the generated spool file information.
- **XML Generation**: Calls external program `AP627R` (previously `AP620R`) to create an XML report, passing extensive metadata and spool file references.
- **PDF Preview**: If enabled, calls `AP621R` to launch the generated PDF in a browser.
- **Meta Tagging**: Supports up to 10 meta tags for enriching the XML output, used for integration with JasperReports or similar tools.

---

## Notable Design Decisions & Conventions

- **Overlay Data Structures**: Used extensively for record and key management, reducing field duplication.
- **Conditional Compilation**: PDF/XML-related code is marked with `pdf` or version tags, indicating optional or version-specific features.
- **Printer File Overflow Handling**: Uses `oflind(*in30)` to manage page breaks and ensure proper report formatting.
- **Parameter Handling**: Parameters are mapped to both internal flags and text representations for consistent reporting and output.

---

## External Program Dependencies

- **AP627R**: Generates XML for the report, integrating with spool file data and meta tags.
- **AP621R**: Launches PDF preview in browser (if enabled).
- **AB710R**: Handles batch job finalization.
- **QSPRILSP**: IBM API for spool file information retrieval.

---

## Summary

This program is a robust, multi-output reporting tool for customer receivables, supporting both traditional print and modern PDF/XML export with metadata enrichment. It is tightly integrated with the ASOKON system’s master and transaction files and is designed for flexible selection and reporting, including support for department, category, salesperson, currency, and sorting. The codebase uses overlays, versioned enhancements, and external program calls to maintain flexibility and extensibility in both output and integration capabilities.