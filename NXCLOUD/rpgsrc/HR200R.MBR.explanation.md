# IBM ILE RPG Program Explanation: HR200R

This program, `HR200R`, is written in ILE RPG and is designed for a system named ASLAGR. It is described as a "Radio terminal trans, calculator" and appears to manage stock items, units of measure, and suppliers within a warehouse context. The code includes support for switching units, reloading data, and fetching supplier information associated with a stock item.

Below is a breakdown of the code and its core logic, annotated by section.

---

## 1. **Header and Options**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Disables debug input/output.
- Date editing is set to day/month/year.

---

## 2. **File Declarations**

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvenl2    if   e           k disk    rename(vvenpfr:vvenl2r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fhr200d    cf   e             workstn
```
- **vvarl1, vvenl2, rlevl1**: Physical files accessed via disk, renamed record formats.
- **hr200d**: Display file (workstation device).

---

## 3. **Data Definition Specifications (D-specs)**

### Parameters
```rpg
d p_firm          s                   like(vvfirm)
d p_vare          s                   like(vvvare)
d p_anta          s             11  3
```
- Parameters: company, item, and quantity.

### Local Data Area
```rpg
d                uds
d l_lage               1001   1002  0
```
- `l_lage`: Local warehouse/location code (from user data).

### Variables in Keys
```rpg
d vvenl2_saen     s                   like(vesaen)
d rlevl1_levr     s                   like(rllevr)
```
- Used in record key structures for file access.

### Working Variables
```rpg
d x               s              1  0
d w_firm          s                   like(vvfirm)
d w_vare          s                   like(vvvare)
d w_omr1/2/3      s                   like(veomre)
d w_enhe          s                   like(veenhe)
d w_lage          s              2  0
...
d w_enhe_gml      s                   like(veenhe)
d w_ldor          s                   like(vvldor)
d b_inlr          s              1    inz(*off)
```
- Various variables for company, item, location, units, old unit, supplier, and end-of-program flag.

---

## 4. **Main Logic**

### Initialization (`*inzsr`)
- Parameters are loaded.
- Key lists for file access are built for `vvarl1`, `vvenl2`, and `rlevl1`.
- Local variables from parameters are initialized.

---

### Main Program Loop

#### **Program Entry (`b1taga` tag)**
1. **Fetch Item Information**
    - `CHAIN` to `vvarl1` (item master), using company (`w_firm`) and item (`w_vare`).
    - If not found, `GOTO avslutt` (exit).

2. **Fetch Supplier Code from Warehouse**
    - Sets warehouse code (`w_lage` from local LDA).
    - Calls program `VL721R` to fetch supplier number into `w_ldor` for the current warehouse/item.
    - If supplier is found, fetches supplier name from `rlevl1`.

3. **Prepare Text Fields**
    - Trims and substrings item text fields for display.

4. **Initialize Unit Selection**
    - Sets status indicators for unit cycling.
    - Initializes unit variables and counters.

5. **Fetch Up to Three Sales Units**
    - Starts reading from `vvenl2` (item-units).
    - Loops to fill up to three units (`b1enh1`, `b1enh2`, `b1enh3`) and their conversion factors (`w_omr1`, etc.).

6. **Set Default Unit**
    - Sets working unit (`w_enhe`) to the first unit and quantity to 0.
    - Stores previous unit for potential conversion later.

7. **Display Main Screen (`b1tagb`)**
    - Displays the data entry screen.
    - Handles function keys:
        - `F12` (`*inkc`): Exit program.
        - `F1` (`*inka`): Call subroutine to change unit.
        - `F5` (`*inke`): Reload program data.

8. **Loop Back to Main Screen**
    - Unless exiting, always returns to the display loop.

---

### **Exit Handling (`avslutt` tag)**
- Passes calculated quantity to parameter.
- Sets last record indicator (`*INLR = *ON`) to end program.

---

### **Unit Change Subroutine (`bytt_enhet`)**
- Cycles through available units on each F1 press.
- When unit changes, converts quantity (`b1anta`) using conversion factors between units.
- Updates current and old unit trackers.

#### Example: 
- If going from unit 1 to 2: divide by `w_omr2`.
- If going from unit 2 to 3: multiply by `w_omr2`, then divide by `w_omr3`.

---

### **Error Routine (`*pssr`)**
- Turns on error indicator and returns to the main screen.

---

## 5. **Key Lists (KLIST) for File Access**

- Built using company, item, and, where needed, sequence or supplier code.

---

## 6. **Parameter List (`*ENTRY PLIST`)**

- Receives company, item, and quantity as parameters from the caller program.

---

## **Summary**

- **Purpose:** Provides an interactive terminal interface for managing warehouse items, supplier lookup, switching between item units, and maintaining quantities across those units.
- **File I/O:** Reads/upates item master, item-unit, and supplier master files.
- **Screen Handling:** Displays data entry screens and handles function keys for various operations.
- **Conversions:** Handles conversions between up to three sales units per item.

---

## **Key Functions for New Developers**

- **Understand the File Layouts:** Look at `vvarl1`, `vvenl2`, and `rlevl1` physical files and their fields.
- **Parameter Passing:** The program expects company, item, and quantity as input, and returns the (possibly converted) quantity.
- **Adding/Changing Units:** Sales units can be cycled, and quantities are automatically converted.
- **Supplier Lookup:** The supplier for an item in a warehouse is fetched via an external program (`VL721R`).
- **UI Flow:** The user interacts with the display until they exit or change units.

---

This program is a classic example of "green screen" RPG application with robust file handling, user interface, and business logic for inventory and supplier management in a warehouse environment.