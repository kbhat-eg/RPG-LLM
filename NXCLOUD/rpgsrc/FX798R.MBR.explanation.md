# RPG Program FX798R: Explanation

This RPG program is used for controlling (looking up) the relationship between a **short KID number** (`kort kid`) and an **invoice number** (`fakturanummer`). It is designed for use on an IBM i (AS/400) system, supporting user interaction via display files (screens).

Below is a breakdown and explanation of its key components and logic:

---

## 1. **Header and Configuration**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **option(*nodebugio)** disables debugging of I/O operations.
- **datedit(*dmy)** sets the default date format to day-month-year.

---

## 2. **File Declarations**

```rpg
fakidl1    if   e           k disk    rename(akidpfr:akidl1r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
ffx798d    cf   e             workstn
```
- **akidl1**: KID register file (input, keyed, externally described, renamed record format).
- **rkunl1**: Customer register file (input, keyed, externally described, renamed record format).
- **fx798d**: Display file for screen interaction.

---

## 3. **Data Structures and Variables**

### Local Data Area (LDA) Fields

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- These map specific positions in the LDA to variables (user, firm number, etc.).

### KID Data Structures

- **Long KID** (`lang kid`): Contains customer and invoice info.
    ```rpg
    d                 ds
    d d_lang                        25
    6.30 d  d_kund                        6  0 overlay(d_lang:7)
    6.30 d  d_fakt                        8  0 overlay(d_lang:13)
    ```
    - `d_kund` overlays positions 7-12 (customer number).
    - `d_fakt` overlays positions 13-20 (invoice number).
- **Short KID** (`kort kid`): Used for input.
    ```rpg
    d                 ds
    6.30 d d_kort                         9
    6.30 d  d_kidr                        8  0 overlay(d_kort)
    6.30 d  d_ksif                        1  0 overlay(d_kort:9)
    ```
    - `d_kidr` is the first 8 digits of KID.
    - `d_ksif` is the 9th digit (check digit?).

### Key Variables

```rpg
d akidl1_kidr     s                   like(akkidr)
d rkunl1_kund     s                   like(rkkund)
d w_firm          s              3  0
```
- Used to store keys for file lookups.

---

## 4. **Indicators**

- **LR**: Program end.
- **30**: Field protection (display only).
- **31-79**: Error message/screen indicators.
- **80-99**: Work indicators.

---

## 5. **Mainline Logic**

```rpg
c                   exsr      xc1bld
c                   eval      *inlr = *on
c                   return
```
- Calls the `xc1bld` subroutine (main work).
- Sets *LR to on (signals job end).

---

## 6. **Subroutines**

### a. **C1BLD Screen Management (`xc1bld`)**

Handles the first screen for user input of the short KID number.

Key steps:
1. Clears indicators and variables.
2. Displays the C1BLD input screen.
3. Handles function keys (like Cancel) to exit.
4. If input is valid (not zero), calls next subroutine (`xc2bld`).
5. Loops back for new input.

### b. **C2BLD Screen Processing (`xc2bld`)**

Handles the second screen, showing details about the KID number.

Key steps:
1. Clears indicators and output fields.
2. Copies the entered KID to the working structure.
3. Looks up the KID in the KID register (`akidl1r`).
4. If found and matches, extracts long KID data (sets invoice, customer, year).
5. Looks up customer in customer file (`rkunl1r`). If found, sets name; if not, shows "Customer not found".
6. If any lookup fails, sets an error indicator.
7. Displays the C2BLD output screen.

### c. **Initialization (`*INZSR`)**

- Defines file keys for chained lookups.
- Retrieves the firm number from LDA.

---

## 7. **File Access Logic**

- Uses **CHAIN** operation for keyed lookups:
    - For KID register (by firm and KID).
    - For customer register (by firm and customer).
- Uses **KLIST** for setting up compound keys.

---

## 8. **Display Files**

- **C1BLD**: Input screen for short KID (`c1kkid`).
- **C2BLD**: Display details (invoice number, customer, year, etc.).

---

## 9. **Summary of Functionality**

1. **User is prompted** to enter a short KID number on the first screen.
2. **If provided**, the program:
    - Looks up this KID.
    - Extracts the associated invoice and customer information.
    - Looks up the customer for their name.
    - Shows all info on a results screen.
3. If any lookup fails, appropriate error indicators/messages are shown on the screen.

---

## 10. **Comments and Documentation**

- The code is well-documented in Norwegian.
- Change history is logged at the top.
- Indicator usage is explained.

---

## 11. **Conclusion**

This program is primarily a user interface for translating a *short KID* entered by the user into its corresponding *invoice number* and related customer info, by leveraging two key files: the KID register and the customer register. It uses screen-handling, controlled indicators, and key-based file access typical for traditional RPG on IBM i systems.