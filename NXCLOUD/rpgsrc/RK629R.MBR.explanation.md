# Documentation: RK629R â€“ Customer Register Printout Notepad

## Purpose

This program, **RK629R**, is designed to print a report from the customer register, specifically focusing on customers with associated notepad entries (notatblokk). It supports selection and filtering by various customer and business attributes, and can print either all customers or only those with notepad entries. The report aggregates financial data (balances, purchases, etc.) and outputs to a printer file.

## Domain Context

- **Customer Register**: Central repository of customer master data.
- **Notatblokk**: Free-text notes associated with customers, stored in a separate file.
- **Selection/Filtering**: Users can specify ranges or lists for customer number, department, category, salesperson, district, warehouse, etc.
- **Sorting**: Output can be sorted numerically (by customer number) or alphabetically (by name).
- **Report Output**: Sent to a printer file, with subtotals and headings as required.

## File Dependencies

- **RKUNL1**: Customer master file, numeric order (customer number).
- **RKUNL2**: Customer master file, alphabetic order (customer name).
- **RKLAL2**: Notepad file, containing notes linked to customers.
- **RK629P**: Printer file for report output.

## Key Data Structures

### Parameter Structure (UDS)

The parameter structure (UDS) encapsulates all input parameters controlling selection and formatting. Key fields include:

- **pdato, paarf, paart, pperf, ppert**: Date and period filters.
- **pavdf/pavdt**: Department range.
- **pkatf/pkatt**: Category range.
- **pself/pselt**: Salesperson range.
- **pknrf/pknrt**: Customer number range.
- **kun**: Array of single customers (up to 10).
- **pdisf/pdist**: District range.
- **plagf/plagt**: Warehouse range.
- **psald**: Only customers with balance.
- **pnota**: Only customers with notepad entries.
- **psort**: Sort order (blank = numeric, else alphabetic).
- **Other flags**: Control for output format, filtering, and report type.

### Working Storage

- **Counters and Sums**: Variables for counting and summing balances, purchases, etc., for selected and all customers.
- **Key Fields**: For building composite keys for file access (e.g., customer, firm, notepad keys).
- **Date Handling**: Both numeric and ISO date fields for comparison and formatting.

## Program Flow

### Initialization (`*INZSR`)

- **Parameter Handling**: Sets selection flags (e.g., *IN12 if only notepad customers).
- **Initial File Positioning**: Sets file pointer to first record in the appropriate customer file (numeric or alphabetic).
- **Report Heading**: Writes initial headings to the printer file, with additional subheadings if filtering by department, district, salesperson, or category.
- **Key Lists**: Builds key lists for accessing customers (by number or alpha) and notepad entries.

### Main Processing Loop

1. **Read Next Customer**: Uses the selected customer file (RKUNL1 or RKUNL2) depending on sort order.
2. **End-of-File Check**: If customer file is exhausted or firm code exceeds selection, exit loop.
3. **Filtering**:
    - Applies all selection criteria: customer number, department, category, salesperson, district, last transaction date.
    - If the customer record does not meet criteria, jumps to "alle" tag for aggregation of all customers.
4. **Selection for Report**:
    - Increments counters for selected customers.
    - Sums balances and purchases, distinguishing between debit and credit balances.
    - Prepares key for notepad lookup.
5. **Notepad Handling**:
    - If only customers with notepad entries are required, attempts to read corresponding notepad records.
    - If found or if all customers are to be listed, invokes the `skrive` subroutine to write customer info.
    - Writes all associated notepad entries for the customer.
6. **Aggregation for All Customers**:
    - At the "alle" tag, updates totals for all customers, regardless of selection.
    - Returns to main loop to read next customer.

### Termination

- Sets LR indicator to end the program.
- Writes final total summary to the print file.

## Subroutines

### `skrive` (Write Customer Heading)

- Handles page overflow: writes headers as needed.
- Writes customer line to the print file.
- (Commented out) Could write additional address lines if present.

### `*INZSR` (Initialization)

- Handles initial parameter processing.
- Writes report headings and subheadings based on selection criteria.
- Sets up key lists for file access.

## Indicator Usage

- **KA (F1)**: Select company.
- **KC (F3)**: Exit.
- **LR**: End program.
- **30**: Field protection on display.
- **31-59**: Error/warning indicators.
- **60-69**: File indicators (chain, etc.).
- **70-79**: Subroutine work indicators.
- **80-89**: General work indicators.
- **90-99**: Standard subroutine indicators.

## Design Notes and Conventions

- **File Renaming**: The program uses the `RENAME` keyword to map physical file fields to internal record formats.
- **Multi-file Support**: Both numeric and alphabetic customer files are supported, with logic to select based on parameter.
- **Overlay Usage**: Date fields are overlaid for flexible access to year, month, day components.
- **Key Lists**: KLIST/KFLD used for composite keys, especially for notepad lookup.
- **Subroutine Structure**: All output logic is encapsulated in subroutines for maintainability.
- **Indicator-Driven Logic**: File I/O and output control are heavily indicator-based, following established RPG/400 conventions.

## Interactions with Other Modules

- **Customer Master**: Reads from RKUNL1 (by number) or RKUNL2 (by name).
- **Notepad File**: Reads from RKLAL2 for customer notes.
- **Printer Interface**: Outputs to RK629P, with overflow and heading management.

## Business Logic Highlights

- **Flexible Selection**: Users can filter by a wide range of customer and business attributes.
- **Notepad Focus**: The program can limit output to only those customers with notepad entries, or list all customers.
- **Aggregated Sums**: The report includes subtotals and totals for balances and purchases, separated by selection and for all customers.
- **Dynamic Headings**: Report headings adapt to the selection criteria, improving clarity for users.

## Special Version Notes

- **R5.40**: Changed to read RKLAL2 instead of RKLALU; district handling updated.
- **R6.20**: Project code now alphanumeric.

---

**In summary:**  
This program is a specialized report generator for customer data, with a focus on integrating associated notepad entries, supporting flexible selection and sorting, and outputting detailed and summary information to a printer file. It is built to be robust, indicator-driven, and easily adaptable for business needs.