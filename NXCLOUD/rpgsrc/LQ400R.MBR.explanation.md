# LQ400R â€“ Deletion of Inventory Transaction Batches

## Purpose

This program, **LQ400R**, is responsible for deleting inventory transaction batches ("lagertransaksjonsbunter"). Specifically, it removes both the header and associated line records for a given batch number. This is a core utility for maintaining the integrity and cleanliness of the inventory transaction files by ensuring that all related data is purged in a controlled manner.

## File Overview

The program interacts with three physical files, each representing different aspects of inventory transactions:

| File Name | Usage | Description | Renamed Record Format |
|-----------|-------|-------------|----------------------|
| LLHELU    | UF    | Inventory transaction header (update/delete) | LLHELUR |
| LLDTL1    | IF    | Inventory transaction lines (read only) | LLDTL1R |
| LLDTLU    | UF    | Inventory transaction lines (update/delete) | LLDTLUR |

- **UF**: Update/Delete allowed, keyed access
- **IF**: Input only, keyed access

**Note:** The LLDTL1 and LLDTLU files reference the same underlying physical file (LLDTPFR) but use different record formats for read and update/delete operations.

## Parameters

- **p_numm**: The batch number (likely representing the inventory transaction batch to be deleted). Passed as a parameter into the program.

## Key Variables

- **l_firm**: Company/firm identifier, sourced from the User Data Section (positions 944-946 in the LDA).
- **w_firm**: Working variable for the firm number, set from l_firm.
- **llhelu_numm, lldtl1_numm, lldtlu_numm**: Key fields for header and line records, all set to p_numm.
- **lldtlu_line**: Line number key for line records.

## Business Logic and Flow

### 1. Initialization (*INZSR)

- **Parameter Intake**: Reads the batch number parameter.
- **Key Construction**: Builds key lists for each file access pattern using the current firm and batch number.
- **Key Value Assignment**: Sets working variables for firm and batch number keys.

### 2. Deletion of Inventory Transaction Lines

- **Read All Lines**: Iterates through all LLDTL1R (line) records for the batch and firm.
- **Delete Matching Lines**: For each line, attempts to chain to LLDTLUR (the updatable version) and deletes it if found.
- **Repeat**: Continues until all lines for the batch are processed.

### 3. Deletion of Inventory Transaction Header

- **Chain to Header**: Attempts to locate the batch header in LLHELUR.
- **Delete if Found**: Deletes the header record if it exists.

### 4. Program Termination

- **Set LR**: Sets the last record indicator to signal program termination.
- **Return**: Exits the program.

## Design Notes and Conventions

- **Firm Context**: All deletions are scoped to the current firm, read from the LDA. This ensures multi-company data integrity.
- **Batch Consistency**: Both header and all associated lines for a batch are deleted to avoid orphaned records.
- **Physical File Sharing**: The use of the same physical file (LLDTPFR) for both read-only and update/delete operations via different record formats is a common pattern in this codebase.
- **No Debug I/O**: The `*NODEBUGIO` option is set, which may be a performance or security consideration.
- **Date Format**: The program expects dates in DMY format, which may be relevant if date fields are added or used elsewhere.

## Interactions

- **No External APIs**: The program operates solely on local physical files.
- **No Output**: This is a batch utility with no user interface or display file interactions.
- **Data Integrity**: Assumes exclusive or safe access to the files to avoid deleting records that may be in use elsewhere.

## Error Handling

- **Minimalistic**: The program only checks for record existence before deletion. There is no explicit error handling for record locks or I/O errors.

## Typical Usage

This program is typically invoked as a utility or as part of a batch process to purge an entire inventory transaction batch (header and lines) for a specific firm and batch number. It is critical that the batch number provided is valid and that the operation is coordinated with other processes to avoid data inconsistencies.

---

**Summary:**  
LQ400R is a batch utility for deleting all records (header and lines) associated with a given inventory transaction batch for the current firm, ensuring no orphaned transaction data remains. It relies on standard keying conventions and physical file layouts common in this codebase.