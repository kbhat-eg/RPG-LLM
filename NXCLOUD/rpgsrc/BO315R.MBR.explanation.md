# RPG ILE Program Explanation: BO315R

This document explains the logic, structure, and operation of the ILE RPG program `BO315R`, which according to internal comments is used for **cash register reconciliation**—specifically, managing cash drawer balances and allowing edits. The code uses a subfile-based user interface for displaying and updating records.

---

## 1. Header (`H`) and Comments

- **`H option(*nodebugio) datedit(*dmy)`**: Compilation options; disables debug IO and sets date format to day/month/year.
- **Documentation block**: Describes the application, modifications, and purpose (cash reconciliation per drawer, with editing option), as well as the indicator usage conventions.

---

## 2. File Declarations (`F` specs)

These define database and display files used by the program.

- **bot1i1, bot1ir, bot1iu**: Three variants of the `bot1st` file (input, read, update), each renamed for program clarity.
- **busri1**: (6.20) Reads user records for security.
- **bo315d**: Display file, with a subfile for the main browse/update, plus access to its feedback data structure.

---

## 3. Data Structures (`D` specs)

### a. Local Data Area

- **l_user, l_firm, l_fnav**: Extracts information from the Local Data Area (LDA) for the current user, firm, and perhaps function/navigation.

### b. Display Feedback

- **dspfbk**: Data structure for display feedback; used for subfile cursor/position handling.

### c. Key Variables

- Multiple variables, like `bot1i1_grup`, `bot1i1_kass`, etc., are defined to hold key fields for file operations—supporting subfile and update actions.

### d. Working Variables

- Multiple working variables for subfile page size, record numbers, flags for operation mode, and so on.

### e. Constants

- **c_sfil = 14**: Subfile page size (number of rows per page).

---

## 4. Indicator Usage

Describes how classic RPG indicators (like *IN10, *IN11, etc.) are used for screen and program control, e.g., roll-up, roll-down, select, protect fields, etc.

---

## 5. Mainline Logic

The mainline section is *not* enclosed in a procedure or subroutine, so it is run sequentially at program start.

### a. Security Check

- If `b_sikk` (security flag) is *on*, access is denied, and the program jumps to end (tag `avslutt`).

### b. Subfile Display and Event Loop

- Writes the command keys screen.
- Calls the main subfile display subroutine (`dsp_subfile`).
- Event handling: Uses a `select` to process function keys:
  - Exit (F3/F12): jump to `avslutt`
  - Refresh (F5): call `forny`, return to main tag
  - Page down (F10): call `crt_subfile` to fill the next page
  - Page up (F11): call `bck_subfile` to page back
  - Home (F21): set cursor position, redraw screen

- If a positioning field is set (`b2grup`), calls `posisjoner` to reposition the subfile.

- Regular subfile processing via `subfile` subroutine.

### c. Program Termination (`avslutt` tag)

- Sets *INLR = *ON to end program.

---

## 6. Key Subroutines

### a. `forny`

- Repositions to the current record if available.
- Rebuilds (`clr_subfile`, `crt_subfile`) the subfile contents based on current position.

### b. `posisjoner`

- Positions the subfile to a specific group if requested.
- Clears and rebuilds the subfile contents for the selection.
- Resets positioning field(s).

### c. `subfile`

- Toggles a flag controlling which records are being shown.
- Reads and processes subfile records in a loop:
  - If the user selects an 'edit' action (likely option 5), invokes `xc2bld` subroutine to edit details, then updates the subfile.
  - Updates underlying file record if the amount has changed.

### d. `xc2bld`

- Loads detail record for view/edit.
- For 'view' only (option 5), sets display indicators for protected (read-only) mode.
- Displays the detail screen and responds to exit keys.

### e. `clr_subfile`

- Writes the subfile control record with indicator to clear subfile.
- Resets subfile-related working variables.

### f. `crt_subfile`

- Fills the subfile with records, up to a page (c_sfil = 14).
- Loads records from the primary input file (`bot1i1`) matching current firm.
- Writes each record to subfile for display.

### g. `bck_subfile`

- Pages backward in the subfile by reading previous set of records.
- Blanks and refills the subfile after repositioning.

### h. `dsp_subfile`

- Prepares the screen for display of subfile.
- Sets display indicators.
- Sets feedback field (`w_fcrn`) with cursor/record position for next screen.

### i. `*inzsr` (Initialization Subroutine)

- Defines key lists for all file operations.
- Loads LDA values for firm, etc.
- Security check (6.20): Verifies if user is allowed to run the program by checking in the BUSRI1 file.
  - User lacks permission if not found, or if some fields (bbkret, bbkopg) do not satisfy requirements.
- Positions the database and fills the subfile for first screen.

---

## 7. Security Model

- At program start (`*inzsr`), user authority is checked—if not found in security file or lacking necessary permissions, sets security flag (`b_sikk`) and prevents further access.

---

## 8. Subfile Model

- The program uses a **paged subfile**, where:
  - Navigation (page up/down, home) is managed with indicators and working variables.
  - Subfile records are loaded in batches (pages).
  - Editing/viewing of details is handled via specialized screens and subroutines.

---

## 9. Key File Operations

- **SETLL/CHAIN/READ/READC/READP/UPDATE/WRITE** operations are used throughout to:
  - Position files for update or retrieval.
  - Read forward/backward for paging.
  - Update records with changes (like new balances).
  - Write new data to the subfile for display.

---

## 10. Indicators

- The classic RPG indicator model (numbers *IN10 to *IN99) is used for program flow control, screen handling, and error/state signaling.

---

## 11. User Interface (Screens & Fields)

- Multiple DDS display formats are referenced (basfl, b2ctl, b2cmd, c2bld, etc.)
  - **basfl**: Main subfile record.
  - **b2ctl**: Subfile control.
  - **b2cmd**: Command key help/instructions.
  - **c2bld**: Detail input/display for a single record.
- Cursor control, entry protection, and field selection is handled via display indicators as described.

---

## 12. Change History

- The code contains embedded version comments and indicates that features such as user-controlled access (security) and new GUI-related changes have been made over time.

---

## 13. Summary

**BO315R** is a robust, classic ILE RPG program for managing cash register balances. It provides:
  - A subfile interface for browsing and editing.
  - Security checks by user and firm.
  - Paging and record positioning in the subfile.
  - Detail view and edit screens.
  - Clear indicator and variable use conventions.

The logic is modular, with each function (display, edit, security, navigation) separated into subroutines for maintainability and clarity. 

---

**Onboarding Tips:**  
- Familiarize yourself with the subfile model and indicator usage.
- Understand the purpose of the display files and key field relationships.
- Review the security model if you need to modify user permissions.
- When debugging or extending, identify which subroutine handles the relevant logic (positioning, editing, display, etc.).
- Be aware of the specific Norwegian naming conventions and comments (e.g., "kasseoppgjør" = cash reconciliation).