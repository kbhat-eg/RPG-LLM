# Program Overview: FO190R â€“ Creation of Order Transactions via Alternative Invoicing

## Purpose

This program, part of the ASOFAK system, handles the creation of order transaction records (`ordretrans`) in scenarios involving alternative invoicing, specifically when card agreements (kortavtaler) are in effect. It ensures that transaction records are created or updated based on customer, project, and agreement data, and applies business rules regarding card types and credit order types.

## Key Business Logic and Flow

1. **Entry and Parameter Handling**
   - The program receives several parameters: status, firm, order number, suffix, customer, and project.
   - It initializes local data and key structures for file access.

2. **Order Transaction Existence Check**
   - If a suffix is provided (`p_suff <> *zero`), a separate routine (`gen_suff`) is called to handle transaction creation for non-zero suffixes, then exits.
   - Otherwise, it checks if an order transaction already exists for the given order number and suffix 0. If found, the program exits early.

3. **Agreement Validation**
   - The program originally checked for agreements in `FMKAPF` (now commented out), but now relies on `RUKRPF` (`sjk_kavt` subroutine) for validating if the customer/project has an active card agreement.
   - If no agreement is found, the program exits.

4. **Card Information Retrieval**
   - Calls an external program `FM501R` to retrieve card information, passing firm, customer, project, and returning card type (`p_kftp`) and sequence (`p_ktsq`).

5. **Transaction Record Creation**
   - If a valid card type is returned (`p_kftp = 1 or 2`), a new transaction record is written via the `skr_trans` subroutine.

6. **Order Header Update Based on Order Type**
   - If a special flag (`u_s701`) is set (determined by a parameter from the `CO402R` program), additional logic is used to check the order type (`votypfr`) and, depending on credit status, update the order header accordingly.
   - The logic ensures that for credit order types, card brand and block code are removed.

## File Relationships

- **rkunl1 (Customer Master)**: Used for customer lookups.
- **fntrl1/fntrlu (Transaction Registers)**: Main files for order transaction records.
- **fmkal1 (Old Card Agreement Register)**: Previously used for agreements, now replaced.
- **rukrlr/ruksl1 (Card Agreement Registers)**: Current source for customer/project card agreements.
- **fohelu/fohel1 (Order Header)**: Used to update order header information post-transaction.
- **votyl1 (Order Type)**: Used to determine order type properties, especially for credit order handling.

## Subroutines and Their Roles

### `gen_suff`
- Handles creation of transaction records when the suffix is non-zero.
- Writes a new transaction record with provided parameters.

### `sjk_avt` (Legacy)
- Checks for agreements in the old agreement file (`fmkal1`).
- Now superseded by `sjk_kavt`.

### `sjk_kavt`
- Checks for active agreements in the new agreement file (`rukrlr`).
- Sets a flag (`b_avta`) if an agreement is found for the customer/project.

### `skr_trans`
- Prepares and writes a transaction record to the transaction file (`fntrlu`).
- Populates fields such as firm, number, suffix, card type, sequence, customer, and project.
- Sets timestamps and user info.

### `opd_ohead`
- Updates the order header record (`fohelu`) with the card type.
- Called when a transaction record is written and order header needs to reflect the card agreement.

### `*inzsr`
- Program initialization.
- Sets up parameter lists and key lists for all major files.
- Calls external program `CO402R` to check if special handling for credit order types is required (sets `u_s701`).

## Notable Design Decisions and Conventions

- **Card Agreement Source Migration**: The program historically used `FMKAPF` for card agreements but now uses `RUKRPF` (`rukrlr`). This change was driven by synchronization issues and is documented in the code comments.
- **Selective Card Type Handling**: Only VISA and Europay are processed for transaction creation; logic for other card types is omitted.
- **Order Type Handling**: Special business logic is applied for credit order types, including removal of card brand/block code, controlled by a parameter retrieved from `CO402R`.
- **Subroutine Naming**: Subroutines are prefixed (`sjk_`, `skr_`, `opd_`, `gen_`) to indicate their function: check agreement, write transaction, update order header, generate transaction for suffix.
- **External Program Calls**: Interaction with `FM501R` (card info retrieval) and `CO402R` (order type parameterization) is central to the business logic.
- **Key Lists**: Keys for file access are constructed and reused throughout the program for consistency and maintainability.

## Interaction with Other Modules

- **FM501R**: Retrieves card information for the current customer/project.
- **CO402R**: Used to determine if special handling for credit order types is required, influencing downstream logic.
- **Order Header and Order Type Files**: Updated or queried based on the outcome of transaction creation and business rules.

## Version History and Enhancements

- **6.10**: Migration to new card agreement file, selective card types, and new logic for card info retrieval.
- **6.21**: Enhanced logic for agreement checks.
- **7.01/8.01**: Refined handling for credit order types, including removal of card brand/block code.
- **8.xx**: Fixes in logic for credit order type checks.

## Summary

This program is a central component for managing order transactions in the context of alternative invoicing with card agreements. It ensures data integrity and proper business rule enforcement across multiple files and handles evolving requirements, such as migration to new agreement sources and nuanced handling of credit order types. The code is modular, with clear separation of concerns, and interacts closely with other system modules for parameterization and data retrieval.