     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RC700R                                              *
      * Beskrivelse . . : Utlegg av innbetalinger til SVEA                    *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                                     *
      * Tilpasset for . :                                                     *
      *                                                                       *
      * Referanse  Dato   Endringsbeskrivelse                            Sign *
      * --------- ------  ---------------------------------------------- ---- *
      * V6.30     210217  Nytt Program                                   sst  *
6.31  * v6.30     090317  Test mot kunderegister om kundekat. 701 / 702       *
6.32  * v6.30     051017  Lagt inn oppdragsgiver 0036100                      *
6.33  * v6.30     031117  Status settes = 1 på alle betalinger så er det      *
      *                   opp til Svea og endre denne til 2 innenfor
      *                   mestergruppens regler for full/del betalt
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     frktrle    if   e           k disk    rename(rktrpfr:rktrler)
     frktslu    uf a e           k disk    rename(rktspfr:rktslur)
     frcsvpf    o  a e           k disk
      *
     d                uds
     d  pfirm                300    302  0
     d  pnavn                303    332
     d  puser                333    342
     d  pkdat                343    348  0
     d  praar                349    352  0
     d  prper                353    354  0
     d  pavdf                355    358  0
     d  pavdt                359    362  0
     d  pkatf                363    366  0
     d  pkatt                367    370  0
     d  pself                371    374  0
     d  pselt                375    378  0
     d  pknrf                379    384  0
     d  pknrt                385    390  0
     d  kun                  391    450  0 dim(10)
     d  pknr1                391    396  0
     d  pknr2                397    402  0
     d  pknr3                403    408  0
     d  pknr4                409    414  0
     d  pknr5                415    420  0
     d  pknr6                421    426  0
     d  pknr7                427    432  0
     d  pknr8                433    438  0
     d  pknr9                439    444  0
     d  pknr0                445    450  0
     d  pfdat                451    456  0
     d  plope                457    459  0
     d  ppkod                460    460
     d  ppros                461    463  1
     d  pgrns                464    465  0
     d  pgbyr                466    466
     d  pmini                467    468  0
     d  pbskr                469    469
     d  pegrn                470    470
     d  pajor                471    471
     d  ptext                472    472  0
     d  ppunr                473    473  0
     d  ppbeh                474    474
     d  palfa                475    475
     d  pdfgg                476    481  0
     d  pparam               300    490
      *
     d  l_wsid               901    910
     d  l_user               911    920
     d  l_fgrp               931    933
     d  l_firm               944    946  0
     d  l_fnav               951    980
      *
     d w_firm          s              3  0
     d w_fdat          s              6  0
     d w_idat          s              6  0
     d w_kund_gml      s              6  0
6.32 d w_oppdrgiv      s              7    inz('0036100')
     d w_knr           s             10
     d w_ref           s             10
     d w_bel           s             11  2
     d w_bex           s             11
     d w_sign          s              1
     d w_aar           s              4
     d w_mnd           s              2
     d w_dag           s              2
     d w_bk            s              2  0
     d w_bkx           s              2
     d w_bsts          s              2
     d w_cr            s              1    inz(x'0D')
     d w_lf            s              1    inz(x'0A')
     d w_dat10         s             10
     d w_ddat          s              8
     d w_isox          s             10
     d w_startd        s                   like(rnbdat)
     d w_start         s              1    inz(' ')
     d w_x37           s             37
     d w_x15           s             15
     d w_ant           s              9  0
     d w_tot           s             12  2
     d w_antx          s              9
     d w_totx          s             12
     d rcsrec          s             80
      *
     d wkjdat          s              6  0
     d wbforp          s             11  2
     d wbfort          s             11  2
     d wnbelØ          s                   like(rnbelØ)
6.31 d rkunl1_firm     s                   like(rkfirm)
     d rkunl1_kund     s                   like(rkkund)
     d rktrle_tist     s                   like(rntist)
     d rktrlu_kund     s                   like(rnkund)
     d rktrlu_bdat     s                   like(rnbdat)
     d rktrlu_tist     s                   like(rntist)
     d rktslu_tist     s                   like(rstist)
     d n               s              3  0
      *
T5.40d                 ds
     d w_isodat                            like(rnbdat)
     d w_isostr                            like(rnbdat)
     d w_datiso                1     10
     d w_aari                  1      4
     d w_mndi                  6      7
     d w_dagi                  9     10
6.31 d w_kund                              like(rnkund)
     d                                     inz(0)
      *
     d                 ds
     d w_nref                        20
     d  w_info                       12    overlay(w_nref:5)
      *
     d/COPY QCPYLESRC,RCN1PFDS
     d/COPY QCPYLESRC,RCN2PFDS
      *
     c     dummy         tag
      *
     c     *dmy          move      021017        w_startd
     c     *dmy          move      udate         w_isodat
     c                   eval      w_isostr = w_isodat - %days(14)
     c                   movel     w_isostr      rktrle_tist
     c     rktrle_key    setll     rktrle
     c                   read      rktrle
     c                   if        rnkund = 10123
     c                   eval      rnkund = rnkund
     c                   endif
     c                   dow       not %eof(rktrle)
      *  Er dette en innbetaling?
     c                   if        rnbilk <> 10 and
     c***  ifølge Hilde 06.10.2017 rnbilk <> 11 and
     c                             rnbilk <> 14 and
     c***  ifølge Hilde 06.10.2017 rnbilk <> 22  samme med 87 også
     c                             rnbilk <> 87
     c                   goto      next
     c                   endif
6.31  *  Skal denne kunde ut?
6.31 c                   if        rnkund <> w_kund
6.31 c                   eval      rkunl1_firm = rnfirm
6.31 c                   eval      rkunl1_kund = rnkund
6.31 c     rkunl1_key    chain     rkunl1
6.31 c                   eval      w_kund = rnkund
6.31 c                   endif
6.31 c                   if        not %found(rkunl1) or
6.31 c                             (rkkatg <> 701 and
6.31 c                              rkkatg <> 702)
6.31 c                   goto      next
6.31 c                   endif
      *  Er innbetaling fra før 02.10.2017
     c                   if        rnbdat < w_startd
     c                   goto      next
     c                   endif
      *  Er trans lagt ut før?
     c                   eval      rktslu_tist = rntist
     c     rktslu_key    chain     rktslu
     c                   if        %found(rktslu)
     c                   goto      next
     c                   endif
      *  Da skal trans ut og vi må ev skrive startrec. først
     c                   if        w_start <> 'J'
     c                   move      w_isodat      w_isox
     c                   eval      w_ddat = %subst(w_isox:1:4) +
     c                                      %subst(w_isox:6:2) +
     c                                      %subst(w_isox:9:2)
     c                   eval      rcsrec = '00'  +
     c                             W_oppdrgiv     +
     c                             w_ddat         +
     c                             w_x37
      *
     c                   write     rcsvpfr
     c                   eval      w_start = 'J'
     c                   endif
6.33  *
6.33  *  Her skal oppslag mot ev faktura gjøres for å finne ut om
6.33  *      betaling skal merkes med 1 for akonto eller 2 for sluttbetalt
6.33  *
      *
      *  Legg ut trans til SVEA
     c                   move      rnkund        w_knr
     c                   eval      w_knr = %xlate(' ':'0':w_knr)
     c                   move      rnrefn        w_ref
     c                   eval      w_ref = %xlate(' ':'0':w_ref)
     c                   move      rnbdat        w_dat10
     c                   eval      w_aar = %subst(w_dat10:1:4)
     c                   eval      w_mnd = %subst(w_dat10:6:2)
     c                   eval      w_dag = %subst(w_dat10:9:2)
     c                   eval      w_bk = rnbilk
      *
     c                   eval      w_bsts = '1'
      *
     c                   if        rnbilk = 22 or
     c                             rnbilk = 87
     c                   eval      w_bk = 17
     c                   endif
     c                   move      w_bk          w_bkx
     c                   eval      w_bkx = %xlate(' ':'0':w_bkx)
      *  BK alltid = 32 ifølge Marius.
     c                   eval      w_bkx = '32'
      *
     c                   eval      w_ant = w_ant + 1
     c                   eval      w_tot = w_tot + rnbelØ
      *
     c                   if        rnbelØ < 0
     c                   eval      w_bel  = rnbelØ * -1
     c                   eval      w_sign = ' '
     c                   else
     c                   eval      w_bel  = rnbelØ
     c                   eval      w_sign = '-'
     c                   endif
     c                   move      w_bel         w_bex
     c                   eval      w_bex = %xlate(' ':'0':w_bex)
      *
     c                   eval      rcsrec =
     c                             '03'          +
     c                             w_oppdrgiv    +
     c**                           '0000'        +
     c                             w_knr         +
     c                             w_ref         +
     c                             w_aar         +
     c                             w_mnd         +
     c                             w_dag         +
     c                             w_bkx         +
     c                             '  '          +
     c                             w_bex         +
     c                             w_sign        +
     c                             w_bsts
     c*                            w_cr          +
     c*                            w_lf
      *
     c                   write     rcsvpfr
      *
      *  Rapporter at trans er lagt ut til SVEA
      *
     c                   eval      rsfirm = w_firm
     c                   eval      rskund = rnkund
     c                   time                    rssdat
     c                   eval      rstist = rntist
     c                   time                    rsodat
     c                   time                    rsotim
     c                   eval      rsousr = l_user
     c                   time                    rsedat
     c                   time                    rsetim
     c                   eval      rseusr = l_user
     c                   write     rktslur
      *
     c     next          tag
      *
     c                   read      rktrle                                 61
     c                   enddo
      *  Nå skal ev sluttpost skrives ut
     c                   if        w_start = 'J'
     c                   if        w_tot < 0
     c                   eval      w_tot = w_tot * -1
     c                   eval      w_sign = ' '
     c                   else
     c                   eval      w_sign = '-'
     c                   endif
     c                   move      w_tot         w_totx
     c                   eval      w_totx = %xlate(' ':'0':w_totx)
     c                   move      w_ant         w_antx
     c                   eval      w_antx = %xlate(' ':'0':w_antx)
     c                   move      w_isodat      w_isox
     c                   eval      rcsrec = '99'  +
     c                             W_oppdrgiv     +
     c                             w_ddat         +
     c                             w_antx         +
     c                             w_totx         +
     c                             w_sign         +
     c                             w_x15
      *
     c                   write     rcsvpfr
     c                   eval      w_start = 'J'
     c                   endif
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     *inzsr        begsr
      *
     c                   eval      n = *zeros
      *
      *
     c     rkunl1_key    klist
     c                   kfld                    rkunl1_firm
     c                   kfld                    rkunl1_kund
      *
     c     rktrle_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rktrle_tist
      *
     c     rktrlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rktrlu_kund
     c                   kfld                    rktrlu_bdat
     c                   kfld                    rktrlu_tist
      *
     c     rktslu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rktslu_tist
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
     c                   move      l_firm        w_firm
      *
      * Hente opplysninger fra firmaregister
      *
     c     afirl1_key    chain     afirl1                             10
      *
      *  Finner faste opplysninger
      *
     c*    rca0l1_key    chain     rca0l1                             10
      *
     c*                  if        *in10 = *on
     c*                  eval      rc0inr = 1
     c*                  else
     c*                  eval      rc0inr = rc0inr + 1
     c*                  endif
      *
     c                   endsr
      *
