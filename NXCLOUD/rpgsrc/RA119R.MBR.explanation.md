# RPG Program RA119R â€“ Account Class Maintenance

This RPG III (possibly RPG IV, but written in fixed format) program is a maintenance application for "kontoklasser" (account classes) using subfiles and multiple screens on IBM i (AS/400) systems. It primarily allows the user to display, create, update, copy, and delete account classes.

Below is a breakdown of the code, focusing on key sections, data structures, and main routines. This will help new maintainers quickly understand the program's structure and logic.

---

## 1. File and Screen Declarations

```rpg
 fra19l1 if   e           k disk    rename(ra19pfr:ra19l1r)
 fra19l2 if   e           k disk    rename(ra19pfr:ra19l2r)
 fra19lr if   e           k disk    rename(ra19pfr:ra19lrr)
 fra19lu uf a e           k disk    rename(ra19pfr:ra19lur)

 fra119d cf   e             workstn sfile(b1sfl:w_srrn)
```

- `fra19l1`, `fra19l2`, `fra19lr`, `fra19lu` are database files, each with a specific purpose, renamed for this program.
- `fra119d` is the workstation file with subfile defined as `b1sfl` and record number `w_srrn`.

---

## 2. Data Area and Variable Definitions

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
...
d w_stel          s              4  0
d w_spge          s              4  0
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
...
d c_sfil          s              2  0 inz(14)
```

- Certain elements are mapped from the *User Data Area* (LDA), such as `l_user` (user id), `l_firm` (company), etc.
- `w_*` variables are working fields, mostly for subfile handling (counts, page size, relative record numbers).
- `c_sfil` is a constant indicating subfile size, set to 14.

---

### **Subfile Variables Explained:**
- `w_stel`: Subfile record counter
- `w_spge`: Page size in subfile (number of records per page)
- `w_srrn`: Relative record number in subfile
- `w_sfrn`: First record number on the page
- `w_ssrn`: Last record number on the page
- `w_curn`: Current record number on the page
- `w_virn`: Virtual page to display
- `w_afld`, `w_arow`, `w_acol`: Cursor positioning info

---

## 3. Program Flow

### **Main Loop**

The main logic is controlled by tags and GOTO statements (common in fixed-format RPG):

- **Entry Point (`b2taga` tag):**
  - Writes the B2 command screen (`write b2cmd`)
- **Data Display (`b2tagb` tag):**
  - Calls the subroutine `dsp_subfile` to display the current subfile page
- **Function Key Handling (`select/when`):**
  - Processes function keys for exit, renew, create, page up/down, position, etc.
  - Delegates actions to subroutines or uses GOTO for flow control.
- **Subfile Handling:**
  - After function key processing and possibly a positioning operation, calls the `subfile` subroutine to process subfile (list) actions.

### **Program Termination**
- When exit keys are detected, sets `*INLR = *ON` and returns.

---

## 4. Indicator Usage (for reference)

Commented at the top, commonly used indicators:
- `LR`      = End program
- `10`      = Rollup
- `11`      = Rolldown
- `12`      = Display subfile
- `13`      = Display control
- `14`      = Clear subfile
- `15`      = End of subfile
- `21`      = Home key
- `22`      = Cursor placement
- `30`      = Protect fields for display
- `31-79`   = Warnings/errors/messages
- `80-99`   = Work indicators

---

## 5. Subroutines Overview

### **A. Subfile Operations**

- **clr_subfile**: Clears the subfile by writing the control record with clear indicator (`*IN14 = *ON`).
- **crt_subfile**: Fills the subfile page-by-page from the database, with paging logic included.
- **bck_subfile**: Allows paging back in the subfile (reads previous records).
- **dsp_subfile**: Displays the subfile, managing the display and control record indicators.

### **B. Positioning and Renewal**

- **forny**: Renews the subfile, optionally repositioning to a specific entry (e.g., after an update or other navigation).
- **posisjoner**: Repositions the subfile starting point to a given account class or description.

### **C. Subfile Processing**

- **subfile**: Iterates through the visible subfile rows, checking for user actions (edit, copy, delete, view) and invoking associated subroutines.

### **D. Record Maintenance**

- **xc1bld**: Handles the "create new" screen and logic (C1BLD).
- **xc1msg**: Displays a message if trying to create a record that already exists.
- **xc2bld**: Handles viewing, editing, or creating a record (C2BLD).
- **xd1win**: Handles deleting a record (D1WIN).
- **xk1win**: Handles copying a record (K1WIN).

### **E. Initialization**

- **\*INZSR**: Sets up key lists for file operations, pulls initial data from data area, positions the file, and builds the first subfile page.

---

## 6. Key Lists

Key lists are defined for various file operations. Each one combines the company code (`w_firm`) with a different key or field, for use in CHAIN, SETLL, etc.

Example:
```rpg
c     ra19l1_key    klist
c                   kfld                    w_firm
c                   kfld                    ra19l1_skod
```

---

## 7. Sample Subfile Processing (from `subfile` subroutine)

```rpg
c                   do        w_ssrn
c                   readc     b1sfl
c                   ...
c                   if        b1valg = 2
c                   eval      c1skod = b1skod
c                   exsr      xc2bld
c                   eval      b1valg = 0
c                   update    b1sfl
c                   iter
c                   endif
...
c                   enddo
```

Each subfile entry is read with `READC`, and if the user requested an update (b1valg = 2), the corresponding subroutine is called to handle the action.

---

## 8. User Interface Screens

The program uses multiple screens:
- **B1SFL**: Subfile for listing account classes
- **B2CTL**: Subfile control record (paging, navigation)
- **B2CMD**: Command keys/help screen
- **C1BLD/C1MSG**: Create-screen and warning screen
- **C2BLD**: Edit/view screen
- **D1WIN**: Delete confirmation screen
- **K1WIN**: Copy confirmation screen

---

## 9. Overall Functionality

- **List**: Users view a paginated list of account classes.
- **Navigate**: Page up/down, position to specific code or description.
- **Edit/View**: Users can edit or view a selected account class.
- **Create**: Users can add a new account class.
- **Copy**: Users can copy an existing account class to a new one.
- **Delete**: Users can delete an account class.
- **Messages/Validation**: Error handling and confirmation messages are provided via modal screens.

---

## 10. Notes for Modern RPG Developers

- This program uses old-style indicators and fixed-format C-spec/CALC logic, which is less readable than modern free-form RPG.
- Modern RPG would use named indicators, subprocedures, and more structured error handling.
- The usage of *GOTO*s and manual indicator management is typical for legacy RPG code and may be refactored in modernizations.

---

## 11. Summary

- **Purpose**: Interactive maintenance of account classes via subfile.
- **Data Access**: Four database files for different key structures.
- **Subfile Use**: Core to the user interface/paging.
- **Multi-screen UI**: Specialized screen handling for create/view/edit/copy/delete.
- **Function Key Handling**: Controls all user actions via select blocks and indicators.
- **Initialization**: Occurs in *INZSR, loads company data and first subfile page.

---

This structure gives you a conceptual map of the program. As you work with the code, focus on understanding subfile mechanics, indicator usage, and how each subroutine maps to user actions and UI screens.