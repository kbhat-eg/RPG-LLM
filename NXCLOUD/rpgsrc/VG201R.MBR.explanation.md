# Explanation of RPG Program VG201R

This source code is a classic ILE RPG program for the IBM i (AS/400) platform. The purpose of the program is to present and allow querying of historical average cost prices ("kostpris historikk") for items in inventory, with a subfile-based display.

Below is a breakdown of the program’s structure and logic, annotated for clarity and onboarding.

---

## 1. **Header/Metadata**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Compiles without debug I/O and uses DD/MM/YY for date format.

```rpg
* System  . . . . : ASLAGR
* Program . . . . : VG201R
* Description  . : Inquiry on average cost price history
* Created  . . . : 211118 ASK  New program
```
- Comments give context, authorship, and notes.

---

## 2. **Indicator Usage**

RPG indicators (*INxx) control screen logic, function key handling, and various states.

- `LR` = Last record (program end)
- `*IN10` = Roll Up, `*IN11` = Roll Down
- `*IN12`, `*IN13`, etc.: relate to subfile control and display

---

## 3. **File Definitions**

```rpg
fvgkpi3    if a e           k disk    rename(vgkpst:vgkpi3r)
fvgkpir    if a e           k disk    rename(vgkpst:vgkpirr)
fvvarl1    if   e           K disk    rename(vvarpfr:vvarl1r)
fvg201d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- `vgkpi3`, `vgkpir`: Input keyed files, both renamed from `vgkpst`.
- `vvarl1`: For item master lookup, renamed from `vvarpfr`.
- `vg201d`: Workstation file displaying a subfile (b1sfl) with subfile record number `w_srrn`.

---

## 4. **Data Area/Variable Definitions**

**Local Data Area:**
```rpg
d l_firm                944    946  0
d l_fnav                951    980
```
- Used to retrieve the company code and firm name.

**Key and Working Variables:**
- Variables for file keys (item number, warehouse, etc.)
- Subfile variables: for page/record numbers, control, and formatting
- Control flags and constants (e.g., c_sfil: subfile page size)

---

## 5. **Screen and Subfile Structure**

- Subfiles are used for displaying multiple lines/items on-screen with paging support.
- Screen fields for item, cost price, effective date/time, etc.
- Subfile control (B2CTL), records (B1SFL), and command screens (B2CMD).

---

## 6. **Main Program Loop**

### a) Entry and Initial Display

- Program entry is handled implicitly.
- Reads parameters for item and warehouse.
- Initializes keys for database access.
- Reads values from the Local Data Area.
- Loads the initial subfile with cost price history for the given item and warehouse.

### b) Screen Logic and Function Key Handling

- `Tag b2taga:` writes the subfile command screen.
- `Tag b2tagb:` displays the current subfile page.
- Function keys processed via `select/when`:
    - `F3/F12` (`*INKC`/`*INKL`): Exit
    - `*IN10`: Next page (calls `crt_subfile`)
    - `*IN11`: Previous page (calls `bck_subfile`)
    - `*IN21`: Home, sets cursor placement flag

### c) Subfile Processing

- Subroutine `subfile`:
    - Toggles *IN22, used for cursor placement logic.
    - If a row is selected (via a function), handles display or editing.
    - Loops through screen records using `readc b1sfl`.
    - If user selects "View" (`b1valg = 5`), loads details and shows them on the detail display (via `xc2bld`).

---

## 7. **Subroutines**

### a) `xc2bld` - Display/Edit Item Detail

- Loads details of a selected record into screen fields.
- Moves data from database fields to screen fields.
- Handles special formatting (dates, times).
- Loads descriptive text for the item (`les_vare`).
- Waits for user interaction with the detail screen.

### b) `clr_subfile` - Clear Subfile

- Sets the clear subfile indicator and resets subfile counters.

### c) `crt_subfile` - Create/Load Next Page of Subfile

- Calculates the next page’s range.
- Reads data from `vgkpi3` and populates the subfile with the next set of records for the given item/warehouse.
- If end-of-file is reached or item changes, sets an end-of-subfile indicator.

### d) `bck_subfile` - Load Previous Page

- Uses `setgt`/`readp` to position the file cursor at the previous subfile "page".
- Clears and then refills the subfile with the prior page's records.

### e) `dsp_subfile` - Display Subfile

- If there are records, sets display indicators and shows subfile screen.
- Otherwise, shows command screen.

### f) `les_vare` - Lookup Item Master

- Retrieves item description from the item master file.

---

## 8. **Key Lists and Initialization**

- Key lists (`klist`/`kfld`) are defined for all file accesses for consistent keyed access.
- `*inzsr` subroutine:
    - Called on program start.
    - Extracts parameters.
    - Loads company code from LDA.
    - Sets up keys and initializes the first subfile page.

---

## 9. **End of Program**

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets the last record indicator to end the program and returns control to the caller.

---

## 10. **General Flow**

1. Accepts item and warehouse as parameters.
2. Loads and displays the cost price history for the item in a paged subfile.
3. Supports paging forward/back through history.
4. Allows the user to select a record for detail viewing.
5. The program ends on function key exit.

---

## 11. **Comments and Naming**

- Comments are in Norwegian, but the code is structured logically.
  - "kostpris" = "cost price"
  - "vare" = "item"
  - "historikk" = "history"
  - "subfile" = multi-row display screen

---

## 12. **Key Takeaways for Onboarding**

- **Subfile Handling:** Core logic revolves around the display and navigation of a subfile with cost history records.
- **Database Access:** Uses keyed access to inventory/item master and history files.
- **Screen Flow:** Function key handling and screen transitions are managed with indicators and explicit subroutines.
- **Customization:** Variable and field names are domain-specific but follow typical RPG conventions.
- **Extensibility:** New fields/features can be added by extending key lists, file definitions, and subfile layouts.

---

## 13. **Next Steps for New Developers**

- Understand subfile processing if not already familiar with RPG display programming.
- Review the DDS (screen definitions) for referenced display files/screens.
- Check database file layouts for `vgkpst`, `vvarpfr` to see available fields and keys.
- Test the program with various scenarios (single/multiple pages, no records, detail view, etc.).

---

**Summary:**  
This program is a well-structured example of classic ILE RPG for inventory cost history inquiry, using subfiles for paged multi-line display, function key navigation, and detail drill-down – all typical for IBM i business applications.