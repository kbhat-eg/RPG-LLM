# RPG Program: af820r – Importing File Groups from CSV

## Overview

This program (`af820r`) is responsible for importing and updating file group records from a CSV file into the application's master file group table. It processes each line from the input file, parses and validates the data, and updates or inserts records in the `afgriu` (file group) database file accordingly.

The program is designed for batch execution and is typically run during data migration or integration scenarios where file group definitions are maintained externally (e.g., from a partner system or spreadsheet).

---

## File Definitions

- **Input File**
  - `lwexpf`: The CSV-like input file, read sequentially.
- **Output/Update File**
  - `afgriu` (renamed as `afgriur`): The master file group table, updated or inserted into as needed.

---

## Data Structures

### Input Line Parsing

A single data structure overlays a 350-character buffer (`d_inpu`) for parsing fields from each input line. Key overlays:

- `d_gsrv` (12): Server code
- `d_gver` (10): Version
- `d_gfgr` (3): File group code
- `d_gtxt` (35): Description
- `d_antx` (6): Number of days after order (as character)
- `d_gmil` (3): Environment (added in version 7.01)

### Working Variables

- Key fields for updates (`afgriu_gsrv`, `afgriu_gfgr`)
- Flags and counters (`b_ok`, `w_anta`, etc.)
- Various buffers for parsing and processing

---

## Constants

- `Lo`, `Up`: Lowercase and uppercase alphabets (with Norwegian characters).
- `digits`: Used for numeric validation.
- `c_null`: Null value placeholder.

---

## Main Program Flow

1. **Loop through input file (`lwexpf`):**
   - Read each line.
   - Trim and store the line for processing.
   - Clear the input data structure.
   - Call `utled_ds` subroutine to parse and validate the line.
   - If parsing is successful (`b_ok = *on`), call `oppdater` to update/insert the file group record.

2. **End-of-file:** Set LR indicator and return.

---

## Subroutines

### `utled_ds` – Parse and Validate Input Line

- **Purpose:** Extracts fields from the semi-colon separated input line, performs normalization, and validates critical fields.
- **Field Extraction Order:**
  1. **Server (`d_gsrv`):** Extracted and validated against a whitelist. Some server names are normalized to internal codes.
  2. **Environment (`d_gmil`):** Added in version 7.01; extracted if present.
  3. **Version (`d_gver`)**
  4. **File Group (`d_gfgr`)**
  5. **Description (`d_gtxt`)**
  6. **Number of Days (`d_antx`):** Parsed and converted to numeric (`w_anta`). Defaults to 0 if invalid.

- **Validation:**
  - Only lines with recognized server codes are processed.
  - Server names are mapped to internal codes as needed.
  - If `d_antx` is not numeric, `w_anta` is set to zero.

- **Side Effects:** Sets `b_ok` flag if the line is valid and ready for database update.

### `oppdater` – Update or Insert File Group Record

- **Purpose:** Updates the master file group table (`afgriu`) with the parsed data. If the key exists, the record is updated; otherwise, a new record is inserted.
- **Logic:**
  - Clear the output record buffer.
  - Chain (lookup) on the composite key (server, file group).
  - Set fields from parsed data.
  - Set `afgakt` (active flag) based on `w_anta` (active if < 50 days).
  - If record exists: update timestamps/user and update.
  - If not: populate key fields and write new record.

---

## Key Design and Business Logic

- **Server Code Normalization:** The program enforces strict mapping of external server codes to internal representations. This ensures consistency in the master table regardless of input source variations.
- **Active Flag Logic:** File groups are marked as active only if the number of days after order is less than 50. This is a business rule likely tied to operational status.
- **Field Extraction:** Input CSV lines are parsed field-by-field using `%scan` and `%subst` rather than a delimiter-splitting utility. This is robust for fixed-order, semi-colon separated files but assumes consistent formatting.
- **Environment Handling:** The `d_gmil` field was introduced in version 7.01, showing ongoing evolution of the data model.
- **User/Metadata:** User and timestamp fields are updated on record modification, supporting audit requirements.

---

## Interactions and Dependencies

- **afgriu (afgriur):** The central file group master. This program is the primary batch loader/updater for this table.
- **Input File (lwexpf):** Must be pre-populated, semi-colon separated, with fields in the expected order.
- **User and Firm Info:** User and firm fields are expected to be set in the user data structure (`uds`), possibly by the job environment or a calling program.

---

## Conventions and Patterns

- **Field Overlaying:** Input parsing uses overlays on a single buffer for efficiency and clarity.
- **Subroutine-Based Parsing:** Parsing and update logic are modularized, making future field additions straightforward.
- **Explicit Field Mapping:** All field transformations and mappings are handled explicitly, with business rules (e.g., server code normalization) embedded in code.
- **Backward Compatibility:** The code includes logic to handle both legacy and new fields (e.g., environment), supporting phased data migration.

---

## Summary

This program is a robust, batch-oriented loader for file group definitions, enforcing business rules around server codes, environments, and activation status. It is central to the integrity of the file group master data. New developers should focus on the field mapping logic, the normalization of server codes, and the handling of active/inactive statuses, as these are critical to correct system operation. Changes to input format or business rules must be carefully coordinated with this program’s parsing and update routines.