# Program NO8080R – Winner Temporary File Import

## Overview

This program is part of the ASOFAK system and is responsible for importing and processing records from a temporary Winner file. The data is parsed, mapped to internal structures, and written into the external order system’s header (NOWHIU) and line (NOWLIU) files. After processing, the program logs the update and calls another program (`NO881R`) to further handle the import.

## Main Responsibilities

- **Read and parse records** from the Winner import file (`wimpi1`).
- **Distinguish between header and line records** based on record type.
- **Extract and map data fields** from the semi-colon separated input records.
- **Write processed data** to internal order header (`nowhiu`) and order line (`nowliu`) files.
- **Log status updates** (though this is currently commented out).
- **Trigger further processing** by calling `NO881R` after import.

## Key Files

- **wimpi1**: Input file, Winner import temporary file, read sequentially.
- **nowhiu**: Output file, order header records.
- **nowliu**: Output file, order line records.

## Parameters

The program expects several parameters on entry:

- `p_firm`: Company number (3,0)
- `p_eksk`: External key (30A)
- `p_lage`: Warehouse code (2A)
- `p_avde`: Department (4,0)
- `p_stat`: Status (1,0)

These are set up in the *inzsr subroutine.

## Data Structures

- **d_trec**: Used to parse each input record. Contains:
    - `d_recty`: Record type (first 3 chars)
    - `d_fill`: Filler (1 char)
    - `d_line`: Actual data line (496 chars)

- Various working variables for parsing and mapping fields.

## Main Processing Flow

1. **Initialization** (in *inzsr):
    - Receives parameters and initializes key fields and timestamps.

2. **Main Loop**:
    - Sequentially reads each record from `wimpi1`.
    - Copies the current record into `d_trec`.
    - Skips records with type '0;' (likely headers or control records).
    - For other records:
        - If `d_recty` < '500', processes as a header record (`oppr_hode`).
        - Else, processes as a line record (`oppr_linje`).

3. **After Processing**:
    - Logs status update (subroutine `log_oppd`, currently commented out).
    - Converts date and time to numeric format.
    - Calls program `NO881R` with relevant parameters for further processing.

4. **Program End**:
    - Sets LR indicator and returns.

## Header Record Processing (`oppr_hode`)

- Handles multiple record types (e.g., 100, 200, 211, 212, 213, 300, 302, 303, 401, 406).
- Each type corresponds to a specific data segment:
    - **100**: Customer number (orderer)
    - **200**: Project information (number, name, customer, customer ref, etc.)
    - **211**: Customer details (name, address, postal code, city, phone, mobile, email)
    - **212**: Delivery details (name, address, postal code, city, phone, mobile, email)
    - **213**: Invoice details (name, address, postal code, city, phone, mobile, email)
    - **300**: Dates (offer date, valid to, delivery dates)
    - **302**: Freight cost
    - **303**: Reference info (seller, seller email)
    - **401/406**: Additional reference info
- Uses `%scan` and `%subst` to parse fields from the semi-colon delimited string.
- Writes header to `nowhiu` at the end of a header block (`skriv_hode`).

## Line Record Processing (`oppr_linje`)

- Handles multiple record types (e.g., 500, 505, 513, 520, 524).
- Each type corresponds to a specific line item segment:
    - **500**: Main item line (item number, text number, supplier item, text, quantity, unit, catalog price, cost price, discounts)
    - **505**: Product group information
    - **513**: Hinging information
    - **520**: Supplier information
    - **524**: Model code
- Similar parsing logic as headers.
- Writes line to `nowliu` at the end of a line block (`skriv_linje`).

## Key Design and Parsing Patterns

- **Semi-colon Delimited Parsing**: The program relies heavily on `%scan` to find field delimiters and `%subst` to extract data fields.
- **Field Skipping**: For fields not used, the code increments pointers to skip them efficiently.
- **Conditional Field Extraction**: For some fields, if the data is blank, zero is used as default.
- **Date Handling**: Dates are parsed by removing slashes, rearranging substrings, and converting to numeric and then date format.
- **Subroutine Structure**: Each major functional block (header/line processing, writing, logging, error handling) is encapsulated as a subroutine.
- **Commented Out Code**: The log update subroutine (`log_oppd`) is present but not active, possibly due to changes in business requirements or data flows.

## Interactions with Other Modules

- **NO881R**: After import, the program calls this external program, passing company, warehouse, department, date, and time for further processing. This is likely the point where orders are finalized or further integrated.

## Business/Domain-Specific Logic

- **Winner Import**: The Winner system provides temporary files with order and line data. This program is a bridge, mapping Winner’s export format to the internal order management system.
- **Record Types**: The numeric record types (e.g., 100, 200, 500, etc.) are specific to the Winner export file format and must be interpreted according to Winner’s documentation.
- **Order Structure**: The program assumes a fixed structure: header records precede line records, and each is mapped to nowhiu/nowliu accordingly.
- **Field Mapping**: The mapping between Winner fields and internal fields is hardcoded, based on field position in the semi-colon delimited string.

## Non-Obvious Design Decisions

- **Parsing by Field Position**: Instead of using a more generic CSV parser, the code manually navigates to each field. This is efficient but fragile if the Winner file format changes.
- **Minimal Error Handling**: Error handling is limited to setting status and exiting (see *pssr subroutine).
- **Logging**: The logging mechanism is present but commented out, suggesting that logging was once required but is now either obsolete or handled elsewhere.
- **No Dynamic Field Mapping**: All field positions are hardcoded, reflecting a tightly coupled interface with the Winner file format.

## Conventions

- **Field Naming**: Internal fields use prefixes like `nwh` (header) and `nwl` (line).
- **Subroutine Naming**: Norwegian terms are used (e.g., `oppr_hode` = process header, `skriv_linje` = write line).
- **Tags and GOTO**: Some use of `tag` and `goto` for flow control, which is typical in legacy RPG code.

## Summary

This program is a critical piece in the import pipeline for external order data from the Winner system, acting as an ETL (Extract, Transform, Load) utility. It is tightly coupled to the Winner file format, with explicit field extraction logic for each record type. After processing, it integrates the imported data into the internal order system and triggers further processing via an external call.

**When maintaining or extending this program:**
- Be cautious about changes to the Winner file format.
- Any new record types or fields must be explicitly handled.
- Consider refactoring parsing logic if the format becomes more complex or variable.
- Review the logging mechanism if traceability of imports is needed again.

For questions about specific field mappings or Winner file structure, refer to the Winner export documentation or consult with business analysts familiar with the order import process.