**Overview**  
This program (SF521R) is part of the ASSTAT system and handles the maintenance (updates) of sales statistics. It retrieves a specific record from the “sstal1” file using a combination of keys (firm number and references such as period, line, etc.), then displays relevant data on the workstation screen (via file SF521D). The user can modify certain fields (e.g., price group, campaign, department, seller), and the program updates the underlying statistics file if those fields change. Finally, it returns the updated sum to the calling routine.

---

## Purpose and Flow

1. **Initialization**  
   - The program starts by receiving parameters (p_firm, p_paar, p_binr, p_line, p_bida, p_sumk).  
   - It stores the “firm” parameter into a local variable (`w_firm`).  
   - Key lists (`sstal1_key`, `rkunl1_key`, `fkprl1_key`) are defined for database lookups.

2. **Data Fetch and Verification**  
   - The program constructs a key for file SSTAL1 using the firm code plus the “paar”, “binr”, “line”, and “bida” parameters.  
   - It attempts to `CHAIN` to SSTAL1. If the record is not found, control jumps to the end (label “avslutt”).

3. **Screen Preparation**  
   - Once the SSTAL1 record is found, its fields (`sf...`) are moved to working areas (`b1...`).  
   - For example, `sfvkun` (customer) moves into `b1vkun`.  
   - The program calculates a net sum (`b1sumn`) as a gross sum minus discounts.  
   - If a customer number (`sfvkun`) exists, the program retrieves the customer name from RKUNL1 to display on the screen.  
   - If a project number (`sfkpro`) exists, it retrieves the project name from FKPRL1.

4. **User Interaction**  
   - The workstation format (`b1bld`) is presented via `EXFMT`.  
   - Standard function key checks (e.g., *INKC or *INKL) lead to program exit.

5. **Statistics Update**  
   - If the user changed specific fields (sum, project, campaign, department, seller), the program updates the SSTAL1 record accordingly.  

6. **Termination**  
   - Before ending, the program sets `p_sumk` to the updated sum and returns control to the caller with `*INLR = *ON`.

---

## Business/Domain Logic Highlights

- **Sales Statistics File (SSTAL1)**  
  This file contains detailed sales entries keyed by firm, period/year (`paar`), invoice or order number (`binr`), line items (`line`), and date (`bida`). The program updates certain commercial fields (e.g., sum, price group, campaign codes, department codes, and seller IDs).  

- **Customer Master (RKUNL1)**  
  When the user supplies a non-zero customer number (`sfvkun`), the program looks up the customer’s name from RKUNL1 to display alongside the statistical data.

- **Project Master (FKPRL1)**  
  If there is a non-zero project number (`sfkpro`), the program fetches the project name for display. This suggests that each sales record may be linked to a project and must keep that relationship synchronized.

- **Net Sum Calculation**  
  The net sum (`b1sumn`) is computed by subtracting multiple discounts (`sfrab1`, `sfrab2`, `sfrabo`) from the gross sum (`sfsumb`). This ensures that the displayed net sum reflects all discount scenarios.

- **Extended Price Group**  
  There is a note in the header referencing an extension of the price group from one to two characters (the “Utvidet prisgruppe”). This change might align with updates required in other programs or tables to accept longer codes for pricing methods.

---

## Design Decisions and Conventions

- **Renaming External Record Formats**  
  In the F-specs, files like “sstal1” (renamed from sstapfr) are suffixed with “r” in references (sstal1r). This local rename convention ensures uniqueness of record format names in the program.

- **B1 Fields in the Screen Structure**  
  All display-related fields are named with a “b1” prefix (e.g., `b1vkun`, `b1kpro`), suggesting a naming convention for the interactive screen. By contrast, the actual file fields use the “sf...” prefix.

- **Key Lists for CHAIN**  
  The program uses named KLIST structures (sstal1_key, rkunl1_key, etc.) to define multi-field keys. This is a standard practice to keep the chain-keys organized and consistent.

- **Modular Lookups**  
  Splitting lookups among SSTAL1, RKUNL1 (customer), and FKPRL1 (project) indicates a breakdown of responsibilities across multiple database objects. This design aligns each file to its respective domain function (e.g., sales statistics, customer data, project data).

- **Controlled Exit Points**  
  The program has clear labels (`avslutt`) and uses GOTO only for specific exit conditions (e.g., missing record), keeping the main flow in a single routine before final housekeeping.

---

**Summary**  
SF521R is an update module for a sales statistics file, allowing the user to view and modify certain key fields. It chains to related customer and project files to display descriptive names, and it recalculates or stores updated amounts as needed. The program follows a consistent naming scheme for screen fields and file fields, uses key lists for multi-field lookups, and terminates by returning the updated sum to the calling program. All of this ensures straightforward maintainability of the sales-statistics logic within the ASSTAT application.