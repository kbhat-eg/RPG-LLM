# Documentation for RPG Program JV622R

## Overview

**Program:** JV622R  
**System:** ASVADM  
**Purpose:**  
This batch program transfers "service items" (tjeneste varer) that match a selection mask (utvalgsmasken) into a dedicated item register (vareregister). The program is primarily used to synchronize or copy selected service items into the main item registry, ensuring that all related data (units, prices, EANs, search texts, warehouse records, etc.) is correctly created or updated.

**Domain Context:**  
- "Tjeneste varer" refers to service-related items.
- The program operates on item master data, including groupings (overgruppe, hovedgruppe, undergruppe), units, prices, EANs, and related attributes.
- The system is used in a Norwegian business environment (as evident from variable names and comments).

---

## High-Level Flow

1. **Initialization:**  
   - Parameters are loaded and mapped.
   - Various key lists for file access are set up.
   - Current date/time and user info are fetched.

2. **Header Output (hode):**  
   - Fetches company and item group information for context/reporting.

3. **Main Processing (behandling):**  
   - Iterates through items matching the selection mask (group, subgroup, etc).
   - For each item, applies further selection criteria.
   - Processes each qualifying item (behandl_vare).

4. **Item Processing (behandl_vare):**  
   - Checks group membership.
   - Calls subroutines to update or create records in the EVR (main item registry) and related files.
   - Handles units, prices, EANs, search texts, and warehouse records.

5. **Finalize:**  
   - Returns the count of items written/updated and any non-transferred units via parameters.

---

## Main Data Files and Relationships

The program interacts with numerous physical/logical files, including:

- **jvprpf, jvarlc, jvpkl2, jvpklr, jwprlu, jvdtlu, jvpkpfr, jvarpfr, etc.:** Original/service item master and related files.
- **vvarlu, vvprlu, vveplu, vvenlu, vvepl2, vvaslu, veanlu, veanl1, vsoklu, vsokl1, vlaglu, etc.:** Target/main item registry and related files (EVR).
- **afirl1, jlevl1, vogrl1, vhgrl1, vugrl1:** Group, company, and supplier master files.
- **ra10l1, mltilr:** Warehouse and ABC parameter files.

---

## Key Business Logic and Notable Design Decisions

### 1. **Selection Mask and Item Filtering**

- The program supports selection by overgruppe (main group), hovedgruppe (subgroup), and undergruppe (sub-subgroup).
- If a specific item number is provided, only that item is processed.
- The selection logic ensures only relevant items are considered for transfer.

### 2. **Item Record Creation/Update**

- For each qualifying item, the program checks if it already exists in the EVR (main registry).
- If not, a new record is created; otherwise, the existing record is updated.
- Many attributes are copied from the source to the target, with business-specific overrides (e.g., setting type, status, etc).

### 3. **Unit Handling (Enheter)**

- Up to five sales units and three purchase units per item are supported.
- Units are determined by reading the packing file (jvpkl1).
- Units are checked for validity against a unit master (venhl1).
- Invalid units are logged and returned in an output parameter.

### 4. **Warehouse Records**

- For each item, warehouse records are created for all relevant warehouses (from ra10l1).
- Only new records are created if one does not already exist.

### 5. **Price Handling**

- Price records are created for each sales unit (oppr_pris).
- The price group field was expanded from 1 to 2 characters in a recent version (see 8.01).

### 6. **EAN/GTIN Management**

- EANs are handled both at the item and unit level.
- If an EAN is not already linked to the item/unit, it is added to the general EAN register.
- The program also ensures that EANs are not duplicated or incorrectly assigned across items/units.

### 7. **Search Texts (SÃ¸ketekster)**

- Search texts are copied from the source to the target registry, but only if they do not already exist.
- Both module keywords and custom search texts are considered.

### 8. **Temporary and Deleted Records**

- If an item is found in the register of deleted items (vvaslu), it is removed upon successful transfer.
- Temporary price records (jwprlu) are also deleted if found.

### 9. **Parameter Handling**

- The program receives and returns several parameters, including the number of items written/updated and a comma-separated list of invalid units.

---

## Subroutine Structure and Notable Patterns

- **Subroutines** are used extensively to modularize logic (e.g., for unit creation, price creation, EAN management, logging).
- **Key lists** are defined for each file access pattern, ensuring efficient indexed access.
- **Versioned logic** is marked in comments (e.g., 6.30, 6.31, 6.32, 6.33, 8.01), reflecting business-driven changes over time.
- **Error Handling:**  
  - The program logs invalid units and returns them as a comma-separated string.
  - Leavesr and goto are used to exit subroutines or skip to next processing steps as needed.

---

## Key Subroutines

- **hode:** Loads company and group data for context.
- **behandling:** Main loop over items to be processed.
- **behandl_vare:** Processes an individual item, including all related data.
- **oppdater:** Updates or creates the main item record in EVR.
- **finn_enhet:** Determines valid sales and purchase units for the item.
- **oppr_enhet:** Creates/updates item unit records, including handling for up to 5 sales units and 3 purchase units.
- **oppr_pris:** Creates price records for each sales unit.
- **oppr_vep:** Creates/updates packaging records for each unit.
- **rydd_ean:** Ensures EAN/GTIN numbers are not duplicated across items/units.
- **sjekk_pkdato:** Validates packing date ranges.
- **log_enhet / skriv_enhet:** Logs and returns invalid units.
- **Initialization (*inzsr):** Sets up parameters, keys, and initial state.

---

## Version History Highlights

- **6.30:** Added warehouse record creation and price initialization to zero.
- **6.31:** Added warning/logging for invalid units.
- **6.32:** Support for 5 sales units (increased from 3); conversion factor set to 1.
- **6.33:** Price handling for units 4 and 5.
- **8.01:** Price group field expanded from 1 to 2 characters.

---

## Interactions with Other Modules

- Calls external program 'VV750R' to update search text against items in EVR.
- Relies on a large number of physical and logical files for master data, item details, units, prices, EANs, search texts, and warehouse information.

---

## Conventions and Patterns

- **Naming:**  
  - Prefixes like 'jv', 'vv', 've', 'js', etc., denote different file origins or business concepts (e.g., jv = source/service, vv = target/EVR).
  - Variables and fields are named in Norwegian, closely matching the business domain.
- **Key Management:**  
  - All file access is via explicitly defined key lists, supporting efficient indexed operations.
- **Data Movement:**  
  - Data is copied field-by-field, with business logic applied to certain fields as required.

---

## Special Considerations for New Developers

- **Master Data Synchronization:**  
  This program is central to keeping the main item registry (EVR) in sync with the service/source item data, including all associated attributes.
- **Business Rules are Embedded:**  
  Many business rules (e.g., unit validation, group membership, price initialization) are enforced directly in the code. Changes to these rules require careful code updates.
- **File Layouts are Key:**  
  Understanding the layout and relationships of the physical/logical files is essential. Field names and keys are critical for correct operation.
- **Parameter Passing:**  
  The program is designed to be called from other programs or batch jobs, with in/out parameters for status and error reporting.
- **Error Logging and Reporting:**  
  Invalid units are tracked and returned; other errors generally cause the item to be skipped.

---

## Summary Table: Key Files and Their Roles

| File      | Role/Content                      | Suffixes | Notes                                      |
|-----------|-----------------------------------|----------|---------------------------------------------|
| jvarlc    | Source item master                | -        | Service/source items                        |
| vvarlu    | Target item master (EVR)          | -        | Main registry                               |
| vvenlu    | Item units (EVR)                  | -        | Up to 5 sales, 3 purchase units             |
| vvprlu    | Item prices (EVR)                 | -        | Price per unit                              |
| vveplu    | Packaging info (EVR)              | -        | Per unit                                    |
| veanlu    | EAN/GTIN register (EVR)           | -        |                                            |
| vsoklu    | Search texts (EVR)                | -        |                                            |
| vlaglu    | Warehouse records (EVR)           | -        | Per warehouse                               |
| ra10l1    | Warehouse master                  | -        | Used to create vlaglu records               |
| ...       | ...                               |          | ...                                         |

---

## Conclusion

This program is a robust, business-critical batch utility for synchronizing service items into the main item registry, enforcing a wide range of business rules around units, prices, EANs, search texts, and warehouse handling. It is modular, highly parameterized, and tightly coupled to the business's data model. Understanding the underlying file structures, key business rules, and the flow of data is essential for effective maintenance and extension of this code.