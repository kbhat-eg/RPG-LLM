## Overview  
FO799R is an interactive RPGLE module that prepares the parameters needed to send an SMS by leveraging the e-mail gateway of a mobile operator. It displays a simple “B1” screen for a user to confirm and/or edit the constructed message fields, then returns those values to the caller program.

---

## Major Components  

1. **File Definitions**  
   - Customer master (`RKUNPFR`), price file (`FKPRLR`), sales-rep file (`RA09L1R`), mobile-operator file (`RA29L1R`), routine register (`AFORL1R`), firm register (`AFIRL1R`)  
   - Display file (`FO799D`) defines the “B1” panel  

2. **Parameters**  
   - Input:  
     - `p_kule` – type flag (‘K’=customer lookup)  
     - `p_kund`, `p_kpro` – customer key fields  
     - `p_selg` – sales-rep code  
     - `p_numm` – order number  
   - Output (returned to caller):  
     - `p_navn` – recipient name  
     - `p_emal` – constructed SMS address (e.g. “47xxxxxx@operator.com”)  
     - `p_emne` – subject line  
     - `p_pers` – signature line (“Vennlig hilsen: …”)  
     - `p_ema2` – sender’s e-mail address  
     - `p_inif` – initialization hex values from routine register  
     - `p_in03` – exit indicator  

3. **Local Control Data (LDA)**  
   - `l_ruti` – routine code to pull default text/data  
   - `l_firm` – company code to select correct firm record  

---

## Screen-Flow (Label B1)  

1. **Initialize display fields**  
   Clears variables for customer number, name, mobile, SMS address, subject, signature.  

2. **Fetch Customer Mobile Number**  
   If invoked with `p_kule = 'K'`, chain to the customer master:  
   - If found, take `rkmobn` (mobile no.) into the B1 field.  
   - If the master doesn’t contain a mobile, chain into the price file (`FKPRLR`) as a fallback.  

3. **Determine Mobile Operator**  
   - The first two characters of `w_mobo` (a flag set earlier) identify the operator code.  
   - Chain to `RA29L1R` to retrieve the SMS-gateway domain (`recadr`) and description (`rectxt`).  

4. **Compose SMS “e-mail address”**  
   - Slice the plain mobile number into segments (e.g. country code, operator prefix, etc.).  
   - Concatenate with “@” + operator domain.  

5. **Fetch Sender E-mail & Signature**  
   - Chain on `p_selg` in the sales-rep file (`RA09L1R`) to get the sender’s e-mail (`raiema`) and name (`raitxt`).  
   - Build `b1pers = 'Vennlig hilsen: ' + raitxt`.  

6. **Load Default Text from Routine Register**  
   - Chain on `l_ruti` in `AFORL1R` to get up to two hex strings (`afhex1`, `afhex2`).  
   - Combine into `p_inif`.  

7. **Prepare Subject Line**  
   - Chain on `l_firm` in the firm register (`AFIRL1R`) to get company name (`aafnav`) and default subject prefix (`aftxt1`).  
   - Build `b1emne = aftxt1 + ' ' + order-number + ' fra ' + companyName`.  

8. **Display & Validation Loop**  
   - `EXFMT B1BLD` shows the panel.  
   - F3 or Enter with Function-Code = *Exit sets `p_in03` and leaves.  
   - On normal submit, `EXSR SJ EKK_INPUT` ensures at least one recipient address is present.  
   - If validation passes, `EXSR FLYTT_PAR` moves B1 fields into the output parameters.  

---

## Subroutines  

- **SJ EKK_INPUT**  
  - Checks that the SMS address (`b1emal`) is not blank.  
  - Sets error indicator to force redisplay otherwise.  

- **FLYTT_PAR**  
  - Transfers display fields (`b1navn`, `b1pers`, `b1emal`, `b1emne`) into the program’s parameter variables (`p_navn`, `p_pers`, `p_emal`, `p_emne`).  

- **INZSR (Initialization)**  
  - Populates the work-area `w_firm` from LDA, moves the order-number into `w_numm`, and defines *CHAIN key lists for all file lookups.  

---

## Key Design Conventions  

- **LDA Usage**: `l_ruti` and `l_firm` drive lookups in routine and firm registers, enabling configurable texts without recompiling.  
- **Fallback Logic**: Mobile number is fetched first from the customer master, then from the pricing file if missing.  
- **Operator Domain Mapping**: Uses a separate file (`RA29L1R`) to allow easy changes of SMS-gateway addresses per operator code.  
- **Parameter-Driven**: All external data is passed via parameters and LDA, making the program reusable in different contexts (e.g. for orders, delivery notices, etc.).  
- **Minimal Business Layer**: FO799R only gathers, formats, and validates data. The actual sending of the SMS is performed by the caller using the returned parameters.