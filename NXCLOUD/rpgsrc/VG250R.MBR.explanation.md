# RPG Program VG250R – Explanation

This RPG (Report Program Generator) ILE (Integrated Language Environment) code is an interactive program for IBM iSeries (AS/400). The program manages a subfile display, allowing the user to scroll and select records related to "Faktortype" (Factor Type). The program structure includes file definitions, field and constant declarations, main logic, and a set of subroutines for typical subfile operations (fill, clear, scroll, position).

Below you’ll find a breakdown of the program components, structure, and purpose, as well as key sections commented for easier onboarding and maintenance.

---

## 1. **File Section**

```rpg
fvgkti1    if   e           k disk    rename(vgktst:vgkti1r)
fvg250d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **vgkti1**: Input file ("vgktst"), accessed by key, renamed as vgkti1r.
- **vg250d**: Display file used as workstation with a subfile (`b1sfl`, controlled by field `w_srrn`). The display is also tied to a feedback data structure (`dspfbk`) to get cursor, etc.

---

## 2. **Data Definitions**

### a. **Parameters**
```rpg
d p_firm      s       like(vtfirm)
d p_ftyp      s       like(vtftyp)
```
- External parameters (presumably received on program call): company (`p_firm`) and factor type (`p_ftyp`). Based on externally defined types.

### b. **Feedback/Infds Structure**
```rpg
d dspfbk      ds
d  d_fcrn         378    379I 0
```
- `dspfbk`: Display feedback data structure.
- `d_fcrn`: Field at position 378–379 in feedback structure, typically holding the cursor position (first record number on subfile page).

### c. **Key and Control Fields**

Fields such as `vgkti1_ftyp`, `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` are used to track subfile/key fields:
- **w_fcrn**: First record number on the page.
- **w_stel**: Subfile record counter.
- **w_spge**: Subfile page size (how many records per page).
- **w_srrn**: Current subfile relative record number.
- **w_sfrn**: First record number on the last page.
- **w_ssrn**: Last record number in the subfile.

### d. **Other Variables**
- **b_valg_ok**: Selection flag (if a user has selected a record).
- **w_firm**: Current company (for positioning/filtering).

### e. **Constants**
```rpg
d c_sfil      s       2  0 inz(8)
```
- **c_sfil**: Subfile page size (default 8 records).

---

## 3. **Indicators Usage**

Special indicators (see comments in code):
- LR: Last record (end program)
- 10-15, 21-22, 30, 31-99: Used for screen, error, control, and work

---

## 4. **Main Control Flow (Cycle)**

### **Entry Points and Main Loop**

- **Initialization**: `*INZSR` gets called automatically to fetch parameters, set initial screen, load first subfile page.
- **Main cycle**:
    - Display/refresh subfile (`dsp_subfile`)
    - Wait for user action (function key, selection, scroll, etc.)
    - Branch and execute corresponding subroutines (`forny`, `crt_subfile`, `bck_subfile`, etc.)
    - Loop until exit (indicator LR set).

---

## 5. **Subroutine Breakdown**

### a. **forny**: Refresh Subfile
- Re-positions the database cursor if not at the first record.
- Re-builds (`crt_subfile`) the subfile from the current position.

### b. **posisjoner**: Positioning
- Allows user to key in a specific factor type to position and display that portion of the subfile.
- Clears old subfile and fills new based on the new position.

### c. **subfile**: Selection Handler
- Handles subfile input/selection loop.
- Iterates subfile records; if a record is selected (`b1valg = 1`), sets program output and signals selection.

### d. **clr_subfile**: Clear Subfile
- Activates indicator 14 to clear subfile display/control.
- Resets record counters and page information.

### e. **crt_subfile**: Fill Subfile
- Loads the next page of records from the database into the subfile.
- Ends subfile if end-of-file or company doesn't match.

### f. **bck_subfile**: Scroll Backwards
- Moves backwards by a page in the subfile, if possible.
- Re-loads the subfile display.

### g. **dsp_subfile**: Display Subfile
- If there are subfile records, sets display indicators and formats the screen.
- Updates cursor position and display state.

### h. **\*INZSR**: Initialization
- Loads parameters.
- Positions database cursor to the correct company and initializes the display.

---

## 6. **Key RPG Logic**

- **Subfiles**: Used for paginated display and selection of records on-screen.
- **Indicators**: Classic RPG mechanism for controlling program and display flow.
- **Database I/O**: `CHAIN`, `SETLL`, `READ`, `READC`, `READP` for positioning and reading DB records.
- **User Interaction**: Function keys and screen indicators are used for navigation and selection.
- **Return Values**: Output parameters are set based on user selection.

---

## 7. **Program Flow Example**

1. **Start**: Program initializes (`*INZSR`), loads initial records into the subfile.
2. **Display**: Presents the subfile to the user.
3. **User Action**: User scrolls (Page Up/Down), positions to a type, or makes a selection.
4. **Process**: Based on user input, moves or rebuilds subfile, positions, or exits.
5. **Selection**: If the user selects a factor type, the corresponding value is returned to the caller.

---

## 8. **Notes**

- **External Objects**: The program relies on the existence of display file (`VG250D`) and logical/physical file (`VGKTI1`).
- **Norwegian Terms**: Some comments and field names are in Norwegian (e.g., "Beskrivelse" = description, "Faktortype" = factor type).
- **Legacy Style**: Code uses fixed-format RPG IV/ILE, with traditional indicators and C-specs.

---

## 9. **Summary Table of Main Subroutines**

| Subroutine          | Purpose                                     |
|---------------------|---------------------------------------------|
| forny               | Refresh and rebuild current subfile page    |
| posisjoner          | Position to a specific factor type          |
| subfile             | Handles selection from subfile list         |
| clr_subfile         | Clears subfile and related counters         |
| crt_subfile         | Populates subfile with next set of records  |
| bck_subfile         | Scrolls subfile backward (previous page)    |
| dsp_subfile         | Displays subfile and processes input        |
| *INZSR              | Initializes the program state and display   |

---

## 10. **Onboarding Tips**

- Learn how subfiles work in RPG (displaying, paging, selection).
- Understand RPG IV indicators and file handling in legacy code.
- Know how to debug and step through interactive RPG applications, especially those using subfiles.
- Review external display and physical/logical files for field definitions.

---

**In essence, this program is an interactive, paged list/selection utility centered around a "factor type" concept using classic subfile management in RPG IV.**