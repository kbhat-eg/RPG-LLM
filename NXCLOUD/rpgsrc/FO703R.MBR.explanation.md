## Program Overview

This program, `FO703R`, is part of the ASOFAK system and is responsible for updating order header totals, including VAT (mva), based on the associated order lines. The main business function is to aggregate financial figures from order lines and ensure the order header reflects the correct totals, including the calculation and distribution of VAT across various rates.

## File Usage and Data Relationships

The program interacts with several physical/logical files:

- **VLtyl1 (Order Line Type Master):** Used to determine the type and classification of each order line.
- **FOdtl1 (Order Line Details):** Contains the actual order lines for each order, including amounts, VAT codes, etc.
- **FOhel1 (Order Header):** The header record for each order, where totals are to be updated.
- **VVarl1 (Item Master):** Provides additional information about items referenced in order lines.

All files are accessed via keyed access, and renaming is used to avoid naming conflicts.

## Key Variables and Structures

- **Parameters:** The program receives firm number, order number, order suffix, and a variable for returning the calculated order total (including VAT).
- **Arrays:** Several arrays are used to accumulate VAT amounts and bases for up to 9 different VAT codes/rates (`mko`, `msa`, `mgr`, `mbe`, `mog`, `mor`).
- **Working Variables:** Totals for net, VAT, and other financial metrics are accumulated in variables like `w_tnet`, `w_mvab`, `w_npri`, etc.

## Main Logic Flow

### 1. Initialization

- The program initializes working totals to zero.
- The parameter list is set up to receive order identification and to return the calculated total.

### 2. Reading and Summing Order Lines

- The program reads all order lines (`FOdtl1`) for the given order.
- For each line:
    - The line type is fetched from `VLtyl1` to determine how to process the line.
    - Lines marked as "text lines" (`valktx = 0`) are skipped from financial calculations.
    - For other lines, if a VAT code is present (`fdomva <> *blank`), item data is fetched from `VVarl1`.
    - The net price for the line is calculated as `fdsums - fdsumr` (gross minus discount).
    - The net total (`w_tnet`) is accumulated.
    - VAT calculations are performed via a call to external program `RS205R`, which returns VAT rate, amount, and other relevant data.
    - If a VAT rate is returned (`w_mvas > 0`), the VAT base (`w_mvab`) is updated.
    - The `xarray` subroutine is called to accumulate VAT by code/rate in the arrays.

### 3. VAT Calculation by Rate

- After all lines are processed, the program calculates the VAT amounts for each rate:
    - For each VAT code, the VAT amount (`mbe`) is calculated as the difference between gross and net bases times the VAT rate.
    - The total VAT (`w_xmbe`) is summed across all rates.
    - The total order sum including VAT (`p_sumi`) is calculated as the net total plus total VAT.

### 4. Program Termination

- The program sets the LR indicator to signal end-of-job and returns, passing back the calculated total.

## Subroutines

### `xarray` — VAT Array Handling

- This subroutine accumulates VAT bases and rates for up to 9 different VAT codes.
- It matches the current VAT code with an existing slot or uses an empty slot.
- Accumulates net price to the base per VAT code.
- Handles adjustments for gross/net when certain business rules are met (e.g., `forabp > 0` and `vvkord = 0`).

### `*inzsr` — Initialization

- Handles parameter assignment.
- Sets up key lists for the various files.
- Assigns the firm number for use in all key lists.

## Notable Design Choices & Conventions

- **Array-based VAT Handling:** The use of parallel arrays for VAT codes, rates, and bases allows efficient aggregation and later calculation of VAT for multiple rates per order.
- **External VAT Calculation:** VAT calculation logic is delegated to program `RS205R`, indicating a separation of business rules for maintainability.
- **Conditional Aggregation:** Only non-text lines and lines with a VAT code are included in financial calculations, reflecting business rules about which lines affect order totals.
- **Key Lists:** The use of named key lists (`vltyl1_key`, `fodtl1_key`, `vvarl1_key`) centralizes key management for file access.

## Business/Domain Specifics

- **Order Header Update:** The main business goal is to ensure the order header reflects accurate totals, including all VAT considerations, based on the current state of order lines.
- **VAT Handling:** The system supports multiple VAT codes/rates per order, and the calculation must reflect the correct distribution and accumulation.
- **Text Lines:** Order lines marked as text (not products/services) are excluded from financial totals, which is a common practice in order processing systems.

## External Dependencies

- **RS205R:** This program is called for each line requiring VAT calculation. It returns VAT rate, amount, and possibly other tax-related figures. Any changes to VAT business logic are likely centralized here.

## Summary

This program is a core component for financial integrity in the ASOFAK order processing system, ensuring that order headers accurately reflect the sum of their lines, including complex VAT calculations. The design supports multiple VAT rates per order, leverages modular VAT logic, and adheres to business rules regarding which lines contribute to totals. The structure is typical for high-volume order processing systems with multi-rate tax environments.