# Explanation of the RPG Program

## Overview

This RPG program (`FO770R`) is designed for a business system (ASOFAK), specifically for updating the discount category ("rabattkategori") on both customers and orders. The program allows the user to change the discount category for one or multiple customers, and the related orders, from an interactive workstation screen.

**Main Tasks:**
1. Display a screen for input.
2. Validate input data.
3. Update customer records with the new discount category.
4. Update order header records with the new discount category.
5. Loop back for the next input or exit.

## File Declarations

- **fra06pf**: Input file - most likely holds discount categories. Renamed to `ra06pfr` in the program.
- **frkunlu**: Update file - the customer master file. Renamed to `rkunlur`.
- **ffohelu**: Update file - the order header file. Renamed to `fohelur`.
- **ffo770d**: The display file for workstation screen I/O (workstn).

## Data Declarations

- **l_user**: (from UDS, User Data Space), the user ID making the change.
- **l_firm**: Numeric; identifies the company ("firm") in a multi-company system.
- **ra06pf_fkod**: Used for looking up discount categories, matches the discount code field type.
- **b_feil**: 1-byte indicator flag; signals input errors (`*off`/`*on`).
- **w_firm**: Local copy of the firm/company number.

## Main Program Flow

### 1. Display the Opening Screen

- **b1taga tag**: A label used for looping back to the main screen after each operation.
- `EXFMT b1bld`: Displays the input screen to the user and waits for input.

### 2. Function Key Handling

- Checks for function keys (*INKC or *INKL, likely F3=Exit or F12=Cancel).
- If pressed, branches to the `avslutt` (exit) routine.

### 3. Input Validation

- Calls subroutine `sjekk_input`.
- If `b_feil` is `*on` after validation, returns to the input screen.

### 4. Update Customer Register

- Uses a keyed read (`SETLL`/`READE`) on the customer file to select relevant customers.
- For each record:
  - If the customer's current discount code (`rkrabk`) matches the old code (`b1rabg`), it:
    - Updates to the new code (`b1rabn`).
    - Stamps with current date/time and user.
    - Updates the program field.
    - Updates the record.
  - If the discount code doesn't match, releases the record lock (`UNLOCK`).

### 5. Update Order Header

- Similar logic as for customers, but on the order header file:
  - Looks for orders where `forkat` (order discount category) matches the old category.
  - Updates it to the new category, stamps date/time/user, and updates the record.

### 6. Reset and Loop

- Resets the new discount category field to zero and goes back for another update.

### 7. Program Exit

- **avslutt tag**: Sets LR indicator and returns to exit the program.

---

## Subroutines

### sjekk_input

- Validates the input fields from the display.
- If either the old or new discount category is 0, sets a field error indicator and sets `b_feil` to `*on`.
- Looks up the new discount category in the discount master file; if not found, sets error.

### *inzsr

- Initialization subroutine (runs on program start).
- Sets up the key lists for lookup operations (for discount category and by firm number).
- Copies the firm number from the LDA (Local Data Area) to a working variable.

---

## Key Concepts Illustrated

- **File Renaming**: Allows the same external file to have alternate record formats in the program.
- **EXFMT/WORKSTN**: Used for interactive display file (DDS) communication.
- **Keyed Reads**: Efficiently selects and processes only matching records.
- **Record Level Locking/UNLOCK**: To handle concurrent updates safely.
- **Indicators and Subroutines**: Classic RPG methods for error handling and code organization.
- **Audit Fields**: Updates date/time/user/program fields to keep history/tracking of changes.

---

## Pseudocode Summary

```rpg
LOOP:
    Show input screen
    If exit requested:
        End program
    Validate screen input
    If error:
        Return to LOOP

    For each customer with old discount category:
        If matches:
            Update to new category, stamp who/when/program
        Else:
            Unlock record

    For each order header with old discount category:
        If matches:
            Update to new category, stamp who/when
        Else:
            Unlock record

    Clear new discount category input, repeat LOOP
```

## Language Notes

- Norwegian variable/comment terminology is used (e.g., "kunde" = customer, "rabattkategori" = discount category, "ordre" = order).
- Logical file names and record format names are customized to the site's naming standard.

---

## Summary

This program is a batch update utility, designed for data integrity and auditability, to change the discount category in both customer and order records. It is interactive, robustly checks for errors, and logs update details for traceability. It serves as a good example of classic ILE RPG business logic programming for maintenance tasks.