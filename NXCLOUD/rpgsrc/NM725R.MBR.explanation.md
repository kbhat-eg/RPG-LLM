# RPG Program NM725R – Historical Sales Export for Blueridge Datahub

---

## High-Level Overview

- **Purpose**: This program exports historical sales data (last 3 years) from internal systems to a format used by the Blueridge datahub, excluding credit orders and handling internal orders (type 'FI') and warehouse 99 (PK1) specifically.
- **Context**: Used in a Norwegian company, as seen from variable/field names and comments.
- **Main Features**:
  - SQL cursor processing of a sales statistics file for sales within the last 3 years.
  - Excludes specific order/warehouse types.
  - Handles conversion of sale units if necessary.
  - Extracts and normalizes supplier and owner data for each sale.
  - Writes output records to an intermediate file, for use in a subsequent program.

---

## Control Specifications

```rpg
H decedit('0.') datedit(*dmy-) option(*nodebugio)
H DftActgrp(*No) Actgrp(*NEW)
```
- **Decimal & Date edit codes**: Formatting for decimals and dates.
- **Activation Group**: New activation group for program isolation.

---

## File Declarations

Example:
```rpg
fsstal1    if   e           k disk    rename(sstapfr:sstal1r)
```
- Multiple database files are declared for reading via key access—these represent sales, product, warehouse, supplier, etc.

---

## Data Structures

- **Local Data Area (LDA) mapping**:
  - `l_user`, `l_figr`, `l_filg`, etc. used for user context, company/firm info.

- **Key Variables**: Local variables used for constructing keys to database files.

- **Working Variables**: For order/date/counters, key construction, quantities, etc.

---

## Program Flow

### Initialization (`*inzsr`)

- **Reads input parameter**: The member name (`p_memb`).
- **Prepares SQL and working variables**.
- **Calculates the starting date (3 years ago)** using the system clock.
- **Builds file keys** for later access.

---

### Mainline

1. **Member Initialization**:
   - If `p_memb` is blank, allocates a new member number via program `AS100R`.
   - Otherwise, uses the parameter value.

2. **Fetch Historical Sales**:
   - Calls subroutine `salg_ordre`.

3. **Program Exit**:
   - Calls program `AS710R` with date/week information to close underlying programs (cleanup).
   - Sets LR (`*inlr`) and returns.

---

## Main Subroutine: `salg_ordre`

- **Purpose**: Loops through all sales from the last 3 years, processes/selects valid records, and normalizes the data.

#### Main Steps

1. **Initialize counters**.
2. **Open SQL cursor on sales statistics** (`sstapf`):
    - Selects relevant fields for the export.
    - Adds date/warehouse/product filters.
3. **Fetch each sale record**:
    - Skips credit orders (based on order type lookup into `votyl1`).
    - Filters non-inventory items and irrelevant product types.
    - Checks and converts sale units if needed (via `vvenlr`).
    - Determines correct supplier and owner through a hierarchy of files and business rules.
    - Calculates correct sale period (monday of the week) using sub-procedures/program-calls.
    - Prepares the output record with all gathered info.
    - Writes or updates the record in the intermediate output file (`brshiur`).

---

### Key Business Logic Notes

#### *Order Type & Product Filtering*:

- Certain types (e.g. credit 'FI', some product types) are explicitly excluded.
- Only sales, not credit, get exported.

#### *Unit Conversion*:

- If the unit of measure in sale differs from the product's standard, the program retrieves conversion factors and normalizes the quantity.

#### *Date Calculations*:

- Uses external programs (`AX711R`, `AS710R`) to:
    - Determine sales period (week number, period dates) from either the delivery or document date.

#### *Supplier/Owner Resolution*:

- Uses a multi-tiered approach (with detailed business logic) to resolve the supplier/owner from various files.
- Overwrites with warehouse-specific owner if applicable.

---

### Supporting Subroutines

- **`hent_rlev`**: Retrieves supplier name from the supplier file based on resolved supplier number.
- **`hent_jlev`**: Retrieves owner information via NOBB owner number.

---

### Error Handling

- **`*pssr`**: On program error, jumps to cleanup, intended for web-service call failures.

---

## Keylists

- **Keylists (`klist`)** are named sets of key fields used in CHAIN, SETLL, or READE operations for efficient file access.
- There are keylists for each major file used (sales, product, warehouse, supplier, etc.).

---

## Comments and Version History

- The code contains a rich history. Change logs document bug fixes and enhancements, such as new data fields, business logic changes, date handling improvements, unit conversion bug fixes, etc.
- Comments are in Norwegian, reflecting actual business requirements and dialog with domain experts.

---

## Summary Table

| Section        | Purpose/Functionality                                                                                  |
|----------------|-------------------------------------------------------------------------------------------------------|
| Initialization | Prepares variables, reads parameters, allocates new member if needed                                  |
| Sales Export   | Loops over sales data, applies filters, normalizes info, calculates period, resolves supplier/owner   |
| Subroutines    | Fetch supplier/owner info, handle conversions, and error handling                                     |
| Cleanup        | Closes files, programs, and ends program                                                              |

---

## Onboarding Guidance

- **Understand the Files**: Each declared file corresponds to internal business databases for sales, products, warehouses, suppliers, etc. Know the relationships and data flow between them.
- **Keylist Usage**: Many RPG file operations are performed via keylists. Be comfortable with how keys get constructed and used.
- **SQL in RPG**: Note the embedding of SQL for cursor handling in the C-specs, especially for performance and complex selection.
- **Business Logic**: Extensive business rules around which sales/owners/suppliers to include. These are domain driven.
- **External Programs**: Some logic is offloaded to other ILE programs for date calculations and sequence generation.
- **Error Handling**: Rather simple—at PSSR, jumps to cleanup.
- **Norwegian Comments**: Names and comments use Norwegian terminology; understanding these will help navigate the code.

---

## Final Thoughts

This program is a mix of "classic" and slightly modernized RPG (SQL, KLIST, etc.), with business-critical data export requirements. If onboarding, first understand the database relationships, then step through the mainline and `salg_ordre` subroutine, and finally, follow the supplier/owner resolution logic and the external program interfaces.