# RPG Program VL715R - Explanation

## General Overview

This RPG (ILE RPG, fixed format) program is used to fetch information associated with an item in a warehouse. Specifically, it gathers item type, outgoing date, supplier number, and available stock from inventory tables. The available stock is calculated as:  
`available = on-hand - on-order`  
If the warehouse unit differs from sales unit 1, the stock is recalculated.

### Inputs
- Firm (Company)
- Item Number
- Warehouse

### Outputs
- Item type
- Outgoing date
- Supplier number
- Available stock

### File Declarations
The program uses several externally described files (presumably physical files or logical files):
```rpg
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
fvvenl2    if   e           k disk    rename(vvenpfr:vvenl2r)
fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)  (added in 6.36)
```
The `rename` keyword is used to map record formats to internal names.

---

## Data Definitions

### Key and Parameter Variables

- Key fields for accessing database records: `vlagl1_firm`, `vlagl1_vare`, etc., are modeled after actual field types in the files (using `like()` keyword).
- Parameters for the program (`p_firm`, `p_vare`, etc) align with the input/output requirements.
- Working variables for various units and conversion factors accommodate up to 4 different sales units (with corresponding conversion factors).

---

## Program Flow

### Entry Point & Input Parameters

At the program's start (`*inzsr` subroutine), the input parameters are loaded using a parameter list (`plist`) with all input/output parameters.

### Main Logic

#### 1. Initialization
- Output parameters (`p_vtyp`, `p_udat`, `p_ldor`, `p_behl`) are initialized to blanks or neutral values.

#### 2. Main Processing (if `faalag = 1`)
- Chains (fetches) the item data from the `vvarl1` file.
- Calls subroutine `hent_enhe` to fetch and prepare sales unit information for conversion calculations.
- Fetches from the inventory/stock file (`vlagl1`) using supplied keys.
- If found, transfers type, date, and supplier number to output parameters, if they exist.
- Calculates available stock (unless the item type is 'D', 'T', or 'S') as `vlbehl - vloord`.
- If the warehouse unit differs from the sales unit, recalculates available stock using conversion factors for up to 4 sales units.

#### 3. Secondary Field Fetching
- If field(s) (type, outgoing date, supplier) were not found in the stock record, then the corresponding values are retrieved from the item file (`vvarl1`).

#### 4. If Not `faalag = 1`
- Tries to set parameters from the item file (`vvarl1`) directly if not found via warehouse logic.

---

## Subroutines

### `hent_enhe`
This subroutine reads all available sales units for the item (`vvenl2` file) and stores up to four units (and their conversion factors) in `w_enh1`...`w_enh4` and `w_omr1`...`w_omr4`.  
It also fetches the "base" unit (from `vvenl1`) and its conversion factor.

### `*inzsr`
Initialization routine. Loads parameters and sets up keys for record access.

---

## Key Definitions (`klist`)
Defines key lists for the various files being accessed:
- `vlagl1_key`: (firm, item, warehouse) for stock table
- `vvarl1_key`: (firm, item) for item master table
- `fstsl1_key`: (firm) for OFAK table
- `vvenl2_key`/`vvenl2_key2`: (firm, item, sales unit)
- `vvenl1_key`: (firm, item, unit)

---

## Handling Program End

Before returning, the program checks if the `p_inlr` parameter is not “on”. If so, it sets the LR indicator to `*on` (last record) to end the program.

---

## Change Log Comments

Extensive comments document corrections and enhancements by different developers (e.g., fixing calculation of conversion factors, handling additional sales units, skipping on-order for certain item types such as 'D', 'T', or 'S', etc.).

---

## Other Notes

- The program is designed to be robust when values are missing in the warehouse file (fetches them from the item master if needed).
- Handles unit conversion very carefully, accounting for several possible sales units per item with their respective conversion factors.
- Ensures calculation correctness by revising logic over several versions to handle edge cases (e.g., "skaffevare": special-order items don't show available stock).

---

## Key Takeaways for Onboarding

- **File access**: The program is structured around using keyed access to fetch data from normalized files.
- **Unit Conversion**: The design supports up to 4 units per item and takes care to convert stock accurately.
- **Business Rules**: Item types 'D', 'T', and 'S' have special rules for stock calculation.
- **Defensive Logic**: When primary warehouse data is missing, falls back to item master data.
- **Extensible**: Logic is isolated and easy to follow; you can add more sales units or conversion logic with minimal changes.
- **Initialization and Cleanup**: Parameters and indicator handling comply with RPG best practices, ensuring clean program lifecycle.

---

## Block Structure

Visually, the main points are:

```rpg
* Input: firm, item, warehouse
* Output: type, outgoing date, supplier, available stock

* Main
  * Initialize outputs
  * If warehouse logic used
      * Get item master data
      * Get sales units (hent_enhe)
      * Fetch warehouse record
      * If found
          * Transfer fields to output
          * Calculate available stock (with/without conversion)
      * If any field missing, get from item master
  * Else (no warehouse logic)
      * Get fields directly from item master

  * End program (set LR if needed)
```

---

## For New Developers

You should become familiar with the files `vlagpfr`, `vvarpfr`, `vvenpfr`, and how unit conversion factors work per item. Also, work through the handling of item types and business rules for special items. This program is a model example of how to make attribute lookups and calculations based on multiple master files in an RPG environment.