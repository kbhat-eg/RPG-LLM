# RPG Program VV106R – Explanation

This program is written for IBM i (AS400) in ILE RPG and is used for **maintaining and adjusting article/item (vare) prices based on “basisenhet” (base unit)**. The code is well-documented and includes support for new features through various versions/patches. The comments are in Norwegian, which I’ll translate/expound as needed.

---

## Program Overview

- **Purpose:**  
  Adjusts article prices, supporting functions for price group, price provider, and enhanced GUI triggers. It interacts with physical files (`VVARL1`, `VVPRL1`) and display file (`VV106D`).

---

## Key Sections

### 1. Header & File Declarations

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Sets the compile-time options: disables debug I/O and sets date editing to day/month/year.

#### Files

```rpg
fVVARL1    if   e           k disk    rename(VVARPFR:VVARL1R)
fVVPRL1    if   e           k disk    rename(VVPRPFR:VVPRL1R)
fVV106D    cf   e             workstn
```
- **VVARL1**, **VVPRL1**: Indexed disk files, renamed record formats.
- **VV106D**: Display device file (workstation).

---

### 2. Data Definitions

#### Parameters

```rpg
d p_firm          s                   like(vpfirm)
d p_vare          s                   like(vpvare)
d p_prgr          s                   like(vpprgr)
d p_enhe          s                   like(vpenhe)
```
- **p_***: parameters received from calling program (firm, item, price group, unit).

#### Working Variables

```rpg
d b_feil          s              1    inz(*off)
d b_inlr          s              1    inz(*off)
d b_ldor          s              1    inz(*off)
```
- Flags to indicate error (`b_feil`), end-of-program (`b_inlr`), supplier check (`b_ldor`).

```rpg
d w_udat          s               d   datfmt(*iso)
d w_spro          s              7  4
d w_kpro          s              7  4
d w_ipro          s              7  4
d w_bpro          s              7  4
d w_dekn          s              5  2
```
- Date and price difference percentages (`w_*`).

```rpg
d w_firm          s                   like(vpfirm)
d w_lety          s                   like(vplety)
d w_vare          s                   like(vvvare)
```
- Work copies of firm, type, and item.

---

### 3. Main Logic

#### Program Initialization

```rpg
c                   eval      w_lety = 0
c                   eval      b_inlr = *off
c                   time                    w_udat
c                   eval      b1ldor = vvldor
```
- Initializes key variables and gets current time.

#### Initial Call to VP701R

```rpg
c                   call      'VP701R'
c                   parm                    p_firm
c                   parm                    p_vare
c                   parm                    p_prgr
c                   parm                    p_enhe
c                   parm                    w_lety
c                   parm                    w_udat
c                   parm                    b_inlr
c                   parm                    b1sagm
c                   parm                    b1bugm
c                   parm                    b1kogm
c                   parm                    b1ingm
```
- Calls another program to fetch/display current item data and prices.

#### Data Preparation

```rpg
c                   eval      b1enhe = p_enhe
c                   eval      b1sapr = b1sagm
c                   eval      b1kopr = b1kogm
c                   eval      b1inpr = b1ingm
c                   eval      b1bupr = b1bugm
```
- Sets up fields for editing on the screen.

#### Main Loop

```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- Tag for looping, then displays input form to the user.

#### Function Key Handling

```rpg
c                   if        *inkc or *inkl
c                   goto      avslutt
c                   endif
```
- Exits if the user presses cancel/exit keys.

#### Input Validation

```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   goto      b1taga
c                   endif
```
- Calls subroutine to validate the entered data. Returns to form if errors are found.

#### Price Percentage Calculation

```rpg
c                   eval(h)   w_spro = (b1sapr - b1sagm) * 100 / b1sagm
...
```
- Calculates the percentage change for various prices (sales, cost, purchase, shop).

#### Price Adjustment Call

```rpg
c                   call      'VP800R'
c                   parm                    p_firm
c                   parm                    p_vare
c                   parm                    w_udat
c                   parm                    w_spro
c                   parm                    w_kpro
c                   parm                    w_ipro
c                   parm                    w_bpro
c                   parm                    w_dekn
c                   parm                    b_inlr
```
- Calls another program to update/apply the new prices.

#### Program End

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Terminates the program, setting LR indicator.

---

### 4. Subroutine: Input Check (`sjekk_input`)

Checks several conditions:

- **Supplier exists:** Loops through `VVPRL1` to confirm supplier is valid for this item.
- **At least one price must be changed:** If all prices are unchanged, flags error.
- **Sales price validations:** Price cannot be zero.
- **Cost, Purchase, Shop price consistency:** If one is zero, the other must also be zero.

Sets error flags (`*in31`, `*in32`, etc.) for the display record.

---

### 5. Subroutine: Program Initialization (`*inzsr`)

- Sets up key lists for file access.
- Initializes local variables from input parameters.
- Sets up key fields for reading from `VVARL1` and `VVPRL1`.

---

## Summary

**High-level Flow:**
1. Receives parameters (firm, item, price group, base unit).
2. Looks up current item and prices.
3. Displays screen for user to adjust prices.
4. Validates the input:
    - Supplier must exist.
    - At least one price must be modified.
    - Consistency checks between old and new prices.
5. Calculates percentage change for each price.
6. Calls an external program to update prices.
7. Allows user to exit or continue adjusting.

**Typical Usage:**  
Used by pricing administrators to update item prices (sales, cost, purchase, shop price) by percentage after input validation, based on the base unit.

---

## Key Concepts for Onboarding

- **Physical Files:** Data is read/written using indexed disk files.
- **Parameter Passing:** Program integrates with other RPG/CL programs using parameter lists.
- **Display Files:** User interaction is through workstation file with screen formats.
- **Validation Logic:** Robust validation to ensure business rules are met before allowing updates.
- **Subroutines:** Used for input checking and initialization, improving modularity.
- **Change Management:** History of versions is maintained in comments.

---

## Important Variables/Coding Patterns

- `*INLR`: Last record indicator, typical for RPG program exit.
- `exfmt`: Outputs screen and receives input.
- `goto`, `tag`: Control structure for flow (old-style, but still common in RPG).
- `eval(h)`: High-precision arithmetic calculations.
- Error indicators (`*in31`, etc.) likely drive input field error highlighting on the display.

---

**In summary:**  
This program is a transactional tool for secure, validated price maintenance for items, heavily relying on database lookups and user input validation, with modular integration to other business logic programs. The code is an example of stable, production-grade RPG application logic, designed for data integrity and user guidance.