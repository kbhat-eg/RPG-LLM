# Overview

This ILE RPG program (JR131R) is a **workstation program** for IBM i (AS/400), managing "mottaksfilter" (possibly receiving filter or group filter) maintenance using a **subfile (SFL)** interface. The application focuses on CRUD (Create, Read, Update, Delete) operations on subfile records, with a clear Norwegian naming convention.

It is structured in classic RPG/400 style, not RPG IV/free, and uses indicator-based display and file handling. It interacts with several physical/logical files and multiple display file formats (subfile record, control, popup windows, etc.).

---

## Key Sections and Structure

### 1. **Header and Documentation**

- The program header includes metadata (system, program, description, reference, author, change log).
- Norwegian documentation explains indicator usage, fields for subfiles, and screen formats.

### 2. **File Declarations**

- Logical/physical files (F-specs):
    - `jrfilr`, `jrfilu`, `jrfil1` (main filter files, different purposes)
    - `jrapl1` (reporter or application lookup)

- Display file:
    - `jr131d` (with subfile `b1sfl`)
    - Infds(dspfbk): feedback data structure for display attributes

### 3. **Data Declarations (D-specs)**

- **Parameters:** Company (`p_firm`), report (`p_rapp`), passed on entry.
- **Local Data Area:** Access to user and navigation values.
- **Feedback Data Structure:** For cursor position and display interaction.
- **Key Variables:** Used to chain into records by key.
- **Work Variables:** For subfile handling (record numbers, page sizes, etc).
- **Flags:** For logic control (e.g., create, update, delete flags).
- **Constants:** Like subfile size (`c_sfil` = 12).

### 4. **Comments and Subfile Field Explanations**

- Detailed comments outlining what each work variable means, aligned to subfile logic.
- Outlines all display screen formats used (main subfile, control, command screens, popups for add, edit, delete, copy, etc.).

---

## Main Logic Flow

### **Program Entry and Initialization (`*inzsr`)**

- Receives parameters (company code, report code).
- Initializes keys for file access.
- Sets up the subfile and loads initial data (using `crt_subfile`).
- Fetches application/report name for display.

### **Main Processing Loop**

- Uses TAGs and GOTO to manage flow between user input, subfile display, and command handling.
- Main loop starts at `b2taga`/`b2tagb`.

#### **Function Key Handling**

- SELECT/ENDSL block decodes user function keys:
    - Rollup/Rolldown (Page up/down)
    - Inquiry, refresh (`forny`), add (`xc1bld`), edit, delete, copy (supporting subfile paging and CRUD).
- GOTO statements control "screen flow" in classic RPG style.

#### **Subfile Paging & Positioning**

- Handles page up/page down via `crt_subfile`/`bck_subfile`.
- Repositions subfiles based on key values entered by user.

### **Subfile Management**

#### **Display Subfile**

- `dsp_subfile`: Displays current subfile page.

#### **Creating a New Row**

- `xc1bld`: Handles popup for adding a new key. If the key exists, shows an error (`xc1msg`); otherwise, passes to edit screen (`xc2bld`) for actual data input.

#### **Edit/View/Copy/Delete Routines**

- `xc2bld`: Handles edit/create/view on the detail screen.
- If the record exists, loads it for update; otherwise, uses blank/new values for creation.
- `xd1win`: Handles delete confirmation and processing.
- `xk1win`: Handles copying a row, with checks for key existence and duplication.

#### **Subfile Refresh**

- `forny`: Refreshes the subfile from the database after maintenance.

#### **Subfile Clear/Load**

- `clr_subfile`: Clears subfile and work variables.
- `crt_subfile`: Populates subfile with records, honors filters & subfile page size.

#### **Paging Backwards**

- `bck_subfile`: Reads records backwards for page up, manages positioning and refilling of subfile.

### **Display Feedback Handling**

- Uses indicators for display file feedback (e.g., which function keys invoked, what task user requests).

---

## Notable Concepts

### **Indicators (INxx)**

- Extensively used for control flow and display logic:
    - Function keys (F3=Exit, F5=Refresh, etc.)
    - Subfile control (clear, end, display, error, etc.)

### **Subfile Variables**

- `w_fcrn`, `w_srrn`, `w_ssrn`, etc.: Manage subfile's current, first, last record numbers for paging/display.

### **Chaining and Keylists**

- Uses `CHAIN`, `SETLL`, `SETGT`, `READ`, `READP`, `UPDATE`, `WRITE`, `DELETE` operations driven by key lists.
- Key lists keep code DRY for record access.

---

## User Interaction

- Users interact via a subfile (a scrollable list), can page up/down, select records to maintain, add, copy, delete, or inquire.
- Popups/windows are used for entry and confirmation.
- Indicators drive both program logic and visual feedback.

---

## Summary Table

| Section        | Purpose                                              |
|----------------|------------------------------------------------------|
| F-specs        | Database and display file definitions                |
| D-specs        | Variable, structure, constant, parameter definitions |
| Main loop      | User interaction, input handling, subfile navigation |
| Subroutines    | Modular, named, for CRUD, subfile, popup handling    |
| Indicators     | Extensive use for program/company standards          |
| Comments       | In-depth explanations (in Norwegian)                 |

---

## Getting Onboard

- **Understand subfile handling:** The program primarily manages lists/subfiles; know how subfiles and indicators work in RPG.
- **Learn the file structures:** Know what each file (`jrfilr`, `jrfilu`, etc.) represents.
- **Follow indicator conventions:** Used for both user keys and internal logic.
- **Trace main loop and subroutines:** Most logic is in named subroutines, called by user action or subfile iteration.
- **Screen navigation:** Use of GOTO and TAG is common here, emulating event loops.

---

## Further Reading

- [IBM Knowledge Center: Subfiles in RPG](https://www.ibm.com/support/knowledgecenter/ssw_ibm_i_74/rpg/idrpgsubfile.htm)
- [IBM RPG Indicator Reference](https://www.ibm.com/docs/en/i/7.5?topic=reference-indicators-in-rpg)

---

This program is a strong example of **classic RPG subfile maintenance** applications, coded for high-interactivity, using indicators and subroutines for tight control of maintenance workflows.