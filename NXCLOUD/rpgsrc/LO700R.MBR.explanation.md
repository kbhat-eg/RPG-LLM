# Explanation of RPG Source Code: Program LO700R

This RPG (Report Program Generator) program is typical of applications running on IBM i (AS/400) systems, written in the fixed-format ILE RPG style. The program's purpose is to **read order line records, perform recalculations of amounts, discounts, and totals, and update the order header with new totals**. Comments in Norwegian indicate it's used in a Scandinavian environment.

---

## 1. **Header Specifications (`H-Spec`)**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: Disables debug for I/O operations for performance.
- `datedit(*dmy)`: Sets default date editing to day/month/year format.

---

## 2. **File Declarations (`F-Spec`)**

The program works with several files tied to orders and types:
```rpg
fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
flohelu    uf   e           k disk    rename(lohepfr:lohelur)
flohel1    if   e           k disk    rename(lohepfr:lohel1r)
flodtl1    if   e           k disk    rename(lodtpfr:lodtl1r)
```
- `vltyl1`: Line type master.
- `lohelu`, `lohel1`: Order header (update and inquiry variants).
- `lodtl1`: Order lines.

`if` = input file, `uf` = update file, `e` = externally described, `k` = keyed, `disk` = disk file.

---

## 3. **Data Definitions (`D-Spec`)**

### **Parameters**
```rpg
d p_firm          s                   like(lofirm)
d p_numm          s                   like(lonumm)
d p_suff          s                   like(losuff)
```
- These are program entry parameters (probably company, order number, and order suffix).

### **Key Variables**
Variables used to build keys for file access (based on the fields in the files).

### **Work Variables**
- Includes dates, amounts, and rates (e.g., `w_sumi`, `w_sumr`, etc.).
- Used for per-line and accumulated calculations.

---

## 4. **Main Logic**

### **Initialization**

At program start, the `*inzsr` subroutine is called to:
- Receive parameters.
- Build keys for file access.
- Initialize work variables.

---

### **Processing Loop**

#### **1. Read Order Header**
```rpg
c     lohel1_key    chain     lohel1r
```
- Retrieves header information for the order.

#### **2. Read All Order Lines**
```rpg
c     lodtl1_key    setll     lodtl1r
c     lodtl1_key    reade     lodtl1r
c                   dow       not %eof
    ...
c     neste_linje   tag
c     lodtl1_key    reade     lodtl1r
c                   enddo
```
- Uses `setll` (Set Lower Limit) and `reade` (read equal key) to loop through all lines for this order.

#### **3. For Each Line:**

##### **a. Check Line Type**
```rpg
c                   eval      vltyl1_ltyp = ldltyp
c     vltyl1_key    chain     vltyl1r
c                   if        valktx = 1
c                   goto      neste_linje
c                   endif
```
- Reads the line type and skips lines marked as text (using `valktx`).

##### **b. Get Price, Discount Data**
```rpg
c                   eval      w_ipny = ldipny
c                   eval      w_kpny = ldkpny
c                   eval      w_rab1 = ldrab1
c                   eval      w_rab2 = ldrab2
```
- Pulls purchase price, cost price, and two discount rates from the line.

##### **c. Calculate Totals for This Line**
- **Quantity Calculation:**
  ```rpg
  c                   eval      w_anta = ldanta
  c                   if        valkre = '-'
  c                   eval      w_anta = w_anta * -1
  c                   endif
  ```
  If the line's credit indicator is '-', negate the quantity.

- **Purchase Amount:**
  ```rpg
  c                   eval      w_sumi = w_ipny * w_anta
  c                   eval      w_lisu = w_sumi
  ```

- **Discount Calculations (three levels):**
  1. Use line's own percentage (`lorabp`).
  2. Apply two further discount percentages (`w_rab1`, `w_rab2`).
  3. Each time, subtract from the amount.

- **Cost Calculation:**
  ```rpg
  c                   eval      w_sumk = w_kpny * w_anta
  ```

- **Accumulate Totals:**
  ```rpg
  c                   eval      w_toti = w_toti + w_sumi
  c                   eval      w_totr = w_totr + w_sumr
  c                   eval      w_totk = w_totk + w_sumk
  ```
  These are used to update the order header later.

---

### **Update Order Header (Subroutine `OPPDAT`)**

After all lines are processed:
```rpg
c                   exsr      oppdat
```
Inside `OPPDAT`:
- Retrieves the order header (`chain lohelur`).
- If found, updates total fields (`lototi`, `lototr`, `lototk`) with accumulated values from all lines.
- Performs the update.

---

## 5. **Program Termination**

```rpg
c                   eval      *inlr = *on
c                   return
```
- Closes files and ends the program.

---

## 6. **Parameter and Keylist Handling**

### **Entry Parameters**
```rpg
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_numm
c                   parm                    p_suff
```
- The program expects parameters for company, order number, and suffix.

### **Keylists**
- RPG "klist"/"kfld" defines keys for file access (for re-use throughout the program).

---

# **Summary Flow**

1. **Receive input parameters** (company, order number, suffix).
2. **Access order header**.
3. **Iterate over each order line:**
   - Skip text lines.
   - Calculate amounts with discounts and costs.
   - Aggregate totals.
4. **Update the order header** with recalculated totals.
5. **End program**.

---

# **Typical Usage**

- This type of program would run after order maintenance or import, ensuring that header totals in an order table are always correct following line-level changes.
- It provides a batch recalculation often needed after bulk data changes or interface imports.

---

# **Key RPG Concepts Used**

- **CHAIN/READE/SETLL**: For keyed file access.
- **KLIST/KFLD**: For defining composite keys.
- **EXSR/BEGSR/ENDSR**: Subroutine invocation and blocks.
- **Parameters and Keylists**: Modularizes and generalizes file access logic.
- **Work & Accumulation Variables**: Classic business logic style for RPG.

---

# **Onboarding Tips**

- **Understand Files**: Know the structure of order header, order lines, and line type master.
- **Know RPG Conventions**: Fixed-format can look odd, but each column has a meaning; see IBM documentation.
- **Debugging**: With `*nodebugio` set, be aware that debugging record access is limited; use display or logging as needed.
- **Business Logic**: Logic is straightforward, but business rules (like skipping text lines) are in the file master data.

---

**This program is a clear example of transactional processing and master/detail recalculation in classic RPG. Once comfortable with keylists and file operations, it is straightforward to maintain.**