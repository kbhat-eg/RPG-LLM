# RPG Program VG512R – Undergruppe Inquiry

This program implements a subfile-based inquiry/display for "undergruppe" (subgroup) records, using a classic ILE RPG/400-style C-spec codebase. Its main function is to let users browse and select subgroups via a paged subfile user interface. Below, the key structures and logic flows are explained for onboarding developers.

---

## **Header, Indicators, and Files**

- The `h` spec defines program attributes, including disabling debug IO and setting date edit format.
- The initial comments explain the program’s purpose, change history, and indicator usage:
  - **LR**: End program
  - **10/11**: Page up/down (Roll/Rolldown)
  - **12–15, 21, 22, 30, 31–99**: Used for subfile and screen field control.

### **File Declarations**

- Four logical files over the same physical (`vugrpfr`), each renamed for a particular view (vugrl1r, vugrl3r, etc.).
- `vg512d` is the display file, with subfiles, using program-to-system fields for feedback and subfile record number (`w_srrn`).

---

## **Data Structures and Variables**

### **Parameters**

- Variables such as `p_firm`, `p_ogrp`, etc., are parameter fields (like company, overgroup, main group, undergroup, and description).
- These are used for program entry and selection return.

### **Display Feedback Structure**

- `dspfbk` is an information data structure to capture display feedback (e.g., cursor position).

### **Key Fields and Working Variables**

- Variables for keys in file searches (`vugrl1_uogr`, etc.).
- Working fields for subfile control (first/last record numbers, page size, current record, etc.)
- Sequence field (`w_seqe`) tracks the current search context (by main group, undergroup, text, etc.).
- Boolean `b_valg_ok` indicates if a selection is made.

### **Constants**

- `c_sfil` holds the subfile page size (here: 8 records per page).

---

## **Special Field and Screen Layout Documentation**

- Extensive comments explain the meaning of every working and screen field used for subfiles and screen navigation.

---

## **Mainline Processing (Primary Logic Flow)**

The program consists of a tag-based main control loop, alternating between display, input, and subfile management:

1. **Program Initialization** (in `*inzsr` subroutine):
    - Receives parameters (via PLIST).
    - Sets up key lists for positioning records in the various logical files.
    - Positions the database at the required starting point and creates/fills the subfile.

2. **Main Loop** (beginning at label `b2taga`):
    - Writes the command key prompt screen.
    - Calls subroutine `dsp_subfile` to display or refresh the subfile window, then handles user function keys.

3. **Function Key Handling** (`select` block after `dsp_subfile`):
    - End (F3/F12): Exit program.
    - Refresh (F5): Calls `forny` to clear and recreate the subfile.
    - Roll Up (F10): Calls `crt_subfile` to page forward.
    - Roll Down (F11): Calls `bck_subfile` to page backward.
    - Home (F21): Sets the cursor at a specific place and redraws.

4. **Positioning Logic**:
    - If the user enters search criteria, calls `posisjoner` subroutine to position and reload the subfile accordingly.

5. **Subfile Handling**:
    - After subfile processing, if selection is made (`b_valg_ok`), the program exits and returns the selected values.
    - Otherwise, loop continues to display and allow further user interaction.

6. **Program Exit** (`avslutt`):
    - Sets LR indicator to end program.

---

## **Key Subroutines**

### **`forny`** — Refresh Subfile

- Positions based on the last viewed record and sequence context.
- Clears and refills the subfile to reflect current data.

### **`posisjoner`** — Position Subfile

- Uses whichever user search criteria are present (overgroup, main group, undergroup, description) to set sequence and position files accordingly.
- Calls routines to clear and refill subfile.
- Resets positioning input fields.

### **`subfile`** — Subfile Interaction

- Toggles indicator for cursor management.
- Loops through subfile records, reading changed records (potentially after user selection).
- If a selection (`b1valg = 1`) is found, saves selected data into parameters and sets the selection flag.

### **`clr_subfile`** — Clear Subfile

- Activates indicators to clear the subfile control record and resets subfile management fields.

### **`crt_subfile`** — Create/Fill Subfile

- Increases page size, initializes current record.
- Reads records from the relevant file (depending on sequence/search context), writes them to the subfile, and manages subfile record numbers.
- Marks the end of file/page as needed.

### **`bck_subfile`** — Page Back in Subfile

- Sets file position for backward paging using `setgt`/`readp` (read previous) on the correct logical file.
- Reads back a full page, then refills the subfile for display.

### **`dsp_subfile`** — Display Subfile

- Manages display indicators for control/command screens.
- Shows the current subfile page to the user and updates working fields with cursor position.

### **`*inzsr`** — Initialization

- Receives entry parameters.
- Sets up key lists for positioning.
- Initializes the program state and subfile based on incoming parameters.

---

## **Key Concepts**

- **Subfile Handling:** Uses RPG subfile concept for paged display, allowing viewing, paging, refreshing, and selection.
- **Multiple Logical Files:** Each "logical view" supports different positioning/searching (by overgroup, main group, undergroup, description).
- **Indicator-Driven UI:** UI state (input enable/disable, subfile control) is managed via indicator variables.
- **Positioning/Subfile Control:** Carefully tracks current position in the list, manages page size, handles both forward and backward paging, and re-positions when search criteria are entered.

---

## **Typical User Flow**

1. Program is called with optional search/positioning parameters.
2. Subfile is built and displayed; user can page forward/back, position (search), or select.
3. If user selects a record, relevant fields are returned and program exits.
4. Otherwise, user can re-enter search criteria to reposition or exit.

---

## **Summary of Key Fields and Indicators**

- **Working Variables:** `w_fcrn`, `w_srrn`, `w_spge`, `w_ssrn`, etc. — Manage subfile record positions and paging.
- **Subfile Fields:** `b1sfl` (subfile record), `b2ctl` (subfile control/heading).
- **Parameter Passing:** All major keys and result fields are passed in/out via parameters for integration into larger applications.
- **Indicators (INXX):**
    - `*IN12, *IN13`: Subfile display management.
    - `*IN14`: Clear subfile.
    - `*IN15`: End of subfile/page.
    - `*IN22`: Cursor placement.

---

## **File Key Lists – Used for Positioning**

- `vugrl1_key`: Firm, Overgroup, Main group, Undergroup.
- `vugrl3_key`: Firm, Main group.
- `vugrl4_key`: Firm, Undergroup.
- `vugrl2_key`: Firm, Description text.

---

## **Extensibility and Maintenance Notes**

- The program is modular, with clear subroutines for each major function.
- For GUI enhancements: Ensure that indicator and subfile logic remains compatible with DDS or newer UI technologies.
- It's highly recommended to carefully manage and initialize all working fields, as classic RPG programs can result in subtle bugs if indicators or working fields are left in the wrong state.
- The abundant comments provide valuable context (especially for Norwegian-speaking teams) about each field and logic branch.

---

**In summary:**  
This program provides a robust, subfile-based interactive selection and inquiry screen for undergroup records, with support for advanced positioning, paging, and selection. It's organized well for its era, using file positioning, indicators, and subroutines for maintainability and clarity.