# Explanation of ILE RPG Source Code: RL629R

## Overview

This RPG program is designed for the IBM i platform and prints a supplier (leverandør) register with optional notes (notatblokk). The program reads supplier data, applies several selection filters, summarizes results, checks for supplier notes, and outputs formatted reports to a printer file.

---

## Structure and Main Elements

### 1. **Header and Documentation**

- The header block documents the system, program, description, change history, and indicator usage.
- Indicators (*INxx) manage function keys, file status, error reporting, and internal program logic.

### 2. **File Declarations (`F-Specs`)**

```rpg
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
frlevl2    if   e           k disk    rename(rlevpfr:rlevl2r)
E5.40frklal2    if   e           k disk    rename(rklapfr:rklal2r)
frl629p    o    e             printer oflind(*in30)
```
- `frlevl1` and `frlevl2`: Supplier master files, keyed, used for alternate sort orders (numeric/alphabetic).
- `frklal2`: Notes block file that contains notes for suppliers.
- `frl629p`: Printer file with overflow indicator *IN30 (for page heading control).

---

### 3. **Data Structures and Fields (`D-Specs`)**

#### a. **Arrays and Work Fields**
- `f`: Work array (DIM(30)), used for temporary field transfers (e.g., movea).
- Various single-value fields for calculations and statistics (e.g., totals, counts).

#### b. **Date Structures**
- `w_tdat`, `w_taar`, `w_tmnd`, `w_tdag`: Date and component fields for formatting/processing.

#### c. **Selection Parameters**
- Data structure (`uds`) for all report selection criteria:
  - Date, year, period, department, category, seller, district, warehouse, flags for test/report options.

#### d. **Other Structures**
- Variables for user info, firm numbers, and holding extracted values.

---

### 4. **Main Logic (C-Specs)**

#### **Program Initialization**
- Subroutine `*inzsr` initializes parameters, sets up file position based on sort order, and writes report headings.

#### **Main Reading Loop ("lesk" TAG)**
1. **Record Selection:**
   - Reads supplier records from either numeric (`rlevl1`) or alphabetic (`rlevl2`) sorted file, based on sort parameter (`psort`).
   - Stops loop if supplier firm exceeds the selected firm.

2. **Filtering Logic:**
   - Supplier number (`rllevr`)
   - Department (`rlavde`)
   - Category (`rlkatg`)
   - Seller (`rkslgr`) [commented out, not active]
   - District (`rldist`)
   - Last transaction date (`rltdat`)
   - If any filter fails, `goto alle` skips to summary for "all suppliers" (not selected for note block print).

3. **Selected Supplier:**
   - Increments counters for statistics (e.g., number of suppliers, debtors, creditors, purchases, totals).
   - Prepares work fields and key values for notes lookup.

4. **Note Block Check:**
   - Using key fields, performs `setll` and `reade` on the notes file (`rklal2`).
   - If "only print suppliers with notes" is selected, it checks for notes and calls the print subroutine if found.
   - Otherwise, prints supplier info based on global selection.

5. **Note Printing:**
   - For each note found, writes to output.

6. **"Alle" TAG (All Suppliers)**
   - Updates statistics for all suppliers (regardless of note presence).
   - Loops back to `lesk` to process next record.

#### **End of Program:**
- At `slutt` tag, sets last record indicator (`*inlr`), prints totals, and ends execution.

---

### 5. **Subroutines**

#### a. **Printing Subroutine (`skrive`)**
- Handles page overflow (checks *IN30, writes headings as needed).
- Writes main supplier information (`levr1`).
- Conditional writing for secondary address line (commented out).

#### b. **Initialization Subroutine (`*inzsr`)**
- Processes selection parameters.
- Sets file positions and writes various header lines, depending on which filters are active.
- Prepares key lists for file access.

---

### 6. **Key Lists**

#### a. **key01:** Firm + supplier number (for numeric access)
#### b. **key02:** Firm + alpha field + supplier number (for alpha access)
#### c. **keynot:** Composite key for notes file (firm, system, project, activity, account, etc.)

---

## **Summary of Main Flow**

1. **Program starts and initializes parameters, headings, and file positions.**
2. **Main loop reads supplier master records:**
   - Applies selection filters.
   - If supplier passes filters, updates statistics and looks for notes.
   - If notes exist (and based on selection), calls subroutine to print supplier info and notes.
   - Always accumulates totals for "all suppliers."
3. **At end, prints summary totals and closes report.**

---

## **Important Details**

- **Indicators:** Control everything from overflow handling, screen protections, error conditions, and file read status.
- **Selection Criteria:** Applied strictly in the order shown; only suppliers matching all criteria are printed with notes block.
- **Flexibility:** Program structure allows switching between numeric and alpha sorting, filtering on numerous fields (department, category, district, date), and optionally restricting to only those with notes.
- **Printer Output:** Uses subroutines and overflow logic to format output properly for each page.

---

## **Comment Highlights & Norwegian Terms**

- Many comments and field names are in Norwegian.
- **Leverandør:** Supplier
- **Notatblokk:** Notes block
- **Utskrift:** Print/output
- **Avdeling:** Department
- **Kategori:** Category
- **Selger:** Seller
- **Distrikt:** District
- **Saldo:** Balance

---

## **Onboarding Tips**

- **File Definitions:** Understand the layouts for RLEV* (suppliers) and RKLAL2 (notes).
- **Selection Parameters:** Know which program variables are set via user input/parameters, and how these impact filtering.
- **Indicator Map:** Refer to the documented indicator map for logic tracing and debugging.
- **Testing:** Use test data with and without notes, and toggle "print only with notes" to see both flows.

---

**In summary:**  
This program is a structured legacy RPG solution for generating filtered, summary supplier lists (with notes), providing flexible selection and clear report output for accounting/auditing purposes. Fields and logic are tailored to common supplier management needs, and the code is well documented for navigation and maintenance.