# Explanation / Onboarding Guide for RPG Program FO614R

---

## 1. **Overview**

This RPG program, `FO614R`, is a highly configurable and central utility for **order selection, processing, backordering ("resting"), and output management** in a Norwegian ERP system. It is built in IBM i ILE RPG and has been maintained for decades with many enhancements reflecting changes in business requirements.

### Main Functional Areas

- **Order picking for print/output**
- **Backorder processing (resting of orders and lines)**
- **Order sorting and grouping for billing**
- **Output queue/mail selection control**
- **Integration with inventory and logistics**
- **Logging and historical updates**
- **Highly parameter-driven and extensible (via data and routine registers)**

---

## 2. **Key Concepts**

- **Order**: Central entity. Each order can have multiple lines and can be split (rested) into new orders.
- **Suffix (`suff`)**: Used to distinguish between main and backordered parts of the same order number.
- **Order Type (`oty`)**: Drives how orders are processed and output.
- **Parameter Files (PLUKK)**: Input that controls selection of orders/lines to process.
- **Resting**: Not all ordered items are available; backorder lines/headers are created.
- **Sorting Keys**: Determine how orders are grouped for processes like invoicing.
- **Local Data Area (`LDA`)**: Used to pass context between calls.

---

## 3. **Main Data Structures and Files**

### a. **Physical and Logical Files**
- Many files (`ffpm2lu`, `frkunl1`, ...) represent order headers, lines, item files, customer registers, types, picking files, stock history, etc.
- Files are read/written using key-lists defined at the end of the code.

### b. **Data Structures**
- `hlrec`, `sorter`, `d_urec`: Used for inventory, sorting/grouping, and logging.
- Overlays allow easy mapping of "record buffer" to meaningful fields.

### c. **LDA Fields**
- Used for passing parameters, routine names, user identity, dates, etc.

---

## 4. **Top-Level Program Flow**

### a. **Program Initialization**
- *INZSR subroutine initializes the environment* (local data, resets fields, loads user/firma settings, checks for specific module activations).

### b. **Picking Parameter Processing Loop**
- Orders to process are selected based on `PLUKK` parameter files.
- Each candidate order is checked (company, type, user, workstation) to ensure it matches the intended selection.

### c. **Order Preparation**
- All relevant keys, variables, and structures are set up for main order, lines, suffix, company, and process type.

### d. **Routine/Output Control**
- The output routine name is dynamically built, taking into account:
  - Order type,
  - Desired output (print/email/etc.),
  - Alternative processing (e.g., specific routines for offers).
- If needed, output queue overrides are respected and signaled.

### e. **Print/Output Program Call**
- LDA is updated and a print/output program (e.g. `AP600R`) is called with the calculated routine.

### f. **Order Header and Line Processing**
- The main order is retrieved; relevant status, type, and inventory info is cached.
- Special logic for resting (backordering): if necessary, new suffix is allocated, backorder header and lines are generated.

### g. **Resting (Backordering)**
- The core of backorder processing:
  - Orders are "rested" if some lines cannot be fulfilled.
  - A new suffix is created for the rest (backordered) items.
  - Remaining fulfilled lines are processed for output.
  - Old order is changed, deleted, or adjusted as needed.

### h. **Inventory, Logging, and Integration**
- Each line processed is checked for inventory updates and historical/log updates.
- If line affects inventory, an external program is called to update stock records.
- Logging of changes, especially status transitions and deletions, is performed via subroutines and external calls.
- Integration points (e.g., transport, ByggDok, Cobuilder) are conditionally called.

### i. **Sorting and Grouping for Invoicing**
- Orders/lines are grouped for output/invoicing based on sorting concepts defined in customizable data structures (`sorter`).
- Grouping may depend on project, customer, date, payment terms, etc.

### j. **Text Line Handling**
- Text before and after items (header/footer) is handled separately and also written to the picking/output file.

### k. **Housekeeping**
- After processing, parameter records are deleted, and temporary picking records are removed (plukk-reg).
- Logging and final cost-pricing programs are invoked if required.

---

## 5. **Key Subroutines (SR)**

- **hntsuf / hntnum**: Determine next available suffix / number for new/backorder.
- **olrest**: Executes the resting (backordering) process for order lines.
- **laglag / opplag**: Perform inventory updates for given lines.
- **ohead / linje / foran / etter**: Write picking header and line/text data to picking/output file.
- **slett_plukk**: Clears temporary plukk-registers as cleanup.
- **upd_logg**: Calls external log program for state/logging changes.
- **sjekk_lkode**: Checks if kjørekontor (run office) is selected (log code 0).

---

## 6. **Key Decision Points and Business Rules**

- **Output Routine Selection**: The actual output program and its routine is not hardcoded, but derived from order and parameter data, making the program highly flexible for new requirements/routines.
- **Backorder (Resting) Logic**: Only lines not fulfilled are rested; rest lines get new suffix; original header is deleted if no lines remain.
- **Order Grouping**: Lots of logic to allow for groupings by customer, project, delivery address, payment conditions, dates, etc., based on customer/project/deposit situation.
- **Integration Points**:
    - **ByggDok**: External document/traceability solution, triggered based on customer/project and module activation.
    - **Transport**: Integration with logistics/flow management. Handles status, plukket/ready status, and may update transport registers.
    - **Email/Print**: Special handling for email output, alternate routines.

---

## 7. **Notable Features / Extensibility**

- **Highly Configurable**: By using registers for routines, output, order type info, etc., new business rules and processes can be introduced with minimal code changes.
- **Extensive Logging & History**: Changes to order status, lines, deletions, and backordering are all logged.
- **Modular Integration**: Seamlessly links to other programs for cost, flow, and document management.
- **Backward Compatibility**: All major changes are documented with versioning in comments.

---

## 8. **Suggestions for New Developers**

- **Understand the File Layouts**: Know what the header, detail, text, and parameter files represent and their key structures.
- **Follow the Flow**: Walk through the handling of one order from selection to output, noting where updates or integrations occur.
- **Pay Attention to Configurable Points**: Most complex logic is driven by data/registers, not by code constants, enabling flexible process changes.
- **Be Careful with Key Management**: Most actions are keyed by company, order number, suffix, and line—watch for off-by-one or zero-initialization errors.
- **Check Ext. Program Calls**: Many actions (inventory, logging, output) rely on external RPG/CL programs.
- **Use Versioned Comments**: The header comments are invaluable for understanding why code was changed—read them for context.

---

## 9. **Glossary (Norwegian Terms)**
- **Ordre**: Order
- **Resting**: Backorder/leftover not delivered
- **Plukkliste**: Picking list (list for warehouse picking)
- **Pakkseddel**: Packing list
- **Faktura**: Invoice
- **Tilbud**: Offer/quotation
- **Suffiks/Suff**: Suffix used to distinguish original and rested (backordered) parts
- **Kunde**: Customer
- **Prosjekt**: Project
- **Leveringsadresse**: Delivery address
- **Erstatningsordre**: Replacement order
- **Kobling til eksterne systemer**: Integration with external systems (e.g., ByggDok, Cobuilder)

---

## 10. **Conclusion**

This program is central to the order/inventory/output process for the ERP in question, handling nearly all advanced order scenarios (print, email, backorder/rest, grouping, integration). The code is complex but well-structured for maintainability and flexibility.

**Onboarding Tip:** Start with a flow for a simple order-pick-to-print, then expand to backorders and grouped invoices to see the full power of the system. Consult the in-code documentation for each feature/version change as you modify or enhance.