# RPG Program Explanation: VK701R

## Overview

This program is written in ILE RPG (RPG IV) and is named `VK701R`.  
Its main purpose is to determine the alternative product group for a given combination of product group, supplier, and product parameters.

- The program first checks if an alternative product group exists directly for the specific product.
- If none is found, it looks for a match based on product group associations, with several fallback combinations (by nullifying fields in the key).

The comments and some variable names are in Norwegian.  
**Key Entities:**  
- **Vare:** Product
- **Varegruppe:** Product Group
- **Leverand√∏r:** Supplier (param: `ldor`)
- **Alt. varegruppe:** Alternative Product Group

---

## File Definitions

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvasl1    if   e           k disk    rename(vvaspfr:vvasl1r)
fvvgkl1    if   e           k disk    rename(vvgkpfr:vvgkl1r)
```
- These are logical or physical files (database tables), each renamed for local use.
  - `vvarl1`: Data about products.
  - `vvasl1`: Data about deleted products (or variants).
  - `vvgkl1`: Product group associations.

---

## Parameters

These are passed in via the program's parameter list (defined in the `*inzsr` subroutine):

| Parameter   | Description                     | Type/Source    |
|-------------|---------------------------------|---------------|
| p_firm      | Company code                    | like(vkfirm)  |
| p_ogrp      | Original product group          | like(vkogrp)  |
| p_hgrp      | Main group                      | like(vkhgrp)  |
| p_ugrp      | Sub group                       | like(vkugrp)  |
| p_ldor      | Supplier code                   | like(vkldor)  |
| p_vare      | Product code                    | like(vvvare)  |
| p_ahgr      | Alt. main group (output)        | like(vkahgr)  |
| p_augr      | Alt. sub group (output)         | like(vkaugr)  |

---

## Key Variables

These are used for building keys for file access:

```rpg
d vvarl1_vare     s  like(vvvare)
d vvasl1_vare     s  like(vvvare)
d vvgkl1_ogrp     s  like(vkogrp)
d vvgkl1_hgrp     s  like(vkhgrp)
d vvgkl1_ugrp     s  like(vkugrp)
d vvgkl1_ldor     s  like(vkldor)
```

---

## Main Logic

### 1. **Initialization**

```rpg
eval w_firm = p_firm
eval p_ahgr = 0
eval p_augr = 0
```
- Local work variable `w_firm` is set from the input parameter.
- Output parameters are initialized to 0.

---

### 2. **Check for Alt. Product Group on Product**

```rpg
if p_vare <> *blank
    eval vvahgr = 0
    eval vvaugr = 0
    eval vvarl1_vare = p_vare

    vvarl1_key chain vvarl1
    if not %found
        eval vvasl1_vare = p_vare
        vvasl1_key chain vvasl1
    endif

    if vvahgr <> 0 and vvaugr <> 0
        eval p_ahgr = vvahgr
        eval p_augr = vvaugr
        goto avslutt
    endif
endif
```
- If a product code is given, it attempts to retrieve a record with this product from either the main product file or (if not found) the deleted product file.
- If alternative product group codes (`vvahgr`, `vvaugr`) are found (i.e., not zero), they are returned and the program ends.

---

### 3. **Check for Alt. Product Group via Product Group Association**

If above fails, the program tries to find a combination in the product group association file.

```rpg
eval vvgkl1_ogrp = p_ogrp
eval vvgkl1_hgrp = p_hgrp
eval vvgkl1_ugrp = p_ugrp
eval vvgkl1_ldor = p_ldor
```

It then performs a series of chained lookups, progressively relaxing the search keys:

- First tries **all fields filled** (`ogrp`, `hgrp`, `ugrp`, `ldor`).
- If not found, tries **ldor = 0**.
- If still not found, tries **ugrp = 0**, **ldor = original**.
- Next, **ugrp = 0**, **ldor = 0**.
- Then **hgrp = 0**, **ldor = original**.
- Finally **hgrp = 0**, **ldor = 0**.

At each attempt, if a matching association is found, the alternative group values are set to the parameters and the program exits.

---

### 4. **Program End / Subroutine**

The label `avslutt` simply returns, ending the program.

---

### 5. **Startup Routine (*inzsr)**

- The `*inzsr` subroutine is executed automatically at program start.
- It defines the parameter list and the key lists used for the `chain` operations.

#### Parameter List
```rpg
*entry plist
  parm p_firm
  parm p_ogrp
  parm p_hgrp
  parm p_ugrp
  parm p_ldor
  parm p_vare
  parm p_ahgr
  parm p_augr
```

#### Key Lists
- `vvarl1_key`, `vvasl1_key`, and `vvgkl1_key` define the fields used as keys for respective files.

---

## **Summary of Flow**

1. **Try to find alternative product group for the specific product.**
2. **If not found, search for association via product group and supplier, with fallback patterns.**
3. **If still not found, output variables remain zero.**

---

## **Key RPG Concepts Used**

- **CHAIN**: Retrieves a specific record by key.
- **KLIST/KFLD**: Key list/fields for building complex keys for chain operations.
- **PLIST/PARM**: Passing parameters into the RPG program.
- **GOTO**: Unconditional jump (here: for early exit).

---

## **Typical Use**

- This routine is typically called by another program or CL, passing in the product, group, and supplier parameters, and receives the applicable alternative group values for further processing (e.g., for categorization, reporting, or business logic).

---

## **Potential for Refactoring**

- Modern RPG IV *free* syntax and modularization could improve readability.
- Replace `goto` with proper structured programming (`return`/`leave`).
- Use of data structures instead of many scalars if related fields.
- Error handling for file operations can be made more robust.

---

### **In Summary**

This program exemplifies a typical RPG approach to searching hierarchically for master data, with several fallback attempts, and is common in legacy IBM i business logic. The code is readable for those familiar with fixed-format RPG IV, although modernizing would help new developers. The strong use of Norwegian variable and comment names should be considered during onboarding for non-Norwegian speakers.