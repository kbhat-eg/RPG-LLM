# RPG Program FO614RMG - Overview and Explanation

This RPG (Report Program Generator) program is designed to process and handle previously invoiced (fakturerte) amounts for a specific project in an order management/invoicing system, primarily focusing on final invoicing of a project. Below is an organized explanation of the code sections, structures, file definitions, variables, logic flow, and key processing areas.

---

## 1. **File Specifications (`F-specs`)**

```rpg
ffodtlu    uf a e           k disk    rename(fodtpfr:fodtlur)
ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
fsohelr    if   e           k disk    rename(sohepfr:sohelrr)
fsodtpf    if   e           k disk    rename(sodtpfr:sodtpfr)
```

- **fodtlu**: Update, Full procedural file, renamed to `fodtlur`.
- **fodtl1**: Input, Full procedural file, renamed to `fodtl1r`.
- **sohelr**: Input, Full procedural file, renamed to `sohelrr`.
- **sodtpf**: Input, Full procedural file, renamed to itself (register of order lines).

Renaming is used for alternative record formats.

---

## 2. **Data Structures (`D-specs`)**

### a. **Sorting Data Structure**
```rpg
d                 ds
d sorter                       114
d  sor001                        8  0 overlay(sorter)
d  sor002                       60    overlay(sorter:9)
d  sor003                       16    overlay(sorter:69)
d  sor004                        3    overlay(sorter:85)
d  sor005                       17    overlay(sorter:88)
d  sor006                        8  0 overlay(sorter:105)
d  sor007                        2  0 overlay(sorter:113)
```
- A 114-byte structure for sorting, with overlays for ease of field access.

### b. **User Record Structure**
```rpg
d                 ds
d d_urec                        80
d  d_ufir                        3  0 overlay(d_urec)
...
d  d_wsid                       10    overlay(d_urec:47)
```
- Structure to hold audit/user info (date, time, user, workstation).

### c. **User Data Space / LDA**
```rpg
d                uds
d l_user                911    920
d l_filg                931    933
d l_firm                944    946  0
```
- Pulls data from the user data area for user, firm, etc.

---

## 3. **Working Variables**

- `sohelr_aarr`, `sohelr_binr`, `sohelr_numm`, `sohelr_suff`: Variables for order header keys.
- `fodtl1_numm`, `fodtl1_suff`, `fodtl1_line`: Keys for order lines.
- A variety of single-character and string fields for types, codes, etc.
- `p_numm`, `p_suff`, `p_line`, `p_proj`, `p_upro`, `p_akti`: Parameters received from the calling program (order, project, line, activity, etc).

---

## 4. **Main Processing Logic**

### a. **SQL Cursor Declaration**

The program uses embedded SQL to fetch previously invoiced order lines for the current firm and project.

```rpg
c/exec sql
c+ declare sok_s cursor for
c+   select ... from sodtpf
c+   where sdfirm = :l_firm and sdproj = :p_proj
c+   for read only
c/end-exec
```
- The cursor retrieves order line info for previously invoiced records (`sodtpf`) for a specific firm and project.
- Fields like number, suffix, line, quantity, sale value, etc. are included.

### b. **Fetching and Looping**

1. **Open and fetch from the cursor**.
2. **Loop through each fetched record**.
   - If no more records, or keys do not match, exit loop.
   - Skip if current invoice/order/line is the same as the one being processed.
   - Only process "Akonto" (downpayment/interim) invoices (as determined by the first 6 chars in `sdtek1`).
   - Verify the fetched order belongs to this project/activity by comparing order headers.
3. **Each valid previously invoiced line:**
   - Find the last line number from the order lines file.
   - Calculate the next line number to be used.
   - Prepare a new record with a description indicating it's a prior invoice ("Akonto ...").
   - Write this new record with the appropriate negative amount (to correct totals).

### c. **Write Summary Text Lines**

After processing all previous invoice lines:
- If lines were found and written, add a summary line: "- Tidligere Fakturert" ("Previously Invoiced").
- Add a line: "S L U T T F A K T U R A" ("FINAL INVOICE").

---

## 5. **Initialization Subroutine (`*inzsr`)**

- Entry parameters (`plist/parm`) set up from the program call (order number, suffix, line, project, activity, etc).
- Key lists establish composite keys for accessing order header and order line files.
- Working variables initialized from LDA values.

---

## 6. **Notable Comments and Change History**

The header contains a change log and description in Norwegian:
- Original purpose: fetch previously invoiced ("tidligere fakturert") for final project invoicing.
- Later extensions include support for longer price group fields, etc.

---

## 7. **Variable Naming and Norwegian Terms**

- Many fields use Norwegian abbreviations:
  - `faktura` = invoice
  - `ordre` = order
  - `prosjekt` = project
  - `linje` = line
  - `kunde` = customer

---

## 8. **Summary of Program Flow**

1. **Initialization**: Read parameters; set up keys, working storage.
2. **Selection**: Use SQL to get all earlier "Akonto" invoices for the project.
3. **Validation/Filtering**: Ensure invoice lines belong to the right project/activity.
4. **Processing**: For each valid previous invoice, create a negative correction line on the final invoice.
5. **Summary Lines**: Add textual lines to demarcate previous invoicing and final invoice section.
6. **Audit info**: Appropriate dating/timestamps/user info for audit trail.
7. **Program End**: Clean up and return to caller.

---

## 9. **Onboarding Notes**

- The program is intended for financial/ERP environments familiar with Norwegian business terminology.
- Modification or extension should be careful with data structures, line numbering logic, and text descriptions (used by customers).
- Relies on several physical/logical filesâ€”understand their layouts before altering keys or field lengths.
- Embeds SQL for record selection; ensure indexes exist for performance.
- Handles records for both calculation and audit purposes; any changes here may affect reporting/invoicing accuracy.
