# SF631R – Label Printing from Statistics

## Overview

This program, part of system **ASSTAT**, is responsible for printing address labels based on statistical data. The program reads customer/project information, organizes it into label format (multiple labels per row), and outputs to a printer file. The code is written in traditional (fixed-format) RPG IV, and is tailored for batch or report-style processing.

## Key Business Logic

- **Purpose**: To generate and print address labels for customers or customer projects, based on criteria from statistical files.
- **Input**: Statistical data and customer/project master files.
- **Output**: A formatted label sheet, with multiple labels in each row, suitable for physical printing.
- **Label Formatting**: Labels are batched into rows, each row containing up to 9 labels (adjustable), with configurable width and height.

## File Usage and Relationships

- **skwwpf**: Input file containing statistics or batch criteria.
- **skpml1**: Input file, likely a project or product master, keyed access.
- **rkunl1**: Input file, customer master, keyed access.
- **sf631p**: Output printer file for label printing. Includes printer information data structure (`infds`).

## Data Structures and Variables

### Arrays

- **a_kund, a_navn, a_adr1, a_adr2, a_padr**: Arrays (size 9) holding customer/project number, name, address lines, and postal place for each label in a row. Populated as labels accumulate before printing a row.

### Key Data Structures

- **skpml1_key**: 15-character key for accessing `skpml1`, overlaid into subfields for firm, type, and code.
- **beg**: 15-character field, overlaid for numeric extraction (`begnum`, `k6`).
- **d_infds**: Holds printer file information, such as current line and page number.
- **l_* fields**: User/session/environment information, e.g., routine, workstation ID, user, firm.

### Control Variables

- **w_etik**: Current label index in the row (1-based).
- **w_ante**: Number of labels per row (default 3).
- **w_bred**: Label width (default 36).
- **w_hoyd**: Label height (default 6).

## Main Processing Flow

1. **Initialization (`*inzsr`)**
   - Sets label layout parameters (`w_ante`, `w_bred`, `w_hoyd`).
   - Reads selection criteria (e.g., label type) from the parameter list.
   - Prepares keys for data access.
   - Writes the initial header to the printer file.

2. **Main Loop**
   - Iterates over records from `skwwpf` (statistics file).
   - For each record, extracts a key and chains to the customer master (`rkunl1`).
   - On group break (change in sort field), triggers label handling.

3. **Label Handling (`behandling` subroutine)**
   - Increments the label index.
   - When a row is full (`w_etik > w_ante`), triggers detail line output.
   - Populates the label arrays with customer/project data.

4. **Detail Line Output (`detalj` subroutine)**
   - Concatenates the label arrays into output fields for the printer file, one field per label row (customer number, name, address lines, postal place).
   - Checks if there is space left on the page; if not, writes a header.
   - Writes the label row and any necessary blank lines to fill the label height.
   - Clears the label arrays for the next row.

## Notable Design Decisions and Conventions

- **Batching**: Labels are buffered in arrays and only printed when a full row is ready, optimizing output and aligning with physical label sheets.
- **Array Sizing**: Arrays are sized for up to 9 labels per row, but the actual count is set by `w_ante` (default 3), allowing for flexible label formats.
- **Overlay Usage**: Key fields and numeric extractions are managed via overlays, a common convention in legacy RPG for efficient field handling.
- **Subroutine Structure**: Key logic is encapsulated in subroutines (`behandling` for label assembly, `detalj` for printing), making the flow modular and easier to follow.
- **Separation of Data and Layout**: The program is structured to keep data extraction, label assembly, and output formatting distinct.

## Interactions with Other Modules

- **Customer/Project Master (`rkunl1`)**: Used for retrieving customer/project details for each label.
- **Statistical Files (`skwwpf`, `skpml1`)**: Provide the selection criteria and context for which labels to print.
- **Printer File (`sf631p`)**: All output is sent here, with printer file status monitored via `d_infds`.

## Domain-Specific Aspects

- **Norwegian Field Names**: Many field and variable names are in Norwegian (e.g., `navn` = name, `adr` = address, `kunde` = customer).
- **Physical Label Sheet Handling**: The code is designed to work with physical sheets of labels, accounting for width, height, and page breaks.
- **Statistical Selection**: The specific records to print are determined by statistical or batch criteria, suggesting this is used for mass mailings or targeted communications.

## Patterns and Conventions

- **Group Break Processing**: The code detects changes in sort fields (e.g., `L6` break) to trigger label row completion.
- **Printer Line Management**: Before writing a new label row, checks are made to ensure it fits on the current page.
- **Blank Line Handling**: After each label row, blank lines are written to maintain proper label height.

## Summary Table

| Component      | Role                                                      |
|----------------|-----------------------------------------------------------|
| skwwpf         | Input: statistical selection criteria                     |
| skpml1         | Input: project/product master, keyed                      |
| rkunl1         | Input: customer master, keyed                             |
| sf631p         | Output: printer file for label sheets                     |
| a_* arrays     | Buffer label data for each row                            |
| behandling     | Subroutine: assemble label row                            |
| detalj         | Subroutine: output label row, manage page/arrays          |
| *inzsr         | Initialization: set up parameters, keys, write header     |

## Key Points for New Developers

- **Parameterization**: Label dimensions and number per row are set at runtime, allowing adaptation to different label sheets.
- **Array Management**: Pay attention to how arrays are cleared and refilled for each label row.
- **Overlay Fields**: Understand overlays for key management; this is a legacy RPG idiom.
- **File Relationships**: Know which files provide selection, detail, and output.
- **Page/Line Control**: The code is careful to avoid overrunning label sheets—modifications must preserve this logic.

---

If you are onboarding to this program, focus on understanding the flow from statistical selection to label assembly and output, and how label layout is controlled by runtime parameters and array buffering. Modifications for new label formats or selection criteria will typically involve adjusting the initialization and the array handling logic.