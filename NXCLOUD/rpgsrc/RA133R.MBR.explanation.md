# Explanation of RPG Program RL133R

This RPG program is written in the traditional "fixed format" style. Below is a breakdown of its components, structures, and business logic to help new developers quickly become oriented with its purpose and flow.

---

## Purpose

**Program**: RL133R  
**System**: NXCLOUD  
**Description**:  
Maintenance of credit limit evaluations ("Vedlikehold av vurdering av kreditt grenser").

---

## High-level Functionality

- Manages credit limit evaluation entries using a subfile interface.
- Supports creating, updating, displaying, and deleting credit limit evaluation records.
- Handles paging in a subfile and ensures data integrity (no duplicate types, increasing score order).
- Reads firm/user context from the Local Data Area (LDA).

---

## File & Workstation Declarations

```rpg
fra33i1    if   e           k disk    rename(ra33st:ra33i1r)
fra33ir    if   e           k disk    rename(ra33st:ra33irr)
fra33iu    uf a e           k disk    rename(ra33st:ra33iur)
fra133d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **fra33i1/ir/iu**: Database files (with key access, externally described), with alternate record formats via `rename`.
- **fra133d**: Workstation file with subfile support, subfile record name `b1sfl` and record number `w_srrn`.

---

## Field & Variable Definitions

- **Local Data Area (LDA)**: Used for retrieving user, firm, and company names at program start.
- **Key fields for files**: Variables like `ra33i1_type`, `ra33ir_kuid`, `ra33iu_kuid` are aligned to respective key field types.
- **Work variables**: For subfile control (record counts, page pointers, etc.), operational flags.
- **Constants**: For subfile paging size (`c_sfil` = 14, i.e., 14 records per page).

---

## Main Program Loop and Workflow

The program is structured around a main loop that repeatedly displays the subfile screen and handles user input, using branching (`goto` and subroutines) for control.

### Initialization (`*INZSR`)

- Populates key lists for file positioning.
- Reads values from LDA for user/firm context.
- Positions the database to the appropriate place.
- Loads the initial subfile page.
- Sets certain indicators for screen display.

### Main Loop
- Writes the main command screen.
- Displays the subfile contents using `dsp_subfile`.
- Handles function key input:
  - **F3/F12 (Exit keys, *INKC or *INKL)**: Exit program.
  - **F5 (*INKE)**: Refreshes the subfile screen.
  - **F6 (*INKF)**: Add new entry (sets create flag, goes to edit subroutine).
  - **F10/F11 (*IN10, *IN11)**: Page forward/backward in the subfile.
  - **F21 (*IN21)**: Some special processing (sets *IN22), not specified.

#### Subfile Processing (`subfile`)

- Loops through displayed subfile records (`readc`), processing user actions for each:
  - **Change (b1valg = 2)**: Edit the record.
  - **Delete (b1valg = 4)**: Calls delete subroutine.
  - **Display/View (b1valg = 5)**: Shows the record in display mode.
- Invokes the appropriate subroutine for each operation.

---

## Subroutines Breakdown

### forny ("refresh")
- Repositions file pointer, clears and recreates the subfile list.

### subfile
- Handles per-record user processing in the subfile as described above.

### xc2bld ("build/change/display record")
- Loads a record for display, change, or creation.
- Performs several validations:
  - No duplicate "type" (when adding).
  - Scores are in ascending order.
- Updates or adds the record depending on context.
- Sets flags for subsequent refresh if necessary.

### xc2msg1 / xc2msg2
- Display error message screens (type used before; score order error).

### xd1win ("delete window")
- Loads the record, displays it, and upon confirmation deletes it.

### clr_subfile
- Clears the subfile and resets related counters and indicators.

### crt_subfile
- Loads records from the database into the subfile up to the page size.
- Updates pointers and subfile record numbers.

### bck_subfile
- Handles paging backwards in the subfile.

### dsp_subfile
- Controls screen display of the subfile.

---

## Key RPG/AS400 Concepts Used

- **Subfiles**: To show lists (paged) and handle selection/editing.
- **Indicators** (`*INxx`): Manage state between program logic and DDS display files.
- **LDA (Local Data Area)**: Used to derive session/user context.
- **KLIST/KFLD**: Key lists for database file operations.
- **Control-level fields**: For paging, record numbers, etc.
- **File operations**: `setll`, `chain`, `update`, `write`, `delete`, `readc`, `readp`.

---

## Error Handling and Validation

- Ensures no duplicate company types when creating.
- Enforces score order to be ascending.
- Error messages are displayed in dedicated subroutines with their own display formats.

---

## Typical User Flow

1. **Screen displays the current list of credit limit evaluations (subfile)**.
2. **User can:**  
   a. Add a new type (F6),  
   b. Change or display details (select row, enter function),  
   c. Delete an entry,  
   d. Page up/down through the subfile (F10/F11),  
   e. Exit.
3. **Validation occurs on any edit or new entry.**
4. **Changes are written to the DB and subfile is refreshed.**

---

## Summary Table

| Subroutine     | Purpose                                                |
|----------------|-------------------------------------------------------|
| forny          | Refresh subfile (clear and reload)                    |
| subfile        | Main subfile processing loop                          |
| xc2bld         | Edit/New/Display single record                        |
| xc2msg1/2      | Display error messages                                |
| xd1win         | Delete a record                                       |
| clr_subfile    | Clear subfile and control fields                      |
| crt_subfile    | Load next set of records into the subfile             |
| bck_subfile    | Load previous page in subfile                         |
| dsp_subfile    | Display the subfile                                   |
| *INZSR         | Initialization on first entry                         |

---

## Comments/Further Guidance

- **Record field names** like `rkktyp`, `rkksc1`, etc., come from the database file(s) and must be checked in DDS.
- **Function keys and indicators**: Mapping between indicator numbers (e.g., *IN12) and display file must be maintained.
- **Subfile size** (`c_sfil`) controls paging granularity.

---

### Onboarding Tips

- **Understand subfile handling**: Review how subfiles are defined/used in the DDS for RL133D.
- **Review database structures**: Check physical file layouts for ra33st and record formats ra33i1r, ra33irr, ra33iur.
- **Cross-reference indicators and command keys**: Match up what function keys are assigned in the display files.
- **Step through with debugging if possible**: Since *NODEBUGIO is set, you can debug but not I/O operations.

---

## Summary

This program is a standard AS/400 (IBM i) ILE RPG application for maintaining a list of credit limit evaluations using a subfile. It's highly modular, with sections for initialization, display, edit, delete, navigation, and error handling, and follows best practices for file and subfile management in classic RPG.