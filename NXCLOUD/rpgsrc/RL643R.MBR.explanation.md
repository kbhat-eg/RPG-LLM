# Documentation for RL643R – Account Statement/Email Print Parameters

## Overview

This program, RL643R, is a parameter entry and validation routine for generating account statements (kontoutdrag) and optionally sending them by email. It is part of the ASOKON system and is typically invoked as a parameter screen, collecting user input for print and distribution criteria. The program's primary responsibility is to gather, validate, and populate parameters, which are then used by downstream processes that handle the actual report generation and distribution.

## Key Features and Business Logic

- **Parameter Collection:** Presents a display file (A2BLD) for users to specify selection criteria regarding account statement printing and emailing.
- **Validation:** Implements comprehensive checks on accounting year, period, and related date ranges to ensure business rules are enforced before proceeding.
- **Email Support:** As of version 5.41, supports sending statements via email, with related parameters and logic.
- **Open Items Option:** As of version 5.50, allows statements to be generated for open items only.
- **Integration:** Relies on a shared data structure (RPARRKDS) for parameter passing and interacts with standard user and company context fields (`l_user`, `l_firm`).

## Structure and Flow

### 1. Initialization (`*inzsr` Subroutine)

- **Parameter List:** Receives up to four parameters (`p_in03`, `p_levr`, `p_valg`, `p_mail`) for external invocation.
- **User/Company Context:** Initializes local copies of user and company fields for downstream use.
- **Default Period Calculation:** Sets up default accounting year (`waar`) and month (`wmnd`) based on the current date, adjusting for year transitions if necessary.
- **Parameter Defaults:** Sets output parameters to zero or blank values as appropriate.

### 2. Main Parameter Screen Logic

- **Display Interaction:** Uses the A2BLD display format to present the parameter entry screen and collect user input.
- **Exit Handling:** If the user presses F3 (`*INKC`), sets a return code and exits immediately.
- **Open Items Logic:** If the user selects the open items option (`a2valg = '2'`), adjusts the from/to year and period fields to current values.
- **Validation:** Performs a series of checks:
    - Ensures the 'to year' is not in the future.
    - Ensures 'from year' and 'to year' are valid and non-zero.
    - Ensures 'from year' is not after 'to year'.
    - Validates accounting periods in the same manner.
    - Ensures period ranges are logical (e.g., 'from period' is not after 'to period' within the same year).
    - Displays appropriate error messages and redisplays the screen if any validation fails.
- **Parameter Assignment:** On successful validation, moves screen values to the shared parameter data structure (RPARRKDS fields).
- **Email Option:** If selected, sets the email flag parameter for downstream processing.

### 3. Program Termination

- **Graceful Exit:** Sets LR indicator to end the program and returns to the caller.

## Notable Design Decisions and Conventions

- **Indicator Usage:** The program uses a well-documented indicator convention for clarity and maintainability:
    - KA/KC for function keys (firm selection/exit).
    - 30s for field protection, 31–59 for warnings/errors, 60–69 for file I/O, 70–89 for working indicators, 90–99 for subroutines.
- **Parameter Passing:** Leverages a common data structure (`RPARRKDS`) for parameter sharing between programs, improving modularity and reducing tight coupling.
- **Screen Re-entry on Error:** All validation failures cause the program to return to the input screen, preserving the user's context and error indicators.
- **Version Control:** Inline comments and a change log at the top of the source document all modifications, including version numbers and responsible developers.
- **Language/Localization:** Comments and some variable names are in Norwegian, reflecting the business context and user base.

## External Interactions

- **Display File:** Uses the `rL643d` workstation file, specifically the `A2BLD` format, for user interaction.
- **Data Structures:** Includes (`/COPY`) the `RPARRKDS` structure from a shared source member for all parameter fields.
- **User/Company Context:** Relies on `l_user` and `l_firm` fields, presumably set by the calling environment or session context.

## Special Notes

- **No Direct File I/O:** This program does not perform any database or file access; it is strictly for parameter entry and validation.
- **No Business Logic Beyond Validation:** All business rules implemented here are related to the validity of the parameter ranges and options, not to the actual processing or output of statements.
- **Extensibility:** The structure allows for easy addition of new parameters or validation rules, as evidenced by the version history.

## Summary Table: Key Parameters

| Parameter   | Source/Target        | Purpose                                 |
|-------------|---------------------|-----------------------------------------|
| p_in03      | Parameter           | Return code (exit status)               |
| p_levr      | Parameter           | Customer/supplier number                |
| p_valg      | Parameter           | Print selection (e.g., open items)      |
| p_mail      | Parameter           | Email flag (send by email if '1')       |
| a2pårf/t    | Screen/Parameter DS | From/To accounting year                 |
| a2ppef/t    | Screen/Parameter DS | From/To accounting period               |
| a2valg      | Screen              | Statement type selection                |
| a2mail      | Screen              | Email option selection                  |

## Typical Call Flow

1. Program is called, parameters are initialized.
2. User is presented with the A2BLD screen to enter criteria.
3. User input is validated; errors are flagged and the screen is redisplayed if necessary.
4. On successful validation (or exit), parameters are returned to the caller for use in downstream statement generation.

---

For further details on the shared parameter structure (`RPARRKDS`), refer to its source member in `QCPYLESRC`. For display file specifics, see the DDS for `rL643d`.