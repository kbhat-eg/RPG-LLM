# RPG Program Walkthrough: RA124R

This source code is for an IBM i (AS/400) ILE RPG program, written using the "original" or fixed-format RPG IV (RPGLE) style. The program is part of a system for maintaining "Reklamasjonsårsaker" (Claim/Complaint Reasons).

Below is a detailed explanation, section by section, to help you or another developer understand and onboard yourself to this code.

---

## 1. **Header and Documentation**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **No Debug I/O**: Disables debug break at input/output operations.
- **Date Edit**: Sets default date format to day/month/year.

The comment section documents the program, version history, and indicator usage conventions.

---

## 2. **File Declarations**

```rpg
fra24l1    if   e           k disk    rename(ra24pfr:ra24l1r)
fra24l2    if   e           k disk    rename(ra24pfr:ra24l2r)
fra24lr    if   e           k disk    rename(ra24pfr:ra24lrr)
fra24lu    uf a e           k disk    rename(ra24pfr:ra24lur)
fra124d    cf   e             workstn sfile(b1sfl:w_srrn)
```

- `fra24l1`, `fra24l2`, `fra24lr`, `fra24lu` are logical files over the same physical file `ra24pfr`, but with different record formats.
- `fra124d` is a display file for user interactions, supporting a subfile (`b1sfl`) for listing items.

---

## 3. **Data Area & Variables**

**User Data Space:**
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Access to data stored in the user-area (UDS), typical in RPG for session/user-specific data.
- Extracts user, firm, and other parameters.

**Variables for Key Fields & Subfile Paging:**
```rpg
d ra24l1_xrko     s                   like(raxrko)
... (similar for l2, lr, lu)

d w_stel          s              4  0
d w_spge          s              4  0
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
...
d w_seqe          s              1
d b_oppr          s              1    inz(*off)
d b_forn          s              1    inz(*off)
...
```
- Subfile management: counters, page sizes, and flags for control flow.

**Constants:**
```rpg
d c_sfil          s              2  0 inz(14)
```
- Constant for subfile page size.

---

## 4. **Indicator Usage**

- LR — End of program
- 10 (Rollup), 11 (Rolldown), 12/13/14/15 — Subfile display/maintenance
- 21/22 — Cursor handling
- 30+ — Field protection, warnings, etc.

---

## 5. **Main Control Flow**

The "main body" is a loop that:
- Displays the subfile control ("b2ctl") and command screen ("b2cmd")
- Handles function key input (F3/F12/F5/F6/etc.)
- Calls subroutines to:
    - Refresh or create the subfile
    - Navigate pages
    - Position on specific records

Example, function key handling:
```rpg
c                   select
c                   when      *inkc or *inkl
c                   goto      avslutt
c                   when      *inke
c                   exsr      forny
...
c                   endsl
```
Depending on the key, it may refresh, create, scroll, or exit.

---

## 6. **Subroutines**

### a. **forny (Renew Subfile)**
- Repositions to the appropriate record.
- Calls subroutines to clear (`clr_subfile`) and (re)create (`crt_subfile`) the subfile.

### b. **posisjoner (Positioning in Subfile)**
- Positions based on either XRKO (reason code) or XTXT (description).
- Uses SETLL to position the appropriate logical file, then refreshes the subfile.

### c. **subfile (Subfile Interaction)**
- Reads all records in the displayed subfile page using `readc b1sfl`.
- Processes actions chosen by users (edit, copy, delete, view), based on the `b1valg` field:
    - 2 = Edit (`xc2bld`)
    - 3 = Copy (`xk1win`)
    - 4 = Delete (`xd1win`)
    - 5 = View  (`xc2bld` with view protections)

### d. **xc1bld (Handle Create Screen)**
- Manages the creation of a new record.
- Checks for duplicates, and if found, displays an info message screen (`xc1msg`).
- Calls `xc2bld` for further processing if valid.

### e. **xc1msg (Duplicate Record Message)**
- Handles a popup/message if trying to create a record that already exists.

### f. **xc2bld (Edit/View/Create Detail Screen)**
- Chain to fetch current record.
- Loads the fields for editing or displays them.
- Updates or writes records back, recording user and timestamp.
- Updates subfile when appropriate.

### g. **xd1win (Delete Popup Window)**
- Confirmation dialog for delete.
- Deletes the record if confirmed.

### h. **xk1win (Copy Popup Window)**
- Allows copying an existing record to a new code (after validation).

### i. **clr_subfile (Clear Subfile)**
- Sends "clear subfile" indicators and resets subfile-related counters.

### j. **crt_subfile (Create/Refill Subfile)**
- Reads records from file and fills the subfile page with up to 14 records (by default).
- Handles which logical file to read (by reason code or description).

### k. **bck_subfile (Scroll Back Subfile Page)**
- Moves the subfile "window" back by one page.

### l. **dsp_subfile (Display Subfile)**
- Controls display logic for the subfile.

### m. **\*inzsr (Initialization Subroutine)**
- Defines key lists for file positioning.
- Loads firm number from the LDA.
- Positions to the start of the file and fills the initial subfile page.

---

## 7. **General Workflow**

1. **Program Initialization (\*inzsr)**:
   - Set up files, variables, and subfile for display.

2. **Main Loop (labels: b2taga, b2tagb):**
   - Show subfile and handle user input.
   - Based on function keys, allow editing, creating, copying, deleting, or viewing certain records.

3. **Subfile Management:**
   - Handles paging, scrolling, refreshing, and updating records as required.
   - Subfile fields (`w_stel`, `w_spge`, etc.) are used to control which items are shown and manipulated.

4. **CRUD Operations:**
   - Each operation is mediated with a confirmation or detail screen.
   - Changes are written back to the database and the subfile is refreshed accordingly.

---

## 8. **Display File (fra124d) and Subfile Usage**

- The display file referenced (`fra124d`) has several record formats:
    - `B1SFL` — subfile record
    - `B2CTL` — subfile control record
    - `B2CMD` — command screen
    - `C1BLD`, `C1MSG`, `C2BLD` — various detail/pop-up screens

All record format names and field names (e.g., `b1xrko`, `b1xtxt`) are referenced consistently when updating or displaying data.

---

## 9. **Function Key Mapping**

- *INKC, *INKL, etc. map to F3 (Exit), F12 (Cancel), F5 (Refresh), F6 (Create), F10 (Page Down), F11 (Page Up), F21 (Home), etc.
- These are handled by checking indicator status and branching accordingly.

---

## 10. **Localization and Comments**

- Comments and variable names are in Norwegian.
- Key words:
    - "reklamasjonsårsaker" = complaint/reason code
    - "beskrivelse" = description
    - "opprettelse" = creation
    - "slette" = delete
    - "kopiere" = copy

---

## 11. **Summary Table of Important Concepts**

| Concept           | Variable / Procedure | Purpose                                            |
|-------------------|---------------------|----------------------------------------------------|
| Subfile page size | `c_sfil`            | Default = 14 records per subfile page              |
| Navigation        | `w_srrn`, `w_ssrn`  | Current and last relative record number            |
| Function keys     | *in10 .. *in15      | Map to paging, clear, end subfile, etc.            |
| CRUD ops          | `xc1bld`, `xd1win`  | Add/create, edit/view, delete, copy                |
| Init sequence     | `*inzsr`            | Sets keys, variables, and performs initial load    |

---

## 12. **Getting Started/Tips for New Developers**
- If you’re new to ILE RPG or subfile programming:
    - Study the indicator roles (`*inXX`) and function key mapping.
    - Run the program in debug to observe subfile operations (page up/down, create, delete, etc.).
    - Examine the display file (`fra124d`) for screen layouts and field positions.
    - Get familiar with Norwegian field and variable names.

---

**In summary:**  
This program is a classic AS/400 subfile-based maintenance screen, letting users browse, create, update, copy, and delete "complaint reasons" by either code or description, with paging and positioning features common to green-screen applications. Most of the logic is handled with RPG subroutines, careful indicator management, and explicit navigation within subfiles.