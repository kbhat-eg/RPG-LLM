# RPG Program BM600R Documentation

## Overview

**Program Name:** BM600R  
**System:** ASLOGI  
**Purpose:**  
This program generates and maintains product (item) records in the "ABC register" (ABC-register), a specialized analysis and reporting structure for inventory management. It classifies and accumulates sales and quantity data for products, assigns ABC/XYZ codes based on configurable thresholds, and interacts with several supporting files and modules to ensure accurate product groupings, replacements, and statistics.

**Business Domain:**  
The ABC-register is a common inventory control technique, where items are classified (A, B, C) based on their contribution to revenue or movement, and further subdivided (X, Y, Z) by sales volume or other criteria. This program automates the periodic update and recalculation of these codes for all relevant products, supporting advanced inventory analysis and reporting.

---

## Main Functional Flow

### 1. Initialization

- **Parameter Handling:**  
  The program receives a single 128-character parameter string (`p_list`) containing various selection and threshold parameters (item ranges, group ranges, date intervals, sorting, warehouse, etc.), parsed into a data structure (`d_list`).
- **Key List Definitions:**  
  Multiple KLISTs are defined for efficient keyed access to the various files (product statistics, working files, group files, etc.).
- **Threshold Calculation:**  
  The subroutine `kalk_grns` computes threshold values for ABC/XYZ classification based on input parameters.

### 2. Data Preparation

- **Deletes Previous Results:**  
  The subroutine `slett_tidl` removes any previous ABC/XYZ analysis results for the current parameter set from the working file (`mabdlur`).

### 3. Main Processing Loop

- **Iterates Over Product Statistics (`sstala`):**  
  Reads each product record within the selected range and period.
- **Record Validation (`rec_ktrl`):**  
  Each record is validated against the input selection criteria (company, date, group, assortment, warehouse, product type, etc.), including complex logic for assortment and replacement products.
- **Record Accumulation (`rec_ok`):**  
  If the product passes all checks, its sales and movement data are accumulated. When the product changes, the previous product's accumulated data is written or updated in the working file (`lwb1lur`).
- **Replacement Products:**  
  For products with replacements, sales data from replacement items are included using `sjekk_erstv` and `les_erstv`.

### 4. ABC/XYZ Analysis

- **Calculate Proportions (`finn_pros`):**  
  For each item, calculates its percentage of total net sales and quantity, storing these for later classification.
- **ABC Classification (`oppd_abc`):**  
  Iterates through items, assigning A, B, or C codes based on net sales thresholds.
- **XYZ Classification (`oppd_xyz`):**  
  Iterates through items, assigning X, Y, or Z codes based on quantity thresholds.
- **Consistency Check (`sjk_abc`, `sjk_xyz`):**  
  Ensures at least one item is classified as A/B and X/Y, adjusting codes as needed.

### 5. Summary Update

- **Summary Calculation (`upd_sum`):**  
  Updates summary counts for each ABC/XYZ combination in the summary file (`mabclur`).

### 6. Finalization

- **Call to External Module (`VL710R`):**  
  At the end, the program optionally calls an external module to update or synchronize tracking information for the last processed product.

---

## Key Data Structures and Files

### Parameter and Control Structures

- **`d_list` (Parameter Data Structure):**  
  Overlays the 128-character input parameter and provides named fields for all selection and threshold values.
- **Group/Type Structures:**  
  Data structures for item group, subgroup, and assortment facilitate flexible selection and matching.

### Files

- **`sstala`, `sstali`:**  
  Product statistics files (main and replacement).
- **`lwb1lu`, `lwb1l5`, `lwb1l6`:**  
  Working files for accumulation and analysis, supporting access by different keys (item, percentage, quantity).
- **`vvarl1`, `vverlr`, `vverl2`:**  
  Product master, replacement product master, and old product number mappings.
- **`vsdtl1`, `vshel1`:**  
  Assortment definition files (with and without warehouse).
- **`mabdlu`, `mabclu`, `mabdl1`, `mabdl2`:**  
  ABC analysis working and summary files for storing results.

---

## Notable Business and Domain-Specific Logic

### 1. **Replacement (Erstatningsvare) Handling**

- When a product has replacement items, their sales/movement data are recursively included in the analysis for the original item, ensuring accurate ABC/XYZ assignment.

### 2. **Assortment (Sortiment) Matching**

- The program supports complex assortment matching, including logic for matching on supplier, warehouse, group, and specific product, with fallback to more general matches if specific ones are not found.

### 3. **ABC/XYZ Classification**

- ABC codes are assigned based on net sales thresholds (A: top, B: middle, C: rest).
- XYZ codes are assigned based on sold quantity thresholds (X: top, Y: middle, Z: rest).
- Ensures at least one item is classified as A and B, and as X and Y, to maintain business reporting requirements.

### 4. **Multi-Level Grouping**

- Supports selection and classification at multiple group levels (main group, subgroup, assortment, warehouse), allowing for highly granular or broad analysis as required.

### 5. **Parameter-Driven Design**

- All selection, filtering, and threshold logic is parameter-driven, allowing the same program to be used for different companies, product groups, periods, and analysis types.

---

## Interactions with Other Modules

- **VL710R:**  
  This external program is called to fetch or update tracking information for products, including product type, warehouse, and possibly other attributes. The call is parameterized with firm, item, warehouse, type, and various tracking fields.
- **Data Files:**  
  The program reads and updates several files, some of which are shared with other modules (e.g., product master, assortment, ABC analysis files).

---

## Design Patterns and Conventions

- **Keyed File Access:**  
  Uses RPG KLISTs for efficient, maintainable keyed access to files.
- **Overlay Data Structures:**  
  Heavily uses overlays to map flat parameter strings to structured fields, a common pattern in legacy RPG for parameter passing.
- **Subroutine Structure:**  
  Business logic is modularized into subroutines for validation, accumulation, classification, and summary, improving maintainability.
- **Versioning and Change Management:**  
  The program header documents all changes, with version numbers and change descriptions, supporting traceability.

---

## Special Considerations

- **Data Consistency:**  
  The program ensures that accumulated data for each product is written before switching to the next product, preventing data loss in case of interruptions.
- **Error Handling:**  
  Most validation is done via subroutines that use early `leavesr` to skip records that do not match criteria.
- **Concurrency:**  
  The program assumes exclusive or controlled access to working files during processing to avoid conflicts.
- **Backward Compatibility:**  
  Several overlays and field assignments support legacy file layouts and naming conventions.

---

## Summary Table of Main Subroutines

| Subroutine      | Purpose                                                        |
|-----------------|----------------------------------------------------------------|
| slett_tidl      | Deletes previous ABC/XYZ results for current selection         |
| rec_ktrl        | Validates a product record against selection parameters        |
| rec_ok          | Accumulates and writes product data to working file            |
| sjekk_erstv     | Handles replacement product accumulation logic                 |
| les_erstv       | Reads and processes replacement product records                |
| rec_ok_er       | Accumulates replacement product data                           |
| rec_ktrl_er     | Validates replacement product records                          |
| kalk_grns       | Calculates ABC/XYZ threshold values from parameters            |
| oppd_abc        | Classifies items as A/B/C based on net sales                   |
| sjk_abc         | Ensures at least one A and B item exists                      |
| oppd_xyz        | Classifies items as X/Y/Z based on quantity                    |
| sjk_xyz         | Ensures at least one X and Y item exists                      |
| finn_pros       | Computes percentage share of sales/quantity for each item      |
| upd_sum         | Updates summary counts for each ABC/XYZ combination            |

---

## Conclusion

This program is a central part of the inventory analysis and control system, automating the classification of products for ABC and XYZ analysis. It is highly parameterized, supports complex business logic for assortment and replacement handling, and interacts with several core data files and external modules. Its subroutine-based structure, extensive use of overlays, and key lists reflect established patterns in this codebase for maintainability and flexibility.

**For onboarding:**  
Familiarity with the business concepts of ABC/XYZ analysis, the structure of the supporting files, and the parameter-driven approach is essential. The programâ€™s logic is modular, but due to its depth and handling of legacy requirements, reviewing the subroutines in detail and understanding the data flow between them is recommended.