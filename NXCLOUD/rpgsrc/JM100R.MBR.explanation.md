# RPG Program JM100R - "Kampanje-hode, vedlikehold"

This ILE RPG (RPG IV / RPGLE) program is designed for interactive maintenance of "campaign headers" in a system. Its main function is to allow users to view, add, update, copy, and delete campaign header records through display files and associated subfiles. The code includes subroutines for subfile management, validations, and integration with related files.

Below is an explanation of the code and its structure, intended to help a new developer understand how it works.

---

## 1. Program Attributes and Comments

- `h option(*nodebugio) datedit(*dmy)`
    - Sets program options for compile:
        - No debug IO (useful for performance)
        - Date edit words for *DMY format
- Extensive comments in Norwegian explain file usage, indicator conventions, and change log/version history.

## 2. File Definitions (`F-specs`)

- Several physical files (`dk`) and update-capable (`uf`) logical files are defined, using `RENAME` to assign local record format names.
- `jkahpfr`, `jkavpfr`, `ra30pfr` are the underlying physical files, with logical files/record formats for different access patterns.
- The workstation file `jm100d` is used for display, defining a subfile (B1SFL) and display file feedback data structure.

### Example:
```rpg
fjkahl1    if   e           k disk    rename(jkahpfr:jkahl1r)
fjkahl2    if   e           k disk    rename(jkahpfr:jkahl2r)
fjkahlu    uf a e           k disk    rename(jkahpfr:jkahlur)
...
fjm100d    cf   e             workstn sfile(b1sfl:w_srrn)
```

## 3. Data Structures and Variables (`D-specs`)

- Local Data Area (LDA) fields for user, firm, and name.
- A display feedback data structure (`dspfbk`) for capturing cursor position, etc.
- Key variables for logical file access.
- Work variables for subfile/page management, flags, and filters.
- Constants and explanations for special-purpose subfile-related fields.

### Example:
```rpg
d jkahl1_kamp     s                   like(jmkamp)
// ...
d w_fcrn          s              4  0
d w_seqe          s              1
d b_oppr          s              1    inz(*off)
d w_fdat          s               d   datfmt(*iso)
d c_sfil          s              2  0 inz(14)
```

## 4. Indicator Convention

Based on comments:
- LR: End of program
- 10–15, 21–22, 30–99: Various UI and logic signals (e.g., subfile rollup, cursor placement, protection, error messages, etc.)

## 5. Mainline (Calculation Specifications) and Subroutines

### Main Processing Loop

The main process uses labels (`tag`) and `goto` to control logic flow between display, subfile processing, and function key handlers.

#### Key Sections:
- `b2taga` / `b2tagb` : Main display and subfile loop.
    - Write commands
    - Handle function keys (select/when)
    - Positioning and filtering
    - Subfile maintenance

- `avslutt` : Program exit (sets LR indicator, returns).

### Subroutines

#### forny

- Repositions in the list based on work variables and input, re-creates subfile.

#### posisjoner

- Handles field-based positioning in the file: by campaign, date, responsible, or price group.
- Rebuilds the subfile from the selected record onward.

#### subfile

- Reads and processes the subfile, handling editing, copying, deletion, viewing, and price maintenance for selected rows.

#### xc1bld / xc2bld

- Handles entry of new records (`xc1bld`) and edit/view/copy (`xc2bld`) of existing records.

#### xc1msg

- Shows a message if an attempt is made to create a record that already exists.

#### xd1win

- Handles deletion of a campaign header and its associated campaign prices.

#### xk1win

- Handles copying of a campaign header and its associated campaign prices.

#### clr_subfile / crt_subfile

- Clears and (re)creates the subfile based on positioning and selection.

#### bck_subfile

- Handles paging backwards in the subfile.

#### dsp_subfile

- Handles display/refresh logic for subfile screen.

#### spørring (8.02+)

- Inquiry subroutine for price group, calls a helper program (`RA530R`) when the cursor is on the relevant field.

#### filter

- Displays and processes filter screen, including price group validation.

#### *inzsr

- Program initialization:
    - Defines keylists for chaining/indicating in logical files.
    - Sets up working variables, retrieves initial values from LDA, positions the file, and fills the subfile.

## 6. Integration with Other Programs

- Calls to `JM110R` (for campaign price maintenance) and `RA530R` (for price group lookup).
- Calls to `VL711R` for price group lookup during initialization.

## 7. Error Handling and Validation

- Various validation and error indicator settings throughout data entry and filtering.
    - Ensures fields are filled, dates are valid and in proper order, required values are set.
    - Error indicators set fields in the display file (usually to show a message).

---

## **Summary of Main Workflow**

1. **Initialization (`*inzsr`)**: Sets up keys, fetches required firm info, and prepares the subfile.
2. **Display Loop**: Shows subfile and filter screens, lets the user select actions with function keys.
3. **Record Maintenance**:
    - **Create**: Prompt user for new header, validate, prevent duplicates, create record.
    - **Edit/View**: Allow editing or viewing of existing records.
    - **Copy**: Copy a record and its prices to a new key, after validation.
    - **Delete**: Remove record and all associated prices after confirmation.
4. **Subfile Paging and Filtering**: User can page through and filter records by different criteria (e.g., campaign, price group).
5. **Price Group Validation**: Integrated with external lookup programs.
6. **Exit**: Setting LR to on (`*inlr = *on`) to end program properly.

---

## **Key Takeaways for Developers**

- This is a classic RPG interactive maintenance program (green screen).
- It is heavily structured around the use of subfiles (for list display and editing).
- Logical files and keylists are used for quick positioning and data retrieval.
- Extensive use of indicators for UI and logic, following old-school RPG standards.
- Interaction with other programs for lookup, validation, and maintenance of related data.
- Handles all standard CRUD operations with validation and feedback to the user.

---

If working on this program, you will typically need to:

- Understand the subfile and display file DDS involved (for B1SFL, B2CTL, etc.).
- Know the layout and content of the files: `jkahpfr`, `jkavpfr`, `ra30pfr`.
- Be aware of the key field definitions and how positioning is handled via keys and variables.
- Recognize the use of subroutines for modularizing code.
- Pay attention to indicator usage for both application logic and UI flow.
- Interact properly with the external programs called for price group and campaign price maintenance.

---

**Tip:** Because of the heavy use of subfiles, function keys, and indicators, debugging and maintenance will be easier if you also have access to the display file DDS and a map of which indicators correspond to which actions/messages. 

---

If you need an explanation of a specific subroutine or section, let me know!