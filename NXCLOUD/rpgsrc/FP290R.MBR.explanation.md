```markdown
# FP290R – Varemottaksprogram (Goods‐Receipt Labeling)

## 1. Program Header & Environment
- **Source options**  
  ```rpg
  /TITLE       ---  FP290R  ----       ASP a.s  
  h dftname(fp610) datedit(*dmy) option(*nodebugio)  
  ```  
  - *dftname(fp610)*: default activation group  
  - *datedit(*dmy)*: European date format  

- **Change log**  
  Long history of enhancements (GTIN, price‐group, MVA, label types).

- **Embedded SQL setup**  
  ```rpg
  C/EXEC SQL  
  C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR  
  C/End-Exec
  ```

---

## 2. File Declarations
- **Display file**  
  `ffp290d   cf   e   workstn`  
- **Database files** (disk):  
  - `vvarl1`, `vvarl4`, `vlagl1`, `vfaspf`, `vetil1(u)`, `vpkol1`, `rlevl1`, `veanlu`, `vvlel1`  
  - Renamed keys for lookups (e.g. `rename(vvarpfr:vvarl1r)`).

- **Print file**  
  `fvaw1pf   o f 512 disk` → label/output buffer.

---

## 3. Data Definitions
- **Constants**:  
  ```rpg
  sp  c '"&\'
  bl  c '   '
  ```
- **Array for messages**:  
  ```rpg
  dcl-s mld varchar(70) dim(6) perrcd(1);
  ```
- **LDA (Local Data Area)**  
  Fields in `uds` structure (e.g. `l_skty, l_etyp, l_firm, l_lage`).

- **Working-Storage Variables**  
  `w_vare, w_eann, w_etyp, w_pri1_u, w_pri2_u, w_mvat, w_mvaf`, etc.  
  Used to hold product number, EAN, pricing, MVA, label type, etc.

---

## 4. Main Program Flow
1. **Entry/Routine A1BLD**  
   - Clear flags: `%IN71..%IN96`, `meld`, `w_valg`.  
   - Display screen via `EXFMT A1BLD`.
2. **Function‐Key Handling**  
   - F3/F12 (`*IN03=*ON`): exit (`goto slutt`).
   - F4 invalid on most fields: show message `meld=mld(04)`.
   - F7/F9: set `w_valg='1'` to print price tag.

3. **GTIN Generation (Option “G”)**  
   - If user presses custom function (F?), branch `kh`: call subroutine `crt_gtin`.

4. **Label Type**  
   - F8 (or custom): set `l_hyll=1` then `goto a1tag6` for shelf‐tag.

5. **Exit Conditions**  
   - If `*INKE` (Esc) or `*INKL`, go to `a1tag5` to reset inputs.

---

## 5. Product Lookup Logic
### 5.1 EAN Lookup
- If `a1eann` (input EAN) not zero:
  1. Call `VE710R` (or `VE716R`) → fetch `w_eava, w_eaen, w_east`.
  2. If found (`w_east='1'`), set `w_vare=w_eava` and jump to `a1tag6`.
  3. Else show “EAN‐kode finnes ikke” (`meld=mld(01)`).

### 5.2 Supplier’s Item Number
- If `a1lvar` (leverandørnr) present:
  1. (SQL lookup in VVLVPF – logistic override).
  2. Else chain on `vvarl4` → product file by `w_lvar`.
  3. If not found: error (`meld=mld(02)`).

### 5.3 Own Product Number
- Tag `a1tag3`:
  1. Chain on `vvarl1` → product master by `w_vare`.
  2. If not found: error (`meld=mld(02)`).
  3. Else call subroutine `hent_ean` to get EAN if missing.
  4. Populate display fields (`a2vare, a2enh1, a2tek1, a2lvar, a2eann`).

---

## 6. Subroutine: HENT_PRIS / KLAR_PRIS / KLAR_REST
- **hent_pris**  
  ```rpg
  call 'VP716R' parms: w_firm, w_vare, w_prgr, w_lage, w_lety, w_dato, w_time, ...  
  ```
  → fetch price for three units, date/time range, campaign price, comp‐price.

- **klar_pris**  
  - Choose correct price by unit (`w_fen1, w_fen2`), apply time‐based override (`w_tipX`).  
  - Lookup MVA rate (`call 'FØ705R'` or `FØ706R`), apply to `w_pri1, w_pri2, w_pspr`.  
  - Round prices (`FA910R`), limit to 99 999.  
  - Set *IN71/*IN72 flags if price1/price2 present.

- **klar_rest**  
  - Ensure EAN present, fetch `w_eann` via `hent_ean`.  
  - Supplier info from `rlevl1` → `w_lvko`, `w_hyle`, `w_lvar`.  
  - Inventory parameters (reorder point, qty, min/max).  
  - Price‐code text via chain on `vpkol1`.  
  - Sanitize text fields via `XLATE` -> blanks.  
  - Fetch storage location via `vlagl1`.  
  - Sort keys: `w_plas_s`, `w_vare_s`.  
  - Limit quantity 1..500.  
  - Product type from `VL710R`.

---

## 7. Subroutine: CRT_GTIN
- Build GTIN‐13 from own product number (`FØ901R`), store in EAN register if new:
  ```rpg
  p_nobb = a1evnr; p_type='1'; call 'FØ901R'; w_eann=int(p_gtin);
  chain veanlu → if not found → write new record.
  ```

---

## 8. Subroutine: HENT_EAN
- Wrapper to call `VE716R` → populates `w_eann, w_east`.

---

## 9. Subroutine: INIT (*INZSR)
- Reads printer config (`vfaspf`) → sets `l_skty`, `w_vtxt`.  
- Loads MVA rate for default.  
- Populates LDA: `l_firm`, `l_lage`, header text (`w_tvar='Varenr', w_tpri='Pris'`).  
- Fetch price group via `VL711R`.  
- Defines key lists (`klist`) for all chained file reads.

---

## 10. Printing & Output
1. **Label Program Selection** (`a1tag0`):  
   ```rpg
   select;  
     when w_etyp=1 eval w_prog='FP213R';  // Price‐tag  
     when w_etyp=2 eval w_prog='FP214R';  // Shelf‐tag 75×28  
     ...  
     when w_etyp=9 eval w_prog='FP221R';  
   endsl
   ```
2. **Set print flags** (`*IN71/*IN72`) if price lines exist.  
3. **EXCEPT skriv** → writes one record to `vaw1pf`.  
4. Loop back for next label; on exit `*INLR=*ON`.

---

## 11. Messages (per mld array)
1. “EAN‐kode finnes ikke i vareregister”  
2. “Varenummer finnes ikke i vareregister”  
3. “EAN‐kode er feil, Tast nytt eller endre registrert kode”  
4. “Spørring (F4) er ugyldig for dette feltet”  
5. “Eget varenummer må være utfylt for denne funksjon”  
6. “Varen er registrert med EAN‐kode tidligere”

---

### Pedagogical Summary
- **User interaction** on display file → enter product/EAN/supplier no.  
- **Lookup logic** chooses one key in sequence: EAN → supplier no → own no.  
- **Subroutines** fetch pricing, MVA, compile label fields.  
- **Output** goes to a spool file with one record per label, controlled by `w_prog`.  
- **Scaling** supports multiple label sizes, price groups, GTIN creation & storage.

```