# Documentation: AA000R – User Registry Lookup

## Overview

**Program Name:** AA000R  
**Description:** System Administration – Lookup against the user registry  
**Domain:** User authentication and environment context for application users  
**Purpose:**  
This program performs a lookup against the central user registry (AUSRL1 file) to retrieve and populate user-related information in the local data area (LDA). It determines whether a user is valid, populates environment and access fields, and applies special handling for certain user types (e.g., system, integration, or network shop users).

---

## High-Level Structure

- **File Declaration:**  
  - `AUSRL1` is the user registry file, accessed by key, with record format renamed to `AUSRL1R`.
- **Local Data Area (LDA):**  
  - Used to pass user context and environment data between programs.
- **Parameters:**  
  - The program is called with three parameters: a return code (`p_okok`), a user ID (`p_user`), and a job identifier (`p_jobb`).
- **Main Logic:**  
  - Chain the user in the registry, populate LDA fields if found, set status indicators.
  - Special rules for certain users (e.g., network/webshop/system users).
- **Initialization Subroutine:**  
  - Handles parameter list and key list setup.

---

## Detailed Logic

### File Definition

```rpg
fausrl1    if   e           k disk
f                                     rename(ausrpfr:ausrl1r)
```
- Accesses the user registry file (`AUSRL1`) by key.
- Record format is renamed for internal clarity.

---

### Local Data Area (LDA) Layout

A block of the LDA is mapped to various user and environment fields. Notable fields:

| Name   | Offset     | Description                         |
|--------|------------|-------------------------------------|
| dsokok | 900        | User found indicator (0/1)          |
| dswsid | 901–910    | Job/session ID                      |
| dsuser | 911–920    | User ID                             |
| dsmeny | 921–930    | Menu/role code                      |
| dssfil | 931–933    | File identifier                     |
| dssbib | 934–943    | Library (library list)              |
| dssfir | 944–946    | Company number                      |
| dssavd | 947–950    | Department number                   |
| dsfnav | 951–980    | Full name                           |
| dslevl | 996–997    | Access level                        |
| dslagr | 1001–1002  | Warehouse/location                  |
| dsmilj | 1003–1005  | Environment (e.g., A01, A02, etc.)  |

> **Note:** Field mapping is crucial for inter-program communication and must not be altered without coordination.

---

### Parameters

```rpg
d p_jobb          s                   like(abuser)
d p_okok          s              1  0
d p_user          s                   like(abuser)
```
- `p_okok`: Output flag (1 = user found, 0 = not found)
- `p_user`: User ID to look up
- `p_jobb`: Job/session identifier

---

### Main Logic Flow

#### 1. User Lookup

```rpg
c                   eval      ausrl1_user = p_user
c     ausrl1_key    chain     ausrl1r                            60
```
- Sets up the key with the user ID.
- Attempts to chain (lookup) the user in `AUSRL1`.
- If not found (`*IN60 = *OFF`), proceeds with "not found" logic.

#### 2. User Found

When the user is found (`*IN60 = *OFF`):

- Sets `p_okok` and `dsokok` to 0 (note: this is a legacy convention, see below).
- Populates all LDA fields with corresponding values from the user record.
- The environment variable (`dsmilj`) is set from the user record (`abmilj`), supporting multi-environment installations.

#### 3. User Not Found

If the user is not found:

- Sets `p_okok` and `dsokok` to 1.

#### 4. Special Handling for Network/System Users

```rpg
c                   eval      w_alfa = %subst(p_user:1:1)
c                   if        p_user = 'ASPKASSE  ' or
c                             p_user = 'NORGROS   ' or
c                             p_user = 'ASPRMI    ' or
c                             w_alfa = 'Q'
c                   eval      p_okok = 0
c                   eval      dsokok = 0
c                   endif
```
- Certain user IDs (`ASPKASSE`, `NORGROS`, `ASPRMI`) or any user starting with `Q` (system users) are always treated as "found", even if not in the registry.
- This supports integration/system users and IBM i system users bypassing normal registry checks.

#### 5. Program Termination

```rpg
c                   eval      *inlr = *on
c                   return
```
- Standard RPG program termination, setting LR indicator.

---

### Subroutine: Initialization (`*INZSR`)

- Zeroes the return code (`p_okok`).
- Sets up the parameter list (`plist`), mapping parameters to the program's internal variables.
- Defines the key list for file access.

---

## Notable Design Decisions & Conventions

- **Indicator Usage:**  
  - File indicators: 60–69  
  - Subroutine/working indicators: 70–99  
  - This is a consistent convention in this codebase.
- **LDA as Data Bus:**  
  - The LDA is used for passing user/session context between programs, which is a legacy but effective approach for tightly-coupled RPG applications.
- **Special User Handling:**  
  - System/integration users are handled via hardcoded IDs and patterns, allowing for operational flexibility.
- **Environment Variable (`dsmilj`):**  
  - Supports multi-environment installations (e.g., test, production) by storing the environment code in the LDA.
- **Return Code Convention:**  
  - Note that `p_okok = 0` means "user found", `p_okok = 1` means "not found". This is the reverse of many modern conventions and should be observed carefully.

---

## External Dependencies & Interactions

- **AUSRL1 File:**  
  - Central user registry, must be kept up to date with valid users.
- **Other Programs:**  
  - Programs that require user context will expect the LDA to be populated as described here.
- **No External APIs:**  
  - All logic is local to the IBM i system and the DB2 database.

---

## Business/Domain Specifics

- **User Registry:**  
  - Centralized control of user access, roles, and environment context.
- **Multi-Environment Support:**  
  - The program is designed to support installations where multiple environments (A01, A02, etc.) exist, critical for test/prod segregation.
- **Integration Support:**  
  - Explicit support for system and integration users, reflecting real-world operational needs.

---

## Maintenance Notes

- **Adding New Fields:**  
  - If new user attributes are needed, coordinate changes to the LDA with all consuming programs.
- **Changing User Handling Rules:**  
  - Any changes to the special user handling logic should be reviewed for operational impact.
- **Environment Expansion:**  
  - If new environments are added, ensure `dsmilj` is populated and interpreted correctly throughout the system.

---

## Summary

AA000R is a foundational program for user authentication and session context setup in our IBM i application suite. It is tightly integrated with the central user registry and relies on the LDA as a communication mechanism. It includes explicit handling for operational and integration users, and supports multi-environment installations. Understanding its conventions and central role is key for effective onboarding and maintenance.