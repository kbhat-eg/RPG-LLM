# RPG Program AN012R: Explanation

This RPG (Report Program Generator) program, named `AN012R`, is designed to generate a tailored *CL* (Control Language) program for night routines (nattrutiner), mainly for backup, subsystem management, and associated automated system maintenance jobs. It dynamically creates a series of CL commands based on input parameters, to be executed as a night job on IBM i (AS/400).

---

## 1. Header and Change Log

The comments at the top provide:
- **Description** ("Beskrivelse"): Generation of a night routine program.
- **Change Log**: Lists historical modifications, such as adding options for different backup routines, supporting multiple night jobs, enhancements for handling subsystems (like QINTER and QBATCH), and savefile management.

---

## 2. File Description

```rpg
fqcllesrc  o  a f  096        disk
```
- Defines an output file `QCLLESRC` (often used for CL source code), which the program will write generated output records to.

---

## 3. Data Structures and Variables

### A. Table of Program Lines

```rpg
d rec             s             80    dim(172) ctdata perrcd(1)
```
- `rec` is an array of 172 elements, each 80 characters wide.
- Each element represents a line or command to include in the generated CL program.

### B. Date Data Structure

```rpg
d                 ds
d d_dato                         6  0
d  d_aaar                        2  0 overlay(d_dato)
d  d_mmnd                        2  0 overlay(d_dato:3)
d  d_ddag                        2  0 overlay(d_dato:5)
```
- `d_dato` is a packed 6-digit date field, with overlays for year, month, and day.

### C. Options Data Structure

```rpg
d                 ds
d d_valg                       128
d  d_time                        6  0 overlay(d_valg)
d  d_dens                       11    overlay(d_valg:7)
d  d_rorg                        1    overlay(d_valg:18)
d  d_back                        1    overlay(d_valg:19)
d  d_ssbs                        1    overlay(d_valg:20)
d  d_prc1                        1    overlay(d_valg:21)
d  d_prc2                        1    overlay(d_valg:22)
d  d_genp                        1    overlay(d_valg:23)
d  d_savf                        1    overlay(d_valg:24)
d  d_smap                        1    overlay(d_valg:25)
d  d_natt                        1    overlay(d_valg:26)
d  d_strt                        1    overlay(d_valg:27)
d  d_slut                        1    overlay(d_valg:28)
d  d_pro1                        8    overlay(d_valg:31)
d  d_bib1                       10    overlay(d_valg:39)
d  d_sys1                        2    overlay(d_valg:49)
d  d_pro2                        8    overlay(d_valg:51)
d  d_bib2                       10    overlay(d_valg:59)
d  d_sys2                        2    overlay(d_valg:69)
```
- `d_valg` contains input parameters (likely from another calling program or a menu system).
- Individual options are overlaid on this field for easy access (e.g., `d_back` for backup, `d_savf` for savefile, etc.).

### D. Other Variables

- `p_valg`: Parameter string (128 chars)
- `n`: Loop counter
- `w_dato`, `w_tell`, `w_recc`: Working variables for date, record sequence, and output record buffer.

---

## 4. Program Flow

### Initialization

On program entry (`*inzsr`), working variables are cleared, the date structure is populated from system date functions, and the `d_valg` structure is initialized from the passed parameter `p_valg`.

### Main Logic: Generating Records for the CL Program

The code is a sequence of conditional blocks that each generate one or more output records, according to the options specified in `d_valg`. For each block:

- **FOR Loops**: Output specific lines (by index) from the `rec` array.
- **EXCEPT xrecut**: Writes a record to the output file, using the O-specifications (`xrecut`) to format the output line.

The different blocks represent different steps or options in the generated CL program:
- **Basic setup**: Always writes initial records.
- **Subsystem handling**: If `d_ssbs` = '1', include commands to stop and restart subsystems (QINTER, QBATCH).
- **Backup and savefile handling**: According to backup options (`d_back`, `d_savf`, etc.), choose different backup routines or savefile/tape management.
- **User-defined programs**: Optionally call user-specified start or end programs.
- **Special jobs & routines**: Run extra jobs, user routines, or routines from other systems, depending on `d_prc1`/`d_prc2`.
- **Reorganization, mapping, and other steps**: Run additional tasks as needed.
- **Confirmation and conclusion**: Output records signaling job end, and other finalization steps.

The logic allows the generated CL program to dynamically adapt to the specified night job scenario (e.g., tape backup, savefile backup, which routines to call).

---

## 5. Output Specifications (O-Specs)

```rpg
oqcllesrc  eadd         xrecut
o                       w_recc              96
o                       w_tell               6
o                       w_dato              12
```
- Defines the output record format for the `QCLLESRC` file.
- Each output record consists of: 
  - The generated CL source line
  - A sequence number
  - The date

---

## 6. Embedded CL Example

This is a sample of what might be output to the CL source file as a result of the RPG's logic:
```cl
PGM                                                 /*01*/
...
CALL       PGM(AN050R) PARM(&KODE &BIBL)            /*12*/
...
WRKACTJOB  OUTPUT(*PRINT) SBS(QINTER QBATCH)        /*14*/
...
ENDPGM                                             /*116*/
```
Each possible night job step is represented here, with substitutions as chosen by parameters:
- **Subsystem management**: Stopping/starting subsystems.
- **Backup routines**: Call to backup CL programs (e.g., ANBAC1/2/3).
- **Savefile handling**: Rename and copy savefiles, call to ANSAVF, etc.
- **Conditional steps**: Only executed if corresponding parameters are set.

---

## 7. Parameterization and Customization

The design allows for a high degree of customization:
- Which backup to run (standard, all users, specific routines)
- Whether to use savefile or tape
- Whether to include extra routines, reorganization, mapping
- Which "night job" program to use (controlled by `d_natt`)
- Subsystem control before/after backup

Input comes via a 128-char parameter, structured in fixed positions for each option.

---

## 8. Summary

**AN012R** is a code generator:  
- It collects processing instructions based on input parameters.
- It creates a tailor-made CL program for unattended nightly processing, maximizing automation and flexibility.
- The output CL program will be submitted as a batch job (night routine) to control system state, perform backups and maintenance, and restore normal operation at the end.

The RPG's main job is mapping high-level night-job choices to specific lines in the `rec` array, creating a custom CL program for each scenario.

---

## 9. Onboarding Tips

- **Study the `rec` array**: Each line is a CL command template, referenced by number in the RPG code.
- **Understand the parameter field (`d_valg`)**: Each option controls whether certain blocks of CL code are included.
- **Check data overlays**: Many small fields are mapped within larger fields for compact parameter passing.
- **Test with various parameters**: Observe the generated CL to see how options map to resulting job streams.
- **Enhancements**: To add new steps, code new lines into `rec` and add conditionals to the RPG logic.

---

With this structure, you can onboard quickly: The RPG decides what *to include*; the CL source in `rec` is *what gets included*. Changes for operational needs (new routines, conditions, etc.) are straightforward once you understand this pattern.