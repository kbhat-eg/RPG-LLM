# RPG Program FO531R – Explanation

This program, titled "ASOFAK Faktura, spørring" (Invoice, Inquiry), is written in legacy **ILE RPG** and handles inquiries on card payments (**Kortbetalinger**), utilizing subfiles for display and navigation in a green-screen environment (IBM i).

## General Structure

- **File Declarations (F-Specs):**
  - Multiple database files are defined (`bobli2`, `bobli1`, `bchei1`, `rkunl1`, `bokkl1`). These are referenced with aliases (via `RENAME`) for use in the program.
  - Workstation file (`fo531d`) is defined with subfile support (`sfile(b1sfl:w_srrn)`) and an information data structure (`infds(dspfbk)`).

- **Data Declarations (D-Specs):**
  - Parameters, local variables, keys, and constants are defined for handling business logic and subfile navigation.

- **Indicator Usage:**
  - The program makes extensive use of RPG indicators for screen control, errors, navigation, etc.

## Core Logic and Flow

### Initialization (`*inzsr`)
- Sets up all key lists for file access.
- Initializes variables from the local data area (retrieves company/firm code and year).
- Initializes subfile display by calling `crt_subfile` subroutine.

### Main Program Cycle
- The main logic involves an event loop, which:
  1. Handles screen display (subfiles and command panels).
  2. Processes function key input (paging, selection, inquiries, exit).
  3. Navigates and displays card payment records in a subfile.

#### Subfile Handling
Subfiles are displayed and managed as lists (pages) of card payment transactions that the user can scroll through, filter, and select:

- **Subfile Construction (`crt_subfile`):**
  - Fills the subfile with up to a set number (`c_sfil`) of valid card payment records from `bobli2`.
  - Each record is filtered:
    - Card payment types handled are `'98'`, `'97'`, `'96'`.
    - Further filtering by year (`f1aarr`), register (`f1kass`), and customer (`f1kund`), as needed.
    - Additional data is retrieved from related files for display (customer name, amount, etc).

- **Subfile Clearing (`clr_subfile`):**
  - Clears the subfile screen and resets page/record counters.

- **Subfile Paging (`bck_subfile`):**
  - Logic to page backwards by re-reading prior records and refilling the subfile accordingly.

#### Function Keys and Actions
- `*INKA`: Show filter window (`xf1win`).
- `*INKC`, `*INKL`: Exit program.
- `*INKE`: Refresh screen (`forny`).
- `*IN10`: Page down (`crt_subfile`).
- `*IN11`: Page up (`bck_subfile`).
- `*IN21`: Home key (set cursor).
- `*IN22`: Toggle subfile view indicator.

#### Subfile Record Actions
- **5=Show Payment Info**: Calls `xc2bld` to display details for a chosen payment.
- **7=Show Receipt (Bong)**: Calls an external program `'BO310R'` with relevant keys to show the receipt.

### Filtering and Inquiry
- **Inquiry Window (`xf1win`)**: Allows the user to specify filter criteria, which limit the records shown in the subfile via the `chk_subfile` subroutine.
- **Filter Subroutine (`chk_subfile`)**: Checks if a record should not be shown, based on year, register, or customer mismatch with filters.

### Key Data Structures

- **Information Data Structure (`dspfbk`)**: Obtains display feedback including function key pressed, screen row and column, etc.

- **Local Data Area**: Used for passing user, firm, and other global values into the program.

### Comments and Documentation

- The program is well-commented in Norwegian, explaining each section and the intended use of indicators, subfile variables, and the business context.
- The source header maintains a revision history.

---

## Key Terms

- **Subfile**: A temporary list of records displayed on a panel, which users can page through, filter, and select.
- **Bong**: Refers to a receipt number/record.
- **Kortbetaling**: Card payment.
- **Kasse**: Register/cash terminal.
- **Kunde**: Customer.

---

## Summary Table – Important Subroutines

| Subroutine     | Purpose                                                            |
|:---------------|:-------------------------------------------------------------------|
| `crt_subfile`  | Fill subfile with payment records                                  |
| `clr_subfile`  | Clear subfile and reset counters                                   |
| `bck_subfile`  | Page backward in subfile                                           |
| `chk_subfile`  | Check if current record matches filter/show criteria               |
| `dsp_subfile`  | Display subfile on terminal                                       |
| `xc2bld`       | Display payment information for a specific record                  |
| `forny`        | Refresh subfile from current position                              |
| `posisjoner`   | Position subfile based on filters or entered keys                  |
| `vis_bong`     | Display receipt (calls external program)                           |
| `spørring`     | Call customer inquiry program (`RK500R`) for customer search       |
| `xf1win`       | Show filter window and process filter changes                      |

---

## Onboarding Suggestions

- The core logic heavily relies on **subfiles** and **indicator-based UI control**. Familiarize yourself with indicator usage, subfile patterns in RPG, and typical database access methods (CHAIN, SETLL, etc.).
- All database access is performed through keyed access (`CHAIN`, `SETLL`, `READ`, `READC`, etc.), and keys are built using key lists.
- The user navigates using function keys mapped to standard actions (refresh, page, inquiry, etc.).
- The subfile logic is modularized into subroutines for clarity and reuse.
- External programs are called for detailed views (`BO310R`) and customer search (`RK500R`).

---

This program is a classic example of green-screen application logic for transaction inquiry and navigation, widely used in IBM i midrange systems.