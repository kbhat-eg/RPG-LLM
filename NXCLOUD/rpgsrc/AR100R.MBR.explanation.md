# Overview

This ILE RPG program (`AR100R`) is a display file application using subfiles to maintain ("vedlikehold") some kind of environment ("miljø") and version data, stored in multiple physical and logical files (`amill1`, `amill2`, `amillr`, `amillu`).  
The program interacts with a workstation (green screen) and supports standard subfile navigation and record maintenance (Add, Change, Copy, Delete, View).

## File Declarations

- `amill1`, `amill2`, `amillr`, `amillu`: Database files (physical/logical), opened for input (`if`) or update (`uf`) operations, with different keys and record formats (`rename()`).
- `ar100d`: Display file (workstation), using a subfile (`sfile(b1sfl:w_srrn)`), feedback data structure (`infds(dspfbk)`).

## Indicator Usage

Indicators (`*INxx`) are used to control function keys, subfile operations, and error/status indicators:

| Indicator | Usage                                 |
|-----------|---------------------------------------|
| LR        | End program                           |
| 10-15     | Paging/navigation/subfile controls    |
| 21-22     | Cursor and home                       |
| 30        | Protect fields on display             |
| 31-79     | Messages, screen indicators           |
| 80-99     | Work indicators                       |

## Data Structures & Variables

- **LDA (Local Data Area):** Used to get user info (user ID, firm number, etc.).
- **Display Feedback:** `dspfbk`—contains field for current record number, used for positioning in subfiles.
- **Key Variables:** For setting up keys to access the different files based on environment/version.
- **Working Variables:** For subfile paging, navigation, and temporary flags (e.g., `b_oppr` - add mode, `b_forn` - refresh needed).

## Main Program Flow

### Program Initialization (`*inzsr`)

- Sets up key lists for database access.
- Reads values from LDA (commented out in this version).
- Initializes screen indicators.
- Positions database and fills the subfile with initial data.

### Main Control Loop

The main entry logic (after tags and comments) is a selection loop that:

- Displays command screen (`b2cmd`).
- Calls subroutines to display the subfile/list of entries.
- Handles function key processing:
  - F3/F12 (`*INKC`, `*INKL`): Exit program
  - F5 (`*INKE`): Refresh/renew
  - F6 (`*INKF`): Add new
  - RollUp/RollDown (`*IN10`, `*IN11`): Page up/down in the subfile
  - Home (`*IN21`): Home navigation
- Allows for direct positioning in subfiles by user input.

### Subfile Processing

#### Refresh Subfile (`forny`)

- Chains to the subfile record if necessary.
- Determines if the list should be positioned by version or environment.
- Clears and recreates the subfile records (calls `clr_subfile` + `crt_subfile`).

#### Positioning Subfile (`posisjoner`)

- Positions the subfile based on input (environment or version).
- Clears out filters afterwards.

#### Subfile Handler (`subfile`)

- Loops through the subfile records, processing user actions:
  - Change (`b1valg = 2`): Edit record (`xc2bld`).
  - Copy (`b1valg = 3`): Copy record (`xk1win`).
  - Delete (`b1valg = 4`): Delete record (`xd1win`).
  - View (`b1valg = 5`): View record details (`xc2bld`).

### Screen/Window Handlers

#### Add New (`xc1bld`)
- Handles insert screen for new environment.
- Checks for duplicates and presents error message (`xc1msg`).
- Calls the main maintenance screen if the new key passes validation.

#### Maintenance Screen (`xc2bld`)
- Handles change/view/copy operations for a record.
- Updates or writes new records as required.
- Populates subfile with updated contents.

#### Delete Window (`xd1win`)
- Presents delete confirmation and processes a delete.

#### Copy Window (`xk1win`)
- Handles copying an existing record to a new key (environment).

#### Message Window (`xc1msg`)
- Simple modal message screen when trying to add a duplicate, to prompt user.

### Subfile Maintenance

#### Clear Subfile (`clr_subfile`)

- Triggers the subfile clear indicator and writes the subfile control record.
- Resets relevant paging/indexing variables.

#### Create Subfile (`crt_subfile`)

- Loops reading records from the current position.
- Fills the subfile by writing each record to the display file.
- Handles end-of-file and record limit for one "page".

#### Page Back in Subfile (`bck_subfile`)

- Handles reading previous records for "page up" navigation.
- Repositions keys and repopulates the subfile as necessary.

#### Display Subfile (`dsp_subfile`)

- Sets necessary indicators and formats the control screen for the subfile display.
- Updates the current record number for cursor positioning.

## Special Notes

- **Norwegian Comments:** The code and comments are partly in Norwegian, describing business rules and field behaviors.
- **Use of Indicators:** This is classic "cycle" RPG with heavy use of indicators, typical for green screen applications.
- **Error/Condition Handling:** Uses separate indicators to highlight errors or status on the screen.
- **Subfile Logic:** Follows the typical IBM i subfile patterns, including clear-fill-display cycles for paging and refresh.
- **Parameterization:** Some code involving firm (`w_firm`, `ahfirm`) is commented out, indicating possible adaptation for different customers/sites.

## Conclusion

This program is a fairly standard RPG display file management program for list/data maintenance using subfiles, implementing add/edit/copy/delete/view logic. Navigation and workflow are highly indicator-driven and rely on subroutine structure for reuse and modularity.

### Useful Reading

- IBM i Subfile Programming
- RPG IV (ILE RPG) Cycle and Indicator programming
- Workstation file programming with INDS (feedback data structures)
- RPG code conventions for screen and database file handling

---

**If you're onboarding:**  
- Focus first on understanding the subfile loop (main interaction is through paging, editing, and function keys).
- Review the variable naming conventions; they're consistent (e.g., `b1*` for subfile, `c1*`, `c2*` for different screens).
- Pay attention to which subroutines are called on each function key press, as that's the heart of the maintenance logic.
- Note the use of various key lists to access the proper records in the database.  
- Read up on the indicator numbers and their effect on the display file and business process.