# Explanation of RPG Program `mm401R`

This RPG (ILE RPG IV, or RPGLE) program is written for IBM i (AS/400) systems. Its purpose appears to be "cleaning up old ABC codes per parameter" (`Rydder i gamle abckoder pr. parameter`). It works on product files and by selection criteria, resets specific ABC codes in the product and stock records.

## High-Level Overview

- The program reviews items/products based on various grouping and supplier criteria specified in the input parameter.
- Selection can be by assortment, group, high group, or subgroup.
- For matched items/products, it nullifies (clears) certain ABC codes depending on parameters.
- Data access is via keyed database files.
- Parameters to the program determine which ABC code (P or S) to clear and what selection/grouping to operate on.

---

## Main Sections

### 1. File Declarations

```rpg
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvvarlr    if   e           k disk    rename(vvarpfr:vvarlrr)
fvvarl8    if   e           k disk    rename(vvarpfr:vvarl8r)
fvvarla    if   e           k disk    rename(vvarpfr:vvarlar)
fvsdtl6    if   e           k disk    rename(vsdtpfr:vsdtl6r)
fvlaglu    uf   e           k disk    rename(vlagpfr:vlaglur)
fvvarlu    uf   e           k disk    rename(vvarpfr:vvarlur)
```
- Program works with several product, assortment, group, stock, and supplier files, usually renamed for record format clarity.

---

### 2. Data Declarations

#### a) Work Variables
- Many fields (e.g., `w_ogrp`, `w_hgrp`) are defined as `LIKE()` fields from file records for consistent typing.
- Parameter area (`w_list`, etc.) for passing in selection criteria.

#### b) Data Structures
```rpg
d                 ds
d d_list                    128
d  d_vsor                   10    overlay(d_list)
d  d_ogrp                    2  0 overlay(d_list:11)
d  d_hgrp                    2  0 overlay(d_list:13)
d  d_ugrp                    3  0 overlay(d_list:15)
d  d_lage                    2    overlay(d_list:18)
d  d_pabc                    1    overlay(d_list:20)
```
- Parses the parameter string into fields: assortment, group, high group, subgroup, warehouse, and 'which ABC code' to nullify.

---

### 3. Main Program Logic

#### Mainline:

```rpg
if d_vsor <> *blank or d_ogrp <> 0 or d_hgrp <> 0 or d_ugrp <> 0
    exsr les_utvalg
else
    read vvarl1
    dow not %eof
        exsr beh_vare
        read vvarl1
    enddo
endif
```
- If selection (`d_vsor`, `d_ogrp`, etc.) is set, calls `les_utvalg` to start by selection. Otherwise, processes all items in the main product file.

---

### 4. Selection and Processing Subroutines

#### a) les_utvalg
- Decides _how_ to select the products/items based on the parameter fields, calling other subroutines such as:
  - `les_vsor` (assortment)
  - `les_ugr` (subgroup)
  - `les_hgr` (high group)
  - `les_ogr` (group)

#### b) les_vsor (Read by assortment)
- Reads the assortment file (`vsdtl6`)
- Depending on the record's contents (supplier, group, etc.), dispatches to the appropriate subroutine to process:
  - Exact item
  - Subgroup
  - Highgroup
  - Group
  - Supplier
- Handles cases both with and without supplier specified.

#### c) les_ugr, les_hgr, les_ogr, les_ldor, etc.
- These subroutines iterate through product files based on the relevant key (group, high group, etc).
- Some have a `_l` (with supplier) variant.

---

### 5. beh_vare (Process Item)
- Central routine to perform the actual nullification of ABC codes.
- First checks whether a warehouse is specified. If yes, works in the warehouse file (`vlaglu`). If not, works in the product file (`vvarlu`).
- Conditional logic:
  - If parameter `d_pabc` = 'P': clear the `vlkabc` field.
  - If parameter `d_pabc` = 'S': clear the `vltabc` field.
  - Only clears code if the existing `vllabc`/`vvlabc` field is 0.
- Performs record update after clearing the code.

---

### 6. Initialization (*INZSR)
- Defines all key lists used for file searches.
- Parameter string is parsed into the data structure fields.
- Fetches the company/firm number from the LDA area.

---

## Key Data Flow

1. **Parameter Input (w_list → d_list → overlays)**
   - The program is called with a string parameter containing field values controlling selection behavior and which ABC code to clear.
2. **Selection**
   - Based on the parsed fields, an appropriate subroutine is called to iterate through matching products/items (using group/assortment/supplier keys).
3. **Processing**
   - For each qualifying product/item, `beh_vare` is called to potentially nullify a specific ABC code field, depending on the parameter.

---

## Technical Features and Notes

- **File Access:** Makes extensive use of keyed file access (`setll`, `reade`, and `chain`) for efficient lookups and iteration.
- **Parameterization:** Uses a parameter data structure for flexible control.
- **Norwegian Comments:** Original documentation and comments are in Norwegian; variable/field names likely reflect Norwegian business terms.
- **Expansion:** The program has evolved over time, with notes about handling combinations of supplier and groups, and an extra parameter to select which ABC code to clear.

---

## Typical Usage Scenario

- *Batch cleaning of item codes:* Run by operations/IT to programmatically clean certain ABC (classification) codes for items that match supplied group, assortment, or supplier criteria—useful in master data management.

---

## Summary Table: Key Subroutines

| Subroutine    | Purpose                                               |
|---------------|-------------------------------------------------------|
| les_utvalg    | Entry point to selection logic, routes by parameter   |
| les_vsor      | Iterates product assortment by assortment key         |
| les_ugr(_l)   | Iterates by group/high group/subgroup (optionally supplier) |
| les_hgr(_l)   | Iterates by high group (optionally supplier)          |
| les_ogr(_l)   | Iterates by group (optionally supplier)               |
| les_ldor      | Iterates by supplier                                  |
| beh_vare      | Checks and blanks relevant ABC code for a product     |

---

## TL;DR

**This program is for mass-updating (clearing) classification (ABC) codes in product and warehouse records on IBM i, driven by flexible selection criteria passed in a parameter. It iterates through product records that match group/assortment/supplier filters and clears one of two ABC codes as specified.**