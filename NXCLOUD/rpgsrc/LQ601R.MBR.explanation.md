# Program LQ601R – Inventory Transaction List Printout

## Overview

This RPG program (`LQ601R`) generates a printed report listing inventory transactions ("lagertransaksjons-liste") for a given inventory batch. The report includes a header, detailed transaction lines, and a total section. It is designed for the ASLAGR system and interacts with multiple master and transaction files to retrieve and present data.

The program is modular, with clear separation between data retrieval, business logic (such as unit conversions), and report formatting. It also contains several business-specific conventions, such as handling of "blank" types and inheritance of values from headers to details.

---

## File Definitions and Interactions

The program uses several externally described files, each renamed for internal clarity. The files and their roles are:

- **LSTSL1 (lstspfr:lstsl1r):** Inventory status codes, used for status lookups.
- **LLHEL1 (llhepfr:llhel1r):** Inventory batch header (LAGERBUNT-HODE).
- **LLDTL1 (lldtpfr:lldtl1r):** Inventory batch lines (LAGERBUNT-LINJE), the transaction details.
- **VVARL1 (vvarpfr:vvarl1r):** Item master (VARE).
- **VVENL1 (vvenpfr:vvenl1r):** Item unit master (VARE-ENHET).
- **VVLEL1 (vvlepfr:vvlel1r):** (6.30+) Timber assortment extension, used for extended item information.
- **LQ601P:** Printer file for report output.

There is also a call to the external program `VL710R` to fetch additional item information, especially for price group and extended item data.

---

## Parameters and Data Structure

- **Input Parameter:** The program receives a 64-byte parameter block (`w_parm`) from a previous program, which is unpacked into:
  - `d_numm` (8,0): Batch number.
  - `d_kode` (1): Report type code (used to distinguish between control and receipt reports).
- **Local Data Area:** Used to fetch the current company (`l_firm`) and company name (`l_navn`).

---

## Key Business Logic and Flow

### 1. Initialization (`*INZSR`)

- **Parameter Handling:** Retrieves and unpacks the incoming parameter.
- **Key Setup:** Prepares key lists for all files, using the company number and batch/item codes as appropriate.
- **Status Lookup:** Fetches status code information for later use in the report header.

### 2. Report Header (A1HDR)

- **Header Data:** Reads batch header (`LLHEL1`) and populates report fields (batch number, type, text, user, workstation).
- **Conditional Heading:** Sets a flag (`*IN41`) based on `d_kode` to distinguish between "Kontroll" (control) and "Kvittering" (receipt) reports.
- **Prints Header:** Outputs the header section.

### 3. Detail Lines (D1DET)

- **Detail Loop:** Iterates through all batch lines (`LLDTL1`) for the selected batch.
- **Unit Conversion:** Calls subroutine `omr_antall` to convert transaction quantity from the registered unit to the warehouse unit, using conversion factors from `VVARL1` and `VVENL1`. Handles special cases for "diverse" item types and calls external program `VL710R` for additional item data as needed.
- **Field Population:** Fills in the detail format fields with transaction data, inheriting values from the header if certain fields are blank or zero.
- **Transaction Type Handling:** 
  - Identifies "text" lines (`type = 'TX'`) and "transfer" lines (`type = 'O '`), setting corresponding indicators.
  - Sets the transaction type text (`d1otxt`) based on the type code, using the `ltx` array loaded from compile-time data.
- **Overflow Handling:** If the print line count overflows (`*IN30`), the header is reprinted.
- **Prints Detail:** Outputs the detail line.

### 4. Totals (T1TOT)

- **Prints Totals:** At the end of the detail lines, prints the total section.

### 5. Program End

- **Cleanup:** Sets the last record indicator (`*INLR = *ON`) to end the program.

---

## Subroutines

### omr_antall – Unit Conversion

Handles conversion of transaction quantity from the registered unit to the warehouse unit:

- Fetches item master and unit master data.
- If units match or item is "diverse," no conversion is needed.
- Otherwise, fetches item type via external program `VL710R` (with extended parameters for timber assortment, etc.).
- Looks up conversion factors in `VVENL1` for both units.
- Performs the conversion: `w_anta = lsanta * w_omrl / w_omrs`.
- Handles missing or zero conversion factors gracefully.

---

## Notable Design Decisions and Conventions

- **Header Inheritance:** When detail fields (type, warehouse, warehouse-to) are blank or zero, values are inherited from the batch header. This ensures data consistency and reduces data entry requirements.
- **Transaction Type Handling:** The program uses a compile-time array (`ltx`) for mapping type codes to human-readable texts, supporting easy maintenance and localization.
- **External Program Call:** `VL710R` is used for fetching item type and extended item information, supporting price group and timber assortment logic.
- **Indicator Usage:** Classic RPG indicators are used for report formatting and control flow, consistent with legacy RPG conventions.
- **Versioning and Extensions:** The codebase is annotated with version comments (e.g., "6.30") marking business-driven extensions, such as timber assortment support.

---

## File Relationships

- **LLHEL1** (header) and **LLDTL1** (details) are related by batch number and company.
- **VVARL1** and **VVENL1** provide item and unit master data, required for detail line enrichment and unit conversion.
- **VL710R** is an external program providing additional item metadata.

---

## Business Domain Notes

- **Inventory Batches:** The system organizes inventory transactions in "batches" (bunter), each with a header and multiple detail lines.
- **Unit of Measure:** The program supports conversion between registered and warehouse units, critical for accurate reporting and stock management.
- **Timber Assortment:** Recent extensions (6.30) support timber-specific item details, reflecting domain-specific requirements.

---

## Format Usage

- **A1HDR:** Report header.
- **D1DET:** Detail transaction line.
- **T1TOT:** Totals section.

---

## Compile-Time Data

- The `ltx` array holds transaction type texts (e.g., Feilkode, Inngang, Uttak, Justering, Overføring), loaded at compile time for mapping type codes in the report.

---

## Summary

This program is a robust, business-driven report generator for inventory transaction batches, designed for extensibility and integration with master data and external item logic. It demonstrates standard patterns for RPG reporting, data inheritance, and unit conversions, with careful annotation for business-specific extensions and maintenance.