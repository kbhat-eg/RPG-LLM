# SC110R – Maintenance of Budget Register (`Vedlikehold av budsjett-register`)

## Overview

This RPG program, part of the **ASSTAT** system, is responsible for the maintenance (create, read, update, delete) of records in the budget register. The program provides a subfile-based interactive interface for users to manage budget entries, including detailed logic for validation, distribution, and calculation of budget amounts across periods and keys.

**Key Features:**
- Subfile-driven maintenance of budget records.
- Validation against multiple code registers (department, warehouse, order type, etc.).
- Support for various budget distribution keys and methods.
- Interaction with several master data files for referential integrity.
- Modular design with subroutines for key business logic.

---

## File Definitions and Relationships

### Display and Subfile
- **`sc110d`**: Workstation file, main display, uses subfile `b1sfl` for listing and maintaining budget entries.

### Master Files (Validation and Lookup)
- **`rlevl1`**: Supplier register.
- **`votyl1`**: Order type register.
- **`vhgrl1`**: Main group register.
- **`vogrl1`**: Over-group register.
- **`vugrl1`**: Subgroup register.
- **`vvarl1`**: Item register.
- **`ra13l1`**: Budget key register.

### Transaction/Accumulation Files
- **`slakl1`**: Supplier accumulation register (monthly values).
- **`slbul1`**: Budget register (main file for maintenance).
- **`slbulu`**: Budget register update file (for write/update operations).

**Note:** Files are opened in various modes (input, update, etc.) and often renamed for local record format clarity.

---

## Data Structures and Variables

- **Arrays:** Used extensively for months (12 elements), distribution keys, and temporary calculations.
- **Display Variables:** For subfile row numbers, page numbers, command key handling, and display texts.
- **Key Fields:** Variables for all key parts of the budget file, facilitating searches and updates.

---

## Program Flow and Main Routines

### Entry Point (`*ENTRY` PLIST)
- Receives context parameters: year, version, code, and a flag for amount/unit handling.
- Initializes working variables and loads the initial subfile contents.
- Sets up display headings and command key labels.

### Main Loop and Subfile Processing
- **Display subfile (`xdsp01`):** Presents the user with a list of budget records filtered by the current key context.
- **User Actions:** Handles create, change, copy, delete, roll, home, and positioning commands.
- **Validation:** Each field can be validated interactively against its respective register.

### CRUD Operations

#### Create (Add new record)
- **`xm1bld` / `xm2bld`:** Handles the display and validation of all fields required for a new budget entry, including context-sensitive lookups.
- On successful validation, invokes the update routine.

#### Change (Edit existing record)
- **`xc2bld`:** Main routine for editing a budget entry. Handles:
  - Field validation.
  - Budget key lookup and distribution calculation.
  - Conflict checks (cannot use both distribution key and method).
  - Update or insert logic for the budget file.
- Handles display of multiple columns (years/periods), copying values between columns, and command key cycling.

#### Copy
- **`xk1win`:** Handles copying an existing record to a new key. Checks for duplicate before writing.

#### Delete
- **`xd1win`:** Handles deletion with confirmation, and cascades to delete all matching records by key.

---

## Business Logic Highlights

### Budget Key and Distribution

- **Distribution Key (`fordelingsnøkkel`):**
  - If a key is used, retrieves the distribution percentages from `ra13l1` and applies them to the total budget amount.
  - Key value `99` means equal distribution across all periods.

- **Distribution Method (`fordelingsmetode`):**
  - Supports predefined methods (e.g., distribute over 1, 2, 3, 4, or 6 periods).
  - Ensures that, if a distribution method is used, a period and amount must be entered.

- **Validation Logic:**
  - Cannot use both a distribution key and a distribution method simultaneously.
  - If either is used, the corresponding required fields (amount, period) must be entered.

### Referential Integrity

- On field entry (department, warehouse, order type, etc.), the program validates the value against the appropriate master file or via external programs (e.g., `RS707R` for department).
- If not found, sets error indicators to prompt the user.

### Subfile Handling

- **`xclr01`**: Clears the subfile and related counters.
- **`xcrt01`**: Populates the subfile with records that match the current key context, up to a page limit.
- **`hnttxt`**: Fetches and formats descriptive text for display columns based on the current sort/order selection.

### Column and Period Handling

- The display supports four columns, typically representing four consecutive years (or periods).
- The user can navigate to previous/next years, copy values between columns, or edit a specific column.

---

## External Program Calls

- **`RS707R`, `RS708R`, `RS709R`, `RS710R`, `RS711R`, `RS712R`, `RS714R`**: Various lookup and validation routines for master data.
- **`RA513R`**: Maintains and retrieves budget distribution keys.

---

## Error and Message Handling

- **Indicator Bits (`*INxx`):** Used extensively for field validation errors, display control, and command key handling.
- **Message Arrays (`mld`, `txt`, `cmd`, `rpt`):** Hold static messages, labels, and command key texts for display use.

---

## Notable Design Patterns and Conventions

- **Subfile Pattern:** Central to the user interface, enabling list-based navigation and selection.
- **Modular Validation:** Each field is validated in its own block, often via external program calls or file lookups.
- **Key Structure:** All files use composite keys based on the business context (firm, year, version, department, etc.), ensuring data integrity and precise updates.
- **Array-based Calculations:** Budget amounts and distributions are handled via arrays indexed by period/month.

---

## Interactions and Integration

- **Master Data:** The program depends on accurate and up-to-date master data for all code fields; changes in master files will affect validation logic.
- **Other Modules:** This program is typically called from a higher-level menu or process, passing context parameters for the budget maintenance session.
- **Data Consistency:** All CRUD operations ensure that only valid, referentially correct data is written to the budget register.

---

## Summary Table of Key Files and Their Roles

| File      | Purpose / Data Held                               | Used for                |
|-----------|---------------------------------------------------|-------------------------|
| `slbul1`  | Budget register                                   | Main CRUD operations    |
| `slbulu`  | Budget register (update)                          | Writing/Updating        |
| `slakl1`  | Supplier accumulation (monthly)                   | Calculations, display   |
| `rlevl1`  | Supplier master                                   | Validation, lookup      |
| `votyl1`  | Order type master                                 | Validation, lookup      |
| `vhgrl1`  | Main group master                                 | Validation, lookup      |
| `vogrl1`  | Over-group master                                 | Validation, lookup      |
| `vugrl1`  | Subgroup master                                   | Validation, lookup      |
| `vvarl1`  | Item master                                       | Validation, lookup      |
| `ra13l1`  | Budget distribution keys                          | Distribution logic      |

---

## Guidance for New Developers

- **Follow the key structure conventions** when searching, updating, or deleting budget records. All lookups are composite and context-sensitive.
- **Understand the business meaning** of each code field (department, warehouse, etc.) and the importance of referential integrity.
- **Use the provided subroutines** for validation and calculations; do not duplicate logic.
- **When adding new distribution methods or keys**, ensure both the calculation and validation logic are updated.
- **When modifying display logic**, be mindful of the subfile and command key cycling patterns.

---

## Typical Workflow

1. **User enters the budget maintenance screen** for a specific context (year, version, code).
2. **Subfile is populated** with matching records.
3. **User can add, change, copy, or delete** budget entries.
4. **Each field is validated** against master data; errors are flagged interactively.
5. **On save/update, budget amounts are distributed** per key or method.
6. **All changes are written back** to the budget register with full key context.

---

## Conclusion

This program is central to the financial planning process, ensuring that budget data is accurate, validated, and distributed according to business rules. Its modular, subfile-driven design supports efficient, error-resistant maintenance of complex budget structures. Developers should familiarize themselves with the key structures, validation subroutines, and the interplay between budget records and master data to maintain and extend this program effectively.