# Documentation: RPG Program JC100R

## Overview

This program, **JC100R**, is the main interactive maintenance and inquiry program for "påslag" (markup/price addition), used in the ASVADM system. Its function is to allow users to view, add, update, copy, and delete markup records at various hierarchical levels (such as price group, group, main group, subgroup, supplier, module, item, price code, item type, delivery type).

It is designed as a subfile-based application, supporting advanced navigation, filtering, and validation for complex business rules regarding markups and their applicability.

## Business Domain

- **Påslag** refers to price markups applied at different levels for items, suppliers, groups, etc.
- The system supports a hierarchy: Price Group > Overgroup > Main Group > Subgroup > Supplier > Module > Item > Price Code > Item Type > Delivery Type.
- Markups can be maintained at any level, with specificity increasing down the hierarchy.
- Filtering and navigation are key features, as users may need to find or maintain markups at any level or combination.

## Key Features

- **Subfile-based display** with paging, roll, and position-to functionality.
- **CRUD operations**: Create, Read/View, Update, Delete, and Copy markups.
- **Filtering**: Users can filter the subfile contents by any combination of hierarchical fields.
- **Validation**: All input is validated against master tables; business rules are enforced, including checks for logistics items, valid price codes, etc.
- **Integration**: Calls out to several lookup programs for master data selection (groups, suppliers, modules, items, etc.).

## File and Data Structure Relationships

- **Primary file**: `jpfalr`, `jpfalu`, ... (`jpfapfr` physical file, various logicals). These hold the markup records at various key levels.
- **Master files**: `jlevl1` (supplier), `jmodl1` (module), `jvarl1` (item), and others for groupings and codes.
- **Subfile**: `b1sfl` (displayed via workstation file `jc100d`).
- **Supporting files**: For group, item type, delivery type, price group, etc.
- **SQL**: Used for some lookups and validation, especially for logistics item checks and advanced filtering.

## Indicators and Conventions

- **Indicators** are used for subfile and screen control, error signaling, and workflow state:
    - `LR`: End of program.
    - `10, 12, 13, 14, 15, 16, 21, 22, 30`: Subfile and screen state control.
    - `31-79`: Error and warning signaling.
    - `80-99`: Work indicators.

- **Screen layouts**:
    - `B1SFL`: Subfile record.
    - `B2CTL/B2CMD`: Subfile control/command.
    - `C1BLD`, `C2BLD`, `D1WIN`, `K1WIN`: Create, update/view, delete, and copy screens.
    - `C1MSG`: Message screen for create.

## Program Structure

### Initialization (`*inzsr`)

- Sets up all key lists for file access.
- Retrieves firm number from LDA.
- Initializes subfile state and positions to the top of the markup file.

### Main Loop

- **Entry point**: `b2taga`/`b2tagb` tags.
- **Screen flow**: Alternates between command screen and subfile display.
- **Function key handling**: Selects subroutines for add, edit, copy, delete, filter, roll, back, position-to, etc.
- **Positioning**: If any position-to fields are filled, positions subfile accordingly.

### Subfile Handling

- **`subfile` subroutine**: Handles readc loop for subfile, processes user actions (edit, copy, delete, view, show module items).
- **`clr_subfile` / `crt_subfile`**: Clears and populates the subfile, with support for filtering and paging.
- **`bck_subfile`**: Handles paging backward.

### CRUD Operations

- **Create**: `xc1bld` subroutine manages the create screen, validates input, checks for duplicates, and calls update logic.
- **Update/View**: `xc2bld` manages update/view logic, including field population, validation, and database update.
- **Delete**: `xd1win` manages the delete screen and removes records.
- **Copy**: `xk1win` manages the copy screen, ensures no duplicate, then invokes update.

### Validation and Lookup

- **`sjekk_input`**: Validates and resolves all input fields, ensuring they exist in master files and conform to business rules (e.g., only allowed price codes/types, not a logistics item, etc.).
- **`hent_info`**: Fetches and populates descriptions for all hierarchical fields for display purposes.

### Filtering

- **`xf1win`**: Handles filter screen, validates filter combinations, and applies filter criteria to subfile population.

### Integration with Other Modules

- **Master data lookups**: Calls to programs like `VG510R`, `VG511R`, `VG512R`, `JL500R`, `JU500R`, `JV500R`, `VA560R`, `VA570R`, `VY500R`, `RA530R` for group, supplier, module, item, price code/type, delivery type, and price group selection.
- **Module item display**: Calls `JV548R` to show items under a module.
- **Logistics item logic**: Advanced SQL checks to ensure only "real" items are handled, not logistics items.

## Notable Design Patterns and Decisions

- **Hierarchical keying**: Markup records are keyed at multiple levels, allowing for maintenance at any specificity.
- **Subfile paging and positioning**: Implemented via record number tracking variables and explicit setll/read/readp logic.
- **Field validation**: Centralized in `sjekk_input`, with error indicators mapped to specific screen messages.
- **Modular screen handling**: Each screen (create, update, delete, copy, filter) has its own subroutine, with consistent field population and validation.
- **Error signaling**: Uses indicators both for display and for controlling flow after errors.

## Domain-Specific Logic

- **Logistics items exclusion**: Enforced via SQL checks; only "real" (non-logistics) items are allowed for markups.
- **Allowed price codes/types**: Only certain codes/types are valid for markups, enforced in validation.
- **Flexible filtering**: Users may filter by any combination of hierarchical fields, with validation to prevent inconsistent combinations.
- **Supplier logic**: Allows for supplier without item group as a valid level.

## Key Variables

- **w_***: Working variables for current/selected values.
- **b1***: Subfile fields (for each row).
- **c1***, **c2***, **d1***, **k1***: Fields for create, update/view, delete, and copy screens.
- **f1***: Filter fields.
- **jpfalr_***, **jpfalu_***, etc.: Key variables for file access at different levels.

## SQL Integration

- Used for advanced lookups, especially for logistics item checks and filtering based on item relationships (`jvklpf`, `jvkhpf`).
- SQL options set for Norwegian language and ISO date format.

## Versioning and Comments

- The code includes detailed version history and comments in Norwegian, documenting changes, bug fixes, and enhancements.
- Comments explain the purpose of fields, indicators, and subroutines.

---

## Summary Table: Main Hierarchy and Related Lookups

| Level         | Field(s)     | Lookup/Validation File | Lookup Program |
|---------------|--------------|-----------------------|---------------|
| Price Group   | prgr         | ra30l1                | RA530R        |
| Overgroup     | ogrp         | vogrl1                | VG510R        |
| Main Group    | hgrp         | vhgrl1                | VG511R        |
| Subgroup      | ugrp         | vugrl1                | VG512R        |
| Supplier      | ldor         | jlevl1                | JL500R        |
| Module        | modn         | jmodl1                | JU500R        |
| Item          | vare         | jvarl1                | JV500R        |
| Price Code    | kpri         | vpkol1                | VA560R        |
| Item Type     | vtyp         | vvtyl1                | VA570R        |
| Delivery Type | lety         | vltpl1                | VY500R        |

---

## Tips for New Developers

- **Understand the hierarchy**: Markups can be set at any level; keys and subfiles are structured accordingly.
- **Follow the indicator conventions**: Error and state signaling are critical for both flow and user feedback.
- **Screen navigation**: Each screen/subfile action is handled in its own subroutine; follow the tags and indicator logic for understanding flow.
- **Master data dependencies**: Many fields are validated or populated via lookups/calls to other modules—be aware of these relationships.
- **When modifying**: Always ensure new fields or logic are validated and integrated into the correct subroutines, and update key lists if needed.

---

## References

- **VG510R, VG511R, VG512R**: Group selection programs.
- **JL500R, JU500R, JV500R**: Supplier, module, item selection.
- **VA560R, VA570R, VY500R, RA530R**: Price code/type, delivery type, price group selection.
- **JV548R**: Display items under a module.
- **jvklpf, jvkhpf**: Used in SQL for logistics item checks.

---

**This program is central for maintaining markups and their hierarchical relationships. It is highly integrated with master data and enforces business rules through validation and screen logic.**