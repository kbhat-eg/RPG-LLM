# MB700R â€“ Documentation

## Overview

**Program:** MB700R  
**System:** ASLOGI  
**Purpose:** This program serves as a batch driver to initiate and coordinate the MB701R analysis process. It reads a set of ABC parameter records, prepares and passes analysis parameters to MB701C (likely a called program), then aggregates and updates ABC/XYZ classification counts in summary tables.  
**Business Context:** This is part of an inventory or warehouse management solution, likely dealing with ABC/XYZ analysis of stock items across various groupings (warehouse, group, subgroup, etc.).

---

## File Definitions

- **mabcl1**: Input file, primary ABC parameter table (`mabcpfr` physical file, renamed as `mabcl1r`).
- **mabdl2**: Input file, ABC detail records (`mabdpfr` physical file, renamed as `mabdl2r`).
- **mabclu**: Update file, ABC summary records (`mabcpfr` physical file, renamed as `mabclur`).

**Note:** The use of `rename` allows multiple logical views of the same physical file.

---

## Data Structures & Variables

### Arrays

- `a_lage(10)` / `a_ltyp(10)`: Hold up to 10 warehouse/group codes and types for parameter passing.

### Working Variables

- Variables like `w_totax`, `w_totay`, ..., `w_totcz`: Totals for each ABC/XYZ combination.
- `w_lagk`, `w_vsor`, etc.: Working (key) fields for passing to file operations.

### Data Structures

- **d_list**: A 128-byte structure for passing a parameter block to MB701C. Contains numerous overlays for individual parameters (e.g., date ranges, group codes, ABC/XYZ settings).
- **d_lagr/d_ltyp**: Structures to break out the 10 warehouse/group codes and types.
- **d_fper/d_tper**: Structures for from/to period (year/month) overlays.
- **Local Data Area (LDA) fields**: User and firm info are loaded from the LDA for audit/update purposes.

---

## Program Flow

### 1. Initialization

- Subroutine `*inzsr` initializes key lists for file access and loads the current firm number from the LDA.

### 2. Main Loop

- The program reads all records from `mabcl1` (ABC parameter records) for the current firm.
- For each record, it calls subroutine `behandle` to process the analysis.

### 3. Analysis Subroutine (`behandle`)

- **Parameter Preparation:**  
  - Loads warehouse/group codes and types from the current `mabcl1` record into arrays and overlays for parameter block.
  - Sets up date ranges and other analysis parameters.
  - Initializes various flags and counters.

- **Analysis Call:**  
  - Calls program `MB701C`, passing the `d_list` parameter block by reference.

- **Post-Analysis:**  
  - Copies key fields from the current record to working variables.
  - Calls subroutine `upd_sum` to aggregate ABC/XYZ counts and update summary records.

### 4. ABC/XYZ Count Update Subroutine (`upd_sum`)

- **Reset Counters:**  
  - All ABC/XYZ totals are set to zero.

- **Detail Traversal:**  
  - Reads all `mabdl2` detail records matching the current grouping (firm, warehouse, group, etc.).
  - Increments the appropriate ABC/XYZ counter for each detail record found.

- **Summary Update:**  
  - Chains (randomly accesses) the corresponding `mabclu` summary record.
  - If found, updates the summary fields with the new totals, sets audit fields (date, time, user), and writes the update.

---

## Key Business/Domain Logic

- **ABC/XYZ Analysis:**  
  - The program is designed to run ABC/XYZ analysis for various groupings (e.g., per warehouse, group, subgroup). The analysis itself is performed in MB701C; this program orchestrates the process and updates summary statistics.

- **Parameter Passing:**  
  - Parameters for the analysis are passed via a structured 128-byte block (`d_list`) with overlays for each individual parameter. This is a common pattern for batch driver programs in legacy RPG environments.

- **Audit Trail:**  
  - When updating summary records, the program sets audit fields: modification date, time, and user (from the LDA).

---

## Design & Implementation Notes

- **File Renaming:**  
  - Multiple logical views of the same physical file are used (e.g., `mabcpfr` as both `mabcl1r` and `mabclur`). This allows the program to process parameters and update summaries using different record formats.

- **Key Lists:**  
  - Key lists (`klist`) are used for indexed file access. The keys are constructed in the initialization subroutine and reused for each operation.

- **Parameter Block Overlays:**  
  - The use of overlays within `d_list` allows for compact parameter passing and easy field extraction in the called program (MB701C).

- **Batch Processing Pattern:**  
  - The main loop reads all relevant parameter records and processes them in sequence, suitable for overnight or scheduled batch runs.

- **Separation of Concerns:**  
  - The actual analysis logic is externalized (MB701C). MB700R acts as a coordinator and summarizer.

---

## External Interactions

- **MB701C:**  
  - The program calls MB701C, passing a parameter block. MB701C is responsible for performing the actual ABC/XYZ analysis for the given parameters.

- **Data Files:**  
  - Reads from `mabcl1` (parameters) and `mabdl2` (detail records).
  - Updates `mabclu` (summary records).

---

## Conventions & Patterns

- **Audit Fields:**  
  - All updates to summary records include audit fields for traceability.
- **Initialization via LDA:**  
  - User and firm context are loaded from the Local Data Area, a common practice in legacy RPG systems.
- **Explicit Zeroing:**  
  - All counters are explicitly reset at the start of each aggregation routine.

---

## Key Points for New Developers

- Understand the structure and overlays of the parameter block (`d_list`). This is central to how analysis parameters are passed to MB701C.
- The program is tightly coupled to the data model (firm, warehouse, group, etc.), and the key construction for file access is critical.
- All business logic for classifying and counting ABC/XYZ items is driven by the data in `mabdl2` and summarized into `mabclu`.
- The orchestration pattern used here is common in legacy RPG batch processing: read parameters, process/analyze, summarize/update.

---

## Summary

MB700R is a batch driver program that coordinates ABC/XYZ inventory analysis by iterating over parameter records, preparing and passing parameter blocks to an analysis program (MB701C), and then aggregating and updating ABC/XYZ classification counts in summary records. It is designed for batch execution, with a clear separation between parameter setup, analysis execution, and summary update, and follows established audit and data access conventions in the codebase.