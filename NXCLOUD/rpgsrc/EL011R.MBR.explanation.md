# RPG Program EL011R Explanation

This ILE RPG program (EL011R) appears to implement an interactive subfile-based inquiry (lookup/search) over a file/register. The code uses Norwegian comments but is otherwise fairly standard RPG. Below is a section-by-section explanation.

---

## 1. **File Specifications**

```rpg
felf4lu    if   e           k disk
f                                     rename(elf4pfr:elf4lur)
fel010d    cf   e             workstn
f                                     sfile(b1sfl:w_srrn)
```

- **elf4lu**: A keyed disk file, renamed from format `elf4pfr` to `elf4lur` in the program.
- **fel010d**: Workstation display file, using subfile record format `b1sfl` with a relative record number field `w_srrn`.

---

## 2. **Data Definitions**

There are three main categories:

### a) **Parameters**
```rpg
d p_text          s                   like(e4text)
d p_besk          s                   like(e4besk)
d p_stat          s              1
```
- Correspond to fields that will be passed *into* and *out of* the program, holding selected values.

### b) **Key Variables**
```rpg
d elf4lu_text     s                   like(e4text)
```
- Used in keyed access (used to search by text).

### c) **Working Variables**
```rpg
d w_spge          s              3  0
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
d w_seqe          s              1
d w_type          s              2    inz('F ')
d w_valg_ok       s              1    inz(*off)
```
- Used for subfile paging and record management (start/stop/visible row numbers, etc.).
- `w_type` filters for records of a certain type.
- `w_valg_ok` is a flag indicating successful row selection.

### d) **Constants**
```rpg
d c_sfil          s              2  0 inz(7)
```
- The subfile page size (number of rows per page).

---

## 3. **Commented Indicator Usage**

Explains RPG indicator usage, e.g. `LR` for program end, `*in10` for "Roll" key, `*in14` for "clear subfile," custom control indicators, etc.

---

## 4. **Main Program Flow**

The program works in a loop-driven fashion, alternating between displaying the screen(s) and responding to function key actions:

- **b2taga**: Initial tag, writes the `b2cmd` record (command line screen).
- **b2tagb**: Handles subfile display and processing using the `dsp_subfile` subroutine.
- **Function Key Handling**: Uses a `select/when` structure to handle different function keys:
    - *inkc, inkl*: exit.
    - *inke*: refresh subfile.
    - *in10*: create subfile (paging?).
- **Positioning**: If a positioning field has data, calls the `posisjoner` subroutine to reposition the subfile.
- **Subfile Processing**: Handles row selection via the `subfile` subroutine.
- **End**: Sets LR (last record) on and returns.

---

## 5. **Subroutines**

### a) `forny` – Refresh Subfile

- Re-positions file to start of key, then clears and re-creates the subfile.

### b) `posisjoner` – Position within Subfile

- If search text is provided, builds a key, positions the database cursor, clears, and re-creates the subfile.
- Clears the search text field after operation.

### c) `subfile` – Interactive Subfile Processing

- Iterates over subfile records (using `readc`).
- If a row is selected (`b1valg = '1'`), passes values to parameters and sets selection flag.

### d) `clr_subfile` – Clear Subfile

- Turns on the indicator to clear the subfile, writes the control record, then resets indicators and counters.

### e) `crt_subfile` – Create/Populate Subfile

- Increments page counter.
- Reads the main file until the subfile page is filled or end-of-file reached, or until a non-matching type is found.
- Fills each subfile row’s fields (`b1valg`, `b1text`, `b1besk`) and writes them to the subfile.

### f) `dsp_subfile` – Display Subfile

- If the subfile has records, sets the display indicators and performs an `exfmt` (format/display) of the control record.

### g) `*inzsr` – Program Initialization

- Handles parameter mapping via *ENTRY PLIST.
- Initializes the subfile key.
- Calls `crt_subfile` to load the subfile for initial display.

---

## 6. **Screen Mapping and Subfile Structure**

- The subfile consists of records (`b1sfl`), and control/command screen formats (`b2ctl`, `b2cmd`), allowing multiple pages and row selection.
- Navigation, clearing, and positioning across pages is handled by subfile and indicator logic.

---

## 7. **General Flow Example**

1. **Initialization:** Program receives some parameters (text, description, status), populates subfile.
2. **Display:** Presents either a command screen or the current subfile screen.
3. **User Interaction:** Processes function keys (exit, refresh, new page, or positioning).
4. **Subfile Handling:** Reads user choices; if a row is selected, copies back values and ends.
5. **Loop/Exit:** Continues until exit/selection.

---

## 8. **Notes on Norwegian Comments**

- *Spørring på register* = Inquiry on file/register
- *Felter* = Fields
- *Beskrivelse* = Description
- *Tømming* = Clearing/Emptying
- *Fylle opp* = Fill up
- *Valgt rad* = Selected row

---

## 9. **Indicators**

RPG indicators (such as `*in10`, `*in12`, etc.) are heavily used for subfile and screen control (as per the comments and IBM RPG subfile conventions).

---

## 10. **Summary**

This RPG program is a classic subfile-based inquiry and selection tool, structured with clear subroutines for:
- initialization,
- refreshing/clearing subfiles,
- populating from a disk file,
- handling user positioning/search,
- and returning selected values.

It is designed for use as a subroutine callable from other programs, passing user-selected data back through parameters after interactive lookup and selection.