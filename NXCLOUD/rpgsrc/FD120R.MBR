     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : FD120R
      * Beskrivelse . . : Ordre-linje, vedlikehold av varelinje - skaffereg.
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       240504 HKO  Nytt program
      *       041104 HKO  Endret parameter ved kall til VP900R
      *       230105 HKO  Rettet feil ved bytting av enhet
      *       150905 HKO  Leter først etter betingelse for skaffevare
      *                   Endret parameterliste ved kall av JV751R,
      *                   JP505R og JP506R
5.51  *       281005 BOF  Nullstilling av bestillingsreferanser
5.52  *       051007 AMD  Varer hentet fra vareadministrasjon går ikke
5.52  *                   innom prisberegningsprogram og kommer ut med
5.52  *                   0 i momskode. Legger ut momskode her også.
5.53  *       100108 BOF  Justert initiering av c2enhe
5.60  *       111207 BOF  Vare-pris utv.m/gammel pris - henter gjeldende pris
5.61  *       030108 BOF  Legger på eannr på varedetaljen
5.62  *       201008 BOF  Hvis innk.pris = 0, så bruk kostpris
5.63  *       261108 xxx  Tester på RKSPFA i stedet for RKSPAV
5.70  * PRGR  301008 bof  Utvidet med prisgruppe
      * 6.10  240609 BSA  Oppdatert med sporingsinformasjon
6.11  * 6.10  290609 bof  Utivdet eannr til 14 og brukt std. oppslag
6.12  *       170909 BOF  Justert kalkulasjon ved endr. enhet og betingelse
6.13  *       170909 BOF  Justert ved endring av linjen
6.14  *       041109 BOF  Utvdet med å hente kampanjepris fra VA
6.15  * 6.10  260411 bof  Hindre at lev.nr forsvinner ved endring
6.16  * 6.10  060712 bsa  Innhenting av GTIN nummer må skje på annen måte.
6.16  * 6.10              Struktur på informasjonen er endret. (NEB)
6.1a  * R6.10 070513 bof  EHF krever avrunding av FDSUMS
5.61  * R5.61 290908 AMD  Programmet feilet når det ble lagt på et
      *                   prosjektnummer (økonomi) på varelinja.
      *                   Parameterlista var ikke riktig.
5.62  * 6.10  211210 bof  Lagt på ekstra test hvis ant*pris blir for stort
6.20  * 6.20  221110 NHO  Proj er nå alfa
6.21  * 6.20  190713 bof  Hindre at den regner rabatt når kampanje fra VA
6.22  * 6.20  240913 bof  ikke tillatt å endre lev.type hvis bestilling eller
6.22  * 6.20         bof  bestillingsforslag er dannet.
6.23  * 6.20  240913 bof  En del felter er fjernet fra bilde, rydder opp i input
6.23  *                   kontroll på disse feltene.
6.24  * 6.20  030114 bof  Endr.levtype og akktype >=2 gi melding
6.25  * 6.20  300614 bof  Sjekk om pris skal kulkuleres fra nobb-pris
6.26  * 6.20  080714 bof  Varsel hvis kostpris er 0 ved kampanje.
6.27  * 6.20  100415 bkv  Lagt inn støtte for endring av enhet etter prisendring
6.28  * 6.20  300415 bkv  Beholde valgt enhet etter trykk på F10
6.30  * 6.30  080114 bof  BM MODUL : vise oppsalg/mersalg på varer
6.31  * 6.30  260114 bof  Utvidet nøkkel i JVPKPF
6.32  * 6.30  270314 bof  Sjekke om pris har utgått
6.NU  * R6.30 260514 bsa  Programmet gjennomgått mtp nummerutvidelser.
6.33  * 6.30  080814 bof  Utvidet med erstattet av nobb.
6.34  * 6.30  120914 BKV  Henter mva kode fra kundepro
6.35  * 6.30  151014 Bsa  Innfører F tast for visning av NOBB info. Erstatter
6.35  *                   koding i jacada.
6.36  * 6.30  290514 BKV  LVAR økt fra 15 til 20
6.3x  * 6.30  310515 bof  Utvidet med prisgruppe    på bet.
6.3y  * 6.30  140915 bof  Hvis prisgr ikke hat bet. så hent med blank prgr.
6.37  *       180416 bof  Ryddet opp i parameter
6.38  *       270516 bof  Skal ikke ta hensyn til kampanje #
6.39  * 6.30  270616 bof  Justert oppslag med prisgr. på betingelse.
6.40  * 6.30  191216 nho  Nullstiller ikke lev.dato men legger ut
      *                   fdldat hvis den inneholder dato
6.3a  * 6.30  200217 bof  Skal bruke mva-kode fra VP900R (VMVAPF)
6.3b  * 6.30  240217 bof  Hvis mva-kode = blank,settes den til 3.
6.3c  * 6.30  310717 bof  Skal ha bruksrett.rab når kampanje fra VA
6.3d  * 6.30  060817 bof  Hvis bet.velges, så beregn evt. frakt
6.3e  * 6.30  161017 bof  Henter utgår dato fra vare-leverandør for prisg.
6.3f  * 6.30  271117 bof  Feilrett.utl. mva når kampanjepris
6.3g  * 6.30  100718 bkv  Ekstra sjekk på om antall får stort
6.3h  * 6.30  051018 bof  Utvidet med logistikk-vare behandling.
      *
7.00  * 7.00  230319 bkv  Hvis nobb frakt:  kostpris = inn pris
7.01  * 7.00  210819 bkv  Lagt inn header på opp og mer salg dds
7.02  * 7.00  230818 hko  Henter kampanjepris kun dersom overført kampanje
7.03  * 7.00  130919 bkv  Rettet feil i visning av kostpris < 1
7.04  * 7.00  251019 bof  Feil vedr.vise fler leverandør og hvem som har pris
7.05  * 7.00  041119 bkv  Lagt inn sjekk på kampanje pris
7.06  * 7.00  240919 nho  Henter alle enheter når Skaffevare
7.07  * K000  100620 ask  Lagt inn eksta kall for å hente riktig GTIN
7.08  * K000  190521 bof  Hvis annen betingelse og nobb eller sano
7.08a * K000  200921 bof  Nytt parm i JX500R, tar med dato
7.09  * K000  060921 bof  Må sjekke mot prisgruppe ved sjekk mot VA kampanje
7.09a * K000  121121 bof  Hvis VA i solve, så bruk vareier til søk på pakning
7.10  * K000  121121 bof  Merke linje hvis endring på rab.skal ikke reberegn.linje
7.11  * K000  310822 bof  Hvis kostpris blank fra kampanje, så bruk beregnet kostpris
7.12  * K000  061022 bof  Endring av DG skal ikke reberegne linje
7.13  *       021023 mst  Kompilert pga endret editeringskode i DDS
      *
8.01  *K000   131123 bsa  Hvis rabatt er endret, vis pris/beløp på nytt
8.02  *K000   131223 bof  Hvis Solve så skal man ikke ha test vedr. 8.01
8.03  *PRG2   080622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner
8.04  *K000   050724 bsa  Sjekker utgårdato på varen, og flagger det før vi går
8.04  *K000               tilbake.
8.05  *K000   290824 mst  Korreksjon av rettelse 8.04
8.06  *K000   270325 ask  Korreksjon av rettelse 8.05  NXS-21016
8.07  *K000   160625 bof  Korreksjon av rettelse 8.06  NXS-xxxxx
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
     fjlevl3    if   e           k disk    rename(jlevpfr:jlevl3r)
6.14 fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
     fjvpkl2    if   e           k disk    rename(jvpkpfr:jvpkl2r)
     fjvprl1    if   e           k disk    rename(jvprpfr:jvprl1r)
     fjbetl5    if   e           k disk    rename(jbetpfr:jbetl5r)
     fjbetl1    if   e           k disk    rename(jbetpfr:jbetl1r)
     fvltpl1    if   e           k disk    rename(vltppfr:vltpl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
5.52 frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
6.14 fjkahl1    if   e           k disk    rename(jkahpfr:jkahl1r)
6.14 fjkavl3    if   e           k disk    rename(jkavpfr:jkavl3r)
     ffodtlu    uf a e           k disk    rename(fodtpfr:fodtlur)
6.22 flfdtl6    if   e           k disk    rename(lfdtpfr:lfdtl6r)
6.24 fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
6.30 famodl1    if   e           k disk    rename(amodpfr:amodl1r)
6.30 fjvoml1    if   e           k disk    rename(jvompfr:jvoml1r)
6.34 ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
6.3e fjvlel1    if   e           k disk    rename(jvlepfr:jvlel1r)

      *
     ffd120d    cf   e             workstn
      *
      * Definering av parametre
      *
     d p_kode          s              1
     d p_firm          s                   like(fdfirm)
     d p_numm          s                   like(fdnumm)
     d p_suff          s                   like(fdsuff)
     d p_line          s                   like(fdline)
     d p_ltyp          s                   like(fdltyp)
     d p_lety          s                   like(fdlety)
     d p_vare          s                   like(fdvare)
     d p_anta          s                   like(fdanta)
6.35 d p_nobb          s              8
      *
      * Definering av Local data area
      *
     d                uds
     d l_user                911    920
7.00 d l_filg                931    933
7.xx d l_firm                944    946  0
7.xx d l_fnav                951    980
      *
      * Definering av datastrukturer
      *
      * Parametre for henting av pris -inn
      *
     d                 ds
     d hirec                        120
     d  hifirm                        3  0 overlay(hirec)
     d  hirkat                        3  0 overlay(hirec:4)
     d  hikund                        6  0 overlay(hirec:7)
     d  hikpro                        6  0 overlay(hirec:13)
     d  hivare                       15    overlay(hirec:19)
     d  hilety                        1  0 overlay(hirec:34)
     d  hienhe                        3    overlay(hirec:35)
     d  hidato                         d   overlay(hirec:38) datfmt(*iso)
     d  hitime                         t   overlay(hirec:48) timfmt(*iso)
6.nu d  hinumm                        8  0 overlay(hirec:56)
6.nu d  hikode                        1    overlay(hirec:64)
6.nu d  hidekn                        5  2 overlay(hirec:65)
6.nu d  hiavgf                        1  0 overlay(hirec:70)
6.nu d  hipriv                        1  0 overlay(hirec:71)
6.nu d  hitilb                        1    overlay(hirec:72)
6.nu d  hiskaf                        1    overlay(hirec:73)
6.nu d  hildor                        6  0 overlay(hirec:74)
6.nu d  hisapr                        9  2 overlay(hirec:80)
6.nu d  hikopr                        9  2 overlay(hirec:89)
8.03 d  hiprgr                        2    overlay(hirec:98)
     d  hiinlr                        1    overlay(hirec:120)
      *
      * Parametre for henting av pris -ut
      *
     d                 ds
     d horec                         80
     d  holety                        1  0 overlay(horec)
     d  hokpri                        1    overlay(horec:2)
     d  hooppr                        9  2 overlay(horec:3)
     d  hosapr                        9  2 overlay(horec:12)
     d  hokopr                        9  2 overlay(horec:21)
     d  horab1                        5  2 overlay(horec:30)
     d  horab2                        5  2 overlay(horec:35)
     d  hodekn                        5  2 overlay(horec:40)
     d  hopros                        5  2 overlay(horec:45)
     d  hokamp                        5    overlay(horec:50)
     d  hoalme                        4  0 overlay(horec:55)
     d  hobrty                        1  0 overlay(horec:59)
     d  hobrr1                        5  2 overlay(horec:60)
     d  hobrr2                        5  2 overlay(horec:65)
     d  hoomva                        1    overlay(horec:70)
8.03 d  hoprgr                        2    overlay(horec:71)
      *
      * Definering av variabler i nøkler
      *
     d jvarl1_vare     s                   like(jvvare)
     d jlevl3_enum     s                   like(jlenum)
6.14 d jlevl1_ldor     s                   like(jlldor)
     d jvpkl2_vare     s                   like(jwvare)
6.31 d jvpkl2_ldor     s                   like(jwldor)
     d jvpkl2_enhe     s                   like(jwenhe)
     d jvprl1_vare     s                   like(jxvare)
8.07 d jvprl1_ldor     s                   like(jxldor)
     d jbetl5_ldor     s                   like(jpldor)
     d jbetl5_vare     s                   like(jpvare)
     d jbetl5_vtyp     s                   like(jpvtyp)
     d jbetl1_ldor     s                   like(jpldor)
6.3x d jbetl1_prgr     s                   like(jpprgr)
     d jbetl1_ogrp     s                   like(jpogrp)
     d jbetl1_hgrp     s                   like(jphgrp)
     d jbetl1_ugrp     s                   like(jpugrp)
     d jbetl1_modn     s                   like(jpmodn)
     d jbetl1_vare     s                   like(jpvare)
     d jbetl1_vtyp     s                   like(jpvtyp)
     d vltpl1_lety     s                   like(vylety)
     d vltyl1_ltyp     s                   like(valtyp)
5.52 d rkunl1_kund     s                   like(rkkund)
6.14 d jkahl1_kamp     s                   like(jmkamp)
6.14 d jkavl3_vvar     s                   like(jmvvar)
6.22 d lfdtl6_ornr     s                   like(lfornr)
6.24 d votyl1_otyp     s                   like(vaotyp)
6.30 d amodl1_modu     s                   like(axmodu)
6.30 d jvoml1_onob     s                   like(jvonob)
6.30 d jvoml1_otyp     s                   like(jvotyp)
6.34 d fkprl1_kund     s                   like(flkund)
6.34 d fkprl1_kpro     s                   like(flkpro)
6.3e d jvlel1_lvnr     s                   like(jvlvnr)
6.3e d jvlel1_lldo     s                   like(jvlldo)
      *
      * Definering av variable
      *
     d b_endr          s              1    inz(*off)
     d b_forn          s              1    inz(*off)
5.31 d b_feil          s              1    inz(*off)
6.12 d b_enhe          s              1    inz(*off)
6.12 d b_beti          s              1    inz(*off)
6.14 d b_kamp          s              1    inz(*off)
6.26 d b_kako          s              1    inz(*off)
6.22 d b_bfoh          s              1    inz(*off)
6.30 d b_opme          s              1    inz(*off)
7.04 d b_vepr          s              1    inz(*off)
8.07 d b_utgd          s              1    inz(*off)
8.07 d b_vepr_2        s              1    inz(*off)
      *
8.04 d w_utgd          s               d   datfmt(*iso)
5.60 d w_udat          s               d   datfmt(*iso)
6.3e d w_luda          s                   like(jvluda)
     d w_mvap          s              6  2
     d w_mvat          s              5  4
     d w_mvaf          s             10  9
     d w_stat          s              1
     d w_sald          s             11  2
     d w_retk          s              1
     d w_kont          s              5  0
     d w_spes          s              4  0
     d w_txt1          s             30
     d w_txt2          s             30
6.14 d w_utxt          s             30
     d w_ldat          s               d   datfmt(*iso)
     d w_dekn          s              5  2
5.62 d w_ntsu          s             15  0
7.08 d w_sano          s              1  0
7.08 d w_nobb          s              1  0
      *
     d w_firm          s                   like(fdfirm)
6.NU d w_numm          s                   like(fdnumm)
     d w_suff          s                   like(fdsuff)
     d w_line          s                   like(fdline)
      *
     d w_raba          s                   like(fdsums)
     d w_sumr          s                   like(fdsums)
     d w_sums          s                   like(fdsums)
     d w_enh1          s                   like(fdenh1)
     d w_enh2          s                   like(fdenh1)
     d w_enh3          s                   like(fdenh1)
     d w_sapr          s                   like(fdsapr)
     d w_sap1          s                   like(fdsapr)
     d w_sap2          s                   like(fdsapr)
     d w_sap3          s                   like(fdsapr)
     d w_kopr          s                   like(fdkopr)
     d w_kop1          s                   like(fdkopr)
     d w_kop2          s                   like(fdkopr)
     d w_kop3          s                   like(fdkopr)
6.12 d w_inp1          s                   like(fdinpr)
6.12 d w_inp2          s                   like(fdinpr)
6.12 d w_inp3          s                   like(fdinpr)
6.12 d w_nopr          s                   like(fdinpr)
6.12 d w_nop1          s                   like(fdinpr)
6.12 d w_nop2          s                   like(fdinpr)
6.12 d w_nop3          s                   like(fdinpr)
     d w_ltxt          s                   like(vybesk)
     d w_rab1          s                   like(fdrab1)
6.12 d w_ifak          s              8  6
6.16 d w_gtin          s                   like(jvean1)
6.16 d w_psta          s              1
6.26 d w_mld1          s             50
      *
      * ---
6.36 d w_lvar          s                   like(fdlvar)
     d w_lnav          s                   like(jlnavn)
     d w_gdat          s               d   datfmt(*iso)
7.08ad w_xdato         s               d   datfmt(*iso)
7.08ad w_dato          s               d   datfmt(*iso)
8.04 d w_date          s               d   datfmt(*iso)
     d w_eldo          s              6  0
     d w_ompr          s             12  6
     d w_omp1          s             12  6
     d w_omp2          s             12  6
     d w_omp3          s             12  6
     d w_omv2          s             12  6
     d w_omv3          s             12  6
     d w_fakt          s             12  6
     d w_bvar          s                   like(jvvare)
     d w_pvar          s                   like(jvvare)
     d w_osts          s              1  0
     d w_anta          s              2  0
     d w_grpr          s                   like(fdkopr)
     d w_bntp          s                   like(fdkopr)
     d w_inpr          s                   like(fdkopr)
5.70 d w_prgr          s                   like(fdprgr)
5.70 d w_prut          s                   like(fdprgr)
6.3y d w_pgbe          s                   like(fdprgr)
6.3y d w_pgfr          s                   like(fdprgr)
6.37 d w_ffak          s              8  6
6.37 d w_inpr2         s              9  2
6.3h d w_lv_nobb       s                   like(jvnobb)
6.3h d w_lv_lvar       s                   like(jvlvar)
6.3h d w_lv_modn       s                   like(jvmodn)
6.3h d w_logi          s              9  0
8.07 d w_pgiv          s                   like(jvldor)
      * ---
      *
     d s_ldor          s                   like(jvldor)
     d s_ifak          s              8  6
     d s_bntp          s              9  2
      *
     d s_ant1          s                   like(fdanta)
     d s_ant2          s                   like(fdanta)
     d s_ant3          s                   like(fdanta)
     d s_anta          s                   like(fdanta)
     d s_enhe          s                   like(fdenh1)
6.27 d s_enh2          s                   like(fdenh1)
     d s_sapr          s                   like(fdsapr)
     d s_rab1          s                   like(fdrab1)
     d s_rab2          s                   like(fdrab2)
     d s_lety          s                   like(fdlety)
     d s_kopr          s                   like(fdkopr)
     d s_dekn          s                   like(fdpasl)
     d s_priv          s                   like(fdpriv)
7.12 d s_dekns         s                   like(fdpasl)
      *
7.00 d u_nobf          s              1    inz(*off)                            fraktkalkulator
7.09ad u_solve         s              1    inz(*off)                            bruker Solve som VA
      *
      * Definering av konstanter
      *
     d lo              c                   'abcdefghijklmnopqrstuvwxyzæøåäö'
     d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅÄÖ'
7.00  *
7.00  * Definering av eksterne prg
7.00  *
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
7.02 d u_702           s              1    inz(*off)
7.08 d u_708           s              1    inz(*off)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     C/Exec SQL
     C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
     C/End-Exec
      *
      * Henter vareinformasjon
      *
     c                   eval      jvarl1_vare = p_vare
     c     jvarl1_key    chain     jvarl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
8.05  *
8.05  * Henter vareinformasjon
8.05  *
8.05 c*                  if        w_date > jvudat
8.05 c*                  eval      w_mld1 = 'Varen er utgått. Reg+
8.05 c*                                     istrering avsluttes!'
8.05 c*                  call      'AA005R'
8.05 c*                  parm                    w_mld1
8.05 c*                  goto      avslutt
8.05 c*                  endif
8.04  *
8.04  * Sjekker utgårdato
8.04  *
8.07 c*                   eval      w_utgd = *hival
8.07 c*                   eval      jvlel1_lvnr = c1vare
8.07 c*                   eval      jvlel1_lldo = 0
8.07 c*     jvlel1_key    setll     jvlel1
8.07 c*     jvlel1_key2   reade     jvlel1
8.07 c*                   dow       not %eof
8.07 c*                   if        jvluda = *loval and
8.07 c*                             w_utgd <> *hival
8.07 c*                   eval      w_utgd = *hival
8.07 c*                   elseif    jvluda <> *loval and
8.07 c*                             jvluda > w_utgd  and
8.07 c*                             w_utgd <> *hival or
8.07 c*                             jvluda <> *loval and
8.07 c*                             w_utgd = *hival
8.07 c*                   eval      w_utgd = jvluda
8.07 c*                   endif
8.07 c*     jvlel1_key2   reade     jvlel1
8.07 c*                   enddo
8.07  *
8.07  * Sjekker utgårdato    hvis første ikke utgåtte vare
8.07  *                      har  priser, så ok.
      *                      når spesialvare jvtype = SP, så ikke krav om pris
8.07  *
8.07 c                   eval      b_utgd = *on
8.07  *
8.07 c                   eval      jvlel1_lvnr = c1vare
8.07 c     jvlel1_key2   setll     jvlel1
8.07 c     jvlel1_key2   reade     jvlel1
8.07 c                   dow       not %eof
8.07 c                   if        jvluda = *loval or
8.07 c                             jvluda > %date()
8.07 c                   if        jvtype <> 'SP'
8.07 c                   eval      w_pgiv = jvlldo
8.07 c                   exsr      sjekk_pgiv_2
8.07 c                   if        b_vepr_2 = *on
8.07 c                   eval      b_utgd = *off
8.07 c                   leave
8.07 c                   endif
8.07 c                   else
8.07 c                   eval      b_utgd = *off
8.07 c                   leave
8.07 c                   endif
8.07 c                   endif
8.07 c     jvlel1_key2   reade     jvlel1
8.07 c                   enddo
8.04  *
8.04  * Sjekk utgårdato
8.04  *
8.07 c                   if        b_utgd = *on
8.06 c                   eval      w_mld1 = 'Varen er utgått. Reg+
8.06 c                                      istrering avsluttes!'
8.06 c                   call      'AA005R'
8.06 c                   parm                    w_mld1
8.06 c                   goto      avslutt
8.06 c                   endif
8.04  *
6.33 c                   eval      c1enob = jvenob
6.30  *
6.30  * sjekker om det finnes oppsalg/mersalg info
6.30  *
6.30 c                   eval      b_opme = *off
6.30 c                   eval      jvoml1_onob = jvnobb
6.30 c                   eval      jvoml1_otyp = 'O'
6.30 c     jvoml1_key    chain     jvoml1
6.30 c                   if        %found(jvoml1)
6.30 c                   eval      c7opp1 = %subst(jvotx1:1:50)
6.30 c                   eval      c7opp2 = %subst(jvotx1:51:50)
6.30 c                   eval      b_opme = *on
6.30 c                   endif
6.30 c                   eval      jvoml1_onob = jvnobb
6.30 c                   eval      jvoml1_otyp = 'M'
6.30 c     jvoml1_key    chain     jvoml1
6.30 c                   if        %found(jvoml1)
6.30 c                   eval      c7mer1 = %subst(jvotx1:1:50)
6.30 c                   eval      c7mer2 = %subst(jvotx1:51:50)
6.30 c                   eval      b_opme = *on
6.30 c                   endif
6.3h  * hvis logistikk-vare, hent nobbnr og riktig lev.varenr
6.3h c                   if        w_logi <> 0
6.3h c/exec sql
6.3h c+ select jvquno,
6.3h c+        jvllva,
6.3h c+        jvmodn
6.3h c+ into   :w_lv_nobb,
6.3h c+        :w_lv_lvar,
6.3h c+        :w_lv_modn
6.3h c+ from   jvklpf
6.3h c+ inner join jvlepf on
6.3h c+       jvlvnr = jvquno and
6.3h c+       jvlldo = :c1ldor
6.3h c+ inner join jvarpf on
6.3h c+       jvvare = jvquno
6.3h c+ where  jvqvnr = :p_vare and
6.3h c+        jvqldo = :c1ldor
6.3h c/end-exec
6.3h c                   endif
      *
      * Initierer ordre-linje
      *
     c                   clear                   fodtlur
      *
     c     fodtl1_key    chain     fodtl1
     c                   if        %found
     c                   eval      b_endr = *on
     c                   exsr      endr_linje
     c                   else
     c                   eval      b_endr = *off
     c                   exsr      ny_linje
     c                   endif
      *
      * Viser registreringbildet
      *
     c     tc1win        tag
6.26 c                   if        b_kamp = *on and
6.26 c                             b_kako = *on
6.26 c                   eval      w_mld1 = 'Advarsel: Kampanje f+
6.26 c                                      innes, men kostpris m+
6.26 c                                      angler!!  '
6.26 c                   call      'AA005R'
6.26 c                   parm                    w_mld1
6.26 c                   endif
      *
     c                   exsr      xc1win
     c                   if        *inkc or *inkl
     c                   goto      avslutt
     c                   endif
      *
      * Gjør oppslag mot ordre-linje for oppdatering
      *
     c     fodtlu_key    chain     fodtlur
      *
      * Opprinnelig pris
      *
     c***                eval      fdoppr = hooppr
     c
      *
      * Henter verdier fra skjermbildet
      *
     c                   eval      fdanta = c1anta
     c                   eval      fdenh1 = c1enhe
     c                   eval      fdsapr = c1sapr
7.10 c                   if        s_rab1 <> c1rab1 or
7.12 c                             s_rab2 <> c1rab2 or
7.12 c                             s_dekns <> c1dekn
7.10 c                   eval      fdprtx = '1'
7.10 c                   endif
     c                   eval      fdrab1 = c1rab1
     c                   eval      fdrab2 = c1rab2
     c                   eval      fdlety = c1lety
5.32 c                   eval      fdltyp = c1ltyp
     c                   eval      fdkpri = c1kpri
     c                   eval      fdkopr = c1kopr
5.62 c                   if        c1inpr <> 0
     c                   eval      fdinpr = c1inpr
5.62 c                   else
5.62 c                   eval      fdinpr = c1kopr
5.62 c                   endif
     c                   eval      fdtek1 = c1tek1
     c                   eval      fdtek2 = c1tek2
     c                   eval      fdpasl = c1dekn
     c                   eval      fdlass = c1lass
     c                   eval      fdproj = c1proj
     c                   eval      fdakti = c1akti
     c                   eval      fdldat = *loval
     c                   eval      fdalme = c1alme
     c                   eval      fdomva = c1omva
     c                   eval      fdbrty = c1brty
     c                   eval      fdbrr1 = c1brr1
     c                   eval      fdbrr2 = c1brr2
     c                   eval      fdpriv = c1priv
      *
     c                   if        c1ldat <> 0
     c     *dmy          move      c1ldat        fdldat
     c                   endif
      *
      * nye felter for lagring
      *
     c                   eval      fdbldo  = c1bldo
     c                   eval      fdbogr  = c1bogr
     c                   eval      fdbhgr  = c1bhgr
     c                   eval      fdbugr  = c1bugr
     c                   eval      fdbmod  = c1bmod
     c                   eval      fdbvar  = c1bvar
     c                   eval      fdbvty  = c1bvty
     c                   eval      fdblet  = c1blet
     c                   eval      fdbbet  = c1bbet
     c                   eval      fdbbet  = c1bbet
     c                   eval      fdbntp  = c1bntp
     c                   eval      fdbifa  = c1ifak
     c                   eval      fdpogr  = c1pogr
     c                   eval      fdphgr  = c1phgr
     c                   eval      fdpugr  = c1pugr
     c                   eval      fdpldo  = c1pldo
     c                   eval      fdpmod  = c1pmod
     c                   eval      fdpvar  = c1pvar
     c                   eval      fdpkpr  = c1pkpr
     c                   eval      fdpvty  = c1pvty
     c                   eval      fdplet  = c1plet
     c                   eval      fdpkfa  = c1kfak
     c                   eval      fdpkbe  = c1kbel
     c                   eval      fdpsfa  = c1sfak
     c                   eval      fdenh1  = c1enhe
      *
     c                   eval      fdnopr = w_nopr
     c                   eval      fdpen1 = w_enh1
     c                   eval      fdpen2 = w_enh2
     c                   eval      fdpen3 = w_enh3
     c                   eval      fdofp1 = w_omp1
     c                   eval      fdofp2 = w_omp2
     c                   eval      fdofp3 = w_omp3
     c                   eval      fdofv2 = w_omv2
     c                   eval      fdofv3 = w_omv3
      *
      * Beregning av totaler
      *
6.1a c*                  eval      w_sums = fdsapr * fdanta
6.1a c                   eval(h)   w_sums = fdsapr * fdanta
     c                   eval      w_sumr = 0
      *
      * Rabatt
      *
     c                   eval(h)   w_raba = (w_sums * forabp) / 100
     c                   eval      w_sumr = w_raba
      *
     c                   if        fdrab1 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdrab1 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
      *
     c                   if        fdrab2 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdrab2 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
      *
     c                   if        fdbrr1 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdbrr1 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
      *
     c                   if        fdbrr2 <> 0
     c                   eval(h)   w_raba = (w_sums - w_sumr) * fdbrr2 / 100
     c                   eval      w_sumr = w_sumr + w_raba
     c                   endif
      *
      * Kostpris  (*** ?)
      *
     c                   if        fdkopr = 0
     c                   eval      fdkopr = fdsapr * hopros
     c                   endif
      *
      * Legger inn totaler
      *
     c                   eval      fdsums = w_sums
     c                   eval      fdsumr = w_sumr
     c                   eval      fdsumk = fdkopr * fdanta
      *
      * Dersom kredit-linjetype må summene korrigeres
      *
     c                   eval      vltyl1_ltyp = fdltyp
     c     vltyl1_key    chain     vltyl1
     c                   if        valkre = '-'
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumr = fdsumr * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   endif
      *
      * Legger inn faste opplysninger fra vare og ordre
      *
     c                   eval      fdotyp = footyp
     c                   eval      fdkakk = 0
     c                   eval      fdkgeb = 0
      *
     c                   eval      fdkund = fokund
     c                   if        folkun <> 0
     c                   eval      fdkund = folkun
     c                   endif
      *
     c                   eval      fdlvre = 1
6.3h c                   if        w_lv_nobb <> 0
6.3h c                   eval      fdnobb = w_lv_nobb
6.3h c                   else
     c                   eval      fdnobb = jvnobb
6.3h c                   endif
6.16 c                   eval      fdeann = c1eann
6.11 c*6.16              if        jweann <> 0
6.11 c*6.16              eval      fdeann = jweann
6.11 c*6.16              else
     c*6.16              eval      fdeann = jvean1
6.11 c*6.16              endif
     c                   eval      fdlvar = w_lvar
     c                   eval      fdldor = w_eldo
     c                   eval      fdogrp = jvogrp
     c                   eval      fdhgrp = jvhgrp
     c                   eval      fdugrp = jvugrp
      *
      * Oversetter varetekst til store bokstaver dersom dette er valgt
      *
     c                   if        faahoy = 1
     c     lo:up         xlate     fdtek1        fdtek1
     c     lo:up         xlate     fdtek2        fdtek2
     c                   endif
5.52  *
5.52  * Kaller subrutine for å sette riktig momskode
5.52  * på varelinjen
5.52  *
5.52 c                   exsr      mva_kode
      *
      * Oppdaterer ordre-linje
      *
     c                   if        %found(fodtlu)
6.10 c                   time                    fdedat
6.10 c                   time                    fdetim
6.10 c                   eval      fdeusr = l_user
     c                   update    fodtlur
     c                   else
     c                   eval      fdfirm = w_firm
     c                   eval      fdnumm = w_numm
     c                   eval      fdsuff = w_suff
     c                   eval      fdline = w_line
     c                   eval      fdbenr = 0
5.51 c                   eval      fdbsuf = 0
5.51 c                   eval      fdblin = 0
     c                   eval      fdavde = 0
     c                   eval      fdkont = 0
     c                   eval      fdspes = 0
     c                   eval      fdvare = c1vare
6.10 c                   time                    fdodat
6.10 c                   time                    fdotim
6.10 c                   eval      fdoous = l_user
6.10 c                   time                    fdedat
6.10 c                   time                    fdetim
6.10 c                   eval      fdeusr = l_user
     c                   write     fodtlur
     c                   endif
      *
      * Legger inn kode som sier at minst en linje er registrert, og
      * returnerer om kostpris skal vises eller ikke
      *
     c                   eval      p_kode = *on
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Initierer endret ordre-linje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     endr_linje    begsr
      *
      * Leverandør
      *
     c                   eval      c1ldor = jvldor
      *
     c                   if        fdldor <> 0
     c                   eval      jlevl3_enum = fdldor
     c     jlevl3_key    chain     jlevl3
     c                   if        %found
     c                   eval      c1ldor = jlldor
6.15 c                   eval      c1lnav = jlnavn
     c                   endif
     c                   endif
      *
      * Henter grunnlag for kalkulasjon
      * henter tidligere data som er lagret på ordrelinje
      *
     c*                  exsr      hent_grunnlag
      *
      * Henter verdier til skjermbilde fra ordre-linje
      *
6.15 c                   eval      w_eldo = fdldor
6.15 c                   eval      w_lvar = fdlvar
     c                   eval      c1anta = fdanta
     c                   eval      c1enhe = fdenh1
     c                   eval      c1sapr = fdsapr
     c                   eval      c1rab1 = fdrab1
     c                   eval      c1rab2 = fdrab2
     c                   eval      c1lety = fdlety
     c                   eval      c1kpri = fdkpri
     c                   eval      c1kopr = fdkopr
     c                   eval      c1inpr = fdinpr
     c                   eval      c1ltyp = fdltyp
     c                   eval      c1tek1 = fdtek1
     c                   eval      c1tek2 = fdtek2
     c                   eval      c1enh1 = fdpen1
     c                   eval      c1enh2 = fdpen2
     c                   eval      c1enh3 = fdpen3
      *
     c                   eval      c1vare = fdvare
     c                   eval      c1dekn = fdpasl
     c                   eval      c1lass = fdlass
6.40 c                   if        fdldat <> *loval
6.40 c     *dmy          move      fdldat        c1ldat
6.40 c                   else
     c                   eval      c1ldat = 0
6.40 c                   endif
6.40  *
     c                   eval      c1proj = fdproj
     c                   eval      c1akti = fdakti
     c                   eval      c1alme = fdalme
     c                   eval      c1omva = fdomva
     c                   eval      c1brty = fdbrty
     c                   eval      c1brr1 = fdbrr1
     c                   eval      c1brr2 = fdbrr2
     c                   eval      c1priv = fdpriv
6.14 c                   eval      c1nopr = fdnopr
6.14 c                   eval      c1kamp = fdkamp
6.14 c                   if        fdkamp <> *blank
6.14 c                   eval      b_kamp = *on
6.14 c                   eval      *in86  = *on
     c                   endif
      *
     c                   if        fdldat <> *loval
     c     *dmy          move      fdldat        c1ldat
     c                   endif
      *
     c                   eval      c1kpri  = fdkpri
     c                   eval      c1bldo  = fdbldo
     c                   eval      c1bogr  = fdbogr
     c                   eval      c1bhgr  = fdbhgr
     c                   eval      c1bugr  = fdbugr
     c                   eval      c1bmod  = fdbmod
     c                   eval      c1bvar  = fdbvar
     c                   eval      c1bvty  = fdbvty
     c                   eval      c1blet  = fdblet
     c                   eval      c1bbet  = fdbbet
     c                   eval      c1bbet  = fdbbet
     c                   eval      c1bntp  = fdbntp
     c                   eval      c1ifak  = fdbifa
     c                   eval      c1pogr  = fdpogr
     c                   eval      c1phgr  = fdphgr
     c                   eval      c1pugr  = fdpugr
     c                   eval      c1pldo  = fdpldo
     c                   eval      c1pmod  = fdpmod
     c                   eval      c1pvar  = fdpvar
     c                   eval      c1pkpr  = fdpkpr
     c                   eval      c1pvty  = fdpvty
     c                   eval      c1plet  = fdplet
     c                   eval      c1kfak  = fdpkfa
     c                   eval      c1kbel  = fdpkbe
     c                   eval      c1sfak  = fdpsfa
     c                   eval      c1inpr  = fdinpr
6.16 c                   eval      c1eann  = fdeann
      *
     c                   eval      w_enh1 = fdpen1
     c                   eval      w_enh2 = fdpen2
     c                   eval      w_enh3 = fdpen3
     c                   eval      w_omp1 = fdofp1
     c                   eval      w_omp2 = fdofp2
     c                   eval      w_omp3 = fdofp3
     c                   eval      w_omv2 = fdofv2
     c                   eval      w_omv3 = fdofv3
     c                   eval      w_kopr = fdkopr
     c                   eval      w_sapr = fdsapr
6.14 c                   eval      w_inpr = fdinpr
6.14 c                   eval      w_nopr = fdnopr
      *
     c                   select
     c                   when      c1enhe = w_enh1
     c                   eval      w_sap1 = w_sapr
     c                   eval(h)   w_sap2 = w_sapr * w_omp2
     c                   eval(h)   w_sap3 = w_sapr * w_omp3
     c                   eval      w_kop1 = w_kopr
     c                   eval(h)   w_kop2 = w_kopr * w_omv2
     c                   eval(h)   w_kop3 = w_kopr * w_omv3
6.12 c                   eval      w_inp1 = w_inpr
6.12 c                   eval(h)   w_inp2 = w_inpr * w_omv2
6.12 c                   eval(h)   w_inp3 = w_inpr * w_omv3
6.12 c                   eval      w_nop1 = w_nopr
6.12 c                   eval(h)   w_nop2 = w_nopr * w_omv2
6.12 c                   eval(h)   w_nop3 = w_nopr * w_omv3
6.12  *
     c                   when      c1enhe = w_enh2
     c                   eval      w_sap2 = w_sapr
     c                   eval(h)   w_sap1 = w_sapr / w_omp2
     c                   eval(h)   w_sap3 = w_sap1 * w_omp3
     c                   eval      w_kop2 = w_kopr
     c                   eval(h)   w_kop1 = w_kopr / w_omv2
     c                   eval(h)   w_kop3 = w_kop1 * w_omv3
6.12 c                   eval      w_inp2 = w_inpr
6.12 c                   eval(h)   w_inp1 = w_inpr / w_omv2
6.12 c                   eval(h)   w_inp3 = w_inp1 * w_omv3
6.12 c                   eval      w_nop2 = w_nopr
6.12 c                   eval(h)   w_nop1 = w_nopr / w_omv2
6.12 c                   eval(h)   w_nop3 = w_nop1 * w_omv3
6.12  *
     c                   when      c1enhe = w_enh3
     c                   eval      w_sap3 = w_sapr
     c                   eval(h)   w_sap1 = w_sapr / w_omp3
     c                   eval(h)   w_sap2 = w_sap1 * w_omp2
     c                   eval      w_kop3 = w_kopr
     c                   eval(h)   w_kop1 = w_kopr / w_omv3
     c                   eval(h)   w_kop2 = w_kop1 * w_omv2
6.12 c                   eval      w_inp3 = w_inpr
6.12 c                   eval(h)   w_inp1 = w_inpr / w_omv3
6.12 c                   eval(h)   w_inp2 = w_inp1 * w_omv2
6.12 c                   eval      w_nop3 = w_nopr
6.12 c                   eval(h)   w_nop1 = w_nopr / w_omv3
6.12 c                   eval(h)   w_nop3 = w_nop1 * w_omv2
      *
     c                   endsl
      *
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Initierer ny ordre-linje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     ny_linje      begsr
      *
      * Setter leverandør lik vareeier
      *
     c                   eval      c1ldor = jvldor
      *
      * Dersom varen har flere prisgivere må prisgiver velges
      *
7.08ac                   eval      w_xdato = *loval
      *
     c                   exsr      sjekk_pgiv
7.04 c                   if        w_anta > 1 or
7.04 c                             b_vepr = *off
     c                   exsr      prisgiver
     c                   endif
6.3h c/exec sql
6.3h c+ select jvquno,
6.3h c+        jvllva,
6.3h c+        jvmodn
6.3h c+ into   :w_lv_nobb,
6.3h c+        :w_lv_lvar,
6.3h c+        :w_lv_modn
6.3h c+ from   jvklpf
6.3h c+ inner join jvlepf on
6.3h c+       jvlvnr = jvquno and
6.3h c+       jvlldo = :c1ldor
6.3h c+ inner join jvarpf on
6.3h c+       jvvare = jvquno
6.3h c+ where  jvqvnr = :p_vare and
6.3h c+        jvqldo = :c1ldor
6.3h c/end-exec
      *
6.14  *
6.14  * Sjekker om det finnes kampanje pris for varen på lev.
6.14  *
6.14 c                   eval      b_kamp = *off
6.26 c                   eval      b_kako = *off
6.14 c                   eval      *in86  = *off
6.14 c                   exsr      sjekk_kamp
      *
      * Initierer skjermbilde
      *
     c                   eval      c1ltyp = p_ltyp
     c                   eval      c1vare = jvvare
     c                   eval      c1anta = p_anta
     c                   eval      c1tek1 = jvtek1
     c                   eval      c1tek2 = jvtek2
     c                   eval      c1lety = p_lety
     c                   eval      c1pasl = fopasl
7.06  *
7.06  * Hent alle enheter
     c                   if        b_kamp = *on
7.06 c                   exsr      hent_grunnlag
7.06 c                   eval      hitilb = '1'
     c                   endif
7.06  *
      *
6.14  * hvis kampanje så går man utenom her
6.14 c                   if        b_kamp = *off
      *
      * Henter priser og kalkulasjon
      *
     c                   exsr      hent_grunnlag
5.53 c                   eval      c1enhe = w_enh1
6.12 c                   eval      c1inpr = w_inpr
6.12 c                   eval      c1nopr = w_nopr
6.12 c*                  eval      c1ifak = w_ifak
      *
      * Dersom varen har alternative betingelser må betingelse velges
      *
     c                   exsr      sjekk_bet
     c                   if        w_anta > 1
     c                   exsr      betingelse
     c                   endif
      *
6.14 c                   endif
6.3e  *
6.3e  * Henter evt. utgårdato
6.3e  *
6.3e c                   eval      jvlel1_lvnr = c1vare
6.3e c                   eval      jvlel1_lldo = c1ldor
6.3e c     jvlel1_key    chain     jvlel1
6.3e c                   if        %found(jvlel1)
6.3e c                   eval      w_udat = jvluda
6.3e c                   endif
      *
      * Henter inn priser og rabatter
      *
5.53 c*                  eval      c1enhe = w_enh1
      *
5.70 c                   eval      hiprgr = w_prgr
     c                   eval      hienhe = c1enhe
     c                   eval      hilety = c1lety
     c                   eval      hidekn = c1pasl
     c                   eval      hiavgf = fomkod
     c                   eval      hipriv = 0
     c                   eval      hildor = w_eldo
     c                   eval      hisapr = w_sapr
     c                   eval      hikopr = w_kopr
      *
     c                   exsr      hent_pris
      *
6.21 c                   if        b_kamp = *off
     c***                eval      fdoppr = hooppr
     c                   eval      c1sapr = hosapr
7.00 c                   if        (u_nobf = *on) and (c1inpr <> 0) and
7.00 c                              (folety = 1)
7.00  *  hvis nobbfrakt brukes og direkte levert, skal kostpris være lik
7.00  *  inn pris. Frakt hentes fra nobb.no
7.00 c                   eval      c1kopr = c1inpr
7.00 c                   else
7.00 c                   eval      c1kopr = hokopr
7.00 c                   endif
     c                   eval      c1kpri = hokpri
     c                   eval      c1rab1 = horab1
     c                   eval      c1rab2 = horab2
     c                   eval      c1pasl = hodekn
     c                   eval      c1alme = hoalme
6.3c c                   endif
6.3f c                   eval      c1omva = hoomva
     c                   eval      c1brty = hobrty
     c                   eval      c1brr1 = hobrr1
     c                   eval      c1brr2 = hobrr2
     c                   eval      c1priv = 0
6.21 c*                  endif
      *--
5.70 c                   eval      fdprgr = hoprgr
6.14 c                   if        b_kamp = *on
6.14 c                   eval      fdkamp = jmvkam
6.14 c                   eval      c1kamp = jmvkam
7.06 c                   eval      c1kpri = 'T'
6.14 c                   else
6.14 c                   eval      fdkamp = hokamp
6.14 c                   endif
      *
5.31 c                   eval      fdlage = folage
6.16  * Hent GTIN nummer
6.16 c                   call      'VE713R'
6.16 c                   parm                    w_firm
6.16 c                   parm                    c1ldor
6.16 c                   parm                    p_vare
6.16 c                   parm                    c1enhe
6.16 c                   parm                    w_gtin
6.16 c                   parm                    w_psta
6.16  *
6.16 c                   eval      fdeann = w_gtin
      *
     c                   endsr
5.52  *
5.52  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.52  * Finner MVA-kode
5.52  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.52  *
5.52 c     mva_kode      begsr
5.52  *
5.52  * Slå opp på kunderegister for å finne om kunden er
5.52  * pliktig eller fri for å sette momskode på varelinjen
5.52  *
5.52 c                   eval      rkunl1_kund = fokund
5.52 c     rkunl1_key    chain     rkunl1
6.34  * Slå opp på kundeprosjekt for å finne om prosjekt er
6.34  * overstyrer verdi på kunde
6.34 c                   if        fokpro > 0
6.34 c                   eval      fkprl1_kund = fokund
6.34 c                   eval      fkprl1_kpro = fokpro
6.34 c     fkprl1_key    chain     fkprl1
6.34 c                   if        %found(fkprl1)
6.34 c                   eval      rkmkod = flmkod
6.34 c                   endif
6.34 c                   endif
6.34  *
5.52  * Default mva-kode
5.52  *
6.3b c                   if        fdomva = *blank
6.3b c                   eval      fdomva = '3'
6.3b c                   endif
5.52  *
5.52  * Avgiftsfritt salg fir mva-kode '4'
5.52  * Dersom kunde også skal ha spesialfaktura settes mva-kode til '0'
5.52  *
6.3A c**                 if        rkmkod = 1
6.3A c**                 eval      fdomva = '4'
6.3A c**                 if        rkspfa = 1
6.3A c**                 eval      fdomva = '0'
6.3A c**                 endif
6.3A c**                 endif
      *
6.34  *
5.52  * Dersom ordre er overstyrt til mva.fri
5.52  * skal også varelinjene ha kode for dette
5.52  *
6.3A c**                 if        fomkod = 1
6.3A c**                 eval      fdomva = '4'
6.3A c**                 endif
5.32  *
5.52 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * C1 Behandle bilde for registrering av varelinje med antall
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc1win        begsr
      *
      * Initierer skjermbildet
      *
     c                   eval      *in81 = w_enh1 = *blank
      *
     c                   eval      *in82 = w_enh2 = *blank
     c                   eval      *in83 = w_enh3 = *blank
      *
6.3e c                   eval      *in84 = jvluda <> *loval
     c                   eval      *in85 = c1priv = 1 or
     c                                     c1brr1 <> 0 or
     c                                     c1brr2 <> 0
      *
     c                   eval      c1enh1 = w_enh1
     c                   eval      c1enh2 = w_enh2
     c                   eval      c1enh3 = w_enh3
6.3h c                   if        w_lv_nobb <> 0
6.3h c                   eval      c1nobb = w_lv_nobb
6.3h c                   eval      c1nmod = w_lv_modn
6.3h c                   else
     c                   eval      c1nobb = jvnobb
     c                   eval      c1nmod = jvmodn
6.3h c                   endif
6.16 c*                  eval      c1eann = jvean1
6.16 c                   if        fdeann <> 0
6.16 c                   eval      c1eann = fdeann
6.16 c                   else
6.16 c                   eval      c1eann = w_gtin
6.16 c                   endif
     c                   eval      c1saim = 0
     c                   eval      c1pasl = 0
6.40 c                   if        fdldat <> *loval
6.40 c     *dmy          move      fdldat        c1ldat
6.40 c                   else
     c                   eval      c1ldat = 0
6.40 c                   endif
6.40  *
     c                   eval      c1ant1 = 0
     c                   eval      c1ant2 = 0
     c                   eval      c1ant3 = 0
     c                   eval      c1udat = 0
      *
6.3e c                   if        jvluda <> *loval
6.3e c     *dmy          move      jvluda        c1udat
     c                   endif
      *
      * Kaller subrutine for å vise antall i andre enheter
      *
     c                   exsr      kalkulator
      *
     c                   if        w_enh1 = *blank
     c                   eval      c1enh1 = fdenh1
     c                   eval      c1ant1 = fdanta
     c                   endif
      *
      * Tar vare på eksisterende verdier
      *
     c                   eval      hosapr = c1sapr
      *
     c                   eval      s_ant1 = c1ant1
     c                   eval      s_ant2 = c1ant2
     c                   eval      s_ant3 = c1ant3
     c                   eval      s_anta = c1anta
     c                   eval      s_enhe = c1enhe
     c                   eval      s_sapr = c1sapr
     c                   eval      s_lety = c1lety
     c                   eval      s_kopr = c1kopr
     c                   eval      s_dekn = c1dekn
     c                   eval      s_priv = c1priv
      *
      * Viser bildet
      *
     c     c1tagb        tag
      *
     c                   eval      s_rab1 = c1rab1
     c                   eval      s_rab2 = c1rab2
      *
     c                   eval      c1ntpr = c1sapr
     c                   if        c1rab1 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1rab1 / 100)
     c                   endif
     c                   if        c1rab2 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1rab2 / 100)
     c                   endif
     c                   if        c1brr1 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1brr1 / 100)
     c                   endif
     c                   if        c1brr2 > 0
     c                   eval(h)   c1ntpr = c1ntpr - (c1ntpr * c1brr2 / 100)
     c                   endif
      *
     c                   eval      c1ntim = c1ntpr * w_mvat
      *
     c                   eval      c1odek = 0
     c                   if        c1kopr <> 0 and
     c                             c1ntpr <> 0
     c                   select
     c                   when      (100 - (c1kopr * 100 / c1ntpr)) > 999,99
     c                   eval      c1odek = 999,99
     c                   when      (100 - (c1kopr * 100 / c1ntpr)) < -999,99
     c                   eval      c1odek = -999,99
     c                   other
     c                   eval(h)   c1odek = 100 - (c1kopr * 100 / c1ntpr)
     c                   endsl
     c                   endif
      *
5.62 c                   eval      w_ntsu = c1ntpr * c1anta
6.3g c                   if        (w_ntsu > 999999999) or
6.3g c                              ((w_ntsu * w_mvat) > 999999999)
6.62 c                   eval      c1ntsu = 999999999
6.62 c                   eval      *in51  = *on
6.62 c                   else
     c                   eval      c1ntsu = c1ntpr * c1anta
     c                   eval      c1nisu = c1ntsu * w_mvat
6.3g c                   eval      *in51  = *off
5.62 c                   endif
      *
     c                   exfmt     c1win
      *
6.30 c                   if        b_opme = *on and
6.30 c                             *in29  = *on
6.30 c                   exsr      xc7win
6.30 c                   endif
      *
     c                   eval      b_forn = *off
      *
      * F2=Manuell beregning av kostpris
      *
     c                   if        *inkb = *on
     c                   call      'FO524R'
     c                   parm                    w_kopr
     c                   if        w_kopr <> 0
     c                   eval      c1kopr = w_kopr
     c                   eval      s_kopr = w_kopr
     c                   if        c1dekn <> 0
     c                   exsr      dekning
     c                   endif
     c                   endif
     c                   goto      c1tagb
     c                   endif
      *
      * F3=Gå tilbake
      *
     c                   if        *inkc or *inkl
     c                   leavesr
     c                   endif
      *
      * F4=Spørring
      *
     c                   if        *inkd  = *on
      *
     c                   if        w_afld = 'C1LETY'
     c                   call      'VY500R'
     c                   parm                    w_firm
     c                   parm                    c1lety
     c                   parm                    w_ltxt
     c                   goto      c1tagb
     c                   endif
      *
      * prosjekt er skjult nå, ikke nødvendig med test
6.23 c*                  if        w_afld = 'C1PROJ'
6.23 c*                  eval      w_kont = 0
6.23 c*                  eval      w_spes = 0
6.23 c*                  call      'RP500R'
6.23 c*                  parm                    w_firm
6.23 c*                  parm                    c1proj
6.23 c*                  parm                    c1akti
6.23 c*                  parm                    w_kont
6.23 c*                  parm                    w_spes
6.23 c*                  parm                    w_txt1
6.23 c*                  goto      c1tagb
6.23 c*                  endif
      *
     c                   endif
      *
      * F8=Produktinformasjon
      *
     c                   if        *inkh = *on
     c                   call      'FO704C'
     c                   parm                    w_firm
     c                   parm                    c1vare
     c                   goto      c1tagb
     c                   endif
      *
6.14  * F10=Vanlig kalkyle - hvis kampanje har blitt valgt
6.14  *
6.14 c                   if        *inkj = *on
6.14  *
6.14  *
6.14  * Henter priser og kalkulasjon
6.14  *
6.14 c                   exsr      hent_grunnlag
6.28 c*                  eval      c1enhe = w_enh1
6.28 c*                  eval      c1nopr = w_nopr
6.14  *
6.14  * Dersom varen har alternative betingelser må betingelse velges
6.14  *
6.14 c                   exsr      sjekk_bet
6.14 c                   if        w_anta > 1
6.14 c                   exsr      betingelse
6.14 c                   endif
6.14  *
6.14  * Henter inn priser og rabatter
6.14  *
6.28 c                   select
6.28 c                   when      c1enhe = w_enh1
6.28 c                   eval(h)   w_sapr = w_sap1
6.28 c                   eval(h)   w_kopr = w_kop1
6.28 c                   eval(h)   w_inpr = w_inp1
6.28 c                   eval(h)   w_nopr = w_nop1
6.28 c                   when      c1enhe = w_enh2
6.28 c                   eval(h)   w_sapr = w_sap2
6.28 c                   eval(h)   w_kopr = w_kop2
6.28 c                   eval(h)   w_inpr = w_inp2
6.28 c                   eval(h)   w_nopr = w_nop2
6.28 c                   when      c1enhe = w_enh3
6.28 c                   eval(h)   w_sapr = w_sap3
6.28 c                   eval(h)   w_kopr = w_kop3
6.28 c                   eval(h)   w_inpr = w_inp3
6.28 c                   eval(h)   w_nopr = w_nop3
6.28 c                   endsl
6.28 c                   eval      c1inpr = w_inpr
6.28 c                   eval      c1nopr = w_nopr
      *
6.28 c                   eval      hienhe = c1enhe
6.14 c                   eval      hilety = c1lety
6.14 c                   eval      hidekn = fopasl
6.14 c                   eval      hiavgf = fomkod
6.14 c                   eval      hipriv = c1priv
6.14 c                   eval      hildor = w_eldo
6.14 c                   eval      hisapr = w_sapr
6.14 c                   eval      hikopr = w_kopr
6.14  *
6.14 c                   exsr      hent_pris
6.14  *
6.14 c***                eval      fdoppr = hooppr
6.14 c                   eval      c1sapr = hosapr
6.14 c                   eval      c1kopr = hokopr
6.14 c                   eval      c1kpri = hokpri
6.14 c                   eval      c1rab1 = horab1
6.14 c                   eval      c1rab2 = horab2
6.14 c                   eval      c1pasl = hodekn
6.14 c                   eval      c1alme = hoalme
6.14 c                   eval      c1omva = hoomva
6.14 c                   eval      c1brty = hobrty
6.14 c                   eval      c1brr1 = hobrr1
6.14 c                   eval      c1brr2 = hobrr2
6.14 c                   eval      c1kamp = *blank
6.14  *
6.14 c                   goto      c1tagb
6.14 c                   endif
      *
      * F13=Velg prisgivende leverandør
      *
     c                   if        *inkm = *on
     c                   exsr      prisgiver
     c                   if        c1ldor <> s_ldor
      *
      * Henter priser og kalkulasjon
      *
     c                   exsr      hent_grunnlag
      *
      * Dersom varen har alternative betingelser må betingelse velges
      *
     c                   exsr      sjekk_bet
     c                   if        w_anta > 1
     c                   exsr      betingelse
     c                   endif
      *
      * Henter inn priser og rabatter
      *
     c                   eval      hienhe = c1enh1
     c                   eval      hilety = c1lety
     c                   eval      hidekn = fopasl
     c                   eval      hiavgf = fomkod
     c                   eval      hipriv = c1priv
     c                   eval      hildor = w_eldo
     c                   eval      hisapr = w_sapr
     c                   eval      hikopr = w_kopr
      *
     c                   exsr      hent_pris
      *
     c***                eval      fdoppr = hooppr
     c                   eval      c1sapr = hosapr
     c                   eval      c1kopr = hokopr
     c                   eval      c1kpri = hokpri
     c                   eval      c1rab1 = horab1
     c                   eval      c1rab2 = horab2
     c                   eval      c1pasl = hodekn
     c                   eval      c1alme = hoalme
     c                   eval      c1omva = hoomva
     c                   eval      c1brty = hobrty
     c                   eval      c1brr1 = hobrr1
     c                   eval      c1brr2 = hobrr2
6.16  * Hent GTIN nummer på nytt
6.16 c                   call      'VE713R'
6.16 c                   parm                    w_firm
6.16 c                   parm                    c1ldor
6.16 c                   parm                    P_vare
6.16 c                   parm                    c1enh1
6.16 c                   parm                    w_gtin
6.16 c                   parm                    w_psta
6.16  *
6.16 c                   eval      c1eann = w_gtin
      *
     c                   endif
      *
     c                   goto      c1tagb
     c                   endif
      *
      * F14=Velg betingelse
      *
     c                   if        *inkn = *on
      *
     c                   eval      w_anta = 0
     c                   exsr      betingelse
      *
     c                   if        c1ifak <> s_ifak or
     c                             c1bntp <> s_bntp
      *
      * Henter inn priser og rabatter
      *
6.12 c*                  eval      hienhe = c1enh1
6.12 c                   eval      hienhe = c1enhe
     c                   eval      hilety = c1lety
     c                   eval      hidekn = fopasl
     c                   eval      hiavgf = fomkod
     c                   eval      hipriv = c1priv
     c                   eval      hildor = w_eldo
     c                   eval      hisapr = w_sapr
     c                   eval      hikopr = w_kopr
      *
     c                   exsr      hent_pris
      *
     c***                eval      fdoppr = hooppr
     c                   eval      c1sapr = hosapr
     c                   eval      c1kopr = hokopr
     c                   eval      c1kpri = hokpri
     c                   eval      c1rab1 = horab1
     c                   eval      c1rab2 = horab2
     c                   eval      c1pasl = hodekn
     c                   eval      c1alme = hoalme
     c                   eval      c1omva = hoomva
     c                   eval      c1brty = hobrty
     c                   eval      c1brr1 = hobrr1
     c                   eval      c1brr2 = hobrr2
      *
     c                   endif
      *
     c                   goto      c1tagb
     c                   endif
      *
      * F15=Kalkulasjon
      *
     c                   if        *inkp = *on
     c                   call      'JV165R'
     c                   parm                    w_firm
     c                   parm                    jvvare
6.3x c                   parm                    w_prgr
     c                   parm                    c1lety
     c                   parm                    c1kpri
     c                   parm                    c1enhe
     c                   parm                    w_enh1
     c                   parm                    w_enh2
     c                   parm                    w_enh3
     c                   parm                    w_ompr
     c                   parm                    w_omp1
     c                   parm                    w_omp2
     c                   parm                    w_omp3
     c                   parm                    w_omv2
     c                   parm                    w_omv3
     c                   parm                    c1ldor
     c                   parm                    w_lnav
     c                   parm                    w_lvar
     c                   parm                    w_eldo
     c                   parm                    c1nopr
     c                   parm                    w_gdat
     c                   parm                    c1inpr
     c                   parm                    w_kopr
     c                   parm                    w_sapr
     c                   parm                    c1bldo
     c                   parm                    c1bogr
     c                   parm                    c1bhgr
     c                   parm                    c1bugr
     c                   parm                    c1bmod
     c                   parm                    c1bvar
     c                   parm                    c1bvty
     c                   parm                    c1blet
     c                   parm                    c1bbet
     c                   parm                    c1bntp
     c                   parm                    c1ifak
     c                   parm                    c1pogr
     c                   parm                    c1phgr
     c                   parm                    c1pugr
     c                   parm                    c1pldo
     c                   parm                    c1pmod
     c                   parm                    c1pvar
     c                   parm                    c1pkpr
     c                   parm                    c1pvty
     c                   parm                    c1plet
     c                   parm                    c1kfak
     c                   parm                    c1kbel
     c                   parm                    c1sfak
      *
     c                   eval      c1lnav = w_lnav
      *
      * Henter inn priser og rabatter
      *
     c                   eval      hienhe = c1enh1
     c                   eval      hilety = c1lety
     c                   eval      hidekn = fopasl
     c                   eval      hiavgf = fomkod
     c                   eval      hipriv = c1priv
     c                   eval      hildor = w_eldo
     c                   eval      hisapr = w_sapr
     c                   eval      hikopr = w_kopr
      *
     c                   exsr      hent_pris
      *
     c***                eval      fdoppr = hooppr
     c                   eval      c1sapr = hosapr
     c                   eval      c1kopr = hokopr
     c                   eval      c1kpri = hokpri
     c                   eval      c1rab1 = horab1
     c                   eval      c1rab2 = horab2
     c                   eval      c1pasl = hodekn
     c                   eval      c1alme = hoalme
     c                   eval      c1omva = hoomva
     c                   eval      c1brty = hobrty
     c                   eval      c1brr1 = hobrr1
     c                   eval      c1brr2 = hobrr2
      *
     c                   goto      c1tagb
     c                   endif
6.35  *
6.35  * F18=NOBB informasjon
6.35  *
6.35 c                   if        *inks = *on
6.35 c                   exsr      vis_nobb
6.35 c                   goto      c1tagb
6.35 c                   endif
      *
      * Enhet må oppgis dersom varen ikke har enhet
      *
     c                   if        w_enh1 = *blank
      *
     c                   if        c1enh1 = *blank
     c                   eval      *in31 = *on
     c                   goto      c1tagb
     c                   endif
      *
     c                   eval      jvpkl2_vare = p_vare
7.09ac                   if        u_solve = *on
7.09ac                   eval      jvpkl2_ldor = jvldor
7.09ac                   else
6.31 c                   eval      jvpkl2_ldor = c1ldor
7.09ac                   endif
     c                   eval      jvpkl2_enhe = c1enh1
     c     jvpkl2_key    chain     jvpkl2
     c                   if        not %found
     c                   eval      *in32 = *on
     c                   goto      c1tagb
     c                   endif
      *
     c                   endif
      *
      * Sjekker og behandler antall
      *
     c                   if        c1ant1 = 0 and
     c                             c1ant2 = 0 and
     c                             c1ant3 = 0 and
     c                             c1anta = 0
     c                   eval      *in33 = *on
     c                   goto      c1tagb
     c                   endif
      *
     c                   select
     c                   when      c1ant1 <> s_ant1 and
     c                             c1ant1 <> 0 or
     c                             w_enh1 = *blank and
     c                             c1ant1 <> 0
     c                   eval      s_ant1 = c1ant1
     c                   eval      c1anta = c1ant1
     c                   eval      c1enhe = c1enh1
     c                   when      c1ant2 <> s_ant2 and
     c                             c1ant2 <> 0
     c                   eval      s_ant2 = c1ant2
     c                   eval      c1anta = c1ant2
     c                   eval      c1enhe = c1enh2
     c                   when      c1ant3 <> s_ant3 and
     c                             c1ant3 <> 0
     c                   eval      s_ant3 = c1ant3
     c                   eval      c1anta = c1ant3
     c                   eval      c1enhe = c1enh3
     c                   endsl
5.31  *
      * Sjekk leveringstype
      *
     c                   eval      vltpl1_lety = c1lety
     c     vltpl1_key    chain     vltpl1
     c                   if        not %found
     c                   eval      *in34 = *on
     c                   goto      c1tagb
     c                   endif
6.24  *
6.24  * Hvis man endrer lev.type og akk.type >= 2, så feil
6.24  *
6.24 c                   if        c1lety <> s_lety and
6.24 c                             vaoakk >=2
6 24 c                   eval      *in46  = *on
6.24 c                   goto      c1tagb
6.24 c                   endif
6.22  *
6.22  * Sjekk om bestilling på linjen, da kan ikke lev.typ endres
6.22  *
6.22 c                   exsr      sjekk_bestf
6.22 c                   if        c1lety <> s_lety and
6.22 c                             (fdbenr <> 0  or
6.22 c                              b_bfoh = *on)
6.22 c                   eval      *in45 = *on
6.22 c                   goto      c1tagb
6.22 c                   endif
5.32  *
5.32  * Sjekk linjetype
5.32  *
5.32 c                   eval      vltyl1_ltyp = c1ltyp
5.32 c     vltyl1_key    chain     vltyl1                             90
5.32 c                   if        *in90 = *on
5.32 c                   eval      b_feil = *on
5.32 c                   eval      *in42 = *on
5.32 c                   goto      c1tagb
5.32 c                   endif
5.32  *
5.32  * Tekst-linjetype og vare kan ikke oppgis samtidig
5.32  *
5.32 c                   if        valktx = 1 and
5.32 c                             c1vare <> *blank
5.32 c                   eval      b_feil = *on
5.32 c                   eval      *in43 = *on
5.32 c                   goto      c1tagb
5.32 c                   endif
5.32  *
5.32  * Vare må oppgis sammen med vare-linjetype
5.32  *
5.32 c                   if        valktx = 0 and
5.32 c                             c1vare = *blank
5.32 c                   eval      b_feil = *on
5.32 c                   eval      *in44 = *on
5.32 c                   goto      c1tagb
5.32 c                   endif
      *
      * Sjekk varetekst
      *
     c                   if        c1tek1 = *blank
     c                   eval      *in35 = *on
     c                   goto      c1tagb
     c                   endif
      *
      * Salgspris inkl.mva, DG og påslag kan ikke endres samtidig
      *
     c                   select
     c                   when      c1saim <> 0
     c                   if        c1dekn <> s_dekn and
     c                             c1dekn <> 0 or
     c                             c1pasl <> 0
     c                   eval      *in36 = *on
     c                   goto      c1tagb
     c                   endif
     c                   when      c1dekn <> s_dekn and
     c                             c1dekn <> 0
     c                   if        c1saim <> 0 or
     c                             c1pasl <> 0
     c                   eval      *in36 = *on
     c                   goto      c1tagb
     c                   endif
     c                   when      c1pasl <> 0
     c                   if        c1saim <> 0 or
     c                             c1dekn <> s_dekn and
     c                             c1dekn <> 0
     c                   eval      *in36 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endsl
      *
      * DG og påslag kan ikke oppgis når kostpris = 0
      *
     c                   if        c1kopr = 0
     c                   if        c1dekn <> 0 or
     c                             c1pasl <> 0
     c                   eval      *in37 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Sjekk leveringsdato
      *
     c                   if        c1ldat <> 0
     c     *dmy          test(d)                 c1ldat                 40
     c                   if        *in40 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Sjekk om leveringsdato er større enn ordredato
      *
     c                   if        c1ldat <> 0
     c     *dmy          move      c1ldat        w_ldat
     c                   if        w_ldat < fobdat
     c                   eval      *in41 = *on
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Sjekk prosjekt
      *
6.23  * prosjekt er skjult nå, ikke nødvendig med test
6.23 c**                 if        c1proj <> 0 and
6.23 c*                  if        c1proj <> *blank and
6.23 c*                            c1proj <> fdproj
6.23 c*                  eval      w_kont = 0
6.23 c*                  eval      w_spes = 0
6.23 c*                  call      'RS770R'
6.23 c*                  parm                    w_retk
6.23 c*                  parm                    c1proj
6.23 c*                  parm                    c1akti
6.23 c*                  parm                    w_kont
6.23 c*                  parm                    w_spes
6.23 c*                  parm                    w_txt1
6.23 c*                  parm                    w_txt2
6.23 c*                  if        w_retk <> *blank
6.23 c*                  eval      *in45 = *on
6.23 c*                  goto      c1tagb
6.23 c*                  endif
6.23 c*                  endif
      *
      * Sjekk aktivitet
      *
6.23  * aktivitet er skjult i bildet, ikke nødvedig med test
6.23 c*                  if        c1akti <> *blank and
6.23 c*                            c1akti <> fdakti
6.23 c*                  call      'RS721R'
6.23 c*                  parm                    w_retk
6.23 c*                  parm                    c1akti
6.23 c*                  parm                    w_txt1
6.23 c*                  if        w_retk <> *blank
6.23 c*                  eval      *in46 = *on
6.23 c*                  goto      c1tagb
6.23 c*                  endif
6.23 c*                  endif
      *
      * Kaller subrutine for å vise antall i andre enheter
      *
     c                   if        w_enh2 <> *blank
     c                   exsr      kalkulator
     c                   eval      s_ant1 = c1ant1
     c                   eval      s_ant2 = c1ant2
     c                   eval      s_ant3 = c1ant3
     c                   endif
6.12  *
6.12  * Dersom enhet er endret og betingelse er endret så må betingelse
6.12  * hentes på nytt.
6.12  *
6.12 c*                  if        c1enhe <> s_enhe  and
6.12 c*                            b_beti = *on
6.12 c*                  eval      *in50 = *on
6.12 c*                  goto      c1tagb
6.12 c*                  endif
      *
      * Dersom enhet, leveringstype eller privat er endret hentes ny pris
      * og rabatt.
      *
     c                   if        c1enhe <> s_enhe or
     c                             c1lety <> s_lety or
     c                             c1priv <> s_priv
      *
6.27 c                   if        c1sapr > 0 and c1sapr <> s_sapr
6.27 c                   eval      s_enh2 = s_enhe
6.27 c                   endif
      *
6.12 c                   eval      b_enhe = *off
6.12 c                   if        c1enhe <> s_enhe
6.12 c                   eval      b_enhe = *on
6.12 c                   endif
      *
     c                   eval      s_enhe = c1enhe
     c                   eval      s_lety = c1lety
     c                   eval      s_dekn = c1dekn
     c                   eval      s_priv = c1priv
      *
     c                   select
     c                   when      c1enhe = w_enh1
6.12 c                   eval(h)   w_sapr = w_sap1
6.12 c                   eval(h)   w_kopr = w_kop1
6.12 c                   eval(h)   w_inpr = w_inp1
6.12 c                   eval(h)   w_nopr = w_nop1
     c                   when      c1enhe = w_enh2
6.12 c                   eval(h)   w_sapr = w_sap2
6.12 c                   eval(h)   w_kopr = w_kop2
6.12 c                   eval(h)   w_inpr = w_inp2
6.12 c                   eval(h)   w_nopr = w_nop2
     c                   when      c1enhe = w_enh3
6.12 c                   eval(h)   w_sapr = w_sap3
6.12 c                   eval(h)   w_kopr = w_kop3
6.12 c                   eval(h)   w_inpr = w_inp3
6.12 c                   eval(h)   w_nopr = w_nop3
     c                   endsl
6.12 c                   eval      c1inpr = w_inpr
6.12 c                   eval      c1nopr = w_nopr
      *
     c                   eval      hienhe = c1enhe
     c                   eval      hilety = c1lety
     c                   eval      hidekn = c1dekn
     c                   eval      hiavgf = fomkod
     c                   eval      hipriv = c1priv
     c                   eval      hildor = w_eldo
6.12  * hvis betingelse er endret
6.12 c*                  if        b_beti = *on
6.12 c*                  eval(h)   w_kopr = (c1inpr * c1kfak) + c1kbel
6.12 c*                  eval(h)   w_sapr = w_kopr * c1sfak * w_ompr
6.12 c*                  endif
6.12  *
     c                   eval      hikopr = w_kopr
6.12 c                   eval      hisapr = w_sapr
      *
     c                   exsr      hent_pris
      *
     c                   eval      c1alme = hoalme
     c                   eval      c1omva = hoomva
     c                   eval      c1brty = hobrty
     c                   eval      c1brr1 = hobrr1
     c                   eval      c1brr2 = hobrr2
      *
      * Oppdater ny pris bare dersom pris ikke er overstyrt og dersom
6.12  * pris ikke er forsjellig fra null, men uansett hvis enhet er endret
      *
     c                   if        hosapr <> 0
     c                   if        (c1sapr = s_sapr or
6.12 c                             c1sapr = 0  or
6.27 c                             b_enhe = *on) and
6.27 c                             s_enh2 = *blank
     c                   eval      c1sapr = hosapr
     c                   eval      c1kopr = hokopr
     c                   eval      c1kpri = hokpri
7.06  *
7.06  * Dersom kampanje sett rabatt til 0
7.06 c                   if        b_kamp = '1'
7.06 c                   eval      horab1 = 0
7.06 c                   eval      horab2 = 0
7.06 c                   eval      c1kpri = 'T'
7.06 c                   endif
7.06  *
     c                   eval      c1rab1 = horab1
     c                   eval      c1rab2 = horab2
     c                   eval      s_anta = c1anta
     c                   eval      s_sapr = c1sapr
     c                   eval      s_rab1 = c1rab1
     c                   eval      s_rab2 = c1rab2
7.12 c                   eval      s_dekns = c1dekn
     c                   eval      b_forn = *on
6.27 c                   elseif    s_enh2 <> c1enhe
6.27 c                   select
6.27 c                   when      s_enh2 = w_enh1
6.27 c                   if        c1enhe = w_enh2
6.27 c                   eval(h)   c1sapr = c1sapr * w_omv2
6.27 c                   eval(h)   c1kopr = c1kopr * w_omv2
6.27 c                   endif
6.27 c                   if        c1enhe = w_enh3
6.27 c                   eval(h)   c1sapr = c1sapr * w_omv3
6.27 c                   eval(h)   c1kopr = c1kopr * w_omv3
6.27 c                   endif
6.27 c                   when      s_enh2 = w_enh2
6.27 c                   if        c1enhe = w_enh1
6.27 c                   eval(h)   c1sapr = c1sapr / w_omv2
6.27 c                   eval(h)   c1kopr = c1kopr / w_omv2
6.27 c                   endif
6.27 c                   if        c1enhe = w_enh3
6.27 c                   eval(h)   c1sapr = c1sapr * (w_omv3/w_omv2)
6.27 c                   eval(h)   c1kopr = c1kopr * (w_omv3/w_omv2)
6.27 c                   endif
6.27 c                   when      s_enh2 = w_enh3
6.27 c                   if        c1enhe = w_enh1
6.27 c                   eval(h)   c1sapr = c1sapr / w_omv3
6.27 c                   eval(h)   c1kopr = c1kopr / w_omv3
6.27 c                   endif
6.27 c                   if        c1enhe = w_enh2
6.27 c                   eval(h)   c1sapr = c1sapr * (w_omv2/w_omv3)
6.27 c                   eval(h)   c1kopr = c1kopr * (w_omv2/w_omv3)
6.27 c                   endif
6.27 c                   endsl
6.27 c
6.27 c                   eval      s_enh2 = s_enhe
6.27 c                   eval      s_anta = c1anta
6.27 c                   eval      s_sapr = c1sapr
6.27 c                   eval      s_rab1 = c1rab1
6.27 c                   eval      s_rab2 = c1rab2
7.12 c                   eval      s_dekns = c1dekn
6.27 c                   eval      b_forn = *on
6.27 c                   endif
     c                   endif
      *
     c                   endif
      *
      * Behandling av salgspris inkl.mva.
      *
     c                   if        c1saim <> 0
     c                   eval(h)   c1sapr = c1saim * w_mvaf
     c                   eval      c1dekn = 0
     c                   eval      c1saim = 0
     c                   goto      c1tagb
     c                   endif
      *
      * Behandling av kostpris
      *
     c                   if        c1kopr <> s_kopr
     c                   eval      s_kopr = c1kopr
     c                   eval      s_dekn = c1dekn
     c                   if        c1dekn <> 0 and
     c                             c1pasl = 0
     c                   exsr      dekning
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Behandling av DG
      *
     c                   if        c1dekn = s_dekn and
     c                             c1dekn <> 0
     c                   if        c1rab1 <> s_rab1 or
     c                             c1rab2 <> s_rab2
     c                   eval      c1dekn = 0
     c                   eval      s_dekn = 0
     c                   eval      s_rab1 = c1rab1
     c                   eval      s_rab2 = c1rab2
     c                   endif
     c                   endif
      *
     c                   if        c1dekn <> s_dekn
     c                   eval      s_dekn = c1dekn
     c                   if        c1dekn <> 0
     c                   exsr      dekning
     c                   goto      c1tagb
     c                   endif
     c                   endif
      *
      * Behandling av påslag
      *
     c                   if        c1pasl <> 0
     c                   eval(h)   w_sapr = c1kopr + (c1kopr * c1pasl / 100)
     c                   eval(h)   c1dekn = 100 - (c1kopr * 100 / w_sapr)
     c                   eval      c1pasl = 0
     c                   eval      s_dekn = c1dekn
     c                   if        c1dekn <> 0
     c                   exsr      dekning
     c                   endif
     c                   goto      c1tagb
     c                   endif
7.07  *
7.07  * Hent GTIN nummer på nytt
7.07  *
7.07 c                   call      'VE713R'
7.07 c                   parm                    w_firm
7.07 c                   parm                    c1ldor
7.07 c                   parm                    P_vare
7.07 c                   parm                    c1enhe
7.07 c                   parm                    w_gtin
7.07 c                   parm                    w_psta
7.07  *
7.07 c                   eval      c1eann = w_gtin
      *
      * Viser bildet på nytt dersom dette er angitt
      *
     c                   if        b_forn = *on
     c                   goto      c1tagb
     c                   endif
      *
      * Viser bildet på nytt dersom varen har flere enheter, antall er
      * endret og bildet ikke allerede er vist
      *
     c                   if        w_enh2 <> *blank and
     c                             c1anta <> s_anta
     c                   eval      s_anta = c1anta
     c                   goto      c1tagb
     c                   endif
      *
      * Sjekk pris
      *
     c                   if        c1sapr <= 0,01
     c                   eval      *in39 = *on
     c                   goto      c1tagb
     c                   endif
      *
      * Sender advarsel dersom netto salgspris < kostpris
      *
     c                   eval      w_sapr = c1sapr
     c                   if        c1rab1 > 0
     c                   eval(h)   w_sapr = w_sapr - (w_sapr * c1rab1 / 100)
     c                   endif
     c                   if        c1rab2 > 0
     c                   eval(h)   w_sapr = w_sapr - (w_sapr * c1rab2 / 100)
     c                   endif
      *
     c                   if        c1kopr > w_sapr
     c                   exfmt     c1msg
     c                   if        *inkc or *inkl
     c                   goto      c1tagb
     c                   endif
     c                   endif
8.01  *
8.01  * Hvis endret rabatt, vis bildet på nytt
8.01  *
8.02 c                   if        u_solve = *off
8.01 c                   if        c1rab1 <> s_rab1 or
8.01 c                             c1rab2 <> s_rab2
8.01 c                   goto      c1tagb
8.01 c                   endif
8.02 c                   endif
      *
     c                   endsr
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.30  * C7 gir popup på oppsalg og mersalg (BM Modul)
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.30  *
6.30 c     xc7win        begsr
6.30 c
6.30 c                   exfmt     c7win
6.30 c                   if        *inkc or *inkl
6.30 c                   goto      end_c7win
6.30 c                   endif
6.30 c                   eval      b_opme = *off
6.30  *
6.30 c     end_c7win     endsr
6.35  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.35  * Vis NOBB informasjon for varen. Samme prinsipp som preview av utskrifter
6.35  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.35  *
6.35 c     vis_nobb      begsr
6.35 c
6.35 c                   eval      p_nobb = %char(c1nobb)
6.35 c                   call      'AP633R'
6.35 c                   parm                    p_nobb
6.35  *
6.35 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for henting av grunnlagsinformasjon
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_grunnlag begsr
      *
7.08ac                   eval      w_dato = fobdat
7.08ac                   if        w_xdato <> *loval
7.08ac                   eval      w_dato = w_xdato
7.08ac                   endif
      *
     c                   call      'JV751R'
     c                   parm                    w_firm
     c                   parm                    jvvare
5.70 c                   parm                    w_prgr
     c                   parm                    c1lety
7.08ac                   parm                    w_dato
     c                   parm                    w_osts
     c                   parm                    c1ldor
     c                   parm                    w_lnav
     c                   parm                    w_lvar
     c                   parm                    w_eldo
6.12 c                   parm                    w_nopr
     c                   parm                    w_gdat
     c                   parm                    w_enh1
     c                   parm                    w_enh2
     c                   parm                    w_enh3
     c                   parm                    w_omp1
     c                   parm                    w_omp2
     c                   parm                    w_omp3
     c                   parm                    w_omv2
     c                   parm                    w_omv3
     c                   parm                    c1kpri
     c                   parm                    c1bldo
     c                   parm                    c1bogr
     c                   parm                    c1bhgr
     c                   parm                    c1bugr
     c                   parm                    c1bmod
     c                   parm                    c1bvar
     c                   parm                    c1bvty
     c                   parm                    c1blet
     c                   parm                    c1bbet
     c                   parm                    c1bntp
     c                   parm                    c1ifak
     c                   parm                    c1pogr
     c                   parm                    c1phgr
     c                   parm                    c1pugr
     c                   parm                    c1pldo
     c                   parm                    c1pmod
     c                   parm                    c1pvar
     c                   parm                    c1pkpr
     c                   parm                    c1pvty
     c                   parm                    c1plet
     c                   parm                    c1kfak
     c                   parm                    c1kbel
     c                   parm                    c1sfak
6.28 c                   parm                    w_inpr
     c                   parm                    w_kopr
     c                   parm                    w_sapr
     c                   parm                    w_dekn
5.70 c                   parm                    w_prut
6.3y c                   parm                    w_pgbe
6.3y c                   parm                    w_pgfr
6.37 c                   parm                    w_ffak
6.37 c                   parm                    w_inpr2
      *
     c                   eval      c1lnav = w_lnav
      *
      * Finner priser for hver salgsenhet
7.06  *
7.06  * Dersom kampanje må kampanjepriser legges inn for utregning
7.05 c                   if        jmvkaa <> 0 and b_kamp = *on
7.06 c                   eval      w_sapr = c1sapr
7.11 c                   if        c1kopr <> 0
7.06 c                   eval      w_kopr = c1kopr
7.11 c                   else
7.11 c                   eval      c1kopr = w_kopr
7.11 c                   endif
7.11 c                   if        c1inpr <> 0
7.06 c                   eval      w_inpr = c1inpr
7.11 c                   else
7.11 c                   eval      c1inpr = w_inpr
7.11 c                   endif
7.11 c                   if        c1kopr > 0
7.11 c                   eval      b_kako = *off
7.11 c                   endif
7.06 c                   endif
7.06  *
      *
     c                   eval      w_sap1 = w_sapr
     c                   eval      w_sap2 = w_sapr * w_omp2
     c                   eval      w_sap3 = w_sapr * w_omp3
      *
     c                   eval      w_kop1 = w_kopr
     c                   eval      w_kop2 = w_kopr * w_omv2
     c                   eval      w_kop3 = w_kopr * w_omv3
6.12  *
6.12 c                   eval      w_inp1 = w_inpr
6.12 c                   eval      w_inp2 = w_inpr * w_omv2
6.12 c                   eval      w_inp3 = w_inpr * w_omv3
6.12  *
6.12 c                   eval      w_nop1 = w_nopr
6.12 c                   eval      w_nop2 = w_nopr * w_omv2
6.12 c                   eval      w_nop3 = w_nopr * w_omv3
      *
      *** Finner omregningsfaktor pris for enhet
      *
     c                   eval      w_ompr = w_omp1
      *
     c                   eval      hopros = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Henter kalkulert pris på varen
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_pris     begsr
      *
     c                   eval      hifirm = w_firm
     c                   eval      hirkat = 0
      *
     c                   eval      hikund = fokund
     c                   if        folkun <> 0
     c                   eval      hikund = folkun
     c                   endif
      *
     c                   eval      hikpro = fokpro
     c                   eval      hivare = jvvare
     c                   eval      hidato = fobdat
     c                   eval      hitime = *loval
     c                   eval      hinumm = 0
     c                   eval      hikode = fopask
     c                   eval      hiskaf = *on
      *
     c                   call      'VP900R'
     c                   parm                    hirec
     c                   parm                    horec
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å sjekke om varen har flere prisgivere
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_pgiv    begsr
      *
     c                   eval      w_anta = 0
7.04 c                   eval      b_vepr = *off
      *
     c                   eval      jvprl1_vare = c1vare
     c     jvprl1_key    setll     jvprl1
     c     jvprl1_key    reade     jvprl1
     c                   dow       not %eof
6.32 c                   if        (jxtdat =  *loval) or
6.32 c                             (jxtdat <> *loval and
6.32 c                             jxtdat > w_udat)
7.04 c                   if        jxldor = jvldor
7.04 c                   eval      b_vepr = *on
7.04 c                   endif
     c                   eval      w_anta = w_anta + 1
6.32 c                   endif
     c     jvprl1_key    reade     jvprl1
     c                   enddo
      *
     c                   endsr
8.07  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.07  * Subrutine for å sjekke om en vare har pris for valgt prisgiver
8.07  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.07  *
8.07 c     sjekk_pgiv_2  begsr
8.07  *
8.07 c                   eval      w_anta = 0
8.07 c                   eval      b_vepr_2 = *off
8.07  *
8.07 c                   eval      jvprl1_vare = c1vare
8.07 c                   eval      jvprl1_ldor = w_pgiv
8.07 c     jvprl1_key2   setll     jvprl1
8.07 c     jvprl1_key2   reade     jvprl1
8.07 c                   dow       not %eof
8.07 c                   if        (jxtdat =  *loval) or
8.07 c                             (jxtdat <> *loval and
8.07 c                             jxtdat > w_udat)
8.07 c                   eval      b_vepr_2 = *on
8.07 c                   leavesr
8.07 c                   endif
8.07 c     jvprl1_key2   reade     jvprl1
8.07 c                   enddo
8.07  *
8.07 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å sjekke om varen har flere betingelser innefor nivå
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_bet     begsr
      *
     c                   eval      w_anta = 0
      *
      * Finner betingelse på varenivå
      *
     c                   eval      jbetl5_ldor = c1ldor
     c                   eval      jbetl5_vare = c1vare
     c                   eval      jbetl5_vtyp = 'S'
      *
     c     jbetl5_key    setll     jbetl5
     c     jbetl5_key    reade     jbetl5
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl5_key    reade     jbetl5
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
      *
     c                   eval      jbetl5_vtyp = *blank
     c     jbetl5_key    setll     jbetl5
     c     jbetl5_key    reade     jbetl5
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl5_key    reade     jbetl5
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
      *
      * Finner betingelse på modul-nivå
      *
     c                   eval      jbetl1_ldor = c1ldor
6.3x c                   eval      jbetl1_prgr = w_prgr
     c                   eval      jbetl1_ogrp = jvogrp
     c                   eval      jbetl1_hgrp = jvhgrp
     c                   eval      jbetl1_ugrp = jvugrp
     c                   eval      jbetl1_modn = jvmodn
     c                   eval      jbetl1_vare = *blank
     c                   eval      jbetl1_vtyp = 'S'
      *
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
      *
     c                   eval      jbetl1_vtyp = *blank
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
      *
      * Finner betingelse på undergruppe-nivå
      *
     c                   eval      jbetl1_modn = 0
     c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = w_prgr
      *
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
      *
     c                   eval      jbetl1_vtyp = *blank
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
      *
      * Finner betingelse på hovedgruppe-nivå
      *
     c                   eval      jbetl1_ugrp = 0
     c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = w_prgr
      *
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
      *
     c                   eval      jbetl1_vtyp = *blank
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
      *
      * Finner betingelse på overgruppe-nivå
      *
     c                   eval      jbetl1_hgrp = 0
     c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = w_prgr
      *
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
      *
     c                   eval      jbetl1_vtyp = *blank
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
      *
      * Finner betingelse på leverandør-nivå
      *
     c                   eval      jbetl1_ogrp = 0
     c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = w_prgr
      *
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
      *
     c                   if        w_anta > 0
     c                   leavesr
     c                   endif
      *
     c                   eval      jbetl1_vtyp = *blank
     c     jbetl1_key    setll     jbetl1
     c     jbetl1_key    reade     jbetl1
     c                   dow       not %eof
     c                   eval      w_anta = w_anta + 1
     c     jbetl1_key    reade     jbetl1
     c                   enddo
6.39  *
6.39 c                   eval      jbetl1_vtyp = 'S'
6.39 c                   eval      jbetl1_prgr = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
6.39  *
6.39 c                   eval      jbetl1_vtyp = *blank
6.39 c     jbetl1_key    setll     jbetl1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   dow       not %eof
6.39 c                   eval      w_anta = w_anta + 1
6.39 c     jbetl1_key    reade     jbetl1
6.39 c                   enddo
6.39  *
6.39 c                   if        w_anta > 0
6.39 c                   leavesr
6.39 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Kalkulator for omregning mellom enheter
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     kalkulator    begsr
      *
     c                   if        c1enhe <> *blank
      *
     c                   eval      c1ant1 = 0
     c                   eval      c1ant2 = 0
     c                   eval      c1ant3 = 0
      *
     c                   select
     c                   when      c1enhe = w_enh1
     c                   eval      c1ant1 = c1anta
     c                   if        w_omv2 <> 0
     c                   eval(h)   c1ant2 = c1anta / w_omv2
     c                   endif
     c                   if        w_omv3 <> 0
     c                   eval(h)   c1ant3 = c1anta / w_omv3
     c                   endif
     c                   when      c1enhe = w_enh2
     c                   eval(h)   c1ant1 = c1anta * w_omv2
     c                   eval      c1ant2 = c1anta
     c                   if        w_omv3 <> 0
     c                   eval(h)   c1ant3 = c1ant1 / w_omv3
     c                   endif
     c                   when      c1enhe = w_enh3
     c                   eval(h)   c1ant1 = c1anta * w_omv3
     c                   if        w_omv2 <> 0
     c                   eval(h)   c1ant2 = c1ant1 / w_omv2
     c                   endif
     c                   eval      c1ant3 = c1anta
     c                   endsl
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Beregner salgspris og rabatt i.h.t. dekningsgrad (DG)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dekning       begsr
      *
     c                   eval(h)   c1sapr = (100 * c1kopr) / (100 - c1dekn)
     c                   eval      c1rab1 = 0
     c                   eval      c1rab2 = 0
      *
     c                   if        fopask = *blank
     c                   if        hosapr > 0,01
     c                   eval(h)   w_rab1 = (hosapr - c1sapr) * 100 / hosapr
     c                   if        w_rab1 >= 0
     c                   eval      c1sapr = hosapr
     c                   eval      c1rab1 = w_rab1
     c                   endif
     c                   endif
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Velger prisgivende leverandør
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     prisgiver     begsr
      *
     c                   eval      s_ldor = c1ldor
      *
     c                   call      'JX500R'
     c                   parm                    jvvare
     c                   parm                    c1ldor
     c                   parm                    w_lnav
     c                   parm                    w_grpr
7.08ac                   parm                    w_xdato
      *
     c                   eval      c1lnav = w_lnav
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Henter ny betingelse
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     betingelse    begsr
      *
     c                   eval      s_ifak = c1ifak
     c                   eval      s_bntp = c1bntp
      *
     c                   if        w_anta > 1
     c                   call      'JP506R'
     c                   parm                    w_firm
     c                   parm                    c1ldor
6.3x c                   parm                    w_prgr
     c                   parm                    jvvare
     c                   parm                    c1lety
     c                   parm                    c1bldo
     c                   parm                    c1bogr
     c                   parm                    c1bhgr
     c                   parm                    c1bugr
     c                   parm                    c1bmod
     c                   parm                    w_bvar
     c                   parm                    c1bvty
     c                   parm                    c1blet
     c                   parm                    c1bbet
     c                   parm                    w_bntp
     c                   parm                    c1ifak
     c                   else
     c                   call      'JP505R'
     c                   parm                    w_firm
     c                   parm                    c1ldor
6.3x c                   parm                    w_prgr
     c                   parm                    jvvare
     c                   parm                    c1bldo
     c                   parm                    c1bogr
     c                   parm                    c1bhgr
     c                   parm                    c1bugr
     c                   parm                    c1bmod
     c                   parm                    w_bvar
     c                   parm                    c1bvty
     c                   parm                    c1blet
     c                   parm                    c1bbet
     c                   parm                    w_bntp
     c                   parm                    c1ifak
     c                   endif
      *
     c                   eval      c1bvar = w_bvar
      *
     c                   select
     c                   when      c1enhe = w_enh1
     c                   eval      c1bntp = w_bntp
     c                   when      c1enhe = w_enh2
     c                   eval      c1bntp = w_bntp * w_omv2
     c                   when      c1enhe = w_enh3
     c                   eval      c1bntp = w_bntp * w_omv3
     c                   endsl
      *
     c                   if        c1bntp = 0 and
     c                             c1ifak = 0
     c                   eval      c1ifak = 1
     c                   endif
     c
      * Dersom innkjøpspris-faktor eller nettopris er endret kalkuleres pris
      * før rabatt på nytt
      *
     c                   if        c1ifak <> s_ifak or
     c                             c1bntp <> s_bntp
      *
      * Finner omregningsfaktor pris for enhet
      *
     c                   select
     c                   when      c1enhe = w_enh1
     c                   eval      w_ompr = w_omp1
     c                   when      c1enhe = w_enh2
     c                   eval(h)   w_ompr = w_omp2 / w_omv2
     c                   when      c1enhe = w_enh3
     c                   eval(h)   w_ompr = w_omp3 / w_omv3
     c                   endsl
      *
      * Priser
      *
6.25 c                   eval      jlevl1_ldor = c1bldo
6.25 c     jlevl1_key    chain     jlevl1
     c                   if        c1bntp <> 0
     c                   eval      c1inpr = c1bntp
     c                   else
     c                   eval(h)   c1inpr = c1nopr * c1ifak
     c                   endif
6.12 c                   eval      w_inpr = c1inpr
6.3d  *
6.3d  * Innkjøpspris2 (etter frakt)  beregnes her
6.3d  *
6.3d c                   eval      w_inpr2 = w_inpr
6.3d c                   if        w_ffak <> 0
6.3d c                   eval      w_inpr2 = w_inpr2 * w_ffak
6.3d c                   endif
      *
     c                   if        c1inpr = 0
     c                   eval      c1inpr = c1kopr
     c                   endif
      *
6.3d c                   eval(h)   w_kopr = (w_inpr2 * c1kfak) + c1kbel
7.08 c                   if        u_708 = *off
6.25 c                   if        jlkkal = 1
6.25 c                   eval(h)   w_sapr = c1nopr
6.25 c                   else
     c                   eval(h)   w_sapr = w_kopr * c1sfak * w_ompr
6.25 c                   endif
7.08 c                   else
7.08 c                   exsr      sjekk_pasl
7.08 c                   if        w_nobb = 1
7.08 c                   eval(h)   w_sapr = c1nopr
7.08 c                   else
7.08 c                   if        jlkkal = 1 or
7.08 c                             w_sano = 1
7.08 c                   eval(h)   w_sapr = c1nopr * c1sfak * w_ompr
7.08 c                   else
7.08 c                   eval(h)   w_sapr = w_kopr * c1sfak * w_ompr
7.08 c                   endif
7.08 c                   endif
7.08 c                   endif
      *
      * Finner priser for hver salgsenhet
      *
     c                   eval      w_sap1 = w_sapr
     c                   eval      w_sap2 = w_sapr * w_omp2
     c                   eval      w_sap3 = w_sapr * w_omp3
      *
     c                   eval      w_kop1 = w_kopr
     c                   eval      w_kop2 = w_kopr * w_omv2
     c                   eval      w_kop3 = w_kopr * w_omv3
6.12  *
6.12 c                   eval      b_beti = *on
      *
     c                   endif
      *
     c                   endsr
6.14  *
6.14  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.14  * Sjekker om vare finnes på kampanje
6.14  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.14  *
6.14 c     sjekk_kamp    begsr
6.14  *
6.14 c                   eval      jkavl3_vvar = p_vare
6.14 c     jkavl3_key    setll     jkavl3
6.14 c     jkavl3_key    reade     jkavl3
6.14 c                   dow       not %eof(jkavl3)
7.09 c                   if        jmvldo = c1ldor and
7.09 c                             jmvprg = w_prgr
6.14 c                   eval      jkahl1_kamp = jmvkam
6.14 c     jkahl1_key    chain     jkahl1
6.14 c                   if        %found(jkahl1) and
6.14 c                             fobdat >= jmfdat and
6.38 c                             fobdat <= jmtdat and
7.02 c                             %subst(jmkamp:1:1) <> '#' and
7.02 c                             ((jmodat <> *loval) or (u_702 = *off))
7.02 c***                          %subst(jmkamp:1:1) <> '#'
6.14 c                   eval      jlevl1_ldor = c1ldor
6.14 c     jlevl1_key    chain     jlevl1
6.14 c                   if        jlenum <> 0
6.14 c                   eval      b_kamp = *on
6.14 c                   eval      *in86  = *on
6.14 c                   eval      c1enhe = jvpenh
6.14 c                   eval      w_enh1 = jvpenh
6.14 c                   eval      c1inpr = jmvkai
6.14 c                   eval      w_inpr = jmvkai
6.14 c                   if        jmvkpr <> 0
6.14 c                   eval      c1kopr = jmvkpr
6.14 c                   else
6.14 c                   eval      c1kopr = jmvkai
6.14 c                   endif
6.26 c                   if        c1kopr = 0
6.26 c                   eval      b_kako = *on
6.26 c                   endif
6.14 c                   eval      w_kopr = c1kopr
6.14 c                   eval      c1sapr = jmvkaa
6.14 c                   eval      w_sapr = jmvkaa
6.14 c                   eval      w_eldo = jlenum
6.14 c                   leavesr
6.14 c                   endif
6.14 c                   endif
6.14  *
6.14 c                   endif
6.14 c
6.14 c     jkavl3_key    reade     jkavl3
6.14 c                   enddo
7.09  * hvis ikke funnet kampanje med prisgruppe, så sjekk mot prisgr = ''
7.09 c                   eval      jkavl3_vvar = p_vare
7.09 c     jkavl3_key    setll     jkavl3
7.09 c     jkavl3_key    reade     jkavl3
7.09 c                   dow       not %eof(jkavl3)
7.09 c                   if        jmvldo = c1ldor and
7.09 c                             jmvprg = *blank
7.09 c                   eval      jkahl1_kamp = jmvkam
7.09 c     jkahl1_key    chain     jkahl1
7.09 c                   if        %found(jkahl1) and
7.09 c                             fobdat >= jmfdat and
7.09 c                             fobdat <= jmtdat and
7.09 c                             %subst(jmkamp:1:1) <> '#' and
7.09 c                             ((jmodat <> *loval) or (u_702 = *off))
7.09 c***                          %subst(jmkamp:1:1) <> '#'
7.09 c                   eval      jlevl1_ldor = c1ldor
7.09 c     jlevl1_key    chain     jlevl1
7.09 c                   if        jlenum <> 0
7.09 c                   eval      b_kamp = *on
7.09 c                   eval      *in86  = *on
7.09 c                   eval      c1enhe = jvpenh
7.09 c                   eval      w_enh1 = jvpenh
7.09 c                   eval      c1inpr = jmvkai
7.09 c                   eval      w_inpr = jmvkai
7.09 c                   if        jmvkpr <> 0
7.09 c                   eval      c1kopr = jmvkpr
7.09 c                   else
7.09 c                   eval      c1kopr = jmvkai
7.09 c                   endif
7.09 c                   if        c1kopr = 0
7.09 c                   eval      b_kako = *on
7.09 c                   endif
7.09 c                   eval      w_kopr = c1kopr
7.09 c                   eval      c1sapr = jmvkaa
7.09 c                   eval      w_sapr = jmvkaa
7.09 c                   eval      w_eldo = jlenum
7.09 c                   leavesr
7.09 c                   endif
7.09 c                   endif
7.09  *
7.09 c                   endif
7.09 c
7.09 c     jkavl3_key    reade     jkavl3
7.09 c                   enddo
6.14  *
6.14 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * ERROR-rutine
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *pssr         begsr
      *
     c                   eval      *in49 = *on
     c                   goto      tc1win
      *
     c                   endsr
6.22  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.22  * Subrutine for å sjekke om det finnes best.forslag heading
6.22  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.22  *
6.22 c     sjekk_bestf   begsr
6.22  *
6.22 c                   eval      b_bfoh = *off
6.22 c                   eval      lfdtl6_ornr =   fonumm
6.22 c     lfdtl6_key    setll     lfdtl6
6.22 c     lfdtl6_key    reade     lfdtl6
6.22 c                   dow       not %eof(lfdtl6)
6.22 c                   eval      b_bfoh = *on
6.22 c     lfdtl6_key    reade     lfdtl6
6.22 c                   enddo
6.22 c                   endsr
      *
7.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.08  * Subrutine for å sjekke om sano eller nobb er på påslaget
7.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.08  *
7.08 c     sjekk_pasl    begsr
7.08  *
7.08 c                   eval      w_sano = 0
7.08 c                   eval      w_nobb = 0
7.08 c/exec sql
7.08 c+ select jcnobb, jcsano
7.08 i+ into   :w_sano, :w_nobb
7.08 c+ from   jpfapf
7.08 c+ where  jcfirm = :w_firm and
7.08 c+        jcprgr = :w_prgr and
7.08 c+        jcogrp = :c1pogr and
7.08 c+        jchgrp = :c1phgr and
7.08 c+        jcugrp = :c1pugr and
7.08 c+        jcldor = :c1pldo and
7.08 c+        jcmodn = :c1pmod and
7.08 c+        jcvare = :c1pvar and
7.08 c+        jckpri = :c1pkpr and
7.08 c+        jcvtyp = :c1pvty and
7.08 c+        jclety = :c1plet
7.08 c/end-exec
7.08 c                   if        sqlcod =  100  and
7.08 c                             w_prgr <> *blank
7.08  * prøver med prisgr blank
7.08 c/exec sql
7.08 c+ select jcnobb, jcsano
7.08 i+ into   :w_sano, :w_nobb
7.08 c+ from   jpfapf
7.08 c+ where  jcfirm = :w_firm and
7.08 c+        jcprgr = ' ' and
7.08 c+        jcogrp = :c1pogr and
7.08 c+        jchgrp = :c1phgr and
7.08 c+        jcugrp = :c1pugr and
7.08 c+        jcldor = :c1pldo and
7.08 c+        jcmodn = :c1pmod and
7.08 c+        jcvare = :c1pvar and
7.08 c+        jckpri = :c1pkpr and
7.08 c+        jcvtyp = :c1pvty and
7.08 c+        jclety = :c1plet
7.08 c/end-exec
7.08 c                   endif
7.08 c                   if        sqlcod < 0
7.08 c                   eval      w_sano = 0
7.08 c                   eval      w_nobb = 0
7.08 c                   endif
7.08 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_kode
     c                   parm                    p_firm
6.NU c                   parm                    p_numm
     c                   parm                    p_suff
     c                   parm                    p_line
     c                   parm                    p_ltyp
     c                   parm                    p_lety
     c                   parm                    p_vare
     c                   parm                    p_anta
      *
      * Key for oppslag på status
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag på vare (VA)
      *
     c     jvarl1_key    klist
     c                   kfld                    jvarl1_vare
      *
      * Key for oppslag på leverandør (VA)
      *
     c     jlevl3_key    klist
     c                   kfld                    jlevl3_enum
6.14  *
6.14  * Key for oppslag på leverandør (VA)
6.14  *
6.14 c     jlevl1_key    klist
6.14 c                   kfld                    jlevl1_ldor
      *
      * Key for oppslag på vare-pakning (VA)
      *
     c     jvpkl2_key    klist
     c                   kfld                    jvpkl2_vare
6.31 c                   kfld                    jvpkl2_ldor
     c                   kfld                    jvpkl2_enhe
      *
      * Key for les på vare-pris
      *
     c     jvprl1_key    klist
     c                   kfld                    jvprl1_vare
8.07  *
8.07  * Key for les på vare-pris  pr. prisgiver
8.07  *
8.07 c     jvprl1_key2   klist
8.07 c                   kfld                    jvprl1_vare
8.07 c                   kfld                    jvprl1_ldor
      *
      * Key for oppslag på betingelse
      *
     c     jbetl5_key    klist
     c                   kfld                    w_firm
     c                   kfld                    jbetl5_ldor
     c                   kfld                    jbetl5_vare
     c                   kfld                    jbetl5_vtyp
      *
     c     jbetl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    jbetl1_ldor
6.3x c                   kfld                    jbetl1_prgr
     c                   kfld                    jbetl1_ogrp
     c                   kfld                    jbetl1_hgrp
     c                   kfld                    jbetl1_ugrp
     c                   kfld                    jbetl1_modn
     c                   kfld                    jbetl1_vare
     c                   kfld                    jbetl1_vtyp
      *
      * Key for oppslag på leveringstype
      *
     c     vltpl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltpl1_lety
      *
      * Key for oppslag på linjetype
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for oppslag på ordre-hode
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
      *
      * Key for oppdatering av ordre-linje
      *
     c     fodtlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
     c                   kfld                    w_line
      *
      * Key for oppslag på ordre-linje
      *
     c     fodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
     c                   kfld                    w_line
5.52  *
5.52  * Key for oppslag på kunderegister
5.52  *
5.52 c     rkunl1_key    klist
5.52 c                   kfld                    w_firm
5.52 c                   kfld                    rkunl1_kund
6.14  *
6.14  * Key for oppslag på kampanje hode
6.14  *
6.14 c     jkahl1_key    klist
6.14 c                   kfld                    w_firm
6.14 c                   kfld                    jkahl1_kamp
6.14  *
6.14  * Key for oppslag på kampanje detaler
6.14  *
6.14 c     jkavl3_key    klist
6.14 c                   kfld                    w_firm
6.14 c                   kfld                    jkavl3_vvar
6.22  *
6.22  * Key for file : best.forslag linjer
6.22  *
6.22 c     lfdtl6_key    klist
6.22 c                   kfld                    w_firm
6.22 c                   kfld                    lfdtl6_ornr
6.24  *
6.24  * Key for ordretyperegister
6.24  *
6.24 c     votyl1_key    klist
6.24 c                   kfld                    w_firm
6.24 c                   kfld                    votyl1_otyp
6.30  *
6.30  * Key for les av moduler Nexstep
6.30  *
6.30 c     amodl1_key    klist
6.30 c                   kfld                    amodl1_modu
6.30  *
6.30  * Key for oppslag på vare oppsalg /mersalg
6.30  *
6.30 c     jvoml1_key    klist
6.30 c                   kfld                    jvoml1_onob
6.30 c                   kfld                    jvoml1_otyp
6.34  *
6.34  * Key for oppslag på kundeprosjekt
6.34  *
6.34 c     fkprl1_key    klist
6.34 c                   kfld                    w_firm
6.34 c                   kfld                    fkprl1_kund
6.34 c                   kfld                    fkprl1_kpro
6.3e  *
6.3e  * Key for oppslag på vare-leverandør
6.3e  *
6.3e c     jvlel1_key    klist
6.3e c                   kfld                    jvlel1_lvnr
6.3e c                   kfld                    jvlel1_lldo
8.04  *
8.04  * Key for oppslag på vare-leverandør
8.04  *
8.04 c     jvlel1_key2   klist
8.04 c                   kfld                    jvlel1_lvnr
      *
      * Henter parametre
      *
     c                   eval      w_firm = p_firm
6.NU c                   eval      w_numm = p_numm
     c                   eval      w_suff = p_suff
     c                   eval      w_line = p_line
8.04 c                   time                    w_date
      *
      * Henter dagens dato
      *
     c                   time                    w_udat
      *
      * Hent opplysninger fra ofak koderegister
      *
     c     fstsl1_key    chain     fstsl1r
      *
      * Hent opplysninger fra ordre-hode
      *
     c     fohel1_key    chain     fohel1r
      *
6.24 c                   eval      votyl1_otyp = footyp
6.24 c     votyl1_key    chain     votyl1r
      *
      * Henter mva-sats
      *
     c                   call      'FÅ705R'
     c                   parm                    p_firm
     c                   parm                    fobdat
     c                   parm                    w_mvap
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
      *
      * Initierer skjermbildet
      *
     c                   eval      c1vare = p_vare
5.70  *
5.70  * Kaller program for henting av prisgruppe fra lager/avdeling
5.70  *
5.70 c                   call      'VL712R'
5.70 c                   parm                    w_firm
5.70 c                   parm                    folage
5.70 c                   parm                    foavde
5.70 c                   parm                    w_prgr
      *
6.3h  * finner evt. logistikk-vare
6.3h  *
6.3h c                   eval      w_logi = 0
6.3h c/exec sql
6.3h c+ select count(*)
6.3h i+ into   :w_logi
6.3h c+ from   jvkhpf
6.3h c+ where  jvkvnr = :p_vare and
     c+        jvkfir = :w_firm
6.3h c/end-exec
6.3h  *
6.30  *
6.30  * Sjekker om BM Modul
6.30  *
6.30 c                   eval      amodl1_modu = 'BM_MODUL'
6.20 c     amodl1_key    chain     amodl1
6.30 c                   if        %found(amodl1)
6.30 c                   eval      *in29  = *on
6.30 c                   endif
7.00  *
7.00  * Test om nobb fraktkalkulator er av eller på
7.00  *
7.00   CallP CO402R(l_filg:w_firm:0:'BRUK_NOBB_FRAKTKALKULATOR':
7.00                    co402_verdi1:co402_verdi2);
7.00   if co402_verdi1 = '1';
7.00     u_nobf = *on;
7.00   endif;
7.00  *
7.00  * Henter kampanjepris kun dersom overført kampanje
7.00  *
7.00   CallP CO402R(l_filg:w_firm:0:'FD120R_702':
7.00                    co402_verdi1:co402_verdi2);
7.00   if co402_verdi1 = '1';
7.00     u_702 = *on;
7.00   endif;
7.08  *
7.08  * Annen betingelse og nobb eller sano
7.08  *
7.08   CallP CO402R(l_filg:w_firm:0:'FD120R_708':
7.08                    co402_verdi1:co402_verdi2);
7.08   if co402_verdi1 = '1';
7.08     u_708 = *on;
7.08   endif;
7.09a *
7.09a * Sjekk om Solve VA
7.09a *
7.09a  CallP CO402R(l_filg:w_firm:0:'SOLVE_VA':
7.09a                   co402_verdi1:co402_verdi2);
7.09a  if co402_verdi1 = '1';
7.09a    u_solve = *on;
7.09a  endif;
      *
     c                   endsr
