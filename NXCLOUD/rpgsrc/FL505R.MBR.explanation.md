# Program FL505R – Customer Project, Show Details

## Overview

**FL505R** is a display program within the ASOFAK system, designed to present detailed information about a specific customer project. It is typically invoked from other programs or menus, receiving the company (firm), customer, and project identifiers as parameters, and then retrieving and displaying comprehensive details about the project and related entities.

The program is structured as a classic RPG/400 interactive workstation application, using several physical and logical files for lookups, and calling external programs for additional information when required.

## Files Used

- **fkprl1 / fkprlu**: Customer project master and update files.
- **rkunl1**: Customer master file.
- **fusrl1**: User master file.
- **ra09l1**: Salesperson master file.
- **ra25lr**: Route master file.
- **ra06pf**: Discount/override code master.
- **aposl1**: Postal code to city mapping.
- **fl505d**: Workstation display file.

All files are renamed upon declaration for clarity and to avoid name conflicts.

## Parameters

- **p_firm**: Company identifier.
- **p_kund**: Customer number.
- **p_kpro**: Project number.
- **p_stat**: (v6.30) Status flag for external program calls.

## Main Flow

### 1. Initialization (`*inzsr`)

- Parameters are received and mapped to internal variables.
- Key lists for file access are constructed using the received parameters.
- The screen is initialized with the relevant customer and project numbers.

### 2. Project Lookup and Data Gathering

- The program chains into **fkprl1** (customer project master) using the provided keys.
    - If the record is not found, the program exits immediately.
- Project fields are loaded into the screen buffer variables (c2xxx fields), including project name, address, contact info, etc.
- Date fields are handled with date conversion logic, moving from numeric to display format only when values are not *loval*.
- Several fields are explicitly blanked out before secondary lookups.

### 3. Supplementary Lookups

The program enriches the screen data with descriptive fields by looking up related master files:

- **Salesperson name** via **ra09l1** if a salesperson code is present.
- **Customer name** via **rkunl1**.
- **City/postal location** via **aposl1** if a postal code is present.
- **Bonus customer name** via **rkunl1** if a bonus customer is associated.
- **Override/discount code description** via **ra06pf**.
- **Override customer/project names** via **rkunl1** and **fkprl1** as appropriate.
- **Route description** via **ra25lr**.
- All lookups use the appropriate key lists, and results are only applied if the target record is found.

### 4. Project Information from Accounting

- The subroutine `sjekk_prosj` is called to retrieve additional project information, such as project text descriptions, by calling an external program (RS880R).
    - The call passes project number and receives back text fields.
    - The old call to RS770R is commented out (legacy).

### 5. Display and User Interaction

- The main screen (`c2bld` record format) is displayed via `EXFMT`.
- If function key F2 is pressed (`*INKF`), the subroutine `xf2win` is executed to show additional payment condition details in a popup window (`f2win` format).
    - This involves further field population and a call to external program RS703R for payment condition text.
- The user can return to the main screen or exit.

### 6. Program Termination

- After the user exits, the program sets the LR indicator and returns.

## Subroutines

### `sjekk_prosj`

- Calls external program RS880R to fetch project accounting information.
- Populates project text fields for display.
- Handles legacy parameters as comments.

### `xf2win`

- Populates additional fields related to payment terms.
- Calls external program RS703R to retrieve payment condition text.
- Handles the display of the popup window (`f2win`).

### `*inzsr`

- Handles program initialization, parameter mapping, and key list setup.

## Design Conventions and Patterns

- **Key Lists**: All file accesses use named key lists, constructed in `*inzsr` for maintainability.
- **Screen Buffer Fields**: All screen fields follow a `c2xxx` or `f2xxx` naming convention, mapping directly to display file fields.
- **External Program Calls**: Business logic that requires complex or shared routines (e.g., project/accounting info, payment conditions) is offloaded to external programs (RS880R, RS703R).
- **Date Handling**: Dates are stored as numeric and converted for display using MOVE with *DMY format, only if the source is not *loval.
- **Conditional Lookups**: All enrichments from related files are guarded by `IF` and `%FOUND` checks, ensuring data integrity and preventing runtime errors.

## Business/Domain-Specific Logic

- **Customer Projects**: The program is centered around customer projects, which are identified by a combination of company, customer, and project number.
- **Descriptive Enrichment**: The program’s main value is in presenting not just raw project data, but also human-readable names and descriptions by joining with related master files.
- **Overrides and Bonus Customers**: Special fields such as override customer/project and bonus customer are handled, with lookups for their names and descriptions.
- **Payment Conditions**: Payment terms are not stored directly but are retrieved via an external program, reflecting a normalized data model.
- **Routes and Logistics**: The system supports route codes and descriptions, indicating the business deals with logistics or service delivery.

## Interactions with Other Modules

- **RS880R**: Retrieves project/accounting information (project text, etc.).
- **RS703R**: Retrieves payment condition descriptions.
- **Display File FL505D**: Provides the main screen and popup window formats.

## Notable Version History

- Multiple enhancements and bugfixes are documented in the header, including support for new fields (e.g., invoice type, route, building documentation).
- The program is actively maintained, with business logic updates to support evolving requirements.

## Summary

FL505R is a core display program for customer projects, responsible for aggregating and presenting all relevant master data and descriptive information to the user. It relies heavily on master file lookups and external business logic modules, and is structured to be robust, maintainable, and extensible for future business needs. The codebase follows established conventions for key management, field naming, and separation of concerns via subroutines and external program calls.