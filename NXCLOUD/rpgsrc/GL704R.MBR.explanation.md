# Program Documentation: BF204R (ASOKON System)

## Overview

This program, **BF204R**, is a batch processing utility within the ASOKON system. It processes records from the input file **ARETPF (gretpf)**, classifies each record by type, and distributes them to one of several output files:

- **GOCRPF (gocrpf)** – OCR returns
- **GTGIPF (gtgipf)** – Telegiro (REM) returns
- **GKTOPF (gktopf)** – Account information
- **GINKPF (ginkpf)** – Collection (Inkasso) returns

The program also handles special business rules for certain record types, particularly regarding how REM and Inkasso returns are identified and processed.

## File Relationships

- **ARETPF (gretpf)**: Input file, contains mixed return records.
- **GOCRPF (gocrpf)**: Output file, receives OCR return records.
- **GTGIPF (gtgipf)**: Output file, receives REM/Telegiro return records.
- **GKTOPF (gktopf)**: Output file, receives account information records.
- **GINKPF (ginkpf)**: Output file, receives Inkasso (collection) return records.

## Data Structures

### Overlay Data Structure

A data structure overlays the first 80 positions of each input record to facilitate field extraction and type matching:

- **dsbexx**: 80-character buffer for the raw record.
- **dsink1**: Positions 1–4
- **dsrekt**: Positions 1–2 (record type code)
- **dsink2**: Positions 3–6
- **dsink3**: Positions 14–17
- **dsbetf**: Positions 41–46

These overlays allow for flexible and efficient record type identification, as different banks may use different layouts.

## Main Process Flow

1. **Initialization**
   - Counters for each record type (i, j, k, l) are set to zero.

2. **Record Processing Loop**
   - Reads each record from **gretpf**.
   - Exits if EOF is reached.

3. **Record Classification and Routing**

   - **OCR Returns**
     - Identified by `'NY'` in positions 1–2 (`dsrekt`).
     - Written to **gocrpf**.
     - Counter `i` incremented.

   - **REM/Telegiro Returns**
     - Identified by `'AH'` in positions 1–2 and `'BETFOR'` in positions 41–46.
     - Written to **gtgipf**.
     - Counter `j` incremented.
     - The next three records are also written to **gtgipf** (REM returns arrive in blocks of 4).
     - All processed records are deleted from **gretpf**.

   - **Inkasso (Collection) Returns**
     - Identified by `'ZXCN'` in any of positions 1–4, 3–6, or 14–17.
     - Written to **ginkpf**.
     - Counter `l` incremented.
     - Special handling for records with `'ZXCN'` in positions 14–17: creates an additional record by combining data from the current and next record, then writes this as a supplementary entry to **ginkpf**.

   - **Account Information**
     - Any record not matching the above criteria is assumed to be account information.
     - Written to **gktopf**.
     - Counter `k` incremented.

   - After processing and writing, the input record is deleted from **gretpf**.

4. **Loop Continuation**
   - After each record is processed, the next record is read and the classification process repeats.

5. **Program Termination**
   - When EOF is reached on **gretpf**, the program sets LR and exits.

## Special/Non-Obvious Business Logic

### REM/Telegiro Block Handling

REM returns are always processed in blocks of four consecutive 80-character records. The first record is identified by `'AH'` and `'BETFOR'`, and the next three records are automatically included as part of the same transaction. This is a domain-specific requirement due to the way REM returns are structured by banking partners.

### Inkasso Supplementary Posting

For Inkasso returns, if `'ZXCN'` is found in positions 14–17, the program creates an additional record:
- It combines the first 33 characters of the original record with `'.2'` and the next 40 characters from the following record.
- This supplementary record is then written to **ginkpf**.
- This logic supports the business requirement to capture additional information related to Inkasso payments and case closures.

### Flexible Account Information Handling

Account information records are a catch-all for any records not matching the above types. Since banks use varying layouts, no strict pattern matching is applied; all unmatched records are routed to **gktopf**.

## Indicators and Conventions

- File indicators (60–69) are used for file I/O status (e.g., *IN60 for EOF).
- *INLR is set on exit to signal RPG program end.
- The program uses explicit delete operations to remove processed records from the input file, ensuring no record is processed more than once.

## Integration Points

- This program is typically run as a batch job, likely as part of a nightly reconciliation or import process.
- Output files (**gocrpf**, **gtgipf**, **gktopf**, **ginkpf**) are consumed by downstream processes for further business handling (e.g., updating customer accounts, posting payments, or following up on collections).

## Summary Table of Record Type Routing

| Record Type           | Identification Criteria                              | Output File | Counter |
|-----------------------|-----------------------------------------------------|-------------|---------|
| OCR Returns           | `'NY'` in positions 1–2                             | GOCRPF      | i       |
| REM/Telegiro Returns  | `'AH'` in 1–2 and `'BETFOR'` in 41–46               | GTGIPF      | j       |
| Inkasso Returns       | `'ZXCN'` in 1–4, 3–6, or 14–17                      | GINKPF      | l       |
| Account Information   | Not matching any of the above                       | GKTOPF      | k       |

## Key Takeaways for New Developers

- **Record classification is positional** and relies on overlays for flexibility.
- **REM/Telegiro and Inkasso returns** have special business rules for multi-record and supplementary postings.
- **All processed records are deleted** from the input file to prevent reprocessing.
- **Counters** are maintained for each record type, possibly for logging or auditing purposes.
- **No validation is performed** for account information records due to variable layouts from different banks.

Familiarity with the business rules around return processing is essential for maintaining or extending this program. If you need to adjust handling for new banks or record types, be mindful of the positional logic and overlay structure.