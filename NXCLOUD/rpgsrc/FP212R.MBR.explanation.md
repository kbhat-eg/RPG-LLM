# Documentation: FP212R – Product Selection from Item Register for Label Printing

## Overview

**FP212R** is a central selection and preparation program in the ASOFAK system, responsible for extracting and preparing product data for label printing. It reads from the item master (vareregister), retrieves units, sales price, and optionally campaign prices for relevant sales units, and outputs structured data for label generation.

This program is a cornerstone for logistics and sales, ensuring that physical labels reflect correct, up-to-date product information, including pricing, units, and traceability data.

## Business Context

- **Domain:** Retail/Wholesale, Inventory Management, Label Printing
- **Purpose:** Extracts and collates item data (including campaign and sales pricing, EAN/GTIN, units, and storage info) for printing product labels.
- **Input:** Selection criteria (range, single item, campaign, or sales date) and label printing parameters.
- **Output:** Structured records for label printing (file `etikett`).

## High-Level Flow

1. **Initialization:** Reads parameters, sets up keys and variables.
2. **Selection:** Based on input mode, selects items:
   - By number range
   - By single item
   - By campaign (promotion)
   - By sales date
3. **Data Enrichment:** For each item:
   - Retrieves inventory and supplier data.
   - Determines pricing, campaign status, and VAT.
   - Retrieves or computes EAN/GTIN codes.
   - Prepares label fields, including sorting/grouping.
4. **Output:** Writes a record to the label output file for each item/label.

## Key Structures and Files

### Input Files

- **param:** Input parameters for the job.
- **vvarlr/vvarl1:** Item master tables.
- **vlagl1:** Inventory/location data.
- **vtill5:** Campaign/promotion register.
- **vvprl1:** Price register.
- **vfaspf:** Fixed register for label parameters.
- **vetil1/vetilu:** Label register (existing labels).
- **vpkol1:** Price code texts.
- **rlevl1:** Supplier register.
- **vvlel1:** Timber assortment (for specialized product types).

### Output File

- **etikett:** Output file for prepared label records.

### External Programs (APIs)

- **VL710R:** Retrieves product type.
- **VP716R:** Retrieves price information for up to three units.
- **VP720R:** Retrieves comparison unit and price.
- **FØ705R/FØ706R:** Retrieves VAT rates (standard/reduced).
- **FA910R:** Applies rounding rules to prices.
- **VE716R:** Retrieves EAN/GTIN code.
- **VL711R:** Retrieves price group.
- **CO402R:** Feature flag/configuration parameter retrieval.

## Key Business Logic

### Selection Modes

- **Range selection:** Extracts all items within a specified range (by item number, group, etc.).
- **Single item:** Extracts data for a specific item.
- **Campaign selection:** Extracts items part of a given campaign.
- **Sales date selection:** Extracts items with price records valid for a given date range.

### Data Enrichment

- **Inventory Data:** For each item, location-specific data is retrieved (e.g., warehouse, storage bin).
- **Supplier Data:** Supplier number, supplier-specific codes, and shelf location are included.
- **Pricing:** 
  - Retrieves up to three unit prices (sales price, comparison price, campaign price).
  - Handles campaign pricing and recalculates comparison prices if applicable.
  - Applies VAT and rounds prices according to company rules.
- **EAN/GTIN:** Attempts to retrieve the EAN/GTIN code; if missing, can construct one from the item number (with Mod10 check digit).
- **Text Fields:** Product description fields are sanitized for special characters based on printer type.
- **Sorting:** Output can be sorted/grouped by various criteria (item, location, supplier, product group) as determined by input parameters.

### Label Register Update

- Updates or inserts label records in the label register (`vetilu`) with the latest print date, price, GTIN, etc.

## Notable Design Patterns and Conventions

- **Extensive Use of External Programs:** Most business rules (pricing, VAT, product type, GTIN) are encapsulated in external programs, promoting modularity and reuse.
- **Feature Flags:** New behavior can be enabled/disabled via configuration parameters (see `CO402R` and `u_703`).
- **Backward Compatibility:** Many code branches and comments indicate careful maintenance for historical changes and customer-specific adaptations.
- **Data-Driven:** Selection and output behavior is highly parameterized, supporting a wide range of label printing scenarios.

## Important Variables and Data Structures

- **w_firm:** Company number (multi-company support).
- **w_vare, g_vare:** Item number (current and previous, for de-duplication).
- **w_lage:** Warehouse/location code.
- **w_plas:** Storage bin/location within the warehouse.
- **w_kpri:** Price code indicator (standard, campaign, etc.).
- **w_pri1, w_pri2, w_pspr:** Prices (main, secondary, comparison).
- **w_eann:** EAN/GTIN code.
- **w_tek1, w_tek2:** Product description lines for the label.
- **w_anta:** Number of labels to print.
- **w_vtyp:** Product type (e.g., 'U' for expired).
- **w_etyp:** Label type.
- **w_lv_nobb:** Timber assortment number (specialized for certain product types).
- **b_kamp:** Flag indicating whether campaign price is used.

## Subroutines

- **beh_fratil:** Handles selection by number range.
- **beh_varer:** Handles single item selection.
- **beh_kampanje:** Handles campaign-based selection.
- **beh_salgsdato:** Handles sales date-based selection.
- **hent_pris:** Calls pricing APIs and determines correct prices.
- **klar_pris:** Prepares/rounds prices for label output, applies VAT, handles campaign logic.
- **klar_rest:** Prepares non-price fields (EAN, supplier, text, sorting).
- **hntean:** Retrieves or constructs EAN/GTIN code.
- **eansjk:** Computes Mod10 check digit for EAN/GTIN construction.
- **oppd_etikett:** Updates or inserts label record in the label register.

## Interactions with Other Modules

- **External APIs:** As listed above, for product type, pricing, VAT, GTIN, and feature flags.
- **Master Data:** Reads from item, inventory, supplier, campaign, and price registers.
- **Label Register:** Updates/creates records to track last print date, price, and GTIN per item/location.

## Special/Non-Obvious Details

- **Campaign/Promotion Handling:** Campaign prices override standard prices and require special handling for comparison price recalculation.
- **VAT Handling:** VAT rates are fetched dynamically based on product and date, supporting standard and reduced rates.
- **EAN/GTIN Construction:** If a code is missing, the program can build one using the item number and Mod10 algorithm, but only if allowed by business rules.
- **Printer-Specific Text Sanitization:** Product descriptions are sanitized differently depending on the printer type, using translation tables for special characters.
- **Sorting Logic:** Output sorting/grouping is controlled by parameters and supports various business needs (by item, location, supplier, or product group).
- **Feature Flags/Parameterization:** Behavior can be toggled or adjusted via parameters, enabling customer or version-specific logic without code changes.

## Maintenance and Evolution

- The code is heavily commented with a detailed change log, indicating frequent business-driven changes and enhancements.
- New fields and logic have been added over time (e.g., expanded product group, extended label fields, support for timber assortment).
- The program is designed to accommodate evolving business requirements, especially related to pricing, labeling, and traceability.

## Summary

**FP212R** is a robust, highly parameterized program for extracting and preparing item data for label printing in the ASOFAK system. It orchestrates complex business logic for item selection, pricing, VAT, and traceability, leveraging a modular architecture with extensive use of external programs and configuration-driven behavior. Its design reflects deep integration with inventory, pricing, and campaign management, supporting both standard and customer-specific label requirements.