# Explanation of RPG Program VV788R

This program is written in ILE RPG (RPG IV, also known as RPGLE), and its purpose is to remove ("delete") all deleted items (varer) in a certain file group or company, typically as part of a data synchronization or migration process.

Below is a breakdown of the program's logic and structure.

---

## 1. **Header and Meta Information**
- `h option(*nodebugio) datedit(*dmy)`: Sets the program options:
  - `*nodebugio`: Disables debug I/O.
  - `datedit(*dmy)`: Sets date edit format to Day-Month-Year.

- The commented header describes the system, program, revision history, and its Scandinavian/Norwegian context.

---

## 2. **File Declarations**
- **From File (Source of Deleted Items):**
  ```rpg
  fvvasl1    if   e        k disk    rename(vvaspfr:vvasl1r)
  ```
  - Reads deleted items from the file/group to be copied from (`vvaspfr`), with the record format renamed to `vvasl1r`.

- **To Files (Target, where deletion/check happens):**
  ```rpg
  fvvarlu    if   e        k disk    rename(vvarpfr:vvarlur)
  fsstal2    if   e        k disk    rename(sstapfr:sstal2r)
  ```
  - `vvarlu`: Item master file in target company/group.
  - `sstal2`: Sales statistics file, used to check if the item was sold recently.

---

## 3. **Data Structures and Variables**
- **Parameter Data Structures:**
  - `d_list`: 260 bytes, overlays for individual fields like file group (`d_fgrp`) and firm (`d_firm`).
  - `d_list2`: 8 bytes, overlays for similar fields for the target.

- **Parameter Variables:**
  - `p_list` and `p_list2`: To receive parameters into the program.

- **Variables for Item Keys and Fields:**
  - Used for file keyfields and program logic.

---

## 4. **Main Program Logic**

### a. **Initialization**
- Subroutine `*inzsr`:
  - Sets up parameter lists.
  - Fills data structures from entry parameters, sets up keys for file access.

### b. **Date Calculation**
- Gets the current date and subtracts one year. This is used later to check for sales activities in the last year.

### c. **Main Processing Loop**
- Reads all deleted items from the `vvasl1` file (source: items marked as deleted).
- For each item, it calls the subroutine `behandling`.

### d. **End Program**
- Releases resources and ends the program.

---

## 5. **Subroutines**

### a. **behandling (Processing a Deleted Item)**
- Checks if the item exists in the target's item master (`vvarlu`).
- If found, calls `ktrl_vare` to check if it can be deleted.
- If deletable:
  - Calls external program (`VV400R`) to delete the item in the target group/company.

### b. **ktrl_vare (Control if Item Can Be Deleted)**
- Calls external program (`VV490R`) to see if the item exists in any order or has stock in any warehouse.
  - If so, sets `b_slett` to off (cannot delete).
- Checks for sales statistics in the past year:
  - If found, item cannot be deleted.

---

## 6. **Key Usage and Data Movement**
- Uses data structure overlays and key lists (`klist`/`kfld`) for efficient indexed file access.
- Uses `*entry plist` to receive and process program parameters.

---

## 7. **External Programs Called**
- **VV400R**: The deletion routine for items.
- **VV490R**: Checks if the item is present in orders or has inventory.

---

## 8. **High-Level Flow**

1. **Initialize**: Set up parameters, keys, calculate date minus one year.
2. **Loop through Deleted Items** in the source file group/company.
3. **For each item**:
   - If the item exists in the target group/company,
   - Check if the item is *not* in an order and has no stock,
   - Ensure no sales in the past year,
   - If all true, call the deletion program (`VV400R`).
4. **End program**.

---

## 9. **Typical Usage**
This program would be scheduled or run when synchronizing companies or file groups in an ERP system, to clean up old, deleted items that are no longer needed and are safe to remove (i.e., no recent activity or dependency).

---

## 10. **Norwegian Comments**
The program includes Norwegian comments and variable names:
- `beskrivelse`: description
- `vare`: item
- `fjerning`: removal
- `filgruppen/firmaet`: file group/company
- `sletting`: deletion

---

## 11. **Summary**

- **Purpose**: To safely remove deleted items from a target group/company, after validating that they're no longer referenced or active.
- **Safety checks**: Ensures no orders, no stock, no sales in the past year before deletion.
- **Parameter driven**: Takes file group/company identifiers via parameters.
- **Modular**: Uses external programs for business logic decoupling.

---

## 12. **Onboarding Tips**
- **Understand the file structures**: Know the layouts of `vvasl1`, `vvarlu`, `sstal2`.
- **Track external program interfaces**: Get the parameter lists for `VV400R` and `VV490R`.
- **Review keylists and overlays**: RPG overlaying is crucial for parameter and key management.

---

This code is a good example of robust batch data maintenance in a legacy RPG system, following best practices for referential integrity and auditability.