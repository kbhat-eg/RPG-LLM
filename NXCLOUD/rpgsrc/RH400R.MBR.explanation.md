# Explanation of RPG Source Code

This RPG program (`RH400R`) is designed for IBM i (AS/400) and handles the deletion of postings/balances with parameters. It is an interactive green-screen (workstation) application, which interacts with both screen and database files.

Let's break down the code block by block:

---

## 1. Header Declarations

```rpgle
     H datedit(*dmy) option(*nodebugio)
```
- **`H`-Spec**: Sets options for the program.
    - `datedit(*dmy)`: Dates are expected in Day-Month-Year format.
    - `option(*nodebugio)`: Disables formatted I/O debugging.

---

## 2. File Declarations

```rpgle
     frh400d    cf   e             workstn
     fraa1pf    if   e           k disk    rename(raa1pfr:raa1pfr)
```
- **`F`-Spec**: File declarations.
    - `rh400d`: Workstation (screen) file.
    - `raa1pf`: Database file, keyed access. The record format is renamed to `raa1pfr`.

---

## 3. Data Definitions

### Local Data Area (LDA) Definitions

```rpgle
     d                uds
     d d_raar                300    303  0
     d d_valg                         1
```
- `uds`: Refers to the User Data Section (LDA).
    - `d_raar`: 4-digit numeric field at positions 300-303 in LDA.
    - `d_valg`: 1-character field.

### Other Data Area Fields

```rpgle
     d l_firm                944    946  0
     d l_fnav                951    980
```
- `l_firm`: 3-digit numeric field in LDA, probably a company code.
- `l_fnav`: 30-character field in LDA, probably company name.

### Standalone Variables

```rpgle
     d b_feil          s              1    inz(*off)
     d w_firm          s              3  0
     d p_in03          s              1
```
- `b_feil`: Flag, 1-char, initial value *off (false).
- `w_firm`: 3-digit numeric, working variable for firm.
- `p_in03`: 1-char, used to hold exit status.

---

## 4. Main Logic

### Opening Screen Loop

```rpgle
     c     b1taga        tag
     c                   exfmt     b1bld
```
- Label `b1taga` marks return point to show main screen (`b1bld`).
- `exfmt` displays and receives input from the user.

### Handle Exit (F3 Key)

```rpgle
     c                   if        *inkc or *inkl
     c                   move      '1'           p_in03
     c                   goto      avslutt
     c                   endif
```
- Checks if F3 (`*INKC`) or another exit key was pressed.
- Sets return parameter `p_in03` to '1' to indicate program ended via F3.
- Jumps to exit label `avslutt`.

### Input Validation

```rpgle
     c                   exsr      sjekk_input
     c                   if        b_feil = *on
     c                   goto      b1taga
     c                   endif
```
- Calls subroutine `sjekk_input` to validate user input.
- If error (`b_feil = *on`), redisplays the screen for error correction.

### Write to LDA

```rpgle
     c                   eval      d_valg = b1valg
     c                   eval      d_raar = b1raar
```
- Stores screen input fields (`b1valg`, `b1raar`) to LDA variables (`d_valg`, `d_raar`).

### Program Exit

```rpgle
     c     avslutt       tag
     c                   eval      *inlr = *on
     c                   return
```
- Label `avslutt` marks program exit.
- `*INLR = *ON`: Closes files and ends the program.

---

## 5. Subroutines

### A. sjekk_input (Input Validation)

```rpgle
     c     sjekk_input   begsr
     c                   eval      b_feil = *off
     c                   eval      *in31 = *off
     c                   eval      *in32 = *off
     c                   eval      *in33 = *off
```
- Resets error flags.

#### Regnskapsår (Fiscal Year) Validation

```rpgle
     c                   if        b1raar = 0
     c                   eval      *in31 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif

     c                   if        b1raar <> 0 and
     c                             b1raar > *year
     c                   eval      *in32 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif

     c                   if        b1raar <> 0 and
     c                             b1raar >= ra1aar
     c                   eval      *in33 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
```
- **Error 1**: If the fiscal year (`b1raar`) is zero.
- **Error 2**: If fiscal year is in the future (`b1raar` > current year).
- **Error 3**: If fiscal year is greater than or equal to `ra1aar` (read from DB).
- Sets relevant indicator (to highlight input field on screen) and error flag, then exits subroutine.


### B. *inzsr (Initialization Subroutine)

```rpgle
     c     *inzsr        begsr
     c     *entry        plist
     c                   parm                    p_in03
     c                   eval      w_firm = l_firm
     c                   eval      w_arow = 3
     c                   eval      w_acol = 2
```
- Reads entry parameter `p_in03`.
- Initializes work variables.

#### Load Company Info

```rpgle
     c     raa1pf_key    chain     raa1pfr                            61
     c     raa1pf_key    klist
     C                   kfld                    l_firm
```
- `chain` attempts to read a record from `raa1pf` using a key list built from `l_firm` (company code).
- This pulls status information for the current company.

---

## 6. Comments and Norwegian Terms

- Variables and comments are partially in Norwegian:
    - "Sletting av posteringer/saldi - parameter" = "Deletion of postings/balances - parameter"
    - "Regnskapsår" = "Fiscal year"
    - "Avslutt" = "Exit/Quit"
    - "Behandle åpningbildet" = "Handle opening screen"
    - "Behandling av skjermbilde" = "Processing screen"
    - "Sjekker input-felter" = "Check input fields"

---

# Summary

- This program presents a screen to the user (for year and action selection).
- It validates the fiscal year input according to specific business rules.
- The input is stored in the Local Data Area (LDA) for use by other programs.
- If F3 is pressed, it cleanly exits, returning a parameter to the caller.
- The code structure is typical for interactive RPG applications and is heavily based on green-screen I/O conventions.

---

## **Key Takeaways for New Developers**

- **LDA Usage**: Data is passed between programs using the LDA.
- **Screen I/O**: User interacts via a 5250 screen (`exfmt`, indicators).
- **Indicators**: Used to highlight errors and fields on the screen.
- **Subroutines**: Common for validation and initialization.

If you need a deeper walkthrough on any specific parts (like screens or file layouts), let me know!