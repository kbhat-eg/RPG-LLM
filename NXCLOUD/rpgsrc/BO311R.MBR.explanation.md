# Program Documentation: BO311R – Display Receipt/Store Invoice Line

## Overview

**System:** ASSHOP  
**Program:** BO311R  
**Purpose:**  
This program displays a single line from a receipt or store invoice ("bong-/butikkfaktura-linje"). It is typically used to inspect or present the details of a specific transaction line, including item, quantity, pricing, and discounts, as stored in the system's sales transaction files.

## Business Context

- **"Bong"** refers to a receipt or transaction slip, common in Nordic retail systems.
- The program is invoked with parameters identifying the company, fiscal year, workstation, receipt number, and line number.
- It retrieves both the header and detail line for the specified transaction, as well as order type information as needed.
- The program is display-oriented, using a workstation file for user interaction.

## File Dependencies

- **bohel1**: Receipt (bong) header file (renamed from `bohepfr` to `bohel1r`)
- **bodtl1**: Receipt line detail file (renamed from `bodtpfr` to `bodtl1r`)
- **votyl1**: Order type file (from version 8.01; renamed from `votypfr` to `votyl1r`)
- **bo311d**: Display file for screen interaction

## Parameters

On entry, the program receives (by parameter list):

- `p_firm`: Company code
- `p_aarr`: Fiscal year
- `p_wsid`: Workstation ID
- `p_numm`: Receipt number
- `p_line`: Line number

These are used as keys for file lookups.

## Key Variables

- Key fields for `bohel1` and `bodtl1` are defined to match the structure of the respective files.
- `votyl1_otyp` is used for looking up order type information.
- `w_firm` is a local copy of the company code for use in key lists.

## Program Flow

### Initialization (`*inzsr` subroutine)

1. **Parameter Assignment:**  
   Reads input parameters into local variables.

2. **Key List Setup:**  
   Defines key lists (`bohel1_key`, `bodtl1_key`, `votyl1_key`) for file access using the provided parameters.

3. **Firm Code Assignment:**  
   Sets `w_firm` from the input parameter for use in key lists.

### Main Logic

#### 1. Retrieve Receipt Header

- Sets key fields for `bohel1` from parameters.
- Chains to `bohel1` (receipt header). If not found (`*in60`), exits program.

#### 2. Retrieve Order Type (v8.01+)

- Sets `votyl1_otyp` from the order type in the header (`bootyp`).
- Chains to `votyl1r` to retrieve order type info.
- If the order type record has `vaokre = '-'`, inverts the sign of `bdsums` (for credit notes or returns).

#### 3. Retrieve Receipt Line

- Sets key fields for `bodtl1` from parameters.
- Chains to `bodtl1` (receipt line detail). If not found (`*in60`), exits program.

#### 4. Date Handling

- Selects either the invoice date (`bofkda`) or transaction date (`bobdat`) depending on whether the invoice number (`bobinr`) is non-zero.

#### 5. Data Mapping for Display

- Maps header and line detail fields to display variables (e.g., `b1numm`, `b1vare`, `b1anta`, `b1kpri`, etc.).
- Handles both standard and special discounts (`b1rab1`, `b1rab2`, `b1orab`).

#### 6. Net Amount Calculation

- If the order type is negative (`vaokre = '-'`), again inverts the sign of `bdsums` (defensive, in case of repeated logic).
- Calculates net amount (`b1sums`) by subtracting all discounts from the gross sum (`bdsums - bdrbe1 - bdrbe2 - bdorbe`).

#### 7. Display and User Interaction

- Presents the data using the `b1bld` display format.
- Handles standard function keys (exit/return).

### Program Termination

- On exit, sets the LR indicator to *on and returns.

## Special Considerations & Design Decisions

- **Order Type Handling:**  
  Order types with `vaokre = '-'` represent credit transactions. The program inverts the sign of amounts in these cases to ensure correct display of returns/credits.
  
- **Discount Calculation:**  
  The net line amount is calculated by deducting up to three different discounts (`bdrbe1`, `bdrbe2`, `bdorbe`) from the gross line sum. This logic was extended in version 6.31 for correct net price handling.

- **Versioned Enhancements:**  
  - v5.30: Receipt number expanded to 12A; other key field changes.
  - v6.30: Order-level discount (`bdorab`) added.
  - v6.31: Correction for sales price calculation.
  - v8.01: Support for order type register (`votyl1`), especially for handling returns with discounts.

- **File Renaming:**  
  All physical files are renamed on input for clarity and possible versioning reasons.

- **Error Handling:**  
  If any key file lookup fails, the program exits gracefully.

## Interactions with Other Modules

- The program is likely called from a transaction or inquiry menu, passing the relevant keys.
- Reads from the master files but does not update any data.
- The display file (`bo311d`) is used for user interaction.

## Conventions

- Norwegian variable and comment naming is used throughout; new developers should familiarize themselves with these terms (e.g., "bong", "butikk", "rabatt").
- Key lists (`klist`) are consistently defined for all major file accesses.
- Defensive logic is in place for both credit and standard transactions.

## Summary

BO311R is a display-only program for showing the details of a single receipt/invoice line, including all relevant pricing and discount information, with careful handling of both standard and credit transactions. It is a core part of the ASSHOP system’s transaction inquiry functionality.