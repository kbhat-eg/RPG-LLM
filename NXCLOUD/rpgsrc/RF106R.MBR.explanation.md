# Explanation of RPG Program RF106R

This program is classic ILE RPG (mainly RPG/400 style with some free-form RPG IV), used for financial postings ("Salderer utfra samle-nr" = "Balances by consolidation number"). The program processes journal entries relating to customers and suppliers, specifically handling settlement (balancing) based on a consolidation number.

## Main Purpose

- **Balances customer and supplier open items linked to a consolidation number ("samle-nr").**
- Adjusts posting records to mark them as balanced when the sum of items in the group is zero.
- Handles "agio/disagio" (exchange rate gain/loss) and cash discount postings.

---

## Structure Overview

### 1. Header and Maintenance Log

- **h-Specs**: Setup program title, date format (*DMY*), and options.
- **Maintenance log**: Tracks version history, bugfixes, and enhancements.

---

### 2. File Declarations (`F-Specs`)

Declares several physical files (database files):

- `rjoul1` / `rjoul1r`: Main journal entries
- `rktrl5` / `rktrl5r`: Customer ledger entries
- `rktrlu` / `rktrlur`: Customer ledger update records
- `rltrl5` / `rltrl5r`: Supplier ledger entries
- `rltrlu` / `rltrlur`: Supplier ledger update records
- `ra04l1` / `ra04l1r`: Account definitions
- `rjoulu` / `rjoulur`: Journal update records

All files have keys and most are renamed from their physical names to logical names.

---

### 3. Variable Definitions (`D-Specs`)

- Working fields for keys, amounts, user IDs, etc.
- Variables are defined, many with `like()` mirroring fields in the database files.
- `u_logg` controls program logging.

---

### 4. Key Lists (`KLIST`)

Defines composite keys for various files for efficient lookup:

- `rjoul1_key`, `rktrl5_key`, `rktrlu_key`, etc.

---

### 5. Main Logic (`C-Specs`)

The program uses indicator variables (`*in16`, `*in15`, etc.) and is driven by a looping structure reading through the postings, dealing with both customer ("K") and supplier ("L") records.

#### 5.1. Logging

- Uses program calls to `AB700R`, `AB705R` for logging if `u_logg` is enabled.

#### 5.2. Main Processing Loop

Repeatedly reads from the main journal file (`rjoul1r`):

- **Skips records not related to consolidation (`rjkrys <> 'S'`).**
- **Skips records not related to customers or suppliers (`rjreid <> 'K'` and `rjreid <> 'L'`).**
- **For customer posting** (`rjreid = 'K'`): Processes all related records by consolidation number, checks if posting group balances to zero, updates postings as balanced.
- **For supplier posting** (`rjreid = 'L'`): Similar logic for supplier ledgers.
- **Handles special cases** for cash discounts (kontantrabatt) and exchange rate differences (agio/disagio).

#### 5.3. Mark as Balanced

- Set amount fields to zero, clear consolidation number and cross-reference fields, set update user and timestamp.
- Update the record in the main journal file.

---

### 6. Special Routines

#### 6.1. `kurdif` subroutine

- Handles creation of agio/disagio (exchange gain/loss) postings for suppliers.
- Writes two journal entries: one for the supplier ledger, one for the general ledger.
- Properly sets debit/credit accounts depending on agio/disagio.

#### 6.2. `*inzsr` subroutine

- Initialization: receives the membership (user/group) as a parameter, sets up the various key lists.
- Calls the external program `CO402R` to check if logging should be enabled.

---

## Detailed Main Flow

1. **Initialization (`*inzsr`)**
    - Accepts membership/user.
    - Sets up keys for DB access.
    - Determines if logging is ON.

2. **Processing Loop**
    - **Read journal record** (`rjoul1r`).
    - **Filter records**: Only process if for consolidation and customer/supplier.
    - **Determine sign** for balance fields (`rjrstb`, ...).
    - **For "K" (customer)**:
        - Loop through matching customer ledger (`rktrl5`) entries.
        - Sum balances; if non-zero, skip.
        - If zero, loop again and update corresponding entries to mark as balanced.
        - Mark main journal records as balanced.
    - **For "L" (supplier)**:
        - Loop analogously through supplier ledger (`rltrl5`).
        - Handles agio/disagio if needed.
    - **Special tags** (`skurab`, `slerab`): For cash discounts, update without strict balancing.

3. **Mark as Balanced**
    - Zero out amounts, clear markers, update date/time/user, write updates to files.

4. **Logging**
    - If enabled, call external logging routines at start/end.

5. **Program End**

---

## Important Details

- **Agio/Disagio Handling**: If the balance differs due to currency rates, the program generates extra "gain/loss" (agio/disagio) postings to account for the difference.
- **Cash Discounts**: Special handling for cash discount postings, which are marked as balanced without comprehensive checks.
- **Resets and Updates**: When balancing happens, not only the main record is marked; all related ledger entries are also physically updated.

---

## File Relationships

- `rjoul1` / `rjoul1r`: Main journal entry (posting) file.
- `rktrl5` / `rktrlu`: Customer ledger and update file.
- `rltrl5` / `rltrlu`: Supplier ledger and update file.
- `ra04l1`: Used to look up certain accounts for posting.
- `rjoulu` / `rjoulur`: For writing log/trace records.

---

## Free-form RPG

- Some routines, particularly after version 7.01, use free-form RPG (`dcl-s`, `if ... endif;`, `callp`).

---

## Key Points for Onboarding

- This program is **transactional**: It processes each posting one-by-one, ensuring settlements are accurately reflected in both journals and ledgers.
- **Direct updates**: Changes customer/supplier subledger and main journal entries in-place.
- **Critical for financial accuracy**: Mistakes in this program could result in out-of-balance ledgers.
- **Indicators**: Uses RPG/400-style indicators to control flow and file I/O.
- **Subroutines and Tags**: Heavy use of `begsr`/`endsr` for subroutines and labels/tags for GOTO-based looping.
- **Integration with system logging** and auditing via external calls.

---

## Tips for Maintenance

- When changing file layouts, ensure `LIKE()` definitions are updated.
- All logic paths should be tested with both positive and negative balances, and for both customer and supplier roles.
- Audit trail is key—make sure logging routines are healthy and that CO402R is maintained.
- Be cautious with GOTO/tag constructs—they make flow harder to follow.
- If refactoring, aim to replace indicators and GOTO/tag loops with structured logic.

---

## Summary

**RF106R is a journal-posting balancer for both customer and supplier postings based on a consolidation number, handling both normal and special-case (like cash discount and currency gain/loss) entries, marking items as settled when appropriate, and updating all related records in both main and sub-ledgers, with optional audit logging.**