# VA590R Program Documentation

## Overview

**Program Name:** VA590R  
**System:** ASOFAK  
**Description:**  
This program manages the display and selection of "bildealternativ" (image/option alternatives) via a subfile interface. It is primarily used for inquiry (spørring) purposes, allowing users to browse, position, and select alternatives from a list. The program is interactive and driven by workstation input, utilizing subfiles for list display and navigation.

## Key Files

- **vbldl1**: Physical file, keyed access, renamed record format (`vbldpfr` → `vbldl1r`). Contains the data for the alternatives.
- **va590d**: Display file, contains the subfile (`b1sfl`), subfile control (`b2ctl`), and command key screen (`b2cmd`).

## Parameters

The program is called with three parameters:
- `p_firm`: Firm/Company identifier.
- `p_balt`: Alternative identifier.
- `p_btx1`: Text/description for the alternative.

These are used for positioning and selection logic.

## Variables and Constants

- **Subfile Control Variables:**
    - `w_stel`: Subfile counter.
    - `w_spge`: Subfile page size.
    - `w_srrn`: Relative record number in subfile.
    - `w_sfrn`: First record number on page.
    - `w_ssrn`: Last record number on page.
    - `w_curn`, `w_virn`: Used for current/virtual record positioning.
- **Selection Logic:**
    - `b_valg_ok`: Indicates if a valid selection has been made.
- **Subfile Page Size:**
    - `c_sfil`: Constant, set to 8 (number of records per subfile page).

## Indicators

- **LR**: End program.
- **10/11**: Roll up/down (paging).
- **12/13**: Subfile display/subfile control.
- **14/15**: Subfile clear/end.
- **21/22**: Home key/cursor positioning.
- **30**: Field protection.
- **31-79**: Error/warning indicators.
- **80-99**: Work indicators.

## Screen Layouts

- **B1SFL**: Subfile record format.
- **B2CTL**: Subfile control record.
- **B2CMD**: Command key screen.

## Main Program Flow

### Initialization (`*inzsr`)
- Receives program parameters.
- Sets up the key list for file positioning.
- Initializes the display.
- Positions the file to the starting point and fills the initial subfile page.

### Main Loop

1. **Command Key Screen** (`b2taga`):
    - Writes the command key screen (`b2cmd`).
2. **Subfile Display** (`b2tagb`):
    - Calls `dsp_subfile` to display the subfile.
    - If a selection has been made (`w_curn > 0`), calculates the first record to display based on the current record and subfile page size.
3. **Function Key Handling**:
    - **F3/F12**: Exit program.
    - **F5**: Refresh subfile (`forny`).
    - **Roll Up (F10)**: Next page (`crt_subfile`).
    - **Roll Down (F11)**: Previous page (`bck_subfile`).
    - **Home (F21)**: Cursor positioning.
4. **Positioning**:
    - If an alternative number is entered (`b2balt <> 0`), calls `posisjoner` to reposition the subfile.
5. **Subfile Processing**:
    - Calls `subfile` to process user selection in the subfile.
    - If a selection is made, exits the program.

### Program Exit (`avslutt`)
- Sets LR indicator and returns.

## Subroutines

### `forny` (Refresh Subfile)
- If a subfile page is already displayed, positions to the current record.
- Repositions the file and refreshes the subfile display.

### `posisjoner` (Positioning)
- If an alternative number is entered, positions the file to that record.
- Clears and refills the subfile from the new position.
- Resets the positioning field.

### `subfile` (Process Subfile Selection)
- Toggles the cursor positioning indicator.
- Iterates through displayed subfile records (`readc b1sfl`).
- If a record is selected (`b1valg = 1`), updates the output parameters and sets the selection flag.

### `clr_subfile` (Clear Subfile)
- Sets the subfile clear indicator and writes the control record to clear the subfile.
- Resets subfile counters and page information.

### `crt_subfile` (Create/Fill Subfile)
- Increments the subfile page counters.
- Reads records from the database and writes them to the subfile until the page is filled or end-of-file is reached.
- Updates the subfile page boundaries.

### `bck_subfile` (Page Backwards)
- If at the end of the subfile, positions to the previous page.
- Reads records backwards (`readp`) to fill the previous page.
- Clears and refills the subfile for the new page.

### `dsp_subfile` (Display Subfile)
- If there are records in the subfile, enables the subfile display indicator and displays the subfile control record.
- Otherwise, writes the command key screen.

### `*inzsr` (Initialization)
- Described above.

## Business/Domain Logic

- **Alternative Selection:** The program is used to browse and select "bildealternativ" related to a firm. The alternatives are displayed in a paged subfile, and selection is made by marking a record.
- **Subfile Paging:** Supports forward and backward paging, positioning to a specific alternative, and refreshing.
- **Parameter Passing:** The selected alternative and its description are returned to the caller via parameters.

## Design Patterns and Conventions

- **Subfile Paging:** Uses a fixed page size (`c_sfil`) and maintains explicit counters for current, first, and last records.
- **Indicator-Driven UI:** Function keys and screen transitions are managed via standard indicator conventions.
- **Separation of Concerns:** Subroutines are used for all major functional areas: initialization, subfile handling, paging, positioning, and display.
- **Explicit File Positioning:** Key lists are used for precise file positioning, supporting both forward and backward navigation.
- **Parameter-Driven:** All business actions are parameterized, supporting flexible integration with other modules.

## Integration and Dependencies

- **vbldl1**: Must be populated with the relevant alternatives for the firm in question.
- **va590d**: Display file must define the expected subfile, control, and command key formats.
- **Caller:** The program is typically called from another program or menu, passing firm and (optionally) an alternative to pre-position the list.

## Notable Details

- **Language/Localization:** Some variable names and comments are Norwegian (e.g., "bildealternativ", "spørring", "plassering"), reflecting the business domain.
- **Error Handling:** Minimal; relies on indicator patterns and EOF checks.
- **No Debug IO:** The program is compiled with `*nodebugio` for performance and security.

---

**Summary:**  
VA590R is a robust, modular subfile-driven inquiry and selection program for "bildealternativ" within a firm context. It adheres to standard RPG subfile and indicator conventions, with clear separation of logic for paging, positioning, and selection. Integration with other modules is via parameter passing, and the program is designed for interactive use on IBM i workstations.