# ILE RPG Program Explanation: Shelf Label Printing ("ASOFAK")

This ILE RPG/400 program is designed to print shelf labels ("hylle etiketter") for products, supporting different types of label printers. Below is an onboarding guide and a walkthrough of the code, focusing on architecture, key logic, data flows, and extensibility.

---

## 1. Overview

- **Purpose**: Reads product/shelf data from a file and prints labels formatted for different printers.
- **Supported Printers**: Meto 8100 Twinax, Meto 8100 Standard, Meto Bandit, Meto mi-4, Zebra QL320, Datamax Ex-2.
- **Inputs**: Product and shelf info, number of labels, etc., from the physical file `vaw1pf`.
- **Outputs**: Formatted printer commands to the `Etikett` printer file.

---

## 2. File Definitions

```rpg
fvaw1pf    if   f  512    64aidisk   // Input file: product/shelf data (disk)
fEtikett   o    f  132        Printer oflind(*inof) // Output file: printer
```

---

## 3. Key Data Structures & Fields

The `I` specs map fields directly from the input data (fixed-format RPG), such as:

- `vaanta`  Number of labels to print
- `vattxt`  Item text
- `vatvar`  Item number
- `vatpri`  Item price
- `vatenh`  Unit
- `vadato`  Date
- `vanobb`  NOBB code
- `vavare`  Internal item number
- `vaeann`  EAN number
- `valvar`  Supplier item number
- `vatek1`, `vatek2`  Item description lines
- `vaenh1`, `vapri1`  Sale unit 1 & price
- `vaenh2`, `vapri2`  Sale unit 2 & price
- ... many more

Variables (`D` specs) are used to prepare and format data for output.

---

## 4. Main Control Flow

### Main Processing Loop

```rpg
c     read      vaw1pf                                 61
c     dow       *in61 = *off
   ... processing for each record ...
c     read      vaw1pf                                 61
c     enddo
```

- Reads each record from the input file (`vaw1pf`).
- For each, processes and prints labels as needed.

### Label-Type Filtering

```rpg
c     if        vaetyp <> 2
c     goto      neste
c     endif
```
- Only processes records where the label type (`vaetyp`) is 2.

---

## 5. Printer Initialization & Setup

The program checks if this is the first record for this label batch and, if so, sends initialization commands to the correct printer, depending on the printer type (`l_type`):

```rpg
c     if        *in60 = *off
c         eval      w_hyle = 9
c         eval      w_skty = l_type
c         // Select printer init EXCEPT block
c         ifeq      0  : except    �clr0
c         ifeq      1  : except    �clr1
c         ifeq      2  : except    �pgm2
c         eval      *in60 =*on
c     endif
```

---

## 6. Data Preparation per Label

- **Product text** and **alternative product numbers** are conditionally moved and trimmed.
- **Order information** and **comparison price** flags are set using indicator variables (`*in24`–`*in27`).
- **Supplier item number** is checked for numeric content; if not numeric, filled with zeroes.
- **Label and barcode selection** is handled based on `vahyle` (label/ barcode type).

---

## 7. Printer Output Selection

Based on printer type (`w_skty`), the program writes data using different EXCEPT blocks:

- `�pgm0`, `�data0` for Meto 8100 Twinax
- `�pgm1`, `�data1` for Meto 8100 Standard
- `�pgm2`, `�data2` for Meto Bandit
- `�data4` for Meto mi-4 and Datamax Ex-2
- `�data5` for Zebra QL320

Each EXCEPT block contains printer-specific command formatting.

---

## 8. Printer Output Formatting (O-specifications)

- **O-specs** define exactly how to print each field for each supported printer, including printer control codes, positioning, and data mapping. There are blocks for each printer type, with many special cases for barcodes and special fields.

For example, the following O-spec (output spec) section for Meto 8100 Twinax initializes the printer and positions data fields:

```rpg
oEtikett   e            �clr0
o                                              '&02&20&03'      // Wake up printer
...
o          e            �pgm0
o                                              '&02'
o                                              '&0D001005030000312'
o                                              '&04'
```

For dynamic data, variables like `w_tek1` or `vaplas` are inserted into the output stream.

---

## 9. Special Handling for Quantities

For Meto Bandit, depending on the label quantity (`vaanta`), the format of the output changes, and different fields are filled (`w_anta_1`, `w_anta_2`, `w_anta_3`).

---

## 10. Extensibility and Maintenance

- **Adding printer types**: Add new exceptions (`EXCEPT`) and output blocks in the O-specs.
- **Adding/removing/adjusting fields**: Update the I-specs/D-specs and O-specs as necessary.
- **Adjusting label layouts**: Change positioning and formatting codes in the O-specs.

---

## 11. End of Processing

Once all records are handled, the program sends end-of-job commands for Bandit printers and sets on the LR indicator to close files and end the program.

---

## 12. Subroutines

- Only one subroutine exists (`*inzsr`), currently empty, but could be used for initialization.

---

## Summary Table

| Area               | Where/How     | Key Points                                |
|--------------------|--------------|--------------------------------------------|
| Input file         | `vaw1pf`     | Reads one record per label                 |
| Output file        | `Etikett`    | Formatted printer commands                 |
| Label types        | `vaetyp`, etc.| Only prints type 2; barcodes by `vahyle`   |
| Printer selection  | `l_type`     | Changes EXCEPT and formatting codes        |
| Data fields        | D/I specs    | Fixed-length fields, some with logic prep  |
| Output formatting  | O-specs      | By printer, using EXCEPT blocks            |
| Extensibility      | Data-driven  | To add printers or change layout           |

---

## 13. Common Entry Points for Debugging or Modification

- **I-specs**: Adjust if product file layout changes.
- **D-specs**: Add variables for new label content.
- **Main loop**: Add business rules for label inclusion/exclusion.
- **Output EXCEPT/O-specs**: Modify for new printer types or label layout.

---

## 14. Comments and Change Log

Extensive change log at the top details all major modifications, versions, and authors.

---

## 15. Language & Character Set

The code and comments are mostly in Norwegian, with Scandinavian characters. Business logic (e.g., "Bestillingsinformasjon" = "order info") is domain-specific.

---

## Conclusion

This program is a robust, modular, and extensible engine for printing product shelf labels on various specialized printers, with flexible formatting and support for a wide array of data fields. Maintenance is mainly about adapting to new printers, label layouts, and data field changes. If onboarding a new developer, focus learning on I/O handling, O-specs for printers, and the meaning of the key fields within `vaw1pf`. 

For further tuning, mapping business requirements for label contents and layouts directly to the code sections described above will help ensure correct output and easy troubleshooting.