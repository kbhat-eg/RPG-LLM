# NW820R – WAP/API: Retrieve Product Information

## Overview

This program, `NW820R`, is a core component in the ASOFAK system, serving as an API endpoint for retrieving detailed product (item) information. It is designed for integration with WAP (Warehouse Access Point) systems and other external clients that require product data lookups, primarily via data queues.

The program listens for incoming requests on an input data queue, processes each request to identify and validate the product, fetches the relevant information, and returns the result on an output data queue. It supports multiple product identification schemes (e.g., supplier number, EAN, logistics numbers) and is integrated with both physical files and business logic modules.

---

## Key Features

- **Data Queue Driven:** Uses IBM i data queues (`QRCVDTAQ`/`QSNDDTAQ`) for asynchronous request/response handling.
- **Flexible Product Identification:** Supports supplier numbers, EAN-128, EAN-13, internal product numbers, and logistics numbers.
- **Modular Lookups:** Interacts with other programs (notably `VV990R` for info retrieval and `VE710R` for EAN resolution).
- **Domain-Specific Logic:** Handles special cases for product types (e.g., logistics items, timber assortment).
- **SQL Integration:** Uses embedded SQL for logistics item lookups.

---

## Data Structures

### Input Data Structure (`d_inpu`)
- **d_kund:** Customer number (9,0)
- **d_kpro:** Customer product number (12A)
- **d_eann:** Product identifier (26A) – can be supplier number, EAN, etc.

### Output Data Structure (`d_outp`)
A 281-character structure containing:
- **d_vare:** Internal product number
- **d_nobb:** NOBB number (Norwegian building industry standard)
- **d_tek1/2:** Product descriptions
- **d_kpri:** Price
- **d_enh1/2/3:** Units of measure
- **d_sap1/2/3:** SAP-related fields
- **d_rab1/2/3:** Discounts
- **d_ntp1/2/3:** Net prices
- **d_lag1/2/3:** Stock info
- **d_omr1/2/3:** Area info
- **d_enhe:** Unit
- **d_anta:** Quantity

### EAN128 Structure (`d_e128`)
Overlay for parsing EAN-128 barcodes:
- **d_fast:** Prefix (2,0)
- **d_eean:** EAN number (14,0)
- **d_kode:** Code (4,0)
- **d_eant:** Quantity (6,2)

---

## Main Flow

### Initialization (`*inzsr`)
- Receives parameters (company, department, data queue names, etc.).
- Sets up key lists for file lookups (vvarl1/vvarl4).
- Stores company number for later use.

### Main Loop
- Continuously reads from the input data queue.
- For each non-blank input:
    - Calls the `behandling` (processing) subroutine.

### Processing Request (`behandling`)
1. **Initial Validation:** Checks if product identifier (`d_eann`) is present.
2. **Product Identification:** Calls `ident_vare` subroutine to resolve the input identifier to the internal product number.
3. **Fetch Product Info:**
    - Sets up customer/product info.
    - Calls `VV990R` to retrieve product details into `d_outp`.
    - If quantity found, sets unit and formats quantity.
4. **Respond:** Writes the result to the output data queue.

---

## Product Identification Logic (`ident_vare`)

The identification logic is domain-driven and prioritizes various schemes:

1. **Alphanumeric Identifier:** (contains non-digits)
    - Checks for logistics product via SQL lookup in `vvlepf`.
    - If not found, tries supplier number lookup in `vvarl4`.
2. **EAN-128 (26 digits):**
    - Parses EAN128 structure.
    - Calls `VE710R` to resolve EAN to internal product.
    - Looks up in `vvarl1`.
3. **Short Numeric (≤8):**
    - Pads and looks up as internal product number in `vvarl1`.
4. **EAN (≤14):**
    - Pads and calls `VE710R` to resolve EAN to internal product.
    - Looks up in `vvarl1`.
5. **Fallback (length < 26):**
    - Again checks for logistics product via SQL.
    - Tries supplier number lookup in `vvarl4`.

If all attempts fail, sets error flag.

---

## File and Program Interactions

### Physical Files
- **vvarl1:** Main product master file (keyed by company and product).
- **vvarl4:** Alternate lookup file, likely keyed by supplier product number.
- **vvlepf:** Logistics products mapping (for logistics number to internal product).

### External Programs
- **VV990R:** Business logic for retrieving product information (populates output structure).
- **VE710R:** Resolves EANs to internal product numbers and units.

### Data Queues
- **Input:** Receives requests from external systems.
- **Output:** Returns product information or error indication.

---

## Error Handling

- **Error Routine (`*pssr`):** Sets error flag and exits program.
- **Field-level:** If product cannot be identified, sets error flag in output.

---

## Special Considerations & Conventions

- **Overlay Fields:** Heavy use of overlays in data structures for efficient parsing of packed input/output.
- **Legacy Compatibility:** Handles various identifier lengths and formats for backward compatibility.
- **SQL for Logistics Items:** Embedded SQL is used to support logistics assortment (timber, etc.) introduced in later versions.
- **Comments and Versioning:** Extensive use of inline comments and version markers (e.g., 6.11, 6.31) for tracking enhancements.

---

## Summary

This program is a robust, queue-based API for product information retrieval, designed for high-throughput, flexible integration. Its identification logic is tightly coupled to the business domain, supporting multiple product numbering schemes and legacy requirements. It acts as a bridge between WAP/external systems and the internal product master, ensuring correct and efficient data delivery.

**If you are extending or debugging this program:**
- Pay close attention to the product identification logic, as it is the heart of the business rules.
- Be mindful of the way overlays and data queues are used for performance and compatibility.
- Any changes to file layouts or external program interfaces (VV990R/VE710R) must be coordinated carefully with this module.