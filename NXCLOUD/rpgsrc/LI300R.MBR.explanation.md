# RPG Program LI300R: Picking EDI Packing Slips for Approval

## Overview

This program, **LI300R**, is responsible for picking EDI packing slips for approval within the ASLAGR system. Its primary function is to process EDI packing slip records, validate associated purchase orders, update their statuses, lock records to prevent duplicate processing, and handle downstream actions such as inventory updates and deletion of completed orders.

The code is heavily integrated with the logistics and order management domain, interacting with numerous files (physical and logical), and follows a complex set of business rules tied to EDI processing, picking, and inventory management.

---

## Business Context

- **Packing Slip (Pakkseddel):** A document accompanying a shipment, listing the contents.
- **EDI (Electronic Data Interchange):** Automated, structured transmission of order/shipment information between systems.
- **Order Picking:** The process of preparing items for shipment based on received orders.
- **Approval Workflow:** Packing slips must be validated and approved before further processing.
- **Resting/Deletion:** If an order is empty (fully picked), it may be deleted via a standard process.

---

## Key Business Rules & Features

- Only valid orders (not already processed or locked) are eligible for picking.
- The program ensures that the same order number cannot be processed more than once in a session.
- Special handling for lines with discrepancies (resting), text lines, and service items.
- Locks are applied to prevent double-picking by other users/sessions.
- Inventory is updated as part of the process.
- Supports deletion of orders that are fully processed (empty).

---

## Main Data Files and Relationships

The program interacts with a variety of files, each representing a different aspect of the business process:

| File        | Description                                 | Usage in Program                  |
|-------------|---------------------------------------------|-----------------------------------|
| VOTYL1      | Order type register                         | Order type validation             |
| LBHOI2/3    | Purchase order header (by package/colli)    | Validate order, update status     |
| LPKOI3      | Packing slip header (colli)                 | Lock/unlock, update status        |
| LPKLIU      | Packing slip lines                          | Lock/unlock, update status        |
| LBLII2      | Purchase order lines                        | Update status, unlock             |
| LPHOI1/U    | Packing slip header (main)                  | Lock/unlock, update status        |
| LOHEL1/U    | Purchase order header (main)                | Update status, lock/unlock        |
| LODTL1/R/U  | Purchase order lines (various views)        | Delete, update, inventory         |
| LPLOL1/U    | Picking parameter register                  | Track picked orders               |
| LPLLLU      | Picked lines register                       | Track picked lines                |
| LSTSL1      | Inventory status codes                      | Lookup for inventory updates      |
| LUSRL1      | User register                               | User validation                   |
| RLEVL1      | Supplier register                           | Resting logic                     |
| LBREIU      | Packing slip work register                  | Resting logic, deletion           |
| VVARL1      | Item master                                 | Service/text line logic           |

---

## Program Structure

### 1. Initialization (`*inzsr`)

- Receives parameters defining the context (order type, number, supplier, etc.).
- Sets up key fields for all major files.
- Fetches relevant status and resting codes for the supplier.

### 2. Main Processing Loop

#### A. Identify Valid Orders for Picking

- Loops through LBHOI3 (purchase order headers by colli) to find orders matching criteria:
    - Not already processed (`pbhsta` ≠ '99'/'90')
    - Order type is valid and not locked (`vaoakk` = 1)
    - Not already processed in this session (checked via arrays)
- Builds arrays of eligible order numbers, suffixes, and associated data.

#### B. User Interaction

- Presents eligible orders on the screen.
- Handles user function keys (F3=Exit, F4=Inquiry).

#### C. Locking Orders and Packing Slips

- Locks the EDI packing slip and all associated colli and lines to prevent double-picking by other users.
- Updates status fields, timestamps, and user fields to reflect the lock.

#### D. Process Each Valid Order

For each eligible order:

- Calls external program `LO709R` to update the order header (marks as being processed).
- Locks the order and related colli headers.
- Calls subroutine `scan_li200` to handle actual picking logic:
    - Determines last item line (to include subsequent text/service lines).
    - Loops through order lines, updates picking line register, and handles text/service lines.
    - Calls subroutines to handle resting (discrepancy) logic and inventory updates.
- Calls external program `LI301R` for printing or further processing.
- Unlocks the order and updates status as "received".
- If all lines are processed/deleted, calls deletion program `LO400R`.

#### E. Finalize Packing Slip Status

- Updates packing slip and associated records to final status ("received").
- Unlocks lines and headers.

#### F. Handle Resting and Deletion

- For lines not to be rested, deletes from the work register and order lines.
- If the order is empty after processing, triggers deletion.

---

## Subroutines

### `scan_li200` — Picking Logic

- Finds the last item line in the order (to ensure text/service lines after the last item are included).
- Loops through all order lines:
    - Unlocks lines.
    - Writes or updates picked line register.
    - Handles text/service lines and service items (via `sub_prevtxt` and `sub_lasttxt`).
    - Handles resting logic (via `sub_rest`).

### `sub_rest` — Resting Logic

- Writes to the work register for lines that need to be handled as discrepancies (rested).
- Updates status and timestamps.

### `sub_prevtxt` and `sub_lasttxt` — Text/Service Line Handling

- Ensures that text lines and service items associated with picked lines are also picked.
- Writes/updates picked line register accordingly.

### `oppdat_lager` — Inventory Update

- Prepares a data structure for inventory transaction.
- Calls external program `VL001R` to update inventory, unless the item is flagged as already processed by the inventory system.

---

## Notable Design Decisions & Patterns

- **File Locking and Status Management:** The program is meticulous about locking records (setting status codes, user, timestamp) to prevent concurrent modifications or double-processing.
- **Array-Based Session Tracking:** Uses arrays to prevent the same order from being processed multiple times in one session.
- **Subroutine Decomposition:** Complex logic for picking, resting, and text/service line handling is decomposed into subroutines for maintainability.
- **External Program Calls:** Delegates specialized tasks (order header updates, printing, inventory updates, deletion) to external programs, following a modular approach.
- **Backward Compatibility and Evolution:** The code contains numerous versioned comments (e.g., 7.04, 7.09), indicating ongoing adaptation to changing business requirements (e.g., handling of service lines, new resting logic, improved line picking).

---

## Domain-Specific Conventions

- **Status Codes:** Status fields (e.g., '50', '90', '99') are used throughout to indicate processing states (locked, received, processed).
- **Resting:** "Resting" refers to handling discrepancies between ordered and received quantities. Special logic ensures these are processed correctly and not included for picking if not allowed.
- **Text/Service Lines:** Text lines (ldltyp = 'TX') and service items (item type 'T') require special handling to ensure they are included with their associated item lines.

---

## Interactions with Other Modules

- **LO709R:** Updates order header to indicate the order is being processed.
- **LI301R:** Handles printing or further processing after picking.
- **LO400R:** Deletes orders that are fully processed.
- **VL001R:** Updates inventory based on picked lines.

---

## Error Handling & User Feedback

- If no valid orders are found, or if user permissions are insufficient, the program sets indicators to inform the user and halts processing.
- Function keys allow the user to exit or perform inquiries at key points.
- All updates are timestamped and attributed to the current user for auditability.

---

## Key Points for New Developers

- **Do not alter status codes or locking logic lightly.** These are critical to preventing data corruption and double-processing.
- **All file accesses are tightly coupled to specific business rules.** Ensure that any changes to file layouts or business processes are reflected in the relevant logic.
- **Subroutines are used to encapsulate complex or repeated logic.** Follow this pattern for new features.
- **External program calls are used for specialized tasks.** Understand the interfaces and expected side effects of these programs before making changes.
- **Array usage is session-local.** Do not assume persistence across separate program invocations.
- **Text/service line handling is non-trivial.** Ensure you understand the rules for inclusion/exclusion of these lines in picking.

---

## Summary

LI300R is a central component in the EDI packing slip picking and approval workflow. It ensures data integrity, prevents duplicate processing, and integrates with inventory and order management subsystems. The program is designed for robustness and traceability, reflecting the business-critical nature of the logistics processes it supports. 

New developers should familiarize themselves with the domain-specific terminology, file relationships, and the modular structure of the code, especially the locking/status management and the handling of special line types (text/service/resting). Any changes should be made with careful consideration of the overall workflow and data integrity requirements.