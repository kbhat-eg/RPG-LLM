# Program VY100R – Documentation

## Overview

**Program Name:** VY100R  
**System:** ASOFAK  
**Description:** Maintenance of delivery types (“Leveringstype, vedlikehold”)  
**Author/History:**  
- Initially created 21.01.99 by HKO  
- Updated 26.06.09 by BSA (added tracking information)  
- GUI-related changes in version 7.00 (note: some changes apply only to DDS)  

This program is a green-screen (workstation) application for maintaining a table of delivery types used in the business domain. It supports CRUD (Create, Read, Update, Delete) operations via subfile interfaces and several display panels.

---

## File Usage and Relationships

### Physical and Logical Files

- **vltpl1, vltpl2, vltplr, vltplu**  
  All are logical files (IF, UF) over the same physical file (`vltppfr`) but with different record formats:
  - `vltpl1r`, `vltpl2r`, `vltplrr`, `vltplur`
  - Used for different access paths: by type, by description, for reading, updating, etc.

### Display File

- **vy100d**  
  - Workstation file with subfile `b1sfl` (relative record number `w_srrn`)
  - Contains multiple record formats for different screens (see below).

### Data Structures

- **Local Data Area (LDA):** Used for user, firm, and navigation info.
- **Display Feedback (`dspfbk`):** Used to obtain cursor location and other display-specific info.

---

## Screen/Panel Layouts

- **B1SFL:** Subfile record for delivery type list.
- **B2CTL:** Subfile control record (header, navigation).
- **B2CMD:** Command keys/help panel.
- **C1BLD:** Entry panel for new key (when creating).
- **C1MSG:** Message panel for C1BLD (e.g., duplicate warning).
- **C2BLD:** Panel for create/change/view.
- **D1WIN:** Delete confirmation window.
- **K1WIN:** Copy window.

---

## Indicator Usage

The codebase relies on standard indicator conventions:

- **LR:** End of program
- **10–15, 21–22, 30:** Subfile/page navigation, cursor placement, field protection.
- **31–79:** Error/warning indicators.
- **80–99:** Working indicators.

---

## High-Level Flow

1. **Initialization (`*inzsr`):**  
   - Set up keys for file access.
   - Load firm number from LDA.
   - Position to the start of the file and fill the subfile.

2. **Main Loop (tags `b2taga`, `b2tagb`):**
   - Display command panel.
   - Display or refresh subfile.
   - Handle function keys (roll, page up/down, create, change, copy, delete, position, exit).
   - Subfile navigation and processing.

3. **CRUD Operations:**
   - **Create:** Via `xc1bld` and `xc2bld` subroutines.
   - **Update:** Via `subfile` processing and `xc2bld`.
   - **Delete:** Via `xd1win`.
   - **Copy:** Via `xk1win`.

---

## Key Business Logic

### Subfile Management

- **Subfile is paged:**  
  Uses variables like `w_fcrn`, `w_srrn`, `w_ssrn`, etc., to manage paging and relative record numbers.
- **Navigation:**  
  Handles roll, page up/down, and positioning on either type or description.
- **Positioning:**  
  Allows direct positioning in the subfile by type or description.

### Delivery Type Constraints

- **Reserved Values:**  
  Delivery types less than 5 are reserved; attempts to create/change/copy these trigger error indicators.

### Data Integrity

- **Duplicate Prevention:**  
  Before creating a new delivery type, checks if it already exists and prompts the user if so.
- **Audit Fields:**  
  On create/update, timestamps (`vyedat`, `vyetim`, etc.) and user fields (`vyeusr`, `vyousr`) are set.

### User Experience

- **Field Protection and Messages:**  
  Uses indicators to protect fields or display error/warning messages as needed.
- **Cursor Placement:**  
  Manages cursor positioning for usability.

---

## Subroutine Structure

### Subfile Routines

- **clr_subfile:**  
  Clears the subfile and resets counters.
- **crt_subfile:**  
  Fills the subfile with records up to the current page size.
- **bck_subfile:**  
  Handles page-up (back) functionality.
- **dsp_subfile:**  
  Displays (EXFMT) the subfile control record.

### Record Maintenance

- **forny:**  
  Refreshes the subfile, repositions as necessary.
- **posisjoner:**  
  Positions the subfile based on type or description.
- **subfile:**  
  Main loop for processing subfile rows (edit, copy, delete, view).

### CRUD Panels

- **xc1bld:**  
  Handles the panel for entering a new delivery type key.
- **xc1msg:**  
  Message panel if the key already exists.
- **xc2bld:**  
  Create/change/view panel for a delivery type.
- **xd1win:**  
  Delete confirmation and action.
- **xk1win:**  
  Copy panel and logic.

---

## Design Patterns and Conventions

- **Tag/GoTo for Panel Loops:**  
  Uses tags and `GOTO` statements for looping through panel logic, a common pattern in legacy RPG.
- **Indicator-driven UI logic:**  
  UI state and error handling are managed via indicator bits, matching DDS conventions.
- **Modular Subroutines:**  
  Each logical operation (CRUD, navigation, display) is encapsulated in a subroutine for clarity and reuse.
- **Key Lists:**  
  All file access is via named key lists, initialized in `*inzsr`, supporting flexible access paths.

---

## Integration Points

- **Physical File (`vltppfr`):**  
  Central data repository for delivery types, accessed via multiple logical views for different operations.
- **Local Data Area (LDA):**  
  Used for per-session user and firm identification, supporting multi-firm operation.
- **Display File (`vy100d`):**  
  Contains all panels and subfiles, tightly coupled to the RPG logic for screen management.

---

## Notable Non-Obvious Behaviors

- **Subfile Paging:**  
  The subfile is not loaded all at once; only a page is filled at a time, improving performance for large datasets.
- **Positioning Logic:**  
  Supports direct jump to a type or description, not just sequential navigation.
- **Field and Error Indicator Management:**  
  Indicators are reused for various UI states (e.g., *in31 for reserved value error, *in32 for duplicate warning).
- **Audit Trail:**  
  On both create and update, timestamps and user IDs are automatically set for tracking.

---

## Summary Table: Key Variable Roles

| Variable      | Description                                   |
|---------------|-----------------------------------------------|
| w_fcrn        | First record number on page                   |
| w_srrn        | Relative record number in subfile             |
| w_ssrn        | Last record number on current page            |
| w_spge        | Page size of subfile                          |
| w_seqe        | Sequence mode: blank (by type), 'B' (by desc) |
| b_oppr        | Operation in progress (create)                |
| b_forn        | Subfile needs refresh                         |
| b_anul        | Operation cancelled flag                      |
| b_feil        | Error flag                                    |
| l_user        | User ID from LDA                              |
| l_firm        | Firm number from LDA                          |
| vltpl1_lety   | Key for type-based access                     |
| vltpl2_besk   | Key for description-based access              |
| vybesk        | Description field in delivery type file       |
| vylety        | Delivery type code                            |
| vyfirm        | Firm number in delivery type file             |

---

## Conclusion

This program is a robust, indicator-driven RPG application for maintaining delivery types, supporting multi-firm operation, paging, direct positioning, and full CRUD functionality with audit trails. The code is modular, with clear separation between UI, navigation, and data maintenance, and follows established RPG/400 and DDS conventions.

For onboarding, focus on understanding the subfile paging model, indicator-based UI state management, and the multi-access-path file logic. The physical file `vltppfr` is central, and the display file `vy100d` defines all user interaction points. The program is designed for extensibility and maintainability within the constraints of classic RPG and green-screen paradigms.