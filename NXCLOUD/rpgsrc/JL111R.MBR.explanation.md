# Program Overview

This RPG program (JL111R) is designed to maintain supplier contacts. It uses subfiles for listing, adding, changing, copying, deleting, and viewing contact records related to a supplier. The user interface is handled via display files (workstation file `JL111d`), and data is managed via several database files.

## High-Level Structure

- **Files**:
  - `jlevl1`: Main supplier file (renamed to jlevl1r)
  - `jlgsl1`, `jlgslr`, `jlgslu`: Contact files (renamed for specific use cases)
  - `JL111d`: Display/workstation file with subfile support (`b1sfl` etc.)

- **Indicators**:
  - Used heavily for control (LR for end of program, 10/11 for rollup/rolldown, 12-15 for subfile management, 30+ for field protection and error display).

- **Subroutines**:
  - Subfile handling (`crt_subfile`, `clr_subfile`, `bck_subfile`, etc.)
  - Maintenance routines for add, change, view, copy, delete contacts.
  - Positioning and display management.

---

## Key Data Structures and Variables

- **LDA Handling**: Fields to pick values like user, firm, etc. from Local Data Area.
- **Display Feedback** (`dspfbk`): Used to detect cursor location in the display file.
- **Keys**: Variables for constructing keys to chain/setll/setgt in files.
- **Subfile Variables**:
  - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc. for tracking subfile state (current record on page, subfile counter, page size, etc.).
- **Flags**: `b_oppr`, `b_forn`, `b_anul`, `b_feil` for controlling subfile/operation state.

---

## Main Control Flow

- The *main loop* alternates between **displaying subfile screens** and **handling user actions via function keys**.
- Actions handled include:
    - Navigate subfile (rollup/down, page, position cursor).
    - Add (`xc1bld`), Change/Copy/Delete/View (`xc2bld`, `xk1win`, `xd1win`), and refresh (`forny`) contacts.
    - Special panels (copy, delete confirmation, messages).
    - Subfile paging and clearing.

---

## Subfile Management

### Filling and Clearing Subfile

- **crt_subfile**: Fills the subfile with a page of records, up to a constant (c_sfil = 14).
- **clr_subfile**: Clears the subfile, resets counters and indicators.

### Navigating Subfile

- **bck_subfile**: Backs up one page in the subfile, using `readp` to read records in reverse order.
- **dsp_subfile**: Manages displaying the subfile to the user, activating appropriate indicators depending on subfile state.

---

## Maintenance Operations

### Add (xc1bld)

- Presents the user with the C1BLD panel for entering a new contact.
- Checks if the record already exists. If so, shows an info message screen (xc1msg).
- Calls the update subroutine (xc2bld) to actually perform the add.

### Change/View (xc2bld)

- Loads the data for a record (using `chain`), fills fields for the change/view screen (C2BLD).
- Allows changes to fields, validates input, writes the record back to the database.
- Also manages field protection (view-only) depending on the mode.

### Copy (xk1win)

- Shows copy window, allows copying an existing contact to a new key.
- Prevents overwriting if target already exists.

### Delete (xd1win)

- Shows delete confirmation window.
- Deletes the record after confirmation.

---

## Positioning and Paging

- **posisjoner**: Positions the subfile based on a given key. Used when the user inputs a specific key for positioning.
- **forny**: Refreshes subfile display after changes (add/change/delete).

---

## Entry and Initialization

- **Initialization routine** (`*inzsr`):
  - Receives parameters (supplier key, mode).
  - Reads LDA for user/firm data.
  - Loads supplier data, preloads subfile with contacts.
  - Sets up key lists for file operations.

---

## Panel/Screen Handling

- **Subfiles**: Used for listing multiple contact persons.
- **Pop-up Windows**: Used for copy/delete confirmation and messaging.
- **Field Protection**: Indicators used to make fields read-only in view mode or after operation.

---

## Error- and Edge-Handling

- **Input validation**: Mandatory fields checked before writes.
- **Duplicate checking**: Prevents adding duplicate contacts.
- **Error indicators**: Set to flag errors for display.

---

## Typical User Interaction

1. User is shown a list of contacts for a supplier (via subfile).
2. User can page, position, add, edit, view, copy, or delete records.
3. Each operation opens the relevant screen/window, responds to function keys, performs validation, and updates database/subfile as needed.
4. After any change, the subfile is refreshed to reflect changes.
5. Special cases (duplicate record on add, record not found for edit, etc.) are handled with info windows.

---

## Summary Table of Main Operations

| Subroutine    | Purpose                                      |
|---------------|----------------------------------------------|
| `crt_subfile` | Populate subfile with next page of records   |
| `clr_subfile` | Clear subfile and counters                   |
| `bck_subfile` | Display previous page in subfile             |
| `dsp_subfile` | Display current subfile, process indicators  |
| `forny`       | Refresh subfile after modifications          |
| `posisjoner`  | Position subfile on a given key              |
| `xc1bld`      | Add new contact (with validation)            |
| `xc1msg`      | Display duplicate-record message             |
| `xc2bld`      | Change/View a contact                        |
| `xd1win`      | Confirm and delete a contact                 |
| `xk1win`      | Copy existing contact to new key             |

---

## Key RPG Patterns Used

- **Extensive use of indicators** for UI and control logic.
- **Subfiles (SFILE keyword)** for interactive lists.
- **Parameter passing and use of LDA** for user/firm context.
- **Chained file access** for direct record operations.
- **KLISTs/KFLDs** for key construction to access records.
- **Display file feedback (INFDS)** for detecting cursor position.
- **Subroutine structure** (`begsr`/`endsr`) for modular logic.

---

## Onboarding Notes

- **Understand subfile logic**: Much of the complexity is in managing pages, indicators, and related variables.
- **Error/message handling**: Look for where indicators are set for error/info screens.
- **UI navigation**: Watch how function keys (INKx, INnn) are used, and how screen flow occurs via GOTO/TAG.
- **Duplicate logic**: Prevents certain actions (like add/copy) when record exists.
- **Operations are tightly coupled between display files and RPG,** so refer to the display file definitions for field names and indicators.

---

With this understanding, new developers can navigate both the logic of the RPG source and the associated display files, and can extend or debug the program efficiently.