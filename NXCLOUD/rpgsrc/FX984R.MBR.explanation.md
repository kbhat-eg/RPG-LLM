# RPG Program Explanation: `galkod` (Special Program - Inventory Update)

This RPG (ILE RPG, Fixed-format) program is designed to update inventory information by reading records from an input file (likely from a print/excel file), extracting group and UNSPSC (commodity code) data, and updating the corresponding records in an inventory group file.

Below is a thorough breakdown of each section for onboarding and maintenance:

---

## 1. Header and Documentation

**Comments** at the top describe:
- The system and program name.
- Purpose: Reads a file with UNSPSC codes and updates under-group info.
- Change log and author sign-off (BOF, 260413).

---

## 2. File Declarations

```rpg
flwexpf    if   e           k disk
fvugrlu    uf a e           k disk    rename(vugrpfr:vugrlur)
```
- **lwexpf** : Input file (likely export from Excel or similar), keyed, for reading inventory items.
- **vugrlu** : Output/update file for inventory groups. Renamed record format (`vugrpfr` as `vugrlur`).

---

## 3. Data Structures

### Excel File Data Structure

```rpg
d                 ds
d d_ex                         512
d  d_vgrp                        7    overlay(d_ex:1)
d  d_ogrp                        2    overlay(d_vgrp:1)
d  d_hgrp                        2    overlay(d_vgrp:3)
d  d_ugrp                        3    overlay(d_vgrp:5)
d  d_unsp                        8    overlay(d_ex:38)
```

- **d_ex**: Entire record, 512 chars.
- **d_vgrp**: The first 7 chars (group code).
- **d_ogrp**, **d_hgrp**, **d_ugrp**: Sub-strings overlaying parts of `d_vgrp` for subgrouping.
- **d_unsp**: 8-character UNSPSC value from position 38.

### Local Data Area (UDS)

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- **l_user**: User info from system LDA (positions 911-920).
- **l_firm**: Firm/company number from LDA (positions 944-946).

---

## 4. Key Variable Definitions

```rpg
d vugrlu_uogr     s                   like(vguogr)
d vugrlu_uhgr     s                   like(vguhgr)
d vugrlu_uugr     s                   like(vguugr)
```
- Local variables for storing group keys when accessing/updating the output file.

---

## 5. Other Variables

```rpg
d w_firm          s                   like(vgufir)
d digits          c                   ' 0123456789'
```
- **w_firm**: Variable for the firm number (matches file field type).
- **digits**: List of digits for use with `%check()`.

---

## 6. Main Processing Loop

### Read, Validate, and Process Records

```rpg
c                   read      lwexpf                                 90
c                   dow       *in90 = *off
c                   eval      d_ex = exclin
c                   if        %check(digits : d_ogrp) = 0 and
c                             d_unsp <> *blank
c                   exsr      behand
c                   endif
c                   read      lwexpf                                 90
c                   enddo
```
- **read lwexpf 90**: Read a record from the input file. Indicator 90 is set if EOF.
- **Main loop:** While not EOF,
  - Assign the record to `d_ex`.
  - **Validation:** Call subroutine `behand` (process) if:
    - `d_ogrp` contains only digits (i.e., %check returns 0).
    - `d_unsp` is not blank.

---

## 7. Program Termination

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
```
- **xslutt**: End label.
- **Set LR**: Marks last record to release resources and end program.

---

## 8. Subroutine: `behand` (Process/Update Inventory Record)

```rpg
c     behand        begsr
c                   move      d_ogrp        vugrlu_uogr
c                   move      d_hgrp        vugrlu_uhgr
c                   move      d_ugrp        vugrlu_uugr
c     vugrlu_key    chain     vugrlu
c                   if        %found(vugrlu)
c                   eval      vgufri = d_unsp
c                   time                    vgueda
c                   time                    vgueti
c                   eval      vgueus = l_user
c                   write     vugrlur
c                   endif
c     behand_ut     endsr
```
- **Populate keys**: Extract group/subgroup values to key variables.
- **CHAIN**: Look up the `vugrlu` record with these keys.
- **If found**:
  - Set `vgufri` (probably "free text" or UNSPSC code) to `d_unsp`.
  - Set date (`vgueda`) and time (`vgueti`) using system time.
  - Set `vgueus` (last user) to current user.
  - **WRITE**: Write back updated record.
- **End of subroutine**.

---

## 9. Subroutine: `*inzsr` (Initialization)

```rpg
c     *inzsr        begsr
c     vugrlu_key    klist
c                   kfld                    w_firm
c                   kfld                    vugrlu_uogr
c                   kfld                    vugrlu_uhgr
c                   kfld                    vugrlu_uugr
c                   eval      w_firm = l_firm
c                   endsr
```
- **Define key list for CHAIN**: Specifies the search key fields for accessing the `vugrlu` file.
- **Initialize firm number (`w_firm`)** from local data area.

---

## 10. Summary

**High-Level Flow:**
1. Read each row from an external file/list.
2. Extract group/UNSPSC info from the line.
3. If valid (group numeric, UNSPSC exists), update the relevant inventory group record with the new UNSPSC code, current timestamp, and user.
4. Loop until all records are processed.

---

## Key Points for Maintenance / Onboarding

- The program expects specifically-formatted input records.
- It uses overlays in data structures for efficient substring access.
- Data is validated before updating the inventory table.
- Make sure the `lwexpf` and `vugrlu` files are properly defined in the database, matching expected keys and field types.
- The code uses old fixed format; consider modernizing to free-format RPG if extending.

---

**References in code**:  
- `lwexpf` = Input file  
- `vugrlu` = Inventory group table (updated)  
- `behand` = Processing subroutine  
- `*inzsr` = Initialization subroutine (called automatically at program start)

---

This program is typical for batch updating master data on IBM i, with careful validation and update logic aligned with business rules (here: inventory group and unspsc code management).