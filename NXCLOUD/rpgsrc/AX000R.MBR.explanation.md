# AX000R â€“ Parameter Entry for Altin Report Ordering

## Overview

**Program:** AX000R  
**Purpose:**  
This program serves as a parameter entry screen for ordering reports to Altin, which is likely an external reporting or regulatory system (possibly related to Norwegian tax or accounting standards, given references to SAFT and Norwegian field names). The program collects user input for report parameters, validates them, and stores them in a data area for use by downstream processes or batch jobs.

---

## Structure and Flow

### 1. File and Display Declarations

- **fax000d**: Workstation file (likely the display file for user interaction).
- **fafirl1**: Disk file, keyed access (used to retrieve company information).

### 2. Local Data Area Mapping

The program maps a set of fields to the local data area (LDA). These fields are used to pass parameters between jobs/programs:

- **l_fper, l_tper**: Period from/to (6 chars each).
- **l_kom1, l_kom2**: Comment fields.
- **l_head, l_ktop, l_kund, l_levr, l_moms, l_kodr, l_hbok**: Selection flags for report sections (1 char each).
- **l_wsid, l_user**: Workstation and user IDs.
- **l_filg**: File group/ID.
- **l_firm, l_avde**: Company and department numbers.

### 3. Main Logic

#### Parameter Initialization

- **p_fper / p_tper**: Defaulted to current month/year (with logic to ensure proper formatting, e.g., leading zeros).
- **Other parameters**: Initialized to blank.

#### Main Input Loop (`a2taga`)

- **Screen Display**: Presents the parameter entry screen (`exfmt a1win`).
- **Cancellation**: If the user cancels (`*inkc`), sets a sentinel value (`*end  `) and exits.
- **Validation**:
  - Checks that periods are valid months (01-12), years are within the last 10 years, and the year format starts with '20'.
  - Ensures at least one report section is selected (at least one of the selection flags is not blank).
- **Storage**:
  - On successful validation, moves the parameters into the data area (`ax000par`).
  - Retrieves company number from `fafirl1` and stores it in the parameter area if found.
  - Writes the data area out for use by downstream processes.

#### Program End

- Ends with setting LR and returning.

### 4. Initialization Subroutine (`*inzsr`)

- Defines and locks the data area (`ax000par`).
- Initializes some window position variables (`w_alin`, `w_apos`).
- Writes an initial screen (`s1win`).

---

## Business/Domain-Specific Logic

- **SAFT Reports**: The program is part of the rollout for SAFT (Standard Audit File for Tax) reporting to all customers (see version history).
- **Period Validation**: The system restricts report generation to the last 10 years, reflecting compliance or business rules.
- **Section Selection**: Users can select which parts of the report to generate (head, account type, customer, supplier, VAT, code, main book). At least one must be chosen.
- **Company Number**: The program chains to a company master file (`fafirl1`) to fetch and store the company number in the parameter area, ensuring the report is linked to the correct entity.

---

## Conventions and Design Decisions

- **Data Area Usage**: Parameters are passed via a data area (`ax000par`), a common pattern in legacy IBM i systems for inter-program communication, especially in job streams or batch processing.
- **Field Packing**: All parameters are packed into fixed positions in the data area, matching the mapping at the start of the program. This requires strict adherence to offsets and lengths.
- **Screen Handling**: Uses a modal input loop with `exfmt` for parameter entry and validation, repeating until valid input is received or the user cancels.
- **Field Names**: Field names are abbreviations of Norwegian terms (e.g., `fper` = "fra periode" = "from period", `tper` = "til periode" = "to period", etc.).

---

## Integration Points

- **Display File (`fax000d`)**: Handles user interaction for parameter entry.
- **Company Master File (`fafirl1`)**: Used to fetch company number for inclusion in the parameter set.
- **Data Area (`ax000par`)**: Serves as the mechanism for passing parameters to subsequent processes or programs that generate the reports.

---

## Notable Patterns

- **Validation Loop**: Uses a tag/goto loop (`a2taga`) for re-prompting the user on invalid input. This is a legacy pattern but ensures robust input validation.
- **Sentinel Value for Cancellation**: Sets the 'from period' parameter to `*end  ` to indicate cancellation to downstream processes.
- **Year Handling**: The period fields are constructed as MMYYYY, with logic to ensure correct formatting and range.

---

## Version History Highlights

- **7.00 (200420)**: Initial rollout for SAFT reports.
- **7.01 (270923)**: Extended period selection to allow reports for earlier years.

---

## Summary for New Developers

This program is a parameter entry and validation front-end for Altin/SAFT report generation. It ensures that users provide valid periods and select at least one report section, then stores the parameters in a data area for downstream batch processing. It integrates with the company master file to ensure correct company identification. The code uses fixed-position data area mapping and a modal input loop, both common in legacy RPG applications. Understanding the structure and mapping of the data area is critical for both maintenance and integration with other modules.