# RPG Program mm802R – Explanation

This RPG (Report Program Generator) source code is a typical IBM i (AS/400) ILE RPG program that primarily manages a screen-based subfile for querying and selecting delivery types (`Leveringstype`). The program interacts with display files, physical files, and uses subroutines to organize logic for user navigation and subfile management.

Let's break it down by areas:

---

## 1. Program-Level Definitions

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `h option(*nodebugio)`: Disables debug I/O, meaning records read/written won't be available for debug.
- `datedit(*dmy)`: Date fields default to `day/month/year` format.

---

## 2. File Declarations

```rpg
fvltpl1    if   e           k disk    rename(vltppfr:vltpl1r)
fvltpl2    if   e           k disk    rename(vltppfr:vltpl2r)
fmm802d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **Physical Files**:  
  - `vltpl1` and `vltpl2` are keyed disk files used for delivery type and description lookup respectively.
  - Both use `rename` to map the record format to `vltpl1r` and `vltpl2r`.

- **Display File**:  
  - `mm802d` is the workstation (display) file.
  - Sfile: `b1sfl`, controlled with relative record number `w_srrn`.
  - `infds(dspfbk)`: Associates the display file feedback data structure for cursor and record information.

---

## 3. Data Declarations

- **Parameter and Key Variables**
    ```rpg
    d p_firm          s                   like(vyfirm)
    d p_lety          s                   like(vylety)
    d p_besk          s                   like(vybesk)
    ```
    Parameters for company (`firm`), delivery type (`lety`), and description (`besk`).

- **Display Feedback Data Structure**
    ```rpg
    d dspfbk          ds
    d  d_fcrn               378    379I 0
    ```
    Used to track cursor position or current record number.

- **Subfile Control Variables**
    - Used to manage subfile paging, selection, positioning, etc. (e.g., `w_spge` is page size, `w_srrn` and `w_ssrn` track record numbers).

- **Constants**
    ```rpg
    d c_sfil          s              2  0 inz(8)
    ```
    Subfile page size is 8.

---

## 4. Program Structure

### Indicator Usage

Indicators (classic in RPG/400-style code) are used heavily to control display file fields and program flow:

- `*INLR`: End-of-program.
- `*IN10`–`*IN15`, `*IN21`, `*IN22`, `*IN30`, etc.: Control subfile operations, display refresh, keypresses, cursor positioning, error highlighting.

### Mainline and Tag Flow

- The program uses labeled `tag` blocks (`b2taga`, `b2tagb`, `avslutt`) and `goto` for mainline logic flow.
- Navigation is largely driven by function keys (detected through indicators).

---

## 5. Mainline Logic

- **Initial Screen Control**:  
  - `write b2cmd` sends the command screen.
- **Display Subfile**:  
  - `exsr dsp_subfile` displays the subfile screen.
- **Function Key Handling**:  
  - Function keys are processed with a `select` block:  
    - Roll up/down, refresh (`forny`), go back (`bck_subfile`), subfile create (`crt_subfile`), and positioning (`posisjoner`).
- **Subfile Processing**:  
  - If `b_valg_ok` (a selection flag) is set, exit program.
- **Exit**:  
  - On exit, sets `*INLR = *ON` (end of program).

---

## 6. Subroutines

### Initialization (`*inzsr`)
- Receives entry parameters.
- Prepares keys for positioning on delivery type/description.
- Sets up the file pointer and populates the initial subfile.

### Forny (Renew/Refresh)
- Chains to current subfile record if available.
- Sets the correct position in the respective file.
- Clears and recreates the subfile for the current position.

### Positioning (`posisjoner`)
- Positions either on delivery type (`b2lety`) or description (`b2besk`).
- Sets file positions accordingly and refreshes the subfile.

### Subfile Processing (`subfile`)
- Iterates over the subfile records (`readc b1sfl`), typically to process user selection.
- Handles up to 10 selections (using array `a_lety`).
- Sets `b_valg_ok` when a record is selected.

### Clear Subfile (`clr_subfile`)
- Sets indicator to clear subfile (`*IN14 = *ON`) and writes control record to reset subfile indicators.

### Create Subfile Page (`crt_subfile`)
- Increments page size and relative record numbers.
- Reads records from the appropriate file (`vltpl1`/`vltpl2` depending on sequence).
- Writes records to the subfile display.

### Roll Back a Page (`bck_subfile`)
- Handles a page backward logic using `readp` (read prior).
- Resets keys and repopulates the subfile.

### Display Subfile (`dsp_subfile`)
- Sets appropriate indicators and uses `exfmt` to display the control record.
- Captures current record number from `infds`.

---

## 7. Subfile and Screen Handling

- **Subfile**:  
  - Subfiles are used to display a list of delivery types or descriptions for selection.
  - Supports paging, positioning, and selection of up to 10 entries.

- **Screen Format Naming**:  
  - `B1SFL`: Subfile record format.
  - `B2CTL`: Subfile control record format.
  - `B2CMD`: Separate screen for command keys.

---

## 8. Business Logic

- **Purpose**:  
  - Let users browse, filter, and select delivery types from a (potentially large) list, using subfiles (paged screens).
  - Multiple selections supported (up to 10).
  - Search/positioning by type or description.

- **Special Features**:  
  - Handles paging (next/previous).
  - Allows searching by either key fields.
  - Mainline loop continues until user selection is finalized (or exit key pressed).

---

## Summary Table

| Section                | Purpose                                                |
|------------------------|-------------------------------------------------------|
| File Declarations      | Reference DB and display files, subfile support       |
| Data Declarations      | Manage keys, paging, selection, feedback              |
| `*inzsr` Subroutine    | Entry/initialization, parameter handling              |
| Mainline Logic         | Indicates main workflow, screen display, FKEY logic   |
| Subfile Routines       | Clear, create, display, page handling, selection etc. |
| Positioning Routines   | Allow searching/positioning by key fields             |
| Indicators             | Classic RPG control of I/O, fields, screens           |
| Comments               | Explain indicator and field purposes                  |

---

## Onboarding Notes

- **Subfile Programming**:  
  - Familiarize with subfile setup and how indicators control screen format.
- **Indicator Usage**:  
  - Indicators are critical to controlling program flow (especially in legacy code).
- **File Handling**:  
  - File positions (`setll`, `read`, `chain`, `readp`) are used throughout for navigation.
- **User Inputs**:  
  - Driven by FKEYs (function keys), program uses branching logic per user action.

---

## Conclusion

This program is a canonical example of RPG subfile-driven inquiry and selection maintenance. Its key mechanisms are indicator-controlled display logic, function key input branching, subfile paging, and selection management. When working with or extending this program, ensure you understand RPG’s subfile concepts, indicator usage, and how this program uses tags and subroutines for major operations.