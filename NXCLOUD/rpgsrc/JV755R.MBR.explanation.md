# Program Overview

This RPG IV (ILE RPG) program manages the update of product information in an inventory system called EVR. The code is highly domain-specific (retail/distribution), integrating data from several files (likely DB2 physical/logical files) related to products (items), suppliers, pricing, packaging, EAN (barcode) registration, and search keywords.

It is designed for use by other programs or batch jobs, accepting parameters for company (firm) and item number, then performing complex updates and integrity checks across EVR and related tables. The source code is heavily commented (in Norwegian) and has a detailed change log, showing it's actively maintained.

---

## High-Level Main Flow

1. **Startup/Initialization**
   - Accepts parameters for company (`p_firm`) and item (`p_vare`).
   - Sets up local variables, data area, and file keys.
   - Reads the local data area to get the current user.

2. **Main Program Logic**
   - Checks if the item exists in EVR (`vvarl1`) and if it's allowed for update.
   - If valid, performs the update by calling the `oppdater` subroutine.
   - When finished, sets LR indicator to terminate the program.

---

## File Definitions

- Multiple files are defined for input/output, mostly keyed (typically logical files).
- Key files:
  - `vvarl1`, `jvarl1`, `jvdtl1`, `vvarlu`, `jvprl1`, `jvpkl1`, `veanl1`, `veanlu`, etc.
- Files are renamed upon use to logical record names (convention: rename(physical:logical)).

---

## Parameter and Variable Declarations

- `p_firm` = Company number (parameter)
- `p_vare` = Item number (parameter)
- Other working variables for item fields, keys, EAN numbers, date/time, etc.
- Heavy use of LIKE keyword to match field definitions in files, ensuring type consistency.

---

## Main Control Logic

### 1. Startup and Check

- Sets up the item key with `p_vare`.
- `CHAIN` to `vvarl1` (item master in EVR).
- If not found or item is excluded (`vvkjus = 1`), skip update.

### 2. Update Subroutine (`oppdater`)

This is the core of the business logic. Steps include:

#### a. Get EAN and Cross Docking Info

- If the item has a supplier code, read item price data for EAN code and cross-docking info.
- EAN and cross-docking variables are set only if criteria on date (validity) are met.

#### b. Get Supplier Expiry Info

- Reads supplier-related details, such as expiry date, from the supplier-item cross-reference.

#### c. EVR Item Update

- Chain to the item in relevant files (possibly legacy systems, alternate item files, etc.)
- For non-logistics items, updates item descriptions, groupings, types, NOBB numbers, cross-docking info, and more.
- Sets flags, dates, times, and user on record.

#### d. Packaging

- If packaging (unit info) is valid for the combination of effective dates, updates the packaging field.
- Uses subroutine `sjekk_pkdato` to validate packaging date ranges.

#### e. Item Update in EVR

- Performs an update to the EVR item file (`vvarlur`).

#### f. EAN Number Registration

- Ensures EAN numbers from item or price exist in the universal EAN registry (`veanlur`), adding them if necessary.
- Handles updating timestamps if EAN already exists but for a different product.

#### g. Supplier Info

- Chains to supplier info file for more data linking.

#### h. Search Texts

- Copies module keywords and custom search texts from the main item search file to the EVR search file if not already present, ensuring relevant search terms are always available.

#### i. Supplier Expiry Update

- Ensures supplier expiry info is present and up-to-date in EVR.

#### j. Call Text Update Program

- Calls another program (`VV750R`) to update EVR search text related to the item.

---

## Subroutines

### 1. oppdater

The main business logic (see above for details).

### 2. rydd_ean

Deletes EAN codes from the registry that are present on EVR item units. Called from old, now commented-out code (may be legacy/cleanup function).

### 3. sjekk_pkdato

Validates if a packaging date is within the valid from/to dates. Used to determine if a packaging unit should be applied to the item (supports open-ended, start-only, end-only, or closed date ranges).

### 4. *inzsr (Initialization Subroutine)

- Loads parameter values into working variables.
- Sets up key lists (KLIST) for all files, defining record keys for chaining and updates.

---

## Key Business Rules

- **Do Not Update** if item does not exist or is excluded.
- **Only update specific fields** depending on item type (logistics or not).
- **EAN Registration** ensures EANs are unique at the product level, and new EANs are registered if necessary.
- **Packaging** is only updated if current date falls within from/to validity for packaging units.
- **Supplier expiry** and cross-docking info are handled specifically for items with suppliers.
- **Modular and custom search texts** are always kept in sync between the main item file and EVR.

---

## Notable Techniques/Patterns

- Use of `CHAIN`, `SETLL`, `READE` for record access.
- Use of **KLIST/KFLD** to define composite keys for file operations.
- Parameter passing and data area usage for user context.
- Extensive use of conditional logic for field updating.
- In-line SQL for certain lookups (e.g., checking for a logistics item).
- Time/date fields are set using RPG `TIME` op code.

---

## Comments & Maintenance

- Code is heavily commented and maintained (as shown by the extensive changelog).
- Comment blocks are in Norwegian, with technical/functional explanations for most logic.
- Various parts have been updated or commented out as requirements changed (e.g., legacy cleanup, field size changes, file switches, etc.).

---

## Summary Table

| Section         | Purpose                                                                                      |
|-----------------|----------------------------------------------------------------------------------------------|
| Main startup    | Parameter init, file key setup, check if update is needed                                    |
| oppdater        | Core update: EAN handling, item/supplier/cross-dock/packaging updates, search text management|
| rydd_ean        | Cleans up EAN numbers in case of unit matches (legacy)                                       |
| sjekk_pkdato    | Validates if packaging info is within valid dates                                            |
| *inzsr          | Initialization, parameter reading, file key definitions                                      |

---

## Onboarding Tips

- **Understand the file layout**: Know what each physical/logical file represents and its key fields.
- **Read comments and changelog**: Many code changes are explained in the comments.
- **Step through oppdater**: This is the business logic heart of the program.
- **Coordinate with other systems**: This program calls other programs (e.g., VV750R), so understand the interface.
- **Testing changes**: Since many updates are conditional and data-driven, use realistic test cases to verify behavior.

---

## Example Scenarios

- When a new item is added or changed in the legacy system, this program will ensure EVR reflects up-to-date info, barcode registration, supplier data, and search texts.
- If an item gets a new EAN/barcode from supplier pricing, this code ensures it's registered if not present already.
- Supplier or packaging updates with expiry logic are managed and synchronized.
- If an item is excluded from updates, nothing is written or changed.

---

**In summary, this is a robust, central update routine for synchronizing item-related data across files in a complex inventory system, handling multiple edge cases and legacy requirements.**