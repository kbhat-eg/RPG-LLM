# RPG Program VV550R — Full Explanation

## Overview

This is a large ILE RPG/400 (Report Program Generator) application for IBM i (AS/400) systems, responsible for complex item and price inquiries, including support for subfiles, filtering/searching, and various workflow and validation functions (such as customer/project selection, warehouse/location management, EAN/GTIN scanning, etc.). It is a mature program with a long change history, providing a highly interactive inquiry interface for inventory, prices, and warehouse data.

---

## Program Header

- `h option(*nodebugio) datedit(*dmy)`
  - Turns off debug I/O.
  - Sets date edit code (DD/MM/YY format).

- **Change History**
  - The commented header contains the system, program name, description, and a comprehensive change log, including many enhancement notes over the years.

---

## Files and Data Structures

### Database/Workstation Files

- Several logical and physical files (`fvvsopf`, `fvvarlr`, `fvvarl1`, ... etc.) are defined for item/warehouse lookup and chains.
- Most files are accessed with a key (`k disk`) and some with record format renaming for easier multi-use.
- The display file `vv550d` is defined with a subfile (`sfile(b1sfl:w_srrn)`) and an indicator data structure for feedback (`infds(dspfbk)`).

### Data Area & Information Data Structures

- `l_firm`, `l_fnav`, `l_lagr` – fields pulled from the local data area (`uds`) for company, name, and warehouse.
- `dspfbk` – Data Structure to get cursor location for the display station (interactive screens).

### Indicator Usage (as per header comments)

- Indicators 10, 12-15, 21, 22, 30, 31–99 are assigned to subfile and screen handling, control flow, errors, field protection, and work flags.

---

## Variables

- **Subfile Management**: `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` – various variables for managing subfile navigation, record numbers, and paging.
- **State Variables**: Numerous flags (like `b_feil`, `b_lager`, `b_open_sok`, etc.) for error, warehouse, special modes, etc.
- **Constants**: `c_sfil = 7` (likely page size), `c_null` (zero-padded string used for EAN padding).
- **Work Variables**: `w_mvap`, `w_mvat`, `w_mvaf` for VAT rates, `w_kode`, `w_ste1`–`w_ste5` for search terms, etc.
- **Keys for CHAIN, SETLL/READ, SQL operations**: Variables created for each key component per file.

---

## Initial Program Setup (`*INZSR`)

- Key lists defined for all database access patterns (item number, text, NOBB, supplier number, group, etc).
- Loads firm and warehouse info from Local Data Area.
- Prepares system VAT rates and checks for warehouse control.
- Sets initial filter indicators.

---

## Main Processing Loop

### Program Flow

- A main loop that writes the command screen (`b2cmd`), handles input, and determines what action to take (search, renew, navigate, etc).
- **Function keys** and commands are detected via special indicators (e.g., F8, F9, F13, F21, F23, etc), causing branching to subroutines or workflows as needed.

### Subfile Handling

- Uses subfile approach for interactive listings (paging, selection, cursor position).
- **Subfile routines**:
  - `clr_subfile`: Clear subfile.
  - `crt_subfile`: Fill subfile based on current view [`w_seqe`] and filter/search params.
  - `subfile`: Main processing of interactive records (actions on listed items).
  - `dsp_subfile`: Display subfile page with control.

### Searching & Filtering

- Multiple methods for searching items:
  - By group hierarchy (overgroup, main group, subgroup).
  - By product text, item number (`vare`), supplier number, NOBB number.
  - Open search (`b_open_sok`) invokes SQL cursors for advanced text searches.

- **Search Routine (`søk`)**:
  - Validates group filters, populates search state, determines what search is being performed, and either sets file positions (`setll`) or opens SQL cursors for text-based lookups.

- **Positioning Routine (`posisjoner`)**:
  - Positions to subfile record matching criteria from text, item number, NOBB, or supplier item number.

---

## Display and Action Logic

- **Various Actions on Subfile Records**: Handled via selection codes (`b1valg`), e.g.,
  - 5: Call item/price display program
  - 6: Show warehouse locations
  - 7: Show item "card" (detailed view)
  - 8: Show product information
  - 9: Show inventory
- **Field Coloring and Status**: Various logic for setting color/indicator for different item statuses, e.g. "discontinued," "NOBB expired," price focus, etc.
- **Multi-field field (`b1stat`)**: Used for encoding item various statuses compactly.

### Warehouses & Locations

- Support for filtering/working with different warehouses; calls to external programs for additional warehouse or location information.
- Dedicated routine for displaying warehouse locations with SQL lookups for location texts.

### Customer and Project Handling

- Customer/project numbers are validated and their names looked up via CHAIN, loaded into display fields for context.
- Subroutine (`hent_info`) fetches and populates these whenever changed.

---

## User Inputs/Function Keys

- F8: Call "Skafferegister" screen.
- F9: Repeat last search.
- F13: Scanning (EAN/GTIN) support—displays scan window, validates scanned values, and finds items.
- F21, F23: Toggle inclusion/exclusion of "skaffevarer" (special-order goods), toggle between item/number views.

---

## SQL Integration

- Uses embedded SQL (via `/EXEC SQL`) for complex and flexible text and group search, as well as various information lookups (e.g., item types, location names).
- When in search mode, SQL cursors fetch matching records into program variables for display.

---

## Error/Edge Case Handling

- Several error indicators/flags are set for validation errors and display notifications (e.g., missing item, invalid group filter, item not found for EAN).
- Program can handle empty result sets gracefully and shows appropriate feedback to the user.

---

## Key Takeaways for Developers

- **Subfiles**: The program heavily utilizes subfiles for display and manipulation of lists of items, with logic for paging, selection, and actions.
- **State & Filter Variables**: Many fields and flags persist user selections and system state between interactions and calls.
- **Integration**: Extensive use of external programs for modularity (item display, scanning, info fetch, VAT rates, etc.) and SQL for advanced searching.
- **Indicators**: The use of indicators is extensive, controlling both logic and display, and are key to following the screen/event workflow.
- **Searching/Filtering**: Rich logic for hierarchical (group/subgroup) and free-text search, with fallback to efficient SQL queries for better performance.
- **Data Area and Multilingual**: Makes use of local data areas, and is suitable for Norwegian environment (as seen by comments/NLS settings).

---

## Conclusion

The program is a central interactive inquiry tool for warehouse/inventory data with deep filtering/searching abilities and is highly optimized for usability in warehouse/retail environments. Developers working on this will need to be familiar with subfile I/O, IBM i data modeling, and legacy RPG/400 style, as well as have knowledge of the underlying business processes (e.g., how items, price groups, and warehouses interact in the ERP system).

**For onboarding:**
- Focus first on the subfile navigation and search routines.
- Examine the display file DDS to understand what the screens and subfiles look like.
- Familiarize yourself with the key database files and their logical views.
- Be prepared for heavy use of indicators and classic `CHAIN/SETLL/READ` file processing.
- Embedded SQL is critical for the advanced search features.
- Extensive modularization via calls to other programs for info and validation.

**If new to RPG:**
- Look up how subfiles work in RPG.
- Review how indicators control both screen and logic flow.
- Understand the usage of /EXEC SQL for integrating with DB2.

---

**This code is a prime example of a complex, user-optimized, interactive RPG application for ERP environments on IBM i.**