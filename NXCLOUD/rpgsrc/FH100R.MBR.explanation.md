# FH100R – Customer Distribution List Maintenance  
**System:** ASOFAK  
**Program:** FH100R  
**Description:** Maintenance of customer distribution lists

---

## Overview

This program implements a maintenance interface for managing customer distribution lists. It is designed for interactive use, leveraging subfiles and multiple display formats for CRUD operations (Create, Read, Update, Delete) on customer-project distribution records. The program is highly modular, with clear separation between display logic, data access, and business rules.

The code is written in traditional RPG IV (fixed-format), with references to display files (workstn), subfiles, and several physical and logical files. It is tailored for a Norwegian business context, as indicated by field names and comments.

---

## Core Business Logic

### Domain Concepts

- **Customer (Kunde):** Identified by a firm and customer number.
- **Customer Project (Kundeprosjekt):** Projects associated with a customer.
- **Distribution List:** A mapping between a customer (and possibly a project) and various distribution parameters (delivery type, assortment, etc.).
- **Subfile:** Used for listing, selecting, and maintaining multiple distribution records in a paged interface.

### Program Flow

1. **Initialization:**  
   - Reads firm information from the Local Data Area (LDA).
   - Initializes the subfile with the first page of customer distribution records.

2. **Main Loop:**  
   - Alternates between subfile display and command processing.
   - Handles function key events for navigation, CRUD operations, and queries.

3. **Subfile Processing:**  
   - Supports paging (forward/back), positioning, and record selection.
   - Each subfile row can be acted upon (edit, copy, delete, view).

4. **CRUD Operations:**  
   - **Create:** Via dedicated screen (C1BLD), with validation and duplicate checks.
   - **Read/View:** Via subfile or detail screen (C2BLD).
   - **Update:** Inline from subfile or via detail screen.
   - **Delete:** Via confirmation window (D1WIN).

5. **Lookups/Validation:**  
   - Extensive use of CHAIN operations for referential checks (customer, project, assortment, delivery type).
   - Calls to external programs for value lookups (e.g., RK500R for customer, FL500R for project).

---

## File Relationships

- **fkdilr / fkdilu / fkdil1 / fkdil2:**  
  The main distribution list files (physical and logical), keyed by firm, customer, and project.
- **rkunl1:**  
  Customer master, used for name lookups and validation.
- **fkprl1:**  
  Customer project master, for project validation.
- **vshel1, vltpl1, fprcl1:**  
  Assortment, delivery type, and price format reference files, used for populating descriptive fields and validation.

---

## User Interface Structure

- **Subfile (B1SFL):**  
  Main list of distribution records. Supports selection for edit/copy/delete/view.
- **Control Records (B2CTL, B2CMD):**  
  Used for subfile commands and function key handling.
- **Detail Screens (C1BLD, C2BLD):**  
  For creating and editing records.
- **Message and Confirmation Windows (C1MSG, D1WIN, K1WIN):**  
  For duplicate record warnings, delete confirmation, and copy operations.

---

## Indicators & Conventions

- **Indicators (INxx):**  
  Standardized usage for controlling display, error messages, subfile operations, and state.
- **Subfile Variables:**  
  - `w_fcrn`, `w_srrn`, `w_ssrn`, `w_sfrn`, `w_spge`: Manage subfile paging and positioning.
  - `w_seqe`: Controls which logical file is used for reading (by customer or by project).
- **Naming Conventions:**  
  - Prefixes (`b1`, `b2`, `c1`, `c2`, etc.) correspond to display formats or data structures.
  - Suffixes (`_kund`, `_kpro`, etc.) indicate the business meaning of variables.

---

## Notable Design Patterns and Decisions

- **Separation of Concerns:**  
  Each subroutine handles a specific aspect (display, validation, file I/O), making the code maintainable despite its procedural structure.
- **Subfile Paging:**  
  Manual management of subfile pages, supporting both forward and backward navigation.
- **External Lookups:**  
  Integration with external programs (e.g., RK500R, FL500R) for value selection, reducing code duplication and centralizing validation logic.
- **Error Handling:**  
  Uses indicators in the 31–79 range for displaying error and warning messages on the UI, following project conventions.
- **Domain-Specific Logic:**  
  - Distribution list records are keyed by firm, customer, and project.
  - Validation ensures referential integrity with customer and project masters.
  - Assortment and delivery type logic is included, with support for warehouse-specific assortments (added in later versions).

---

## Code Walkthrough

### File Declarations

- **Physical and Logical Files:**  
  - `fkdilr`, `fkdilu`, `fkdil1`, `fkdil2`: Distribution list files, with different access paths.
  - `rkunl1`, `fkprl1`: Customer and project master files.
  - `vshel1`, `vltpl1`, `fprcl1`: Reference files for assortment, delivery type, and price format.

- **Display File:**  
  - `fh100d`: Main display file, with subfile (B1SFL) and various screens.

### Data Structures

- **LDA (Local Data Area):**  
  - Used to retrieve user and firm context.
- **Display Feedback (dspfbk):**  
  - Used for cursor positioning and screen I/O feedback.

### Key Lists

- Defined for each file access pattern, supporting CHAIN, SETLL, and SETGT operations.

### Subroutines

- **forny:**  
  Refreshes the subfile from the current position.
- **posisjoner:**  
  Positions the file pointers based on customer or project input, then refreshes the subfile.
- **subfile:**  
  Main loop for processing subfile records (edit, copy, delete, view).
- **xc1bld / xc2bld:**  
  Handles creation and editing of records, including validation.
- **xd1win / xk1win:**  
  Handles delete confirmation and copy operations.
- **clr_subfile / crt_subfile / bck_subfile:**  
  Subfile management: clear, create (fill), and page back.
- **dsp_subfile:**  
  Controls the display of the subfile and command area.
- **spørring:**  
  Handles user-initiated lookups for customer and project fields, via external programs.
- **\*inzsr:**  
  Initialization routine: sets up keys, retrieves firm, initializes the subfile.

### External Program Calls

- **RK500R:**  
  Customer lookup.
- **FL500R:**  
  Project lookup.
- **VC500R, VY500R, FC500R:**  
  Lookups for assortment, delivery type, and price format.

---

## Version History and Enhancements

- **Initial Version (1999):**  
  Basic maintenance of customer distribution lists.
- **2006:**  
  Added delivery type selection.
- **2009-2010:**  
  Tracking information and assortment/warehouse support.
- **2020+:**  
  GUI-related changes, support for "skaffvare" (special order) and "tilbudspris" (offer price).

---

## Interactions with Other Modules

- **Customer/Project Masters:**  
  All customer and project references are validated against master files.
- **Reference Data:**  
  Assortment, delivery type, and price format are validated and described via their respective files.
- **External Lookup Programs:**  
  Used for user-friendly selection and validation of key values.

---

## Special Considerations

- **Norwegian Business Context:**  
  Field names and comments are in Norwegian; understanding of the business domain is helpful.
- **GUI vs. DDS:**  
  Some logic is specific to DDS (Display File), and may need adjustment for GUI frontends.
- **Indicator Usage:**  
  Follows a strict convention for indicator assignment, which is important for UI consistency.

---

## Summary

This program is a robust, interactive maintenance tool for customer distribution lists, integrating multiple files and external modules, and providing a user-friendly interface for managing complex business relationships. Its structure and conventions are consistent with established RPG development practices in the organization, and it is highly extensible for future business needs.