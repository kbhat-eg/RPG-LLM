# ILE RPG Program: NM722R – Inventory Export to Blueridge Datahub

---

## **Purpose and Context**

This program is designed to export inventory information from an IBM i (AS/400) system to the "Blueridge datahub." Over time, it has evolved from outputting JSON files to updating a DB2 table. The code handles a range of business logic, including determination of supplier, warehouse, order/inventory calculation, and various exceptions and special rules.

---

## **Key Concepts and Flow**

### 1. **File Declarations**

- Multiple files (`F-Specs`) are declared, each with a unique record format mapped via the `RENAME` keyword. These files are sourced from different physical files, typically inventory, warehouse, vendor, order detail, etc.
- **Example:**  
  `fvvarlr    if   e           k disk    rename(vvarpfr:vvarlrr)`  
  Opens an inventory master file with keyed access.

### 2. **Data Structures and Variables**

- **Internal tables for warehouse codes and descriptions**:  
  `t_lage` (codes), `t_ltxt` (descriptions), dimension of 99.
- **Work Variables**:  
  Variables are declared for items, inventory levels, supplier info, order info, and dates/times.

- **Data Areas (`uds`)**:  
  Used for user, company, firm number, etc., typically loaded at program start.

- **Key Variables**:  
  Declared for retrieval from various files using keys (e.g., `vvarlr_vare`, `vlaglr_lage`).

### 3. **Initialization (`*inzsr`)**

- **Parameter Handling**:  
  Reads entry parameter `p_memb` (member indicator for the run).
- **Key Lists**:  
  Defines all keys for subsequent file operations.
- **Date/Time Setup**:  
  Sets reference date/time variables used throughout (e.g., today, 30 days ahead, etc.).

### 4. **Main Processing Flow**

#### a. **Get/Generate Run Counter**

- If not supplied, the program calls a service program (`AS100R`) to generate a unique run/member identifier.
- Used to segment or identify this export in the DB2 table.

#### b. **Read Warehouse Master and Build Lookup Table**

- Reads all warehouses into `t_lage` and `t_ltxt` arrays for fast access.

#### c. **Read Inventory Master**

- Loops through all inventory items (`vvarlr`), filtering by relevant `vtyp`.
- For each relevant item, retrieves item description & name.

#### d. **Supplier Lookup (`hent_levr`)**

- Determines which supplier to use for the item based on a prioritized logic (main supplier, logistics, NOBB, etc.).
- Uses multiple files/tables to lookup supplier names and codes.
- Stores both the working value and originals for potential override/reversal.

#### e. **Warehouse Details Loop**

- For each item, loops through all relevant warehouses.
- Filters out inventory with zero/expired quantity, or not of type 'L'.

#### f. **Table Lookup for Warehouse**
- Uses the prebuilt lookup tables to quickly find warehouse IDs and descriptions.

#### g. **Stock/Order Calculation (`lag_info`)**

- **Beholdning/Stock:** Amount currently available in the warehouse.
- **In order:** Quantity that is on order (purchase orders not yet received).
- **In bestelling:** Quantity that is in planned or suggested order (handled similarly to 'in order').
- **Earliest delivery date:** Finds the soonest outstanding delivery date that isn’t expired, skipping direct delivery or “buffer” orders.
- **Order/quantity conversions:** Handles unit conversions if the stock unit is different from order unit (`omr_enh`, `omr_enh_best`).

#### h. **Output Record (`wrt_stock`)**

- Prepares and writes a record for the item/warehouse to the DB2 export table.
- Handles supplier overrule logic (local overrides, RDS lookups).
- Handles updating/inserting the record into the DB2 file with the correct run identifier, sequence, and all calculated fields.

### 5. **Subroutines and Special Handling**

- **Order and bestilling ("planned order") filtering:**  
  Detailed business rules to exclude certain order types (direct delivery, more than 30 days in the future, etc.).
- **Unit conversions** (`omr_enh`, `omr_enh_best`):  
  Compute correct quantities when units differ between files.
- **Supplier determination:**  
  Sophisticated, multi-step process with fallbacks and table cross-references.
- **Error Handling:**  
  Simple, returns on error with a jump to the end.

### 6. **End-of-Program/Clean Up**

- After processing all items and warehouses, the program sets last-record indicator and returns.

---

## **Key Business Rules and Features**

- **Order/Bestilling Exclusion:**  
  Excludes "direct delivered" and "buffer" (leveringstype 7) orders from calculations.
- **Order Date Windows:**  
  Ignores orders with delivery dates more than 30 days ahead.
- **Order Types Filtering:**  
  Skips certain order types (e.g., 'BN', 'RO' etc.).
- **Supplier Overriding:**  
  Handles local supplier overrides, main supplier, logistics supplier, and external "overrule" tables.
- **Efficient File Access:**  
  Uses arrays to minimize redundant file I/O and improve lookup speed.

---

## **Comments and Versioning**

- **Comprehensive in-line comments:**  
  Each section, especially business logic decisions, is commented (in Norwegian) with detailed explanations.
- **Version history block:**  
  Maintained at the top, with references to feature updates, bug fixes, and Jira tickets.

---

## **Conclusion/Onboarding Notes**

- **Program Structure:**  
  The main logic is contained in a tight loop over items and warehouses, with outboard subroutines for complex calculations and lookups.
- **Extensibility:**  
  New business rules are typically versioned with date/user references, making it easy to track changes.
- **Debugging:**  
  Since the program currently disables debug I/O (`option(*nodebugio)`), tracing issues may require additional debug code or logging.

---

## **Useful Tips for Maintainers**

- **Be cautious with key structure and file definitions:**  
  Many of the lookups are keyed and rely on correct maintenance of key lists.
- **Watch for side effects in supplier logic:**  
  Changes to supplier determination can have cascading effects.
- **Unit handling is subtle:**  
  Conversion logic is nontrivial and central to stock/order calculations.
- **RPG III/400 style:**  
  The code uses fixed-format RPG with subroutines, so line-level changes should be handled with care.
- **Test boundary cases:**  
  Orders close to excluded/included thresholds (e.g., delivery dates, order types).

---

## **Summary Table**

| Section           | Description |
|-------------------|-------------|
| File Declarations | Inventory, warehouse, vendor, order detail, etc. |
| Internal Tables   | Fast lookup of warehouse codes/descriptions |
| Main Loop         | Per item, per warehouse, calculate and output stock + order info |
| Subroutines       | Supplier lookup, unit conversion, error handling |
| Business Logic    | Exclusion/inclusion of special order types and dates, supplier overrule |
| Output            | Writes to DB2 export table with all calculated fields |

---

**In sum:** The program provides a highly specialized, well-commented, robust export of inventory information, reflecting both current stock and pipeline orders, according to complex business rules and supplier hierarchies.