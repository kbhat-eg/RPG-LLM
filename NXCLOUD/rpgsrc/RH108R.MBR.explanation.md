# High-Level Overview

This ILE RPG program (RH108R) is designed for maintaining a chart of accounts ("Kontoplan, vedlikehold") within a Norwegian accounting system. It is written in traditional fixed-format RPG IV and intended for execution on IBM i (AS/400) systems.

The code is structured with a main control loop that handles user I/O via a workstation file (display file with subfile support), navigation, and editing of account records, as well as supporting functions like copying or moving accounts, searching, and validation through calls to other programs. Indicator usage and subfile mechanics are central to its design.

---

## Key Areas and Components

### File & Display Definitions

- **Physical Files (Database Access):**
  - `frhovl1`, `frhovl2`, `frhovl3`, `frhovl4`, `frhovlr`  
    These are logical files over the same physical file (`rhovpfr`), providing different keyed views into the account records for various query criteria (by account, department, cost bearer, description). Each is renamed for clarity in code.

- **Display File:**
  - `frh108d`  
    An interactive workstation (display) file, with subfile support (`sfile(b1sfl:w_srrn)`) and an information data structure (`infds(dspfbk)`).

---

### Data Structure & Variable Definitions

- **LDA (Local Data Area):**
  - Contains user, firm, and navigation info (fields like `l_user`, `l_firm`, `l_fnav`).

- **Info Data Structure (`dspfbk`):**
  - Used to retrieve display feedback, such as the current record number (`d_fcrn`).

- **Variables for Keys and Data:**
  - Many variables are defined using the `like()` keyword, matching the database file's fields for account number, department, cost bearer, and more.
  - Variables like `w_srrn`, `w_sfrn`, `w_ssrn`, etc., are used for subfile navigation and paging.
  - Other working variables help manage the currently selected, source, and destination accounts during tasks like copy/move.

---

### Indicators

IBM i RPG relies heavily on indicators (`*INnn` and manual field indicators 10-99):

- 10-15, 21-22, 30, 31-99 are assigned as per scrolling, protecting fields, error signaling, and internal flags.
- Extensive use in subfile paging (rollup/rolldown), field protection, and feedback from called programs.

---

### Main Logic Flow

#### 1. **Startup (`*inzsr` Subroutine)**

- Initializes working variables and keys.
- Prepares database position for initial subfile load.
- Calls `crt_subfile` to fill the subfile with records.

#### 2. **Main Control Loop**

- Displays the main "opening" subfile screen.
- Handles function key input to direct processing:
  - Exit (`*inkc`, `*inkl`)
  - Refresh (`*inke`)
  - Paging (rollup/rolldown: `*in10`, `*in11`)
  - Positioning (Home-key: `*in21`)
- Allows repositioning with search fields: by account, department, cost bearer, or description.

#### 3. **Subfile Handling**

- **Filling/Resetting Subfiles:**
  - `clr_subfile` blanks the subfile records.
  - `crt_subfile` fills the subfile according to the current key and paging state.

- **Paging:**
  - `bck_subfile`: Handles 'page back' logic for the subfile.

- **Display & Edit:**
  - `dsp_subfile` presents the current subfile.
  - Handles record selection for viewing or moving (e.g., option 5 for 'Display', 7 for 'Move').

#### 4. **Record Viewing & Editing**

- When a record is selected for viewing (`xc2bld`), the code retrieves it from the database, displays details, and fetches related descriptive information by calling various code and description programs (`RS705R`, `RS713R`, etc.).

#### 5. **Copying/Moving Accounts**

- The `xm1win` subroutine handles interactive movement of account records:
  - Validates source and destination fields through database lookups and inter-program calls.
  - Transfers the account data by calling the `RH109R` program.
  - Provides the UI to pick destination account, department, and cost bearer—integrated with pop-up windows and lookup programs for code validation.
  - Extensive error and validation handling to prevent invalid moves.

#### 6. **Validation Subroutines**

- `kontroll` contains logic for fetching supplemental data (like VAT codes, budget keys, amount units, and currencies).
- Uses external program calls to obtain human-readable descriptions.

---

### Subfile and Paging Mechanics

- **Subfiles** provide array-like presentation in the display file, navigated by "relative record numbers". The code tracks the first (`w_sfrn`), last (`w_ssrn`), and current (`w_srrn`) records displayed, as well as the page size (`w_spge`).
- Paging logic (`crt_subfile`, `bck_subfile`) ensures that the correct segment of records is loaded into the display as the user navigates forward and backward.

---

### Integration with Other Programs

- The RPG program frequently delegates validation and lookup to other programs (`RS707R`, `RS728R`, `RH500R`, `RH109R`, etc.), passing parameters to retrieve or validate codes and get descriptions or statuses.
- This modular approach keeps the main program focused on control and presentation logic.

---

## Onboarding Notes

- **Subfile Navigation:**  
  Understanding how subfiles work on IBM i is critical: this program uses "load on demand" style subfile maintenance with both forward and backward paging (rollup/rolldown).

- **Indicator Management:**  
  Many operational states are tracked using indicators, following RPG's traditional "flag" style. Pay attention to their meaning, set/reset points, and flow impact (see the comment block for assignments).

- **Program Calls:**  
  System design is modular, with many functions performed by calling external programs for validation and lookup. Knowledge of their interfaces and output is important for maintenance.

- **Error Handling:**  
  Errors and invalid entries result in indicators being set, and the user returned to the appropriate screen with messages—look for `*in31` to `*in39` for such signals.

- **Database Keys:**  
  Multiple logical files provide different sorted/hashed views for efficient search and subfile management. Key lists (`klist`) are used for positioning and chaining.

- **Internationalization:**  
  Texts are in Norwegian (field names like `kont`, `spes`, `avde`, etc.), and code comments are helpful for understanding business terminology.

---

## Summary Table

| Functionality   | Key Points                                                                 |
|-----------------|----------------------------------------------------------------------------|
| Subfile Display | Handles listing, paging, and selection/editing of account records.         |
| Positioning     | Allows fast search by account, department, cost bearer, or description.    |
| Editing         | Full view and limited edit via pop-up windows with key validation.         |
| Record Move     | Interactive window, with code/desc lookups and validation before move.     |
| Integration     | Uses external programs for validations, info lookups, and moves.           |
| Error Handling  | Indicator-driven; messages and field highlighting on invalid input.        |

---

## Most Important Subroutines

- `forny`        – Refresh the subfile.
- `posisjoner`   – Handle user-initiated positioning/search.
- `subfile`      – Process subfile events and options.
- `xc2bld`       – Display or edit a selected account record.
- `xm1win`       – Manage the move/copy account window and process.
- `clr_subfile`  – Clear subfile records for new load.
- `crt_subfile`  – Load records into the subfile for display.
- `bck_subfile`  – Page back through the subfile.
- `dsp_subfile`  – Display the subfile control screen.
- `kontroll`     – Retrieve human-readable descriptions for codes.

---

## Final Remarks

This is a classic IBM i RPG accounting maintenance program, making extensive use of subfiles, indicator-driven state management, and modular program calls for a robust and interactive user experience. For onboarding, focus on understanding subfile logic, indicator manipulation, and how user input is validated/processed via external calls. The code is well-commented (in Norwegian) and logically organized according to standard IBM i accounting application conventions.