# Program AF728R - XML Generation for Email with Attachment

## Overview

This program is responsible for generating an XML file to facilitate email distribution with attachments. The XML is constructed based on templates and various runtime parameters, and the output is written to the IFS (Integrated File System). It also logs the batch/job status and optionally triggers downstream processes (such as launching a PDF in the browser and activating a data queue sniffer).

The program is integrated with the CGIDEV2 toolkit for HTML/XML template processing and uses several data files and external programs for configuration, logging, and batch/job management.

---

## Business Context

- **Purpose:** Automate the creation of an XML document to describe an email with an attachment, which is then processed by other systems for distribution.
- **Attachments:** The program supports adding file attachments (e.g., Excel files) with MIME type information.
- **Templates:** XML output is based on a template, with runtime data merged in.
- **Logging:** Job status and events are logged for traceability.
- **Integration:** Can optionally trigger downstream processes (PDF launch, data queue notification).

---

## Structure & Flow

### 1. Initialization (`*INZSR` Subroutine)

- **Parameter Intake:** Receives three parameters:
  - `p_filn` — Full path to the attachment file.
  - `p_fnav` — Name of the attachment as it should appear.
  - `p_mime` — MIME type of the attachment.

- **Configuration Retrieval:**
  - Retrieves template and output paths from the `AFPSLR` configuration file, using keys such as `VISVEDLEGG`, `XMLPATH`, and `DATAQ`.
  - If not found in the configuration, defaults are set (notably for the template path).

- **Batch/Job Setup:**
  - Calls `AS100R` to generate a new batch/job number.
  - Logs the start of the job (`AB700R`) and the XML generation step (`AB705R`).

- **Timestamping:** Captures the current system time for logging and XML content.

- **Attachment Preparation:**
  - Ensures the attachment path is prefixed with `ifs:`.
  - Sets attachment name and MIME type (defaults to `text/plain` if not provided).

---

### 2. Main Procedure

- **Validation:** Exits immediately if either the XML template path or output path is missing.

- **XML Template Handling (`xml_env` Subroutine):**
  - Loads the XML template using `GetHTMLIFS`.
  - Clears the HTML/XML buffer.
  - Updates template variables for batch number, type, username, time, schema, and company number.
  - Writes the top and credential sections using CGIDEV2's `WrtSection`.

- **Attachment Section:**
  - If an attachment is specified, writes the attachment section into the XML, including:
    - URL (IFS path)
    - MIME type
    - Attachment name
    - A flag indicating not to fail if the file is not found

- **Finalization (`xml_end` Subroutine):**
  - Writes the XML footer section.
  - Constructs the output XML file name and path.
  - Writes the generated XML to the IFS using `WrtHtmlToStmf`.
  - If configured, notifies a data queue via program `AP629C` with the file group and XML file path.

- **Downstream Triggers:**
  - Calls `AP621R` to launch a PDF in the browser, passing the batch key.
  - Calls `AB710R` to close the job ID.

---

## Key Data Relationships

- **Configuration & Control Files:**
  - `AFPSLR` — Holds XML template and output paths, and data queue flag.
  - `FUSRL1`, `FRA09LR` — Used for user and seller lookups (not deeply used in this program, but structures are present).

- **Logging Programs:**
  - `AS100R` — Batch/job number assignment.
  - `AB700R`, `AB705R`, `AB710R` — Job status logging and closure.
  - `AP621R` — Launch PDF in browser.
  - `AP629C` — Data queue notification.

- **CGIDEV2 Toolkit:**
  - Used for template processing (`GetHTMLIFS`, `UpdHTMLVar`, `WrtSection`, `WrtHtmlToStmf`).

---

## Notable Design Decisions & Conventions

- **Template-Driven XML:** All XML is generated via templates, with variables injected at runtime. This allows for flexible changes to XML structure without code changes.
- **IFS Integration:** Both input (template) and output (XML) are handled via the IFS, supporting modern file-based workflows.
- **Attachment Handling:** Attachment information is always included as a distinct XML section if present, and the system is robust to missing files.
- **Batch/Job Model:** Every run is tracked as a batch/job, with extensive logging for audit and traceability.
- **Data Queue Optionality:** The program can optionally notify a data queue, controlled by configuration, for integration with real-time sniffer or monitoring processes.
- **Hardcoded Fallbacks:** If configuration entries are missing, the program falls back to hardcoded paths, ensuring robustness.

---

## Module Interactions

- **CGIDEV2/CGIDEV2:** Bound at compile time for HTML/XML template processing.
- **External Programs:**
  - `AS100R` — Batch/job number generator.
  - `AB700R`, `AB705R`, `AB710R` — Logging and job management.
  - `AP621R` — PDF launch.
  - `AP629C` — Data queue notification.

- **Files:**
  - `AFPSLR`, `FUSRL1`, `FRA09LR` — Configuration and lookup files.

---

## Error Handling

- **Missing Paths:** If template or output paths are missing, the program exits gracefully.
- **Attachment Path:** Ensures attachment paths are properly formatted for downstream systems.
- **MIME Type:** Defaults to `text/plain` if not provided.

---

## Summary Table

| Component         | Purpose                                                    |
|-------------------|-----------------------------------------------------------|
| `*INZSR`          | Initialization, configuration retrieval, batch/job setup   |
| `xml_env`         | Load and prepare XML template, inject credentials          |
| Main Procedure    | Validate, generate XML, handle attachments                |
| `xml_end`         | Finalize XML, write to IFS, notify data queue             |
| Logging/Batch     | Job status and event logging                              |
| CGIDEV2           | Template-based XML generation                             |
| Downstream Calls  | PDF launch, job closure, data queue notification          |

---

## Key Variables

- `p_filn` — Path to attachment (IFS)
- `p_fnav` — Attachment name
- `p_mime` — Attachment MIME type
- `XML_path` — Template path (from config)
- `Out_path` — Output directory (from config)
- `w_jkey` — Batch/job key
- `w_attac` — Attachment IFS path
- `w_anavn` — Attachment display name
- `w_mime` — Attachment MIME type
- `w_dtaq` — Data queue activation flag

---

## Special Notes

- Comments and variable names are partially in Norwegian (e.g., "Vedlegg" = "Attachment", "mal" = "template", "utsendelse" = "distribution").
- The program is designed for extensibility (new templates, new attachment types) and integration with other batch processing and monitoring systems.

---

## Onboarding Recommendations

- Familiarize yourself with the CGIDEV2 toolkit for template-driven output.
- Review the configuration entries in `AFPSLR` for template and output path management.
- Understand the batch/job logging model (programs `AS100R`, `AB700R`, `AB705R`, `AB710R`).
- Review downstream consumers of the generated XML and attachment conventions.
- For troubleshooting, check the job logs and the IFS output directories specified in the configuration.