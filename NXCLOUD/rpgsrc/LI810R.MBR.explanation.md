# RPG Program LI810R: EDI Packing Slip and Order Reference Handling

## Overview

This RPG program, `LI810R`, processes EDI (Electronic Data Interchange) packing slips and builds information related to orders. The key objectives are:
- To ensure packing slip lines are correctly linked to order lines.
- To update or create cross-reference records between EDI packing slips and internal order entities.
- To determine if automatic updates (such as goods receipt) should be performed based on various business logic and lookup tables.

## Sections and Main Concepts

### 1. File Declarations (F-Specs)
The program defines several files, all with record-level access:
- **lphoir** (`lphost`): EDI packing slip header (input)
- **lpkliu** (`lpklst`): EDI packing slip lines (update)
- **lpkoi1** (`lpkost`): EDI packing slip item header (input)
- **lbhoiu** (`lbhost`): Order header cross-ref (update)
- **lbliiu** (`lblist`): Order line cross-ref (update)
- Other tables for lookups such as suppliers, parties, shipment methods, and orders.

### 2. Data Structures and Fields
- Local Data Area fields for user and firm info.
- Overlaid data structures for flexible handling of order numbers of various lengths, allowing easy right-justification and zero-padding.
- Variables set up to hold keys for different files, mapped to file fields, supporting indexed access.

### 3. Mainline Logic

#### Initialization
- On program start, the `*inzsr` subroutine initializes generic key lists for file access and retrieves the current firm code.

#### Main Program
- The core logic is in the `bygg_Best` subroutine.

#### Hovedprogram (Main Program)
- Only two steps: call `bygg_Best`, then set LR indicator to *ON (program end).

---

## Main Subroutine: BYGG_BEST ("Build Order Reference")

### Steps per Packing Slip

1. **Iterate EDI Packing Slip Headers (`lphoir`):**
   - For each packing slip that is not "completed" (status ≠ '99' and < '90').

2. **For Each Packing Slip Line (`lpkliu`):**
   - For each line, check if it references an order number (`plbnum`).
   - Handles various order number lengths, right-justifies and left-pads with zeros to fit an 8-character format. Verifies it's numeric.

3. **Order Validation:**
   - Chains to the order header file (`lohel1`) to check if the referenced order exists.
   - Sets `b_best` flag if valid.

4. **Update Packing Slip Line:**
   - Sets the internal order number on the packing slip line, updates the record.

5. **Header and Line Cross-Reference Creation:**
   - For valid order references, builds cross-reference records in both the order header (`lbhoiu`) and order line (`lbliiu`) files if they do not already exist.
   - These records tie EDI packing slip lines/headers to internal orders and provide audit and tracking information (who, when, etc.).

6. **Automatic Packing Slip Update Logic:**
   - If the order association was valid (`b_best = *on`), after all packing slip lines are processed, control moves to `upd_pakk`.
   - This subroutine contains rules for checking whether the packing slip should be updated automatically, depending on:
     - Supplier info.
     - Whether a distribution warehouse is involved.
     - Whether the order is linked to a logistics office.
   - If so, calls another program (`LI320R`) to perform the update.

---

## Subroutines

### 1. **upd_pakk**
- Determines if the EDI packing slip should trigger an automatic update.
- Checks the supplier’s record for a specific flag (`lnapak`).
- Fallback: checks for the existence of a specific carrier party on the slip (party type 'CA').
- Overrides: checks if the tied sales order is associated with a "logistics office" (via shipment method in `ra17l1` table).
- If all criteria are met, calls program `LI320R` to perform the actual update, passing key info.

### 2. **Initialization (`*inzsr`)**
- Sets up all key-lists (klist/kfld) for efficient file access.
- Retrieves the current firm number for use in all file operations.

---

## Design and Coding Details

- **Overlayed Data Structures** are used to handle various order number lengths and provide flexible numeric conversion.
- **File Access Patterns**: SETLL for positioning, READE for sequential reads, CHAIN for direct access.
- **Cross-Reference Table Writes** are conditional (only if a record doesn't already exist).
- **Automatic Update Logic** is modularized for maintainability.

---

## Change Logs

The header comments (with Norwegian text) document incremental updates and bugfixes. Notable versions:
- 7.01: Order validity checks added.
- 7.04/7.05: Improved order number normalization and handling (padding/justification).
- 8.01–8.06: Various enhancements to automate updates based on business rules (such as distribution warehouse involvement, shipment method checks).

---

## Key Business Rules

- Orders must be correctly mapped and validated before cross-reference creation.
- Not every packing slip triggers an automatic update; it's based on:
  - Supplier records.
  - Existence of a "carrier" party.
  - Linkage to a "logistics office" order.
- Data integrity and traceability are maintained by logging user and timestamp on creation/update.

---

## Summary

This program is a specialized RPG batch utility that ensures EDI packing slip data are consistently mapped to internal order data, maintaining cross-references and automating follow-up processes (like goods receipt) when required by business logic. 

It's robust against varying order number formats and supports evolving business needs through its modular structure and change-resilient logic. New developers should pay special attention to:
- File access strategies (key lists and overlays)
- Cross-reference creation logic
- The criteria for triggering automatic updates
- The use of flags and overlays for data normalization.