# RPG Program LO104R Documentation

## Overview

**Program Name:** LO104R  
**System:** ASLAGR  
**Description:** Handles registration and maintenance of header/footer text lines for purchase orders (bestilling/innkjøp).  
**Business Domain:** Purchasing – specifically, management of free-text lines associated with purchase order headers ("topptekst") and footers ("bunntekst").

This program allows users to view, edit, and update the header and footer texts attached to a purchase order. It provides the ability to toggle between header and footer text, load template texts, and update the associated database records.

---

## File Usage

- **LOTXL1** (lotxpfr:lotxl1r): Input file, holds existing purchase order texts.
- **LOTXLU** (lotxpfr:lotxlur): Update file, used for writing/deleting text records.
- **LFTXL1** (lftxpfr:lftxl1r): Input file, provides template or standard texts.
- **LO104D**: Display file (workstn), manages user interface.

---

## Data Structures

### Arrays

- **a_totx (16 x 70A):** Holds up to 16 lines of header text ("topptekst").
- **a_butx (16 x 70A):** Holds up to 16 lines of footer text ("bunntekst").

### Parameters

- **p_stat:** Status indicator (purpose not detailed in this code).
- **p_firm, p_numm, p_suff:** Identifiers for the company, order number, and suffix.

### Local Data Area Fields

- **l_user:** User ID.
- **l_firm:** Firm number.
- **l_fnav:** User full name.

### Key Variables

- **lotxl1_line, lotxlu_line:** Used for line number keys in text files.
- **lftxl1_numm:** Used for template text lookups.

### Working Variables

- **b_text:** Boolean flag to track if text exists for update/delete logic.
- **w_tell:** Counter for lines processed.
- **w_firm, w_numm, w_suff, w_line:** Work copies of firm, order, suffix, and line number.

---

## Main Program Flow

### 1. Initialization (`*inzsr`)

- Receives parameters for status, firm, order number, and suffix.
- Sets up key lists for database access.
- Initializes working variables and display fields.
- Ensures the program starts by showing the header text.

### 2. Load Text (`hent_tekst`)

- Loads up to 16 lines of header text (lines 1000–1160, increments of 10) and footer text (lines 5000–5160) into the respective arrays from **LOTXL1**.
- Each text type is loaded by iterating through the records for the current order.

### 3. Main Display Loop

- Displays either header or footer text, depending on the state of indicator `*IN80` (off = header, on = footer).
- Populates display fields with the current text array.
- Waits for user input:
    - **F3:** Exit.
    - **F6:** Load new template text (`xt2win`).
    - **F23:** Toggle between header and footer.
- After editing, updates the arrays with user input.

### 4. Load Template Text (`xt2win`)

- Prompts the user for a template number.
- Allows inquiry via F4 (calls another program, `LJ500R`).
- If a valid template is entered, loads up to 16 lines from **LFTXL1** into the current text array (header or footer, depending on `*IN80`).

### 5. Update Text (`oppd_tekst`)

- For both header and footer:
    - Iterates through the 16 lines in reverse (from 16 down to 1).
    - If the line is blank and a record exists, deletes the record.
    - If the line is not blank, updates the record if it exists, or writes a new record if not.
    - Updates audit fields (date, time, user) when modifying records.

---

## Key Business/Domain Logic

- **Text Line Numbering:** Header and footer texts are distinguished by their line numbers:
    - Header: 1000, 1010, ..., 1160
    - Footer: 5000, 5010, ..., 5160
- **16 Lines per Type:** Both header and footer texts are limited to 16 lines.
- **Template Usage:** Users can load standard texts from a template (LFTXL1) to pre-fill the arrays.
- **Audit Trail:** When updating or creating records, audit fields (date, time, user) are set to track changes, supporting traceability requirements (see changes in v6.10).

---

## Notable Design Decisions and Conventions

- **Toggle Mechanism:** The use of indicator `*IN80` to switch between header and footer simplifies the UI logic and avoids code duplication.
- **Reverse Processing:** Updates and deletions are processed from the last line to the first, ensuring that trailing blank lines are handled correctly.
- **Key Lists:** All file access uses named key lists for maintainability and to ensure consistent keying across different file operations.
- **Audit Updates:** The program updates both creation and change audit fields on insert, and only change fields on update, ensuring compliance with audit requirements.
- **Template Integration:** The ability to load template texts allows for rapid entry and standardization of frequently used texts.

---

## External Interactions

- **LJ500R:** Called during template text inquiry (F4 in `xt2win`), likely a program for searching available templates.
- **Files:** The program reads from and writes to the LOTXL1/LOTXLU files for order texts and LFTXL1 for templates. These files must be kept in sync with the order master data.

---

## Error Handling & User Feedback

- **Validation:** The program validates template existence before loading template text; if not found, sets an error indicator (`*IN31`).
- **Exit Handling:** Graceful exit on F3 (or similar keys), returning control to the caller.
- **Field Clearing:** Fields are cleared when loading new templates to prevent data leakage between sessions.

---

## Summary Table

| Functionality        | Subroutine/Section | Description                                                                 |
|----------------------|--------------------|-----------------------------------------------------------------------------|
| Initialization       | `*inzsr`           | Sets up keys, loads parameters, initializes screen                          |
| Load Text            | `hent_tekst`       | Loads header/footer text from LOTXL1 into arrays                            |
| Main Screen          | Mainline           | Displays and edits text, handles user input                                 |
| Load Template Text   | `xt2win`           | Loads text from LFTXL1 template into the current array                      |
| Update Text          | `oppd_tekst`       | Writes/deletes records in LOTXLU based on array contents                    |

---

## Integration Points

- **Order Management:** This program is part of a suite handling purchase orders. Texts managed here are typically displayed on order documents.
- **Template Maintenance:** LFTXL1 must be managed separately to ensure relevant templates are available for users.

---

## Maintenance Notes

- **Line Number Expansion:** The code has been checked/updated for order number expansion (see v6.30 changes).
- **Audit Compliance:** Ensure audit fields are maintained for legal/regulatory compliance.
- **Display File:** Any changes to the number of text lines supported must be reflected both in the arrays and the display file definitions.

---

## Conclusion

LO104R is a specialized maintenance program for purchase order header/footer texts, supporting both direct editing and template-based entry, with robust audit tracking and a user-friendly toggle interface. It is tightly integrated with order and template files and is critical for maintaining the quality and consistency of purchase order documentation.