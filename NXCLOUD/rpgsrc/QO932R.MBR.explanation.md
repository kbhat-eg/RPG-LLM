# Program QO932R – Documentation

## Overview

**QO932R** is a central program for generating and outputting *prisbekreftelse* (price confirmation) documents, used in the order-to-cash process. The program supports both classic spool file printing and modern XML/Jasper-based document generation for archiving, emailing, and advanced formatting.

It integrates with a wide range of master and transaction files, supports extensive business logic for handling customer, order, and pricing details, and includes numerous options for output customization and downstream integrations.

---

## Main Purpose

- **Generate price confirmation documents** for customer orders, including:
  - Order header, line items, and associated texts.
  - Calculation and presentation of discounts, VAT, and totals.
  - Handling of department, project, and delivery information.
- **Support multiple output modes:**
  - Traditional spool file printing.
  - XML output for JasperReports (PDF generation, archiving, emailing).
- **Integration with other modules** for logging, archiving, emailing, and business rules.

---

## Key Features & Business Logic

### 1. **Document Structure**

The program processes each order in a cycle, handling:

- **Order header** (customer, delivery, and payment info)
- **Order lines** (products/services, quantities, prices, discounts)
- **Text lines** (comments, instructions)
- **Totals** (net, VAT, gross)

### 2. **Output Modes**

- **Spool file (printer) output**: Classic RPG output to printer file `QO932P`.
- **XML/Jasper output**: Generates XML for JasperReports, supporting advanced formatting, archiving, and emailing.

The output mode is controlled by flags (e.g., `l_poff`, `b_pdfp`) and parameters from the job environment (often set in LDA or passed in).

### 3. **Master Data Integration**

- **Order Header**: `FOHEL1R`
- **Order Lines**: `FODTL1R`
- **Text Lines**: `FOTXL1R`
- **Customer**: `RKUNL1R`
- **Product**: `VVARL1R`
- **Department/Division**: `RA07PFR`
- **Project**: `FKPRL1R`

### 4. **Business Rules Highlights**

- **Department vs. Company**: The document can show department info instead of company info, based on settings.
- **Discount Handling**: Supports showing discounts as percentage or only as net amounts, depending on order/customer flags.
- **VAT Calculation**: Supports multiple VAT rates per document, with logic for accumulating VAT bases and outputs per rate.
- **Length Specifications**: For certain items, prints a specification of lengths and quantities.
- **Special Customer/Project Logic**: If a customer project is specified, fetches additional info (including external email addresses).
- **Order Logging**: Updates logs for order confirmations, especially for "kjørekontor" (centralized order handling) solutions.
- **Email Integration**: If emailing, assembles mail subject, body, and recipients from order/customer/project data, and logs status.

### 5. **XML/Jasper Integration**

- Generates XML with detailed tags for all order data, using routines like `UpdHTMLVar()` and `WrtSection()`.
- Supports archiving and search by writing metadata and document references to the archive system and a search table (`XLKOST`).
- Handles special character conversion for XML safety using the `AP613R` program.
- Supports previewing generated PDFs in the browser via `AP621R`.

### 6. **Parameterization and Environment**

- Many settings are read from LDA (Local Data Area), including output queue, batch/job number, company/department codes, and print options.
- Entry parameters support integration with upstream processes (e.g., batch job runners or web frontends).

---

## File Interactions

### Input/Update Files

- **Order Files**: `FPSOL1`, `FOHEL1`, `FODTL1`, `FOTXL1`
- **Customer Files**: `RKUNL1`
- **Product Files**: `VVARL1`, `VPKOL1`
- **Department/Division**: `RA07PF`
- **Project**: `FKPRL1`
- **Length Specifications**: `FVLSL1`
- **Log/Archive**: `XLKOST` (via SQL), others via called programs (`FU900R`, etc.)

### Output Files

- **Printer File**: `QO932P`
- **XML Output**: Written to IFS for JasperReports, archiving, and emailing.

---

## Key Subroutines and Sections

### Initialization (`*INZSR`)

- Sets up environment, keys, and zeroes out accumulators.
- Reads parameters from LDA and sets output mode.
- Determines whether to use Jasper/XML output or classic printing.
- Prepares paths, template names, and logging for Jasper mode.

### Main Processing Loop

- **Order Header Handling**: Fetches customer, department, project, and payment info. Applies business logic for displaying department/company, discounts, and contact info.
- **Order Line Handling**: Fetches product data, calculates prices, discounts, and VAT. Handles special rules for item types and decimal precision.
- **Text Line Handling**: Fetches and prints or outputs comment/instruction lines.
- **Totals Calculation**: Sums net, VAT, and gross amounts. Handles order-level discounts and VAT breakdowns.
- **Overflow Handling**: Manages page breaks and section headers.

### XML/Jasper Subroutines

- **xml_envm**: Sets up environment tags (user, company, printer, etc.).
- **xml_head**: Writes header tags (company, customer, project, etc.).
- **xml_deta**: Writes line item tags (item, quantity, price, discounts, etc.).
- **xml_spec**: Writes length/specification tags.
- **xml_rabatt**: Writes discount lines.
- **xml_netto/xml_vat/xml_totaler**: Writes net, VAT, and total sections.
- **xml_topt_str/xml_topptxt/xml_topt_end**: Handles top text (header comments).
- **xml_bott_str/xml_bunntxt/xml_bott_end**: Handles bottom text (footer comments).
- **xml_end**: Finalizes XML, writes archive/search metadata, triggers sniffer if needed.

### Special Subroutines

- **skr_leng**: Outputs length specifications for relevant order lines.
- **xarray**: Handles accumulation of VAT bases and amounts per rate.
- **hnt_avde**: Fetches department/division info for output.

---

## Notable Design Patterns & Conventions

- **Versioning in Comments**: Extensive in-line history is maintained in comments, with references to requirement numbers and dates.
- **Key Lists for File Access**: All file access is parameterized via named key lists for maintainability.
- **Separation of Output Modes**: Logic for classic print and XML/Jasper output is kept parallel but separate, facilitating future migration.
- **Externalized Business Logic**: Many business rules (e.g., VAT calculation, special character conversion) are delegated to external programs, promoting reuse and centralization.
- **Extensive Use of Overlays and Data Structures**: For memory-efficient handling of variable data, especially for archiving/logging.
- **Conditional Output**: Many fields and sections are only output if present or relevant, as indicated by internal flags (e.g., `*IN31` for delivery address, etc.).
- **Internationalization**: Date and time formats, language/country settings, and character conversion are handled for multi-market support.

---

## Integration Points

- **Emailing**: Via routines that assemble and send mails, including scanning for illegal characters in subjects/bodies.
- **Archiving**: XML output is written to IFS and metadata is stored in `XLKOST` for searching.
- **JasperReports**: Uses XML as input for JasperReports templates for PDF generation.
- **Logging**: Status and errors are logged via calls to dedicated programs (`AB705R`, etc.).
- **Sniffer/Workflow**: Optionally triggers a data queue for further workflow steps (e.g., Java-based sniffers).

---

## Domain-Specific Notes

- **"Kjørekontor"**: A special mode for centralized order processing, with unique logging and confirmation handling.
- **Order/Customer Project Handling**: Supports external customer projects, which may override standard email and contact info.
- **Discount Presentation**: Business logic allows for presenting discounts either as a percentage or only as a net price, based on customer/order settings.
- **Length Specifications**: Some products (e.g., building materials) require detailed specification of lengths and counts per order line.
- **Multiple VAT Rates**: The system supports and outputs several VAT rates per document, with correct calculation and breakdown.

---

## Maintenance & Extension Guidance

- **Adding New Output Fields**: Extend both classic print and XML/Jasper sections, and ensure any new business logic is encapsulated in subroutines or external programs.
- **Integrating New Business Rules**: Prefer external programs for complex logic to maintain centralization and reusability.
- **Supporting New Output Modes**: Use the existing flag-based structure to add new output types or integrations.
- **File/Field Extensions**: Use `LIKE` and overlays for new fields to ensure consistency and minimize memory usage.

---

## Summary Table – Key External Programs Called

| Program   | Purpose                                  |
|-----------|------------------------------------------|
| `FØ705R`  | VAT calculation (old, now commented)     |
| `RS205R`  | VAT code lookup/calculation              |
| `RS718R`  | Delivery terms lookup                    |
| `FØ707R`  | Fetch company/department info            |
| `FØ710R`  | Fetch customer phone/fax/mobile          |
| `FØ798R`  | Fetch email addresses for customer/project|
| `AP613R`  | Special character scanning/conversion    |
| `AP609R`  | Jasper/XML template setup                |
| `GetHTMLIFS` | Loads Jasper template from IFS        |
| `ClrHtmlBuffer` | Clears HTML/XML buffer             |
| `WrtHtmlToStmf` | Writes XML to IFS                  |
| `AP629C`  | Triggers data queue for workflow         |
| `AB705R`  | Logging (status, errors)                 |
| `AP621R`  | PDF preview in browser                   |
| `FU900R`  | Logging for order confirmations          |
| `AM705C`  | Mail server lookup                       |
| `AS100R`  | Generates new document ID                |
| `AB700R`  | Logging (document start)                 |

---

## Change Management

The program is under continuous development, with a detailed changelog embedded in the source. When making changes:

- **Document all changes** with version, date, initials, and description in the header.
- **Update integration points** if external programs or file layouts change.
- **Coordinate changes** with Jasper/XML templates and downstream consumers if output tags/structure change.

---

## Final Notes

This program is a cornerstone of the order processing and document output system. It is highly parameterized and interacts with many parts of the business application landscape. Any changes should be carefully analyzed for impact on both upstream (order capture) and downstream (archiving, emailing, reporting) processes.

For further details on specific business rules, refer to the external programs called, as many contain critical logic not replicated in this source.

---