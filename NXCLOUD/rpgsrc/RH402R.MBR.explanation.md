# Program RH402R – General Ledger Balance Deletion

## Purpose

This program is designed to delete balance records from the General Ledger (Hovedbok) system. Specifically, it removes records from the balance file (`RHSALU`, based on physical file `RHSAPF`) for a given company (firm) and for years earlier than a specified cutoff year. The deletion is conditional, based on a selection flag.

## High-Level Flow

1. **Initialization:** Local data area (LDA) fields and key structures are initialized.
2. **Iterate Over Balances:** The program loops through all balance records (`RHSAL1`) for the selected company.
3. **Conditional Deletion:** For each record, if the selection flag (`d_valg`) is 'J' (Yes) and the year is less than the cutoff (`d_raar`), the corresponding detailed balance record in `RHSALU` is deleted.
4. **Termination:** The program ends when all relevant records have been processed.

## File Definitions and Relationships

- **RHSAL1**: Logical file (renamed as `rhsal1r`) over the physical file `RHSAPF`. Used for reading high-level balances.
- **RHSALU**: Logical file (renamed as `rhsalur`) over the same physical file, but likely with a different key structure (more granular, includes account, department, etc.). Used for deleting specific balance entries.

Both files are keyed and processed sequentially for the specified company.

## Data Area and LDA Usage

- The program uses fields in the Local Data Area (LDA) to retrieve parameters:
    - `d_raar` (positions 300–303): The cutoff year for deletion.
    - `d_valg` (position 304): Selection flag, must be 'J' to enable deletion.
    - `l_firm` (positions 944–946): The company number to process.
    - `l_fnav` (positions 951–980): Company name (not used in logic).

## Main Logic Breakdown

### 1. Initialization (`*inzsr` Subroutine)

- Sets up key lists for both files:
    - `rhsal1_key`: Keyed by company number.
    - `rhsalu_key`: Keyed by company, account, special code, department, year, and type.

### 2. Main Processing Loop

- **Set Position:** The program positions itself at the first record in `RHSAL1` for the specified company using `SETLL`.
- **Loop:** Reads records one by one.
    - **End/Break Condition:** 
        - If EOF (`*IN90`), or
        - If the company number in the record exceeds the selected company (`rifirm > l_firm`),
        - Then the program jumps to the termination section.
    - **Conditional Deletion:**
        - If `d_valg = 'J'` and the record's year (`riraar`) is less than the cutoff (`d_raar`):
            - Populates key fields for `RHSALU`.
            - Attempts to chain (retrieve) the detailed balance record.
            - If found, deletes the record from `RHSALU`.
    - **Continue:** Repeats the loop for the next record.

### 3. Special Handling

- There is a code block (V5.40) that sets a variable `kai` to 'Z' if the year is 2003. However, `kai` is not declared or used elsewhere in the program, suggesting it may be a remnant from earlier logic or debugging.

### 4. Termination

- When the end of records is reached or the company number changes, the program sets the last record indicator (`*INLR`) and returns, ending the job.

## Business/Domain-Specific Notes

- **Deletion Policy:** Only records for years prior to the cutoff year and with the selection flag set are deleted. This is a safety measure to prevent accidental mass deletion.
- **Company-Specific:** All processing is limited to a single company per run, as indicated by `l_firm`.
- **File Expansion:** Comments indicate that the balance table was expanded in line with business requirements (see reference to `COMP` and history in the comments).

## Design Patterns and Conventions

- **Use of LDA:** Passing parameters via LDA is a standard pattern in legacy RPG applications, allowing for flexible batch job configuration.
- **Key Lists:** Key lists (`klist`/`kfld`) are used for file access, ensuring consistent and maintainable key management.
- **Tag/GOTO Structure:** The code uses tags and `GOTO` for loop and exit control, which is a legacy RPG idiom.
- **Error Handling:** Minimal error handling; assumes that the presence or absence of a record in `RHSALU` is not an exceptional condition.

## Integration and Dependencies

- The program depends on the structure and integrity of the `RHSAPF` file and its logical views (`rhsal1r` and `rhsalur`).
- It expects LDA fields to be properly populated by the calling program or job control.

## Non-Obvious Aspects

- **No Deletion from RHSAL1:** The program only deletes from `RHSALU`, not from the high-level balance file (`RHSAL1`). This may be intentional due to business rules or referential integrity.
- **Year-Specific Logic:** The special handling for year 2003 is unexplained and appears vestigial.
- **No User Interaction:** This is a batch process; all parameters must be set before execution.

---

**Summary:**  
This program is a batch utility for purging old detailed balance records for a specific company in the general ledger system, based on parameters provided in the local data area. It is intended for controlled, periodic cleanup as part of financial data management.