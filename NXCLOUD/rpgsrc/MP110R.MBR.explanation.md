# RPG Program MP110R – Explanation Guide

## 1. Overview

This RPG (Report Program Generator) program, `MP110R`, is used for managing suppliers (leverandører) for purchase order proposals in an IBM i environment. The program provides a rich green-screen (workstation) user interface to display, add, edit, copy, and delete supplier (vendor) records, each potentially associated with a warehouse.

### Main Features

- Displays a list (subfile) of suppliers.
- Allows for CRUD operations (Create, Read, Update, Delete) on supplier records.
- Supports searching and positioning within the supplier subfile.
- Handles screen navigation and function keys (F-keys).
- Calls external programs for data verification and retrieval.
- Cleans up text to be compatible with the Newlook interface (removing unsupported punctuation).

## 2. File Declarations

```rpg
fmpldiu    uf a e           k disk    rename(mpldst:mpldiur)
fmpldi1    if   e           k disk    rename(mpldst:mpldi1r)
fmpldir    if   e           k disk    rename(mpldst:mpldirr)
fra10l1    if   e           k disk    rename(ra10pfr:ra10l1r)
fmp110d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **mpldiu, mpldi1, mpldir** – Disk files for supplier data with different usage types and record formats.
- **ra10l1** – Disk file, likely 'lager' (warehouse) information.
- **mp110d** – Workstation file for the display, using subfile `b1sfl` and a display feedback data structure (`dspfbk`).

## 3. Data Structures & Variables

### Local Data Area (LDA)
```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Picks up values such as user, firm, and user name from pre-defined LDA fields.

### Information Data Structure – Display Feedback
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Holds feedback from display file operations (e.g., cursor record number).

### Key Variable Definitions
Multiple variables for supplier number (`dlev`), warehouse (`dlag`), etc., are defined for use as keys in file operations.

### Other Variables
- `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc. – Used for subfile record and page handling.
- `b_oppr`, `b_forn`, `b_anul`, `b_feil` – Boolean flags for controlling various operations.
- `w_firm`, `w_retk`, `w_levr`, etc. – Working variables for business logic.

## 4. Indicators

Uses RPG indicators (*in01–*in99) for controlling program flow, UI locking, error signaling, etc. They are mapped as per the header comment.

Example:
- *in10 = Page up (Rollup)
- *in14 = Clear subfile
- *in15 = End of subfile

## 5. Main Control Flow

### **Initialization**
- The `*inzsr` subroutine (run at program start) initializes keys, reads LDA info, positions files, and fills the subfile with supplier data.

### **Main Screen Management**
- The program uses labeled tags (`b2taga`, `b2tagb`) to loop through main screen actions.
- Handles function keys for navigation (roll up/down), add, copy, delete, and field entry.
- Based on the user's action, it calls subroutines to clear, refresh, or update the subfile and invokes maintenance screens.

### **Subfile Management**
- **Subfile routines** are responsible for displaying, updating, and paging through the subfile of suppliers.
- Handling for editing (`b1valg = 2`), copying (`b1valg = 3`), deleting (`b1valg = 4`), and viewing (`b1valg = 5`) supplier records.

### **Screen Handling**
- `dsp_subfile` – Controls display of the subfile and navigation between screens.
- `clr_subfile` / `crt_subfile` – Clear and (re)populate the subfile records.

### **CRUD Operations**
- **Add new**: `xc1bld` subroutine shows the creation screen, validates data, checks for existing records, and invokes the maintenance subroutine `xc2bld`.
- **Update/View**: `xc2bld` handles input, validates, and writes changes or new records to the database.
- **Copy**: `xk1win` allows copying an existing supplier record, with validation.
- **Delete**: `xd1win` handles deletion after confirmation.

### **Searching and Positioning**
- The `spørring` subroutine interfaces with external (callable) programs to search for supplier or warehouse numbers and populates the relevant fields on return.
- Positioning in the subfile is handled by the `posisjoner` routine.

### **External Calls**
- Calls such as `'RS760R  '` and `'RS710R  '` are used to look up or validate supplier and warehouse data.
- `'RL500R  '` is likely used for lookup during inquiry (spørring).

### **Newlook Data Cleansing**
- The `newlo_vask` subroutine removes trailing periods (.) or colons (:) from the supplier names and warehouse texts, because the Newlook emulator does not handle them properly.

## 6. Subroutine Highlights

### **forny**
- Refreshes the subfile based on the currently selected record.

### **posisjoner**
- Positions the file pointer to a specific supplier and warehouse, clears and refills the subfile accordingly.

### **subfile**
- Handles the main display, allowing users to iterate through, edit, copy, delete, or view subfile records.

### **xc1bld**
- Manages the 'add new' screen including validation, inquiries, and checking for duplicates.

### **xc1msg**
- Shows an error/information message when attempting to add a supplier that already exists.

### **xc2bld**
- Handles the main maintenance (edit/view) screen for supplier records, including data validation and saving.

### **xd1win, xk1win**
- Manage the delete and copy screens, including double-checking existing records and validation.

### **clr_subfile, crt_subfile**
- Clear and populate the subfile (list) used for display. Includes data cleansing for Newlook compatibility.

### **bck_subfile**
- Handles paging backwards in the subfile (roll down).

### **dsp_subfile**
- Triggers the correct display format for the subfile or control screen.

### **spørring**
- Handles field-specific inquiries for supplier and warehouse codes, calling external programs and updating the appropriate fields.

## 7. Error and Information Handling

- Several indicators are used for signaling errors (e.g., *in31, *in32, *in33).
- Informational messages via screens when, for example, a duplicate supplier is found.

## 8. Special Section: Newlook Data Cleanup (ILE free format)

```rpg
 /FREE
 begsr newlo_vask;
   for w_teller = 1 to 5 ;
     w_len = %len(%trim(b1lnav));
     if (w_len > 0);
       b1lnav = %ScanRpl('.':'':b1lnav:w_len); // Remove trailing periods
     endif;
     w_len = %len(%trim(b1lnav));
     if (w_len > 0);
       b1lnav = %ScanRpl(':':'':b1lnav:w_len); // Remove trailing colons
     endif;
     w_len = %len(%trim(b1ltxt));
     if (w_len > 0);
       b1ltxt = %ScanRpl('.':'':b1ltxt:w_len);
     endif;
     w_len = %len(%trim(b1ltxt));
     if (w_len > 0);
       b1ltxt = %ScanRpl(':':'':b1ltxt:w_len);
     endif;
   endfor ;
 endsr;
 /END-FREE
```
- Cleans visible data in subfile names and texts to avoid misinterpretation by the Newlook GUI.

## 9. Keylists for File Access

- Defined for use in CHAIN, SETLL, etc., to access and position supplier and warehouse records.

## 10. Onboarding Advice

- **Familiarize yourself with the screen layout** (DSPF), subfile mechanism, and function key assignments.
- **Understand the external program calls** (e.g., RS760R, RL500R, RS710R, RA510R) and their purposes; these often return status or descriptive text for lookups.
- **Error handling** is mainly through indicators and display records (messages on the screen).
- **Subfile paging and selection** logic is central; understand variable roles like w_fcrn, w_srrn, w_ssrn, etc.
- **Modify with care**: due to the extensive use of indicators and positional logic, changes require careful regression testing.

---

**In summary:**  
This program is a classic green-screen subfile handler for supplier records, richly commented and structured around the management of a single subfile with supporting CRUD, inquiry, and navigation logic, including attention for end-user emulator compatibility.