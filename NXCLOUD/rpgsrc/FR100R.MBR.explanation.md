# RPG Program Walkthrough: Rabattmatrise Vedlikehold (FR100R)

This RPG program, `FR100R`, is a maintenance program for a discount matrix ("rabbattmatrise") used to manage hierarchical pricing/discounts in a business system. The naming and many comments are in Norwegian, but the structure follows classic RPG standards, specifically ILE RPG with externally described files, subfiles for display, and modular (subroutine) logic.

Below, I will walk you through the structure and logic of the program, focusing on main sections, key data structures, and the workflow/logic.

---

## 1. **Header & History**

- **Description**: The program manages the maintenance of a discount/pricing matrix, allowing discounts based on various customer, product, and grouping categories.
- **Revision History**: Detailed, with every major enhancement or bug fix noted (support for customer category, supplier, product group, Excel import, GUI adaptations, etc.).
- **Indicator Usage**: Lists the purpose of common indicators (e.g., LR for program end, 10/11 for rollup/rolldown, 30 for field protection, 31-79 for messages, etc.).

---

## 2. **File Declarations**

The program uses many physical files, most renamed to suit local naming conventions.

- **Discount Matrix Files**: `frablr`, `frablu`, ... through `frablc` are variants/views of the discount matrix, each for different key sequences to efficiently access or position on different hierarchy levels (price group, customer, supplier, etc.).
- **Supporting Master Files**: Customers (`rkunl1`), products (`vvarl1`), suppliers (`rlevl1`), groups, units, etc., are referenced for lookups and validation.
- **Display File**: `fr100d`, with subfiles (e.g., B1SFL) and info data structure (`infds`).

---

## 3. **Data Definitions**

Includes fields for:
- **Keys to all the discount matrix access paths** (local variables for chaining/setting keys)
- **Working variables for display logic** (subfile row numbers, statuses, etc.)
- **Date/time and descriptive fields** for UI messages, data entry, and validation
- **Constants**, e.g., `c_sfil` for subfile page size

---

## 4. **Subfile & Screen Logic**

### Subfiles (SFL):

- Used for listing matrix entries, with navigation (paging), selection, update, delete, copy, and add functionalities.
- Supports filtering and positioning based on various matrix levels (customer, group, etc.).

### Main Program Loop & Navigation:

- **Main tags**: `b2taga`, `b2tagb`, serve as entry/return points after screen/form interactions.
- **Function Key Handling**: Branches or subroutines activated by function keys (handled via indicators: *INKC, *INKD, *INKE, *INKF, etc.)
- **Security/Access Control**: Checks if certain function keys (like F8) are allowed via a call to an authorization program (`AD005R`).

---

## 5. **Core Subroutines and Their Purpose**

- `forny`: Refreshes the subfile contents based on the current positioning.
- `posisjoner`: Positions the file pointer based on the user's entry (customer, group, etc.), sets keys, and triggers subfile refresh.
- `subfile`: Handles reading, editing, copying, deleting, and viewing rows in the subfile.
- `xc1bld`: Logic for adding a new row (with field validation and duplicate check).
- `xc2bld`: Logic for maintaining (add/edit/view) a matrix row. Includes data movement, validation, and database update/write.
- `xd1win`: Handles delete confirmation and record deletion.
- `xk1win`: Handles logic for copying a row (user can specify source and destination).
- `clr_subfile` / `crt_subfile`: Clear and refill the subfile for display.
- `bck_subfile`: Handles page backwards in the subfile.
- `dsp_subfile`: Displays the subfile, handles page control.
- `spørring`: Field-level inquiry/help (pop-up information calls for all related master data).
- `filter`: Handles the filter pop-up, allowing user to limit which rows are displayed.
- `sjekk_input`: Validates that input keys/fields are valid, cross-referencing master data (customer, group, unit, etc.).
- `hent_info`: Fills out description fields for display based on entered keys.
- `kalk_dg`: Calls a separate program to calculate "dekningsgrad" (contribution margin/profitability) for a line, passing all relevant keys and discount fields.

---

## 6. **Display File and UI Layout**

- **Screen Images**: Subfiles (B1, B2), popups for add/edit/view (C1BLD, C2BLD), delete (D1WIN), copy (K1WIN), filter (F1WIN), and message windows (C1MSG, C1MSGEXCEL).
- **Field Descriptions**: All key fields (price group, discount category, customer, etc.) are referenced for display, validation, and inquiry.

---

## 7. **Data Validation and Integrity**

- On every entry (add/copy/edit), the program checks for:
  - Mutually exclusive/combinable key settings (e.g., customer & customer group).
  - Validity of related master data via lookups (chain operations).
  - Validity of date fields.
  - Duplicate keys for the discount matrix.
  - Special rules for price group, item no., and combinations thereof.
- Error conditions are signalled using indicators (e.g., *IN33, *IN34).

---

## 8. **Handling Imports from Excel**

- Special subroutine `Excel`, which allows updating the matrix from an Excel import file, running an external program for the update.

---

## 9. **KLIST and Key List Logic**

At the end, keylist (KLIST) definitions centralize the keys used for various file access and lookups, enabling efficient, consistent SETLL/CHAIN/READ/WRITE operations.

---

## 10. **Initialization: *INZSR**

- Upon calling the program, the `*INZSR` subroutine initializes:
    - Retrieves the company id (firm) from the Local Data Area (LDA).
    - Prepares the display and subfile, positioned at the default/top.

---

# **High-Level Workflow:**

1. **Program Starts, Subfile Displayed**: Loads rows for the relevant discount/pricing matrix, allowing scrolling and selection through a subfile.
2. **User Can:**
   - **Add**: Opens entry screen, validates, checks for duplicates, writes new row.
   - **Edit/View**: Retrieves existing row, allows update/view.
   - **Delete**: Confirms, deletes row.
   - **Copy**: Lets user copy a row to new keys.
   - **Filter/Position**: Lets user filter/subfile or jump to a given position using specific keys.
   - **Calculate**: For a given line, can call a separate routine to calculate profitability.
   - **Excel Import**: Launches import routines.
3. **Validation/Lookups**: On entry for key fields, calls supporting programs to lookup/validate keys and fill descriptions (customer name, group text, product description).
4. **Records Are Written, Updated, or Deleted**: Based on user operations, changes persist to the underlying database files.
5. **Program Ends on Exit**: Indicator LR sets to finish.

---

# **Key Takeaways for Developers**

- **Modular and Table-Driven**: The use of many access paths (frabl1 - frablc, etc.) makes this program efficient and flexible for user navigation.
- **Heavy Emphasis on Data Integrity**: Nearly every data entry is validated with supporting master data files.
- **User Interaction is Subfile-Driven**: The main user interface is a work-with subfile, with function keys for all special actions.
- **Integrated with Business Rules**: Many checks are tailored to business logic—e.g., which discount levels may be combined, dependencies between key fields, rules for price group/item combinations.
- **Expandable**: The design makes it straightforward to add new hierarchy levels or modify validation by extending the key logic and updating the relevant subroutines.

---

# **References for Onboarding**

- **Display Files (DDS)**: Familiarity with these is essential for understanding subfile navigation and screen layouts.
- **Physical Files/Fields**: Review the DDS/definitions for all referenced files (frab*, rkunl1, vvarl1, etc.), as keys and descriptions pull from there.
- **Supporting Programs**: Many `CALL` operations reference external RPG programs (RA506R, RA511R, FO714C, etc.) providing field validation or descriptions.
- **Indicator Usage**: Understanding legacy indicator logic is important, as much conditional logic is driven by indicators rather than named variables.
- **Business Rules**: The rules for how discounts are determined and which matrix combinations are allowed are embedded in `sjekk_input` and validation parts of the main loop.

---

If you are working with this source or similar RPG programs, familiarize yourself with:

- Subfile processing (paging, display, select, update)
- File access (CHAIN, SETLL, READ)
- KLIST for multi-part keys
- Indicator-driven conditional logic
- Error display and recovery
- Integration points with other programs

---

*This onboarding guide should help you rapidly gain context and understanding of the program's structure, flow, and coding practices in IBM i (AS/400) RPG environments. For deeper work, always consult the DDS for physical and display files and business requirement documentation.*