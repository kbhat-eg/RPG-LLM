# Explanation of the RPG Program: `ASOFAK` (Subprogram for Rounding)

This RPG program—used as a subroutine—performs "avrunding" (rounding) of monetary amounts in various contexts: purchase price, cost price, sales price excluding VAT, and sales price including VAT. The program is data-driven, drawing rounding logic and thresholds from database files.

## High-Level Purpose

- **Input:** Receives company, item, code (determines price type), and amount.
- **Output:** Rounds the amount based on rules from master data files and returns the rounded value via the same parameter.
- **Driven by:** The value in `p_kode` deciding the rounding type, plus configuration settings read from files.

---

## Key Sections

### 1. File Definitions

```rpg
ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
```
- These are database (DISK) files for status, item, and item group definitions. They are read by key to determine company/item context and rounding rules.

---

### 2. Parameter Definitions

```rpg
d p_firm          s                   like(vvfirm)
d p_vare          s                   like(vvvare)
d p_inlr          s              1        // *INLR flag (close files)
d p_kode          s              1  0     // Rounding code (price type)
d p_bel1          s             11  2     // Amount to round (input/output)
```
- **p_firm**: Company ID.
- **p_vare**: Item ID.
- **p_inlr**: Flag to indicate if *INLR indicator (program closure) should be set.
- **p_kode**: Code for type of price to round (1=purchase, 2=cost, 3=sales excl. VAT, 4=sales incl. VAT).
- **p_bel1**: Amount to round (parameter is updated with the result).

---

### 3. Local Variables

Variables such as `w_avrk`, `w_spny`, `w_ø rer`, etc. are used to:
- Hold intermediate price type codes and thresholds.
- Split the amount into Krone/Øre (whole/decimal).
- Store rounding thresholds (fetched from files).

---

### 4. Program Flow

#### Initialization/Entry List

The program expects 4 or 5 parameters (firm, item, code, amount, and optionally inlr flag).

#### Manual File Closing Support

```rpg
if p_inlr = *on
    goto avslutt
endif
```
- If the *INLR flag is set, skip to program end to trigger file closure.

#### Early Exits

The program aborts early if:
- The amount is zero.
- A file lookup fails.
- The rounding code is invalid.
- The rounding parameter for the selected code or context is zero (no rounding defined).

---

#### Fetching Rounding Rules

- Looks up the relevant **status record** for the company.
- Loads the relevant **rounding rule** (w_avrk) based on `p_kode` (purchase, cost, sales, etc.).
- Looks up **item** and **group** records for possible overrides/special rules (e.g., vguavr).

#### Decides if Amount Should Rounding Should Happen

- If `vguavr` (rounding allowed for group) is 1, skip rounding.

---

### 5. Rounding Logic

#### Splitting Amount

- Separate amount into integer and decimal part (kroner/øre).
- `w_spny` is the rounded amount (working variable).

#### Rounding Rules by Thresholds

- **faagr0**: Below this, no rounding.
- **faagr1**: Round to nearest 0.05.
- **faagr2**: Round to nearest 0.10.
- **faagr3**: Round to nearest 0.50.
- **faagr4**: Round to nearest 1.00.
- Over **faagr4**: Round to nearest 10.00.

#### Per-Threshold Rounding Logic

For each threshold, separate logic for:
- **w_avrk = 1 "NÆRMESTE" (nearest)**: round to nearest, e.g. 0 or 5 øre,
- **else "OPPOVER" (up)**: always round up.

Each block contains arithmetic and "move" operations to adjust `w_spny` to the correct granularity. For example, for amounts between the 0 and 0.05 thresholds, it checks the decimal part and applies the corresponding rounding.

---

### 6. Tagging and Setting Results

- The result is written back to the parameter `p_bel1`.

---

### 7. Program End / File Closing

If `p_inlr=*on`, set RPG indicator *INLR before returning, which ensures files are closed.

---

### 8. Initialization Subroutine `*inzsr`

- Sets up the parameter list.
- Initializes the various keys for file lookups, populating working storage variables.

---

## Summary Table

| Parameter | Description                                                |
|-----------|-----------------------------------------------------------|
| p_firm    | Company number                                            |
| p_vare    | Item number                                               |
| p_kode    | Rounding code (1–4; which price type to use)              |
| p_bel1    | Amount to round (input & output)                          |
| p_inlr    | Indicator to close files after running (optional/flag)    |

| File     | Purpose                                  |
|----------|------------------------------------------|
| fstsl1   | Status/Company-level rounding rules      |
| vvarl1   | Item master (for group mapping etc.)     |
| vugrl1   | Item group master (group-level rounding) |

---

## Takeaways

- The program is designed for flexible, parameter-driven monetary rounding.
- Rounding logic and threshold values are not hardcoded, but are fetched from database files, allowing for easy changes by updating master data.
- The code handles rounding up, rounding to the nearest, and does nothing (if not required).
- The design allows future modifications and supports company/item-specific overrides.

---

## Useful for New Developers

- If you need to adjust rounding logic or thresholds, update the relevant database records, not the program.
- If you add new rounding codes/pricing types, expand the section where `p_kode` is evaluated.
- The program can be called as a subroutine from other programs that need configurable monetary rounding.
- The code uses classic RPG III/400 (fixed format C specs). If you need to modernize it, consider moving to free-format RPG.

---

If you have specific questions about a section of the code or how a particular scenario is handled, please ask!