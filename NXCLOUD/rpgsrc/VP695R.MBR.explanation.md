# RPG Source Code Explanation – Program VP695R

## Overview

This RPG program, named **VP695R**, is designed to **generate unique filenames** for files that will be transferred to an online store (nettbutikk), based on input parameters such as store ID, customer, and customer project. The generated filename structure and its file extension are dynamically built from these parameters.

---

## Header and Comments

- **h option(*nodebugio) datedit(*dmy)**
  - Compiler options: disables debug I/O and sets date editing to day/month/year.
- The comments at the top provide metadata:
  - System: ASOFAK
  - Description: Build unique filenames for e-commerce transfers, with parameters for store, customer, and customer project.
  - Maintenance history/changelog.

---

## Data Structure Definitions

### Filename Data Structure

```rpg
d                 ds
d d_fnav                        64
d  d_filtyp                      7    overlay(d_fnav)     inz('prisfil')
d  d_skill1                      1    overlay(d_fnav:8)   inz('_')
d  d_butiid                     15    overlay(d_fnav:9)
d  d_skill2                      1    overlay(d_fnav:24)  inz('_')
d  d_kunden                      6    overlay(d_fnav:25)
d  d_skill3                      1    overlay(d_fnav:31)  inz('_')
d  d_kprosj                      6    overlay(d_fnav:32)
d  d_fileks                      4    overlay(d_fnav:38)
```

- **d_fnav (64A):** The full filename (up to 64 characters).
- **Overlay fields:** Subfields, each overlaying a segment of `d_fnav` to assemble a filename of the form:
    ```
    prisfil_<storeid>_<customer>_<project>.<ext>
    ```
  - `d_filtyp`: 'prisfil' (starts at position 1, length 7)
  - `d_skill1`, `d_skill2`, `d_skill3`: underscores (‘_’) at appropriate spots in the name.
  - `d_butiid`: store ID (length 15)
  - `d_kunden`: customer (length 6)
  - `d_kprosj`: customer project (length 6)
  - `d_fileks`: file extension (.DAT, .XLS, .TXT, depends on format)

---

### Parameter Variables

```rpg
d p_buid          s             15
d p_firm          s              3
d p_kund          s              6
d p_kpro          s              6
d p_rfmt          s             10
d p_fnav          s             64
```

- **p_buid:** Store ID
- **p_firm:** Company code
- **p_kund:** Customer number
- **p_kpro:** Customer project
- **p_rfmt:** File format code (e.g., 'NOBB', 'REGNEARK', etc.)
- **p_fnav:** Output variable to receive the constructed filename

---

## Main Logic

### 1. Set File Extension Based on File Format

```rpg
c                   select
c                   when      p_rfmt = 'NOBB'
c                   eval      d_fileks = '.DAT'
c                   when      p_rfmt = 'REGNEARK'
c                   eval      d_fileks = '.XLS'
c                   when      p_rfmt = 'REGNEARKPO'
c                   eval      d_fileks = '.XLS'
c                   other
c                   eval      d_fileks = '.TXT'
c                   endsl
```

- Depending on the input parameter `p_rfmt`, the file extension (`d_fileks`) gets set:
  - 'NOBB' → `.DAT`
  - 'REGNEARK' or 'REGNEARKPO' → `.XLS`
  - Any other format → `.TXT`

---

### 2. Build the Filename

```rpg
c                   eval      d_butiid = p_buid
c                   eval      d_kunden = p_kund
c                   eval      d_kprosj = p_kpro
c                   eval      p_fnav = d_fnav
```

- Assigns input parameters (`p_buid`, `p_kund`, `p_kpro`) into their appropriate subfields in the filename data structure.
- Finally, the constructed filename (`d_fnav`) is placed into the output parameter (`p_fnav`), for use by calling programs or downstream processing.

---

### 3. Program Termination

```rpg
c     end_pgm       tag
c                   eval      *inlr = *on
c                   return
```

- Marks the logical end of the program.
- Sets the last record indicator (`*inlr`) to *ON, signaling end of program.
- Returns control to the caller.

---

## *INZSR Subroutine – Program Initialization

```rpg
c     *inzsr        begsr
     *  Tar inn parameter fra forrige program
c     *entry        plist
c                   parm                    p_buid
c                   parm                    p_firm
c                   parm                    p_kund
c                   parm                    p_kpro
c                   parm                    p_rfmt
c                   parm                    p_fnav
c                   endsr
```

- The special *INZSR subroutine runs at program start.
- Receives parameter list from calling program (input/output):
    - Store ID (`p_buid`)
    - Company code (`p_firm`)
    - Customer (`p_kund`)
    - Project (`p_kpro`)
    - Format (`p_rfmt`)
    - Filename (IN/OUT, `p_fnav`)

---

## Summary

- **Purpose:** Compose a unique output filename for a store transfer, using input parameters to build the name and select the extension.
- **Input:** Store, company, customer, project, file format.
- **Output:** Filename returned via parameter.
- **Design:** Uses overlays in a data structure for easy building and output of filenames.
- **Extensibility:** Adding new formats/extensions is straightforward.

---

### Example Output

Given:
- `p_buid`: 'STORE123'
- `p_kund`: 'CUST1'
- `p_kpro`: 'PROJ9'
- `p_rfmt`: 'NOBB'

Output (`p_fnav`):
```
prisfil_STORE123_CUST1_PROJ9.DAT
```

---

This modular approach ensures the filename always follows the required format, can be easily extended, and makes maintenance simple.