# Explanation of the RPG Program

This RPG (Report Program Generator) program, named **VG791R**, is written for the IBM i (AS/400, iSeries) platform using the ILE RPG language. Its main purpose is to fetch the current average cost price for an item as of a given date. If the average cost price is not found, it retrieves a calculated cost price instead. Below is a breakdown to help new developers understand its structure and core logic.

---

## 1. **Header Specifications**
```rpg
h option(*nodebugio) datedit(*dmy)
h dftactgrp(*no)
```
- `option(*nodebugio)`: Disables debug I/O.
- `datedit(*dmy)`: Sets default date format (day/month/year).
- `dftactgrp(*no)`: Program runs in its own activation group (ILE).

---

## 2. **File Specifications**
```rpg
fvgkpi3    if a e           k disk    rename(vgkpst:vgkpi2r)
fvvarlr    if a e           k disk    rename(vvarpfr:vvarlrr)
fvgkkir    if   e           k disk    rename(vgkkst:vgkkirr)
```
- Three physical files are used:
  - **vgkpi3** (renamed from `vgkpst`): likely contains cost price records.
  - **vvarlr** (renamed from `vvarpfr`): likely contains item master data.
  - **vgkkir** (renamed from `vgkkst`): possibly a code table.
- All three use indexed (keyed) access. 

---

## 3. **Data Definitions (D-Specs)**

### **Parameters**
```rpg
d p_vare          s                   like(vgvare)
d p_lage          s                   like(vglage)
d p_dato          s                   like(vggdat)
d p_cost          s                   like(vgcost)
d p_prgr          s              1
d p_lety          s              1  0
d p_sapr          s              9  2
d p_gmpr          s              9  2
d p_kopr          s              9  2
d p_inpr          s              9  2
d p_inlr          s              1
```
- Parameters passed when calling the program.  
  - `p_vare`: item number
  - `p_lage`: warehouse/location number
  - `p_dato`: date
  - `p_cost`: cost (output)
  - Additional pricing parameters (groups, types, prices, flags)

### **Local Data Area**
```rpg
d                uds
d l_firm                944    946  0
```
- The company number is extracted from the User Data Area (LDA).

### **Other Variables**
- Keys and working variables are defined to facilitate searching and calculations.

---

## 4. **Main Logic**

### **Initialize Key Fields**
```rpg
c                   eval      vgkpi3_vare = p_vare
c                   eval      vgkpi3_lage = p_lage
c                   eval      vgkpi3_gdat = p_dato
```
- Sets up the lookup key for the cost price file using input parameters.

### **Fetch Latest Cost Price**
```rpg
c     vgkpi3_key    setll     vgkpi3
c                   read      vgkpi3
```
- Positions (`setll`) and reads vgkpi3 for a matching record.

#### **Check if Cost Price Found**
```rpg
c                   if        %eof or
c                             vgfirm <> w_firm or
c                             vgvare <> p_vare or
c                             vglage <> p_lage
c                   eval      p_cost = 0
c                   else
c                   eval      p_cost = vgcost
c                   endif
```
- If no record found, or record doesnâ€™t match the firm/item/location, set cost to 0.
- Otherwise, set output cost to the value found.

### **If No Cost Price: Fetch Calculated Cost**
```rpg
c                   if        p_cost = 0
c                   eval      p_prgr = *blank
c                   eval      p_lety = 0
[... SQL to look up price group in VPGRPF ...]
c                   eval      w_date = p_dato
c                   eval      vvarlr_vare = p_vare
c     vvarlr_key    chain     vvarlr
```
- If no valid average cost was found, fetch other parameters:
  - Lookup price group via embedded SQL (`vpgrpf` table).
  - Fetch item data from `vvarlr`.

#### **Call to External Program**
```rpg
c                   call      'VP730R'
c                   parm                    w_firm
c                   parm                    p_vare
c                   parm                    p_prgr
c                   parm                    p_lety
c                   parm                    w_date
c                   parm                    vvenhl
c                   parm                    p_sapr
c                   parm                    p_gmpr
c                   parm                    p_kopr
c                   parm                    p_inpr
c                   parm                    p_lage
```
- Calls subprogram `VP730R` to calculate cost price and related values, passing relevant parameters.
- The new cost is taken from the returned value (`p_kopr`).

---

## 5. **Program End and INLR Handling**
```rpg
c                   if        p_inlr <> *on
c                   eval      *inlr = *on
c                   endif
c                   return
```
- The program only sets LR (last record indicator, i.e., signal end of job) if `p_inlr` is not set, to control whether files are closed and program resources purged.  
- This allows the program to remain resident if called repeatedly, improving performance.

---

## 6. **Initialization Subroutine (`*inzsr`)**
```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_vare
c                   parm                    p_lage
c                   parm                    p_dato
c                   parm                    p_cost
c                   parm                    p_inlr
[...]
c                   eval      w_firm = l_firm
[...]
c     vgkkir_key    chain     vgkkir
c                   if        vgprlg = 'N'
c                   eval      p_lage = 0
c                   endif
c                   endsr
```
- Initializes the program.
- Retrieves passed parameters.
- Gets the company number from the LDA.
- Looks up a flag (`vgprlg`) in `vgkkir` to determine if cost price is per warehouse; if not, zeroes out the warehouse/location variable.

---

## 7. **Indicator Usage**
- **LR**: Used to end the program and close files (except suppressed by `p_inlr`).
- **80-99**: Reserved for internal logic (not visibly used in supplied code but documented for future refactors/extensions).

---

## 8. **Version History and Comments**
- Comments are extensive, including Norwegian language documentation, versioning (with developer initials and dates), and explanations of business logic changes.

---

## Summary

- **VG791R** is a service program that retrieves or calculates an item's average or calculated cost as of a specific date, given item number and warehouse.
- It first tries a direct file lookup.
- If not found, it derives/calculate the price by looking up price group and calling an auxiliary program.
- It manages activation group finalization based on an input flag.
- Initialization handles parameter setup and determines if costs are tracked by warehouse or globally.

---

This program is a good example of a data-access RPG program performing legacy business logic with a mix of native file, LDA, and external program calls, and modern (embedded SQL) lookup. The design enables efficient repeated calls without closing files unless requested, suitable for use in batch or service program scenarios.