# Documentation for Program JW506R: Vare-pakning, velg leverandør

## Overview

**JW506R** is a display file-driven RPG program used in the ASOFAK system to support the business process of selecting a supplier ("leverandør") for a given item ("vare") during the packing process ("vare-pakning"). The program is invoked only when there are multiple suppliers for a given item, presenting the user with a subfile list to select the appropriate supplier.

This program is part of a larger suite for item and supplier management and is typically called from other programs (notably JW510R) to handle supplier selection. The code makes extensive use of subfiles for display and selection logic.

---

## Files and Data Structures

### Physical and Logical Files

- **jvpkl1**: Item-price-supplier file (likely containing price and supplier info for items)
- **jlevl1**: Supplier master file (supplier names and details)
- **jvarl1**: Item master file (item details)
- **JW506d**: Display file, containing subfile (b1sfl) and control records (b2ctl, b2cmd)

### Data Structures

- **dspfbk**: Display feedback data structure, used to track display file cursor position and feedback information.

### Key Lists

- **jvpkl1_key**: For positioning/reading by item and supplier.
- **jvpkl1_key2**: For reading all suppliers for a given item.
- **jvarl1_key**: For reading item master by item.
- **jlevl1_key**: For reading supplier master by supplier number.

---

## Parameters

- **p_firm**: Company/firm number.
- **p_vare**: Item number (like jwvare).
- **p_ldor**: Supplier number (like jwldor).

---

## Main Program Flow

### Initialization (`*inzsr`)

- Receives parameters: company, item.
- Reads item master to validate item.
- Counts the number of unique suppliers for the item in the item-price-supplier file (`jvpkl1`). If only one supplier exists, the program exits immediately (no selection needed).
- If multiple suppliers exist, sets up subfile display:
    - Positions to the start of item-supplier records.
    - Calls subroutine to fill the subfile (`crt_subfile`).

### Main Loop

- If only one supplier, calls JW510R directly with the supplier and exits.
- Otherwise, enters a loop to display the subfile and interact with the user.
- Handles function keys (roll up/down, refresh, home, etc.) and selection logic.
- When a supplier is selected, calls JW510R with the selected supplier and exits.

---

## Subfile Processing

The program uses a subfile (`b1sfl`) to display a paged list of suppliers for the selected item. Several subroutines support subfile operations:

### `dsp_subfile`

- Handles display of the subfile control record.
- Sets indicators for subfile display and control, then issues EXFMT on the control record.

### `clr_subfile`

- Clears the subfile by setting indicator 14 and writing the control record.
- Resets various subfile counters and pointers.

### `crt_subfile`

- Fills the subfile with supplier records for the current item.
- Reads through `jvpkl1` for the item, adding one record per unique supplier.
- For each supplier, retrieves the supplier name from `jlevl1` (if available).
- Sets subfile fields and writes the subfile record.
- Handles page size and subfile record counters.

### `bck_subfile`

- Handles rolling the subfile back one page.
- Reads backwards in `jvpkl1` to position the subfile to the previous page.
- Clears and refills the subfile.

### `forny`

- Refreshes the subfile from the current position (used for the refresh function key).

### `posisjoner`

- Repositions the subfile based on a supplier number entered by the user.
- Clears and refills the subfile starting from the specified supplier.

### `subfile`

- Processes the subfile after user input.
- Checks for a selection (b1valg = 1) and sets the selected supplier.
- Handles toggling of indicator 22 for cursor placement.

---

## Function Key and Indicator Handling

The program uses a set of indicators for function key handling and subfile operations:

- **10**: Roll up
- **11**: Roll down
- **12**: Subfile display
- **13**: Subfile display control
- **14**: Subfile clear
- **15**: Subfile end
- **21**: Home key
- **22**: Cursor placement

Other indicators (31-99) are reserved for errors, warnings, and working flags.

---

## Business Logic and Domain-Specific Notes

- The program is only active if there are two or more suppliers for the item; this prevents unnecessary user interaction when only one supplier is available.
- Supplier selection is critical for subsequent processes (e.g., pricing, order creation) and is passed to JW510R for downstream processing.
- The subfile is paged, with a page size determined by `c_sfil` (default 8).
- The code ensures that only one record per unique supplier is shown, even if the item-supplier file contains multiple price records per supplier.

---

## Relationships

- **JW510R**: This program is called both if there is only one supplier and after a supplier is selected. JW510R likely handles further processing for the item and supplier.
- **jvpkl1, jlevl1, jvarl1**: Core data files for item-supplier relationships, supplier master, and item master.

---

## Design Patterns and Conventions

- **Subfile Paging**: Standard paged subfile pattern, with roll up/down and refresh.
- **Indicator Usage**: Follows a strict convention for indicators, with comments explaining their purposes.
- **Single Responsibility**: Each subroutine is focused on a specific aspect of subfile or display management.
- **Early Exit**: If only one supplier, program exits early to streamline user experience.
- **Supplier Deduplication**: Ensures only one entry per supplier, even if multiple records exist for the same supplier and item.

---

## Special Considerations

- The code uses Norwegian variable and comment naming conventions; be aware of translations (e.g., "vare" = item, "leverandør" = supplier).
- The program assumes a fixed subfile size and uses explicit counters for paging.
- Error handling is minimal; assumes data integrity in master files.

---

## Summary

JW506R is a focused utility for user-driven supplier selection in the context of item packing, leveraging subfiles for interactive selection only when necessary. It integrates tightly with master data files and downstream processing programs, and is designed for efficiency and clarity in its user interaction model. The codebase uses established RPG subfile and indicator handling patterns, with clear separation of concerns in its subroutines.