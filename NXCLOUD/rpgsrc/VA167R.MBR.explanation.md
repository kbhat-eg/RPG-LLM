# VA167R – RPG Program Explanation

This ILE RPG program (VA167R) is a green-screen, subfile-based maintenance application for managing "bonus rates by bonus type". The code is annotated with Norwegian descriptions, which I'll preserve while providing English explanations. The structure, use of subfiles, and modular routines make this application typical for IBM i panel-driven business administration.

---

## 1. **Header and Meta Information**

- `h option(*nodebugio) datedit(*dmy)`:  
  - Sets the compilation options.  
  - `*nodebugio` disables certain debugging features for input/output operations.
  - `datedit(*dmy)` sets the date edit mode to day-month-year.

- The comment block details the system, program, purpose, and a change log, indicating a mature, versioned program.

---

## 2. **File Declarations (F-Specs)**

- Four physical files (likely database tables), each with `rename` to map external record formats to internal variable names:
  - `ekbsiu`, `ekbsir`, `ekbsi1`, and `vbotl1` (all renamed).
- One `WORKSTN` display file (`va167d`) uses subfiles (`sfile(b1sfl:w_srrn)`) for screen lists, with a data structure `dspfbk` for feedback (e.g., cursor position, etc.).

---

## 3. **Data Declarations (D-Specs)**

- **Parameters and Local Data Area:**  
  - `p_boty`: program parameter for "bonus type", passed at *ENTRY.
  - `l_user`, `l_firm`, `l_fnav`: mapped to fields in the User Data Area (UDA), typical for session-specific information.
- **Display Feedback Data Structure:**  
  - `dspfbk`: used to retrieve UI information (e.g., cursor location).
- **Key Variables for Files:**  
  - Variables for the keys to the database files: e.g., `ekbsir_sbot`, `ekbsir_saar` (bonus type, year, etc.).
- **Working Variables:**  
  - Paging and subfile control: e.g., `w_fcrn` (first record number), `w_srrn` (subfile record number), etc.
- **Flags:**  
  - Boolean (`1A`) flags for different program states (error, renew, maintenance, cancel, subfile in use) using `inz(*off)` to initialize off.
- **Constants:**  
  - E.g., `c_sfil` (subfile size).

---

## 4. **Comments on Indicators and Subfile Fields**

- Details usage of RPG indicators (`*INxx` flags), such as:
  - `LR`: End program
  - 10-15: Paging/subfile controls
  - 21-22: Cursor/home key
  - 30: Field protection
  - 31-99: Error/working indicators
- Subfile working variables are explained (record numbers, page counts, etc.)
- Screen formats used (subfile record, control, command, maintenance, window, etc.)

---

## 5. **Main Control Flow (C-Specs)**

### **Program Loop and Dispatch:**
- Tag-based ("Goto") mainline, with subroutines and logic for handling:
  - Opening the command window
  - Navigating and displaying the subfile
  - Handling function keys (F-keys), which trigger maintenance routines, inquiries, add/update, copy, delete, view, and paging.

### **Subfile Processing:**
- Subroutine `subfile` loops through subfile entries using `readc` (reads records with changes).
  - Checks for different actions via a selection field on each row (`b1valg`): edit, copy, delete, view.
  - Calls corresponding subroutines: `xc2bld`, `xk1win`, `xd1win`
  - Updates subfile record on completion.

### **Subfile Refill and Renewal:**
- `forny`: Repositions the main file for the bonus type and year, clears and refills the subfile (`clr_subfile`, `crt_subfile`).

### **Add, Copy, Modify, and Delete:**
- `xc1bld`: Handles creating a new row, validating, checking for duplicates, and calling the maintenance dialog (`xc2bld`).  
- `xc1msg`: Shows a message if the row already exists.
- `xc2bld`: The main edit/maintain routine – fills/edits record fields, validates, and writes to the database (update or add), and also updates subfile if necessary.
- `xd1win`: Handles delete window – gets the record, displays confirmation, and deletes if confirmed.
- `xk1win`: Handles copy window – reads source record, allows new range, validates, and then invokes edit dialog for copied entry.

### **Subfile Maintenance:**
- `clr_subfile`: Clears subfile and resets pagination variables.
- `crt_subfile`: Fills subfile with records from the master file, up to the subfile size (`c_sfil`).
- `dsp_subfile`: Shows the subfile on-screen, handles indicators for proper UI display.

---

## 6. **Function Key Handling**

- The SELECT block dispatches actions based on function keys (e.g., *INKA, *INKD).
  - Calls subroutines or exits program as necessary.
  - Handles paging, renew, maintenance, and cursor positioning.

---

## 7. **Initialization (`*INZSR`)**

- Called once at program startup.
- Sets up parameter list, fills key lists for file lookups, initializes main working values (from LDA, year, etc.), fetches descriptions (e.g., bonus type text), and fills the subfile for initial display.

---

## 8. **Key Lists (Db File Lookup Keys)**

- For every main file operation (chain, setll, etc.), a key list is defined, containing all the primary key fields ordered as expected by the logical file.  
- This structure is necessary for correct random access and updates of DB records.

---

## 9. **Unimplemented/Placeholder Subroutines**

- `spørring`: Defined but not implemented (would handle inquiry/lookup features).

---

## 10. **General Observations**

- **UI Paradigm:**  
  Uses subfiles for list display and row selection; pop-up windows for CRUD operations (create, read, update, delete).
- **Error and Validation:**  
  Relies on *INxx indicators for error states, validation errors, and UI state.
- **Scandinavian Language:**  
  Comments and some variable names are in Norwegian, so some domain terms (e.g., "bonussatser", "bonustype") are business-specific.

---

## 11. **Summary Table of Key Subroutines**

| Subroutine   | Purpose                                              |
| ------------ | ---------------------------------------------------- |
| `forny`      | Refresh/reposition and reload the subfile            |
| `subfile`    | Handles per-row subfile operations (edit, copy, etc.)|
| `xc1bld`     | Add/Create new row via maintenance window            |
| `xc1msg`     | Show message for duplicate entries                   |
| `xc2bld`     | Edit/Maintain selected record                        |
| `xh1win`     | Show and handle paging/alternative selection window  |
| `xd1win`     | Handle Delete confirmation window                    |
| `xk1win`     | Copy an existing entry to a new key                  |
| `clr_subfile`| Clear out the subfile and reset state                |
| `crt_subfile`| Refill subfile from the database                     |
| `dsp_subfile`| Display the subfile on screen                        |
| `spørring`   | Placeholder for inquiry/lookup                       |

---

## 12. **Program Start/Exit**

- **Program Entry:**  
  Receives a bonus type parameter, initializes internal fields, displays the subfile UI.
- **Exit:**  
  When requested, sets LR (`*INLR`) to end the program and returns.

---

## 13. **Error/Status Management**

- Heavily dependent on RPG's 99 indicators for tracking UI and business states.
- Subfile record selection (`b1valg`) drives which CRUD operation is performed on a row.

---

## 14. **Typical Usage Pattern**

1. User enters via menu or call, passing a bonus type.
2. Subfile is shown listing current bonus rates of that type.
3. Function keys or subfile select options (edit, copy, delete, view) open relevant dialog windows.
4. Data is validated, and changes are written back to the database and/or subfile refreshed as needed.
5. User can page, renew, or exit at will.

---

## 15. **Conclusion**

This program is a good example of classic IBM i green-screen maintenance logic using subfiles and RPG, with clear separation of display, update, and database access logic via subroutines. The code is modular and well-commented, ideal for onboarding new developers in this business area.

---

**If you need clarification on any specific routine, indicator, or file, feel free to ask!**