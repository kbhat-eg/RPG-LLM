# RPG Program VV101R: Item Maintenance, Screen 1 (`VV101R`)

This RPG program is a part of an inventory or product master data management system. It provides maintenance functionality for items ("varer") - specifically, the first screen/tab of item maintenance. The program is well-established, maintained over years, and is layered with business rules and validations.

Below is a structured explanation to help new developers understand and onboard onto this code.

---

## High-Level Purpose

- **Core Functionality**: Maintains (view, add, edit) product master data in an inventory system.
- **Screen**: This is the “screen 1” view for item maintenance, likely displaying general item data and associated sales prices.
- **Business Context**: Handles complex business logic regarding item groups, price groups, units, suppliers, item types (stock, make-to-order, etc.), and other attributes.

---

## File Declarations

Many physical/logical files (tables/views) are declared as disk files. Each is used for a specific domain, for example:

- `vvarl1/vvarl3`: Item master (standard and by NOBB number)
- `vvasl1`: Deleted items
- `vvenl1/vvenl5/vvenlu`: Item units
- `vvprl1/vvprlr/vvprlu`: Item prices (by group/unit/dates)
- `vugrl1`, `vhgrl1`: Group/hierarchies
- `vvtyl1`: Item types
- `venhl1`: Units
- `rlevl1`: Suppliers
- `fstsl1`: Status codes
- Several others for supporting data

---

## Workstation File

- `vv101d` is the display file which holds the main screen, including a subfile for price information.

---

## Data Structures

### Parameters

- `p_firm`, `p_vare`, `p_valg`, `p_varekopi`: Used to pass company, item, mode, and possibly a copy-from item number to the program.

### Local Data Area

- For storing job/environment information such as user, file group, file name.

### Display Feedback

- Field for capturing the cursor location on the display (`dspfbk`).

---

## Key Variables

- Most variables are used for intermediate work, capturing field values for either the master screen or subfile rows (prices).
- The code uses RPG’s "like()" keyword to type variables based on corresponding file fields.

### Notable Working Variables

- `b_feil`: Indicator for input error
- `b_ny_vare`: Indicates if new item is being created
- `w_srrn`: Subfile row number
- `w_valg`: Indicates operation mode (edit, add, copy)
- `w_vare`, `w_firm`: Current working company and item numbers
- Numerous others for validation and display purposes.

---

## Constants

- Subfile display capacity (e.g., `c_sfil = 72`).

---

## Major Program Sections

### 1. *Main Control Flow*

- **Initialization**: Sets up display variables, determines if it’s a new or existing item, and loads appropriate data.
- **Subfile Management**: Loads price information into a subfile for display/edit.
- **Function Key Handling**: Calls other programs for notations, prices, units, etc.
- **Validation**: Data entered by the user is thoroughly validated for business and referential integrity.
- **Update**: Writes back changes to the database, handling both main item data and related price/unit records.

#### Typical Flow

1. **Initialize display**
2. **Load item (or new item template)**
3. **Handle special function keys (F2-Notat, F10-VA info, F15-Prices, etc.)**
4. **Validate input, show errors if any**
5. **Update item and related tables as required**
6. **Loop or exit**

### 2. *Subroutines (BEGSR/ENDSR)*

**Key Subroutines:**

- `endr_vare`: Load existing item data
- `ny_vare`: Initialize a new item
- `crt_subfile`, `clr_subfile`: Manage the price subfile (load/clear rows)
- `hent_kontr`: Fetches group/supplier descriptions for element display
- `kalk_dekn`: Calculates margin/coverage (dekningsgrad) for a price line
- `sjekk_input`, `sjekk_pris`: Validate main and subfile input fields according to a complex set of business rules
- `oppdater`, `oppdat_pris`, `oppdat_enhet`, `oppdat_omre`: Perform updates of item, price, and unit tables
- `spørring`: Handles F4 prompt/lookup logic
- `xb2msg`, `xb3msg`: Special message handling routines
- `vis_VA`: Show "VA" (possibly Norwegian “Value Added” or similar) information
- Specialized routines for updating related tables when, e.g., supplier or item type changes

---

## Validation Logic

The validation logic, both for the main item and the prices subfile, is extensive. Some highlights:

- **Basic Fields**: Checks for required fields (descriptions, group, type, units, etc.)
- **Groups/Hierarchy**: Ensures the chosen groups exist and are consistent.
- **Supplier and Units**: Ensures referenced suppliers and units exist.
- **Price Logic**: Guarantees units and prices are valid, handles special rules for "stock" vs. other types.
- **Business Rules**: For instance, item type may only switch between certain combinations (L↔S, D↔T), not others.
- **SQL Lookups**: Used to ensure prices exist for necessary units.

---

## Price Subfile Management

- On load, prices for the item are read from the database and populated into the subfile, grouped by price group and unit.
- When updating, the program compares the current subfile content to the previous state and updates, deletes, or adds as needed to the database files.

---

## Special Features and Integrations

- **NOBB**: This is a Norwegian industry standard for product numbers in building materials; there are special rules around this number.
- **Notat/Annotation System**: Items can have attached notes.
- **Subtle UI State Handling**: The program heavily uses indicator variables and data structure overlays to manage display and error highlighting.

---

## Function Key Navigation

- F2: Notat (notes)
- F10: Show "VA" information
- F13: To "screen 2" of item maintenance
- F14: Units maintenance
- F15: Prices maintenance
- F16: Search texts maintenance
- F17: EAN (barcode) maintenance
- F18: Offer prices
- F19: Price adjustment
- F20: Change base unit price
- F21: Supplier associations
- Navigation and exit keys

---

## Handling Price Groups and Security

- The code contains logic for users with special access to see more or all price groups ("For users with special access, you shall be able to use all price groups").
- Use of `FB700R` and `VL711R` to check access/limits.

---

## Modern Additions

Many program sections are marked with change numbers and initials (see comments): indicating years of change and which developer made the change. The code accommodates evolving business requirements and data structures.

---

## Relevant Norwegian Terms

You'll encounter Norwegian variable names (e.g., "vare" = item, "enhet" = unit, "gruppe" = group, "leverandør" = supplier, "utgått" = obsolete, "pris" = price). Understanding these is helpful for context.

---

## Entry Point and Initialization

- The program starts at the `*inzsr` routine.
- Receives parameters, sets up working storage, loads default values, determines if special flags or features are enabled (via calls to `CO402R`).
- Key-lists (KLIST) are defined for all major file lookups.

---

## Error Handling

- Display input errors by setting the appropriate display indicators (`*inXX`)
- Dedicated subroutines for displaying error and confirmation messages.

---

## SQL Integration

- Contains embedded SQL for some lookups and validations (added in later versions).

---

## Conclusion

### Onboarding Recommendations

- **Understand the physical/logical files, their relationships and business meaning** (look at the field definitions in the PF/LF source, and the DDS for the display files).
- **Read the business rules** in the comments—many validations will only make complete sense in the business-process context.
- **Look for change levels in comments** (e.g., `5.70`, `6.10`) to see how/why new variables or logic blocks appear.
- **Investigate called programs** (`LL766R`, `VK700R`, etc.) as they encapsulate further logic, especially for complex maintenance and lookups.
- **Pay attention to indicator variables** and their mapping to display fields (for error highlighting, etc).
- **Familiarize yourself with Norwegian business terminology** if not already known.

---

**This program is a highly-integrated, business-critical module for item maintenance in an AS/400 (IBM i) environment, deeply linked to surrounding master data tables, and built for robust data integrity and complex pricing/grouping scenarios.**