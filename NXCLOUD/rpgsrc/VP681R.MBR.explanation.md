# VP681R – Price File Control Program Documentation

## Overview

**Program:** VP681R  
**System:** ASOFAK  
**Description:** Controls the extraction and output of item price files to customers, based on various selection parameters and customer distribution lists.

This program orchestrates the creation of price files for customers, supporting selection by discount category, customer project, specific customer, or the entire distribution list. It gathers customer and distribution data, applies business rules, and delegates the actual file output to a separate program (VP682C). The logic is parameter-driven and accommodates several business requirements and special cases.

---

## File Dependencies

- **RKUNL1:** Customer master file (renamed record format: `rkunpfr` → `rkunl1r`)
- **FKDIL1:** Customer distribution list (renamed record format: `fkdipfr` → `fkdil1r`)

Both files are accessed by keyed I/O for efficient lookups and iteration.

---

## Parameter Structure

### Input Parameter List (`p_list`)

A packed data structure (`d_list`, 82 bytes) overlays the input parameter string. It is split into several fields, each mapped to a business concept:

| Field    | Pos | Length | Description                                   |
|----------|-----|--------|-----------------------------------------------|
| d_firm   | 1   | 3p0    | Company code                                  |
| d_rkat   | 4   | 3p0    | Discount category                             |
| d_kund   | 7   | 6p0    | Customer number                               |
| d_kpro   | 13  | 6p0    | Customer project number                       |
| d_rfmt   | 19  | 10a    | Record format                                 |
| d_vsor   | 29  | 10a    | Sorting value                                 |
| d_ogrp   | 39  | 2p0    | Main group                                    |
| d_hgrp   | 41  | 2p0    | Secondary group                               |
| d_ugrp   | 43  | 3p0    | Sub group                                     |
| d_ldor   | 46  | 6p0    | Delivery door                                 |
| d_rfm2   | 52  | 10a    | Alternate record format                       |
| d_sval   | 62  | 1p0    | S-value, business-specific                    |
| d_tval   | 63  | 1p0    | T-value, business-specific                    |
| d_2val   | 64  | 1p0    | 2-value, business-specific                    |
| d_bval   | 65  | 1p0    | B-value, business-specific                    |
| d_lety   | 66  | 1p0    | Delivery type                                 |
| d_dato   | 67  | 8d     | Date (ISO format)                             |
| d_lage   | 79  | 2p0    | Warehouse code (if applicable)                |
| d_nval   | 81  | 1p0    | NOBB-only flag (optional, for NOBB extraction)|

Other parameters:
- `p_fldr`: Folder name for output (12A)

---

## Main Control Flow

### Initialization (`*inzsr`)

- Reads parameters from the entry parameter list.
- Initializes key lists for file access.
- Splits the parameter structure into working variables.
- Captures a timestamp for unique file/member naming.

### Main Selection Logic

Based on the input parameters, the program selects one of four processing paths:

1. **By Discount Category (`d_rkat`):**  
   Calls `behandl_rkat`. Iterates all customers with the specified discount category, then all their distribution list entries.

2. **By Customer Project (`d_kpro`):**  
   Calls `behandl_kpro`. Processes the specified customer project.

3. **By Customer (`d_kund`):**  
   Calls `behandl_kund`. Processes all distribution entries for the customer, or a default if no distribution list exists.

4. **All Distribution List:**  
   Calls `behandl_tot`. Iterates the entire distribution list.

Each path collects the necessary data and calls the `prisfil` subroutine to output the price file.

---

## Subroutine Details

### 1. `behandl_rkat` – By Discount Category

- Reads all customers with the selected discount category from RKUNL1.
- For each customer, reads all distribution list entries from FKDIL1.
- Applies two filters before output:
  - Only entries with price file flag (`fhpfil`) set.
  - Only entries with a matching record format (if specified).
- Collects data from the distribution entry and parameter structure.
- Calls `prisfil` to generate the output.

### 2. `behandl_kpro` – By Customer Project

- Sets keys for the specific customer and project.
- If a distribution entry exists, uses its values, otherwise falls back to parameters.
- Calls `prisfil`.

### 3. `behandl_kund` – By Customer

- Looks up distribution entries for the customer.
- If none exist, outputs a default using parameter values.
- Otherwise, iterates all entries, applying parameter overrides as needed.
- Calls `prisfil` for each.

### 4. `behandl_tot` – Full Distribution List

- Iterates the entire FKDIL1 file for the current firm.
- For each entry, applies the price file flag and record format filter.
- Calls `prisfil`.

---

### `prisfil` – Price File Output

- Skips output if no record format is determined.
- If a main group (`d_ogrp`) is specified, blanks out the sorting value.
- Gathers all relevant fields from parameter structure and working variables.
- Generates a unique member name for the output file using the current timestamp.
- Calls external program `VP682C` with all collected parameters, which is responsible for the actual file creation/output.

#### Parameters sent to VP682C:

- Company, customer, project, sorting value, groupings, delivery door, record format, handler, date, business values (sval, tval, etc.), delivery type, date, warehouse, timestamp, output folder, member name, and NOBB-only flag.

---

## Key Business and Technical Decisions

- **Parameter-Driven:**  
  The program is highly parameterized, allowing flexible extraction scenarios.
  
- **Distribution List Logic:**  
  The customer distribution list (FKDIL1) is central. Only entries flagged for price file output and matching the record format are processed.

- **Record Format Filtering:**  
  Record format can be overridden via parameters or taken from the distribution entry, ensuring only relevant data structures are processed.

- **Timestamp-Based Member Naming:**  
  Unique member names for output files are generated using a timestamp, preventing collisions and aiding traceability.

- **Delegation to Output Program:**  
  All actual file output is handled by VP682C, keeping this program focused on selection and orchestration.

---

## Integration Points

- **VP682C:**  
  The called program that creates/writes the actual price file or output member. All relevant data is passed as parameters.

- **RKUNL1 & FKDIL1:**  
  All customer and distribution data is sourced from these files. The program assumes these files are available and keyed correctly.

---

## Conventions & Patterns

- **Overlay Data Structures:**  
  Parameter passing and parsing is handled by overlaying a single string with a data structure, a common pattern in legacy RPG for compact parameter lists.

- **Key Lists:**  
  Key lists are defined for efficient and consistent file access.

- **Field Overrides:**  
  Parameters can override values from distribution entries, providing flexibility in output customization.

- **Business Value Fields:**  
  Several fields (`sval`, `tval`, `2val`, `bval`, etc.) are business-specific and may require domain knowledge to interpret.

- **Warehouse Support:**  
  Extended in version 5.70 to support warehouse-specific pricing.

- **NOBB Extraction:**  
  Extended in version 7.02 to support extraction of only NOBB numbers (Norwegian building product registry).

---

## Version History Highlights

- **Support for warehouse-specific pricing and NOBB-only extraction.**
- **Parameter and structure expansions to accommodate new business requirements.**
- **Record format and member naming logic changes to support external output requirements.**

---

## Summary

VP681R is a key orchestration program for generating customer price files, supporting a range of selection criteria and business rules. It is tightly integrated with customer and distribution master data and delegates output responsibilities to a dedicated program. The codebase uses several legacy RPG patterns (overlays, key lists, etc.) and is structured for maintainability and extensibility in response to evolving business needs. Understanding the domain-specific fields and the logic for combining parameter and master data is essential for effective maintenance and further development.