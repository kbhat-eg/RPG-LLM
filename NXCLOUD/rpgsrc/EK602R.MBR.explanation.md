**Overview**  
This program (`EK602R`) generates a printed letter with bonus information for customers. It supports two primary paths for retrieving bonus data:

1. By customer category (`kal_kkat` subroutine)  
2. By individual customers (`kal_kund` subroutine)

It then writes the relevant data to a printer file (`fek602p`), using various record formats (e.g., `a1hdr`, `d1det`, `t1tot`).

---

## Purpose and Flow

1. **Initialization and Parameters**  
   - The program receives parameters such as the firm code (`p_firm`), year (`p_paar`), range of categories (`p_kfra` / `p_ktil`), and range of customers (`p_knrf` / `p_knrt`).  
   - These parameters determine which records are read from the bonus files and how the printed output is organized.

2. **Main Program Logic**  
   - Immediately sets some initial indicators and variables (e.g., `b_bonu` is turned off, and subtotals are zeroed).  
   - Decides whether to process by category (`kal_kkat`) or by customer (`kal_kund`) based on the incoming parameters.  
   - Ends by setting on the last record indicator (`*INLR`).

3. **Reading and Processing Data**  
   - Two files (`ekbti3` and `ekbti1`) are used to retrieve bonus data either by category or by customer (keyed by `ektkka` or `ektbku`).  
   - The program also reads from `ekboir` to compute additional bonus amounts (the “bonusgrunnlag”) for each customer.  
   - Customer details (e.g., name, address) are fetched from `rkunl1`.  
   - Bonus type descriptions are fetched from `vbotl1`.

4. **Subtotals and Printing**  
   - For each bonus entry, the program calculates the sum of two components (the “bonusgrunnlag” and the bonus itself) and writes detail lines (`d1det`).  
   - If a new category (or new customer) is encountered, it writes out any existing subtotal line (`t1tot`), resets the subtotal, and proceeds with the new set.  
   - Printing involves writing record formats to the printer file, with logic to handle page overflow (`xovrfl`).

---

## Key Subroutines

1. **kal_kkat**  
   - Processes records by category (`ekbti3`).  
   - For each category, it retrieves related bonus information and prints detail lines as needed.  
   - Subtotals are accumulated until the category changes, at which point totals are printed and reset.

2. **kal_kund**  
   - Processes records by customer (`ekbti1`).  
   - Follows a similar pattern: collects bonus data, writes detail lines, sums totals, then injects a subtotal line when switching to a new customer.

3. **kal_bgrl**  
   - Retrieves bonus amounts for the current customer and category combination from `ekboir`.  
   - Adds these amounts together to produce the “bonusgrunnlag” for each entry.

4. **finn_ktext**  
   - Looks up the customer’s name, address, etc., in `rkunl1` and populates summary fields (e.g., `a1kuna`, `a1kuga`).  
   - Signals that a new customer block is starting (setting `b_kund` on).

5. **finn_btext**  
   - Retrieves descriptive text for the bonus type (`vbotl1`) and places it in the appropriate output field (`d1besk`).

6. **xovrfl**  
   - Executed when a page boundary is reached (`*IN30` indicator).  
   - Performs a header write (`a1hdr`) to start a new page.

7. ***inzsr** (Implicit Initialization)  
   - Sets up parameters and read keys (e.g., `rkunl1_key`, `vbotl1_key`), populates working variables (`w_firm`, etc.), and translates some of the input fields into numeric values.

---

## Notable Design Points

- **Multiple File Renames**  
  Each physical file referenced in F-specs has its own renamed format. This is a common approach in this codebase to maintain distinct record format names (like `ekbti3r`, `ekbti1r`, etc.).

- **Category vs. Customer Logic**  
  The program has divergent paths for categories (`kal_kkat`) vs. customers (`kal_kund`), but the flow for each is nearly identical. This is to handle distinct business scenarios where bonuses are analyzed either by grouping or by individual customer records.

- **Subtotals and Summaries**  
  Each time the subroutine encounters a new category or customer, it writes out any pending subtotals (if `b_bonu` is on) and resets them. This pattern ensures a clean separation of data blocks on the printed report.

- **Interaction with Bonus Files**  
  After reading the main bonus files (`ekbti3` or `ekbti1`), a secondary lookup into `ekboir` computes the bonus sum (`w_bgrl`). This allows dynamic calculation without storing all details in a single file.

- **Printer Overflow Handling**  
  When indicator `*IN30` is set (which typically means the printer page is full), `xovrfl` writes a header record to start the next page. This is a recurring reporting convention in this system.

---

**Summary**  
In short, `EK602R` orchestrates the reading of customer and bonus data from several files, applying category-based or customer-based logic to gather and summarize bonus information. It then outputs a detailed and subtotaled report to a printer file, ensuring each page is logically split and includes relevant headings for clarity.