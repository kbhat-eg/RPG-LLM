# RPG Program Explanation: BYGGFTPR

## Overview

This RPG program, BYGGFTPR, is designed for the IBM i platform (AS/400) and constructs FTP command parameter files dynamically based on various input and database values. The generated FTP scripts are used for transferring files or libraries to/from external systems, handling both normal file transfers (GET/PUT/MPUT/MGET) and AS/400 library save/restore scenarios, including optional zipping.

The code is in the "traditional" fixed-format RPG IV (ILE RPG) style with extensive use of disk files, data structures, subroutines, and parameter handling.

---

## Main Data Files

- **afpapf**: Output file for FTP parameter/script lines (used with `SrcDta` data from the Linje1/Linje2 data structures).
- **aftpl1**/**aftplu**: Input files keyed by parameters, source of FTP control information (like user, password, file/library names, options), likely templates for FTP jobs.

---

## Key Data Structures & Variables

- **Linje1**: Data structure (80 bytes), maps out `bruker` (user, 36 bytes) and `passord` (11 bytes), used to create the login line for FTP.
- **Linje2**: Data structure (200 bytes), generic buffer for lines written to the FTP parameter file.
- **Parameter variables**: (e.g., `p_navn`, `p_status`, `p_konvin`, etc.)â€”used as program entry parameters and for returning results (host, conversion info, etc).
- **Working variables**: For holding temporary values, counters, commands, etc.

---

## Main Program Flow

### 1. Initialization (`*inzsr`)
- Sets up key lists for reading the template files (`aftpl1`, `aftplu`) based on company/firm and template name.
- Maps entry parameters to working variables.

### 2. Main Logic (Program Body)

#### a. Start Tag
- Looks up the main FTP template record (`aftpl1`) based on parameters.  
  - If not found, sets `p_status` = 'N' (not found) and exits.

#### b. Update Last Run Date
- Updates a separate tracking record (`aftplu`) if it exists with current date/time.

#### c. Special Case: Library Transfers
- If the `aflibt` flag is 'J' (library transfer), uses `aftype` to branch to special GET/PUT library subroutines:
  - `EXSR get_lib`
  - `EXSR put_lib`
- Otherwise, continues with normal file transfer processing.

#### d. FTP User/Password Setup
- Builds first FTP command line with user and password.
- Handles possibility of proxy or alternate host by combining username and host if required (`afprxu`).
- Optionally, calls a program (`AF709R`) to do password lookup/validation if `afqyps` is 'J'.

#### e. FTP Parameter File Generation

Writes lines to the FTP parameter file (`afpapf`) in sequence to set up the session, e.g.:

1. File naming format (`namefmt 0` or `1`)
2. Passive/active mode (`sendpasv 0` or `1`)
3. Data type (`binary` if needed)
4. Transfer commands based on type (`GET`, `PUT`, `MPUT`, `MGET`)
    - Includes handling of folder navigation, replacement options, command support lines, etc.
5. Handles filename overrides, counters, renaming, and deletion, as needed.

#### f. Library Transfer Special Subroutines

##### `get_lib`
- Runs CL commands to clear/create save files.
- Writes lines to:
  - Delete/create savefile on target.
  - Save and get libraries as savefiles via FTP.
  - Restore on target on completion.

##### `put_lib`
- Runs CL commands to clear/create/save libraries into save files.
- Handles zipping if requested (`afzipl`).
- Writes scripts for putting and restoring the savefile on the target system.

##### `put_w_zip`
- Special case for zipped transfers: uses PC file format (`namefmt 1`), transfers zipped file, unpacks remotely, and restores library.

---

## Additional Details

- **Flexible Command Construction:**  
  Many `eval` statements construct command lines using RPG string ops, often with `trim` to avoid spacing issues.

- **Extra User Commands:**  
  Up to 3 extra user-specified pre-commands can be included in the script (e.g., `afxcm1`, `afxcm2`, `afxcm3`).

- **Rename/Replace Handling:**  
  Handles optional renaming and file replacement based on parameters.

- **Teller (Counter) Support:**  
  If specified (`aftell` = 'J'), increments and includes a counter in the filename for uniqueness.

- **Optional Post-Transfer Deletions:**  
  If specified (`afslet` = 'J'), generates FTP commands to delete file(s) after transfer.

- **Return Parameters:**  
  Returns host, conversion, and status info to the caller via the entry parameter list.

- **Error Handling:**  
  Generally, on failed validation or external program call, sets status and exits; minimal error management otherwise.

---

## Summary Table

| Component                   | Purpose                                                         |
|-----------------------------|-----------------------------------------------------------------|
| FTP template file(s)        | Holds master data for FTP job configuration                     |
| Output parameter file       | Receives constructed FTP script                                 |
| Library transfer subroutines| Specialized save/restore, optionally zipped, for AS/400 objects |
| Password validation         | Calls out to another program if required                        |
| Parameterized scripting     | Handles various options per transfer: file naming, mode, etc.   |
| Extra commands              | Allows for custom FTP command lines in the job                  |

---

## Typical Use Cases

- Automated FTP transfer of files or AS/400 libraries based on job templates.
- Supports both receive (GET) and send (PUT/MPUT) transfers.
- Optionally supports savefile zipping.
- Can handle complex filename requirements, user/password proxying, and post-transfer actions.

---

## Onboarding Notes

- **Parameter-driven:** Most logic depends on the data in the template files and parameters passed in; reviewing a sample of those will help understand actual run scenarios.
- **Fixed-format:** This is not RPG Free Format; indentation and column positions matter for statements.
- **External Program Calls:** Some external CL programs (e.g., `QCMDEXC`, `AF709R`, `AZ700C`, `AZ701C`) are required for full function.
- **Norwegian Comments:** Many descriptive comments are in Norwegian; e.g. "Fjerne gammel savefile" = "Remove old savefile".

---

## Conclusion

BYGGFTPR is a robust, template- and parameter-driven FTP scripting engine for IBM i, supporting both standard and advanced (library/savefile/zipping) transfers. The logic is modular and extensible, largely focused on the needs of automated batch data export/import with rich options for customization and error handling. Reviewing the template files and customizing subroutines (if needed) will be critical for onboarding and possible enhancements.