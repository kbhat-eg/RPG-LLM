# RPG Program RR628R – Result Report Printout

This source code is for a classic ILE RPG (RPG IV) program that reads data from several files and prints a financial result report. The program includes significant logic for data selection, control breaks, subtotals, and text handling. Below is a pedagogical line-by-line walkthrough and summary of each part:

---

## 1. Header and Program Description

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **h-spec**: Disables debug I/O and sets date handling to day-month-year format.

The comment headers document the program (RR628R) and its purpose: *"Utskrift av resultatrapport"*, i.e., printout of a result (financial) report.

---

## 2. File Declarations (“f-specs”)

```rpg
frrf0l1    if   e           k disk    rename(rrf0pfr:rrf0l1r)
frrf5l1    if   e           k disk    rename(rrf5pfr:rrf5l1r)
frrf9l2    if   e           k disk    rename(rrf9pfr:rrf9l2r)
frrf9l1    if   e           k disk    rename(rrf9pfr:rrf9l1r)
frr628p    o    e             printer oflind(*in30)
```
- **frrf0l1, frrf5l1, frrf9l2, frrf9l1**: Input (i), Full procedural (f), externally described, keyed (k) disk files; renamed for local usage.
- **frr628p**: Output (o), external printer file, with overflow (page break) handled by indicator *IN30.

---

## 3. Table Definitions and Data Structures (“d-specs”)

### Arrays

```rpg
d pav             s              4  0 dim(24)   // Department numbers
d sal             s             11  2 dim(14)   // Amounts per period
```

### Data structures for break control

```rpg
d                 ds
d nybrd                          9  0
d  nylin                         5  0 overlay(nybrd)
d  nyavd                         4  0 overlay(nybrd:6)
d                 ds
d gmbrd                          9  0
d  gmlin                         5  0 overlay(gmbrd)
d  gmavd                         4  0 overlay(gmbrd:6)
```
- These “break” data structures are used for detecting changes in line and department.

### Local variables (“uds” and others)

Defines a large set of variables for:
- Parameters and selection fields
- Totals and subtotals per year/period
- Temporary values used in calculations
- Buffer fields for comparison, heading, etc.

Example:
```rpg
d rhprap                300    301  0 // Report number
d rhpkda                         6  0 // Something code A
// ... (many others)
d w_gtxt          s             30    // Department text (exp. to 30)
```
Variables are used for input parameters, accumulators, subtotals, heading management, etc.

---

## 4. Input Specification (“i-specs”)

These relate file fields to working storage, such as mapping file fields for period amounts to array elements:
```rpg
i              rr9s01                      sal(01)
i              rr9s02                      sal(02)
// ... up to rr9s13, rr9s00
```
This is done for both line and department order.

---

## 5. Main Control Logic (“c-specs”)

### a. Selection of records

Logic for selecting the correct file and reading the first record, depending on sorting parameter `rhpsrt` (sort by line/department).

```rpg
c     rrf9l1_key    setll     rrf9l1r
c     rrf9l1_key    reade     rrf9l1r                                60
```
- *setll*: Position cursor based on key
- *reade*: Read next equal key

### b. Main Processing Loop

```rpg
c                   dow       *in60 = *off
// ...
c                   enddo
```
- Read and process records until EOF.

#### Department selection filtering

Logic to ensure only the selected departments (from parameters/table) are considered.

#### Control break detection

- Compare current record’s “break fields” (`nybrd`) with previous (`gmbrd`)
- If a break, process subtotals (via subroutines) and print totals.

#### Subtotal and Accumulator Logic

- Accumulate per-year, per-period, per-type (actual/budget/alt-budget).
- Subroutines handle accumulation, resets, and summary printing.

---

## 6. Subroutines

### a. `rsum` – Sum up values

Handles the accumulation of amounts (saldo, budgets, etc) into subtotal fields:

```rpg
c     rsum          begsr
// ... update l1beår, l1saår etc based on year and record type
c                   endsr
```

### b. `hsum` – Calculate Per-Period and Year-To-Date Totals

Summing logic for current period and YTD totals.

### c. `brlin` – Line Break Handler

Handles totals and printing when a new line is encountered.

### d. `brtxt` – Text Line Handling

Prints associated text lines, including logic for handling multiple blank/sectioning lines.

### e. `bravd` – Department Break Handler

Handles breaks on department (prints heading, resets accumulators, fetches department name).

### f. `beregn` – Comparison Calculations

Computes percentages for comparisons to budget, last year, or averages, for both current and YTD.

### g. `skrhed` – Page Heading Printing

Writes report header lines to the printer file.

### h. `xltxt` – Text Line Fetch

Reads next text line from the text file.

### i. `brsln` – Fetch Comparison Line Amounts

Invokes program `RR612R` to fetch amounts for a specific comparison line.

### j. `l1null` – Reset Level 1 Accumulators

Clears subtotal accumulators after a subtotal is printed.

### k. *Initialization*

*inzsr initializes parameters, copies input selection criteria into local arrays and fields, fetches initial headings, etc.

---

## 7. Control Break and Summary Handling

- The program is based on “control break” processing. When a break on line or department is detected, it prints out accumulated subtotals and zeros the accumulators for the next group.
- Special handling for optional printing of blank lines, new pages (overflow), and writing section headers or text records.

---

## 8. External Calls

- **RS707R**: Called to get the department text for a given department code
- **RR612R**: Called to fetch amounts for comparison lines

---

## 9. Output

- The main output is printed report lines with subtotals, comparisons, headings, and optionally text lines. The exact layout is defined by “output specifications” in the printer file (not shown here but referenced via `write` operations).

---

## 10. Parameterization

The program is highly parameterized, with fields like `rhpsrt`, `rhpsml`, `rhphel` etc, controlling:
- Sorting order (line vs. department)
- Comparison type (budget, last year, average)
- Output scaling (whole, thousands)
- Department filtering and exclusion of “zero” lines

---

## 11. Indicators

Classic RPG indicators (e.g. *IN30 for page overflow, *IN60 EOF) are used throughout for flow control and conditional logic.

---

## 12. General Flow

1. **Initialization**: Load parameters, set up accumulators, fetch headings.
2. **Reading**: Loop through records, filter by department & other criteria.
3. **Break Control**: On control break, print subtotals, reset accumulators.
4. **Accumulation**: Summing values into period/year totals.
5. **Printing**: Write main data, subtotals, comparison info, section text as appropriate.
6. **Cleanup**: After last record, print final totals and headings.

---

## 13. Special Notes

- Norwegian field and comment names (e.g., "avdelings" = department, "saldo" = balance, "beløp" = amount, "tekst" = text)
- Extensively uses classic RPG "C-specs" style, with named tags, labels, and subroutine structure.
- The use of overlays in data structures is a way to break multi-part keys or fields into components, for easier break-detection.

---

## 14. Onboarding Summary

- **Purpose**: Generates a detailed, multi-level financial report.
- **Inputs**: Several files with result lines, department definitions, and report definitions.
- **Process**: Reads, filters, sorts, accumulates, and prints, with sophisticated subtotal and comparison logic, and department/line break handling.
- **Customization**: Driven by many parameters, allowing flexible reporting by period, department, type, and comparison basis.

**If you are onboarding to this code, start by understanding how break logic works, how accumulators are handled, and familiarize yourself with the RPG file specs and external program calls. Try mapping parameter fields in the code to their use for filtering and output formatting.**