# Overview

This IBM ILE RPG program is for a customer inquiry/search application intended for use on a radio terminal (likely a mobile device in a warehouse, etc.). The source code features robust subfile (paging/grid) handling, search/filter by customer name, and user navigation via function keys. The use of SQL for searching and subfile control is prominent.

The program name is `RK580R`, and it operates within the `ASOKON` system. The code and its comments (“beskrivelse”) are partly in Norwegian.

---

## File Specs

```rpg
frksopf    if   e           k disk
frkunl2    if   e           k disk    rename(rkunpfr:rkunl2r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)

frk580d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Physical files for lookup on customers (`rksopf`, `rkunl2`, `rkunl1`)
- The display file (`rk580d`) uses a subfile named `b1sfl` with record number `w_srrn`
- The `infds(dspfbk)` provides information about display operations/status.

---

## Data Definitions & Variables

### Parameters & Data Structures

- `p_firm`, `p_kund`: Passed in parameters (firm and customer identifiers)
- `dspfbk`: Display feedback data structure, e.g., holds cursor position info.
- Keys for file lookups are set up using key lists.

### Working Variables

- Variables for subfile handling and search text (`w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`, etc.)
- `b_open_sok`, `b_valg_ok`: State flags for SQL ("search open") and "option chosen"
- `w_ste1` to `w_ste5`: Up to five search phrases, used for customer search

### Constants

- `c_sfil`: Subfile page size constant (initialized to 4)

---

## Indicator Usage

Indicators (logical switches) guide display logic and program flow, per the comment header:
- LR: Last record, end program
- 10-15, 21-22, 30-99: Used for display/protect/status indicators

---

## Main Logic Flow

### Initialization (`*inzsr`)

- Receives parameters (`p_firm`, `p_kund`)
- Initializes keys for lookup
- Sets up file position and populates the subfile for the first view

---

### Main Input/Function Loop

Labeled sections (`b2taga`, `b2tagb`) orchestrate the program flow.

**b2taga:**
- Writes command screen (`b2cmd`), then moves to data handling

**b2tagb:**
- Calls subroutine to display subfile (`dsp_subfile`)
- Handles key actions via `select`:
    - Cancel (`*inkc`): Exit program
    - Refresh (`*inke`): Refreshes subfile, then redisplays
    - Roll (PageDn) (`*in10`): Loads next page of subfile records
- F2 (repeat search): Restores search text for another try
- If a new search phrase is entered, executes search subroutine
- Handles subfile selection (via `subfile` routine). If a customer is selected, exits.

---

### Subroutines

#### `forny`: Refreshes subfile
- Repositions file if needed
- Clears and recreates subfile contents

#### `søk`: Handles search
- Sets SQL search flags, gathers search key(s)
- Calls external program `AS700R` to parse search text into up to five tokens
- Clears and repopulates subfile with matching records

#### `subfile`: User selection logic
- Loops through displayed subfile lines
- If user has selected (`b1valg = 1`), stores customer id and signals selection

#### `clr_subfile`: Clears subfile and control indicators

#### `crt_subfile`: Populates the subfile
- If in search mode (`w_seqe='S'`), prepares and opens an SQL cursor based on search phrases; otherwise, reads from file
- Fetches records into the subfile, skipping customers marked passive (`rkpass='J'`)
- Performs in-memory matching for advanced search (tokens 2-5 in name)
- Stops when subfile page is filled

#### `dsp_subfile`: Display subfile screen
- If there are records, sets up for subfile display; else, shows command screen

---

## SQL Usage

- SQL is used for searching: sets up a cursor, fetches matching records, and closes/opens as necessary for each search.
- `DatFmt=*ISO` option ensures ISO date format.

---

## Subfile (Paging/Grid) Handling

- Program manages its own paging within the subfile by controlling `w_srrn`, `w_spge` (relative record # and subfile page size)
- Supports advanced search: allows up to 5 search tokens, presence tested in name field

---

## Miscellaneous

- Uses external RPG program (`AS700R`) to split search text
- Handles indicator-driven display protection and error/status signals

---

## Key Takeaways for New Developers

- **Navigation**: The workflow is stateful, looping between input/display and data subroutines, responding to function keys or commands.
- **Extensibility**: Adding new search fields or function key actions is straightforward via the subfile/search subroutines.
- **Subfile Mastery**: Understand the subfile structure, indicators, and data-backed paging for adding new fields or behaviors.
- **SQL/Native File Handling**: The program uses both SQL and native RPG file access, so familiarity with both is needed.

---

## Summary Table

| Area             | Description                                          |
|------------------|-----------------------------------------------------|
| UI Layout        | Subfile list of customers + command screen          |
| Key Features     | Paging, search, selection, filtering                |
| DB Access        | Native (CHAIN/READ) and SQL (cursor/fetch)          |
| Indicators       | Control screen, subfile, and navigation logic       |
| Extensibility    | Subroutines and modular variable naming             |
| Multi-language   | Code/comments in Norwegian with English RPG naming  |

---

## Next Steps

- Learn subfile handling in RPG if you’re new
- Study indicator management for display files
- Get comfortable with hybrid SQL/native data access
- Familiarize yourself with search tokenization logic and display data flows

---

**This code serves as a classic pattern for subfile-driven inquiry applications on IBM i.**