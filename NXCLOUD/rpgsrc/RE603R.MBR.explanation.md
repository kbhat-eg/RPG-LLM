# RPG Source Code Explanation: "Saldooverføring" (Balance Transfer)

This program, **RE603R**, is written in ILE RPG (RPG/400) and its purpose is to process and transfer account balances ("saldo") and budgets ("budsjett") for the Trioplan system. It's typical for financial or accounting batch jobs on IBM i (AS/400).

---

## 1. Program Metadata

```rpg
h/TITLE  Saldooverføring
h datedit(*dmy)
...
* System. . . . . : ASOKON
* Program . . . . : RE603R
* Beskrivelse . . : Saldo/budsjett til Trioplan
...
```

- **Title:** Balance Transfer
- **Date format:** Day-Month-Year
- **Purpose:** Transfer balances/budgets to the Trioplan system

---

## 2. File Definitions

```rpg
frhsal1    ipe  e           k disk    rename(rhsapfr:rhsal1r)
fre01pf    o  a e             disk
```

- **`rhsal1`**: Input file (probably account balances), with externally described keys. Renamed record format.
- **`re01pf`**: Output file for writing processed records.

---

## 3. Data Structures and Variables

### Arrays for Balances

```rpg
d sal             s             15  2 dim(14)   Saldo
d sa�             s             15  2 dim(14)   Saldo i år (This Year)
d saf             s             15  2 dim(14)   Saldo i fjor (Last Year)
d sab             s             15  2 dim(14)   Saldo budsjett (Budget)
```
- Four arrays (14 elements each):
  - `sal`: General balance storage
  - `sa�`: This year's balance
  - `saf`: Last year's balance
  - `sab`: This year's budget

### Input/Output Fields

These are likely for reading fields from input/output record buffers.

```rpg
d pfirm                 300    302  0      Firma
d pnavn                         30         Name
...
d pdato                          6  0      Per dato (to date)
d praar                          4  0      Per år (this year)
...
```

- Mappings of buffer positions (possibly for externally described data) to variables: company, user, date, year, period, department, etc.

### Other Variables

```rpg
d p_stat          s              1
d p_kont          s                   like(rikont)
d p_spes          s                   like(rispes)
d p_avde          s                   like(riavde)
d p_text          s             30
d p_gkod          s                   like(riavde)
d p_gtxt          s             20
...
d w_raar          s                   like(riraar)
d w_firm          s                   like(rifirm)
```

- Variables for:
  - Account, department, and special codes
  - Descriptive text
  - Working year/company

---

## 4. Input Record Definition

```rpg
irhsal1r
i                                          rifirm        l6
i                                          rikont        l4
i                                          riavde        l2
i              risa01                      sal(01)
i              risa02                      sal(02)
...
i              risa12                      sal(12)
i              risa13                      sal(13)
i              risa00                      sal(14)
```

- **Keys:** Company (`rifirm`), Account (`rikont`), Department (`riavde`)
- **Detail:** Each month's balances and a "total" (`risa00`).

---

## 5. Main Processing Logic

### a. Entry and Initial Checks

```rpg
c     a2tagb        tag
...
c     les           tag
```
- Label/tag for start of looping or main entry point.

#### **Company Check**

```rpg
if        *inl6 = *on
 eval      *in50 = *on
if        rifirm <> l_firm
 eval      *in50 = *off
endif
endif
if        *in50 = *off
 goto      slutt
endif
```
- Checks if the company changes. If company does not match expected (`l_firm`), branch to `slutt` (exit).

### b. Account Break (Kontonr-rekkefølge)

```rpg
if        *inl4 = *on
 eval      p_kont = rikont
 eval      p_spes = rispes
 eval      p_avde = riavde
 call      'RS740R'
    parm   p_stat
    parm   p_kont
    parm   p_spes
    parm   p_avde
    parm   p_text
 move      p_text        rhtext
endif
```
- On account break, call program `RS740R` to get account description, then move the result into a header text variable.

### c. Department Break (Avdelings-brudd)

```rpg
if        *inl2 = *on
 eval      sa� = 0
 eval      saf = 0
 eval      sab = 0
 eval      p_gkod  = riavde
 call      'RS707R'
    parm   p_stat
    parm   p_gkod
    parm   p_gtxt
 if        p_stat = 'N' and p_gkod = *zero
 eval      ragtxt = *blank
 else
 eval      ragtxt = p_gtxt
 endif
endif
```
- On department change, zero year/last year/budget arrays.
- Calls `RS707R` to get department name/description, or blanks department text if not found.

### d. Year Control

```rpg
if        riraar > praar or
          riraar < w_raar
 goto      slutt
endif
```
- Skips processing if the accounting year in question is outside of the accepted range (not this year or last year).

### e. Accumulate Balances

#### Saldo This Year

```rpg
if        ritype = 1
 if        riraar = praar
  add       sal           sa�
 endif
endif
```
- If record type is `1` (balance), and year is current, add to this year's array.

#### Saldo Last Year

```rpg
if        ritype = 1
 if        riraar = w_raar
  add       sal           saf
 endif
endif
```
- If record type is `1` and year is *last* year, add to last year's array.

#### Budget This Year

```rpg
if        ritype = 3
 if        riraar = praar
  add       sal           sab
 endif
endif
```
- If record type is `3` (budget), and year is current, add to budget array.

---

## 6. Write Results (on Department Break)

```rpg
cl2                 move      sa�(14)       risa00
cl2                 move      sa�(1)        risa01
...
cl2                 add       sa�(13)       risa12
cl2                 move      saf(1)        rqsa01
...
cl2                 move      sab(12)       rr9s12
cl2                 add       sab(13)       rr9s12
E501 cl2 50          write     re01pfr   SKRIV POST
```

- On a department break, moves balance arrays back to the record buffer/fields to prepare for output.
- Writes the output record to `re01pf`.

---

## 7. Initialization Subroutine

```rpg
c     *inzsr        begsr
  eval      w_raar = praar - 1
  eval      w_firm = l_firm
endsr
```
- On program initialization:
  - Sets `w_raar` ("previous year") to one less than current year.
  - Sets working company variable.

---

## 8. Special Indicators

- **`*inl6`, `*inl4`, `*inl2`**: Break indicators — denote a key change on company, account, and department respectively.
- **`*in50`**: Used to control continued processing or early exit.

---

## 9. Flow Overview

**High Level Processing:**

- For each record in the input file:
  - Check if the company matches
      - If account key changes: fetch account text/description
      - If department changes: fetch department description, zero accumulation arrays
  - Ensure accounting year is valid
  - Accumulate balances/budgets into appropriate arrays by year/type
- On department (or account/company) break, write out accumulated balances.

---

## 10. Called Programs

- **`RS740R`**: Used for account description lookup.
- **`RS707R`**: Used for department description lookup.

---

## 11. Comments and Norwegian Terms

- Many comments are in Norwegian:
  - *Saldo* = Balance
  - *Budsjett* = Budget
  - *Avdeling* = Department
  - *Firma* = Company
  - *Kontroll* = Control/Check
  - *Brudd* = Break (as in group break)
  - *Skirv post* = Write record

---

## 12. Legacy RPG Syntax

- Uses **fixed-format** RPG IV (ILE RPG).
- Control level indicators (`L2`, `L4`, `L6`), as old RPG read loops trigger logic at group breaks.

---

**Summary**:  
This program processes a file of account balances and budgets, groups by account and department, accumulates yearly/budget balances, and writes summary records to an output file, with descriptive text for accounts and departments looked up via external programs. It is typical for legacy financial batch processing on IBM i.