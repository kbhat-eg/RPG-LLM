# RPG Program JU505R — Detailed Explanation

This ILE RPG program is a classic green-screen application for the IBM i (AS/400), written in fixed-format RPG IV. Its main function is to display and interact with a list (subfile) of modules and their details, allowing for searching, positioning, paging, and detail viewing.

Below, we break down the code structure, major logic flows, and key variable usage for easy onboarding.

---

## Program Description & Header

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: No extra I/O debugging code generated.
- `datedit(*dmy)`: Default date format is day/month/year.

The comments describe:
- The system, program name, and purpose ("Module, List/Details").
- Modification history.
- Explanation of indicator usage (LR, function keys F10-F21, screen logic, error indicators).

---

## File Declarations

```rpg
fjmodlr    if   e           k disk    rename(jmodpfr:jmodlrr)
fjmodl1    if   e           k disk    rename(jmodpfr:jmodl1r)
fjmodl2    if   e           k disk    rename(jmodpfr:jmodl2r)
fjmodl3    if   e           k disk    rename(jmodpfr:jmodl3r)
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)

fju505d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **Database Physical Files**: Four logical views (`jmodlrr`, `jmodl1r`, `jmodl2r`, `jmodl3r`) on the *Module* file, one (`jlevl1r`) on the *Supplier* file.
- **Display File**: JU505D with subfile `b1sfl`, record number `w_srrn`.
- `infds(dspfbk)`: Get display file feedback/status.

---

## Data Declarations

### LDA (Local Data Area)
```rpg
d l_firm                944    946  0
d l_fnav                951    980
```
- Extracts company code and name from LDA.

### Display Feedback DS
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- Used to get the cursor position/record number after display operations.

### Key Variables for Chaining
```rpg
d jmodlr_modn     s                   like(jumodn)
d jmodl1_modn     s                   like(jumodn)
d jmodl2_mte1     s                   like(jumte1)
d jmodl3_ldor     s                   like(juldor)
d jlevl1_ldor     s                   like(jlldor)
```
- Variables to hold key values for file lookups and positioning.

### Working Variables (for Paging, Subfile, and More)
```rpg
d w_fcrn          s              4  0   // First record on page
d w_stel          s              4  0   // Subfile counter
d w_spge          s              4  0   // Subfile page size
d w_srrn          s              4  0   // Current subfile relative record #
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)

d w_seqe          s              1      // Subfile sequence type ('S', 'M', 'L', blank)
d b_open_sok      s              1 inz(*off) // Search open flag

d w_firm          s              3  0   // Company code
d w_ste1-5        s             35      // Search fields (1..5)
d w_ogrp_alf      s              2      // Group codes (alpha)
d w_hgrp_alf      s              2
d w_ugrp_alf      s              3

d s_stek          s             35      // Search text (input/copy)
d w_lnav          s                   like(jlnavn)
```

### Constants
```rpg
d c_sfil          s              2  0 inz(13)   // Subfile page size
```

---

## Main Program Logic (High-level Flow)

### Initialization Block (`*inzsr`)
Defines all key lists for file access, loads the company code from LDA, opens the subfile, and prepares the subfile for display.

### Main Processing Loop
1. **Show "Command" Window:** (`b2taga` tag)
    - `write b2cmd` displays command screen.
2. **Display the Subfile:** (`b2tagb` tag)
    - `exsr dsp_subfile` — shows subfile or a command screen if empty.
3. **Function/Key Handling:**
    - Function key indicators (`*inkc-`, etc.) trigger jumps to routines (exit, search, refresh, rollup/down, reposition, etc.).
    - Search or position inputs also trigger their routines.
4. **Subfile Processing:**
    - `exsr subfile` processes selections within the subfile (e.g., drill-down to details).

---

## Subroutines

### Subfile Display (`dsp_subfile`)
- If subfile has records (`w_srrn <> 0`), shows it; otherwise, shows command panel.
- Handles display indicators and sets `w_fcrn` to current record.

### Subfile Handling (`subfile`)
- Loops through subfile records using `readc`.
- Based on a subfile option (`b1valg`), calls external programs for detailed actions (details, items, keywords, notes, standards).
- Resets the selection after processing.

### Search (`søk`)
- Sets mode to search, opens search SQL cursor.
- Calls an auxiliary program (`AS701R`) to parse search text into searchable fields (`w_ste1-5`).
- Clears subfile and refills it with the search result.

### Positioning (`posisjoner`)
- Determines where to position the list based on inputs (by text, module, or supplier).
- Positions with appropriate key and refills the subfile.

### Clear Subfile (`clr_subfile`)
- Sets indicators to clear subfile and resets counters.

### Create/Fill Subfile (`crt_subfile`)
- Determines end record for the page.
- Fills the subfile with records from SQL (if searching) or logical file.
- Sets up data fields, does file lookups for supplementary info (such as supplier names).
- Assembles group codes as a display string.
- Updates internal paging variables.

### Page Backwards (`bck_subfile`)
- Handles backward paging logic for the subfile.
- Reads back a page worth of records and refills.

### Query/Inquiry (`spørring`)
- For specific fields, launches lookup/inquiry routines (e.g., supplier lookup).

---

## SQL Integration

- Uses embedded SQL for searches in subfile creation, with dynamically built LIKE clauses using up to 5 search terms.
- Handles OS/400 SQL peculiarities (see comments near SQL).

---

## Key Concepts/Variables

- **Indicator Variables**: Many operations depend on classic RPG indicators for function keys and screen control.
- **Paging Variables**: `w_srrn`, `w_spge`, `w_ssrn` manage subfile paging.
- **Search/Position**: Subfile can be “refreshed” by search or by jumping to specific descriptions, modules, or supplier.
- **Subfile**: A screen list—user can scroll, search, and select options for records.
- **Command Keys**: F-keys mapped to navigation, search, query, refresh, etc.
- **Drill-down**: External RPG programs called for detail display.

---

## External Dependencies

- **Display File:** `JU505D`, with subfile `b1sfl`.
- **Programs:** Calls to several other RPG programs (e.g., `JU501R`, `JU520R`, `JV530R`) for details or maintenance.
- **LDA:** Picks up company context.
- **Files:** Multiple logical views of module and supplier files.

---

## Typical User Flow

1. User sees either a list ("subfile") of modules or a command screen.
2. User can page up/down, search, or jump to a position in the list.
3. User can select a record to view details (or related options such as items, keywords, free text, standards).
4. Program dynamically fills and manages the subfile as needed.
5. Exit via function keys.

---

## Key Points for New Developers

- **Classic Indicator-driven RPG**: Understanding indicator usage is crucial (mapped in comments).
- **Subfile Management**: The program focuses on efficiently refilling and displaying subfile lists based on user actions.
- **SQL Search**: When searching, the program uses embedded SQL; otherwise, it uses native logical file reads.
- **User Interaction**: All user input is via the green-screen interface, using function keys.
- **Integration**: Relies on several external programs for detailed functions.

---

## Summary Table

| Routine        | Purpose                            |
|----------------|------------------------------------|
| *INZSR         | Initialization                     |
| forny          | Refresh subfile from current pos.  |
| søk            | Search subfile                     |
| posisjoner     | Position within subfile            |
| clr_subfile    | Clear subfile contents             |
| crt_subfile    | Fill subfile                       |
| bck_subfile    | Page backward in subfile           |
| dsp_subfile    | Present subfile or command screen  |
| subfile        | Process subfile selects            |
| spørring       | Inquiry (field-specific)           |

---

This code is a robust and classic example of IBM i (AS/400) green-screen subfile programming with search, drill-down, and navigation. It is highly modular, and each subroutine is responsible for a clear part of the workflow. Most logic pivots on RPG indicators and the state of subfile variables. Familiarity with subfile management, indicator handling, and classic RPG syntax will help you onboard to this program quickly.