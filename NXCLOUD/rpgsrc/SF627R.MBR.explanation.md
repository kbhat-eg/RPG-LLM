# Documentation: SF627R – Sales Statistics Report

## Overview

**Program:** SF627R  
**System:** ASSTAT  
**Purpose:**  
This program generates a detailed sales statistics report, aggregating and comparing sales, discounts, and contribution margins at various business hierarchy levels. It supports breakdowns by customer, product, category, region, and other business-specific groupings, and allows for comparison against previous year and budget figures.

## High-Level Structure

- **File Declarations:**  
  Many physical and logical files are declared, representing customers, products, budgets, categories, and more. Some files are renamed for clarity or to match logical views.

- **Data Structures:**  
  Several data structures and arrays are used to manage grouping, keys, and intermediate calculations.

- **Level Break Logic:**  
  The code uses multi-level break (brudd) logic to aggregate data at different hierarchy levels (e.g., product group, customer category, company).

- **Calculation Routines:**  
  Performs period and year-to-date calculations, computes variances vs. budget and previous year, and prepares data for output.

- **Report Output:**  
  Writes to a printer file, with overflow and heading management.

## Business/Domain-Specific Logic

- **Sales Statistics:**  
  The core function is to calculate net sales, discounts, and contribution margins for various periods (current period, year-to-date, previous year, budget).

- **Hierarchical Aggregation:**  
  Data is grouped and subtotaled at multiple business levels:
    - SRT1 (Level 6): Highest grouping (e.g., product group, customer segment)
    - SRT2 (Level 5): Subgroup
    - SRT3 (Level 4): Sub-subgroup
    - L7: Company total

- **Comparison Modes:**  
  The report can compare actuals to either budget ("B") or previous year ("F"), controlled by the `w_smli` field.

- **Dynamic Key Construction:**  
  Keys for budget and lookup files are dynamically constructed based on the selected grouping/sorting criteria.

## File Relationships

- **Main Input:**  
  - `skwwpf`: Likely the main sales statistics file.
  - `skbul1`: Budget register.

- **Reference/Lookup Files:**  
  - `skpml1`: Parameter file (report parameters).
  - `rkunl1`: Customer master.
  - `rlevl1`: Supplier master.
  - `vvarl1`, `vvasl1`: Product master and auxiliary product info.
  - `vahgl1`, `vaugl1`, `vogrl1`, `vhgrl1`, `vugrl1`: Product groupings (main, sub, over-group, etc.).
  - `ra06pf`, `ra07pf`, `ra08pf`, `ra09l1`, `ra10pf`, `ra11pf`, `ra12pf`: Various code tables (discount, division, district, sales rep, warehouse, customer category, country).
  - `fkprl1`: Customer project.

- **Output:**  
  - `sf627p`: Printer file for report output.

## Key Variables and Data Structures

- **Grouping Arrays:**  
  - `sal(12)`: Holds amounts for each of 12 periods (months).
  - `rt(60)`: Report text labels for headings and grouping descriptions.

- **Work Structures:**  
  - `w_rest`: Holds parameter/criteria data from the parameter file.
  - `w_xgrp`, `w_xogr`, `w_xhgr`, `w_xugr`: Used for extracting parts of product group codes.
  - `wxkode`: Holds codes for budget key construction, with subfields for each grouping.

- **Subtotal Fields:**  
  For each breakdown level (4–7), the following are tracked:
    - `bnpi*`: Net sales this period, current year.
    - `bnpf*`: Net sales this period, previous year.
    - `bnpb*`: Net sales this period, budget.
    - `bnii*`: Net sales YTD, current year.
    - `bnif*`: Net sales YTD, previous year.
    - `bnib*`: Net sales YTD, budget.

- **Calculated Fields:**  
  - `w_rab`: Total discounts.
  - `w_net`: Net sales after discount.
  - `w_bid`: Contribution margin (net - cost).
  - `wbapfu`, `wbapbu`, `wbaifu`, `wbaibu`: Percentage variances for period and YTD vs. previous year and budget.

## Processing Logic

### Initialization

- Loads report parameters and criteria from the parameter file.
- Sets up grouping/sorting fields and report texts.
- Determines comparison mode (budget or previous year).
- Prepares keys for all reference and lookup files.

### Main Loop and Aggregation

- For each record, determines the appropriate grouping (SRT1/SRT2/SRT3).
- On a break at any grouping level, subtotals are rolled up to the next level and printed.
- For each record:
    - Discounts are summed.
    - Net sales and contribution margin are calculated.
    - Period and YTD totals are updated for current year, previous year, and budget, depending on the comparison mode.
    - If budget comparison is enabled, budget values are fetched and aggregated.

### Subroutines

- **L4brd, L5brd, L6brd, L7brd:**  
  Handle subtotal roll-up and output for each grouping level. Move subtotal values to output fields and trigger calculation of variances.

- **beregn:**  
  Calculates percentage variances for actual vs. previous year and budget, both for the current period and YTD.

- **raprut:**  
  Retrieves the appropriate description text for each grouping key, using the relevant reference file. Handles all possible groupings (product groups, customer categories, order types, etc.).

- **budsjett:**  
  Constructs the budget key dynamically based on the grouping, fetches budget values, and aggregates them for the current period and YTD.

- **hntwxk:**  
  Sets up the budget key code fields (`wxkode_*`) based on which groupings are active, so the correct budget record can be retrieved.

- **overflow:**  
  Handles printer file overflow, writing the heading as needed.

### Reporting

- Writes subtotals and headings to the printer file at each level break.
- Manages overflow by reprinting the heading when needed.
- Output includes group descriptions as retrieved from the lookup tables.

## Design Patterns and Conventions

- **Level Break Processing:**  
  Uses RPG's level break indicators (L4, L5, L6, L7) to manage hierarchical subtotaling and output.

- **Dynamic Key Construction:**  
  The dynamic assignment of grouping codes to budget lookup keys is a key feature, allowing the report to adapt to different grouping/sorting configurations.

- **Lookup with Fallback:**  
  When retrieving group descriptions, the code attempts primary and then fallback files (e.g., for product descriptions, if not found in the main file, tries an auxiliary file).

- **Business Field Naming:**  
  Field names encode their business meaning (e.g., `bnpi4` = "brutto netto period i år, level 4"), and comments clarify the naming conventions.

## Noteworthy Implementation Details

- **Extensive Use of Data Structures:**  
  Overlays and subfields are used to extract keys and codes from grouping fields, supporting flexible grouping and key construction.

- **Parameterization:**  
  Report criteria and grouping options are read from a parameter file, supporting a wide range of report configurations.

- **Multi-File Integration:**  
  The program ties together data from many master and code tables, reflecting a complex business domain.

- **Scandinavian/Norwegian Field Names:**  
  Many fields and comments are in Norwegian; new developers should familiarize themselves with key business terms.

- **Legacy RPG III/IV Style:**  
  The program uses fixed-format RPG with indicators and operation codes; understanding the indicator logic is essential for maintenance.

## Integration Points

- **Input Data:**  
  Sales and budget data from core operational files.

- **Reference Data:**  
  Product, customer, group, and code tables for enrichment and validation.

- **Output:**  
  Printer file, formatted for business reporting.

## Maintenance Notes

- **Adding New Groupings:**  
  To support new report groupings, extend the relevant arrays, lookup logic, and key construction routines.

- **Changing Business Logic:**  
  Adjust field calculations and level break logic in the relevant subroutines.

- **File Structure Changes:**  
  If master/reference file layouts change, update the relevant data structures and key lists.

## Summary Table: Grouping Codes and Descriptions

| Code | Grouping/Description        | Lookup File(s)    |
|------|----------------------------|-------------------|
| 11   | Alt. hovedgruppe           | vahgl1            |
| 12   | Alt. undergruppe           | vaugl1            |
| 13   | Rabattgruppe               | (removed)         |
| 14   | Overgruppe                 | vogrl1            |
| 15   | Hovedgruppe                | vhgrl1            |
| 16   | Undergruppe                | vugrl1            |
| 21   | Kundekategori              | ra11pf            |
| 22   | Rabattkategori             | ra06pf            |
| 23   | Distrikt                   | ra08pf            |
| 24   | Selger ordre               | ra09l1            |
| 25   | Land                       | ra12pf            |
| 27   | Selger kasse               | ra09l1            |
| 31   | Varenummer                 | vvarl1/vvasl1     |
| 32   | Kunde                      | rkunl1            |
| 33   | Kundeprosjekt              | fkprl1            |
| 42   | Faktnr/Krednr              | -                 |
| 43   | Fakturadato                | -                 |
| 51   | Ordretype                  | votyl1            |
| 52   | Avdeling                   | ra07pf            |
| 53   | Lager                      | ra10pf            |
| 54   | Produktansvarlig           | -                 |
| 55   | Leveringstype              | vltpl1            |
| 56   | Leverandør                 | rlevl1            |

## Conclusion

This program is a central reporting tool for sales statistics, supporting highly flexible and detailed breakdowns according to business needs. It is tightly coupled to the company's data model and code tables, and its logic is driven by parameter files and grouping codes. New developers should pay close attention to the grouping logic, key construction for lookups, and the conventions used for subtotaling and output.