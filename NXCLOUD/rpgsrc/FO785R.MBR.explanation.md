# Program Overview

This RPG IV (ILE RPG) program (named **FO785R**) processes order headers to count the number of offers that need follow-up. The program is designed for the IBM i (AS/400) platform and interacts with three physical files: `FOHEL9`, `FUSRL1`, and `VOTYL1`. It also retrieves some information from the local data area (LDA).

---

## Structure and Logic

### Control Options (`H-spec`)
```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: Disables debug support for database I/O.
- `*DMY`: Date editing uses day/month/year sequence.

---

### File Declarations (`F-spec`)
```rpg
ffohel9    if   e           k disk    rename(fohepfr:fohel9r)
ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
```
- Declares three keyed, externally-described files, each renamed for use in this program.
  - `fohel9` (orders)
  - `fusrl1` (user info)
  - `votyl1` (order types)

---

### Data Definitions (`D-spec`)
#### Parameter and LDA fields
```rpg
d p_anta          s              6  0
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- `p_anta`: Output parameter, number of offers to follow up.
- `uds`: Declares use of LDA (Local Data Area).
- `l_user`, `l_firm`: Extracts User (positions 911-920) and Firm (944-946) from LDA.

#### Key Fields and Variables
```rpg
d fohel9_selg     s                   like(foselg)
d fusrl1_user     s                   like(fbuser)
d votyl1_otyp     s                   like(vaotyp)
d w_firm          s                   like(fofirm)
```
- `fohel9_selg`: Seller number for order header key.
- `fusrl1_user`: User for user info file key.
- `votyl1_otyp`: Order type for order type file key.
- `w_firm`: Firm number.

---

### Main Program Logic (`C-spec`)

1. **Exit if No User in LDA**
    ```rpg
    c                   if        l_user = *blank
    c                   goto      avslutt
    c                   endif
    ```
    - If no user ID is found in LDA, exit program.

2. **Initialize Output Parameter**
    ```rpg
    c                   eval      p_anta = 0
    ```
    - Set the output count (number of offers) to 0.

3. **Retrieve Seller Number for User**
    ```rpg
    c                   eval      fusrl1_user = l_user
    c     fusrl1_key    chain     fusrl1
    c                   if        not %found or
    c                             fbselg = 0
    c                   goto      avslutt
    c                   endif
    ```
    - Set up the user key, retrieve user record (`chain`), and check for seller number (`fbselg`). If not found or seller number is 0, exit.

4. **Loop Through Orders for Seller**
    ```rpg
    c                   eval      fohel9_selg = fbselg
    c     fohel9_key    setll     fohel9
    c     fohel9_key    reade     fohel9
    c                   dow       not %eof
    ```
    - Set up order header key for seller, start reading all order header records for this seller.

5. **For Each Order: Look Up Type and Apply Criteria**
    ```rpg
    c                   eval      votyl1_otyp = footyp
    c     votyl1_key    chain     votyl1r
    c                   if        %found and
    c                             vaoakk = 0
    c                   if        foddat <= %date
    c***                if        fotdat = *loval or
    c***                          fotdat >  %date
    c                   eval      p_anta = p_anta + 1
    c***                endif
    c                   endif
    c                   endif
    ```
    - For the current order:
        - Look up order type.
        - If found and "not acknowledged" (`vaoakk = 0`).
        - If "follow-up date" (`foddat`) has passed.
        - **NOTE:** Test for "offer not expired" is commented out.
        - If all criteria match: increment counter (`p_anta`).

6. **End Loop**
    ```rpg
    c     fohel9_key    reade     fohel9
    c                   enddo
    ```

7. **Exit and Cleanup**
    ```rpg
    c     avslutt       tag
    c                   eval      *inlr = *on
    c                   return
    ```

---

### Initialization Subroutine (`*INZSR`)
```rpg
c     *inzsr        begsr
      ...
c     *entry        plist
c                   parm                    p_anta
      ...
c     fohel9_key    klist
c                   kfld                    w_firm
c                   kfld                    fohel9_selg
      ...
c                   eval      w_firm = l_firm
c                   endsr
```
- Handles parameter passing.
- Defines key lists for file access (order header, user, order type).
- Reads the firm number from LDA to `w_firm` for use in file keys.

---

## Summary Flow

1. On program start, it pulls the necessary user and firm info from LDA.
2. It checks if the user is present; if not, it exits.
3. It initializes the output parameter.
4. It finds the seller number for the user from the user file.
5. It loops through all orders for that seller, and for each order:
    - Validates order type and "not acknowledged" status.
    - Checks if the follow-up date is passed.
    - (Optionally: would check if not expired, but this is commented out.)
    - Increments the count if all criteria are met.
6. Sets the output parameter and exits.

---

## Key Points for Onboarding

- **File Access**: The program uses three files and retrieves data using keyed access (`chain`, `setll`, `reade`).
- **User and Firm Context**: Reads user and firm identifiers from the Local Data Area.
- **Parameter Passing**: Uses the parameter list (`plist`, `parm`) to support modular/reusable program calls.
- **Business Logic**: Designed to count "offers to follow up" for a seller, based on specific date/status criteria.
- **Date Handling**: Makes use of the `%date` built-in function for current date comparison.
- **Extendability**: The commented out expiration date logic (`fotdat`) can be reactivated to refine offer selection.

---

## Comments

- **Variables** like `fbselg`, `footyp`, `vaoakk`, `foddat`, `fotdat` correspond to fields in the respective files. Check their definitions in the file DDS for precise meaning.
- **LDA Usage**: The program expects LDA to be loaded with needed values prior to program call.
- **Error Handling**: Minimal; exits quietly if any criteria are not met.
- **Language**: Some variable/field/section names are in Norwegian (e.g., "selger", "tilbud", "oppfÃ¸lging", "ordre-hode").

---

> This program is a typical example of an IBM i/AS400 batch processing program that filters and counts records based on business rules, with modular design for easy integration.