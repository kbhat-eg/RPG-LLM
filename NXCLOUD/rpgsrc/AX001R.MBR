     h datedit(*dmy) option(*nodebugio)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  System. . . . . :
      *  Program . . . . : AX001R
      *  Beskrivelse . . : HEADER    Legger ut XML til SAF-T
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Spesialversjon. :
      *  Tilpasset for . :
      *
Versj *Uts   Dato Usr Referanse Beskrivelse
      *____________________________________________________________________________________________
      *K00-200420               START FOR VERSJON K00
7.00  *K00 200420 SST NXS-4426  Utrulling av SAFT-Rapporter til alle kundene
      *
      *
      *
      *____________________________________________________________________________________________
      *
      *
      *  Dette programmet henter data fra ADBxxx/AFIRPF m/AAFFIR = Firma
      *
      *
     f*amill1    if   e           k disk        rename(amilpfr:amill1r)
     fafirpf    if   e           k disk        rename(afirpfr:afirl1r)
      *
     frxmml1    if   e           k disk        rename(rxmmpfr:rxmml1r)
     frxmll1    if   e           k disk        rename(rxmlpfr:rxmll1r)
      *
     faxmlut    o    e             disk
      *
      *
     d*amill1_milj     s                       like(armilj)
      *
     d rxmml1_firm     s                       like(xmfirm)
      *
     d rxmll1_head     s                       like(axhead)
     d rxmll1_linj     s                       like(axlinj)
      *
     d w_firm          s              3A
     d text            s             50
     d txt2            s             50
     d stmt            s            512A
     d xmlut           s            512A
     d i               s              9S 0
     d j               s              9S 0
     d f               s              3
     d t               s              3
     d fn              s              3S 0
     d tn              s              3S 0
     d w_iso_dat       s               d   datfmt(*iso)
     d w_x_dat         s             10A
      *
     d w_str_i         s            500
     d w_str_u         s            500
     d w_posi          s              2  0
     d w_posu          s              2  0
     d w_str_x         s              1
     d w_lr            s              1
      *
      *  Konstanter
      *
     d c_apos          c                   x'7D'
     d p_perfm         s              2
     d p_perfa         s              4
     d p_pertm         s              2
     d p_perta         s              4
     d p_hcom          s             50
      *
      *
     d                uds
     d l_firm                944    946  0
     d l_user                911    920
     d l_milj               1003   1005
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Start
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     start         tag
     c                   read      rxmll1
     c                   if        not %eof(rxmll1) and
     c                             axhead = 'HEADER'
      *
      *   Hopper over 2 første linjer og siste
      *
     c                   if        axlinj = 5
     c                   goto      lesnext
     c                   endif
     c                   if        axlinj = 6
     c                   goto      lesnext
     c                   endif
     c                   if        axlinj = 99000
     c                   goto      lesnext
     c                   endif
      *
      *  Hvis type er merket med 'X' er ikke denne linja klargjort enda
      *
     c                   if        axtype = 'X'
     c                   goto      lesnext
     c                   endif
      *
     c                   eval      text = *blank
      *
     c                   eval      i = %scan('?V?':axxmlt)
     c                   if        i > 0
      *
      *  Dagens dato hentes dersom axtype = 'C' (current)
      *
     c                   if        axtype = 'C'
     c     *dmy          move      udate         w_iso_dat
     c                   move      w_iso_dat     w_x_dat
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(w_x_dat) +
     c                             %subst(axxmlt:i+3:50)
     c                   goto      next
     c                   endif
      *
      *  Hente felt fra kunde
      *
     c                   if        axfelt <> *blank
     c                             and axregi <> *blank
      *
     c                   eval      stmt = 'select ' + axfelt +
     c                             ' from ' + axregi + ' where +
     c                             aaffir = ' + w_firm
     c/exec sql
     c+ prepare S1 from :stmt
     c/end-exec
      *
     c/exec sql
     c+ declare c1 cursor for s1
     c/end-exec
      *
     c/exec sql
     c+ open c1
     c/end-exec
      *
     c/exec sql
     c+ fetch c1 into :text
     c/end-exec
      *
     c/exec sql
     c+ close c1
     c/end-exec
      *
     c                   endif
      *
      *  Hente inn tekst felt
      *
     c                   if        axtype = 'T'
     c                   if        text = *blank
     c                   select
     c                   when      axfelt = 'VERSJON'
      *
     c                   call      'GETVERSJOF'
     c                   call      'GETVERSJON'
     c                   parm                    text
     c*                  movel     l_milj        amill1_milj
     c*    amill1_key    chain     amill1
     c*                  movel     arvers        text
      *
     c                   when      axfelt = 'XMFNAV'
     c                   movel     xmfnav        text
     c                   exsr      sjk_xml_esc
     c                   when      axfelt = 'XMENAV'
     c                   movel     xmenav        text
     c                   exsr      sjk_xml_esc
     c                   when      axfelt = 'XMREGI'
     c                   movel     xmregi        text
      *
     c                   exsr      sjk_xml_esc
     c                   when      axfelt = 'XMTELE'
     c                   movel     xmtele        text
     c                   when      axfelt = 'XMMOBI'
     c                   movel     xmmobi        text
     c                   when      axfelt = 'XMEMAL'
     c                   movel     xmemal        text
     c                   endsl
     c                   endif
     c                   eval      text = text
      *
     c                   if        %subst(axfast:1:1) = '('
     c                   eval      j = %scan(',':axfast)
     c                   if        j > 0
     c                   eval      f = %subst(axfast:2:3)
     c                   eval      t = %subst(axfast:6:3)
     c                   move      f             fn
     c                   move      t             tn
     c                   eval      txt2 = %subst(text:fn:tn-fn+1)
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(txt2) +
     c                             %subst(axxmlt:i+3:50)
     c                   goto      next
     c                   endif
     c                   endif
      *
     c                   exsr      sjk_xml_esc
      *
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(text) +
     c                             %subst(axxmlt:i+3:50)
     c                   endif
      *
      *  Hente inn numerisk felt
      *
     c                   if        axtype = 'N'
     c                   eval      text = text
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(text) +
     c                             %subst(axxmlt:i+3:50)
     c                   endif
      *
      *  Hente inn dato felt
      *
     c                   if        axtype = 'D'
      *
     c                   eval      w_x_dat = text
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(w_x_dat) +
     c                             %subst(axxmlt:i+3:50)
     c                   endif
      *
      *  Hente inn parameter via p_xxxxx felt fra axfelt
      *
     c                   if        axtype = 'P'
     c                   eval      text = *blank
     c                   select
     c                   when      axfelt = 'P_PERFM'
     c                   movel     p_perfm       text
     c                   when      axfelt = 'P_PERFA'
     c                   movel     p_perfa       text
     c                   when      axfelt = 'P_PERTM'
     c                   movel     p_pertm       text
     c                   when      axfelt = 'P_PERTA'
     c                   movel     p_perta       text
     c                   when      axfelt = 'P_HCOM'
     c                   movel     p_hcom        text
     c                   when      axfelt = 'L_USER'
     c                   movel     l_user        text
     c                   endsl
      *
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(text) +
     c                             %subst(axxmlt:i+3:50)
     c                   endif
      *
     c                   eval      text = *blank
      *
     c                   goto      next
      *  END ?V?
     c                   endif
      *
      *  Sjekk om faste felter skal legges ut
      *
     c                   eval      i = %scan('?F?':axxmlt)
     c                   if        i > 0
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(axfast) +
     c                             %subst(axxmlt:i+3:50)
     c                   goto      next
     c                   endif
      *
      *  Sjekk om bare xml linja skal ut
      *
     c                   if        axtype = 'F'
     c                   eval      xmlrec = axxmlt
     c                   goto      next
     c                   endif
      *
      *  Sjekk xml linja skal ut med parameter
      *
     c                   if        axtype = 'F'
     c                   eval      xmlrec = %subst(axxmlt:1:i-1) +
     c                             %trim(axfast) +
     c                             %subst(axxmlt:i+3:50)
     c                   goto      next
     c                   endif
      *
     c     next          tag
      *
     c                   write     axmlutr
      *
     c     lesnext       tag
     c                   goto      start
      *
     c                   endif
      *
     c                   eval      *inlr = *on
     c                   return
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for kontroll/erstatning av XML-escape tegn i tekstfel
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     sjk_XML_esc   begsr
      *
     c                   eval      w_posi = 0
     c                   eval      w_posu = 0
     c                   eval      w_str_u = *blank
     c                   eval      w_str_i = text
      *
     c                   dow       w_posi < 400
     c                   eval      w_posi = w_posi + 1
     c                   if        %subst(w_str_i:w_posi:499-w_posi) = ' '
     c                   leave
     c                   endif
     c                   eval      w_str_x = %subst(w_str_i:w_posi:1)
     c                   if        w_posu < 450
     c                   select
     c                   when      w_str_x = '&'
     c                   eval      w_posu = w_posu + 1
     c                   eval      %subst(w_str_u:w_posu:5) = '&amp;'
     c                   eval      w_posu = w_posu + 4
      *
     c                   when      w_str_x = '<'
     c                   eval      w_posu = w_posu + 1
     c                   eval      %subst(w_str_u:w_posu:4) = '&lt;'
     c                   eval      w_posu = w_posu + 3
      *
     c                   when      w_str_x = '>'
     c                   eval      w_posu = w_posu + 1
     c                   eval      %subst(w_str_u:w_posu:4) = '&gt;'
     c                   eval      w_posu = w_posu + 3
      *
     c                   when      w_str_x = c_apos
     c                   eval      w_posu = w_posu + 1
     c                   eval      %subst(w_str_u:w_posu:6) = '&apos;'
     c                   eval      w_posu = w_posu + 5
      *
     c                   when      w_str_x = '"'
     c                   eval      w_posu = w_posu + 1
     c                   eval      %subst(w_str_u:w_posu:6) = '&quot;'
     c                   eval      w_posu = w_posu + 5
      *
     c                   other
     c                   eval      w_posu = w_posu + 1
     c                   eval      %subst(w_str_u:w_posu:1) = w_str_x
      *
     c                   endsl
     c                   endif
     c                   enddo
     c                   eval      text = %trim(w_str_u)
     c*    'å':'a'       xlate     text          text
     c*    'Å':'A'       xlate     text          text
     c*    'æ':'e'       xlate     text          text
     c*    'Æ':'E'       xlate     text          text
     c*    'ø':'o'       xlate     text          text
     c*    'Ø':'O'       xlate     text          text
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     *inzsr        begsr
      *
     c**   amill1_key    klist
     c**                 kfld                    amill1_milj
      *
     c     rxmll1_key    klist
     c                   kfld                    rxmll1_head
     c                   kfld                    rxmll1_linj
      *
     c     rxmml1_key    klist
     c                   kfld                    rxmml1_firm
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter verdier fra LDA / Legger inn verdier i felter
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     *dtaara       define                  ax000par        100
     c     *lock         in        *dtaara
     c                   eval      p_perfm = %subst(ax000par:1:2)
     c                   eval      p_perfa = %subst(ax000par:3:4)
     c                   eval      p_pertm = %subst(ax000par:7:2)
     c                   eval      p_perta = %subst(ax000par:9:4)
     c                   eval      p_hcom  = %subst(ax000par:13:50)
      *
      *
     c                   eval      rxmll1_head = 'HEADER'
     c                   eval      rxmll1_linj = *zero
     c     rxmll1_key    setll     rxmll1
      *
     c                   move      l_firm        w_firm
     c                   move      l_firm        rxmml1_firm
     c     rxmml1_key    chain     rxmml1
      *
     c                   endsr
