# RPG Program Explanation: JP100R (Vedlikehold av betingelser, param)

This ILE RPG program (JP100R) is designed to maintain and display vendor-related conditions, using interactive subfiles. The application lets a user select vendors from a list (subfile), search by name or number, and drill down to view or update conditions and freight terms. It is written using traditional (fixed-format) RPG IV, with embedded SQL and subfile techniques.

Below is a structured explanation for onboarding developers.

---

## High-Level Flow

1. **Initialization**
   - Initialize keys, read company info from LDA, position files, and load the subfile.

2. **Main Processing Loop**
   - Display subfile and handle user input (function keys).
   - User can roll pages, search for vendors, position to a vendor by name/number, or launch maintenance routines for selected records.

3. **Subroutines**
   - `forny`: Refresh subfile after actions.
   - `søk`: Search vendors by entered text.
   - `posisjoner`: Position to vendor by name/number.
   - `subfile`: Handle subfile record-level processing (drill-down).
   - `clr_subfile`: Clear out subfile.
   - `crt_subfile`: Create/fill subfile from file/SQL.
   - `bck_subfile`: Page back in subfile.
   - `dsp_subfile`: Display the subfile/control screen.

---

## Key Concepts

### 1. Files & Data Structures

- **Physical Files**
  - `jlevl1`, `jlevl2`: Vendor master files.
  - `jbetl1`: Vendor conditions file.
  - `jfbel1`: Freight conditions file.

- **Display File**
  - `jpj100d`: Workstation file, subfile-enabled, with indicators for subfile feedback and control.

- **Data Structures**
  - `dspfbk`: For display feedback (DS).
  - LDA fields: Contains user, firm, etc.

---

### 2. Indicators Explained

The program uses numeric screen indicators. For example:
- `*IN12`, `*IN13`, `*IN14`, `*IN15`, etc. for subfile controls.
- `*IN22`: Cursor placement.
- `*IN16`: End of subfile (READC).

---

### 3. Subfile Handling

#### Subfile Variables

- `w_fcrn`: First record number on page.
- `w_stel`: Subfile record counter.
- `w_srrn`: Relative record number.
- `w_spge`: Subfile page size.
- `w_ssrn`: Last subfile record number.

#### Subfile Operations

- **Display**: `dsp_subfile` shows subfile page.
- **Clear**: `clr_subfile` clears out subfile area.
- **Create/Refill**: `crt_subfile` loads records from DB (with paging/search).
- **Back**: `bck_subfile` pages back through data.

---

### 4. Main Program Steps

#### Initialization (`*INZSR`)
- Sets up keys/lists for positioning (name, vendor no, conditions).
- Retrieves firm from LDA.
- Positions to start of file by name.
- Triggers loading the subfile with vendor data.

#### Main Loop
1. **Show screen** via `dsp_subfile`.
2. **Process Function Keys**:
   - F3/F12: Exit (goto `avslutt`)
   - F9: Repeat search
   - F10/F11: Create/refresh or back page
   - Name/number: Positioning
   - Option fields: Drill-down

#### Subfile Record Processing (`subfile`)
- Reads user-chosen option per record (opt 7: conditions, opt 9: freight).
- Executes maintenance program as needed.
- If updates happened, refresh subfile.

#### Search (`søk`)
- Calls program (`AS701R`) to parse/search string into up to 5 components.
- Prepares search keys.
- SQL cursor declared to search across vendor name and address fields (using UPPER and LIKE with wildcards).

#### Position to (`posisjoner`)
- By name or vendor number.
- Repositions corresponding file.
- Rebuilds subfile to show positioned record.

#### Subfile Build (`crt_subfile`)
- Pages through file or SQL search result.
- Fills subfile screen with structured data.
- Marks existing conditions or freight flags (via lookups to `jbetl1`, `jfbel1`).

#### Clear Subfile (`clr_subfile`)
- Sets subfile clear indicator and writes blank subfile.

---

### 5. Embedded SQL

- Used for search/filter when the user enters specific search text.
- The SQL cursor (`sok`) concatenates several vendor fields, performs a multi-key LIKE search (up to 5 search fragments).
- Orders by name and number for consistent display.

---

### 6. Drill-down

- **Option 7**: Calls program `JP102R` for vendor conditions.
- **Option 9**: Calls program `JP120R` for freight conditions.
- Both pass the company and vendor number as parameters.
- After update, subfile can be refreshed (if changes were made).

---

### 7. Program Exit (`avslutt`)
- Sets `*INLR` (last record indicator) to terminate the program cleanly.

---

## Notable Coding Patterns

- **Setll/Read/Chain**: Used for DB positioning (by keys) and record fetches.
- **Indicators**: Classic RPG subfile/screen handling using indicators for state.
- **Tag/Goto/Select**: Main loop and routing is structured using tags and `goto` for classic RPG state transitions.
- **Parameter Passing**: External program calls use `parm` for simple data exchange.

---

## Summary Table

| Subroutine          | Purpose                                                                                      |
|---------------------|---------------------------------------------------------------------------------------------|
| `forny`             | Refreshes subfile, positions DB, clears and refills subfile.                                |
| `søk`               | Prepares and performs search, clears and refills subfile with SQL-based search results.      |
| `posisjoner`        | Positions to a vendor by name or number, then refreshes subfile.                            |
| `subfile`           | Handles per-record drill-down in subfile (e.g., edit conditions or freight terms).          |
| `clr_subfile`       | Clears out subfile on screen.                                                               |
| `crt_subfile`       | Loads/populates subfile with data from file or SQL cursor (supports paging/search).         |
| `bck_subfile`       | Handles paging backward through subfile data.                                               |
| `dsp_subfile`       | Displays the subfile screen and processes user input.                                       |

---

## Final Notes

- Expect significant use of DDS display files for subfile screens.
- The code is a good example of classic green-screen RPG programming, with modern SQL search features.
- Understanding the interplay between indicators, subfile record/page counters, and DB positioning is crucial for extending or maintaining the program.

---

If you have a specific area you want to deep-dive (e.g., SQL search logic, subfile mechanics, or external program calls), ask for more details!