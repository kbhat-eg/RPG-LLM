# RPG Source Code Explanation for Program GL405R

This program is written in the IBM ILE RPG (Report Program Generator) language, designed for use on IBM i (AS/400) systems. The program’s primary purpose is to copy company (firma) data across a set of defined files, preparing data for a new or different company number, often as part of a company copy or cleanup operation.

Below is a detailed walkthrough of the code structure and logic:

---

## 1. **Header and Metadata**

The header section (`/TITLE`, `h option(*nodebugio)`, and comments) provides the following information:
- **System/Program:** ASTELE / GL405R
- **Description:** Copy company (Kopiere firma)
- **History:** Lists creation and modifications, including bug fixes and file additions.
- **Option:** `*NODEBUGIO` disables debug I/O for performance.

---

## 2. **File Declarations**

Each file is declared with an `f` specification. Files are often declared twice (input and output), sometimes with a renaming. The key features:
- **`if`**: Input file
- **`o`**: Output file
- **`e`**: External description
- **`k`**: Keyed access
- **`disk`**: Disk file

**Example:**
```rpg
fgfaspf    if   e           k disk    rename(gfaspfr:gfaspfr)
fgfaslu    o    e           k disk    rename(gfaspfr:gfaslur)
```
Here, the file `gfaspfr` is used for both input and output, but the output is renamed as `gfaslur`.

---

## 3. **Data Definitions (`d-spec`)**

- **UDS (User Defined Structure):** Used for data overlays on input records, for easy field extraction. 
- **Fields like `l_user`, `l_firm`, `l_navn`** are mapped to specific positions in the record buffer.
- **`w_firm`**: Most important variable; holds the target company number for the copy operation.

---

## 4. **Main Copy Loops (C-Specs)**

The business logic is implemented as a sequence of virtually identical loops:
- **Set Key List (`setll`)**: Positions the file cursor at the beginning of the records with the relevant key (usually `l_firm`—the company number being copied).
- **Read Equal (`reade`)**: Reads the next record matching the key.
- **Copy Loop (`dow`)**: While a matching record is found, change the company number to the new value (`w_firm`) and write it out to the output file.
- **Write Output (`write`)**: Records are written to the output file, usually with the company number changed.

**General Pattern Example:**
```rpg
c     gfaspf_key    setll     gfaspf
c     gfaspf_key    reade     gfaspf
c                   dow       *in90 = *off
c                   eval      geffir = w_firm
c                   write     gfaslur
c     gfaspf_key    reade     gfaspf
c                   enddo
```
Here, all records for the old company are read from `gfaspf`, the company number is updated, and then written to `gfaslur`.

**Commented-Out Code:** Some sections for certain files (e.g., “Feilretur”) are commented out, either because those files are not needed or not available.

---

## 5. **End of Program**

At the conclusion of all processing:
- The special indicator `*INLR` (Last Record) is set to `*ON`, which signals the program will end and releases resources.
- `return` completes the program.

---

## 6. **Initialization Subroutine (`*inzsr`)**

- The initialization routine handles setting up program variables, particularly handling the input parameter (`w_firm`)—the new company code.
- Key lists for all files are defined here, relating the key for each file to `l_firm`, which is the company number being copied from.

**Parameter Passing:**
```rpg
c     *entry        plist
c                   parm                    w_firm
```
The new company/firma number is passed in as a parameter at program start.

**Key Lists:**
For each file, a key list is created for keyed access, typically tied to the company field.

---

## 7. **General Flow Summary**

1. **Program Initialization:** Receives the new company number (w_firm) as a parameter.
2. **For each file:**
   - Reads all records belonging to the old company (`l_firm`).
   - For each record, changes the company code to the new one (`w_firm`).
   - Writes the record to the corresponding output file.
3. **Repeats for all relevant files (input to output pairs).**
4. **Program ends, cleanly releasing resources.**

---

## 8. **Special Notes**

- Variable names are Norwegian, reflecting the heritage of the system (e.g., “firma” = “company”, “navn” = “name”).
- The program is very typical in financial or administrative systems for mass copying data when a new company entity is created.
- Not all possible files are actually processed; some logic is commented out.

---

# **Summary Table**

| Section            | Purpose                                                |
|--------------------|-------------------------------------------------------|
| File Specs         | Declare input/output file pairs                        |
| Data Definitions   | Map buffer positions to variables/fields               |
| Main Logic         | For each file, copy and modify company numbers         |
| Initialization     | Receive parameters, set up key lists                   |
| Program End        | Set LR indicator, return                               |

---

## **Onboarding Tips**

- **Variable Naming:** Learn typical field names (e.g., `geffir`, `gafirm`, etc.) as they map to company codes in different files.
- **Add Files:** To process new files, copy an existing loop pattern and adjust input/output file and fields as needed.
- **Adjust For Structure:** Watch for record buffer overlays (UDS) and field offsets; these must match your file definitions.
- **Parameter:** The program expects the target company number (`w_firm`) at invocation.
- **Testing:** Be cautious—this program *writes* data; test with appropriate data sets and environments.

---

If you have any specific files, fields, or company setups, you should ensure their definitions match those expected in this program.