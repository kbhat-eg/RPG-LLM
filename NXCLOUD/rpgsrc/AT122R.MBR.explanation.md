# Program Overview

This RPG program (AT122R) is a classic ILE RPG application running on IBM i (AS/400). It manages a "menu" maintenance screen (likely for application navigation), using subfiles for list handling and SQL for data access. Much of the interface and logic is described in Norwegian. 

It covers:
- Displaying, updating, inserting, and deleting subfile records representing menu entries.
- Searching/filtering records.
- Subroutines for core CRUD logic.
- SQL with embedded cursor management.
- User feedback via specific screens and indicators.

---

## Source Sections Explanation

### 1. **Header and Settings**
```rpg
h option(*nodebugio : *srcstmt) datedit(*dmy)
```
Sets program options:
- No debug I/O.
- Source statement numbering.
- Date edit format day/month/year.

### 2. **Comments/Documentation**

The boxed comment block describes:
- Program identification.
- Indicator usage (e.g., *INLR = end of program, *IN10 = roll-up, *IN11 = roll-down, etc.).
- Special versions, customization, change log.
- Norwegian comment lines describe variable purposes, screen layouts, and logic.

### 3. **File Definitions**
```rpg
fat122d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Display file (AT122D) with workstation device type (**workstn**).
- Subfile **b1sfl** used for listing, controlled by relative record number (**w_srrn**).
- Information Data Structure (**infds**) named **dspfbk** for interactive feedback.

### 4. **Data Definitions (D-Specs)**

- **Local Data Area (LDA)**:
    ```rpg
    d                uds
    d l_user                911    920
    d l_firm                944    946  0
    d l_fnav                951    980
    ```
    Reads system-level data, e.g., user, firm (company), navigation.

- **Information Data Structure**:
    ```rpg
    d dspfbk          ds
    d  d_fcrn               378    379I 0
    ```
    Used to capture cursor position, etc.

- **Variable and Key Definitions**:
    - **w_date, w_time**: Current date and time.
    - **w_fcrn, w_stel, w_spge, w_srrn, w_sfrn, w_ssrn**: Paging/subfile control variables (first/last/current record, page size, etc.).
    - **b_forn, b_oppr, b_anul**: Boolean flags for subroutine flow.
    - **w_amhuid, w_amhmnu, etc.**: Work variables and fields mapped to menu entries.
    - **sqlquery**: Very large variable for dynamic SQL query construction.

- **Constants**:
    ```rpg
    d c_sfil          s              2  0 inz(18)
    ```
    Subfile page size (18 lines).

### 5. **Initialization**

```rpg
C/Exec SQL
C+  Set Option DatFmt=*ISO, commit=*none, DlyPrp=*YES
C+  , SRTSEQ=*LANGIDSHR, LANGID=NOR
C/End-Exec
```
- Sets SQL options: ISO date, no commit, deferred prepare, Norwegian sort sequence.

---

## **Main Logic**

### 6. **Main Control Routine**

The main logic is a big loop structure, controlled by labels and GO TOs (old RPG style):

- **b2taga**: This label starts the major loop.
    - **WRITE b2cmd**: Send prompt/instruction screen.
- **b2tagb**: Handles the main subfile display and interaction.
    - **EXSR dsp_subfile**: Show the subfile.
- **Function key handling (SELECT/WHEN)**:
    - *INkc,*INkl: Exit program.
    - *INka: Help screen.
    - *INkd: Query/search (not fully implemented in this snippet).
    - *INke: Refresh.
    - *INkf: "Protect" fields, open create-new screen.
    - *INkh: Call another program.
    - *IN10: Rollup; load next subfile page.
- **Positioning logic**: If field (b2fris) has value, position subfile.
- **Subfile processing**: Handles edits, copies, deletes, view actions.

- **avslutt**: Program exit.

### 7. **Major Subroutines**

Each subroutine uses the classic `begsr/endsr` structure.

- **forny**: Refresh/repopulate the subfile list. Clears and reloads.
- **posisjoner**: Repositions the subfile based on user entry.
- **subfile**: Handles user actions on subfile rows (edit, copy, delete, view). Core logic:
    - Loops through subfile records, reading changed rows.
    - For each action (edit/copy/delete/view), calls the relevant subroutine.
    - If changes were made (`b_forn`), re-populates the subfile.
- **xc1bld**: Screen handler for creating new entry (or copying an existing row for duplication).
    - Handles input and checks for duplicates (via SQL).
    - Calls the maintenance subroutine for the actual update/insert.

- **xc1msg**: If duplicate found, display a message.

- **xd1win**: Handler for delete confirmation:
    - Fetches current row details.
    - Shows delete screen.
    - Deletes if confirmed via SQL.

- **xc2bld**: Maintenance subroutine for update/insert/view:
    - If new, pre-populates from working variables.
    - Otherwise, pulls up the current database row via a SELECT.
    - Depending on action (edit/copy/new), does UPDATE or INSERT.

- **clr_subfile**: Clears (empties) the subfile, resets control variables.

- **crt_subfile**: Populates (fills) the subfile:
    - Dynamically constructs and prepares the SQL query, with or without a search filter.
    - Opens and fetches rows, writing to the subfile until page filled.

- **dsp_subfile**: Displays the subfile, handles standard display indicators.

- **spørring**: Placeholder for advanced search logic (not implemented here).

- **xf1msg**: Displays info/help message.

- ***inzsr**: Initialization: loads company from LDA, sets up initial screen and subfile.

---

## **Subfile Paging Explanation**

- Subfile uses a relative record model, supports paging (rolling up/down).
- Controlled by variables:
    - **w_srrn**: Last record number in use.
    - **w_spge**: Page size.
    - **w_ssrn, w_sfrn**: Used to handle roll up/down and page navigation.
- When user pages, subfile is reloaded with appropriate rows.

---

## **SQL Integration**

- Embedded SQL is used for all data access (SELECT, INSERT, UPDATE, DELETE).
- Dynamic SQL is built for listing/searching (`sqlquery`, prepared and used via cursor).
- Variables mapped to fields in the `amnhst` or `dynamiskcloudmeny` tables.

---

## **Indicator Usage**

- **Function and status indicators** (classic RPG *INxx) control flow and screen behavior:
    - *INLR: Last record/exit program.
    - *IN10, *IN11: Page up/down.
    - *IN14: Subfile clear indicator.
    - *IN15: End of subfile indicator.
    - *IN22: Cursor positioning.
    - *IN30: Protect fields.
    - *INkc, *INkl, etc: Function/command keys.

---

## **Screen/Display File References**

- **b1sfl**: Main subfile record format.
- **b2ctl**: Subfile control record.
- **b2cmd**: Command function key prompt.
- **c1bld/c1msg/d1win/c2bld**: Various entry/edit/delete screens.

---

## **Key Takeaways for Onboarding**

- **This is a menu-maintenance program** using RPG’s subfile paradigm, tied heavily to interactive screens.
- **CRUD**: All core create, read, update, delete actions are covered per-row, with user confirmation and feedback.
- **Paging and search**: Users can page through entries, and filter/search using a free-text field.
- **Subroutines**: Business logic is highly structured via subroutines, which are called depending on user actions.
- **SQL usage**: Data access is managed by embedded SQL; search is done with dynamic SQL for flexible filtering.
- **Indicators**: Extensive use of classic RPG indicators for screen and flow control (critical to follow program flow).
- **Screen interaction**: Program flow moves between subfile, entry, delete, and message screens, controlled by user input.

---

## **For New Developers**

- **Understand the subfile logic** (fetching, writing, clearing, paging).
- **Follow the indicator-based flow**: Actions are mostly predicated on which indicators were set by display file.
- **SQL integration**: Prepare to debug/extend dynamic queries.
- **Look up display file formats** (DDS for AT122D) for attribute mapping.
- **Know the tables involved**: Mainly `amnhst` or `dynamiskcloudmeny`.
- **Read the Norwegian comments**: They’re essential for field and logic understanding.
- **Classic style**: While RPG IV is modern, this program uses many RPG/400 idioms (goto, subroutine blocks, etc.).

---

### **Summary Table: Main Actions**

| User Action      | Indicator(s)            | Subroutine(s) Called | Result                         |
|------------------|------------------------|---------------------|--------------------------------|
| Create New       | *INkf                  | xc1bld, xc2bld      | Shows new row screen, inserts  |
| Edit             | Selection on subfile   | xc2bld              | Shows edit screen, updates     |
| Copy             | Selection on subfile   | xc1bld, xc2bld      | Shows copy-as-new, inserts     |
| Delete           | Selection on subfile   | xd1win              | Confirms, deletes row          |
| View             | Selection on subfile   | xc2bld              | Shows details, no change       |
| Search           | Entry in field         | crt_subfile         | Filters list                   |
| Page Up/Down     | *IN10, *IN11           | crt_subfile         | Loads next/prev page           |
| End/Exit         | *INkc, *INkl           | End logic           | Leaves program                 |

---

**In summary:**  
This is a robust, indicator-driven RPG interactive program for maintaining a menu system. It uses subfiles, SQL, and display files, with logic separated into subroutines for clarity. Familiarity with classic RPG, subfiles, and IBM i display files is essential to support or enhance this code.