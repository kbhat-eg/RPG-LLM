# Explanation of RPG Program MP103R

This RPG (Report Program Generator) program is named **MP103R** and runs on IBM i (AS/400) systems. It is written in fixed-format ILE RPG. The code is well commented in Norwegian, and its primary purpose is:

> **Selecting suppliers to generate order proposals, based on the day and parameters.**

Below is a structured explanation to help developers onboard quickly.

---

## 1. **Header and Metadata**
- **`h option(*nodebugio) datedit(*dmy)`**
  - *NODEBUGIO* disables debug input/output.
  - *DATEEDIT* specifies DD/MM/YY date format.
- The initial comments explain the system, purpose, and modification history.

---

## 2. **Files Declared**
- **Logical/Physical Files:**
  - `fmppalr`: Input file for supplier parameters (`mppapfr:mppalrr`).
  - `fmppalu`: Update file for supplier parameters (`mppapfr:mppalur`).
  - `fxtill1`: File for additional fields/parameters (`xtilpfr:xtill1r`).
- Files are declared with key (`k`) and with external data structure renames.

---

## 3. **Parameter and Variable Declarations**
- **Parameters:**
  - `p_dato`: Date parameter, format ISO.
  - `p_dgnr`: Day number (1-7).
  - `p_ldor`, `p_lnum`: Supplier order and number, like DB fields.
  - `p_jobb`, `p_dat`, `p_kl`: Job name, date, and time for scheduling.
  - `w_kls`, `w_dato`, etc.: Work variables for time and date processing.
- **LDA (Local Data Area) Fields:**
  - For user, firm ID, file identities.
- **Other Working Variables:** For field/record handling, screen indicators, subfile processing, etc.
- **Constants:**
  - `c_sfil`: Used for subfile operations.

---

## 4. **Mainline Logic**

### a. **Initialization**
- **Set current time to `p_dato`.**
- **Call program `MP701R`** to determine the day number for the given date (`p_dato`).
- **Set file position to start of supplier parameter file (`mppalr`).**

### b. **Main Processing Loop**
- **Reads records** from `mppalr` (supplier parameters).
- **For each record, calls subroutine `behandling`** (processing).
- Continues until end of file (`%eof(mppalr)`).

### c. **Scheduling (v7.01 additions)**
- After processing all suppliers, the code:
  - Reads possible scheduled start times from `xtill1` (extra parameter file).
  - Determines next valid time for order proposal runs.
  - If a run should occur later the same day, **schedules job by calling `MP705C`** with calculated date and time.

---

## 5. **Subroutines**

### a. **`behandling` (Processing Supplier)**
- **Initializes `b_dann` to *off* (do not generate proposal by default).**
- **Checks if supplier is on hold (`mphold = 0`).**
- Depending on the frequency (`mphypp`):
  - `'MD'`: Monthly. If at least 1 month since last order (`mpsdat`), set `b_dann` on.
  - `'DG'`: Daily. If at least 1 day since last order, set `b_dann` on.
  - `'14'`: 14-day cycle. Calls subroutine `beh_14d`.
  - `'UK'`: Weekly cycle. Calls subroutine `beh_uke`.
- **Time-of-day check:** (v7.01 logic)
  - Retrieves scheduled start time from `xtill1`.
  - If scheduled start (`w_kl`) > current time (`w_akttid`), skips run for now (sets `b_dann` off).
- **If `b_dann` is ON:**
  - Sets up parameters and **calls program `MP703R`** to generate order proposal for the supplier.

---

### b. **`beh_14d` (14-Day Frequency Helper)**
- Checks if more than 7 days have passed since last order.
- For each day of the week (Sunday to Saturday), checks if:
  - Today is that weekday (`p_dgnr`), and
  - The supplier is scheduled for proposals on that weekday (flags `mpdag1`-`mpdag7`).
- If both match, sets `b_dann` on and exits subroutine.

---

### c. **`beh_uke` (Weekly Frequency Helper)**
- Checks if at least 1 day has passed since last order.
- As for `beh_14d`, checks one weekday at a time and corresponding flags.

---

### d. **`*inzsr` (Initialization Subroutine)**
- Sets up key lists for file access.
- Loads firm ID from LDA and sets work variables.
- Sets screen processing indicator.

---

## 6. **Key List Declarations**
- Used for file operations (`read`, `chain`, etc.) according to RPG file processing rules.

---

## 7. **Program End**
- Sets *LR indicator to signal end of program and returns.

---

# **Summary of Functionality**

- For each supplier record, the program determines—based on configured frequency, last proposal date, user parameters, day of week, and scheduled run-time—whether an **order proposal** should be generated now.
- If so, it **calls an external program** to handle the proposal generation.
- It also checks when the next run should occur (scheduling future job if appropriate).
- All time and scheduling logic is controlled both by frequency fields and by possible "do not run before XX:XX" settings in auxiliary tables.

---

# **Onboarding Tips**

- **Supplier parameters**: Most logic depends on fields like `mphypp` (frequency), `mpsdat` (last order), and weekday flags (`mpdag1`-`mpdag7`).
- **Date/Time handling**: Uses subfielding and decimal conversions (`%subst`, `%dec`, `%char`) to calculate times and compare current vs. scheduled times.
- **External Programs**: `MP701R` (get day), `MP703R` (generate proposal), `MP705C` (schedule job) are invoked at key points.
- **XTILPF file**: Used to store additional per-supplier settings, particularly for scheduling.

---

# **Key Points in Code Read**

- **Entry point**: Initialization, then supplier loop.
- **Subroutines do the core logic**: Check frequency, dates, and time of day.
- **Extensive use of indicators and subfile logic**: Many indicators (10-99) reserved.
- **Extensibility**: File and field names are externalized, easily adapted for new frequencies or parameter tables.
- **Norwegian field and comment names**: Developers unfamiliar with Norwegian may want to get a vocabulary reference for field meanings.

---

*This explanation should help new RPG developers or those unfamiliar with this codebase to quickly understand the purpose and flow of MP103R.*