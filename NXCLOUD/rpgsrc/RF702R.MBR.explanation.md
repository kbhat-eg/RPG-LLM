# Documentation: Deletion of Records from `rtripf` (Program RF702R)

## Overview

This program is responsible for deleting records from the physical file `rjoulu` (likely related to a "trip" or "journey" log, given naming conventions). The deletion is controlled by a member key (`w_memb`) passed as a parameter. The program supports optional logging, which is dynamically enabled via a call to an external program (`CO402R`). Logging entries are written via calls to `AB700R` and `AB705R` at key points in the program's execution.

---

## Structure and Flow

### File and Data Definitions

- **File**:  
  - `rjoulu` is defined as a keyed, update-capable disk file.
- **Key Fields**:  
  - `rjoulu_nivo`, `rjoulu_memb`, `rjoulu_sort` are used to build the key list for record navigation and deletion.
- **Work Variables**:  
  - Various work fields (`w_firm`, `w_memb`, `w_jkey`, etc.) are used for logging and parameter passing.
- **Logging Control**:  
  - `u_logg` is a flag controlling whether logging is active.

### External Program Calls

- **CO402R**:  
  - Determines if logging should be enabled for the current run. Takes file group, firm, warehouse, and a key string, returning a flag in `co402_verdi1`.
- **AB700R / AB705R**:  
  - Used for writing log entries. `AB700R` is called at job start, while `AB705R` is used at start, before LR (last record), and after LR.

---

## Main Processing Logic

### Initialization (`*inzsr` Subroutine)

- Accepts `w_memb` as an input parameter, which identifies the member whose records should be deleted.
- Initializes key fields for file positioning.
- Sets `w_firm` from a data structure.
- Calls `CO402R` to determine if logging is needed.
  - If logging is enabled (`co402_verdi1 = '1'`), sets `u_logg` to *on.

### Logging Start

- If logging is enabled, logs the start of the program to both `AB700R` and `AB705R`.

### Record Deletion Loop

- Positions to the first record matching the key list (`setll`).
- Reads sequentially through the file:
  - If EOF, branches to cleanup.
  - If the `rjmemb` field does not match `w_memb`, exits loop.
  - Otherwise, deletes the record and continues.

### Logging End

- If logging is enabled, writes a log entry before and after setting the last record indicator (`*inlr`), using `AB705R`.

### Program End

- Returns control to the caller.

---

## Business and Domain-Specific Logic

- **Member-Based Deletion**:  
  The core business rule is to delete all records in `rjoulu` where the member field matches the input parameter. This is likely part of a data cleanup, archival, or reset process for a specific user, account, or organizational unit.
- **Dynamic Logging Activation**:  
  The program does not always log its activity. Instead, logging is enabled or disabled at runtime based on configuration or operational context, as determined by `CO402R`. This allows for detailed auditing only when required, reducing overhead during routine operations.
- **Logging Conventions**:  
  Log messages are standardized and include program identifiers (e.g., 'Start RF702R', 'Slutt RF702R f�r LR', etc.), supporting traceability in operational logs. The use of both `AB700R` and `AB705R` suggests a multi-tiered logging/auditing system.

---

## Design Patterns and Conventions

- **Separation of Logging Logic**:  
  All logging is encapsulated in external programs, keeping the main business logic clean and focused.
- **Configurable Behavior**:  
  Logging can be toggled dynamically, supporting both performance and audit requirements.
- **Keyed Access and Deletion**:  
  The use of a key list (`klist`) and sequential read/delete pattern ensures efficient processing of relevant records.

---

## Interactions with Other Modules

- **CO402R**:  
  Centralized logging configuration, likely used by other programs as well.
- **AB700R / AB705R**:  
  Shared logging routines, possibly writing to a job log or audit file.

---

## Notes & Non-Obvious Points

- **Field Naming**:  
  Many field names are abbreviated and may not be immediately clear. Refer to data dictionary or file layouts for precise meanings.
- **Error Handling**:  
  Minimal error handling is present; the program assumes successful file operations and program calls.
- **Code Comments**:  
  Some comments are in Norwegian (e.g., "Slette poster" = "Delete records", "Test om logging skal gjøres" = "Test if logging should be done").

---

## Summary Table

| Section              | Purpose                                             |
|----------------------|-----------------------------------------------------|
| Initialization       | Set up parameters, keys, and logging control        |
| Logging (Start)      | Optionally log program start                        |
| Main Loop            | Delete matching records from `rjoulu`               |
| Logging (End)        | Optionally log program completion                   |
| External Calls       | Logging configuration and log entry writing         |

---

## Recommendations for New Developers

- Familiarize yourself with the structure and content of `rjoulu` and the meaning of key fields.
- Review the interfaces for `CO402R`, `AB700R`, and `AB705R` to understand logging infrastructure.
- Be aware of the dynamic logging mechanism when troubleshooting or auditing program runs.
- Follow the established pattern for logging and deletion if extending or refactoring this program.