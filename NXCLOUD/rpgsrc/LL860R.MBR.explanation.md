# LL860R Program Documentation

## Overview

**Program Name:** LL860R  
**System:** ASLAGR  
**Description:** Extraction of incoming invoice lines (Uttrekk inng.fakt.linjer) via parameter interface.

This program is part of the accounts payable or procurement subsystem, designed to extract invoice line data based on user-specified criteria. It interacts with the user via a workstation display file, validates input parameters, and delegates the actual extraction to a called program (`LL860C`). The program also supports inquiry functionality for supplier data and maintains a consistent structure for parameter passing and error handling.

---

## Key Components

### 1. File Declarations

- **rlevl1**: Physical file for supplier master data, renamed to `rlevl1r` in this program. Accessed by key for supplier validation.
- **LL860d**: Workstation display file (DSPF), defines the user interface for entering extraction criteria and displaying messages.

### 2. Data Structures

#### Local Data Area (LDA) Fields

- **l_firm**: Company number.
- **l_wsid**: Workstation ID.
- **l_user**: User ID.
- **l_fnav**: User's full name.
- **l_lage**: Warehouse/location code.

#### Parameter Record

A data structure for passing extraction parameters:
- **p_prec**: 55-character parameter string.
  - **p_ldor**: Supplier number (overlay).
  - **p_fdat**: From date (overlay).
  - **p_tdat**: To date (overlay).
- **p_mapp**: Mapping profile/ID.
- **p_filn**: File name for output.
- **p_batc**: Batch indicator.

#### Working Variables

- **w_***: Variables for temporary storage and manipulation of input data, dates, groupings, and output formatting.
- **b_***: Boolean switches for error and state management.
- **c_fsep**: Constant for field separator (`;`), possibly for CSV output.

---

## Program Flow

### Initialization

- **INZSR** subroutine sets up initial state:
  - Reads company number from LDA.
  - Gets current date/time and extracts year and month.
  - Prepares key list for supplier file access.

### Main Loop (`A1BLD` Tag)

1. **Screen Display and Input**
   - Displays input screen (`exfmt a1bld`) for the user to enter extraction criteria.

2. **Command Handling**
   - **CMD3/CMD12**: Exit program.
   - **CMD4**: Calls `sp_input` subroutine for supplier inquiry.
   - **CMD13**: Sets batch indicator (`p_batc`).

3. **Input Validation**
   - Checks for required fields:
     - Supplier number (`a1ldor`)
     - From date (`a1fdat`)
     - To date (`a1tdat`)
     - Mapping profile (`a1mapp`)
     - Output file name (`a1filn`)
   - Each missing/invalid field sets a corresponding indicator and redisplays the screen.

4. **Supplier Validation**
   - Chains to `rlevl1` (supplier master) using the supplier number.
   - If not found, sets error indicator and redisplays the screen.

5. **Parameter Preparation**
   - Populates parameter data structure with validated inputs.
   - Prepares parameters for the extraction program.

6. **Delegation to Extraction Program**
   - Calls `LL860C` (the extraction logic) with all necessary parameters.

### Program Exit

- **END_PGM** tag: Sets LR indicator and returns.

---

## Subroutines

### `sp_input`

Handles supplier inquiry from the input screen:
- If the active field is supplier number, calls `RL500R` (supplier inquiry program) to fetch supplier details.

### `*INZSR`

Initialization logic:
- Loads company number from LDA.
- Sets up date-related working variables.
- Prepares key list for supplier file access.

---

## Design Decisions & Conventions

- **Parameter Passing**: Uses overlays in a fixed-length parameter string for compatibility and legacy integration.
- **Field Validation**: Each required parameter is individually validated. Errors are signaled by setting display file indicators, which control error messages on the screen.
- **Screen Flow**: Uses tags and `goto` for returning to the main input screen after validation errors, following a traditional RPG screen-handling pattern.
- **Separation of Concerns**: Extraction logic is separated into `LL860C`, keeping this program focused on validation and parameter collection.
- **Supplier Inquiry Integration**: Supplier validation and inquiry are modularized, with the ability to call out to a dedicated inquiry program (`RL500R`) from the input screen.

---

## External Dependencies

- **rlevl1**: Supplier master file (must be available and keyed).
- **LL860d**: Workstation display file (DSPF) defining the user interface.
- **LL860C**: Extraction program called with validated parameters.
- **RL500R**: Supplier inquiry program called during input inquiry.

---

## Business/Domain-Specific Logic

- **Supplier Number**: Central to the extraction; must be validated against master data.
- **Date Range**: Extraction is always limited to a user-specified date interval.
- **Mapping Profile**: Likely refers to a transformation or format profile for output.
- **Output File Name**: User specifies where the extracted data should be written.
- **Batch Indicator**: Optional; may control batch vs. online extraction mode.
- **Error Handling**: All user errors are surfaced via display file indicators for user correction.

---

## Summary

LL860R is a user-interactive parameter collection and validation program for extracting incoming invoice lines. It ensures the user provides all necessary input, validates supplier existence, and delegates the actual extraction to a separate program. The design emphasizes modularity, robust validation, and adherence to established RPG screen-handling conventions within the accounts payable domain.