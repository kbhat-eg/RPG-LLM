# RPG Program Explanation: Kontroll av ordre på kunde (`FO792R`)

This RPG program verifies whether there are orders for a given customer in the order header file. The code is written in fixed-format ILE RPG and contains comments explaining indicator usage and version history.

---

## 1. **Header and Metadata**

```rpg
/TITLE  Kontroll av ordre p� kunde
h datedit(*dmy) option(*nodebugio)
```
- **/TITLE** sets the program title (Order Control for Customer).
- **H-spec** sets the date format to day/month/year and disables debug I/O.

---

## 2. **Comments and Indicator Usage**

The commented header details:
- Program name: `FO792R`
- Purpose: Checking orders for a customer
- Indicator conventions, such as `KA` (F1), `KC` (F3), `LR` (last record/program end), etc.
- Version history.

---

## 3. **File Declaration**

```rpg
ffohelk    if   e           k disk    rename(fohepfr:fohelkr)
```
- Declares logical file `fohelk` (order header file), keyed, for input.
- The record format `fohepfr` is renamed to `fohelkr` in the program.

---

## 4. **Variables and Data Area**

### Key Variable
```rpg
d fohelk_kund     s                   like(fokund)
```
- A standalone field, `fohelk_kund`, defined with the same data type as `fokund` (customer number field from the file).

### User Data Area (UDA)
```rpg
d                uds
d l_wsid                901    910
d l_user                911    920
d l_firm                944    946  0
d l_navn                951    980
```
- Data area overlay for workstation/user/firma information.

### Local Variables
```rpg
d w_firm          s                   like(fofirm)
d p_firm          s              3  0
d p_kund          s                   like(fokund)
d p_stat          s              1
```
- `w_firm`: Work variable for company, like `fofirm`.
- `p_firm`: Program parameter, 3 digits, for company.
- `p_kund`: Program parameter, customer number.
- `p_stat`: Status flag/parameter (1 character).

---

## 5. **Main Logic - Order Existence Check**

```rpg
c                   if        p_stat = ' '
c                   eval      fohelk_kund = p_kund
c     fohelk_key    chain     fohelk                             91
c                   if        *in91 = *off
c                   eval      p_stat = 'X'
c                   endif
c                   endif
```
- If `p_stat` is blank, check if there is an order for the customer.
- Set `fohelk_kund` to `p_kund`.
- **CHAIN** using the key list `fohelk_key` into file `fohelk`, set on indicator 91 if not found.
- If found (`*in91 = *off`), set `p_stat` to `'X'`.

---

## 6. **End Tag and Program End**

```rpg
c     slutt         tag

c                   if        p_stat = 'S'
c                   eval      *inlr = *on
c                   endif
T3.30c                   return
```
- Label `slutt` marks the exit point.
- If `p_stat` is `'S'`, set LR (last record) indicator to end the program.
- Always **RETURN** (fix from version V3.30 to avoid looping).

---

## 7. **Initialization Subroutine (*INZSR)**

```rpg
c     *inzsr        begsr

c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_kund
c                   parm                    p_stat
```
- Standard initialization subroutine.
- Receives three parameters: company, customer, status.

### Key Definition for File Lookup

```rpg
c     fohelk_key    klist
c                   kfld                    w_firm
c                   kfld                    fohelk_kund

c                   eval      w_firm = p_firm
```
- `fohelk_key` is the key list for searching the order file: company + customer.
- Assign input company to work variable `w_firm`.

```rpg
c                   endsr
```
- End of subroutine.

---

## 8. **Summary of Indicator Usage**

- **91**: Set when CHAIN fails (no order found for customer).
- **LR**: Set when `p_stat` = 'S', to terminate program.
- Other indicators are described in the comments but not actively used in the main logic.

---

## 9. **High-Level Program Flow**

1. **Initialization**: Receives parameters for company, customer, and status.
2. **Key Preparation**: Sets up key fields for order header lookup.
3. **Order Existence Check**: If status is blank, use company and customer as key to query orders in the header file.
4. **Status Update**: If order found, set status to 'X'.
5. **End**: If status is 'S', terminate program.
6. **Always RETURN**: Program ends after main logic to ensure no infinite loop.

---

## 10. **Typical Usage**

This program is typically called as a subroutine or utility to check if a particular customer has orders in the system. It relies on status flags returned to the caller to indicate the outcome (`'X'` for found, blank for not found, etc.).

---

## 11. **Version Fix**

- **T3.30**: The program originally lacked a `RETURN` statement, potentially causing looping—hence the added `RETURN`.

---

**In essence, this RPGLE program is a utility for checking order existence for a customer, relying on file CHAIN operations and careful status management using passed parameters and indicators.**