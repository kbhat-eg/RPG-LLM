# Overview
This program handles the maintenance of offer prices (“Tilbudspriser”) in the ASOFAK system. It allows users to create, edit, copy, delete, and view offer-price records through a subfile-based interactive screen (VT100D). In the business domain, “Tilbudspriser” can be tied to both individual items and groups of items (overgruppe, hovedgruppe, undergruppe), as well as specific suppliers (leverandør). The program also supports price grouping, campaign codes (kampanje), and the option to define date/time ranges for when an offer is active.

Although the code is an RPG program, it integrates with several external modules and APIs. For example, it calls:
- VG510R, VG511R, VG512R (group lookups)  
- VV500R (item lookups)  
- RL500R (supplier lookups)  
- RA530R (price-group lookups)  
- VP715R (supplementary price or item logic)  

Additionally, the program references multiple physical files. The core files begin with “VTILL…”, which store the offer-price data, and the code uses specialized variants such as VTI2… and others that handle extended fields like purchase price range, date expansions, and more.

# Core Functional Areas

## 1. Subfile and Display Management
- The main display (VT100D) contains a subfile (B1SFL) and several control records (B2CTL, B2CMD).  
- The code manages paging (roll up/down) and positioning in the subfile (see the tags b2taga, b2tagb).  
- Subroutines like “clr_subfile” (to clear existing data) and “crt_subfile” (to reload a portion of data) define how records are pushed into the subfile.  
- “bck_subfile” handles reverse paging logic (readp commands).  
- “dsp_subfile” writes and displays the subfile, capturing function keys and cursor position.

## 2. Filtering and Positioning
- The program offers multiple ways to locate records: by item number (vare), price group (prisgruppe), campaign code (kampanje), date ranges (fra-dato, til-dato), supplier (leverandør), or grouping levels (overgruppe / hovedgruppe / undergruppe).  
- Subroutines “posisjoner” and “forny” illustrate how a user-supplied filter (for example, from screen fields B2xxxx) triggers a reposition in the underlying physical files, then refreshes the subfile with matching data.

## 3. Creating, Editing, and Copying Records
- “xc1bld” handles creation (C1BLD display). When a user enters new data, the code checks for conflicts (e.g., if the record already exists).  
- “xc2bld” (C2BLD display) is for editing or viewing details. It retrieves the existing data, populates the screen, and then confirms any changes back to the underlying file.  
- “xk1win” (K1WIN display) manages copying an existing record to a new key. The code checks whether the new record already exists before writing it.  
- Common subroutines check the correctness of date/time input, unit references, price group references, and whether an item or group-based discount is being created.

## 4. Deleting Records
- “xd1win” (D1WIN window) handles record deletions. After confirming the user’s intention, it chains and deletes the matching record (VTILLUR).

## 5. Multiple Units, Price Calculations, and MVA
- The code supports up to three different units for each item (C2ENH1, C2ENH2, C2ENH3) with corresponding offer prices (C2TIPx), cost prices (C2KOPx), and optional tax-inclusive calculations.  
- Subroutine “auto_beregn” automatically recalculates offer prices across units based on conversion factors (C2OMR2, C2OMR3) and an MVA factor (w_mvaf) if a user has entered prices including VAT.  
- This ensures that if a price is changed in one unit, the system can derive comparable changes in the other units.

## 6. External Lookups and Screen-Level Queries
- The program calls external modules (like VG510R, RL500R, etc.) in subroutine “spørring.” This is activated when the user presses a function key (F4) on certain fields.  
- Once the external lookup returns data, the program updates local fields (for example, w_gtxt or w_lnave) to display textual descriptions (such as group names, supplier names).

## 7. Handling Extended Fields
- Repeated references to versioning (6.20, 6.21, 7.00, etc.) indicate incremental enhancements:  
  - Additional grouping fields (ogrp, hgrp, ugrp) and supplier codes (ldor).  
  - Price-group expansions, purchase prices, and date expansions (vidf, vidt).  
  - “Vti2…” files store or chain extended attributes (e.g., c2vidf, c2vidt for an extended date range).
- The code often updates both the main “VTILL…” records (vtillr/vtillu) and the extended “VTI2…” variants (vti2lr/vti2lur) so that newly introduced fields remain consistent.

## 8. Data Scrubbing for Newlook
- Subroutine “newlo_vask” (near the bottom) demonstrates removal of certain trailing punctuation (“.” or “:”) from a field (b1tek1) because the Newlook UI cannot handle them. This is a non-obvious design detail to ensure compatibility with that specific client display tool.

# Key Takeaways
1. The program is a comprehensive maintenance solution for offer-price records, supporting:
   - Item-based, group-based, and supplier-based offers.  
   - Configurable date/time windows.  
   - Multi-unit discounting.  
   - Price-group expansions.  

2. Extensive subfile logic controls how records are listed and browsed.

3. Calls to multiple external modules show the system’s modular reference approach, where each lookup (item, supplier, group, or price group) is performed by a dedicated program.

4. Careful input validation (dates, times, fields) ensures data integrity across the “tilbudspriser” files.

5. Newlook-specific handling ensures text fields do not contain symbols that the GUI application cannot parse.

Ultimately, “VT100R” is a master entry-point for users to maintain discounted/offer-price records. It orchestrates all subfile activity, queries, data verification, and calls to other external programs.