# RPG Program RR624R - Printout of Result Report (13 Periods)

This RPG/400 program is for IBM i (AS/400) and generates a result report (presumably a financial statement) over 13 periods, with options for selecting departments, different types (actual, budget, forecast, etc.), and layouts (by line or department).

Below is a categorized, block-wise explanation to help you understand its architecture, logic, and how to work with or modify it.

---

## 1. **Control Specifications and Documentation Header**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `option(*nodebugio)`: Disables the debug I/O.
- `datedit(*dmy)`: Sets the date edit format to day/month/year.

The comment block (starting with `* System. . . . . : ASOKON ...`) documents the system, program, description, references, and change history.

---

## 2. **File Specifications (`F-Specs`)**

```rpg
frrf0l1    if   e           k disk    rename(rrf0pfr:rrf0l1r)
...
frr624p    o    e             printer oflind(*in30)
```
- Four database files (`rrf0l1`, `rrf5l1`, `rrf9l1`, `rrf9l2`) are input files, keyed, externally described, and renamed in the program.
- `rrf0l1`, `rrf5l1`, `rrf9l1`, `rrf9l2` are the logical files (views) over RESULTATREGISTER tables, holding report headings, text lines, balances, and so on.
- `rr624p` is the output printer file, with the overflow indicator as `*in30`.

---

## 3. **Data and Working Storage Definitions**

### a. Tables (Arrays)
```rpg
d pav             s              4  0 dim(24)         // Department numbers allowed
d uav             s              4  0 dim(8)          // Unused or alternative dep'ts
d sal             s             11  2 dim(14)         // Amounts per period (and opening bal)
d gsa             s             11  2 dim(14)         // Accumulated balances per period
d l1s             s              9  0 dim(14)         // Sums for output print lines
d kod             s              1    dim(14)         // Code (e.g., actual, budget) per period
```

### b. Data Structures
```rpg
d                 ds
d nybrd                          9  0                  // Composite break value
d  nylin                         5  0 overlay(nybrd)   // Line number within break value
d  nyavd                         4  0 overlay(nybrd:6) // Department number within break
...
d gmbrd (and overlays)                                // "Current" break values for comparisons
```

**Purpose:**  
- Used to track report control-break values (e.g., lines, departments), facilitating break handling logic in the report (subtotals, new headings, etc.).

### c. Local Variables
Numerous fields for:
- User/firm identification
- Holding balances (regnskap = actual, budsjett = budget, prognose = forecast, etc.)
- Temporary work fields (`n, m, x`), department text, status flags, report/line keys, and more.

---

## 4. **Input Specifications (`I-Specs`)**

```rpg
irrf9l1r
i              rr9s01                      sal(01)
...
irrf9l2r
i              rr9s01 ... rr9s13, rr9s00   sal(01) ... sal(14)
```
- These map physical fields in the result records (`rr9s01` = period 1, ..., `rr9s13` = period 13, `rr9s00` = opening balance) to corresponding array elements for reading in a loop.

---

## 5. **Main Logic**

### a. Reading Balance Records

The program supports two selection modes (`rhpsrt`):
  - `' '` (blank): line order
  - `'A'`: department order

Depending on the mode, it sets up the corresponding key and reads from the proper file (`rrf9l1r`/`rrf9l2r`). The read is done in a loop.

Within the loop, various filters are applied:  
- Skip unwanted departments (`rhanul = 'N' and rr9avd = *zeros`)
- Department selection via range and/or a `pav` array.
- Skip or process based on report type, year, and type (actual, budget, forecast, etc.).

### b. Report Control-Break Handling

Break values for lines and/or departments are constructed, compared to previous (gmbrd/gmlin/gmavd), and determine when to call subtotalling and print subroutines:
  - If new line: `exsr brlin`
  - If new department: `exsr bravd`
  - Print report headers as needed: `exsr skrhed`
  - Summation logic: `exsr rsum`
  - Reset and carry forward break variables to track state.

### c. Summing Logic (`rsum` Subroutine)
- Accumulates actuals, budgets, and forecasts into appropriate periods of the `gsa` array for printing.

### d. Printing and Formatting
- `brlin`, `bravd` subroutines handle printing of subtotals, headings, department labels, etc.
- `brtxt` writes textual lines and handles blank lines, page breaks, and resets overflow as needed.

### e. Helper Subroutines
- `beregn` calculates percent utilized/achieved figures for current and cumulative periods.
- `skrhed` writes report headers.
- `xltxt` fetches the next text line for output.

---

## 6. **Initialization (`*inzsr` Subroutine)**

- Sets output indicators based on report type parameter (`rhptyp`).
- Fills in the `kod` array with codes (`'R'`, `'B'`, `'F'`) for each column in the heading.
- Prepares working variables, fetches report and department headings, and maps input parameters into local arrays (`pav` for departments).
- Sets up key lists for random access to the various logical files.

---

## 7. **Key Logic Example**

```rpg
/--- Selection for record processing ---/
c     if        rhptyp = 'R' or rhptyp = 'P' or rhptyp = 'F'
c                and rr9aar = rhpr�r and rr9typ = 1
c         goto      behand

c     if        rhptyp = 'B' and rr9aar = rhpr�r and rr9typ = 3
c         goto      behand

c     if        rhptyp = 'A' and rr9aar = rhpr�r and rr9typ = 4
c         goto      behand

c     if        rhptyp = 'P' and rr9aar = rhpr�r and rr9typ = 3
c         goto      behand

c     if        rhptyp = 'F' and rr9aar <> rhprfj and rr9typ = 1
c         goto      behand
```
- Only process the record (`goto behand`) if it matches the selected type/year.

---

## 8. **Breakdown of Control Breaks**

- **Line Break (`brlin`):** Print subtotal line for line level, print optional blank lines, reset balances.
- **Department Break (`bravd`):** Print subtotal and heading for new department, fetch department description, reset balances.
- **Text Break (`brtxt`):** Output any text lines (headers/descriptions).

---

## 9. **Printing Amounts**

Amounts are accumulated in arrays (`sal`, `gsa`, `l1s`), and the print fields (`l1s01`–`l1s14`) are loaded for the printer file. Scaling based on parameter (`H` or `T`, i.e. hundreds/thousands) occurs as well.

---

## 10. **Program Completion**

When end-of-file, or at logical breaks, the program:
- Completes the report by printing any pending subtotals/headings.
- Sets `*INLR = *ON` (end of job).
- Ends.

---

## 11. **Hints for Extension or Modification**

- To add more periods: Increase array dimensions and mappings accordingly.
- To add new selection criteria: Extend filtering logic after file reads.
- For new print formats: Modify subroutines `skrhed`, `brlin`, `bravd`, and associated printer file layouts.

---

## 12. **General Notes**

- Many parameters seem to be passed/programmed externally (departments, report/year type, etc.).
- The code is carefully structured to handle complex printout logic for multi-level break reporting.
- Some embedded Norwegian terms:  
  - "Avdeling" = Department  
  - "Saldo" = Balance  
  - "Budsjett" = Budget  
  - "Regnskap" = Accounting/Actual
  - "Prognose" = Forecast
- The RPG/400 style (fixed-format), with overlays and indicator variables, is historical but still common in legacy IBM i environments.

---

## **Summary**

**This program is a classic AS/400 batch report generator for financial results over multiple periods and departments.**  
It is highly parameterized, supports flexible selection and formatting, and is designed for printing on classic IBM line printers. The code features complex break and subtotal logic to handle multi-level reporting by department/line, with separate handling for actual, budget, and forecast values.

For onboarding:  
- Understand the report requirements, especially the meaning of each input parameter.
- Pay attention to the array mappings, period handling, and control break mechanics.
- Test using different `rhptyp`, `rhpsrt`, and `pav` values to see effects on output.

If you need a walkthrough of any subroutine or section in further detail, just ask!