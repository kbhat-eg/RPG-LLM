## RPG Program: RE615R — "Saldobalanse til Akelius - utplukk"

This program is written in fixed-format ILE RPG and prepares a balance report for the Akelius system. It reads from account master and balance files, computes current year, previous year, and budget balances per account, and outputs a formatted record.

---

### 1. **Header Section**

- `h datedit(*dmy) option(*nodebugio)`
    - Sets date edit format as Day/Month/Year.
    - Disables debug IO.

---

### 2. **File Declarations**

- `frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)`
    - Input file: Account master, renamed record format.
- `frhsal1    if   e           k disk    rename(rhsapfr:rhsal1r)`
    - Input file: Balance matrix, renamed record format.
- `fre08pf    o  a e             disk`
    - Output file.

---

### 3. **Data Structures & Fields**

#### **Work Fields**

- `sal, saå, saf, sab` (arrays [1..14])
    - Hold balances (saldo) for different scenarios: generic, this year, last year, budget.
- **Layout for Output (`dsulda`)**
    - A data structure of length 80 with overlays for fields like account number, separator, text, amount, etc.
- **User Data Structure**
    - Holds company, user, report, and selection parameters.

#### **Work Variables**

- Many variables for holding current values (account, department, balances, etc.)
- `w_funn` is a flag indicating if a balance was found for the account.

---

### 4. **Input Specifications**

- The input record specification (`irhsal1r`) maps fields (`risa01` to `risa13`, `risa00`) to the `sal` array.

---

### 5. **Main Routine**

#### **1. Read Account Master**

```rpg
c     rhovl1_key    setll     rhovl1r
c     rhovl1_key    reade     rhovl1r
```
- Position to and read the first relevant account.

#### **2. Main Loop (by Account)**

```rpg
c                   dow       *in60 = *off
```
- Loop through all accounts.

#### **3. Account Deduplication**

```rpg
c                   if        rhkont = wfkont
c                   goto      neste_kto
c                   endif
```
- Skip if the same account as previous (write only once per account).

#### **4. Init for Each Account**

- Zero out the balance arrays.

#### **5. Read Balance Matrix for Account**

```rpg
c     rhsal1_key    setll     rhsal1r
c     rhsal1_key    reade     rhsal1r
```
- Position to and read balances for the current account.

#### **6. Loop Through Balances for Account**

```rpg
c                   dow       *in61 = *off
```
- Reads all balance records for this account.

##### **Subtotals/Grouping**

- Handles grouping by specification (`psums`) or department (`psumm`), with calls to the `summer` subroutine to output subtotals.

##### **Filtering by Department**

- Only include records within the selected department range.

##### **Balance Assignment**

- For current year (`ritype = 1` and `riraar = praar`): add to current year balance array.
- For previous year (`ritype = 1` and `riraar = w_raar`): add to previous year balance.
- For current year budget (`ritype = 3` and `riraar = praar`): add to budget balance.

#### **7. End of Matrix Loop**

- When done with all matrix records for this account, if a relevant balance was found, call the `summer` subroutine to write data.

#### **8. Next Account**

```rpg
c     rhovl1_key    reade     rhovl1r
```
- Advance to next account.

---

### 6. **Subroutine: `summer`**

Handles subtotaling/grouping and formatting output data.

- Sums up the relevant balances for this year, last year, and budget by period.
- Formats amounts, adding appropriate sign.
- Moves descriptive/account fields to output layout.
- **Only writes to output if at least one amount is non-zero.**

**Prevents duplicate account output** using `w_kont`.

**Resets keys for further subtotals** if grouping is active.

---

### 7. **Initialization (`*inzsr`)**

- Initializes variables.
- Calculates previous year (`w_raar = praar - 1`).
- Prepares key lists for setll/reade.

---

## **Key Design Points for Onboarding**

- **One Output Row per Account:** Skip duplicate accounts.
- **Balances for Multiple Years & Budget:** Arrays used to keep per-period values, for this year, last year, and budget.
- **Grouping ("pr. kto+spes", "pr. avdeling"):** Handles subgroups by specification or department.
- **Output Formatting:** Uses overlays in output DS to arrange fields as target system (Akelius) expects.
- **Only Nonzero Rows Output:** Avoids cluttering output with empty rows.

---

### **Maintenance Notes**

- Use of fixed-format C-specs and overlays: move carefully if converting/refactoring.
- Scandinavian field names: be aware when mapping to business logic.
- For new logic: focus on manipulation of balance arrays and subgrouping logic in the balance matrix loop.

---

## **Summary Flow**

1. **Loop over all accounts.**
2. For each new account, reset aggregates.
3. Read all balances for account.
4. Aggregate those that match selection criteria.
5. Write formatted output if any balances exist.
6. Repeat for next account.

---

## **References**

- `rhovl1` - Account master file.
- `rhsal1` - Balance matrix file.
- `re08pf` - Output file for Akelius.
- `summer` - Subroutine to sum, format, and write output for one group.
- `*inzsr` - Initialization subroutine.

---

**In summary:**
You can think of this program as looping over every account, collecting all relevant balances (current year, previous year, budget), grouping/subtotaling if needed, and writing out only non-empty (non-zero) summaries — all formatted for the Akelius system’s expectations.