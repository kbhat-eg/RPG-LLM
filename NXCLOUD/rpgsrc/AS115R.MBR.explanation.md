# AS115R – Documentation

## Purpose

The AS115R program is responsible for determining the next available suffix (suffiks) for a given order number (`numm`). The suffix is used to uniquely identify different versions or instances of an order across several tables in the system. The program ensures that the generated suffix does not conflict with existing suffixes in the following sources:

- **Current Orders** (BESTILLING-HODE-REGISTER)
- **Historical Invoices** (Historisk fakturaregister - SIHE)
- **Deleted Orders** (Sletta tabeller - LDEL)

The program is designed to prevent reuse of suffixes, handle wrap-around scenarios, and ensure uniqueness across both current and historical data.

---

## Structure Overview

### File Declarations

- **lohelr / lohel1**: Both are logical views over the BESTILLING-HODE-REGISTER (order header register), using different record formats.
- **sihel3**: Logical view over the historical invoice register (SIHE).
- **ldellr**: Logical view over the deleted orders register (LDEL).

All files are accessed via key access (`k disk`) and renamed to local record formats for clarity.

### Data Areas and Variables

- **Local Data Area**: Used to fetch values such as user, file, and firm number.
- **Key Variables**: Used to build keys for file access, matching the structure of the corresponding files.
- **Working Variables**: Used to track the highest suffixes found (`w_lsuf`, `w_hsuf`, `w_dsuf`), the candidate suffix (`w_suff`), and the firm identifier (`w_firm`).
- **Entry Parameters**: `p_numm` (order number, input), `p_suff` (suffix, output).

### Constants

- **lo, up**: Lowercase and uppercase alphabets (including Norwegian characters), likely used for validation or translation in other contexts.

---

## Main Logic Flow

1. **Initialization**: Sets up working variables and copies the input order number (`p_numm`) to all key variables.
2. **Suffix Search**:
    - Calls three subroutines to fetch the highest existing suffix for the order number from:
        - Current orders (`hnt_b_suf`)
        - Historical invoices (`hnt_h_suf`)
        - Deleted orders (`hnt_d_suf`)
3. **Determine Next Suffix**:
    - Compares found suffixes and selects the highest, incrementing it by one.
    - Ensures the suffix does not exceed 99 (wrap-around logic).
4. **Uniqueness Check**:
    - Checks that the proposed suffix does not already exist in current orders.
    - If it does, increments and checks again (loop).
5. **Return**:
    - Sets the output parameter `p_suff` to the determined value and exits.

---

## Subroutines

### hnt_b_suf – Find Highest Suffix in Current Orders

- Checks if suffix 99 exists for the given order number; if so, sets the next suffix to 100 (will wrap later).
- Otherwise, reads the highest existing suffix using a descending read (`readpe`).
- Sets `w_lsuf` to the highest found or -1 if none exists.
- Updates `w_suff` to `w_lsuf + 1`.

### hnt_h_suf – Find Highest Suffix in Historical Invoices

- Searches both the current year and the previous year for the highest suffix associated with the order number.
- Iterates through all matching records, tracking the highest suffix found in `w_hsuf`.

### hnt_d_suf – Find Highest Suffix in Deleted Orders

- Mirrors the logic of `hnt_h_suf`, but searches the deleted orders file.
- Searches both the current and previous year.

---

## Business/Domain-Specific Logic

- **Suffix Uniqueness**: Suffixes must be unique per order number, across current, historical, and deleted records.
- **Year Handling**: Historical and deleted tables are partitioned by year; both current and previous years are checked to avoid collisions.
- **Suffix Range**: Suffixes are in the range 0–99. If the next available suffix exceeds 99, it wraps to 0.
- **Order of Precedence**: The program first checks current orders, then historical, then deleted. The highest found suffix is incremented, unless already used in current orders.

---

## Design Decisions & Patterns

- **Key Lists**: All file accesses use explicitly defined key lists for clarity and maintainability.
- **Subroutine Structure**: Suffix-finding logic is encapsulated in subroutines, making it easier to maintain and extend.
- **Wrap-Around Handling**: Explicit logic ensures that suffixes do not overflow the allowed range.
- **Double-Check Loop**: The program loops to ensure that the selected suffix is not already in use in the current orders table, incrementing until a free value is found.

---

## File Relationships

- **BESTILLING-HODE-REGISTER**: Active orders, checked for existing suffixes and to ensure uniqueness.
- **SIHE**: Historical invoices, checked for previously used suffixes (to prevent reuse).
- **LDEL**: Deleted orders, checked for previously used suffixes (to prevent reuse).

---

## Conventions

- **Norwegian Naming**: Variable and comment language is Norwegian, reflecting the business domain and user base.
- **Suffix Handling**: All suffix variables are consistently named (`*_suff`), and all key variables are prefixed with their related file.
- **Record Renaming**: Files are renamed on input for clarity and to avoid conflicts.

---

## Integration Points

- **Input/Output Parameters**: The program is typically called with an order number; it returns the next available suffix.
- **Data Area Usage**: The program expects certain values (e.g., firm number) to be set in the local data area.
- **External Table Dependencies**: The logic is tightly coupled to the structure and content of the BESTILLING-HODE-REGISTER, SIHE, and LDEL tables.

---

## Summary

AS115R is a utility program for managing order suffixes, ensuring uniqueness across current, historical, and deleted orders. Its logic is robust against collisions and wrap-around scenarios and is structured to be maintainable and extensible. The program is central to order lifecycle management, preventing accidental reuse of suffixes and ensuring data integrity across the system.