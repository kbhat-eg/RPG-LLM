# Explanation of RPG Program JM110R: Vedlikehold av kampanjepriser

This ILE RPG program is part of the ASVADM system, and its purpose is to maintain (create, view, update, and delete) campaign prices for items (`Vedlikehold av kampanjepriser`). The design is modular and has grown over many years with enhancement version numbers and developer annotations. User interface interaction is through display files (subfiles), program calls, and indicators for screen handling.

## Major Functional Overview

- **Display and manage campaign prices** for items in a subfile-based work screen.
- **Support CRUD operations:** Add, copy, edit, delete, and view items.
- **Calls out to a variety of external programs** for additional maintenance, validation, or calculation.
- **Handles campaign information** (firm, campaign code, price group, supplier, etc.).
- **Various configuration switches/parameters** are dynamically loaded to alter operational logic.

---

## 1. File Definitions (`F-spec`)

```rpg
fjkavlr    if   e           k disk    rename(jkavpfr:jkavlrr)
fjkavlu    uf a e           k disk    rename(jkavpfr:jkavlur)
fjkavl1    if   e           k disk    rename(jkavpfr:jkavlr1)
fjkavl2    if   e           k disk    rename(jkavpfr:jkavl2r)
fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
...
```

- Multiple physical and logical files are defined, often using `rename()` to map to record-level formats specific to purpose (e.g., reading, updating, searching, etc.).
- The display file (`jm110d`) includes subfile `b1sfl`, with indicators for display feedback (`infds`).

---

## 2. Data Definitions (`D-spec`)

- **Program parameters** (e.g., `p_firm`, `p_kamp`, `p_prgr`, etc.) are often defined as local variables using `like()` to tie types to database fields.
- **Local data area** (LDA) fields are mapped using `uds` for user, file group, etc.
- **Variables** for handling subfile navigation, mode flags (operation, error, function key pressed), and screen/field values (item, price, supplier, text, etc.).
- **Constants** (e.g., `c_sfil = 12`) control subfile page size.
- **Toggle switches** (`u_701`, `u_702`) for enabling/disabling specific features, set at runtime via external configuration program `CO402R`.

---

## 3. Key Lists (`KLIST`)

- Various composite keys are defined for database operations: e.g., by firm/campaign/item, by supplier, etc.
- Used for positioning (`SETLL`, `CHAIN`), searching, and maintaining database integrity.

---

## 4. Main Program Flow

### Initialization (`*INZSR`)

- Receives parameters (firm, campaign, price group).
- Calls out to `CO402R` for configuration (e.g., allow cost price zero, enable DG calculation).
- Reads "campaign header" from `jkahl1`.
- Loads tax rates (mva, VAT) and default warehouse.
- Starts with positioning and subfile creation.

---

### Main Control Loop

- **Tag-Driven:** The logic is managed by named tags (`b2taga`, `b2tagb`, `avslutt`, etc.) and `GOTO` or `EXSR` to subroutine blocks.
- **Subfile management:** Display, clear, fill, navigate ("roll up/down"), handle user-selected actions.
- **Function Key Handling:** Each function key is mapped to a specific operation:
    - F3/F12: Exit
    - F4: Inquiry
    - F5: Refresh
    - F6: Create new record
    - F10/F11: Page Up/Down
    - F14, F13, F16, F17, F18, F20: Specialized operations (call other programs for batch processing, group handling, status codes, etc.)

---

### Subfile Processing

- **Actions are selected per-row** in the subfile (edit, copy, delete, view, maintain, etc.), via the `b1valg` field.
- For each selected action, the corresponding subroutine is triggered:
    - **Edit/View:** `xc2bld`
    - **Copy:** `xk1win`
    - **Delete:** `xd1win`
    - **Maintain item or conditions:** calls external programs (e.g., `JV101R`, `JP500R`, `JX100R`, `JW100R`)
- **After each operation**, the subfile row is updated and the action code reset.

---

### Add/Edit/View Screen subroutines

- **xc1bld:** Handles the creation of new entries.
    - Inquiry, validation, duplicate checks.
    - Calls edit/view logic for maintenance.
- **xc2bld:** Handles edit/view for selected entries.
    - Fetches and sets all relevant fields (prices, item/supplier info, VAT, etc.).
    - Performs validation (dates, required fields, price logic).
    - On successful update, writes changes to the database.
    - Handles cost margin/DG calculation if enabled (u_702).
- **xk1win / xd1win:** Handle copy and delete window logic with appropriate checks.

---

### Inquiry Functionality (`spørring`)

- Used for lookup of items or suppliers by field name context, calling out to helper programs (`JV500R`, `JL500R`).

---

### Special Features

- **DG Margin Calculation:** If enabled, calculates margin percentage based on price and cost.
- **NOBB Info Display:** F-key triggers info call for NOBB standard (Norwegian building goods code).
- **Configuration-Driven:** Several operational switches (`u_701`, `u_702`, `u_utgd`) control behavior at runtime.
- **Subfile Paging:** Manage subfiles for smooth paging, positioning, and display.

---

### SQL Integration

- Several newer routines (e.g., `hent_evr`, `hent_laglev`) use embedded SQL to fetch specific values from the database, supplementing traditional record-level access.

---

## 5. Error and Message Handling

- **Indicators 31-79** are used to signal and control error/warning messages on screen.
- Error paths and validation messages are handled locally within each subroutine.

---

## 6. Subroutines and Calls

- **External Programs:** Many specialized maintenance operations are delegated to other RPG programs, enhancing modularity and separation of concern.
- **Subroutines:** Standard RPG `BEGSR`/`ENDSR` blocks with named entry points handle logic for key steps, such as:
    - Subfile maintenance (`clr_subfile`, `crt_subfile`, `bck_subfile`, etc.)
    - Add/Edit/View/Delete (`xc1bld`, `xc2bld`, `xk1win`, `xd1win`)
    - Data and configuration fetching (`hent_pris`, `hent_evr`, `hent_laglev`)
    - Inquiry and special info (`spørring`, `vis_nobb`)
---

## 7. Structure and Coding Style

- **Comment blocks** are extensive and document both logic and operational behavior, including screen field conventions and enhancement history.
- **Version/Change log:** Indicates a long-lived production program under active maintenance.
- **Legacy & Modern RPG Mix:** Traditional RPG C-spec code (fixed format) is mostly used, with some free-form and modern enhancements (such as `DCL-S` and SQL).

---

## 8. Typical Use/Workflow

- A user enters the campaign pricing maintenance screen—sees a list of items.
- Navigates using subfile paging.
- Chooses to add, edit, view, copy, or delete campaign price records for an item.
- May invoke external programs for related maintenance, group operations, or status information.
- Operations are validated, saved, and the subfile is refreshed with updates.

---

## 9. Key Takeaways for New Developers

- **Understand the subfile UI model** on IBM i: much of the program is about handling the subfile and screen interaction.
- **Know the business rules** related to campaign pricing—many validations and configurations are embedded in the logic.
- **Familiarize with the related external programs** (`JV500R`, `JP500R`, `AP633R`, etc.)—they provide specialized item, pricing, or supplier maintenance.
- **Review configuration switches** (`u_701`, `u_702`, `u_utgd`) as they alter critical control paths at runtime.
- **Follow the comments and version annotations** for historical context and understanding code evolution.

---

### Summary Table of Key Function Keys and Actions

| Key      | RPG Indicator | Action/Program Called              |
|----------|---------------|-----------------------------------|
| F3/F12   | *INKC/INKL    | Exit                              |
| F4       | *INKD         | Inquiry                           |
| F5       | *INKE         | Refresh subfile                   |
| F6       | *INKF         | Add (call `xc1bld`)               |
| F10      | *IN10         | Page down (load next subfile page)|
| F11      | *IN11         | Page up (load previous page)      |
| F13      | *INKM         | Status codes (`JM112R`)           |
| F14      | *INKN         | Batch cost price update (`JM113R`)|
| F16      | *INKQ         | Group maintenance (`JM114R`)      |
| F17      | *INKR         | Group search/selection (`JM115R`) |
| F18      | *INKS         | Export from campaign (`JM550R`)   |
| F20      | *INKU         | Start transfer (`JM119R`)         |

---

**In summary:**  
This program is an RPG-based user interface for campaign price maintenance, heavily reliant on subfile techniques, modular in external program calls, and adaptable via configuration switches. The logic is well-annotated for navigation, error-handling, and function key mapping, providing a robust (if complex) foundation for campaign price management on IBM i systems.