# Explanation of ILE RPG Source Code: Kontoll av sist brukte kontaktpersonnummer

This program is an ILE RPG application named **RS003R**. Its primary function is to determine and update the last used contact person number (`kontaktpersonnummer`) for a company ("firm"), ensuring uniqueness and correct sequential use. This is especially useful in ERP, CRM, or other business systems for managing master data integrity.

Let’s break down the code for developer onboarding:

---

## 1. **Header and Documentation**

The comments at the start document:
- **System**: ASOKON
- **Program**: RS003R
- **Description**: Fetches the last used contact person number.
- **Modification Logging**: There’s structure for logging changes, though currently empty.

---

## 2. **File Specifications**

```rpg
fraa4l1    if   e           k disk    rename(raa4pfr:raa4l1r)
fraa4lu    uf   e           k disk    rename(raa4pfr:raa4lur)
frukpl2    if   e           k disk    rename(rukppfr:rukpl2r)
```
- **fraa4l1 / fraa4lu:** Logical files (input, full procedural, keyed) over the `raa4pfr` physical file, renamed to record formats `raa4l1r`/`raa4lur`.
- **frukpl2:** Logical file for the contact person register, over `rukppfr` with record format `rukpl2r`.

---

## 3. **Variables**

```rpg
d p_retk          s              1
d p_4pnr          s                   like(ra4pnr)
d w_firm          s                   like(ra4fir)
d w_test          s                   like(p_retk)
d w_4pnr          s                   like(ra4pnr)
d w_kpnr          s                   like(rukpnr)
d rukpl2_kpnr     s                   like(rukpnr)
d raa4l1_4aar     s                   like(ra4aar)
d raa4lu_4aar     s                   like(ra4aar)
```
- **p_retk**: Return code passed in/out.
- **p_4pnr**: Parameter for current contact person number.
- **w_firm**: Current company (firm) code.
- **w_test**: Working return code.
- **w_4pnr/w_kpnr**: Working numbers for contact person.
- **rukpl2_kpnr**: Used for keying into contact register.
- **raa4l1_4aar/raa4lu_4aar**: Year fields for status code files.

---

## 4. **Main Logic**

### Initialization

```rpg
c                   move      p_retk        w_test
c                   eval      p_retk = *blank
c                   eval      raa4l1_4aar = 0
c     raa4l1_key    chain     raa4l1r                            90
```
- Stores the incoming return code into a working variable (`w_test`) and blanks `p_retk`.
- Initializes the key used to find the last used contact person number (`raa4l1_4aar = 0`), then does a keyed read (`chain`) to fetch the record.

### Handling Missing Record

```rpg
c                   if        *in90 = *on
c                   move      'N'           p_retk
c                   goto      xslutt
c                   endif
```
- If not found (`*IN90` = on), returns 'N' and ends.

### Determining the Next Contact Person Number

```rpg
c                   if        w_test = *blank
c                   eval      w_4pnr = ra4pnr + 1
c                   endif

c                   if        w_test = 'S'
c                             and p_4pnr = ra4pnr
c                   eval      w_4pnr = ra4pnr - 1
c                   endif

c                   if        w_test = 'K'
c                   eval      w_4pnr = p_4pnr
c                   endif
```
- **Blank**: Use next sequential number.
- **'S'**: If instructed (“S” for "slettet"/delete?) and the number matches, decrement.
- **'K'**: Use provided number.

### Finding a Free Contact Person Number

```rpg
c                   eval      w_kpnr = w_4pnr
c     finnes        tag
c                   eval      rukpl2_kpnr = w_kpnr
c     rukpl2_key    chain     rukpl2r                            90
c                   if        *in90 = *off
c                   eval      w_kpnr = w_kpnr + 1
c                   goto      finnes
c                   endif
```
- Loops, incrementing `w_kpnr` until a unique number is found (not already in use in the contact person register).

### Updating the Last Used Number

```rpg
c                   eval      raa4lu_4aar = 0
c     raa4lu_key    chain     raa4lur                            90
c                   if        *in90 = *off
c                   if        w_kpnr > ra4pnr
c                   eval      ra4pnr = w_kpnr
c                   endif
c                   if        w_test = 'S'
c                             and p_4pnr = ra4pnr
c                   eval      ra4pnr = w_4pnr
c                   endif
c                   update    raa4lur
c                   endif
```
- If a record exists, updates the last used number if the new value is greater, or decrements if needed (per business logic).
- Writes the update back.

### Return Values

```rpg
c                   eval      p_4pnr = ra4pnr
c                   eval      p_retk = ' '
```
- Sets the output parameters for the caller: the new contact person number and an (assumed successful) return code.

---

## 5. **Program End**

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Ends the program, setting the LR (Last Record) flag for proper closure.

---

## 6. **Initialization Subroutine (`*inzsr`)**

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_retk
c                   parm                    w_firm
c                   parm                    p_4pnr
...
c                   endsr
```
- Standard RPG subroutine to initialize variables and parameter lists.
- **Keys** for record access are set up here, using `klist` and `kfld`.

---

## 7. **Summary**

- **Purpose**: Sequentially determines the next available contact person number per company, ensuring no duplicates, updates the "last used" number, and responds to different business logic conditions (like deletion or direct number assignment).
- **Files Used**:
    - Master file for contact persons (`raa4l1r`, `raa4lur`)
    - Register of existing contact persons (`rukpl2r`)
- **Typical Use**:
    - Called as a service program from another application, receiving parameters (return code, firm, last number used), and returning the new last used number and status.

---

**For onboarding**:  
- Familiarize yourself with the file structures (`raa4pfr`, `rukppfr`).
- Understand the company's numbering policy for contact persons.
- Note the use of "test" modes (`w_test`) to support different operational modes (possibly: blank = add, S = delete, K = direct assign).
- All database actions are performed via RPG's classic native IO operations (`chain`, `update`).

---

**Typical Call Sequence:**
1. Input: current company, last used number, action code.
2. Program:
    - Determines next logical available number.
    - Ensures the number is unique in the register.
    - Updates the master file with the new number.
    - Returns the assigned number and status.

---

If you need more specifics about file fields (e.g. types/lengths of `ra4pnr`, `rukpnr`), refer to the DDS for `raa4pfr` and `rukppfr`.