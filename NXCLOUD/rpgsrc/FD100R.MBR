     h option(*nodebugio : *srcstmt) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : FD100R
      * Beskrivelse . . : Ordre-linje, registrering av tilbud/ordre
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       030402 HKO  Skrevet om programmet
5.01  * R5.01 241002 AMD  Lagt om rutiner for oppdatering av lager
5.02  * R5.02 190603 AMD  Lagt inn varsel ved sletting av ordrelinjer
      *       100703 HKO  Lagt inn test før deling på fdsums
5.31  * R5.31 100104 ASK  Lagt inn endringer for lager på linjenivå.
      *       140504 HKO  Utvidet parametre ved overgang til skafferegister
      *       110804 HKO  Viser ordre-linje selv om dette er første linje i
      *                   tabellen
5.32  * R5.32 030604 GRO  Lagt til sletting av lengdespesifikasjoner
      *       051005 HKO  Utvidet subfilen til 7 linjer
      *                   Viser slettede varer med ** SLETTET VARE ** i
      *                   vareteksten
      *       141005 HKO  Spørring/registrering av salg fra statistikk
      *       271005 HKO  Fjernet funksjonstaster for rabattmatrise og
      *                   spesialpriser og lagt inn logikk for å vise
      *                   salgspris og DG etter bonus via F1
      *                   Dersom kunden inngår i en bonusavtale vises dette
      *       311005 HKO  Lagt inn funksjonstast for å sette i bestilling
      *       091105 HKO  Viser informasjonsmelding dersom orderen
      *                   inneholder slettede varer
5.51  *       101105 AMD  Henter mobilnummer fra :
      *                     - Kunde dersom det finnes der
      *                     - Kundeprosjekt dersom det finnes der
      *                     - Ordrehode dersom det finnes der
5.52  * R5.52 020106 AMD  Lagt inn spørremuligheter (F4) i skjermbilde
      *                   for innsetting av varelinjer
      *       160206 HKO  Endret avslutingsbilde til også å ta hensyn til
      *                   overgang til bestilling og plukking av via
      *                   kjørekontorløsning
      *       100306 HKO  Viser ikke "Til bestilling" i avslutingsbildet
      *                   dersom behandlignskode <> 1
      *                   Sperrer også for overgang til bestilling
5.53  * R5.53 210307 AMD  Lagt på mva på memosaldo for å få riktigere
      *                   beregning av kredittgrense
5.54  * R5.54 270307 AMD  Bygget om kjørekontorløsningen til å benytte
      *                   loggfilen i stedet for infokodene
5.60  * R5.60 061107 AMD  Lagt inn løsning for kontroll av grense for
      *                   almenningsrabatter
5.61  * R5.61 070108 bof  utvidet loggfil med år
5.62  * R5.62 310108 bof  Hvis til plukking sett loggk.før evt. plukkl.
5.63  * R5.63 150208 AMD  Lagt inn logging av slettede ordrelinjer
5.64  * R5.64 120308 AMD  Lagt inn varsling ved overskridelse av grense
5.65  * R5.65 230608 bof  Setter kode 0 i loggkode hvis kjørek. er valgt
      * 6.10  230609 BSA  Oppdatert med sporingsinformasjon
6.11  * 6.10  290609 bof  Utivdet eannr til 14 og brukt std. oppslag
6.11  * 6.10  220909 ASK  Nye parametre til VL001R
6.12  * 6.10  201109 bof  Utivdet parameter med ean-nr til fd105R
6.13  * 6.10  280109 bof  Tester på om kreditgrense er låst
6.14  * 6.14  260310 AMD  Lagt inn varsel på ordre m/varelinjer u/moms
6.20  * 6.20  161110 bof  Hvis klar til plukking, evt. splitt av ordre
6.21  * 6.20  100311 nho  Vise varer som er tilkn.varegr for transport
6.22  * 6.20  140611 bsa  Memosaldo ligger på egen file
6.23  * 6.20  071111 BOF  Parameterstyre om ordre skal splittes pr.lager
6.24  * 6.20  120312 BOF  6.21 skal kun gjelde ordretyper med pos.fortegn
6.25  * R6.20 140112 bof  Mulighet til å legge ut ByggDok innsamling
6.26  * R6.20 040113 bof  Henter byggdok - kode fra FKPRPF
6.NU  * R6.30 230514 bsa  Endringer grunnet nummerutvidelser
6.30  * R6.30 060814 bsa  Varefeltet skal fungere som varesøk, hvis
6.30  *                   eksakt vare ikke finnes.
6.31  * R6.30 080814 bsa  Innført sjekk av saldofelt mot origo
6.31  *                   Utvider nøkkel til å være unik ved sjekk mot
6.31  *                   origo.
6.32  * R6.30 110814 bsa  Innført sjekk om kortmodul er innstallert
6.33  * R6.30 280814 bkv  Sett inn linje fra skafferegisteret
6.34  * 6.30  221014 BKV  Søtte for cobuilder
6.35  * 6.30  110615 BKV  Liten fiks på: Varefeltet skal fungere som varesøk
6.36  * 6.30  191015 Bsa  Sjekk kortkoden mot lager, deretter lager 0 hvis
6.36  *                   det ikke finnes.
6.37  * 6.30  191015 Bsa  Utvidet felt i parameterliste
6.38  * 6.30  101215 Bsa  Utvidet streng for saldosjekk med firma og avdeling
6.39  * 6.30  210316 bof  Hvis varen ligger i EVR skal lager oppd. selv om fdlvr = 1
6.3a  * 6.30  200516 nho  Skal ikke innom JVARL1 dersom vare finnes i
      *                   eget vareregister
6.3b  * 6.30  220616 bof  Kan ikke endre parm i VV500r, det er brukt i veldig
      *                   mange progrm. Har endret her tilVV501R
6.3c  * 6.30  290616 bof  Rettelse vedr. Cobuilder
6.3d  * 6.30  040716 bof  Skal ikke kunne bruke std.varenr fra SHOP.
6.3e  * 6.30  050716 bof  Byggdok/Cob. skal evt. ta mailadr. fra kundeprosjekt
6.3f  * 6.30  020816 bof  Hvis krav om depositum, så gi melding hvis ikke innbetalt.
6.3g  * 6.30  111016 bof  Rettelse av 6.3d
6.3h  * 6.30  060417 bof  Ved legg til skal lev.type bli med fra heading
6.3i  * 6.30  140318 nho  Kun vedl tekstlinjer dersom kreditgrense overg
6.3j  * 6.30  050718 bkv  Hvis rkmems blir for høy
6.3k  * 6.30  070918 bkv  Kommentert ut parameter som er lagt inn ved feil
6.3l  * 6.30  151018 bof  utvidet med trelast-sortiment
7.xx  * 7.00  220116 bsa  Endringer reltart til ny GUI. NB Kan kun gjelde DDS
7.01  * 7.00  250817 bkv  Hvis DG F1, last hele subfil på nytt
7.02  * 7.00  250518 bkv  Endret i DDS: &W_ARCD &W_AFLD, unike variabler pr bilde
7.03  * 7.00  170818 bkv  PgDn var disablet...
7.04  * 7.00  170318 bkv  Konfigering om depositum sjekk skal gjøres. Default *on
7.05  * 7.00  101218 bkv  Konfigering om gavekort fra shop er lov     Default *off
7.06  * 7.00  100119 bkv  Laster subfil på nytt, ved direkte søk
7.08  * 7.00  060319 bkv  Retter feil i farger + kundetilp. av farger
7.09  * 7.00  230319 bkv  Fjerner tegn som skaper problmer for Newlook
Q.01  * 7.00  080219 bsa  Quick wins - skrevet om til å bruke 27x132 størrelse
Q.02  * 7.00  080219 bsa  Quick wins - Utskrift, forh.visning og e-post - valg 1,2 og 3
Q.02x *       150519 bsa  QW - Må lagre og summere opp ordren, hvis ikke mangler totaler.
Q.03  * 7.00  140219 bsa  Quick wins - Settes klar til plukking - valg 4
Q.04  * 7.00  010319 bsa  Quick wins - Bytte kunde - valg 5
Q.05  * 7.00  210319 bsa  Quick wins - Skrive ut kollietiketter - valg 6
Q.06  * 7.00  210319 bsa  Quick wins - Legger til vare for transport automatisk
Q.07  * 7.00  250319 bsa  Quick wins - Legger til vare på bestilling automatisk
Q.08  * 7.00  270319 bsa  Quick wins - Lagrer ordre uten spm, og går ut. Ref
Q.08  *                   dagens F5 fra bestilling. - valg 7
Q.09  * 7.00  270319 bsa  Quick wins - Sende SMS fra ordreregistrering - valg 8
Q.10  * 7.00  020419 bsa  Quick wins - Prisbekreftelse pakkseddel - valg 9
Q.11  * 7.00  020419 bsa  Quick wins - Sette ordren som utlevert - valg 10
Q.111 * 7.00  270619 bsa  Quick wins - skal ikke avslutte hvis feil ordretype
7.10  * 7.00  090519 bkv  Mail ved overføring til kjørekontor Kirkenes
7.11  * 7.00  070619 ask  Fjernet visning av DG inkl kundebonus.
7.12  * 7.00  070619 bof  Fjernet direkte kall FO788R, kalles i egen rut.
7.13  * MGR   070619 sst  Ber flytende Memosaldo m/ordre pr ant. dager
      *                   Hente parameter meosaldo fra AFPSPF
7.14  *       070619 ask  Fjernet mulighet for å legge hovedordre til plukking
7.15  *       070619 ask  Fjernet mulighet for å plukke hovedordre til bestilling
7.16  *       070619 bof  Setter indikator slik at bonustekst aldri vises.
7.17  *       070619 bsa  Kaller program for kalkulering av priser ved
      *                   registrering av varelinjer.
7.18  *       070619 bsa  Sletter evnt info fra skyggetabell
7.19  *       020719 bkv  C36 tilpasninger:
      *       251007 TSV  Lagt inn bilde med ekstra ordreinfo på CF15
      *       100308 ASK Lagt inn fast valg 1=Utskrift ved ordreavsl.
      *       071112 AMD  Lagt inn ny parameter for oppkall av fd105r
      *       051017 NHO  Har tatt bort ny call til *inkp
7.20  *       160819 bkv  Lagt inn slettet vare
7.21  *       270819 bsa  Klar for plukking skal ikke vises hvis ordre
7.21  *                   har leveringstype 1.
7.22  *       270819 bkv  Vis vare mot transport i QW
7.23  *       130919 bkv  Korrigerer vising av desimal tall
7.24  *       160919 nho  Sletter linje fra tilleggsregister på linja
7.25  *       111119 bkv  Utvider til 132 bilde
7.26  *       121119 bsa  Mulighet til å bytte varenummer. Brukes primært
7.26  *                   hvor det skal sendes elektronisk ordrebekreftelse
7.26  *                   og vi ønsker spore linjenummer.
7.27  *       191119 bkv  Newlook vask
7.28  *       131219 bkv  Newlook vask
7.28a *       211119 bsa  Fjernet oppslag mot ZI110R. Kun for MGR når det er
7.28a *                   aktuelt. Ønsker ikke program i korr (for øyeblikket)
7.29  *       171019 sst  F17 Hente varelinjer fra budsjett prosjekt mgr
7.30  *       270320 sst  F19 Hente varelinjer fra excel  nx:'FD100R_EXCEL'
7.31  *       240420 ask  Lagt inn flagging av tilbud til Proffportal
7.2A  *       030120 bkv  Viste ikke negativ DB
7.2B  *       060120 bof  Validering på avdeling, Gipling
7.2C  *       070120 bkv  Gjort om F1
7.2D  *       130120 bkv  Ikke vise F8 knapp hvis Solve VA
7.2e  *       130120 bsa  Feilmelding ved scroll
7.2f  *       150120 bkv  Rettet feil ved bruk av F4 og F8.
      *                   Skal vises sist innlagte linjer
7.2g  *       150120 bkv  Mer vasking newlook b1tex1
7.2h  *       170120 bkv  Endret visning av beholding/DG
7.2i  *       290120 bkv  Hvis Solve Va. Rekalkuler ordre ved F5
7.2j  *       110220 bkv  Sjekk om sperrekode også ved hurtigavslutt
7.2k  *       190220 bkv  Mer vasking newlook b1tex1....
7.2l  *       180320 sst  Åpne for endre tekstlinjer på pakkseddel selv om
      *                   bruker er sperret for endring av pakkseddel
7.2lx *       190320 ask  Lagt inn fargestyring basert på kode i sortimentfeltet på VVARPF
7.2lx *                   Dette er switch-styrt med koden kode "FARGE_SKAFF_SORTIMENT"
7.2lx *                   Denne koden overstyrer fargestyring
7.2m  *K00    190820 bof  Rettelse i vis av DG (ref. 7.2h)(Justert bsa)
7.2n  *K00    040920 bof  Ved prisbekreft - kjør rekalk ordre først
7.2o  *K00    080920 bof  Mva behandling av varer som kommer fra Solve
7.2p  *K00    100920 ask  Viser kun farge på linje fra sortiment dersom
7.2p  *K00                skaffevare (HKO på ASKUND_KMM)
Q.081 *K00    081220 bsa  Sjekker om det er overskredet kreditgrenser ved
Q.081 *K00                hurtigavslutning.
7.2q  *K00    101220 bsa  Hvis ordren er sperret for å sendes til plukking
7.2q  *K00                må det også sjekke ved hurtigtast (Q.03)
7.2s  *K000   291220 bsa  Flyttet på kundenummer da siste siffer forsvinner
7.2s  *K000               i cloud. Endring kun i dspf.
7.2t  *K00    051020 ask  Endring av varenummer med rekalkulering fra B2C
7.2u  *K000   150121 bsa  Mulighet for skrive ut plukkliste direkte. Styres av switch
7.2u  *K000               for å forenkle prosesse. Ikke tenkt for de som kjører
7.2u  *K000               kjørekontor osv.
Q.082 *K00    090221 ask  Lagt inn flagg på kredittgrense kontroll for hurtigavslutning
Q.083 *K00    150421 bsa  Må bergne ordretotal før kreditgrensekontroll ved
Q.083 *K00                hurtigavslutning. Hvis ikke blir ikke nye ordre med i
Q.083 *K00                ordretotalen.
Q.041 *K000   160421 bsa  Flytter sjekken på depositum ved bytte av kunde
7.2v  * K000  140521 bsa Henter disponibel beholdning basert på leveringsdato
7.2v  * K000             fra ordren. Farge settes rød hvis negativ beholdning.
7.2v  * K000             kan forvirre når både utgått vare og negativ beholdning
7.2v  * K000             gir rød farge. (47)
      *
7.fb  * 7.00  061216 bof  Forskuddsbetaling
7.f1  * 7.00  050517 bof  Utivdet parameter fd105R, erstatte varelinj.
7.f2  * 7.00  200318 bof  Dep.må beregnes på nytt ved utg.hvis ikke loggk.=1 + feilr.
7.f3  * 7.00  220318 bof  Det skal være farge på lik linje med FO500R
7.f4  * 7.00  300320 bsa  Hvis forskuddsbetalt ordre, skal det ikke være mulig å legge
7.f4  * 7.00              til nye linjer.
7.f5  * 7.00  170620 bsa  Endret måte å legge inn depositumskrav.
7.f6  * 7.00  190620 bsa  Hvis det skal være forskudd, og verdien av ordren er endret
7.f6  *                   skal det få spm om depositumskrav skal reberegnes.
7.f7  * 7.00  190620 bsa  Valg 6 skal ikke vises før det er 100% innbetalt.
7.f8  * 7.00  180920 bsa  Endrer betingelser for om krav til depositum skal skje.
7.f9  * 7.00  180920 bsa  Skal ikke få legge inn depositum før det finnes varelinjer
7.f9  * 7.00              på ordren.
7.f0  * 7.00  180920 bsa  Gi mulighet for å slette depositum.
7.fa  * 7.00  210920 bsa  Reduserer antall tegn i felt til 2. Eget felt for 100%
7.fa  * 7.00              forhåndsbetaling.
7.fc  * 7.00  220920 bsa  Låser muligheten for å slette og endre depositum etter
7.fc  * 7.00              det er innbetalt.
7.fd  * 7.00  220920 bsa  Sender info om depositum med til linjeprogrammer.
7.fe  * 7.00  021020 bsa  Må sjekke mot krav til laveste grense for om depositum skal
7.fe  * 7.00              kunne opprettes.
7.ff  * 7.00  051020 bsa  Takle om varesøk kommer fra skaffereg.
7.fg  * 7.00  201120 bsa  Endrer måten å sjekke mot depositum på, ved nyopprettelse.
      *
Q.042 *K000   160621 bsa  Setter ikke adressefelter, hvis det ikke ligger noe
Q.042 *K000               der fra før.
      *
8.01  *K00    061021 bof  Ved F8 til Solve, så skal ordre rekalkuleres ved kall til FO730R
8.02  *K00    170122 bsa  Forviklinger med bruken av indikatorer.
8.03  *K00    070322 sst  Lagt inn flere f-taster vedr 7.2l
8.04  *K00    131221 bof  Ved F8 til Solve, kalles eget program for rekalk FO731
8.05  *K000   110122 bsa  Legg ut varekunde hvis både varekunde, fakturakunde og prosjektnr.
8.06  *K000   250522 bsa  Legger ut suffiks i bildet.
8.07  * K000  231122 sst  Flyttet ant memo-dager og utv.kreditgrense til  UTVIDET_MEMOSALDO (nx)
8.08  * K000  281122 sst  Endret U_713 til U_KMEM vedr begr.memoslado til UTVIDET_MEMOSALDO (nx)
8.09  * K000  150223 sst  Tillate reg/enddring av D-linjer selv om Depositum er betalt.
8.10  * K000  010323 sst  Justering qav logikk i 8.09 fra MKR
8.11  *(8.15) 210223 sst  Justering av beregning aktuell saldo og memosaldo
8.12  *(8.16) 010323 sst  Beregning av memosaldo m/memodager og %utv.
8.13  *K0000  200323 bsa  Fjerner endring 8.06, da dette skaper problemer i newlook.
8.14  *K0000  100423 bof  NXS_16537 Ikke tillatt med søk i VA hvis SOlve flagg på (*in56 på)
8.15  *K00    310323 sst  Ikke godkjenne enkeltordre over kreditgrense uansett dato.
8.16  *K00    310323 sst  Legge inn logikk fra 8.15 også ved kopiering av T til P/O.
8.17  *K00    270623 mst  Feil sum ved hurtigknapp 'Klar til plukking'
8.18  *K00    091123 bsa  Hvis du søker på logistikkvarenummer, skal
8.18  *K00                du ikke få treff. Hvis varen er en del av en
8.18  *K00                logistikkvare, men ikke ligger i EVR.
8.19  *PRG2   210622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner
8.23  *       140524 ask  Fjernet skriv til ByggDok fil (FBDOPF)
8.24  *K00    260824 bsa  Justert søk mot logistikkvarenummer.
8.25  *K0000  040924 bsa  Hvis ikke koblet nobbnummer til logistikkvare
8.25  *K0000              er angitt nobbnummer, gi varsel.
8.26  *K0000  221124 bsa  Rekalkuler ordre etter F6/DG.
8.27  *K0000  200225 bsa  Rekalkuler ordre etter F6/DG, også etter F10.
8.28  *K0000  310325 bsa  Legger inn switch, slik at du kan bytte kundenummer
8.28  *K0000              selv om den er tilknyttet bestilling.
      *
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
6.22 frkmel1    if   e           k disk    rename(rkmepfr:rkmel1r)
     frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvvarl4    if   e           k disk    rename(vvarpfr:vvarl4r)
     fvltpl1    if   e           k disk    rename(vltppfr:vltpl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
7.fb ffst2l1    if   e           k disk    rename(fst2pfr:fst2l1r)
7.fb fsdeplu    uf a e           k disk    rename(sdeppfr:sdeplur)
     flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
     ffusrl1    if   e           k disk    rename(fusrpfr:fusrl1r)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffohelu    uf   e           k disk    rename(fohepfr:fohelur)
     ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
     ffodtlr    if   e           k disk    rename(fodtpfr:fodtlrr)
     ffodtlu    uf   e           k disk    rename(fodtpfr:fodtlur)
5.51 ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
5.32 ffvlslu    uf a e           k disk    rename(fvlspfr:fvlslur)
6.21 fra17l1    if   e           k disk    rename(ra17pfr:ra17l1r)
6.25 fafpslr    if   e           k disk    rename(afpspfr:afpslrr)
6.25 famodl1    if   e           k disk    rename(amodpfr:amodl1r)
6.25 frukpl6    if   e           k disk    rename(rukppfr:rukpl6r)
7.2B favall1    if   e           k disk    rename(avalpfr:avall1r)
6.31 frukrl5    if   e           k disk    rename(rukrpfr:rukrl5r)
6.31 fruksl1    if   e           k disk    rename(rukspfr:ruksl1r)
6.25 ffbdopf    o  a e           k disk
6.33 fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
6.3d fbstsl1    if   e           k disk    rename(bstspfr:bstsl1r)
6.3f fsdepl1    if   e           k disk    rename(sdeppfr:sdepl1r)
7.f0 fsdeplr    uf   e           k disk    rename(sdeppfr:sdeplrr)
7.08 fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
7.08 fjlevl3    if   e           k disk    rename(jlevpfr:jlevl3r)
7.08 fjvlel1    if   e           k disk    rename(jvlepfr:jvlel1r)
Q.03 ffloglr    if   e           k disk    rename(flogpfr:floglrr)
Q.04 flohel1    if   e           k disk    rename(lohepfr:lohel1r)
Q.07 flodtlc    if   e           k disk    rename(lodtpfr:lodtlcr)
7.18 ffodmiu    uf   e           k disk    rename(fodmst:fodmiur)
7.24 ffod2lu    uf   e           k disk    rename(fod2pfr:fod2lur)
7.26 feddtl2    if   e           k disk    rename(eddtpfr:eddtl2r)
7.26 feddtl3    uf   e           k disk    rename(eddtpfr:eddtl3r)
7.2o fvmval1    if   e           k disk    rename(vmvapfr:vmval1r)
      *
     ffd100d    cf   e             workstn sfile(b1sfl:w_srrn)
     f                                     infds(dspfbk)
      *
      * Definering av parametre
      *
     d p_firm          s              3  0
6.NU d p_numm          s              8  0
     d p_stat          s              1
     d p_suff          s              2  0
Q.09 d p_syst          s              1
7.30 d p_numx          s              8
7.30 d p_sufx          s              2
      *
      * Definering av Local Data Arae (LDA)
      *
     d                uds
5.54 d l_wsid                901    910
     d l_user                911    920
6.25 d l_filg                931    933
5.54 d l_firm                944    946  0
     d l_fnav                951    980
      *
      * Definering av Information Data Structure - display feedback
      *
     d dspfbk          ds
     d  d_fcrn               378    379I 0
      *
7.06 d ProgStatus     sds
7.06 d CurPgmNam               1     10
7.06 d CurPgmLib              81     90
      *
      * Datastrukturer
      *
      * Datastruktur for Ean128 - kode
      *
     d                 ds
     d d_e128                        26
6.11 d  d_fast                        2  0 overlay(d_e128)
6.11 d  d_eann                       14  0 overlay(d_e128:4)
     d  d_kode                        4  0 overlay(d_e128:17)
     d  d_anta                        6  2 overlay(d_e128:21)
5.54  *
5.54  * Definering av datastruktur
5.54  *
5.54 d                 ds
5.54 d d_urec                        80
5.54 d  d_firm                        3  0 overlay(d_urec)
5.61 d  d_aarr                        4  0 overlay(d_urec:4)
6.NU d  d_numm                        8  0 overlay(d_urec:8)
6.NU d  d_suff                        2  0 overlay(d_urec:16)
6.NU d  d_kodb                        1    overlay(d_urec:18)
6.NU d  d_date                         d   overlay(d_urec:19) datfmt(*iso)
6.NU d  d_time                         t   overlay(d_urec:29) timfmt(*iso)
6.NU d  d_user                       10    overlay(d_urec:37)
6.NU d  d_wsid                       10    overlay(d_urec:47)
      *
      * Datastruktur for lageroppdatering
      *
     d                 ds
6.NU d hlrec                        128
     d  hlvare                       15    overlay(hlrec)
     d  hllage                        2  0 overlay(hlrec:16)
     d  hldato                         d   overlay(hlrec:18) datfmt(*iso)
     d  hltime                         t   overlay(hlrec:28) timfmt(*iso)
     d  hlotyp                        2    overlay(hlrec:36)
     d  hlltyp                        2    overlay(hlrec:38)
     d  hlanta                       11  3 overlay(hlrec:40)
     d  hlkopr                        9  2 overlay(hlrec:51)
     d  hlrefr                       20    overlay(hlrec:60)
     d  hlsyst                        1    overlay(hlrec:80)
     d  hlaltk                        2    overlay(hlrec:81)
     d  hlrest                        1    overlay(hlrec:83)
     d  hltype                        1    overlay(hlrec:84)
     d  hlenhe                        3    overlay(hlrec:85)
     d  hlinlr                        1    overlay(hlrec:88)
     d  hllety                        1    overlay(hlrec:89)
6.NU d  hlonum                        8  0 overlay(hlrec:90)
6.NU d  hlolin                        4  0 overlay(hlrec:98)
      *
      * Definering av variabler i nøkler
      *
     d rkunl1_kund     s                   like(rkkund)
     d rlevl1_levr     s                   like(rllevr)
     d vvarl1_vare     s                   like(vvvare)
6.21 d w_varenr        s                   like(vvvare)
     d vvarl4_lvar     s                   like(vvlvar)
     d vltyl1_ltyp     s                   like(valtyp)
     d votyl1_otyp     s                   like(vaotyp)
     d vltpl1_lety     s                   like(vylety)
     d fusrl1_user     s                   like(fbuser)
     d fodtl1_line     s                   like(fdline)
     d fodtlr_line     s                   like(fdline)
     d fodtlu_line     s                   like(fdline)
5.32 d fvlslu_numm     s                   like(fvnumm)
5.32 d fvlslu_suff     s                   like(fvsuff)
5.32 d fvlslu_line     s                   like(fvline)
5.51 d fkprl1_kund     s                   like(flkund)
5.51 d fkprl1_kpro     s                   like(flkpro)
6.21 d ra17l1_qkod     s                   like(raqkod)
6.25 d amodl1_modu     s                   like(axmodu)
6.25 d afpslr_ufil     s                   like(l_filg)
6.25 d afpslr_uide     s                   like(afuide)
6.25 d rukpl6_kund     s                   like(rukund)
7.2B d avall1_apgm     s                   like(avapgm)
6.31 d rukrl5_ktyp     s                   like(ruktyp)
6.31 d rukrl5_kkun     s                   like(rukkun)
6.31 d rukrl5_kpro     s                   like(rukpro)
6.31 d ruksl1_skty     s                   like(ruskty)
6.31 d ruksl1_slag     s                   like(ruslag)
6.33 d jvarl1_vare     s                   like(jvvare)
6.3f d sdepl1_numm     s                   like(sknumm)
6.3f d sdepl1_kund     s                   like(skkund)
7.fb d sdepl1_tell     s                   like(sktell)
7.f0 d sdeplr_numm     s                   like(sknumm)
7.f0 d sdeplr_kund     s                   like(skkund)
7.f0 d sdeplr_tell     s                   like(sktell)
7.fb d sdeplu_numm     s                   like(sknumm)
7.fb d sdeplu_kund     s                   like(skkund)
7.fb d sdeplu_tell     s                   like(sktell)
7.08 d vlagl1_vare     s                   like(vlvare)
7.08 d vlagl1_lage     s                   like(vllage)
7.08 d jlevl3_enum     s                   like(jlenum)
7.08 d jvlel1_lvnr     s                   like(jvlvnr)
7.08 d jvlel1_lldo     s                   like(jvlldo)
Q.03 d floglr_aarr     s                   like(fuaarr)
Q.03 d floglr_numm     s                   like(funumm)
Q.03 d floglr_suff     s                   like(fusuff)
Q.04 d lohel1_numm     s                   like(lonumm)
Q.04 d lohel1_suff     s                   like(losuff)
Q.07 d lodtlc_ornu     s                   like(ldornu)
Q.07 d lodtlc_orsu     s                   like(ldorsu)
Q.07 d lodtlc_orli     s                   like(ldorli)
7.26 d eddtl2_onum     s                   like(edonum)
7.26 d eddtl2_osuf     s                   like(edosuf)
7.26 d eddtl2_olin     s                   like(edolin)
7.26 d eddtl3_fsys     s                   like(edfsys)
7.26 d eddtl3_tell     s                   like(edtell)
7.26 d eddtl3_line     s                   like(edline)
7.2o d vmval1_mkod     s                   like(vamkod)
      *
6.3i d p_txtl          s              2
      *
      * Definering av variable
      *
6.21 d w_indi          s              1
     d w_fcrn          s              4  0
     d w_stel          s              4  0
     d w_spge          s              4  0
     d w_srrn          s              4  0
     d w_sfrn          s                   like(w_srrn)
     d w_ssrn          s                   like(w_srrn)
7.19  *
7.19  *
7.19 d w_totkg         s              9  3
7.19 d                 ds
7.19 d w_totkgc                       9
7.19 d w_totkgx                       9S 3 overlay(w_totkgc)
7.19 d w_totkg1                       6    overlay(w_totkgc)
7.19 d w_totkg2                       1    overlay(w_totkgc:7)
7.19  *
7.19 d                 ds
7.19 d w_totkgu                       9
7.19 d w_totkgu2                      6    overlay(w_totkgu:2)
7.19 d w_totkgu21                     1    overlay(w_totkgu:2)
7.19 d w_totkgu22                     1    overlay(w_totkgu:3)
7.19 d w_totkgu23                     1    overlay(w_totkgu:4)
7.19 d w_totkgu24                     1    overlay(w_totkgu:5)
7.19 d w_totkgu25                     1    overlay(w_totkgu:6)
7.19 d w_totkgu3                      1    overlay(w_totkgu:8)
7.19 d w_totkgu4                      1    overlay(w_totkgu:9)
      *
     d b_oppr          s              1    inz(*off)
     d b_feil          s              1    inz(*off)
     d b_forn          s              1    inz(*off)
     d b_bonu          s              1    inz(*off)
     d b_kost          s              1    inz(*off)
     d b_text          s              1    inz(*off)
     d b_slet          s              1    inz(*off)
     d b_slet_vare     s              1    inz(*off)
     d b_best          s              1    inz(*off)
Q.082d b_kred          s              1    inz(*off)
6.14 d b_umva          s              1    inz(*off)
6.25 d b_bdo1          s              1    inz(*off)
6.25 d b_bdo2          s              1    inz(*off)
6.25 d b_bdo3          s              1    inz(*off)
6.25 d b_bdo4          s              1    inz(*off)
6.25 d b_kper          s              1    inz(*off)
6.32 d b_modul         s              1    inz(*off)
6.39 d b_evr           s              1    inz(*off)
6.3f d b_bfor          s              1    inz(*off)
6.3f d b_krav          s              1    inz(*off)
Q.03 d b_pluk          s              1    inz(*off)
Q.04 d b_kund          s              1    inz(*off)
Q.08 d b_avsl          s              1    inz(*off)
Q.11 d b_pakk          s              1    inz(*off)
Q.111d b_utle          s              1    inz(*off)
7.31 d b_prof          s              1    inz(*off)
7.fb d b_100p          s              1    inz(*off)
7.fb d b_depo          s              1    inz(*off)
8.23 d b_bygd          s              1    inz(*off)
      *
     d w_stat          s              1
     d w_retu          s              1
     d w_sald          s             11  2
5.60 d w_sal2          s             11  2
     d w_enor          s              1
     d w_leng          s              2  0
     d w_posi          s              2  0
     d w_totk          s             11  2
     d w_tots          s             11  2
     d w_totr          s             11  2
5.60 d w_tota          s             11  2
5.60 d w_totn          s             11  2
5.60 d w_tot1          s             11  2
5.60 d w_tot2          s             11  2
6.11 d w_eanx          s             14
6.11 d w_eann          s             14  0
6.12 d w_gtin          s             14  0
6.11 d w_eava          s                   like(vvvare)
6.11 d w_eaen          s                   like(vvenhe)
6.11 d w_east          s              1
     d w_type          s              4
5.01 d w_opdt          s              1
     d w_stek          s             35
5.63 d w_spgm          s             10
7.19 d w_flag          s              1
6.30 d p_vare          s             35
6.40 d w_inkh          s              1
7.fb d w_depo          s             11  2
7.fb d w_netg          s                   like(fdsums)
7.fb d w_netn          s                   like(fdsums)
7.fb d w_sumi          s             11  2
7.fb d w_sumu          s             11  2
7.fb d w_depb          s             11  2
7.fb d w_tell          s                   like(sktell)
7.fb d w_depp          s                   like(skdepp)
7.fb d w_diff          s                   like(skdepp)
      *
     d w_firm          s                   like(vvfirm)
7.04 d w_avde          s                   like(vvfirm)
5.61 d w_aarr          s              4  0
6.NU d w_numm          s                   like(fonumm)
6.21 d w_lmat          s                   like(folmat)
     d w_suff          s                   like(fosuff)
     d w_ldat          s                   like(foldat)
     d w_line          s                   like(fdline)
     d w_enhe          s                   like(fdenh1)
     d w_ltxt          s                   like(vybesk)
     d w_vare          s                   like(fdvare)
     d w_kgrn          s                   like(rksald)
     d w_ksal          s                   like(rksald)
     d w_rgrn          s                   like(faagrn)
     d w_ogrp          s                   like(fdogrp)
     d w_hgrp          s                   like(fdhgrp)
     d w_ugrp          s                   like(fdugrp)
5.52 d w_tek1          s                   like(vvtek1)
5.02  *
5.02 d w_mld1          s             50
5.02 d w_mld2          s             50
8.25 d w_mld3          s             50
5.02 d w_svar          s              1
5.02 d w_in12          s              1  0
5.54 d w_sva2          s              1
5.54 d w_kod2          s              1
5.64 d w_stop          s              1
5.64 d s_gral          s                   like(rkgral)
5.64 d s_kjal          s                   like(rkkjal)
5.64 d w_bgrn          s                   like(rkgral)
6.NU d w_numa          s              8
5.02 d w_lina          s              4
6.25 d w_btms          s               Z
6.25 d w_ti26          s             26
6.NU d w_bnum          s              8
6.31 d w_kode          s              1
6.31 d w_fell          s              6
6.31 d w_rtyp          s              2
6.31 d w_fast          s             10
6.31 d w_ruti          s             10
6.37 d w_rnum          s              8  0
6.32 d w_modu          s             10
6.32 d w_disp          s              1
6.33 d w_lvre          s                   like(fdlvre)
6.31 d w_lv_vare       s                   like(vvvare)
6.3l d w_undv          s              8  0
6.3l d w_logl          s             15
6.3l d w_jvqvnr        s                   like(vvvare)
6.3l d w_jvquno        s              8  0
Q.02 d w_acti          s              1
Q.02 d w_qsta          s              1
Q.04 d w_mkod          s                   like(rkmkod)
Q.04 d w_betb          s                   like(rkbetb)
Q.04 d w_faty          s                   like(rkfaty)
Q.04 d w_navn          s                   like(fonavn)
Q.04 d w_adr1          s                   like(foadr1)
Q.04 d w_adr2          s                   like(foadr2)
Q.04 d w_sted          s                   like(fosted)
Q.04 d w_kprs          s                   like(flkprs)
Q.04 d w_tlfa          s                   like(fltlfa)
Q.04 d w_tlfp          s                   like(fltlfp)
Q.04 d w_tlfm          s                   like(fltlfm)
Q.04 d w_mail          s                   like(flmail)
Q.04 d w_orka          s                   like(florka)
Q.04 d w_okun          s                   like(flokun)
Q.04 d w_okpr          s                   like(flokpr)
Q.04 d w_opda          s                   like(flopda)
Q.04 d w_proj          s                   like(flproj)
Q.04 d w_kjor          s                   like(flkjor)
Q.04 d w_kjnr          s                   like(flkjnr)
Q.04 d w_dato          s                   like(flfdat)
Q.06 d w_anta          s                   like(fdanta)
     d w_filn          s            256
     d w_fnav          s             50
     d w_mime          s            150
      *
7.10 d p_rec1          s             50    inz('sa@monter.kirkenes.no')
7.10 d p_rec2          s             50    inz('lager@monter.kirkenes.no')
7.10 d p_rec3          s             50    inz(' ')
7.10 d p_rec4          s             50    inz(' ')
7.10 d p_rec5          s             50    inz(' ')
7.10 d p_rec6          s             50    inz('        ')
7.10 d p_send          s             50    inz(' ')
7.10 d p_subj          s            100    inz(' ')
7.10 d p_txt1          s            100    inz(' ')
7.10 d p_txt2          s            100    inz(' ')
7.10 d p_txt3          s            100    inz(' ')
7.10 d p_txt4          s            100    inz(' ')
7.10 d p_avsl          s            100    inz(' ')
8.25 d p_logg_vare     s             15
8.25 d p_lage_inn      s              2  0
8.25 d p_nobb_ut       s              8  0
8.25 d p_udat          s               d   datfmt(*iso)
8.25 d p_lv_nobb       s                   like(vvnobb)
8.25 d p_lv_modn       s                   like(vvnmod)
8.25 d p_lv_lldo       s                   like(vvldor)
8.25 d p_lv_llva       s                   like(vvlvar)
8.25 d p_vtyp          s                   like(vvvtyp)
8.25 d p_ldor          s              6  0
      *
7.10 d w_ordre         s              8
7.10 d w_suffi         s              2
7.26 d w_erst          s              1  0
7.26 d w_vtxt          s                   like(vvtek1)
7.31 d w_proff         s              1
7.2t d w_linnet        s                   like(fdsums)
7.2t d w_nynet         s                   like(fdsums)
7.2t d w_lindif        s                   like(fdsums)
7.2t d w_nyrab         s                   like(fdrab1)
7.04  *
7.04 d u_deps          s              1    inz(*on)                             Depositum sjekk
7.04 d u_gavk          s              1    inz(*off)                            Bruk gavekort shop
7.08 d u_fskv          s              1    inz(*off)                            Farge på skaffvare
7.08 d u_fugv          s              1    inz(*off)                            Farge på utgåttvare
7.10 d u_710           s              1    inz(*off)                            Endring 7.10
7.11 d u_711           s              1    inz(*off)
7.12 d u_712           s              1    inz(*off)
7.13 d*u_713           s              1    inz(*off)
7.14 d u_714           s              1    inz(*off)
7.15 d u_715           s              1    inz(*off)
7.16 d u_716           s              1    inz(*off)
7.17 d u_717           s              1    inz(*off)
7.18 d u_718           s              1    inz(*off)
7.19 d u_719           s              1    inz(*off)
7.19 d u_729           s              1    inz(*off)
7.2t d u_72t           s              1    inz(*off)
7.2u d u_72u           s              1    inz(*off)
7.30 d u_excel         s              1    inz(*off)
7.31 d u_731           s              1    inz(*off)
8.07 d u_kmem          s              1    inz(*off)
8.28 d u_best          s              1    inz(*off)
      *
7.13  *w_utvgrns = utvidelse i % av kreditgrense(Mestergruppen)
7.13 d w_utvgrns       s              2  0
7.13  *w_memodagr = antall dager ordre skal med i memosaldo
7.13 d w_memodagr      s              3  0
7.13 d w_3x            s              3
7.13 d p_fir           s              3
7.13 d p_kun           s              6
7.2v d p_dato          s                   like(fdldat)
7.2v d p_time          s                   like(fdotim)
7.2v d p_lenh          s                   like(fdenh1)
7.2v d p_kalk          s              1
7.2v d p_inlr          s              1
      *
7.26 d s_line          s                   like(fdline)
7.26 d s_benr          s                   like(fdbenr)
7.26 d s_bsuf          s                   like(fdbsuf)
7.26 d s_blin          s                   like(fdblin)
7.26 d s_onum          s                   like(fdnumm)
7.26 d s_osuf          s                   like(fdsuff)
7.26 d s_olin          s                   like(fdline)
7.2t d s_netb          s                   like(fdsums)
7.f6 d s_tota          s                   like(fotots)
5.53  *
5.53  * Parametre til RS205R - hent mva %
5.53  *
5.53 d w_mvak          s              1
5.53 d w_mvtx          s             30
5.53 d w_mvas          s              6  2
5.53 d w_mvat          s              5  4
5.53 d w_mvaf          s             10  9
5.53 d w_bpro          s              5  2
5.53 d w_date          s               d   datfmt(*iso)
6.31 d p_list          s             64
6.37 d p_rkey          s             10
6.31 d p_osta          s              1
      *
7.xx d w_lage          s              2  0
7.xx d w_vtyp          s                   like(vvvtyp)
7.xx d w_ldor          s                   like(vvldor)
7.xx d w_behl          s             11  3
7.xx d w_udat          s               d   datfmt(*iso)
7.xx d b_inlr          s              1    inz(*off)
7.20 d w_sltv          s              1    inz(*off)                            slettet vare
7.2h d w_behl0         s              5  0
7.2m d w_dgl00         s              4  2
7.2h d w_dg101         s              4  1
7.2h d w_raba1         s              4  1
7.25 d* w_oa_on         s              2  0 inz(0)
7.25 d* w_oa_on1        s              2  0 inz(0)
7.25 d* w_oa_on2        s              2  0 inz(0)
7.25 d* w_oa_on3        s              2  0 inz(0)
7.25 d* w_oa_on4        s              2  0 inz(0)
7.25 d w_fsok          s              1    inz(*off)                            fri søk treff
7.25 d w_ftekst        s                   like(b2fsok)
7.27 d w_len           s              3  0
7.27 d w_teller        s              3  0
7.2o d w_omva          s                   like(vamkof)
8.11 d w_memodat       s               d   datfmt(*iso)
8.18 d w_nobb          s              8  0
      *
7.fb d s_depp          s                   like(skdepp)
7.fb d s_100p          s                   like(sk100p)
7.fb d s_depx          s              3  0
7.fb d s_depo          s                   like(skdepo)
      *
7.28  *  w_tekst_pakk = J betyr at firmaet tillater reg tekst på pakkseddel
7.28  *                   selv om bruker er sperret for endring
7.28  *                   styres fra: PAKK_TEKST_ENDRE_OM_IKKE_TILGANG
7.28 d w_tekst_pakk    s              1    inz(' ')
7.28  *  w_pakk_sperr = J betyr at bruker er sperret for en del valg og f-taster
7.28  *                   Åpne valg: 5, Åpne F-taster: F2, F3, F9, F11, F14, F21
7.28 d w_pakk_sperr    s              1    inz(' ')
7.2B  *
7.2B  * Firmastyrt validering av felt
7.2B  *
7.2B
7.2B d u_avde          s              1    inz(*off)
7.2lxd u_fsor          s              1    inz(*off)                            Fargekode fra sortim
7.2lxd w_fso1          s             10
7.2lxd w_fso2          s             10
6.31  *
6.31  * Origo integrasjon
6.31  *
6.31 d                 ds
6.31 d d_list                        64
6.31 d  d_des0                        1    overlay(d_list:1)
6.31 d  d_belh                       11  0 overlay(d_list:2)
6.31 d  d_skil                        1    overlay(d_list:13)
6.31 d  d_beld                        2  2 overlay(d_list:14)
6.31 d  d_des1                        1    overlay(d_list:16)
6.31 d  d_kort                       11    overlay(d_list:17)
6.38 d  d_des2                        1    overlay(d_list:28)
6.38 d  d_sfir                        3    overlay(d_list:29)
6.38 d  d_des3                        1    overlay(d_list:32)
6.38 d  d_avde                        4    overlay(d_list:33)
6.31 d                 ds
6.31 d d_belop                       13  2
6.31 d  d_helt                       13  0 overlay(d_belop:1)
6.31 d  d_desi                        2  2 overlay(d_belop:12)
6.31 d                 ds
6.37 d d_rkey                        10
6.37 d  d_requ                        2    overlay(d_rkey:1)
6.37 d  d_rnum                        8  0 overlay(d_rkey:3)
7.08  *
7.08  * Definering av eksterne prg
7.08  * BKV
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
      *
      * Definering av konstanter
      *
7.25 d c_sfil          s              3  0 inz(014)
      *
     d lo              c                   'abcdefghijklmnopqrstuvwxyzæøåäö'
     d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZÆØÅÄÖ'
     d digit           c                   '0123456789 '
     d null            c                   '0000000000000'
6.32 d c_modu          c                   'KORT      '
7.xx d c_sepw          c                   const(X'22')
7.xx d c_sepg          c                   const(X'20')
      *
6.3l C/Exec SQL
7.2t C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR,
7.2t C+             commit=*none
6.3l C/End-Exec
      *
7.25      *in48 = *on;
7.25   //  // det er forskjellige navn på OA bibliotek
7.25   //  // OA er std 700
7.25   //  // GUIO er for XL
7.25   //  // ASKUNDxxxO skal være std for kundebibl
7.25   //   w_oa_on = 0;
7.25   //   w_oa_on1 = %scan ('OA' : CurPgmLib);
7.25   //   w_oa_on2 = %scan ('GUIO' : CurPgmLib);
7.25   //   if ( %len(%trim(CurPgmLib)) = 10);
7.25   //     if (%subst(CurPgmLib:1:6) = 'ASKUND');
7.25   //       if (%subst(CurPgmLib:10:1) = 'O');
7.25   //         w_oa_on3 =1 ;
7.25   //       endif;
7.25   //     endif;
7.25   //   endif;
7.25   //   if ((w_oa_on1<>0) or (w_oa_on2<>0) or (w_oa_on3<>0)
7.25   //                or (w_oa_on4<>0));
7.25   //     w_oa_on = 1;
7.25   //     *in48 = *on;
7.25   //   endif;
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * D1 Behandle åpningsopplysninger
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Viser informasjonsbilde dersom orderen inneholder slettede varer
      *
     c     fodtlr_key2   setll     fodtlr
     c     fodtlr_key2   reade     fodtlr
     c                   dow       not %eof
     c                   if        fdvare <> *blank and
     c                             fdlvre = 0
     c                   eval      vvarl1_vare = fdvare
     c     vvarl1_key    chain     vvarl1
     c                   if        not %found
     c                   eval      b_slet_vare = *on
     c                   leave
     c                   endif
     c                   endif
     c     fodtlr_key2   reade     fodtlr
     c                   enddo
      *
     c                   if        b_slet_vare = *on
     c                   exfmt     d1win
     c                   endif
      *
     c     d1tag         tag
      *
      * Posisjonerer databasen, og fyller opp subfile
      *
     c                   if        w_fcrn <> 0
     c     w_fcrn        chain     b1sfl
     c                   eval      fodtl1_line = b1line
     c                   else
     c                   eval      fodtl1_line = 0
     c                   endif
      *
     c     fodtl1_key    setll     fodtl1
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
      * Hent opplysninger fra ordre
      *
     c                   exsr      hent_ordre
      *
      * Hent sist brukte linjenummer og legg inn i teller
      *
     c                   exsr      hent_linjenr
      *
      * Sjekker om det skal beregnes bonus av kundens kjøp
      *
     c                   exsr      sjekk_bonus
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * D1 Behandle åpningsbildet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     d1taga        tag
      *
      * Blanker variable som benyttes i bildet
      *
     c                   eval      b2lety = b3lety
     c                   eval      b2ltyp = faalty
     c                   eval      b2anta = 0
6.21  *
6.21 c                   if        w_indi <> '1'
     c                   eval      b2vare = *blank
6.21 c                   endif
6.21 c                   eval      w_indi = '0'
      *
      * Send Alt
      *
     c     b2taga        tag
      *
     c                   eval      *in22 = *on
      *
     c                   eval      b2over = *blank
      *
     c                   select
     c                   when      *in70 = *on
7.xx c                   eval      b2over = 'Varenr   Varetekst' +
7.xx c                                      '                      ' +
7.xx c                                      'Antall   Enh Salgspris  ' +
7.xx c                                      'Rabatt Kod'
7.xx c**                 eval      b2over = 'Varenr  '+ c_sepw + 'Varetekst' +
7.xx c**                                    '                ' + c_sepw +
7.xx c**                                    '    Antall  ' + c_sepw + 'Enh' +
7.xx c**                                    c_sepw + 'Salgspris ' + c_sepw +
7.xx c**                                    'Rabatt ' + c_sepw + 'Kod'
     c                   when      *in71 = *on
     c                   eval      b2over = 'Varetekst' +
     c                                      '                    ' +
     c                                      '               ' +
     c                                      'Sum netto      Sum kost    DG'
     c                   when      *in72 = *on
     c                   eval      b2over = 'Varetekst' +
     c                                      '                    ' +
     c                                      '             ' +
     c                                      'Etter bonus      Sum kost    DG'
     c                   endsl
      *
     c                   write     b2cmd
      *
      * Bare data
      *
     c     b2tagb        tag
      *
     c                   exsr      dsp_subfile
      *
     c                   eval      *in22 = *off
      *
      * Behandling av funksjonstaster
      *
     c                   select
7.03 c                   when      *in10
7.03 c                   exsr      crt_subfile
7.03 c                   goto      b2tagb
7.2f c                   when      *in11
7.2f c                   exsr      bck_subfile
7.2f c                   goto      b2tagb
7.xx c*                  when      *in21
7.xx c*                  eval      *in22 = *on
7.xx c*                  goto      b2taga
     c                   endsl
7.2l  *
7.2l  *    Sjekk om bruker har tilgang til funksjonstast
7.2l  *                            *in16 betyr at f-tast er trykket
7.2l c                   if        *in16
7.2l c                             and w_pakk_sperr = 'J'
7.2l c                             and not (*inkb
7.2l c                                   or *inkc
8.03 c                                   or *inka
8.03 c                                   or *inkf
7.2l c                                   or *inki
7.2l c                                   or *inkk
7.2l c                                   or *inkn
7.2l c                                   or *inkv)
7.2l c                   eval      w_mld1 = 'Funksjonstast ikke tillatt for +
7.2l c                                       din bruker'
7.2l c                   call      'AA005R'
7.2l c                   parm                    w_mld1
7.2l c                   goto      b2taga
7.2l c                   endif
7.25  *
7.25  * F5=Forny  - nullstill søk
7.25  *
7.25 c                   if        *inke  = *on
7.2i c                   if        *in56 = *on
7.2o c                   exsr      sjekk_mva
7.2i  * hvis Solve VA. Rekalkuler ordre ved F5 (kommer også fra Newlook)
8.04 c                   eval      w_enor = ' '
8.04 c                   call      'FO731R'
7.2i c                   parm                    w_enor
7.2i c                   parm                    w_firm
7.2i c                   parm                    w_numm
7.2i c                   parm                    w_suff
7.2i c                   endif
7.25 c                   eval      b2fso2 = *blank
7.25 c                   eval      b2fsok = *blank
7.25 c                   eval      b1line = 0
7.25 c                   eval      w_fcrn = 0
7.25 c                   exsr      forny
7.25 c*                   eval      *in22 = *off
7.25 c*                   exsr      clr_subfile
7.25 c*                   exsr      crt_subfile
7.25 c                   goto      b2taga
7.25 c                   endif
7.25  *
7.25  * Frisøk
7.25  *
7.25 c                   if        b2fsok <> *blank
7.25 c                   eval      fodtl1_line = 0
7.25 c                   eval      b2fso2 = b2fsok
7.25 c                   eval      b1line = 0
7.25 c                   eval      w_fcrn = 0
7.25 c                   exsr      forny
7.25 c                   eval      b2fsok = *blank
7.25 c                   goto      b2taga
7.25 c                   endif
      *
      * F1=Vis skjermbilde-II (dekning + beregnet)
      *
     c                   if        *inka = *on
     c                   select
     c                   when      *in70 = *on
     c                   eval      *in70 = *off
     c                   eval      *in71 = *on
     c                   eval      *in72 = *off
     c                   when      *in71 = *on
7.11 c                   if        u_711 = *on
7.11 c                   eval      *in70 = *on
7.11 c                   eval      *in71 = *off
7.11 c                   eval      *in72 = *off
7.11 c                   else
     c                   if        b_bonu = *on
     c                   eval      *in70 = *off
     c                   eval      *in71 = *off
     c                   eval      *in72 = *on
     c                   else
     c                   eval      *in70 = *on
     c                   eval      *in71 = *off
     c                   eval      *in72 = *off
     c                   endif
7.11 c                   endif
     c                   when      *in72 = *on
     c                   eval      *in70 = *on
     c                   eval      *in71 = *off
     c                   eval      *in72 = *off
     c                   endsl
7.2f c                   exsr      forny
7.2f c*                  exsr      forny_alt
     c                   goto      b2taga
     c                   endif
      *
      * F2=Sett inn tekstlinje
      *
     c                   if        *inkb = *on
     c                   exsr      hent_linjenr
     c                   eval      w_line = w_line + 10
     c                   exsr      tekstlinje
     c                   exsr      oppdat_side
     c                   goto      d1taga
     c                   endif
7.f5  *
7.f5  * Registrere depositumskrav.
7.f5  *
7.f5 c                   if        *inkg = *on
7.f5 c                   exsr      Xs1win
7.f5 c                   goto      b2taga
7.f5 c                   endif
      *
Q.03  * B2VALG = 4,Sett ordre klar til plukking - hurtigversjon. Må kjøre samme
Q.03  * rutine som ved F3, men hopper over endel step og skjermbilder
Q.03  * NB Sjekk om den allerede er lagt til plukking
Q.03  *
Q.03 c                   if        b2valg = 4 or
Q.03 c                             b_pluk = *on
7.2q  *
7.2q  * Gi varsel dersom ordre er direktelevering
7.2q  *
7.2q c                   if        footyp = 'HO' and
7.2q c                             u_714 = *on
7.2q c                   eval      w_mld1 = 'Varsel: Hovedordre kan +
7.2q c                                       ikke sendes til plukk'
7.2q c                   call      'AA005R'
7.2q c                   parm                    w_mld1
7.2q c                   eval      b_pluk = *off
7.2q c                   eval      b_avsl = *on
7.2q c                   eval      *inkc = *on
7.2q c                   eval      b2valg = 0
7.2q c                   else
7.21  *
7.21  * Gi varsel dersom ordre er direktelevering
7.21  *
7.21 c                   if        folety = 1
7.21 c                   eval      w_mld1 = 'Varsel: Kan ikke plukkes +
7.21 c                                       da det er direktelevering'
7.21 c                   call      'AA005R'
7.21 c                   parm                    w_mld1
7.21 c                   eval      b_pluk = *off
7.21 c                   eval      b_avsl = *on
7.21 c                   eval      *inkc = *on
7.21 c                   eval      b2valg = 0
7.21 c                   else
Q.03 c                   eval      b_pluk = *on
8.17  *Oppdater før hurtigutskrift
8.17 c                   exsr      oppdat_ordre
8.17  *
7.22 c                   exsr      ex_vis_tvare
Q.03 c                   exsr      ex_pluk
Q.03 c                   eval      b2valg = 0
Q.03 c                   if        b_pluk = *on
Q.03 c                   eval      b_pluk = *off
Q.03 c                   eval      b_avsl = *on
Q.03 c                   eval      *inkc = *on
Q.03 c                   endif
7.21 c                   endif
7.2q c                   endif
Q.03 c                   endif
Q.08  * B2VALG = 7,Avslutt ordren uten spm som normalt dukker opp. Ref
Q.08  * samme funksjon som F5 ved bestilling. Samme som F3, men hopper
Q.08  * over alle step og skjermbilder.
Q.08  *
Q.08 c                   if        b2valg = 7 or
Q.08 c                             b_avsl = *on
7.22 c                   exsr      ex_vis_tvare
Q.08 c                   eval      b_avsl = *on
Q.08 c                   eval      *inkc = *on
Q.081 * Sjekk om kreditgrensen er overskredet.
Q.081c                   if        p_txtl = *blank
Q.083c                   exsr      oppdat_ordre
Q.081c                   exsr      sjekk_kunde
Q.081c                   endif
Q.081c                   eval      b2valg = 0
Q.082c                   if        b_kred = *on and
Q.081c                             *inks = *off
Q.081c                   eval      b_avsl = *off
Q.081c                   goto      d1tag
Q.081c                   else
Q.081c                   eval      *inkc = *on
Q.081c                   endif
Q.08 c                   endif
Q.11  *
Q.11  * B2VALG = 10, Send automatisk til utlevering
Q.11  *
Q.11 c                   if        b2valg = 10
Q.111c                   eval      b_utle = *on
Q.11 c                   exsr      ex_utlev
Q.11 c                   eval      b2valg = 0
Q.111c                   if        b_utle = *on
Q.11 c                   goto      avslutt
Q.111c                   else
Q.111c                   goto      b2tagb
Q.111c                   endif
Q.11 c                   endif
Q.11  *
      *
      * F3=Starter subrutine for oppdatering/utskrift/overføring
      *
     c                   if        *inkc = *on
      *
     c                   eval      b_slet = *off
     c                   eval      *inkc  = *off
      *
     c                   exsr      oppdat_ordre
7.f6  * Hvis depositum, sjekk om total er økt, da skal det rekalkuleres dep.krav
7.f6 c                   if        *in58 = *on
7.f6 c                   exsr      sjk_depo
7.f6 c                   endif
Q.08  * Hurtigavslutning ??
Q.08 c                   if        b_avsl = *off
Q.08  *
5.64 c                   exsr      sjekk_almrab
5.64 c                   if        w_stop = *on
5.64 c                   exfmt     f2win
5.64 c                   if        *inks  = *off
5.64 c                   goto      d1tag
5.64 c                   endif
5.64 c                   endif
5.64  *
     c                   exsr      sjekk_rabatt
6.3i c                   if        *inkc = *off
6.3i  * Ikke sjekk kunde dersom kun vedlikehold av tekstlinjer
6.3i c                   if        p_txtl = *blank
     c                   exsr      sjekk_kunde
     c                   endif
6.3i c                   endif
      *
      * Avslutt dersom ordre er slettet
      * p.g.a. kreditt-grense
      *
     c                   if        b_slet = *on
     c                   goto      avslutt
     c                   endif
      *
     c                   if        *inkc = *off
     c                   exsr      f1subr
     c                   endif
     c                   if        *inkc = *on
     c                   goto      d1tag
     c                   endif
6.31  * Hvis det er kortordre, sjekk om det skal settes sperrekode
6.31 c                   if        fopsuf <> 0 and
6.31 c                             foityp = *blanks
6.31 c                   exsr      spr_ordre
6.31 c                   endif
      *
Q.08 c                   else
7.2j  * Hvis det er kortordre, sjekk om det skal settes sperrekode
7.2j c                   if        fopsuf <> 0 and
7.2j c                             foityp = *blanks
7.2j c                   exsr      spr_ordre
7.2j c                   endif
Q.08  *
Q.08  * Tilbakestill kode som sier at ordre er opptatt
Q.08  *
Q.08 c     fohelu_key    chain     fohelur
Q.08 c                   if        fokode = 1
Q.08 c                   eval      fokode = 0
Q.08 c                   move      *loval        fokoda
Q.08 c                   move      *loval        fokoti
Q.08 c                   eval      fokous = *blank
Q.08 c                   eval      fokows = *blank
Q.08 c                   endif
Q.08 c                   time                    foedat
Q.08 c                   time                    foetim
Q.08 c                   eval      foeusr = l_user
Q.08 c                   update    fohelur
Q.08 c                   endif
      *
     c                   goto      avslutt
      *
     c                   endif
      *
      * F4=Spørring på Leveringstype
      *
7.02 c*                   if        *inkd  = *on
7.02 c*                   if        w_afldb2 = 'B2LETY'
7.02 c*                   call      'VY500R'
7.02 c*                   parm                    w_firm
7.02 c*                   parm                    b2lety
7.02 c*                   parm                    w_ltxt
7.02 c*                   goto      b2tagb
7.02 c*                   endif
7.02 c*                   endif
      *
      * F4=Spørring i vare-register
      *
6.3i  * Skal ikke få ta F4 hvis kreditgrense er oversteget.
6.3i  * Da skal kun tekstlinjer kunne vedlikeholdes.
6.3i c                   if        p_txtl = *blank
     c                   if        *inkd = *on
     c                   exsr      oppdat_ordre
     c                   exsr      hent_linjenr
6.30 c                   eval      p_vare = *blanks
     c                   call      'FD102R'
     c                   parm                    p_stat
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_line
     c                   parm                    b_kost
6.30 c                   parm                    p_vare
7.f4 c                   parm                    b_depo
     c                   eval      *in49 = b_kost
7.2f c                   exsr      oppdat_side
7.2f c*                   exsr      forny_alt
     c                   goto      d1taga
     c                   endif
6.3i c                   endif
      *
      * F6=Vis dekningsbidrag
      *
6.3i  * Skal ikke få ta F6 hvis kreditgrense er oversteget.
6.3i  * Da skal kun tekstlinjer kunne vedlikeholdes.
6.3i c                   if        p_txtl = *blank
     c                   if        *inkf = *on
     c                   exsr      oppdat_ordre
     c                   call      'FO522R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
      *
8.26 c                   eval      w_enor = *blanks
8.26 c                   call      'FO730R'
8.26 c                   parm                    w_enor
8.26 c                   parm                    w_firm
8.26 c                   parm                    w_numm
8.26 c                   parm                    w_suff
     c                   goto      d1tag
     c                   endif
6.3i c                   endif
      *
      * F8=Skaffevareregister (overgang til vareadministrasjon)
      *
6.3i  * Skal ikke få ta F4 hvis kreditgrense er oversteget.
6.3i  * Da skal kun tekstlinjer kunne vedlikeholdes.
6.3i c                   if        p_txtl = *blank
     c                   if        *inkh = *on
6.40 c                   eval      w_inkh = '1'
     c                   exsr      oppdat_ordre
     c                   exsr      hent_linjenr
     c                   call      'JV160R'
     c                   parm                    p_stat
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_line
     c                   parm                    b2ltyp
     c                   parm                    b2lety
     c                   parm                    w_ogrp
     c                   parm                    w_hgrp
     c                   parm                    w_ugrp
     c                   parm                    w_stek
7.f4 c                   parm                    b_depo
7.2f c                   exsr      oppdat_side
7.2f c*                  exsr      forny_alt
     c                   goto      d1taga
     c                   endif
6.3i c                   endif
      *
      * F9=Spørring på vare/lager
      *
     c                   if        *inki = *on
      *
     c                   exsr      oppdat_ordre
      *
6.3i  * Skal ikke kunne søke opp vare
6.3i c                   if        p_txtl = 'TX'
6.3i c                   eval      b2vare = *blank
6.3i c                   endif
6.3i  *
     c                   if        b2vare <> *blank
     c                   eval      w_vare = b2vare
     c                   call      'LL502R'
     c                   parm                    w_firm
     c                   parm                    w_vare
     c                   else
     c                   call      'LL500R'
     c                   endif
      *
     c                   goto      d1tag
     c                   endif
      *
      * F10=Vedlikehold av faste opplysninger
      *
6.3i  * Skal ikke kunne vedlikeholdes dersom kred.gr. er oversteget
6.3i  * kun vedlikehold av tekstlinjer
6.3i c                   if        p_txtl = *blank
     c                   if        *inkj = *on
     c                   exsr      oppdat_ordre
     c                   call      'FO101R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
      *
8.26 c                   eval      w_enor = *blanks
8.26 c                   call      'FO730R'
8.26 c                   parm                    w_enor
8.26 c                   parm                    w_firm
8.26 c                   parm                    w_numm
8.26 c                   parm                    w_suff
      *
     c                   goto      d1tag
     c                   endif
6.3i c                   endif
      *
      * F11=Vedlikehold av faste tekster
      *
     c                   if        *inkk = *on
     c                   exsr      oppdat_ordre
     c                   call      'FO105R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   goto      d1tag
     c                   endif
      *
      * F13=Spørring/registrering av varelinjer fra statistikk
      *
     c                   if        *inkm = *on
     c                   exsr      oppdat_ordre
     c                   exsr      hent_linjenr
     c                   call      'SF160R'
     c                   parm                    p_stat
     c                   parm                    w_firm
     c                   parm                    fokund
     c                   parm                    fokpro
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_line
     c                   parm                    b2ltyp
     c                   parm                    b2lety
     c                   parm                    b_kost
     c                   exsr      oppdat_side
     c                   goto      d1taga
     c                   endif
      *
      * F14=Vis kunde-/kundeprosjekt-informasjon
      *
     c                   if        *inkn = *on
     c                   call      'FL510R'
     c                   parm                    w_firm
     c                   parm                    fokund
     c                   parm                    fokpro
     c                   goto      d1tag
     c                   endif
6.31  *
6.31  * F15=Sjekk mot origo om det er gyldig saldo
6.31  *
6.32  * Er kortmodulen innstallert ?
7.19 c                   if        u_719 = *off
6.32 c                   if        *inkp = *on
6.32 c                   exsr      sjk_modul
6.32 c                   if        b_modul = *off
6.32 c                   goto      d1tag
6.32 c                   endif
6.32  *
6.31 c                   exsr      sjk_saldo
6.31 c                   goto      d1tag
6.31 c                   endif
7.19 c                   endif
7.19  *
7.19  * F16=Vis ekstra ordreinfo
7.19  *
7.19 c                   if        u_719 = *on
7.19 c                   if        *inkq = *on
7.19 c                   call      'FD801R'
7.19 c                   parm                    w_firm
7.19 c                   parm                    w_numm
7.19 c                   parm                    w_suff
7.19 c                   parm                    w_totkg
7.19 c                   eval      w_totkgx  = w_totkg
7.19 c                   eval      w_totkgu2 = w_totkg1
7.19 c                   if        w_totkg < 100000
7.19 c                   eval      w_totkgu21 = ' '
7.19 c                   endif
7.19 c                   if        w_totkg < 10000
7.19 c                   eval      w_totkgu22 = ' '
7.19 c                   endif
7.19 c                   if        w_totkg < 1000
7.19 c                   eval      w_totkgu23 = ' '
7.19 c                   endif
7.19 c                   if        w_totkg < 100
7.19 c                   eval      w_totkgu24 = ' '
7.19 c                   endif
7.19 c                   if        w_totkg < 10
7.19 c                   eval      w_totkgu25 = ' '
7.19 c                   endif
7.19 c                   eval      w_totkgu3 = ','
7.19 c                   eval      w_totkgu4 = w_totkg2
7.19 c                   eval      totkg = w_totkgu
7.19 c                   exfmt     o2win
7.19 c                   goto      d1tag
7.19 c                   endif
7.19 c                   endif
7.29  *
7.29  * F17=Hente budjsett fra Prosjekt
7.29  *
7.19 c                   if        u_729 = *on
7.29 c                   if        *inkr = *on
7.29 c                             and foproj <> *blank
7.29 c                   call      'RP147R'
7.29 c                   parm                    foproj
7.29 c                   parm                    foupro
7.29 c                   parm                    foakti
7.29 c                   parm                    w_numm
7.29 c                   parm                    w_suff
7.29 c                   goto      d1tag
7.29 c                   endif
7.29 c                   endif
7.29  *
7.30  *
7.30  * F19=Hente budjsett fra Prosjekt
7.30  *
7.30 c                   if        u_excel = *on
7.30 c                             and *inkt = *on
7.30 c                   move      w_numm        p_numx
7.30 c                   move      w_suff        p_sufx
7.30 c                   call      'HENTORPC'
7.30 c                   parm                    p_numx
7.30 c                   parm                    p_sufx
7.30 c                   goto      d1tag
7.30 c                   endif
7.30  *
      *
      * F20=Sett i bestilling
      *
6.3i  * Skal ikke få ta F20 hvis kreditgrense er oversteget.
6.3i  * Da skal kun tekstlinjer kunne vedlikeholdes.
6.3i c                   if        p_txtl = *blank
     c                   if        *inku = *on
7.15 c                   if        u_715 = *on
7.15 c                   if        footyp = 'HO'
7.15 c                   exsr      xm1win
7.15 c                   goto      d1tag
7.15 c                   endif
7.15 c                   endif
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1
     c                   if        vaoakk = 1
6.3f  * depositumsjekk
7.04 c                   if        u_deps = *on
6.3f c                   if        b_krav = *on
6.3f c                   exsr      xf1msg
6.3f c                   goto      d1tag
6.3f c                   endif
7.04 c                   endif
     c                   if        laaabe = 1
     c                   call      'FO740R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   else
     c                   call      'FO734R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   endif
     c                   endif
     c                   goto      d1tag
     c                   endif
6.3i c                   endif
      *
      * F21=Spørring på vare/pris
      *
     c                   if        *inkv = *on
     c                   call      'VV550R'
     c                   goto      d1tag
     c                   endif
      *
      * F23=Skifte mellom skjul/vis kostpris (dersom tillatt på bruker)
      *
     c                   if        *inkx = *on and
     c                             fbko02 = 1
     c                   if        *in49 = *off
     C                   eval      *in49 = *on
     c                   else
     C                   eval      *in49 = *off
     c                   endif
     c                   eval      b_kost = *in49
     c                   goto      b2taga
     c                   endif
      *
      * Behandling av opplysninger i bildet
      *
6.3i  * Skal ikke kunne søke opp vare
6.3i c                   if        p_txtl = 'TX'
6.3i c                   eval      b2vare = *blank
6.3i c                   endif
6.3i  *
     c                   if        b2ltyp <> *blank or
     c                             b2vare <> *blank
     c                   exsr      hent_linjenr
     c                   eval      w_line = w_line + 10
     c                   exsr      registrer
     c                   select
     c                   when      b_feil = *on
     c                   goto      b2tagb
     c                   when      b_oppr = *on
7.2f c                   exsr      oppdat_side
7.2f c*                  exsr      forny_alt
7.2f  *blar til siste side, hvis ikke OA bilde
7.2f c*                   if        w_oa_on = 0
7.2f c*                  dow       *in15 = *off
7.2f c*                  exsr      crt_subfile
7.2f c*                  enddo
7.25 c*                   endif
     c                   goto      d1taga
     c                   endsl
     c                   endif
Q.02  *
Q.02  * B2VALG, 1=Skriv ut ordre
Q.02  *
Q.02 c                   if        b2valg = 1
Q.02  *
Q.02  * Alle sjekker på gyldig ordretype skjer i neste program. Da
Q.02  * slipper jeg kode det mange ganger.
Q.02  *
7.22 c                   exsr      ex_vis_tvare
Q.02 c                   exsr      ex_print
Q.02 c                   eval      b2valg = *zeros
Q.02 c                   goto      d1tag
Q.02 c                   endif
Q.02  *
Q.02  * B2VALG, 2=Forhåndsvisning
Q.02  *
Q.02 c                   if        b2valg = 2
Q.02  *
Q.02  * Alle sjekker på gyldig ordretype skjer i neste program. Da
Q.02  * slipper jeg kode det mange ganger.
Q.02  *
7.22 c                   exsr      ex_vis_tvare
Q.02 c                   exsr      ex_preview
Q.02 c                   eval      b2valg = *zeros
Q.02 c                   goto      d1tag
Q.02 c                   endif
Q.02  *
Q.02  * B2VALG, 3=email
Q.02  *
Q.02 c                   if        b2valg = 3
Q.02  *
Q.02  * Alle sjekker på gyldig ordretype skjer i neste program. Da
Q.02  * slipper jeg kode det mange ganger.
Q.02  *
7.22 c                   exsr      ex_vis_tvare
Q.02 c                   exsr      ex_email
Q.02 c                   eval      b2valg = *zeros
Q.02 c                   goto      d1tag
Q.02 c                   endif
Q.03  *
Q.03  * B2VALG, 4=Klar til plukking
Q.03  *
Q.03 c                   eval      b_pluk = *off
Q.03 c                   if        b2valg = 4
Q.03 c                   eval      b_pluk = *on
Q.03 c                   eval      b2valg = *zeros
Q.03 c                   endif
Q.04  *
Q.04  * B2VALG, 5=Bytte kunde på ordren
Q.04  *
Q.04 c                   if        b2valg = 5
Q.04  *
Q.04  * Alle sjekker skjer i subrutina
Q.04  *
Q.04 c                   exsr      ex_bytt_kunde
Q.04 c                   eval      b2valg = *zeros
Q.04 c                   goto      d1tag
Q.04 c                   endif
Q.05  *
Q.05  * B2VALG, 6=Skriv ut kollietiketter
Q.05  *
Q.05 c                   if        b2valg = 6
Q.05  *
Q.05  * Alle sjekker skjer i subrutina
Q.05  *
Q.05 c                   exsr      ex_prt_kolli
Q.05 c                   eval      b2valg = *zeros
Q.05 c                   eval      b_pluk = *off
Q.05 c                   goto      d1tag
Q.05 c                   endif
Q.09  *
Q.09  * B2VALG, 8=Send SMS
Q.09  *
Q.09 c                   if        b2valg = 8
Q.09  *
Q.09  * Alle sjekker skjer i subrutina
Q.09  *
Q.09 c                   exsr      ex_snd_SMS
Q.09 c                   eval      b2valg = *zeros
Q.09 c                   goto      d1tag
Q.09 c                   endif
Q.10  *
Q.10  * B2VALG, 9 =Skriv prisbekreftelse
Q.10  *
Q.10 c                   if        b2valg = 9
Q.10  *
Q.10  * Alle sjekker på gyldig ordretype skjer i neste program. Da
Q.10  * slipper jeg kode det mange ganger.
Q.10  *
7.2n c                   exsr      upd_ordrehode
7.22 c                   exsr      ex_vis_tvare
Q.10 c                   exsr      ex_prt_prisb
Q.10 c                   eval      b2valg = *zeros
Q.10 c                   goto      d1tag
Q.10 c                   endif
Q.10  *
Q.10  * B2VALG,11 =Lag Excelfil med visning
Q.10  *
Q.10 c                   if        b2valg = 11
Q.10  *
Q.10  * Alle sjekker på gyldig ordretype skjer i neste program. Da
Q.10  * slipper jeg kode det mange ganger.
Q.10  *
Q.10 c                   exsr      ex_vis_excel
Q.10 c                   eval      b2valg = *zeros
Q.10 c                   goto      d1tag
Q.10 c                   endif
      *
      * Behandling av subfile
      *
     c                   exsr      subfile
      *
6.30 c**                 if        w_fcrn <> 0
     c                   goto      d1taga
6.30 c**                 endif
      *
      * Avslutt program
      *
     c     avslutt       tag
6.25  *
6.25  * hvis byggdok har blitt lagt ut kjør en rutine
6.25  *
7.12 c                   if        u_712 = *off
6.25 c                   if        b_bdo4 = *on
6.25 c                   call      'FO788R '
6.25 c                   endif
7.12 c                   endif
6.14  *
6.14  * Gi varsel dersom ordre er pliktig og det
6.14  * finnes varelinjer som ikke har moms
6.14  *
6.14 c                   if        fomkod = 0 and
6.14 c                             b_umva = *on
6.14 c                   eval      w_mld1 = 'Varsel: Ordre inneho+
6.14 c                                       lder varelinjer uten +
6.14 c                                       mva. Ok ?'
6.14 c                   call      'AA005R'
6.14 c                   parm                    w_mld1
6.14 c                   endif
      *
     c                   eval      *inlr = *on
     c                   return
      *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Sjekker saldo mot origo.
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     sjk_saldo     begsr
6.32  * Sjekk først om korttypen kvalifiserer til saldosjekk
6.32  * Foreløpig er det bare korttype 4 (GE kort) som kan saldosjekkes
6.32 c                   if        fopsuf <> 4
6.32 c                   exfmt     f15wi3
6.32 c                   goto      end_saldo
6.32 c                   endif
6.31  * Hent beløp fra ordrehodet
6.31 c                   eval      f15bel = fotots-fototr
6.31 c                   if        fomkod = 0
6.31 c                   eval      f15bel = f15bel * 1.25
6.31 c                   endif
6.31  *
6.31 c                   exfmt     f15wi2
6.31  *
6.31 c                   if        *inkc or *inkl
6.31 c                   leavesr
6.31 c                   endif
6.31  *
6.31  * Finner registreringsrutine
6.31  *
6.31 c                   eval      f15tx1 = *blanks
6.31 c                   eval      f15tx2 = *blanks
6.31 c                   eval      f15tx3 = *blanks
6.31 c                   eval      d_list = *blanks
6.31  * Sjekk først om det finnes kort på kunden
6.31 c                   eval      rukrl5_ktyp = fopsuf
6.31 c                   eval      rukrl5_kkun = fokund
6.31 c                   eval      rukrl5_kpro = 0
6.31 c     rukrl5_key    chain     rukrl5
6.31 c                   if        %found     and
6.31 c                             rukobl = 1
6.31  * Hent neste ledige nummer
6.31 c                   exsr      hnt_nummer
6.31  *
6.31 c                   move      rukknr        d_kort
6.31 c                   eval      d_belh = f15bel
6.31 c                   eval      d_belop = f15bel
6.31 c                   eval      d_beld = d_desi
6.38 c                   eval      d_sfir = %char(l_firm)
6.38 c                   eval      d_avde = %char(foavde)
6.31 c                   eval      p_osta = *blanks
6.31 c                   eval      d_skil = '.'
6.31 c                   eval      d_des0 = ';'
6.31 c                   eval      d_des1 = ';'
6.38 c                   eval      d_des2 = ';'
6.38 c                   eval      d_des3 = ';'
6.31 c                   eval      p_list = d_list
6.31 c                   eval      p_rkey = d_rkey
6.31  *
6.31 c                   call      'AP511C'
6.31 c                   parm                    p_rkey
6.31 c                   parm                    p_list
6.31 c                   parm                    p_osta
6.31  *
6.31 c                   if        p_osta = '1'
6.31 c                   eval      f15tx1 = 'Saldosjekk er OK.'
6.31 c                   endif
6.31  *
6.31 c                   if        p_osta = '2'
6.31 c                   eval      f15tx1 = 'Ikke dekning på kortet,'
6.31 c                   eval      f15tx2 = 'eller kortet er ugyldig'
6.31 c                   endif
6.31  *
6.31 c                   if        p_osta = '3'
6.31 c                   eval      f15tx1 = 'Kortnummer er ugyldig'
6.31 c                   endif
6.31  *
6.31 c                   if        p_osta = 'E'
6.31 c                   eval      f15tx1 = 'Feil under innhenting av'
6.31 c                   eval      f15tx2 = 'saldo.'
6.31 c                   endif
6.31  * Kunden har ikke "riktig" kort
6.31 c                   else
6.31 c                   eval      f15tx1 = 'Kortinformasjon er ikke'
6.31 c                   eval      f15tx2 = 'tilgjengelig'
6.31 c                   endif
6.31  * Hvis returkode ?, er det ikke dekning
6.31 c                   exfmt     f15win
6.31  *
6.31 c     end_saldo     endsr
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Subrutine for etablering av batchnummer
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     hnt_nummer    begsr
6.31  *
6.31  * Hent jobbnummer
6.31  *
6.31 c                   eval      w_kode = '0'
6.31 c                   eval      w_firm = l_firm
6.31 c                   eval      w_fell = 'NXTKLI'
6.31 c                   eval      w_rtyp = *blank
6.31 c                   eval      w_fast = *blank
6.31 c                   eval      w_rnum = *zero
6.31  *
6.31 c                   call      'AS100R'
6.31 c                   parm                    w_kode
6.31 c                   parm                    w_firm
6.31 c                   parm                    w_fell
6.31 c                   parm                    w_rtyp
6.31 c                   parm                    w_fast
6.31 c                   parm                    w_rnum
6.31  *
6.31 c                   eval      d_rnum = w_rnum
6.31  *
6.31 c                   endsr
6.31  *
6.32  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.32  * Subrutine for sjekk om kortmodul er innstallert
6.32  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.32  *
6.32 c     sjk_modul     begsr
6.32  *
6.32  * Finnes modul ?
6.32  *
6.32 c                   eval      w_modu = c_modu
6.32 c                   eval      w_disp = '1'
6.32 c                   eval      w_stat = '0'
6.32 c                   eval      b_modul = *on
6.32  *
6.32 c                   call      'AX700R'
6.32 c                   parm                    w_modu
6.32 c                   parm                    w_disp
6.32 c                   parm                    w_stat
6.32  *
6.32 c                   if        w_stat = '1'
6.32 c                   eval      b_modul = *off
6.32 c                   endif
6.32  *
6.32 c                   endsr
6.32  *
7.xx  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.xx  * Subrutine for ny innlesning av subfile
7.xx  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.xx  *
7.xx c     forny_alt     begsr
7.xx  *
7.xx  *
7.xx c                   eval      fodtl1_line = 0
7.xx c     fodtl1_key    setll     fodtl1
7.xx  *
7.xx c                   exsr      clr_subfile
7.xx c                   exsr      crt_subfile
7.xx  *
7.xx  * Henter ordre-total
7.xx  *
7.xx c                   exsr      hent_total
7.xx  *
7.xx c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for fornying av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     forny         begsr
      *
     c                   if        w_fcrn <> 0
     c     w_fcrn        chain     b1sfl
     c                   endif
      *
     c                   eval      fodtl1_line = b1line
     c     fodtl1_key    setll     fodtl1
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
      * Henter ordre-total
      *
     c                   exsr      hent_total
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å vise sist registrerte linje nederst på siden
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppdat_side   begsr
      *
     c                   eval      fodtl1_line = 9999
      *
     c                   exsr      clr_subfile
      *
     c                   eval      *in15 = *on
     c                   exsr      bck_subfile
      *
      * Henter ordre-total
      *
     c                   exsr      hent_total
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for registrering av ny ordre-linje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     registrer     begsr
      *
     c                   eval      b_oppr = *off
     c                   eval      b_feil = *off
      *
     c                   eval      b2vare = %trim(b2vare)
      *
      * Validering
      * Linjetype må finnes
      *
     c                   eval      vltyl1_ltyp = b2ltyp
     c     vltyl1_key    chain     vltyl1                             90
     c                   if        *in90 = *on
     c                   eval      b_feil = *on
     c                   eval      *in31 = *on
     c                   leavesr
     c                   endif
      *
      * Tekst-linjetype og vare kan ikke oppgis samtidig
      *
     c                   if        valktx = 1 and
     c                             b2vare <> *blank
     c                   eval      b_feil = *on
     c                   eval      *in32 = *on
     c                   leavesr
     c                   endif
      *
      * Vare må oppgis sammen med vare-linjetype
      *
     c                   if        valktx = 0 and
     c                             b2vare = *blank
     c                   eval      b_feil = *on
     c                   eval      *in33 = *on
     c                   leavesr
     c                   endif
6.3d  *
6.3d  * ikke lov å bruke std. varenr fra shop
6.3d  *
6.3g c                   if         (baavar <> *blank and
6.3g c                              b2vare = baavar) or
7.05 c*                             (baagva <> *blank and
7.05 c*                             b2vare = baagva) or
6.3g c                              (baadva <> *blank and
6.3g c                              b2vare = baadva)
6.3d c                   eval      b_feil = *on
6.3d c                   eval      *in51 =  *on
6.3d c                   leavesr
6.3d c                   endif
     c
7.05 c                   if        (u_gavk = *off) and
7.05 c                             (baagva <> *blank and
7.05 c                              b2vare = baagva)
7.05 c                   eval      b_feil = *on
7.05 c                   eval      *in51 =  *on
7.05 c                   leavesr
7.05 c                   endif
     c
      *
      * Identifisering/validering av vare
      *
     c                   if        b2vare <> *blank
     c                   exsr      ident_vare
     c                   if        b_feil = *on
     c                   leavesr
     c                   endif
     c                   endif
      *
      * Behandling avhengig av linjetype
      *
     c                   if        valktx = 0
     c                   exsr      reg_vare
     c                   else
     c                   exsr      tekstlinje
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for registrering av varelinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     reg_vare      begsr
      *
      * Kaller registreringsrutine
      *
     c                   eval      w_vare = b2vare
      *
6.33 c                   if        w_lvre = 1
6.33 c                   eval      w_lvre = 0
6.33 c                   call      'FD120R'
6.33 c                   parm                    b_oppr
6.33 c                   parm                    w_firm
6.NU c                   parm                    w_numm
6.33 c                   parm                    w_suff
6.33 c                   parm                    w_line
6.33 c                   parm                    b2ltyp
6.33 c                   parm                    b2lety
6.33 c                   parm                    w_vare
6.33 c                   parm                    b2anta
      *
6.12 c*                  eval      w_enhe = *blank
      *
6.33 c                   else
7.17  * Kall program for kalkulering av priser
7.17 c                   if        u_717 = *on
7.28ac                   if        1=2
7.17 c                   call      'ZI110R'
7.17 c                   parm                    fokund
7.17 c                   parm                    fonumm
7.17 c                   parm                    folage
7.17 c                   parm                    foavde
7.17 c                   parm                    w_vare
7.17 c                   parm                    w_enhe
7.28ac                   endif
7.17 c                   endif
7.17  *
7.19 c                   if        u_719 = *on
7.19 c                   call      'FD105R'
7.19 c                   parm                    b_oppr
7.19 c                   parm                    w_firm
7.19 c                   parm                    w_numm
7.19 c                   parm                    w_suff
7.19 c                   parm                    w_line
7.19 c                   parm                    b2ltyp
7.19 c                   parm                    b2lety
7.19 c                   parm                    w_vare
7.19 c                   parm                    b2anta
7.19 c                   parm                    w_enhe
7.19 c                   parm                    b_kost
7.19 c                   parm                    w_gtin
7.19 c                   parm                    w_flag
7.fd c                   parm                    w_erst
7.19 c                   else
     c                   call      'FD105R'
     c                   parm                    b_oppr
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_line
     c                   parm                    b2ltyp
     c                   parm                    b2lety
     c                   parm                    w_vare
     c                   parm                    b2anta
     c                   parm                    w_enhe
     c                   parm                    b_kost
6.12 c                   parm                    w_gtin
7.19 c                   parm                    w_flag
7.fd c                   parm                    w_erst
7.19 c                   endif
6.33 c                   endif
      *
     c                   if        b_oppr = *on
     c                   eval      p_stat = *on
Q.07  *
Q.07  * Kall program for synking med bestilling
Q.07  *
Q.07 c                   call      'QD100R'
Q.07 c                   parm                    w_firm
Q.07 c                   parm                    w_numm
Q.07 c                   parm                    w_suff
Q.07 c                   parm                    w_line
     c                   endif
      *
     c                   eval      *in49 = b_kost
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for identifisering/validering av vare
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     ident_vare    begsr
      *
6.12 c                   eval      w_enhe = *blank
6.12 c                   eval      w_gtin = 0
      *
      * Identifisering av vare foregår etter følgende rekkefølge, hvor
      * lengden på varenummeret, og om varenummer er alfa eller numerisk
      * er avgjørende:
      *
      * 1) alfa:
      *      - Lev. varenummer (første 15 pos.)
      * 2) num + lengde = 26:
      *      - EAN-128
      * 3) num + lengde <= 8:
      *      - Varenr
6.11  * 4) num + lengde <= 14:
      *      - EAN-nummer
      * 5) num + lengde < 26:
      *      - Lev. varenummer (første 15 pos.)
      *
      * Finner lengde og sjekker om varenummer inneholder alfa-verdi
      *
     c                   eval      w_leng = %len(%trim(b2vare))
      *
     c     digit         check     b2vare        w_posi
      *
      * Behandling dersom alfa
      *
     c                   if        w_posi > 0
      *
6.31  * sjekker om logistikk-vare
6.31 c                   eval      w_lv_vare = *blank
6.31 c/exec sql
6.31 c+ select vvlvnr
6.31 c+ into   :w_lv_vare
6.31 c+ from   vvlepf
6.31 c+ where  vvllva = :b2vare
6.31 c+ fetch first 1 rows only
6.31 c/end-exec
6.31 c                   if        w_lv_vare <> *blank
6.31 c                   eval      b2vare = w_lv_vare
6.31 c                   leavesr
6.31 c                   endif
      *
     c                   eval      vvarl4_lvar = b2vare
     c     vvarl4_key    chain     vvarl4
     c                   if        %found
     c                   eval      b2vare = vvvare
     c                   leavesr
     c                   endif
6.30  *
6.30  * Dette skal ses på som varesøk
6.30  *
6.30 c                   eval      p_vare = %trim(b2vare)
6.30 c                   call      'FD102R'
6.30 c                   parm                    p_stat
6.30 c                   parm                    w_firm
6.30 c                   parm                    w_numm
6.30 c                   parm                    w_suff
6.30 c                   parm                    w_line
6.30 c                   parm                    b_kost
6.30 c                   parm                    p_vare
7.f4 c                   parm                    b_depo
6.30 c                   eval      *in49 = b_kost
6.30 c                   eval      b_oppr = *on
6.30 c                   eval      p_stat = *on
6.30 c**                 exsr      oppdat_side
6.30 c                   leavesr
      *
     c                   eval      b_feil = *on
     c                   eval      *in35 = *on
     c                   leavesr
      *
     c                   endif
      *
      * Behandling dersom lengde = 26
      *
     c                   if        w_leng = 26
      *
     c                   eval      d_e128 = b2vare
     c                   eval      w_eann = d_eann
6.11 c                   call      'VE710R  '
6.11 c                   parm                    w_firm
6.11 c                   parm                    w_eann
6.11 c                   parm                    w_eava
6.11 c                   parm                    w_eaen
6.11 c                   parm                    w_east
6.11 c                   if        w_east = '1'
6.12 c                   eval      w_enhe = w_eaen
6.12 c                   eval      w_gtin = d_eann
6.11 c                   eval      vvarl1_vare = w_eava
6.12 c     vvarl1_key    chain     vvarl1
     c                   if        %found
     c                   eval      b2vare = vvvare
     c                   eval      b2anta = d_anta
     c                   leavesr
     c                   endif
     c                   endif
      *
     c                   eval      b_feil = *on
     c                   eval      *in35 = *on
     c                   leavesr
      *
     c                   endif
      *
      * Behandling dersom lengde <= 8
      *
     c                   if        w_leng <= 8
      *
     c                   eval      w_vare = %subst(null:1:8-w_leng) + b2vare
      *
     c                   eval      vvarl1_vare = w_vare
     c     vvarl1_key    chain     vvarl1
     c                   if        %found
     c                   eval      b2vare = vvvare
     c                   leavesr
     c                   endif
8.18  *
8.18  * sjekker om det er en del av en logistikkvare
8.18  *
8.18 c                   eval      w_lv_vare = *blank
8.18 c                   eval      w_nobb = %dec(w_vare:8:0)
8.18 c/exec sql
8.18 c+ select vvlvnr
8.18 c+ into   :w_lv_vare
8.18 c+ from   vvlepf
8.18 c+ where  vvlnob = :w_nobb
8.18 c+ fetch first 1 rows only
8.18 c/end-exec
8.18 c                   if        w_lv_vare <> *blank
8.24 c                   eval      b2vare = w_lv_vare
8.24 c*                  eval      b2vare = *blanks
8.24 c*                  eval      *in35 = *on
8.25  * Sjekk om foretrukket nobbnummer til logistikkvare er samme som
8.25  * angitt som søkenummer.
8.25 c                   eval      p_logg_vare = w_lv_vare
8.25 c                   eval      p_lage_inn = folage
8.25 c                   eval      p_vtyp = *blanks
8.25 c                   eval      p_udat = *loval
8.25 c                   eval      p_ldor = 0
8.25 c                   call      'VL710R'
8.25 c                   parm                    w_firm
8.25 c                   parm                    p_logg_vare
8.25 c                   parm                    p_lage_inn
8.25 c                   parm                    p_vtyp
8.25 c                   parm                    p_udat
8.25 c                   parm                    p_ldor
8.25 c                   parm                    b_inlr
8.25 c                   parm                    p_lv_nobb
8.25 c                   parm                    p_lv_modn
8.25 c                   parm                    p_lv_lldo
8.25 c                   parm                    p_lv_llva
8.25 c                   if        w_nobb <> p_lv_nobb
8.25 c                   eval      w_mld1 = 'NOBB nr er knyttet til logistikk+
8.25 c                                      nummer ' + %trim(w_lv_vare)
8.25 c                   eval      w_mld2 = 'Foretrukket nobbnummer +
8.25 c                                      er ' + %char(p_lv_nobb) + ' og vil +
8.25 c                                      bli'
8.25 c                   eval      w_mld3 = 'brukt i registrering'
8.25 c                   call      'AA031R'
8.25 c                   parm                    w_mld1
8.25 c                   parm                    w_mld2
8.25 c                   parm                    w_mld3
8.25 c                   endif
8.25  *
8.18 c                   leavesr
8.18 c                   endif
      *
7.ff c**                 if        w_lvre = 1
8.14 c                   if        *in56 = *off
6.33 c                   eval      jvarl1_vare = w_vare
6.33 c     jvarl1_key    chain     jvarl1
6.33 c                   if        %found(jvarl1)
7.ff c                   eval      w_lvre = 1
6.33 c                   eval      b2vare = jvvare
6.33 c                   leavesr
6.33 c                   endif
8.14 c                   endif
7.ff c**                 endif
      *
     c                   endif
      *
      * Behandling dersom lengde <= 13
      *
     c                   if        w_leng <= 13
      *
6.11 c                   eval      w_eanx = %subst(null:1:14-w_leng) +
     c                                      B2vare
      *
6.11 c                   movel     w_eanx        w_eann
6.11 c                   call      'VE710R  '
6.11 c                   parm                    w_firm
6.11 c                   parm                    w_eann
6.11 c                   parm                    w_eava
6.11 c                   parm                    w_eaen
6.11 c                   parm                    w_east
6.11 c                   if        w_east = '1'
6.12 c                   eval      w_enhe = w_eaen
6.12 c                   eval      w_gtin = w_eann
6.11 c                   eval      vvarl1_vare = w_eava
     c     vvarl1_key    chain     vvarl1
     c                   if        %found
     c                   eval      b2vare = vvvare
     c                   leavesr
     c                   endif
     c                   endif
      *
     c                   endif
      *
      * Behandling dersom lengde < 26 (samlepost)
      *
6.31  * sjekker om logistikk-vare
6.31 c                   eval      w_lv_vare = *blank
6.31 c/exec sql
6.31 c+ select vvlvnr
6.31 c+ into   :w_lv_vare
6.31 c+ from   vvlepf
6.31 c+ where  vvllva = :b2vare
6.31 c+ fetch first 1 rows only
6.31 c/end-exec
6.31 c                   if        w_lv_vare <> *blank
6.31 c                   eval      b2vare = w_lv_vare
6.31 c                   leavesr
6.31 c                   endif
      *
     c                   eval      vvarl4_lvar = b2vare
     c     vvarl4_key    chain     vvarl4
     c                   if        %found
     c                   eval      b2vare = vvvare
     c                   leavesr
     c                   endif
6.30  *
6.30  * Dette skal ses på som varesøk
6.30  *
6.30 c                   if        %trim(b2vare) <> *blanks
6.30 c                   eval      p_vare = %trim(b2vare)
6.30 c                   call      'FD102R'
6.30 c                   parm                    p_stat
6.30 c                   parm                    w_firm
6.30 c                   parm                    w_numm
6.30 c                   parm                    w_suff
6.30 c                   parm                    w_line
6.30 c                   parm                    b_kost
6.30 c                   parm                    p_vare
7.f4 c                   parm                    b_depo
6.30 c                   eval      *in49 = b_kost
6.35 c                   eval      b_oppr = *on
6.35 c                   eval      p_stat = *on
6.35 c*                  exsr      oppdat_side
6.30 c                   leavesr
6.30 c                   endif
      *
      * Setter feil-indikator dersom vare ikke ble funnet
      *
     c                   eval      b_feil = *on
     c                   eval      *in35 = *on
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for registrering av tekstlinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tekstlinje    begsr
      *
     c                   call      'FD110R'
     c                   parm                    b_oppr
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_line
     c                   parm                    b2ltyp
      *
     c                   if        b_oppr = *on
     c                   eval      p_stat = *on
Q.07  *
Q.07  * Kall program for synking med bestilling
Q.07  *
Q.07 c                   call      'QD100R'
Q.07 c                   parm                    w_firm
Q.07 c                   parm                    w_numm
Q.07 c                   parm                    w_suff
Q.07 c                   parm                    w_line
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     subfile       begsr
      *
     c                   eval      b_forn = *off
      *
     c                   eval      w_virn = w_fcrn
      *
      * Leser og behandler subfile
      *
     c                   do        w_ssrn
     c                   readc     b1sfl
      *
     c                   if        %eof
     c                   leave
     c                   endif
      *
     c                   eval      w_virn = w_srrn
7.2l  *
7.2l  *  Sjekk om tilgang til valg
7.2l  *
7.2l c                   if        w_pakk_sperr = 'J'
7.2l c                   if           b1valg =  0
7.2l c                             or b1valg =  5
7.2l c                             or (b1valg = 2 and b1lktx = 1)
7.2l c                             or (b1valg = 4 and b1lktx = 1)
7.2l c                   eval      b1valg = b1valg
7.2l c                   else
7.2l c                   eval      w_mld1 = 'Bruker er sperret for dette valg'
7.2l c                   call      'AA005R'
7.2l c                   parm                    w_mld1
7.2l c                   eval      b1valg = 0
7.2l c                   update    b1sfl
7.2l c                   iter
7.2l c                   endif
7.2l c                   endif
      *
      * Legg til linje
      *
7.xx c**                 if        b1valg = 1
7.xx c                   if        b1valg = 9
     c                   exsr      legg_til
     c                   eval      b1valg = 0
6.3l  * sjekk farge
6.3l c                   eval      w_jvqvnr = b1vare
6.3l c                   exsr      finn_logivar
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Endre linje
      *
     c                   if        b1valg = 2
     c                   exsr      endre_linje
     c                   eval      b1valg = 0
7.08 c                   exsr      sjekk_farge
6.3l  * sjekk farge
6.3l c                   eval      w_jvqvnr = b1vare
6.3l c                   exsr      finn_logivar
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Slett linje
      *
     c                   if        b1valg = 4
     c                   exsr      slett_linje
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vis linje
      *
     c                   if        b1valg = 5
     c                   exsr      vis_linje
     c                   eval      b1valg = 0
6.3l  * sjekk farge
6.3l c                   eval      w_jvqvnr = b1vare
6.3l c                   exsr      finn_logivar
     c                   update    b1sfl
     c                   iter
     c                   endif
7.fb  *
7.fb  * Bytt varlinje
7.fb  *
7.fb c                   if        b1valg = 6
7.fb c                   if        sk100p = 1
7.fb c                   eval      s6vare = b1vare
7.fb c                   exsr      Xs6win
7.fb c                   eval      w_erst = 0
7.fb c                   eval      b1valg = 0
7.fb c                   update    b1sfl
7.fb c                   iter
7.fb c                   endif
7.fb c                   endif
7.26  *
7.26  * Bytt varenr
7.26  *
7.26 c                   if        b1valg = 8
7.26 c                   eval      s2vare = b1vare
7.26 c                   exsr      Xs8win
7.26 c                   eval      w_erst = 0
7.26 c                   eval      b1valg = 0
7.26 c                   update    b1sfl
7.26 c                   iter
7.26 c                   endif
      *
     c                   enddo
      *
     c                   if        b_forn = *on
7.25 c*                   exsr      forny_alt
7.25 c                   exsr      forny
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Sjekk om totalbeløp er under grensen for å få rabatt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_rabatt  begsr
      *
      * Utfør beregninger
      *
     c                   eval      w_rgrn = faagrn
      *
      * Hent opplysninger fra kunde
      *
     c                   eval      rkunl1_kund = b2kund
     c     rkunl1_key    chain     rkunl1
     c                   if        %found and
     c                             rkfagr <> 0
     c                   eval      w_rgrn = rkfagr
     c                   endif
      *
      * Dersom det er rabatt på denne ordren, sjekkes det om
      * nettobeløp er mindre enn rabattgrense
      *
     c                   if        w_totr > 0 and
     c                             b2nett < w_rgrn
      *
      * Hent opplysninger fra ordretype-register
      *
     c                   eval      votyl1_otyp = b2otyp
     c     votyl1_key    chain     votyl1
      *
      * Sender opp skjermbilde dersom pakkseddel eller faktura
      *
     c                   if        vaoakk = 2 or
     c                             vaoakk = 3
      *
     c                   eval      r1rgrn = w_rgrn
     c                   eval      r1nett = b2nett
     c                   eval      r1valg = 1
      *
     c     r1tagb        tag
      *
     c                   exfmt     r1win
      *
      * F3=Avslutt
      *
     c                   if        *inkc or *inkl
     c                   eval      *inkc = *on
     c                   leavesr
     c                   endif
      *
      * Slett rabatt på ordrelinjene og oppdater ordren på nytt
      *
     c                   if        r1valg = 1
      *
     c     fodtlu_key2   setll     fodtlu
     c     fodtlu_key2   reade     fodtlur
     c                   dow       not %eof
      *
     c                   eval      fdrab1 = 0
     c                   eval      fdrab2 = 0
     c                   eval      fdsumr = 0
      *
6.10 c                   time                    fdedat
6.10 c                   time                    fdetim
6.10 c                   eval      fdeusr = l_user
     c                   update    fodtlur
      *
     c     fodtlu_key2   reade     fodtlur
     c                   enddo
      *
     c                   endif
     c                   endif
     c                   endif
      *
     c                   endsr
5.64  *
5.64  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.64  * Sjekk om total almenningsrabatt overstiger grensen
5.64  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.64  *
5.64 c     sjekk_almrab  begsr
5.64  *
5.64 c                   eval      w_stop = *off
5.64 c                   eval      s_gral = 0
5.64 c                   eval      s_kjal = 0
5.64 c                   eval      f2over = 0
5.64  *
5.64  * Hent opplysninger fra kunde
5.64  *
5.64 c                   eval      rkunl1_kund = b2kund
5.64 c     rkunl1_key    chain     rkunl1
6.22  * Hent inn memosaldo
6.22 c     rkunl1_key    chain     rkmel1
5.64  * Benytt beløpsgrense almenning fra kunde dersom utfylt
5.64  *
5.64 c                   if        rkgral <> 0
5.64 c                   eval      s_gral = rkgral
5.64  *
5.64 c                   else
5.64  *
5.64  * Ellers hent beløpsgrense almenning
5.64  *
5.64 c                   call      'FO106R'
5.64 c                   parm                    b2kund
5.64 c                   parm                    w_bgrn
5.64  *
5.64 c                   eval      s_gral = w_bgrn
5.64 c                   endif
5.64  *
5.64 c                   eval      s_kjal = rkkjal +  rkmema
5.64  *
5.64  * Sjekk,  Har kunden overskredet beløpsgrense almenning
5.64  *
5.64 c                   if        s_gral <> 0 and
5.64 c                             s_kjal >  s_gral
5.64 c                   eval      f2over = (s_gral - s_kjal)
5.64 c                   eval      w_stop = *on
5.64 c                   endif
5.64  *
5.64 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Sjekk kredittgrense
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_kunde   begsr
      *
      * Hent opplysninger fra ordre
      *
     c     fohel1_key    chain     fohel1
      *
      * Sjekk, er totalsum på ordren <> 0
      *
     c                   if        fotots <> 0
      *
      * Hent opplysninger fra ordretype-register
      *
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1
      *
      * Sjekk, oppdaterer denne akkumlatoretypen "memosaldo"
      *
     c                   if        vaoakk <> 0
6.25  *
6.25  * Sjekker om kundeprosjekt skal legge ut ByggDok
6.25  *
6.25 c                   eval      b_bdo2 = *off
6.25 c                   eval      b_bdo4 = *off
6.25 c                   if        b_bdo1 = *on
6.26 c                   eval      fkprl1_kund = fokund
6.26 c                   eval      fkprl1_kpro = fokpro
6.26 c     fkprl1_key    chain     fkprl1r
6.3c c                   if        %found(fkprl1)
6.3c c                   if        flbdok = 1 or
6.3c c                             flcobu = 1
6.25 c                   time                    w_btms
6.25 c                   eval      b_bdo2 = *on
6.3c c                   endif
6.25 c                   endif
6.25 c                   eval      b_bdo3 = *on
6.25 c                   endif
      *
      * Hent opplysninger fra kunderegister
      *
Q.082c                   eval      b_kred = *off
     c                   move      fokund        rkunl1_kund
     c     rkunl1_key    chain     rkunl1                             90
6.22  * hent inn informasjon om memosaldo
6.22 c     rkunl1_key    chain     rkmel1                             90
      * Sjekk, er kredittgrense overskredet
      *
     c                   if        rkgrns <> 0
8.08 c                   if        u_kmem = *on
8.12 c                   eval      w_ksal = rksald +
8.12 c**                                    (rkmems * w_mvat)
8.12 c                                      rkmems
8.11 c                   eval      w_memodat = w_date + %days(w_memodagr)
8.12 c                   if        foldat > w_memodat
8.12 c                   eval      w_ksal = w_ksal -
8.12 c                                      (fotots - fototr) * w_mvat
8.11 c                   endif
7.13  *   Utvide kreditgrense   (Mestergruppen løsning 2017_01)  sst
7.13 c                   if        w_ksal > rkgrns * 1000
7.13 c                   eval      w_kgrn = rkgrns * 1000 *
7.13 c                                      (1+w_utvgrns/100)
7.13 c                   else
7.13 c                   eval      w_kgrn = rkgrns * 1000
7.13 c                   endif
     c                   else
6.3j c                   if        (rksald + (rkmems * w_mvat)) < 999999999,99
8.12 c*                  eval      w_ksal = rksald + (rkmems * w_mvat)
8.12 c                   eval      w_ksal = rksald + rkmems
6.3j c                   else
6.3j c                   eval      w_ksal = 999999999,99
6.3j c                   endif
     c                   eval      w_kgrn = rkgrns * 1000
7.13 c                   endif
     c                   eval      g1totl = w_ksal - w_kgrn
      *
8.15 c                   eval      *in41 = *off
8.15 c                   if        w_ksal <= w_kgrn
8.15 c                             and ((fotots - fototr) * w_mvat) > w_kgrn
8.15 c                   eval      *in41 = *on
8.15 c                   eval      g1totl = w_kgrn
8.15 c                   endif
8.15  *
     c                   if        w_ksal > w_kgrn
8.15 c                             or ((fotots - fototr) * w_mvat) > w_kgrn
      *
      * Kredittgrense er overksredet, send g1win
      *
     c     g1tagb        tag
      *
6.3i  * Skal ikke vise bilde dersom kreditgrense er oversteget,
6.3i  * skal kun vise og vedlikeholde tekstlinjer
6.3i c                   if        p_txtl = *blank
Q.082c                   eval      b_kred = *on
     c                   exfmt     g1win
6.3i c                   endif
      *
      * F3=Avslutt
      *
     c                   if        *inkc or *inkl
     c                   eval      *inkc = *on
     c                   leavesr
     c                   endif
      *
      * F6=Fjern ordren fra ordre-register
      *    Legg ut vindu for slettegrunn
      *
     c                   if        *inkf = *on
      *
     c                   eval      g2numm = fonumm
     c                   eval      g2navn = fonavn
     c                   eval      g2kom1 = *blank
     c                   eval      g2kom2 = *blank
      *
     c     g1tagc        tag
      *
6.3i  * Skal ikke vise bilde dersom kreditgrense er oversteget,
6.3i  * skal kun vise og vedlikeholde tekstlinjer
6.3i c                   if        p_txtl = *blank
     c                   exfmt     g2win
6.3i c                   endif
      *
      * F3=Avslutt
      *
     c                   if        *inkc or *inkl
     c                   goto      g1tagb
     c                   endif
      *
      * Slettegrunn kan ikke være blank
      *
     c                   if        g2kom1 = *blank and
     c                             g2kom2 <> *blank
     c                   eval      g2kom1 = g2kom2
     c                   eval      g2kom2 = *blank
     c                   endif
      *
     c                   if        g2kom1 = *blank
     c                   eval      *in31 = *on
     c                   goto      g1tagc
     c                   endif
      *
      * Kaller opp subprogrammet for sletting av ordre
      *
     c                   eval      w_stat = *blank
     c                   eval      w_type = 'KRED'
      *
     c                   call      'FO410R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    w_type
     c                   parm                    g2kom1
     c                   parm                    g2kom2
5.01 c                   parm                    w_opdt
      *
     c                   eval      b_slet = *on
      *
     c                   leavesr
     c                   endif
      *
      * F18=Godkjenn overskridelsen
      *
     c                   if        *inks
6.13 c                   if        rkkgrk = 'J'
6.3i  * Skal ikke vise bilde dersom kreditgrense er oversteget,
6.3i  * skal kun vise og vedlikeholde tekstlinjer
6.3i c                   if        p_txtl = *blank
6.13 c                   exfmt     g3win
6.13 c                   goto      g1tagb
6.3i c                   endif
     c                   else
     c                   leavesr
6.3i c***                endif
6.13 c                   endif
     c                   endif
      *
      * Oppdaterer ordre-register med kode for at ordren er på venting
      *
     c                   if        g1valg = 1
     c                   call      'FO709R'
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c     fohelu_key    chain     fohelur                            90
     c                   if        *in90 = *off
     c                   eval      fokode = 5
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   endif
     c                   leavesr
     c                   endif
      *
     c                   goto      g1tagb
     c                   endif
     c                   endif
      *
     c                   endif
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Sjekk oppdatering/utskrift/utplukk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     f1subr        begsr
      *
     c                   eval      w_stat = *blank
      *
      * Oppdater ordrehode med verdier fra varelinjer
      *
     c                   call      'FO730R'
     c                   parm                    w_enor
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
      *
      * Initierer skjermbilde
      *
     c                   eval      f1best = 0
7.19 c                   if        u_719 = *on
7.19 c                   eval      f1valg = '1'
7.19 c                   else
7.xx c                   eval      f1valg = '0'
7.19 c                   endif
     c                   eval      f1pluk = 0
      *
     c                   eval      *in77 = *off
     c                   eval      *in78 = *off
      *
      * Henter behandlingskode for ordretype
      *
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1
      *
      * Dersom behandlingskode er 1 åpnes det for valg av "Til bestilling"
      *
     c                   if        vaoakk = 1
     c                   eval      *in77 = *on
     c                   endif
      *
      * Setter f1best=1 dersom ordren inneholder varer som må bestilles
      *
     c                   if        vaoakk = 1
      *
     c                   call      'FO743R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    b_best
      *
     c                   if        b_best = *on
     c                   eval      f1best = 1
     c                   endif
      *
     c                   endif
      *
      * Viser valg for "Klar til plukking" dersom kjørekontorløsning og
      * ordren har behandlingskode 1
      *
7.14 c                   if        u_714 = *on
7.14 c                   if        faakjk = 1 and
7.14 c                             vaoakk = 1 and
7.14 c                             footyp <> 'HO'
7.14 c                   eval      *in78 = *on
7.14 c                   endif
7.14 c                   else
     c                   if        faakjk = 1 and
     c                             vaoakk = 1
     c                   eval      *in78 = *on
     c                   endif
7.14 c                   endif
5.54  *
5.54  * Men . . dersom denne allerede er klar for plukking vises
5.54  * ikke dette valget en gang til
5.54  *
5.54 c                   eval      w_kod2 = '2'
5.54  *
5.61 c                   eval      w_aarr = %subdt(fobdat:*years)
5.54 c                   call      'FU702R'
5.61 c                   parm                    w_aarr
5.54 c                   parm                    fonumm
5.54 c                   parm                    fosuff
5.54 c                   parm                    w_kod2
5.54 c                   parm                    w_sva2
5.54  *
5.54 c                   if        w_sva2 = 'J'
5.54 c                   eval      *in78 = *off
5.54 c                   endif
7.21  *
7.21  * Viser ikke "klar til plukking" dersom leveringstype 1
7.21  *
7.21 c                   if        folety = 1
7.21 c                   eval      *in78 = *off
7.21 c                   endif
      *
      * Send bilde f1win
      *
     c     f1tagb        tag
6.21  *
7.22 c                   exsr      ex_vis_tvare
7.22 c
7.22  ** Sjekker om noen av varene på ordren er linket mot varegr.
7.22  ** for transport, gjøres kun dersom kjørekontor = 1
7.22  ** Hvis ordretype har positivt fortegn
7.22  **
7.22 c*                   if        vaokre = *blank
7.22  **
7.22 c*                   eval      ra17l1_qkod = folmat
7.22 c*     ra17l1_key    chain     ra17l1r
7.22 c*                   if        raqkjo = 1
7.22 c*                   eval      w_varenr = *blanks
7.22 c*                   call      'VR743R'
7.22 c*                   parm                    w_firm
7.22 c*                   parm                    w_numm
7.22 c*                   parm                    w_lmat
7.22 c*                   parm                    w_indi
7.22 c*                   parm                    w_varenr
7.22  **
7.22 c*                   if        w_indi = '1'
7.22 c*                   eval      b2vare = w_varenr
7.22  ** Vi legger automatisk til denne varen på ordren.
7.22 c*                   exsr      ex_add_tral
7.22 c*                   eval      b2vare = *blanks
7.22 c*                   goto      d1tag
7.22 c*                   endif
7.22 c*                   endif
7.22 c*                   endif
6.21  *
7.31  * Sjekker om Proffnett kobling er valgt og om tilbud allerede er flagget
7.31  *
7.31 c                   if        u_731 = *on and
7.31 c                             vaoakk = 0
7.31 c                   eval      *in79 = *on
7.31 c/exec sql
7.31 c+ select Order_tag
7.31 c+ into   :w_proff
7.31 c+ from XNTAST
7.31 c+ where  order_number = :w_numm and order_suffix = :w_suff
7.31 c/end-exec
7.31 c                   if        sqlcod = 100 or sqlstt = '02000'
7.31 c                   eval      f1prof = 0
7.31 c                   eval      b_prof = *off
7.31 c                   else
7.31 c                   eval      b_prof = *on
7.31 c                   if        w_proff = 'Y'
7.31 c                   eval      f1prof = 1
7.31 c                   else
7.31 c                   eval      f1prof = 0
7.31 c                   endif
7.31 c                   endif
7.31 c                   endif
      *
Q.03 c                   if        b_pluk= *off
     c                   exfmt     f1win
Q.03 c                   else
Q.03 c                   eval      f1best = 0
Q.03 c                   eval      f1valg = '0'
Q.03 c                   eval      f1pluk = 1
Q.03 c                   endif
      *
      * F3=Avslutt
      *
     c                   if        *inkc or *inkl
     c                   eval      *inkc = *on
     c                   leavesr
     c                   endif
      *
      * Validering
      *
      *
      * Test på utfylt avdeling
      *
7.2B c                   if        u_avde = *on and
7.2B c                             foavde = 0
7.2B c                   eval      w_mld1 = 'Avdeling må fylles ut +
7.2B c                                       på ordren.'
7.2B c                   call      'AA005R'
7.2B c                   parm                    w_mld1
7.2B c                   goto      f1tagb
7.2B c                   endif
      *
      * Test på gyldig valg
      *
7.xx c                   if        f1valg <> '0' and
7.xx c                             f1valg <> '1' and
7.xx c                             f1valg <> '2'
     c                   eval      *in31 = *on
     c                   goto      f1tagb
     c                   endif
      *
      * Faktura kan ikke plukkes
      *
7.xx c                   if        f1valg = '2' and
     c                             vaoakk = 3
     c                   eval      *in32 = *on
     c                   goto      f1tagb
     c                   endif
      *
      * Behandling dersom "Til bestilling" er valgt
      *
     c                   if        f1best = 1
7.15 c                   if        u_715 = *on
7.15 c                   if        footyp = 'HO'
7.15 c                   exsr      xm1win
7.15 c                   goto      xf1tag
7.15 c                   endif
7.15 c                   endif
6.3f  * depositumsjekk
7.04 c                   if        u_deps = *on
6.3f c                   if        b_krav = *on
6.3f c                   exsr      xf1msg
6.3f c                   goto      f1tagb
6.3f c                   endif
7.04 c                   endif
     c                   if        laaabe = 1
     c                   call      'FO740R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   else
     c                   call      'FO734R'
     c                   parm                    w_retu
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   endif
7.15 c     xf1tag        tag
     c                   endif
      *
6.25  * Hvis valg = 0 og vaoakk = 2, og
6.25  * så må man danne byggdok hvis det er valgt
7.xx c                   if        f1valg = '0' and
6.25 c                             vaoakk = 2 and
6.25 c                             vaokre = *blank
6.25 c                   exsr      byggdok
6.25 c                   endif
      *
      * Når f1valg=0
      * Tilbakestill kode som sier at ordre er opptatt
      *
7.xx c                   if        f1valg = '0'
     c     fohelu_key    chain     fohelur
     c                   if        fokode = 1
     c                   eval      fokode = 0
     c                   move      *loval        fokoda
     c                   move      *loval        fokoti
     c                   eval      fokous = *blank
     c                   eval      fokows = *blank
     c                   endif
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
     c                   endif
5.62  *
5.62  * Behandling dersom "Klar til plukking" er valgt
5.62  *
5.62 c                   if        f1pluk = 1
5.62  *
5.62 c                   exsr      o1subr
5.62 c                   if        *inkc = *on
5.62 c                   leavesr
5.62 c                   endif
5.62 c                   endif
7.31  *
7.31  * Behandling dersom Proffnett tilbud er valgt
7.31  *
7.31 c                   if        u_731 = *on
7.31 c                   if        f1prof = 1
7.31 c                   eval      w_proff = 'Y'
7.31 c                   else
7.31 c                   eval      w_proff = 'N'
7.31 c                   endif
7.31 c                   if        b_prof = *off
7.31 c/exec sql
7.31 c+ insert into XNTAST
7.31 c+ (company,order_number,order_suffix,Order_tag_key,Order_tag)
7.31 c+ values (:w_firm,:w_numm,:w_suff,'NX_PROFF_TILBUD',:w_proff)
7.31 c/end-exec
7.31 c                   else
7.31 c/exec sql
7.31 c+ update XNTAST
7.31 c+ set Order_tag = :w_proff
7.31 c+ where company = :w_firm and order_number = :w_numm and
7.31 c+       order_suffix = :w_suff and Order_tag_key = 'NX_PROFF_TILBUD'
7.31 c/end-exec
7.31 c                   endif
7.31 c                   endif
      *
      * Sjekk, valg=1, dvs. utskrift
      *
7.xx c                   if        f1valg = '1'
     c                   call      'FO600R'
     c                   parm                    w_stat
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   endif
      *
      * Sjekk, valg=2, dvs. utplukk
      *
7.xx c                   if        f1valg = '2'
     c                   call      'FO736R'
     c                   parm                    w_stat
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   endif
      *
      * Sjekk om retur fra annet program
      *
     c                   if        w_stat <> *blank and
7.xx c                             f1valg <> '0'
     c                   eval      *inkc = *on
     c                   leavesr
     c                   endif
      *
      * Behandling dersom "Klar til plukking" er valgt
      *
5.62 c*                  if        f1pluk = 1
5.62  *
5.62 c*                  exsr      o1subr
5.62 c*                  if        *inkc = *on
5.62 c*                  leavesr
5.62 c*                  endif
5.62  *
5.62 c*                  endif
      *
     c                   endsr
6.3f  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.3f  *  Gir melding vedr. depositum krav
6.3f  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.3f  *
6.3f c     xf1msg        begsr
6.3f c                   exfmt     f1msg
6.3f  *
6.3f c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppdatering av tilleggsinformasjon ved kjørekontorløsning
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     o1subr        begsr
      *
      * Initierer skjermbilde
      *
7.2u c                   eval      o1pluk = 0
7.2u c                   if        u_72u = *on
7.2u c                   eval      o1pluk = 1
7.2u c                   endif
      *
     c                   eval      o1ldat = 0
     c                   eval      o1inf1 = foinf1
     c                   eval      o1inf2 = foinf2
      *
     c                   if        foldat <> *loval
     c     *dmy          move      foldat        o1ldat
     c                   endif
      *
      * Send bilde o1win
      *
     c     o1tagb        tag
      *
     c                   exfmt     o1win
      *
      * F3=Avslutt
      *
     c                   if        *inkc or *inkl
     c                   eval      *inkc = *on
     c                   leavesr
     c                   endif
      *
      * F4=Spørring
      *
      *
      * Validering
      *
      *
      * Leveringsdato må oppgis
      *
     c                   if        o1ldat = 0
     c                   eval      *in33 = *on
     c                   goto      o1tagb
     c                   endif
      *
      * Leveringsdato må være en gyldig dato
      *
     c     *dmy          test(d)                 o1ldat                 34
     c                   if        *in34 = *on
     c                   goto      o1tagb
     c                   endif
      *
      * Leveringsdato må være større enn/lik ordre-dato
      *
     c     *dmy          move      o1ldat        w_ldat
     c                   if        w_ldat < fobdat
     c                   eval      *in35 = *on
     c                   goto      o1tagb
     c                   endif
      *
      * Oppdaterer ordre
      *
     c     fohelu_key    chain     fohelur
     c                   eval      foldat = %date(o1ldat:*dmy)
     c                   eval      foinf1 = o1inf1
     c                   eval      foinf2 = o1inf2
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
5.65  *
5.65  * oppdat. status med 0 - betyr at kjørekontor er valgt
5.65  *
5.65 c                   eval      d_firm = fofirm
5.65 c                   eval      d_numm = fonumm
5 65 c                   eval      d_suff = fosuff
5.65 c                   eval      d_kodb = '0'
5.65 c                   exsr      upd_logg
     c                   if        u_710 = *on
     c                   exsr      send_kj_mail
     c                   endif
5.54  *
5.61  * Hvis valg = 2 så oppdateres loggkode i FO614R
5.54  * Oppdaterer loggfilen med klar for plukking
5.54  *
7.xx c                   if        f1valg <> '2'

5.54 c                   eval      d_firm = l_firm
5.54 c                   eval      d_numm = fonumm
5.54 c                   eval      d_suff = fosuff
5.54 c                   eval      d_kodb = '2'
5.65 c                   exsr      upd_logg
      *
6.20  * sjekker om ordre må splittes i flere suffix
6.20  *
6.23 c                   if        faak02 = 1
6.20 c                   call      'FO775R '
6.20 c                   parm                    fofirm
6.NU c                   parm                    fonumm
6.20 c                   parm                    fosuff
6.23 c                   endif
6.20  *
5.61 c                   endif
7.2u  *
7.2u  * Skal plukkliste skrives
7.2u  *
7.2u c                   if        u_72u = *on
7.2u c                   if        o1pluk = 1
7.2u c                   eval      w_retu = *blank
7.2u c                   call      'FO600R'
7.2u c                   parm                    w_retu
7.2u c                   parm                    fofirm
7.2u c                   parm                    fonumm
7.2u c                   parm                    fosuff
7.2u c                   endif
7.2u  *
7.2u  * Sett også automatisk kode 4 for plukking. Koden settes
7.2u  * uavhengig av om utskrift er valgt.
7.2u  *
7.2u c                   eval      d_firm = l_firm
7.2u c                   eval      d_numm = fonumm
7.2u c                   eval      d_suff = fosuff
7.2u c                   eval      d_kodb = '4'
7.2u c                   exsr      upd_logg
7.2u c                   endif
      *
     c                   endsr
      *
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  * Forskuddsbetaling
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  *
7.fb c     xs1win        begsr
7.fb  *
7.fc c*                  if        b_100P = *on
7.fc c*                  eval      w_mld1 = *blank
7.fc c*                  eval      w_mld1 = 'Depositum kan ikke endres!'
7.fc c*                  call      'AA005R'
7.fc c*                  parm                    w_mld1
7.fc c*                  leavesr
7.fc c*                  endif
7.fb  *
7.fb c                   eval      s1100p = 0
7.fb c                   eval      s1depp = 0
7.fb c                   eval      s1depo = 0
7.fb c                   eval      s1bere = 0
7.fe c                   eval      s1akbs = faakbs
7.fb c                   eval      s_depp = 0
7.fb c                   eval      s_depx = 0
7.fb c                   eval      s_depo = 0
7.fb  * Beregn ordretotal
7.fb c                   eval      w_sumi = 0
7.fb c                   eval      w_sumu = 0
7.fb c                   call      'FO704R '
7.fb c                   parm                    w_firm
7.fb c                   parm                    w_numm
7.fb c                   parm                    w_suff
7.fb c                   parm                    w_sumi
7.fb c                   parm                    w_sumu
7.fb c                   eval      s1tota = w_sumi
7.f9  *
7.f9  * Kan ikke legge inn depositum før det finnes ordrelinjer
7.f9  *
7.f9 c                   if        s1tota = 0
7.f9 c                   eval      w_mld1 = *blank
7.f9 c                   eval      w_mld1 = 'Kan ikke legge inn depositum før v-
7.f9 c                             arene !'
7.f9 c                   call      'AA005R'
7.f9 c                   parm                    w_mld1
7.f9 c                   goto      end_xs1win
7.f9 c                   endif
7.fb  *
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
7.fb c     sdepl1_key    chain     sdepl1r
7.fb c                   if        %found(sdepl1)
7.fb c                   eval      s1100p = sk100p
7.fb c                   eval      s_100p = sk100p
7.fb c                   eval(h)   s1depp = skdepp
7.fb c                   eval      s_depx = skdepp
7.fb c                   eval      w_depp = skdepp
7.fb c                   eval      s_depp = skdepp
7.fb c                   eval      s1depo = skdepo
7.fb c                   eval      w_depo = s1depo
7.fb c                   eval      s_depo = s1depo
7.fc c                   eval      s1depb = skdepb
7.fb c                   else
7.fb c                   eval      s1bere = 1
7.fb c                   eval(h)   s1depp = faamap
7.fb c                   eval      s_depx = s1depp
7.fb c                   eval      w_depp = s1depp
7.fb c                   eval      s_depp = faamap
7.fb c                   eval(h)   s1depo = s1tota * s1depp/100
7.fb c                   eval      s_depo = s1depo
7.fb c                   eval      w_depo = s1depo
7.fc c                   eval      s1depb = 0
7.fb c                   endif
7.fc  *
7.fc  * Generell test om depositum er betalt. Da skal det ikke være mulig å endre
7.fc  * eller fjerne depositumskrav.
7.fc  *
7.fc c                   eval      *in60 = *off
7.fc c                   if        skdepo <> 0 and
7.fc c                             skdepb <> 0
7.fc c                   eval      *in60 = *on
7.fc c                   endif
7.fb  *
7.fb  * Send bilde s1win
7.fb  *
7.fb c     S1tagb        tag
7.fb  *
7.fb c                   exfmt     S1win
7.fb  *
7.fb  * F3=Avslutt
7.fb  *
7.fb c                   if        *inkc or *inkl
7.fb c                   eval      *inkc = *on
7.fb c                   leavesr
7.fb c                   endif
7.fe  *
7.fe  * Kan ikke legge inn depositum hvis det er ordretotal er lavere
7.fe  *
7.fe c                   if        s1tota < faakbs
7.fe c                   eval      w_mld1 = *blank
7.fe c                   eval      w_mld1 = 'Ordretotal er under krav for depos-
7.fe c                             itum !'
7.fe c                   call      'AA005R'
7.fe c                   parm                    w_mld1
7.fe c                   goto      end_xs1win
7.fe c                   endif
7.f0  *
7.f0  * F7=Slett depositum
7.f0  *
7.f0 c                   if        *inkg
7.f0  *
7.f0  * Kan ikke ha skrevet ut dokument, siden da blir det generert KID
7.f0  *
7.f0 c                   eval      floglr_aarr = %subdt(w_date:*years)
7.f0 c                   eval      floglr_numm = fonumm
7.f0 c                   eval      floglr_suff = fosuff
7.f0 c     floglr_key    setll     floglr
7.f0 c     floglr_key    reade     floglr
7.f0 c                   dow       not %eof
7.f0 c                   if        fukode > '0'
7.f0 c                   eval      w_mld1 = *blank
7.f0 c                   eval      w_mld1 = 'Ordre er skrevet, kan ikke slette -
7.f0 c                             depositum'
7.f0 c                   call      'AA005R'
7.f0 c                   parm                    w_mld1
7.f0 c                   goto      s1tagb
7.f0 c                   endif
7.f0 c     floglr_key    reade     floglr
7.f0 c                   enddo
7.f0  *
7.f0  * Da sletter vi depositum
7.f0  *
7.f0 c                   eval      sdeplr_numm = fonumm
7.f0 c                   eval      sdeplr_kund = fokund
7.f0 c                   eval      sdeplr_tell = 0
7.f0 c     sdeplr_key    setll     sdeplrr
7.f0 c     sdeplr_key2   reade     sdeplrr
7.f0 c                   dow       not %eof
7.f0 c                   delete    sdeplr
7.f0 c     sdeplr_key2   reade     sdeplrr
7.f0 c                   enddo
7.f0 c                   goto      end_xs1win
7.f0 c                   endif
7.fb  *
7.f2  * logikk for å sette feltene riktig ved endring
7.f2 c                   if        s_100p <> s1100p or
7 f2 c                             s_depp <> s1depp
7.f2  * sjekk hvis endring 100%
7.f2 c                   if        s_100p <> s1100p
7.f2 c                   if        s1100p = 1
7.f2  * 100 % på
7.f2 c                   eval(h)   s1depo = s1tota
7.f2 c                   eval      s1depp = 0
7.f2 c                   else
7.f2  * 100 % av
7.f2 c                   if        s1depp = 0
7.f2 c                   eval      s1depp = faamap
7.f2 c                   eval(h)   s1depo = s1tota * s1depp/100
7.f2 c                   endif
7.f2 c                   if        s1depp <> 0
7.f2 c                   eval(h)   s1depo = s1tota * s1depp/100
7.f2 c                   endif
7.f2 c                   endif
7.f2 c                   eval      s_100p = s1100p
7.f2 c                   eval      s_depx = s1depp
7.f2 c                   eval      w_depp = s1depp
7.f2 c                   eval      s_depp = s1depp
7.f2 c                   eval      w_depo = s1depo
7.f2 c                   eval      s_depo = s1depo
7.f2 c                   endif
7.f2  *
7.f2 c                   if        s_depp <> s1depp
7.f2  * endring på prosent
7.f2 c                   eval      s1100p = 0
7.f2 c                   eval(h)   s1depo = s1tota * s1depp/100
7.f2 c                   eval      s_100p = s1100p
7.f2 c                   eval      s_depx = s1depp
7.f2 c                   eval      w_depp = s1depp
7.f2 c                   eval      s_depp = s1depp
7.f2 c                   eval      w_depo = s1depo
7.f2 c                   eval      s_depo = s1depo
7.f2 c                   endif
7.f2 c                   eval      s1bere = 1
7.f2 c                   goto      s1tagb
7.f2 c                   endif
7.f2  * endring på beløp
7.f2 c                   if        s1depo <> s_depo
7.f2 c                   eval      s1100p = 0
7.f2 c                   eval(h)   s1depp = (s1depo / s1tota)* 100
7.f2 c                   eval      s_100p = s1100p
7.f2 c                   eval      s_depo = s1depo
7.f2 c                   eval      s_depx = s1depp
7.f2 c                   eval      s_depp = s1depp
7.f2 c                   eval(h)   w_depp = s1depp
7.f2 c                   eval      s1bere = 1
7.f2 c                   goto      s1tagb
7.f2 c                   endif
7.fb  *
7.fb  * Validering
7.fb  * hvis 100 % så må man ikke ha prosent
7.fb c                   if        (s1100p <> 0 and
7.fb c                             s1depp <> 0)
7.fb c                   eval      *in31 = *on
7.fb c                   goto      s1tagb
7.fb c                   endif
7.fb  *
7.fb  * ikke lov med høyere depositumsbeløp enntotal
7.fb  *
7.fb c                   if        s1depo > s1tota
7.fb c                   eval      *in32 = *on
7.fb c                   goto      s1tagb
7.fb c                   endif
7.fb  *
7.fb  *
7.fb  * sjekk at Delbetaling % ikke er lavere enn krav i kode
7.fb  * Kun hvis 100 % er av
7.fb  *
7.fb c                   if        s1100p = 0    and
7.fb c                             s1depp < faamap
7.fb c                   eval      *in33 = *on
7.fb c                   goto      s1tagb
7.fb c                   endif
7.fb  *
7.fb c                   if        (w_depp - s_depp) <> 0  or
7.fb c                             s_depx <> s1depp
7.fb c                   if        s1100p = 1
7.fb c                   eval(h)   s1depo = s1tota
7.fb c                   else
7.fb c                   eval(h)   s1depo = s1tota * s1depp/100
7.fb c                   endif
7.fb c                   eval      s_100p = s1100p
7.fb c                   eval      s_depo = s1depo
7.fb c                   eval      s_depx = s1depp
7.fb c                   eval      s_depp = s1depp
7.fb c                   eval      w_depp = s1depp
7.fb c                   eval      s1bere = 1
7.fb c                   goto      s1tagb
7.bf c                   endif
7.bf c*                   if        s1depo <> s_depo
7.bf c*                   eval(h)   s1depp = (s1depo / s1tota)* 100
7.bf c*                   eval      s_depo = s1depo
7.bf c*                   eval      s_depx = s1depp
7.fb c*                   eval      s_depp = (s1depo / s1tota)* 100
7.fb c*                   eval(h)   w_depp = (s1depo / s1tota)* 100
7.fb c*                   eval      s1bere = 1
7.fb c*                   goto      s1tagb
7.fb c*                   endif
7.fb  *
7.fb  * Oppdaterer depositumsfilen, kun 1. gang eller ved
7.fb  * endring av innhold i skjermbildet
7.fb  *
7.fb c                   if        s1bere = 1
7.fb  *
7.fb  * hvis endret flere ganger så lagres 00 --> siste teller
7.fb c                   exsr      finn_siste
7.fb  *
7.fb c                   if        w_tell > 0
7.fb c                   eval      sdeplu_numm = fonumm
7.fb c                   eval      sdeplu_kund = fokund
7.fb c                   eval      sdeplu_tell = 0
7.fb c     sdeplu_key    chain     sdeplur
7.fb c                   if        %found(sdeplu)
7.fb c                   eval      sktell = w_tell
7.fb c                   write     sdeplur
7.fb c                   endif
7.fb c                   endif
7.fb  *
7.fb  * finner valgt depositum
7.fb  *
7.fb c                   eval      w_depo = 0
7.fb c                   if        s1100p = 1
7.fb c                   eval      w_depo =  s1tota
7.fb c                   else
7.fb c                   if        s1depp <> 0
7.fb c                   eval(h)   w_depo = (s1tota * w_depp /100)
7.fb c                   else
7.fb c                   if        s1depo <> 0
7.fb c                   eval(h)   w_depo = s1depo
7.fb c                   endif
7.fb c                   endif
7.fb c                   endif
7.fb  *
7.fb c                   clear                   sdeplur
7.fb c                   eval      sdeplu_numm = fonumm
7.fb c                   eval      sdeplu_kund = fokund
7.fb c                   eval      sdeplu_tell = 0
7.fb c     sdeplu_key    chain     sdeplur
7.fb c                   eval      sk100p = s1100p
7.fb c                   if        sk100p = 1
7.fb c                   eval      sktotu = w_sumu
7.fb c                   endif
7.fb c                   eval      skdepp = w_depp
7.fb c                   eval      skdepo = w_depo
7.fb c                   time                    skedat
7.fb c                   time                    sketim
7.fb c                   eval      skeusr = l_user
7.fb c                   eval      skwsid = l_wsid
7.fb c                   if        %found(sdeplu)
7.fb c                   update    sdeplur
7.fb c                   else
7.fb c                   eval      skfirm = w_firm
7.fb c                   eval      sknumm = sdeplu_numm
7.fb c                   eval      skkund = sdeplu_kund
7.fb c                   eval      sktell = sdeplu_tell
7.fb c                   time                    skodat
7.fb c                   time                    skotim
7.fb c                   time                    skdate
7.fb c                   time                    sktime
7.fb c                   eval      skousr = l_user
7.fb c                   eval      skwsid = l_wsid
7.fb c                   eval      skuser = l_user
7.fb c                   write     sdeplur
7.fb c                   endif
7.fb  * slutt s1bere = 1
7.fb c                   endif
7.fb c**7.f7             eval      *in50 = *off
7.f4 c                   eval      b_depo = *on
7.fb c**7.f7             if        sk100p = 1
7.fb c**7.f7             eval      *in50 = *on
7.fb c**7.f7             endif
7.f9 c     end_xs1win    endsr
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  * Forskuddsbetaling
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  *
7.fb c     xs6win        begsr
7.fb  *
7.fb c                   eval      s6nyva = *blank
7.fb c                   eval      s_line = b1line
7.fb  * tar vare på sum netto på gml. linje
7.fb c                   eval      fodtlr_line = b1line
7.fb c     fodtlr_key    chain     fodtlr
7.fb c                   if        %found
7.fb c                   eval      w_netg = fdsums - fdsumr
7.fb c                   eval      s_benr = fdbenr
7.fb c                   eval      s_bsuf = fdbsuf
7.fb c                   eval      s_blin = fdblin
7.fb c                   endif
7.fb c     s6tagb        tag
7.fb  *
7.fb c                   exfmt     s6win
7.fb  *
7.fb  * F3=Avslutt
7.fb  *
7.fb c                   if        *inkc or *inkl
7.fb c                   eval      *inkc = *on
7.fb c                   leavesr
7.fb c                   endif
7.fb c                   if        *inkd
7.fb c                   call      'VV500R'
7.fb c                   parm                    w_firm
7.fb c                   parm                    w_varenr
7.fb c                   parm                    w_vtxt
7.fb c                   eval      s6nyva = w_varenr
7.fb c                   endif
7.fb  *
7.fb  * Identifisering/validering av vare
7.fb  *
7.fb c                   if        s6nyva <> *blank
7.fb c                   eval      b2vare = s6nyva
7.fb c                   exsr      ident_vare
7.fb c                   if        b_feil = *on
7.fb c                   goto      s6tagb
7.fb c                   endif
7.fb c                   endif
7.fb  *
7.fb c                   exsr      hent_linjenr
7.fb c                   eval      w_line = w_line + 10
7.fb c                   eval      b2ltyp = *blank
7.f1 c                   eval      w_erst = 1
7.fb c                   exsr      reg_vare
7.fb  *
7.fb c                   eval      fodtlr_line = w_line
7.fb c     fodtlr_key    chain     fodtlr
7.fb c                   if        %found
7.fb c                   eval      w_netn = fdsums - fdsumr
7.fb c                   if        w_netn > w_netg
7.fb c                   eval      w_mld1 = 'Ny varelinje har +
7.fb c                                       større verdi enn valg+
7.fb c                                       t linje'
7.fb c                   call      'AA005R'
7.fb c                   parm                    w_mld1
7.fb c                   eval      fodtlu_line = w_line
7.fb c     fodtlu_key    chain     fodtlu
7.fb c                   if        %found(fodtlu)
7.fb c                   delete    fodtlur
7.fb c                   endif
7.fb c                   else
7.fb  * sletter gammel linje
7.fb c                   eval      w_spgm      = 'FD100R'
7.fb c                   call      'FS710R'
7.fb c                   parm                    w_firm
7.fb c                   parm                    w_numm
7.fb c                   parm                    w_suff
7.fb c                   parm                    s_line
7.fb c                   parm                    w_spgm
7.fb c                   eval      fodtlu_line = s_line
7.fb c     fodtlu_key    chain     fodtlu
7.fb c                   if        %found(fodtlu)
7.fb c                   delete    fodtlur
7.fb  *
7.fb  * Oppdaterer lager
7.fb  *
7.fb c                   if        faalag <> 0
7.fb c                   eval      fdanta = fdanta * -1
7.fb c                   exsr      oppdat_lager
7.fb c                   endif
7.fb  *
7.fb  * Sletter lengdespesif.linjer
7.fb  *
7.fb c                   eval      fvlslu_numm = w_numm
7.fb c                   eval      fvlslu_suff = w_suff
7.fb c                   eval      fvlslu_line = fodtlu_line
7.fb c     fvlslu_key    setll     fvlslu
7.fb c     fvlslu_key    reade     fvlslu
7.fb  *
7.fb c                   dow       not %eof
7.fb c                   delete    fvlslur
7.fb c     fvlslu_key    reade     fvlslu
7.fb c                   enddo
7.fb
7.fb c                   endif
7.fb  * oppdaterer med evt. best.data
7.fb c                   eval      fodtlu_line = w_line
7.fb c     fodtlu_key    chain     fodtlu
7.fb c                   if        %found(fodtlu)
7.fb c                   eval      fdbenr = s_benr
7.fb c                   eval      fdbsuf = s_bsuf
7.fb c                   eval      fdblin = s_blin
7.fb c                   update    fodtlur
7.fb c                   endif
7.fb c                   endif
7.fb c                   endif
7.fb c                   eval      b_forn = *on
7.fb c                   endsr
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  * Finn siste teller i depositumsfilen
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  *
7.fb c     finn_siste    begsr
7.fb c                   eval      w_tell = 0
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 99
7.fb c     sdepl1_key    setgt     sdepl1
7.fb c                   readp     sdepl1
7.fb c                   if        not %eof(sdepl1) and
7.fb c                             sknumm = fonumm and
7.fb c                             skkund = fokund
7.fb c                   eval      w_tell = sktell + 1
7.fb c                   endif
7.fb c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hent opplysninger om ordren
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_ordre    begsr
      *
      * Hent opplysninger fra ordre-hode
      *
     c     fohel1_key    chain     fohel1r
      *
     c                   eval      b2onum = fonumm
8.06 c*8.13              eval      b2osuf = fosuff
     c                   eval      b2otyp = footyp
     c                   eval      b3navn = fonavn
     c                   eval      b3adr1 = foadr1
     c                   eval      b3sted = fosted
      *
     c                   eval      b2kund = fokund
     c                   eval      b2lkun = folkun
     c                   eval      b3lety = folety
      *
      * Hent beskrivelse av ordretype
      *
     c                   eval      b2otxt = *blank
      *
     c                   eval      votyl1_otyp = footyp
     c     votyl1_key    chain     votyl1
     c                   if        %found
     c                   eval      b2otxt = vaotxt
     c                   endif
      *
      * Henter beskrivelse av leveringstype
      *
     c                   eval      b2besk = *blank
      *
     c                   eval      vltpl1_lety = folety
     c     vltpl1_key    chain     vltpl1
     c                   if        %found
     c                   eval      b2besk = vybesk
     c                   endif
      *
      * Hent opplysninger fra kunde
      *
     c                   eval      b2navn = *blank
     c                   eval      b2adr1 = *blank
     c                   eval      b2sted = *blank
     c                   eval      b2tlfn = *blank
     c                   eval      b2mobn = *blank
      *
     c                   eval      rkunl1_kund = fokund
     c     rkunl1_key    chain     rkunl1
     c                   if        %found
     c                   eval      b2navn = rknavn
     c                   eval      b2adr1 = rkgate
     c                   eval      b2sted = rksted
     c                   eval      b2tlfn = rktlfn
     c                   eval      b2mobn = rkmobn
     c                   endif
8.05  *
8.05  * Legg ut varekunde hvis det er både varekunde, fakturakunde og prosjekt.
8.05  *
8.05 c                   if        fokund <> folkun and
8.05 c                             fokpro <> 0
8.05 c                   eval      rkunl1_kund = folkun
8.05 c     rkunl1_key    chain     rkunl1
8.05 c                   if        %found
8.05 c                   eval      b2navn = rknavn
8.05 c                   eval      b2adr1 = rkgate
8.05 c                   eval      b2sted = rksted
8.05 c                   eval      b2tlfn = rktlfn
8.05 c                   eval      b2mobn = rkmobn
8.05 c                   endif
8.05 c                   endif
5.51  *
5.51  * Hent opplysninger fra kundeprosjekt
5.51  *
5.51 c                   eval      fkprl1_kund = fokund
5.51 c                   eval      fkprl1_kpro = fokpro
5.51 c                   if        fokpro <> 0
5.51 c     fkprl1_key    chain     fkprl1
5.51 c                   if        %found
5.51 c                   if        fltlfm <> *blank
5.51 c                   eval      b2mobn = fltlfm
5.51 c                   endif
5.51 c                   if        fltlfa <> *blank
5.51 c                   eval      b2tlfn = fltlfa
5.51 c                   endif
5.51 c                   endif
5.51 c                   endif
5.51  *
5.51  * Er mobilnr overstyrt på ordrehode ?
5.51  *
5.51 c                   if        fomobi <> *blank
5.51 c                   eval      b2mobn = fomobi
5.51 c                   endif
      *
      * Hent ordretotal
      *
7.f6  * Finn total på ordren. Varsles om rekalkulering av hvis total er økt, og forskudd
7.f6  * skal betales.
7.f6 c                   eval      s_tota = (fotots - fototr)
     c                   exsr      hent_total
6.3f  *
6.3f  * Sjekker om depositum krav, (kun evt. ved vanlig bestilling).
6.3f  *
6.3f c                   eval      b_bfor = *off
6.3f c                   eval      b_krav = *off
6.3f c                   eval      sdepl1_numm = fonumm
6.3f c                   eval      sdepl1_kund = fokund
6.3f c     sdepl1_key    chain     sdepl1r
6.3f c                   if        faabfs = 1
6.3f c                   eval      b_bfor = *on
6.3f c                   if        vaoska = 1
6.3f c                   eval      b_bfor = *off
6.3f c                   endif
6.3f c                   else
6.3f c                   eval      b_bfor = *off
6.3f c                   endif
6.3f c*7.fb              if        b_bfor = *off and
6.3f c*7.fb                        (skdepo  <> 0 and
6.3f c*7.fb                         skdepb = 0) or
6.3f c*7.fb                        (skdepo <> 0 and
6.3f c*7.fb                        skdepo < skdepb)
6.3f c*7.fb              eval      b_krav = *on
6.3f c*7.fb              endif
7.f8  *
7.f8  * Er det krav til depositum på kontantordre.
7.f8  *
7.f8 c                   if        rkkres = 2 and
7.f8 c                             faak12 = 1
7.f8 c                   eval      b_krav = *on
7.f8 c                   endif
      *
7.f8 c                   eval      sdepl1_numm = fonumm
7.f8 c                   eval      sdepl1_kund = fokund
7.f8 c                   eval      sdepl1_tell = 0
7.f8 c     sdepl1_key    chain     sdepl1r
7.f8 c                   if        %found
7.f8 c**                 if        b_bfor = *off and
7.f8 c**                 if        (skdepo  <> 0 and
7.f8 c**                            skdepb = 0) or
7.f8 c**                           (skdepo <> 0 and
7.f8 c**                           skdepo < skdepb)
7.f8 c**                 eval      b_krav = *on
7.f8 c**                 endif
7.f8 c                   if        skdepb >= skdepo
7.f8 c                   eval      b_krav = *off
7.f8 c                   endif
      *
7.f8 c**                 eval      sdepl1_numm = fonumm
7.f8 c**                 eval      sdepl1_kund = fokund
7.f8 c**                 eval      sdepl1_tell = 0
7.f8 c**   sdepl1_key    chain     sdepl1
7.f8 c**                 if        %found
7.f4 c                   eval      b_depo = *on
7.f7 c                   if        skdepo > 0 and
7.f7 c                             skdepo = skdepb
7.f7 c                   eval      *in50 = *on
7.f7 c                   endif
7.f8 c**                 endif
7.f8 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Sjekker om det skal beregnes bonus av kundens kjøp
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_bonus   begsr
      *
     c                   eval      b_bonu = *off
      *
     c                   call      'EK750R'
     c                   parm                    w_firm
     c                   parm                    fokund
     c                   parm                    folkun
     c                   parm                    fokpro
     c                   parm                    b_bonu
      *
7.16 c                   if        u_716 = *off
     c                   eval      *in75 = b_bonu = *on
7.16 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppdaterer ordre og memosaldo
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppdat_ordre  begsr
      *
      * Henter ny ordretotal
      *
     c                   exsr      hent_total
      *
      * Beregner justeringsbeløp, og oppdaterer memosaldo
      *
     c     fohel1_key    chain     fohel1
      *
     c                   eval      w_sald = (w_tots - w_totr) -
     c                                      (fotots - fototr)
5.60  *
5.60 c                   eval      w_sal2 = (w_tota - fobrra)
      *
     c                   eval      w_stat = *blank
      *
8.11 c*                  call      'FA922R'
8.11 c*                  parm                    w_firm
8.11 c*                  parm                    footyp
8.11 c*                  parm                    fokund
8.11 c*                  parm                    w_sald
8.11 c*                  parm                    w_sal2
      *
      * Oppdaterer ordre-hode med ny saldo
      *
     c     fohelu_key    chain     fohelur
      *
     c                   eval      fotots = w_tots
     c                   eval      fototr = w_totr
     c                   eval      fototk = w_totk
5.60 c                   eval      fobrra = w_tota
      *
6.10 c                   time                    foedat
6.10 c                   time                    foetim
6.10 c                   eval      foeusr = l_user
     c                   update    fohelur
8.11  *   Oppdatere Memosaldo
8.11 c                   move      w_firm        p_fir
8.11 c                   move      fokund        p_kun
8.11 c                   call      'FO763R'
8.11 c                   parm                    p_fir
8.11 c                   parm                    p_kun
      *
     c                   endsr
      *
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  * Sjekk om det skal legges sperrekode på ordren
6.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.31  *
6.31 c     spr_ordre     begsr
6.31  *
6.31  * Hvilken kortkode er dette ?
6.31  *
6.36 c                   eval      ruksl1_skty = fopsuf
6.36 c                   eval      ruksl1_slag = folage
6.36 c     ruksl1_key    chain     ruksl1
6.36 c                   if        not %found
6.36  *
6.31 c                   eval      ruksl1_skty = fopsuf
6.31 c                   eval      ruksl1_slag = 0
6.31 c     ruksl1_key    chain     ruksl1
6.31 c                   if        not %found
6.31 c                   leavesr
6.31 c                   endif
6.36  *
6.36 c                   endif
6.31  * Vi skal bare ha kreditkort
6.31 c                   if        rustyp <> 'K'
6.31 c                   leavesr
6.31 c                   endif
6.31  * Kun hvis ordreinfokoden er lagt på
6.31 c                   if        rusity = *blanks
6.31 c                   leavesr
6.31 c                   endif
6.31  *
6.31  * Oppdaterer ordre-hode med ordreinfokode
6.31  *
6.31 c     fohelu_key    chain     fohelur
6.31  *
6.31 c                   if        %found
6.31 c                   eval      foityp = rusity
6.31 c                   time                    foedat
6.31 c                   time                    foetim
6.31 c                   eval      foeusr = l_user
6.31 c                   update    fohelur
6.31 c                   endif
6.31  *
6.31 c                   endsr
6.31  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppdatering av Lager
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppdat_lager  begsr
6.39  *
6.39  * hvis varene finnes i EVR, så må man oppdatere lager.
6.39  *
6.39 c                   eval      b_evr = *off
6.39 c                   eval      vvarl1_vare = fdvare
6.39 c     vvarl1_key    chain     vvarl1
6.39 c                   if        %found
6.39 c                   eval      b_evr = *on
6.39 c                   endif
      *
      * Legger over verdier i overførings-felter
      *
     c                   move      fdvare        hlvare
5.31 c                   move      fdlage        hllage
     c                   move      fdenh1        hlenhe
     c                   move      *loval        hldato
     c                   move      *loval        hltime
     c                   move      footyp        hlotyp
     c                   move      fdltyp        hlltyp
      *
     c                   eval      hlanta = fdanta
     c                   eval      hlkopr = fdkopr
      *
     c                   eval      hlrefr = *blank
     c                   move      'F'           hlsyst
     c                   eval      hlaltk = *blank
     c                   eval      hlrest = *blank
6.NU c                   move      fdnumm        w_numa
     c                   move      fdline        w_lina
     c                   eval      hlrefr = 'O:' + w_numa +
     c                                      ' L:' + w_lina
     c                   eval      hlonum = fdnumm
     c                   eval      hlolin = fdline
     c                   move      fdlety        hllety
      *
      * Kaller opp lageroppdaterings-program
      * dersom dette ikke er en vare hentet inn fra LVR
      *
6.39 c                   if        fdlvre = 0  or
6.39 c                             b_evr = *on
      *
     c                   eval      w_stat = *blank
      *
     c                   call      'VL001R'
     c                   parm                    w_stat
6.NU c                   parm                    hlrec
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for tømming av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     clr_subfile   begsr
      *
     c                   eval      *in14 = *on
     c                   write     b2ctl
     c                   eval      *in14 = *off
      *
     c                   eval      *in15 = *off
     c                   eval      w_srrn = 0
     c                   eval      w_sfrn = 0
     c                   eval      w_ssrn = 0
     c                   eval      w_spge = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å fylle opp subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     crt_subfile   begsr
      *
     c                   eval      w_spge = w_spge + c_sfil
     c                   eval      w_srrn = w_ssrn
      *
     c                   dou       w_srrn = w_spge
      *
     c                   read      fodtl1
      *
     c                   if        %eof or
     c                             fdfirm <> w_firm or
     c                             fdnumm <> w_numm or
     c                             fdsuff <> w_suff
     c                   eval      *in15 = *on
     c                   leave
     c                   endif
6.3i  * Skal kun vise tekstlinjer dersom kreditgrense er oversteget
6.3i c**                 if        p_txtl = 'TX' and
6.3i c**                           fdltyp <> 'TX'
6.3i c**                 goto      lestxli
6.3i c**                 endif
6.3i  *
7.25  *  Frisøk
7.25  *
7.25 c                   if        b2fso2 <>  *blank
7.25 c                   exsr      frisok
7.25 c                   if        w_fsok = *off
7.25 c                   iter
7.25 c                   endif
7.25 c                   endif
     c                   eval      w_srrn = w_srrn + 1
      *
     c                   eval      fodtl1_line = fdline
      *
     c                   eval      b1valg = 0
     c                   eval      b1line = fdline
     c                   eval      b1lety = fdlety
     c                   eval      b1vare = fdvare
     c                   eval      b1tek1 = fdtek1
7.09 c     x'1C':' '     xlate     b1tek1        b1tek1
7.28 c     x'25':' '     xlate     b1tek1        b1tek1
7.xx c                   eval      b1tek2 = fdtek2
7.09 c     x'1C':' '     xlate     b1tek2        b1tek2
7.28 c     x'25':' '     xlate     b1tek2        b1tek2
7.xx c                   eval      b1text = *blanks
     c                   eval      b1enhe = fdenh1
     c                   eval      b1raba = 0
7.xx c                   eval      b1kpri = *blanks
     c                   eval      b1sumn = fdsums - fdsumr
     c                   eval      b1sumk = fdsumk
     c                   eval      b1sumb = 0
     c                   eval      b1grad = 0
7.25 c*                   eval      b1neto = *blanks
7.25 c*                   eval      b1kost = *blanks
7.25 c*                   eval      b1dekg = *blanks
      *
7.2h c                   eval      w_behl0 = 0
7.2h c                   eval      b1lbeh = %editw(w_behl0 : '     -')
7.20 c                   eval      w_sltv = *off
     c                   if        fdvare <> *blank and
     c                             fdlvre = 0
     c                   eval      vvarl1_vare = fdvare
     c     vvarl1_key    chain     vvarl1
     c                   if        not %found
     c                   eval      b1tek1 = %subst(b1tek1:1:8) +
     c                                      ' ** SLETTET VARE **'
7.20 c                   eval      w_sltv = *on
7.xx c                   else
7.xx  *
7.xx  * henter varetype og beholdning
7.xx  *
7.2v  * Vi henter reell disponibelsituasjon basert på leveringsdato på ordren.
7.2v  *
7.2v c                   eval      *in47 = *off
7.2v c                   if        fdldat <> *loval
7.2v c                   eval      p_dato = fdldat
7.2v c                   elseif    foldat <> *loval
7.2v c                   eval      p_dato = foldat
7.2v c                   elseif    fobdat <> *loval
7.2v c                   eval      p_dato = fobdat
7.2v c                   endif
7.2v  *
7.2v c                   eval      p_time = *loval
7.2v c                   eval      p_kalk = *blanks
7.2v c                   eval      w_behl = 0
7.2v c                   eval      p_lenh = *blanks
7.2v c                   call      'VL718R'
7.2v c                   parm                    p_firm
7.2v c                   parm                    fdvare
7.2v c                   parm                    fdenh1
7.2v c                   parm                    folage
7.2v c                   parm                    p_dato
7.2v c                   parm                    p_time
7.2v c                   parm                    p_kalk
7.2v c                   parm                    w_behl
7.2v c                   parm                    p_lenh
7.2v c                   parm                    p_inlr
7.2v  *
7.2v c**                 eval      w_lage = fdlage
7.2v c**                 call      'VL715R'
7.2v c**                 parm                    w_firm
7.2v c**                 parm                    vvvare
7.2v c**                 parm                    w_lage
7.2v c**                 parm                    w_vtyp
7.2v c**                 parm                    w_udat
7.2v c**                 parm                    w_ldor
7.2v c**                 parm                    w_behl
7.2v c**                 parm                    b_inlr
7.2v  *
7.2v  * Setter rød farge hvis nehativ beholdning.
7.2v c                   if        w_behl < 0
7.2v c                   eval      *in47 = *on
7.2v c                   endif
7.2v  *
7.2h c                   if        w_behl >= 100000
7.2h c                   eval      w_behl0 = 99999
7.2h c                   elseif    w_behl <= -100000
7.2h c                   eval      w_behl0 = -99999
7.2A c                   else
7.2A c                   eval(h)   w_behl0 = w_behl
7.2A c                   endif
7.2h c                   eval      b1lbeh = %editw(w_behl0 : '     -')
7.2h c*                  eval      b1lbeh = w_behl0
     c                   endif
     c                   endif
      *
     c                   move      fdanta        b1anta
     c                   move      fdsapr        b1sapr
      *
     c                   if        fdrab2 = 0 and
     c                             fdbrr1 = 0 and
     c                             fdbrr2 = 0
     c                   eval      b1raba = fdrab1
     c                   else
     c                   if        fdsums <> 0
     c                   eval(h)   b1raba = fdsumr * 100 / fdsums
     c                   endif
     c                   endif
7.2A c                   if        b1raba >= 100
7.2h c*                   eval      b1tal1 = 99,99
7.2h c                   eval      w_raba1 = b1raba
7.2h c                   eval      b1tal1 = %editw(w_raba1 : '   , ')
7.2A c                   elseif    b1raba <= -100
7.2h c*                   eval      b1tal1 = -99,99
7.2h c                   eval      w_raba1 = b1raba
7.2h c                   eval      b1tal1 = %editw(w_raba1 : '   , -')
7.2C c                   else
7.2h c*                   eval      b1tal1 = b1raba
7.2h c                   eval      b1tal1 = %editw(b1raba : '   ,  -')
7.2A c                   endif
      *
     c                   if        fdlass > 0
     c                   movel     fdlass        b1kpri
     c                   endif
     c                   move      fdkpri        b1kpri
      *
      * Kalkulerer bonus dersom det er knyttet bonus mot kundens kjøp
      *
     c                   if        b_bonu = *on and
     c                             b1sumn <> 0
     c                   eval      w_vare = b1vare
     c                   call      'EK760R'
     c                   parm                    w_firm
     c                   parm                    fokund
     c                   parm                    folkun
     c                   parm                    fokpro
     c                   parm                    forkat
     c                   parm                    fobdat
     c                   parm                    w_vare
     c                   parm                    b1enhe
     c                   parm                    b1lety
     c                   parm                    fdldor
     c                   parm                    b1sumn
     c                   parm                    b1sumb
     c                   endif
      *
     c                   if        b_bonu = *on and
     c                             *in72 = *on
     c                   eval      b1sumn = b1sumn - b1sumb
     c                   endif
      *
      * Beregner DG
      *
     c                   if        b1sumn <> 0
     c                   select
     c                   when      (100 - (b1sumk * 100 / b1sumn)) < -999,99
     c                   eval      b1grad = -999,99
     c                   when      (100 - (b1sumk * 100 / b1sumn)) > 999,99
     c                   eval      b1grad = 999,99
     c                   other
     c                   eval(h)   b1grad = 100 - (b1sumk * 100 / b1sumn)
     c                   endsl
     c                   endif
      *
      * Vises negativt antall dersom kredit linjetype
      *
     c                   if        fdanta <> 0 and
     c                             fdltyp <> *blank
     c                   eval      vltyl1_ltyp = fdltyp
     c     vltyl1_key    chain     vltyl1
     c                   if        valkre = '-'
     c                   eval      b1anta = b1anta * -1
     c                   endif
     c                   endif
      *
      * Dersom bruker ikke skal ha tilgang til å se kostpris blir
      * informasjon om denne fjernet.
      *
7.xx c                   if        *in70 = *on
7.xx c                   eval      b1sumk = 0
7.xx c                   eval      b1grad = 0
7.xx c                   endif
     c                   if        *in49  = *off
     c                   eval      b1sumk = 0
     c                   eval      b1grad = 0
     c                   endif
7.2l  *
7.2l  *  Ta med linjetype til subfile
7.2l  *
7.2l c                   eval      vltyl1_ltyp = fdltyp
7.2l c     vltyl1_key    chain     vltyl1
7.2l c                   if        %found(vltyl1)
7.2l c                   eval      b1lktx = valktx
7.2l c                   else
7.2l c                   eval      b1lktx = 0
7.2l c                   endif
      *
      * Konkatinerer linje
      *
      * --> START IKKE OA VERSJON  <--
     c*                   select
     c*                   when      b1vare = *blank
     c*                   eval      b1text = fdtek1 + fdtek2
     c*                   when      *in70 = *on
     c*                   eval      b1text = b1vare + ' ' +
     c*                                      %subst(b1tek1:1:27) + ' ' +
     c*                                      %editw(b1anta:'     0 ,   -') + ' '+
     c*                                      b1enhe + ' ' +
     c*                                      %editw(b1sapr:'      ,  -') + ' ' +
     c*                                      %editw(b1raba:'   ,  -') +
     c*                                      b1kpri
     c*                   when      *in71 = *on or
     c*                             *in72 = *on
     c*                   eval      b1text = b1tek1 + '     ' +
     c*                                      %editw(b1sumn:'         ,  -') +
     c*                                      ' ' +
     c*                                      %editw(b1sumk:'         ,  -') +
     c*                                      ' ' +
     c*                                      %editw(b1grad:'   ,  -')
     c*                   endsl
      * --> SLUTT IKKE OA VERSJON  <--
      * --> START OA VERSJON  <--
7.xx c                   if        b1vare = *blank
7.xx c                   eval      b1text = %trimr(fdtek1) + %trimr(fdtek2)
7.2C c                   eval      b1tex1 = %trimr(fdtek2)
7.xx c                   else
7.xx c                   if        fdtek2 = *blank
7.xx c                   eval      b1text=%trimr(fdtek1)
7.2C c                   eval      b1tex1 = *blank
7.2C c                   else
7.2C c*                   eval      b1text=%trimr(fdtek1)+' : '+%trimr(fdtek2)
7.2C c                   eval      b1text=%trimr(fdtek1)
7.2C c                   eval      b1tex1 = %trimr(fdtek2)
7.2C c                   endif
7.20 c                   if        w_sltv = *on
7.20 c                   eval      b1text= ' ** SLETTET VARE **' +
7.20 c                                       %trimr(fdtek1)
7.20 c                   endif
7.xx c                   endif
7.09 c     x'1C':' '     xlate     b1text        b1text
7.28 c     x'25':' '     xlate     b1text        b1text
7.2k c     x'1C':' '     xlate     b1tex1        b1tex1
7.2k c     x'25':' '     xlate     b1tex1        b1tex1
7.xx c                   eval      b1tek2 = fdtek2
7.09 c     x'1C':' '     xlate     b1tek2        b1tek2
7.28 c     x'25':' '     xlate     b1tek2        b1tek2
7.25 c*                   eval      b1neto = %editw(b1sumn : '       0 ,  -')
7.25 c*                   eval      b1kost = %editw(b1sumk : '       0 ,  -')
7.25 c*                   eval      b1dekg = %editw(b1grad : ' 0 ,  -')
     c
7.25 c                   if        *in70 = *off
7.2h c                   if        b1grad = 100
7.2h c                   eval      b1lbeh = %editw(b1grad : ' 0 ,  ')
7.2h c                   elseif    b1grad <= -100
7.2h c                   eval      w_dg101 = b1grad
7.2h c                   eval      b1lbeh = %editw(w_dg101 : ' 0 , -')
7.2h c                   else
7.2h c                   eval      w_dgl00 = b1grad
7.2m c                   eval      b1lbeh = %editw(w_dgl00 : '0 ,  -')
7.2h c                   endif
7.2h c*                  eval      b1lbeh = b1grad
7.2C c*                   eval      b1anta = b1sumn
7.2C c*                   eval      b1sapr = b1sumk
7.2C c                   eval      b1tex1 = %editw(b1sumn : '       0 ,  -') +
7.2C c                              c_sepw + %editw(b1sumk : '       0 ,  -')
7.25 c                   endif
     c
      * --> SLUTT OA VERSJON  <--
9.xx c                   exsr      sjekk_farge
      *
6.3l  * sjekk farge
6.3l c                   eval      w_jvqvnr = fdvare
6.3l c                   exsr      finn_logivar
7.27  *  Vasker tegn som newlook ikke tåler
7.27 c                   exsr      newlo_vask
      *
     c                   write     b1sfl
      *
6.3i c     lestxli       tag
     c                   enddo
      *
     c                   if        w_srrn > w_ssrn
     c                   eval      w_sfrn = w_ssrn + 1
     c                   endif
      *
     c                   eval      w_ssrn = w_srrn
     c                   eval      w_virn = w_sfrn
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å bla tilbake en side i subfilen
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     bck_subfile   begsr
      *
     c                   if        *in15
     c     fodtl1_key    setgt     fodtl1
     c                   readp     fodtl1
     c                   endif
      *
      * Leser tilbake en side
      *
     c                   eval      w_stel = 0
      *
     c                   dou       w_stel = w_ssrn + c_sfil
      *
     c                   readp     fodtl1
      *
     c                   if        %eof or
     c                             fdfirm <> w_firm or
     c                             fdnumm <> w_numm or
     c                             fdsuff <> w_suff
     c                   leave
     c                   endif
      *
7.2f  *  Frisøk
7.2f  *
7.2f c                   if        b2fso2 <>  *blank
7.2f c                   exsr      frisok
7.2f c                   if        w_fsok = *off
7.2f c                   iter
7.2f c                   endif
7.2f c                   endif
      *
6.3i  * Skal kun vise tekstlinjer dersom kreditgrense er oversteget
6.3i c*                  if        p_txtl = 'TX' and
6.3i c*                            fdltyp <> 'TX'
6.3i c*                  goto      lestxl
6.3i c*                  endif
6.3i  *
     c                   eval      w_stel = w_stel + 1
      *
     c                   eval      fodtl1_line = fdline
      *
6.3i c     lestxl        tag
     c                   enddo
      *
     c                   if        %eof
     c                   eval      fodtl1_line = fdline
     c     fodtl1_key    setll     fodtl1
     c                   endif
      *
      * Blanker og fyller opp subfile
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for display av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dsp_subfile   begsr
      *
     c                   if        w_srrn <> 0
     c                   eval      *in12 = *on
     c                   else
     c                   write     b2cmd
     c                   endif
      *
     c                   eval      *in13 = *on
     c                   exfmt     b2ctl
      *
     c                   eval      *in12 = *off
     c                   eval      *in13 = *off
      *
     c                   eval      w_fcrn = d_fcrn
      *
     c                   endsr
      *
7.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.25  * Subrutine for frisøk i subfile
7.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.25  *
7.25 c     frisok        begsr
7.25 c
7.25 c                   eval      w_fsok = *on
7.25 c
7.25 c                   if        %scan(%trim(b2fso2) : fdtek1) > 0
7.25 c                   leavesr
7.25 c                   endif
7.25 c                   if        %scan(%trim(b2fso2) : fdtek2) > 0
7.25 c                   leavesr
7.25 c                   endif
7.25 c                   if        %scan(%trim(b2fso2) : fdlvar) > 0
7.25 c                   leavesr
7.25 c                   endif
7.25 c                   if        %scan(%trim(b2fso2) : fdvare) > 0
7.25 c                   leavesr
7.25 c                   endif
7.25  * sjekk om søke er bare tall
7.25 c                   if        %check(digit:b2fso2) = 0
7.25 c                   eval      w_ftekst = *blank
7.25 c                   move      fdldor        w_ftekst
7.25 c                   if        %scan(%trim(b2fso2) : w_ftekst) > 0
7.25 c                   leavesr
7.25 c                   endif
7.25 c                   endif
7.25 c
7.25 c                   if        fdldor <> 0
7.25 c
7.25 c/exec sql
7.25 c+ select rlalfa
7.25 c+ into   :w_ftekst
7.25 c+ from   rlevpf
7.25 c+ where  rlfirm = :w_firm and rllevr = :fdldor
7.25 c+ fetch first 1 rows only
7.25 c/end-exec
7.25 c                   if        %scan(%trim(b2fso2) : w_ftekst) > 0
7.25 c                   leavesr
7.25 c                   endif
7.25 c                   endif
7.25 c
7.25 c
7.25 c                   eval      w_fsok = *off
7.25 c
7.25 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for innlegging av ny linje, tast inn kode
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     legg_til      begsr
      *
     c                   eval      t1valg = 1
     c                   eval      t1ltyp = faalty
6.3h c                   eval      t1lety = folety
      *
      * Vis bilde
      *
     c     t1tagb        tag
      *
6.3i  *  Setter default 'TX' dersom kred.gr. ver oversteget
6.3i c                   if        p_txtl = 'TX'
6.3i c                   eval      t1ltyp = 'TX'
6.3i c                   endif
     c                   exfmt     t1win
      *
      * F3=Avslutt
      *
     c                   if        *inkc or *inkl
     c                   leavesr
     c                   endif
5.52  *
5.52  * F4=Spørring
5.52  *
6.3i  * ikke ta F4 når kred.gr. er oversteget og det kun skal vedl. TX
6.3i c                   if        p_txtl = *blank
5.52 c                   if        *inkd
7.02 c                   if        w_afldt1 = 'T1VARE'
5.3b c                   call      'VV501R'
5.52 c                   parm                    w_firm
5.52 c                   parm                    w_vare
5.52 c                   parm                    w_tek1
6.3a c                   parm                    w_inkh
5.52 c                   movel     w_vare        t1vare
6.33  *
6.33  * henter info fra VA
      *

6.33 c                   eval      w_lvre = 0
8.14 c                   if        *in56 = *off
6.40 c                   if        w_inkh = '1'
6.33 c                   if        %len(%trim(t1vare)) = 8
6.33 c                   eval      jvarl1_vare = t1vare
6.33 c     jvarl1_key    chain     jvarl1
6.33 c                   if        %found(jvarl1)
6.33 c                   eval      w_lvre = 1
6.33 c                   else
6.33 c                   eval      w_lvre = 0
6.33 c                   endif
6.33 c                   endif
6.40 c                   endif
8.14 c                   endif
      *
5.52 c                   endif
6.40 c                   eval      w_inkh = ' '
5.52  *
7.02 c                   if        w_afldt1 = 'T1LETY'
5.52 c                   call      'VY500R'
5.52 c                   parm                    w_firm
5.52 c                   parm                    t1lety
5.52 c                   parm                    w_ltxt
5.52 c                   endif
5.52  *
5.52 c                   goto      t1tagb
5.52 c                   endif
6.3i c                   endif
      *
      * Finner linjenummer
      *
     c                   if        t1valg = 1
     c                   eval      w_line = b1line + 1
     c                   else
     c                   eval      w_line = b1line - 1
     c                   endif
      *
      * Dersom linje ikke allerede finnes, kalles registreringsrutine
      *
     c                   eval      fodtlr_line = w_line
     c     fodtlr_key    chain     fodtlr
     c                   if        not %found
      *
     c                   eval      b2ltyp = t1ltyp
     c                   eval      b2lety = t1lety
     c                   eval      b2vare = t1vare
      *
     c                   if        b2ltyp <> *blank or
     c                             b2vare <> *blank
     c                   exsr      registrer
     c                   select
     c                   when      b_feil = *on
     c                   goto      t1tagb
     c                   when      b_oppr = *on
     c                   eval      b_forn = *on
     c                   leavesr
     c                   endsl
     c                   endif
      *
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å endre linje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     endre_linje   begsr
      *
     c                   eval      fodtlr_line = b1line
     c     fodtlr_key    chain     fodtlr
     c                   if        not %found
     c                   leavesr
     c                   endif
6.3i  * Bare endre tekstlinjer
6.3i c                   if        p_txtl = 'TX' and
6.3i c                             fdltyp <> 'TX'
6.3i c                   goto      ikkoppd
6.3i c                   endif
7.fc  *
7.fc  * Hvis depositum er innbetalt, skal det ikke være mulig å endre linje. Kun T/D linjer
7.fc  *
8.09 c*8.10              eval      vvarl1_vare = fdvare
8.09 c*8.10vvarl1_key    chain     vvarl1
8.09 c*8.10              if        %found(vvarl1)
8.09 c*8.10                        and vvvtyp <> 'T'
8.09 c*8.10                        and vvvtyp <> 'D'
8.09 c*8.10              if        skdepo <> 0
8.09 c*8.10                        and skdepb >= skdepo
8.10 c                   if        sk100p = 1
8.10 c                             and skdepb = skdepo
7.fc c                   eval      w_mld1 = 'Depositum er betalt. Kan +
7.fc c                             ikke endre linje'
7.fc c                   call      'AA005R'
7.fc c                   parm                    w_mld1
7.fc c                   goto      ikkoppd
7.fc c                   endif
8.10 c*                  endif
      *
     c                   select
     c                   when      fdvare <> *blank and
     c                             fdlvre = 0
7.17  * Kall program for kalkulering av priser
7.17 c                   if        u_717 = *on
7.28 c                   if        1=2
7.17 c                   call      'ZI110R'
7.17 c                   parm                    fokund
7.17 c                   parm                    fonumm
7.17 c                   parm                    folage
7.17 c                   parm                    foavde
7.17 c                   parm                    w_vare
7.17 c                   parm                    w_enhe
7.28 c                   endif
7.17 c                   endif
7.17  *
7.19 c                   if        u_719 = *on
7.19 c                   call      'FD105R'
7.19 c                   parm                    b_oppr
7.19 c                   parm                    w_firm
7.19 c                   parm                    w_numm
7.19 c                   parm                    w_suff
7.19 c                   parm                    fdline
7.19 c                   parm                    fdltyp
7.19 c                   parm                    fdlety
7.19 c                   parm                    fdvare
7.19 c                   parm                    fdanta
7.19 c                   parm                    fdenh1
7.19 c                   parm                    b_kost
7.19 c                   parm                    fdeann
7.19 c                   parm                    w_flag
7.fd c                   parm                    w_erst
7.19 c                   else
     c                   call      'FD105R'
     c                   parm                    b_oppr
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    fdline
     c                   parm                    fdltyp
     c                   parm                    fdlety
     c                   parm                    fdvare
     c                   parm                    fdanta
     c                   parm                    fdenh1
     c                   parm                    b_kost
6.12 c                   parm                    fdeann
7.19 c                   parm                    w_flag
7.fd c                   parm                    w_erst
7.19 c                   endif
     c                   eval      *in49 = b_kost
     c                   when      fdvare <> *blank and
     c                             fdlvre = 1
     c                   call      'FD120R'
     c                   parm                    b_oppr
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    fdline
     c                   parm                    fdltyp
     c                   parm                    fdlety
     c                   parm                    fdvare
     c                   parm                    fdanta
     c                   other
     c                   call      'FD110R'
     c                   parm                    p_stat
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    fdline
     c                   parm                    fdltyp
     c                   endsl
      *
6.3i c     ikkoppd       tag
     c                   eval      b_forn = *on
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for sletting av linje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     slett_linje   begsr
      *
5.02  * Varselbilde for bekrefting av sletting
5.02  *
5.02 c                   eval      w_mld1 = 'Sletting av ordrelinje er valgt,'
5.02 c                   eval      w_mld2 = 'bekreft at dette ønskes . .     '
5.02 c                   eval      w_svar = 'N'
5.02  *
5.02 c                   call      'AA007R'
5.02 c                   parm                    w_mld1
5.02 c                   parm                    w_mld2
5.02 c                   parm                    w_svar
5.02 c                   parm                    w_in12
5.02  *
5.02  * F12 er tatt
5.02  *
5.02 c                   if        w_in12 = 1
5.02 c                   leavesr
5.02 c                   endif
5.02  *
5.02 c                   if        w_svar = 'N'
5.02 c                   leavesr
5.02 c                   endif
5.02  *
5.02  * Sletting er akseptert
5.02  *
5.63  *
5.63  * Logg ordrelinje før den blir slettet
5.63  *
5.63 c                   eval      w_spgm      = 'FD100R'
5.63 c                   call      'FS710R'
5.63 c                   parm                    w_firm
6.NU c                   parm                    w_numm
5.63 c                   parm                    w_suff
5.63 c                   parm                    b1line
5.63 c                   parm                    w_spgm
5.63  *
     c                   eval      fodtlu_line = b1line
     c     fodtlu_key    chain     fodtlur
     c                   if        not %found
     c                   leavesr
     c                   endif
      *
     c                   eval      b_forn = *on
      *
     c                   delete    fodtlur
7.18 c                   if        u_718 = *on
7.18  * Slett eventuel skyggetabell
7.18 c     fodtlu_key    chain     fodmiur
7.18 c                   if        %found
7.18 c                   delete    fodmiur
7.18 c                   endif
7.18 c                   endif
      *
7.24  * Slett ordrelinje i TILLEGGSTABELL
7.24 c     fodtlu_key    chain     fod2lur
7.24 c                   if        %found
7.24 c                   delete    fod2lur
7.24 c                   endif
      *
      * Oppdaterer lager
      *
     c                   if        faalag <> 0
     c                   eval      fdanta = fdanta * -1
     c                   exsr      oppdat_lager
     c                   endif
5.32  *
5.32  * Sletter lengdespesif.linjer
5.32  *
5.32 c                   eval      fvlslu_numm = w_numm
5.32 c                   eval      fvlslu_suff = w_suff
5.32 c                   eval      fvlslu_line = fodtlu_line
5.32 c     fvlslu_key    setll     fvlslu
5.32 c     fvlslu_key    reade     fvlslu
5.32  *
5.32 c                   dow       not %eof
5.32 c                   delete    fvlslur
5.32 c     fvlslu_key    reade     fvlslu
5.32 c                   enddo
5.63  *
Q.07  * Sjekk om linjen er bestilt ?
Q.07  *
Q.07 c                   eval      lodtlc_ornu = w_numm
Q.07 c                   eval      lodtlc_orsu = w_suff
Q.07 c                   eval      lodtlc_orli = fodtlu_line
Q.07 c     lodtlc_key    chain     lodtlcr
Q.07 c                   if        not %found
Q.07 c                   goto      end_dlt_lin
Q.07 c                   endif
Q.07  *
Q.07  * Varselbilde for bekrefting av sletting
Q.07  *
Q.07 c                   eval      w_mld1 = 'Ordrelinje er koblet til bestillin-
Q.07 c                             g.'
Q.07 c                   eval      w_mld2 = 'Informer leverandør !'
Q.07 c                   eval      w_svar = 'N'
Q.07  *
Q.07 c                   call      'AA007R'
Q.07 c                   parm                    w_mld1
Q.07 c                   parm                    w_mld2
Q.07 c                   parm                    w_svar
Q.07 c                   parm                    w_in12
Q.07  *
Q.07 c     end_dlt_lin   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å behandle bilde for å vise en vare/tekst-linje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     vis_linje     begsr
      *
     c                   eval      fodtlr_line = b1line
     c     fodtlr_key    chain     fodtlr
     c                   if        not %found
     c                   leavesr
     c                   endif
      *
     c                   if        fdvare = *blank
     c                   leavesr
     c                   endif
      *
     c                   call      'FD505R'
     c                   parm                    w_firm
6.NU c                   parm                    w_numm
     c                   parm                    w_suff
     c                   parm                    b1line
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å hente høyeste linjenummer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_linjenr  begsr
      *
     c                   eval      fodtlr_line = 9999
     c     fodtlr_key    setll     fodtlr
     c                   readp     fodtlr
     c                   if        not %eof and
     c                             fdfirm = w_firm and
     c                             fdnumm = w_numm and
     c                             fdsuff = w_suff
     c                   eval      w_line = fdline
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for henting av ordretotal
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     hent_total    begsr
      *
     c                   eval      w_totk = 0
     c                   eval      w_tots = 0
     c                   eval      w_totr = 0
5.60 c                   eval      w_tota = 0
5.60 c                   eval      w_totn = 0
5.60 c                   eval      w_tot1 = 0
5.60 c                   eval      w_tot2 = 0
6.14 c                   eval      b_umva = *off
      *
     c     fodtlr_key2   setll     fodtlr
     c     fodtlr_key2   reade     fodtlr
     c                   dow       not %eof
     c                   eval      w_totk = w_totk + fdsumk
     c                   eval      w_tots = w_tots + fdsums
     c                   eval      w_totr = w_totr + fdsumr
5.60  *
5.60 c                   eval      w_totn = fdsums
5.60 c                   eval      w_tot1 = 0
5.60 c                   eval      w_tot2 = 0
5.60  *
5.60 c                   if        fdrab1 <> 0
5.60 c                   eval      w_tot1 = w_totn * fdrab1 / 100
5.60 c                   eval      w_totn = w_totn - w_tot1
5.60 c                   endif
5.60  *
5.60 c                   if        fdrab2 <> 0
5.60 c                   eval      w_tot2 = w_totn * fdrab2 / 100
5.60 c                   eval      w_totn = w_totn - w_tot2
5.60 c                   endif
5.60  *
5.60  * NB!  w_tot1
5.60  * og   w_tot2 brukes om
5.60  * igjen og null-stilles
5.60  *
5.60 c                   eval      w_tot1 = 0
5.60 c                   eval      w_tot2 = 0
5.60  *
5.60 c                   if        fdbrr1 <> 0
5.60 c                   eval      w_tot1 = w_totn * fdbrr1 / 100
5.60 c                   eval      w_totn = w_totn - w_tot1
5.60 c                   endif
5.60  *
5.60 c                   if        fdbrr2 <> 0
5.60 c                   eval      w_tot2 = w_totn * fdbrr2 / 100
5.60 c                   eval      w_totn = w_totn - w_tot2
5.60 c                   endif
5.60  *
5.60 c                   eval      w_tota = w_tota + w_tot1
5.60 c                   eval      w_tota = w_tota + w_tot2
5.60  *
6.14  *
6.14  * Finnes det varelinjer som ikke har moms ?
6.14  *
6.14 c                   if        fdvare <>' '
6.14 c                   if        fdomva = ' ' or
6.14 c                             fdomva = '0' or
6.14 c                             fdomva = '4'
6.14 c                   eval      b_umva = *on
6.14 c                   endif
6.14 c                   endif
6.14  *
     c     fodtlr_key2   reade     fodtlr
     c                   enddo
      *
     c                   eval      b2nett = w_tots - w_totr
     c                   eval      b2kost = w_totk
     c                   eval      b2dekn = b2nett - b2kost
      *
      * Beregner DG
      *
     c                   if        b2nett <> 0
     c                   select
     c                   when      (100 - (b2kost * 100 / b2nett)) < -999,99
     c                   eval      b2grad = -999,99
     c                   when      (100 - (b2kost * 100 / b2nett)) > 999,99
     c                   eval      b2grad = 999,99
     c                   other
     c                   eval(h)   b2grad = 100 - (b2kost * 100 / b2nett)
     c                   endsl
     c                   endif
      *
     c                   endsr
5.65  *
5.65  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.65  * Subrutine for oppdatere logg-register
5.65  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.65  *
5.65 c     upd_logg      begsr
5.65  *
5.65  *
5.65 c                   time                    d_date
5.65 c                   time                    d_time
5.65 c                   eval      d_user = l_user
5.65 c                   eval      d_wsid = l_wsid
5.65 c                   eval      d_aarr = %subdt(fobdat:*years)
5.65 c                   call      'FU900R  '
5.65 c                   parm                    p_stat
6.NU c                   parm                    d_urec
5.65  *
5.65  *
5.65 c                   endsr
6.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.25  * Subrutine for å legge ut i Byggdok
6.25  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.25  *
6.25 c     byggdok       begsr
6.25  *
6.25  * legger evt. linjer til BygDok
6-2x  *
6.25 c                   if        b_bdo1 = *on and
6.25 c                             b_bdo2 = *on and
6.25 c                             b_bdo3 = *on and
6.25 c                             fdnobb <> 0
6.25 c                   eval      rkunl1_kund = fokund
6.25 c     rkunl1_key    chain     rkunl1
6.25 c                   eval      b_kper  = *off
6.25 c                   eval      rukpl6_kund = fokund
6.25 c     rukpl6_key    setll     rukpl6
6.25 c     rukpl6_key    reade     rukpl6
6.25 c                   dow       not %eof
6.25 c     lo:up         xlate     rukrol        rukrol
6.34 c                   if        rukrol  = 'BYGGDOK' or rukrol = 'COBUILDER'
6.25 c                   eval      b_kper  = *on
6.25 c                   goto      fbdo_tag
6.25 c                   endif
6.25 c     rukpl6_key    reade     rukpl6
6.25 c                   enddo
6.25 c     fbdo_tag      tag
6.25 c                   eval      fwbfir = w_firm
6.25 c                   eval      fwbkun = fokund
6.25 c                   eval      fwbkpr = fokpro
6.25 c                   movel     fonumm        fwbnum
6.25 c                   eval      fwbnav = rknavn
6.25 c                   if        b_kper  = *on and
6.25 c                             ruenav <> *blank and
6.25 c                             rumail <> *blank
6.25 c                   eval      fwbper = %trim(ruenav) + ',' +
6.25 c                                      %trim(rufnav)
6.25 c                   eval      fwbmai = rumail
6.25 c                   else
6.25 c                   eval      fwbper = rknavn
6.25 c                   eval      fwbmai = rkemal
6.25 c                   endif
6.2e  * hvis mail på kunde-prosjekt overstyrer det alt
6.3e c                   if        flmail <> *blank
6.3e c                   eval      fwbmai = flmail
6.3e c                   if        flkprs <> *blank
6.3e c                   eval      fwbper = flkprs
6.3e c                   endif
6.3e c                   endif
6.25 c                   eval      fwbftn = rkftnr
6.25 c                   move      w_btms        w_ti26
6.25 c                   eval      fwbtms = w_ti26
6.25 c                   eval      fwbnob = fdnobb
6.25 c                   time                    fwboda
6.25 c                   time                    fwboti
6.25 c                   time                    fwbeda
6.25 c                   time                    fwbeti
6.25 c                   eval      fwbous = l_user
6.25 c                   eval      fwbeus = l_user
8.23 c                   if        b_bygd = *on
8.23 c                   write     fbdopfr
8.23 c                   endif
6.2c c                   move      fwbnum        w_bnum
6.25 c                   eval      b_bdo4 = *on
6.25 c                   endif
6.25  *
6.25 c                   endsr
7.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.08  * Subrutine for å sjekke om skaff eller utgått og gi kode for
7.08  * farge.. 45=rød, 46=blå
7.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.08  *
7.08 c     sjekk_farge   begsr
7.2lxc                   eval      *in44 = *off
7.08 c                   eval      *in45 = *off
7.08 c                   eval      *in46 = *off
7.2lxc                   eval      *in47 = *off
7.08 c
7.08  * F8-varer merkes alltid blå
7.08 c                   if        u_fskv = *on
7.08 c                   if        fdlvre = 1
7.08 c                   eval      *in45 = *on
7.08 c                   endif
7.08 c                   eval      vlagl1_vare = fdvare
7.08 c                   eval      vlagl1_lage = fdlage
7.08 c                   if        fdlage = 0
7.08 c                   eval      vlagl1_lage = folage
7.08 c                   endif
7.08 c     vlagl1_key    chain     vlagl1
7.08 c                   if        %found(vlagl1)
7.08 c                   if        vlvtyp = 'S'
7.08 c                   eval      *in45 = *on
7.08 c                   endif
7.08 c                   endif
7.08 c                   endif
7.08 c
7.08 c                   if        u_fugv = *on
7.08 c                   if        vaoakk > 0  and
7.08 c                             footyp <> 'HO'
7.08 c                   leavesr
7.08 c                   endif
7.08  * sjekker om utgått i VA eller på lager
7.08 c                   if        fdldor <> 0
7.08 c                   eval      jlevl3_enum = fdldor
7.08 c     jlevl3_key    chain     jlevl3
7.08 c                   if        %found(jlevl3)
7.08 c                   eval      jvlel1_lvnr = fdvare
7.08 c                   eval      jvlel1_lldo = jlldor
7.08 c     jvlel1_key    chain     jvlel1
7.08 c                   if        %found(jvlel1)
7.08 c                   if        jvluda <> *loval and
7.08 c                             w_date > jvluda
7.08 c                   eval      *in46 = *on
7.08 c                   eval      *in45 = *off
7.08 c                   endif
7.08 c                   endif
7.08 c                   endif
7.08 c                   endif
7.08  *
7.08 c                   if        %found(vlagl1)   and
7.08 c                             vludat <> *loval and
7.08 c                             w_date > vludat
7.08 c                   eval      *in46 = *on
7.08 c                   eval      *in45 = *off
7.08 c                   endif
7.08 c                   if        fdlvre = 0 and
7.08 c                             fdvare <> *blank
7.08 c                   eval      vvarl1_vare = fdvare
7.08 c     vvarl1_key    chain     vvarl1
7.08 c                   if        not %found(vvarl1)
7.08 c                   eval      *in46 = *on
7.08 c                   eval      *in45 = *off
7.08 c                   endif
7.08 c                   endif
7.08 c                   endif
7.2lx *
7.2lx * Lagt inn test om fargestyring på sortiment
7.2lx *
7.2lxc                   if        u_fsor = *on
7.2lxc                   eval      *in44 = *off
7.2lxc                   eval      *in45 = *off
7.2lxc                   eval      *in46 = *off
7.2lxc                   eval      *in47 = *off
7.2p c                   eval      vlagl1_vare = fdvare
7.2p c                   eval      vlagl1_lage = fdlage
7.2p c                   if        fdlage = 0
7.2p c                   eval      vlagl1_lage = folage
7.2p c                   endif
7.2p c     vlagl1_key    chain     vlagl1
7.2p c                   if        %found(vlagl1) and
7.2p c                             vlvtyp = 'S'
7.2lxc                   if        vvsort = w_fso1
7.2lxc                   eval      *in46 = *on
7.2lxc                   eval      *in47 = *on
7.2lxc                   endif
7.2lxc                   if        vvsort = w_fso2
7.2lxc                   eval      *in44 = *on
7.2lxc                   eval      *in45 = *on
7.2lxc                   endif
7.2lxc                   endif
7.2p c                   endif
7.08 c
7.08 c                   endsr
7.15  *
7.15  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.15  *  Gir melding hvis man prøver o plukke bestilling til hovedordre
7.15  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.15  *
7.15 c     xm1win        begsr
7.15 c                   exfmt     m1msg1
7.15  *
7.15 c                   endsr
6.3l  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.3l  * Finn info om logistikkvare for riktig prisgiver
6.3l  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.3l  *
6.3l c     finn_logivar  begsr
6.3l  *
6.3l c                   eval      *in52 = *off
6.3l c                   eval      *in53 = *off
6.3l c
6.3l c                   if        %trim(w_jvqvnr) = ''
6.3l c                   leavesr
6.3l c                   endif
6.3l c
6.3l c                   eval      w_logl = ''
6.3l c                   eval      w_undv = 0
6.3l c                   movel     w_jvqvnr      w_jvquno
6.3l c/exec sql
6.3l c+                  select jvquno, jvqvnr
6.3l c+                  into :w_undv, :w_logl
6.3l c+                  from jvklpf
6.3l c+                  where (jvquno = :w_jvquno or
6.3l c+                  jvqvnr = :w_jvqvnr)
6.3l c+                  and jvqfir = :w_firm
6.3l c+                  fetch first 1 rows only
6.3l c/end-exec
6.3l c                   if        w_logl = w_jvqvnr
6.3l c                   eval      *in53 = *on
7.08 c                   eval      *in45 = *off
7.08 c                   eval      *in46 = *off
6.3l c                   elseif    w_undv > 0
6.3l c                   eval      *in52 = *on
7.08 c                   eval      *in45 = *off
7.08 c                   eval      *in46 = *off
6.3l c                   endif
7.2lx *
7.2lx * Lagt inn test om fargestyring på sortiment
7.2lx *
7.2lxc                   if        u_fsor = *on
7.2lxc                   eval      *in44 = *off
7.2lxc                   eval      *in45 = *off
7.2lxc                   eval      *in46 = *off
7.2lxc                   eval      *in47 = *off
7.2lxc                   if        vvsort = w_fso1
7.2lxc                   eval      *in46 = *on
7.2lxc                   eval      *in47 = *on
7.2lxc                   endif
7.2lxc                   if        vvsort = w_fso2
7.2lxc                   eval      *in44 = *on
7.2lxc                   eval      *in45 = *on
7.2lxc                   endif
7.2lxc                   endif
6.3l  *
6.3l c                   endsr
      *
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  * Skriv ut dokumentet
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  *
Q.02 c     ex_print      begsr
Q.02  *
Q.02 c                   eval      w_numm = fonumm
Q.02 c                   eval      w_suff = fosuff
Q.02 c                   eval      w_acti = 'U'
Q.02 c                   eval      w_qsta = *blanks
Q.02x * Oppdater før vi skriver ut. Mangeler totaler
Q.02xc                   exsr      oppdat_ordre
Q.02 c
Q.02 c                   call      'QO600C'
Q.02 c                   parm                    w_numm
Q.02 c                   parm                    w_suff
Q.02 c                   parm                    w_acti
Q.02 c                   parm                    w_qsta
Q.02  *
Q.02 c                   endsr
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  * Forhåndsvisning
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  *
Q.02 c     ex_preview    begsr
Q.02  *
Q.02 c                   eval      w_numm = fonumm
Q.02 c                   eval      w_suff = fosuff
Q.02 c                   eval      w_acti = 'P'
Q.02 c                   eval      w_qsta = *blanks
Q.02x * Oppdater før vi viser ordre. Mangeler totaler
Q.02xc                   exsr      oppdat_ordre
Q.02 c
Q.02 c                   call      'QO600C'
Q.02 c                   parm                    w_numm
Q.02 c                   parm                    w_suff
Q.02 c                   parm                    w_acti
Q.02 c                   parm                    w_qsta
Q.02  *
Q.02 c                   endsr
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  * E-mail
Q.02  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.02  *
Q.02 c     ex_email      begsr
Q.02  *
Q.02 c                   eval      w_numm = fonumm
Q.02 c                   eval      w_suff = fosuff
Q.02 c                   eval      w_acti = 'E'
Q.02 c                   eval      w_qsta = *blanks
Q.02x * Oppdater før vi sender mail. Mangeler totaler
Q.02xc                   exsr      oppdat_ordre
Q.02 c
Q.02 c                   call      'QO600C'
Q.02 c                   parm                    w_numm
Q.02 c                   parm                    w_suff
Q.02 c                   parm                    w_acti
Q.02 c                   parm                    w_qsta
Q.02  *
Q.02 c                   endsr
Q.02  *
Q.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.03  * Sjekk om vi kan sette ordre til plukking
Q.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.03  *
Q.03 c     ex_pluk       begsr
Q.03  *
Q.03  * Kaller program som sjekker og gjør utplukk
Q.03  *
Q.03 c                   call      'QO736R'
Q.03 c                   parm                    w_numm
Q.03 c                   parm                    w_suff
Q.03 c                   parm                    b_pluk
Q.03  *
Q.03 c                   endsr
Q.03  *
Q.04  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.04  * Bytt kunde
Q.04  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.04  *
Q.04 c     ex_bytt_kunde begsr
Q.04  *
Q.04  * Bytte av kunde kan kun skje når ordren er tilbud/ordrebekreftelse. Den kan
Q.04  * heller ikke være sendt til plukking. Har du retiigheter til å endre pakkseddel
Q.04  * overstyres disse kontrollene.
Q.04  *
Q.04 c                   eval      votyl1_otyp = footyp
Q.04 c     votyl1_key    chain     votyl1
Q.04 c                   if        vaoakk  > 2
Q.04 c                   eval      w_mld1 = 'Kan ikke bytte kunde, +
Q.04 c                                       feil ordretype.'
Q.04 c                   call      'AA005R'
Q.04 c                   parm                    w_mld1
Q.04 c                   goto      end_bytt
Q.04 c                   endif
Q.04  *
Q.041 * Flyttet kode for sjekk av depositum
Q.04  * Kan ikke bytte kunde hvis ordre har depositum
Q.04  * Hent opplysninger fra Depositum-fil
Q.04  *
Q.04 c                   eval      sdepl1_numm = fonumm
Q.04 c                   eval      sdepl1_kund = fokund
Q.04 c     sdepl1_key    chain     sdepl1r
Q.04 c                   if        %found
Q.04 c                   if        skdepo <> 0 or
Q.04 c                             skdepb <> 0 or
Q.04 c                             skdept <> 0
Q.041c**                 eval      *in34 = *on
Q.041c**                 goto      q4tag
Q.041c                   eval      w_mld1 = 'Det er betalt depositum, +
Q.041c                                       kan ikke bytte kunde.'
Q.041c                   call      'AA005R'
Q.041c                   parm                    w_mld1
Q.041c                   goto      end_bytt
Q.04 c                   endif
Q.04 c                   endif
Q.04  *
Q.04  * Sjekk om du har lov til å endre "pakkseddel". Krever at det er satt
Q.04  * rettigheter på brukeren.
Q.04  *
Q.04 c                   if        vaoakk  = 2 and
Q.04 c                             fbko07  = 1
Q.04 c                   goto      bytt_kunde
Q.04 c                   endif
Q.04  *
Q.04 c                   if        vaoakk  = 2 and
Q.04 c                             fbko07  <> 1
Q.04 c                   eval      w_mld1 = 'Kan ikke bytte kunde, +
Q.04 c                                       feil ordretype. Ingen rettigheter'
Q.04 c                   call      'AA005R'
Q.04 c                   parm                    w_mld1
Q.04 c                   goto      end_bytt
Q.04 c                   endif
Q.04  *
Q.04 c                   if        1 = 2
Q.04 c                   eval      b_pluk = *off
Q.04 c                   eval      floglr_aarr = %subdt(w_date:*years)
Q.04 c                   eval      floglr_numm = fonumm
Q.04 c                   eval      floglr_suff = fosuff
Q.04 c     floglr_key    setll     floglr
Q.04 c     floglr_key    reade     floglr
Q.04 c                   dow       not %eof
Q.04 c                   if        fukode = '2'
Q.04 c                   eval      b_pluk= *on
Q.04 c                   endif
Q.04 c     floglr_key    reade     floglr
Q.04 c                   enddo
Q.04  *
Q.04 c                   if        b_pluk = *on
Q.04 c                   eval      w_mld1 = 'Kan ikke bytte kunde, +
Q.04 c                                       ordren er sendt til +
Q.04 c                                       plukking'
Q.04 c                   call      'AA005R'
Q.04 c                   parm                    w_mld1
Q.04 c                   goto      end_bytt
Q.04 c                   endif
Q.04 c                   endif
Q.04  *
8.28 c                   if        u_best = *off
Q.04 c                   if        fobenr <> 0
Q.04 c                   eval      w_mld1 = 'Kan ikke bytte kunde, +
Q.04 c                                       er tilknytttet bestilling'
Q.04 c                   call      'AA005R'
Q.04 c                   parm                    w_mld1
Q.04 c                   goto      end_bytt
Q.04 c                   endif
8.28 c                   endif
Q.04  *
Q.04 c     bytt_kunde    tag
Q.04  *
Q.04  * Hvis jeg kommer hit skal vi bytte kunde på ordre.
Q.04  *
Q.04 c                   eval      q4numm = fonumm
Q.04 c                   eval      q4navn = fonavn
Q.04 c                   eval      q4pris = '1'
Q.04  *
Q.04 c     q4tag         tag
Q.04  *
Q.04 c                   exfmt     q4win
Q.04  *
Q.04 c                   if        *inkc or *inkl
Q.04 c                   leavesr
Q.04 c                   endif
Q.04  *
Q.04 c                   if        *inkd
Q.04  * Kunde
Q.04 c                   if        w_afldt1 = 'Q4KUND'
Q.04 c                   call      'RK500R'
Q.04 c                   parm                    w_firm
Q.04 c                   parm                    q4kund
Q.04 c                   parm                    q4navn
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04  * Kundeprosjekt
Q.04 c                   if        w_afldt1 = 'Q4KPRO'
Q.04 c                   move      udate         w_dato
Q.04 c                   call      'FL501R'
Q.04 c                   parm                    w_firm
Q.04 c                   parm                    q4kund
Q.04 c                   parm                    w_dato
Q.04 c                   parm                    q4kpro
Q.04 c                   parm                    w_navn
Q.04 c                   parm                    w_adr1
Q.04 c                   parm                    w_adr2
Q.04 c                   parm                    w_sted
Q.04 c                   parm                    w_kprs
Q.04 c                   parm                    w_tlfa
Q.04 c                   parm                    w_tlfp
Q.04 c                   parm                    w_tlfm
Q.04 c                   parm                    w_mail
Q.04 c                   parm                    w_orka
Q.04 c                   parm                    w_okun
Q.04 c                   parm                    w_okpr
Q.04 c                   parm                    w_opda
Q.04 c                   parm                    w_proj
Q.04 c                   parm                    w_kjor
Q.04 c                   parm                    w_kjnr
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04  *
Q.04 c                   endif
Q.04  * Er nytt kundenummer gyldig ?
Q.04 c                   eval      rkunl1_kund = q4kund
Q.04 c     rkunl1_key    chain     rkunl1
Q.04 c                   if        not %found
Q.04 c                   eval      *in31 = *on
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04  * Er kunde sperret for registrering ?
Q.04 c                   if        rksprk = 'J'
Q.04 c                   eval      *in32 = *on
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04  * Er kunde kreditsperret ?
Q.04 c                   if        rkkres = 1
Q.04 c                   eval      *in33 = *on
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04  * Er kunde kontantkunde ?
Q.04 c                   if        rkkres = 2
Q.04 c                   eval      *in32 = *on
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04  *
Q.04  * Kan ikke bytte kunde hvis ordre har depositum
Q.04  * Hent opplysninger fra Depositum-fil
Q.04  *
Q.04 c                   eval      sdepl1_numm = fonumm
Q.04 c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
Q.04 c     sdepl1_key    chain     sdepl1r
Q.04 c                   if        %found
Q.04 c                   if        skdepo <> 0 or
Q.04 c                             skdepb <> 0 or
Q.04 c                             skdept <> 0
Q.04 c                   eval      *in34 = *on
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04 c                   endif
Q.04  *
Q.04  * Kan ikke bytte kunde hvis ordren er tilknyttet bestilling
Q.04  *
8.28 c                   if        u_best = *off
Q.04 c                   eval      fodtlr_line = 0
Q.04 c     fodtlr_key    setll     fodtlr
Q.04 c     fodtlr_key2   reade     fodtlr
Q.04  *
Q.04 c                   dow       not %eof
Q.04 c                   if        fdbenr <> 0
Q.04 c                   eval      lohel1_numm = fdbenr
Q.04 c                   eval      lohel1_suff = fdbsuf
Q.04 c     lohel1_key    chain     lohel1
Q.04 c                   if        %found(lohel1)
Q.04 c                   eval      *in36 = *on
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04 c                   endif
Q.04 c     fodtlr_key2   reade     fodtlr
Q.04 c                   enddo
8.28 c                   endif
Q.04  *
Q.04  * Sjekk om kunde/prosjekt finnes
Q.04  *
Q.04 c                   if        q4kpro > 0
Q.04 c                   eval      fkprl1_kund = q4kund
Q.04 c                   eval      fkprl1_kpro = q4kpro
Q.04 c     fkprl1_key    chain     fkprl1r
Q.04 c                   if        not %found(fkprl1)
Q.04 c                   eval      *in35 = *on
Q.04 c                   goto      q4tag
Q.04 c                   endif
Q.04 c                   endif
Q.04  *
Q.04  * Oppdatering av memosaldo for "gammel" kunde
Q.04  *
Q.04 c                   eval      w_sald = fototr - fotots
Q.04 c                   eval      w_sal2 = fobrra * -1
Q.04 c                   call      'FA922R'
Q.04 c                   parm                    w_firm
Q.04 c                   parm                    footyp
Q.04 c                   parm                    fokund
Q.04 c                   parm                    w_sald
Q.04 c                   parm                    w_sal2
Q.04  *
Q.04  * Så begynner vi å endre felter som må byttes ut - starter med ordrehodet
Q.04  *
Q.04  * Slå opp på kundeprosjekt for å finne om prosjekt er
Q.04  * overstyrer verdi på kunde
Q.04  *
Q.04 c                   eval      w_faty = rkfaty
Q.04 c                   eval      w_mkod = rkmkod
Q.04 c                   eval      w_betb = rkbetb
Q.04 c                   eval      w_navn = rknavn
Q.04 c                   eval      w_adr1 = rkgate
Q.04 c                   eval      w_adr2 = rkadr2
Q.04  *
Q.04 c                   if        q4kpro > 0
Q.04 c                   eval      fkprl1_kund = q4kund
Q.04 c                   eval      fkprl1_kpro = q4kpro
Q.04 c     fkprl1_key    chain     fkprl1
Q.04 c                   if        %found(fkprl1)
Q.04 c                   eval      w_faty = flfaty
Q.04 c                   eval      w_mkod = flmkod
Q.04 c                   eval      w_betb = flbetb
Q.04 c                   eval      w_navn = flnavn
Q.04 c                   eval      w_adr1 = fladr1
Q.04 c                   eval      w_adr2 = fladr2
Q.04 c                   endif
Q.04 c                   endif
Q.04  *
Q.04  * Så begynner vi oppdatering
Q.04  *
Q.04 c     fohelu_key    chain     fohelur
Q.04  *
Q.04  * Legger inn kundeopplysninger i ordre-felter
Q.04  *
Q.04 c                   eval      fokund = q4kund
Q.04 c                   eval      fokpro = q4kpro
Q.04 c                   eval      fokuna = *blank
Q.04 c                   movel     rkalfa        fokuna
Q.04 c                   eval      fobetb = w_betb
Q.04 c                   eval      fovalk = rkvalk
Q.04 c                   eval      forkat = rkrabk
Q.04 c                   eval      fomkod = w_mkod
Q.04 c                   eval      fofaty = w_faty
Q.04  *
Q.04 c                   eval      folkun = *zero
Q.042c                   if        %trim(fonavn) <> *blanks
Q.04 c                   eval      fonavn = w_navn
Q.04 c                   eval      foadr1 = w_adr1
Q.04 c                   eval      foadr2 = w_adr2
Q.04 c                   eval      fosted = *blank
Q.042c                   endif
Q.04 c                   eval      fomobi = *blank
Q.04  * Kortkode ??
Q.04 c                   exsr      sjk_kort
Q.04  *
Q.04 c                   time                    foedat
Q.04 c                   time                    foetim
Q.04 c                   eval      foeusr = l_user
Q.04 c                   update    fohelur
Q.04  *
Q.04  * Hvordan skal vi håndtere ordrelinjene ?
Q.04  *
Q.04 c                   exsr      recalc_ordre
Q.04  *
Q.04 c     end_bytt      endsr
Q.04  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.04  * Sjekker at kortinformasjon finnes på kunde. Legger ut info på BOKK
Q.04  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.04 c     sjk_kort      begsr
Q.04  *
Q.04  * Les kortregister for kunde, og sjekk om det skal legges ut info.
Q.04  * Santanderkort - 4
Q.04 c                   eval      rukrl5_ktyp = 4
Q.04 c                   eval      rukrl5_kpro = 0
Q.04 c                   eval      rukrl5_kkun = q4kund
Q.04 c     rukrl5_key    chain     rukrl5
Q.04 c                   if        %found
Q.04  * Kortet kan ikke være sperret
Q.04 c                   if        rukspr <> 'J' and
Q.04 c                             rukobl = 1
Q.04 c                   eval      fopsuf = 4
Q.04 c                   endif
Q.04 c                   endif
Q.04  * Hva med BM kort ??
Q.04 c                   if        fopsuf = 0
Q.04 c                   eval      rukrl5_ktyp = 5
Q.04 c                   eval      rukrl5_kpro = 0
Q.04 c                   eval      rukrl5_kkun = q4kund
Q.04 c     rukrl5_key    chain     rukrl5
Q.04 c                   if        %found
Q.04  * Kortet kan ikke være sperret
Q.04 c                   if        rukspr <> 'J' and
Q.04 c                             rukobl = 1
Q.04 c                   eval      fopsuf = 5
Q.04 c                   endif
Q.04 c                   endif
Q.04 c                   endif
Q.04  *
Q.04 c                   endsr
Q.04  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.04  * Subrutine for henting av ordretotal
Q.04  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.04  *
Q.04 c     recalc_ordre  begsr
Q.04  *
Q.04  * q4pris = 0, ingen rekalkulering
Q.04  * q4pris = 1, priser og rabatter hentes på nytt
Q.04  *
Q.04 c                   if        q4pris = '1'
Q.04  * Rekalkuler hele ordren
Q.04 c                   eval      w_enor = '1'
Q.04 c                   call      'FO730R'
Q.04 c                   parm                    w_enor
Q.04 c                   parm                    w_firm
Q.04 c                   parm                    w_numm
Q.04 c                   parm                    w_suff
Q.04  *
Q.04 c                   endif
Q.04  *
Q.04 c                   endsr
7.2n  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2n  * Subrutine for å oppdatere order hode
7.2n  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2n  *
7.2n c     upd_ordrehode begsr
7.2n  *
7.2n c                   eval      w_enor = ' '
7.2n c                   call      'FO730R'
7.2n c                   parm                    w_enor
7.2n c                   parm                    w_firm
7.2n c                   parm                    w_numm
7.2n c                   parm                    w_suff
7.2n  *
7.2n  *
7.2n c                   endsr
Q.05  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.05  * Skriv ut kollietiketter
Q.05  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.05  *
Q.05 c     ex_prt_kolli  begsr
Q.05  *
Q.05 c                   eval      votyl1_otyp = footyp
Q.05 c     votyl1_key    chain     votyl1
Q.05 c                   if        vaoakk < 1 or
Q.05 c                             vaoakk > 2
Q.05 c                   eval      w_mld1 = 'Kan ikke skrive etiketter,-
Q.05 c                              feil ordretype.'
Q.05 c                   call      'AA005R'
Q.05 c                   parm                    w_mld1
Q.05 c                   goto      end_prt_kolli
Q.05 c                   endif
Q.05  *
Q.05  * Sjekk at den er sendt til plukking. (Ikke krav)
Q.05  *
Q.05 c                   if        1 = 2
Q.05 c                   eval      b_pluk = *off
Q.05 c                   eval      floglr_aarr = %subdt(fobdat:*years)
Q.05 c                   eval      floglr_numm = fonumm
Q.05 c                   eval      floglr_suff = fosuff
Q.05 c     floglr_key    setll     floglr
Q.05 c     floglr_key    reade     floglr
Q.05 c                   dow       not %eof
Q.05 c                   if        fukode = '2'
Q.05 c                   eval      b_pluk= *on
Q.05 c                   endif
Q.05 c     floglr_key    reade     floglr
Q.05 c                   enddo
Q.05  *
Q.05 c                   if        b_pluk = *off
Q.05 c                   eval      w_mld1 = 'Kan ikke skrive etiketter, -
Q.05 c                             ikke klar til plukking'
Q.05 c                   call      'AA005R'
Q.05 c                   parm                    w_mld1
Q.05 c                   goto      end_prt_kolli
Q.05 c                   endif
Q.05 c                   endif
Q.05  *
Q.05 c                   call      'QP270R'
Q.05 c                   parm                    fonumm
Q.05 c                   parm                    fosuff
Q.05  *
Q.05 c     end_prt_kolli endsr
Q.06  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.06  * Subrutine for å legge til transportlinje
Q.06  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.06  *
Q.06 c     ex_add_tral   begsr
Q.06  *
Q.06 c                   eval      vvarl1_vare = b2vare
Q.06 c     vvarl1_key    chain     vvarl1
Q.06  *
Q.06 c                   exsr      hent_linjenr
Q.06 c                   eval      w_line = w_line + 10
Q.06  *
Q.06 c                   eval      w_kode = *blanks
Q.06 c                   eval      w_anta = 1
Q.06  *
Q.06  * Kaller hurtigoppretting av vare
Q.06  *
Q.06 c                   call      'FD106R'
Q.06 c                   parm                    w_kode
Q.06 c                   parm                    w_firm
Q.06 c                   parm                    fonumm
Q.06 c                   parm                    fosuff
Q.06 c                   parm                    w_line
Q.06 c                   parm                    faalty
Q.06 c                   parm                    folety
Q.06 c                   parm                    b2vare
Q.06 c                   parm                    w_anta
Q.06 c                   parm                    vvenhe
Q.06 c                   parm                    foldat
Q.06  *
Q.06 c                   endsr
Q.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.09  * Subrutine for å sende SMS
Q.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.09  *
Q.09 c     ex_snd_SMS    begsr
Q.09  *
Q.09  * Start program for sending av SMS
Q.09  *
Q.09 c                   eval      p_syst = 'O'
Q.09 c                   call      'QO500R'
Q.09 c                   parm                    w_firm
Q.09 c                   parm                    fonumm
Q.09 c                   parm                    fosuff
Q.09 c                   parm                    p_syst
Q.09  *
Q.09 c     endsms        endsr
Q.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.10  * Skriv ut prisbekreftelse
Q.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.10  *
Q.10 c     ex_prt_prisb  begsr
Q.10  *
Q.10 c                   eval      votyl1_otyp = footyp
Q.10 c     votyl1_key    chain     votyl1
Q.10 c                   if        vaoakk <> 2
Q.10 c                   eval      w_mld1 = 'Kan ikke skrive prisbekr.,-
Q.10 c                              feil ordretype.'
Q.10 c                   call      'AA005R'
Q.10 c                   parm                    w_mld1
Q.10 c                   goto      end_prt_prisb
Q.10 c                   endif
Q.10  *
Q.10 c                   eval      w_numm = fonumm
Q.10 c                   eval      w_suff = fosuff
Q.10 c                   eval      w_acti = 'B'
Q.10 c                   eval      w_qsta = *blanks
Q.10 c
Q.10 c                   call      'QO600C'
Q.10 c                   parm                    w_numm
Q.10 c                   parm                    w_suff
Q.10 c                   parm                    w_acti
Q.10 c                   parm                    w_qsta
Q.10  *
Q.10 c     end_prt_prisb endsr
Q.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.11  * Subrutine for å sette ordren til utlevert
Q.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.11  *
Q.11 c     ex_utlev      begsr
Q.11  *
Q.11 c                   eval      votyl1_otyp = footyp
Q.11 c     votyl1_key    chain     votyl1
Q.11 c                   if        vaoakk <> 1
Q.11 c                   eval      w_mld1 = 'Kan ikke settes utlevert,-
Q.11 c                              feil ordretype.'
Q.11 c                   call      'AA005R'
Q.11 c                   parm                    w_mld1
Q.111c                   eval      b_utle = *off
Q.11 c                   goto      end_utlev
Q.11 c                   endif
Q.11  *
Q.11 c                   exsr      oppdat_ordre
Q.11  *
Q.11  * Kjør rutine for utlevering
Q.11  *
Q.11 c                   call      'QO737R'
Q.11 c                   parm                    w_stat
Q.11 c                   parm                    w_firm
Q.11 c                   parm                    w_numm
Q.11 c                   parm                    w_suff
Q.11  *
Q.11 c     end_utlev     endsr
      * - - - - - - - - - -Q.10  * - - - - - - - - - - - - - - - - - - - -
Q.10  * Skriv ut prisbekreftelse
Q.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Q.10  *
Q.10 c     ex_vis_excel  begsr
     c
     c*                   eval      w_filn = '/home/bkv700/foo.xlsx'
     c*                   eval      w_filn = '/home/FOO.XLSX'
     c                   eval      w_filn = '/home/foo.csv'
     c                   eval      w_fnav = 'varelinjer.csv'
     c                   eval      w_mime = 'application/vnd.ms-excel'
     c*                   eval      w_mime = 'application/vnd.openxmlformats+
     c*                                    -officedocument.spreadsheetml.sheet'
     c
Q.11 c                   call      'AF729R'
     c                   parm                    w_filn
     c                   parm                    w_fnav
     c                   parm                    w_mime
     c
Q.11 c     end_excel     endsr
7.22  * - - - - - - - - - -Q.10  * - - - - - - - - - - - - - - - - - - - -
7.22  * Vis vare mot transport
7.22  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.22  *
7.22 c     ex_vis_tvare  begsr
7.22 c
6.21  *
6.21  * Sjekker om noen av varene på ordren er linket mot varegr.
6.21  * for transport, gjøres kun dersom kjørekontor = 1
6.24  * Hvis ordretype har positivt fortegn
6.24  *
7.22  *
7.22  * Henter behandlingskode for ordretype
7.22  *
7.22 c                   eval      votyl1_otyp = footyp
7.22 c     votyl1_key    chain     votyl1
7.22  *
6.24 c                   if        vaokre = *blank
6.24  *
6.21 c                   eval      ra17l1_qkod = folmat
6.21 c     ra17l1_key    chain     ra17l1r
6.21 c                   if        raqkjo = 1
6.21 c                   eval      w_varenr = *blanks
6.21 c                   call      'VR743R'
6.21 c                   parm                    w_firm
6.NU c                   parm                    w_numm
6.21 c                   parm                    w_lmat
6.21 c                   parm                    w_indi
6.21 c                   parm                    w_varenr
6.21  *
6.21 c                   if        w_indi = '1'
6.21 c                   eval      b2vare = w_varenr
Q.06  * Vi legger automatisk til denne varen på ordren.
Q.06 c                   exsr      ex_add_tral
Q.06 c                   eval      b2vare = *blanks
6.21 c                   goto      d1tag
6.21 c                   endif
6.21 c                   endif
6.24 c                   endif
6.21  *
7.22 c     end_tvare     endsr
7.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.10  * Send kjørekontor epost
7.10  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.10  *
7.10 c     send_kj_mail  begsr
7.10 c
7.10 c                   if        l_filg <> 'D22'
7.10 c                   leavesr
7.10 c                   endif
7.10  * FIXME: gjør mail adresser dynamisk
7.10 d* p_rec1          s             50    inz('sa@monter.kirkenes.no')
7.10 d* p_rec2          s             50    inz('lager@monter.kirkenes.no')
7.10 d* p_rec3          s             50    inz(' ')
7.10 d* p_rec4          s             50    inz(' ')
7.10 d* p_rec5          s             50    inz(' ')
7.10 d* p_rec6          s             50    inz('        ')
7.10 c
7.10 c**                 if        l_user = 'ASP_D22'
7.10 c                   move      fonumm        w_ordre
7.10 c                   move      fosuff        w_suffi
7.10 c                   eval      p_subj  = *blank
7.10 c                   eval      p_subj  = 'Ordre '    +
7.10 c                                       w_ordre     +
7.10 c                                       ' - ' +
7.10 c                                       w_suffi     +
7.10 c                                       ' er overført kjørekontor'
7.10 c                   eval      p_send = 'noreplay@egretail.no'
7.10 c                   if           p_rec1 <> *blank
7.10 c                             or p_rec2 <> *blank
7.10 c                             or p_rec3 <> *blank
7.10 c                   call      'AF726R'
7.10 c                   parm                    p_rec1
7.10 c                   parm                    p_rec2
7.10 c                   parm                    p_rec3
7.10 c                   parm                    p_send
7.10 c                   parm                    p_subj
7.10 c                   parm                    p_txt1
7.10 c                   parm                    p_txt2
7.10 c                   parm                    p_txt3
7.10 c                   parm                    p_txt4
7.10 c                   parm                    p_avsl
7.10 c                   endif
7.10 c                   if           p_rec4 <> *blank
7.10 c                             or p_rec5 <> *blank
7.10 c                             or p_rec6 <> *blank
7.10 c                   call      'AF726R'
7.10 c                   parm                    p_rec4
7.10 c                   parm                    p_rec5
7.10 c                   parm                    p_rec6
7.10 c                   parm                    p_send
7.10 c                   parm                    p_subj
7.10 c                   parm                    p_txt1
7.10 c                   parm                    p_txt2
7.10 c                   parm                    p_txt3
7.10 c                   parm                    p_txt4
7.10 c                   parm                    p_avsl
7.10 c                   endif
7.10 c**                 endif
7.10  *
7.10 c
7.10 c     end_kj_mail   endsr
      *
7.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.26  * Bytte varenummer
7.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.26  *
7.26 c     xs8win        begsr
7.26  *
7.26 c                   eval      s2nyva = *blank
7.26 c                   eval      s_line = b1line
7.26 c                   eval      s_onum = 0
7.26 c                   eval      s_osuf = 0
7.26 c                   eval      s_olin = 0
7.26 c                   eval      eddtl3_fsys = *blanks
7.26 c                   eval      eddtl3_tell = 0
7.26 c                   eval      eddtl3_line = 0
7.26  *
7.26  * Tar vare på bestillingsinfo
7.26  *
7.26 c                   eval      fodtlr_line = b1line
7.26 c     fodtlr_key    chain     fodtlr
7.26 c                   if        %found
7.26 c                   eval      s_benr = fdbenr
7.26 c                   eval      s_bsuf = fdbsuf
7.26 c                   eval      s_blin = fdblin
7.2t c                   eval      s_onum = fdnumm
7.2t c                   eval      s_osuf = fdsuff
7.2t c                   eval      s_olin = fdline
7.2t c                   endif
7.2t  *
7.2t  * Ta vare på opprinnelig linje netto for evt rekalkulering
7.2t  *
7.2t c                   eval      s_netb = fdsums - fdsumr
7.26  *
7.26  * Sjekk om vi har en linkt til bestilling på EDI
7.26  *
7.26 c                   eval      eddtl2_onum = fdnumm
7.26 c                   eval      eddtl2_osuf = fdsuff
7.26 c                   eval      eddtl2_olin = fdline
7.26 c     eddtl2_key    chain     eddtl2
7.26 c                   if        %found
7.26 c                   eval      s_onum = fdnumm
7.26 c                   eval      s_osuf = fdsuff
7.26 c                   eval      s_olin = fdline
7.26 c                   eval      eddtl3_fsys = edfsys
7.26 c                   eval      eddtl3_tell = edtell
7.26 c                   eval      eddtl3_line = edline
7.26 c                   endif
7.26  *
7.26 c     s2tagb        tag
7.26  *
7.26 c                   exfmt     s2win
7.26  *
7.26  * F3=Avslutt
7.26  *
7.26 c                   if        *inkc or *inkl
7.26 c                   eval      *inkc = *on
7.26 c                   leavesr
7.26 c                   endif
7.26  *
7.26 c                   if        *inkd
7.26 c                   call      'VV500R'
7.26 c                   parm                    w_firm
7.26 c                   parm                    w_varenr
7.26 c                   parm                    w_vtxt
7.26 c                   eval      s2nyva = w_varenr
7.26 c                   endif
7.26  *
7.26  * Identifisering/validering av vare
7.26  *
7.26 c                   if        s2nyva <> *blank
7.26 c                   eval      b2vare = s2nyva
7.26 c                   exsr      ident_vare2
7.26 c                   if        b_feil = *on
7.26 c                   eval      *in31 = *on
7.26 c                   goto      s2tagb
7.26 c                   endif
7.26 c                   else
7.26 c                   eval      *in31 = *on
7.26 c                   goto      s2tagb
7.26 c                   endif
7.26  *
7.26 c                   exsr      hent_linjenr
7.26 c                   eval      w_line = w_line + 10
7.26 c                   eval      b2ltyp = *blank
7.fd c                   eval      w_erst = 0
7.fd c                   if        sk100p = 1
7.fd c                   eval      w_erst = 1
7.fd c                   endif
7.26 c                   exsr      reg_vare
7.26  *
7.26  * Sjekk om ny linje er registrert. Hvis ja, slett gammel,
7.26  * hvis nei, behold gammel linje.
7.26  *
7.26 c                   eval      fodtl1_line = w_line
7.26 c     fodtl1_key    chain     fodtl1
7.26 c                   if        %found(fodtl1)
7.2t  *
7.2t  * Rekalkuler ny linje dersom overstyring av B2C og B2C ordre
7.2t  *
7.2t c                   if        u_72t = *on and
7.2t c                             fofsys = 'B2C'
7.2t c                   exsr      vare_b2c
7.2t c                   endif
7.26  *
7.26  * sletter gammel linje
7.26  *
7.26 c                   eval      w_spgm      = 'FD100R'
7.26 c                   call      'FS710R'
7.26 c                   parm                    w_firm
7.26 c                   parm                    w_numm
7.26 c                   parm                    w_suff
7.26 c                   parm                    s_line
7.26 c                   parm                    w_spgm
7.26 c                   eval      fodtlu_line = s_line
7.26 c     fodtlu_key    chain     fodtlu
7.26 c                   if        %found(fodtlu)
7.26 c                   delete    fodtlur
7.26  *
7.26  * Oppdaterer lager
7.26  *
7.26 c                   if        faalag <> 0
7.26 c                   eval      fdanta = fdanta * -1
7.26 c                   exsr      oppdat_lager
7.26 c                   endif
7.26  *
7.26  * Sletter lengdespesif.linjer
7.26  *
7.26 c                   eval      fvlslu_numm = w_numm
7.26 c                   eval      fvlslu_suff = w_suff
7.26 c                   eval      fvlslu_line = fodtlu_line
7.26 c     fvlslu_key    setll     fvlslu
7.26 c     fvlslu_key    reade     fvlslu
7.26  *
7.26 c                   dow       not %eof
7.26 c                   delete    fvlslur
7.26 c     fvlslu_key    reade     fvlslu
7.26 c                   enddo
7.26  *
7.26  * oppdaterer med evt. best.data
7.26  *
7.26 c                   eval      fodtlu_line = w_line
7.26 c     fodtlu_key    chain     fodtlu
7.26 c                   if        %found(fodtlu)
7.26 c                   eval      fdbenr = s_benr
7.26 c                   eval      fdbsuf = s_bsuf
7.26 c                   eval      fdblin = s_blin
7.26 c                   update    fodtlur
7.26 c                   endif
7.26  *
7.26  * oppdaterer med evt. best.data
7.26  *
7.26 c     eddtl3_key    chain     eddtl3
7.26 c                   if        %found(eddtl3)
7.26 c                   eval      edonum = s_onum
7.26 c                   eval      edosuf = s_osuf
7.26 c                   eval      edolin = w_line
7.26 c                   update    eddtl3r
7.26 c                   endif
7.26  *
7.26 c                   endif
7.26 c                   endif
7.26  *
7.26 c                   eval      b_forn = *on
7.26  *
7.26 c                   endsr
7.26  *
7.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.26  * Subrutine for identifisering/validering av vare
7.26  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.26  *
7.26 c     ident_vare2   begsr
7.26  *
7.26 c                   eval      w_enhe = *blank
7.26 c                   eval      w_gtin = 0
7.26  *
7.26  * Finner lengde og sjekker om varenummer inneholder alfa-verdi
7.26  *
7.26 c                   eval      w_leng = %len(%trim(b2vare))
7.26  *
7.26 c     digit         check     b2vare        w_posi
7.26  *
7.26  * Behandling dersom alfa
7.26  *
7.26 c                   if        w_posi > 0
7.26  *
7.26  * sjekker om logistikk-vare
7.26 c                   eval      w_lv_vare = *blank
7.26 c/exec sql
7.26 c+ select vvlvnr
7.26 c+ into   :w_lv_vare
7.26 c+ from   vvlepf
7.26 c+ where  vvllva = :b2vare
7.26 c+ fetch first 1 rows only
7.26 c/end-exec
7.26 c                   if        w_lv_vare <> *blank
7.26 c                   eval      b2vare = w_lv_vare
7.26 c                   leavesr
7.26 c                   endif
7.26  *
7.26 c                   eval      vvarl4_lvar = b2vare
7.26 c     vvarl4_key    chain     vvarl4
7.26 c                   if        %found
7.26 c                   eval      b2vare = vvvare
7.26 c                   leavesr
7.26 c                   endif
7.26  *
7.26  * Dette skal ses på som varesøk
7.26  *
7.26 c                   eval      p_vare = %trim(b2vare)
7.26 c                   call      'FD102R'
7.26 c                   parm                    p_stat
7.26 c                   parm                    w_firm
7.26 c                   parm                    w_numm
7.26 c                   parm                    w_suff
7.26 c                   parm                    w_line
7.26 c                   parm                    b_kost
7.26 c                   parm                    p_vare
7.f4 c                   parm                    b_depo
7.26 c                   eval      *in49 = b_kost
7.26 c                   eval      b_oppr = *on
7.26 c                   eval      p_stat = *on
7.26 c                   leavesr
7.26  *
7.26 c                   endif
7.26  *
7.26  * Behandling dersom lengde <= 8
7.26  *
7.26 c                   if        w_leng <= 8
7.26  *
7.26 c                   eval      w_lvre = 0
7.26  *
7.26 c                   eval      w_vare = %subst(null:1:8-w_leng) + b2vare
7.26  *
7.26 c                   eval      vvarl1_vare = w_vare
7.26 c     vvarl1_key    chain     vvarl1
7.26 c                   if        %found
7.26 c                   eval      b2vare = vvvare
7.26 c                   leavesr
7.26 c                   endif
7.26  *
8.14 c                   if        *in56 = *off
7.26 c                   eval      jvarl1_vare = w_vare
7.26 c     jvarl1_key    chain     jvarl1
7.26 c                   if        %found(jvarl1)
7.26 c                   eval      b2vare = jvvare
7.26 c                   eval      w_lvre = 1
7.26 c                   leavesr
7.26 c                   endif
8.14 c                   endif
7.26  *
7.26 c                   endif
7.26  *
7.26  * Setter feil-indikator dersom vare ikke ble funnet
7.26  *
7.26 c                   eval      b_feil = *on
7.26 c                   eval      *in31 = *on
7.26  *
7.26 c                   endsr
7.26  *
7.2o  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2o  * Subrutine for å sjekke mvakode i forhold til kunde
7.2o  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2o  *
7.2o c     sjekk_mva     begsr
7.2o c                   eval      w_omva = '3'
7.2o c                   if        fomkod = 1
7.2o c                   eval      vmval1_mkod = 1
7.2o c                   else
7.2o c                   eval      vmval1_mkod = 0
7.2o c                   endif
7.2o c     vmval1_key    chain     vmval1
7.2o c                   if        %found
7.2o c                   eval      w_omva = vamkof
7.2o c                   if        fomkod = 2 and
7.2o c                             vamkuo <> *blank
7.2o c                   eval      w_omva = vamkuo
7.2o c                   endif
7.2o c                   endif
7.2o  * oppdater med korrekt mvakode ihht. kunde
7.2o c     fodtlu_key2   setll     fodtlu
7.2o c     fodtlu_key2   reade     fodtlur
7.2o c                   dow       not %eof
7.2o  *
7.2o c                   eval      fdomva = w_omva
7.2o  *
7.2o c                   time                    fdedat
7.2o c                   time                    fdetim
7.2o c                   eval      fdeusr = l_user
7.2o c                   update    fodtlur
7.2o  *
7.2o c     fodtlu_key2   reade     fodtlur
7.2o c                   enddo
7.2o  *
7.2o c                   endsr

7.27  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.27  * Newlook vask av data
7.27  *  Fjerner tegn som gjør at Newlook feiltolker
7.27  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.27  *
7.27  /FREE
7.27
7.27   begsr newlo_vask;
7.27     for w_teller = 1 to 25;
7.27       w_len = %len(%trim(b1text));
7.27       if (w_len > 0);
7.27       b1text = %ScanRpl('.':'':b1text:w_len); // newlook tåler ikke . på slutten
7.27       endif;
7.27       w_len = %len(%trim(b1text));
7.27       if (w_len > 0);
7.27       b1text = %ScanRpl(':':'':b1text:w_len); // newlook tåler ikke : på slutten
7.27       endif;
7.2g       w_len = %len(%trim(b1tex1));
7.2g       if (w_len > 0);
7.2g       b1tex1 = %ScanRpl('.':'':b1tex1:w_len); // newlook tåler ikke . på slutten
7.2g       endif;
7.2g       w_len = %len(%trim(b1tex1));
7.2g       if (w_len > 0);
7.2g       b1tex1 = %ScanRpl(':':'':b1tex1:w_len); // newlook tåler ikke : på slutten
7.2g       endif;
7.27     endfor ;
7.27   endsr;
7.27  /END-FREE
7.2t  *
7.2t  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2t  * Rekalkuler etter bytting av B2C vare for å sikre samme linjebeløp
7.2t  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.2t  *
7.2t  /FREE
7.2t   begsr vare_b2c;
7.2t
7.2t     w_linnet = fdsums - fdsumr;
7.2t
7.2t     if  w_linnet > s_netb;
7.2t         w_lindif = fdsums - s_netb;
7.2t         eval(h) w_nyrab = (w_lindif *100) / fdsums;
7.2t
7.2t       eval(h) w_nynet = fdsums - ((fdsums * w_nyrab) /100);
7.2t       if w_nynet > s_netb;
7.2t          w_nyrab = w_nyrab + 0,01;
7.2t       endif;
7.2t
7.2t    exec sql update fodtpf
7.2t             set fdrab1=:w_nyrab, fdrab2=0 ,fdsumr=:w_lindif
7.2t             where fdfirm = :w_firm and
7.2t                   fdnumm = :fdnumm and
7.2t                   fdsuff = :fdsuff and
7.2t                   fdline = :w_line;
7.2t     endif;
7.2t   endsr;
7.2t  /END-FREE
7.f6  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.f6  * Sjekker om det skal beregnes nytt depositum
7.f6  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.f6  *
7.f6 c     sjk_depo      begsr
7.f6  *
7.f6  * Er det lagt inn forskudd på denne ordren
7.f6  *
7.f6 c                   eval      sdepl1_numm = fonumm
7.f6 c                   eval      sdepl1_kund = fokund
7.f6 c                   eval      sdepl1_tell = 0
7.f6 c     sdepl1_key    chain     sdepl1r
7.f6 c                   if        %found(sdepl1)
7.f6  * Det er enda ikke betalt inn depositum
7.f6 c                   if        skdepb = 0
7.f6  *
7.f6  * Beregn ordretotal
7.f6  *
7.f6 c                   eval      w_sumi = 0
7.f6 c                   eval      w_sumu = 0
7.f6 c                   call      'FO704R '
7.f6 c                   parm                    w_firm
7.f6 c                   parm                    w_numm
7.f6 c                   parm                    w_suff
7.f6 c                   parm                    w_sumi
7.f6 c                   parm                    w_sumu
7.f6  *
7.fg  * Hvis total er 0, sjekk om beregnet depositum stemmer med det som er beregnet fra før.
7.fg  *
7.fg c                   if        s_tota = 0
7.fg  *
7.fg c                   if        sk100p = 1
7.fg c                   eval      s_tota = sktotu
7.fg c                   else
7.fg c                   eval      s_tota = skdepo * (100/skdepp)
7.fg c                   endif
7.f6  *
7.f6  * Hvis ordretotal har økt, vis bilde for depositum på nytt
7.f6  *
7.fg c                   if        sk100p = 1 and
7.fg c                             w_sumu > s_tota or
7.fg c                             sk100p = 0 and
7.fg c                             w_sumi > s_tota
7.f6 c                   eval      w_mld1 = *blank
7.f6 c                   eval      w_mld1 = 'Ordretotal har økt. Depositum bør -
7.f6 c                             rekalkuleres'
7.f6 c                   call      'AA005R'
7.f6 c                   parm                    w_mld1
7.f6 c                   exsr      xs1win
7.f6 c                   endif
7.fg  *
7.fg c                   else
7.fg c                   if        w_sumu > s_tota
7.f6 c                   eval      w_mld1 = *blank
7.f6 c                   eval      w_mld1 = 'Ordretotal har økt. Depositum bør -
7.f6 c                             rekalkuleres'
7.f6 c                   call      'AA005R'
7.f6 c                   parm                    w_mld1
7.f6 c                   exsr      xs1win
7.f6 c                   endif
7.fg c                   endif
7.f6  *
7.f6 c                   endif
7.f6 c                   endif
7.f6  *
7.f6 c                   endsr
7.f6  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_stat
     c                   parm                    p_firm
     c                   parm                    p_numm
     c                   parm                    p_suff
6.3i c                   parm                    p_txtl
      *
      * Key for oppslag på kunde
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Key for oppslag på leverandør
      *
     c     rlevl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rlevl1_levr
      *
      * Key for oppslag på ofak-koderegister
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag på lager/innkjøp-koderegister
      *
     c     lstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag på ordretype
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for oppslag på linjetype
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for oppslag på vare
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for oppslag på vare m/lev.varenr
      *
     c     vvarl4_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl4_lvar
      *
      * Key for oppslag på odre-hode
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
      *
      * Key for oppdatering av odre-hode
      *
     c     fohelu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
      *
      * Key for les på ordre-linje
      *
     c     fodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
     c                   kfld                    fodtl1_line
      *
      * Key for les/oppslag på ordre-linje
      *
     c     fodtlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
     c                   kfld                    fodtlr_line
      *
     c     fodtlr_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
      *
      * Key for oppdatering av ordre-linje
      *
     c     fodtlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
     c                   kfld                    fodtlu_line
7.24  *
7.24  * Key for oppdatering på ordre-linje TILLEGGSTABELL
7.24  *
7.24 c     fod2lu_key    klist
7.24 c                   kfld                    w_firm
7.24 c                   kfld                    w_numm
7.24 c                   kfld                    w_suff
7.24 c                   kfld                    fodtl1_line
      *
     c     fodtlu_key2   klist
     c                   kfld                    w_firm
     c                   kfld                    w_numm
     c                   kfld                    w_suff
5.32  *
5.32  * Key for oppdatering av lengdespesifikasjoner
5.32  *
5.32 c     fvlslu_key    klist
5.32 c                   kfld                    w_firm
5.32 c                   kfld                    fvlslu_numm
5.32 c                   kfld                    fvlslu_suff
5.32 c                   kfld                    fvlslu_line
5.51  *
5.51  * Key for oppslag/les kundeprosjekt
5.51  *
5.51 c     fkprl1_key    klist
5.51 c                   kfld                    w_firm
5.51 c                   kfld                    fkprl1_kund
5.51 c                   kfld                    fkprl1_kpro
      *
6.21  *
6.21 c     ra17l1_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    ra17l1_qkod
      *
      * Key for oppslag på bruker-registrer
      *
     c     fusrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fusrl1_user
      *
      * Key for oppslag på leveringstype
      *
     c     vltpl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltpl1_lety
6.25  *
6.25  * Key for les av moduler Nexstep
6.25  *
6.25 c     amodl1_key    klist
6.25 c                   kfld                    amodl1_modu
6.25  *
6.25  * Key for propertiesfil
6.25  *
6.25 c     afpslr_key    klist
6.25 c                   kfld                    afpslr_ufil
6.25 c                   kfld                    afpslr_uide
6.25  *
6.25  * Key for oppslag på kunde - kontaktperson
6.25  *
6.25 c     rukpl6_key    klist
6.25 c                   kfld                    w_firm
6.25 c                   kfld                    rukpl6_kund
7.2B  *
7.2B  * Key for file : Firmastyrt validering
7.2B  *
7.2B c     avall1_key    klist
7.2B c                   kfld                    w_firm
7.2B c                   kfld                    avall1_apgm
6.31  *
6.31  * Key for oppslag/les kortregister
6.31  *
6.31 c     rukrl5_key    klist
6.31 c                   kfld                    w_firm
6.31 c                   kfld                    rukrl5_ktyp
6.31 c                   kfld                    rukrl5_kkun
6.31 c                   kfld                    rukrl5_kpro
6.31  *
6.31  * Key for les på kortregister
6.31  *
6.31 c     ruksl1_key    klist
6.31 c                   kfld                    w_firm
6.31 c                   kfld                    ruksl1_skty
6.31 c                   kfld                    ruksl1_slag
6.33  * Key for oppslag på vare i VA
6.33  *
6.33 c     jvarl1_key    klist
6.33 c                   kfld                    jvarl1_vare
6.3d  *
6.3d  * Key for oppslag på shop-koderegister
6.3d  *
6.3d c     bstsl1_key    klist
6.3d c                   kfld                    w_firm
6.3f  *
6.3f  * Key for oppslag på depositum-fil
6.3f  *
6.3f c     sdepl1_key    klist
6.3f c                   kfld                    w_firm
6.3f c                   kfld                    sdepl1_numm
6.3f c                   kfld                    sdepl1_kund
7.fb c                   kfld                    sdepl1_tell
7.f0  *
7.f0  * Key for oppslag på depositum-fil
7.f0  *
7.f0 c     sdeplr_key    klist
7.f0 c                   kfld                    w_firm
7.f0 c                   kfld                    sdeplr_numm
7.f0 c                   kfld                    sdeplr_kund
7.f0 c                   kfld                    sdeplr_tell
7.f0  *
7.f0  * Key for oppslag på depositum-fil
7.f0  *
7.f0 c     sdeplr_key2   klist
7.f0 c                   kfld                    w_firm
7.f0 c                   kfld                    sdeplr_numm
7.f0 c                   kfld                    sdeplr_kund
7.fb  *
7.fb  * Key for oppslag på depositum-fil
7.fb  *
7.fb c     sdeplu_key    klist
7.fb c                   kfld                    w_firm
7.fb c                   kfld                    sdeplu_numm
7.fb c                   kfld                    sdeplu_kund
7.fb c                   kfld                    sdeplu_tell
Q.03  *
Q.03  * Key for oppslag på loggfil
Q.03  *
Q.03 c     floglr_key    klist
Q.03 c                   kfld                    w_firm
Q.03 c                   kfld                    floglr_aarr
Q.03 c                   kfld                    floglr_numm
Q.03 c                   kfld                    floglr_suff
Q.04  *
Q.04  * Key for oppslag på bestillingsfil
Q.04  *
Q.04 c     lohel1_key    klist
Q.04 c                   kfld                    w_firm
Q.04 c                   kfld                    lohel1_numm
Q.04 c                   kfld                    lohel1_suff
7.08  *
7.08  * Key for vare-lager
7.08  *
7.08 c     vlagl1_key    klist
7.08 c                   kfld                    w_firm
7.08 c                   kfld                    vlagl1_vare
7.08 c                   kfld                    vlagl1_lage
7.08  *
7.08  * Key for vare-lev VA
7.08  *
7.08 c     jvlel1_key    klist
7.08 c                   kfld                    jvlel1_lvnr
7.08 c                   kfld                    jvlel1_lldo
7.08  *
7.08  * Key for leverandør VA
7.08  *
7.08 c     jlevl3_key    klist
7.08 c                   kfld                    jlevl3_enum
Q.07  *
Q.07  * Key for oppslag på bestillingsfil
Q.07  *
Q.07 c     lodtlc_key    klist
Q.07 c                   kfld                    w_firm
Q.07 c                   kfld                    lodtlc_ornu
Q.07 c                   kfld                    lodtlc_orsu
Q.07 c                   kfld                    lodtlc_orli
7.26  *
7.26  * Key for les/oppslag på ordre-linje
7.26  *
7.26 c     eddtl2_key    klist
7.26 c                   kfld                    w_firm
7.26 c                   kfld                    eddtl2_onum
7.26 c                   kfld                    eddtl2_osuf
7.26 c                   kfld                    eddtl2_olin
7.26  *
7.26  * Key for les/oppslag på ordre-linje
7.26  *
7.26 c     eddtl3_key    klist
7.26 c                   kfld                    w_firm
7.26 c                   kfld                    eddtl3_fsys
7.26 c                   kfld                    eddtl3_tell
7.26 c                   kfld                    eddtl3_line
7.2o  *
7.2o  * Key for oppslag på mva.-kode
7.2o  *
7.2o c     vmval1_key    klist
7.2o c                   kfld                    w_firm
7.2o c                   kfld                    vmval1_mkod
      *
      * Legger inn type for oppdatering av lager  R=Registrering
      *
5.01 c                   move      ' '           hltype
6.37 c                   eval      d_requ = 'rq'
7.19  *
7.19  * Legger inn verdi i w_flag
7.19  *
7.19 c                   eval      w_flag = '0'
      *
      *
      * Henter verdier fra parmametre
      *
     c                   move      p_firm        w_firm
     c                   move      p_numm        w_numm
     c                   move      p_suff        w_suff
      *
      * Henter statusopplysninger fra status-register
      *
     c     fstsl1_key    chain     fstsl1
7.fb c     fstsl1_key    chain     fst2l1
     c     lstsl1_key    chain     lstsl1
      *
7.fb c                   if        faak11 = 1
7.fb c                   eval      *in58 = *on
7.fb c                   endif
      *
      * Henter opplysninger fra bruker
      *
     c                   eval      fusrl1_user = l_user
     c     fusrl1_key    chain     fusrl1
      *
      * Sett indikator som styrer kostpris i henhold til kode på bruker
      *
     c                   if        fbko01 = 1
     c                   eval      *in49 = *on
     c                   else
     c                   eval      *in49 = *off
     c                   endif
      *
     c                   eval      b_kost = *in49
      *
      * Sett indikator som styrer DG-linje og varenummer/ean-nummer
      *
     c                   eval      *in70 = *on
     c                   eval      *in87 = *on
5.53  *
5.53  * Hent mva % for beregning av memosaldo inkl. mva
5.53  *
5.53 c                   eval      w_stat = *blank
5.53 c                   eval      w_mvak = '3'
5.53 c                   time                    w_date
5.53  *
5.53 c                   call      'RS205R'
5.53 c                   parm                    w_stat
5.53 c                   parm                    w_mvak
5.53 c                   parm                    w_mvtx
5.53 c                   parm                    w_date
5.53 c                   parm                    w_mvas
5.53 c                   parm                    w_mvat
5.53 c                   parm                    w_mvaf
5.53 c                   parm                    w_bpro
6.25  *
6.25  * Sjekker om Byggdok skal kjøres forutsetter at
6.25  * modul er på plass og at
6.25  *
6.25 c                   eval      b_bdo1 = *off
6.25 c                   eval      amodl1_modu = 'BYGGDOK'
6.25 c     amodl1_key    chain     amodl1
6.25 c                   if        %found(amodl1)
6.25 c                   eval      afpslr_ufil = l_filg
6.25 c                   eval      afpslr_uide = 'BYGGDOK   '
6.25  *
6.34  * Sjekk om byggdok eller cobuilder aktivering er på/av
6.25  *
6.25 c     afpslr_key    chain     afpslrr
6.25 c                   if        %found(afpslr)
6.25 c                   eval      b_bdo1 = *on
6.34 c                   else
6.34 c                   eval      afpslr_uide = 'COBUILDER '
6.34 c     afpslr_key    chain     afpslrr
6.34 c                   if        %found(afpslr)
6.34 c                   eval      b_bdo1 = *on
6.34 c                   endif
6.25 c                   endif
6.25 c                   endif
7.2B  *
7.2B  * Firmastyrt validering av utvalgte felter
7.2B  * (samme validering som i FO103R)
7.2B c                   eval      avall1_apgm = 'FO103R'
7.2B c     avall1_key    setll     avall1
7.2B c     avall1_key    reade     avall1
7.2B c                   dow       not %eof(avall1)
7.2B c                   if        avaflt = 'FOAVDE'  and
7.2B c                             avaval = 1
7.2B c                   eval      u_avde = *on
7.2B c                   endif
7.2B
7.2B c     avall1_key    reade     avall1
7.2B c                   enddo
6.3d  *
6.3d  * Les av status shop
6.3d  *
6.3d c     bstsl1_key    chain     bstsl1
7.13  *
7.13  *   Hent inn % utvidelse av kreditgrense
8.07 c*                  eval      afpslr_uide = 'KRGRNSUTV'
8.07 c*    afpslr_key    chain     afpslrr
8.07 c*                  if        %found(afpslr)
8.07 c*                  movel     afudss        w_utvgrns
8.07 c*                  endif
7.13  *
7.13  *   Hent inn ant dager fram ordre skal med i memosaldo
8.07 c*                  eval      afpslr_uide = 'MEMODAGER'
8.07 c*    afpslr_key    chain     afpslrr
8.07 c*                  if        %found(afpslr)
8.07 c*                  movel     afudss        w_3x
8.07 c*                  move      w_3x          w_memodagr
8.07 c*                  endif
7.01  *
7.01  * Konfiguerte tilpasninger
7.04  *
7.01  *
7.01  * Utvidet memosaldo
8.01  *   Hent inn ant dager fram ordre skal med i memosaldo
7.01  *   Hent inn % utvidelse av kreditgrense
7.13  *
8.01 c                   eval      w_memodagr = 999
8.01 c                   eval      w_utvgrns  = 0
7.01  *
7.01   CallP CO402R(l_filg:w_firm:0:'UTVIDET_MEMOSALDO':
7.01                    co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     u_kmem = *on;
8.01     if  %subst(co402_verdi2:1:3) <> *blank;
8.01       w_memodagr = %dec(%subst(co402_verdi2:1:3):3:0);
8.01     endif;
8.01     if  %subst(co402_verdi2:133:2) <> *blank;
8.01       w_utvgrns = %dec(%subst(co402_verdi2:133:2):2:0);
8.01     endif;
7.01   endif;
7.04  *
7.04  * Test om depositumsjekk er av eller på
7.04  *
7.04   u_deps = *on;
7.04   CallP CO402R(l_filg:w_firm:0:'IKKE_BRUK_DEPOSITUM_SJEKK':
7.04                    co402_verdi1:co402_verdi2);
7.04   if co402_verdi1 = '1';
7.04     u_deps = *off;
7.04   endif;
7.05  *
7.05  * Test om gavekort fra shop er lov
7.05  *
7.05   CallP CO402R(l_filg:w_firm:0:'BRUK_GAVEKORT':
7.05                    co402_verdi1:co402_verdi2);
7.05   if co402_verdi1 = '1';
7.05     u_gavk = *on;
7.05   endif;
7.08  *
7.08  * Skal skaffevarer ha farger
7.08  *
7.08   CallP CO402R(l_filg:w_firm:0:'FARGE_SKAFFEVARE':
7.08                    co402_verdi1:co402_verdi2);
7.08   if co402_verdi1 = '1';
7.08     u_fskv = *on;
7.08   endif;
7.08  *
7.08  * Skal utgåtte varer ha farger
7.08  *
7.08   CallP CO402R(l_filg:w_firm:0:'FARGE_UTGAATT_VARE':
7.08                    co402_verdi1:co402_verdi2);
7.08   if co402_verdi1 = '1';
7.08     u_fugv = *on;
7.08   endif;
7.10  *
7.10  * Endring 7.10
7.10  *
7.08   CallP CO402R(l_filg:w_firm:0:'FD100R_710':
7.10                    co402_verdi1:co402_verdi2);
7.10   if co402_verdi1 = '1';
7.10     u_710 = *on;
7.10   endif;
7.11  *
7.11  * Endring 7.11
7.11  *
7.11   CallP CO402R(l_filg:w_firm:0:'FD100R_711':
7.11                    co402_verdi1:co402_verdi2);
7.11   if co402_verdi1 = '1';
7.11     u_711 = *on;
7.11   endif;
7.12  *
7.12  * Endring 7.12
7.12  *
7.12   CallP CO402R(l_filg:w_firm:0:'FD100R_712':
7.12                    co402_verdi1:co402_verdi2);
7.12   if co402_verdi1 = '1';
7.12     u_712 = *on;
7.12   endif;
7.13  *
7.13  * Endring 7.13
7.13  *
7.13  *CallP CO402R(l_filg:w_firm:0:'FD100R_713':
7.13  *                 co402_verdi1:co402_verdi2);
7.13  *if co402_verdi1 = '1';
7.13  *  u_713 = *on;
7.13  *endif;
7.14  *
7.14  * Endring 7.14
7.14  *
7.14   CallP CO402R(l_filg:w_firm:0:'FD100R_714':
7.14                    co402_verdi1:co402_verdi2);
7.14   if co402_verdi1 = '1';
7.14     u_714 = *on;
7.14   endif;
7.15  *
7.15  * Endring 7.15
7.15  *
7.15   CallP CO402R(l_filg:w_firm:0:'FD100R_715':
7.15                    co402_verdi1:co402_verdi2);
7.15   if co402_verdi1 = '1';
7.15     u_715 = *on;
7.15   endif;
7.16  *
7.16  * Endring 7.16
7.16  *
7.16   CallP CO402R(l_filg:w_firm:0:'FD100R_716':
7.16                    co402_verdi1:co402_verdi2);
7.16   if co402_verdi1 = '1';
7.16     u_716 = *on;
7.16   endif;
7.17  *
7.17  * Endring 7.17
7.17  *
7.17   CallP CO402R(l_filg:w_firm:0:'FD100R_717':
7.17                    co402_verdi1:co402_verdi2);
7.17   if co402_verdi1 = '1';
7.17     u_717 = *on;
7.17   endif;
7.18  *
7.18  * Endring 7.18
7.18  *
7.18   CallP CO402R(l_filg:w_firm:0:'FD100R_718':
7.18                    co402_verdi1:co402_verdi2);
7.18   if co402_verdi1 = '1';
7.18     u_718 = *on;
7.18   endif;
7.19  *
7.19  * Endring 7.19
7.19  *
7.19   *in54 = *off;
7.19   CallP CO402R(l_filg:w_firm:0:'FD100R_719':
7.19                    co402_verdi1:co402_verdi2);
7.19   if co402_verdi1 = '1';
7.19     u_719 = *on;
7.19     *in54 = *on;
7.19   endif;
7.29  *
7.29  * Endring 7.29
7.29  *
7.29   *in55 = *off;
7.29   CallP CO402R(l_filg:w_firm:0:'FD100R_729':
7.29                    co402_verdi1:co402_verdi2);
7.29   if co402_verdi1 = '1';
7.29     u_729 = *on;
7.29     *in55 = *on;
7.29   endif;
7.2D  *
7.2D  * Endring 7.2D
7.2D  *
7.2D   *in56 = *off;
7.2D   CallP CO402R(l_filg:w_firm:0:'SOLVE_VA':
7.2D                    co402_verdi1:co402_verdi2);
7.2D   if co402_verdi1 = '1';
7.2D     *in56 = *on;
7.2D   endif;
7.2lx *
7.2lx * Test om fargekode fra sortimentskode
7.2lx *
7.2lx  CallP CO402R(l_filg:w_firm:0:'FARGE_SKAFF_SORTIMENT':
7.2lx                   co402_verdi1:co402_verdi2);
7.2lx  if co402_verdi1 = '1';
7.2lx    u_fsor = *on;
7.2lx    w_fso1 = %subst(co402_verdi2:3:%scan('B=':co402_verdi2) - 3);
7.2lx    w_fso2 = %subst(co402_verdi2:%scan('B=':co402_verdi2) + 2:10);
7.2lx  endif;
      *
7.2l  *
7.2l  *    Sjekk om 'Pakkseddel' og om bruker kan endre tekst
7.2l  *
7.2l  * PAKK_TEKST_ENDRE_OM_IKKE_TILGANG
7.2l  *
7.2l   CallP CO402R(l_filg:w_firm:0:'PAKK_TEKST_ENDRE_OM_IKKE_TILGANG':
7.2l                    co402_verdi1:co402_verdi2);
7.2l   if co402_verdi1 = '1';
7.2l     w_tekst_pakk = 'J';
7.2l   endif;
7.2l c     fohel1_key    chain     fohel1
7.2l  *
7.2l  * Hent opplysninger fra ordretype-register
7.2l  *
7.2l c                   eval      votyl1_otyp = footyp
7.2l c     votyl1_key    chain     votyl1
7.2l  *
7.2l  * Sjekk, oppdaterer denne akkumlatoretypen "memosaldo"
7.2l  *
7.2l c                   if        vaoakk >= 2
7.2l c                             and  w_tekst_pakk = 'J'
7.2l c                   eval      w_pakk_sperr = 'J'
7.2l c                   endif
7.2t  *
7.2t  * Endring 7.2t
7.2t  *
7.2t   CallP CO402R(l_filg:w_firm:0:'VARE_B2C':
7.2t                    co402_verdi1:co402_verdi2);
7.2t   if co402_verdi1 = '1';
7.2t     u_72t = *on;
7.2t   endif;
7.2u  *
7.2u  * Endring 7.2u - kjøre forenklet plukkeprosess
7.2u  *
7.2u   *in57 = *off;
7.2u   CallP CO402R(l_filg:w_firm:0:'FORENKLET_PLUKKING':
7.2u                    co402_verdi1:co402_verdi2);
7.2u   if co402_verdi1 = '1';
7.2u     *in57 = *on;
7.2u     u_72u = *on;
7.2u   endif;
7.30  *
7.30  * Endring 7.30
7.30  *
8.02   *in59 = *off;
7.30   CallP CO402R(l_filg:w_firm:0:'FD100R_EXCEL':
7.30                    co402_verdi1:co402_verdi2);
7.30   if co402_verdi1 = '1';
8.02     *in59   = *on;
7.30     u_excel = *on;
7.30   endif;
7.31  *
7.31  * Endring 7.2m
7.31  *
7.31   CallP CO402R(l_filg:w_firm:0:'PROFFPORTAL_TILBUD':
7.31                    co402_verdi1:co402_verdi2);
7.31   if co402_verdi1 = '1';
7.31     u_731 = *on;
7.31   endif;
8.28  *
8.28  * Test om depositumsjekk er av eller på
8.28  *
8.28   u_best = *off;
8.28   CallP CO402R(l_filg:w_firm:0:'BYTTE_KUNDE_MED_BESTILLING':
8.28                    co402_verdi1:co402_verdi2);
8.28   if co402_verdi1 = '1';
8.28     u_best = *on;
8.28   endif;
      *
      * farger
9.xx c                   eval      *in45 = *off
9.xx c                   eval      *in46 = *off
Q.03 c                   time                    w_date
      *
     c                   endsr
