# RPG Program JR890R: Explanation

This RPG program processes records from input files, performs validation and lookups, and updates a target file with data from an external source (S4). The main purpose is to read item-related data, process specific item records, and update order quantities in a database.

---

## 1. File Declarations

```rpg
fjrvapf    if   e           k disk
fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
fjvprl2    if   e           k disk    rename(jvprpfr:jvprl2r)
fvvarlu    uf   e           k disk    rename(vvarpfr:vvarlur)
```

- **jrvapf**: Main input file (probably raw data from S4).
- **jlevl1**: Supplier master file (aliased to `jlevl1r`).
- **jvprl2**: Item price file (aliased to `jvprl2r`).
- **vvarlu**: Item master file (aliased to `vvarlur`), updated by the program.

---

## 2. Data Structures & Variables

### Local Data Area (LDA)
```rpg
d                uds
d l_firm                944    946  0
```
- Pulls company code from LDA positions 944-946.

### Temporary Buffers for S4 Record Types

- `m1_list`, `m3_list`, `m5_list`: Hold entire input records of types 161, 163, 165, respectively.
    - `m3_ldor`, `m3_lvar`: Fields within `m3_list` (supplier number and item code).
    - `m5_anta`: Field within `m5_list` (order quantity/amount).

### Variables for Keys and Processing

- Variables like `jlevl1_ldor`, `jvprl2_ldor` etc., hold keys for record lookups.
- `b_første`: Boolean flag (are we processing the first item?).
- `w_rect`: Record type code, extracted from the input record.
- `w_anta`, `w_ldor`, `w_lvar`: Working fields for amounts, supplier, and item.
- `w_firm`: Company code, loaded from LDA.

---

## 3. Main Program Logic

### Load Company Code and Initialize

- Loads company code (`w_firm`) from LDA at program start.

---

### Main Input Processing Loop

```rpg
c                   read      jrvapf                                 90
c                   dow       *in90 = *off
    ...
c                   read      jrvapf                                 90
c                   enddo
```

- Reads one record at a time from the main input file (`jrvapf`).
- Extracts the first 3 characters as `w_rect` (record type: 161, 163, 165).
- If a new item (type 161) is encountered and it's not the first item, calls subroutine `oppdater` to process the item collected so far, then resets buffers.
- Depending on record type:
    - 161: Save to `m1_list`
    - 163: Save to `m3_list`
    - 165: Save to `m5_list`
- Sets `b_første` flag off the first time a 161-record is encountered.

---

### End of File: Process Last Item

```rpg
c                   if        m1_list <> *blank and
c                             b_første = *off
c                   exsr      oppdater
c                   endif
```

- After end-of-file, ensures the last buffered item is processed.

---

## 4. Subroutines

### `oppdater` — Process and Update Item

- **Supplier filtering:** Only processes items from suppliers '9998' or '9999'.
- **Skip if Quantity Blank or 0/1:** If quantity is blank, 0, or 1, skip processing.
- **Normalize Quantity:** Pads `m5_anta` (order quantity) with leading zeros to 8 characters.
- **Find Supplier (jlevl1):** Lookup in supplier master using supplier code.
- **Find Item Price (jvprl2):** Lookup in item price file based on supplier and item code.
- **Find and Update Item (vvarlu):**
    - Lookup item master with company and item number.
    - If found and supplier matches, update the `vvbmen` (order quantity) field.
- Skips further processing if any lookup fails or validation criteria are not met.

---

### *inzsr — Initialization Subroutine

- Defines key lists (for chaining lookups in files).
- Loads company code from LDA into working variable (`w_firm`).

---

## 5. Key Lists

Used for indexed lookups (`CHAIN`) in database files:
- `jlevl1_key`: Supplier number
- `jvprl2_key`: Supplier and item code
- `vvarlu_key`: Company and item number

---

## 6. Comments and Maintenance

- The program is written in Norwegian (many comments are Norwegian).
- It documents changes with headers.

---

## 7. General Flow

1. **Initialize:** Set up keys, load company code from LDA.
2. **Read each record from input:**
    - Group records of types 161/163/165 that describe one item.
    - On new 161-record, process (update) buffered previous item, unless it’s the first.
3. **Processing (`oppdater`):**
    - Ensure supplier is allowed and data is valid.
    - Lookup relevant master and price records.
    - Update item master with new order quantity.
4. **At EOF:** Process any remaining item.
5. **End Program.**

---

## Summary

The program collects item data from multiple input records (based on type), validates it, performs lookups in master files, and updates order quantities for specific suppliers. It is structured around reading and buffering related records, then processing and updating the database when a new item is encountered. The business logic is tightly linked to supplier/item identification and strict validation rules. 

This is classic batch-style RPG coding, typically part of IBM i (AS/400) ETL or data synchronization routines.