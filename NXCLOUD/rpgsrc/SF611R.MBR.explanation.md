# Documentation: SF611R â€“ Statistics Report Printing

## Overview

**Program Name:** SF611R  
**System:** ASSTAT  
**Description:** Printing of statistical reports (Utskrift av statistikk)

This program generates statistical reports based on sales and related data, grouped and broken down by a range of business dimensions (such as product groups, customer categories, discounts, etc.). The report layout and grouping levels are highly configurable, supporting multiple levels of summarization and subtotaling.

---

## Business Context

The program is a core part of the statistics and reporting module. It is designed to process transaction records and summarize them by various business groupings, such as:

- Product groupings (main, sub, overgroups, etc.)
- Customer categories and projects
- Discounts, salespersons, departments, etc.

The grouping and summary logic is controlled by parameters and master data tables, enabling flexible reporting structures.

---

## File Dependencies

The program interacts with a significant number of DB2 physical files (tables), which include:

- **Master tables:** Product (`vvarl1`, `vvasl1`), customer (`rkunl1`), supplier (`rlevl1`), product groupings (`vahgl1`, `vaugl1`, `vogrl1`, `vhgrl1`, `vugrl1`), order types (`votyl1`), and others.
- **Reference tables:** Discount categories (`ra06pf`), departments (`ra07pf`), districts (`ra08pf`), salespersons (`ra09l1`), warehouses (`ra10pf`), customer categories (`ra11pf`), countries (`ra12pf`), delivery types (`vltpl1`), and customer projects (`fkprl1`).
- **Parameter/configuration files:** `skwwpf`, `skpwpf` (likely report configuration/parameter files).
- **Output:** Printer file `sf611p`.

The program uses extensive chaining (random access) to these files to fetch descriptive texts and other master data for reporting.

---

## Key Data Structures

### 1. **Report Text Table (`rt`)**
- `rt` is a 60-element array holding report texts, loaded from CTDATA.
- Each index corresponds to a report/grouping type (see the RAPPORT TEKSTER section at the end).

### 2. **Work Structures**
- Multiple work fields and data structures are defined to manage keys, grouping codes, and accumulator variables for report calculation (e.g., `ant4`, `bru4`, `rab41`, etc.).
- These are used for subtotaling at different grouping levels.

### 3. **Overlayed Key Structures**
- Several DS overlays are used for building keys for file access (e.g., `skpwpf_key`, `beg`, `w_xgrp`).

### 4. **User Data Structure**
- `uds` overlays user, firm, and session-related fields, likely from a global area or job user space.

---

## Report Grouping and Summarization Logic

The program supports up to four levels of grouping, controlled by the parameters `rp1`, `rp2`, and `rp3`, which are populated from the configuration files.

- **l6 (Level 6):** Outermost grouping (e.g., SRT1)
- **l5 (Level 5):** Next grouping (e.g., SRT2)
- **l4 (Level 4):** Innermost grouping (e.g., SRT3)
- **l7:** Firm-level summary (optionally included)

For each level, the program:

- Initializes accumulator fields.
- Moves relevant grouping keys and parameters.
- Calls subroutines to fetch group texts (via `raprut`).
- Summarizes transaction values (quantities, gross/net amounts, discounts, costs).
- Computes percentages (e.g., margin, discount %).
- Handles group breaks (brudd) and writes subtotals to the report.

---

## Main Calculation and Control Flow

### Initialization (`*inzsr`)
- Clears all work fields and accumulators.
- Loads report configuration (grouping types, texts, periods) from parameter files.
- Sets up indicator flags based on configuration (for controlling which group breaks are active).
- Writes initial report headers.

### Main Loops
- The program processes records grouped by SRT1, SRT2, and SRT3 (grouping codes).
- At each level, accumulator fields are reset, and grouping texts are fetched.
- For each transaction, values are accumulated at all active levels.
- At group breaks, the corresponding subroutine is called to calculate subtotals and write them to the report.

### Subroutines

#### `raprut`
- Central routine for resolving grouping texts and descriptions based on the current grouping type (`rap`).
- Uses `chain` to look up the appropriate text in the relevant master file.
- Handles a wide range of grouping types (see RAPPORT TEKSTER mapping).

#### `brdl4`, `brdl5`, `brdl6`, `brdl7`
- Each handles subtotal calculation and percentage computation for a specific grouping level.
- Net and margin values are calculated and percentage values are bounded to avoid overflow.
- Accumulators are rolled up to the next level.

#### `overflow`
- Handles page overflow: writes report headers if the output page is full.

---

## Design Patterns and Conventions

- **Indicator Variables:** The program uses RPG indicators (`*inxx`) to control break logic, output, and conditional processing, based on configuration and current data.
- **Overlayed Data Structures:** For efficient key management and field extraction from parameter records.
- **Extensive Use of Subroutines:** Business logic for each break level and group text lookup is encapsulated in subroutines, improving maintainability.
- **Configurable Grouping:** The report structure is not hardcoded; grouping types and their associated texts are parameter-driven, allowing for high flexibility.
- **Backward Compatibility:** Change logs in the header and incremental field extensions (e.g., `rab71` extended in V5.50) show careful versioning and migration.

---

## Business/Domain-Specific Logic

- **Grouping Codes:** The grouping codes (SRT1, SRT2, SRT3) correspond to business dimensions (e.g., product groups, customer categories, order types) and are mapped to their descriptive texts dynamically.
- **Discount Handling:** Discounts are accumulated and summarized at each level, with logic to combine multiple discount fields.
- **Margin and Discount Percentages:** Calculated at each group break, with business rules to cap values for outliers.
- **Configurable Report Periods:** Periods (from/to month/year) are parameterized and fetched from configuration files.
- **Multi-company Support:** All keys include a firm/company code, supporting multi-company reporting.

---

## Interaction with Other Modules

- **Master Data Synchronization:** The program assumes up-to-date master files for products, customers, suppliers, grouping structures, etc.
- **Parameterization:** Relies on parameter files (e.g., `skpwpf`) for report configuration, grouping, and text mapping.
- **Output Integration:** Generates output to a printer file, likely consumed by downstream printing or archiving processes.

---

## RAPPORT TEKSTER Mapping

The `rt` array (see CTDATA at the end) provides a mapping from grouping codes to their Norwegian descriptions. For example:

| Code | Description             |
|------|------------------------|
| 11   | Alt. hovedgruppe       |
| 12   | Alt. undergruppe       |
| 13   | Rabattgruppe           |
| 14   | Overgruppe             |
| 15   | Hovedgruppe            |
| 16   | Undergruppe            |
| ...  | ...                    |
| 21   | Kundekategori          |
| 22   | Rabattkategori         |
| ...  | ...                    |
| 31   | Varenummer             |
| 32   | Kunde                  |
| ...  | ...                    |

This mapping is used throughout the program for dynamic header and break text generation.

---

## Noteworthy Implementation Details

- **Chained File Access:** The program uses keyed access (`chain`) for performance and to avoid unnecessary reads.
- **Dynamic Text Resolution:** Grouping texts are always resolved at runtime, ensuring that report headers and breaks reflect current master data.
- **Multi-level Summarization:** Roll-up logic is carefully implemented to ensure accurate aggregation at all grouping levels.
- **Legacy RPG Style:** The code is written in traditional RPG/400 style, with heavy use of indicators and fixed-format logic.

---

## Maintenance and Extension Considerations

- **Adding New Grouping Types:** To support new business dimensions, update the RAPPORT TEKSTER table and ensure corresponding master files are available and mapped in `raprut`.
- **Changing Report Layout:** Modify parameter files rather than code for most layout changes.
- **Master Data Dependencies:** Ensure master files are synchronized and contain all necessary descriptive texts for accurate reporting.

---

## Conclusion

SF611R is a flexible, parameter-driven statistics report generator. Its design enables business users to configure grouping and summarization logic without code changes, while encapsulating all business logic for subtotaling, margin, and discount calculations. Understanding the relationships between configuration files, master data, and output is key to maintaining and extending this program.