# RS216R – Currency Code Validation Program Documentation

## Overview

**Program Name:** RS216R  
**System:** ASOKON  
**Purpose:** Validates whether a given currency code is valid and determines which exchange rate should be used based on an effective date.  
**Primary File:** `RA16PFR` (accessed as `RA16L1R` via RENAME)  
**Business Domain:** Currency management/validation in financial applications.

---

## High-Level Functionality

This program serves as a validation routine for currency codes. It checks if the supplied currency code exists in the currency master file and, if valid, determines which exchange rate (current or previous) should be used based on a provided date.

The program is typically called as a subroutine or service program, receiving parameters and returning a status code, description, and exchange rate.

---

## Structure and Key Components

### 1. File Declaration

```rpg
fra16l1    if   e           k disk    rename(ra16pfr:ra16l1r)
```
- **File `RA16PFR`** is accessed for reading with a key, renamed as `RA16L1R` in this program.
- This file is the master data source for currency codes and associated rates.

### 2. Data Definitions

- **Work variables** like `w_firm`, `ra16l1_pkod` are defined based on the structure of the currency file fields (e.g., `rapfir`, `rapkod`, etc.).
- **Parameters:**  
  - `p_stat`: Status code (output)
  - `p_pkod`: Currency code (input)
  - `p_pmna`: Currency name/description (output)
  - `p_pkda`: Effective date (input)
  - `p_pomr`: Exchange rate (output)

- **User data structure:**  
  - Fields for user, firm, and file navigation, likely for audit or logging purposes.

### 3. Parameter List and Initialization

- The program uses a parameter list (`*ENTRY PLIST`) for input/output, following common conventions for callable RPG routines.
- The `*INZSR` subroutine initializes the work firm variable from the input data.

### 4. Business Logic

#### a. Validate Currency Code

- The program sets up a key (`ra16l1_key`) consisting of the firm and the currency code.
- A `CHAIN` operation attempts to retrieve the currency record.
- **If not found:**  
  - `p_stat` is set to `'N'` (not found/invalid)
  - `p_pmna` is set to a fixed error message ("Koden er ugyldig" – "The code is invalid")
- **If found:**  
  - `p_stat` is blank (indicating success)
  - `p_pmna` is set to the currency name from the file.

#### b. Determine Applicable Exchange Rate

- Compares input date (`p_pkda`) with the currency's effective date (`rapkda` from file).
- **If input date is current or newer:**  
  - Sets `p_pomr` to the current exchange rate (`rapmku`)
- **Else:**  
  - Sets `p_pomr` to the previous exchange rate (`rapmkg`)

#### c. Program Termination

- Standard RPG logic to set LR indicator and return.

---

## Indicators

- **60/61**: File operation indicators (used for `CHAIN` success/failure).

---

## Design Notes and Conventions

- **File keying:** All currency lookups are firm-specific, ensuring multi-firm support.
- **Status Coding:** Uses a single-character status (`p_stat`), with `'N'` for not found, blank for success.
- **Parameter Passing:** All input/output is through a parameter list, suitable for subprogram or service program use.
- **Error Messaging:** Returns a fixed error message in the currency name field if the code is invalid.
- **Exchange Rate Selection:** Business rule is to use the "current" rate if the provided date is on or after the effective date; otherwise, the "old" rate is used.

---

## External Relationships

- **RA16PFR (Currency Master File):**  
  - Central repository for all currency codes, descriptions, effective dates, and exchange rates.
  - Any updates to currency codes/rates must be reflected here for this program to function correctly.

- **Calling Programs:**  
  - This routine is intended to be called by other modules needing currency validation and rate retrieval (e.g., transaction entry, reporting).

---

## Business/Domain-Specific Logic

- **Multi-firm support:** The currency code validation is always contextual to the firm (`w_firm`), supporting multi-tenant environments.
- **Date-based rate selection:** Ensures financial calculations are historically accurate by selecting the correct rate based on the transaction/effective date.

---

## Summary Table

| Parameter | Direction | Purpose                                               |
|-----------|-----------|-------------------------------------------------------|
| p_stat    | Out       | Status: blank=found, 'N'=not found                   |
| p_pkod    | In        | Currency code to validate                            |
| p_pmna    | Out       | Currency name/description or error message           |
| p_pkda    | In        | Date for which exchange rate is needed               |
| p_pomr    | Out       | Applicable exchange rate (current or previous)       |

---

## Maintenance Notes

- Any changes to the structure of the currency master file (`RA16PFR`) will require updates to the LIKE definitions.
- If additional status codes or error handling are needed, expand the logic around `p_stat` and `p_pmna`.
- For enhanced auditing, consider expanding the use of user and navigation fields.

---

## Typical Usage Scenario

1. A calling program passes a firm, currency code, and date to RS216R.
2. RS216R verifies if the currency code exists for the firm.
3. If valid, it returns the currency name and the correct exchange rate for the date.
4. If not valid, it returns a status of 'N' and an error message.

---

## Conclusion

RS216R provides a centralized, consistent method for validating currency codes and retrieving the appropriate exchange rate, ensuring data integrity and compliance with business rules across the ASOKON system.