# Program Overview

This RPG IV (ILE RPG) program, `LI715R`, is designed to control and validate electronic invoice (EDI/faktura) data against corresponding purchase orders (bestilling) in the ASLAGR system. It performs checks on message types, header information, line items, totals, tolerances, units, and more, updating record statuses and logging discrepancies for further handling. The code is well-annotated, and has been iteratively maintained and expanded based on business logic and standards, such as NEB (Norsk Byggtjeneste) and GTIN handling.

## File Declarations

- The program uses a large number of files (physical and logical) for data lookup, update, and validation.
- Files are typically suffixed with `1`, `r`, or `u` to indicate logical access, read, or update modes.
- `rename(from_file: to_format)` is used to map logical files or record formats.
- Files include EDI files, vendor, order, item master, tolerances, logging, etc.

## Data Structures (DS) and Variables

- Data structures (`d_fakh1`, `d_fakh2`, etc.) represent invoice header, line, total, parts, references, and transport lines.
- Work variables (prefixed with `w_`), parameter variables (prefixed with `p_`), and flags (prefixed with `b_`) are defined for various intermediate and control purposes.
- Arrays, e.g., `a_line`, are used for lookup/matching across records.
- Constants for upper/lower case letters to enable data normalization.

## Main Program Logic

### Initialization

- Entry parameters are firm, message type, message/order numbers, suffix, and status.
- Key lists (`klist`) are defined for efficient file access.
- Tolerances are initialized from the appropriate file.

### Message Type Check

- Only processes messages of type 'FAKT' (Invoice). Otherwise, sets status and exits.

### Workflow Steps

1. **Reset Record Status (`reset_stat`):**
   - Clears the status for records in the EDI file for the current message.

2. **Read and Validate Message Header:**
   - Attempts to read the invoice header. If missing, sets error status and exits.
   - If found, copies EDI data to work DS and runs header validation subroutine.

3. **Validate Parts Information (`sjk_part`):**
   - Ensures supplier info in the invoice corresponds to vendor master or location data.

4. **Read and Validate Invoice Total:**
   - Reads the total line (for validation). If not found, sets error status and exits.
   - Compares invoice and order totals, applying tolerance checks.

5. **Validate Invoice Lines (`sjk_lin`):**
   - Loops through all invoice lines, validates each against the order lines using keys like GTIN/EAN or NOBB number, checking units, quantities, and prices.
   - Flags lines and header for mismatches.
   - Removes any previously generated unmatched lines.

6. **Beløp (Amount) Check (`sjk_belop`):**
   - Calls another program for summary-level validation and updates the header status if discrepancies are found.

7. **Unit Check & Conversion (`sjk_enhet`, `recalc_linje`, `sjk_omr`, `sjk_edienh`):**
   - Checks for potential unit-of-measure mismatches.
   - Normalizes units (e.g., converts 'PCE' to 'STK').
   - If necessary and allowed, recalculates quantities and prices to match the order's units.
   - Logs all conversions (for supplier delivery quality metrics).
   - If unit conversion is not allowed (per supplier settings), flags accordingly.

8. **Match Cross-Check (`kryss_sjekk`):**
   - Ensures all order lines have corresponding invoice lines, generating missing lines as needed (with 'deviation' status).

9. **End of Program:**
   - Cleans up and returns status.

## Subroutines (SR)

- Each piece of business logic is encapsulated in a subroutine: header check, part check, total check, line check, tolerance checking, order line lookup, logging, etc.
- Subroutines use key lists and parameter variables for efficient processing.

## Error Handling & Status

- Listat (status) codes are set for various discrepancies:
  - 1: Header/order not found.
  - 2: Supplier/EAN mismatch.
  - 3: General error, e.g., line-level errors.
  - 4: Unknown item, unmatched item.
  - 5: Tolerance/amount/price mismatch.
  - 6/7: Unit/quantity discrepancies.
- Header-level status is updated if line-level issues are found.

## Special Features / Handling

- EAN/GTIN/NOBB number matching to find the correct item/order line.
- Unit conversions, with 'slingringsmonn' (tolerance) adjustments.
- Supplier-specific flags to control unit conversions.
- Extensive logging of any automatic adjustments or conversions for audit/tracking.
- Handling of 14-digit GTINs to comply with NEB standards.
- SQL Embedded in RPG for logistics item lookup.
- Commented-out or conditional code reflects business rule changes over time.

## KLIST Usage

- RPG KLISTs (Key Lists) are set up to make file access (CHAIN, SETLL, READE) efficient and centralize key management.

## Comments and Versioning

- Detailed header comments document every functional enhancement, bug fix, and business rule change, including version, date, developer initials, and description.
- Inline comments describe purpose, expected behavior, and known issues or TODOs.
- Version markers (e.g., 6.10, 6.20, 7.01, 8.02) annotate enhancements.

---

# Summary Table of Major Subroutines

| Subroutine     | Purpose                                                           |
|----------------|-------------------------------------------------------------------|
| reset_stat     | Clears EDI record statuses for a message.                         |
| sjk_hode       | Validates message header, ensures order exists.                   |
| sjk_part       | Validates supplier/part info in invoice.                          |
| sjk_tot        | Validates invoice totals against order, using tolerance checks.   |
| sjk_lin        | Validates each invoice line against order lines.                  |
| slett_glin     | Deletes generated unmatched EDI lines.                            |
| finn_nobb      | Finds order line via GTIN/NOBB or item number.                    |
| lin_ktrl       | Checks unit, quantity, and price on an invoice line.              |
| oppd_hode      | Updates invoice header if line errors found.                      |
| kryss_sjekk    | Ensures order lines are represented in EDI, adds if missing.      |
| bygg_xedil     | Constructs a missing EDI line for unmatched order lines.          |
| sjk_toleranse  | Checks price/amount tolerances.                                   |
| omr_enhet      | Converts quantities to match order units if necessary.            |
| sjk_belop      | Checks summarization of invoice amounts (calls another program).  |
| sjk_enhet      | Handles unit-of-measure reconciliation for invoice lines.         |
| sjk_edienh     | Checks if EDI unit is valid for the item.                         |
| sjk_omr        | Checks if supplier’s items should be converted or not.            |
| gen_logg_lin   | Logs all automatic conversions for auditing.                      |

---

# Example: Processing an EDI Invoice

1. **Receive EDI invoice message (`FAKT`)**.
2. **Clear statuses** for all involved records.
3. **Check header**: Is referenced order present in the system?
4. **Check supplier part info**: Does invoice supplier match order supplier?
5. **Check total**: Does invoice total, less deductions, match order total (within tolerance)?
6. **For each invoice line**:
    - **Try to match** with order line via GTIN/EAN or NOBB/item number.
    - **Check unit**: If mismatched, try to convert or flag as error according to supplier settings.
    - **Check quantity and price**: If mismatched and not allowed by tolerances, flag error.
    - **Log any conversions**.
7. **Check all order lines**: Are they present in invoice? If not, add generated lines to EDI with deviation status.
8. **Update status codes** for lines and header as needed.
9. **Return summary status**.

---

# Notable RPG Techniques

- **KLIST and KFLD**: Used for parameterizing file keys.
- **CHAIN, SETLL, READE**: Indexed/random access to DB2 tables/logical files.
- **Data Structure Overlays**: Efficient handling of record formats.
- **Embedded SQL**: For specialized queries, e.g., logistics item number lookup.
- **Use of Flags**: *on/*off (booleans) to control logic flow.
- **Version/Feature Control**: Inline version codes (`6.20`, `7.01`, etc.) for feature/bug toggling.

---

# Final Notes

- **Highly domain-specific**: Code is tightly coupled to Norwegian building industry standards (NEB, NOBB, GTIN, EAN).
- **Maintained for years**: Rich versioning and business context in comments.
- **Expandable**: New partners, units, item number standards, and tolerance rules have been added by extending subroutines and validation logic.
- **Robust error/status handling**: Ensures discrepancies are flagged, logged, and auditable—vital for financial/document integration.

This program is a good example of a robust ILE RPG validation/processing engine for EDI/order synchronization, with strong emphasis on auditability and compliance to external and internal rules.