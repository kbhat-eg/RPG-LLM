     h option(*nodebugio) datedit(*ymd)
     h decedit('0,')
      /title  ASOFAK Gen. faktura i Logiq/Norgros formatparam. (non-EDI)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : FO181R
      * Beskrivelse . . : Fakturabeh., gen. faktura i Logiq/Norgros format
      *                   - Håndtering av elektronisk utg.fakt. (non-EDI)
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       181004 GRO  Nytt program
      *       290107 BOF  Etter avtale lagt inn i blank lev.bet.
      *       300507 BOF  Spes. tegn '25' byttes ut med blank i tekst (36)
      *       310507 BOF  Spes. tegn '|' byttes ut med blank
      *       180607 BOF  Sjekker skafferegister i tilfelle skaffevare
      *       220607 BOF  Hvis tilb.pris/nettopris så dannes 41 rec. (Tilb.)
      *       140807 BOF  Hvis utenl.fakt. så utenl. postnr og landkode
      *       140807 BOF  sjekker om lang el. kort kide - rut.reg FO181
      *       150807 BOF  Omskriving av les og kontroll
      *       071207 BOF  Endret vedr. avgiftsfrie kunder
5.60  *       120808 BOF  Justert mail vedr. Buyers e-postadress
5.60  *       220808 BOF  Tillate lang og kort kid på alle fakt.typer
5.61  *       080908 BOF  Endret EMAIL til EMAILSPLIT og lagt EMAIL på
      *                   fakturatype 25.
5.62  *       151008 BOF  Byggmester-Faktura vedlegg til faktura
5.63  *       111108 BOF  Hente mail-adresse fra kontaktperson-hvis finnes
5.64  *       090109 BOF  Legger dagens dato i datofeltet
5.65  *       020209 BOF  Hindre utskr.av linjet. som er kodet for dette TI
5.66  *       180209 BOF  hente 2 mailadresser på kontaktperson.
5.67  *       300609 BOF  Lagt inn løsning for depositum
5.68  *       161009 BOF  Legge på partsinformasjon IV på efaktura
5.69  *       171109 BOF  Justering av IV på efaktura
6.10  *       110909 BOF  Omskrevet logikk, påbegynt 150807,gjennomført nå !
6.11  *       281009 BOF  Utvidet med TIFF-format fakt.type = 26
6.12  *       281009 BOF  Hvis gate og adr2 = blankt, sett gate = '-'
6.13  *       041209 BOF  tester på | i sdtek1 ot sdtek2
6.14  *       231207 BOF  Endrer hex 3F til A i varetekst
6.15  *       151008 BOF  Lagt inn transportmåte og transportør
6.16  *       100210 BOF  Hvis ' i varetekst ++ erstattes med blank
6.17  *       200910 BOF  Endrer hex 32 til Æ i deres ref.
6.18  *       101210 BOF  På 20 skal kundeid ha foranstilt 0
6.19  *       150211 BOF  På 20 skal postnr ha foranstilt 0
6.1a  *       070311 BOF  Forsendelsesmåte skal også vises på 35
6.1b  *       151110 BOF  Legger på bruksrett rab og beløp
6.1b  *       281210 BOF  Lagt ut mva.gr.lag - bruksrett i sum-record
6.1c  *       010911 BOF  Tar hensyn til negativ rabatt (påslag)
      *                   Må teste på ordretype.
6.1d  *       290713 BOF  vedr. 6.1c, må teste på antall i tillegg
6.21  *       060612 BOF  Utvide med div. felter på rec. 35
6.22  *       280612 BOF  Åpnet for utskrift av netto beløp
6.23  *       250214 NHO  Fjernet add 1 til w_antf (antall fakturaer)
      *                   i forbindelse med bruksrettrabatt
6.24  *       220515 bof  Trekker fra depositum på totalsum
6.25  *       171215 nho  Må også teste på kidvariant 3 faktnr + kontr
6.NU  * R6.30 230514 bsa  Programmet gjennomgått mtp nummerutvidelser.
6.30  *       191115 bsa  Feil beskrivelse av bruksrettsrabatt
6.30  *              bsa  NB Bruksrett beregnes etter Skattum metoden
6.31  *       040716 bof  Feilretting i format (30 og 80)
6.32  *       140217 bsa  Ny mva kode må justere sats som overføres.
6.33  *       021117 bsa  Endrer litt logikk ved beregning av mva sats
6.34  *       210318 bsa  Legger ut iBan og Swift på recordtype 20
6.35  *       191218 bof  Utvidet med trelast-logikk
6.36  *       290519 bsa  Endret beregning av nettopris.
7.01  * K000  040620 bsa  Legger internt eller eksternt prosjektnummer i pos 13
7.02  *K000   080221 sst  Hente factoring bankgironr fra rkbgir på fact.kunde.
7.02  *                   hvis den er definert
7.03  *K000   310820 bsa  Hvis faktura uten ordrelinjer, skal "hodet" merkes
7.03  *                   som overført.
      *
8.01  * 800   230222 ask  Lagt inn switchstyrt valg av bankkonto ved factoring
8.02  *K000   140622 bsa  Switchstyrer om firma eller avdelingsinfo skal legges
8.02  *K000               ut som SU på fila.
8.03  *K000   060722 bsa  Feil i utlegg av IV. En "blank" for mye.
8.04  *K000   221223 bsa  Scanner strengene for ugyldige tegn før den skrives.
8.05  *800    201123 ask  Lagt på sjekk på ordretype og kunde ved factoring
8.06  *PRG2   090622 BOF  Utvidet prisgruppe fra 1 til 2 posisjoner
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
7.02 frkunlr    if   e           k disk    rename(rkunpfr:rkunlrr)
7.02 f                                     prefix(rr:2)
     fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
     fsohelr    if   e           k disk    rename(sohepfr:sohelrr)
     f                                     prefix(xx:2)
     fsodtl1    if   e           k disk    rename(sodtpfr:sodtl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     fveanl2    if   e           k disk    rename(veanpfr:veanl2r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     fra10l1    if   e           k disk    rename(ra10pfr:ra10l1r)
     fra18l1    if   e           k disk    rename(ra18pfr:ra18l1r)
6.15 fra17l1    if   e           k disk    rename(ra17pfr:ra17l1r)
7.02 fraa9l1    if   e           k disk    rename(raa9pfr:raa9pfr)
     fraa8l1    if   e           k disk    rename(raa8pfr:raa8l1r)
     ffmftl1    if   e           k disk    rename(fmftpfr:fmftl1r)
     ffnufl1    if   e           k disk    rename(fnufpfr:fnufl1r)
     ffnufl2    if   e           k disk    rename(fnufpfr:fnufl2r)
     fra07l1    if   e           k disk    rename(ra07pfr:ra07l1r)
     fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
     fvpkol1    if   e           k disk    rename(vpkopfr:vpkol1r)
6.21 ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
     ffnuflu    uf a e           k disk    rename(fnufpfr:fnuflur)
     ffnefpf    o  a e           k disk    rename(fnefpfr:fnefpfr)
     ffneppf    o  a e           k disk    rename(fneppfr:fneppfr)
     ffnempf    o  a e           k disk    rename(fnempfr:fnempfr)
     ffnecpf    o  a e           k disk    rename(fnecpfr:fnecpfr)
7.03 fsodtlr    if   e           k disk    rename(sodtpfr:sodtlrr)
     ffo181p    o    e             printer
      *
      * Definering av Local data area
      *
     d                uds
     d d_kidk                883    883  0
     d l_wsid                901    910
     d l_user                911    920
7.01 d l_filg                931    933
     d l_firm                944    946  0
     d l_fnav                951    980
      *
      * Definering av variabler i nøkler
      *
     d sohel1_aarr     s                   like(soaarr)
     d sohel1_binr     s                   like(sobinr)
     d sohelr_aarr     s                   like(soaarr)
     d sohelr_binr     s                   like(sobinr)
     d sodtl1_aarr     s                   like(sdaarr)
     d sodtl1_binr     s                   like(sdbinr)
     d sodtl1_numm     s                   like(sdnumm)
     d sodtl1_suff     s                   like(sdsuff)
     d rkunl1_kund     s                   like(rkkund)
7.02 d rkunlr_kund     s                   like(rkkund)
     d vvarl1_vare     s                   like(vvvare)
     d vltyl1_ltyp     s                   like(sdltyp)
     d veanl2_vare     s                   like(vxvare)
     d votyl1_otyp     s                   like(vaotyp)
     d ra10l1_jkod     s                   like(rajkod)
     d ra18l1_rkod     s                   like(rarkod)
6.15 d ra17l1_qkod     s                   like(raqkod)
     d fmftl1_faty     s                   like(fmtfat)
     d fnufl1_aarr     s                   like(fnuaar)
     d fnufl1_binr     s                   like(fnubin)
     d fnufl2_ufat     s                   like(fnufat)
     d fnufl2_ukda     s                   like(fnukda)
     d fnuflu_aarr     s                   like(fnuaar)
     d fnuflu_binr     s                   like(fnubin)
     d ra07l1_gkod     s                   like(ragkod)
     d jvarl1_vare     s                   like(jvvare)
     d vpkol1_pkod     s                   like(vapkod)
6.21 d fkprl1_kund     s                   like(flkund)
6.21 d fkprl1_kpro     s                   like(flkpro)
7.03 d sodtlr_aarr     s                   like(sdaarr)
7.03 d sodtlr_binr     s                   like(sdbinr)
      *
      * Definering av variable
      *
     d w_firm          s                   like(rkfirm)
     d w_flin          s           1024
     d w_flinx1        s           1024
     d w_flinx2        s           1024
     d w_flinx3        s           1024
     d w_raba          s              5  2
     d w_tnto          s             13  2
     d w_tmva          s             13  2
     d w_tmva_m        s             15  5
     d w_tmvg          s             13  2
     d w_mdat_iso      s               d   datfmt(*iso)
     d w_mdat_alf      s              8
     d w_mtim          s              6  0
     d w_mtim_alf      s              6
     d w_levd_alf      s              8
     d w_ford_alf      s              8
     d w_fakd_alf      s              8
     d w_odat_alf      s              8
     d w_ponr_alf      s              4
     d w_mref          s              6  0
     d w_ftnr          s              9
     d w_ftex          s             14
     d w_npri          s             13  2
     d w_tbto          s             13  2
     d w_cbda          s               d   datfmt(*iso)
     d w_cfda          s               d   datfmt(*iso)
     d w_retk          s              1
     d w_ctx1          s             20
     d w_ctx2          s             20
     d w_ctxt          s             40
     d w_posm          s              4  0
     d w_numf          s             20
     d w_antx          s             11  2
     d w_anta          s             14
     d w_ntpe          s             15
     d w_ntpf          s             15
     d w_mvap          s              8
     d w_dnto          s             20
     d w_dbto          s             20
     d w_drab          s             20
     d w_antf          s              6  0
     d w_antl          s              6  0
     d w_anto          s              6  0
     d w_enhp          s             11  2
     d w_enhx          s             13
     d w_avru          s             11  2
     d w_avrx          s             13
     d w_rkrx          s             13
     d w_rabx          s              7
     d w_rabp          s              5  2
     d w_rabg          s             11  2
     d w_dmva          s             11  2
     d w_teid          s              1
     d w_binr          s                   like(sobinr)
     d w_fsum          s                   like(sofsum)
     d w_kidd          s                   like(sokidd)
6.25 d w_kid2          s                   like(sokidd)
6.25 d w_kidh          s             21
     d w_kidr          s                   like(sokidr)
6.25 d w_kid3          s              8  0
6.nu d*w_kidrx         s              7
6.nu d w_kidrx         s              9
     d w_wlin          s              6  0
     d w_vare          s                   like(vvvare)
     d w_nobb          s                   like(vvnobb)
     d w_eanx          s             14
     d w_leng          s              2  0
     d w_tek1          s             70
5.64 d w_udat          s               d   datfmt(*iso)
5.62  * byggm.fakt
5.62 d w_bf_n          s             11  2
5.62 d w_bf_g          s             11  2
5.62 d w_bf_m          s             11  2
5.62 d w_bf_b          s             11  2
5.63 d w_krol          s             20
5.66 d w_maip          s             50
5.66 d w_mail          s            100
5.67 d w_besk          s             35
5.69 d w_faku          s                   like(rkfaku)
5.69 d w_kund          s                   like(rkkund)
6.18 d w_kunx          s              6
6.1b d w_rb1p          s             11  2
6.1b d w_rb1h          s             11  2
6.1b d w_rb1f          s             11  2
6.1b d w_gr1p          s             11  2
6.1b d w_gr1h          s             11  2
6.1b d w_gr1f          s             11  2
6.1b d w_gr2p          s             11  2
6.1b d w_gr2h          s             11  2
6.1b d w_gr2f          s             11  2
6.1b d w_rb2p          s             11  2
6.1b d w_rb2h          s             11  2
6.1b d w_rb2f          s             11  2
6.1b d w_rbsu          s             11  2
6.22 d w1rab1          s                   like(sdsapr)
7.02 d w_fbgi          s                   like(aafbgi)
7.02 d w_sbgi          s                   like(aafbgi)
6.31 d w_fbim          s             11  2
6.35 d w_lv_vare       s                   like(sdvare)
8.02 d w_fmai          s                   like(aamail)
8.02 d w_fad1          s                   like(aafad1)
8.02 d w_fad2          s                   like(aafad2)
8.02 d w_fste          s                   like(aafste)
8.02 d w_ftlf          s                   like(aaftlf)
8.02 d w_ffax          s                   like(aaffax)
      *
     d s_fsum          s             11  2
     d s_salp          s             11  2
     d s_salh          s             11  2
     d s_salf          s             11  2
     d s_rk1p          s             11  2
     d s_rk2p          s             11  2
     d s_rkop          s             11  2
     d s_rk1h          s             11  2
     d s_rk2h          s             11  2
     d s_rkoh          s             11  2
     d s_rk1f          s             11  2
     d s_rk2f          s             11  2
     d s_rkof          s             11  2
     d s_fnet          s             11  2
     d s_fbru          s             11  2
     d s_fmva          s             15  5
     d s_fmvg          s             11  2
     d s_frab          s             11  2
     d s_ltyp          s              2
     d s_mvp1          s              6  2
     d s_mvg1          s             11  2
     d s_mvb1          s             15  5
     d s_mvp2          s              6  2
     d s_mvg2          s             11  2
     d s_mvb2          s             15  5
     d s_mvp3          s              6  2
     d s_mvg3          s             11  2
      *
     d                 ds
     d w_kvan                        14  3
     d   w_kvanh                     11    overlay(w_kvan:1)
     d   w_kvand                      3    overlay(w_kvan:12)
     d                 ds
     d w_belo                        17  2
     d   w_beloh                     15    overlay(w_belo:1)
     d   w_belod                      2    overlay(w_belo:16)
     d                 ds
     d w_pros                         5  2
     d   w_prosh                      3    overlay(w_pros:1)
     d   w_prosd                      2    overlay(w_pros:4)
     d                 ds
     d w_pris                        14  3
     d   w_prish                     11    overlay(w_pris:1)
     d   w_prisd                      3    overlay(w_pris:12)
8.01 d w_fbkk                        11  0
8.05 d w_fot1                         2
8.05 d w_fot2                         2
8.05 d w_fot3                         2
8.05 d w_fot4                         2
8.05 d w_fot5                         2
8.05 d w_fack                         1  0
      *
     d b_init          s              1    inz(*off)
     d b_binr          s              1    inz(*off)
     d b_numm          s              1    inz(*off)
     d b_logf          s              1    inz(*off)
     d b_saml          s              1    inz(*off)
     d b_kred          s              1    inz(*off)
     d b_skfl          s              1    inz(*off)
     d b_eof           s              1    inz(*off)
     d b_uskr          s              1    inz(*off)
7.03 d b_alin          s              1    inz(*off)
8.05 d b_fact          s              1    inz(*off)
      *
     d s_binr          s                   like(sobinr)
     d s_numm          s                   like(sonumm)
     d s_lbin          s                   like(sobinr)
     d s_lnum          s                   like(sonumm)
     d s_lsuf          s                   like(sosuff)
      *
      * Definering av parametre
      *
     d p_aarr          s                   like(soaarr)
     d p_faty          s                   like(sofaty)
6.NU d p_fnum          s                   like(sobinr)
6.NU d p_tnum          s                   like(sobinr)
     d p_omkj          s              1
     d p_rapp          s              1
     d p_anta          s              4  0
     d p_feil          s              1
      *
     d p_stat          s              1
     d p_ekod          s              1
     d p_etxt          s             30
     d p_dato          s               d   datfmt(*iso)
     d p_mvap          s              6  2
     d p_mvat          s              5  4
     d p_mvaf          s             10  9
      *
      * Konstanter
      *
     d c_fsep          c                   '|'
     d c_veid          c                   '1.0'
     d c_teid          c                   '1'
      *
7.01   dcl-s co402_verdi1  char(1);
7.01   dcl-s co402_verdi2  char(2048);
7.01   DCL-PR CO402R EXTPGM('CO402R');
7.01     p_filgrp            char(3)     const;
7.01     p_firm              packed(3:0) const;
7.01     p_lager             packed(2:0) const;
7.01     p_nokkel            char(50)    const;
7.01     p_verdi1            char(1);
7.01     p_verdi2            char(2048);
7.01   END-PR;
7.01 d u_701           s              1    inz(*off)
8.01 d u_801           s              1    inz(*off)
8.02 d u_avde          s              1    inz(*off)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     C/Exec SQL
     C+  Set Option DatFmt=*ISO , commit=*none
     C/End-Exec
      *
      * Leser firmadata ifm avsenderinformasjon
      *
     c     afir_key      chain     afirl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      * Henter OFAK informasjon
      *
     c     fstsl1_key    chain     fstsl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
     c*                  eval      ra10l1_jkod = faahla
     c*    ra10l1_key    chain     ra10l1
     c*                  if        not %found
     c*                  goto      avslutt
     c*                  endif
      *
      * Hent statuskode 8
      *
     c     raa8l1_key    chain     raa8l1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      * Henter fakturatype info
      *
     c                   eval      fmftl1_faty = p_faty
     c     fmftl1_key    chain     fmftl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      *
     c                   select
     c                   when      p_omkj = *blank
     c                   eval      fnufl2_ufat = p_faty
     c                   eval      fnufl2_ukda = *loval
     c     fnufl2_key    setll     fnufl2
     c                   read      fnufl2                                 90
     c                   when      p_omkj = '1'
     c                   eval      fnufl1_aarr = p_aarr
     c                   eval      fnufl1_binr = p_fnum
     c     fnufl1_key    setll     fnufl1
     c                   read      fnufl1                                 90
     c                   endsl
      *
     c                   dow       *in90 = *off
      *
      * hvis vanlig kjøring - og kjørt dato <> *loval da kan man avslutte
     c                   if        p_omkj = *blank and
     c                             fnukda <> *loval
     c                   goto      siste
     c                   endif
      * hvis omkjøring  - og til faktnr. er passert kan man avslutte
     c                   if        p_omkj = '1' and
     c                             fnubin > p_tnum
     c                   goto      siste
     c                   endif
      *
     c                   if        fnuaar = p_aarr and
     c                             fnufat = p_faty
      *
     c                   exsr      sjk_uf_log
      *
     c                   if        b_logf = *on
      *
     c                   eval      sohel1_aarr = p_aarr
     c                   eval      sohel1_binr = fnubin
     c     sohel1_key    setll     sohel1
     c     sohel1_key    reade     sohel1
7.03  * Sjekk om faktura har linjer
7.03 c                   exsr      sjk_fakt
7.03  *
7.03 c                   if        b_alin = *off
7.03 c                   eval      s_binr = sobinr
7.03 c                   exsr      upd_uf_log
7.03 c                   goto      noline
7.03 c                   endif
7.03  *
6.1b c                   exsr      sjk_bruksrett
     c                   exsr      sjk_saml
     c                   exsr      gen_fakthod
     c                   exsr      gen_fakpart
      *
     c                   dow       not %eof(sohel1)
      *
     c                   exsr      skriv_olin
      *
      * Iterasjon på fakturahode
      *
     c                   eval      sodtl1_aarr = soaarr
     c                   eval      sodtl1_binr = sobinr
     c                   eval      sodtl1_numm = sonumm
     c                   eval      sodtl1_suff = sosuff
     c                   eval      w_tbto = w_tbto + sofsum
      *
     c     sodtl1_key    setll     sodtl1
     c     sodtl1_key    reade     sodtl1
      *
      * Iterasjon på fakturalinje
      *
     c                   dow       not %eof(sodtl1)
      *
     c                   if        sdvare <> *blank
     c                   eval      vvarl1_vare = sdvare
     c     vvarl1_key    chain     vvarl1
     c                   exsr      sjk_50rec
     c                   exsr      skriv_vlin
     c                   else
     c                   exsr      skriv_ftxl
     c                   endif
      *
     c     sodtl1_key    reade     sodtl1
      *
     c                   eval      s_numm = sdnumm
     c                   eval      s_binr = sdbinr
     c                   enddo
      *
     c                   exsr      sjk_50rec
     c                   exsr      save_fsum
      *
     c     sohel1_key    reade     sohel1
     c                   if        %eof(sohel1) or
     c                             sobinr <> fnubin
     c                   exsr      skriv_fslut
     c                   endif
      *
     c                   enddo
      *
     c                   endif
      *
     c                   endif
7.03  *
7.03  * Hvis ingen linjer på faktura, kommer du hit.
7.03 c     noline        tag
      *
     c                   select
     c                   when      p_omkj = *blank
     c                   read      fnufl2                                 90
     c                   when      p_omkj = '1'
     c                   read      fnufl1                                 90
     c                   endsl
      *
     c                   enddo
      *
     c     siste         tag
      *
      * Sluttrecord - recordtype 90
      *
     c                   if        w_antl > *zero
     c                   eval      w_flin = *blank
     c                   eval      w_antl = w_antl + 1
      *
      * - Recordtype / ant.linjer / ant.fakturaer
      *
     c                   eval      w_flin = '90' + c_fsep +
     c                                      %char(w_antl) + c_fsep +
     c                                      %char(w_antf) + c_fsep
      *
     c                   exsr      write_outp
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     avslutt       tag
      *
     c                   eval      p_anta = w_antf
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av faktura-hode
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     gen_fakthod   begsr
      *
     c                   if        s_lbin <> 0 and
     c                             s_lbin = sobinr
     c                   leavesr
     c                   endif
      *
     c                   if        s_ltyp = '10'
     c                   leavesr
     c                   endif
5.62  *
5.62 c                   eval      w_bf_n = 0
5.62 c                   eval      w_bf_g = 0
5.62 c                   eval      w_bf_m = 0
5.62 c                   eval      w_bf_b = 0
      *
      * Faktura identifikasjonspost - recordtype 01
      *
     c                   if        b_init = *off
     c                   eval      w_flin = *blank
      *
      * - Recordtype/avsender-id./kvalifikator
      *
     c                   eval      w_flin = '01' + c_fsep +
     c                                      %char(ra8ean) + c_fsep +
     c                                      'EAN' + c_fsep
      *
      * - Mottakers-id eller behandlingstype / kvalifikator
      *
     c                   if        p_faty = 20
     c                   eval      w_flin = %trim(w_flin) +
     c                                      'EFAKTURA' + c_fsep +
     c                                      'XXX' + c_fsep
     c                   endif
      *
     c                   if        p_faty = 21
     c                   eval      w_flin = %trim(w_flin) +
     c                                      'PRINT' + c_fsep +
     c                                      'XXX' + c_fsep
     c                   endif
      *
     c                   if        p_faty = 22
     c                   eval      w_flin = %trim(w_flin) +
5.61 c                                      'EMAILSPLIT' + c_fsep +
     c                                      'XXX' + c_fsep
     c                   endif
      *
     c                   if        p_faty = 23
     c                   eval      w_flin = %trim(w_flin) +
     c                                      'CARDS' + c_fsep +
     c                                      'XXX' + c_fsep
     c                   endif
      *
5.61 c                   if        p_faty = 25
5.61 c                   eval      w_flin = %trim(w_flin) +
5.61 c                                      'EMAIL' + c_fsep +
5.61 c                                      'XXX' + c_fsep
5.61 c                   endif
      *
6.11 c                   if        p_faty = 26
6.11 c                   eval      w_flin = %trim(w_flin) +
6.11 c                                      'EMAILTIFF' + c_fsep +
6.11 c                                      'XXX' + c_fsep
6.11 c                   endif
      *
      * - Meldingstype
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      'LOGINV' + c_fsep
      *
     c                   time                    w_mdat_iso
     c     *iso0         move      w_mdat_iso    w_mdat_alf
     c                   time                    w_mtim
     c                   move      w_mtim        w_mtim_alf
      *
      * - Meldingstidspunkt / versjon / testindikator
      *
     c                   if        fmttes = 1
     c                   eval      w_teid = '1'
     c                   else
     c                   eval      w_teid = *blank
     c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      w_mdat_alf +
     c                                      %subst(w_mtim_alf:1:4) +
     c                                      c_fsep + c_veid + c_fsep +
     c                                      %trim(w_teid) + c_fsep
      *
     c                   exsr      write_outp
     c                   eval      b_init = *on
     c                   endif
      *
     c                   eval      w_mref = *zero
      *
      * Faktura hodepost - recordtype 10
      *
     c                   eval      w_flin = *blank
     c                   eval      w_wlin = *zero
      *
     c                   eval      votyl1_otyp = sootyp
     c     votyl1_key    chain     votyl1r
5.62  *
5.62  * leser kunde for å finne evt. byggm.faktura
5.62 c                   eval      rkunl1_kund = sokund
5.62 c     rkunl1_key    chain     rkunl1
      *
      * - Recordtype / faktura eller kreditnota
      *
     c                   if        vaokre = '-'
     c                   eval      w_flin = '10' + c_fsep + 'K' + c_fsep
     c                   eval      b_kred = *on
     c                   else
     c                   eval      w_flin = '10' + c_fsep + 'F' + c_fsep
     c                   eval      b_kred = *off
     c                   endif
      *
      * - Fakturanummer
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %char(sobinr) + c_fsep
      *
      * - Fakturadato / forfallsdato / leveringsdato
      *
     c                   if        sofkda <> *loval
     c     *iso0         move      sofkda        w_fakd_alf
     c                   else
     c                   eval      w_fakd_alf = *blank
     c                   endif
      *
     c                   if        soffda <> *loval
     c     *iso0         move      soffda        w_ford_alf
     c                   else
     c                   eval      w_ford_alf = *blank
     c                   endif
      *
     c                   if        soldat <> *loval
     c     *iso0         move      soldat        w_levd_alf
     c                   else
     c                   eval      w_levd_alf = *blank
     c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_fakd_alf) + c_fsep +
     c                                      %trim(w_ford_alf) + c_fsep
      *
     c                   if        b_saml = *on
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_levd_alf) + c_fsep
     c                   endif
      *
      * - Valuta
      *
     c                   if        sovalk <> *blank
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(sovalk) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + 'NOK' + c_fsep
     c                   endif
      *
      * - Kjøpers best.nr. (eller rekvisisjonsnr)
      *
     c                   if        sokbnr <> *blank
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sokbnr) + c_fsep
     c                   else
     c                   if        sorekv <> *blank
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sorekv) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
     c                   endif
      *
      * - Selgers ordrenr.
      *
     c                   if        b_saml = *on
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %char(sonumm) + c_fsep
     c                   endif
      *
      * - Pakkseddelnr.
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep
      *
      * - Ref. fakturanr. (kred.)
      *
     c                   if        b_kred = *on and
     c                             sokref <> *zero
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %char(sokref) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
      *
      * - Kundereferansenr.
      *
     c     '|':' '       xlate     sodref        sodref
6.16 c     x'7D':' '     xlate     sodref        sodref
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sodref) + c_fsep
      *
      * - Prosjektnr.
      *   (Prosjekt)
      *
7.01 c                   if        u_701 = *off
      *
     c                   if        sonavn <> *blank
     c     '|':' '       xlate     sonavn        sonavn
6.16 c     x'7D':' '     xlate     sonavn        sonavn
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sonavn) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
7.01  *
7.01 c                   else
7.01 c                   eval      fkprl1_kund = sokund
7.01 c                   eval      fkprl1_kpro = sokpro
7.01 c     fkprl1_key    chain     fkprl1r
7.01 c                   if        %found
7.01 c                   if        flepro <> *blank
7.01 c                   eval      w_flin = %trim(w_flin) +
7.01 c                                      %trim(flepro) + c_fsep
7.01 c                   else
7.01 c                   eval      w_flin = %trim(w_flin) + c_fsep
7.01 c                   endif
7.01 c                   endif
7.01 c                   endif
      *
      * - KID-nr. (ref. eller fullt KID)
      *   Hvis faktura type 21, så kan kort kid brukes, hvis ikke lang...
      *
5.60 c*                  if        p_faty = 21
6.25 c*                  if        w_kidd <> *blank
6.25 c                   if        d_kidk = 1
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_kidd) + c_fsep
     c                   else
     c                   move      w_kidr        w_kidrx
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_kidrx) + c_fsep
     c                   endif
5.60 c*                  else
5.60 c*                  eval      w_flin = %trim(w_flin) +
5.60 c*                                     %trim(w_kidd) + c_fsep
5.60 c*                  endif
      *
      * - Kontraktsnr.
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep
      *
      * - Samlefakturaind.
      *
     c                   if        b_saml = *on
     c                   eval      w_flin = %trim(w_flin) + 'S' + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
      *
      * - Leveringsbet. (tekst/kode/sted)
      *
     c                   if        solbet <> *zero
     c                   eval      ra18l1_rkod = solbet
     c     ra18l1_key    chain     ra18l1r
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(rartx1) + c_fsep +
     c                                      %trim(%subst(rartx1:1:3)) +
     c                                      c_fsep + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) +
     c                                      'Etter avtale' + c_fsep +
     c                                      'EXW' + c_fsep + c_fsep
     c                   endif
      *
      * - Transportmåte/transportør
      *
6.15 c                   if        solmat <> *zero
6.15 c                   eval      ra17l1_qkod = solmat
6.15 c     ra17l1_key    chain     ra17l1r
6.15 c                   eval      w_flin = %trim(w_flin) +
6.15 c                                      %char(raqkod) + c_fsep +
6.15 c                                      %trim(raqtxt) + c_fsep
6.15 c                   else
6.15 c                   eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
6.15 c                   endif
      *
      * - Betalingsbet.tekst / rabatt / straffegebyr
      *
     c                   eval      w_ctxt = *blank
     c                   if        sobetb <> *zero
     c                   eval      w_cbda = *loval
     c                   eval      w_cfda = *loval
     c                   eval      w_ctx1 = *blank
     c                   eval      w_ctx2 = *blank
      *
     c                   call      'FÅ703R'
     c                   parm                    w_firm
     c                   parm                    sobetb
     c                   parm                    w_cbda
     c                   parm                    w_retk
     c                   parm                    w_cfda
     c                   parm                    w_ctx1
     c                   parm                    w_ctx2
      *
     c                   eval      w_ctxt = w_ctx1 + w_ctx2
     c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(%subst(w_ctxt:1:35)) +
     c                                      c_fsep + c_fsep + c_fsep
      *
      * - Fakturakopi
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep
      *
      * - Spesifikasjon
      *
5.62 c                   if        rkfcop = 2 or
5.62 c                             rkfcop = 3
5.62 c                   eval      w_flin = %trim(w_flin) + 'J' + c_fsep
5.62 c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
5.62 c                   endif
      *
      * - Samlekundenr.
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %char(sokund) + c_fsep
      *
      * - Generalnota
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep
      *
     c                   exsr      write_outp
     c                   eval      w_antf = w_antf + 1
      *
     c                   eval      s_lbin = sobinr
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av faktura-hode/partsinfo.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     gen_fakpart   begsr
      *
     c                   if        s_ltyp <> '10' and
     c                             s_ltyp <> '11'
     c                   leavesr
     c                   endif
      *
      * Partsinformasjon - recordtype 20
      *
     c                   eval      w_flin = *blank
      *
      * > Kjøperinfo. (BY)
      *
      * - Recordtype / partskvalifikator
      *
     c                   eval      w_flin = '20' + c_fsep + 'BY' + c_fsep
      *
     c                   eval      rkunl1_kund = sokund
     c     rkunl1_key    chain     rkunl1
      *
      * Partsinformasjon består for alle parter av :
      * - EAN-nr./foretaksnr/kundenr.
      * - Navn/adresse 1+2/postnr./poststed/landkode
      * - Kont.pers./bankkto.nr./e-mail
      * - Tlf.nr./faxnr./bet.kortnr./utløpsdato
      *
6.12 c                   if        rkgate = *blank and
6.12 c                             rkadr2 = *blank
6.12 c                   eval      rkgate = '-'
6.12 c                   endif
      *
     c                   eval      w_ftex = *blank
     c                   if        rkftnr <> *zero
     c                   move      rkftnr        w_ftnr
     c                   eval      w_ftex = 'NO' + w_ftnr + 'MVA'
     c                   endif
      *
6.16 c     x'7D':' '     xlate     rknavn        rknavn
6.16 c     x'7D':' '     xlate     rkgate        rkgate
6.16 c     x'7D':' '     xlate     rkadr2        rkadr2
      *
6.18 c                   move      sokund        w_kunx
     c                   eval      w_flin = %trim(w_flin) +
     c                             %char(rkeank) + c_fsep +
     c                             %trim(w_ftex) + c_fsep +
     c                                             c_fsep +
6.18 c                             %trim(w_kunx) + c_fsep +
     c                             %trim(rknavn) + c_fsep +
     c                             %trim(rkgate) + c_fsep +
     c                             %trim(rkadr2) + c_fsep
      *
5.68 c                   eval      w_faku = rkfaku
      *
     c                   if        rkponr <> *zero
     c                   move      rkponr        w_ponr_alf
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(w_ponr_alf) + c_fsep
     c*                            %char(rkponr) + c_fsep
     c                   else
     c                   if        rkupnr = *blank
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(%subst(rksted:1:4)) + c_fsep
     c                   else
      * utenl.postnr.
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(rkupnr) + c_fsep
     c                   endif
     c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(%subst(rksted:5)) + c_fsep
      *
     c                   if        rkland <> *blank
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(rkland) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
      *
5.63 c                   eval      w_mail = *blank
5.63  * prøver først å finne mail på kontaktperson - rolle EMAIL
5.63 c                   eval      w_krol = 'EMAIL1'
5.63 c                   call      'RS752R  '
5.63 c                   parm                    w_firm
5.63 c                   parm                    sokund
5.63 c                   parm                    w_krol
5.66 c                   parm                    w_maip
5.66 c                   movel     w_maip        w_mail
5.63 c                   if        w_mail = *blank
5.63 c                   movel     rkemal        w_mail
5.66 c                   else
5.66  * prøver å finne mailadresse 2
5.66 c                   eval      w_krol = 'EMAIL2'
5.66 c                   call      'RS752R  '
5.66 c                   parm                    w_firm
5.66 c                   parm                    sokund
5.66 c                   parm                    w_krol
5.66 c                   parm                    w_maip
5.66 c                   if        w_maip <> *blank
5.66 c                   eval      w_mail = %trim(w_mail) +',' +
5.66 c                                      %trim(w_maip)
5.66 c                   endif
5.66 c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(sodref) + c_fsep +
5.60 c                             %char(rkbgir) + c_fsep +
5.63 c                             %trim(w_mail) + c_fsep +
     c                             %trim(rktlfn) + c_fsep +
     c                             %trim(rktlfx) + c_fsep +
6.10 c                                             c_fsep +
6.34 c                                             c_fsep +
6.34 c                             %trim(aaweba) + c_fsep +
6.34 c                                             c_fsep +
6.34 c                             %trim(aaiban) + c_fsep +
6.34 c                             %trim(aaswif) + c_fsep +
6.34 c                                             c_fsep
      *
     c                   exsr      write_outp
     c                   eval      w_flin = *blank
      *
      * > Selger (SU)
      *
      * - Recordtype / partskvalifikator
      *
     c                   eval      w_flin = '20' + c_fsep + 'SU' + c_fsep
      *
     c                   eval      w_ftex = *blank
     c                   if        aafftn <> *zero
     c                   move      aafftn        w_ftnr
     c                   eval      w_ftex = 'NO' + w_ftnr + 'MVA'
     c                   endif
8.01  *
8.01  *  Switchstyrt - sjekker om bankkonto skal overstyres
8.01  *
8.01       if u_801 = *on;
8.05         exsr sjk_fact;
8.05         if b_fact = *off;
8.01          exec sql
8.01            select rkfbkk into :w_fbkk
8.01              from ra34st
8.01               where rkffir = :w_firm;
8.01          aafbgi = w_fbkk;
8.05        endif;
8.01       endif;
8.01  *
      *
8.02 c                   eval      w_ftlf = aaftlf
8.02 c                   eval      w_ffax  =  aaffax
8.02 c                   eval      w_fmai  =  aamail
8.02 c                   eval      w_fad1  =  aafad1
8.02 c                   eval      w_fad2  =  aafad2
8.02 c                   eval      w_fste  =  aafste
      *
8.02 c                   if        u_avde = *on
8.02 c                   eval      ra07l1_gkod = soavde
8.02 c     ra07l1_key    chain     ra07l1
8.02 c                   if        %found(ra07l1)
8.02 c                   eval      w_ftlf  =  ragtlf
8.02 c                   eval      w_ffax  =  ragfax
8.02 c                   eval      w_fad1  =  %trim(ragtxt)
8.02 c                   eval      w_fad2  =  %trim(ragadr)
8.02 c                   eval      w_fste  =  %char(ragpnr) + %trim(ragste)
8.02 c                   eval      w_fmai  =  %trim(ragmai)
8.02 c                   endif
8.02 c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                             %char(ra8ean) + c_fsep +
     c                             %trim(w_ftex) + c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                             %trim(aafnav) + c_fsep +
8.02 c**                           %trim(aafad1) + c_fsep +
8.02 c                             %trim(w_fad1) + c_fsep +
8.02 c**                           %trim(aafad2) + c_fsep
8.02 c                             %trim(w_fad2) + c_fsep
      *
     c                   eval      w_flin = %trim(w_flin) +
8.02 c                             %trim(%subst(w_fste:1:4)) + c_fsep +
8.02 c                             %trim(%subst(w_fste:5)) + c_fsep
8.02 c**                           %trim(%subst(aafste:1:4)) + c_fsep +
8.02 c**                           %trim(%subst(aafste:5)) + c_fsep
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep
7.02  *
7.02 c                   if        w_sbgi <> *zero
7.02 c                   eval      w_fbgi = w_sbgi
7.02 c                   else
7.02 c                   eval      w_fbgi = aafbgi
7.02 c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                             %trim(sovref) + c_fsep +
7.02 c*                            %char(aafbgi) + c_fsep +
7.02 c                             %char(w_fbgi) + c_fsep +
8.02 c                             %trim(w_fmai) + c_fsep +
8.02 c                             %trim(w_ftlf) + c_fsep +
8.02 c                             %trim(w_ffax) + c_fsep +
8.02 c**                           %trim(aamail) + c_fsep +
8.02 c**                           %trim(aaftlf) + c_fsep +
8.02 c**                           %trim(aaffax) + c_fsep +
     c                                             c_fsep + c_fsep + c_fsep
      *
     c                   exsr      write_outp
5.68  *
5.68  * > Fakturamottager (IV)
5.68  *
5.68  * - Recordtype / partskvalifikator
5.68  *
5.68 c                   if        p_faty = 20
5.68  *
5.68 c                   eval      w_flin = *blank
5.68  *
5.69 c                   if        w_faku <> 0
5.68 c                   eval      rkunl1_kund = w_faku
5.68 c     rkunl1_key    chain     rkunl1
5.69 c                   endif
5.68  *
5.68 c                   eval      w_flin = '20' + c_fsep + 'IV' + c_fsep
5.68  *
5.68 c                   eval      w_flin = %trim(w_flin) +
5.68 c                             %char(rkeanf) + c_fsep
5.68  *
5.68 c                   eval      w_ftex = *blank
5.68 c                   if        rkftnr <> *zero
5.68 c                   move      rkftnr        w_ftnr
5.68 c                   eval      w_ftex = 'NO' + w_ftnr + 'MVA'
5.68 c                   endif
5.68  *
5.68 c                   eval      w_flin = %trim(w_flin) +
5.68 c                             %trim(w_ftex) + c_fsep +
5.68 c                                             c_fsep +
5.68 c                             %char(rkkund) + c_fsep +
5.68 c                             %trim(rknavn) + c_fsep +
5.68 c                             %trim(rkgate) + c_fsep +
5.68 c                             %trim(rkadr2) + c_fsep
5.68  *
5.68 c                   if        rkponr <> *zero
6.19 c                   move      rkponr        w_ponr_alf
6.19 c                   eval      w_flin = %trim(w_flin) +
6.19 c                             %trim(w_ponr_alf) + c_fsep
5.68 c                   else
5.68 c                   eval      w_flin = %trim(w_flin) +
5.68 c                             %trim(%subst(rksted:1:4)) + c_fsep
5.68 c                   endif
5.68  *
5.68 c                   eval      w_flin = %trim(w_flin) +
5.68 c                             %trim(%subst(rksted:5)) + c_fsep
5.68  *
5.68 c                   if        rkland <> *blank
5.68 c                   eval      w_flin = %trim(w_flin) +
5.68 c                             %trim(rkland) + c_fsep
5.68 c                   else
5.68 c                   eval      w_flin = %trim(w_flin) + c_fsep
5.68 c                   endif
5.68  *
5.68 c                   eval      w_flin = %trim(w_flin) + c_fsep +
8.03 c**                           %char(rkbgir) + c_fsep + c_fsep +
8.03 c                             %char(rkbgir) + c_fsep +
5.68 c                             %trim(rkemal) + c_fsep +
5.68 c                             %trim(rktlfn) + c_fsep +
5.68 c                             %trim(rktlfx) + c_fsep +
5.68 c                                             c_fsep + c_fsep
5.68  *
5.68 c                   exsr      write_outp
5.68  *
5.69 c                   if        w_faku <> 0
5.69  * henter riktig kundeinfo igjen
5.68 c                   eval      rkunl1_kund = w_kund
5.68 c     rkunl1_key    chain     rkunl1
5.69 c                   endif
5.68  *
5.68 c                   endif
      *
      * > Leveringssted (DP)
      *
     c                   if        sonavn <> *blank
     c*                            sosted <> *blank
     c                   eval      w_flin = *blank
      *
      * - Recordtype / partskvalifikator
      *
     c                   eval      w_flin = '20' + c_fsep + 'DP' + c_fsep
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                             c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                             %trim(sonavn) + c_fsep +
     c                             %trim(soadr1) + c_fsep +
     c                             %trim(soadr2) + c_fsep +
     c                                             c_fsep +
     c                             %trim(sosted) + c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                                             c_fsep +
     c                                             c_fsep + c_fsep + c_fsep
      *
     c                   exsr      write_outp
     c                   endif
5.67  *
5.67  * - Depositum (Fradrag)
5.67  *
5.67 c                   if        sodept <> 0
5.67 c                   eval      w_flin = '30' + c_fsep + '-' + c_fsep
5.67  *
5.67 c                   eval      w_flin = %trim(w_flin) +
5.67 c                             'OTE'         + c_fsep
5.67  *
5.67 c                   eval      w_ntpf = %editc(sodept : 'M')
5.67 c                   eval      w_numf = w_ntpf
5.67 c                   exsr      sjekk_minus
5.67 c                   eval      w_flin = %trim(w_flin) +
5.67 c                                      %trim(w_numf) + c_fsep
5.67  *
5.67 c                   eval      w_besk = 'Fradrag depositum'
5.67 c                   eval      w_flin = %trim(w_flin) +
5.67 c                                             c_fsep +
6.31 c                                             c_fsep +
5.67 c                                             c_fsep +
5.67 c                                             c_fsep +
5.67 c                             %trim(w_besk) + c_fsep
5.67  *
5.67 c                   exsr      write_outp
5.67 c                   endif
      *
      * Oppdater rapportfelter
      *
     c                   eval      a1binr = sobinr
     c                   eval      a1numm = sonumm
     c                   move      sosuff        a1suff
     c                   eval      a1otyp = sootyp
     c     *dmy          move      sofkda        a1fkda
     c     *dmy          move      soffda        a1ffda
     c                   eval      a1kund = sokund
     c                   eval      a1navn = rknavn
     c                   eval      a2navn = sonavn
      *
     c                   if        p_rapp = '1'
     c                   if        b_uskr = *off
     c                   exsr      skr_rapph
     c                   endif
     c                   endif
6.1b  *
6.1b  * sjekker om det bruksrabatt
6.1b  *
6.1b  *
6.1b c                   if        w_rb1p <> 0 or
6.1b c                             w_rb1h <> 0 or
6.1b c                             w_rb1f <> 0 or
6.1b c                             w_rb2p <> 0 or
6.1b c                             w_rb2h <> 0 or
6.1b c                             w_rb2f <> 0
6.1b c                   exsr      gen_bruksrett
6.1b c                   endif
6.1b  *
6.1b  *
6.1b c                   endsr
6.1b  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.1b  * Subrutine for generering av bruksrettlinjer på 30
6.1b  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.1b  *
6.1b c     gen_bruksrett begsr
6.1b  *
6.1b  *
6.1b  * Bruksrettrabatt 1 Pliktig
6.1b  *
6.1b c                   if        w_rb1p <> 0
6.1b  *
6.1b c                   eval      w_flin = *blank
6.1b c                   eval      w_wlin = *zero
6.1b  *
6.1b c                   eval      w_flin = '30' + c_fsep +
6.1b c                                      '-'  + c_fsep + c_fsep
6.1b  *
6.1b c                   eval      w_rb1p = w_rb1p * -1
6.1b c                   eval      w_numf = %editc(w_rb1p : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   eval      w_numf = %editc(w_gr1p : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                      'Bruksrettrabatt 1 (Grunnl/Rab) ' +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   exsr      write_outp
6.23 c***                eval      w_antf = w_antf + 1
6.1b  * tilbake til opprinnelig fortegn
6.1b c                   eval      w_rb1p = w_rb1p * -1
6.1b c                   endif
6.1b  *
6.1b  * Bruksrettrabatt 1 1/2 mva
6.1b c                   if        w_rb1h <> 0
6.1b c                   eval      w_flin = *blank
6.1b c                   eval      w_wlin = *zero
6.1b  *
6.1b c                   eval      w_flin = '30' + c_fsep +
6.1b c                                      '-'  + c_fsep + c_fsep
6.1b  *
6.1b c                   eval      w_rb1h = w_rb1h * -1
6.1b c                   eval      w_numf = %editc(w_rb1h : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   eval      w_numf = %editc(w_gr1h : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                      'Bruksrettrabatt 1 (Grunnl/Rab) ' +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   exsr      write_outp
6.23 c***                eval      w_antf = w_antf + 1
6.1b  * tilbake til opprinnelig fortegn
6.1b c                   eval      w_rb1h = w_rb1h * -1
6.1b c                   endif
6.1b  *
6.1b  * Bruksrettrabatt 1 fritt
6.1b  *
6.1b c                   if        w_rb1f <> 0
6.1b c                   eval      w_flin = *blank
6.1b c                   eval      w_wlin = *zero
6.1b  *
6.1b c                   eval      w_flin = '30' + c_fsep +
6.1b c                                      '-'  + c_fsep + c_fsep
6.1b  *
6.1b c                   eval      w_rb1f = w_rb1f * -1
6.1b c                   eval      w_numf = %editc(w_rb1f : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   eval      w_numf = %editc(w_gr1f : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                      'Bruksrettrabatt 1 (Grunnl/Rab) ' +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   exsr      write_outp
6.23 c***                eval      w_antf = w_antf + 1
6.1b  * tilbake til opprinnelig fortegn
6.1b c                   eval      w_rb1f = w_rb1f * -1
6.1b c                   endif
6.1b  *
6.1b  * Bruksrettrabatt 2 Pliktig
6.1b  *
6.1b c                   if        w_rb2p <> 0
6.1b  *
6.1b c                   eval      w_flin = *blank
6.1b c                   eval      w_wlin = *zero
6.1b  *
6.1b c                   eval      w_flin = '30' + c_fsep +
6.1b c                                      '-'  + c_fsep + c_fsep
6.1b  *
6.1b c                   eval      w_rb2p = w_rb2p * -1
6.1b c                   eval      w_numf = %editc(w_rb2p : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   eval      w_numf = %editc(w_gr2p : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.30 c                                      'Bruksrettrabatt 2 (Grunnl/Rab) ' +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   exsr      write_outp
6.23 c***                eval      w_antf = w_antf + 1
6.1b  * tilbake til opprinnelig fortegn
6.1b c                   eval      w_rb2p = w_rb2p * -1
6.1b c                   endif
6.1b  *
6.1b  * Bruksrettrabatt 1 1/2 mva
6.1b c                   if        w_rb2h <> 0
6.1b c                   eval      w_flin = *blank
6.1b c                   eval      w_wlin = *zero
6.1b c                   eval      w_flin = '30' + c_fsep +
6.1b c                                      '-'  + c_fsep + c_fsep
6.1b  *
6.1b c                   eval      w_rb2h = w_rb2h * -1
6.1b c                   eval      w_numf = %editc(w_rb2h : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   eval      w_numf = %editc(w_gr2h : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.30 c                                      'Bruksrettrabatt 2 (Grunnl/Rab) ' +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b  *
6.1b c                   exsr      write_outp
6.23 c***                eval      w_antf = w_antf + 1
6.1b  * tilbake til opprinnelig fortegn
6.1b c                   eval      w_rb2h = w_rb2h * -1
6.1b c                   endif
6.1b  *
6.1b  * Bruksrettrabatt 2 fritt
6.1b  *
6.1b c                   if        w_rb2f <> 0
6.1b c                   eval      w_flin = *blank
6.1b c                   eval      w_wlin = *zero
6.1b  *
6.1b c                   eval      w_flin = '30' + c_fsep +
6.1b c                                      '-'  + c_fsep + c_fsep
6.1b  *
6.1b c                   eval      w_rb2f = w_rb2f * -1
     c                   eval      w_numf = %editc(w_rb2f : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b c                   eval      w_numf = %editc(w_gr2f : 'M')
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.1b c                                                      c_fsep +
6.30 c                                      'Bruksrettrabatt 2 (Grunnl/Rab) ' +
6.1b c                                      %trim(w_numf) + c_fsep
6.1b  *
6.1b  *
6.1b c                   exsr      write_outp
6.23 c***                eval      w_antf = w_antf + 1
6.1b  * tilbake til opprinnelig fortegn
6.1b c                   eval      w_rb2f = w_rb2f * -1
6.1b c                   endif
6.1b  *
6.1b c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av ordrehodelinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skriv_olin    begsr
      *
     c*                  if        b_saml = *off
     c*                  leavesr
     c*                  endif
      *
     c                   if        s_lnum = sonumm
     c                   if        s_lsuf = sosuff
     c                   leavesr
     c                   endif
     c                   endif
      *
6.10 c*                  if        sdvare = *blank and
6.10 c*                            sdltyp = *blank
6.10 c*                  leavesr
     c*                  endif
      *
      * Ordre hodepost (samlefaktura/flere ordre) - recordtype 35
      *
     c                   eval      w_flin = *blank
      *
     c                   eval      w_flin = '35' + c_fsep +
     c                             %char(sonumm) + c_fsep
      *
      * - Ordredato
      *
     c                   if        sobdat <> *loval
     c     *iso0         move      sobdat        w_odat_alf
     c                   else
     c                   eval      w_odat_alf = *blank
     c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_odat_alf) + c_fsep
      *
      * - Levering
      *
6.1a c                   if        solmat <> *zero
6.1a c                   eval      ra17l1_qkod = solmat
6.1a c     ra17l1_key    chain     ra17l1r
6.1a c                   eval      w_flin = %trim(w_flin) +
6.1a c                                      %trim(raqtxt) + c_fsep
6.1a c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
6.1a c                   endif
      *
      * - Deres ref
      *
6.x  c     X'32':'Æ'     xlate     sodref        sodref
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sodref) + c_fsep
      *
      * - Vår ref
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sovref) + c_fsep
      *
      * - Leveringsdato
      *
     c                   if        soldat <> *loval
     c     *iso0         move      soldat        w_levd_alf
     c                   else
     c                   eval      w_levd_alf = *blank
     c                   endif
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_levd_alf) + c_fsep
      *
      * - Utsalgssted
      *
     c                   if        soavde = *zero
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   else
     c                   eval      ra07l1_gkod = soavde
     c     ra07l1_key    chain     ra07l1
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(ragtxt) + c_fsep
     c                   endif
      *
      * - Leveringsadr.1/2/3
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sonavn) + c_fsep
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(soadr1) + c_fsep
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sosted) + c_fsep
      *
      * - Kjøpers best.nr. (eller rekvisisjonsnr)
      *
     c                   if        sokbnr <> *blank
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sokbnr) + c_fsep
     c                   else
     c                   if        sorekv <> *blank
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sorekv) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
     c                   endif
6.21  *
6.21  * - Selger og Lager (kodene)
6.21  *
6.21 c                   if        soselg <> 0
6.21 c                   eval      w_flin = %trim(w_flin) +
6.21 c                                      %char(soselg) + c_fsep
6.21 c                   else
6.21 c                   eval      w_flin = %trim(w_flin) + c_fsep
6.21 c                   endif
6.21  *
6.21 c                   if        solage <> 0
6.21 c                   eval      w_flin = %trim(w_flin) +
6.21 c                                      %char(solage) + c_fsep
6.21 c                   else
6.21 c                   eval      w_flin = %trim(w_flin) + c_fsep
6.21 c                   endif
6.21  * Hent over eksternt prosjektnr
6.21  * dersom dette finnes
6.21  *
6.21 c                   eval      fkprl1_kund = sokund
6.21 c                   eval      fkprl1_kpro = sokpro
6.21 c     fkprl1_key    chain     fkprl1r
6.21 c                   if        %found
6.21 c                   if        flepro <> *blank
6.21 c                   eval      w_flin = %trim(w_flin) +
6.21 c                                      %trim(flepro) + c_fsep
6.21 c                   else
6.21 c                   eval      w_flin = %trim(w_flin) + c_fsep
6.21 c                   endif
6.21 c                   endif
6.21  *
6.21  * -kundeprosjekt
6.21  *
6.21 c                   if        sokpro <> 0
6.21 c                   eval      w_flin = %trim(w_flin) +
6.21 c                                      %char(sokpro) + c_fsep
6.21 c                   else
6.21 c                   eval      w_flin = %trim(w_flin) + c_fsep
6.21 c                   endif
      *
     c                   exsr      write_outp
     c                   eval      s_lnum = sonumm
     c                   eval      s_lsuf = sosuff
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av fakturalinje
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skriv_vlin    begsr
      *
      * Varelinjeinfo. - recordtype 40
      *
     c                   eval      w_flin = *blank
      *
      * - Recordtype / linjenummer
      *
     c*                  eval      w_wlin = (sdktxt * 10000) + sdline
     c                   eval      w_wlin = w_wlin + 1
     c                   eval      w_flin = '40' + c_fsep +
     c*                                     %char(sdline) + c_fsep
     c                                      %char(w_wlin) + c_fsep
      *
      * - Hvis ikke vare funnet eller skaffevare (sdlvre = 1)-sjekk jvarpf
      *
     c                   eval      w_vare = sdvare
     c                   eval      w_nobb = 0
      *
     c                   if        %found(vvarl1)
     c                   eval      w_vare = vvvare
     c                   eval      w_nobb = vvnobb
     c                   else
     c                   eval      jvarl1_vare = sdvare
     c     jvarl1_key    chain     jvarl1
     c                   if        %found(jvarl1)
     c                   eval      w_vare  = jvvare
     c                   eval      w_nobb  = jvnobb
     c                   endif
     c                   endif
6.35 c                   exsr      sjekk_logi
6.35 c                   if        w_lv_vare <> *blank
6.35 c                   eval      w_nobb = 0
6.35 c                   endif
      *
      * - EAN-nummer
      *
     c                   eval      veanl2_vare = w_vare
     c     veanl2_key    chain     veanl2
     c                   if        %found(veanl2)
      * sjekker om ean er 13 langt
     c                   move      vxeann        w_eanx
     c                   eval      w_leng = %len(%trim(w_eanx))
      *
     c                   if        vxeann <> *zero and
     c                             w_leng = 13
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %char(vxeann) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
      *
      * - NOBB-nr.
     c                   if        w_nobb <> 0
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %char(w_nobb) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
      *
      * - Leverandørs varenr (eget)
      *
     c                   if        w_nobb = 0
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_vare) + c_fsep +
     c                                      'SA' + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
     c                   endif
      *
      * - Varebetegnelse
      *
6.13 c     '|':' '       xlate     sdtek1        sdtek1
6.16 c     x'7D':' '     xlate     sdtek1        sdtek1
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sdtek1) + c_fsep
      *
      * - Fakturert kvantum / enhet
      *
     c                   eval(h)   w_antx = sdanta
     c                   eval      w_anta = %editc(w_antx : 'M')
     c                   eval      w_numf = w_anta
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep +
     c                                      %trim(sdenh1) + c_fsep
      *
      * - Levert kvantum / enhet
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep +
     c                                                      c_fsep
      *
      * - Netto varelinjebeløp
      *
     c                   eval      w_npri = sdsalg -
     c                                      sdrkr1 - sdrkr2 - sdrkro
     c                   eval      s_fnet = s_fnet + w_npri
      *
     c                   if        w_npri <> *zero
     c                   eval      w_ntpe = %editc(w_npri : 'M')
     c                   eval      w_numf = w_ntpe
     c                   else
     c                   eval      w_numf = '0'
     c                   endif
      *
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Brutto varelinjebeløp
      *
6.22 c                   if        soneto = 1
6.22 c                   eval      sdsalg = sdsalg -
6.22 c                                      sdrkr1 - sdrkr2 - sdrkro
6.22 c                   endif
5.62 c                   eval      w_bf_n = w_bf_n + sdsalg
      *
     c                   eval      w_ntpf = %editc(sdsalg : 'M')
     c                   eval      w_numf = w_ntpf
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Netto enhetspris
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep
      *
      * - Brutto enhetspris
      *
     c*                  eval      w_enhp = sdsapr
     c*                  if        sdanta <> *zero
     c*                  eval      w_enhp = sdsalg / sdanta
     c*                  else
     c*                  eval      w_enhp = *zero
     c*                  endif
      *
6.22  * hvis nettopris skal rabatt trekkes ut
6.22  *
6.22 c                   if        soneto = 1
6.22  * Beregne snittrabatt
6.22  *
6.22 c                   eval      w1rab1 = 100 - sdrab1
6.22 c                   eval      w1rab1 = w1rab1 * sdrab2
6.22 c                   eval      w1rab1 = w1rab1 / 100
6.22 c                   eval      w1rab1 = w1rab1 + sdrab1
6.36 c                   eval(h)   sdsapr = sdsapr -
6.22 c                                     (sdsapr * w1rab1 / 100)
6.22 c                   endif
      *
     c                   eval      w_enhx = %editc(sdsapr : 'M')
     c                   eval      w_numf = w_enhx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Prisenhet / enhetsmengde
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sdenh1) + c_fsep + c_fsep
      *
      * Kaller program i økonomisystemet / MVA-oppslag
      *
6.32 c                   if        somkod = 1 OR
6.32 c                             somkod = 2
6.11 c                   eval      p_ekod = '4'
6.33 c                   elseif    sdomva <> *blanks
6.33 c                   eval      p_ekod = sdomva
6.33 c                   else
     c                   select
     c                   when      sdkmva = 1
     c                   eval      p_ekod = '4'
     c                   when      sdkmva = 2
     c                   eval      p_ekod = 'H'
     c                   other
     c                   eval      p_ekod = '3'
     c                   endsl
6.11 c                   endif
      *
     c                   eval      p_dato = sofkda
      *
     c                   call      'RS755R'
     c                   parm                    p_stat
     c                   parm                    p_ekod
     c                   parm                    p_etxt
     c                   parm                    p_dato
     c                   parm                    p_mvap
     c                   parm                    p_mvat
     c                   parm                    p_mvaf
      *
      * - MVA-prosent
      *
     c                   if        p_mvap <> *zero
     c                   eval      w_mvap = %editc(p_mvap : 'M')
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_mvap) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) +
     c                                      '0' + c_fsep
     c                   endif
      *
     c                   eval      s_fmva = s_fmva +
     c                                      ((w_npri * p_mvap) / 100)
      *
     c                   if        p_mvap <> *zero
     c                   eval      s_fmvg = s_fmvg + w_npri
5.62 c                   eval      w_bf_g = w_bf_g + sdsalg
     c                   endif
      *
     c                   if        p_ekod = '3'
     c                   eval      s_mvp1 = p_mvap
     c                   eval      s_mvg1 = s_mvg1 + w_npri
     c                   eval      s_mvb1 = s_mvb1 +
     c                                      ((w_npri * p_mvap) / 100)
5.62 c                   eval      w_bf_m = w_bf_m +
5.62 c                                      ((sdsalg * p_mvap) / 100)
     c                   endif
     c                   if        p_ekod = 'H'
     c                   eval      s_mvp2 = p_mvap
     c                   eval      s_mvg2 = s_mvg2 + w_npri
     c                   eval      s_mvb2 = s_mvb2 +
     c                                      ((w_npri * p_mvap) / 100)
5.62 c                   eval      w_bf_m = w_bf_m +
5.62 c                                      ((sdsalg * p_mvap) / 100)
     c                   endif
     c                   if        p_ekod = '4'
     c                   eval      s_mvp3 = p_mvap
     c                   eval      s_mvg3 = s_mvg3 + w_npri
5.62 c                   eval      w_bf_m = w_bf_m + sdsalg
     c                   endif
      *
      * - Div. felter (ikke obl. p.t.)
      *   > Kjøpers best.nr/linjenr i best.
      *   > Selgers ordrenr/linjenr i ordre
      *   > Pakkseddelnr./linjenr i ordre
      *   > Fakturanr./linjenr på fakt.
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
     c                   eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
     c                   eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
     c                   eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
      *
      * - Varebeskrivelse 2+3
      *
     c                   if        sdtek2 <> *blank
6.13 c     '|':' '       xlate     sdtek2        sdtek2
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(sdtek2) + c_fsep
     c                   else
     c*                  eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
6.1b  *
6.1b  * - Varebeskrivelse 3 brukes til Bruksrett rab %
6.1b  *
6.1b c                   if        sdbrr1 <> 0 or
6.1b c                             sdbrr2 <> 0
6.1b c                   if        sdbrr1 <> 0
6.1b c                   eval      w_rkrx = %editc(sdbrr1 : 'M')
6.1b c                   eval      w_numf = w_rkrx
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_tek1 = %trim(w_numf)
6.1b c                   endif
6.1b c                   if        sdbrr2 <> 0
6.1b c                   eval      w_rkrx = %editc(sdbrr2 : 'M')
6.1b c                   eval      w_numf = w_rkrx
6.1b c                   exsr      sjekk_minus
6.1b c                   eval      w_tek1 = %trim(w_tek1) + ';' +
6.1b c                                      %trim(w_numf)
6.1b c                   endif
6.1b c                   eval      w_flin = %trim(w_flin) +
6.1b c                                      %trim(w_tek1) + c_fsep
6.1b c                   else
6.1b c                   eval      w_flin = %trim(w_flin) + c_fsep
6.1b c                   endif
      *
      * - Enhets listepris + Listepris linje
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep + c_fsep
      *
     c                   exsr      write_outp
     c                   eval      b_skfl = *on
      *
      * Hvis tilbud/nettopris - legges det ut en linje 41 med teksten på denne
     c                   if        sdrab1 = *zero
     c                   eval      w_tek1 = *blank
     c                   eval      vpkol1_pkod = sdkpri
     c     vpkol1_key    chain     vpkol1r                            69
     c                   if        *in69 = *off
     c                   eval      w_tek1 = '.                   ' +
     c                                      '                    ' +
     c                                      '          ' +
     c                                      vaptxt +
     c                                      '               '
     c                   eval      w_flin = '41' + c_fsep +
     c                                      %trim(w_tek1) + c_fsep
     c                   exsr      write_outp
     c                   endif
     c                   endif
      *
      *
      *
      * Rabatt/linjeinfo. - recordtype 50
      *
     c                   if        sdrkr1 = *zero and
     c                             sdrkr2 = *zero and
     c                             sdrkro = *zero
     c                   leavesr
     c                   endif
6.22  *
6.22  * hvis nettopris skal ikke rabatt skrives ut.
6.22  *
6.22 c                   if        soneto = 1
6.22 c                   leavesr
6.22 c                   endif
      *
      * Tar vare på rabatt-linjer inntil evt. tekstlinjer på 41 er skrevet
     c                   eval      w_flinx1 = *blank
     c                   eval      w_flinx2 = *blank
     c                   eval      w_flinx3 = *blank
     c
      *
      * Rabatt #1
      *
     c                   if        sdrkr1 <> *zero
     c                   eval      w_flin = *blank
6.1c  *
6.1c  * sjekker om sdrkr1 er negativ - i så fall et påslag
6.1c  * gjelder faktura
6.1c c                   if        sdrkr1 < 0   and
6.1d c                             sdanta > 0   and
6.1c c                             b_kred = *off
6.1c c                   eval      w_flin = '50' + c_fsep + '+' + c_fsep +
6.1c c                                      'PAR' + c_fsep
6.1c c                   eval      sdrkr1 = sdrkr1 * -1
6.1c c                   if        sdrab1 < 0
6.1c c                   eval      sdrab1 = sdrab1 * -1
6.1c c                   endif
6.1c c                   else
      *
      * - Recordtype, fradrag, rabattkode
      *
     c                   eval      w_flin = '50' + c_fsep + '-' + c_fsep +
     c                                      'PAR' + c_fsep
      *
6.1c c                   endif
      *
      * - Rabattbeløp
      *
     c                   eval      w_rkrx = %editc(sdrkr1 : 'M')
     c                   eval      w_numf = w_rkrx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Rabattprosent
      *
     c                   eval      w_rabx = %editc(sdrab1 : 'M')
     c                   eval      w_numf = w_rabx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
     c                   eval      w_flinx1 = w_flin
     c*                  exsr      write_outp
      *
     c                   eval      s_frab = s_frab + sdrkr1
     c                   endif
      *
      * Rabatt #2
      *
     c                   if        sdrkr2 <> *zero
     c                   eval      w_flin = *blank
6.1c  *
6.1c  * sjekker om sdrkr1 er negativ - i så fall et påslag
6.1c  * gjelder faktura
6.1c c                   if        sdrkr2 < 0 and
6.1c c                             b_kred = *off
6.1c c                   eval      w_flin = '50' + c_fsep + '+' + c_fsep +
6.1c c                                      'PAR' + c_fsep
6.1c c                   eval      sdrkr2 = sdrkr2 * -1
6.1c c                   if        sdrab2 < 0
6.1c c                   eval      sdrab2 = sdrab2 * -1
6.1c c                   endif
6.1c c                   else
      *
      * - Recordtype, fradrag, rabattkode
      *
     c                   eval      w_flin = '50' + c_fsep + '-' + c_fsep +
     c                                      'PAR' + c_fsep
      *
6.1c c                   endif
      *
      * - Rabattbeløp
      *
     c                   eval      w_rkrx = %editc(sdrkr2 : 'M')
     c                   eval      w_numf = w_rkrx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Rabattprosent
      *
     c                   eval      w_rabx = %editc(sdrab2 : 'M')
     c                   eval      w_numf = w_rabx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
     c                   eval      w_flinx2 = w_flin
     c*                  exsr      write_outp
      *
     c                   eval      s_frab = s_frab + sdrkr2
     c                   endif
      *
      * Rabatt #3 (ordre)
      *
     c                   if        sdrkro <> *zero
     c                   eval      w_flin = *blank
      *
      * - Recordtype, fradrag, rabattkode
      *
     c                   eval      w_flin = '50' + c_fsep + '-' + c_fsep +
     c                                      'PAR' + c_fsep
      *
      * - Rabattbeløp
      *
     c                   eval      w_rkrx = %editc(sdrkro : 'M')
     c                   eval      w_numf = w_rkrx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Rabattprosent
      *
     c                   eval      w_rabg = sdsalg - sdrkr1 - sdrkr2
     c                   eval(h)   w_rabp = (sdrkro / w_rabg) * 100
     c                   eval      w_rabx = %editc(w_rabp : 'M')
     c                   eval      w_numf = w_rabx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
     c                   eval      w_flinx3 = w_flin
     c*                  exsr      write_outp
      *
     c                   eval      s_frab = s_frab + sdrkro
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for generering av fakturalinje/fritekst
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skriv_ftxl    begsr
      *
      * Varelinje/fritekst - recordtype 41 eller fritekst/hodelinje - rec.11
      *
     c                   eval      w_flin = *blank
      *
      * Spes. Per Strand
     c                   if        sdktxt = 1 or
     c                             sdktxt = 5
     c                   leavesr
     c                   endif
5.65  *
5.65  * Hent linje-type
5.65  *
5.65 c                   eval      vltyl1_ltyp = sdltyp
5.65 c     vltyl1_key    chain     vltyl1r                            68
5.65 c                   if        sdotyp = valo01 or
5.65 c                             sdotyp = valo02 or
5.65 c                             sdotyp = valo03 or
5.65 c                             sdotyp = valo04
5.65 c                   leavesr
5.65 c                   endif
      *
      * - Recordtype / fritekst
      *
     c                   if        sdtek1 = *blank
     c                   if        sdtek2 = *blank
     c                   leavesr
     c                   endif
     c                   endif
      *
     c     x'25':' '     xlate     sdtek1        sdtek1
     c     x'25':' '     xlate     sdtek2        sdtek2
     c     x'3F':'A'     xlate     sdtek1        sdtek1
     c     x'3F':'A'     xlate     sdtek2        sdtek2
6.16 c     x'7D':' '     xlate     sdtek1        sdtek1
6.16 c     x'7D':' '     xlate     sdtek2        sdtek2
      *
     c                   if        s_ltyp = '10' or
     c                             s_ltyp = '11'
     c                   eval      w_flin = '11' + c_fsep +
     c                                      %trim(sdtek1) +
     c                                      %trim(sdtek2) + c_fsep
     c                   exsr      write_outp
     c                   leavesr
     c                   endif
      *
     c                   if        s_ltyp = '35' or
     c                             s_ltyp = '36'
     c                   eval      w_flin = '36' + c_fsep +
     c                                      %trim(sdtek1) +
     c                                      %trim(sdtek2) + c_fsep
     c                   exsr      write_outp
     c                   endif
      *
      *
     c                   if        s_ltyp = '40' or
     c                             s_ltyp = '41' or
     c                             s_ltyp = '50'
     c                   eval      w_flin = '41' + c_fsep +
     c                                      %trim(sdtek1) +
     c                                      %trim(sdtek2) + c_fsep
     c                   exsr      write_outp
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for gen. av avsluttende fakturadata
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skriv_fslut   begsr
      *
      * Sumrecord - recordtype 80
      *
     c                   eval      w_flin = *blank
      *
      * - Recordtype
      *
     c                   eval      w_flin = '80' + c_fsep
      *
      * Kalk. MVA-grunnlag
      *
     c                   eval      w_tmvg = *zero
     c                   eval      w_tmvg = ((s_salp + s_salh) -
     c                                       (s_rk1p + s_rk2p + s_rkop +
     c                                        s_rk1h + s_rk2h + s_rkoh))
     c                   eval      w_tmva = *zero
      *
     c*                  if        p_mvap > *zero
     c*                  eval      w_tmva_m = ((w_tmvg / 100) * p_mvap)
     c*                  eval(h)   w_tmva = w_tmva_m
     c*                  endif
     c                   eval(h)   w_tmva = s_fmva
6.1b  *
6.1b  * beregner bruksrettrabatt
6.1b  *
6.1b c                   eval      w_rbsu = w_rb1p +
6.1b c                                      w_rb1h +
6.1b c                                      w_rb1f +
6.1b c                                      w_rb2p +
6.1b c                                      w_rb2h +
6.1b c                                      w_rb2f
      *
      *
      * - Nettobeløp (eks. MVA)
      *
6.1b  * evt. trekke fra bruksrettrabatt
6.7x  *
6.1b c                   eval      s_fnet = s_fnet - w_rbsu
     c                   eval      w_belo = s_fnet
     c                   if        w_belo <> *zero
     c                   eval      w_dnto = %editc(w_belo : 'M')
     c                   else
     c                   eval      w_dnto = '0'
     c                   endif
      *
     c                   eval      w_numf = w_dnto
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
     c                   eval      s_fbru = s_fnet + w_tmva
6.31 c                   eval      w_fbim = s_fmvg + w_tmva
      *
      * - MVA-grunnlag
      *
     c                   if        s_fmvg <> *zero
     c                   eval      w_numf = %editc(s_fmvg : 'M')
     c                   else
     c                   eval      w_numf = '0'
     c                   endif
      *
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Totalt MVA beløp
      *
     c                   if        w_tmva <> *zero
     c                   eval      w_numf = %editc(w_tmva : 'M')
     c                   else
     c                   eval      w_numf = '0'
     c                   endif
      *
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Bruttobeløp / fakt.total
      *
6.24 c                   if        sodept <> 0
6.24 c                   eval      w_belo =s_fsum - sodept
6.24 c                   else
     c                   eval      w_belo = s_fsum
6.24 c                   endif
      *
     c                   if        w_belo <> *zero
     c                   eval      w_dbto = %editc(w_belo : 'M')
     c                   else
     c                   eval      w_dbto = '0'
     c                   endif
      *
     c                   eval      w_numf = w_dbto
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Div. tot.felter (EDI)
      * - Sum netto varelinjer
      *
     c                   eval      w_belo = s_fnet
      *
     c                   if        w_belo <> *zero
     c                   eval      w_dnto = %editc(w_belo : 'M')
     c                   else
     c                   eval      w_dnto = '0'
     c                   endif
      *
     c                   eval      w_numf = w_dnto
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Sum tillegg (=0)
      *
     c                   eval      w_flin = %trim(w_flin) + '0' + c_fsep
      *
      * - Sum fradrag
      *
     c                   eval      w_belo = s_frab
      *
     c                   if        w_belo <> *zero
     c                   eval      w_drab = %editc(w_belo : 'M')
     c                   else
     c                   eval      w_drab = '0'
     c                   endif
      *
     c                   eval      w_numf = w_drab
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - Øreavrunding
      *
     c                   if        s_fsum <> s_fbru
     c                   eval      w_avru = s_fsum - s_fbru
     c                   eval      w_avrx = %editc(w_avru : 'M')
     c                   eval      w_numf = w_avrx
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
     c                   else
     c                   eval      w_flin = %trim(w_flin) + c_fsep
     c                   endif
      *
      * - Sum listeprislinjer
      *
     c                   eval      w_flin = %trim(w_flin) + c_fsep
5.62  * Byggmester faktura
5.62 c                   if        rkfcop = 2 or
5.62 c                             rkfcop = 3
5.62  *
5.62  * - Bruttosum uten rabatt
5.62  *
5.62 c                   if        w_bf_n <> *zero
5.62 c                   eval      w_numf = %editc(w_bf_n : 'M')
5.62 c                   else
5.62 c                   eval      w_numf = '0'
5.62 c                   endif
5.62  *
5.62 c                   exsr      sjekk_minus
5.62 c                   eval      w_flin = %trim(w_flin) +
5.62 c                                      %trim(w_numf) + c_fsep
5.62  *
5.62  * - Bruttosum uten rabatt -  mva-grunnlag
5.62  *
5.62 c                   if        w_bf_g <> *zero
5.62 c                   eval      w_numf = %editc(w_bf_g : 'M')
5.62 c                   else
5.62 c                   eval      w_numf = '0'
5.62 c                   endif
5.62  *
5.62 c                   exsr      sjekk_minus
5.62 c                   eval      w_flin = %trim(w_flin) +
5.62 c                                      %trim(w_numf) + c_fsep
5.62  *
5.62  * - Bruttosum uten rabatt - mva
5.62  *
5.62 c                   if        w_bf_m <> *zero
5.62 c                   eval      w_numf = %editc(w_bf_m : 'M')
5.62 c                   else
5.62 c                   eval      w_numf = '0'
5.62 c                   endif
5.62  *
5.62 c                   exsr      sjekk_minus
5.62 c                   eval      w_flin = %trim(w_flin) +
5.62 c                                      %trim(w_numf) + c_fsep
5.62  *
5.62  * - Bruttosum uten rabatt - total-sum
5.62  *
5.62 c                   eval      w_bf_b = w_bf_n + w_bf_m
5.62 c                   if        w_bf_b <> *zero
5.62 c                   eval      w_numf = %editc(w_bf_b : 'M')
5.62 c                   else
5.62 c                   eval      w_numf = '0'
5.62 c                   endif
5.62  *
5.62 c                   exsr      sjekk_minus
5.62 c                   eval      w_flin = %trim(w_flin) +
5.62 c                                      %trim(w_numf) + c_fsep
5.62  *
6.31 c                   else
6.31  * ikke byggmesterfaktura
6.31  *                  else
6.31  * - Faktura beløp inkl. MVA inkl. mva eks rabatt.
6.31  *
6.31 c                   if        w_fbim <> *zero
6.31 c                   eval      w_numf = %editc(w_fbim : 'M')
6.31 c                   else
6.31 c                   eval      w_numf = '0'
6.31 c                   endif
6.31  *
6.31 c                   exsr      sjekk_minus
6.31 c                   eval      w_flin = %trim(w_flin) +
6.31 c                                             c_fsep +
6.31 c                                             c_fsep +
6.31 c                                      %trim(w_numf) + c_fsep
6.31  *
5.62 c                   endif
      *
     c                   exsr      write_outp
      *
      * MVA-totalrecord - recordtype 81
      *
     c                   if        (s_mvg1 <> *zero and s_mvg2 <> *zero) or
     c                             (s_mvg1 <> *zero and s_mvg3 <> *zero) or
     c                             (s_mvg2 <> *zero and s_mvg3 <> *zero)
      *
      * MVA-sats 1
      *
     c                   if        s_mvg1 <> *zero
     c                   eval      w_flin = *blank
     c                   eval      w_flin = '81' + c_fsep
      *
      * - MVA-grunnlag #1
      *
     c                   eval      w_numf = %editc(s_mvg1 : 'M')
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - MVA-prosent #1
      *
     c                   eval      w_mvap = %editc(s_mvp1 : 'M')
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_mvap) + c_fsep
      *
      * - MVA-beløp #1
      *
     c                   eval(h)   w_dmva = s_mvb1
     c                   eval      w_numf = %editc(w_dmva : 'M')
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
     c                   exsr      write_outp
     c                   endif
      *
      * MVA-sats 2
      *
     c                   if        s_mvg2 <> *zero
     c                   eval      w_flin = *blank
     c                   eval      w_flin = '81' + c_fsep
      *
      * - MVA-grunnlag #2
      *
     c                   eval      w_numf = %editc(s_mvg2 : 'M')
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - MVA-prosent #2
      *
     c                   eval      w_mvap = %editc(s_mvp2 : 'M')
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_mvap) + c_fsep
      *
      * - MVA-beløp #2
      *
     c                   eval(h)   w_dmva = s_mvb2
     c                   eval      w_numf = %editc(w_dmva : 'M')
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
     c                   exsr      write_outp
     c                   endif
      *
      * - MVA-grunnlag (null)
      *
     c                   if        s_mvg3 <> *zero
     c                   eval      w_flin = *blank
     c                   eval      w_flin = '81' + c_fsep
     c                   eval      w_numf = %editc(s_mvg3 : 'M')
     c                   exsr      sjekk_minus
     c                   eval      w_flin = %trim(w_flin) +
     c                                      %trim(w_numf) + c_fsep
      *
      * - MVA-prosent (null)
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      '0' + c_fsep
      *
      * - MVA-beløp (null)
      *
     c                   eval      w_flin = %trim(w_flin) +
     c                                      '0' + c_fsep
      *
     c                   exsr      write_outp
     c                   endif
     c                   endif
      *
     c                   if        p_rapp = '1'
     c                   exsr      skr_rappl
     c                   endif
      *
     c                   exsr      upd_uf_log
      *
     c                   eval      s_binr = *zero
     c                   eval      s_fbru = *zero
     c                   eval      s_fnet = *zero
     c                   eval      s_fmva = *zero
     c                   eval      s_fmvg = *zero
     c                   eval      s_frab = *zero
      *
     c                   eval      s_mvp1 = *zero
     c                   eval      s_mvg1 = *zero
     c                   eval      s_mvb1 = *zero
     c                   eval      s_mvp2 = *zero
     c                   eval      s_mvg2 = *zero
     c                   eval      s_mvb2 = *zero
     c                   eval      s_mvp3 = *zero
     c                   eval      s_mvg3 = *zero
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for skriving av fysisk record - m/konv. av bokstaver
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     write_outp    begsr
      *
6.16 c     X'7D':' '     xlate     w_flin        w_flin
8.04 c     x'1C':' '     xlate     w_flin        w_flin
8.04 c     x'25':' '     xlate     w_flin        w_flin
8.04 c     X'2B':' '     xlate     w_flin        w_flin
8.04 c     X'17':' '     xlate     w_flin        w_flin
8.04 c     x'05':' '     xlate     w_flin        w_flin
8.04 c     x'0D':' '     xlate     w_flin        w_flin
     c*    'Æ':X'46'     xlate     w_flin        w_flin
     c*    'æ':X'A0'     xlate     w_flin        w_flin
     c*    'Ø':X'77'     xlate     w_flin        w_flin
     c*    'ø':X'90'     xlate     w_flin        w_flin
     c*    'Å':X'2A'     xlate     w_flin        w_flin
     c*    'å':X'EF'     xlate     w_flin        w_flin
      *
     c                   if        p_faty = 20
     c                   eval      fnefln = w_flin
     c                   write     fnefpfr
     c                   endif
      *
     c                   if        p_faty = 21
     c                   eval      fnepln = w_flin
     c                   write     fneppfr
     c                   endif
      *
5.61 c                   if        p_faty = 22 or
6.11 c                             p_faty = 25 or
6.11 c                             p_faty = 26
     c                   eval      fnemln = w_flin
     c                   write     fnempfr
     c                   endif
      *
     c                   if        p_faty = 23
     c                   eval      fnecln = w_flin
     c                   write     fnecpfr
     c                   endif
      *
     c                   eval      w_antl = w_antl + 1
     c                   eval      s_ltyp = %subst(w_flin:1:2)
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for mellomlagring av hodesummer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     save_fsum     begsr
      *
     c                   eval      s_fsum = sofsum
     c                   eval      s_salp = sosalp
     c                   eval      s_salh = sosalh
     c                   eval      s_salf = sosalf
     c                   eval      s_rk1p = sork1p
     c                   eval      s_rk2p = sork2p
     c                   eval      s_rkop = sorkop
     c                   eval      s_rk1h = sork1h
     c                   eval      s_rk2h = sork2h
     c                   eval      s_rkoh = sorkoh
     c                   eval      s_rk1f = sork1f
     c                   eval      s_rk2f = sork2f
     c                   eval      s_rkof = sorkof
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for kontroll av utgående fakturalogg
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjk_uf_log    begsr
      *
     c                   eval      b_logf = *off
     c                   eval      w_binr = fnubin
      *
      * Sjekk omkjøring og kjøredato
      *
     c                   if        p_omkj = *blank
     c                   if        fnukda <> *loval
     c                   leavesr
     c                   endif
     c                   endif
      *
     c                   if        p_omkj = '1'
     c                   if        fnukda = *loval
     c                   leavesr
     c                   endif
     c                   if        p_fnum <= 1 or
6.NU c                             p_tnum = 99999999
     c                   leavesr
     c                   endif
     c                   if        fnubin < p_fnum or
     c                             fnubin > p_tnum
     c                   leavesr
     c                   endif
     c                   endif
      *
     c                   eval      b_logf = *on
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for oppdat. av utgående fakturalogg
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     upd_uf_log    begsr
      *
     c                   eval      fnuflu_aarr = p_aarr
     c                   eval      fnuflu_binr = s_binr
     c     fnuflu_key    chain     fnuflur
     c                   if        %found
     c                   time                    fnukda
     c                   time                    fnukti
     c                   eval      fnukws = l_wsid
     c                   eval      fnutel = fnutel + 1
     c                   time                    fnueda
     c                   time                    fnueti
     c                   eval      fnueus = l_user
     c                   update    fnuflur
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for manipulering til ledende minustegn
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_minus   begsr
      *
     c                   eval      w_posm = 0
     c                   eval      w_posm = %scan('-':w_numf)
      *
     c                   if        w_posm > 0
     c                   eval      w_numf = %subst(w_numf:1:w_posm - 1)
     c                   eval      w_numf = '-' + %trim(w_numf)
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for sjekk om samlefaktura
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjk_saml      begsr
      *
     c                   eval      b_saml = *off
     c                   eval      w_anto = *zero
     c                   eval      w_fsum = *zero
     c                   eval      w_kidr = *zero
     c                   eval      w_kidd = *blank
      *
     c                   eval      sohelr_aarr = soaarr
     c                   eval      sohelr_binr = sobinr
      *
     c     sohelr_key    setll     sohelr
     c     sohelr_key    reade     sohelr
      *
     c                   dow       not %eof
      *
     c                   eval      w_anto = w_anto + 1
      *
     c                   eval      w_fsum = xxfsum
     c                   if        d_kidk <> 0
     c                   if        d_kidk = 1
     c                   eval      w_kidd = xxkidd
     c                   else
6.25 c                   if        d_kidk = 2
     c                   eval      w_kidr = xxkidr
6.25 c                   else
6.25 c                   if        d_kidk = 3
6.25 c                   movel     xxkidr        w_kid3
6.25 c                   call      'AK710R'
6.25 c                   parm                    w_firm
6.25 c                   parm                    w_kid3
6.25 c                   parm                    w_kidd
6.25 c                   parm                    w_kid2
6.25 c                   movel     w_kid2        w_kidr
6.25 c                   movel     w_kid2        w_kidh
6.25 c                   move      w_kidh        w_kidr
     c                   else
     c                   eval      w_kidr = xxkidr
     c                   eval      w_kidd = xxkidd
     c                   endif
6.25 c                   endif
6.25 c                   endif
6.25 c                   endif
      *
     c     sohelr_key    reade     sohelr
     c                   enddo
      *
     c                   if        w_anto > 1
     c                   eval      b_saml = *on
     c                   endif
      *
     c                   endsr
6.1b  *
6.1b  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.1b  * Subrutine for sjekk og evt. summerer bruksrett rabatt
6.1b  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.1b  *
6.1b c     sjk_bruksrett begsr
6.1b  *
6.1b c                   eval      w_rb1p = 0
6.1b c                   eval      w_rb1h = 0
6.1b c                   eval      w_rb1f = 0
6.1b c                   eval      w_gr1p = 0
6.1b c                   eval      w_gr1h = 0
6.1b c                   eval      w_gr1f = 0
6.1b c                   eval      w_rb2p = 0
6.1b c                   eval      w_rb2h = 0
6.1b c                   eval      w_rb2f = 0
6.1b c                   eval      w_gr2p = 0
6.1b c                   eval      w_gr2h = 0
6.1b c                   eval      w_gr2f = 0
6.1b  *
6.1b c                   eval      sohelr_aarr = soaarr
6.1b c                   eval      sohelr_binr = sobinr
6.1b  *
6.1b c     sohelr_key    setll     sohelr
6.1b c     sohelr_key    reade     sohelr
6.1b c                   dow       not %eof(sohelr)
6.1b c                   eval      w_rb1p = w_rb1p + xxrb1p
6.1b c                   eval      w_rb1h = w_rb1h + xxrb1h
6.1b c                   eval      w_rb1f = w_rb1f + xxrb1f
6.1b c                   eval      w_gr1p = w_gr1p + xxgr1p
6.1b c                   eval      w_gr1h = w_gr1h + xxgr1h
6.1b c                   eval      w_gr1f = w_gr1f + xxgr1f
6.1b c                   eval      w_rb2p = w_rb2p + xxrb2p
6.1b c                   eval      w_rb2h = w_rb2h + xxrb2h
6.1b c                   eval      w_rb2f = w_rb2f + xxrb2f
6.1b c                   eval      w_gr2p = w_gr2p + xxgr2p
6.1b c                   eval      w_gr2h = w_gr2h + xxgr2h
6.1b c                   eval      w_gr2f = w_gr2f + xxgr2f
6.1b c     sohelr_key    reade     sohelr
6.1b c                   enddo
6.1b  *
6.1b c                   endsr
6.1b  *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for skriving av rapportheader v/ utskrift valgt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skr_rapph     begsr
      *
     c                   eval      a1firm = l_firm
     c                   eval      a1fnav = l_fnav
     c                   eval      a1wsid = l_wsid
     c                   time                    a1time
5.64 c     *dmy          move      w_udat        a1date
     c                   eval      a1user = l_user
      *
     c                   eval      a1ftyp = fmtbes
      *
     c                   if        p_omkj = '1'
     c                   eval      a1omkj = 'Omkjøring'
     c                   else
     c                   eval      a1omkj = *blank
     c                   endif
      *
     c                   write     a1hdr                                30
      *
     c                   eval      b_uskr = *on
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for skriving av rapportlinje v/ utskrift valgt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     skr_rappl     begsr
      *
     c                   eval      a1fsum = s_fsum
      *
     c                   write     a1det                                30
      *
      * Er det overflow ?
      *
     c                   select
     c                   when      *in30 = *on
     c                   exsr      xovrfl
     c                   endsl
      *
     c                   endsr
8.05  *
8.05  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.05  * Subrutine for sjekk om ordretype eller kunde er utelatt fra factoring
8.05  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.05  *
8.05 c     sjk_fact      begsr
8.05  *
8.05  * Ordretype utelatt?
8.05  *
8.05           b_fact = *off;
8.05
8.05          exec sql
8.05            select rkfot1, rkfot2, rkfot3, rkfot4, rkfot5
8.05              into :w_fot1, :w_fot2, :w_fot3, :w_fot4, :w_fot5
8.05            from ra34st
8.05               where rkffir = :w_firm;
8.05
8.05          if w_fot1 = sootyp or
8.05             w_fot2 = sootyp or
8.05             w_fot3 = sootyp or
8.05             w_fot4 = sootyp or
8.05             w_fot5 = sootyp;
8.05           b_fact = *on;
8.05          endif;
8.05  *
8.05  * Kunde utelatt ?
8.05  *
8.05          exec sql
8.05            select rkfack
8.05              into :w_fack
8.05            from rkunpf
8.05               where rkfirm = :w_firm and
8.05                     rkkund = :sokund;
8.05
8.05          if w_fack = 1;
8.05           b_fact = *on;
8.05          endif;
8.05  *
8.05 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for overflow                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xovrfl        begsr
      *
     c                   write     a1hdr                                30
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for sjekker om det noen 50 - records som ikke er skrevet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     sjk_50rec     begsr
      *
     c                   if        w_flinx1 <> *blank
     c                   eval      w_flin = w_flinx1
     c                   exsr      write_outp
     c                   endif
      *
     c                   if        w_flinx2 <> *blank
     c                   eval      w_flin = w_flinx2
     c                   exsr      write_outp
     c                   endif
      *
     c                   if        w_flinx3 <> *blank
     c                   eval      w_flin = w_flinx3
     c                   exsr      write_outp
     c                   endif
      *
     c                   eval      w_flinx1 = *blank
     c                   eval      w_flinx2 = *blank
     c                   eval      w_flinx3 = *Blank
      *
     c                   endsr
      *
      *
6.35  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.35  * Subrutine for å finne riktig nobbnr. på logistikk-vare
6.35  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.35  *
6.35 c     sjekk_logi    begsr
6.35 c                   eval      w_lv_vare = *blank
6.35 c/exec sql
6.35 c+ select jvkvnr
6.35 c+ into   :w_lv_vare
6.35 c+ from   jvkhpf
6.35 c+ where  jvkvnr = :w_vare
6.35 c/end-exec
6.35 c                   endsr
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  * Subrutine for sjekk om faktura har linjer
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  *
7.03 c     sjk_fakt      begsr
7.03  *
7.03 c                   eval      b_alin = *off
7.03  *
7.03  * Sjekk om det finnes linjer
7.03  *
7.03 c                   eval      sodtlr_aarr = soaarr
7.03 c                   eval      sodtlr_binr = sobinr
7.03  *
7.03 c     sodtlr_key    setll     sodtlr
7.03 c     sodtlr_key    reade     sodtlr
7.03  *
7.03 c                   if        not %eof(sodtlr)
7.03 c                   eval      b_alin = *on
7.03 c                   endif
7.03  *
7.03 c                   endsr
7.03  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    p_aarr
     c                   parm                    p_faty
6.NU c                   parm                    p_fnum
6.NU c                   parm                    p_tnum
     c                   parm                    p_omkj
     c                   parm                    p_rapp
     c                   parm                    p_anta
     c                   parm                    p_feil
      *
     c                   eval      p_anta = *zero
     c                   eval      p_feil = *blank
      *
     c                   eval      w_antf = *zero
     c                   eval      w_antl = *zero
      *
     c                   eval      w_firm = l_firm
      *
      * Key for les av kunde
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
7.02  *
7.02 c     rkunlr_key    klist
7.02 c                   kfld                    w_firm
7.02 c                   kfld                    rkunlr_kund
      *
      * Key for oppslag på faktura-hode-register
      *
     c     sohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sohel1_aarr
     c                   kfld                    sohel1_binr
      *
      * Key for oppslag på faktura-hode-register (les ant. ordre)
      *
     c     sohelr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sohelr_aarr
     c                   kfld                    sohelr_binr
      *
      * Key for les av fakturalinjer
      *
     c     sodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sodtl1_aarr
     c                   kfld                    sodtl1_binr
     c                   kfld                    sodtl1_numm
     c                   kfld                    sodtl1_suff
      *
      * Key for firma
      *
     c     afir_key      klist
     c                   kfld                    w_firm
      *
      * Key for linjetyper
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for ordretyper
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for oppslag på ofak-koderegister (statuskoder)
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for les på lager
      *
     c     ra10l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra10l1_jkod
      *
      * Key for kode
      *
     c     ra18l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra18l1_rkod
6.15  *
6.15  * Key for transportmåte
6.15  *
6.15 c     ra17l1_key    klist
6.15 c                   kfld                    w_firm
6.15 c                   kfld                    ra17l1_qkod
      *
      * Key for statuskode 8
      *
     c     raa8l1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag på vareregister
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for oppslag på EAN-nummer
      *
     c     veanl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    veanl2_vare
      *
      * Key for les av fakturatype
      *
     c     fmftl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fmftl1_faty
      *
      * Key for oppslag av fakturalogg
      *
     c     fnufl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fnufl1_aarr
     c                   kfld                    fnufl1_binr
      *
      * Key for oppslag av fakturalogg (type/dato)
      *
     c     fnufl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fnufl2_ufat
     c                   kfld                    fnufl2_ukda
      *
      * Key for oppdat. av fakturalogg
      *
     c     fnuflu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fnuflu_aarr
     c                   kfld                    fnuflu_binr
      *
      * Key for oppslag på avdeling
      *
     c     ra07l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra07l1_gkod
      *
      * Key for oppslag på vare (VA)
      *
     c     jvarl1_key    klist
     c                   kfld                    jvarl1_vare
      *
      * Key for priskode-register
      *
     c     vpkol1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vpkol1_pkod
6.21  *
6.21  * Key for oppslag på kundeprosjekt
6.21  *
6.21 c     fkprl1_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    fkprl1_kund
6.21 c                   kfld                    fkprl1_kpro
7.03  *
7.03  * Key for les av fakturalinjer
7.03  *
7.03 c     sodtlr_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    sodtlr_aarr
7.03 c                   kfld                    sodtlr_binr
5.64  *
5.64 c                   time                    w_udat
7.02  *
7.02  *  Sjekk om eget bankgironummer på factoring kunde
7.02  *
7.02 c                   eval      w_sbgi = *zero
7.02 c     afir_key      chain     raa9l1
7.02 c                   if        %found(raa9l1)
7.02 c                             and ra9knr <> 0
7.02 c                   eval      rkunlr_kund = ra9knr
7.02 c     rkunlr_key    chain     rkunlr
7.02 c                   if        %found(rkunlr)
7.02 c                   eval      w_sbgi = rrbgir
7.02 c                   endif
7.02 c                   endif
7.02  *
7.01  *
7.01  * Legge ut internt eller eksternt prosjektnummer
7.01  *
7.01   CallP CO402R(l_filg:w_firm:0:'FO181_701':
7.01                    co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     u_701 = *on;
7.01   endif;
8.01  *
8.01  * Factoring via izzy
8.01  *
8.01   CallP CO402R(l_filg:w_firm:0:'FACTORING_VIA_IIZY':
8.01                    co402_verdi1:co402_verdi2);
8.01   if co402_verdi1 = '1';
8.01     u_801 = *on;
8.01   endif;
8.02  *
8.02  * Sjekk om firma eller avdeling skal legges som SU
8.02  *
8.02   CallP CO402R(l_filg:w_firm:0:'AVDELING_ELLER_FIRMA_LOGINV':
8.02                    co402_verdi1:co402_verdi2);
8.02   if co402_verdi1 = '1';
8.02     u_avde = *on;
8.02   endif;
      *
     c                   endsr
      *
