# RPG Program VA198R – Explanation and Overview

This RPG (Report Program Generator) program is designed to maintain a "MVA coupling table" (MVA = Norwegian VAT/tax code), allowing for viewing, editing, copying, creating, and deleting table entries through subfiles and multiple display formats. Below is an explanation of the program, focusing on structure and key logic areas. 

---

## 1. **Program Attributes and Metadata (`H` Spec and Comments)**
- **`option(*nodebugio)`**: Suppresses the generation of debug information for I/O operations.
- **`datedit(*dmy)`**: Specifies the date editing for day/month/year.
- Comments describe the system, program purpose, and modifications over time.
- There's an extensive comment block assigning indicator meanings (for UI and workflow).

---

## 2. **File Definitions (`F` Specs)**

### Database File Definitions
- **`vmval1`, `vmval2`, `vmvalr`, `vmvalu`**: Logical and update-capable database files, renamed to specific record formats. `K disk` denotes a keyed access path.
    - These files are used for various lookups and updates on MVA records.
- **`fva195d`**: Workstation file, representing the display file. Contains subfile (sfile) for paginated lists, with indicator feedback via `INDS`.

---

## 3. **Data Structure and Variable Declarations (`D` Specs)**

### Data Area Fields
- **Local data area (`UDA`)**: Used to get user (`l_user`), company (`l_firm`), and name fields (`l_fnav`).

### Display Feedback
- **`dspfbk`**: Used to get first cursor record number.

### Variables for Keys and Operation State
- Various variables keep track of keys, text, state flags (operation, error), and fields for subfile manipulation: page size, counters, etc.

### Constants
- Example: `c_sfil` = 13 – Size of subfile page (number of rows in subfile display).

---

## 4. **Subfile and Display Workflow**

### Subfile Terminology
- Variables like `w_fcrn`, `w_stel`, `w_spge`, etc., track subfile navigation, page boundaries, and cursor position.
- Display file formats:
    - `B1SFL` – Subfile record
    - `B2CTL` – Subfile control (header/footer)
    - `B2CMD` – Command key window
    - Other special windows for add/edit/copy/delete.

---

## 5. **Main Control Flow (`C` Specs)**

### Start/Entry Point
- Starts at the main menu (labels like `b2taga`, `b2tagb`).
- Writes the command screen, then displays/fills subfiles.
- Handles function keys via a SELECT/WHEN structure (e.g., F3–exit, F5–refresh, F6–create, F10–page roll, etc).

---

#### Example Snippet – Function Key Handling
```rpg
c     select
c     when      *inkc or *inkl  // F3 or F12 pressed
c     goto      avslutt         // Exit program
c     when      *inke           // F5 pressed
c     exsr      forny           // Refresh subfile
c     goto      b2tagb
...
c     endsl
```

---

### Subfile Positioning
- Allows searching and positioning via code or description.

### Subfile Processing Loop
- Reads and processes records selected in the subfile (`readc b1sfl`).
- The user can choose to Edit, Copy, Delete, or View via options (2,3,4,5).

---

## 6. **Display and Data Manipulation Subroutines**

### Creating New Rows (`xc1bld`)
- Handles logic for creating a new entry.
- Checks if the key already exists; if so, displays a message.
- Calls the edit routine for further input.

### Edit/View Routine (`xc2bld`)
- Loads data if the key exists; otherwise, prepares blank entry.
- Handles screen input, including F-key lookups for other codes.
- Validates input (calls `kontroll` routine).
- Updates or adds the database record.

### Copy/Delete Windows (`xk1win`, `xd1win`)
- Copy: Displays copy window, validates, then calls edit routine.
- Delete: Displays confirmation, then deletes the record if approved.

### Validation Routine (`kontroll`)
- Calls external validation program (`RS705R`) to check if MVA codes are valid, for various fields (sale, warehouse, export).
- Signals error indicators if invalid.

---

## 7. **Subfile Handling**

### Clear Subfile (`clr_subfile`)
- Sets indicators to clear subfile, writes control record, and resets counters.

### Create Subfile (`crt_subfile`)
- Reads from the appropriate file (by code or description), populates the subfile page-wise up to the `c_sfil` limit.

### Page Backward (`bck_subfile`)
- Handles rolling back one page in the subfile.

### Display Subfile (`dsp_subfile`)
- Handles page display, sets indicators to manage which screens are shown.

---

## 8. **Initialization (`*inzsr`)**
- Sets up keys for various access paths.
- Loads initial firm (company) from LDA.
- Initializes subfile display.

---

## 9. **General Notes**

- The program is tightly coupled to the display file and the subfile UI model.
- Uses explicit indicator management for workflow/UI control.
- Calls several external programs for code validation and lookup.
- Comments and field names are in Norwegian; field names like `mva` for VAT/Moms, `kod` for code, etc.

---

## 10. **Common Workflows**

- **Create**: Enter new value in command/display screen → edit fields → check duplicate → save record.
- **Edit**: Select line (option 2) → edit → validate → save.
- **Copy**: Select line (option 3) → display copy window → enter new code → check existence → edit as needed → save.
- **Delete**: Select line (option 4) → display delete confirmation → confirm → delete record.
- **Search/Position**: Enter code or text in command area → subfile refreshes.
- **Function keys**: F3/F12 (exit), F5 (reload), F6 (add), F10/F11 (paging), F9 (field lookups).

---

## 11. **Key RPG Programming Concepts Illustrated**

- **Subfiles**: Efficiently handles large record lists, paginates, and supports keyboard navigation.
- **Indicators**: Classic indicator usage for controlling screen behavior.
- **Chaining and SETLL/READ/UPDATE/WRITE/DELETE**: Standard database access and manipulation.
- **External Program Calls**: Used for modular validation and field lookups.

---

## 12. **Summary Table of Important Variables/Indicators**

| Element      | Purpose                            |
|--------------|------------------------------------|
| *inxx        | UI/Functional indicators           |
| b1sfl        | Subfile record format              |
| w_srrn       | Current subfile record number      |
| w_ssrn       | Last record number on page         |
| c1mkod       | VAT code being processed/edited    |
| c1mtxt       | Description text                   |
| b_forn       | Refresh subfile flag               |
| b_oppr       | New record creation flag           |

---

## 13. **Conclusion**

This program is an example of classic ILE RPG programming for IBM iSeries/AS400, managing maintenance of a VAT code cross-reference using subfiles and display file navigation, with strong focus on indicator-based UI control and data validation through modular routines and external program calls. For onboarding, focus on learning:
- Subfile processing patterns
- Indicator workflows
- Database access methods (`chain`, `setll`, etc.)
- UI/display file integration

Understanding the flow will make it easier to onboard and contribute to maintenance or enhancements of this application.