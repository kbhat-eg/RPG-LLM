# Explanation of RPG Program VA150R ("Ordretype, vedlikehold")

This RPG program is designed for IBM i (AS/400) and manages the maintenance (vedlikehold) of order types ("ordretype"). Below is an explanation organized to help someone new to this code.

---

## High-Level Overview

- **Purpose:** Manage order types (add, change, delete, display) using a subfile-based display.
- **Interaction:** Uses a display file (`va150d`) and several physical files (order type master and related files).
- **Language:** RPG/400 (ILE RPG, but with much legacy syntax).
- **Structure:** Main logic with extensive use of subroutines. Program flow is driven by display file indicators and user function keys.

---

## 1. File and Data Area Declarations

**Physical Files:**
- `votyl1`, `votyl2`, `votylr`, `votylu` (all based on the same physical file, `votypfr`, but different record formats, likely for various logical access paths)
- `vot1lr`, `vot1lu` (side register, based on `vot1pfr`)

**Display File:**
- `va150d` – Used for all screen interactions, with subfile support (`sfile(b1sfl:w_srrn)`).

**Data Area:**
- LDA (Local Data Area) is read into variables like `l_user`, `l_firm`, used for firm/user context.

**Feedback Data Structure:**
- `dspfbk` – Used to capture display file feedback such as cursor position.

---

## 2. Key Variables and Indicators

- Many single-letter or short named variables for status, flags, and subfile handling (e.g., `w_fcrn`, `w_srrn`).
- Indicators (`*inxx`) are used (RPG's equivalent of flags), especially for function keys (roll up/down, select, error indicators, etc.).
- Subfile variables: manage which records are showing, current position, page sizes, etc.

---

## 3. Main Program Flow

### A. Startup (`*inzsr` Subroutine)

- Defines keys for file access.
- Reads the firm number from the LDA.
- Initializes display and fills the subfile with data.

### B. Main Display Loop

- Tag-based loop using `b2taga` and `b2tagb`.
- Handles subfile display, function key processing, and call-outs to subroutines based on user actions:

  - *F3/F12 Exit* (`*inkc` / `*inkl`): End program
  - *F5 Refresh* (`*inke`): Refresh subfile data
  - *F6 New* (`*inkf`): Add new entry (calls `xc1bld`)
  - *Page Up/Down* (`*in10` / `*in11`): Scroll subfile up/down
  - *F21 Home* (`*in21`): Position cursor

- Subfile selection actions: positioning on type or description.

---

## 4. Subroutines

### A. Subfile Handling

- **`dsp_subfile`**: Display subfile, handle focus management.
- **`subfile`**: Read and process user-modified subfile records (edit, copy, delete, view).
- **`clr_subfile`**/**`crt_subfile`**: Clear and then repopulate subfile with records from database.
- **`bck_subfile`**: Scroll subfile back one page.

### B. CRUD Actions

- **`xc1bld` (Add New)**: Handles new record creation.
  - Prompts for order type.
  - Checks for duplicates.
  - If valid, calls `xc2bld` to maintain new entry.
- **`xc1msg`**: Display message dialog for "already exists" situations.
- **`xc2bld` (Edit/View)**: Main entry for editing or viewing a record.
  - Loads data into screen fields.
  - Handles update or write logic to main and "side" files.
  - Enforces business rules (see section on special validations).
- **`xd1win` (Delete)**: Confirm and delete a record.
- **`xk1win` (Copy)**: Copy an existing record to a new key.

### C. Special Validations and Functionality

- **Order Type Consistency (`xc2bld`):**
  - Various checks ensure that linked order types (e.g., credit notes, corresponding system types) are valid.
  - Enforces that order types being referenced exist and meet certain requirements.

- **Inquiry Support (`spørring`):**
  - Special F4-inquiry ("prompt") for fields like `c2obld` (image alternative).

---

## 5. Keylists (File Access)

- Keylists are defined to drive setll/chain/read operations. These are combinations of firm + order type or firm + description, depending on use case.

---

## 6. Explanation of Main Indicators

- **LR** = Last record (end-of-program)
- **10/11** = Roll up/down
- **12/13** = Subfile display/control
- **14/15** = Subfile clear/end-of-file
- **21/22** = Home/cursor placement
- **30** = Protect (read-only) mode for display
- **31-79** = Error/field indicators
- **80-99** = Work indicators

---

## 7. Display File Interaction

- Uses several records/screens:
  - **B1SFL**: Main subfile listing
  - **B2CTL**: Control record for subfile
  - **C1BLD / C2BLD**: Key and detail maintenance screens
  - **D1WIN / K1WIN**: Delete/copy dialogs
  - **C1MSG**: Message display

---

## 8. Comments and History

- The code is heavily commented, with a history of enhancements, mainly new fields or special logic for new requirements.
- Comments are in Norwegian, but mostly self-explanatory for Norwegian-speaking developers.

---

## 9. Subfile Paging and Processing

- Uses variables like `w_fcrn`, `w_srrn`, `w_spge` to track current and next record numbers in the subfile UI.
- Handles page up/down logic in `crt_subfile`/`bck_subfile`.

---

## 10. Data Integrity

- Updates to both main order type and associated "side register" (`vot1lur`) to ensure all related data is in sync.
- Uses timestamping (`time op-code`) and user tracking for auditing changes.

---

## 11. Other Special Routines

- **Inquiry (F4/Prompt):** When the current field is for image alternatives, calls program `VA590R` for look-up.

---

## Summary Table of Main Code Sections

| Section            | Purpose                                          |
|--------------------|--------------------------------------------------|
| File Declarations  | Connects to physical/display files               |
| Data Structures    | Holds user, firm, cursor, feedback, etc.         |
| Initialization     | Sets up keylists, reads LDA, primes subfile      |
| Main Loop          | Handles user input, delegates actions            |
| Subfile Handlers   | Paging, display, update, clear                   |
| CRUD Subroutines   | Add, edit, delete, copy, validate records        |
| Inquiry Handling   | F4-prompt for special fields                     |

---

## Onboarding Advice

- **RPG Syntax:** If you're not familiar with fixed-format RPG, spend some time learning how to read the column-based syntax (e.g., C-specs, D-specs, etc.).
- **Subfile Processing:** This is classic RPG subfile logic: clear, load, display, process, repeat. Understanding the flow between these will help.
- **Indicators:** Learn how indicators (`*inxx`) are used for display file and program state management.
- **Error Handling:** Most errors (field validation, record exists, etc.) are signaled via indicators and handled via display fields.
- **Extensions:** The code is modular: new logic and fields are added by extending data structures and relevant sections.
- **Documentation:** Comments are comprehensive and indicate both field use and history.

---

This program is a good example of advanced subfile maintenance in classic RPG, handling both display interaction and consistent data updates across related tables.