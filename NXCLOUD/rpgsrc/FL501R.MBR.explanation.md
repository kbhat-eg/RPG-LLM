# RPG Program FL501R Explanation

This program is an ILE RPG program for IBM i (AS/400) systems, aimed at querying customer projects for a given customer and date, allowing the user to search and select among both active and inactive (historical) projects. The code supports subfile-based displays (paged lists), SQL search, various function keys, and has support for additional project/underproject data.

Below is an organized walk-through of the program's key features and implementation.

---

## 1. **Header and Documentation**

- **Options:**  
  - `*nodebugio` disables debug for I/O.  
  - `datedit(*dmy)` sets the default date edit code.

- **Description:**  
  The program queries customer projects by company, customer, and date. You can search for both active and inactive projects. There are special keys for toggling views for historical projects.

- **Indicator Usage:**  
  Indicators are mapped for functions like roll up/down, subfile display control, field protection, cursor handling, function key logic, etc.

---

## 2. **File Definitions (`F-Specs`)**

- Multiple physical and logical files are referenced, including customer files (`fkpspf`, `fkprl4`, `fkprlr`), address files (`apospf`), projects (`rp1pl1`, `rp2ul1`), and a display file (`fl501d`) which supports subfile operations.

- The subfile B1SFL is defined in display file FL501D and controlled with the variable `w_srrn`.

---

## 3. **Data Structures and Variables (`D-Specs`)**

- **Parameters:**  
  Variables with prefix `p_` are used as parameters exchanged between calling and called programs or between routines.

- **Feedback Data Structure:**  
  `dspfbk` is used to capture display feedback, such as the current cursor row.

- **Key Variables:**  
  Variables like `fkprlr_kpro`, `apospf_ponr`, etc., are used for key operations (CHAIN, SETLL, READE) against database files.

- **Working Variables:**  
  Used for subfile paging, search text, position tracking, etc.

- **Constants:**  
  For example, `c_sfil` defines a subfile page size.

---

## 4. **Main Logic Flow (`C-Specs`)**

### **Program Entry and Initialization**

- The `*inzsr` subroutine is run at program start:
  - Sets up parameter passing.
  - Defines key lists for file access.
  - Initializes company and customer values.
  - Primes the subfile view.
  - Calls `crt_subfile` to fill the subfile for display.

### **Main Display Loop**

- `b2taga` / `b2tagb` tags constitute the main display loop:
  - Shows the command panel (`b2cmd`) and subfile.
  - Handles function key processing via a `SELECT` statement, including exit, refresh, page up/down, re-display, and search repeat.
  - Special key toggles historical/active project view using indicator `*IN80`.
  - Handles search logic and calls the appropriate subroutines (`søk`, `forny`, etc.).

---

## 5. **Key Subroutines**

### **forny (Renew Subfile)**

- If already positioned, chains to current subfile row.
- Depending on mode (`w_seqe` = 'S'), sets open search or positions to start.
- Calls `clr_subfile` and `crt_subfile` to clear and refill the subfile.

### **søk (Search)**

- Sets search mode and marks open search.
- Calls external program `AS700R` to derive up to 5 separate search words from the search string.
- Clears subfile and fills it using search criteria.
- Blanks out search text after use.

### **subfile (Subfile Processing)**

- Toggles the search field indicator.
- Loops through displayed subfile records (using `readc`), allowing the user to select an entry.
- If a row is selected (`b1valg = 1`), retrieves project and customer data into the parameter variables using CHAIN, and may trigger additional logic to gather project or underproject info, including calling external programs (`RP601R`, `RP605R`).
- Once a valid selection is made, exits loop.

### **clr_subfile**

- Activates indicator to clear the subfile (indicator 14).
- Resets record number trackers.

### **crt_subfile**

- Updates page counters.
- Depending on search mode and open search:
  - Prepares and opens an SQL cursor for the search.
  - Fetches database rows into working variables.
  - Applies additional search word filtering (up to 5 search words), skips entries not matching all words.
- Ensures only valid/active entries are returned (unless toggled to show all).
- Writes each valid record to the subfile for display.
- Calls `newlo_vask` to clean up data for Newlook compatibility if needed.
- Updates subfile tracking variables.

### **dsp_subfile**

- Prepares the subfile screen for display.
- Handles display indicators and feedback.

### **newlo_vask**

- Runs through the subfile fields (name/address), removing periods and colons from the end to prevent display issues with Newlook GUI clients.

---

## 6. **Key Handling**

- **Function Key Map:**  
  - `*INKC`, `*INKL` – Exit  
  - `*INKE` – Refresh  
  - `*IN10` – Page up  
  - `*IN11` – Page down  
  - `*IN21` – Home  
  - `*INKI` – Repeat search  
  - `*INKX` – Toggle active/inactive view

---

## 7. **Parameter List / Entry Parameters**

- When called as a subroutine or from another program, the following parameters are expected: company, customer, date, project code, name, address lines, contact info, project and underproject keys, etc.

---

## 8. **External Program Calls**

- **AS700R:** Used to parse and split the search string into up to 5 search words.
- **RP601R, RP605R:** Used to fetch project and underproject details (called when the user selects a project and if subproject info is relevant).

---

## 9. **Special Logic & Notes**

- Support for both native and SQL access (for searches).
- Uses subfiles for paged display, so the user can scroll through results.
- Cleanses output data for downstream GUI compatibility (Newlook).
- Several enhancement and customer-specific modifications have been documented (see program history).
- Norwegian comments and terminology ("kunde"=customer, "prosjekt"=project, "søk"=search, etc.).

---

## 10. **Summary**

**FL501R** is an interactive RPG subfile program for advanced customer project lookups and selection, with robust support for search, paging, data hygiene for GUI interaction, and adaptable logic for project/subproject expansion. The code is modular, with extensive use of subroutines for clarity and maintainability, and well-documented in both code and comments for future onboarding.