# NN710R – Nettbutikk, eksport av vareinformasjon

## Purpose and Overview

**NN710R** is a batch RPG program responsible for exporting product (item) information from the ERP system to an external file (presumably for use by a web shop or third-party system). The export includes product master data, groupings, units of measure, and pricing, all formatted into a specific, semicolon-separated record layout.

The program is highly parameterized and supports a wide range of business rules and filtering options. It has a long history of enhancements, as evidenced by the extensive change log, and is designed to support a complex product and pricing structure, including support for multiple units, price groups, logistics, and handling of obsolete or special items.

## High-Level Structure

1. **Initialization**
   - Reads configuration and key parameters from the Local Data Area (LDA).
   - Validates that required data (web shop and owner) exists.
   - Sets up runtime variables (firm, warehouse, date, etc.).
   - Loads the price group and checks for special runtime flags via external calls.

2. **Header Output**
   - Writes out message header, start, and organization records to the export file.

3. **Main Processing**
   - Exports product group (category) hierarchy.
   - Exports product master data, including units and prices, applying all relevant business rules and filters.

4. **Trailer Output**
   - Writes out a trailer record, including a segment count.

## Key Data Sources and Relationships

- **Master files for product, group, unit, price, warehouse, supplier, etc.** are accessed via renamed file definitions to allow multiple logical views.
- **Export file (`netvarer`)** is written in a flat, semicolon-delimited format, with each record type (header, item, unit, price, etc.) defined via a data structure.

## Domain-Specific and Non-Obvious Logic

### Filtering and Product Inclusion

- **Products are only included if:**
  - They are either stock or "orderable" items in at least one warehouse.
  - Obsolete products are only included if there is positive stock.
  - Products with descriptions starting with `*` are excluded.
- **Special handling for units:**
  - Sales units are output in ascending conversion factor order.
  - Calculation units (M2, M3, KG, LTR) are always output last, regardless of their conversion factor.

### Group Hierarchy

- The program walks through the product group hierarchy, outputting both "overgroup" and "main group" records, then attaches textual descriptions.
- If a referenced group does not exist, the product is omitted and a message is written to an error log.

### Units of Measure and Pricing

- For each product, all associated units are exported, with a preference for sales units.
- For each unit, price lookup is attempted in the following order:
  1. Warehouse-specific supplier
  2. Main supplier
  3. No supplier (fallback)
- If no price is found for a unit, it is still exported, but without price.

### Obsolete and Logistic Items

- The program checks multiple sources for obsolete status, including warehouse-specific expiry dates.
- Additional logic is present for "logistics" items, including extended attributes (NOBB, MODN, LVAR, NLEV) via SQL fetch from `vvlepf`.

### External Integrations

- Calls to other programs:
  - **VE712R**: For EAN (barcode) lookup.
  - **VL711R**: For price group lookup.
  - **CO402R**: For runtime configuration (e.g., whether to output item type).
- SQL is used for extended attribute lookup (logistics items).

### Record Layouts

- Each output record type (header, item, unit, price, etc.) is defined as a data structure with fixed field positions and overlays, matching the required export format.
- All fields are separated by semicolons, and the layout is versioned (e.g., version 1.0 in the header).

### Error Handling

- If a required group or sub-group is missing, the product is omitted, and a descriptive error is logged to a separate file (`netvrapp`).
- The program sets a status flag (`p_stat`) to indicate error or partial completion.

## Design Patterns and Conventions

- **File Renaming**: Multiple logical files/views of the same physical file are used for different lookups, renamed for clarity.
- **Overlayed Data Structures**: Used extensively to build export records in memory before writing.
- **Extensive Use of Subroutines**: For logical separation (groups, items, units, prices, warehouse checks).
- **Change Log and Versioning**: The code is heavily commented with a change log, indicating careful version control and backward compatibility.
- **Parameterization via LDA**: Key runtime parameters are passed via the local data area, supporting batch and scheduled operation.

## Notable Business Rules and Details

- **Group and Subgroup Validation**: Ensures that all products are assigned to valid groupings; missing groups result in exclusion and logging.
- **Warehouse-Scoped Logic**: Many lookups and filters are scoped to a specific warehouse, supporting multi-warehouse environments.
- **Obsolete Logic**: Products are marked as inactive (`N`) if their expiry date is before the current date, from either the product or warehouse record.
- **Special Item Types**: The output of item type can be toggled at runtime via a control program.
- **Data Cleansing**: Semicolons in item texts are replaced with spaces to avoid delimiter issues in the export file.

## Key Subroutines

### vgrp

- Walks through product groups and main groups, outputting hierarchy records.

### varer

- Main item processing loop.
- Applies all product inclusion/exclusion rules.
- Outputs item master records, including group texts, supplier info, EAN, and price code descriptions.
- Calls subroutines for units and prices.

### enheter

- Processes all units for a product.
- Ensures calculation units are always last in the export.
- For each unit, attempts to find and output price in prioritized order.

### priser

- Price lookup for a given product, unit, and supplier.
- Tries with and without price group.
- Formats price for output.

### sjekk_lager

- Checks warehouse records for item type, expiry, and stock.
- Determines if the product should be included based on these attributes.
- Fetches extended "logistic" attributes if applicable.

## Interactions with Other Modules

- **VE712R**: EAN code lookup.
- **VL711R**: Price group determination.
- **CO402R**: Runtime configuration/feature toggling.
- **SQL query against `vvlepf`**: Fetches logistics-related item attributes.

## Special Considerations

- **Backward Compatibility**: The program is designed to be robust against missing or incomplete data, always preferring to skip problematic records and log an error rather than fail.
- **Export Format Stability**: The use of overlayed data structures ensures the output format remains stable and versioned, which is critical for downstream consumers.
- **Runtime Feature Flags**: Ability to toggle features (e.g., item type output) at runtime via external configuration.

---

## Summary

NN710R is a robust, highly parameterized export utility for product master data, tailored for integration with web shop solutions. It incorporates complex business rules for product inclusion, group validation, unit and price prioritization, and extended attribute handling. The codebase is heavily versioned and annotated, reflecting its long-term evolution and critical business role in the product data supply chain. 

When onboarding, pay special attention to the business rules around filtering, group validation, and unit/price handling, as these are central to the program’s operation and are tightly coupled to the specific requirements of the downstream consumer systems.