## Program Overview: LI730R (Oppdatering av Faktura / Invoice Update)

This program is a central part of our inbound EDI invoice handling/process, which updates purchase order headers and lines based on information received via EDI messages. Its design orchestrates the translation of EDI invoice data into purchase orders in our internal system, integrates with supplier registries, manages product references, supports diverse tax/VAT code rules, and maintains historical traceability for auditing.

The program has evolved significantly, with a long history of domain-specific adaptations. Much of its logic is driven by changes in Norwegian construction supply industry standards (NOBB, GTIN), invoicing conventions, and integration best-practices.

---

### General Structure

- **Files:** The program works with a wide range of database files, most in update mode, corresponding to purchase order headers/lines, EDI intermediate registers, supplier, product, tax/MVA, and logistic/administration tables.
- **Parameters:** The main entrypoints are data structures which carry composite identifiers and control flags (immerse yourself in the usage of structures like `d_prec`, `p_prec`, which are overlays for the firm, document type, message numbers, etc.).
- **Main logic:** The program steps through initial EDI message validation, header update or creation, removal and recreation of all order lines per invoice, application of invoice lines and invoice-level corrections, recalculation, and archiving.

---

### Control and Business Logic

#### Indicator Conventions

- *LR* - End program
- *80-89* - Work indicators
- *90-99* - File indicators (CHAIN/READE/READ)

#### Line Numbering Convention

(See comments for explanation; e.g., 10xxx = header info, 20xxx = party info, 50xxx = invoice lines, etc.)

---

### File Interactions

- **lohelur/lodtlur/ledilur** etc: Main order header, order line, EDI workfiles (updated frequently)
- **ledil1/ledilr**: EDI “inbox” files carrying message header/line information
- **rlevl5**: Supplier registry (lookup on EAN-location number)
- **vvarl3/jvarl3**: Product master (primary/reference and administrative)
- **vmval1**: VAT/MVA code reference file

---

### Key Data Structures

- **d_fakl**, **d_fakh1..6** etc: Working layouts for EDI message fields (distinctly mapped for header, lines, references, parties, transport, etc.)
- **Key variables**: Mixing numeric and alphanumeric overlays allows flexible key building (e.g., order number + suffix)
- **w_* variables**: Working buffers for product, text, calculation, and integration

---

### Main Program Flow

1. **Initialization (`*inzsr`)**
   - Populates firm, pulls warehouse (lager) info, and stamps time
   - Positions message keys for header/lines in EDI files
   - Determines if EDI invoice archiving is required (CO402R switch logic)
   - Initializes data for update processing

2. **Validation (`sjk_meld`)**
   - Verifies message presence; if missing, returns error.
   - Iterates invoice lines, checking price/rabatt relationships for consistency with EDI standards.

3. **Header Update or Creation**
   - If the order header exists (matched by keys from EDI), update; else, build new.
   - Updates header with values from EDI, including supplier lookup by EAN, calculation of balances, assignment of VAT code.
   - Assigns or increments accounting/bilagsnummer as needed by business rules.
   - Updates back references into the EDI workfiles for traceability.

4. **Order Line Handling**
   - **Delete:** All existing PO lines belonging to the order (preserving references as possible).
   - **New Lines:** For each EDI invoice line, builds and inserts new order line:
     - Looks up product info by NOBB/GTIN, falling back to EDI values if not found.
     - Applies pricing/billing rules, using a standardized method for handling complex surcharges/deductions (the `finn_pris` subroutine).
     - Copies across relevant text, quantities, MVA rules, links to references, etc.
     - Handles multiple pricing and VAT code rules in a very flexible, extensible way.
     - Modular code for handling “tillegg/fradrag” (invoice-level additions/deductions) as order lines, using tailored NOBB codes.

5. **Order Recalculation**
   - Triggers downstream program (`LO730R`) to recalculate PO header totals after line changes.

6. **Order Type Adjustment**
   - Optionally shifts the order type in accordance with invoice type code (distinct handling for invoice vs. credit-note), with fallback to hardcoded types if not in registry.

7. **Invoice Print or Archival**
   - Based on control parameters, can initiate print or archive of the processed invoice/order.
   - EDI archiving method can be controlled by switch and is offloaded to external CL/RPG “archive” programs.

---

### Product and Reference Resolution

- **Item identification:** Priority given to precise matching via NOBB number. If NOBB is missing, attempts lookup by GTIN code (via external program, `VE717R`), with schedules and fallback to alternate master files.
- **Fallback/Administrative handling:** If no internal or admin match found, uses values from EDI message directly (with appropriate group defaults).
- **GTIN/NOBB logic:** Highly dynamic -- designed to accommodate supplier or EDI senders providing partial or idiosyncratic data.

---

### VAT/MVA Code Handling

- **Rules evolve:** There are several generations of logic present (see version notes).
- **Conditional path:** MVA code (`ldomva`) assignment can depend on:
  - Explicit value in EDI file,
  - Internal company flag (lomkod),
  - Master file lookup based on item group,
  - “Hardcoding” for known scenarios.
- **Fallbacks follow business conventions.**

---

### Special/Non-obvious Design Patterns

- **Line reference preservation:** Attempts to minimize disruption to customer order references even if matches must be dynamically reassigned.
- **Data overlays:** Many buffer data structures use overlays for performance, and to facilitate mapping between EDI message fields, internal keys, and file layouts.
- **Line numbering:** Order and EDI files use strict line number increments (by 10), which is enforced throughout, ensuring consistency for updates and reference matching.

---

### Integration

- **Multiple subprograms** are called for external tasks:
  - **AS100R:** Assigns next free order/invoice number.
  - **LO600R:** Printing/Outputting invoices.
  - **VE717R:** GTIN / NOBB resolution.
  - **CO402R:** Controls EDI invoice archiving workflow.
- **SQL used** for certain advanced product lookups (e.g., for "logistics item" resolution).

---

### Reference Data and Constants

- **NOBB numbers** hardcoded for certain addition/deduction line types, matching construction supply standards.
- **Group/category fields** populated based on standard, but with fallback for EDI-supplied values.

---

### Patterns for Maintenance

- **Extensive business comment history.** Modification notes are detailed and should always be reviewed if expanding or adapting code.
- **Switches and feature toggles** (see u_802 and similar): sometimes new logic is guarded by a parameter or feature flag, left in-code until all customers/sites are migrated.

---

### What’s Expected of a New RPG Developer Here

- Familiarize yourself with the sequence: EDI validation → order header update/creation → delete order lines → create new lines (from both detail and addition/deduction sections) → recalc and finalize.
- Learn our company’s product, supplier, and order referencing conventions, especially around NOBB/GTIN logic.
- Be aware: much of this code expects domain knowledge about Norwegian building supplies/invoicing, Norwegian tax law, and industry registries.
- When making changes, consult both code comments **and** the live database/file dictionaries for detailed field semantics, as many overlays and data structures are reused in complex ways.
- Always run regression tests on full range of EDI cases (credit note, addition/deduction, missing references, partial/incorrect GTIN), as business rules have many case-by-case overrides.

---

## Summary

This program is the backbone of EDI invoice-to-order update in our system. It encapsulates decades of business law, EDI standards, supplier conventions, and corporate exceptions into a robust, extensible update sequence. Code maintenance and enhancement should be approached with respect for the many business subtleties embedded in its layers.

**Do not hesitate to ask domain experts for clarification when dealing with pricing rules, VAT code assignment, or product identifier logic -- these are less obvious than simple RPG programming conventions.**