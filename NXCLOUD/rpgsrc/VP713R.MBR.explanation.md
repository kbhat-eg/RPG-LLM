# RPG Program VP713R - Explanation & Onboarding Guide

---

## 1. Program Overview

This RPG (ILE RPG III/400) program, **VP713R**, is designed to **retrieve product pricing information** for up to three sales units with supplier selection and promotional price handling.

- **Main Use Case:**  
  Given a company, item, supplier, price group, delivery type, date and time, and a flag for "main supplier," the program returns:
  - Unit, sales price, store price, cost price, and purchase price for unit 1
  - Unit, sales price, store price, and conversion factor for units 2 and 3 (relative to unit 1)
  - Price date for each unit
  - Promotion (Kampanje) periods and prices
  - Purchase unit and price comparison unit

- **Files Used:**
  - **vvprl1, vvenl2, vvenl4, vtill1, vvarl1, vugrl1**
  - These files reference product price, product unit, promotions, product master, and product group data.

---

## 2. Main Input and Output Parameters

**Inputs:**
- `p_firm`: Company number
- `p_vare`: Item number
- `p_ldor`: Supplier number
- `p_prgr`: Price group
- `p_lety`: Delivery type
- `p_dato`: Date (YYYYMMDD)
- `p_time`: Time (HHMMSS)
- `p_hlev`: Flag if the main supplier's price must be used (1=yes)

**Outputs (among others):**
- `p_enh1`, `p_enh2`, `p_enh3`: Unit codes for units 1, 2, 3
- `p_sap1`, etc.: Sales price
- `p_bup1`, etc.: Store price
- `p_kop1`, etc.: Cost price
- `p_pda1`, etc.: Price date
- `p_tip1`, `p_tip2`, `p_tip3`: Promotional prices
- `p_enin`: Purchase unit
- `p_enps`, `p_pspr`: Price comparison unit and its price

---

## 3. Main Processing Flow

1. **Initialization (`*inzsr`):**
    - Input parameters are loaded and moved to working variables.
    - Output parameters are initialized to default/blank/zero values.
    - Working date/time are set, using the current date/time if not provided.

2. **Read Product Master:**
    - Checks if the item exists in the product master (`vvarl1`).  
      If not found, the program ends.

3. **Read Sales Units (Loop for up to 3 units):**
    - Loops through possible sales units for the product (from `vvenl2`).
    - For each, retrieves price from the price table (`vvprl1`) using subroutine `hent_pris`.
    - Tries main supplier or requested supplier, depending on `p_hlev`.

4. **Calculate Volume Conversion Factors:**
    - For unit 2 and 3, sets conversion factor relative to unit 1.

5. **Retrieve Promotional Prices:**
    - Reads the promotions file (`vtill1`) to find matching promotional price (if any) for the item.
    - If not found, tries combinations with delivery type 0, blank price group, or item group instead of item number.
    - Calls subroutines `bestem_tilb`, `tilb_sjekk`, and `hent_tilb` as needed.
    - If found, outputs applicable promotional price(s) and details.

6. **Calculate Cost Price if Needed:**
    - If cost price is zero, calculates it using the product's or product group's "DG-%" (cover %).

7. **Purchase and Comparison Units:**
    - Determines first purchase unit from `vvenl4`.  
    - Determines price comparison unit, preferably from the product, otherwise from the product group.

8. **Set Price for Comparison Unit:**
    - Assigns the proper sales price for the comparison unit.

9. **End Program:**
    - Sets LR and returns.

---

## 4. Key Subroutines

### a. `hent_pris`
**Fetches price for a sales unit** from the price register (`vvprl1`), with various fallback strategies if the initial search fails:
- 1st: by input delivery type/price group
- 2nd: by delivery type zero
- 3rd: by price group blank (with and without delivery type zero)

For each match, fills in unit and price details in the output parameters.

---

### b. `bestem_tilb`
**Populates promotional period and promotional prices** for matching units, if a qualifying promotion is found.

---

### c. `tilb_sjekk` and `hent_tilb`
**Search alternative promotion possibilities**:
- Tries to find promotions at item group / supplier level and with various combinations of delivery type and price group.
- Calls `hent_tilb` which checks the promotion register for an active promotion.

---

## 5. Key Data Access Patterns

**Chain** operations use constructed keys (company, item, supplier, price group, unit, delivery type, etc.) to retrieve single records.  
**Setll/Reade** is used for sequential (loop) retrieval within a certain key range (eg. loop through all sales units for a product).

---

## 6. Fallback Hierarchy

When seeking prices or promotions, the program follows a fallback pattern:
- Look for exact match (item, price group, delivery type)
- Try delivery type 0
- Try price group blank
- Try item group in place of item number (with supplier, group, delivery type, etc.)
- Use most recent available if no active promotion

---

## 7. Notable RPG Idioms

- **Use of Indicator *INxx**:  
  `*in90`/`*in91` are used to detect EOF or record-not-found after read operations (READE/CHAIN).

- **Eval(H)**:  
  Used for half-adjust mode (evaluate with result half adjusted, for decimals in division).

- **Select/When/Endsl**:  
  Used for multi-case selection (like switch/case).

- **Plist/Parm**:  
  Used for defining the subroutine interface and parameter passing.

---

## 8. Maintenance Notes

- The program is heavily commented (in Norwegian) with revision history.
- Many enhancements have been made to support more flexible pricing and promotions.
- Some sections are commented out for conditional functionality, especially relating to supplier priorities.
- Field names are often abbreviated; refer to file definitions (DDS) for field descriptions.
- Modifications may be needed if underlying file structures change (e.g., add more units, promotion types).

---

## 9. Summary

**VP713R** is a complex, business-critical backend program that handles product pricing, unit conversion, and promotional pricing for Norwegian retail/wholesale environments. Its logic ensures the best price information is returned for any item/unit/supplier combination at a given date and time, including backup strategies when standard prices or promotions aren't found.

---

### For Developers

- **Understand the data model** (files and fields) and business rules for price calculation and promotions.
- Get familiar with the subroutine structure and fallback logic.
- Before changing, check how the change might affect pricing fallback and promotion lookup.
- If you add new units, suppliers, or pricing rules, carefully update the key building logic and corresponding subroutines.

---

**If you have questions about a specific section or file structure, consult the DDS for the referenced files or ask a senior analyst for business rule clarifications.**