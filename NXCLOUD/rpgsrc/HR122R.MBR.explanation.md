# RPG Program Explanation: HR122R (Batch Number Inquiry, Radio Terminal)

## Overview

This RPG/400 (ILE RPG) program, named `HR122R`, is designed for **batch number inquiry** via a radio terminal. It primarily interfaces with a display workstation and a batch file. The program utilizes subfiles to display and manage batch numbers, providing the user functionality to scroll, position, and select batches.

The language in comments appears to be Norwegian.

---

## Sections

### 1. File Declarations

```rpg
flbchl1    if   e           k disk    rename(lbchpfr:lbchl1r)
fhr122d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- **lbchl1**: Physical file for batch records, keyed.
- **hr122d**: Workstation display file, using subfile `b1sfl` driven by relative record number `w_srrn`.

---

### 2. Data Definitions

```rpg
d p_firm          s                   like(lcfirm)
d p_batc          s                   like(lcbatc)
d lbchl1_batc     s                   like(lcbatc)
...
d w_spge          s              4  0
d w_srrn          s              4  0
...
d c_sfil          s              2  0 inz(7)
```
- **Parameters**: `p_firm`, `p_batc` - company code and batch number input.
- **Key Variables**: Used for file positioning.
- **Subfile Variables**: 
  - `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn` for page/record management in the subfile.
- **Constant**: `c_sfil` (value 7) - subfile page size.

---

### 3. Indicator Usage (from comments)

- **LR**: Last record â€“ signals program end.
- **10, 12, 13, 14, 15, 16, 21, 22, 30, 31-79, 80-89, 90-99**: Status, error, control, and file indicators. For example, 16 signals end of subfile, etc.

---

### 4. Main Control Flow

#### Main Loop Tags

- `b2taga` and `b2tagb` are main control jumps.
- Main loop alternates between command display and subfile processing.

#### User Input Handling

```rpg
c     select
c     when      *inkc         (F3=Exit)
c     goto      avslutt
c     when      *inke         (F5=Refresh)
c     exsr      forny
c     goto      b2tagb
c     when      *in10         (Roll/Next-page)
c     exsr      crt_subfile
c     goto      b2tagb
c     endsl
```
- **F3/Exit**: End program.
- **F5/Refresh**: Refresh subfile (calls `forny`).
- **F10/Roll**: Read next page in subfile.

#### Positioning

- If the batch number entry (`b2batc`) is given, position subfile to that batch.

---

### 5. Subroutine Explanations

#### **forny** (Refresh subfile)

- Resets file pointer (`setll`), clears subfile (`clr_subfile`), creates subfile (`crt_subfile`), positions cursor (`*in22`).

#### **posisjoner** (Position on batch)

- If batch number is entered:
  - Assigns it to key var, positions file, then clears and fills subfile accordingly.

#### **subfile** (Handle subfile)

- If a record is selected in the subfile (`b1valg = 1`):
  - Batch is set as output (`p_batc`), `b_valg_ok` is set to *on, and loop leaves for exit.
- Reads each record in the displayed subfile until end or selection.

#### **clr_subfile** (Clear subfile)

- Activates subfile clear indicator, outputs control record, and zeroes subfile counters.

#### **crt_subfile** (Create/fill subfile page)

- Increments page size.
- Reads batch records one by one until page full or end of file.
- Only includes records with `lcsper = 0` (unlocked?).
- Populates subfile display variables.

#### **dsp_subfile** (Display subfile)

- If subfile not empty, sets display indicator and shows subfile.
- Otherwise, shows command panel instead.

#### **\*inzsr** (Initialization)

- Reads input parameters.
- Positions the file to start and fills the subfile.

---

## 6. Workflow Summary

1. **Initialization**: Receives parameters (`firm`, `batch`), positions data, prepares subfile view.
2. **Display Main Screen**: Shows options to user.
3. **Handle Keys**: User can scroll, enter batch number to position, refresh, or exit.
4. **Subfile Handling**: Fills subfile with batches for display and selection.
5. **Batch Selection**: When user selects a batch, program captures it and exits.
6. **Exit**: Releases resources and ends program.

---

## 7. Subfile Management

- Uses subfile for batch records with paging (7 records per page).
- Allows positioning directly to a batch number for fast lookup.
- Handles dynamic refresh and navigation.

---

## 8. Key Variables & Indicators

- **Batch selection:** `b1valg` field; `b_valg_ok` controls whether user made a valid selection.
- **Indicators:** Used extensively for subfile and display file logic (`*in12`, `*in13`, etc.)
- **Subfile Counters:** `w_srrn`, `w_sfrn`, `w_ssrn`, `w_spge` for managing which records are displayed.

---

## 9. Error Handling

- Error and status management largely handled via indicator settings and write/exfmt to subfile or control records.

---

## 10. Customization/Extension

- You can modify subfile page size, add more function keys, or change which records are presented (i.e., filter conditions).

---

## 11. Screen Structures (from comments)

- **B1SFL**: Main subfile record format.
- **B2CTL**: Subfile control panel.
- **B2CMD**: Command input screen (for function keys, etc.)

---

### In summary

This is a classical RPG program for subfile management and inquiry, designed for efficient batch lookup and selection, employing strong use of indicators, subfiles, and modular subroutines for clear structure and maintainability.