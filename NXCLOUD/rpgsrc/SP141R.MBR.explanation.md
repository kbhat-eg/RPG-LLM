# RPG Program SP141R â€“ "ASSTAT Selection to Parameter File, From/To Period"

This program is written in RPG/400 (also known as RPG III), primarily using fixed-format D- and C-specs. Its purpose is to display a screen for the user to select a "from" and "to" period, validate the selection, and update a parameter file accordingly.

---

## 1. **File Declarations**

```rpg
fsp141d    cf   e             workstn
fskpml1    if   e           k disk    rename(skpmpfr:skpml1r)
fskpmlu    uf a e           k disk    rename(skpmpfr:skpmlur)
```
- **sp141d**: Display file (workstation), used for user interaction (`cf`).
- **skpml1 / skpmlu**: Physical files, one for input (`if`), one for update (`uf`), both externally described and both using keyed access. The records are renamed for local reference in this program. Likely, one is used for reference/look-up, and one for maintenance.

---

## 2. **Data Declarations**

```rpg
d wptype          s                   like(sptype)
d wptext          s             30
d wwfirm          s                   like(spfirm)
d wwtype          s                   like(sptype)
d wwkode          s                   like(spkode)
```
- **wptype, wptext**: Hold parameter values coming from another program.
- **wwfirm, wwtype, wwkode**: Work variables for key fields.

```rpg
dwwrest           ds           330
d wwtext                  1     30
d wwfper                 31     36  0
d wwtper                 37     42  0
```
- **wwrest**: Data structure for storing a record image (text, from period, to period).

```rpg
d wwvalg          ds
d  wwfyll                 1     15
```
- **wwvalg/wwfyll**: Likely used as part of the key.

```rpg
d                uds
d dsuser                911    920
d dsfirm                944    946  0
d l_fnav                951    980
```
- **UDS**: User data structure, extracting subfields such as user, firm, etc., from the program status data structure.

---

## 3. **Mainline Logic**

### a. **Initialization (`*inzsr` subroutine)**

- Sets up key fields for file access.
- Receives parameters from the calling program.
- Initializes fields for the session.

### b. **Program Loop**

#### 1. **Tag b2tagb**

- Builds the key from `wwfirm`, `wwtype`, `wwkode`, and `wwvalg`.
- **`chain key01 skpml1`**: Attempts to retrieve an existing parameter record.
    - If found (`*in60 = *off`):
        - Copies details into work variables for display.
    - If not found (`*in60 = *on`):
        - Sets the periods to zero.

#### 2. **Tag b2taga**

- Presents the entry/display format (`exfmt b2bld`), prompting user input.

- Checks for function key exits: `*inkc` and `*inkl` (function keys, e.g., F3/F12).
    - If pressed, goes to program termination.

- **Validation**
    - If "from" period is greater than "to" period, reprompt.
    - If "from" period is not zero and is less than 195000 (possibly invalid), reprompt.

- After validation, attempts to find the record in the update file (`skpmlu`). Updates work variables from the user input.

- **If record exists (`*in60 = *off`):**
    - If both periods are zero, delete record (interpreted as "remove selection").
    - Otherwise, update the record.

- **If no record (`*in60 = *on`):**
    - Writes a new record to the file.

### c. **Termination (Tag xslutt)**

- Set LR indicator (`*inlr = *on`), ending the program and closing files.

---

## 4. **Keylist and Parameter List**

```rpg
c     key01         klist
c                   kfld                    wwfirm
c                   kfld                    wwtype
c                   kfld                    wwkode
c                   kfld                    wwvalg
```
- Defines the key structure for file lookup.

```rpg
c     *entry        plist
c                   parm                    wptype
c                   parm                    wptext
```
- Receives passed-in parameters from the calling program.

---

## 5. **Screen and Field Interaction**

- The display file defines the screen layout (not included here), presented with `exfmt b2bld`.
- User input is validated and then written to or updated in the parameter file.

---

## 6. **Overall Flow**

1. **Initialize fields and parameters.**
2. **Try to load parameters for the user's current firm/type/kode/valg.**
3. **If found, show them; if not, show blank/zero values.**
4. **User enters/edits the from and to periods; values are validated.**
5. **Update, insert, or delete the parameter record as required.**
6. **Return to prompt if there are errors, or exit if the user presses F3/F12.**

---

## 7. **Key Concepts**

- **Keyed file access** is central: program operates on a per-firm/type/kode/valg basis.
- **Data validation** is done before file update.
- **Parameter file maintenance**: deletes record if both periods are set to zero.
- **Program is structured** using labels/tags instead of free-form loops or subprocedures.

---

## 8. **Typical Use Case**

- As a batch or interactive utility to maintain a parameter file for reporting or processing, specifying valid accounting or time periods (from/to) for a specific type of data.
- Called from another program (parameters), picks up the current firm/user context, allows the user to adjust the valid selection periods, and persists the user's choice.

---

> **Summary**:  
This RPG program is a small, interactive utility for maintaining period selection records in a parameter file, with keyed access, user entry/validation, and update/delete/write support. It displays a "from/to" period selection window, ensures the values are valid, and stores/removes this information tied to firm/type/kode/valg as appropriate.