# RPG Program: Kontroll av Gyldig Prosjekt (`RS880R`)

This ILE RPG program checks whether a given project and its possible subproject are valid. The program is written in a classic fixed-format RPG IV style and is designed to be called from other programs, providing information on the validity of a project and returning descriptive messages.

---

## Overview and Purpose

- **Program Name:** RS880R
- **System:** ASOKON
- **Description:** Validates (kontroller) if a supplied project number (and optional subproject) is valid, exists, and is not closed.
- **Main Output:** Return code and project text/message.
- **Return Codes:**
    - `N` = Project not found.
    - `S` = Project is closed.
    - `X` = Error with subproject.
    - Blank = Project found and open.

---

## File Definitions

```rpg
frp1pl1    if   e           k disk    rename(rp1ppfr:rp1pl1r)
frp2ul1    if   e           k disk    rename(rp2upfr:rp2ul1r)
```
- **rp1pl1/rp1pl1r:** Main project file/record format.
- **rp2ul1/rp2ul1r:** Subproject file/record format.

---

## Data Structures and Work Fields

### Fields and Arrays

- **txt:** Array of 3x30 characters, loaded from compile-time data (`ctdata`). Holds error messages.
- **p_firm, p_pros, p_pupr:** Work variables for firm, project, subproject.
- **p_retk:** Return code (length 1).
- **p_txt1, p_txt2:** Return text fields for project description/messages.

### Work Fields

- **w_firm:** Current firm number (copied from global field).
- **rp1pl1_pros, rp2ul1_pros, rp2ul1_pupr:** Work fields for keys during file access.

### User Data Structure (`uds`)
- Holds user, firm, and other common info, mapped from input buffer.

---

## Parameter List

```rpg
c     *entry        plist
c                   parm                    p_retk
c                   parm                    p_pros
c                   parm                    p_pupr
c                   parm                    p_txt1
c                   parm                    p_txt2
```
- **p_retk:** Output return code.
- **p_pros:** Input project number.
- **p_pupr:** Input subproject number (optional).
- **p_txt1:** Output project text/message 1.
- **p_txt2:** Output project text/message 2.

---

## Main Logic

### Initialization

1. **Firm Number:** Sets `w_firm` from `l_firm`.
2. **Clear Outputs:** Sets return code and text fields to blank.

### Project Validation

3. **Set Key:** Loads `rp1pl1_pros = p_pros`.
4. **File Chain (Project):** Performs a `CHAIN` (keyed lookup) on the project master file, flag set in indicator 60.
5. **File Chain (Subproject):** If `p_pupr` (subproject) is not blank, sets up subproject key fields and does `CHAIN` on subproject file, indicator 61.

### Validation Outcomes

#### If Project Not Found:
```rpg
if *in60 = *on
  move 'N'  p_retk
  move txt(1) p_txt1
  goto slutt
endif
```
- Sets return code = 'N' (Not Found)
- Sets message: "PROSJEKTNUMMER ER UGYLDIG" (from txt(1))
- Ends program

#### If Subproject Not Found:
```rpg
if *in61 = *on
  move 'X'  p_retk
  move txt(3) p_txt1
  goto slutt
endif
```
- Sets return code = 'X'
- Sets message: "FEIL UNDERPROSJEKT" (from txt(3))
- Ends program

#### If Project Found:
- (Commented) Code to check if project is "sperret" (blocked/closed), which would set return code to 'S' and message: "PROSJEKTET ER AVSLUTTET" (txt(2)) -- this is currently commented out.

- **Otherwise**, returns project text:
    - `p_txt1 = rp1txt` (project description)
    - `p_txt2 = rp1tx2` (extra info)
    - If a valid subproject exists, `p_txt2 = rp2txt` (subproject description).

---

## Ending the Program

```rpg
c     slutt         tag
c                   eval      *inlr = *on
c                   return
```
- Sets *last record* indicator to close files and exit with returned values.

---

## Subroutines

### *INZSR (Initialization Subroutine)

- Defines key lists for chained file access for both main project and subproject files.

---

## Compile-time Array `txt`

At the end, the `ctdata` block fills the `txt` array with the error messages used for validation:

```
PROSJEKTNUMMER ER UGYLDIG
PROSJEKTET ER AVSLUTTET
FEIL UNDERPROSJEKT
```

---

## Key Takeaways for Onboarding

- This program is a **validation routine** for projects and subprojects.
- Primarily used as a **subroutine** or **validation module** in larger systems.
- **Inputs:** Project and (optionally) subproject number.
- **Outputs:** Status code (`N`, `S`, `X`, or blank) and descriptive text.
- Error and status messages are **parameter-driven** and returned to the caller.
- **File structure:** Assumes master files for projects and subprojects keyed by firm, project, and subproject.
- To extend: implement the "project closed" check by uncommenting the relevant code.

---

## Usage Pattern

Call RS880R program with appropriate parameters and interpret the return code and message fields to know if a project (and possibly its subproject) is valid and active. The logic is structured for clear error handling and is adaptable for further business rules.