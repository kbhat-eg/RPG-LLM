# RPG Program Walkthrough and Explanation

This RPG program (JM551R) is an interactive database inquiry and selection screen for "kampanjevarer" (campaign items), structured to display and maintain data using subfiles (scrollable lists in 5250 green-screen interfaces). It is tailored for IBM i (AS/400, iSeries) using the traditional ILE RPG. The code is heavily commented in Norwegian, and uses traditional indicators and DS (Data Structure) for screen and file IO handling.

---

## 1. **Header and Metadata**

- `h option(*nodebugio) datedit(*dmy)`  
  - Source options: disables debug IO, sets default date format to ddmmyy.
- Extensive comment block describes purpose, change history, and indicator use.

---

## 2. **File Declarations (`F` specs)**

- **Database Files:**  
  These files are all externally described (from DDS) and are renamed locally for clarity.
    - `jkavlr`, `jkavl1`, `jkavl2` – Campaign item master files (with different logical views).
    - `jvarl1` – Item master, for item texts etc.
    - `jlevl1` – Vendor master, for supplier names etc.
    - `jkavlu` – Update file (for writing/maintaining campaign-item links).
- **Display File:**  
  - `jm551d` – The workstation display, using subfile `b1sfl` and including a feedback DS (for cursor/field control).

---

## 3. **Data Structure and Variable Declarations**

- **Parameters / Local Data Area:**
  - `p_firm`, `p_kamp`, `p_tkam`, `p_prgr`, `p_user` – Program parameters for firm, campaign, target campaign, price group, user, etc.
  - Local data area (LDA) fields (e.g., `l_fnav`) for miscellaneous local information.
- **Feedback DS:**  
  - `dspfbk` contains the field for cursor record in input (for subfile cursoring).
- **Key Variables:**  
  - Variables used for building file keys for CHAINs/SETLLs.
- **Working Variables:**  
  - `w_fcrn`, `w_stel`, `w_spge`, etc. for subfile page/record pointers.
  - `w_seqe` for search sequence/criteria (e.g., 'V' for item number).
  - `w_navn`, `w_tek1`, etc. for data fetched for display.

---

## 4. **Explanation of Main Areas of Logic**

### **A. Main Program Loop**

#### **Screen Flow Tags**
- `b2taga`, `b2tagb`: Main entry and return points for the display cycle.

#### **Screen Write & Subfile Handling**
- Writes command screen (`b2cmd`).
- Calls subroutine to display subfile (`dsp_subfile`).

#### **Function Key Handling**
- Uses classic RPG indicator-based function key handling (`select`, `when` on *INxx):
    - *INKC/*INKL: Exit (goto avslutt).
    - *INKD: Inquiry (calls `spørring` subroutine).
    - *INKE: Refresh (calls `forny` subroutine).
    - *IN10: Page down in subfile (`crt_subfile`) then redisplay.
    - *IN11: Page up in subfile (`bck_subfile`).
    - *IN21: Home Key – sets cursor indicator *IN22.

#### **Positioning**
- If position parameters present (`b2vldo`, `b2vvar`), calls `posisjoner`.

#### **Processing and Exit**
- Calls `subfile` (process subfile records).
- `goto avslutt` for termination.

---

### **B. Subroutines**

#### 1. **Forny (Refresh Subfile)**
- Repositions file based on current subfile record, using either item number or supplier as a key.
- Calls `clr_subfile` and `crt_subfile` to clear and refill the subfile.

#### 2. **Posisjoner (Positioning in Subfile)**
- If supplier provided, sets up keys and positions to that supplier.
- If item number provided, positions to that item.
- Clears and rebuilds subfile, clears positioning fields.

#### 3. **Subfile (Process Subfile)**
- Toggles subfile cursor indicator.
- Reads back and processes subfile records with `READC` (read changed), cycling through possible selections (`b1valg = 1` for selected).
- If selected, chains to update and reference files; updates/creates links as needed.

#### 4. **clr_subfile (Clear the Subfile)**
- Sets indicators to clear subfile, writes control record, and resets working counters.

#### 5. **crt_subfile (Create/Fill Subfile)**
- Calculates new paging limits.
- Reads from the appropriate logical file, populating subfile screen fields with item/vendor data.
- On each record, fetches the item description and supplier name as needed.

#### 6. **bck_subfile (Page Back in Subfile)**
- Reads previous set of records using `READP` for page-up functionality.
- Populates subfile accordingly via `clr_subfile` and `crt_subfile`.

#### 7. **dsp_subfile (Display Subfile)**
- If subfile has data, sets relevant display indicators, presents control record, updates cursor position.

#### 8. **spørring (Inquiry/Prompt)**
- Handles requests for prompt screens on item or supplier numbers, calling relevant programs via `CALL`.

#### 9. ***inzsr (Initialization Subroutine)**
- Processes program entry parameters and initializes working variables and keys.
- Positions logical files to first record for the campaign.
- Primed subfile is filled for display.

---

## 5. **Key Handling and Data Access**

- **SETLL/CHAIN/READ/READC/READP:**  
  Classic DB operations for positioning, fetching, and updating records in IBM i DB2 tables.
- **Indicators:**  
  Used to track function key states, EOF, and subfile states as per RPG III/400 conventions.
- **Subfiles:**  
  - B1SFL: The list itself (records).
  - B2CTL: Subfile control record.
  - B2CMD: Command key screen.

---

## 6. **Business Logic in Subfile Population**

- Program can look up either by item or supplier (or both), presenting results in a scrollable list ("subfile") with support for paging up/down.
- Allows selecting an entry, which then triggers an update/add in linking tables.
- Has prompt support for lookup on item or supplier codes (via external `CALL` to lookup programs).
- Handles campaign, price group, user, and firm as key business parameters.

---

## 7. **Indicator Usage Highlight (per comments)**

- **LR** = Last Record (end of program)
- **10/11** = Roll Up/Down
- **12–15** = Subfile display/clear/ending
- **21/22** = Home and cursor
- **30** = Protect fields on view
- **31–99** = Various error/status/working indicators

---

## 8. **Modifications & Extensibility**
- The code has been changed over several versions, notably to support new GUI requirements and to expand fields (like price group).
- The structure is typical for green-screen subfile selection/maintenance programs and could be extended with more search keys or data as needed.

---

## 9. **Summary**

**This program is a classic IBM i (AS/400) subfile-based inquiry and selection/update screen for campaign items. It lets the user:**
- Search for items by item number or vendor,
- Page through results,
- Select items for linking or update to a campaign,
- Prompt for item or supplier codes,
- See additional item description and vendor name.

The program structure is modular with clearly separated subroutines for each key function (refresh, position, fill, clear, page, display, inquiry, initialization), and is thoroughly commented for maintainability.

---

**New developers should:**
- Familiarize themselves with the subfile concept in IBM i and function indicator usage.
- Understand the structure of key lists and data chain/set logic.
- Refer to the DDS source for the display file and physical/logical files to fully grasp field layouts and keys.