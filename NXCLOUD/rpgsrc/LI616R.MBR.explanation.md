```markdown
# LI626R – EDI Invoice Print Program

This ILE RPG program reads EDI invoice messages from database files (`GEDILR`, `GEDIL1`), formats them as either a traditional spool‐file print or as XML for Jasper/PDF output, and finally archives or emails the result.

---

## 1. H-Specifications

```rpg
H/TITLE  ASOFAK: Utskrift av EDI Faktura
H OPTION(*NODEBUGIO) DATEFMT(*DMY-) DECEDIT('0.')
H DFTAACTGRP(*NO) BNDDIR('CGIDEV2/CGIDEV2')
```

- **TITLE**: “ASOFAK: Utskrift av EDI Faktura”
- **No activation group**, no debug I/O.
- **Date format** = DMY, **decimal edit** = ‘0.’  
- **Bound directory**: `CGIDEV2/CGIDEV2`

---

## 2. File Definitions (F-Specs)

```rpg
FLOHEL1  IF   E           K  DISK  RENAME(LOHEPFR:LOHEL1R)
FLODTL1  IF   E           K  DISK  RENAME(LODTPFR:LODTL1R)
FGEDILR  IF   E           K  DISK  RENAME(GEDIPFR:GEDILRR)
FGEDIL1  IF   E           K  DISK  RENAME(GEDIPFR:GEDIL1R)
…
FLI616P  O    E             PRINTER
```

- **Input keyed files**:
  - `GEDIL1R` / `GEDILRR` hold message lines.
  - Other files provide lookup for orders, customers, company info.
- **Output**: printer file `LI616P` for spool-based printing.

---

## 3. Parameter Data Structure

```rpg
D d_prec       45          *OVERLAY:  
D  d_firm       3 0  OVERLAY(d_prec)
D  d_type       4    OVERLAY(d_prec:4)
D  d_mnum       8 0  OVERLAY(d_prec:8)
D  d_mlin       6 0  OVERLAY(d_prec:16)
D  d_biln       8 0  OVERLAY(d_prec:22)
D  d_kode       1    OVERLAY(d_prec:30)
```

- **`d_prec`** carries all inbound parameters.
- Overlays break it into:
  - `d_firm` (company),
  - `d_type` (message type),
  - `d_mnum` (message number),
  - `d_mlin` (message line),
  - `d_biln` (batch/document number),
  - `d_kode` (operation code).

---

## 4. Invoice Data Structures

### 4.1 Header DS (`d_fakh1`)
Fields for invoice header:  
```rpg
D d_fakh1      DS
D  d_fh_dtyp       3     // message type
D  d_fh_fanr      35     // invoice number
D  d_fh_ldat       D   DATFMT(*ISO)  // order date
…  
D  d_fh_forf       D   DATFMT(*ISO)  // due date
```

### 4.2 Addenda DS (`d_fakh2`, `d_fakh3`)
- **`d_fakh2`** = charges/discount lines  
- **`d_fakh3`** = free text lines  

### 4.3 Reference DS (`d_fakh4`)
Holds various invoice references: order, customer ref, KID, project no…

### 4.4 Part/Transport DS (`d_fakh5`, `d_fakh6`)
“Who is invoice to”, “delivery to”, “supplier” addresses and codes.

### 4.5 Line Items DS (`d_fakl`)
Detailed invoice lines: quantity, unit price, total, discount flags, VAT…

### 4.6 Totals DS (`d_fakt`)
Grand totals: net, VAT base, VAT amount, invoice total…

---

## 5. Local Data Area (LDA)

A 1 KB LDA block holds job-wide control values:
- `l_utqm` (output queue/mailer),
- `l_bach` (batch/job number),
- `l_arch` (archive flag),
- `l_mail` (mail flag),
- `l_ruti` (routine name),
- `l_outq`, `l_copy`, `l_avde` (archive department)…

---

## 6. Working Variables

- **Record‐key buffers** for chained `GEDIL1R/GEDILRR`.
- **Parameters** for Jasper/XML:  
  `p_mail`, `p_filg` (file group), `p_xmlf` (XML filename),  
  `b_pdfp` (use PDF), `b_topt/b_bott` (page headers/footers)…  
- **HTML/XML buffers**: `XML_Output`, `XML_Path`, `jasper_mal`, `jasper_logo`  
- **Helper variables** for date/time conversion, CRLF, and intermediate strings.

---

## 7. Main Control Flow

1. **Initialize** via hidden *INZSR:  
   - Set up key lists (`KLIST`),  
   - Load routine template (via `AFORL1R`),  
   - Load company info (`AFIRL1R`),  
   - Decide: **spool print** vs **XML/Jasper** (calls `AP609R`, `GetHTMLIFS`).

2. **Read EDI Header** (`chain GEDIL1R` at mlin = input),  
   Populate `d_fakh1` from `gimeld` (raw data).

3. **Set up print variables** (`a1fanr`, `a1fnav`, `a1fad1/2`, `a1fste`, …)  
   – logic picks non‐blank address lines in order.

4. **Party Info**:  
   `exsr PART_INFO` reads `GEDILRR` mlin 200000–300000 to fill invoice‐to, deliver‐to, supplier DS.

5. **Write Header**:  
   - If spool mode: `WRITE A1HDR`  
   - If XML mode: `EXSR XML_HEAD`

6. **Loop Free Text** (if enabled)  
   – read `GEDIL1R` between 650000–700000, `WRITE D1FTX` or `EXSR XML_DETA`.

7. **Loop Line Items**  
   - Read `GEDIL1R` between 500000–550000  
   - Map into `d_fakl` → `WRITE D1DET` or `EXSR XML_DETA`  
   - **Overflow** detection: when print area overflows, write new header.

8. **Footer & Totals** (`EXSR FAKT_AVSL`)  
   - Print blank lines, underline (`D3DET`), net sum, charges, VAT, invoice total  
   - Either via spool (`WRITE T1TOT`, `T2TOT`) or XML routines (`XML_NETTO`, `XML_CHARGES`, `XML_VAT`, `XML_TOTALER`).

9. **End Program**  
   - If XML mode: `EXSR XML_END`, maybe `CALL AP621R` to preview PDF in browser, then `CALL AB710R` to close job id.  
   - Set `*INLR = *ON`.

---

## 8. Key Subroutines

### 8.1 PART_INFO  
Reads `GEDILRR` lines for parts (200000–300000) and distributes address blocks into:
- Invoice recipient (`d_fh_part = 'BY '`),
- Delivery recipient (`'DP '`),
- Supplier (`'SU '`).

### 8.2 SR_6TEXT  
If a charge/discount has no text, supplies a default based on code (e.g. `'TRANSPORT'`, `'KAPPING'`, …).

### 8.3 FAKT_AVSL  
Prints the footer: blank lines, underline, net totals, each charge, VAT lines, and final invoice total.

---

## 9. XML/Jasper Integration

When XML mode is detected (`b_pdfp = *ON`):

1. **XML_ENVM**  
   - Writes environment tags: batch no, user, credentials, report command.

2. **XML_HEAD**  
   - Converts all header fields to XML-safe (`AP613R`),  
   - Calls `UpdHTMLVar`/`WrtSection` to build XML sections for heading.

3. **XML_DETA / XML_NETTO / XML_CHARGES / XML_VAT / XML_TOTALER**  
   - Each builds the detail, net, charges, VAT and total sections.

4. **XML_END**  
   - Writes closing tags,  
   - Writes the entire XML buffer to disk with `WrtHtmlToStmf`.

5. **Archive Commands** (if `l_arch = 1`):  
   - Adds meta tags (invoice no, amount, user, dates),  
   - Calls archive data‐queue (`AP629C2`) to notify sniffer for storage.

6. **PDF Preview**  
   - Optional `pdf_preview` calls `AP621R` to launch the generated PDF in the browser.

---

## 10. Job Logging and Error Handling

- Uses `AB705R` to log job status (start, errors) in transaction log.  
- Validates outq via `AP612R`, drawer via `AP611R`.  
- If output queue invalid, logs “Invalid outq” and falls back to archive only.

---

### Summary

LI626R is a classic multi-version ILE RPG printing utility that:

- Reads EDI message files via keyed access,
- Builds invoice header, line, and total records,
- Prints to either a traditional IBM spool file or assembles an XML structure for Jasper reports,
- Optionally emails or archives the result,
- Uses a mix of fixed‐format RPG for file I/O and subroutine logic, and `/FREE` code for HTML/XML generation.
```