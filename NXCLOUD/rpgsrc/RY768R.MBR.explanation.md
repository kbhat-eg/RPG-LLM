## Program Overview

**Program Name:** RY768R  
**System:** ASVADM  
**Purpose:**  
This program is a utility designed to clean up duplicate product records in the LVR (presumably a product ledger or reference file) caused by the incorrect use of NIB numbers instead of NOBB numbers. Specifically, it identifies records in the `JVARPF` file where the NOBB number (`jvnobb`) does not match the product number (`jvvare`) and invokes a deletion process for these records.

**Important Note:**  
This program must **not** be run for customers who use NIB numbers. It is only intended for customers where `jvnobb` equals `jvvare`.

---

## File Definitions

- **JVARL1**: Logical file over `JVARPF` (product master), renamed as `jvarl1r`.
- **VVARL1**: Logical file over `VVARPF`, renamed as `vvarl1r`.

These files are declared for keyed access (`k disk`), but in this program, only SQL is used to access `JVARPF`.

---

## Variables

- **b_inlr**: Flag (1 char), initialized to *off. Used to signal program end to called program.
- **w_vare**: Work variable, same type as `jvvare`. Holds the product number being processed.
- **w_firm**: Work variable, same type as `vvfirm`. Holds the firm/company number (not actively used in logic; always zero).
- **w_teller**: Counter (5,0), counts number of deletions performed.

---

## External Program Call

- **P_JV400R**: External program prototype.  
  - **firma**: Firm/company number (like `vvfirm`)
  - **vare**: Product number (like `jvvare`)
  - **inlr**: End-of-program flag (1 char)

This program is called to perform the deletion of the product from LVR.

---

## SQL Environment

- Sets the default SQL date format to *ISO for this session.

---

## Main Logic

1. **Initialization**
   - `w_firm` set to 0.
   - `w_teller` set to 0.

2. **Find Target Products**
   - Opens a SQL cursor (`vareNobbCursor`) selecting all `jvvare` from `jvarpf` where:
     - `jvnobb` is not zero,
     - `jvnobb` does not equal `jvvare`.
   - These records represent products where the NOBB number (official product number) does not match the product number field, indicating possible data entry using NIB numbers.

3. **Processing Loop**
   - For each product found:
     - Sets `b_inlr` to *on (to ensure called program ends after processing).
     - Calls external program `JV400R` to delete the product from LVR.
     - Increments `w_teller`.
     - (Commented-out test code: would exit after 10 deletions for testing.)

4. **Cleanup**
   - Closes the SQL cursor.
   - Sets *INLR on to end the program.

---

## Business/Domain-Specific Logic

- **Duplicate Product Cleanup:**  
  The business rule here is to remove products from LVR where the NOBB number does not match the product number, as this indicates erroneous data entry (NIB numbers used instead of NOBB). This is a data hygiene measure to ensure product master data integrity.

- **Customer Segmentation:**  
  The program must **not** be run for customers who use NIB numbers as their standard; it is strictly for those using NOBB numbers as the product key.

---

## Design/Implementation Notes

- **SQL vs Native I/O:**  
  Although logical files are declared, all relevant data access is performed via embedded SQL. This is likely for performance and flexibility in selecting records.

- **Externalized Deletion Logic:**  
  The actual deletion is performed by an external program (`JV400R`), which likely encapsulates all necessary business logic and referential integrity checks for removing a product from LVR.

- **Firm Number:**  
  `w_firm` is always set to zero in this program, which may be a convention in your system for "default" or "not applicable" firm context.

- **Test Harness:**  
  There is commented code to limit the number of processed records to 10, useful for safe testing in non-production scenarios.

- **Date Handling:**  
  The program enforces ISO date format for SQL operations, which may be required for consistency across the system or for compatibility with other modules.

---

## Interactions with Other Modules

- **JV400R:**  
  The only external dependency is the `JV400R` program, which must conform to the expected interface and handle the deletion logic safely.

- **JVARPF and VVARPF:**  
  Although both files are declared, only `JVARPF` is accessed in this program. `VVARPF` may be relevant in related processes or in the called program.

---

## Conventions and Patterns

- ***INLR Usage:**  
  Both local (`b_inlr`) and global (`*inlr`) end-of-program flags are used, following standard RPG program lifecycle management.

- **Prototypes and Strong Typing:**  
  Use of LIKE for parameter definitions ensures type consistency with database fields.

- **SQL-Driven Batch Processing:**  
  The program uses a SQL cursor to drive batch processing of records, a common pattern for data cleanup or migration utilities.

---

## Summary

This program is a specialized data cleanup tool for product master files, targeting records with mismatched NOBB and product numbers. It leverages embedded SQL for record selection and delegates deletion to an external program, ensuring business rules are centrally enforced. The program is to be used with caution, only in environments where NOBB is the authoritative product identifier.