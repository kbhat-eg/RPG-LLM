# Program Documentation: FTP File List Builder

## Overview

This program is part of the AS??? system and is responsible for generating a command file for FTP operations, specifically for building a file list to be transferred. The main purpose is to construct a sequence of FTP commands, tailored for each request, and write them to a spool file (`aflspf`). These commands are later used by other processes to execute the actual FTP transfer.

The program is invoked with parameters (name, status, host), looks up the FTP request in a control file (`aftpl1`), and builds the FTP command sequence based on the request's attributes.

---

## File and Record Definitions

- **aflspf**: Output file (spool), renamed to `aflspfr`. Each record is an FTP command line.
- **aftpl1**: Control file, renamed to `aftpl1r`. Contains metadata for FTP requests.

---

## Data Structures and Variables

- **Linje1**: DS for the first FTP command line (user/password), split into `bruker` (user) and `passord` (password).
- **Linje2**: DS for subsequent command lines (up to 200 chars).
- **p_navn, p_status, p_host**: Parameters passed to the program.
- **w_firm, aftpl1_navn**: Key fields for file lookup.
- **w_status, w_bruker, w_passord**: Work variables for password lookup.
- **l_firm**: Subfield from user data section, used as part of the key.

---

## Main Processing Logic

### 1. Initialization

- The `*inzsr` subroutine initializes key variables and parameter lists.
- The program expects three parameters: request name, status (output), and host (output).
- The key for the control file lookup is built from the current firm (`w_firm`) and the request name (`aftpl1_navn`).

### 2. FTP Request Lookup

- The program chains to the `aftpl1` file using the constructed key.
- If the request is not found, it sets `p_status` to 'N' (not found) and exits.

### 3. Request Type Checks

- If the request is for a library transfer (`aflibt = 'J'`), or not a 'GET' operation, it sets `p_status` to 'X' (unsupported) and exits.

### 4. User and Password Setup

- The initial FTP command line is set up with the user and password.
- If a proxy user (`afprxu`) is specified, the user field is built as `user@host`.
- If the request requires password lookup (`afqyps = 'J'`), a call is made to program `AF709R` to retrieve the password. If successful, the returned user/password are used; otherwise, status 'A' (authentication error) is set and the program exits.
- Otherwise, the password is taken directly from the control file.

### 5. Writing FTP Command Lines

- The program writes the following FTP command lines (in order):
  - User/password line.
  - `namefmt` command (0 or 1), depending on `affils`.
  - `sendpasv` command (0 or 1), depending on `afspas`.
  - `cd` command with the target directory (`afchdr`).
  - Up to three additional custom commands (`afxcm1`, `afxcm2`, `afxcm3`), if present.
  - `ls` command to list files, with the file name pattern (`affiln`).
  - `quit` command to terminate the FTP session.

Each command is written as a separate record to the output file (`aflspf`).

### 6. Returning Host Information

- The output host parameter is set to the proxy user (`afprxu`), if present; otherwise, it defaults to the direct host (`afhost`).

---

## Error Handling & Status Codes

- **'N'**: Request not found in control file.
- **'X'**: Unsupported operation (library transfer or not a GET).
- **'A'**: Authentication error during password lookup.
- (Blank): Success.

---

## External Program Calls

- **AF709R**: Invoked for retrieving user/password dynamically when `afqyps = 'J'`. Returns user, password, and status.

---

## Business/Domain-Specific Logic

- The program is tailored for a system that automates FTP transfers, supporting both direct and proxy users.
- It supports both active and passive FTP modes, and can alter file name formatting as required by the target system.
- Custom pre-listing commands are supported for special FTP server requirements.

---

## Notable Design Decisions & Conventions

- **Separation of command lines**: Each FTP command is constructed and written as a separate record, allowing downstream processes to execute them sequentially.
- **Dynamic password retrieval**: The system supports both static and dynamic password handling, increasing security and flexibility.
- **Flexible command injection**: Up to three custom commands can be inserted prior to the file listing, supporting non-standard server requirements.
- **Status-driven exit**: The program uses a status parameter to indicate the outcome, supporting robust error handling in calling processes.

---

## Module Relationships

- **Input**: Control file `aftpl1` (FTP request metadata).
- **Output**: Spool file `aflspf` (FTP command script).
- **External Calls**: Program `AF709R` for secure password retrieval.

---

## Summary Table: Key Fields from `aftpl1`

| Field      | Purpose                                        |
|------------|------------------------------------------------|
| afuser     | FTP username                                   |
| afpass     | FTP password (if not dynamically retrieved)    |
| afhost     | FTP host                                       |
| afprxu     | Proxy user (for proxy FTP logins)              |
| aflibt     | Indicates library transfer                     |
| aftype     | FTP operation type (must be 'GET')             |
| afqyps     | If 'J', password is retrieved via AF709R       |
| affils     | File name formatting (0 or 1)                  |
| afspas     | FTP mode: active ('A') or passive              |
| afchdr     | Target directory                               |
| affiln     | File name pattern for listing                  |
| afxcm1-3   | Optional custom FTP commands                   |

---

## Usage Notes

- This program is intended to be called by higher-level processes responsible for managing FTP transfers.
- Ensure that the control file (`aftpl1`) is correctly populated with all required fields before invoking this program.
- The output spool file (`aflspf`) will contain the command script to be executed by the FTP client.

---

## Maintenance Considerations

- Any changes to the FTP command structure or supported FTP features must be reflected in this program.
- If new custom commands or authentication methods are needed, additional logic should be added in the command construction section.
- Ensure the external password retrieval program (`AF709R`) is maintained and secured, as it is a key point for authentication.

---

## Conclusion

This program encapsulates the business rules and command sequencing for automated FTP file listing operations, supporting both standard and advanced scenarios (proxy users, dynamic passwords, server-specific commands). Its output is a fully-formed FTP script, ready for execution by downstream processes.