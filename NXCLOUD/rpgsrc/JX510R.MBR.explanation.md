# RPG Program Explanation: JX510R (Vare-pris, vise)

This RPG program is designed to display item price information in a subfile interface. It runs on IBM i (AS/400) using ILE RPG with classic fixed-format (column-sensitive) logic. The comments and structure are in Norwegian, with extensive documentation for onboarding.

Below is a breakdown of the code sections and their logic:

---

## 1. Header & Metadata

- `h option(*nodebugio) datedit(*dmy)`: Specifies that debug I/O is disabled, and date fields use day/month/year editing.
- The opening block comments provide:
  - System, program name, and descriptive change log.
  - Indicator usage map (e.g., *in10=Rollup, *in30=Protect for display, 80-99 are work indicators).

---

## 2. File Declarations

- Files `jvprlr`, `jvprl1`, `jvarl1`, `jlevl1`, `jvpkl1`, (and later `jvlelr`) are declared as keyed input files (disk files) for reading product, supplier, and pricing info.
- `fjx510d` is a display file with subfiles, used for the screen UI.
  - `sfile(b1sfl:w_srrn)` means subfile record format `b1sfl` using `w_srrn` as relative record number.
  - `infds(dspfbk)` links a display feedback data structure.

---

## 3. Data Structures and Variables

- Parameters: `p_vare` (item code) passed to the program.
- Local Data Area: Accessed via unnamed UDS (user data structure); `l_fnav` is a substring from LDA.
- Display Feedback Data Structure: `dspfbk` (e.g., `d_fcrn` holds cursor location).
- Key Variables: Used for constructing keys for file operations (`jvprlr_ldor`, `jvprlr_gdat`, etc.).
- Subfile Helpers: Variables like `w_fcrn` (first rec# on page), `w_srrn` (relative rec#), etc., are heavily commented for their use in paging, record handling, and cursor management.
- Constants: `c_sfil` is subfile page size.

---

## 4. Main Program Flow

### Initial Display and Command Screen

- **Label `b2taga`**:
  - Writes the CMD-format screen (`b2cmd`).
- **Label `b2tagb`**:
  - Calls `dsp_subfile` subroutine (display subfile).

### Function Key Processing

- `select/when` logic for function keys:
  - *inkc/*inkl: Exit (goto avslutt).
  - *inke: Refresh (exsr forny).
  - *in10: Next page (exsr crt_subfile).
  - *in11: Previous page (exsr bck_subfile).
  - *in21: Home key (set *in22, goto command).
- If positioned by supplier (`b2ldor`), calls `posisjoner`.

### Subfile Handling

- Calls `subfile` subroutine for subfile record handling.
- Always loops back to the top after each action.

### Program End

- Label `avslutt`: Sets *inLR=on and returns (ends the program).

---

## 5. Subroutines

#### `forny` - Refresh Subfile

- If there is a first record number, it chains to that subfile entry.
- Positions file, clears and creates subfile again.

#### `posisjoner` - Positioning

- If a supplier number is set in `b2ldor`, positions to that entry, blanks appropriate indicators/fields, then recreates the subfile for new position.

#### `subfile` - Handle Subfile Records

- Toggles *in22.
- Main record processing loop using `readc` on `b1sfl`.
- If select=5 (view), loads detail record and calls `xc2bld` to show full detail.
- Updates the selection state and continues.

#### `xc2bld` - Display Detail (C2BLD Screen)

- Loads full key to `jvprlr` (main price file), fetches price fields.
- Loads supplier-specific fields if available (`jvlelr` lookup).
- Moves/sets various display variables and issues `exfmt` to display the C2BLD screen.

#### `clr_subfile` - Clear Subfile

- Sets indicators to clear subfile and resets count/page variables.

#### `crt_subfile` - Create (Fill) Subfile

- Fills the subfile page with up to `c_sfil` records, fetching from the price file.
- Sets up record-specific fields: supplier name, codes, local-marks.
- Handles page/record numbers for subfile paging.

#### `bck_subfile` - Page Backwards

- Handles rolling back a subfile page by reading previous records.

#### `dsp_subfile` - Display Subfile Page

- If there are records, sets indicators for display, then calls `exfmt` for the subfile control screen.
- Captures first record number after interaction.

#### `*inzsr` - Initial Program Setup

- Parameter passing (item number).
- Builds keys for all database access.
- Preloads main item and supplier information for display.
- Positions to start, invokes creation of the first subfile page.

---

## 6. Key Technical Concepts in This Program

- **Subfile Paging**: The code is structured for paged lists with Rollup/Rolldown (next/prev page) logic.
- **Dynamic File Access**: Uses keyed access (`setll`, `chain`, `read`, `readp`) for efficient navigation.
- **Function Key Handling**: Implements main navigation via indicators, mapping function keys to program logic.
- **Screen Management**: Uses multiple display formats and fields (subfile record, control, CMD-screen, full detail).
- **Supplier & Price Lookups**: Integrates multiple files (item, supplier, price) for a complete price overview.

---

## 7. File & Variable Relationships

- `jvprlr/jvprl1`: Main item price records.
- `jvarl1`: Item master.
- `jlevl1`: Supplier master.
- `jvpkl1`: Packing information.
- `jvlelr`: Supplier's item numbers.
- Subfile fields (`b1sfl`, `b2ctl`, etc.) are mapped to these data sources for UI display, selection, and paging.

---

## 8. Summary

This RPG program provides a paged, interactive display of item (product) prices with options to view details, navigate pages, and refresh the data. It is built with classic RPG structure and conventions, with ample comments (mostly Norwegian) guiding future developers. The program leverages subfiles for user interaction, supports both item and supplier-based lookups, and integrates tightly with a relational database of items, suppliers, and prices.

---

**Onboarding Tips:**
- Understand the indicator-driven control flow.
- Review subfile record format definitions in the associated DDS (`fjx510d`).
- Recognize how keys are constructed and used for file operations.
- The change log provides historical context for conditional code sections (`6.30`, `6.34`, etc.).

If you work with this program, you will mainly interact by extending file handling or display logic, or when integrating new item/supplier attributes.