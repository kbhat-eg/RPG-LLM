# RPG Program Explanation: FW123R

## Overview

This RPG/400 program, `FW123R`, is a classic IBM i (AS/400, iSeries) ILE RPG application. Its purpose is to help create ("oppretter") new supplier-related item records with standard/default values. The code is written in Norwegian, which reflects in field names and comments.

The program works with two logical files (likely over supplier and group master data), and a display file for user interactions. It uses parameters (plist) to exchange data with the caller. The main functional sections are:
- Initialization
- Display interaction loop
- Validation of input fields
- Handling inquiry ("spørring") requests for group fields
- Returning data to caller

---

## File Declarations

```rpg
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
ffw123d    cf   e             workstn
```
- **rlevl1** (supplier master, renamed from physical file `rlevpfr`)
- **vugrl1** (group master, renamed from physical file `vugrpfr`)
- **fw123d** (display/workstation file)

---

## Data Definitions

### Parameters

Used for communication with caller (entry parameters).
- `p_vtyp` (Item type)
- `p_kpri` (Price code)
- `p_varf` (Item number)
- `p_kvar` (Item flag)
- `p_firm`, `p_ldor`, `p_ogrp`, `p_hgrp`, `p_ugrp` (Firm, supplier, group identifiers)

### Local Variables

- Keys for DB access (`rlevl1_levr`, etc.)
- Error flags (`b_feil`)
- Work fields (`w_retu`, `w_vare`, etc.)
- `l_fnav` (seems unused here; possibly leftovers referencing LDA segment)

---

## Main Program Flow

### Initialization

- Screen fields (`b1...`) initialized from parameters
- DB lookups:
    - Supplier (`rlevl1`) for name (`b1navn`)
    - Group (`vugrl1`) for description (`b1utxt`)
- Default values: If item type (`b1vtyp`) is blank, set to `'L'`.

### Display Loop

Label **b1taga** marks the start of the interactive loop:
- `exfmt b1bld` displays the main screen and waits for user actions.

### Function Key Handling

- If F3 (KC) or F12 (KL) pressed: Go to `avslutt` (exit)
- If F4 (KD): Call the `spørring` (inquiry) subroutine, then redisplay
- Otherwise: Continue

### Validation

- Calls `sjekk_input` to validate user entries
- If errors, redisplay for correction
- If valid, copy screen fields back to parameters for return

### Program Exit

- Label `avslutt`: sets last record indicator and returns

---

## Subroutines

### Inquiry: `spørring`

Based on the active field (`w_afld`), calls external programs for group selection:
- Overgroup (`B1OGRP`): calls `VG510R`
- Main group (`B1HGRP`): calls `VG511R`
- Subgroup (`B1UGRP`): calls `VG512R`
Passes current firm and relevant group fields to external program to select/update group.

### Validation: `sjekk_input`

Checks for:
- Valid group (must exist in vugrl1)
- Item type (`b1vtyp`) must be `'L'` or `'S'`
- Price code (`b1kpri`) must be blank, `'N'`, or `'B'`
- Item number (`b1varf`) must be between 0 and 99999999
- Item flag (`b1kvar`) must be 0 or 1
- Complex rule: If item number is not 0, item flag must be 0

If any check fails, sets error indicators (`*in32`, `*in35`, etc.) for display feedback and marks field as erroneous.

### Initialization: `*inzsr`

- Reads parameters into local variables
- Prepares DB access key lists

---

## Key Lists

- `rlevl1_key`: for supplier file lookup, based on firm and supplier number
- `vugrl1_key`: for group file lookup, based on firm and group hierarchy (over, main, sub-group)

---

## Local Data Area

- Reads company name or code (`w_firm`) from parameter (and could have used `l_fnav` from LDA)

---

## Summary Table

| Section      | Function                                                        |
|--------------|-----------------------------------------------------------------|
| File Decl.   | Connects logical/physical files and display                     |
| Params       | Entry/exit parameters (data in/out)                             |
| Main         | Initializes, runs input loop, handles keys, validates           |
| Subroutines  | Inquiry for groups, validation, initialization                  |
| Exit         | Returns parameters, ends program                                |

---

## Remarks

- This is "traditional" fixed-format RPG, not free-form.
- Error handling is via indicator variables (e.g., *in91, *in32), reflecting the display file's error fields.
- The user sees a screen (`b1bld` record format), fills in/selects data, and receives error feedback until all is valid or they cancel.
- Group and supplier lookups populate additional descriptive fields, improving user guidance.
- External "VGxxxR" programs handle lookups/searches for group fields via F4.

---

## Onboarding Takeaways

- Most field and variable names are abbreviations of Norwegian terms—familiarize yourself with these for effective maintenance.
- The program is centered on a modal workflow: init → user interaction → validate → return.
- Error highlighting and feedback is handled by setting display file indicator variables.
- Key logic revolves around group code validity, item type/price code restrictions, and item number field rules.
- External calls for group inquiries are a major integration point.

**In summary:**  
FW123R is a typical RPG/400 legacy program for creating supplier item records, with interactive validation and firm/group context, designed to guide the user and uphold business rules inline with the Norwegian-language ASOFAK system.