# RPG Program Explanation: LO405R

This RPG (Report Program Generator) ILE program is named `LO405R`. Its primary purpose is to handle the deletion of orders (bestillinger) by allowing user parameter entry via display files, validating those parameters, and then calling appropriate subprograms to execute the deletion. The code structure is typical for interactive AS/400 RPG/400 and RPGLE applications.

---

## **Header and Setup**

```rpg
h datedit(*dmy) option(*nodebugio)
```
- Sets the default date edit word to day-month-year and suppresses debug I/O information.

---

## **File Declaration**

```rpg
flo405d    cf   e             workstn
```
- Defines a display file `LO405D` for interactive (workstation) I/O.

---

## **Data Structures and Fields**

### **Parameter Data Structure**

```rpg
d                 ds
d d_prec                        64
d  d_bdat                        6  0 overlay(d_prec)
d  d_uvar                        1  0 overlay(d_prec:7)
d  d_ldor                        6  0 overlay(d_prec:8)
d  d_otyp                        2    overlay(d_prec:14)
```
- A 64-byte area (`d_prec`) overlays several parameter fields:
  - `d_bdat`: Order date (6 digits)
  - `d_uvar`: Item indicator (1 digit)
  - `d_ldor`: Supplier number (6 digits, starts at pos 8)
  - `d_otyp`: Order type (2 chars, starts at pos 14)

### **Local Data Area Fields**

```rpg
d                uds
d l_firm                944    946  0
d l_fnav                951    980
```
- Maps portions of the user data space for company number and company name, possibly for use in called programs or display.

### **Other Variables**

```rpg
d w_batc          s              1
d w_bdat          s               d   datfmt(*iso)
d w_firm          s              3  0
```
- `w_batc`: Indicates batch/job queue processing (`'1'` or `'0'`)
- `w_bdat`: Date field using ISO format.
- `w_firm`: Company number.

---

## **Main Program Flow**

### **Screen Initialization**

```rpg
c     b1tag         tag
c                   eval      b1bdat = 0
c                   eval      b1uvar = 1
c                   eval      b1ldor = 0
c                   eval      b1otyp = *blank
```
- Initializes the parameters to default values before screen display.

---

### **User Parameter Entry (Main Loop)**

```rpg
c     b1tagb        tag
c                   exfmt     b1bld
```
- Presents screen (`b1bld`) for the user to enter/delete order selection parameters.

#### **Handling Special Keys**

- **F3 (Exit):**
  ```rpg
  c                   if        *inkc = *on
  c                   goto      end_pgm
  c                   endif
  ```

- **F4 (Inquiry/Prompting):**
  - If `w_afld = 'B1LDOR'`, calls program `RL500R` to prompt for supplier.
  - If `w_afld = 'B1OTYP'`, calls program `VA550R` to prompt for order type.

- **Field Validation:**
  - Checks if date entered is valid.
  - Ensures required parameters are not missing.

---

### **Parameter Validation and Error Trapping**

1. **Order Date Validation**
    - Checks if date is not zero and is a valid date (sets error indicators otherwise).

2. **Item Indicator and Order Type**
    - Ensures these fields are properly set, else prompts the user with an error.

---

### **Confirmation Message Construction**

```rpg
c                   eval      d1tek1 = *blank
c                   eval      d1tek2 = *blank
c                   eval      d1tek3 = *blank
c                   eval      d1tek4 = *blank
```
- Builds up confirmation text to display the user’s deletion criteria, e.g.:
  - Whether deleting only orders without items or all orders.
  - Date range restriction ("orders before [date]").
  - Specific order type or supplier number, if entered.

---

### **Parameter Transfer**

```rpg
c                   eval      d_uvar = b1uvar
c                   eval      d_bdat = b1bdat
c                   eval      d_otyp = b1otyp
c                   eval      d_ldor = b1ldor
```
- Stores parameters in the overlay data structure for passing to subprograms.

---

### **Confirmation and Execution**

```rpg
c                   exfmt     d1win
c                   if        *inkc = *on or
c                             *inkl = *on
c                   goto      b1taga
c                   endif
```
- Displays confirmation window. User can either accept or abort.

---

### **Batch/JOBQ Handling (F10)**

```rpg
c                   if        *inkj = *on
c                   eval      w_batc = '1'
c                   else
c                   eval      w_batc = '0'
c                   endif
```
- If F10 is pressed, sets flag for batch processing.

---

### **Call to Next Program**

```rpg
c                   call      'LO405C'
c                   parm                    d_prec
c                   parm                    w_batc
```
- Calls the next program (`LO405C`), passing the user’s parameters and batch/job flag.

---

### **End Program**

```rpg
c     end_pgm       tag
c                   eval      *inlr = *on
c                   return
```
- Normal RPG program end sequence.

---

## **Initialization Subroutine**

```rpg
c     *inzsr        begsr
c                   endsr
```
- Empty initialization subroutine, reserved for future startup actions.

---

## **Summary**

- **Purpose:** Interactive deletion of orders with parameter entry, confirmation, and passing selections to another program for processing.
- **Features:** 
  - Handles user prompting, field validation, and error correction.
  - Offers inquiry (F4) for order type and supplier number.
  - Constructs and displays confirmation messages for user review.
  - Supports batch or immediate processing (F10).
  - Cleanly modular, calling CL or RPG subprograms as needed.

---

### **Onboarding Note**

If you are working with or modifying this program:
- **Understand the parameter fields** (overlay structure) and how they map to both screen fields and the called program.
- **Customize validation rules** as business needs change.
- **Display file(s) (LO405D)** must be updated carefully together with this code for screen changes.

**The code is well-commented in Norwegian, with clear structure and logic, making onboarding relatively straightforward for someone familiar with classic RPG programming on IBM i systems.**