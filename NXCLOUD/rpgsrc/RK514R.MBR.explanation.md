# Overview

This ILE RPG program (`RK514R`) is designed to support an interactive inquiry into customer postings and general invoice notes ("Kundeposteringer, spørring generalnota"). It handles subfile display and navigation, supports function keys, and interfaces with customer and posting physical files. There is special handling for multi-page (subfile) displays and for looking up customer and transaction details.

The program uses traditional fixed-format RPG IV and relates to an interactive (workstation) display file with subfiles. This code is well-commented, especially in Norwegian, which clarifies both business and technical intent.

---

# Header Section

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: Disables debug I/O.
- `*DMY`: Date fields are in day/month/year format.

---

# File Declarations

```rpg
frktrl5    if   e           k disk    rename(rktrpfr:rktrl5r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
frktrl2    if   e           k disk    rename(rktrpfr:rktrl2r)

frk514d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- Three physical files are declared:
  - `rktrl5`, `rkunl1`, `rktrl2` are input files for transaction and customer data,
    - All are key-sequenced files, some renamed for local reference.
- `frk514d` is the display file,
  - The subfile is `b1sfl`, controlled with record number variable `w_srrn`.
  - `infds(dspfbk)` enables the use of the display feedback data structure.

---

# Data Structure and Variable Declarations

- **Local Data Area**: pulls basic info (user, firm, etc.)
- **Display Feedback Structure (`dspfbk`)**: used to get the subfile current record.
- **Key Variables**: used for file access (e.g., `rktrl5_samf`, `rkunl1_kund`).
- **Working Variables**: control subfile navigation and status, including page size (`w_spge`), pointers (`w_srrn`, `w_sfrn`, `w_ssrn`), various 'current' values, and page markers.
- **Constants**: e.g., `c_sfil` = 13 (subfile page size).

---

# Indicator Usage (From Comments)

- Systematic indicator assignment for screen handling and logic:
    - 10-15 for keying/navigation and subfile control.
    - 21-22 for cursor and home key.
    - 31-79 for errors and UI messages.
    - 80-99 for internal/working indicators.

---

# Subfile Control

### Subfile Concepts

- Subfiles are "paged lists" for screen display.
- Navigation keys (`Page Up`, `Page Down`) are supported.
- Each "page" of the subfile holds multiple entries; record numbers and page markers handle positioning.

---

## Mainline Structure

### Initialization (`*inzsr`)

- Receives a customer number as an entry parameter.
- Initializes keys and working variables based on Local Data Area.
- Prepares the subfile for display by setting up positions and keys, then filling the first page.

### Main Loop

- Tags and flow control are used rather than structured subprocedures.
- Responds to function keys such as:
    - Exit keys: LR set, program ends.
    - Refresh (`forny`), Forward (`crt_subfile`), Back (`bck_subfile`).
    - Home/Cursor placement.
- Navigates between two tagged sections: 
    - `b2taga` (command screen processing)
    - `b2tagb` (subfile display loop)
- After most actions, returns to either process more screen input or redisplay the subfile.

---

## Core Subroutines

### `forny` – Refresh the Subfile

- If a specific record is active, chains to the subfile on that record to refresh context.
- Resets current key structure.
- Calls routines to clear and then refill the subfile.

### `posisjoner` – Position to Subfile Entry

- Determines correct position when a year or general invoice number changes.
- If a year (`b2raar`) is entered, adjusts the current working year.
- If general note number (`b2samf`) is entered, positions on that.
- Clears and fills the subfile to match new positioning.

### `subfile` – Process Subfile List

- Toggles a positioning indicator.
- Reads and processes each subfile entry (do loop), handling visible entries and "view"/lookup requests.
- If user presses "View" (`valg = 8`), calls `xc2win` to show detailed window.

### `clr_subfile` – Clear Subfile

- Sets indicators and writes subfile control record, effectively clearing the subfile.
- Resets working subfile position variables.

### `crt_subfile` – Build Subfile Page

- Fills the subfile from the current key position.
- Loops, reading the posting file sorted by key, and writing subfile records up to the page size.
- Additional logic groups postings by customer and general note, calculates sums, and writes summarized records.
- Handles filtering by year and customer if requested.

### `skr_subfile` – Write Entry to Subfile

- Writes one subfile record for the current grouping.
- Looks up customer name from the customer file.
- Writes the subfile record and resets group totals.

### `bck_subfile` – Go Back One Subfile Page

- Navigates backwards through the posting file to position to the previous page.
- Skips entries not matching year, if filtering.
- Fills the subfile starting from this backward position.

### `dsp_subfile` – Display Subfile

- Shows the subfile (or a "no data" message if empty).
- Sets screen indicators and executes the format.

### `xc2win` – Display Details in Window

- Calls an external program (`RK515R`) with customer, general note and year as parameters to show a detail window.

---

# Key Lists

- `rktrl5_key`, `rkunl1_key` and `rktrl2_key` are defined for consistent keyed access to physical files.

---

# Notes on Business Logic

- **General Note (Samlefaktura/Generalnota)**: The code specifically handles grouping by general note number, a summary invoice for a customer.
- **Year Handling**: Handles both current and previous years' postings; logic exists to force a search for previous year entries if needed (see T5.50).
- **Function Key Handling**: RPG indicators map directly to UI keys and state management.

---

# Summary

- The program is a classic RPG interactive inquiry screen using subfiles.
- Displays lists of postings (invoices, payments) per customer/general note.
- Supports paging, positioning, filtering, and call-out to display more details.
- Heavy use of RPG indicators and explicit tags for flow control.
- Keyed file access for efficient random access (paging, lookups).
- Well-commented with references to business processes and Norwegian terminology.

---

# Onboarding Recommendations

- Familiarize yourself with the display file (`RK514D`) and its subfile records (`B1SFL`, `B2CTL`, `B2CMD`).
- Review the physical files (`RKTRL5`, `RKUNL1`, `RKTRL2`) structure and keys.
- Understand the RPG indicator assignments and their mapping to function keys/events.
- Review the business process: groupings by customer and general note, and how postings are aggregated.
- Test using different navigation keys and positioning/filtering options to see how subfiles are dynamically built and displayed.