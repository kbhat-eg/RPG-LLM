# AA003R – Environment Selection Program

## Overview

**AA003R** is a workstation-based RPG program used for selecting an environment ("miljø") from a list, presented via a subfile. The program is part of the ASPGPL system and interacts primarily with the `amill1` physical file (environment master) and a subfile-based display file (`AA003D`). The code is written in classic (fixed-format) RPG IV, with Norwegian comments and business terminology.

The program is designed to:
- Display a list of environments in a subfile.
- Allow the user to scroll through pages (forward/backward).
- Allow selection of an environment, returning the selected value to the caller.
- Handle screen positioning, cursor placement, and function key logic.

## Data and File Relationships

- **AMILPFR** (renamed to `amill1`): Physical file containing environment records.
- **AA003D**: Display file, using subfiles for environment selection (`B1SFL`), and control records (`B2CTL`, `B2CMD`).
- **Local Data Area**: Used for passing/receiving selection and control information.

## Key Data Structures and Variables

- **amill1_milj**: Key field for environment selection, used for positioning in the file.
- **w_srrn, w_ssrn, w_sfrn, w_spge, w_fcrn, w_stel, w_acli, w_acpo**: Subfile and paging control variables.
- **b_valg_ok**: Indicates if a valid selection has been made.
- **p_milj**: Parameter for returning the selected environment.
- **dspfbk**: Display feedback structure (for cursor row/column).

## Indicator Usage

- **LR**: End of program.
- **10 / 11**: Roll forward/backward.
- **12 / 13**: Subfile display indicators.
- **14 / 15**: Subfile clear/end indicators.
- **21 / 22**: Home key, cursor placement.
- **30**: Field protection.
- **31-79**: Error/warning indicators.
- **80-99**: Work indicators.

## Main Program Flow

### 1. Program Initialization (`*inzsr`)
- Receives parameter for the selected environment (`p_milj`).
- Initializes indicators and variables.
- Positions to the top of the environment file.
- Calls `crt_subfile` to fill the first page of the subfile.

### 2. Main Screen Loop

The program cycles between two main states:
- **b2taga**: Displays the command screen (`B2CMD`).
- **b2tagb**: Handles subfile display and user input.

Within `b2tagb`:
- Calls `dsp_subfile` to present the subfile page.
- Processes function key input:
    - **F3/F12** (`*INKC`/`*INKL`): Exit, set `l_sw12`, end program.
    - **F5** (`*INKE`): Refresh, call `forny`.
    - **Roll Up** (`*IN10`): Page forward, call `crt_subfile`.
    - **Roll Down** (`*IN11`): Page backward, call `bck_subfile`.
    - **Home** (`*IN21`): Set cursor position, restart at `b2taga`.
- If the user enters a value in the environment field (`b2milj`), calls `posisjoner` to position to that environment.
- Otherwise, calls `subfile` to process selection from the subfile.

### 3. Subfile and Paging Logic

#### a. Creating Subfile (`crt_subfile`)
- Fills the subfile with up to `c_sfil` (13) records per page.
- Reads from `amill1` and writes to the subfile (`B1SFL`).
- Handles end-of-file and updates subfile counters.

#### b. Clearing Subfile (`clr_subfile`)
- Clears the subfile using indicator 14 and control record (`B2CTL`).
- Resets subfile counters.

#### c. Paging Backward (`bck_subfile`)
- If at end-of-file, backs up in the file by one record.
- Reads back a full page, updating subfile counters.
- Refills the subfile.

#### d. Refreshing Subfile (`forny`)
- Positions to the current top record in the subfile.
- Clears and refills the subfile.

#### e. Positioning (`posisjoner`)
- If the user enters an environment code, positions to that record in `amill1`.
- Clears and refills the subfile, then blanks the positioning field.

#### f. Processing Subfile Selection (`subfile`)
- Reads changed records from the subfile.
- If the selection field (`b1valg`) is set, stores the selected environment in `p_milj` and sets `b_valg_ok` to signal a valid selection.

#### g. Displaying Subfile (`dsp_subfile`)
- Sets appropriate indicators for subfile display.
- Uses `exfmt` to display the control record (`B2CTL`) and collect input.
- Updates the current first record number for paging.

## Display File Interaction

- **B1SFL**: Subfile record format for environment list.
- **B2CTL**: Subfile control record (header, function keys, etc.).
- **B2CMD**: Command screen for function key help or additional commands.

## Business/Domain-Specific Logic

- The program is designed for the selection of a "miljø" (environment), which may refer to a logical or physical environment in the application domain (e.g., system, test, production).
- The code expects the user to select an environment either by positioning directly (typing in a code) or by scrolling through the list and marking a selection.
- The program is highly indicator-driven, following conventions typical for subfile-based selection lists in legacy IBM i (AS/400) applications.

## Design Patterns and Conventions

- **Subfile Paging**: Implements classic subfile paging with manual counters and indicators.
- **Indicator-Driven UI**: Uses RPG indicators extensively for function key processing, subfile control, and error handling.
- **Modular Subroutines**: Key operations (create, clear, refresh, page, display) are encapsulated in subroutines, making maintenance easier.
- **Feedback Data Structure**: Uses `dspfbk` to retrieve cursor position and other display feedback for improved user experience.

## Integration Points

- **amill1**: The only physical data source, representing the list of environments.
- **AA003D**: The only display file, with all user interaction via subfiles and control screens.
- **Parameter Passing**: The selected environment is returned to the caller via the `p_milj` parameter.

## Notable Non-Obvious Details

- **w_seqe**: Appears to be reserved for future or conditional logic (e.g., alternate paging or selection modes), but in the current code is mostly set to blank or 'B'.
- **Display Feedback (dspfbk)**: Used to maintain cursor and screen state across subfile operations.
- **Indicator 22**: Used for cursor placement logic, toggled in several routines to control field focus.

## Error and Exit Handling

- Exits gracefully on F3/F12 or successful selection.
- Uses indicator-driven logic to ensure subfile and screen are always in a consistent state after each operation.

---

## Summary Table: Key Routines

| Routine        | Purpose                                                     |
|----------------|------------------------------------------------------------|
| *inzsr         | Initialization, parameter setup, initial subfile fill      |
| dsp_subfile    | Display subfile and control record, handle input           |
| crt_subfile    | Fill subfile with next page of records                     |
| clr_subfile    | Clear subfile and reset counters                           |
| bck_subfile    | Page backward in subfile                                   |
| forny          | Refresh subfile based on current position                  |
| posisjoner     | Position to a specific environment code                    |
| subfile        | Process user selection from subfile                        |

---

## Conclusion

This program is a standard, robust implementation of a subfile-based selection list for environments, following established IBM i application design patterns. Its modular subroutine structure, indicator-driven logic, and clear separation of display and data handling make it straightforward to maintain and extend. The business logic is tightly coupled to the concept of environment selection, and the code is ready for adaptation to similar selection-list requirements elsewhere in the system.