# Explanation of RPG Source Code for "Utskrift av kontoplan" (Print Chart of Accounts)

This RPG program (RH611R) produces a printed report of the chart of accounts, supporting different sorting/grouping such as by account, department, or cost bearer. It handles grouping breaks, subtotals, and conditional printing of account lines, and can be adapted to different companies (multi-firm).

Below is a breakdown of the major components and logic:

---

## Title, Header, and Documentation

- `/TITLE` and `h` spec: The program title and compile-time options.
  - `datedit(*dmy)`: Date fields formatted as day/month/year.
  - `option(*nodebugio)`: Disables debug I/O for faster runtime.
- Documentation area: Describes indicator conventions and program history.

---

## File Declarations

```rpg
frhovl1 if e k disk    rename(rhovpfr:rhovl1r)
frhovl3 if e k disk    rename(rhovpfr:rhovl3r)
frhovl4 if e k disk    rename(rhovpfr:rhovl4r)
frh611p o  e printer oflind(*in30)
```
- **Input files:** `frhovl1`, `frhovl3`, `frhovl4` — all key-sequenced disk files, renamed to local record names.
- **Output file:** `frh611p`, a printer file, with page overflow controlled by indicator *IN30.

---

## Data Definitions

- `avd` and `txt`: Arrays for departments and text lines.
- Several data structures (`DS`) are defined to facilitate easy manipulation and overlay of related fields:
  - `nybrd` / `gmbrd`: Structures to hold new and old group-break values (e.g., department, account, group, class, cost bearer).
  - `wkonto`: For manipulating account numbers.
  - User data structure fields: Custom fields like `l_wsid` (workstation ID), `l_user`, `l_fgrp`, `l_firm`, etc.
- Several standalone fields for counters, flags, and parameters.

---

## Main Logic

### 1. Initialization (`*INZSR`)

- Sets initial values for break variables.
- Initializes group/sort indicators based on the report type (by account, department/avdeling, or cost bearer).
- Sets up keys for file access according to selected sorting.

### 2. Reading Input Accounts

- The `SELECT` block determines which account file to read, depending on `rhpsrt` (sort code: 'K', 'A', 'B').
- Sets on the first record (*SETLL, *READE) using appropriate key lists.

### 3. Main Processing Loop

```rpg
c dow *in60 = *off
```
Keeps reading records until EOF (indicated by *IN60).

#### For Each Account:
- Loads the account number and overlays into work fields as needed.
- **Filtering:** Several conditions decide whether to skip the account ('goto neste'), e.g.:
  - Exclude blocked accounts if not requested.
  - Restrict by account number, department, or cost bearer ranges as needed.
- **Handling Group Breaks:**
  - Checks for changes in group break fields: department, cost bearer, class, group.
  - When a break is detected, calls the appropriate subroutine:
    - `brdavd`: On department change.
    - `brdsps`: On cost bearer change.
    - `brdkla`: On class change.
    - `brdgrp`: On group change.
  - These subroutines call external programs (such as `RS707R`, `RS728R`, etc.) to retrieve descriptive text for codes.
- **Header Handling:** Writes section headers if starting a new page or group.
- **Accumulators:** Counter `antkto` increments for each printed account.
- **Writes**:
  - Class/group totals/details when a break is detected, via print records `t1kla`, `t1grp`, `d1det`, etc.
  - Moves the current break fields to "previous" for next iteration.
  - After each record, reads the next input record using the same logic as above.

### 4. Termination

- After processing all records, writes the total count of accounts (`t1tot`), sets the last record indicator (*INLR= *ON), and ends.

---

## Subroutines

- **brdavd, brdsps, brdkla, brdgrp**: Called on break/group changes. Each:
  - Moves the relevant code into a parameter variable.
  - Calls an external program to fetch the code description.
  - Stores the code and text for printing in headers.
- **Initialization (*inzsr)**: Sets all break fields to zero/blank, prepares keys, and sets indicators according to report type.

---

## Indicator Usage

The indicator conventions defined in comments are followed, e.g.:
- 30: Output page overflow.
- 60: File EOF.
- 80-99: Work indicators for routines and print control.

---

## General Flow

1. **Initialize** (set values, keys, indicators).
2. **Select records from correct file** (based on grouping type).
3. **Loop through records**:
   - Process/screen each record.
   - Handle group breaks.
   - Write account lines and headers.
   - Update break variables.
4. **Terminate**: Write totals, end program.

---

## Special Features

- Handles multiple reporting "views" (account, department, cost bearer).
- Skips/marks blocked accounts depending on user preferences.
- Externalizes all code-to-text conversion to sub-programs for easier maintenance.
- Makes heavy use of overlays to handle group fields efficiently.

---

## Summary Table of Key Concepts

| Area                     | Purpose                                                         |
|--------------------------|-----------------------------------------------------------------|
| File declarations        | Input: account master tables (3 views), Output: print           |
| Break detection          | Triggers headers/subtotals when department/group/class changes  |
| Subroutines              | Retrieve code descriptions for print headers/totals             |
| Filtering                | By blocked accounts, range checks on account/avdeling/costbearer|
| Print control            | Manages page breaks, header writing, and account lines          |
| Indicator usage          | Standard ILE RPG for control and file status                    |

---

## Onboarding Advice

- **Break Fields:** Understand how overlays allow viewing the same value as department/account/group/etc.
- **Integration:** The program expects external programs for code text descriptions—be familiar with `CALL` and parameter-passing conventions.
- **Print File:** Modify print layout by adjusting `frh611p` and its associated record formats.
- **Sort Modes:** The `rhpsrt` field controls logic throughout. Know which sort/view you are enhancing!
- **Error Handling:** Minimal explicit validation—assumed handled outside or by data integrity.

---

If you will work on extending or maintaining this program, start by understanding the grouping requirements (breaks/subtotals), how indicators drive report formatting, and how the external description programs fit into the workflow. The main report loop is a classic RPG pattern for exception-driven printing with group change logic.