# Overview  
This RPGLE program (NM723R) exports “yesterday’s” sales data to a temporary work file (BRIDIUR) for subsequent JSON creation (by NM724R). Sales are pulled from three sources:  
  1. Packing‐slip–based orders (FOHEPF/FODTLR)  
  2. Voucher‐based orders (BOHEPF/BODTL1)  
  3. Invoice history (SOHEPF/SODTLR)  
Plus an extended source for “Malproff” transactions (VHISPF).  

Each source routine:  
  - Opens a SQL cursor for the master header table (by date).  
  - Filters out credit orders (via VOTYLPF).  
  - Reads detail lines, excludes text/zero‐qty lines.  
  - Checks EVR items (VVARLPF) and inventory items (VLAGLPF).  
  - Converts quantities to the base unit using VVENLR.  
  - Determines supplier/reskontronummer via LOGIC:  
      • Primary supplier (VVLDOR/RLEVLPF)  
      • If logistic item, via JVKHPF→JLEVPF  
      • Override supplier per RDS table (VLA2I1/VLA2ST)  
  - Accumulates into the BRIDIUR file (add or update).  

# File Declarations  
• Input files (IF/UF):  
  – FOHEL1/FOHEPFR & FODTLR/FODTPFR – order headers/details  
  – BOHEL1/BOHESPF & BODTL1/BODTPFR – voucher headers/details  
  – SOHEL1/SOHEPFR & SODTLR/SODTPFR – invoice headers/details  
  – VVENLR, VVARL1, VOTYL1, VLAGL1, RA10L1, JLEVL1, RLEVL1, VLA2I1, VHISPL – lookup tables  
  – BRIDIU/BRIDST   – work file for export (output)  

# Data Definitions  
• **Local Data Area** (UDS): user, company, firm, etc.  
• **Working Variables**:  
  – w_date: export date (ISO)  
  – w_firm: company code  
  – w_size / bidlin: line counter in BRIDIUR  
  – w_senh, w_omrs, w_omrl: unit conversion factors  
  – w_anta: adjusted quantity  
  – w_ldor / w_ltxt: resolved supplier code/name  
  – bridiu_d…: key fields for BRIDIUR lookup  

# Main Program Flow  
1. **Initialization**  
   - Determine running member (`AS100R` call) or reuse passed parameter.  
   - Build `w_memb`, set up `bridiu_dmem`.  
   - Set `w_date` = today (since run at night).  

2. **Extraction Subroutines**  
   - EXSR pakk_ordre  
   - EXSR bong_ordre  
   - EXSR fakt_ordre  
   - EXSR fakt_malproff  _(for Malproff sales)_  

3. **Program End**  
   - Set *INLR = *ON, return  

# Subroutine: pakk_ordre (Packing‐Slips)  
– Reset counters (w_size, w_lety).  
– Open SQL cursor on FOHEPF where FOPADA = w_date.  
– For each header:  
  • Skip credit orders (via VOTYLPF→VAOKRE).  
  • Chain to FODTLR detail lines.  
  • For each line with nonblank FDVARE, FDANTA≠0:  
    1. Chain VVARL1 (EVR items)—skip if not found  
    2. Chain VLAGL1 (inventory items)—skip if not L‐type  
    3. Lookup unit conversion in VVENLR: compute w_anta  
    4. Resolve supplier code/name:  
       – Default: VVLDOR → RLEVL1  
       – Logistic override: JVKHPF→JLEVPF  
       – Extra override: VLA2I1→RLEVL1  
    5. Chain BRIDIUR by (mem, var, lag, id); if not found → CLEAR, assign keys.  
    6. Chain RA10L1 for warehouse text.  
    7. Populate BRIDIUR fields (date, time, user, qty, item, customer, supplier).  
    8. WRITE or UPDATE BRIDIUR.  

# Subroutine: bong_ordre (Vouchers)  
– Very similar to **pakk_ordre**, but uses BOHEPF/BODTL1 and voucher keys (arrangement, voucher no., warehouse id).  
– Extracts BDVARE/BDANTA, same EVR/inventory/unit‐conv/supplier logic.  
– Writes into BRIDIUR (bidivd derived from voucher no.).  

# Subroutine: fakt_ordre (Invoice History)  
– SQL cursor on SOHEPF where SOPADA = w_date.  
– Chain SODTLR historical lines (SOAARR, SOBINR, SONUMM, SOSUFF).  
– For each valid line: EVR/inventory/unit conversion.  
– Populate BRIDIUR (bidivd = bank/line combo).  

# Subroutine: fakt_malproff  
(New in v8.15)  
– Cursor on VHISPF where VHDATO=w_date and VHKODE=‘MP’.  
– For each record: EVR/inventory/unit conversion.  
– Populate BRIDIUR, with bidkun fixed to 59997 and memo code ‘MP’.  

# Supplier Resolution Helpers  
• **hent_rlev** (RLEVL1): lookup VVLDOR or override per RDS table → w_ldor, w_ltxt  
• **hent_jlev** (JLEVPF): lookup logistic owner (NOBB) → w_ldor, w_ltxt  

# Rest‐Quantity Calculation (calc_rest)  
(v8.10)  
– Scans FODTLV for delivered vs. invoiced quantity mismatches.  
– Adds back undelivered remainder to BIDOQT.  

# Key Takeaways for Onboarding  
- The program unifies three different sales sources into one staging file.  
- EVR (VVARL1) and Inventory (VLAGL1) check ensures only relevant items are exported.  
- Unit conversion via VVENLR is critical to normalize quantities.  
- Supplier logic is multi‐step: default, logistic owner, NOBB owner, plus RDS override.  
- The BRIDIUR file is updated (insert/update) based on composite key (mem+item+warehouse+id).  
- New Malproff routine follows the same patterns using VHISPF as source.