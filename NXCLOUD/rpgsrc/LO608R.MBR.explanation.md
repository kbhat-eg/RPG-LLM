# RPG Program: LO608R – Start Print of Order/Purchase Papers

This IBM ILE RPG program (named **LO608R**) is used for starting the print of order or purchasing documents. Below, you'll find a detailed line-by-line explanation of the code, focusing on its purpose, structure, and key logic.

---

## 1. Program Header

```rpg
H DATEDIT(*DMY)
```
- Sets the default date format for the program to Day/Month/Year.

The long block of comments describes:
- Program information, version history, and change log.
- "Beskrivelse" (Norwegian): Description of the program's purpose – starting print of orders/purchases.

---

## 2. File Declarations

```rpg
FVOTYL1    IF   E           K DISK    RENAME(VOTYPFR:VOTYL1R)
FLSTSL1    IF   E           K DISK    RENAME(LSTSPFR:LSTSL1R)
FLPM1LU    UF A E           K DISK    RENAME(LPM1PFR:LPM1LUR)
```
- Declares three files, all keyed, for input/output.
    - **VOTYL1**: Order type register
    - **LSTSL1**: Stock status code register  
    - **LPM1LU**: Pick-1 line register

Each uses the `RENAME` keyword to use different record format names internally.

---

## 3. Data Structure and Variable Definitions

### Data Structures

```rpg
D                 DS
D  LDAMBR                 1     10
D  LDABOK                 1      1
D  LDAFIR                 2      4  0
D  LDALST                 5     10  0

D                UDS
D  DSWSID               901    910
D  DSUSER               911    920
D  DSSFIR               944    946  0
```
- **DS**: Used for passing parameters, e.g., for calls and outputs.
- **UDS**: User Data Structure, often mapped to program status data for job/user info.

### Standalone Variables

```rpg
d wwdato_6        s              6  0
d wwdato          s               d   datfmt(*iso)
d WWPERI          s              4  0
d WWPERI_ALF      s              8
d W_OTYP          s              2
d W_OT02          s              2
d W_OT03          s              2
d W_OT04          s              2
d W_OT05          s              2
d w_peri          s              6  0
```
- Used for various date, period, and type fields.

---

## 4. Main Processing Logic (Calcs)

### Direct Print or Exit

```rpg
C     WPNUMM        IFNE      *ZERO
C                   MOVE      WPOTYP        W_OTYP
C                   ELSE
C                   GOTO      XSLUTT
C                   END
```
- If **WPNUMM** (order number) is NOT zero, continue to process print.
- If zero, exit (`GOTO XSLUTT`).

### Initialize Direct Print Flag

```rpg
C                   MOVE      *ZERO         WPDIRK
```
- Clears/Resets direct print indicator.

### Retrieve Order Type Information

```rpg
C                   MOVE      W_OTYP        OTYTYP
C     OTYKEY        CHAIN     VOTYL1R                            90
```
- Loads the order type structure and reads (CHAINs) the order type register.

### Prepare Parameters for Print Program Call

```rpg
C                   MOVE      *ZERO         WWVALG
C                   EXSR      PARAM
C                   CALL      'LO112C'
C                   PARM                    LDAMBR
```
- Sets up **WWVALG** (print parameter selector), calls a subroutine (`PARAM`) to set up a parameter area.
- Calls external program **LO112C**, passing it the parameter block **LDAMBR**.

---

## 5. Program Exit Routine

```rpg
C     XSLUTT        TAG
C                   SETON                                        LR
C                   RETURN
```
- If program should exit (e.g., no order number), sets last record indicator (LR) and returns.

---

## 6. PARAM Subroutine (Setting Print Parameters)

```rpg
C     PARAM         BEGSR
C                   MOVE      WWVALG        PM1LST
C     PM1KEY        CHAIN     LPM1LUR                            90
C                   MOVE      WPOUTQ        LK1UTQ
...
C                   MOVE      0             LK1VG3

8.01   // Henter periode fra dagens dato
8.01       w_peri = (%subdt(%date():*years) * 100) +
8.01                 %subdt(%date():*months);
8.01 c                   eval      lk1per = w_peri
8.01 c                   eval      lk1dat = %date()
```
- Moves input and computed parameter values to the Pick-1 line record fields.
- Calculates and stores the current period (year*100 + month) and date in the line register.

**Update or Write the Record:**
```rpg
C     *IN90         IFEQ      *OFF
C                   UPDATE    LPM1LUR
C                   ELSE
C                   MOVE      PM1FIR        LK1FIR
C                   MOVE      DSWSID        LK1WSD
C                   MOVE      DSUSER        LK1USR
C                   MOVE      WWVALG        LK1LST
C                   WRITE     LPM1LUR
C                   END
```
- If the record existed, update; if not, populate required fields and write as new.

---

## 7. *INZSR Initialization Subroutine

```rpg
CSR   *INZSR        BEGSR
C                   MOVE      *ZERO         WCQNNN            1
C                   MOVE      *ZERO         WCNUMM            6 0
```
- Runs at program start.
- Zeroes out control fields.

**Field Redefinition and Key Definitions:**
- Uses `DEFINE` statements to alias variables, mostly for record keys.
- Sets up key-lists (KLIST) for the various files.

---

## 8. Entry Parameter List

```rpg
C     *ENTRY        PLIST
C                   PARM                    WPSKOR            1
C                   PARM                    WPFIRM            3 0
C                   PARM                    WPNUMM            8 0
C                   PARM                    WPSUFF            2 0
C                   PARM                    WPOTYP            2
C                   PARM                    WPDIRK            1 0
C                   PARM                    WPOUTQ           10
```
- The program expects several parameters:
    - **WPSKOR**: ?
    - **WPFIRM**: Company number
    - **WPNUMM**: Order number
    - **WPSUFF**: Suffix
    - **WPOTYP**: Order type
    - **WPDIRK**: Direct print indicator
    - **WPOUTQ**: Output queue for printing

**Applies Company/Job/User Info to Keys/Fields:**
```rpg
C                   MOVE      WPFIRM        STSFIR
C                   MOVE      WPFIRM        OTYFIR
C                   MOVE      WPFIRM        PM1FIR
C                   MOVE      WPFIRM        LDAFIR
C                   MOVE      DSWSID        PM1WSD
C                   MOVE      DSUSER        PM1USR
```
- Prepares key fields for relevant files.

**Retrieves Status Code Information:**
```rpg
C     STSKEY        CHAIN     LSTSL1R                            90
C     *IN90         IFEQ      *OFF
C                   MOVE      LAAOT2        W_OT02
C                   MOVE      LAAOT3        W_OT03
C                   MOVE      LAAOT4        W_OT04
C                   MOVE      LAAOT5        W_OT05
C                   END
```
- Retrieves stock status code info and stores order types if found.

**Gets Latest Number from Another Program:**
```rpg
C                   CALL      'L�900R'
C                   PARM                    WCQNNN
C                   PARM                    WCNUMM
C                   MOVE      'A'           LDABOK
C                   MOVE      WCNUMM        LDALST
```
- Gets the latest reference/order number via a call to program **L�900R**.

---

## 9. Keylists (KLIST)

These set up compound keys for record access:

```rpg
C     STSKEY        KLIST
C                   KFLD                    STSFIR

C     OTYKEY        KLIST
C                   KFLD                    OTYFIR
C                   KFLD                    OTYTYP

C     PM1KEY        KLIST
C                   KFLD                    PM1FIR
C                   KFLD                    PM1WSD
C                   KFLD                    PM1USR
C                   KFLD                    PM1LST
```
- These KLISTs are used for CHAIN/UPDATE/WRITE operations on the files declared at the top.

---

## **Summary of Program Flow**

1. **Initialize:** Set up variables, keys, and receive parameters.
2. **Check if Order Number Provided:** If not, exit.
3. **Fetch Order Type Data:** From order type register file.
4. **Set up Print Parameters:** Via PARAM subroutine (may update or insert new in pick line register).
5. **Call Print Program:** Passes a parameter structure to another program responsible for actual printing.
6. **Exit.**

---

## **Notable Details**

- **Language:** Norwegian variable/field names and comments, but business logic translates well.
- **Coding Style:** Classic fixed-format RPG IV, with modern free-form RPG snippets for date calculation.
- **Extensibility:** Program is modular, with subroutines and external program calls.
- **Purpose:** Central orchestration for starting print jobs for orders/purchases, integrating with registers for order types, status, and pick-line details.
- **Business Logic:** Ensures only valid orders, with company/user info and status, are processed.

---

**This code serves as a print job kick-off for warehouse or purchasing documents, interacting with multiple registers and relies on consistent setup of keys, parameter passing, and record updating/creation.**