# IBM ILE RPG Program: FP100R – Special Price Maintenance

## Program Overview

This RPG program is designed for the maintenance of special prices ("Spesialpriser, vedlikehold") in what appears to be a customer and product price matrix. It utilizes subfiles to list, search, add, modify, copy, and delete special pricing records.

## High-Level Structure

- **File Declarations**: Multiple files, including several "fpril*" files, handle special price records. Other files provide master data for customers, items, price groups, etc.
- **Display File**: Uses `fp100d` as a workstation file with subfile support.
- **Local Data Area (LDA)**: Extracts values such as the current user and firm number.
- **Indicators**: Standard RPG indicators are well documented in the comments.
- **Subroutines**: The program is extensively structured with subroutines for operations such as refreshing the subfile display, CRUD actions, and field validation.

---

## Main Components Explained

### File Definitions

- Files like `fprilr`, `fprilu`, ..., `fpril9`, handle special price records with different keys for lookup and positioning in the database.
- Supporting files such as customer, item, and unit master tables are also referenced for validation and display purposes.
- The main display file uses subfiles for the maintenance UI.

### Data Area and Information Data Structure

- The LDA (`uds`) is mapped to quickly access the current user (`l_user`), firm number (`l_firm`), and user's name (`l_fnav`).
- Display feedback data structure allows you to capture the cursor row.

### Work Variables

- Many work variables (`w_*`) manage subfile navigation, active/selected keys for filtering, and store field values for intermediate calculations.

---

## Subfile Handling

### Subfile Navigation Fields

- `w_fcrn`: First record number shown in the subfile.
- `w_stel`: Subfile record counter.
- `w_spge`: Subfile page size.
- `w_srrn`, `w_ssrn`: Record numbers for subfile management.
- `w_sfrn`: First record number on last page.

### Main Subfile Control Logic

The program uses a main loop structure (with tags like `b2taga` and `b2tagb`) for UI event handling, which includes:

- Displaying the subfile
- Handling function keys for record operations (add, change, copy, delete, display)
- Processing filters and positioning in the subfile

---

## CRUD Operations

- **Add (Create):** Subroutine `xc1bld` handles the creation of new special price records, including input validation, duplicate check, field population, and writing to the database.
- **Change (Update):** Subroutine `xc2bld` processes both changing and displaying records, including validation and updating the database.
- **Copy:** Subroutine `xk1win` allows the user to copy an existing price line, after validating no duplicates exist.
- **Delete:** Subroutine `xd1win` handles deletion after user confirmation.
- **Display:** Also managed in `xc2bld`, but with fields set as protected.

---

## Subfile Management

- **Subfile Clear:** `clr_subfile` resets relevant subfile indicators and clears data.
- **Subfile Fill:** `crt_subfile` fills the subfile with data from the database, applying any current filter or positioning keys.
- **Subfile Backward Paging:** `bck_subfile` allows the user to page backward in the subfile.
- **Display Subfile:** `dsp_subfile` presents the subfile to the user, enabling selection.

---

## Filtering and Positioning

- **Filter:** Subroutine `filter` allows the user to filter the list by customer or project, validates input, and determines correct starting keys for the subfile.
- **Positioning:** Subroutine `posisjoner` interprets input keys for fields like price group, discount category, customer, etc., and positions the database cursor accordingly before filling the subfile.

---

## Field Validation and Lookup

- **Field Validation:** `sjekk_input` validates all components of the key (price group, discount category, customer, item, etc.) before allowing an insert or update.
- **Field Lookup:** `spørring` (in Norwegian, "query") performs field lookups for help (e.g., F4 prompt), such as fetching item descriptions, customer names, etc.

---

## Record Key Management

The program defines multiple key-lists (KLISTs) for different lookup, filter, and update operations. Each is tailored with the appropriate fields for efficient direct access (`CHAIN`, `SETLL`, etc.) to the correct record(s) in the respective files.

---

## Calculations

- **Gross Margin Calculation (DG):** Subroutine `kalk_dg` computes the margin between sales and cost price, applying first and second discounts as necessary.

---

## Initialization

- The `*inzsr` subroutine (run at program start) initializes the program:
    - Loads LDA values
    - Sets the firm's number
    - Gets the current date
    - Loads the initial subfile content

---

## Additional Notes

- The program is **heavily commented and versioned** for maintainability. Each significant upgrade is marked.
- Norwegian terms are heavily used in comments and variable naming (`rkat` = rabattkategori/discount category, `kund` = customer, `vare` = item).
- Much of the business logic involves ensuring the right combination of keys and validation of master data before allowing any price entry to be created or modified.

---

## Summary Table of Common Field Prefixes

| Prefix   | Meaning             | Usage Example    |
|----------|---------------------|------------------|
| fpril*   | Special price files | fpril1, fpril2   |
| ra06pf   | Discount category   | ra06pf_fkod      |
| ra11pf   | Customer category   | ra11pf_kkod      |
| fkprl1   | Customer project    | fkprl1_kund      |
| vvarl1   | Item master         | vvarl1_vare      |
| venhl1   | Unit master         | venhl1_eenh      |
| vltpl1   | Delivery type       | vltpl1_lety      |
| w_*      | Work variable       | w_firm, w_srrn   |
| b1*, c1* | Subfile/Screen data | b1prgr, c1kund   |

---

## Typical Screen Flow

1. **Display Subfile**: Show list of special prices with options to add, edit, copy, delete, etc.
2. **Filter or Position**: User can filter by various key fields or jump to a specific record.
3. **CRUD Operation**: User chooses to add, edit, copy, delete, or view a record.
4. **Subroutines for Input Validation**: Each CRUD operation validates keys/data and fetches any required supporting info.
5. **Update Subfile**: Any change (including after copy/delete) triggers a subfile refresh, keeping the UI in sync.

---

## Onboarding Tips

- **Start with DATA**: Understand the database structure and how keys are built.
- **Learn the UI Flow**: Familiarize yourself with subfile navigation, filtering, and CRUD screens.
- **Follow the Main Loop**: The `b2taga/b2tagb` tags and the select/case structure drive user navigation.
- **Understand the Subroutines**: Each business operation is encapsulated as a subroutine (`begsr`/`endsr`).
- **Use Comments and Versions**: Comments are in Norwegian but are descriptive; check version markings for historical/business context.
- **Debugging**: Since debugging is turned OFF (`option(*nodebugio)`), use logs or temporary displays if issues arise.

---

### Reference

- For any field or action you don't understand, refer to the comments—they're extensive and capture both technical and business intent.
- Norwegian variable names directly map to business concepts:
    - prgr = price group, rkat = discount category, kund = customer, vare = item, enhe = unit, lety = delivery type.

---

**In summary**: This is a robust, user-interactive maintenance program for managing special (contractual) prices based on multiple criteria, with strong validation, subfile-based UI, and full audit trail (date/user/time stamping). 

If onboarding, focus on understanding the key structure of special prices and the subfile UI logic, as they are central to all operations in the code.