# AB101R – User Export Program Documentation

## Overview

**System:** Administrasjon  
**Program:** AB101R  
**Description:** Export of user profiles.

This program is designed to extract user information from the system, format it, and export it to an intermediate file (`LXL4ST`). Optionally, it can trigger an external process to export this data to Excel via a URL, depending on system configuration. The program also interacts with several other modules and relies on business logic for user profile handling and export control.

---

## File Definitions

- **AUSRL1**: Input file, keyed, representing the list of user profiles to be exported.  
  - Renamed record format: `AUSRPFR` → `AUSRL1R`.

- **LXL4ST**: Output file, keyed, used as a staging area for exported user data.  
  - Renamed record format: `LXL4ST` → `LXL4STR`.

---

## Data Structures

### Date and Time Handling

- **d_dato** (6,0): Holds date as a packed decimal (YYMMDD).
  - Overlays extract year (`d_aar`), month (`d_mnd`), and day (`d_dag`).

- **d_tid** (6,0): Holds time as a packed decimal (HHMMSS).
  - Overlays extract hour (`d_tim`), minute (`d_min`), and second (`d_sek`).

- **x_tid** (8A): Character representation of time, formatted as `HH:MM:SS` for output.

### Variables

- **w_numm**: Sequence number for this export batch.
- **w_kode/w_fell/w_type/w_fast**: Parameters for fetching the next sequence number from a system counter.
- **w_dato/w_tid**: Temporary variables for date/time fetched from the user profile.
- **w_date/w_time**: ISO-formatted date/time (not always used).
- **w_excel_url**: URL for Excel export, retrieved from configuration.
- **w_firm**: Company identifier, used for system-wide settings.
- **u_excl**: Export-to-Excel flag (on/off).
- **p_excel_url**: Parameter passed to the Excel export program.

---

## External Program and Procedure Calls

- **AS100R**: Retrieves the next available sequence number for export batches.
- **CO402R**: Fetches configuration values (here, the Excel export URL and enablement flag).
- **AB101C**: Called to perform the actual Excel export, passing the URL and sequence number.

---

## Main Processing Logic

### Initialization (`*INZSR`)

- Initializes control variables and retrieves the next batch sequence number by calling `AS100R`.
- Calls `CO402R` to determine if Excel export is enabled and to retrieve the export URL.
  - If enabled (`co402_verdi1 = '1'`), sets `u_excl = *on` and stores the URL.

### User Export Loop

1. **Read AUSRL1 (user profiles):**
   - For each user record:
     - Clear the output record buffer (`lxl4str`).
     - Fetch last sign-on date (`uppsod`) and time (`uppsot`) from the `USRPRF` table using embedded SQL, keyed by the user ID (`abuser`).
     - Parse and format date/time for output.
     - Populate the output record fields:
       - `lx4ide`: Export batch number.
       - `lx4usr`: User ID.
       - `lx4nam`: User name.
       - `lx4pad`: Last sign-on date (set to lowest value if unavailable).
       - `lx4pat`: Last sign-on time (set to lowest value if unavailable).
       - `lx4lag`: Warehouse.
       - `lx4avd`: Department.
     - Write the formatted record to `LXL4ST`.
     - Continue to next user.

### Excel Export (Optional)

- If Excel export is enabled (`u_excl = *on`):
  - Call `AB101C`, passing the export URL and batch number.
  - After export, delete the exported records from `LXL4ST` for this batch.
  - Commit the transaction.

### Program Termination

- Sets `*INLR = *ON` to close files and exit the program.

---

## Business/Domain-Specific Logic

- **Export Batching:**  
  Each run is assigned a unique batch number (`w_numm`), retrieved from a central counter (`AS100R`). This ensures traceability and prevents record collisions.
  
- **Excel Export Enablement:**  
  The ability to export to Excel is controlled centrally via a configuration value (`CO402R`) associated with the key `'NX_EXCEL_URL'`. This allows system administrators to enable/disable Excel export and update the target URL without code changes.

- **User Profile Data:**  
  The program relies on the `USRPRF` table for last sign-on information. Note that SQL is used for this, which may be due to system architecture or performance considerations.

- **Cleanup:**  
  After a successful Excel export, exported records are deleted from the staging file to prevent duplication and manage storage.

---

## Design Patterns, Conventions, and Notes

- **Record Format Renaming:**  
  Input and output files are renamed for clarity and to avoid naming conflicts.

- **Use of Overlays:**  
  Overlays are extensively used for parsing date and time fields, a common pattern in legacy RPG code.

- **Configuration via External Programs:**  
  System-wide settings (like Excel export enablement and URLs) are fetched via external programs, supporting centralized configuration management.

- **Modular Export Logic:**  
  The actual Excel export is delegated to a separate program (`AB101C`), promoting separation of concerns and easier maintenance.

- **Transactional Integrity:**  
  The program uses SQL `COMMIT` after deletion to ensure data consistency.

---

## Inter-module Relationships

- **AS100R:**  
  Provides the next available sequence number for export batches.

- **CO402R:**  
  Acts as a configuration service for retrieving system-wide settings.

- **AB101C:**  
  Handles the actual export of user data to Excel.

- **USRPRF Table:**  
  Source of user profile information, specifically last sign-on date/time.

---

## Error Handling and Limitations

- **Minimal Error Handling:**  
  The program assumes successful execution of external calls and SQL statements. Additional error handling may be needed for production robustness.

- **Legacy RPG Style:**  
  The code mixes traditional fixed-format RPG with modern free-format SQL, reflecting incremental modernization.

- **Hard-coded Configuration Keys:**  
  The configuration key `'NX_EXCEL_URL'` is hard-coded, which may be a maintenance consideration if additional export destinations are required.

---

## Summary

AB101R is a batch program for exporting user profile data to a staging file, with optional Excel export based on system configuration. It leverages external programs for configuration and batch numbering, and uses embedded SQL for fetching auxiliary user data. The program is structured for modularity and central configuration, supporting easy enablement/disablement of export features and consistent batch processing.