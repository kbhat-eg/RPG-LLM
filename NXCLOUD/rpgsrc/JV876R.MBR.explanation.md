# IBM ILE RPG Program Explanation

## Overview

This RPG III/IV program (JV876R) runs on IBM i systems (formerly known as AS/400). It updates "contact person" information from a NOBB XML feed, as noted in the header comments (“Oppdater fra NOBB, kontaktperson”). The code is written in a classic fixed-format style (with C/F/D specs), and includes embedded SQL.

The workflow is:
- Receives contact person data as parameters.
- Deletes old contacts if specified.
- Inserts (writes) a new contact.
- Handles errors, logs job activities, and manages end-of-job cleanups.

Below, you’ll find structured explanations for its key sections.

---

## Header and Metadata

```rpg
h option(*nodebugio: *srcstmt) datedit(*dmy)
```
- Disables debug for I/O operations, sets debugging to source statement lines, and sets date editing to DMY format.

Header comments include program name, description, change history, etc.

---

## File Declarations

```rpg
fjstsl1    if   e           k disk    rename(jstspfr:jstsl1r)
f                                     infsr(FileErr)
fjlkplu    uf a e           k disk    rename(jlkppfr:jlkplur)
fjlgslu    uf   e           k disk    rename(jlgspfr:jlgslur)
```
- `fjstsl1`, `fjlkplu`, `fjlgslu` are logical files (database tables) used in the program.
- `rename` changes the externally-described record format name to a local name.
- `infsr(FileErr)` sets a file error subroutine.

---

## Data Definitions

### Simple Data Definitions

- Various variables for keys, parameters, job logging, and date handling.
- Example: 
    - `jlkplu_pldo` – field for key lookups. 
    - `p_jbid`, `p_jsts`, `p_jmld` – for job logging.

### Local Data Area Overlay

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
```
- Overlays the Program Status Data Structure (PSDS) to access specific user and firm IDs from the LDA (local data area).

### Data Structures (DS)

- **Contact Person Data:**
    - `d_konrec` (200 chars), overlaid by individual fields (`d_jkpldo`, `d_jkptel`, etc.).
    - This represents incoming contact info—each field is mapped to known character positions within the buffer.

- **Job Log Data:**
    - `d_job_log` (50 chars), with overlays for event types and numbers.

- **Exception Information:**
    - `PgmError SDS` – overlays the RPG program status data structure to access error information, current line, status codes, etc.

---

## Main Program Logic

### Initialization

- **Embedded SQL Option**
    ```rpg
    C/Exec SQL
    C+  Set Option DatFmt=*ISO
    C/End-Exec
    ```
    - Sets default SQL date format to ISO.

- **Parameter Assignment**
    - Assigns job log and incoming record data (`d_job_log = p_job_log`, `d_konrec = p_drec`).

### Core Processing

```rpg
c                   if        p_inlr = *on
c                   eval      d_konrec = p_drec
    ...
c                   if        d_jkptel_num = 1
c                   exsr      slett_konp
c                   endif
c                   exsr      skr_kont
c                   endif
```
- If `p_inlr = *on` (end-of-job requested), loads the input record.
- If the telephone number (`d_jkptel_num`) is 1, deletes existing contacts (“slett_konp” subroutine).
- Always writes new contact info (“skr_kont” subroutine).

- After processing, updates job log output parameter.

### Program End

```rpg
c     avslutt       tag
c                   if        p_inlr <> *on
c                   eval      *inlr = *on
c                   endif
c                   return
```
- If not end-of-job, sets LR indicator to end the program.

---

## Subroutines

### File Error Handler

```rpg
c     FileErr       begsr
    ...
c                   eval      p_stat = '1'
c                   eval      p_jsts = 50
c                   eval      p_jmld = 'Fil ' + %trim(last_file) + ...
c                   call      'AB705R'
c                   parm                    p_jbid
c                   parm                    p_jsts
c                   parm                    p_jmld
c                   goto      avslutt
c                   endsr
```
- Builds job log message using error information.
- Calls an external program (`AB705R`) to log errors.
- Jumps to program end (“avslutt”).

---

### Write New Contact (`skr_kont`)

```rpg
/free
 exec sql
    SELECT IFNULL(MAX(JKPTEL), 0) into :b_stell
    FROM JLKPPF WHERE JKPLDO = :d_jkpldo_nym ;
/end-free
...
c                   clear                   jlkplur
...
c                   eval      jkpldo = d_jkpldo_nym
c                   eval      jkptel = b_stell + 1
c                   eval      jkpnav = %trim(d_jkpnav)
c                   eval      jkpttl = %trim(d_jkpttl)
...[more fields]...
c                   write     jlkplur
c                   endsr
```
- Uses SQL to get the maximum contact person number (JKPTEL) for the participant (JKPLDO), incremented by 1 for the new record.
- Clears the contact file record buffer.
- Populates fields with trimmed input.
- Writes the record to the contact person file (`jlkplur`).

---

### Delete Existing Contacts (`slett_konp`)

```rpg
c                   eval      jlkplu_pldo = d_jkpldo_nym
c     jlkplu_key    setll     jlkplur
c     jlkplu_key    reade     jlkplur
c                   dow       not %eof(jlkplu)
c                   delete    jlkplur
c     jlkplu_key    reade     jlkplur
c                   enddo
c                   endsr
```
- For the given participant key, reads and deletes all contact person records.

---

### *INZSR: Program Initialization

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_drec
c                   parm                    p_job_log
c                   parm                    p_inlr
...[key lists]...
c                   eval      w_firm = l_firm
c                   time                    w_dato
...
c     jstsl1_key    chain     jstsl1
c                   endsr
```
- Receives parameter list: incoming record, job log, and end-of-job flag.
- Sets up key lists for file access.
- Sets firm variable, gets current date/time.
- Fetches info from status file via key.

---

## Summary

**In Essence:**
- **Receives** a "contact person" data buffer and job log information.
- **Deletes** old contact persons for a participant (if flagged).
- **Writes** a new contact person record with the incremented contact number.
- **Handles errors** robustly and logs job activity.
- **Uses overlays** and shared buffers for field extraction and data structuring.

**Why is it written this way?**
- Maximizes legacy RPG efficiency: overlays, key lists, and subroutines were best practices for performance and maintainability in classic environments.
- Integrates with IBM i DB2 and job logging systems.

**Key onboarding point:** If you’re coming from modern RPG (RPGLE/free) or other languages, pay attention to buffer overlays, the way parameters are handled, and the strong coupling to DB2 files and OS/400’s job and error handling mechanisms.