# Source Code Explanation: AX720R "Checking if F3 is Allowed on Menu"

## Overview

This RPG (ILE RPG, fixed format) program, named **AX720R**, is part of the ASPGPL system. Its purpose is to determine if the user is permitted to use the F3 function key (often "Exit" or "Cancel") from a particular menu. The program is parameterized, taking a menu name and returning a status indicator (0 = F3 is allowed, 1 = F3 not allowed).

---

## Parameters

- `p_meny` (10A): **Input**. The menu name you want to check.
- `p_stat` (1A): **Output**. Status indicator. Set to `'1'` if F3 is *not* allowed from this menu (first menu), `'0'` if F3 is allowed.

---

## Data Definitions

- **File Declaration:**
  - `fausrl1`: File `AUSRL1` is declared keyed, externally described, and renamed as `AUSRL1R`.

- **Work variables:**
  - `ausrl1_user` (like `abuser`): Holds user ID for keying into the file.
  - `w_firm` (3,0): Possibly company code (not used in logic shown).
  - `w_srrn` (4,0): Possibly a sequence or record number (not used in logic shown).
  - `w_meld` (50A): Message text for informational messages.

- **Local Data Area Mapping:**
  - `l_user`: Positions 911-920 of the LDA, representing the current user.
  - `l_sfir`: Positions 944-946 of the LDA, possibly the firm code.

---

## Indicator Usage

Standard RPG indicators are listed (not all are used in this code), e.g., LR (last record), 10-99 for specific UI, error, and work indicators.

---

## Main Program Logic

1. **Initialize Key:**
    ```rpg
    c                   eval      ausrl1_user = l_user
    ```
    Set the user variable for file access using the user ID from LDA.

2. **File Lookup:**
    ```rpg
    c     ausrl1_key    chain     ausrl1
    ```
    Perform a keyed lookup in `AUSRL1` for the current user.

3. **If User Found:**
    ```rpg
    c                   if        %found
    ```
    If the user exists in the file, process further.

    a. **Menu Name Mapping (Special Cases):**
       The code adjusts the real menu name for several "start" menu names, mapping things like `'FSTART'` and its variants to standard internal menu names like `'FM00'`. This prevents users from bypassing start menus with alternate names.

    b. **Is This the User's First Menu?**
       ```rpg
       c                   if        %trim(abmeny)<>*blank and
       c                             %trim(abmeny)=%trim(p_meny)
       ```
       If the (possibly remapped) last menu shown (`abmeny`) equals the input parameter, it's the first menu for this user.

        - **Set Status and Message**  
          - Set `p_stat` to `'1'` (F3 not allowed).
          - Compose an explanatory message.
          - Call program `'AA005R'` to display/inform the user.

    c. **Otherwise:**
       - Set `p_stat` to `'0'` (F3 OK).

4. **If User Not Found:**
   - Set `p_stat` to `'0'`.

5. **Program End:**
   - Set LR (`*INLR`) to on to end the program.

---

## Initialization Subroutine (`*INZSR`)

- **Entry Parameter List:**
  - Sets up the parameter list and binds `p_meny`, `p_stat`.

- **File Key Setup:**
  - Defines a key list for accessing `AUSRL1` based on user.

- **Variable Initialization:**
  - Resets `p_stat` to `'0'`.

---

## Additional Notes

- **File `AUSRL1`:** Looks like it tracks the last menu visited by each user.
- **Parameter Flow:** The program is likely called from a menu controller: it checks if the user's current menu is their "first menu" (i.e., they shouldn't be able to exit), and otherwise allows F3.
- **Remapping Menus:** The remapping of start menus to internal names standardizes logic, so many variants point to a common "first menu."
- **Message Handling:** If F3 is not allowed, the program notifies the user via a standard message program (`AA005R`).

---

## Summary Table

| Variable    | Type | Description                               |
|-------------|------|-------------------------------------------|
| p_meny      | 10A  | Name of the menu being checked            |
| p_stat      | 1A   | Status: '1'=F3 not allowed, '0'=allowed   |
| ausrl1_user | like abuser | User ID for file key               |
| abmeny      | ?    | Last menu visited by user (in AUSRL1)     |
| w_meld      | 50A  | Message text for user                     |
| *INLR       |      | Indicator to end program                  |

---

### In Short

This program ensures that F3 (Exit) cannot be used from a user's designated "first menu" (start menu), based on user tracking. For all other menus, F3 is permitted. The menu mapping logic allows for multiple start menus to be handled uniformly. If F3 is disallowed, a standard message is shown to the user.