     h option(*nodebugio : *srcstmt) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASVADM
      * Program . . . . : JK100R
      * Beskrivelse . . : Logistikkvare hode, vedlikehold
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       011018 BKV  Nytt program
7.01  * 7.00  010319 bkv  Lagr på posisjonering på undervare og leverandør
7.01  * 7.00  191220 bof  Tillate å endre hovedvarenr
7.02  * 7.00  211220 bof  Manglet C2KNUP på allerede eksisterende varer
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Bruk av indikatorer:
      *
      *       LR = Avslutt program
      *       10 = Roll
      *       11 = Rolldown
      *       12 = Sfldsp
      *       13 = Sfldspctl
      *       14 = Sflclr
      *       15 = Sflend
      *       21 = Home-key
      *       22 = Plassering av cursor
      *       30 = Protect av felter ved vise
      *    31-79 = Varsle m/feilmeldinger/skjermindikatorer
      *    80-99 = Arbeidsindikatorer
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fjvkhl1    if   e           k disk    rename(jvkhpfr:jvkhl1r)
     fjvkhlr    if   e           k disk    rename(jvkhpfr:jvkhlrr)
     fjvkhlu    uf a e           k disk    rename(jvkhpfr:jvkhlur)
     fjvklpf    if   e           k disk    rename(jvklpfr:jvkll1r)
     fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
     fjlevl1    if   e           k disk    rename(jlevpfr:jlevl1r)
     fjvlelr    if   e           k disk    rename(jvlepfr:jvlelrr)
     fafpslr    if   e           k disk    rename(afpspfr:afpslrr)
     f
      *
     fjk100d    cf   e             workstn sfile(b1sfl:w_srrn)
     f                                     infds(dspfbk)
      *
      * Definering av parametre
      *
     d p_dflldor       s              6  0
      *
      * Definering av Local data area
      *
     d                uds
     d l_user                911    920
     d l_filg                931    933
     d l_firm                944    946  0
     d l_fnav                951    980
      *
      * Definering av Information Data Structure - display feedback
      *
     d dspfbk          ds
     d  d_fcrn               378    379I 0
      *
      * Definering av variabler i nøkler
      *
     d jvkhl1_vare     s                   like(jvkvnr)
     d jvkhlr_vare     s                   like(jvkvnr)
     d jvkhlu_vare     s                   like(jvkvnr)
     d jvarl1_vare     s                   like(jvvare)
     d jlevl1_ldor     s                   like(jlldor)
     d jvlelr_lvnr     s                   like(jvlvnr)
     d afpslr_ufil     s                   like(l_filg)
     d afpslr_uide     s                   like(afuide)
      *
      * Definering av variable
      *
     d w_fcrn          s              4  0
     d w_stel          s              4  0
     d w_spge          s              4  0
     d w_srrn          s              4  0
     d w_sfrn          s                   like(w_srrn)
     d w_ssrn          s                   like(w_srrn)
      *
     d w_seqe          s              1
     d b_oppr          s              1    inz(*off)
     d b_forn          s              1    inz(*off)
     d b_anul          s              1    inz(*off)
      *
     d b_akti          s              1    inz(*off)
     d w_udat          s                   like(jvluda)
     d w_vdpl          s              3  0
     d w_ldpl          s              3  0
     d w_evrv          s              2  0
     d w_dplunvar      s              3  0
     d w_dpllovar      s              3  0
     d w_dflldor       s                   like(p_dflldor)
      *
     d w_firm          s                   like(jvkfir)
     d w_vare          s                   like(jvkvnr)
     d w_valg          s              1  0
     d w_ldor          s                   like(jvkldo)
     d w_lldo          s                   like(jvldor)
     d w_llna          s                   like(jlnavn)
     d w_quno          s                   like(jvquno)
     d w_jwldor        s                   like(jvldor)
     d w_jvlvei        s                   like(jvlvei)
     d b_open_sok      s              1    inz(*off)
     d w_levr          s              6  0
     d w_ldox          s              6
     d w_dumm          s              1    inz('*')
      *
     d sqlquery        s           4096
     d w_antvar        s              3  0
     d w_teller        s              3  0
     d w_teller2       s              3  0
     d w_vtek1         s                   like(b1tek1)
     d w_hlevn         s                   like(b1hlen)
     d b_vgrpsjekk     s              3  0
     d b_inlr          s              3    inz(*off)
      *
      *  Tabell DS
      *
     d ds_jvarpf     E ds                  extName(jvarpf)
     d* ds_jvpkpf     E ds                  extName(jvpkpf)
     d ds_jvprpf     E ds                  extName(jvprpf)
     d ds_jvlepf     E ds                  extName(jvlepf)
      *
      * Definering av konstanter
      *
     d c_sfil          s              2  0 inz(15)
      *
      * Forklaring på spesielle felter
      * som benyttes ved sub-files.
      * - - - - - - - - - - - - - - - - -
      * w_fcrn - Første recordnummer på siden
      * w_stel - Subfile-teller
      * w_spge - Sidestørrelse i subfile (page)
      * w_srrn - Relativt recordnummer i subfile
      * w_sfrn - Første recordnummer på siste side
      * w_ssrn - Siste recordnummer på siste side
      * w_curn - Current recordnummer på siden
      * w_virn - Side og cursorplassering som skal vises
      * w_afld - Aktivt feltnavn
      * w_arow - Aktiv rad for cursor
      * w_acol - Aktiv kolonne for cursor
      *
      * Benyttede skjermbilder.
      * - - - - - - - - - - - - - - - - -
      * B1SFL  - B1 Subfile - record
      * B2CTL  - B2 Subfile - control record
      * B2CMD  - B2 Eget skjermbilde for CMD-taster
      * C1BLD  - C1 Skjermbilde for innlegging av nøkkel ved oppretting
      * C2BLD  - C2 Skjermbilde for opprette/endre/vise
      * C3BLD  - C3 Skjermbilde for å vise melding/tekstlinje
      * D1WIN  - D1 Vindu for slette (Delete)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * B2CTL Behandle åpningsbildet med subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     C/Exec SQL
     C+  Set Option DatFmt=*ISO , commit=*none
     C+  , DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
     C/End-Exec
      *
      * Send Alt
      *
     c     b2taga        tag
      *
     c                   write     b2cmd
      *
      * Bare data
      *
     c     b2tagb        tag
      *
     c                   exsr      dsp_subfile
      *
      * Behandling av funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   goto      avslutt
     c                   when      *inke
     c                   exsr      forny
     c                   goto      b2tagb
     c                   when      *inkf
     c                   exsr      xc1bld
     c                   goto      b2taga
6.37 c                   when      *inkm
6.37 c                   exsr      xb13win
6.37 c                   goto      b2tagb
     c                   when      *in10
     c                   exsr      crt_subfile
     c                   goto      b2tagb
     c*                   when      *in11
     c*                   exsr      bck_subfile
     c*                   goto      b2tagb
     c                   when      *in21
     c                   eval      *in22 = *on
     c                   goto      b2taga
     c                   endsl
      *
      * Posisjonering
      *
7.01 c                   if        b2vare <> *blank or
7.01 c                             b2uvar <>  *blank or
7.01 c                             b2ldor <>  *zero
     c                   exsr      posisjoner
     c                   goto      b2tagb
     c                   endif
      *
      * Behandling av subfile
      *
     c                   exsr      subfile
      *
     c                   goto      b2taga
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for fornying av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     forny         begsr
      *
     c                   if        w_fcrn <> 0
     c     w_fcrn        chain     b1sfl
     c                   endif
      *
     c                   eval      w_seqe = *blank
     c                   eval      b_open_sok = *on
     c*                   select
     c*                   when      w_seqe = 'V'
     c*                   eval      b_open_sok = *on
     c*                   other
     c*                   eval      b_open_sok = *on
     c*                   endsl
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c     end_forny     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for posisjonering i subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     posisjoner    begsr
      *
     c                   eval      w_seqe = *blank
      *
      * Varenummer
      *
     c                   if        b2vare <> *blank
     c                   eval      w_seqe = 'V'
     c                   eval      b_open_sok = *on
     c                   goto      end_pos
     c                   endif
7.01  *
7.01  * Undervare
7.01  *
7.01 c                   if        b2uvar <> *blank
7.01 c                   eval      w_seqe = 'N'
7.01 c                   eval      b_open_sok = *on
7.01 c                   goto      end_pos
7.01 c                   endif
7.01  *
7.01  * Leverandør
7.01  *
7.01 c                   if        b2ldor <> *zero
7.01 c
7.01 c                   eval      w_seqe = 'L'
7.01 c                   eval      b_open_sok = *on
7.01 c                   goto      end_pos
7.01 c                   endif
      *
     c     end_pos       tag
      *
      * Blanker subfile, og fyller opp i.h.t. posisjonering
      *
     c                   eval      *in22 = *off
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
      * Blanker posisjoneringsfelter
      *
     c                   eval      b2vare = *blank
7.01 c                   eval      b2uvar = *blank
7.01 c                   eval      b2ldor = *zero
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     subfile       begsr
      *
     c                   eval      b_forn = *off
      *
     c                   if        *in22 = *off
     c                   eval      *in22 = *on
     c                   else
     c                   eval      *in22 = *off
     c                   endif
      *
     c                   eval      w_virn = w_fcrn
      *
      * Leser og behandler subfile
      *
     c                   do        w_ssrn
     c                   readc     b1sfl
      *
     c                   if        %eof
     c                   leave
     c                   endif
      *
     c                   eval      *in22 = *off
     c                   eval      w_virn = w_srrn
      *
      * Endre
      *
     c                   if        b1valg = 2
     c                   eval      c2vare = b1vare
     c                   eval      c2tek1 = b1tek1
     c                   eval      c2kldo = b1kldo
     c                   eval      c2hlen = b1hlen
     c                   exsr      xc2bld
     c                   exsr      sjekk_vargrp
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Slett
      *
     c                   if        b1valg = 4
     c                   eval      d1vare = b1vare
     c                   eval      d1vtxt = b1tek1
     c                   exsr      xd1win
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vis
      *
     c                   if        b1valg = 5
     c                   eval      c2vare = b1vare
     c                   eval      c2tek1 = b1tek1
     c                   eval      c2kldo = b1kldo
     c                   eval      c2hlen = b1hlen
     c                   exsr      xc2bld
     c                   exsr      sjekk_vargrp
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Bygg undervare
      *
     c                   if        b1valg = 6
     c                   eval      w_vare = b1vare
     c                   call      'JK702R'
     c                   parm                    w_vare
     c                   parm                    w_levr
     c                   parm                    w_dumm
     c                   exsr      sjekk_vargrp
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vis undervare
      *
     c                   if        b1valg = 7
     c                   eval      w_vare = b1vare
     c                   call      'JK110R'
     c                   parm                    w_vare
     c                   exsr      sjekk_vargrp
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vis varekort
      *
     c                   if        b1valg = 8
     c                   eval      w_vare = b1vare
     c                   eval      w_valg = 2
     c                   call      'JV101R'
     c                   parm                    w_firm
     c                   parm                    w_vare
     c                   parm                    w_valg
     c                   eval      b1valg = 0
     c                   exsr      sjekk_vargrp
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vis varekort
      *
     c                   if        b1valg = 9
     c                   eval      w_vare = b1vare
     c                   call      'JV510R'
     c                   parm                    w_firm
     c                   parm                    w_vare
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
     c                   enddo
      *
     c                   if        b_forn = *on
     c                   exsr      forny
     c                   endif
      *
     c     end_subfile   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av skjermbilde for ny rad (C1BLD)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc1bld        begsr
      *
     c                   eval      b_oppr = *on
     c                   eval      b_forn = *off
      *
     c                   eval      c1vare = ''
      *
     c     c1taga        tag
      *
     c                   if        c1vare = ''
     c                   eval      c1tek1 = ''
     c                   eval      c1tek2 = ''
     c                   endif
      *
     c                   exfmt     c1bld
      *
      * Behandling av funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   goto      end_c1bld
     c                   endsl
     c
      *
      * F4=Spørring
      *
     c                   if        *inkd
      *
     c                   if        w_afld = 'C1VARE'
     c                   movel     c1vare        w_vare
     c                   call      'JV500R'
     c                   parm                    w_firm
     c                   parm                    w_vare
     c                   parm                    c1tek1
     c                   movel     w_vare        c1vare
     c/exec sql
     c+ select IFNULL(jvtek1, '''') ,IFNULL(jvtek2, '''')
     c+  into  :c1tek1, :c1tek2  from jvarpf
     c+ where jvvare = :w_vare
     c/end-exec
     c                   goto      c1taga
     c                   endif
      *
     c                   goto      c1taga
      *
     c                   endif
     c                   movel     c1vare        w_vare
     c/exec sql
     c+ select IFNULL(jvtek1, '''') ,IFNULL(jvtek2, '''')
     c+  into  :c1tek1, :c1tek2  from jvarpf
     c+ where jvvare = :w_vare
     c/end-exec
      *
      * Validering av input
      *
     c
     c                   if        c1vare = '' or
     c                             %len(%trim(c1vare)) <> 8
     c                   eval      *in40 = *on
     c                   goto      c1taga
     c                   endif
     c
     c*/exec sql
     c*+ select COUNT(*) into :w_ldpl from jvlepf
     c*+ where jvlvnr = :c1vare
     c*/end-exec
     c*
     c*                   if        w_ldpl > 1
     c*                   eval      *in41 = *on
     c*                   goto      c1taga
     c*                   endif
     c
      * sjekk om logistikkvare finnes fra før
     c/exec sql
     c+ select COUNT(*) into :w_dpllovar from jvkhpf
     c+ where jvkfir = :w_firm and jvkvnr = :c1vare
     c/end-exec
     c                   if        w_dpllovar > 0
     c                   eval      *in43 = *on
     c                   goto      c1taga
     c                   endif
      * sjekk om logistikkvare er undervare
     c/exec sql
     c+ select COUNT(*) into :w_dplunvar from jvklpf
     c+ where jvqfir = :w_firm and jvquno = :c1vare
     c/end-exec
     c                   if        w_dplunvar > 0
     c                   eval      *in42 = *on
     c                   goto      c1taga
     c                   endif
     c*/exec sql
     c*+ select COUNT(*) into :w_evrv from vvarpf
     c*+ where vvfirm = :w_firm and
     c*+   vvvare = :c1vare and vvudat = '0001-01-01'
     c*/end-exec
     c*                   if        w_evrv > 0
     c*                   eval      *in44 = *on
     c*                   goto      c1taga
     c*                   endif
     c
     c*/exec sql
     c*+ select COUNT(*) into :w_vdpl from jvarpf
     c*+ where jvvare = :c1vare
     c*/end-exec
     c*                   if        w_vdpl > 0
     c*                   exsr      xc1msg
     c*                   if        b_anul = *on
     c*                   goto      c1taga
     c*                   endif
     c*                   endif
      *
      * Kaller vedlikeholdsprogram
      *
     c                   eval      c2vare = c1vare
     c                   eval      c2tek1 = c1tek1
     c                   exsr      xc2bld
      *
     c                   eval      c1vare = ''
      *
     c                   goto      c1taga
      *
     c     end_c1bld     tag
      *
     c                   eval      b_oppr = *off
     c                   eval      c1vare = ''
      *
     c                   if        b_forn = *on
     c                   exsr      forny
     c                   endif
     c
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for utlegging av opprettelsesmelding
      * Meldingsbildet legges ut dersom det forsøkes å opprette en rad som
      * finnes fra før.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc1msg        begsr
      *
     c                   eval      b_anul = *off
      *
     c                   exfmt     c1msg
      *
      * Behandling av funksjonstaster
      *
     c                   if        *inkc or *inkl
     c                   eval      b_anul = *on
     c                   leavesr
     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å behandle bilde for ny/endring/vise (C2BLD)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xc2bld        begsr
      *
     c                   eval      w_arow = 0
     c                   eval      w_acol = 0
      *
     c                   eval      jvkhlr_vare = c2vare
     c     jvkhlr_key    chain     jvkhlr
     c                   if        %found
      *
      * Initierer bildet
      *
     c                   eval      c2vare = jvkvnr
     c                   eval      c2vldo = w_levr
     c                   eval      c2vlnv = b1vlnv
     c                   eval      c2unob = b1quno
     c                   eval      c2unot = b1tek1
     c                   eval      c2kldo = b1kldo
     c                   eval      c2eusr = jvkeus
7.02 c                   eval      c2knup = jvknup
      *
     c     *dmy          move      jvkeda        c2edat
     c                   else
      *
      * Initierer bildet
      *
     c                   eval      c2kldo = 0
     c                   eval      c2vldo = w_levr
     c                   eval      c2vlnv = ''
     c                   eval      c2unob = 0
     c                   eval      c2unot = ''
     c                   eval      c2hlen = ''
     c                   eval      c2knup = 0
     c                   eval      c2eusr = l_user
     c                   eval      c2edat = 0
     c                   endif
      *
     c                   if        b1valg = 5
     c                   eval      *in30 = *on
     c                   endif
      *
     c     c2taga        tag
      *
     c                   exsr      oppdatkt
      *
     c                   exfmt     c2bld
      *
     c                   if        *inkc or *inkl or *in30
     c                   goto      end_c2bld
     c                   endif
      *
      * F4=Spørring
      *
     c                   if        *inkd
      *
     c                   if        w_afld = 'C2UNOB'
     c                   movel     c2unob        w_vare
     c                   call      'JV500R'
     c                   parm                    w_firm
     c                   parm                    w_vare
     c                   parm                    c2tek1
     c                   movel     w_vare        c2unob
     c                   goto      c2taga
     c                   endif
      *
     c                   if        w_afld = 'C2VLDO'
     c                   eval      w_ldor = c2vldo
     c                   call      'JL500R'
     c                   parm                    w_ldor
     c                   parm                    c2vlnv
     c                   eval      c2vldo = w_ldor
     c                   goto      c2taga
     c                   endif
      *
     c                   goto      c2taga
      *
     c                   endif
      *
     c                   exsr      oppdatkt
      *
      * Validering av input
      *
      *sjekk om varen finnes på annen logsitkkvare
     c/exec sql
     c+ select COUNT(*) into :w_vdpl from jvklpf
     c+ where jvqfir = :w_firm and
     c+   jvquno = :c2unob and jvqvnr <> :c2vare
     c/end-exec
      * sjekk om samme leverandør finnes på logistikkvare fra før
     c/exec sql
     c+ select COUNT(*) into :w_ldpl from jvklpf
     c+ where jvqfir = :w_firm and
     c+   jvqldo = :c2kldo and jvqvnr = :c2vare
     c+   and  jvquno <> :c2unob
     c/end-exec
      * sjekk at undervarer ikke finnes i EVR
      * aktiv hvis utgått er 0 eller beholding > 0
     c/exec sql
     c+ select COUNT(*) into :w_evrv from vvarpf
     c+ where vvfirm = :w_firm and
     c+   vvvare = :c2unob  and ( vvudat = '0001-01-01'
     c+     or (SELECT sum(VLBEHL) FROM vlagpf where vlvare = :c2unob) > 0
     c+   )
     c/end-exec
     c                   if        c2vare = *blank
     c                   eval      *in31 = *on
     c                   goto      c2taga
     c                   endif
     c                   if        c2unob = *zero
     c                   eval      *in32 = *on
     c                   goto      c2taga
     c                   endif
     c                   if        b_akti = *off
     c                   eval      *in35 = *on
     c                   goto      c2taga
     c                   endif
     c                   if        c2tek1 = *blank
     c                   eval      *in32 = *on
     c                   goto      c2taga
     c                   endif
     c                   if        c2kldo = *zero
     c                   eval      *in33 = *on
     c                   goto      c2taga
     c                   endif
     c                   if        c2hlen = *blank
     c                   eval      *in33 = *on
     c                   goto      c2taga
     c                   endif
     c                   if        c2vldo = *zero
     c                   eval      *in34 = *on
     c                   goto      c2taga
     c                   endif
     c                   if        c2vlnv = *blank
     c                   eval      *in34 = *on
     c                   goto      c2taga
     c                   endif
7.01  *sjekk om varen finnes på annen logsitkkvare
     c                   if        w_vdpl > 0
     c                   eval      *in36 = *on
     c                   goto      c2taga
     c                   endif
7.01  * sjekk om samme leverandør finnes på logistikkvare fra før
7.01  * Tillate dette
7.01 c*                  if        w_ldpl > 0
7.01 c*                  eval      *in37 = *on
7.01 c*                  goto      c2taga
7.01 c*                  endif
7.01  * sjekk at undervarer ikke finnes i EVR
7.01  * Tillate dette
7.01 c*                  if        w_evrv > 0
7.01 c*                  eval      *in38 = *on
7.01 c*                  goto      c2taga
7.01 c*                  endif
      *
      *
      * Oppdatering av logistikkvare
      *
     c                   clear                   jvkhlur
      *
     c                   eval      jvkhlu_vare = c2vare
     c     jvkhlu_key    chain     jvkhlur
      *
     c                   eval      jvkvnr = c2vare
     c                   eval      jvkldo = c2kldo
     c                   eval      jvknup = c2knup
      *
     c                   time                    jvkeda
     c                   time                    jvketi
     c                   eval      jvkeus = l_user
      *
     c                   if        %found(jvkhlu)
     c                   update    jvkhlur
     c                   exsr      nobbkopi
     c                   else
     c                   time                    jvkoda
     c                   time                    jvkoti
     c                   eval      jvkous = l_user
     c                   eval      jvkfir = w_firm
     c                   write     jvkhlur
     c                   exsr      nobbkopi
     c                   exsr      forny
     c                   endif
      *
      * Oppdater subfile
      *
     c                   if        b1valg = 2
     c                   eval      b1vare = jvkvnr
     c                   movel     c2tek1        b1tek1
     c                   eval      b1kldo = jvkldo
     c                   movel     c2hlen        b1hlen
     c                   eval      b1knup = jvknup
     c                   endif
      *
     c     end_c2bld     tag
      *
     c                   eval      *in30 = *off
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å oppdatere tekster
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     oppdatkt      begsr
     c
      *
      * Henter leverandørnavn
     c                   if        c2vldo <> *zero
     c/exec sql
     c+ select IFNULL(jlnavn, '''') into :c2vlnv from jlevpf
     c+ where jlldor = :c2vldo
     c/end-exec
     c                   endif
      * Henter varetekst-1
     c                   if        c2unob <> *zero
     c
     c                   movel     c2unob        w_vare
     c
     c/exec sql
     c+ select IFNULL(jlldor, 0), IFNULL(jlnavn, ''''), IFNULL(jvtek1, '''')
     c+  into  :w_ldor, :c2hlen, :jvtek1  from jlevpf
     c+ inner join jvarpf on  jvldor = jlldor
     c+ where jvvare = :w_vare
     c/end-exec
     c                   eval      c2kldo = w_ldor
     c                   eval      c2tek1 = jvtek1
     c                   eval      c2unot = jvtek1
      *
      * sjekk om vare er utgått hos alle prisgivere /vareeiere
      *
     c                   eval      b_akti = *off
     c                   movel     c2unob        jvlelr_lvnr
     c     jvlelr_key    setll     jvlelr
     c     jvlelr_key    reade     jvlelr
     c                   dow       not %eof(jvlelr)
      * hvis minst 1 ikke utgått-> aktiv
     c                   if        jvluda = *loval
     c                   eval      b_akti = *on
     c                   eval      *in35 = *off
     c                   endif
      * hvis utgått dato, men ikke passert i tid--> aktiv
     c                   if        jvluda <> *loval and
     c                             jvluda > w_udat
     c                   eval      b_akti = *on
     c                   eval      *in35 = *off
     c                   endif
     c     jvlelr_key    reade     jvlelr
     c                   enddo
     c                   if        b_akti = *off
     c                   eval      c2unot = %subst(c2unot:1:21) +
     c                                      ' ** UTGÅTT  **'
     c                   endif
     c                   endif
     c
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å behandle logi vare
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     nobbkopi      begsr
     c
      /FREE
       // Oppdater eller insert undervare (hoved)
       exec sql
        select count(*) into :w_teller from JVKLPF
        WHERE JVQFIR = :w_firm AND JVQVNR = :jvkvnr AND JVQUNO = :b1quno and
              JVQLDO = :jvkldo;
       if (w_teller = 0);
         exec sql
           INSERT INTO JVKLPF
           (JVQFIR,JVQVNR,JVQUNO
           ,JVQOFA,JVQLDO,JVQODA
           ,JVQOTI,JVQOUS,JVQEDA
           ,JVQETI,JVQEUS)
           VALUES (
           :w_firm
           ,:jvkvnr
           ,:c2unob
           , 1.000000
           ,:jvkldo
           ,CURRENT_DATE
           ,CURRENT_TIME
           ,:l_user
           ,CURRENT_DATE
           ,CURRENT_TIME
           ,:l_user
           );
       else;
         exec sql
          UPDATE JVKLPF
          SET
           JVQUNO = :c2unob
          ,JVQEDA = CURRENT_DATE
          ,JVQETI = CURRENT_TIME
          ,JVQEUS = :l_user
          WHERE JVQFIR = :w_firm AND
           JVQVNR = :jvkvnr AND
           JVQUNO = :b1quno AND
           JVQLDO = :jvkldo;
       endif;

      /END-FREE
      // hvis logistikkvare er en aktiv NOBB vare ikke gjør noe med logistikk va
     c                   movel     c2unob        w_vare
      /FREE
       if jvkvnr = w_vare;
         leavesr;
       endif;

       // Kopier NOBB vare til logistikkvare
       exec sql
        select count(*) into :w_teller from JVARPF
        WHERE (JVVARE=:jvkvnr);

       if (w_teller = 0);
         exec sql
           INSERT INTO     JVARPF
              (JVVARE,JVOGRP,JVHGRP,JVUGRP,JVEOGR,JVEHGR,JVEUGR
              ,JVTEK1,JVTEK2,JVETE1
              ,JVETE2,JVNOBB,JVMODN,JVPROD,JVPVAR,JVLDOR,JVLVAR
              ,JVEAN1,JVSTRE,JVLEVE
              ,JVDOKI,JVUTKO,JVSORT,JVSLDO,JVSENH,JVPENH,JVMMK1,JVMLK1
              ,JVMMK2,JVMLK2
              ,JVENOB,JVFTXT,JVADAT,JVUDAT,JVSTAT,JVUNNR,JVFANR
              ,JVFABS,JVEMBM,JVEMGR
              ,JVBRAN,JVKATE,JVTYPE,JVLTXT,JVUARB,JVLFOR,JVHDAT
              ,JVTFRO,JVHPSE,JVTONO
              ,JVTOEU,JVGSTS,JVNODA,JVNBED,JVNSDA,JVODAT,JVEDAT
              ,JVETIM,JVEUSR)
           SELECT
           :jvkvnr,JVOGRP,JVHGRP,JVUGRP,JVEOGR,JVEHGR,JVEUGR
           ,JVTEK1,JVTEK2,JVETE1
           ,JVETE2, 0, 0, JVPROD,JVPVAR,:c2vldo
           , '' ,JVEAN1,JVSTRE,JVLEVE,JVDOKI,JVUTKO,JVSORT
           ,JVSLDO,JVSENH,JVPENH
           ,JVMMK1,JVMLK1,JVMMK2,JVMLK2,JVENOB,JVFTXT,JVADAT
           ,JVUDAT,JVSTAT,JVUNNR,JVFANR,JVFABS,JVEMBM,JVEMGR
           ,JVBRAN,JVKATE,JVTYPE
           ,JVLTXT,JVUARB,JVLFOR,JVHDAT,JVTFRO,JVHPSE,JVTONO
           ,JVTOEU,JVGSTS,JVNODA,JVNBED,JVNSDA,CURRENT_DATE
           ,CURRENT_DATE,CURRENT_TIME,:l_user
           FROM JVARPF WHERE JVVARE = :w_vare;
       else;
         exec sql
           select * into :ds_jvarpf from jvarpf WHERE JVVARE = :w_vare ;

         exec sql
           UPDATE JVARPF SET
             --JVOGRP=:JVOGRP,
             --JVHGRP=:JVHGRP,
             --JVUGRP=:JVUGRP,
             --JVEOGR=:JVEOGR,
             --JVEHGR=:JVEHGR,
             --JVEUGR=:JVEUGR,
             --JVTEK1=:JVTEK1,
             --JVTEK2=:JVTEK2,
             --JVETE1=:JVETE1,
             --JVETE2=:JVETE2,
             JVNOBB=0,
             --JVMODN=0,
             JVPROD=:JVPROD,
             JVPVAR=:JVPVAR,
             JVLDOR=:c2vldo,
             JVLVAR='',
             JVEAN1=:JVEAN1,
             JVSTRE=:JVSTRE,
             JVLEVE=:JVLEVE,
             JVDOKI=:JVDOKI,
             JVUTKO=:JVUTKO,
             JVSORT=:JVSORT,
             JVSLDO=:JVSLDO,
             JVSENH=:JVSENH,
             JVPENH=:JVPENH,
             JVMMK1=:JVMMK1,
             JVMLK1=:JVMLK1,
             JVMMK2=:JVMMK2,
             JVMLK2=:JVMLK2,
             JVENOB=:JVENOB,
             JVFTXT=:JVFTXT,
             JVADAT=:JVADAT,
             JVUDAT=:JVUDAT,
             JVSTAT=:JVSTAT,
             JVUNNR=:JVUNNR,
             JVFANR=:JVFANR,
             JVFABS=:JVFABS,
             JVEMBM=:JVEMBM,
             JVEMGR=:JVEMGR,
             JVBRAN=:JVBRAN,
             JVKATE=:JVKATE,
             JVTYPE=:JVTYPE,
             JVLTXT=:JVLTXT,
             JVUARB=:JVUARB,
             JVLFOR=:JVLFOR,
             JVHDAT=:JVHDAT,
             JVTFRO=:JVTFRO,
             JVHPSE=:JVHPSE,
             JVTONO=:JVTONO,
             JVTOEU=:JVTOEU,
             JVGSTS=:JVGSTS,
             JVNODA=:JVNODA,
             JVNBED=:JVNBED,
             JVNSDA=:JVNSDA,
             JVODAT=:JVODAT,
             JVEDAT=CURRENT_DATE,
             JVETIM=CURRENT_TIME,
             JVEUSR=:l_user
          WHERE
           (JVVARE=:jvkvnr );

       endif;

      /END-FREE
      *
      * Oppdaterer søketekst
      *
     c                   if        jvkvnr <> *blank
     c                   eval      b_inlr = *on
     c                   call      'JV790R'
     c                   parm                    w_firm
     c                   parm                    jvkvnr
     c                   parm                    b_inlr
     c                   endif
      /FREE

       // Kopier/oppdater vare-leverandør kobling
       exec sql DECLARE CLE CURSOR FOR
                 SELECT * FROM JVLEPF
                 WHERE JVLVNR = :w_vare AND JVLLDO = :jvkldo;
       exec sql OPEN CLE ;

       dow (2 = 2) ;
         exec sql FETCH NEXT FROM CLE INTO :ds_JVLEPF ;
         if (SQLCOD <> 0) ;
           leave ;
         endif ;

         for w_teller2 = 1 to 2 ; // både for varelev og nobb lev
           if (w_teller2 = 1);
             w_jwldor = c2vldo;
             w_jvlvei = 1;
           elseif (w_teller2 = 2);
             w_jwldor = jvkldo;
             w_jvlvei = 0;
           endif;

           exec sql
            select count(*) into :w_teller from JVLEPF
            WHERE (JVLVNR=:jvkvnr AND JVLLDO=:w_jwldor);

           if (w_teller = 0);
             exec sql
               INSERT INTO JVLEPF
               (JVLVNR,JVLLDO,JVLVEI,JVLLVA,JVLMR1,JVLMR2,JVLMR3
               ,JVLUDA,JVLODA,JVLOTI,JVLOUS,JVLEDA,JVLETI,JVLEUS)
               SELECT
               :jvkvnr,:w_jwldor,:w_jvlvei,JVLLVA,JVLMR1,JVLMR2,JVLMR3
               ,JVLUDA,JVLODA,JVLOTI,JVLOUS,CURRENT_DATE,CURRENT_TIME,:l_user
               FROM JVLEPF B WHERE
                  (JVLVNR=:w_vare AND JVLLDO=:jvkldo);
           else;
             exec sql
               update JVLEPF set
                 JVLVEI=:w_jvlvei,
                 JVLLVA=:JVLLVA,
                 JVLMR1=:JVLMR1,
                 JVLMR2=:JVLMR2,
                 JVLMR3=:JVLMR3,
                 JVLUDA=:JVLUDA,
                 JVLODA=:JVLODA,
                 JVLOTI=:JVLOTI,
                 JVLOUS=:JVLOUS,
                 JVLEDA=CURRENT_DATE,
                 JVLETI=CURRENT_TIME,
                 JVLEUS=:l_user
              WHERE
               (JVLVNR=:jvkvnr AND JVLLDO=:w_jwldor );
           endif;
         endfor;
       enddo ;
       exec sql CLOSE CLE ;

       // Kopier/oppdate alle pakninger fra NOBB vare til logistikkvare
       exec sql
         DELETE FROM JVPKPF
           WHERE JWVARE = :jvkvnr AND JWLDOR = :c2vldo and JWRSTS = 0;

       exec sql
         INSERT INTO JVPKPF
         (JWVARE,JWLDOR,JWPAKN,JWENHE,JWOFAK,JWOFAP
         ,JWBRED,JWLENG,JWHOYD,JWVEKT,JWVOLU,JWBEST
         ,JWPKLA,JWGTIN,JWPSEN,JWPAKS,JWANTP,JWPAPP
         ,JWPMSB,JWLFOR,JWNBRE,JWNLEN,JWNHOY,JWNVEK
         ,JWNVOL,JWGTYP,JWEPSE,JWRSTS,JWFDAT,JWTDAT
         ,JWNODA,JWNEDA,JWNSDA,JWODAT,JWEDAT,JWETIM
         ,JWEUSR)
         SELECT
         :jvkvnr,:c2vldo,JWPAKN,JWENHE,JWOFAK,JWOFAP
         ,JWBRED,JWLENG,JWHOYD,JWVEKT,JWVOLU,JWBEST
         ,JWPKLA,JWGTIN,JWPSEN,JWPAKS,JWANTP,JWPAPP
         ,JWPMSB,JWLFOR,JWNBRE,JWNLEN,JWNHOY,JWNVEK
         ,JWNVOL,JWGTYP,JWEPSE,JWRSTS,JWFDAT,JWTDAT
         ,JWNODA,JWNEDA,JWNSDA,JWODAT,CURRENT_DATE,CURRENT_TIME
         ,:l_user
         FROM JVPKPF B WHERE
            ( JWVARE = :w_vare AND JWLDOR = :jvkldo and JWRSTS = 0 );

       exec sql
         DELETE FROM  JVPKPF
           WHERE JWVARE = :jvkvnr AND JWLDOR = :jvkldo and JWRSTS = 0;

       exec sql
         INSERT INTO JVPKPF
         (JWVARE,JWLDOR,JWPAKN,JWENHE,JWOFAK,JWOFAP
         ,JWBRED,JWLENG,JWHOYD,JWVEKT,JWVOLU,JWBEST
         ,JWPKLA,JWGTIN,JWPSEN,JWPAKS,JWANTP,JWPAPP
         ,JWPMSB,JWLFOR,JWNBRE,JWNLEN,JWNHOY,JWNVEK
         ,JWNVOL,JWGTYP,JWEPSE,JWRSTS,JWFDAT,JWTDAT
         ,JWNODA,JWNEDA,JWNSDA,JWODAT,JWEDAT,JWETIM
         ,JWEUSR)
         SELECT
         :jvkvnr,:jvkldo,JWPAKN,JWENHE,JWOFAK,JWOFAP
         ,JWBRED,JWLENG,JWHOYD,JWVEKT,JWVOLU,JWBEST
         ,JWPKLA,JWGTIN,JWPSEN,JWPAKS,JWANTP,JWPAPP
         ,JWPMSB,JWLFOR,JWNBRE,JWNLEN,JWNHOY,JWNVEK
         ,JWNVOL,JWGTYP,JWEPSE,JWRSTS,JWFDAT,JWTDAT
         ,JWNODA,JWNEDA,JWNSDA,JWODAT,CURRENT_DATE,CURRENT_TIME
         ,:l_user
         FROM JVPKPF B WHERE
         ( JWVARE = :w_vare AND JWLDOR = :jvkldo and JWRSTS = 0 );

       //exec sql DECLARE CPK CURSOR FOR
       //          SELECT * FROM JVPKPF
       //          WHERE JWVARE = :c2unob AND JWLDOR = :jvkldo and JWRSTS = 0;
       //exec sql OPEN CPK ;
       //dow (2 = 2) ;
       //  exec sql FETCH NEXT FROM CPK INTO :ds_jvpkpf ;
       //  if (SQLCOD <> 0) ;
       //    leave ;
       //  endif ;
       //
       //  for w_teller2 = 1 to 2 ; // både for varelev. og nobblev
       //    if (w_teller2 = 1);
       //      w_jwldor = c2vldo;
       //    elseif (w_teller2 = 2);
       //      w_jwldor = jvkldo;
       //    endif;
       //
         //    exec sql
         //     select count(*) into :w_teller from jvpkpf
         //     WHERE (JWVARE=:jvkvnr AND JWLDOR=:w_jwldor AND JWPAKN=:JWPAKN);
         //
         //    if (w_teller = 0);
         //      exec sql
         //        INSERT INTO JVPKPF
         //        (JWVARE,JWLDOR,JWPAKN,JWENHE,JWOFAK,JWOFAP
         //        ,JWBRED,JWLENG,JWHOYD,JWVEKT,JWVOLU,JWBEST
         //        ,JWPKLA,JWGTIN,JWPSEN,JWPAKS,JWANTP,JWPAPP
         //        ,JWPMSB,JWLFOR,JWNBRE,JWNLEN,JWNHOY,JWNVEK
         //        ,JWNVOL,JWGTYP,JWEPSE,JWRSTS,JWFDAT,JWTDAT
         //        ,JWNODA,JWNEDA,JWNSDA,JWODAT,JWEDAT,JWETIM
         //        ,JWEUSR)
         //        SELECT
         //        :jvkvnr,:w_jwldor,JWPAKN,JWENHE,JWOFAK,JWOFAP
         //        ,JWBRED,JWLENG,JWHOYD,JWVEKT,JWVOLU,JWBEST
         //        ,JWPKLA,JWGTIN,JWPSEN,JWPAKS,JWANTP,JWPAPP
         //        ,JWPMSB,JWLFOR,JWNBRE,JWNLEN,JWNHOY,JWNVEK
         //        ,JWNVOL,JWGTYP,JWEPSE,JWRSTS,JWFDAT,JWTDAT
         //        ,JWNODA,JWNEDA,JWNSDA,JWODAT,CURRENT_DATE,CURRENT_TIME
         //        ,:l_user
         //        FROM JVPKPF B WHERE
       //           ( JWVARE = :c2unob AND JWLDOR = :jvkldo AND JWPAKN=:JWPAKN);
         //    else;
         //      exec sql
         //        update jvpkpf set
         //          JWENHE=:JWENHE,
         //          JWOFAK=:JWOFAK,
         //          JWOFAP=:JWOFAP,
         //          JWBRED=:JWBRED,
         //          JWLENG=:JWLENG,
         //          JWHOYD=:JWHOYD,
         //          JWVEKT=:JWVEKT,
         //          JWVOLU=:JWVOLU,
         //          JWBEST=:JWBEST,
         //          JWPKLA=:JWPKLA,
         //          JWGTIN=:JWGTIN,
         //          JWPSEN=:JWPSEN,
         //          JWPAKS=:JWPAKS,
         //          JWANTP=:JWANTP,
         //          JWPAPP=:JWPAPP,
         //          JWPMSB=:JWPMSB,
         //          JWLFOR=:JWLFOR,
         //          JWNBRE=:JWNBRE,
         //          JWNLEN=:JWNLEN,
         //          JWNHOY=:JWNHOY,
         //          JWNVEK=:JWNVEK,
         //          JWNVOL=:JWNVOL,
         //          JWGTYP=:JWGTYP,
         //          JWEPSE=:JWEPSE,
         //          JWRSTS=:JWRSTS,
         //          JWFDAT=:JWFDAT,
         //          JWTDAT=:JWTDAT,
         //          JWNODA=:JWNODA,
         //          JWNEDA=:JWNEDA,
         //          JWNSDA=:JWNSDA,
         //          JWEDAT=CURRENT_DATE,
         //          JWETIM=CURRENT_TIME,
         //          JWEUSR=:l_user
         //       WHERE
         //        (JWVARE=:jvkvnr AND JWLDOR=:w_jwldor AND JWPAKN=:JWPAKN);
         //    endif;
       //  endfor;
       //enddo ;
       //exec sql CLOSE CPK ;

       // Kopier/oppdate priser
       exec sql DECLARE CPR CURSOR FOR
                 SELECT * FROM JVPRPF
                 WHERE JXVARE = :w_vare AND JXLDOR = :jvkldo;
       exec sql OPEN CPR ;

       dow (2 = 2) ;
         exec sql FETCH NEXT FROM CPR INTO :ds_jvprpf ;
         if (SQLCOD <> 0) ;
           leave ;
         endif ;
         w_jwldor = jvkldo;
         exec sql
          select count(*) into :w_teller from jvprpf
          WHERE (JXVARE=:jvkvnr AND JXLDOR=:w_jwldor
                 AND JXGDAT=:JXGDAT AND JXRSTS=:JXRSTS);

         if (w_teller = 0);
           exec sql
             INSERT INTO JVPRPF
             (JXVARE,JXLDOR,JXLVAR,JXPRIS,JXGDAT,JXTDAT,JXGPRI
             ,JXVALU,JXFBEL,JXCRDO,JXRSTS,JXEANN,JXNODA,JXNEDA
             ,JXNSDA,JXODAT,JXEDAT,JXETIM,JXEUSR)
             SELECT
             :jvkvnr,:w_jwldor,JXLVAR,JXPRIS,JXGDAT,JXTDAT,JXGPRI
             ,JXVALU,JXFBEL,JXCRDO,JXRSTS,JXEANN,JXNODA,JXNEDA
             ,JXNSDA,JXODAT,CURRENT_DATE,CURRENT_TIME,:l_user
             FROM JVPRPF B WHERE
               (JXVARE=:w_vare AND JXLDOR=:w_jwldor
                AND JXGDAT=:JXGDAT AND JXRSTS=:JXRSTS);
         else;
           exec sql
             update jvprpf set
               JXLVAR=:JXLVAR,
               JXPRIS=:JXPRIS,
               JXTDAT=:JXTDAT,
               JXGPRI=:JXGPRI,
               JXVALU=:JXVALU,
               JXFBEL=:JXFBEL,
               JXCRDO=:JXCRDO,
               JXEANN=:JXEANN,
               JXNODA=:JXNODA,
               JXNEDA=:JXNEDA,
               JXNSDA=:JXNSDA,
               JXODAT=:JXODAT,
               JXEDAT=CURRENT_DATE,
               JXETIM=CURRENT_TIME,
               JXEUSR=:l_user
            WHERE
             (JXVARE=:jvkvnr AND JXLDOR=:w_jwldor
               AND JXGDAT=:JXGDAT AND JXRSTS=:JXRSTS);
         endif;
       enddo ;
       exec sql CLOSE CPR ;
      /end-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av slette-bildet (D1WIN)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xd1win        begsr
      *
     c                   eval      jvkhlr_vare = d1vare
     c     jvkhlr_key    chain     jvkhlr
      *
     c                   exfmt     d1win
      *
     c                   if        *inkc or *inkl
     c                   goto      end_d1win
     c                   endif
      *
     c                   eval      b_forn = *on
      *
      * Sletter logistikkvare
      *
      *
     c                   movel     c2unob        w_vare
      * hvis logistikkvare er en aktiv NOBB vare, ikke slett NOBB info
     c                   if        jvkvnr <> w_vare
     c/exec sql
     c+  UPDATE JVLEPF SET JVLUDA = CURRENT_DATE,
     c+   JVLEDA=CURRENT_DATE, JVLETI=CURRENT_TIME, JVLEUS=:l_user
     c+   WHERE (JVLVNR = :jvkvnr AND JVLUDA = '0001-01-01'
     c+     AND JVLLDO IN (SELECT JVQLDO FROM JVKLPF WHERE
     c+     JVQFIR=:w_firm AND JVQVNR=:jvkvnr))
     c/end-exec
     c/exec sql
     c+  UPDATE JVPRPF SET JXTDAT = CURRENT_DATE,
     c+   JXEDAT=CURRENT_DATE, JXETIM=CURRENT_TIME, JXEUSR=:l_user
     c+   WHERE (JXVARE = :jvkvnr AND JXTDAT = '0001-01-01'
     c+     AND JXLDOR IN (SELECT JVQLDO FROM JVKLPF WHERE
     c+     JVQFIR=:w_firm AND JVQVNR=:jvkvnr))
     c/end-exec
     c/exec sql
     c+  UPDATE JVPKPF SET JWTDAT = CURRENT_DATE,
     c+   JWEDAT=CURRENT_DATE, JWETIM=CURRENT_TIME, JWEUSR=:l_user
     c+   WHERE (JWVARE = :jvkvnr AND JWTDAT = '0001-01-01'
     c+     AND JWLDOR IN (SELECT JVQLDO FROM JVKLPF WHERE
     c+     JVQFIR=:w_firm AND JVQVNR=:jvkvnr))
     c/end-exec
      *
     c                   endif
      *
      * slett undervarene
     c/exec sql
     c+  DELETE FROM JVKLPF
     c+  WHERE JVQVNR=:jvkvnr AND JVQFIR=:w_firm
     c/end-exec
      *
     c                   eval      jvkhlu_vare = d1vare
     c     jvkhlu_key    chain     jvkhlur
     c                   delete    jvkhlur
      *
     c     end_d1win     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for tømming av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     clr_subfile   begsr
      *
     c                   eval      *in14 = *on
     c                   write     b2ctl
     c                   eval      *in14 = *off
      *
     c                   eval      *in15 = *off
     c                   eval      w_srrn = 0
     c                   eval      w_sfrn = 0
     c                   eval      w_ssrn = 0
     c                   eval      w_spge = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å fylle opp subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     crt_subfile   begsr
      *
     c                   eval      w_spge = w_spge + c_sfil
     c                   eval      w_srrn = w_ssrn
      *
     c                   if        b_open_sok = *on
     c/exec sql
     c+ close STMT
     c/end-exec
      *
     c                   eval      sqlquery  = 'select +
     c                              A.jvkfir +
     c                             ,A.jvkvnr +
     c                             ,IFNULL(C.jvtek1, '''') as vtek1 +
     c                             ,A.jvkldo +
     c                             ,IFNULL((select F1.jlnavn from jlevpf F1 +
     c                               where F1.jlldor = A.jvkldo), '''') +
     c                               as lnavn +
     c                             ,A.jvknup +
     c                             ,(select count(*) from jvklpf D1 where +
     c                               D1.jvqfir = A.jvkfir and D1.jvqvnr = +
     c                                A.jvkvnr) +
     c                               as ant_varer +
     c                             ,IFNULL(C.jvldor, 0 ) +
     c                             ,IFNULL((select E1.jlnavn from jlevpf E1 +
     c                               where  E1.jlldor +
     c                              = IFNULL(C.jvldor, 0 )), '''') as llnavn +
     c                             ,IFNULL(B.jvquno, 0 ) +
     c                               from   jvkhpf A +
     c                             left outer join jvklpf B on B.jvqfir = +
     c                                 A.jvkfir and B.jvqvnr = A.jvkvnr +
     c                                and B.jvqldo = A.jvkldo +
     c                             left outer join jvarpf C on A.jvkvnr =  +
     c                              C.jvvare  +
     c                             where A.jvkfir = ? and a.jvkvnr >= ? +
     c                               '
7.01 c                   if        w_seqe = 'N'
7.01 c                   eval      sqlquery  = %trim(sqlquery) +
7.01 c                             ' and (select count(*) from jvklpf ff where +
7.01 c                             ff.jvqfir = A.jvkfir and ff.jvqvnr=A.jvkvnr +
7.01 c                             and ff.jvquno = ?)> 0'
7.01 c                   elseif    w_seqe = 'L'
7.01 c                   eval      sqlquery  = %trim(sqlquery) +
7.01 c                             ' and (select count(*) from jvklpf ff where +
7.01 c                             ff.jvqfir = A.jvkfir and ff.jvqvnr=A.jvkvnr +
7.01 c                             and ff.jvqldo = ?)> 0'
7.01 c                   endif
     c                   if        w_seqe = 'V'
     c                   eval      sqlquery  = %trim(sqlquery)  +
     c                             ' order by A.jvkvnr +
     c                             for read only +
     c                             '
7.01 c                   else
     c                   eval      sqlquery  = %trim(sqlquery)  +
     c                             ' order by a.jvkeda desc, a.jvketi desc  +
     c                             for read only +
     c                             '
     c                   endif
     c
     c
     c/exec sql
     c+ PREPARE SQL_STMT FROM :sqlquery
     c/end-exec
     c
     c/exec sql
     c+ DECLARE STMT CURSOR FOR SQL_STMT
     c/end-exec
     c
     c                   if        sqlcod < 0
     c                   eval      *in15 = *on
     c                   leavesr
     c                   endif
     c
     c
7.01 c                   if        w_seqe = 'N'
7.01 c/exec sql
7.01 c+ OPEN STMT using :w_firm, :b2vare, :b2uvar
7.01 c/end-exec
7.01 c                   elseif    w_seqe = 'L'
7.01 c/exec sql
7.01 c+ OPEN STMT using :w_firm, :b2vare, :b2ldor
7.01 c/end-exec
7.01 c                   else
7.01 c/exec sql
     c+ OPEN STMT using :w_firm, :b2vare
     c/end-exec
7.01 c                   endif
     c
     c                   endif
     c
     c                   dou       w_srrn = w_spge
      *
     c/exec sql
     c+ fetch STMT
     c+ into  :jvkfir,:jvkvnr,:w_vtek1,:jvkldo,:w_hlevn,:jvknup,:w_antvar,
     c+       :w_lldo,:w_llna,:w_quno
     c/end-exec
     c                   if        sqlcod = 100 or sqlstt = '02000'
     c                   eval      *in15 = *on
     c                   endif
      *
     c                   if        *in15 = *on or
     c                             jvkfir <> w_firm
     c                   leave
     c                   endif
      *
     c                   eval      w_srrn = w_srrn + 1
      *
     c                   eval      b1valg = 0
     c                   eval      b1vare = jvkvnr
     c                   movel     w_vtek1       b1tek1
     c                   eval      b1kldo = jvkldo
     c                   movel     w_hlevn       b1hlen
     c                   eval      b1knup = jvknup
     c                   eval      b1antv = w_antvar
     c                   eval      b1vldo = w_lldo
     c                   eval      b1vlnv = w_llna
     c                   eval      b1quno = w_quno
      *
     c                   exsr      sjekk_vargrp
      *
     c                   write     b1sfl
      *
     c                   enddo
      *
     c                   if        w_srrn > w_ssrn
     c                   eval      w_sfrn = w_ssrn + 1
     c                   endif
      *
     c                   eval      w_ssrn = w_srrn
     c                   eval      w_virn = w_sfrn
      *
     c                   eval      b_open_sok = *off
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å bla tilbake en side i subfilen
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c*     bck_subfile   begsr
      **
     c*                   if        *in15
     c*                   select
     c*                   when      w_seqe = 'V'
     c*     jvkhl1_key    setgt     jvkhl1
     c*                   readp     jvkhl1
     c*                   other
     c*     jvkhl1_key    setgt     jvkhl1
     c*                   readp     jvkhl1
     c*                   endsl
     c*                   endif
      **
      ** Leser tilbake en side
      **
     c*                   eval      w_stel = 0
      **
     c*                   dou       w_stel = w_ssrn + c_sfil
      **
     c*                   select
     c*                   when      w_seqe = 'V'
     c*                   readp     jvkhl1
     c*                   other
     c*                   readp     jvkhl1
     c*                   endsl
      **
     c*                   if        %eof or
     c*                             jvkfir <> w_firm
     c*                   leave
     c*                   endif
      **
     c*                   eval      w_stel = w_stel + 1
      **
     c*                   select
     c*                   when      w_seqe = 'V'
     c*                   eval      jvkhl1_vare = jvkvnr
     c*                   other
     c*                   eval      jvkhl1_vare = jvkvnr
     c*                   endsl
      **
     c*                   enddo
      **
     c*                   if        %eof
     c*                   select
     c*                   when      w_seqe = 'V'
     c*     jvkhl1_key    setll     jvkhl1
     c*                   other
     c*     jvkhl1_key    setll     jvkhl1
     c*                   endsl
     c*                   endif
      **
      ** Blanker og fyller opp subfile
      **
     c*                   exsr      clr_subfile
     c*                   exsr      crt_subfile
      **
     c*                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for display av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dsp_subfile   begsr
      *
     c                   if        w_srrn <> 0
     c                   eval      *in12 = *on
     c                   else
     c                   write     b2cmd
     c                   endif
      *
     c                   eval      *in13 = *on
     c                   exfmt     b2ctl
      *
     c                   eval      *in12 = *off
     c                   eval      *in13 = *off
      *
     c                   eval      w_fcrn = d_fcrn
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Sjekk vareguppe forskjeller
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sjekk_vargrp  begsr
     c
     c                   eval      *in28 = *off
     c
     c/exec sql
     c+                  SELECT COUNT(*) into :b_vgrpsjekk FROM (
     c+                   SELECT DISTINCT JVOGRP,JVHGRP,JVUGRP
     c+                   FROM JVARPF WHERE jvnobb IN (
     c+                    select JVQUNO from jvklpf
     c+                    WHERE JVQVNR = :jvkvnr
     c+                   )
     c+                  ) A
     c/end-exec
     c
     c                   if        b_vgrpsjekk > 1
     c                   eval      *in28 = *on
     c                   endif
     c
     c                   endsr
6.37  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.37  * Subrutine for å vise info
6.37  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.37  *
6.37 c     xb13win       begsr
6.37  *
6.37 c                   exfmt     b13win
6.37  *
6.37 c     end_xb13win   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      ** Parametre
     c*     *entry        plist
     c*                   parm                    p_dflldor
      *
      *
      * Key for posisjonering på varenummer
      *
     c     jvkhl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    jvkhl1_vare
      *
      * Key for posisjonering på varenummer
      *
     c     jvkhlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    jvkhlr_vare
      *
      * Key for oppdatering av logistikkvare
      *
     c     jvkhlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    jvkhlu_vare
      *
      * Key for oppslag på vare
      *
     c     jvarl1_key    klist
     c                   kfld                    jvarl1_vare
      *
      * Key for oppslag på leverandør
      *
     c     jlevl1_key    klist
     c                   kfld                    jlevl1_ldor
      *
      * Key for propertiesfil
      *
     c     afpslr_key    klist
     c                   kfld                    afpslr_ufil
     c                   kfld                    afpslr_uide
      *
      * Henter firma og referanse fra parameter
      *
     c                   eval      w_firm = l_firm
      *
     c*                   if        %parms > 0
     c*                   eval      w_dflldor = p_dflldor
     c*                   else
     c*                   eval      w_dflldor = 0
     c*                   endif
     c                   eval      w_ldox = *blank
     c                   eval      afpslr_ufil = l_filg
     c                   eval      afpslr_uide = 'LOGILEV   '
      *
      * Sjekk om byggdok eller cobuilder aktivering er på/av
      *
     c     afpslr_key    chain     afpslrr
     c                   if        %found(afpslr)
     c                   eval      w_ldox = afudss
     c                   endif
     c                   if        w_ldox = *blank
     c                   eval      w_ldox = '900099'
     c                   endif
     c                   move      w_ldox        w_levr
      *
      * Initierer skjermbildet
      *
     c                   eval      *in22 = *on
      *
      * Posisjonerer databasen, og fyller opp subfile
      *
     c                   eval      jvkhlu_vare = ''
     c     jvkhl1_key    setll     jvkhl1
      *
      *
      * Key for les på vare-leverandør
      *
     c     jvlelr_key    klist
     c                   kfld                    jvlelr_lvnr
      *
6.36 c                   time                    w_udat
      *
     c                   eval      b_open_sok = *on
     c                   exsr      crt_subfile
      *
     c                   endsr
