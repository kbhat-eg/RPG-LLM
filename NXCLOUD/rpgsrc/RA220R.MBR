     h datedit(*dmy) option(*nodebugio)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -*
      *                                                                       *
      * System. . . . . : ASOKON                                              *
      * Program . . . . : RA220R                                              *
      * Beskrivelse . . : Tilrettelegger trans fra Svea                       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Spesialversjon. :                                                     *
      * Tilpasset for . :                                                     *
      *                                                                       *
      * Referanse  Dato   Endringsbeskrivelse                            Sign *
      * --------- ------  ---------------------------------------------- ---- *
      * 6.30  sst 280617  Nytt program                                        *
      *
      *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *
     frsvepf    ip  af  512        disk
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     fraa3l1    if   e           k disk    rename(raa3pfr:raa3l1r)
     fraa4lu    uf   e           k disk    rename(raa4pfr:raa4lur)
     frktrl8    if   e           k disk    rename(rktrpfr:rktrl8r)
     frbunl1    if   e           k disk    rename(rbunpfr:rbunl1r)
     fre0tpf    o    e           k disk
      *
     d per             s              2  0 dim(13)
     d wbel            s              1    dim(14)
     d wfbe            s              1    dim(14)
      *
     d                 ds
     d rpcin1                       512
     d  wdsbty                        2    overlay(rpcin1)
     d  wdsUG                         7    overlay(rpcin1:3)
     d  wdsKNR                       10    overlay(rpcin1:10)
     d  wdsFNR                       10    overlay(rpcin1:20)
     d  wdsbda                        8    overlay(rpcin1:30)
     d   wdsbdd                       2    overlay(wdsbda:7)
     d   wdsbmm                       2    overlay(wdsbda:5)
     d   wdsbÅÅ                       2    overlay(wdsbda:3)
     d  wdsTRK                        2    overlay(rpcin1:38)
      *   10 = Bankgiro
      *   11 = Kasse/Sjekk
      *   12 = Postgiro
      *   16 = Postgiro OCR
      *   17 = Bankgiro OCR
      *   20 = Inkasso kapital
      *   31 = Kundetap
      *   32 = Betalt direkte til oppdragsgiver
      *   33 = Debit/kredit justering
      *   34 = Bortskrivning/internkreditering
      *   36 = Regress
     d  wdsBLT                        2    overlay(rpcin1:40)
      *   bb = Beløp =kapital???
      *   PA = Purregebyr
      *   IR = Inkassorente
     d  wdsBEL                       11    overlay(rpcin1:42)
     d  wdsMIN                        1    overlay(rpcin1:53)
     d  wdsBST                        1    overlay(rpcin1:54)
      *    1 = Delbetalt
      *    2 = Sluttbetalt
      *
      *  Slutt-record
      *
     d  wdtbty                        2    overlay(rpcin1)
     d  wdtUG                         7    overlay(rpcin1:3)
     d  wdtbda                        8    overlay(rpcin1:10)
     d   wdtbdd                       2    overlay(wdtbda:7)
     d   wdtbmm                       2    overlay(wdtbda:5)
     d   wdtbÅÅ                       2    overlay(wdtbda:3)
     d  wdtANT                        9    overlay(rpcin1:18)
     d  wdtBEL                       12    overlay(rpcin1:27)
     d  wdtMIN                        1    overlay(rpcin1:53)
      *
     d                 ds
     d wwsbda                         6
     d  wwsbdd                        2    overlay(wwsbda)
     d  wwsbmm                        2    overlay(wwsbda:3)
     d  wwsbÅÅ                        2    overlay(wwsbda:5)
      *
      * LOCAL DATA
      *
     d                uds
     d pfirm                 300    302  0
     d pnavn                         30
     d puser                         10
     d pdato                          6  0
     d praar                          4  0
     d pperf                          2  0
     d ppert                          2  0
     d psyst                 471    472  0
      *
     d l_user                911    920
     d l_firm                944    946  0
     d l_navn                951    980
      *
      *  Skal sluttrecord posteres?
     d w_sluttrec      s              1       inz('N')
      *  Bankkonto (motkonto)  (Interimskonto SVEA)
     d w_ktob          s              6  0    inz(1506)
      *  Tapskonto (motkonto)
     d w_ktot          s              6  0    inz(7830)
      *  Konto for inkassorente (ikke i bruk foreløpig)
     d w_ktoi          s              6  0    inz(9999)
      *  Konto for avskrivning(diff faktura - betaling < grense)
     d w_ktoa          s              6  0    inz(7771)
      *  Konto for purregebyr   (ikke i bruk foreløpig)
     d w_ktop          s              6  0    inz(1506)
      *
     d w_totb          s                      like(rtbelØ)
     d w_tota          s              9  0
     d w_dtbel         s                      like(rtbelØ)
     d w_dtant         s              9  0
     d w_stat          s                      like(rsstat)
      *
     d pdatx           s              8  0
     d wfbelØ          s             14
     d wfelt           s                   like(rpcin1)
     d wftgn           s              1
     d wkp             s              2  0
     d wkper           s              8  0
     d wlinje          s              8  0
     d wblin           s              8  0
6.NU d wnota           s              8  0
     d wnxbun          s                   like(rtbunt)
     d wtpre           s             10  2
     d i               s              3  0
     d w_biln          s                   like(rtbiln)
     d w_tdat          s              6
     d w_diff          s                      like(rtbelØ)
     d w_belØ          s                      like(rtbelØ)
      *
     d w_firm          s                   like(l_firm)
     d w_raar          s              4  0
     d wwsbdn          s              6  0
6.30 d w_kto           s              8
6.30 d w_avd           s              8
6.30 d w_sps           s              8
6.30 d w_mva           s              1
      *
     d raa4lu_4aar     s                   like(ra4aar)
     d rktrl8_firm     s                   like(rnfirm)
     d rktrl8_kund     s                   like(rnkund)
     d rktrl8_biln     s                   like(rnbiln)
     d rbunl1_memb     s                   like(rsmemb)
     d rbunl1_bunt     s                   like(rsbunt)
      *
      *  Statusopplysninger - avvikende perioder?!?
      *
     iraa3l1r
     i              ra3p01                      per(01)
     i              ra3p02                      per(02)
     i              ra3p03                      per(03)
     i              ra3p04                      per(04)
     i              ra3p05                      per(05)
     i              ra3p06                      per(06)
     i              ra3p07                      per(07)
     i              ra3p08                      per(08)
     i              ra3p09                      per(09)
     i              ra3p10                      per(10)
     i              ra3p11                      per(11)
     i              ra3p12                      per(12)
     i              ra3p13                      per(13)
      *
     irsvepf    NS  01
     i                                  1  512  rpcin1
      * ______________________________________________________________
     c                   if        wdsbty <> '03'
     c                   goto      slutt_rec
     c                   endif
      *
6.30 c                   eval      praar = *zero
6.30 c                   move      wdsbÅÅ        praar
6.30 c                   eval      praar = praar + 2000
6.30 c                   move      wdsbmm        ppert
6.30 c                   eval      rtraar = praar
6.30 c                   eval      rtrper = ppert
      *
     c     start         tag
      *
     c                   exsr      getbiln
      *
      *
     c                   eval      wwsbdd = wdsbdd
     c                   eval      wwsbmm = wdsbmm
     c                   eval      wwsbÅÅ = wdsbÅÅ
     c                   move      wwsbda        wwsbdn
     c                   move      wwsbda        w_tdat
     c     *dmy          move      wwsbdn        rtbdat
      *  Kundenummer
     c                   dow       %subst(wdsKNR:10:1) = *blank
     c                   eval      %subst(wdsKNR:2:9) = %subst(wdsKNR:1:9)
     c                   eval      %subst(wdsKNR:1:1) = '0'
     c                   enddo
     c                   move      wdsKNR        w_kto
      *
     c                   eval      rtbilk = 13
      *
     c                   select
     c                   when      wdstrk = '10'
     c                   eval      rttext = 'Svea Innbetalt  '
     c                   eval      rtbilk = 13
     c                   when      wdstrk = '11'
     c                   eval      rttext = 'Kasse/Sjekk     '
     c                   eval      rtbilk = 11
     c                   when      wdstrk = '12'
     c                   eval      rttext = 'Postgiro        '
     c                   eval      rtbilk = 83
     c                   when      wdstrk = '16'
     c                   eval      rttext = 'Postgiro OCR    '
     c                   eval      rtbilk = 83
     c                   when      wdstrk = '17'
     c                   eval      rttext = 'Svea Innbetalt  '
     c                   eval      rtbilk = 13
     c                   when      wdstrk = '20'
     c                   eval      rttext = 'Inkasso kapital '
     c                   eval      rtbilk = 10
     c                   when      wdstrk = '31'
     c                   eval      rttext = 'Kundetap        '
     c                   eval      rtbilk = 65
     c                   when      wdstrk = '32'
     c                   eval      rttext = 'Bet.Dir.Oppdrgiv'
     c                   eval      rtbilk = 10
     c                   when      wdstrk = '33'
     c                   eval      rttext = 'De/Kr Justering '
     c                   eval      rtbilk = 20
     c                   when      wdstrk = '34'
     c                   eval      rttext = 'Bortskriv/int.kr'
     c                   when      wdstrk = '36'
     c                   eval      rttext = 'Regress         '
     c                   other
     c                   eval      rttext = 'Udef. fra Svea  '
     c                   endsl
      *   Beløp
     c                   move      wdsbel        rtbelØ
     c                   if        rtbelØ = 0
     c                   goto      slutt
     c                   endif
      *   Valuta beløp        debug
     c                   eval      rtvalb = *zero
     c                   eval      rtvalk = *blank
      *   Referanse
     c                   dow       %subst(wdsFNR:10:1) = *blank
     c                   eval      %subst(wdsFNR:2:9) = %subst(wdsFNR:1:9)
     c                   eval      %subst(wdsFNR:1:1) = '0'
     c                   enddo
     c                   move      wdsFNR        rtrefn
      *
     c                   eval      rtdavd = *zeros
     c                   eval      rtdkto = *zeros
     c                   eval      rtdsps = *zeros
     c                   eval      rtdmva = *blank
      *
     c                   eval      rtcavd = *zeros
     c                   eval      rtckto = *zeros
     c                   eval      rtcsps = *zeros
     c                   eval      rtcmva = *blank
      *
     c****               eval      w_kto  = *blank
     c                   eval      w_avd  = *blank
     c                   eval      w_sps  = *blank
     c                   eval      w_mva  = *blank
      *
     c                   if        wdsmin = '-'
     c                   move      w_kto         rtdkto
     c                   move      w_avd         rtdavd
     c                   move      w_sps         rtdsps
     c                   if        rtbilk = 65
     c                   eval      rtckto  = w_ktot
     c                   else
     c                   eval      rtckto  = w_ktob
     c                   endif
     c                   else
     c                   move      w_kto         rtckto
     c                   move      w_avd         rtcavd
     c                   move      w_sps         rtcsps
     c                   if        rtbilk = 65
     c                   eval      rtdkto  = w_ktot
     c                   else
     c                   eval      rtdkto  = w_ktob
     c                   endif
     c                   endif
      *
     c                   eval      rtakti = *blank
      *
     c                   eval      rtfdat = rtbdat
      *
      * Legg ut postering
      *
     c                   add       1             wlinje
     c                   eval      rtreid = 'T'
     c                   eval      rtfirm = l_firm
     c                   eval      rtbunt = wnxbun
     c                   eval      rtlinj = wlinje
     c                   eval      rtbiln = wnota
     c                   eval      wblin  = wblin + 1
     c                   eval      rtbill = wblin
     c                   eval      rtstat = *blank
     c                   eval      rtcmva = ' '
     c                   eval      rtdmva = ' '
     c                   eval      rtkrab = *zero
     c                   eval      rtmngd = *zero
     c                   eval      rtmngk = *zero
     c                   eval      rtvirk = *blank
     c                   eval      rtautx = *blank
     c                   eval      rtkrys = *blank
     c                   eval      rtkidi = *blank
     c                   eval      rtbetb = *zero
     c                   eval      rtbref = *blank
      *
     c                   if        wdsmin = '-'
     c                   eval      w_totb = w_totb - rtbelØ
     c                   else
     c                   eval      w_totb = w_totb + rtbelØ
     c                   endif
     c                   eval      w_tota = w_tota + 1
      *
     c                   write     re0tpfr
      *  _________________________________________________________________
      *  Status = 2 og diff mot faktura innenfor grenser
      *
     c                   if        wdsbst = '2'
     c                   eval      w_raar = *zero
     c                   eval      w_belØ = *zero
     c                   eval      rktrl8_firm = w_firm
     c                   move      w_kto         rktrl8_kund
     c                   eval      rktrl8_biln = rtrefn
     c     rktrl8_key    setll     rktrl8
     c     rktrl8_key    reade     rktrl8
     c                   dow       not %eof(rktrl8)
     c                   if        rnraar > w_raar
     c                   eval      w_raar = rnraar
     c                   eval      w_belØ = rnbelØ
     c                   endif
     c     rktrl8_key    reade     rktrl8
     c                   enddo
      *    Beregne diff mellom faktura og innbetaing
     c                   eval      w_diff = w_belØ - rtbelØ
     c                   if            w_diff <= 72
     c                             and w_diff >= -70
     c                             and w_diff <> 0
     c                   eval      rtbill = rtbill + 1
     c                   eval      rttext = 'Avskrivning     '
     c                   eval      rtbilk = 78
     c                   if        w_diff > 0
     c                   eval      rtdkto = w_ktoa
     c                   move      w_kto         rtckto
     c                   eval      rtbelØ = w_diff
     c                   else
     c                   eval      rtckto = w_ktoa
     c                   move      w_kto         rtdkto
     c                   eval      rtbelØ = w_diff * -1
     c                   endif
      *
     c                   write     re0tpfr
      *
     c                   endif
     c                   endif
      *
     c                   goto      slutt
      *
     c     slutt_rec     tag
      *
      * ______________________________________________________________
     c                   if        wdsbty <> '99'
     c                   goto      slutt
     c                   endif
      *
     c                   eval      wwsbdd = wdtbdd
     c                   eval      wwsbmm = wdtbmm
     c                   eval      wwsbÅÅ = wdtbÅÅ
     c                   move      wwsbda        wwsbdn
     c                   move      wwsbda        w_tdat
     c     *dmy          move      wwsbdn        rtbdat
      *
     c                   move      wdtbel        rtbelØ
     c                   move      wdtbel        w_dtbel
     c                   move      wdtant        w_dtant
     c
      *
      *
     c     slutt         tag
      *
      *  Ev. totalpostering
      *
     clr                 if        w_sluttrec = 'J'
     clr                 if           w_totb <> w_dtbel
     c                             or w_tota <> w_dtant
     clr                 eval      w_dtbel = w_dtbel
     clr                 endif
     clr                 if        w_totb <> 0
     clr                 if        w_totb < 0
     clr                 eval      rtbelØ = w_totb * -1
     clr                 eval      rtckto = w_ktob
     clr                 eval      rtdkto = *zero
     clr                 else
     clr                 eval      rtbelØ = w_totb
     clr                 eval      rtdkto = w_ktob
     clr                 eval      rtckto = *zero
     clr                 endif
     clr                 eval      wblin  = wblin + 1
     clr                 eval      rtbill = wblin
     clr                 eval      rttext = 'Innbetalt ' + %trim(w_tdat) +
     c                                      %trim(' Sve')
     clr                 write     re0tpfr
     clr                 endif
     clr                 endif
      *
      *  Hente neste bilagsnr.
      *
     c     getbiln       begsr
      *
     c                   if        w_biln = 0
     c                   eval      raa4lu_4aar = praar
     c     raa4lu_key    chain     raa4lu
 001  *
B001 c                   if        %found
 001 c                   z-add     ra4sig        wnota
E001 c                   else
 001 c                   z-add     0             wnota
E001 c                   endif
     c                   eval      wnota = wnota + 1
     c                   eval      wblin = *zero
     c                   eval      ra4sig = wnota
     c                   update    raa4lur
      *
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     *inzsr        begsr
      *
     c                   eval      wtpre = *zeros
     c                   eval      wkp = *zeros
     c                   move      *zeros        rpcin1
      *
     c                   eval      rbunl1_memb  = 'TELE' + %char(l_firm)
     c                   eval      rbunl1_bunt  = 1
     c     rbunl1_key    chain     rbunl1
     c                   dow       %found(rbunl1)
     c                   eval      rbunl1_bunt = rbunl1_bunt + 1
     c     rbunl1_key    chain     rbunl1
     c                   enddo
     c                   z-add     rsbunt        wnxbun
     c     uyear         sub       1             w_raar
      *
     c     afirl1_key    chain     afirl1                             10
 001  *
     c     raa3l1_key    chain     raa3l1                             10
 001  *
 001  *
     c     afirl1_key    klist
     c                   kfld                    w_firm
 001  *
     c     raa3l1_key    klist
     c                   kfld                    w_firm
 001  *
     c     raa4lu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    raa4lu_4aar
 001  *
     c     rktrl8_key    klist
     c                   kfld                    rktrl8_firm
     c                   kfld                    rktrl8_kund
     c                   kfld                    rktrl8_biln
 001  *
     c     rbunl1_key    klist
     c                   kfld                    w_stat
     c                   kfld                    rbunl1_memb
     c                   kfld                    w_firm
     c                   kfld                    rbunl1_bunt
      *
     c                   endsr
      * ----------------------------------------
