     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOKON
      * Program . . . . : RK120R
      * Beskrivelse . . : Kundeposteringer, vedlikehold
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       130802 KOB  Nytt program
      *       250603 KOB  Lagt inn dato for purring i bilde
      *       020703 KOB  Lagt inn merking av poster som ikke skal rente-
      *                   beregnes videre
      * V5.30 241104 KOB  Lagt inn kundenummer i kall til faktura-visning
      * V5.40 210405 KOB  Lagt inn behandling av uttrekk til factoring
      * V5.40 230705 KOB  Korrigert oppslag mot faktura, år i call var 0
      *                   og kode i skjermbildet var feil, 7 istedet for 8
      * V5.41 070207 AMD  Ved sletting av poster posisjonerte subfilen
      *                   seg på første rad igjen. Dette er korrigert. I
      *                   tillegg er bla-rutiner lagt på plass slik at det
      *                   går an å bla tilbake over startpunktet i subfilen.
      *                   Ny logisk fil måtte benyttes for å løse ny logikk.
      * V5.60 290908 KOB  Lagt inn mulighet for å korrigere renteberegningen
6.10  * V6.10 220909 BSA  Lagt inn sporingsfelter
6.20  * V6.20 030113 NHO  Lagt inn vis av notatblokk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *  Bruk av indikatorer:
      *
      *       LR = Avslutt program
      *       10 = Roll
      *       11 = Rolldown
      *       12 = Sfldsp
      *       13 = Sfldspctl
      *       14 = Sflclr
      *       15 = Sflend
      *       21 = Home-key
      *       22 = Plassering av cursor
      *       30 = Protect av felter ved vise
      *    31-79 = Varsle m/feilmeldinger/skjermindikatorer
      *    80-99 = Arbeidsindikatorer
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     frkwbl1    if   e           k disk    rename(rkwbpfr:rkwbl1r)
5.41 frkwblr    if   e           k disk    rename(rkwbpfr:rkwblrr)
     frkwblu    uf   e           k disk    rename(rkwbpfr:rkwblur)
     frktrlu    uf   e           k disk    rename(rktrpfr:rktrlur)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     fraa1l1    if   e           k disk    rename(raa1pfr:raa1l1r)
     fraa6l1    if   e           k disk    rename(raa6pfr:raa6l1r)
     fra11l1    if   e           k disk    rename(ra11pfr:ra11l1r)
6.20 frklal2    if   e           k disk    rename(rklapfr:rklal2r)
6.20 frklal3    if   e           k disk    rename(rklapfr:rklal3r)
      *
     frk120d    cf   e             workstn sfile(b1sfl:w_srrn)
     f                                     infds(dspfbk)
      *
      * Definering av Local data area
      *
     d                uds
     d l_user                911    920
     d l_firm                944    946  0
     d l_fnav                951    980
      *
      * Definering av Information Data Structure - display feedback
      *
     d dspfbk          ds
     d  d_fcrn               378    379I 0
      *
      * Definering av variabler i nøkler
      *
     d rkwbl1_kund     s                   like(rnkund)
     d rkwbl1_bdat     s                   like(rnbdat)
     d rkwbl1_tist     s                   like(rwtist)
5.41 d rkwblr_kund     s                   like(rnkund)
5.41 d rkwblr_bdat     s                   like(rnbdat)
5.41 d rkwblr_tist     s                   like(rwtist)
     d rkunl1_kund     s                   like(rnkund)
     d rkwblu_kund     s                   like(rnkund)
     d rkwblu_bdat     s                   like(rnbdat)
     d rkwblu_tist     s                   like(rwtist)
     d rktrlu_kund     s                   like(rnkund)
     d rktrlu_bdat     s                   like(rnbdat)
     d rktrlu_tist     s                   like(rwtist)
     d  ra11l1_kkod    s                         like(rakkod)
      *
     d rksal1_kund     s                   like(rkkund)
6.20 d rklal2_syst     s                   like(rxsyst)
6.20 d rklal2_pros     s                   like(rxpros)
6.20 d rklal2_akti     s                   like(rxakti)
6.20 d rklal2_kund     s                   like(rxkont)
      *
6.20 d rklal3_syst     s                   like(rxsyst)
6.20 d rklal3_pros     s                   like(rxpros)
6.20 d rklal3_akti     s                   like(rxakti)
6.20 d rklal3_kund     s                   like(rxkont)
6.20 d rklal3_spes     s                   like(rxspes)
6.20 d rklal3_avde     s                   like(rxavde)
6.20 d rklal3_tist     s                   like(rxtist)
      *
      * Definering av variable
      *
5.41 d w_fcrn          s              4  0
     d w_stel          s              4  0
     d w_spge          s              4  0
     d w_srrn          s              4  0
     d w_sfrn          s                   like(w_srrn)
     d w_ssrn          s                   like(w_srrn)
      *
     d w_seqe          s              1
     d b_valg_ok       s              1    inz(*off)
     d b_forn          s              1    inz(*off)
     d b_feil          s              1    inz(*off)
      *                                                               . .
     d w_firm          s                   like(rnfirm)
     d w_biln          s                   like(rnbiln)                                      .
     d w_kund          s                   like(rnkund)                                      .
     d w_raar          s                   like(rnraar)                                      .
     d w_valg          s              1
     d w_valg_v        s              1    inz(*off)
      *
     d w_dato          s                   like(rnbdat)
     d w_syst          s              4
      *
     d                 ds
     d w_dato6                        6  0
     d w_dag                          2  0 overlay(w_dato6)
     d w_mnd                          2  0 overlay(w_dato6:3)
     d w_aar                          2  0 overlay(w_dato6:5)
      *
     d w_rent          s              9  2
     d w_rgrl          s             11  2
     d w_rpro          s              4  2
     d w_rfda          s               d   datfmt(*iso)
     d w_rtda          s               d   datfmt(*iso)
     d wdg             s              5  0
      *
6.20 d wpf001          s              3
6.20 d wpavde          s              4  0
6.20 d wpakti          s              6
6.20 d wppros          s              6
6.20 d wpspes          s              4  0
6.20 d wpsyst          s              1
6.20 d wpvalg          s              1  0
6.20  *
     d p_stat          s              1
     d p_akod          s                   like(rnbilk)
     d p_gkod          s                   like(rkavde)
     d p_ikod          s                   like(rkslgr)
     d p_atxt          s             20
     d p_gtxt          s             20
     d p_itxt          s             20
      *
      * Parameter - program RF020R
6.20 i/COPY QCPYLESRC,RF020PAR
6.20 d rxupar          s                   like(rxulda)
      * Definering av konstanter
      *
     d c_sfil          s              2  0 inz(13)
      *
      * Forklaring på spesielle felter
      * som benyttes ved sub-files.
      * - - - - - - - - - - - - - - - - -
5.41  * w_fcrn - Første recordnummer på siden
      * w_stel - Subfile-teller
      * w_spge - Sidestørrelse i subfile (page)
      * w_srrn - Relativt recordnummer i subfile
      * w_sfrn - Første recordnummer på siste side
      * w_ssrn - Siste recordnummer på siste side
      * w_curn - Current recordnummer på siden
      * w_virn - Side og cursorplassering som skal vises
      * w_afld - Aktivt feltnavn
      * w_arow - Aktiv rad for cursor
      * w_acol - Aktiv kolonne for cursor
      *
      * Benyttede skjermbilder.
      * - - - - - - - - - - - - - - - - -
      * B1SFL  - B1 Subfile - record
      * B2CTL  - B2 Subfile - control record
      * B2CMD  - B2 Eget skjermbilde for CMD-taster
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * B2CTL Behandle åpningsbildet med subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Send Alt
      *
     c     b2taga        tag
      *
     c                   write     b2cmd
      *
      * Bare data
      *
     c     b2tagb        tag
      *
     c                   exsr      dsp_subfile
      *
      * Behandling av funksjonstaster
      *
     c                   select
     c                   when      *inkc or *inkl
     c                   goto      avslutt
     c                   when      *inke
     c                   exsr      forny
     c                   goto      b2tagb
     c                   when      *in10
     c                   exsr      crt_subfile
     c                   goto      b2tagb
5.41 c                   when      *in11
5.41 c                   exsr      bck_subfile
5.41 c                   goto      b2tagb
     c                   when      *in21
     c                   eval      *in22 = *on
     c                   goto      b2taga
     c                   endsl
      *
6.20  * Oppkall av notatark. hvis kunden sperret
6.20  * eller F2
6.20  *
6.20 c                   if        *inkb = *on
6.20 c                   move      w_firm        rxfirm
6.20 c                   move      wpsyst        rxsyst
6.20 c                   move      wppros        rxpros
6.20 c                   move      wpakti        rxakti
6.20 c                   move      w_kund        rxkont
6.20 c                   move      wpspes        rxspes
6.20 c                   move      wpavde        rxavde
6.20 c                   eval      rxlinj = *zeros
6.20 c                   eval      rxtext = *blank
6.20 c                   move      wpvalg        rxvalg
6.20 c                   move      *loval        rxtist
6.20 c                   eval      rxbiln = *zero
6.20 c                   eval      rxrper = *zero
6.20 c                   eval      rxraar = *zero
6.20 c                   eval      rxonr  = *zero
6.20 c                   move      rxulda        rxupar
6.20 c                   call      'RF020R'
6.20 c                   parm                    rxupar
6.20 c                   move      rxupar        rxulda
6.20 c                   eval      *inkb = *off
6.20 c                   goto      b2tagb
6.20 c                   endif
6.20  *
      * NOK/Valuta
      *
     c                   if        *inkg = *on                                           .....
     c                   if        w_valg_v = *on                                            .
     c                   eval      w_valg_v = *off
     c                   else                                                                .
     c                   eval      w_valg_v = *on
     c                   endif                                                               .
      *                                                                 .
     c                   eval      rkwbl1_bdat = *loval                                      .
     c                   eval      rkwbl1_tist = *loval                                      .
      *                                                                 .
     c     rkwbl1_key    setll     rkwbl1                                                    .
      *                                                                 .
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
     c                   goto      b2tagb                                                    .
     c                   endif                                                           .....
      *
      * Behandling av subfile
      *
     c                   exsr      subfile
      *
     c                   goto      b2taga
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for fornying av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     forny         begsr
      *
5.41 c                   if        w_fcrn <> 0
5.41 c     w_fcrn        chain     b1sfl
     c                   endif
      *
     c                   eval      rkwbl1_kund = b2kund
5.41 c                   eval      rkwbl1_bdat = b1bdat
5.41 c***                eval      rkwbl1_tist = b1wtis
5.41 c                   eval      rkwbl1_tist = *loval
     c     rkwbl1_key    setll     rkwbl1
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c     end_forny     endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for posisjonering i subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     posisjoner    begsr
      *
     c                   eval      rkwbl1_kund = b2kund
     c     rkwbl1_key    setll     rkwbl1
      *
      * Blanker subfile, og fyller opp i.h.t. posisjonering
      *
     c                   eval      *in22 = *off
      *
     c                   exsr      clr_subfile
     c                   exsr      crt_subfile
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     subfile       begsr
      *
     c                   eval      b_forn = *off
      *
     c                   if        *in22 = *off
     c                   eval      *in22 = *on
     c                   else
     c                   eval      *in22 = *off
     c                   endif
      *
5.41 c                   eval      w_virn = w_fcrn
      *
      * Leser og behandler subfile
      *
     c                   do        w_ssrn
     c                   readc     b1sfl
      *
     c                   if        %eof
     c                   leave
     c                   endif
      *
     c                   eval      *in22 = *off
     c                   eval      w_virn = w_srrn
      *
      * Oppdater
      *
     c                   if        b1valg = 2
     c                   eval      *in30  = *off
     c                   eval      c2nyen = ' Endring '
     c                   exsr      xc2win                                                  . .
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Slette post
      *
     c                   if        b1valg = 4
     c                   eval      d1kund = w_kund
     c                   exsr      xd1win
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *
      * Vis
      *
     c                   if        b1valg = 5
     c                   eval      *in30  = *on
     c                   eval      c2nyen = '   Vis   '
     c                   exsr      xc2win                                                  . .
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
      *                                                                 .
      * Vise faktura
      *
     c                   if        b1valg = 8                                          ..... .
     c                   eval      *in30  = *on
     c                   eval      w_biln = b1biln                                         . .
     c                   eval      w_kund = b2kund                                         . .
     c                   eval      w_raar = b1raar                                         . .
     c                   call      'RK110C'                                                . .
     c                   parm                    w_firm                                    . .
     c                   parm                    w_raar                                    . .
     c                   parm                    w_kund                                    . .
     c                   parm                    w_biln                                    . .
      *
     c                   eval      b1valg = *zero                                          . .
     c                   update    b1sfl                                                   . .
     c                   iter                                                              . .
     c                   endif                                                         ..... .
      *
      * Slette post og merk i reskontro slik at
      * posten ikke blir med på renteberegning senere
      *
     c                   if        w_syst = 'RENT' or
     c                             w_syst = 'FACT'
     c                   if        b1valg = 9
     c                   eval      d1kund = w_kund
     c                   exsr      xd1win
     c                   exsr      mrk_post
     c                   eval      b1valg = 0
     c                   update    b1sfl
     c                   iter
     c                   endif
     c                   endif
      *
     c                   enddo
      *
     c                   if        b_forn = *on
     c                   exsr      forny
     c                   endif
      *
     c     end_subfile   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for tømming av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     clr_subfile   begsr
      *
     c                   eval      *in14 = *on
     c                   write     b2ctl
     c                   eval      *in14 = *off
      *
     c                   eval      *in15 = *off
     c                   eval      w_srrn = 0
     c                   eval      w_sfrn = 0
     c                   eval      w_ssrn = 0
     c                   eval      w_spge = 0
      *
     c                   endsr
      *
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å fylle opp subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     crt_subfile   begsr
      *
     c                   eval      w_spge = w_spge + c_sfil
     c                   eval      w_srrn = w_ssrn
      *
     c                   dou       w_srrn = w_spge
      *
     c                   read      rkwbl1
      *
     c                   if        %eof or
     c                             rnfirm <> w_firm or
     c                             rnkund <> w_kund                                          .
     c                   eval      *in15 = *on
     c                   leave
     c                   endif
      *                                                                 .
      * Ved valg "Valuta"                                               .
      * test om valutakode = blank                                      .
      *                                                                 .
     c                   if        w_valg_v = *on and                                    ... .
     c                             rnvalk = *blank                                         . .
     c                   iter                                                              . .
     c                   endif                                                           ... .
      *
     c                   eval      w_srrn = w_srrn + 1
      *
     c                   eval      b1valg = 0
     c                   eval      b1raar = rnraar
     c                   eval      b1bdat = rnbdat
     c                   eval      b1tist = rntist
     c                   eval      b1wtis = rwtist
     c                   eval      b1biln = rnbiln
     c     *dmy          move      rnbdat        b1bida
     c                   eval      b1bilk = rnbilk
     c                   eval      b1text = rntext
      *
     c                   if        rnrefn <> *zeros                                          .
     c                   eval      b1refn = rnrefn
     c                   else                                                              . .
     c                   eval      b1refn = rnsamf
     c                   endif                                                             . .
      *
     c     *dmy          move      rnfdat        b1fdat
      *                                                                 .
      * Valuta/NOK                                                      .
      *                                                                 .
     c                   if        w_valg_v = *off                                       ... .
     c                   eval      b1belØ = rnbelØ
     c                   eval      b1rest = rnrest                                         . .
     c                   else                                                              . .
     c                   eval      b1belØ = rnvalb
     c                   eval      b1rest = rnvalr                                         . .
     c                   move      '    '        b1text                                    . .
     c                   move      rnvalk        b1text                                    . .
     c                   endif                                                           ... .
      *
6.20  * Gult bilagsnr. hvis det finnes notatblokk på posten
6.20  *
6.20 c                   eval      rklal3_syst = 'K'
6.20 c                   eval      rklal3_pros = *blanks
6.20 c                   eval      rklal3_akti = *blanks
6.20 c                   eval      rklal3_kund = b2kund
6.20 c                   eval      rklal3_spes = *zero
6.20 c                   eval      rklal3_avde = *zero
6.20 c                   eval      rklal3_tist = b1tist
6.20 c     rklal3_key    setll     rklal3                                 73
6.20  *
     c                   write     b1sfl
6.20 c                   eval      *in73  = *off
      *
     c                   enddo
      *
      * Send melding hvis ingen poster
      *
     c                   if        w_srrn = *zero                                        .....
     c                   exsr      clr_subfile
      *                                                                 .
     c                   if        w_valg_v = *on                                        ... .
     c                   eval      b1text = 'Ingen valutaposter'
     c                   else                                                              . .
     c                   eval      b1text = 'Ingen poster'
     c                   endif                                                           ... .
      *                                                                 .
     c                   eval      b1biln = *zeros                                           .
     c                   eval      b1bdat = *loval                                           .
     c                   eval      b1bilk = *zeros                                           .
     c                   eval      b1refn = *zeros                                           .
     c                   eval      b1fdat = *zeros                                           .
     c                   eval      b1belØ = *zeros                                           .
     c                   eval      b1rest = *zeros                                           .
     c                   eval      w_srrn = 1                                                .
     c                   write     b1sfl
      *
     c                   endif                                                           .....
      *
     c                   if        w_srrn > w_ssrn
     c                   eval      w_sfrn = w_ssrn + 1
     c                   endif
      *
     c                   eval      w_ssrn = w_srrn
     c                   eval      w_virn = w_sfrn
      *
     c                   endsr
5.41  *
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  * Subrutine for å bla tilbake en side i subfilen
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  *
5.41 c     bck_subfile   begsr
5.41  *
5.41 c                   if        *in15
5.41 c     rkwbl1_key    setgt     rkwbl1
5.41 c                   readp     rkwbl1
5.41 c                   endif
5.41  *
5.41  * Leser tilbake en side
5.41  *
5.41 c                   eval      w_stel = 0
5.41  *
5.41 c                   dou       w_stel = w_ssrn + c_sfil
5.41  *
5.41 c                   readp     rkwbl1
5.41  *
5.41 c                   if        %eof or
5.41 c                             rnfirm <> w_firm or
5.41 c                             rnkund <> w_kund
5.41 c                   leave
5.41 c                   endif
5.41  *
5.41 c                   eval      w_stel = w_stel + 1
5.41  *
5.41 c                   eval      rkwbl1_kund = rnkund
5.41  *
5.41 c                   enddo
5.41  *
5.41 c                   if        %eof
5.41 c     rkwbl1_key    setll     rkwbl1
5.41 c                   endif
5.41  *
5.41  * Blanker og fyller opp subfile
5.41  *
5.41 c                   exsr      clr_subfile
5.41 c                   exsr      crt_subfile
5.41  *
5.41 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for display av subfile
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     dsp_subfile   begsr
      *
     c                   if        w_srrn <> 0
     c                   eval      *in12 = *on
     c                   else
     c                   write     b2cmd
     c                   endif
      *
     c                   eval      *in13 = *on
     c                   exfmt     b2ctl
      *
     c                   eval      *in12 = *off
     c                   eval      *in13 = *off
      *
5.41 c                   eval      w_fcrn = d_fcrn
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * C2WIN Behandle bilde for oppdatering                            *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xc2win        begsr
      *
     c                   eval      rkwblu_kund = b2kund
     c                   eval      rkwblu_bdat = b1bdat
     c                   eval      rkwblu_tist = b1wtis
     c     rkwblu_key    chain     rkwblu                             60
      *
     c                   if        %found(rkwblu)
      *
     c                   move      rnbiln        c2biln                                      .
     c                   move      rnbilk        c2bilk                                      .
     c                   move      rntext        c2text                                      .
     c     *dmy          move      rnbdat        c2bdat                                      .
     c     *dmy          move      rnfdat        c2fdat                                      .
     c                   move      rnrper        c2rper                                      .
     c                   move      rnraar        c2raar                                      .
     c                   move      rnrekl        c2rekl                                      .
     c                   move      rnjour        c2jour                                      .
     c                   move      rnrefn        c2refn                                      .
     c                   move      rnsamf        c2samf                                      .
     c                   move      rnbiln        c2biln                                      .
     c                   move      rnbelØ        c2belØ                                      .
     c                   move      rnrest        c2rest                                      .
     c                   move      rnrenk        c2renk                                      .
      *
     c                   if        rwrfda = *loval
     c                   eval      c2rfda = 0                                                .
     c                   else
     c     *dmy          move      rwrfda        c2rfda                                      .
     c                   endif
      *
     c                   if        rwrtda = *loval
     c                   eval      c2rtda = 0                                                .
     c                   else
     c     *dmy          move      rwrtda        c2rtda                                      .
     c                   endif
      *
     c                   move      rwrgrl        c2rgrl                                      .
     c                   move      rwrent        c2rent                                      .
      *
     c                   move      rnantp        c2antp                                      .
      *
     c                   if        rnpdat = *loval
     c                   eval      c2pdat = 0                                                .
     c                   else
     c     *dmy          move      rnpdat        c2pdat                                      .
     c                   endif
      *
     c                   if        rnrdat = *loval
     c                   eval      c2rdat = 0                                                .
     c                   else
     c     *dmy          move      rnrdat        c2rdat                                      .
     c                   endif
      *
     c                   move      rninko        c2inko                                      .
      *
     c                   if        rnidat = *loval
     c                   eval      c2idat = 0                                                .
     c                   else
     c     *dmy          move      rnidat        c2idat                                      .
     c                   endif
      *
     c     c2taga        tag
      *
     c                   exfmt     c2win
      *
6.20  * Notatblokk bilag
6.20 c                   if        *inkb
6.20 c                   eval      rxtist = rntist
6.20 c                   eval      rxbiln = rnbiln
6.20 c                   eval      rxrper = rnrper
6.20 c                   eval      rxraar = rnraar
6.20 c                   eval      rxonr  = *zero
6.20 c                   exsr      notat
6.20 c                   goto      end_c2bld
6.20 c                   endif
      *
     c                   if        *inkc or *inkl
     c                   goto      end_c2bld
     c                   endif
      *
      * Call program for bilagskode
      *
     c                   if        *inkd = *on and                                       .....
     c                             w_afld = 'C2BILK'                                         .
     c                   call      'RA501R'                                                  .
     c                   parm                    w_firm                                      .
     c                   parm                    p_akod                                      .
     c                   parm                    p_atxt                                      .
      *                                                                 .
     c                   if        p_akod <> *zero                                           .
     c                   eval      c2bilk = p_akod                                           .
     c                   eval      c2text = p_atxt                                           .
     c                   endif                                                               .
      *                                                                 .
     c                   move      *on           *in33                                       .
     c                   goto      c2taga                                                    .
     c                   endif                                                           .....
      *
      * Kontroll av skjermbildet
      *
     c                   exsr      sjekk_input
      *
     c                   if        b_feil = *on
     c                   goto      c2taga
     c                   endif
      *
      * Oppdater posteringsregister
      *
     c                   eval      rkwblu_bdat = b1bdat
     c                   eval      rkwblu_tist = b1wtis
     c     rkwblu_key    chain     rkwblur                            60
      *
     c                   move      c2bilk        rnbilk
     c                   move      c2text        rntext
     c     *dmy          move      c2fdat        rnfdat
     c                   move      c2rekl        rnrekl
     c                   move      c2refn        rnrefn
     c                   move      c2renk        rnrenk
     c                   move      c2rest        rnrest
      *
     c                   move      c2antp        rnantp
      *
     c                   if        c2pdat = 0
     c                   eval      rnpdat = *loval
     c                   else
     c     *dmy          move      c2pdat        rnpdat
     c                   endif
      *
     c                   if        c2rdat = 0
     c                   eval      rnrdat = *loval
     c                   else
     c     *dmy          move      c2rdat        rnrdat
     c                   endif
      *
     c                   move      c2inko        rninko
      *
     c                   if        c2idat = 0
     c                   eval      rnidat = *loval
     c                   else
     c     *dmy          move      c2idat        rnidat
     c                   endif
      *
      * Sjekk om renteberegning skal endres
      *
     c                   if        c2rtda = 0
     c                   eval      w_rtda = *loval
     c                   else
     c     *dmy          move      c2rtda        w_rtda
     c                   endif
      *
     c                   if        c2rfda = 0
     c                   eval      w_rfda = *loval
     c                   else
     c     *dmy          move      c2rfda        w_rfda
     c                   endif
      *
     c                   eval      w_rgrl = c2rgrl
      *
      * Bruk rentesats fra parameterbildet
      *
     c                   eval      w_rpro = ra6ppr
      *
      * Henter avvikende rentesats fra kunde/kundekategori
      *
     c                   eval      rkunl1_kund = b2kund
     c     rkunl1_key    chain     rkunl1
      *
     c                   eval      ra11l1_kkod = rkkatg
     c     ra11l1_key    chain     ra11l1
      *
     c                   if        %found and
     c                             rakavp <> 0
     c                   eval      w_rpro= rakavp
     c                   endif
      *
      * Beregn rente dersom rente fra dato, rente til dato eller rentegrunnlag er endret
      *
     c                   if        w_rfda <> rwrfda or
     c                             w_rtda <> rwrtda or
     c                             w_rgrl <> rwrgrl
      *
     c                   exsr      beregn
      *
     c                   eval      rwrfda = w_rfda
     c                   eval      rwrtda = w_rtda
     c                   eval      rwrgrl = w_rgrl
     c                   eval      rwrent = w_rent
     c                   eval      rwdagr = wdg
     c                   endif
      *
      * Oppdater transaksjonsfil
      *
     c                   update    rkwblur
     c                   endif
      *
     c     end_c2bld     tag
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for behandling av slette-bildet (D1WIN)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xd1win        begsr
      *
5.41 c                   eval      rkwblr_kund = d1kund
5.41 c                   eval      rkwblr_bdat = b1bdat
5.41 c                   eval      rkwblr_tist = b1wtis
5.41 c     rkwblr_key    chain     rkwblr                             90
      *
     c     d1tagb        tag
      *
5.41 c                   eval      d1bilk = rnbilk
5.41 c                   eval      d1text = rntext
5.41 c                   eval      d1bdat = rnbdat
5.41 c                   eval      d1belØ = rnbelØ
5.41 c                   eval      d1rest = rnrest
      *
     c                   exfmt     d1win
      *
     c                   if        *inkc or *inkl
     c                   goto      end_d1win
     c                   endif
      *
     c                   eval      rkwblu_kund = d1kund
     c                   eval      rkwblu_bdat = b1bdat
     c                   eval      rkwblu_tist = b1wtis
      *
     c                   eval      b_forn = *on
      *
     c     rkwblu_key    chain     rkwblu                             90
      *
     c                   if        *in90 = *off
     c                   delete    rkwblur
     c                   endif
      *
     c                   exsr      sum_poster
      *
     c     end_d1win     endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Kontroll  C2 bilde (endringer)                                  *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     sjekk_input   begsr
      *
     c                   eval      b_feil = *off
     c                   eval      *in32  = *off
     c                   eval      *in33  = *off
     c                   eval      *in34  = *off
     c                   eval      *in35  = *off
     c                   eval      *in40  = *off
     c                   eval      *in41  = *off
     c                   eval      *in42  = *off
     c                   eval      *in43  = *off
     c                   eval      *in44  = *off
     c                   eval      *in45  = *off
      *
      * Sjekke om forfallsdato er gyldig
      *
     c                   if        c2fdat > 0
     c     *dmy          test(d)                 c2fdat                 40
     c                   if        *in40 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
     c                   endif
      *
      * Sjekke om purret dato er gyldig
      *
     c                   if        c2pdat > 0
     c     *dmy          test(d)                 c2pdat                 41
     c                   if        *in41 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
     c                   endif
      *
      * Sjekke om renteberegnet dato er gyldig
      *
     c                   if        c2rdat > 0
     c     *dmy          test(d)                 c2rdat                 42
     c                   if        *in42 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
     c                   endif
      *
      * Sjekke om rente-fra-dato er gyldig
      *
     c                   if        c2rfda > 0
     c     *dmy          test(d)                 c2rfda                 43
     c                   if        *in43 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
     c                   endif
      *
      * Sjekke om rente-til-dato er gyldig
      *
     c                   if        c2rtda > 0
     c     *dmy          test(d)                 c2rtda                 44
     c                   if        *in44 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
     c                   endif
      *
      * Sjekke om inkasso dato er gyldig
      *
     c                   if        c2idat > 0
     c     *dmy          test(d)                 c2idat                 45
     c                   if        *in45 = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
     c                   endif
      *
      * Sjekk om bilagskode er gyldig
      *
     c                   move      c2bilk        p_akod
     c                   call      'RS701R'
     c                   parm                    p_stat
     c                   parm                    p_akod
     c                   parm                    p_atxt
      *
     c                   if        p_stat = 'N'
     c                   move      *on           *in33
     c                   move      *on           *in81
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
      *
     c     end_sjekk     endsr
      *
     c/eject
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å summere posteringer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     sum_poster    begsr
      *
     c                   eval      b2sump = 0                                              . .
     c                   eval      *in16  = *off                                           . .
      *
5.41 c                   eval      rkwblr_kund = w_kund
5.41 c                   eval      rkwblr_bdat = *loval
5.41 c                   eval      rkwblr_tist = *loval
5.41 c     rkwblr_key    setll     rkwblr
      *
     c                   dow       *in16 = *off
      *
5.41 c                   read      rkwblr
      *
     c                   if        %eof or
     c                             rnfirm <> w_firm or
     c                             rnkund <> w_kund                                          .
     c                   eval      *in16 = *on
     c                   leave
     c                   endif
      *
     c                   eval      b2sump = b2sump + rnrest                                . .
      *
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for merking av renteposter
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     mrk_post      begsr
      *
     c                   eval      rktrlu_kund = d1kund
     c                   eval      rktrlu_bdat = b1bdat
     c                   eval      rktrlu_tist = b1tist
     c     rktrlu_key    chain     rktrlu
      *
     c                   if        %found
      *
     c                   if        w_syst = 'RENT'
     c                   eval      rnrenk = 1
     c                   endif
      *
     c                   if        w_syst = 'FACT'
     c                   eval      rnfack = 1
     c                   endif
      *
6.10 c                   time                    rnedat
6.10 c                   time                    rnetim
6.10 c                   eval      rneusr = l_user
     c                   update    rktrlur
     c                   endif
      *
     c     end_mrk       endsr
      *
     c/eject
      *
      * Beregn løpedager og rente
      *
     c     beregn        begsr
      *
      * Beregn rentedager
      *
     c     w_rtda        subdur    w_rfda        wdg : *d
      *
      * Hvis antall rentedager negativ, sett dager = 0
      *
     c                   if        wdg < 0
     c                   eval      wdg = 0
     c                   endif
      *
      * Beregn rente
      *
     c                   if        w_rgrl / 100 * w_rpro / 360 * wdg > 9999999
     c                   eval      w_rent = 9999999
     c                   else
     c                   eval      w_rent = w_rgrl / 100 * w_rpro / 360 * wdg
     c                   endif
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  * Subrutine for oppkall av notatark
6.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  *
6.20 c     notat         begsr
6.20  *
6.20 c                   eval      rxfirm = w_firm
6.20 c                   eval      rxsyst = 'K'
6.20 c                   eval      rxpros = *blank
6.20 c                   eval      rxakti = ' '
6.20 c                   eval      rxkont = rkkund
6.20 c                   eval      rxspes = 0
6.20 c                   eval      rxavde = 0
6.20 c                   eval      rxlinj = *zeros
6.20 c                   eval      rxtext = *blank
6.20 c                   eval      rxvalg = *blank
6.20 c                   move      rxulda        rxupar
6.20  *
6.20 c                   call      'RF020R'
6.20 c                   parm                    rxupar
6.20  *
6.20 c                   move      rxupar        rxulda
6.20  *
6.20 c                   endsr
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
6.20  * Parametre til Notatark.
6.20  *
6.20 c                   move      'K'           wpsyst
6.20 c                   eval      wpspes = 0
6.20 c                   eval      wpavde = 0
6.20 c                   eval      wppros = *blanks
6.20 c                   eval      wpakti = *blanks
6.20 c                   eval      wpf001 = *blanks
      *
      * Parameterliste
      *
     c     *entry        plist
     c                   parm                    w_valg
     c                   parm                    w_kund
     c                   parm                    w_syst
      *
      * Key for posisjonering på kundeposter
      *
     c     rkwbl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkwbl1_kund
     c                   kfld                    rkwbl1_bdat
     c                   kfld                    rkwbl1_tist
5.41  *
5.41  * Key for lesing av kundeposter
5.41  *
5.41 c     rkwblr_key    klist
5.41 c                   kfld                    w_firm
5.41 c                   kfld                    rkwblr_kund
5.41 c                   kfld                    rkwblr_bdat
5.41 c                   kfld                    rkwblr_tist
      *
      * Key for oppdatering av kundeposter
      *
     c     rkwblu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkwblu_kund
     c                   kfld                    rkwblu_bdat
     c                   kfld                    rkwblu_tist
      *
      * Key for oppdatering av kundeposter
      *
     c     rktrlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rktrlu_kund
     c                   kfld                    rktrlu_bdat
     c                   kfld                    rktrlu_tist
      *
      * Key for kunderegister via kundenummer
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Key for statuskode 1
      *
     c     raa1l1_key    klist
     c                   kfld                    w_firm
      *
6.20  * Key for notatblokk
      *
6.20 c     rklal2_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    rklal2_syst
6.20 c                   kfld                    rklal2_pros
6.20 c                   kfld                    rklal2_akti
6.20 c                   kfld                    rklal2_kund
      *
6.20 c     rklal3_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    rklal3_syst
6.20 c                   kfld                    rklal3_pros
6.20 c                   kfld                    rklal3_akti
6.20 c                   kfld                    rklal3_kund
6.20 c                   kfld                    rklal3_spes
6.20 c                   kfld                    rklal3_avde
6.20 c                   kfld                    rklal3_tist
      * Henter parametre, og initierer skjermbildet
      *
     c                   eval      w_firm = l_firm
      *
     c                   eval      *in22 = *on
     c                   move      *date         w_dato
      *
      * Sett på *in38 for å vise kode 9=Slett/merke i skjermbildet
      *
     c                   if        w_syst = 'RENT' or
     c                             w_syst = 'FACT'
     c                   eval      *in38 = *off
     c                   else
     c                   eval      *in38 = *on
     c                   endif
      *
      * Hent kunde
      *
     c                   eval      rkunl1_kund = w_kund
     c     rkunl1_key    chain     rkunl1                             61
      *
     c                   eval      b2kund = w_kund
     c                   eval      b2navn = rknavn
     c                   eval      b2sald = rksald
      *
6.20  * Finnes notatblokk på kunden?
6.20  *
6.20 c                   eval      rklal2_syst = 'K'
6.20 c                   eval      rklal2_pros = *blanks
6.20 c                   eval      rklal2_akti = *blanks
6.20 c                   eval      rklal2_kund = b2kund
6.20 c     rklal2_key    setll     rklal2                                 94
6.20  *
6.20 c                   if        *in94 = *on
6.20 c                   eval      B2notb = 'NOTATARK'
6.20 c                   endif
      *
      * Hent statuskode 1
      *
     c     raa1l1_key    chain     raa1l1                             61
      *
      * Key for kundekategori
      *
     c     ra11l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    ra11l1_kkod
      *
      * Key for statusopplysninger og betalingsbetingelser
      *
     c     raa6l1_key    klist
     c                   kfld                    w_firm
      *
      * Hent renteprosent fra koderegisteret
      *
     c     raa6l1_key    chain     raa6l1
      *
      * Beregn sum poster
      *
     c                   exsr      sum_poster
      *
      * Posisjonerer databasen, og fyller opp subfile
      *
     c                   eval      rkwbl1_kund = w_kund
     c                   eval      rkwbl1_bdat = *loval
     c                   eval      rkwbl1_tist = *loval
      *
     c     rkwbl1_key    setll     rkwbl1
      *
     c                   exsr      crt_subfile
      *
     c                   endsr
