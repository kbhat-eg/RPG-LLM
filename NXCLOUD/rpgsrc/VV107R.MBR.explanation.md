<h2>Program Overview</h2>
<p>This RPG IV program (VV107R) handles the maintenance of an item’s statistical unit (“statistikkenhet”). It displays a screen for the user to change the unit, validates input, updates the master file, and calls external programs to adjust related statistics.</p>

<h2>Header and Compile Options</h2>
<ul>
  <li><b>option(*nodebugio)</b>: Disables debug I/O.</li>
  <li><b>datedit(*dmy)</b>: Sets date edit format to DD.MM.YYYY.</li>
  <li>Comments record program metadata, version history, and change descriptions.</li>
</ul>

<h2>File Declarations</h2>
<ul>
  <li><b>fvvarl1</b> (vvarpfr → vvarl1r): Input file for item master data.</li>
  <li><b>fvvenl1</b> (vvenpfr → vvenl1r): Input file for item‐unit master data.</li>
  <li><b>fvvarlu</b> (vvarpfr → vvarlur): Update file for item master.</li>
  <li><b>fvv107d</b>: Display file representing the GUI screen (workstn). </li>
</ul>

<h2>Data Areas and Variables</h2>
<dl>
  <dt>Local Data Area (User Data Structure)</dt>
    <dd>Field <code>l_user</code> holds the current user ID (positions 911–920).</dd>
  <dt>Parameters</dt>
    <dd><code>p_firm</code>, <code>p_vare</code>: Incoming company and item codes.</dd>
  <dt>Key‐file Variables</dt>
    <dd><code>vvenl1_enhe</code>: Holds the new statistical unit code entered by user.</dd>
  <dt>Working Variables</dt>
    <dd>
      <ul>
        <li><code>b_feil</code>: Error flag (1 = error).</li>
        <li><code>w_etxt</code>: Error text for F4 help.</li>
        <li><code>w_firm</code>, <code>w_vare</code>: Local copies of company and item.</li>
      </ul>
    </dd>
</dl>

<h2>Main Logic (B1 Handler)</h2>

<h3>1. Initialize Screen Fields</h3>
<pre>
CHAIN vvarl1 (key = w_firm, w_vare) 
IF *IN90 = *ON 
  GOTO avslutt 
ENDIF 
EVAL b1ensg = vvenhs  ; store old statistical unit
</pre>

<h3>2. Display and Input Loop</h3>
<pre>
b1taga: 
  EXFMT b1bld   ; render screen and wait for input
</pre>

<h3>3. Handle Function Keys</h3>
<dl>
  <dt>*INKC or *INKL</dt><dd>Exit the program.</dd>
  <dt>*INKD (F4)</dt><dd>Call the <code>spørring</code> subroutine for unit lookup, then redisplay.</dd>
</dl>

<h3>4. Input Validation</h3>
<pre>
EXSR sjekk_input 
IF b_feil = *ON 
  GOTO b1taga 
ENDIF
</pre>
<ul>
  <li>Ensures new unit ≠ old unit.</li>
  <li>Checks existence of the new unit in the unit master file.</li>
</ul>

<h3>5. Update Master Record</h3>
<pre>
CHAIN vvarlur (key = w_firm, w_vare)
IF *IN90 = *OFF
  EVAL vvenhs = b1enhs   ; set new unit
  TIME vvedat           ; update date
  TIME vvetim           ; update time
  EVAL vveusr = l_user   ; update user
  UPDATE vvarlur
ENDIF
</pre>

<h3>6. Adjust Related Statistics</h3>
<p>After updating the item’s unit, the program calls two external programs to adjust historical statistics:</p>
<ul>
  <li><b>SF750R</b>: Updates sales statistics. Passes <code>w_firm</code>, <code>w_vare</code>, <code>b1enhs</code>.</li>
  <li><b>SI750R</b>: Updates purchase statistics. Same parameters.</li>
</ul>

<h3>7. Program End</h3>
<pre>
avslutt:
  EVAL *INLR = *ON   ; set last record indicator
  RETURN
</pre>

<h2>Subroutine: spørring (Help / F4)</h2>
<pre>
spørring:
  IF w_afld = 'B1ENHS'
    CALL 'VE550R' PARM(w_firm : w_vare : b1enhs : w_etxt)
  ENDIF
endsr
</pre>
<p>When F4 is pressed on the statistical unit field, calls the lookup program <code>VE550R</code>, returns a valid code or error text.</p>

<h2>Subroutine: sjekk_input (Validation)</h2>
<pre>
sjekk_input:
  EVAL b_feil = *OFF

  IF b1enhs = b1ensg            ; same as old
    SETON *IN31
    EVAL b_feil = *ON
    RETURN
  ENDIF

  EVAL vvenl1_enhe = b1enhs
  CHAIN vvenl1 (key = w_firm, w_vare, vvenl1_enhe)
  IF *IN32 = *ON                ; not found
    EVAL b_feil = *ON
  ENDIF
endsr
</pre>

<h2>Initialization (INZSR)</h2>
<pre>
*INZSR:
  *ENTRY PLIST
    PARM p_firm
    PARM p_vare

  KLIST for vvarl1: w_firm, w_vare
  KLIST for vvenl1: w_firm, w_vare, vvenl1_enhe
  KLIST for vvarlu: w_firm, w_vare

  EVAL w_firm = p_firm
  EVAL w_vare = p_vare
endsr
</pre>
<p>Copies incoming parameters into working fields and defines key lists for file operations.</p>