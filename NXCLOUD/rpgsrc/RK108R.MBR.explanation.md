# RPG Program Explanation: Flytting av kunder og posteringer (`RK108R`)

## Context and Purpose

This program, part of the ASOKON system, is named `RK108R` and is responsible for moving (merging) customers and their associated transactions/postings in the company's database. It offers an interactive interface (via subfiles) to select, display, and transfer customer records, including their postings, memos, notes, and related sub-entities.

The program is enhanced over many iterations (as seen in the change log at the top), including support for special agreements, note blocks, memos, and customer lookup by name or address, and it contains mechanisms to lock or restrict its functionality.

---

## Core Components

### Files

The program declares multiple logical and physical files:
- Customer master and associated logicals (`rkunl1`, `rkunl2`, etc.).
- Memo, special agreement, transactions, kid (OCR/customer identification no), note blocks, etc.
- Subfile declarations for displaying data on a workstation (green screen).

### Main Data Structures

- **Local Data Area (LDA)**: For retrieving logged-in user and firm number.
- **Work Variables**: For holding current customer, selection state, accumulators, page sizes, etc.
- **DS for KID fields**: Used for manipulation of KID info (typically payment/customer reference).

### Key Concepts

- **Indicators**: RPG's boolean flags (`*INxx`) for function key detection, field protection, subfile state, etc.
- **Subfiles**: Used to display customer lists in a scrollable fashion, supporting actions per row (edit, display, move, etc.).
- **Function Keys**: Mapped to specific actions (exit, refresh, next/previous page, position to, show duplicates, etc.).
- **Subroutines (`begsr`/`endsr`)**: The program logic is highly modular, with clear routines for each main task.

---

## Main Program Flow

1. **Startup/Initialization**
   - Reads the firm number from LDA.
   - Sets up keys for various indexed access.
   - Populates the initial subfile with customer data (likely sorted by name at first).

2. **Access Restriction**
   - Before allowing usage, checks if the functionality is locked for the current company/group by calling `TESTSPERRE`. If locked, shows a message and exits.

3. **Main Display Loop**
   - Handles displaying and interacting with the subfile list of customers.
   - Responds to function keys (exit, refresh, paging, position to, show duplicates, toggle view modes, etc.).
   - Allows searching/positioning by customer number or name.

4. **Subfile Interaction**
   - For each row, allows actions like **edit** (calls maintenance program), **view**, and **move** (begins moving this customer to another).
   - When moving, it triggers logic to copy all postings, memos, KID entries, notes, and finally deletes the original customer.

5. **Copying/Merging Logic**
   - Ensures no duplication or invalid moves (e.g., moving to self or to customer number zero).
   - Merges balances and associated data if the target exists, or creates a new target customer otherwise.
   - Special handling for memos and notes (with options to copy or remove).
   - Cleans up old records in all related files after migration.

6. **Supporting Routines**
   - Subfile maintenance: clear, fill, handle back/forward.
   - Display routines: for dialog windows, messages, and screens.
   - Utility subroutines: for uppercase conversion, field comparison, etc.
   - Special routines to verify presence of agreements or notes, warn the user, and handle accordingly.

---

## Important Logic Sections

### Subfile Management

- **Display and Paging**: Data is shown in pages; the user can scroll, refresh, and filter.
- **Toggle Modes**: Function keys toggle between showing name or address in the list, and between all customers or just those with duplicates.

### Customer Move (Copy/Merge) (`xk1win`)
- **Validation**: No move if the new and old customer numbers are the same or new customer is zero.
- **New Customer Creation**: Copies data to new customer, creates memo record if needed.
- **Merging**: If moving to an existing customer, aggregates balances and memo amounts.
- **Move Postings**: Updates all transactions to the new customer number.
- **Move KID**: Transfers any payment IDs.
- **Cleanup**: Deletes old customer, associated notes, memos, and agreements if applicable.

---

## Key Data Structures and Indicators

- **w_* Variables**: Working fields, e.g. current firm (`w_firm`), customer number (`w_kund`), balances, etc.
- **Subfile Row Variables**: E.g., `b1alfa`, `b1kund`, `b1navn`, etc. for subfile display record.
- **Indicators**: Used for subfile operations (`*IN10`, `*IN12`), error conditions (`*IN33`, etc.), and control (`*IN80` for display toggle).
- **Constants for Case Conversion**: `lo` and `up` constants are used with `XLATE` to convert between lowercase and uppercase for consistent comparison and presentation.

---

## Field Comparison/Filter

- The user may filter or only show duplicates based on name, address, phone, etc. The subroutine `xsrkont` controls if a row is considered a duplicate based on the selected fields.

---

## Comments/Documentation

- The program header documents modifications by version, author, and date, with a summary of what was changed.
- Extensive inline comments explain the purpose of routines, variables, and business logic, mostly in Norwegian.

---

## Function Key Map (Partial)

| Indicator | Key | Purpose                                 |
|-----------|-----|-----------------------------------------|
| *IN10     | F10 | Next page                              |
| *IN11     | F11 | Previous page / Toggle view             |
| *IN21     | F21 | Home                                   |
| *INKC     | F3  | Exit                                   |
| *INKL     | F12 | Exit                                   |
| *INKE     | F5  | Refresh                                |
| *INKG     | F7  | Show only duplicates                   |
| *INKK     | F11 | Toggle between name/address in subfile |

---

## Special Handling

- **Special Agreements and Notes**: Extra confirmation if the customer being moved has these.
- **Field Overlay**: For KID field, overlays are used for easy manipulation of subfields.

---

## Error Handling

- Ensures safe operations with checks for:
  - Nonexistent customer numbers.
  - Attempting to move to same customer.
  - Target customer already exists (unless merging is intended).
- Uses message screens to prompt for confirmation or display errors.

---

## Batch Operations

- When moving a customer, all their postings (transactions), KID entries, notes, and memos are iterated and updated to the new customer number.

---

## Summary

**This program is an interactive ILE RPG application for maintaining customer masters, including powerful mechanisms to move or merge customers, while ensuring all related records and sub-entities are consistently updated.** The design is modular, robust, and supports many business scenarios required for customer data integrity and migration within the ASOKON system.

### Onboarding Tips

- Focus on understanding RPG indicators, subfiles, and how database logicals are used for access.
- Most business logic is encapsulated in subroutines for clarity.
- The code is well-commented, and function key behavior/documentation is explicitly mapped at the top.
- For UI changes, subfile and display file definitions should be understood.
- All moves/merges are accompanied by necessary validations and user prompts, maintaining data integrity.

---

### Common Use Cases

- Searching for customers by number or name and paging through the list.
- Editing, viewing, or moving (merging) a customer to a new or existing customer number.
- Handling of duplicates, memos, notes, and special agreements during the move.
- Ensuring full audit and traceability information is updated (timestamps, user IDs).

---

### Key Files Referenced

- `rkunl1`, `rkunl2`: Customer master logicals, by number and name respectively.
- `rkunlu`, `frkunlu`: Customer master update logical.
- `rkmelu`, `frkmelu`: Memo balances.
- `rksolu`: Customer search text.
- `rktrlu`: Transaction postings.
- `akidlu`: KID (customer reference numbers).
- `rksalu`: Special agreements.
- `rklalu`: Note blocks.

---

If you are onboarding to this program, understanding RPG subfiles and indicators, as well as the business rules for customer data, is essential!