# RPG Program EM102R - Explanation

## 1. **Purpose and Functionality**

This program is intended for the maintenance of "bonuselementer" (bonus elements) as templates. It provides full CRUD (Create, Read, Update, Delete) functionality for the management of bonus element records in a subfile interface on IBM i. It supports searching, editing, copying, deleting, and detailed inquiry for bonus rules/elements, and is designed to work with a variety of file relationships (groups, items, modules, etc.).

## 2. **File and Display Definitions**

### **Physical/Logical Files (F-specs)**
The program uses multiple database files, each representing different entities, e.g.:
- `embhi1`, `embeir`, `embeiu`, etc.: Bonus Master, Element, and Update files.
- `fra11l1`, `fvogrl1`, `fvvarl1`, etc.: Reference files (likely for groups, items, suppliers, etc.).
- All files are renamed locally to shorter names for use in the code.

### **Display Files**
- `em102d`: The main display file, using subfiles (B1SFL) for listing, and multiple record formats for maintenance screens and pop-ups/warnings.

## 3. **Data and Working Variables (D-specs)**

- **Parameters**: `p_firm`, `p_bbot`, `p_bmnr` — passed in to indicate which company/bonus customer/template.
- **Local Data Area**: Used for audit/user info.
- **Display Feedback Information**: Display file feedback, primarily for cursor positioning.
- **Key and Working Variables**: Used for searching and updating key fields in subfiles and database files.
- **Flags & Indicators**: For example, `b_forn` (refresh), `b_oppr` (create mode), `b_anul` (cancel), `b_feil` (error), and various indicator variables.

## 4. **Indicator Usage**

- Follows traditional RPG indicator philosophy.
- Special indicators (e.g., LR for last record - program end, *in10 for rollup, *in14 for subfile clear, etc.)
- Error and status communication via indicators.

## 5. **Subfile and Screen Handling**

### **Main Looping Structure**
- **B2CTL (Main Subfile Control)**: Handles subfile page navigation, function keys, and actions like edit, create, copy, delete, and view.
- **Action Selection & Branching**: Uses `SELECT/WHEN` statements for function key handling, branching to appropriate subroutines depending on user action.

### **Subfile Operations**
- **Creating/Clearing/Reading**: Subroutines `crt_subfile`, `clr_subfile`, `bck_subfile`, and `dsp_subfile` handle the population, blanking, page-back, and display of the subfile.
- **Record Positioning**: Allows positioning within the subfile based on search criteria for group/module/item/etc.

### **Maintenance and Inquiry**
- **Create (Add) New Row**: `xc1bld` — screen and logic for adding.
- **Edit/View Row**: `xc2bld` — screen and logic for editing or viewing.
- **Delete Row**: `xd1win` — screen and logic for confirming and processing a delete.
- **Copy Row**: `xk1win` — screen and logic for copying from one bonus element to another.

### **Validation and Lookup**
- **sjekk_input**: Checks the validity of entered keys (existence, relationships, date ranges, etc.).
- **hent_info**: Looks up and populates descriptive fields (e.g., group name, supplier name, item description).

### **Inquiry Popups**
- Subroutine `spørring` (`sporring`): Handles lookups for selecting valid values (F4 and similar help/popups) for the key fields.

## 6. **General Program Flow**

1. **Initialization (`*inzsr`)**
   - Receives parameters, reads initial master/template records, sets up subfile headers, and positions database for subfile loading.

2. **Main Processing Loop**
   - Handles user actions from the subfile screen: navigation, add, edit, copy, delete, inquiry, search position, and exits.

3. **CRUD Operations**
   - Depending on user selection, enters subroutines for the corresponding maintenance screens and database operations.

4. **Validation and Error Handling**
   - Inputs are validated for referential integrity, correct formats, and business rules before updates are written to the database.

5. **Auxiliary (Inquiry) Lookups**
   - For all key fields, pop-up calls to other inquiry programs allow user to search or validate codes.

## 7. **Notable Implementation Aspects**

- **Subfile Paging**: Supports traditional page up/down (rollup/rolldown), with relative subfile record number tracking.
- **Multi-level Keying**: All database accesses (CHAIN, SETLL, READE) use composite keys, reflecting the program's complex data relationships.
- **Commenting and Versioning**: The code is thoroughly commented and maintains a change log with version numbers and brief notes.
- **Conditional Compilation & Language**: Some code is commented (e.g., handling for "enhet"/unit) — these are likely temporarily disabled features or alternative flows per client/version.
- **Norwegian Naming**: Variable and comment names use Norwegian business terms (e.g. "vare" = item, "gruppe" = group, "leverandør" = supplier, "levertype" = delivery type).

## 8. **Typical Maintainer Tasks**

- **Adding a New Bonus Element**: Fill out the key fields, validate, and save via the create screen.
- **Editing/Viewing a Bonus Element**: Select from the subfile, enter edit/view, make changes, validate and update.
- **Copying an Element**: Select 'copy', specify the source and target, and confirm.
- **Deleting an Element**: Select 'delete', confirm in the pop-up, and the record and any related details are removed.
- **Searching/Filtering**: Position subfile at a desired group/module/item via search fields.
- **Field Assistance**: Use inquiry (F4/spørring) lookups for valid values on key fields.

## 9. **Key Files and Relationships**

- **embhi1, embeir, embeiu, embdiu, etc.**: Main files for bonus element templates, element headers, element details, and update processes.
- **fra11l1, fvogrl1, fvvarl1...**: Files for supplementary information (group, item, supplier lookups).
- **Display File (em102d)**: Designs multiple record formats for subfile behavior and data entry screens.

## 10. **Best Practices and Observations**

- The code uses a standard subfile pattern, which is well-established on IBM i.
- Use of indicators and explicit subroutine structure makes the code highly maintainable, readable, and testable.
- The program expects all referenced inquiry programs (VG510R, RL500R, VV500R, etc.) to be present and functioning.
- Extensive commenting helps with onboarding and future maintenance.

---

## **In Summary**
This program is a full-featured, modular, and well-structured RPG application for maintaining bonus element templates, using subfiles for usability, and supporting complex keying and lookup/inquiry for reference data. The program is a good example of classic IBM i (AS/400) RPG/subfile application design, blending business rules, user interface, and robust data management.