# MP100R – RPG Source Code Explanation & Onboarding Guide

---

## 1. **Program Purpose and Context**

This RPG program, named **MP100R**, is part of a system called **ASLOGI**. Its primary function is to handle **parameter maintenance by supplier** (leverandør) for **order proposal generation**. The program contains a user interface (via subfiles) for viewing, adding, updating, copying, and deleting ordering parameters per supplier.

The code is written in classic IBM ILE RPG IV (mostly in fixed format, some in /FREE), and is heavily tailored for a Norwegian business domain (terms like "lev.", "lager", "selger" etc. stand for supplier, warehouse, seller).

---

## 2. **File Declarations**

### Disk Files

- **mppal1, mppal2, mppal3, mppal4, mppalr, mppalu**: Different logical views over the same physical file (`mppapfr`), used for different key accesses (by supplier, description, seller, etc.).
- **ausrl1**: User register (`ausrpfr`).
- **ra09l1**: Seller register (`ra09pfr`).
- **lstsl1, fstsl1**: Warehouse/order status codes.
- **xtillu**: Additional fields, e.g., start time for processes.
- **sloglu**: System log for deletion events.

### Display File

- **mp100d**: Main workstation display file, containing subfiles (with subfile key fields, indicators, and file feedback structure).

---

## 3. **Data Structures and Variables**

- **Local Data Area (LDA)**: Used for sharing user, firm number, navigation info between programs and sessions.
- **Display Feedback Structure**: For feedback from display file operations.
- **Key Variables**: Used to set or chain to records using different keys for different logical files.
- **Working Variables**: For subfile record numbers, subfile paging, operation indicators, and work fields for data passing/validation.
- **Constants**: e.g., `c_sfil = 14` defines subfile page size.

---

## 4. **Indicator Usage**

Indicators (`*INnn` or `*INLR`) are heavily used:
- **LR**: End of program.
- **10/11**: Rollup/Rolldown.
- **12-15, 21-22, 30-99**: Field protection, error display, work indicators.

---

## 5. **Main Flow and User Interface**

### Subfile Concept

The program uses a subfile (B1SFL) to display a list of parameters associated with suppliers, allowing paging, selection, and operations:

- **B2CTL**: Subfile control record.
- **B2CMD**: Command key panel.
- **C1BLD/C1MSG/C2BLD**: Popups for creating/maintaining records.
- **D1WIN, K1WIN**: Popups for delete/copy functionality.
- **C3WIN, C4WIN**: Additional data entry popups (pattern, notification).

### Main Loop

1. **Display or process subfile (DSP_SUBFILE, SUBFILE):**
   - Shows the list of supplier parameters.
   - Handles user F-key input for paging, add, change, delete, copy, view, filter, etc.
2. **Operation Handling:**
   - `F3/F12`: Exit.
   - `F5`: Refresh.
   - `F6`: Add new row.
   - `F7`: Copy.
   - `F8`: View details.
   - Actions (change/copy/delete/view) are dispatched to subroutines with appropriate popups.
3. **Filtering/Positioning**
   - The user can search/filter by supplier number, seller, warehouse, or description.

---

## 6. **Major Subroutines**

### 6.1. **forny** (Refresh Subfile)
- Refreshes the content of the subfile based on current position and sequence (search filter).

### 6.2. **posisjoner** (Subfile Positioning)
- Positions the underlying file based on filter/search fields.
- Calls forny to update the subfile.

### 6.3. **subfile** (Subfile Processing)
- Reads selected entries from subfile with `readc`.
- For each entry: If marked for change/copy/delete/view, invokes the corresponding popup subroutine.
- Handles changes in status and refreshes the content if necessary.

### 6.4. **xc1bld** (Add New Row)
- Handles the 'add' popup.
- Validates new entries, checks for duplicate keys, and calls the maintenance subroutine on acceptance.

### 6.5. **xc1msg** (Duplicate Row Message)
- Handles the message popup if a user tries to add a row that already exists.

### 6.6. **xc2bld** (Edit/View Row)
- Handles the main edit/view popup.
- Loads data if it exists or initializes new data otherwise.
- Performs exhaustive field validation (seller, product manager, warehouse, ranges, etc.).
- Facilitates updating or writing new entries.

### 6.7. **xc3win/xc4win** (Pattern/Notification Windows)
- Handles specialized popups for recurring patterns and notification settings.

### 6.8. **xd1win** (Delete Row)
- Handles delete confirmation and removes the entry from the parameter file.
- **Also logs the deletion event to `SLOGPF`** for auditing.

### 6.9. **xk1win** (Copy Row)
- Handles the copy popup. Validates key uniqueness and invokes the edit popup as needed.

### 6.10. **clr_subfile, crt_subfile, bck_subfile**
- Clear the subfile, fill new page, or move backwards in the subfile, respectively.

### 6.11. **dsp_subfile**
- Displays the main subfile screen.

### 6.12. **spørring** (Inquiry/Field Lookup)
- Handles calls to separate lookup programs to retrieve valid values for fields (supplier, seller, warehouse, groups, etc.).
- Sets the field value and name after user selection.

### 6.13. **finn_num** (Find Next Running Number)
- Helper to determine the next available running number/ID for a supplier.

### 6.14. **newlo_vask** (Newlook Data Clean)
- Cleans up display fields to remove problematic characters for Newlook GUI compatibility (e.g., removes trailing '.' or ':').

### 6.15. **xh1win** (Filter Options Window)
- Handles filter option popup.

### 6.16. **Initialization (`*INZSR`)**
- Sets up all key lists (`KLIST`s) used for chained access to logical files.
- Reads in initial company information and status codes for screen setup.
- Positions to the initial start of the parameter file.
- Loads the first page of the subfile.

---

## 7. **Audit Logging**

- On deletion, the program logs the event to the `SLOGPF` file, including company, region, user, timestamps, and the before/after values.

---

## 8. **Version Notes**

- The source is maintained with detailed version history for each enhancement (see comments at the top).
- New fields, logic, or file accesses are marked with version comments (e.g., `7.05`, `6.20`, etc.).
- GUI compatibility is specifically handled with data cleansing logic.

---

## 9. **Technical Notes and Best Practices**

- **Subfile Paging:** Implemented manually via page size constant and record number tracking.
- **Chaining and Key Lists:** Relies heavily on RPG's `CHAIN`, `SETLL`, `READx` operations for indexed access and filtering.
- **Field Validation:** All user input is validated, and helper programs are called to ensure referential integrity.
- **Separation of Concerns:** Each screen or function (add, edit, copy, delete, filter, etc.) has its own subroutine.

---

## 10. **Onboarding Checklist**

If you are new to this code, ensure you:

- Understand the business flow: parameters per supplier for order proposals.
- Familiarize yourself with the subfile concept in RPG.
- Study how indicator fields and key lists are used for workflow control.
- Investigate the logical files (`mppal1`…`mppalu`) to understand their key structure and relevant fields.
- Note the external programs called for field validation/lookups.
- Pay attention to how audit logging is performed.
- For GUI issues, see the `newlo_vask` routine and its text sanitization logic.
- Use the version comments to see what has changed and why, especially when debugging or modifying domain logic.

---

## 11. **Domain Vocabulary**

- **Leverandør (lev):** Supplier
- **Lager:** Warehouse
- **Selger:** Seller
- **Bestillingsforslag:** Order proposal
- **Produktansvarlig:** Product Manager
- **Gruppe:** Group (overgruppe/hovedgruppe/undergruppe)
- **Beskrivelse:** Description

---

## 12. **Summary of Main User Interactions**

- **Browse** supplier parameters in a paged list.
- **Filter** by supplier, seller, warehouse, description.
- **Add, Edit, Copy, Delete, View** parameters, each with confirmation/validation.
- **Audit** of deletions.
- **Lookups** for code-to-name translation.
- **GUI cleaning** for better frontend compatibility.

---

### For new developers, this program is a classic RPG application marrying green-screen database maintenance with modern file and business logic handling, supporting extensibility and auditability for robust supplier parameter management tied to order proposals. 

---