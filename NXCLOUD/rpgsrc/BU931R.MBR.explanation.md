## Program BU931R â€“ Price and Discount Calculation for Retail Units

### Overview

**BU931R** is a core pricing module in the ASSHOP system, responsible for calculating and returning sales price, discounts, and purchase price for a given item/unit combination. It extends the logic of earlier programs (BU927R/BU931R), with support for price groups and club membership, and is tailored for scenarios where the NGN system requires direct access to purchase price calculations.

The program is invoked as a subprocedure or called program, receives a comprehensive parameter list, and returns calculated pricing data, including error/status indicators. It interacts with multiple files and external programs to resolve item, unit, customer, and price group data.

---

### High-Level Flow

1. **Initialization**: Handles parameter unpacking and sets up keys and working variables.
2. **Validation**: Ensures the item and item/unit combination exist.
3. **Customer Lookup**: Retrieves customer discount category if available.
4. **Pricing Call (VP900R)**: Calls the pricing engine to obtain base prices, discounts, and group information.
5. **Net Price Calculation**: Applies multiple discount types to compute the net price.
6. **Purchase Price Lookup (VP754R)**: Retrieves the purchase price for the item/unit/price group.
7. **Result Assignment**: Returns all calculated and looked-up values via the parameter list.

---

### Key Data Structures and Files

#### Files

- **rkunpfr (rkunl1)**: Customer master file, for fetching customer discount category.
- **vvarpfr (vvarl1)**: Item master file, to check item existence.
- **vvenpfr (vvenl1)**: Item/unit master file, to check if the item/unit combination is valid.

#### Data Structures

- **hirec/horec**: Parameter buffers for calls to the pricing engine (VP900R), with overlays for structured access to fields.
- **Work variables**: For firm, department, item type, price group, and intermediate calculation results.

---

### Parameter List

#### Input Parameters

- **p_firm**: Company code.
- **p_kund**: Customer number.
- **p_kpro**: Customer project.
- **p_vare**: Item number.
- **p_enhe**: Unit of measure.
- **p_lety**: Delivery type.
- **p_lagr**: Warehouse/location.
- **p_dato**: Price date.
- **p_klub**: Customer club membership (since version 6.32).

#### Output Parameters

- **p_sapr**: Base sales price.
- **p_rab1/p_rab2**: Discount 1 and 2.
- **p_brr1/p_brr2**: Usage right discounts 1 and 2.
- **p_kpri**: Price code.
- **p_kamp**: Campaign code.
- **p_netp**: Net price (after all discounts).
- **p_kopr**: Cost price.
- **p_inkp**: Purchase price (since 8.xx).
- **p_prgr**: Price group (since 8.01, expanded to 2 chars in 8.02).
- **p_stat**: Status indicator (error codes for item/unit existence).

---

### Detailed Logic

#### Initialization (`*inzsr`)

- **Parameter unpacking**: Standard RPG `*entry` parameter list.
- **Key setup**: Prepares key lists for customer, item, and item/unit lookups using company and relevant fields.
- **Price group fetch**: Calls `VL712R` to obtain price group for the warehouse.
- **Item type fetch**: Calls `BL710R` to determine item type and supplier (important for lumber assortment logic).
- **Date validation**: Ensures the price date is valid, defaults to system date if not.

#### Main Logic

##### 1. Item Existence Check

- Looks up the item in `vvarl1`.  
- If not found, sets `p_stat = 1` and exits.

##### 2. Item/Unit Combination Check

- Looks up the item/unit in `vvenl1`.  
- If not found, sets `p_stat = 2` and exits.

##### 3. Customer Discount Category

- Looks up the customer in `rkunl1`.  
- If not found, sets discount category to 0.

##### 4. Prepare Pricing Call

- Populates the `hirec` data structure with all relevant parameters, including company, item, unit, customer, price group, and club membership.
- Calls external program `VP900R` to perform the detailed price calculation.

##### 5. Retrieve Pricing Results

- Extracts output parameters from `horec` (sales price, discounts, price group, etc.) and assigns them to the output parameter fields.

##### 6. Net Price Calculation

- Applies up to four discounts (2 standard, 2 usage right) *sequentially and cumulatively* to the sales price:
    - Each discount is applied to the remaining (not yet discounted) portion of the price.
    - The cumulative discount is subtracted from the sales price to yield the net price (`p_netp`).

##### 7. Purchase Price Lookup

- Calls external program `VP754R` to fetch the purchase price for the item/unit/price group.
- If a purchase price is found, assigns to `p_inkp`; otherwise, falls back to the cost price (`p_kopr`).

##### 8. Exit

- Returns to caller, with all output parameters populated.

---

### Error Handling and Status Codes

- **p_stat = 1**: Item does not exist.
- **p_stat = 2**: Item/unit combination does not exist.
- **p_stat = 0**: Success.

---

### External Program Dependencies

- **VP900R**: Central pricing engine, returns base price, discounts, and price group.
- **VP754R**: Purchase price lookup for item/unit/price group.
- **VL712R**: Determines price group for a warehouse.
- **BL710R**: Determines item type and supplier, especially for lumber assortment logic.

---

### Domain/Business-Specific Notes

- **Price group logic**: Extended from 1 to 2 characters (8.02) to support more granular pricing.
- **Customer club**: Additional logic and parameters for customer club membership, affecting pricing.
- **Lumber assortment**: Special handling for item type and supplier, using `BL710R`.
- **Discount application order**: Discounts are applied sequentially and cumulatively, which is critical for correct net price calculation.
- **Purchase price for NGN**: The program was specifically extended to provide purchase price directly for the NGN system, reducing the need for external logic.

---

### Notable Conventions / Patterns

- **Overlayed data structures**: Used for parameter passing to and from external programs.
- **Version tagging**: Comments and code are clearly marked with version numbers and change descriptions.
- **Error-first exit**: Early validation of item/unit existence, with immediate exit and status setting on failure.
- **Separation of concerns**: Lookup, calculation, and external program calls are clearly separated.

---

### Relationships to Other Modules

- **Pricing and cost logic is centralized** in `VP900R` and `VP754R`.
- **Warehouse and item master data** are accessed via `vvarl1` and `vvenl1`.
- **Customer master data** is accessed via `rkunl1`.
- **Price group determination** is delegated to `VL712R`.
- **Item type/supplier logic** is handled by `BL710R`, especially for domain-specific requirements like lumber.

---

### Summary

This program is a robust, extensible pricing routine that acts as the central point for price, discount, and purchase price calculation in the retail domain, with strong support for business-specific features like price groups, club membership, and special assortment handling. It is designed for integration with other systems (notably NGN) and is structured for maintainability, with clear separation of logic and strong version/change documentation.