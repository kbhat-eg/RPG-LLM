# RPG Program EK142R: Customer Bonus Calculation and Update

## Overview

This program calculates and updates customer bonuses based on sales statistics and the customer's bonus agreements. It systematically processes sales data, applies bonus rules at various hierarchy levels, and updates both bonus registers and sales statistics. The program is designed to handle complex bonus structures, including overlapping and multi-level agreements, and supports a wide variety of matching rules for bonus eligibility.

**Key business domain concepts:**
- **Bonus agreements** can be defined at multiple levels (customer, project, product groups, etc.).
- **Bonus calculation** can be performed on totals or per element, with possible reductions (e.g., for freight).
- **Sales statistics** are updated with the calculated bonus share for each sale.
- **The program supports a complex matching hierarchy** for determining which bonus agreement applies to a given sale.

## File Relationships

The program interacts with several physical and logical files, each representing different business entities:

- **ekbost/ekboi1, ekboic, ekboiur**: Customer bonus master and detail records.
- **ekbest/ekbeiur, ekbei2r**: Customer bonus elements.
- **ekbtst/ekbtiur, ekbtirr**: Bonus type totals.
- **ekbsst/ekbsirr**: Bonus type side register (used for total-based calculation).
- **rkunpfr/rkunl1r**: Customer master data.
- **vvarpfr/vvarl1r, vvaspfr/vvasl1r**: Item master and deleted items.
- **vbotpfr/vbotl1r**: Bonus type master.
- **sstapfr/sstalkr, sstalur**: Sales statistics (main and update).
- **ebkspfr/ebkslur**: Side register for invoice basis (used if enabled).

## Program Flow

### 1. Initialization

- Receives parameters: company, bonus customer, period from/to, bonus type, and *INLR flag.
- Sets up local variables and key lists for file access.

### 2. Customer Data Retrieval

- Loads customer data from the customer master file (rkunl1).

### 3. Reset Bonus Registers

- For the selected customer and bonus type, resets bonus basis and calculated bonus in all relevant bonus registers (master, elements, and total per type).
- If any bonus is defined at the customer or discount category level, sets a flag (`b_hele`) to force full sales statistics scan.

### 4. Calculate Bonus Basis

- Calls subroutine `bonusgrunnlag` to sum up sales eligible for bonus, per agreement level and bonus type.
- Handles overlapping bonus agreements by using an array to track which bonus types have already been considered for a given sale.

### 5. Calculate Bonus

- Calls subroutine `bonus` to calculate the bonus amount for each eligible bonus element.
- Handles tiered bonuses, percentage bonuses, and checks for "building" elements (which should not be included in the calculation).
- Updates bonus totals per bonus type and applies reductions if specified.

### 6. Update Sales Statistics

- Calls subroutine `statistikk` to update each sales record with the calculated bonus share.
- The bonus share is distributed proportionally based on the sales amount's contribution to the bonus basis.

### 7. (Optional) Update Invoice Basis

- If enabled, calls subroutine `faktura_grl` to update a side register with the calculated bonus for later use in invoicing.

### 8. Program End

- Closes files and returns, setting *INLR if requested.

---

## Main Subroutines and Logic

### `bonusgrunnlag` (Calculate Bonus Basis)

- Iterates through sales statistics for the customer and period.
- For each sale, determines applicable bonus agreements using the `bonusniv책` subroutine.
- Sums the sales amount (after discounts) into the appropriate bonus basis field for each matching agreement.

### `bonus` (Calculate Bonus Amount)

- For each bonus agreement with a non-zero basis, calculates the bonus amount based on the agreement's rules (tiers, percentages, limits).
- Updates the bonus element and accumulates the total bonus per type.
- Updates the bonus type register with the new totals.

- Handles both element-level and total-level bonuses:
  - If the bonus type is set to be calculated on totals, calls `sr_kbonus`.
  - If reduction is specified for the bonus type, calls `sr_breduk`.
  - Otherwise, sums up element-level bonuses with `sr_belem`.

### `statistikk` (Update Sales Statistics)

- For each sale, determines which bonus agreements apply.
- Distributes the calculated bonus proportionally to the sale's contribution to the bonus basis.
- Updates the sales statistics file with the bonus share.

### `bonusniv책` (Determine Bonus Level)

- Implements a complex matching hierarchy to determine which bonus agreement(s) apply to a sale.
- The hierarchy covers over 160 different combinations of agreement levels (customer, project, product group, item, etc.).
- For each combination, attempts to find a matching bonus agreement in the master file.
- Uses an array to track which bonus types have already been applied to avoid double-counting.

### `sr_kbonus` (Total-Based Bonus Calculation)

- Calculates the bonus for a type based on total sales, rather than per element.
- Handles tiered bonuses and updates the bonus type register accordingly.

### `sr_breduk` (Bonus Reduction)

- Reduces the calculated bonus by a specified percentage (e.g., to account for freight or other costs).
- Updates the bonus type register.

### `sr_belem` (Sum Element Bonuses)

- Sums the calculated bonuses for all elements of a bonus type.
- Updates the bonus type register with the total element bonus.

### `faktura_grl` (Update Invoice Basis, optional)

- Writes the calculated bonus and basis to a side register for later use in invoicing.
- Handles insert or update logic depending on record existence.

---

## Notable Design Decisions and Patterns

- **Matching Hierarchy:** The core of the system is the matching hierarchy in `bonusniv책`, which supports a highly granular and flexible bonus agreement structure. This is implemented using a combination of key construction and iterative file reads.
- **Array Tracking:** The use of an array (`a_boty`) to track which bonus types have been applied to a sale prevents double-counting and supports the exclusion of overlapping agreements.
- **Building Elements:** Certain bonus elements marked as "building" (`ekebyg = 1`) are explicitly excluded from bonus calculation and updating logic.
- **Date Interval Handling:** The logic checks for overlapping date intervals to determine bonus eligibility, but does not support multiple overlapping intervals for the same agreement (by design).
- **Parameterization:** The program is highly parameterized, supporting batch calculation for any customer, period, and bonus type.
- **Side Register for Invoicing:** Optionally, the calculated bonus can be written to a dedicated file for later use in invoice generation, decoupling bonus calculation from invoicing logic.

---

## File and Key Conventions

- **Key lists** (`klist`) are used extensively for file access, supporting both full and partial key matches depending on the context.
- **Prefixing:** Prefixes are used for certain files to avoid field name collisions.
- **Update/Write Logic:** The program generally uses `chain` and `update` for existing records, and `write` for new ones, following standard RPG file handling conventions.

---

## Integration Points

- **Sales statistics** are both read and updated, ensuring that bonus calculation is reflected in reporting and downstream processes.
- **Bonus agreements** are maintained in dedicated files, which can be updated externally (e.g., by a maintenance application).
- **Customer master** is accessed for validation and to obtain relevant customer data for matching.

---

## Special Notes

- **No General Discount:** The program explicitly does not take general discounts into account for bonus calculation, as those fields are used for mark-up invoicing in another system.
- **Extensible Matching:** The matching logic is designed to be easily extensible for new agreement levels or business rules.
- **Side Register (EBKSLU):** The side register logic is only enabled if the corresponding sections are uncommented (as indicated by the `x.xx` markers).

---

## Summary Table: Main Data Flows

| Step                   | Input Files         | Output Files          | Purpose                                               |
|------------------------|--------------------|-----------------------|-------------------------------------------------------|
| Initialization         | Parameters         | Variables             | Set up program context                                |
| Customer Data Load     | rkunl1             |                       | Load customer master data                             |
| Reset Registers        | ekboiur, ekbeiur, ekbtiur |          | Clear previous bonus data                             |
| Calculate Bonus Basis  | sstalk, ekboi1     | ekboiur               | Sum sales per agreement and bonus type                |
| Calculate Bonus        | ekboiur, ekbei2r   | ekbei2r, ekbtiur      | Calculate and store bonus per element/type            |
| Update Statistics      | sstalur            | sstalur               | Write bonus share to sales statistics                 |
| (Optional) Invoice Basis |                   | ebkslur               | Store bonus for use in invoicing                      |

---

## Conclusion

This program forms the backbone of the customer bonus calculation process. Its design reflects the need for flexibility in agreement definition, accuracy in bonus calculation, and traceability in both sales and bonus registers. The matching and calculation logic is intricate, supporting a wide range of real-world business scenarios and ensuring that bonuses are correctly applied and recorded for each customer and sale.

For onboarding, it is critical to understand:
- The matching hierarchy and its impact on bonus eligibility.
- The relationship between bonus basis, bonus calculation, and statistics update.
- The file structure and key conventions, as these underpin all data access in the program.

If you have questions about any specific section or wish to see the matching hierarchy in more detail, please refer to the extensive comments in the `bonusniv책` subroutine.