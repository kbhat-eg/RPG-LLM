# Explanation of ASOFAK Subprogram (ILE RPG)

## Overview

This ILE RPG program (`FA910R`, system name `ASOFAK`) is a subprogram designed for **rounding monetary values** (Norsk: avrunding) according to a set of company-specific parameters and rules. The program is called with a code indicating which kind of price to round (e.g., purchase, sales, etc.), the company and item IDs, and the amount to round.

It uses system tables to look up rounding rules and applies different modes for rounding (nearest/upwards) based on configuration. Additionally, it can release resources and close files quickly using the `INLR` indicator for performance.

---

## Data Definitions and Files

### Files

- **fstsl1** – Status register (keyed disk file)
- **vvarl1** – Item master (keyed disk file)
- **vugrl1** – Item group master (keyed disk file)

Each file is renamed for record format specificity.

### Parameters

- `p_firm` — Company number (like `vvfirm`)
- `p_vare` — Item number (like `vvvare`)
- `p_kode` — Input code (1: Purchase, 2: Cost, 3: Sales excl. VAT, 4: Sales incl. VAT)
- `p_bel1` — Input/output amount to be rounded (11,2)
- `p_inlr` — Controls end-of-program logic and file closure, introduced in version 8.01

### Working Variables

- `w_Ører` — Decimal (fractional) part of amount
- `w_avru` — Integer (rounded down) part of amount
- `w_sist` — Last digit(s) of amount (for rounding logic)
- `w_spny` — Working rounded amount
- `w_firm`, `w_avrk` — Company, rounding code from status registers

And variables for resolving group hierarchy keys for item lookup.

---

## Main Logic Flow

### 1. **Quick File Closure Check**

If `p_inlr = *on`, immediately end program, possibly for cleanup or batch closing (`goto avslutt`).

### 2. **Exit on Zero Amount**

If the amount to round (`p_bel1`) is zero, exit immediately.

### 3. **Lookup Status Register**

Fetches the company status record (`fstsl1_key`), exits ("avslutt") if not found.

### 4. **Validate Rounding Code**

Check if `p_kode` is between 1 and 4; if not, exit.

### 5. **Set Rounding Parameter**

Depending on `p_kode`:
- 1: Use purchase price rule (`faaink`)
- 2: Use cost price rule (`faakos`)
- 3: Use sales excl. VAT rule (`faaemv`)
- 4: Use sales incl. VAT rule (`faaimv`)

If the chosen code's rounding parameter (e.g., `faaink`) is zero, exit.

### 6. **Check If Item Is Exempt from Rounding**

- Looks up item (`vvarl1_key`) and then item group (`vugrl1_key`).
- If group indicates "do not round" (`vguavr = 1`), exit.

### 7. **Split Amount into Integer and Fractional Parts**

- `w_spny` ← Input amount for working
- `w_avru` ← Integer part (truncated)
- `w_Ører` ← Fractional part (`w_spny - w_avru`)
- `w_sist` ← Extract last digit/decimals (for business rounding rules)

### 8. **Rounding Logic Based on Amount Intervals**

#### The status record provides thresholds and rounding increments:

- `faagr0` – Minimum threshold (no rounding)
- `faagr1`, `faagr2`, `faagr3`, `faagr4` – Increasing thresholds
- `faabl1` to `faabl5` – Rounding increments (e.g., 0.05, 0.10, 0.50, 1.00, 10.00)

For each interval, there's logic to round either to:
- the nearest value (NÆRMESTE) when `w_avrk = 1`
- or upwards (OPPOVER) otherwise

**The program applies this logic in order:**
- Amount < `faagr0`: No rounding.
- Amount < `faagr1`: Round to nearest/up to 0.05.
- Amount < `faagr2`: Round to nearest/up to 0.10.
- Amount < `faagr3`: Round to nearest/up to 0.50.
- Amount < `faagr4`: Round to nearest/up to 1.00.
- Amount ≥ `faagr4`: Round to nearest/up to 10.00.

Each interval includes logic for determining if the decimals push the value up or keep it down, using MOVE and EVAL operations.

### 9. **Output**

The working variable `w_spny` holds the rounded value, written back to the parameter `p_bel1` for output.

### 10. **Program Termination**

- If called with `p_inlr = *on`, sets LR indicator (`*INLR = *on`) to close files and free resources.
- The program then returns.

---

## Initialization Routine (`*inzsr`)

- Reads in parameters from the *entry parameter list (`plist`).
- Sets up key lists for file lookups.
- Moves the company parameter (`p_firm`) into the working variable `w_firm`.

---

## Summary

### What does this program do?

- **Receives a monetary amount and context (company, item, rule type), and rounds the amount according to detailed rules stored in system tables.**
- **Rules cover different thresholds and increments (0.05, 0.10, etc.), and can be set to "round up" or "to nearest".**
- **Can skip rounding for certain items/groups.**
- **Runs efficiently for batch by using the INLR parameter for file closure.**

---

## Key Points for New Developers

- **Rounding rules are table-driven** (maintained in files, not hardcoded).
- **Different prices (purchase, cost, sales with/without VAT) may have different rounding behavior**.
- **Exemptions are possible at the item group level.**
- **Understand the file structure and the meaning of each field in the status and group registers.**
- **This is classic RPG; logic could be more readable/modernized but is typical for legacy finance systems.**
- **Test with various values and rules to fully understand the effect.**

---

**Tip:** 
To onboard, pay particular attention to the structure of the status/group/item files and the values in the rounding fields (`faaink`, `faakos`, etc.), as these drive the core logic.