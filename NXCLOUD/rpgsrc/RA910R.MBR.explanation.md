# Program RA910R: Region and Warehouse Linkage Maintenance

## Overview

This program, `RA910R`, is part of the ASOKON system and is used for the maintenance of regions and the linkage of regions to warehouses. It is a specialized version for the "Mestergruppen" client and includes both CRUD operations for regions and the ability to associate (link) warehouses to regions.

The program uses display files with subfile support for interactive maintenance. It is designed for interactive usage, allowing users to add, update, delete, and browse regions and their warehouse links.

### Key Business Concepts

- **Region**: A logical grouping, typically for sales or logistics purposes.
- **Warehouse (Lager)**: A physical or logical storage location.
- **Region-Warehouse Link**: Associates a warehouse with a region, possibly for fulfillment or reporting.
- **Kjedekode**: A chain code, relevant for e-commerce integration (Ehandel).

## File Usage and Relationships

- **Physical Files**
  - `ra91pfr`: Stores regions and region-warehouse link records.
  - `ra10pfr`: Stores warehouse master data.
- **Display File**
  - `ra910d`: Contains subfile and control formats for interactive display.

## Data Structures and Variables

### Key Data Structures

- **ra91l1**, **ra91lr**, **ra91lu**: Logical views over `ra91pfr` for different access patterns (listing, reading, updating).
- **ra10lr**: Logical view over `ra10pfr` for warehouse lookup.

### Local Data Area (LDA)

- Used to retrieve session/user context like `l_user`, `l_firm` (company), and `l_fnav` (user name).

### Key Variables

- **b_oppr**: Indicates create (opprett) mode.
- **b_vedl**: Indicates edit (vedlikehold) mode.
- **b_forn**: Indicates refresh is needed.
- **b_anul**: Used for cancellation logic.
- **b_feil**: Error indicator.
- **w_firm**: Current company number.
- **w_srrn, w_ssrn, w_sfrn, w_spge**: Subfile row and paging management.

## Indicator Usage

- **LR**: End program.
- **10/11**: Paging (Rollup/Rolldown).
- **12/13/14/15**: Subfile display/clear/end.
- **21/22**: Cursor/home positioning.
- **30/40**: Field protection.
- **31-79**: Error/warning indicators.
- **80-99**: Work indicators.

## Main Program Flow

### Initialization (`*inzsr`)

- Loads company info from LDA.
- Sets up keys for file access.
- Initializes subfile by loading the list of regions and their links.

### Main Loop

- Presents the main command screen (`b2cmd`).
- Displays the subfile with regions and their warehouse links.
- Processes function keys for actions like create, edit, delete, paging, and refresh.

### Subfile Handling

- **Display (`dsp_subfile`)**: Shows the list of regions and their links.
- **Create (`crt_subfile`)**: Loads more records into the subfile for paging.
- **Back (`bck_subfile`)**: Pages backward in the subfile.
- **Clear (`clr_subfile`)**: Clears the subfile for repopulation.

### Region Maintenance

- **Create/Edit (`xc1bld`)**: Handles both creation and updating of region records. Checks for duplicate regions before creation.
- **Duplicate Region Message (`xc1msg`)**: Notifies the user if the region already exists.

### Region-Warehouse Link Maintenance

- **Create/Edit Link (`xc2bld`)**: Handles creation or update of a region-warehouse link. Validates warehouse existence and chain code (`kjedekode`). Calls out to another program (`RA510R`) for warehouse lookup if needed.
- **Duplicate Link Message (`xc2msg`)**: Notifies the user if the link already exists.
- **Missing Chain Code Message (`xc3msg`)**: Notifies if the chain code is missing or invalid (must be 'XL' or 'BT').

### Deletion

- **Delete Region (`xd1win`)**: Deletes a region and all its links.
- **Delete Link (`xd2win`)**: Deletes a specific region-warehouse link.

## Notable Design Decisions and Conventions

- **Subfile Paging**: The subfile is paged in fixed-size chunks (`c_sfil = 14`). Paging is handled manually with counters for current row, start/end row, and page.
- **File Access via Key Lists**: Key lists (`klist`) are used for multi-field keyed access to logical files.
- **Indicator-Driven UI**: Heavy use of indicators for display file field protection, error highlighting, and user interaction.
- **Separation of Region and Link**: Regions (where `rrlage = 0`) and region-warehouse links (where `rrlage <> 0`) are stored in the same file but are differentiated by the warehouse field.
- **External Program Call**: For warehouse lookup, the program calls `RA510R`, passing the company, warehouse, and description fields.
- **Chain Code Validation**: From version 7.01, the chain code (`kjedekode`) must be either 'XL' or 'BT' for e-commerce integration, enforced during link creation/edit.

## Module and API Interactions

- **RA510R**: Called for warehouse lookup; returns warehouse number and description.
- **ra91pfr/ra10pfr**: Logical files for all region and warehouse data access.

## Error and Message Handling

- **User Feedback**: All errors (duplicate region/link, invalid warehouse, missing chain code) are handled via modal message screens, requiring user acknowledgement.
- **Field Protection**: Certain fields are protected based on the editing context (e.g., when displaying vs. editing).

## Summary Table: Main Subroutines

| Subroutine      | Purpose                                             |
|-----------------|-----------------------------------------------------|
| `forny`         | Refresh subfile after changes                       |
| `subfile`       | Handles user actions in subfile (edit, link, delete)|
| `xc1bld`        | Create/edit region                                  |
| `xc1msg`        | Duplicate region message                            |
| `xc2bld`        | Create/edit region-warehouse link                   |
| `xc2msg`        | Duplicate link message                              |
| `xc3msg`        | Missing/invalid chain code message                  |
| `xd1win`        | Delete region and all links                         |
| `xd2win`        | Delete region-warehouse link                        |
| `clr_subfile`   | Clear subfile                                       |
| `crt_subfile`   | Populate/load subfile                               |
| `bck_subfile`   | Page subfile backward                               |
| `dsp_subfile`   | Display subfile                                     |

---

## Special Considerations

- **Data Integrity**: When deleting a region, all associated links are also deleted.
- **User Experience**: The program is designed for interactive use with immediate feedback and modal dialogues for errors and confirmations.
- **Localization**: Some comments and variable names are in Norwegian, reflecting the business domain and user base.

---

## Summary

RA910R is a robust interactive application for maintaining regions and their warehouse links, supporting paging, validation, and integration with external modules for warehouse lookup. It enforces business rules such as unique regions, valid warehouse numbers, and mandatory chain codes for certain integrations. The code is structured around subroutines for each logical operation, with clear separation of concerns and a user-driven workflow.