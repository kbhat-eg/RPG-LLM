## High-level Overview

This RPG (Report Program Generator) program is an IBM i (AS/400) ILE RPG source code, written in the fixed format (with some /FREE sections). The main purpose of the program is to provide a display/query utility for customer projects (`kundeprosjekt`) using subfiles for display and navigation. The user can search, position, scroll, and select entries from a subfile. It supports searching/filtering and efficient scrolling of possibly large sets of data.

---

## Sections Breakdown

### 1. Header & Documentation

- The top comments (`*`) give metadata: system, program, description, revision history, and an explanation of indicator usage.
- There’s a clear indicator map (e.g., `*IN10`=Roll/next page, `*IN11`=Roll Down/previous, `LR` = end, etc.)

---

### 2. File Declarations (`F-Specs`)

- **Physical and Logical Files**  
  - `fkpspf`: Main file containing customer project records.
  - `fkprlr`, `fkprl1`, `fkprl2`, `fkprl3`: Logical files over `fkpspf`, each with a different record format for varying key structures (for searching by project, name, etc.).
  - `rkunl1`: Customer name/address file.
- **Display File**  
  - `fl500d`: Workstation device file for the display interface, with the subfile defined (`sfile(b1sfl:w_srrn)`). The `infds` keyword maps the display feedback data structure.

---

### 3. Data Declarations (`D-Specs`)

- **Parameters** (for input/output to the program):
  - `p_firm`, `p_kund`, `p_kpro`, `p_knav`, `p_navn`
- **Feedback Data Structures**:
  - `dspfbk`: Holds feedback from display for cursor positioning, etc.
- **Work Variables**:  
  - Subfile paging/positioning: `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, etc.
  - Sequence variables: `w_seqe`, determines the current search or display mode.
  - Various text fields for search parsing: `w_ste1-5`.
- **Constants**:
  - `c_sfil`: Subfile page size (8).
- **Subfile Field Explanations**: Extensive comments explain what each subfile-related field does.

---

### 4. Mainline Logic and Processing

#### Initialization

- The `*inzsr` subroutine retrieves parameters, initializes the workspace, positions the relevant logical file according to the customer number, and pre-loads the subfile for display.

#### Main Display Loop

- `b2taga` and `b2tagb` are named tags marking key points in the interactive loop.
- The main loop:
  - Writes the main screen (`b2cmd`).
  - Calls routines to display/refresh the subfile (`dsp_subfile`), handle function keys, search, reposition, and select entries.
- **Function Keys/Indicators Handling**:  
  - Handles roll, roll-down, search, go-to-home, re-search, and selection logic. Most user actions result in control flow between tags or subroutines.
- **Search, Position, and Subfile Operations**:  
  - Searching: Calls a separate program `AS700R` for parsing/expanding the search term, clears and recreates the subfile contents according to the search.
  - Positioning: Allows moving directly to a specified customer, project, or name.

#### Subfile Processing Subroutines

1. **forny**: Refreshes subfile according to the current position or mode (search, by project, by name, by customer).
2. **søk**: Handles searching, including calling an external program to process the search term, then rebuilding the subfile with results.
3. **posisjoner**: Positions the logical file and subfile on a given customer/project/name.
4. **subfile**: Handles input from the subfile, checks for row selection, and sets output parameters accordingly.
5. **clr_subfile**: Clears the subfile, resets counters.
6. **crt_subfile**: Fills the subfile with new data, either by reading the appropriate logical file or, if in search mode, by using a SQL cursor (`sok`).
    - Includes logic to avoid duplicates, skip records from other firms, and apply customer filtering.
    - Handles paging, only pulling in the next page (`c_sfil` records).
    - Contains filtering logic for search expansion words (`w_ste2-5`).
7. **bck_subfile**: Scrolls the subfile backward.
8. **dsp_subfile**: Handles the actual display and interactive format of the subfile page, sets up for paging and cursor placement.

#### Data "Washing" for Newlook Compatibility

- **newlo_vask**: A /FREE-format subroutine that removes problematic trailing `.` and `:` characters from names (since "Newlook" – the terminal emulator – misinterprets these).

---

### 5. SQL Usage

- Uses embedded SQL for searching in subfile mode (`w_seqe = 'S'`), including parameter binding and cursor management.
- Sets the SQL environment for date format and sorting.

---

### 6. Entry Parm/Key Lists

- Several KLIST/KFLD constructs define composite keys for file operations, matching the organization of logical files to support fast positioning and searches.

---

## Key Concepts for New Developers

- **Subfile Pattern**: The heart of IBM i interactive programs. This code manages a scrollable list (`subfile`), with robust searching, positioning, and selection logic.
- **Indicators**: Booleans (`*INxx`) control flow and UI state.
- **Display File (DSPF) Coordination**: The RPG program interacts closely with the display file, setting indicators for which record formats to show, when to clear or roll the subfile, and how to place the cursor.
- **SQL/Native IO Duality**: For searching, uses SQL; for direct navigation/scrolling, uses native RPG record-level access via logical files.
- **Legacy Style with Enhancements**: The code is written mostly in fixed-format RPG IV, with some /FREE enhancements as features were added. There are special notes/warnings about GUI compatibility (Newlook quirks).

---

## Onboarding Tips

- **Start at the Initialization (`*inzsr`)** to understand how the program expects to be called and what parameters must be supplied.
- **Study the Subfile Operations** (`crt_subfile`, `clr_subfile`, `bck_subfile`) to see how data is loaded and paged for the user.
- **Note Search/Positioning**: Users can search with text, or jump to a particular customer/project/name.
- **Understand I/O**: All user interaction is mediated through the display file; RPG indicators control what is shown, and file operations (CHAIN, SETLL, READ, etc.) manage the dataset.
- **External Program Calls**: The program dispatches to `AS700R` to "expand" search strings—this is a separate concern.
- **Error/Edge Handling**: There is logic to skip invalid/mismatched records, skip across firms or invalid matches, and to ensure the UI reflects the current state accurately.
- **GUI Compatibility**: See the `/FREE` subroutine cleaning up problematic characters for Newlook GUI support.

---

## Summary

This program is a robust, mature, and commented customer projects inquiry routine for IBM i, using subfiles, RPG indicators, and a mix of SQL and native IO for searching and navigation. It is designed for interactive inquiry, paging, and filtering large datasets, and is adapted for both green-screen and GUI environments.

For maintenance or enhancement, understanding the indicator map, subfile management flows, and the interaction with both logical files and the SQL cursor is key. The comments and structure are thorough, aiding onboarding and further development.