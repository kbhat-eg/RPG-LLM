# Overview

This IBM ILE RPG program (SH410R) is a display program whose purpose is to **view invoice information ("Vise faktura")** in system ASLAGR. The program reads invoice header and detail data from physical files (database tables), displays summaries and lists to the user, and responds to user input for various actions (viewing details, printing copies, generating historical orders, etc.).

The language and comments are largely in Norwegian. The code uses traditional fixed-format RPG IV (RPGLE), and is structured with mainline code and a series of subroutines (begsr/endsr) for modular handling of business logic.

---

## File Declarations

- **sihel1 / rlevl1 / sidtl1 / votyl1**: These are physical files (likely database tables) holding invoice headers, supplier records, invoice details, and order types. They are renamed in the program for clarity (`sihel1r`, `rlevl1r` etc).
- **sh410d**: Display file (workstn), with subfile (sfile) `b1sfl` for displaying invoice lines.

---

## Main Data Structures and Variables

- **Parameter Variables**
    - `p_firm`, `p_aarr`, `p_levr`, `p_binr`: Company, year, supplier, and invoice number passed to the program via *ENTRY parameters.
  
- **Working Variables**
    - Key fields (`w_firm`, `w_aarr`, `w_levr`, `w_binr` etc) and utility counters.
    - Subfile handling variables (`w_srrn`, `w_spge`, etc.) for display paging.
    - Data structure for detail lines (`d_text`, overlays like `d_vare`, `d_tek1`, ...).
  
- **Constants**
    - `c_sfil`: Subfile page size.

---

## Main Logic Flow

**1. Program initialization**
   - *INZSR: Sets up keys, receives parameters, initializes variables.

**2. Control Initialization**
   - `control_init`: Finds the latest invoice header and loads header info and supplier info for current invoice.

**3. Subfile Handling**
   - `crt_subfile`: Reads invoice detail records and populates subfile (`b1sfl`).
   - `clr_subfile`: Clears subfile (for refresh).
   - `dsp_subfile`: Displays subfile page or command screen depending on state.
   - `subfile`: Reads user interactions with subfile, such as selecting detail views (call to SH411R) or viewing order header (call to SH415R).

**4. User Function Handling**
   - Handles function keys (F-keys) for actions like exit, print, refresh, page roll, and historical order generation (via SH300R).

**5. Looping**
   - Main loop repeatedly displays the subfile control screen, waits for user input, and calls the relevant logic for each action.

**6. Exiting**
   - ‘avslutt’: Sets LR (last record) indicator on and returns (program end).

---

## Special Sections/Features

- **Indicator Usage**
    - Extensive use of RPG indicators (*INxx) to control flow, errors, and screen behavior.
    - Indicators are documented in comments.

- **Subfile Paging**
    - Paging variables maintain position, support rolling through multiple pages of invoice details.

- **Validation and Business Rules**
    - Checks for correct supplier, existence of invoice in current/prior/future years.
    - Checks for valid order types when generating historical orders.

- **Dynamic Functionality**
    - Calls external programs for:
        - Printing invoice copy (`LO681R`)
        - Generating order from historical invoice (`SH300R`)
        - Pop-up for valid order types (`VA550R`)
        - Fetching payment terms (`FØ703R`)

- **Support for Expansions**
    - Code comments and variables indicate changes over the years including number expansions and GUI integration.

---

## Key Subroutines

### control_init

- Loads the latest header info for given invoice, with special handling for missing data in current year (searches previous or next year).
- Loads and fills display screen fields for invoice header.
- Loads supplier info if available.
- Calls payment terms retrieval.

### subfile

- Handles subfile record-by-record, processing user actions (show line details, show order header) based on entry fields (`b1valg`).

### crt_subfile

- Reads invoice details and builds display lines for the subfile, formatting values and combining text fields as needed.
- Handles both item lines and free-text lines, formats numbers, calculates discounts.

### dsp_subfile

- Displays subfile page or command screen, depending on subfile content and state.

---

## Key Lists

- **sihel1_key**: Used for reading invoice header (ordernummer).
- **rlevl1_key**: Used for reading supplier master.
- **sidtl1_key**: Used for reading invoice details.
- **votyl1_key**: Used for checking order type when generating orders.

---

## Function Key Actions

- **F3/F12 (exit/cancel)**: Exits the program.
- **F5 (refresh)**: Reloads subfile from disk.
- **F10 (roll/page)**: Loads next subfile page.
- **F15/F20**: Historical order generation and invoice copy print (calls to other programs).
- **Enter/others**: Processes subfile actions.

---

## Error/Status Handling

- *INxx indicators are set for:
    - File not found
    - Error states (e.g. invalid order type)
    - Display field protection

---

## Notable Business Logic

- If invoice is not found for current year, searches previous or next year (controlled by `w_tell` and `w_aar1`).
- Only continues if supplier matches, else program ends.
- Can generate new orders from historical invoices (subject to validation).

---

## Useful References (from comments)

- **LR**: End program
- **Indicators 10-99**: Reserved for special purposes (user input, error flags, file status, subroutines etc.)
- **B1SFL**: Subfile for invoice detail lines
- **B2CTL**: Subfile control record

---

## Summary Table

| Section        | Purpose                                                     |
|----------------|-------------------------------------------------------------|
| File Specs     | Define DB & display files                                   |
| Parameters     | Receive keys to fetch invoice                               |
| Main Flow      | Initialize, load header, build subfile, display, interact   |
| Subroutines    | Modular logic for all steps above                           |
| Error Handling | Uses indicators and screen fields for status                |
| Ext. Programs  | Print, generate order, pop-ups, payment terms               |
| Paging         | Subfile paging/rolling with state variables                 |

---

## Onboarding Notes

- This is a legacy-style RPG program relying on fixed-format RPGLE, display files with subfiles, and uses indicators for control.
- **Main navigation**: Initialization, then an event loop on user input (F-keys or selection fields), calling subroutines or other programs.
- **Custom business logic**: Handles previous/future years if invoice not found, custom rules for order generation.
- **UI**: Display files (`sh410d`) with subfiles; program serves as a controller that navigates the invoice browsing experience.
- **Changing/Extending**: Locate subroutine tied to functionality; follow indicator usage and subfile conventions.

---

### In Short

- This program is a classic RPGLE "inquiry" application for invoices, using subfiles for detail lines and supporting several business actions (view, print, generate order) via external program calls and special keys.
- Key program flow is in subroutines, with startup and user event loop in the main C-specs.
- Heavy use of indicators, overlays, and fixed-format conventions; ideal for those familiar with classic IBM i development.