## Program Overview

This program, `NO881R`, is responsible for creating records in an external order management system based on data from the "Winner" system. It processes temporary order headers and lines from Winner, enriches and transforms the data, and writes the resulting orders and order lines to the external system's files. The program also updates logging information to reflect the operation.

### Business Context

- **Winner System**: Internal system holding order data (headers and lines) to be exported.
- **External Order System**: Receives orders in a specific format, possibly for integration with vendors or logistics.
- **Order Flow**: The program reads temporary order data, maps and possibly enriches it, and writes it to the external system's files. It also updates status/logging fields to indicate processing.

---

## File Definitions

The program uses several physical files (tables), most of which are renamed for clarity:

| File     | Usage         | Description                                                      |
|----------|---------------|------------------------------------------------------------------|
| NOWHIR   | Input         | Temporary order header from Winner (`nowhst` → `nowhirr`)        |
| NOWHIU   | Update        | Updatable order header (`nowhst` → `nowhiur`)                    |
| NOWLI1   | Input         | Temporary order lines from Winner (`nowlst` → `nowli1r`)         |
| NOHELU   | Update        | External order header file (`nohepfr` → `nohelur`)               |
| NODTLU   | Update        | External order lines file (`nodtpfr` → `nodtlur`)                |
| NKEOLR   | Input         | External order code reference (`nkeopfr` → `nkeolrr`)            |
| NOWCIR   | Input         | Catalog/supplier cross-reference (`nowcst` → `nowcirr`)          |

---

## Parameters and Local Data

**Input Parameters** (via *entry plist):

- `p_firm`: Company/firm code.
- `p_lage`: Warehouse code (may be blank).
- `p_avde`: Department code.
- `p_date`: Order date (numeric, 8 digits).
- `p_time`: Order time (numeric, 6 digits).

**Local Data Area**: Used to retrieve workstation/user information.

**Key Variables**: Used to construct keys for file access, based on date, time, firm, codes, etc.

---

## Program Flow

### 1. Initialization (`*inzsr`)

- Parameters are loaded.
- Key fields for all file operations are initialized.
- Date and time parameters are converted to ISO format for use in keys.

### 2. Retrieve External Order Code

- The program sets `w_ekod` to 'WIN' (indicating Winner-originated orders).
- It chains into `NKEOLR` (external order code reference) using the firm and code.
- If not found, the program exits.

### 3. Prepare for Order Creation

- Various work variables are set up for order creation, such as order counter (`w_fell`), type, etc.
- Calls external program `AS100R` to acquire or validate order number and related info.
- If the call fails (non-zero `w_kode`), the program exits.

### 4. Set Up Order Identifiers

- Sets up firm, system, and order number fields for both header and line processing.

### 5. Process Order Header (`les_hode` subroutine)

- Reads the temporary Winner order header (`NOWHIR`).
- If not found, sets a flag and exits the subroutine.
- Maps Winner fields to the external order header format, handling warehouse code conversion, date logic, and field population.
- Writes the new external order header (`NOHELU`).

### 6. Process Order Lines (`les_linjer` subroutine)

- Reads all lines for the order from Winner (`NOWLI1`).
- For each line:
    - Looks up supplier/item info from the catalog (`NOWCIR`).
    - Checks for expired catalog dates and adjusts item code if necessary.
    - Normalizes the unit of measure (upper/lowercase translation, specific code translation).
    - Maps line fields to the external format, increments line number, and writes the line (`NODTLU`).
    - If the line is a text-only line (quantity or price zero, or blank unit), adjusts fields accordingly.
    - If a "hinge" attribute is present (special business logic), writes an additional descriptive line ("Hengslet Venstre/Høyre").

### 7. Update Logging (`oppd_logg` subroutine)

- Updates the processed order header in the Winner system (`NOWHIU`) to indicate it has been processed (sets status, date, and time).

### 8. Program Termination

- Sets LR indicator to on and returns.

---

## Notable Design Decisions & Patterns

- **Separation of Concerns**: Header and line processing are clearly separated into subroutines.
- **Data Mapping**: Extensive mapping from internal Winner fields to external system fields, including data normalization (units, dates, supplier codes).
- **Catalog/Supplier Lookup**: For each line, the catalog is queried to enrich item/supplier data, with fallback logic for expired catalog entries.
- **Business Logic for Text Lines**: Lines without quantity, unit, or price are treated as text lines (comments or instructions).
- **Special Handling for "Hinge" Lines**: Specific logic to write extra text lines when a "hinge" attribute is set, reflecting domain-specific requirements for order documentation.
- **External Program Call**: Uses `AS100R` to obtain or validate order numbers, centralizing order number logic outside this program.
- **Logging/Status Update**: After successful processing, the original Winner header is updated for traceability.

---

## Interactions with Other Modules

- **AS100R**: External program responsible for order number allocation or validation.
- **Catalog/Supplier Files**: Cross-references item numbers and suppliers for enrichment.
- **Winner Temporary Files**: Reads from temporary files written by upstream Winner processes.
- **External Order Files**: Writes headers and lines to files consumed by the external order system.

---

## Key Business/Domain-Specific Logic

- **Order Numbering**: Managed externally and tightly controlled.
- **Order Line Enrichment**: Each line can be linked to catalog/supplier data, ensuring accurate item codes.
- **Text Line and Hinge Handling**: Supports complex order line documentation requirements.
- **Date Handling**: Ensures that delivery dates are not in the past.
- **Status Tracking**: Processed orders are marked as such in the Winner system for auditing and to prevent duplicate processing.

---

## Naming and Conventions

- **Prefixes**: 
    - `no*` for order header-related fields.
    - `nd*` for order line-related fields.
    - `nw*` for Winner source fields.
    - `w_*` for work variables.
    - `p_*` for parameters.
- **File Renaming**: Physical files are renamed to logical names for clarity in code.
- **Subroutines**: Used for logical grouping (`les_hode`, `les_linjer`, `oppd_logg`).

---

## Error Handling

- If required reference data (order code, header) is missing, the program exits gracefully.
- If the external program for order number allocation fails, the program exits.

---

## Summary Table: Main Subroutines

| Subroutine    | Purpose                                            |
|---------------|----------------------------------------------------|
| `les_hode`    | Reads and maps Winner order header to external     |
| `les_linjer`  | Reads and maps Winner order lines to external      |
| `oppd_logg`   | Updates processing status in Winner header         |

---

## Integration Points

- **Upstream**: Winner system populates temporary header/line files.
- **Downstream**: External order system consumes the output files.
- **Side**: Catalog and supplier files provide enrichment data.
- **External Call**: `AS100R` for order number management.

---

## Important Notes for New Developers

- The program assumes all data to be present and valid in the Winner temporary files; missing data is treated as a fatal error.
- All business-specific mappings (field assignments, catalog lookups, text line logic) are hardcoded based on the current external system’s requirements.
- Any changes to the structure of Winner or external files require updates to the mappings in this program.
- The codebase uses Norwegian variable names and comments; familiarity with the business terms is important for maintenance.

---

## References

- **AS100R**: See documentation for order number allocation logic.
- **Winner System**: See upstream process for how temporary files are populated.
- **External Order System**: See downstream process for consumption of `NOHELU` and `NODTLU` files.

---

For further questions on specific mappings or business rules, consult the business analyst or system architect responsible for the Winner-to-External order integration.