```markdown
# RPG Program NN801R (API Controller for Webshop)

This is an ILE RPG (RPG IV - fixed format) program for the IBM i (AS/400) platform. The program serves as a main control routine ("styreprogram") for various API operations related to a web shop ("nettbutikk"). Its primary role is to route incoming requests to the appropriate sub-programs based on a request type parameter.

---

## Header & Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `option(*nodebugio)`: Disables debug I/O.
- `datedit(*dmy)`: Default date format is Day/Month/Year.

The comments provide system, program, and change information (standard RPG program documentation).

---

## File Definition

```rpg
fanbll1    if   e           k disk    rename(anblpfr:anbll1r)
```
- Defines logical file `anbll1` (renamed from `anblpfr` to `anbll1r`) as a keyed, externally described disk file.

---

## Parameter Definitions

```rpg
d p_recd          s              3
d p_eier          s             10
d p_buti          s             15
d p_uniq          s             15
d p_bibl          s             10
d p_dtqi          s             10
d p_dtqo          s             10
d p_feil          s              1
```
- These are stand-alone variables (local program variables), typically used as parameter fields for program calls.
  - `p_recd`: Record type / request type (e.g., 'PRI', 'INV', etc).
  - `p_eier`: Owner or tenant.
  - `p_buti`: Store or shop ID.
  - `p_uniq`: Unique identifier for the transaction/request.
  - `p_bibl`: Library.
  - `p_dtqi`, `p_dtqo`: Date/time or similar info for input/output.
  - `p_feil`: Error flag.

---

## Variables for Key Fields

```rpg
d anbll1_leie     s                   like(aoleie)
d anbll1_lbut     s                   like(aolbut)
```
- Variables matching key fields in the logical file (match fields like owner/store for file lookup).

---

## Other Working Variables

```rpg
d w_inpl          s              5p 0
d w_outl          s              5p 0
d w_wait          s              5p 0
d w_keyo          s              2
d w_keyl          s              3p 0
d w_sndl          s              3p 0
d w_sndi          s             36
```
- Various work variables used for communication with sub-programs, especially for queue/data structure handling.

---

## Main Logic

### 1. Retrieve Info from "Nettbutikk" File

```rpg
c     eval      anbll1_leie = p_eier
c     eval      anbll1_lbut = p_buti
c     anbll1_key    chain     anbll1
```
- Prepares key fields from input parameters, then attempts to read a matching record from the logical file `anbll1`.
  - `chain`: Reads keyed record into program's buffer.

---

### 2. Initialize Data Queue Variables

```rpg
c     eval      w_inpl = 1024
c     eval      w_outl = 1024
c     eval      w_wait = 0
c     eval      w_keyo = 'EQ'
c     eval      w_keyl = 15
c     eval      w_sndl = 0
c     eval      w_sndi = *blank
```
- Standardizes/inits values to be passed to called programs, likely for data queue or similar inter-program communication.

---

### 3. Route Request to the Relevant API Handler

The program uses a `select/when` structure to determine the type of request (value of `p_recd`). Each possible value results in calling a different handler program, with a fixed parameter list:

Example for `PRI`:
```rpg
c     when      p_recd = 'PRI'
c     call      'NN810R'
c     parm                    p_uniq
c     parm                    p_dtqi
c     parm                    p_dtqo
c     parm                    p_bibl
c     parm                    p_feil
c     parm                    aolfir
c     parm                    aollag
c     parm                    w_inpl
c     parm                    w_outl
c     parm                    w_wait
c     parm                    w_keyo
c     parm                    w_keyl
c     parm                    w_sndl
c     parm                    w_sndi
```
- For each recognized `p_recd` value, a corresponding program is called:
    - `'PRI'`: Calls `NN810R`
    - `'INV'`: Calls `NN820R`
    - `'IND'`: Calls `NN821R`
    - `'RST'`: Calls `NN830R`
    - `'RSP'`: Calls `NN831R`
    - `'ORD'`: Calls `NN850R` (includes extra param: `aolavd`)
- A fixed list of parameters is passed on each call - likely containing all relevant input/output data for processing.

```rpg
c     other
c     eval      p_feil = *on
c     goto      avslutt
```
- If `p_recd` is not recognized, sets error flag and jumps to cleanup.

---

### 4. Program Exit

```rpg
c     avslutt       tag
c     eval      *inlr = *on
c     return
```
- Sets last record indicator (`*inlr = *on`) to end the program and release resources, then returns.

---

## *PSSR (Error Routine)

```rpg
c     *pssr         begsr
c     eval      p_feil = *on
c     goto      avslutt
c     endsr
```
- Standard error subroutine:
  - Sets the error flag and ends the program cleanly.

---

## *INZSR (Initialization Routine)

```rpg
c     *inzsr        begsr
c     *entry        plist
c                   parm                    p_recd
c                   parm                    p_eier
c                   parm                    p_buti
c                   parm                    p_uniq
c                   parm                    p_bibl
c                   parm                    p_dtqi
c                   parm                    p_dtqo
c                   parm                    p_feil
```
- The program is called as a service program or external program with these parameters in order.

```rpg
c     anbll1_key    klist
c                   kfld                    anbll1_leie
c                   kfld                    anbll1_lbut
c     endsr
```
- Defines a key list `anbll1_key` for use in keyed operations (`chain`), associated with `anbll1` file.

---

# Summary

- The program acts as a dispatcher/controller for several web shop API operations.
- Based on the request type (`p_recd`), it routes the call to the appropriate handler program, passing along all relevant data.
- Handles file lookups, parameter initialization, error handling, and clean program shutdown.
- The main business logic is handled in the called programs (`NN810R`, `NN820R`, etc.) - this program primarily dispatches and coordinates.

# Quick Reference

| Parameter     | Description                         |
|---------------|-------------------------------------|
| p_recd        | Request/record type                 |
| p_eier        | Owner/tenant                        |
| p_buti        | Store/shop ID                       |
| p_uniq        | Unique ID for transaction/request   |
| p_bibl        | Library name                        |
| p_dtqi, dtqo  | Date/time info (in/out)             |
| p_feil        | Error flag (output)                 |

| Handler | Called Program | Purpose (likely)        |
|---------|---------------|-------------------------|
| 'PRI'   | NN810R        | Price handling          |
| 'INV'   | NN820R        | Inventory handling      |
| 'IND'   | NN821R        | Index/list handling     |
| 'RST'   | NN830R        | Reset operation         |
| 'RSP'   | NN831R        | Response/answer?        |
| 'ORD'   | NN850R        | Order handling          |


> **In summary:**  
> This RPG program is a main controller or "router" for a web shop API, receiving incoming requests, looking up some info in a file, preparing parameters, and delegating the actual work to specialized sub-programs according to the request type.
```